

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/avatar.png">
  <link rel="icon" href="/img/avatar.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
    <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="arttnba3">
  <meta name="keywords" content="">
  
    <meta name="description" content="å®å°±æ˜¯ğŸ‘´ã® Manager ğŸ">
<meta property="og:type" content="article">
<meta property="og:title" content="ã€FUZZ.0x02ã€‘syzkaller - IIï¼šsyz-manageræºç åˆ†æ">
<meta property="og:url" content="http://blog.arttnba3.cn/2023/03/02/FUZZ-0X02-SYZKALLER-II_SOURCE_SYZMANAGER/index.html">
<meta property="og:site_name" content="arttnba3&#39;s blog">
<meta property="og:description" content="å®å°±æ˜¯ğŸ‘´ã® Manager ğŸ">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://s2.loli.net/2023/03/02/xrfT9S7u3EijaLY.png">
<meta property="article:published_time" content="2023-03-01T20:33:58.000Z">
<meta property="article:modified_time" content="2023-03-01T20:40:20.334Z">
<meta property="article:author" content="arttnba3">
<meta property="article:tag" content="æ¼æ´æŒ–æ˜">
<meta property="article:tag" content="FUZZ">
<meta property="article:tag" content="syzkaller">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://s2.loli.net/2023/03/02/xrfT9S7u3EijaLY.png">
  
  
    <meta name="referrer" content="no-referrer-when-downgrade">
  
  
  <title>ã€FUZZ.0x02ã€‘syzkaller - IIï¼šsyz-manageræºç åˆ†æ - arttnba3&#39;s blog</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- ä¸»é¢˜ä¾èµ–çš„å›¾æ ‡åº“ï¼Œä¸è¦è‡ªè¡Œä¿®æ”¹ -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  




  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"blog.arttnba3.cn","root":"/","version":"1.9.2","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":"Â§"},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":false,"follow_dnt":true,"baidu":null,"google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false}},"search_path":"/local-search.xml"};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  


  
<meta name="generator" content="Hexo 6.2.0"><link rel="alternate" href="/atom.xml" title="arttnba3's blog" type="application/atom+xml">
</head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 80vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>arttnba3&#39;s blog</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                é¦–é¡µ
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                å½’æ¡£
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                åˆ†ç±»
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                æ ‡ç­¾
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                å…³äº
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/links/">
                <i class="iconfont icon-link-fill"></i>
                å‹é“¾
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/atom.xml">
                <i class="iconfont icon-rss"></i>
                rss
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              &nbsp;<i class="iconfont icon-search"></i>&nbsp;
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">&nbsp;<i
                class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('https://i.loli.net/2021/11/12/BnYuNbO2MdiEw5V.png') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="ã€FUZZ.0x02ã€‘syzkaller - IIï¼šsyz-manageræºç åˆ†æ"></span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2023-03-02 04:33" pubdate>
          2023å¹´3æœˆ2æ—¥ å‡Œæ™¨
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          35k å­—
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          290 åˆ†é’Ÿ
        
      </span>
    

    
    
      
        <span id="busuanzi_container_page_pv" style="display: none">
          <i class="iconfont icon-eye" aria-hidden="true"></i>
          <span id="busuanzi_value_page_pv"></span> æ¬¡
        </span>
        
      
    
  </div>


        
      </div>

      
        <div class="scroll-down-bar">
          <i class="iconfont icon-arrowdown"></i>
        </div>
      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">ã€FUZZ.0x02ã€‘syzkaller - IIï¼šsyz-manageræºç åˆ†æ</h1>
            
              <p class="note note-info">
                
                  
                    æœ¬æ–‡æœ€åæ›´æ–°äºï¼š2023å¹´3æœˆ2æ—¥ å‡Œæ™¨
                  
                
              </p>
            
            
              <div class="markdown-body">
                
                <p>å®å°±æ˜¯ğŸ‘´ã® Manager ğŸ</p>
<span id="more"></span>

<h1 id="0x00-ä¸€åˆ‡å¼€å§‹ä¹‹å‰"><a href="#0x00-ä¸€åˆ‡å¼€å§‹ä¹‹å‰" class="headerlink" title="0x00.ä¸€åˆ‡å¼€å§‹ä¹‹å‰"></a>0x00.ä¸€åˆ‡å¼€å§‹ä¹‹å‰</h1><p>syzkaller æ˜¯ä¸€ä¸ªéå¸¸ç»å…¸çš„ kernel fuzzerï¼Œè™½ç„¶ç¬”è€…ä¹‹å‰æ›¾ç»ç”¨è¿‡ï¼ˆä¸è¿‡ç¬”è€…å¤ªèœäº†å•¥éƒ½æ²¡æŒ–å‡ºæ¥ï¼‰ä¹Ÿæ›¾ç²—ç•¥è¯»è¿‡æºç ï¼Œä½†æ˜¯æ²¡æœ‰å¤ªè¿‡äºä»”ç»†åˆ†æå°±æŠ›åœ¨è„‘åäº†ï¼ˆæ‚²ï¼‰</p>
<p>ä¸ºäº†æ·±å…¥å­¦ä¹  fuzzing theoryï¼Œç¬”è€…å†³å®šå…ˆä»è¿™ä¸ªå…¸ä¸­å…¸çš„ syzkaller æºç è¿›è¡Œåˆ†æå­¦ä¹  ï¼šï¼‰</p>
<h2 id="PRE-å·¥ä½œåŸç†"><a href="#PRE-å·¥ä½œåŸç†" class="headerlink" title="PRE.å·¥ä½œåŸç†"></a>PRE.å·¥ä½œåŸç†</h2><p>å¯¹äº syzkaller çš„æ¶æ„ï¼Œå®˜æ–¹ç»™å‡ºäº†è¿™æ ·çš„ä¸€å¼  Overview</p>
<p><img src="https://i.loli.net/2021/11/11/LxNvdhpEX2sBjYc.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p>syzkaller æ•´ä½“ä¸Šä¸ºä¸€ä¸ª<strong>åŒæœºè°ƒè¯•ç»“æ„</strong>ï¼šç”±ä¸€å°æœºå™¨è´Ÿè´£ç®¡æ§æ•´ä¸ª fuzzing æµç¨‹ï¼ˆæœ¬æ–‡ç§°ä¸º <code>Host</code>ï¼‰ï¼Œåœ¨å¦ä¸€å°æœºå™¨ä¸Šè¿›è¡Œ fuzzingï¼ˆæœ¬æ–‡ç§°ä¸º <code>Guest</code>ï¼‰ï¼ŒGuest é€šå¸¸ä¸ºè™šæ‹Ÿæœºï¼Œä»è€Œèƒ½è®© Host æ›´å¥½åœ°ç®¡æ§æ•´ä¸ªæµç¨‹</p>
<p>syzkaller åˆ†ä¸ºä¸‰å¤§ç»„ä»¶ï¼š</p>
<ul>
<li><p>ä½äº Hostï¼š</p>
<ul>
<li><code>syz-manager</code> ï¼šsyzkaller çš„æ§åˆ¶ä¸­æ¢ï¼Œå…¶ä¼šå¯åŠ¨å¤šä¸ª VM å®ä¾‹ï¼ˆå¦‚å›¾æ‰€ç¤ºçš„ä¸€ä¸ªé»„è‰²å¡ç‰‡å°±æ˜¯ä¸€ä¸ªå®ä¾‹ï¼‰å¹¶è¿›è¡Œç›‘è§†ï¼ŒåŒæ—¶é€šè¿‡ RPC æ¥å¯åŠ¨ <code>syz-fuzzer</code></li>
</ul>
</li>
<li><p>ä½äº Guestï¼š</p>
<ul>
<li><code>syz-fuzzer</code> ï¼šè´Ÿè´£å¼•å¯¼æ•´ä¸ª fuzz çš„è¿‡ç¨‹ï¼š<ul>
<li>ç”Ÿæˆ input</li>
<li>å¯åŠ¨ <code>syz-executor</code> è¿›ç¨‹è¿›è¡Œ fuzz</li>
<li>ä»è¢« fuzz çš„ kernel çš„ <code>/sys/kernel/debug/kcov</code> è·å¾—è¦†ç›–ï¼ˆcoverageï¼‰çš„ç›¸å…³ä¿¡æ¯</li>
<li>é€šè¿‡ RPC å°†æ–°çš„è¦†ç›–å›é€åˆ° <code>syz-manager</code></li>
</ul>
</li>
<li><code>syz-executor</code>ï¼šè´Ÿè´£<strong>æ‰§è¡Œå•ä¸ªè¾“å…¥</strong>â€”â€”ä» <code>syz-fuzzer</code> å¤„æ¥å— input å¹¶æ‰§è¡Œï¼Œæœ€åå›é€ç»“æœ</li>
</ul>
</li>
</ul>
<p><code>syz-manager</code> ä¸º syzkaller çš„æ§åˆ¶ä¸­æ¢ï¼Œå…¶ä¼šå¯åŠ¨å¤šä¸ª VM å®ä¾‹å¹¶è¿›è¡Œç›‘è§†ï¼ŒåŒæ—¶é€šè¿‡ RPC æ¥å¯åŠ¨ <code>syz-fuzzer</code>ï¼Œæˆ‘ä»¬é€šå¸¸å¯åŠ¨ fuzzing æ—¶ä¾¿æ˜¯ä»¥ <code>syz-manager</code> ä½œä¸ºç¨‹åºå¯åŠ¨çš„å…¥å£ç‚¹ï¼Œå› æ­¤ç¬”è€…ä¹Ÿå…ˆä»æ­¤å¤„å¼€å§‹åˆ†æ</p>
<h1 id="0x01-åŸºæœ¬ç»“æ„ä½“"><a href="#0x01-åŸºæœ¬ç»“æ„ä½“" class="headerlink" title="0x01. åŸºæœ¬ç»“æ„ä½“"></a>0x01. åŸºæœ¬ç»“æ„ä½“</h1><p>ç›¸æ¯”äºç›´æ¥å¼€å§‹åˆ†ææºç ï¼Œç¬”è€…è®¤ä¸ºæœ‰å¿…è¦åœ¨æ­¤ä¹‹å‰å…ˆåˆ—å‡ºä¸€äº›åŸºæœ¬çš„ç»“æ„ä½“ï¼Œä½ ä¹Ÿå¯ä»¥æŠŠè¿™ä¸€èŠ‚å½“æˆä¸€ä¸ªè¡¨æ¥æŸ¥ ï¼šï¼‰</p>
<h2 id="VM-ç®¡æ§ç›¸å…³"><a href="#VM-ç®¡æ§ç›¸å…³" class="headerlink" title="VM ç®¡æ§ç›¸å…³"></a>VM ç®¡æ§ç›¸å…³</h2><p>Host éœ€è¦å»æ„ŸçŸ¥ä¸ç®¡æ§ Guest VMsï¼Œå› è€Œåœ¨ <code>syz-manager</code> å½“ä¸­æœ‰ç€ä¸€å¥—ç›¸åº”çš„è¡¨ç¤ºä¸ç®¡ç† Guest VM çš„ç»“æ„ä½“</p>
<h3 id="1-Instanceï¼šVM-å®ä¾‹"><a href="#1-Instanceï¼šVM-å®ä¾‹" class="headerlink" title="1. Instanceï¼šVM å®ä¾‹"></a>1. Instanceï¼šVM å®ä¾‹</h3><p><code>syz-manager</code> ä¸­çš„ VM å®é™…ä¸Šæ˜¯ä½¿ç”¨ä¸€ä¸ªåä¸º <code>Instance</code> çš„ç»“æ„ä½“æ¥è¡¨ç¤ºçš„ï¼Œå®šä¹‰äº <code>vm/vm.go</code> ä¸­ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> Instance <span class="hljs-keyword">struct</span> &#123;<br>	impl     vmimpl.Instance<br>	workdir  <span class="hljs-type">string</span><br>	timeouts targets.Timeouts<br>	index    <span class="hljs-type">int</span><br>	onClose  <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span><br>&#125;<br></code></pre></td></tr></table></figure>

<p>ç±»ä¼¼åœ°ï¼Œå…¶éœ€è¦å®ç° <code>Interface</code> æ¥å£ï¼Œå®šä¹‰äº <code>vm/vmimpl/vmimpl.go</code> ä¸­ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// Instance è¡¨ç¤ºä¸€ä¸ªå•ç‹¬çš„ VM.</span><br><span class="hljs-keyword">type</span> Instance <span class="hljs-keyword">interface</span> &#123;<br>	<span class="hljs-comment">// Copy å¤åˆ¶ä¸€ä¸ª hostSrc æ–‡ä»¶åˆ° VM ä¸­å¹¶è¿”å› VM ä¸­çš„æ–‡ä»¶å.</span><br>	Copy(hostSrc <span class="hljs-type">string</span>) (<span class="hljs-type">string</span>, <span class="hljs-type">error</span>)<br><br>	<span class="hljs-comment">// Forward è®¾ç½®ä»è™šæ‹Ÿæœºå†…åˆ°ä¸»æœºä¸Šç»™å®š tcp ç«¯å£çš„è½¬å‘ï¼Œ</span><br>	<span class="hljs-comment">// å¹¶è¿”å›è¦åœ¨è™šæ‹Ÿæœºä¸­ä½¿ç”¨çš„åœ°å€.</span><br>	Forward(port <span class="hljs-type">int</span>) (<span class="hljs-type">string</span>, <span class="hljs-type">error</span>)<br><br>	<span class="hljs-comment">// Run åœ¨è™šæ‹Ÿæœºå†…æ‰§è¡Œå‘½ä»¤ (ç±»ä¼¼ ssh cmd).</span><br>	<span class="hljs-comment">// outc æ¥å—æ··åˆäº†å‘½ä»¤è¡Œä¸å†…æ ¸æ§åˆ¶å°çš„è¾“å‡º.</span><br>	<span class="hljs-comment">// errc æ¥å—å‘½ä»¤ç­‰å¾…è¿”å› error æˆ– vmimpl.ErrTimeout.</span><br>	<span class="hljs-comment">// Command åœ¨ timeout ååœæ­¢. åœ¨ stop chan ä¸Šå‘é€å¯ä»¥ç”¨ä»¥æ›´æ—©å°†å…¶ç»ˆæ­¢.</span><br>	Run(timeout time.Duration, stop &lt;-<span class="hljs-keyword">chan</span> <span class="hljs-type">bool</span>, command <span class="hljs-type">string</span>) (outc &lt;-<span class="hljs-keyword">chan</span> []<span class="hljs-type">byte</span>, errc &lt;-<span class="hljs-keyword">chan</span> <span class="hljs-type">error</span>, err <span class="hljs-type">error</span>)<br><br>	<span class="hljs-comment">// Diagnose ä» VM ä¸Šæ£€ç´¢é¢å¤–çš„è°ƒè¯•ä¿¡æ¯</span><br>	<span class="hljs-comment">// (ä¾‹å¦‚é€šè¿‡å‘é€ä¸€äº› sys-rq&#x27;s æˆ– SIGABORT&#x27;ing ä¸€ä¸ª Go ç¨‹åº).</span><br>	<span class="hljs-comment">//</span><br>	<span class="hljs-comment">// é€‰æ‹©æ€§åœ°ç›´æ¥è¿”å› (ä¸€äº›æˆ–æ‰€æœ‰) ä¿¡æ¯. è‹¥ wait == true,</span><br>	<span class="hljs-comment">// è°ƒç”¨è€…å¿…é¡»ç­‰å¾… VM ç›´æ¥è¾“å‡ºä¿¡æ¯åˆ°å…¶æ—¥å¿—.</span><br>	<span class="hljs-comment">//</span><br>	<span class="hljs-comment">// rep æè¿°äº† Diagnose è¢«è°ƒç”¨çš„åŸå› .</span><br>	Diagnose(rep *report.Report) (diagnosis []<span class="hljs-type">byte</span>, wait <span class="hljs-type">bool</span>)<br><br>	<span class="hljs-comment">// Close åœæ­¢å¹¶é”€æ¯ VM.</span><br>	Close()<br>&#125;<br></code></pre></td></tr></table></figure>

<ul>
<li><code>Copy()</code>ï¼šå°†ä¸€ä¸ªæ¥è‡ªå®¿ä¸»æœºçš„æ–‡ä»¶æ‹·è´è‡³è™šæ‹Ÿæœºä¸­ï¼Œè¿”å›è™šæ‹Ÿæœºä¸­çš„æ–‡ä»¶å.</li>
<li><code>Forward()</code>ï¼šè®¾ç½®ä»è™šæ‹Ÿæœºå†…åˆ°ä¸»æœºä¸Šç»™å®š tcp ç«¯å£çš„è½¬å‘ï¼Œå¹¶è¿”å›è¦åœ¨è™šæ‹Ÿæœºä¸­ä½¿ç”¨çš„åœ°å€</li>
<li><code>Run()</code>ï¼šåœ¨è™šæ‹Ÿæœºå†…æ‰§è¡Œå‘½ä»¤</li>
<li><code>Diagnose()</code>ï¼šåœ¨è™šæ‹Ÿæœºä¸Šæ£€ç´¢é¢å¤–çš„è°ƒè¯•ä¿¡æ¯</li>
<li><code>Close()</code>ï¼šåœæ­¢å¹¶é”€æ¯è™šæ‹Ÿæœº</li>
</ul>
<p>éœ€è¦æ³¨æ„çš„æ˜¯<strong>ä¸åŒç±»å‹çš„ Guest VM æ‰€å®ç°çš„ Interface æ¥å£æ˜¯ä¸åŒçš„</strong></p>
<blockquote>
<p>ä»¥ QEMU ä¸ºä¾‹ï¼Œå…¶å®ç°ä¸»è¦ä½äº <code>vm/qemu/qemu.go</code> ä¸­</p>
</blockquote>
<h3 id="2-Poolï¼šVM-æ± "><a href="#2-Poolï¼šVM-æ± " class="headerlink" title="2.Poolï¼šVM æ± "></a>2.Poolï¼šVM æ± </h3><p>ç±»ä¼¼äºçº¿ç¨‹æ± çš„æ¦‚å¿µï¼Œåœ¨ <code>syz-manager</code> ä¸­ä½¿ç”¨ä¸€ä¸ª <strong>VM æ± </strong> â€”â€” <code>Pool</code> ç»“æ„ä½“æ¥ç®¡æ§ Guest VMï¼Œè¯¥ç»“æ„ä½“å®šä¹‰äº <code>vm/vm.go</code> ä¸­ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> Pool <span class="hljs-keyword">struct</span> &#123;<br>	impl        vmimpl.Pool<br>	workdir     <span class="hljs-type">string</span><br>	template    <span class="hljs-type">string</span><br>	timeouts    targets.Timeouts<br>	activeCount <span class="hljs-type">int32</span><br>&#125;<br></code></pre></td></tr></table></figure>

<p>è¯¥ç»“æ„ä½“å®ç°äº† <code>Pool</code> æ¥å£ï¼Œå®šä¹‰äº <code>vm/vmimpl/vmimpl.go</code> ä¸­ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// Pool è¡¨ç¤ºäº†ä¸€ç»„ç‰¹å®šç±»å‹çš„æµ‹è¯•æœºå™¨ (è™šæ‹Ÿæœº, ç‰©ç†è®¾å¤‡, etc).</span><br><span class="hljs-keyword">type</span> Pool <span class="hljs-keyword">interface</span> &#123;<br>	<span class="hljs-comment">// Count è¿”å›æ± ä¸­æ‰€æœ‰ VM çš„æ•°é‡.</span><br>	Count() <span class="hljs-type">int</span><br><br>	<span class="hljs-comment">// Create åˆ›å»ºå¹¶å¯åŠ¨ä¸€ä¸ªæ–°çš„ VM å®ä¾‹.</span><br>	Create(workdir <span class="hljs-type">string</span>, index <span class="hljs-type">int</span>) (Instance, <span class="hljs-type">error</span>)<br>&#125;<br></code></pre></td></tr></table></figure>

<ul>
<li><code>Count()</code>ï¼šè¿”å›æ± ä¸­æ‰€æœ‰ VM çš„æ•°é‡</li>
<li><code>Create()</code>ï¼š<strong>æ–°å»ºå¹¶å¯åŠ¨ä¸€ä¸ª VMå®ä¾‹</strong>ï¼Œè¿”å›æ–°å»ºçš„å®ä¾‹å¯¹è±¡</li>
</ul>
<h4 id="QEMU-VM-æµ…æ"><a href="#QEMU-VM-æµ…æ" class="headerlink" title="QEMU VM æµ…æ"></a>QEMU VM æµ…æ</h4><p>ä»¥ QEMU ä¸ºä¾‹çš„ Pool æ¥å£å®ç°å¦‚ä¸‹ï¼Œå¯¹äº <code>Count()</code> è€Œè¨€ä¼šç›´æ¥è¿”å›é…ç½®æ–‡ä»¶ä¸­çš„è®¡æ•°ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(pool *Pool)</span></span> Count() <span class="hljs-type">int</span> &#123;<br>	<span class="hljs-keyword">return</span> pool.cfg.Count<br>&#125;<br></code></pre></td></tr></table></figure>

<p><code>Create()</code> åˆ™ä¼šé¦–å…ˆæ£€æŸ¥æ–‡ä»¶ç³»ç»Ÿé•œåƒæ˜¯å¦ä¸º <code>9p</code> æ ¼å¼ï¼Œè‹¥æ˜¯åˆ™ä¼šç”Ÿæˆä¸€ä¸ª ssh key å­˜æ”¾åˆ° <code>key</code> æ–‡ä»¶ä¸­å¹¶ç”Ÿæˆä¸€ä¸ª <code>init.sh</code> æ–‡ä»¶ï¼›æ¥ä¸‹æ¥å°±æ˜¯è°ƒç”¨ <code>ctor()</code> å‡½æ•°åˆ›å»ºè™šæ‹Ÿæœºï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(pool *Pool)</span></span> Create(workdir <span class="hljs-type">string</span>, index <span class="hljs-type">int</span>) (vmimpl.Instance, <span class="hljs-type">error</span>) &#123;<br>	sshkey := pool.env.SSHKey<br>	sshuser := pool.env.SSHUser<br>	<span class="hljs-keyword">if</span> pool.env.Image == <span class="hljs-string">&quot;9p&quot;</span> &#123;<br>		sshkey = filepath.Join(workdir, <span class="hljs-string">&quot;key&quot;</span>)<br>		sshuser = <span class="hljs-string">&quot;root&quot;</span><br>		<span class="hljs-keyword">if</span> _, err := osutil.RunCmd(<span class="hljs-number">10</span>*time.Minute, <span class="hljs-string">&quot;&quot;</span>, <span class="hljs-string">&quot;ssh-keygen&quot;</span>, <span class="hljs-string">&quot;-t&quot;</span>, <span class="hljs-string">&quot;rsa&quot;</span>, <span class="hljs-string">&quot;-b&quot;</span>, <span class="hljs-string">&quot;2048&quot;</span>,<br>			<span class="hljs-string">&quot;-N&quot;</span>, <span class="hljs-string">&quot;&quot;</span>, <span class="hljs-string">&quot;-C&quot;</span>, <span class="hljs-string">&quot;&quot;</span>, <span class="hljs-string">&quot;-f&quot;</span>, sshkey); err != <span class="hljs-literal">nil</span> &#123;<br>			<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, err<br>		&#125;<br>		initFile := filepath.Join(workdir, <span class="hljs-string">&quot;init.sh&quot;</span>)<br>		<span class="hljs-keyword">if</span> err := osutil.WriteExecFile(initFile, []<span class="hljs-type">byte</span>(strings.Replace(initScript, <span class="hljs-string">&quot;&#123;&#123;KEY&#125;&#125;&quot;</span>, sshkey, <span class="hljs-number">-1</span>))); err != <span class="hljs-literal">nil</span> &#123;<br>			<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, fmt.Errorf(<span class="hljs-string">&quot;failed to create init file: %v&quot;</span>, err)<br>		&#125;<br>	&#125;<br><br>	<span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; ; i++ &#123;<br>		inst, err := pool.ctor(workdir, sshkey, sshuser, index)<br>		<span class="hljs-keyword">if</span> err == <span class="hljs-literal">nil</span> &#123;<br>			<span class="hljs-keyword">return</span> inst, <span class="hljs-literal">nil</span><br>		&#125;<br>		<span class="hljs-comment">// Older qemu prints &quot;could&quot;, newer -- &quot;Could&quot;.</span><br>		<span class="hljs-keyword">if</span> i &lt; <span class="hljs-number">1000</span> &amp;&amp; strings.Contains(err.Error(), <span class="hljs-string">&quot;ould not set up host forwarding rule&quot;</span>) &#123;<br>			<span class="hljs-keyword">continue</span><br>		&#125;<br>		<span class="hljs-keyword">if</span> i &lt; <span class="hljs-number">1000</span> &amp;&amp; strings.Contains(err.Error(), <span class="hljs-string">&quot;Device or resource busy&quot;</span>) &#123;<br>			<span class="hljs-keyword">continue</span><br>		&#125;<br>		<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, err<br>	&#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<p><code>ctor()</code> çš„å®ç°æ¯”è¾ƒç®€å•ï¼Œä¸»è¦å°±æ˜¯åˆ›å»ºä¸€ä¸ªå¸¦ç€ ssh key åŠä¸€äº›é…ç½®ä¿¡æ¯ä¸ä¸€ä¸ª channel çš„ <code>instance</code> å®ä¾‹ï¼Œåˆå§‹åŒ–å®ä¾‹å†…çš„ç®¡é“å¹¶è°ƒç”¨ <code>boot()</code> å‡½æ•°è¿›è¡Œæ­£å¼çš„åˆ›å»ºï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(pool *Pool)</span></span> ctor(workdir, sshkey, sshuser <span class="hljs-type">string</span>, index <span class="hljs-type">int</span>) (vmimpl.Instance, <span class="hljs-type">error</span>) &#123;<br>	inst := &amp;instance&#123;<br>		index:      index,<br>		cfg:        pool.cfg,<br>		target:     pool.target,<br>		archConfig: pool.archConfig,<br>		version:    pool.version,<br>		image:      pool.env.Image,<br>		debug:      pool.env.Debug,<br>		os:         pool.env.OS,<br>		timeouts:   pool.env.Timeouts,<br>		workdir:    workdir,<br>		sshkey:     sshkey,<br>		sshuser:    sshuser,<br>		diagnose:   <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> <span class="hljs-type">bool</span>, <span class="hljs-number">1</span>),<br>	&#125;<br>	<span class="hljs-keyword">if</span> st, err := os.Stat(inst.image); err != <span class="hljs-literal">nil</span> &amp;&amp; st.Size() == <span class="hljs-number">0</span> &#123;<br>		<span class="hljs-comment">// Some kernels may not need an image, however caller may still</span><br>		<span class="hljs-comment">// want to pass us a fake empty image because the rest of syzkaller</span><br>		<span class="hljs-comment">// assumes that an image is mandatory. So if the image is empty, we ignore it.</span><br>		inst.image = <span class="hljs-string">&quot;&quot;</span><br>	&#125;<br>	closeInst := inst<br>	<span class="hljs-keyword">defer</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br>		<span class="hljs-keyword">if</span> closeInst != <span class="hljs-literal">nil</span> &#123;<br>			closeInst.Close()<br>		&#125;<br>	&#125;()<br><br>	<span class="hljs-keyword">var</span> err <span class="hljs-type">error</span><br>	inst.rpipe, inst.wpipe, err = osutil.LongPipe()<br>	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>		<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, err<br>	&#125;<br><br>	<span class="hljs-keyword">if</span> err := inst.boot(); err != <span class="hljs-literal">nil</span> &#123;<br>		<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, err<br>	&#125;<br><br>	closeInst = <span class="hljs-literal">nil</span><br>	<span class="hljs-keyword">return</span> inst, <span class="hljs-literal">nil</span><br>&#125;<br></code></pre></td></tr></table></figure>

<p><code>boot()</code> å‡½æ•°ä¸»è¦å°±æ˜¯å„ç§å‚æ•°åˆ¤æ–­ï¼Œä¹‹å<strong>æŠŠ QEMU èµ·äº†ä»¥å ssh è¿ä¸Šå»</strong>ï¼Œè¿™é‡Œå°±ä¸æ‘˜æŠ„ä»£ç äº†ï¼šï¼‰</p>
<h3 id="3-Envï¼šå•ä¸ª-VM-Pool-çš„ç¯å¢ƒå˜é‡"><a href="#3-Envï¼šå•ä¸ª-VM-Pool-çš„ç¯å¢ƒå˜é‡" class="headerlink" title="3. Envï¼šå•ä¸ª  VM Pool çš„ç¯å¢ƒå˜é‡"></a>3. Envï¼šå•ä¸ª  VM Pool çš„ç¯å¢ƒå˜é‡</h3><p><code>Env</code> ç»“æ„ä½“ä¸ºç”¨äºä¸€ä¸ª VM Pool çš„ç¯å¢ƒå˜é‡ï¼Œå®šä¹‰äº <code>vm/vmimpl/vmimpl.go</code> ä¸­ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// Env åŒ…å«äº†ç”¨äº VM æ± çš„å…¨å±€å¸¸é‡å‚æ•°.</span><br><span class="hljs-keyword">type</span> Env <span class="hljs-keyword">struct</span> &#123;<br>	<span class="hljs-comment">// ç‹¬ç‰¹çš„åå­—</span><br>	<span class="hljs-comment">// è‹¥å‡ ä¸ª Pool å…±äº«äº†å…¨å±€å‘½åç©ºé—´åˆ™å¯è¢«ç”¨äº VM name çš„å†²çªè§£å†³</span><br>	Name      <span class="hljs-type">string</span><br>	OS        <span class="hljs-type">string</span> <span class="hljs-comment">// ç›®æ ‡ OS</span><br>	Arch      <span class="hljs-type">string</span> <span class="hljs-comment">// ç›®æ ‡ arch</span><br>	Workdir   <span class="hljs-type">string</span><br>	Image     <span class="hljs-type">string</span><br>	SSHKey    <span class="hljs-type">string</span><br>	SSHUser   <span class="hljs-type">string</span><br>	Timeouts  targets.Timeouts<br>	Debug     <span class="hljs-type">bool</span><br>	Config    []<span class="hljs-type">byte</span> <span class="hljs-comment">// json-åºåˆ—åŒ–çš„ VM-ç±»å‹-ç‰¹å®šé…ç½®</span><br>	KernelSrc <span class="hljs-type">string</span><br>&#125;<br></code></pre></td></tr></table></figure>





<h3 id="4-Typeï¼šVM-ç±»å‹"><a href="#4-Typeï¼šVM-ç±»å‹" class="headerlink" title="4. Typeï¼šVM ç±»å‹"></a>4. Typeï¼šVM ç±»å‹</h3><p>ä¸€ä¸ª VM Pool ä¸­åªèƒ½æœ‰ä¸€ç§ç±»å‹çš„ VMï¼Œå› è€Œä¸åŒç±»å‹çš„ VM çš„ Pool åº”å½“è¦æœ‰ä¸åŒçš„æ„é€ å‡½æ•°ï¼Œåœ¨ <code>syz-manager</code> ä¸­ä½¿ç”¨ <code>Type</code> ç»“æ„ä½“è¡¨ç¤ºä¸€ç§ VM çš„ç±»å‹ä¿¡æ¯ï¼Œå®šä¹‰äº <code>vm/vmimpl/vmimpl.go</code> ä¸­ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> Type <span class="hljs-keyword">struct</span> &#123;<br>	Ctor       ctorFunc<br>	Overcommit <span class="hljs-type">bool</span><br>&#125;<br><br><span class="hljs-keyword">type</span> ctorFunc <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(env *Env)</span></span> (Pool, <span class="hljs-type">error</span>)<br></code></pre></td></tr></table></figure>

<p><code>ctorFunc</code> ä¸ºæ„é€ å‡½æ•°ç±»å‹ï¼Œå…¶æ¥å—ä¸€ä¸ª <code>Env</code> ç±»å‹çš„ç»“æ„ä½“æŒ‡é’ˆï¼ˆå‚¨å­˜äº†å…¨å±€çš„ä¸€äº›åŸºæœ¬ä¿¡æ¯ï¼‰ï¼Œå¹¶è¿”å›ä¸€ä¸ª VM Pool å®ä¾‹</p>
<p>ç”±ä¸€ä¸ªå…¨å±€çš„ <code>stringâ†’Type</code> æ˜ å°„è¡¨å­˜å‚¨äº†ä¸åŒç±»å‹ VM çš„ä¿¡æ¯ï¼Œåœ¨æ­£å¼å¯åŠ¨ä¹‹å‰ç¨‹åºä¼šé€šè¿‡ <code>Register()</code> å‡½æ•°å°†ä¸åŒç±»å‹çš„ VM ä¿¡æ¯æ³¨å†Œåˆ°è¯¥è¡¨ä¸­ï¼Œå®šä¹‰äº <code>vm/vmimpl/vmimpl.go</code> ä¸­ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// Register åœ¨åŒ…ä¸­æ³¨å†Œä¸€ä¸ªæ–°çš„ VM ç±»å‹.</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">Register</span><span class="hljs-params">(typ <span class="hljs-type">string</span>, ctor ctorFunc, allowsOvercommit <span class="hljs-type">bool</span>)</span></span> &#123;<br>	Types[typ] = Type&#123;<br>		Ctor:       ctor,<br>		Overcommit: allowsOvercommit,<br>	&#125;<br>&#125;<br><br><span class="hljs-comment">//...</span><br><br><span class="hljs-keyword">var</span>(<br>    <span class="hljs-comment">//...</span><br>	Types = <span class="hljs-built_in">make</span>(<span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]Type)<br></code></pre></td></tr></table></figure>

<p>ä»¥ <code>QEMU</code> ä¸ºä¾‹ï¼Œå…¶åœ¨åŒ…è¢«å¯¼å…¥æ—¶æ³¨å†Œæ„é€ å‡½æ•°ï¼Œä¸»è¦æ˜¯è°ƒç”¨ <code>LoadData()</code> è§£æé…ç½®æ–‡ä»¶åè¿›è¡Œæ£€æŸ¥ï¼Œè¿™é‡Œä¸å†èµ˜å™ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">init</span><span class="hljs-params">()</span></span> &#123;<br>	<span class="hljs-keyword">var</span> _ vmimpl.Infoer = (*instance)(<span class="hljs-literal">nil</span>)<br>	vmimpl.Register(<span class="hljs-string">&quot;qemu&quot;</span>, ctor, <span class="hljs-literal">true</span>)<br>&#125;<br><br><span class="hljs-comment">//...</span><br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">ctor</span><span class="hljs-params">(env *vmimpl.Env)</span></span> (vmimpl.Pool, <span class="hljs-type">error</span>) &#123;<br>	archConfig := archConfigs[env.OS+<span class="hljs-string">&quot;/&quot;</span>+env.Arch]<br>	cfg := &amp;Config&#123;<br>		Count:       <span class="hljs-number">1</span>,<br>		CPU:         <span class="hljs-number">1</span>,<br>		Mem:         <span class="hljs-number">1024</span>,<br>		ImageDevice: <span class="hljs-string">&quot;hda&quot;</span>,<br>		Qemu:        archConfig.Qemu,<br>		QemuArgs:    archConfig.QemuArgs,<br>		NetDev:      archConfig.NetDev,<br>		Snapshot:    <span class="hljs-literal">true</span>,<br>	&#125;<br>	<span class="hljs-keyword">if</span> err := config.LoadData(env.Config, cfg); err != <span class="hljs-literal">nil</span> &#123;<br>		<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, fmt.Errorf(<span class="hljs-string">&quot;failed to parse qemu vm config: %v&quot;</span>, err)<br>	&#125;<br>	<span class="hljs-keyword">if</span> cfg.Count &lt; <span class="hljs-number">1</span> || cfg.Count &gt; <span class="hljs-number">128</span> &#123;<br>		<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, fmt.Errorf(<span class="hljs-string">&quot;invalid config param count: %v, want [1, 128]&quot;</span>, cfg.Count)<br>	&#125;<br>	<span class="hljs-keyword">if</span> env.Debug &amp;&amp; cfg.Count &gt; <span class="hljs-number">1</span> &#123;<br>		log.Logf(<span class="hljs-number">0</span>, <span class="hljs-string">&quot;limiting number of VMs from %v to 1 in debug mode&quot;</span>, cfg.Count)<br>		cfg.Count = <span class="hljs-number">1</span><br>	&#125;<br>	<span class="hljs-keyword">if</span> _, err := exec.LookPath(cfg.Qemu); err != <span class="hljs-literal">nil</span> &#123;<br>		<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, err<br>	&#125;<br>	<span class="hljs-keyword">if</span> env.Image == <span class="hljs-string">&quot;9p&quot;</span> &#123;<br>		<span class="hljs-keyword">if</span> env.OS != targets.Linux &#123;<br>			<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, fmt.Errorf(<span class="hljs-string">&quot;9p image is supported for linux only&quot;</span>)<br>		&#125;<br>		<span class="hljs-keyword">if</span> cfg.Kernel == <span class="hljs-string">&quot;&quot;</span> &#123;<br>			<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, fmt.Errorf(<span class="hljs-string">&quot;9p image requires kernel&quot;</span>)<br>		&#125;<br>	&#125; <span class="hljs-keyword">else</span> &#123;<br>		<span class="hljs-keyword">if</span> !osutil.IsExist(env.Image) &#123;<br>			<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, fmt.Errorf(<span class="hljs-string">&quot;image file &#x27;%v&#x27; does not exist&quot;</span>, env.Image)<br>		&#125;<br>	&#125;<br>	<span class="hljs-keyword">if</span> cfg.CPU &lt;= <span class="hljs-number">0</span> || cfg.CPU &gt; <span class="hljs-number">1024</span> &#123;<br>		<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, fmt.Errorf(<span class="hljs-string">&quot;bad qemu cpu: %v, want [1-1024]&quot;</span>, cfg.CPU)<br>	&#125;<br>	<span class="hljs-keyword">if</span> cfg.Mem &lt; <span class="hljs-number">128</span> || cfg.Mem &gt; <span class="hljs-number">1048576</span> &#123;<br>		<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, fmt.Errorf(<span class="hljs-string">&quot;bad qemu mem: %v, want [128-1048576]&quot;</span>, cfg.Mem)<br>	&#125;<br>	cfg.Kernel = osutil.Abs(cfg.Kernel)<br>	cfg.Initrd = osutil.Abs(cfg.Initrd)<br><br>	output, err := osutil.RunCmd(time.Minute, <span class="hljs-string">&quot;&quot;</span>, cfg.Qemu, <span class="hljs-string">&quot;--version&quot;</span>)<br>	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>		<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, err<br>	&#125;<br>	version := <span class="hljs-type">string</span>(bytes.Split(output, []<span class="hljs-type">byte</span>&#123;<span class="hljs-string">&#x27;\n&#x27;</span>&#125;)[<span class="hljs-number">0</span>])<br><br>	pool := &amp;Pool&#123;<br>		env:        env,<br>		cfg:        cfg,<br>		version:    version,<br>		target:     targets.Get(env.OS, env.Arch),<br>		archConfig: archConfig,<br>	&#125;<br>	<span class="hljs-keyword">return</span> pool, <span class="hljs-literal">nil</span><br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="5-ResourcePoolï¼šVM-èµ„æºæ± é˜Ÿåˆ—"><a href="#5-ResourcePoolï¼šVM-èµ„æºæ± é˜Ÿåˆ—" class="headerlink" title="5. ResourcePoolï¼šVM èµ„æºæ± é˜Ÿåˆ—"></a>5. ResourcePoolï¼šVM èµ„æºæ± é˜Ÿåˆ—</h3><p>Guest VM çš„èµ„æºè°ƒé…ä¸»è¦æ˜¯é€šè¿‡<code>ResourcePool</code> è¿™ä¸€ç»“æ„æ¥å®Œæˆçš„ï¼Œè¿™å®é™…ä¸Šæ˜¯ä¸€ä¸ª <strong>å­˜æ”¾ç©ºé—² VM ã® idx çš„å•å‘é˜Ÿåˆ—ï¼Œå†³å®šäº† VM çš„è°ƒåº¦é¡ºåº</strong>ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> ResourcePool <span class="hljs-keyword">struct</span> &#123;<br>	ids   []<span class="hljs-type">int</span><br>	mu    sync.RWMutex<br>	Freed <span class="hljs-keyword">chan</span> <span class="hljs-keyword">interface</span>&#123;&#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>ä¸»è¦å®šä¹‰äº†è¿™äº›æ–¹æ³•æ¥æ“çºµèµ„æºæ± é˜Ÿåˆ—ï¼š</p>
<ul>
<li><code>Put()</code> ï¼šå‘é˜Ÿåˆ—æœ«å°¾æ·»åŠ ç©ºé—² VM ã® idx</li>
<li><code>Len()</code> ï¼šè·å–é˜Ÿåˆ—é•¿åº¦</li>
<li><code>Take()</code>ï¼šä»é˜Ÿåˆ—é¦–éƒ¨å–å‡º <code>cnt</code> ä¸ªæˆå‘˜</li>
<li><code>TakeOne()</code> ï¼šä»é˜Ÿåˆ—é¦–éƒ¨å–å‡ºå•ä¸ªæˆå‘˜</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(pool *ResourcePool)</span></span> Put(ids ...<span class="hljs-type">int</span>) &#123;<br>	pool.mu.Lock()<br>	<span class="hljs-keyword">defer</span> pool.mu.Unlock()<br>	pool.ids = <span class="hljs-built_in">append</span>(pool.ids, ids...)<br>	<span class="hljs-comment">// Notify the listener.</span><br>	<span class="hljs-keyword">select</span> &#123;<br>	<span class="hljs-keyword">case</span> pool.Freed &lt;- <span class="hljs-literal">true</span>:<br>	<span class="hljs-keyword">default</span>:<br>	&#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(pool *ResourcePool)</span></span> Len() <span class="hljs-type">int</span> &#123;<br>	pool.mu.RLock()<br>	<span class="hljs-keyword">defer</span> pool.mu.RUnlock()<br>	<span class="hljs-keyword">return</span> <span class="hljs-built_in">len</span>(pool.ids)<br>&#125;<br><br><span class="hljs-comment">//...</span><br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(pool *ResourcePool)</span></span> Take(cnt <span class="hljs-type">int</span>) []<span class="hljs-type">int</span> &#123;<br>	pool.mu.Lock()<br>	<span class="hljs-keyword">defer</span> pool.mu.Unlock()<br>	totalItems := <span class="hljs-built_in">len</span>(pool.ids)<br>	<span class="hljs-keyword">if</span> totalItems &lt; cnt &#123;<br>		<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span><br>	&#125;<br>	ret := <span class="hljs-built_in">append</span>([]<span class="hljs-type">int</span>&#123;&#125;, pool.ids[totalItems-cnt:]...)<br>	pool.ids = pool.ids[:totalItems-cnt]<br>	<span class="hljs-keyword">return</span> ret<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(pool *ResourcePool)</span></span> TakeOne() *<span class="hljs-type">int</span> &#123;<br>	ret := pool.Take(<span class="hljs-number">1</span>)<br>	<span class="hljs-keyword">if</span> ret == <span class="hljs-literal">nil</span> &#123;<br>		<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span><br>	&#125;<br>	<span class="hljs-keyword">return</span> &amp;ret[<span class="hljs-number">0</span>]<br>&#125;<br></code></pre></td></tr></table></figure>

<p>åŒæ—¶æœ‰ä¸€ä¸ª <code>SequentialResourcePool()</code> å‡½æ•°ç”¨ä»¥åˆå§‹åŒ–èµ„æºæ± ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">SequentialResourcePool</span><span class="hljs-params">(count <span class="hljs-type">int</span>, delay time.Duration)</span></span> *ResourcePool &#123;<br>	ret := &amp;ResourcePool&#123;Freed: <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> <span class="hljs-keyword">interface</span>&#123;&#125;, <span class="hljs-number">1</span>)&#125;<br>	<span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br>		<span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; count; i++ &#123;<br>			ret.Put(i)<br>			time.Sleep(delay)<br>		&#125;<br>	&#125;()<br>	<span class="hljs-keyword">return</span> ret<br>&#125;<br></code></pre></td></tr></table></figure>



<h2 id="å…¨å±€ç®¡æ§ç›¸å…³"><a href="#å…¨å±€ç®¡æ§ç›¸å…³" class="headerlink" title="å…¨å±€ç®¡æ§ç›¸å…³"></a>å…¨å±€ç®¡æ§ç›¸å…³</h2><h3 id="1-Managerï¼šåŸºæœ¬ä¿¡æ¯"><a href="#1-Managerï¼šåŸºæœ¬ä¿¡æ¯" class="headerlink" title="1. Managerï¼šåŸºæœ¬ä¿¡æ¯"></a>1. Managerï¼šåŸºæœ¬ä¿¡æ¯</h3><p><code>Manager</code> ç»“æ„ä½“ç”¨äº<strong>è¡¨ç¤ºä¸€ä¸ª syz-manager çš„åŸºæœ¬ä¿¡æ¯</strong>ï¼Œå®šä¹‰äº <code>syz-manager/manager.go</code> ä¸­ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> Manager <span class="hljs-keyword">struct</span> &#123;<br>	cfg            *mgrconfig.Config<br>	vmPool         *vm.Pool<br>	target         *prog.Target<br>	sysTarget      *targets.Target<br>	reporter       *report.Reporter<br>	crashdir       <span class="hljs-type">string</span><br>	serv           *RPCServer<br>	corpusDB       *db.DB<br>	startTime      time.Time<br>	firstConnect   time.Time<br>	fuzzingTime    time.Duration<br>	stats          *Stats<br>	crashTypes     <span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]<span class="hljs-type">bool</span><br>	vmStop         <span class="hljs-keyword">chan</span> <span class="hljs-type">bool</span><br>	checkResult    *rpctype.CheckArgs<br>	fresh          <span class="hljs-type">bool</span><br>	numFuzzing     <span class="hljs-type">uint32</span><br>	numReproducing <span class="hljs-type">uint32</span><br><br>	dash *dashapi.Dashboard<br><br>	mu                    sync.Mutex<br>	phase                 <span class="hljs-type">int</span><br>	targetEnabledSyscalls <span class="hljs-keyword">map</span>[*prog.Syscall]<span class="hljs-type">bool</span><br><br>	candidates       []rpctype.Candidate <span class="hljs-comment">// untriaged inputs from corpus and hub</span><br>	disabledHashes   <span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]<span class="hljs-keyword">struct</span>&#123;&#125;<br>	corpus           <span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]CorpusItem<br>	seeds            [][]<span class="hljs-type">byte</span><br>	newRepros        [][]<span class="hljs-type">byte</span><br>	lastMinCorpus    <span class="hljs-type">int</span><br>	memoryLeakFrames <span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]<span class="hljs-type">bool</span><br>	dataRaceFrames   <span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]<span class="hljs-type">bool</span><br>	saturatedCalls   <span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]<span class="hljs-type">bool</span><br><br>	needMoreRepros <span class="hljs-keyword">chan</span> <span class="hljs-keyword">chan</span> <span class="hljs-type">bool</span><br>	hubReproQueue  <span class="hljs-keyword">chan</span> *Crash<br>	reproRequest   <span class="hljs-keyword">chan</span> <span class="hljs-keyword">chan</span> <span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]<span class="hljs-type">bool</span><br><br>	<span class="hljs-comment">// For checking that files that we are using are not changing under us.</span><br>	<span class="hljs-comment">// Maps file name to modification time.</span><br>	usedFiles <span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]time.Time<br><br>	modules            []host.KernelModule<br>	coverFilter        <span class="hljs-keyword">map</span>[<span class="hljs-type">uint32</span>]<span class="hljs-type">uint32</span><br>	coverFilterBitmap  []<span class="hljs-type">byte</span><br>	modulesInitialized <span class="hljs-type">bool</span><br><br>	assetStorage *asset.Storage<br>&#125;<br></code></pre></td></tr></table></figure>

<p>è¿™é‡Œåªè¯´æ˜æ¯”è¾ƒå…³é”®çš„å‡ ä¸ªå­—æ®µï¼š</p>
<ul>
<li><code>cfg</code>ï¼šåŸºæœ¬è®¾ç½®ä¿¡æ¯ï¼Œå¯¹åº”å­˜æ”¾åœ¨ä¸€ä¸ª json æ–‡ä»¶ä¸­</li>
<li><code>vmPool</code> ï¼šæ‰€ç”¨çš„ VM Pool</li>
<li><code>reporter</code>ï¼šç”¨ä»¥æŠ¥å‘Š crash</li>
<li><code>serv</code> ï¼šRPC Serverï¼Œç”¨ä»¥ä¸ Guest é—´é€šä¿¡</li>
<li><code>corpusDB</code>ï¼šå­˜æ”¾è¯­æ–™çš„æ•°æ®åº“</li>
<li><code>targetEnabledSyscalls</code>ï¼šæµ‹è¯•ç”¨ä¾‹æ‰€å…è®¸ä½¿ç”¨çš„ç³»ç»Ÿè°ƒç”¨</li>
<li><code>candidates</code>ï¼šå¾…æ‰§è¡Œæµ‹è¯•ç”¨ä¾‹</li>
<li><code>corpus</code>ï¼šè¯­æ–™åº“</li>
<li><code>seeds</code>ï¼šç”¨æ¥å¯¹è¯­æ–™åº“å˜å¼‚çš„ç§å­</li>
</ul>
<h3 id="2-fuzzing-phase"><a href="#2-fuzzing-phase" class="headerlink" title="2. fuzzing phase"></a>2. fuzzing phase</h3><p><code>syz-manager</code> ä¸­å°† fuzzing æµç¨‹åˆ†ä¸ºå¦‚ä¸‹çš„ä¸åŒé˜¶æ®µï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">const</span> (<br>	<span class="hljs-comment">// åˆšåˆšå¼€å§‹ï¼Œå•¥éƒ½æ²¡åš.</span><br>	phaseInit = <span class="hljs-literal">iota</span><br>	<span class="hljs-comment">// åŠ è½½äº†è¯­æ–™åº“ä¸”æ£€æŸ¥äº†æœºå™¨.</span><br>	phaseLoadedCorpus<br>	<span class="hljs-comment">// ä»è¯­æ–™åº“ä¸­åˆ†ç±»äº†æ‰€æœ‰è¾“å…¥.</span><br>	<span class="hljs-comment">// è¿™æ˜¯æˆ‘ä»¬å¼€å§‹æŸ¥è¯¢ hub ä¸æœ€å°åŒ–è¿ç»­è¯­æ–™åº“çš„æ—¶å€™.</span><br>	phaseTriagedCorpus<br>	<span class="hljs-comment">// ç¬¬ä¸€ä¸ªè¯·æ±‚å‘é€åˆ°äº† hub.</span><br>	phaseQueriedHub<br>	<span class="hljs-comment">// åˆ†ç±»æ‰€æœ‰æ¥è‡ª hub çš„æ–°è¾“å…¥.</span><br>	<span class="hljs-comment">// è¿™æ˜¯æˆ‘ä»¬å¼€å§‹å¤ç° crashes çš„æ—¶å€™.</span><br>	phaseTriagedHub<br>)<br></code></pre></td></tr></table></figure>

<h2 id="Fuzzing-ç»“æœç›¸å…³"><a href="#Fuzzing-ç»“æœç›¸å…³" class="headerlink" title="Fuzzing ç»“æœç›¸å…³"></a>Fuzzing ç»“æœç›¸å…³</h2><h3 id="1-Crashï¼šè®°å½•-crash-ä¿¡æ¯"><a href="#1-Crashï¼šè®°å½•-crash-ä¿¡æ¯" class="headerlink" title="1. Crashï¼šè®°å½• crash ä¿¡æ¯"></a>1. Crashï¼šè®°å½• crash ä¿¡æ¯</h3><p><code>manager.go</code> ä¸­å®šä¹‰äº†<code>Crash</code> ç»“æ„ä½“ç”¨ä»¥è®°å½•äº§ç”Ÿ crash çš„ VMã€æœºå™¨ä¿¡æ¯ç­‰ï¼Œ<strong>çœŸæ­£çš„ crash ä¿¡æ¯ä¸»è¦å­˜æ”¾åœ¨ä¸€ä¸ª <code>Report</code> ç»“æ„ä½“ä¸­</strong>ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> Crash <span class="hljs-keyword">struct</span> &#123;<br>	vmIndex <span class="hljs-type">int</span><br>	hub     <span class="hljs-type">bool</span> <span class="hljs-comment">// this crash was created based on a repro from hub</span><br>	*report.Report<br>	machineInfo []<span class="hljs-type">byte</span><br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="2-Reportï¼šå•æ¬¡æ‰§è¡Œç»“æœæŠ¥å‘Š"><a href="#2-Reportï¼šå•æ¬¡æ‰§è¡Œç»“æœæŠ¥å‘Š" class="headerlink" title="2. Reportï¼šå•æ¬¡æ‰§è¡Œç»“æœæŠ¥å‘Š"></a>2. Reportï¼šå•æ¬¡æ‰§è¡Œç»“æœæŠ¥å‘Š</h3><p><code>pkg/report/rteport.go</code> ä¸­çš„ <code>Report</code> ç»“æ„ä½“ç”¨ä»¥è¡¨ç¤ºå•æ¬¡æ‰§è¡Œçš„ç»“æœï¼ŒåŒ…æ‹¬æ˜¯å¦äº§ç”Ÿäº† crashã€Oops çš„ä¿¡æ¯ç­‰ç­‰ï¼š</p>
<ul>
<li><p><code>Title</code>ï¼š<strong>Oops çš„ç¬¬ä¸€è¡Œæ–‡æœ¬ï¼Œç”¨æ¥æ ‡è¯†ç‰¹å®šç±»å‹çš„ crash</strong></p>
<blockquote>
<p>ä¾‹å¦‚ <code>BUG: unable to handle page fault for address: ffffffff81001619</code> è¿™æ ·çš„</p>
</blockquote>
</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> Report <span class="hljs-keyword">struct</span> &#123;<br>	<span class="hljs-comment">// Title contains a representative description of the first oops.</span><br>	Title <span class="hljs-type">string</span><br>	<span class="hljs-comment">// Alternative titles, used for better deduplication.</span><br>	<span class="hljs-comment">// If two crashes have a non-empty intersection of Title/AltTitles, they are considered the same bug.</span><br>	AltTitles []<span class="hljs-type">string</span><br>	<span class="hljs-comment">// Bug type (e.g. hang, memory leak, etc).</span><br>	Type Type<br>	<span class="hljs-comment">// The indicative function name.</span><br>	Frame <span class="hljs-type">string</span><br>	<span class="hljs-comment">// Report contains whole oops text.</span><br>	Report []<span class="hljs-type">byte</span><br>	<span class="hljs-comment">// Output contains whole raw console output as passed to Reporter.Parse.</span><br>	Output []<span class="hljs-type">byte</span><br>	<span class="hljs-comment">// StartPos/EndPos denote region of output with oops message(s).</span><br>	StartPos <span class="hljs-type">int</span><br>	EndPos   <span class="hljs-type">int</span><br>	<span class="hljs-comment">// SkipPos is position in output where parsing for the next report should start.</span><br>	SkipPos <span class="hljs-type">int</span><br>	<span class="hljs-comment">// Suppressed indicates whether the report should not be reported to user.</span><br>	Suppressed <span class="hljs-type">bool</span><br>	<span class="hljs-comment">// Corrupted indicates whether the report is truncated of corrupted in some other way.</span><br>	Corrupted <span class="hljs-type">bool</span><br>	<span class="hljs-comment">// CorruptedReason contains reason why the report is marked as corrupted.</span><br>	CorruptedReason <span class="hljs-type">string</span><br>	<span class="hljs-comment">// Recipients is a list of RecipientInfo with Email, Display Name, and type.</span><br>	Recipients vcs.Recipients<br>	<span class="hljs-comment">// GuiltyFile is the source file that we think is to blame for the crash  (filled in by Symbolize).</span><br>	GuiltyFile <span class="hljs-type">string</span><br>	<span class="hljs-comment">// reportPrefixLen is length of additional prefix lines that we added before actual crash report.</span><br>	reportPrefixLen <span class="hljs-type">int</span><br>	<span class="hljs-comment">// symbolized is set if the report is symbolized.</span><br>	symbolized <span class="hljs-type">bool</span><br>&#125;<br></code></pre></td></tr></table></figure>





<h1 id="0x02-main-ï¼šåŠ è½½é…ç½®æ–‡ä»¶ï¼Œå¯åŠ¨-manager"><a href="#0x02-main-ï¼šåŠ è½½é…ç½®æ–‡ä»¶ï¼Œå¯åŠ¨-manager" class="headerlink" title="0x02. main()ï¼šåŠ è½½é…ç½®æ–‡ä»¶ï¼Œå¯åŠ¨ manager"></a>0x02. main()ï¼šåŠ è½½é…ç½®æ–‡ä»¶ï¼Œå¯åŠ¨ manager</h1><p><code>syz-manager</code> çš„ <code>main()</code> å‡½æ•°å…¶å®æ¯”è¾ƒç®€å•ï¼Œä¸»è¦å°±æ˜¯è½½å…¥é…ç½®æ–‡ä»¶ä¿¡æ¯å¹¶è°ƒç”¨ <code>RunManager()</code> ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>	<span class="hljs-keyword">if</span> prog.GitRevision == <span class="hljs-string">&quot;&quot;</span> &#123;<br>		log.Fatalf(<span class="hljs-string">&quot;bad syz-manager build: build with make, run bin/syz-manager&quot;</span>)<br>	&#125;<br>	flag.Parse()<br>	log.EnableLogCaching(<span class="hljs-number">1000</span>, <span class="hljs-number">1</span>&lt;&lt;<span class="hljs-number">20</span>)<br>	cfg, err := mgrconfig.LoadFile(*flagConfig)<br>	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>		log.Fatalf(<span class="hljs-string">&quot;%v&quot;</span>, err)<br>	&#125;<br>	RunManager(cfg)<br>&#125;<br></code></pre></td></tr></table></figure>

<blockquote>
<p><del>ğŸ‘´å¯»æ€å¥½åƒæ²¡ä»€ä¹ˆå¥½è¯´çš„</del></p>
</blockquote>
<h1 id="0x03-RunManager-ï¼šè¿›è¡Œåˆå§‹åŒ–å·¥ä½œ"><a href="#0x03-RunManager-ï¼šè¿›è¡Œåˆå§‹åŒ–å·¥ä½œ" class="headerlink" title="0x03. RunManager()ï¼šè¿›è¡Œåˆå§‹åŒ–å·¥ä½œ"></a>0x03. RunManager()ï¼šè¿›è¡Œåˆå§‹åŒ–å·¥ä½œ</h1><h3 id="Step-1-åˆå§‹åŒ–-VM-Pool"><a href="#Step-1-åˆå§‹åŒ–-VM-Pool" class="headerlink" title="Step 1. åˆå§‹åŒ– VM Pool"></a>Step 1. åˆå§‹åŒ– VM Pool</h3><p>é¦–å…ˆæ˜¯åˆå§‹åŒ– VM Poolï¼Œè¿™é‡Œè°ƒç”¨äº† <code>vm/vm.go</code> ä¸­çš„ <code>Create()</code> æ¥å®Œæˆ VM pool çš„åˆ›å»º</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">var</span> vmPool *vm.Pool<br>   <span class="hljs-comment">// &quot;none&quot; ç±»å‹å¯¹äºè°ƒè¯•/å¼€å‘è€Œè¨€æ˜¯ä¸€ç§ç‰¹æ®Šæƒ…å†µï¼Œmanager å¹¶ä¸ä¼šå¯åŠ¨ä»»ä½• VMï¼Œ</span><br>   <span class="hljs-comment">// ä½†ç›¸åº”çš„æ˜¯ä½ åº”å½“æ‰‹åŠ¨å¯åŠ¨ VM å¹¶åœ¨æ­¤å¯åŠ¨ syz-fuzzer.</span><br><span class="hljs-keyword">if</span> cfg.Type != <span class="hljs-string">&quot;none&quot;</span> &#123;<br>	<span class="hljs-keyword">var</span> err <span class="hljs-type">error</span><br>	vmPool, err = vm.Create(cfg, *flagDebug)<br>	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>		log.Fatalf(<span class="hljs-string">&quot;%v&quot;</span>, err)<br>	&#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>è¯¥å‡½æ•°ä¸»è¦å°±æ˜¯è·å– VM ç±»å‹ã€å°è£…ä¸€ä¸ª Env ç»“æ„ä½“ã€è°ƒç”¨å¯¹åº”ç±»å‹ VM Pool çš„æ„é€ å‡½æ•°ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// Create åˆ›å»ºä¸€ä¸ªå¯ç”¨äºåˆ›å»ºç‹¬ç«‹ VMs çš„ VM pool.</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">Create</span><span class="hljs-params">(cfg *mgrconfig.Config, debug <span class="hljs-type">bool</span>)</span></span> (*Pool, <span class="hljs-type">error</span>) &#123;<br>	typ, ok := vmimpl.Types[cfg.Type]<br>	<span class="hljs-keyword">if</span> !ok &#123;<br>		<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, fmt.Errorf(<span class="hljs-string">&quot;unknown instance type &#x27;%v&#x27;&quot;</span>, cfg.Type)<br>	&#125;<br>	env := &amp;vmimpl.Env&#123;<br>		Name:      cfg.Name,<br>		OS:        cfg.TargetOS,<br>		Arch:      cfg.TargetVMArch,<br>		Workdir:   cfg.Workdir,<br>		Image:     cfg.Image,<br>		SSHKey:    cfg.SSHKey,<br>		SSHUser:   cfg.SSHUser,<br>		Timeouts:  cfg.Timeouts,<br>		Debug:     debug,<br>		Config:    cfg.VM,<br>		KernelSrc: cfg.KernelSrc,<br>	&#125;<br>	impl, err := typ.Ctor(env)<br>	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>		<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, err<br>	&#125;<br>	<span class="hljs-keyword">return</span> &amp;Pool&#123;<br>		impl:     impl,<br>		workdir:  env.Workdir,<br>		template: cfg.WorkdirTemplate,<br>		timeouts: cfg.Timeouts,<br>	&#125;, <span class="hljs-literal">nil</span><br>&#125;<br></code></pre></td></tr></table></figure>



<h3 id="Step-2-åˆå§‹åŒ–-Managerï¼Œè½½å…¥è¯­æ–™åº“ï¼Œå»ºç«‹é€šä¿¡æœåŠ¡å™¨"><a href="#Step-2-åˆå§‹åŒ–-Managerï¼Œè½½å…¥è¯­æ–™åº“ï¼Œå»ºç«‹é€šä¿¡æœåŠ¡å™¨" class="headerlink" title="Step 2. åˆå§‹åŒ– Managerï¼Œè½½å…¥è¯­æ–™åº“ï¼Œå»ºç«‹é€šä¿¡æœåŠ¡å™¨"></a>Step 2. åˆå§‹åŒ– Managerï¼Œè½½å…¥è¯­æ–™åº“ï¼Œå»ºç«‹é€šä¿¡æœåŠ¡å™¨</h3><p>éšåä¼šåˆ›å»ºç”¨äºå­˜å‚¨ crash çš„æ–‡ä»¶å¤¹ä¸ä¸€ä¸ªæ–°çš„ Reporter å®ä¾‹ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs go">crashdir := filepath.Join(cfg.Workdir, <span class="hljs-string">&quot;crashes&quot;</span>)<br>osutil.MkdirAll(crashdir)<br><br>reporter, err := report.NewReporter(cfg)<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>	log.Fatalf(<span class="hljs-string">&quot;%v&quot;</span>, err)<br>&#125;<br></code></pre></td></tr></table></figure>

<p>æ¥ä¸‹æ¥åˆ›å»ºä¸€ä¸ªåŸºæœ¬çš„ Manager å®ä¾‹ï¼Œç„¶åæ˜¯å››æ­¥èµ°ï¼š</p>
<ul>
<li><p><code>preloadCorpus()</code>ï¼šæ£€æŸ¥ <code>corpus.db</code> æ–‡ä»¶æ˜¯å¦å­˜åœ¨ï¼ˆè‹¥ä¸å­˜åœ¨åˆ™åˆ›å»ºï¼‰å¹¶è½½å…¥ <code>sys/è¦fuzzçš„OS/test</code> ç›®å½•ä¸‹çš„æµ‹è¯•ç”¨æ¨¡æ¿</p>
<blockquote>
<p>è¯­æ–™åº“è½½å…¥çš„æ¨¡æ¿æœ¬èº«ç±»ä¼¼äº syzlang æ–‡ä»¶ï¼Œä¾‹å¦‚ <code>sys/linux/pipe</code>ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs syzlang">pipe2(&amp;(0x7f0000000000)=&#123;&lt;r0=&gt;0x0, &lt;r1=&gt;0x0&#125;, 0x0)<br>close(r0)<br>close(r1)<br></code></pre></td></tr></table></figure>
</blockquote>
</li>
<li><p><code>initStats()</code>ï¼šæ³¨å†Œä¸€ä¸ª prometheus ç›‘è§†å™¨ï¼ˆä¸€ä¸ªå¼€æºçš„ç›‘è§†&amp;é¢„è­¦å·¥å…·åŒ…ï¼‰</p>
</li>
<li><p><code>initHTTP()</code>ï¼šåˆ›å»ºä¸€ä¸ª HTTP æœåŠ¡å™¨å¹¶æ³¨å†Œä¸€ç³»åˆ—çš„ç›®å½•ï¼ˆç”¨ä»¥ä¾›ä½¿ç”¨è€…è®¿é—®ï¼‰</p>
</li>
<li><p><code>collectUsedFiles()</code>ï¼šæ£€æŸ¥æ‰€éœ€æ–‡ä»¶æ˜¯å¦å­˜åœ¨</p>
</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs go">mgr := &amp;Manager&#123;<br>	cfg:              cfg,<br>	vmPool:           vmPool,<br>	target:           cfg.Target,<br>	sysTarget:        cfg.SysTarget,<br>	reporter:         reporter,<br>	crashdir:         crashdir,<br>	startTime:        time.Now(),<br>	stats:            &amp;Stats&#123;haveHub: cfg.HubClient != <span class="hljs-string">&quot;&quot;</span>&#125;,<br>	crashTypes:       <span class="hljs-built_in">make</span>(<span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]<span class="hljs-type">bool</span>),<br>	corpus:           <span class="hljs-built_in">make</span>(<span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]CorpusItem),<br>	disabledHashes:   <span class="hljs-built_in">make</span>(<span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]<span class="hljs-keyword">struct</span>&#123;&#125;),<br>	memoryLeakFrames: <span class="hljs-built_in">make</span>(<span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]<span class="hljs-type">bool</span>),<br>	dataRaceFrames:   <span class="hljs-built_in">make</span>(<span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]<span class="hljs-type">bool</span>),<br>	fresh:            <span class="hljs-literal">true</span>,<br>	vmStop:           <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> <span class="hljs-type">bool</span>),<br>	hubReproQueue:    <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> *Crash, <span class="hljs-number">10</span>),<br>	needMoreRepros:   <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> <span class="hljs-keyword">chan</span> <span class="hljs-type">bool</span>),<br>	reproRequest:     <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> <span class="hljs-keyword">chan</span> <span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]<span class="hljs-type">bool</span>),<br>	usedFiles:        <span class="hljs-built_in">make</span>(<span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]time.Time),<br>	saturatedCalls:   <span class="hljs-built_in">make</span>(<span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]<span class="hljs-type">bool</span>),<br>&#125;<br><br>mgr.preloadCorpus()<br>mgr.initStats() <span class="hljs-comment">// åˆå§‹åŒ– prometheus å˜é‡.</span><br>mgr.initHTTP()  <span class="hljs-comment">// åˆ›å»º HTTP æœåŠ¡.</span><br>mgr.collectUsedFiles()<br></code></pre></td></tr></table></figure>

<p>ä¹‹ååˆ›å»ºä¸€ä¸ª RPC Serverï¼Œç”¨ä»¥åœ¨ Host ä¸ Guest VMs ä¹‹é—´è¿›è¡Œé€šä¿¡ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// Create ä¸º fuzzer åˆ›å»º PRC æœåŠ¡å™¨.</span><br>mgr.serv, err = startRPCServer(mgr)<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>	log.Fatalf(<span class="hljs-string">&quot;failed to create rpc server: %v&quot;</span>, err)<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="Step-3-åˆå§‹åŒ–-dashboard-ç›¸å…³"><a href="#Step-3-åˆå§‹åŒ–-dashboard-ç›¸å…³" class="headerlink" title="Step 3.  åˆå§‹åŒ– dashboard ç›¸å…³"></a><em>Step 3.  åˆå§‹åŒ– dashboard ç›¸å…³</em></h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">if</span> cfg.DashboardAddr != <span class="hljs-string">&quot;&quot;</span> &#123;<br>	mgr.dash, err = dashapi.New(cfg.DashboardClient, cfg.DashboardAddr, cfg.DashboardKey)<br>	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>		log.Fatalf(<span class="hljs-string">&quot;failed to create dashapi connection: %v&quot;</span>, err)<br>	&#125;<br>&#125;<br><br><span class="hljs-keyword">if</span> !cfg.AssetStorage.IsEmpty() &#123;<br>	mgr.assetStorage, err = asset.StorageFromConfig(cfg.AssetStorage, mgr.dash)<br>	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>		log.Fatalf(<span class="hljs-string">&quot;failed to init asset storage: %v&quot;</span>, err)<br>	&#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="Step-4-åˆ›å»ºã€æ—¥å¿—è¾“å‡ºã€‘åç¨‹"><a href="#Step-4-åˆ›å»ºã€æ—¥å¿—è¾“å‡ºã€‘åç¨‹" class="headerlink" title="Step 4. åˆ›å»ºã€æ—¥å¿—è¾“å‡ºã€‘åç¨‹"></a>Step 4. åˆ›å»ºã€æ—¥å¿—è¾“å‡ºã€‘åç¨‹</h3><p>æ¥ä¸‹æ¥ä¼šæ–°èµ·ä¸€ä¸ªåç¨‹è¿›è¡Œæ•°æ®è®°å½•çš„å·¥ä½œï¼Œå†…éƒ¨å…¶å®å°±æ˜¯ä¸€ä¸ª<strong>æ¯ 10s è¿›è¡Œä¸€æ¬¡è¿›åº¦é‡‡é›†å¹¶è¾“å‡ºæ—¥å¿—çš„æ— é™å¾ªç¯</strong>ï¼Œä¸»è¦æ˜¯é‡‡é›†æ‰§è¡Œä¿¡æ¯ã€è¯­æ–™è¦†ç›–ç‡ã€crashes ä¿¡æ¯ç­‰ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br>	<span class="hljs-keyword">for</span> lastTime := time.Now(); ; &#123;<br>		time.Sleep(<span class="hljs-number">10</span> * time.Second)<br>		now := time.Now()<br>		diff := now.Sub(lastTime)<br>		lastTime = now<br>		mgr.mu.Lock()<br>		<span class="hljs-keyword">if</span> mgr.firstConnect.IsZero() &#123;<br>			mgr.mu.Unlock()<br>			<span class="hljs-keyword">continue</span><br>		&#125;<br>		mgr.fuzzingTime += diff * time.Duration(atomic.LoadUint32(&amp;mgr.numFuzzing))<br>		executed := mgr.stats.execTotal.get()<br>		crashes := mgr.stats.crashes.get()<br>		corpusCover := mgr.stats.corpusCover.get()<br>		corpusSignal := mgr.stats.corpusSignal.get()<br>		maxSignal := mgr.stats.maxSignal.get()<br>		mgr.mu.Unlock()<br>		numReproducing := atomic.LoadUint32(&amp;mgr.numReproducing)<br>		numFuzzing := atomic.LoadUint32(&amp;mgr.numFuzzing)<br><br>		log.Logf(<span class="hljs-number">0</span>, <span class="hljs-string">&quot;VMs %v, executed %v, cover %v, signal %v/%v, crashes %v, repro %v&quot;</span>,<br>			numFuzzing, executed, corpusCover, corpusSignal, maxSignal, crashes, numReproducing)<br>	&#125;<br>&#125;()<br></code></pre></td></tr></table></figure>

<h3 id="Step-5-åˆ›å»º-bench-åç¨‹ï¼ˆæ¯éš”ä¸€åˆ†é’Ÿæœ€å°åŒ–è¯­æ–™åº“å¹¶å°†-bench-data-å†™å…¥-bench-æ–‡ä»¶ï¼‰"><a href="#Step-5-åˆ›å»º-bench-åç¨‹ï¼ˆæ¯éš”ä¸€åˆ†é’Ÿæœ€å°åŒ–è¯­æ–™åº“å¹¶å°†-bench-data-å†™å…¥-bench-æ–‡ä»¶ï¼‰" class="headerlink" title="Step 5. åˆ›å»º bench åç¨‹ï¼ˆæ¯éš”ä¸€åˆ†é’Ÿæœ€å°åŒ–è¯­æ–™åº“å¹¶å°† bench data å†™å…¥ bench æ–‡ä»¶ï¼‰"></a>Step 5. åˆ›å»º bench åç¨‹ï¼ˆæ¯éš”ä¸€åˆ†é’Ÿæœ€å°åŒ–è¯­æ–™åº“å¹¶å°† bench data å†™å…¥ bench æ–‡ä»¶ï¼‰</h3><p>è¿™é‡Œä¼šåˆ¤æ–­å‘½ä»¤è¡Œä¼ å…¥å‚æ•°æ˜¯å¦æœ‰ <code>bench=</code>ï¼Œè‹¥æ˜¯åˆ™è°ƒç”¨ <code>initBench()</code>ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">if</span> *flagBench != <span class="hljs-string">&quot;&quot;</span> &#123;<br>	mgr.initBench()<br>&#125;<br></code></pre></td></tr></table></figure>

<p> è¿™é‡Œçš„ <code>flagBench</code> æ˜¯ä¸€ä¸ªå…¨å±€çš„ flag å˜é‡ï¼Œgolang æä¾›äº†ä¸€ä¸ª <code>flag</code> åŒ…ç”¨ä»¥å¤„ç†å‘½ä»¤è¡Œå‚æ•°ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">var</span> (<br>	flagConfig = flag.String(<span class="hljs-string">&quot;config&quot;</span>, <span class="hljs-string">&quot;&quot;</span>, <span class="hljs-string">&quot;configuration file&quot;</span>)<br>	flagDebug  = flag.Bool(<span class="hljs-string">&quot;debug&quot;</span>, <span class="hljs-literal">false</span>, <span class="hljs-string">&quot;dump all VM output to console&quot;</span>)<br>	flagBench  = flag.String(<span class="hljs-string">&quot;bench&quot;</span>, <span class="hljs-string">&quot;&quot;</span>, <span class="hljs-string">&quot;write execution statistics into this file periodically&quot;</span>)<br>)<br></code></pre></td></tr></table></figure>

<p><code>initBench()</code> ä¼šå¯åŠ¨ä¸€ä¸ªåç¨‹ï¼Œä¸»è¦å°±æ˜¯ä¸€ä¸ªæ¯éš”ä¸€åˆ†é’Ÿè¿è¡Œä¸€æ¬¡çš„å¾ªç¯ï¼š</p>
<ul>
<li>è°ƒç”¨ <code>minimizeCorpus()</code> å°†è¯­æ–™åº“è¿›è¡Œæœ€å°åŒ–</li>
<li>å‘ <code>bench</code> å‚æ•°æŒ‡å®šçš„æ–‡ä»¶å½“ä¸­å†™å…¥ <code>è¯­æ–™åº“é•¿åº¦ã€å¯åŠ¨æ—¶é—´ã€fuzzing æ—¶é—´\n</code></li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(mgr *Manager)</span></span> initBench() &#123;<br>	f, err := os.OpenFile(*flagBench, os.O_WRONLY|os.O_CREATE|os.O_EXCL, osutil.DefaultFilePerm)<br>	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>		log.Fatalf(<span class="hljs-string">&quot;failed to open bench file: %v&quot;</span>, err)<br>	&#125;<br>	<span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br>		<span class="hljs-keyword">for</span> &#123;<br>			time.Sleep(time.Minute)<br>			vals := mgr.stats.all()<br>			mgr.mu.Lock()<br>			<span class="hljs-keyword">if</span> mgr.firstConnect.IsZero() &#123;<br>				mgr.mu.Unlock()<br>				<span class="hljs-keyword">continue</span><br>			&#125;<br>			mgr.minimizeCorpus()<br>			vals[<span class="hljs-string">&quot;corpus&quot;</span>] = <span class="hljs-type">uint64</span>(<span class="hljs-built_in">len</span>(mgr.corpus))<br>			vals[<span class="hljs-string">&quot;uptime&quot;</span>] = <span class="hljs-type">uint64</span>(time.Since(mgr.firstConnect)) / <span class="hljs-number">1e9</span><br>			vals[<span class="hljs-string">&quot;fuzzing&quot;</span>] = <span class="hljs-type">uint64</span>(mgr.fuzzingTime) / <span class="hljs-number">1e9</span><br>			mgr.mu.Unlock()<br><br>			data, err := json.MarshalIndent(vals, <span class="hljs-string">&quot;&quot;</span>, <span class="hljs-string">&quot;  &quot;</span>)<br>			<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>				log.Fatalf(<span class="hljs-string">&quot;failed to serialize bench data&quot;</span>)<br>			&#125;<br>			<span class="hljs-keyword">if</span> _, err := f.Write(<span class="hljs-built_in">append</span>(data, <span class="hljs-string">&#x27;\n&#x27;</span>)); err != <span class="hljs-literal">nil</span> &#123;<br>				log.Fatalf(<span class="hljs-string">&quot;failed to write bench data&quot;</span>)<br>			&#125;<br>		&#125;<br>	&#125;()<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="Step-6-å¯åŠ¨-dashboard-åç¨‹ï¼Œè¿›å…¥ä¸‹ä¸€é˜¶æ®µ"><a href="#Step-6-å¯åŠ¨-dashboard-åç¨‹ï¼Œè¿›å…¥ä¸‹ä¸€é˜¶æ®µ" class="headerlink" title="Step 6. å¯åŠ¨ dashboard åç¨‹ï¼Œè¿›å…¥ä¸‹ä¸€é˜¶æ®µ"></a>Step 6. å¯åŠ¨ dashboard åç¨‹ï¼Œè¿›å…¥ä¸‹ä¸€é˜¶æ®µ</h3><p>æ¥ä¸‹æ¥ä¼šå¯åŠ¨ä¸€ä¸ªæ–°çš„åç¨‹ï¼Œä¸»è¦æ˜¯ <em>æ¯éš”ä¸€åˆ†é’Ÿä¸ŠæŠ¥ä¸€æ¬¡ syz-manager çš„çŠ¶æ€ï¼Œè¿™é‡Œä¸å†å±•å¼€</em> ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">if</span> mgr.dash != <span class="hljs-literal">nil</span> &#123;<br>	<span class="hljs-keyword">go</span> mgr.dashboardReporter()<br>&#125;<br></code></pre></td></tr></table></figure>

<p>æœ€åä¼šç®€å•æ£€æŸ¥ä¸€ä¸‹ VM Pool ï¼Œéšåè°ƒç”¨ <code>vmLoop()</code> è¿›å…¥ä¸‹ä¸€é˜¶æ®µï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs go">	osutil.HandleInterrupts(vm.Shutdown)<br>	<span class="hljs-keyword">if</span> mgr.vmPool == <span class="hljs-literal">nil</span> &#123;<br>		log.Logf(<span class="hljs-number">0</span>, <span class="hljs-string">&quot;no VMs started (type=none)&quot;</span>)<br>		log.Logf(<span class="hljs-number">0</span>, <span class="hljs-string">&quot;you are supposed to start syz-fuzzer manually as:&quot;</span>)<br>		log.Logf(<span class="hljs-number">0</span>, <span class="hljs-string">&quot;syz-fuzzer -manager=manager.ip:%v [other flags as necessary]&quot;</span>, mgr.serv.port)<br>		&lt;-vm.Shutdown<br>		<span class="hljs-keyword">return</span><br>	&#125;<br>	mgr.vmLoop()<br>&#125;<br></code></pre></td></tr></table></figure>



<h1 id="0x04-vmLoop-ï¼šå¯åŠ¨-fuzzingï¼Œç®¡æ§æ•´ä½“æµç¨‹"><a href="#0x04-vmLoop-ï¼šå¯åŠ¨-fuzzingï¼Œç®¡æ§æ•´ä½“æµç¨‹" class="headerlink" title="0x04. vmLoop()ï¼šå¯åŠ¨ fuzzingï¼Œç®¡æ§æ•´ä½“æµç¨‹"></a>0x04. vmLoop()ï¼šå¯åŠ¨ fuzzingï¼Œç®¡æ§æ•´ä½“æµç¨‹</h1><h2 id="ä¸€ã€VM-åˆ†ç»„ï¼Œåˆå§‹åŒ–èµ„æºæ± ç­‰å˜é‡"><a href="#ä¸€ã€VM-åˆ†ç»„ï¼Œåˆå§‹åŒ–èµ„æºæ± ç­‰å˜é‡" class="headerlink" title="ä¸€ã€VM åˆ†ç»„ï¼Œåˆå§‹åŒ–èµ„æºæ± ç­‰å˜é‡"></a>ä¸€ã€VM åˆ†ç»„ï¼Œåˆå§‹åŒ–èµ„æºæ± ç­‰å˜é‡</h2><p>ä¸€å¼€å§‹é¦–å…ˆä¼šå°†æ‰€æœ‰çš„ VM åˆ†ä¸ºä¸¤ç»„ï¼šä¸€ç»„è´Ÿè´£ fuzzingï¼Œä¸€ç»„è´Ÿè´£å¤ç° crash ï¼ˆ<code>maxReproVMs</code>ï¼‰ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// Manager needs to be refactored (#605).</span><br><span class="hljs-comment">// nolint: gocyclo, gocognit, funlen</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(mgr *Manager)</span></span> vmLoop() &#123;<br>	log.Logf(<span class="hljs-number">0</span>, <span class="hljs-string">&quot;booting test machines...&quot;</span>)<br>	log.Logf(<span class="hljs-number">0</span>, <span class="hljs-string">&quot;wait for the connection from test machine...&quot;</span>)<br>	instancesPerRepro := <span class="hljs-number">4</span><br>	vmCount := mgr.vmPool.Count()<br>	maxReproVMs := vmCount - mgr.cfg.FuzzingVMs<br>	<span class="hljs-keyword">if</span> instancesPerRepro &gt; maxReproVMs &amp;&amp; maxReproVMs &gt; <span class="hljs-number">0</span> &#123;<br>		instancesPerRepro = maxReproVMs<br>	&#125;<br></code></pre></td></tr></table></figure>

<p>éšåä¼šè°ƒç”¨ <code>SequentialResourcePool()</code> æ–°å»ºä¸€ä¸ª <code>ResourcePool</code> é˜Ÿåˆ—ï¼Œä¸»è¦è´Ÿè´£å¯¹<strong>ç©ºé—² VM ä½¿ç”¨é¡ºåº</strong>çš„è°ƒæ§ ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs go">instances := SequentialResourcePool(vmCount, <span class="hljs-number">10</span>*time.Second*mgr.cfg.Timeouts.Scale)<br></code></pre></td></tr></table></figure>

<p>æ¥ä¸‹æ¥ä¼šåˆå§‹åŒ–ä¸€ç³»åˆ—çš„å˜é‡ï¼š</p>
<ul>
<li><code>runDone</code>ï¼šä¿å­˜ fuzzing ç»“æœä¸º crash çš„ <strong>Crash é˜Ÿåˆ—</strong></li>
<li><code>pendingRepro</code>ï¼šæ ‡è¯†<strong>å¾…å¤ç°çš„ Crash</strong></li>
<li><code>reproducing</code>ï¼šæ ‡è¯†<strong>æŸä¸ªç±»å‹ Crash</strong> æ˜¯å¦å‡†å¤‡è¢«å¤ç°</li>
<li><code>reproQueue</code>ï¼šCrash çš„å¤ç°é˜Ÿåˆ—</li>
<li><code>reproDone</code>ï¼šCrash çš„å¤ç°ç»“æœ</li>
<li><code>stopPending</code>ï¼šç­‰å¾…åœæ­¢æ ‡å¿—ä½</li>
<li><code>shutdown</code>ï¼šå·¥ä½œç»ˆæ­¢æ ‡å¿—ä½</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs go">runDone := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> *RunResult, <span class="hljs-number">1</span>)<br>pendingRepro := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">map</span>[*Crash]<span class="hljs-type">bool</span>)<br>reproducing := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]<span class="hljs-type">bool</span>)<br><span class="hljs-keyword">var</span> reproQueue []*Crash<br>reproDone := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> *ReproResult, <span class="hljs-number">1</span>)<br>stopPending := <span class="hljs-literal">false</span><br>shutdown := vm.Shutdown<br></code></pre></td></tr></table></figure>

<p>æœ€åè¿›å…¥åˆ°ä¸€ä¸ªå¤§å¾ªç¯ä¸­ï¼Œè¿™ä¸ªå¤§å¾ªç¯æ‰æ˜¯çœŸæ­£çš„ fuzzing è°ƒæ§æµç¨‹</p>
<h2 id="äºŒã€å¤–å±‚å¤§å¾ªç¯ï¼šè°ƒé…ç©ºé—²-VM-è¿›è¡Œ-fuzz-amp-crash-reproï¼Œç­‰å¾…å¤„ç†ä¸åŒ-channel-æ•°æ®"><a href="#äºŒã€å¤–å±‚å¤§å¾ªç¯ï¼šè°ƒé…ç©ºé—²-VM-è¿›è¡Œ-fuzz-amp-crash-reproï¼Œç­‰å¾…å¤„ç†ä¸åŒ-channel-æ•°æ®" class="headerlink" title="äºŒã€å¤–å±‚å¤§å¾ªç¯ï¼šè°ƒé…ç©ºé—² VM è¿›è¡Œ fuzz &amp; crash reproï¼Œç­‰å¾…å¤„ç†ä¸åŒ channel æ•°æ®"></a>äºŒã€å¤–å±‚å¤§å¾ªç¯ï¼šè°ƒé…ç©ºé—² VM è¿›è¡Œ fuzz &amp; crash reproï¼Œç­‰å¾…å¤„ç†ä¸åŒ channel æ•°æ®</h2><p>å¤§å¾ªç¯çš„ç»ˆæ­¢æ¡ä»¶ä¸º <code>shutdown == nil</code> æˆ–æ˜¯ ResourcePool ä¸­çš„ VM æ•°é‡ä¸æ€»æ•°é‡ä¸ç›¸ç­‰ï¼Œè¿›å…¥å¾ªç¯åé¦–å…ˆä¼šè·å–å½“å‰æ‰€åœ¨é˜¶æ®µï¼š </p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">for</span> shutdown != <span class="hljs-literal">nil</span> || instances.Len() != vmCount &#123;<br>	mgr.mu.Lock()<br>	phase := mgr.phase<br>	mgr.mu.Unlock()<br></code></pre></td></tr></table></figure>

<h3 id="Step-1-å†…å±‚å°å¾ªç¯ï¼šè·å–å¾…å¤ç°-crash-åŠ å…¥å¤ç°é˜Ÿåˆ—"><a href="#Step-1-å†…å±‚å°å¾ªç¯ï¼šè·å–å¾…å¤ç°-crash-åŠ å…¥å¤ç°é˜Ÿåˆ—" class="headerlink" title="Step 1. å†…å±‚å°å¾ªç¯ï¼šè·å–å¾…å¤ç° crash åŠ å…¥å¤ç°é˜Ÿåˆ—"></a>Step 1. å†…å±‚å°å¾ªç¯ï¼šè·å–å¾…å¤ç° crash åŠ å…¥å¤ç°é˜Ÿåˆ—</h3><p>å°å¾ªç¯ä¼šéå† <code>pendingRepro</code> ä¸­çš„ crashï¼š</p>
<ul>
<li>è‹¥æœªè¢«å¤ç°åˆ™ä» pendingRepro ä¸­åˆ é™¤</li>
<li>è°ƒç”¨ <code>needRepro()</code> æ£€æŸ¥æ˜¯å¦éœ€è¦å¤ç°</li>
<li>æ ‡è®°è¯¥æ ‡é¢˜çš„ crash å·²åœ¨å¤ç°ï¼Œå¹¶åŠ å…¥å¤ç°é˜Ÿåˆ—ä¸­</li>
</ul>
<p>è¿™é‡Œçš„ <code>crash.Title</code> å…¶å®æ˜¯ <strong>Oops çš„ç¬¬ä¸€è¡Œæ–‡æœ¬ï¼Œ</strong>å³<strong>åŒä¸€æ—¶åˆ»ä»…ä¼šå¤ç°åŒç±» crash ä¸­çš„ä¸€ä¸ª</strong>ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">for</span> crash := <span class="hljs-keyword">range</span> pendingRepro &#123;<br>	<span class="hljs-keyword">if</span> reproducing[crash.Title] &#123;<br>		<span class="hljs-keyword">continue</span><br>	&#125;<br>	<span class="hljs-built_in">delete</span>(pendingRepro, crash)<br>	<span class="hljs-keyword">if</span> !mgr.needRepro(crash) &#123;<br>		<span class="hljs-keyword">continue</span><br>	&#125;<br>	log.Logf(<span class="hljs-number">1</span>, <span class="hljs-string">&quot;loop: add to repro queue &#x27;%v&#x27;&quot;</span>, crash.Title)<br>	reproducing[crash.Title] = <span class="hljs-literal">true</span><br>	reproQueue = <span class="hljs-built_in">append</span>(reproQueue, crash)<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="Step-2-åˆ¤æ–­æ˜¯å¦å¯ä»¥å¯¹-crash-è¿›è¡Œå¤ç°å¹¶è°ƒæ§-VM"><a href="#Step-2-åˆ¤æ–­æ˜¯å¦å¯ä»¥å¯¹-crash-è¿›è¡Œå¤ç°å¹¶è°ƒæ§-VM" class="headerlink" title="Step 2. åˆ¤æ–­æ˜¯å¦å¯ä»¥å¯¹ crash è¿›è¡Œå¤ç°å¹¶è°ƒæ§ VM"></a>Step 2. åˆ¤æ–­æ˜¯å¦å¯ä»¥å¯¹ crash è¿›è¡Œå¤ç°å¹¶è°ƒæ§ VM</h3><p>æ¥ä¸‹æ¥ä¼šè¾“å‡ºä¸€è¡Œæ—¥å¿—ï¼Œä¹‹åå®šä¹‰ä¸€ä¸ªé—­åŒ…å‡½æ•° <code>canRepro</code>ï¼Œç”¨æ¥åˆ¤æ–­<strong>å½“å‰æ˜¯å¦å¯ä»¥è¿›è¡Œ crash å¤ç°</strong>ï¼Œä¸»è¦åˆ¤æ–­ä»¥ä¸‹ä¸‰ä¸ªæ¡ä»¶æ˜¯å¦æ»¡è¶³ï¼š</p>
<ul>
<li>å½“å‰é˜¶æ®µæ˜¯å¦è¶…è¿‡ <code>phaseTriagedHub</code> </li>
<li>å¾…å¤ç°é˜Ÿåˆ— <code>reproQueue</code> æ˜¯å¦ä¸ä¸ºç©º</li>
<li>åŠ ä¸Šè¯¥ crash åæ‰€æœ‰ç”¨æ¥å¤ç° crash çš„ VM æ•°é‡æ˜¯å¦å°äº <code>maxReproVMs</code></li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs go">log.Logf(<span class="hljs-number">1</span>, <span class="hljs-string">&quot;loop: phase=%v shutdown=%v instances=%v/%v %+v repro: pending=%v reproducing=%v queued=%v&quot;</span>,<br>	phase, shutdown == <span class="hljs-literal">nil</span>, instances.Len(), vmCount, instances.Snapshot(),<br>	<span class="hljs-built_in">len</span>(pendingRepro), <span class="hljs-built_in">len</span>(reproducing), <span class="hljs-built_in">len</span>(reproQueue))<br><br>canRepro := <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> <span class="hljs-type">bool</span> &#123;<br>	<span class="hljs-keyword">return</span> phase &gt;= phaseTriagedHub &amp;&amp; <span class="hljs-built_in">len</span>(reproQueue) != <span class="hljs-number">0</span> &amp;&amp;<br>		(<span class="hljs-type">int</span>(atomic.LoadUint32(&amp;mgr.numReproducing))+<span class="hljs-number">1</span>)*instancesPerRepro &lt;= maxReproVMs<br>&#125;<br></code></pre></td></tr></table></figure>

<p>æ¥ä¸‹æ¥æ˜¯ä¸¤ä¸ªå°å¾ªç¯ï¼š</p>
<h4 id="â‘ -å¾ªç¯å¯åŠ¨åç¨‹è°ƒåº¦-VM-è¿›è¡Œ-crash-å¤ç°"><a href="#â‘ -å¾ªç¯å¯åŠ¨åç¨‹è°ƒåº¦-VM-è¿›è¡Œ-crash-å¤ç°" class="headerlink" title="â‘  å¾ªç¯å¯åŠ¨åç¨‹è°ƒåº¦ VM è¿›è¡Œ crash å¤ç°"></a>â‘  å¾ªç¯å¯åŠ¨åç¨‹è°ƒåº¦ VM è¿›è¡Œ crash å¤ç°</h4><p>ç¬¬ä¸€ä¸ªå°å¾ªç¯ä¼šå¾ªç¯åˆ¤æ–­æ˜¯å¦å¯ä»¥è¿›è¡Œ crash å¤ç°ï¼š</p>
<ul>
<li>è‹¥å¯ä»¥å¤ç°åˆ™ä»èµ„æºæ± é˜Ÿåˆ—ä¸­å–å‡ºä¸€ä¸ª VM idxï¼Œè‹¥èµ„æºæ± ä¸ºç©ºåˆ™ç›´æ¥è·³å‡º</li>
<li>ä» <code>reproQueue</code> ä¸­å–å‡ºä¸€ä¸ª crashï¼Œæ›´æ–° manager çš„ <code>numReproducing</code> è®¡æ•°</li>
<li>å¯åŠ¨ä¸€ä¸ªæ–°çš„åç¨‹è°ƒç”¨ <code>runRepro()</code> å¯¹è¯¥ crash è¿›è¡Œå¤ç°ï¼Œç»“æœè¾“å‡ºè‡³ <code>reproDone</code> é˜Ÿåˆ—ä¸­</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">if</span> shutdown != <span class="hljs-literal">nil</span> &#123;<br>	<span class="hljs-keyword">for</span> canRepro() &#123;<br>		vmIndexes := instances.Take(instancesPerRepro)<br>		<span class="hljs-keyword">if</span> vmIndexes == <span class="hljs-literal">nil</span> &#123;<br>			<span class="hljs-keyword">break</span><br>		&#125;<br>		last := <span class="hljs-built_in">len</span>(reproQueue) - <span class="hljs-number">1</span><br>		crash := reproQueue[last]<br>		reproQueue[last] = <span class="hljs-literal">nil</span><br>		reproQueue = reproQueue[:last]<br>		atomic.AddUint32(&amp;mgr.numReproducing, <span class="hljs-number">1</span>)<br>		log.Logf(<span class="hljs-number">1</span>, <span class="hljs-string">&quot;loop: starting repro of &#x27;%v&#x27; on instances %+v&quot;</span>, crash.Title, vmIndexes)<br>		<span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br>			reproDone &lt;- mgr.runRepro(crash, vmIndexes, instances.Put)<br>		&#125;()<br>	&#125;<br></code></pre></td></tr></table></figure>

<p> è€Œ <code>runRepro()</code> å…¶å®å°±æ˜¯ <code>repro.Run()</code> çš„ wrapper ï¼‹ ä¸€äº›é”™è¯¯æ£€æŸ¥åå°† VM idx æ”¾å›èµ„æºæ± ï¼Œè¿™é‡Œå°±ä¸å±•å¼€äº†ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(mgr *Manager)</span></span> runRepro(crash *Crash, vmIndexes []<span class="hljs-type">int</span>, putInstances <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(...<span class="hljs-type">int</span>)</span></span>) *ReproResult &#123;<br>	features := mgr.checkResult.Features<br>	res, stats, err := repro.Run(crash.Output, mgr.cfg, features, mgr.reporter, mgr.vmPool, vmIndexes)<br>    <span class="hljs-comment">//...</span><br></code></pre></td></tr></table></figure>

<p><code>Run()</code> ä¸€å¼€å§‹ä¸»è¦æ˜¯ä¸€äº›æ£€æŸ¥ï¼Œä¹‹åæ ¹æ® crash ç±»å‹çš„ä¸åŒè®¾ç½®ä¸åŒçš„å¤ç°æ—¶é—´ä¸Šé™ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">Run</span><span class="hljs-params">(crashLog []<span class="hljs-type">byte</span>, cfg *mgrconfig.Config, features *host.Features, reporter *report.Reporter,</span></span><br><span class="hljs-params"><span class="hljs-function">	vmPool *vm.Pool, vmIndexes []<span class="hljs-type">int</span>)</span></span> (*Result, *Stats, <span class="hljs-type">error</span>) &#123;<br>	<span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(vmIndexes) == <span class="hljs-number">0</span> &#123;<br>		<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, <span class="hljs-literal">nil</span>, fmt.Errorf(<span class="hljs-string">&quot;no VMs provided&quot;</span>)<br>	&#125;<br>	entries := cfg.Target.ParseLog(crashLog)<br>	<span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(entries) == <span class="hljs-number">0</span> &#123;<br>		<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, <span class="hljs-literal">nil</span>, fmt.Errorf(<span class="hljs-string">&quot;crash log does not contain any programs&quot;</span>)<br>	&#125;<br>	crashStart := <span class="hljs-built_in">len</span>(crashLog)<br>	crashTitle, crashType := <span class="hljs-string">&quot;&quot;</span>, report.Unknown<br>	<span class="hljs-keyword">if</span> rep := reporter.Parse(crashLog); rep != <span class="hljs-literal">nil</span> &#123;<br>		crashStart = rep.StartPos<br>		crashTitle = rep.Title<br>		crashType = rep.Type<br>	&#125;<br>	testTimeouts := []time.Duration&#123;<br>		<span class="hljs-number">3</span> * cfg.Timeouts.Program, <span class="hljs-comment">// ä»¥æ•è·æ›´ç®€å•çš„ crashes (å³ no races and no hangs)</span><br>		<span class="hljs-number">20</span> * cfg.Timeouts.Program,<br>		cfg.Timeouts.NoOutputRunningTime, <span class="hljs-comment">// ä»¥æ•è· &quot;no output&quot;, races and hangs</span><br>	&#125;<br>	<span class="hljs-keyword">switch</span> &#123;<br>	<span class="hljs-keyword">case</span> crashTitle == <span class="hljs-string">&quot;&quot;</span>:<br>		crashTitle = <span class="hljs-string">&quot;no output/lost connection&quot;</span><br>		<span class="hljs-comment">// Lost connection å¯ä»¥è¢«æ›´å¿«åœ°æ£€æµ‹åˆ°,</span><br>		<span class="hljs-comment">// ä½†ç†è®ºä¸Šè‹¥å…¶ç”±ç«äº‰é€ æˆï¼Œåˆ™å¯èƒ½éœ€è¦æœ€é•¿çš„ timeout.</span><br>		<span class="hljs-comment">// No output ä»…èƒ½åœ¨æœ€å¤§çš„ timeout ä¸‹è¢«å¤ç°.</span><br>		<span class="hljs-comment">// ä½œä¸ºå¦¥åï¼Œæˆ‘ä»¬ä½¿ç”¨æœ€å°ä¸æœ€å¤§çš„ timeouts.</span><br>		testTimeouts = []time.Duration&#123;testTimeouts[<span class="hljs-number">0</span>], testTimeouts[<span class="hljs-number">2</span>]&#125;<br>	<span class="hljs-keyword">case</span> crashType == report.MemoryLeak:<br>		<span class="hljs-comment">// ç”±äºæ˜‚è´µçš„è®¾ç½®ä¸æ‰«æï¼Œå†…å­˜æ³„éœ²ä¸èƒ½è¢«å¾ˆå¿«åœ°æ£€æµ‹åˆ°.</span><br>		testTimeouts = testTimeouts[<span class="hljs-number">1</span>:]<br>	<span class="hljs-keyword">case</span> crashType == report.Hang:<br>		testTimeouts = testTimeouts[<span class="hljs-number">2</span>:]<br>	&#125;<br></code></pre></td></tr></table></figure>

<p>æ¥ä¸‹æ¥ä¼šå°†å´©æºƒä¿¡æ¯å­˜å‚¨åˆ°ä¸€ä¸ª <code>context</code> ç»“æ„ä½“ä¸­ï¼Œå¹¶æ–°å»ºä¸€ä¸ª WaitGroupï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs go">ctx := &amp;context&#123;<br>	target:       cfg.SysTarget,<br>	reporter:     reporter,<br>	crashTitle:   crashTitle,<br>	crashType:    crashType,<br>	instances:    <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> *reproInstance, <span class="hljs-built_in">len</span>(vmIndexes)),<br>	bootRequests: <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> <span class="hljs-type">int</span>, <span class="hljs-built_in">len</span>(vmIndexes)),<br>	testTimeouts: testTimeouts,<br>	startOpts:    createStartOptions(cfg, features, crashType),<br>	stats:        <span class="hljs-built_in">new</span>(Stats),<br>	timeouts:     cfg.Timeouts,<br>&#125;<br>ctx.reproLogf(<span class="hljs-number">0</span>, <span class="hljs-string">&quot;%v programs, %v VMs, timeouts %v&quot;</span>, <span class="hljs-built_in">len</span>(entries), <span class="hljs-built_in">len</span>(vmIndexes), testTimeouts)<br><span class="hljs-keyword">var</span> wg sync.WaitGroup<br>wg.Add(<span class="hljs-built_in">len</span>(vmIndexes))<br></code></pre></td></tr></table></figure>

<p>éšåå¾ªç¯è·å–ç”¨ä»¥å¤ç°çš„ VM idx å¹¶ä¾æ¬¡å¯åŠ¨æ–°åç¨‹è°ƒç”¨ <code>CreateExecProgInstance()</code> <strong>åˆ›å»º VM å¹¶æ‹·è´ crash ç¨‹åº</strong>ï¼Œè‹¥å¤±è´¥åˆ™ä¼‘çœ  10s åé‡è¯•ï¼Œæœ€å¤šä¼šå°è¯• <code>maxTry</code> æ¬¡ï¼›æˆåŠŸçš„ç»“æœä¼šè¾“å‡ºåˆ° <code>ctx.instances</code> ä¸­ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">for</span> _, vmIndex := <span class="hljs-keyword">range</span> vmIndexes &#123;<br>	ctx.bootRequests &lt;- vmIndex<br>	<span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br>		<span class="hljs-keyword">defer</span> wg.Done()<br>		<span class="hljs-keyword">for</span> vmIndex := <span class="hljs-keyword">range</span> ctx.bootRequests &#123;<br>			<span class="hljs-keyword">var</span> inst *instance.ExecProgInstance<br>			maxTry := <span class="hljs-number">3</span><br>			<span class="hljs-keyword">for</span> try := <span class="hljs-number">0</span>; try &lt; maxTry; try++ &#123;<br>				<span class="hljs-keyword">select</span> &#123;<br>				<span class="hljs-keyword">case</span> &lt;-vm.Shutdown:<br>					try = maxTry<br>					<span class="hljs-keyword">continue</span><br>				<span class="hljs-keyword">default</span>:<br>				&#125;<br>				<span class="hljs-keyword">var</span> err <span class="hljs-type">error</span><br>				inst, err = instance.CreateExecProgInstance(vmPool, vmIndex, cfg,<br>					reporter, &amp;instance.OptionalConfig&#123;Logf: ctx.reproLogf&#125;)<br>				<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>					ctx.reproLogf(<span class="hljs-number">0</span>, <span class="hljs-string">&quot;failed to init instance: %v&quot;</span>, err)<br>					time.Sleep(<span class="hljs-number">10</span> * time.Second)<br>					<span class="hljs-keyword">continue</span><br>				&#125;<br>				<span class="hljs-keyword">break</span><br>			&#125;<br>			<span class="hljs-keyword">if</span> inst == <span class="hljs-literal">nil</span> &#123;<br>				<span class="hljs-keyword">break</span><br>			&#125;<br>			ctx.instances &lt;- &amp;reproInstance&#123;execProg: inst, index: vmIndex&#125;<br>		&#125;<br>	&#125;()<br>&#125;<br><span class="hljs-comment">// ä¸€äº›æ”¶å°¾å·¥ä½œ...</span><br><span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br>	wg.Wait()<br>	<span class="hljs-built_in">close</span>(ctx.instances)<br>&#125;()<br><span class="hljs-keyword">defer</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br>	<span class="hljs-built_in">close</span>(ctx.bootRequests)<br>	<span class="hljs-keyword">for</span> inst := <span class="hljs-keyword">range</span> ctx.instances &#123;<br>		inst.execProg.VMInstance.Close()<br>	&#125;<br>&#125;()<br></code></pre></td></tr></table></figure>

<p><code>CreateExecProgInstance()</code> ä¸»è¦å°±æ˜¯è°ƒç”¨ <code>vmPool.Create()</code> å¯åŠ¨è™šæ‹Ÿæœºåè°ƒç”¨ <code>SetupExecProg()</code> æ‹·è´è¦æ‰§è¡Œçš„äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œè¿™é‡Œå°±ä¸å±•å¼€äº†ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">CreateExecProgInstance</span><span class="hljs-params">(vmPool *vm.Pool, vmIndex <span class="hljs-type">int</span>, mgrCfg *mgrconfig.Config,</span></span><br><span class="hljs-params"><span class="hljs-function">	reporter *report.Reporter, opt *OptionalConfig)</span></span> (*ExecProgInstance, <span class="hljs-type">error</span>) &#123;<br>	vmInst, err := vmPool.Create(vmIndex)<br>	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>		<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, fmt.Errorf(<span class="hljs-string">&quot;failed to create VM: %v&quot;</span>, err)<br>	&#125;<br>	ret, err := SetupExecProg(vmInst, mgrCfg, reporter, opt)<br>	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>		vmInst.Close()<br>		<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, err<br>	&#125;<br>	<span class="hljs-keyword">return</span> ret, <span class="hljs-literal">nil</span><br>&#125;<br></code></pre></td></tr></table></figure>

<p>å›åˆ° <code>Run()</code>  ä¸­ï¼Œå…¶æœ€åä¼šè°ƒç”¨ <code>context.repro()</code> <strong>æ­£å¼å¼€å§‹å¤ç° crash çš„å·¥ä½œ</strong>ï¼Œæ£€æŸ¥ç»“æœåè¿”å›ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs go">	res, err := ctx.repro(entries, crashStart)<br>	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>		<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, <span class="hljs-literal">nil</span>, err<br>	&#125;<br>	<span class="hljs-keyword">if</span> res != <span class="hljs-literal">nil</span> &#123;<br>		ctx.reproLogf(<span class="hljs-number">3</span>, <span class="hljs-string">&quot;repro crashed as (corrupted=%v):\n%s&quot;</span>,<br>			ctx.report.Corrupted, ctx.report.Report)<br>		<span class="hljs-comment">// Try to rerun the repro if the report is corrupted.</span><br>		<span class="hljs-keyword">for</span> attempts := <span class="hljs-number">0</span>; ctx.report.Corrupted &amp;&amp; attempts &lt; <span class="hljs-number">3</span>; attempts++ &#123;<br>			ctx.reproLogf(<span class="hljs-number">3</span>, <span class="hljs-string">&quot;report is corrupted, running repro again&quot;</span>)<br>			<span class="hljs-keyword">if</span> res.CRepro &#123;<br>				_, err = ctx.testCProg(res.Prog, res.Duration, res.Opts)<br>			&#125; <span class="hljs-keyword">else</span> &#123;<br>				_, err = ctx.testProg(res.Prog, res.Duration, res.Opts)<br>			&#125;<br>			<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>				<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, <span class="hljs-literal">nil</span>, err<br>			&#125;<br>		&#125;<br>		ctx.reproLogf(<span class="hljs-number">3</span>, <span class="hljs-string">&quot;final repro crashed as (corrupted=%v):\n%s&quot;</span>,<br>			ctx.report.Corrupted, ctx.report.Report)<br>		res.Report = ctx.report<br>	&#125;<br>	<span class="hljs-keyword">return</span> res, ctx.stats, <span class="hljs-literal">nil</span><br>&#125;<br></code></pre></td></tr></table></figure>

<p><code>repro()</code> å‡½æ•°ä¸»è¦åˆ†ä¸¤éƒ¨åˆ†ï¼š</p>
<ul>
<li><p>è°ƒç”¨ <code>extractProg()</code> <strong>è·å–è§¦å‘ crash çš„ç¨‹åºé›†åˆ</strong></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(ctx *context)</span></span> repro(entries []*prog.LogEntry, crashStart <span class="hljs-type">int</span>) (*Result, <span class="hljs-type">error</span>) &#123;<br>	<span class="hljs-comment">// å»é™¤åœ¨ crash å‘ç”Ÿåæ‰§è¡Œçš„ç¨‹åº.</span><br>	<span class="hljs-keyword">for</span> i, ent := <span class="hljs-keyword">range</span> entries &#123;<br>		<span class="hljs-keyword">if</span> ent.Start &gt; crashStart &#123;<br>			entries = entries[:i]<br>			<span class="hljs-keyword">break</span><br>		&#125;<br>	&#125;<br><br>	reproStart := time.Now()<br>	<span class="hljs-keyword">defer</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br>		ctx.reproLogf(<span class="hljs-number">3</span>, <span class="hljs-string">&quot;reproducing took %s&quot;</span>, time.Since(reproStart))<br>	&#125;()<br><br>	res, err := ctx.extractProg(entries)<br>	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>		<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, err<br>	&#125;<br>	<span class="hljs-keyword">if</span> res == <span class="hljs-literal">nil</span> &#123;<br>		<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, <span class="hljs-literal">nil</span><br>	&#125;<br>	<span class="hljs-keyword">defer</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br>		<span class="hljs-keyword">if</span> res != <span class="hljs-literal">nil</span> &#123;<br>			res.Opts.Repro = <span class="hljs-literal">false</span><br>		&#125;<br>	&#125;()<br></code></pre></td></tr></table></figure>
</li>
<li><p>æœ€å°åŒ–ç¨‹åºé›†åˆå¹¶å°è¯•ç”Ÿæˆå¯ä»¥è§¦å‘è¯¥ crash çš„ C ç¨‹åºï¼Œè¿”å›ç»“æœï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs go">	<span class="hljs-comment">// å°è¯•æœ€å°åŒ–ç¨‹åºé›†</span><br>	res, err = ctx.minimizeProg(res)<br>	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>		<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, err<br>	&#125;<br><br>	<span class="hljs-comment">// é¦–å…ˆå°è¯•åœ¨ä¸ç®€åŒ–é…ç½®çš„æƒ…å†µä¸‹æå– C repro.</span><br>	res, err = ctx.extractC(res)<br>	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>		<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, err<br>	&#125;<br><br>	<span class="hljs-comment">// ç®€åŒ–é…ç½®å¹¶å°è¯•æå– C repro.</span><br>	<span class="hljs-keyword">if</span> !res.CRepro &#123;<br>		res, err = ctx.simplifyProg(res)<br>		<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>			<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, err<br>		&#125;<br>	&#125;<br><br>	<span class="hljs-comment">// ç®€åŒ– C ç›¸å…³çš„é…ç½®.</span><br>	<span class="hljs-keyword">if</span> res.CRepro &#123;<br>		res, err = ctx.simplifyC(res)<br>		<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>			<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, err<br>		&#125;<br>	&#125;<br><br>	<span class="hljs-keyword">return</span> res, <span class="hljs-literal">nil</span><br>&#125;<br></code></pre></td></tr></table></figure></li>
</ul>
<p><code>extractProg()</code> çš„é€»è¾‘æ¯”è¾ƒç®€å•ï¼š</p>
<ul>
<li>é€†åºåè°ƒç”¨ <code>context.extractProgSingle()</code> <strong>é€ä¸ªè¿è¡Œå•ä¸ªç¨‹åº</strong>ï¼Œè‹¥æŸä¸€ç¨‹åºè§¦å‘äº† crash åˆ™ç›´æ¥è¿”å›</li>
<li>è‹¥å•ä¸€ç¨‹åºæ— æ³•è§¦å‘ crashï¼Œåˆ™è°ƒç”¨ <code>context.extractProgBisect()</code> <strong>ä½¿ç”¨äºŒåˆ†æ³•æ‰¾å‡ºè§¦å‘ crash çš„ç¨‹åºé›†åˆ</strong></li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(ctx *context)</span></span> extractProg(entries []*prog.LogEntry) (*Result, <span class="hljs-type">error</span>) &#123;<br>	ctx.reproLogf(<span class="hljs-number">2</span>, <span class="hljs-string">&quot;extracting reproducer from %v programs&quot;</span>, <span class="hljs-built_in">len</span>(entries))<br>	start := time.Now()<br>	<span class="hljs-keyword">defer</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br>		ctx.stats.ExtractProgTime = time.Since(start)<br>	&#125;()<br><br>	<span class="hljs-comment">// Extract last program on every proc.</span><br>	procs := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">map</span>[<span class="hljs-type">int</span>]<span class="hljs-type">int</span>)<br>	<span class="hljs-keyword">for</span> i, ent := <span class="hljs-keyword">range</span> entries &#123;<br>		procs[ent.Proc] = i<br>	&#125;<br>	<span class="hljs-keyword">var</span> indices []<span class="hljs-type">int</span><br>	<span class="hljs-keyword">for</span> _, idx := <span class="hljs-keyword">range</span> procs &#123;<br>		indices = <span class="hljs-built_in">append</span>(indices, idx)<br>	&#125;<br>	sort.Ints(indices)<br>	<span class="hljs-keyword">var</span> lastEntries []*prog.LogEntry<br>	<span class="hljs-keyword">for</span> i := <span class="hljs-built_in">len</span>(indices) - <span class="hljs-number">1</span>; i &gt;= <span class="hljs-number">0</span>; i-- &#123;<br>		lastEntries = <span class="hljs-built_in">append</span>(lastEntries, entries[indices[i]])<br>	&#125;<br>	<span class="hljs-keyword">for</span> _, timeout := <span class="hljs-keyword">range</span> ctx.testTimeouts &#123;<br>		<span class="hljs-comment">// åˆ†åˆ«æ‰§è¡Œæ¯ä¸ªç¨‹åºä»¥æ£€æµ‹ç”±å•ä¸ªç¨‹åºé€ æˆçš„ç®€å•çš„ crash.</span><br>		<span class="hljs-comment">// ç¨‹åºè¢«é€†åºæ‰§è¡Œ, é€šå¸¸æœ€åä¸€ä¸ªç¨‹åºå°±æ˜¯ç½ªé­ç¥¸é¦–.</span><br>		res, err := ctx.extractProgSingle(lastEntries, timeout)<br>		<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>			<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, err<br>		&#125;<br>		<span class="hljs-keyword">if</span> res != <span class="hljs-literal">nil</span> &#123;<br>			ctx.reproLogf(<span class="hljs-number">3</span>, <span class="hljs-string">&quot;found reproducer with %d syscalls&quot;</span>, <span class="hljs-built_in">len</span>(res.Prog.Calls))<br>			<span class="hljs-keyword">return</span> res, <span class="hljs-literal">nil</span><br>		&#125;<br><br>		<span class="hljs-comment">// è‹¥åªæœ‰ä¸€ä¸ª entry åˆ™ä¸è¿›è¡ŒäºŒåˆ†.</span><br>		<span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(entries) == <span class="hljs-number">1</span> &#123;<br>			<span class="hljs-keyword">continue</span><br>		&#125;<br><br>		<span class="hljs-comment">// æ‰§è¡Œå¤šä¸ªç¨‹åºå¹¶äºŒåˆ† log ä»¥æ‰¾åˆ°é€ æˆå´©æºƒçš„å¤šä¸ªç¨‹åº.</span><br>		res, err = ctx.extractProgBisect(entries, timeout)<br>		<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>			<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, err<br>		&#125;<br>		<span class="hljs-keyword">if</span> res != <span class="hljs-literal">nil</span> &#123;<br>			ctx.reproLogf(<span class="hljs-number">3</span>, <span class="hljs-string">&quot;found reproducer with %d syscalls&quot;</span>, <span class="hljs-built_in">len</span>(res.Prog.Calls))<br>			<span class="hljs-keyword">return</span> res, <span class="hljs-literal">nil</span><br>		&#125;<br>	&#125;<br><br>	ctx.reproLogf(<span class="hljs-number">0</span>, <span class="hljs-string">&quot;failed to extract reproducer&quot;</span>)<br>	<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, <span class="hljs-literal">nil</span><br>&#125;<br></code></pre></td></tr></table></figure>

<p>è¿™ä¸¤ä¸ªå‡½æ•°ä¸»è¦å°±æ˜¯é€šè¿‡å¦‚ä¸‹è°ƒç”¨é“¾æ¥åœ¨ VM ä¸­æ‰§è¡Œç¨‹åºï¼Œè¿™é‡Œå°±ä¸å±•å¼€äº†ï¼š</p>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs reasonml">context.test<span class="hljs-constructor">Prog()</span><br>	context.test<span class="hljs-constructor">Progs()</span><br>		context.test<span class="hljs-constructor">WithInstance()</span><br>			ExecProgInstance.<span class="hljs-constructor">RunSyzProg()</span><br>				ExecProgInstance.<span class="hljs-constructor">RunSyzProgFile()</span><br>					<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">ExecProgInstance</span>.</span></span>run<span class="hljs-constructor">Command()</span><br></code></pre></td></tr></table></figure>



<h4 id="â‘¡-å¾ªç¯å¯åŠ¨åç¨‹è¿›è¡Œ-fuzzing"><a href="#â‘¡-å¾ªç¯å¯åŠ¨åç¨‹è¿›è¡Œ-fuzzing" class="headerlink" title="â‘¡ å¾ªç¯å¯åŠ¨åç¨‹è¿›è¡Œ fuzzing"></a>â‘¡ å¾ªç¯å¯åŠ¨åç¨‹è¿›è¡Œ fuzzing</h4><p>æ­¤æ—¶å·²ç»ä¸æ»¡è¶³å¯ä»¥è¿›è¡Œ crash å¤ç°çš„æ¡ä»¶äº†ï¼Œå› è€Œä¼šæœ‰ç¬¬äºŒä¸ªå°å¾ªç¯å¯åŠ¨æ–°åç¨‹<strong>å°†èµ„æºæ± ä¸­å‰©ä½™ VM è°ƒåº¦å» fuzzing</strong>ï¼Œ å¹¶å°†ç»“æœè¾“å‡ºåˆ° <code>runDone</code> ä¸­ï¼š </p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs go">	<span class="hljs-keyword">for</span> !canRepro() &#123;<br>		idx := instances.TakeOne()<br>		<span class="hljs-keyword">if</span> idx == <span class="hljs-literal">nil</span> &#123;<br>			<span class="hljs-keyword">break</span><br>		&#125;<br>		log.Logf(<span class="hljs-number">1</span>, <span class="hljs-string">&quot;loop: starting instance %v&quot;</span>, *idx)<br>		<span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br>			crash, err := mgr.runInstance(*idx)<br>			runDone &lt;- &amp;RunResult&#123;*idx, crash, err&#125;<br>		&#125;()<br>	&#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p><code>runInstance()</code> å‡½æ•°å®é™…ä¸Šä¼šè°ƒç”¨ <code>runInstanceInner()</code>ï¼Œè¯¥å‡½æ•°<strong>ä»…å½“äº§ç”Ÿäº† Crash æ—¶è¿”å›çš„ç»“æœæ‰ä¸ä¸º nilï¼Œå³ runRepro é˜Ÿåˆ—å®é™…ä¸Šä¸º Crash é˜Ÿåˆ—ï¼š</strong></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(mgr *Manager)</span></span> runInstance(index <span class="hljs-type">int</span>) (*Crash, <span class="hljs-type">error</span>) &#123;<br>	mgr.checkUsedFiles()<br>	instanceName := fmt.Sprintf(<span class="hljs-string">&quot;vm-%d&quot;</span>, index)<br><br>	rep, vmInfo, err := mgr.runInstanceInner(index, instanceName)<br><br>	machineInfo := mgr.serv.shutdownInstance(instanceName)<br>	<span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(vmInfo) != <span class="hljs-number">0</span> &#123;<br>		machineInfo = <span class="hljs-built_in">append</span>(<span class="hljs-built_in">append</span>(vmInfo, <span class="hljs-string">&#x27;\n&#x27;</span>), machineInfo...)<br>	&#125;<br><br>	<span class="hljs-comment">// Error that is not a VM crash.</span><br>	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>		<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, err<br>	&#125;<br>	<span class="hljs-comment">// No crash.</span><br>	<span class="hljs-keyword">if</span> rep == <span class="hljs-literal">nil</span> &#123;<br>		<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, <span class="hljs-literal">nil</span><br>	&#125;<br>	crash := &amp;Crash&#123;<br>		vmIndex:     index,<br>		hub:         <span class="hljs-literal">false</span>,<br>		Report:      rep,<br>		machineInfo: machineInfo,<br>	&#125;<br>	<span class="hljs-keyword">return</span> crash, <span class="hljs-literal">nil</span><br>&#125;<br></code></pre></td></tr></table></figure>

<p><code>runInstanceInner()</code> çš„æ ¸å¿ƒéƒ¨åˆ†ä¸»è¦æ˜¯ï¼š</p>
<ul>
<li><p>è°ƒç”¨ <code>vmPool.Create()</code> åˆ›å»º VMï¼Œè°ƒç”¨ <code>inst.Forward()</code> è¿›è¡Œ TCP è½¬å‘ï¼Œæ‹·è´ <code>syz-fuzzer</code> ä¸ <code>syz-executor</code> åˆ° VM æ–‡ä»¶ç³»ç»Ÿä¸­</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(mgr *Manager)</span></span> runInstanceInner(index <span class="hljs-type">int</span>, instanceName <span class="hljs-type">string</span>) (*report.Report, []<span class="hljs-type">byte</span>, <span class="hljs-type">error</span>) &#123;<br>	inst, err := mgr.vmPool.Create(index)<br>	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>		<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, <span class="hljs-literal">nil</span>, fmt.Errorf(<span class="hljs-string">&quot;failed to create instance: %v&quot;</span>, err)<br>	&#125;<br>	<span class="hljs-keyword">defer</span> inst.Close()<br><br>	fwdAddr, err := inst.Forward(mgr.serv.port)<br>	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>		<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, <span class="hljs-literal">nil</span>, fmt.Errorf(<span class="hljs-string">&quot;failed to setup port forwarding: %v&quot;</span>, err)<br>	&#125;<br><br>	fuzzerBin, err := inst.Copy(mgr.cfg.FuzzerBin)<br>	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>		<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, <span class="hljs-literal">nil</span>, fmt.Errorf(<span class="hljs-string">&quot;failed to copy binary: %v&quot;</span>, err)<br>	&#125;<br><br>	<span class="hljs-comment">// è‹¥æä¾›äº† ExecutorBin , è¿™æ„å‘³ç€ syz-executor æ—©å·²åœ¨é•œåƒä¸­,</span><br>	<span class="hljs-comment">// æ•…æ— éœ€è¿›è¡Œæ‹·è´.</span><br>	executorBin := mgr.sysTarget.ExecutorBin<br>	<span class="hljs-keyword">if</span> executorBin == <span class="hljs-string">&quot;&quot;</span> &#123;<br>		executorBin, err = inst.Copy(mgr.cfg.ExecutorBin)<br>		<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>			<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, <span class="hljs-literal">nil</span>, fmt.Errorf(<span class="hljs-string">&quot;failed to copy binary: %v&quot;</span>, err)<br>		&#125;<br>	&#125;<br><br>	fuzzerV := <span class="hljs-number">0</span><br>	procs := mgr.cfg.Procs<br>	<span class="hljs-keyword">if</span> *flagDebug &#123;<br>		fuzzerV = <span class="hljs-number">100</span><br>		procs = <span class="hljs-number">1</span><br>	&#125;<br></code></pre></td></tr></table></figure>
</li>
<li><p>è°ƒç”¨ <code>instance.FuzzerCmd()</code> ç”Ÿæˆå‘½ä»¤è¡Œåè°ƒç”¨ <code>inst.Run()</code> å¯åŠ¨ <code>syz-fuzzer</code></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// Run the fuzzer binary.</span><br>start := time.Now()<br>atomic.AddUint32(&amp;mgr.numFuzzing, <span class="hljs-number">1</span>)<br><span class="hljs-keyword">defer</span> atomic.AddUint32(&amp;mgr.numFuzzing, ^<span class="hljs-type">uint32</span>(<span class="hljs-number">0</span>))<br>  <br>args := &amp;instance.FuzzerCmdArgs&#123;<br>	Fuzzer:    fuzzerBin,<br>	Executor:  executorBin,<br>	Name:      instanceName,<br>	OS:        mgr.cfg.TargetOS,<br>	Arch:      mgr.cfg.TargetArch,<br>	FwdAddr:   fwdAddr,<br>	Sandbox:   mgr.cfg.Sandbox,<br>	Procs:     procs,<br>	Verbosity: fuzzerV,<br>	Cover:     mgr.cfg.Cover,<br>	Debug:     *flagDebug,<br>	Test:      <span class="hljs-literal">false</span>,<br>	Runtest:   <span class="hljs-literal">false</span>,<br>	Optional: &amp;instance.OptionalFuzzerArgs&#123;<br>		Slowdown:   mgr.cfg.Timeouts.Slowdown,<br>		RawCover:   mgr.cfg.RawCover,<br>		SandboxArg: mgr.cfg.SandboxArg,<br>	&#125;,<br>&#125;<br>cmd := instance.FuzzerCmd(args)<br>outc, errc, err := inst.Run(mgr.cfg.Timeouts.VMRunningTime, mgr.vmStop, cmd)<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>	<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, <span class="hljs-literal">nil</span>, fmt.Errorf(<span class="hljs-string">&quot;failed to run fuzzer: %v&quot;</span>, err)<br>&#125;<br></code></pre></td></tr></table></figure>
</li>
<li><p>è°ƒç”¨ <code>inst.MonitorExecution()</code> ç›‘æ§ VM è¿è¡Œï¼Œè¯¥å‡½æ•°ä¸»è¦æ˜¯<strong>é€šè¿‡è·å– kernel oops æ¥åˆ¤æ–­æ˜¯å¦è§¦å‘äº† crash</strong>ï¼ˆKASAN ä¸ä¼šé€ æˆ kernel panicï¼Œä»è€Œä½¿å¾—ä¸€ä¸ª VM å®ä¾‹é•¿æœŸè¿è¡Œï¼Œä¸è¿‡ dmesg ä¸­ä»æœ‰ oopsï¼‰</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs go">	<span class="hljs-keyword">var</span> vmInfo []<span class="hljs-type">byte</span><br>	rep := inst.MonitorExecution(outc, errc, mgr.reporter, vm.ExitTimeout)<br>	<span class="hljs-keyword">if</span> rep == <span class="hljs-literal">nil</span> &#123;<br>		<span class="hljs-comment">// This is the only &quot;OK&quot; outcome.</span><br>		log.Logf(<span class="hljs-number">0</span>, <span class="hljs-string">&quot;%s: running for %v, restarting&quot;</span>, instanceName, time.Since(start))<br>	&#125; <span class="hljs-keyword">else</span> &#123;<br>		vmInfo, err = inst.Info()<br>		<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>			vmInfo = []<span class="hljs-type">byte</span>(fmt.Sprintf(<span class="hljs-string">&quot;error getting VM info: %v\n&quot;</span>, err))<br>		&#125;<br>	&#125;<br><br>	<span class="hljs-keyword">return</span> rep, vmInfo, <span class="hljs-literal">nil</span><br>&#125;<br></code></pre></td></tr></table></figure></li>
</ul>
<h3 id="Step-3-ç­‰å¾…å¤„ç†ä¸åŒ-channel-æ•°æ®"><a href="#Step-3-ç­‰å¾…å¤„ç†ä¸åŒ-channel-æ•°æ®" class="headerlink" title="Step 3. ç­‰å¾…å¤„ç†ä¸åŒ channel æ•°æ®"></a>Step 3. ç­‰å¾…å¤„ç†ä¸åŒ channel æ•°æ®</h3><p><code>vmLoop()</code> çš„æœ€åä¸»è¦å°±æ˜¯ä¸€ä¸ªå¤§çš„ <code>select</code>ï¼Œç­‰å¾…æŸä¸ª channel ä¸­æœ‰æ•°æ®åè¿›è¡Œå¤„ç†ï¼Œä¹‹åé‡æ–°è·³å›ç­‰å¾…å¤„ç†æˆ–æ˜¯å¼€å§‹ä¸‹ä¸€è½®å¾ªç¯ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs go">	<span class="hljs-keyword">var</span> stopRequest <span class="hljs-keyword">chan</span> <span class="hljs-type">bool</span><br>	<span class="hljs-keyword">if</span> !stopPending &amp;&amp; canRepro() &#123;<br>		stopRequest = mgr.vmStop<br>	&#125;<br><br>wait:<br>	<span class="hljs-keyword">select</span> &#123;<br></code></pre></td></tr></table></figure>

<p>é¦–å…ˆæ˜¯èµ„æºæ± çš„ <code>Freed</code> channelï¼Œåœ¨ <code>Put()</code> ä¸­ä¼šå°†ç©ºé—² VM idx æ”¾å›èµ„æºæ± åå‘è¯¥ channel é€å…¥ä¸€ä¸ª <code>true</code>ï¼Œè€Œè¿™é‡Œä»€ä¹ˆéƒ½æ²¡æœ‰åšï¼Œç¬”è€…ä¼°è®¡ä¼šåœ¨åç»­ç‰ˆæœ¬ä¸­æ›´æ–°ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">case</span> &lt;-instances.Freed:<br>	<span class="hljs-comment">// An instance has been released.</span><br></code></pre></td></tr></table></figure>

<p><code>stopRequest</code> å…¶å®æ˜¯ <code>Manager.vmStop</code> ï¼Œè¿™ä¸ª channel ä¼šåœ¨ VM instance æ‰€å®ç°çš„ <code>Run()</code> æ–¹æ³•ä¸­è¢«ä½¿ç”¨ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">case</span> stopRequest &lt;- <span class="hljs-literal">true</span>:<br>	log.Logf(<span class="hljs-number">1</span>, <span class="hljs-string">&quot;loop: issued stop request&quot;</span>)<br>	stopPending = <span class="hljs-literal">true</span><br></code></pre></td></tr></table></figure>

<p>å½“ <code>runDone</code> ä¸­æœ‰æ•°æ®æ—¶è¯´æ˜<strong>fuzz äº§ç”Ÿäº† crash</strong>ï¼Œæ­¤æ—¶ä¼šå°†äº§ç”Ÿ crash çš„ VM é‡Šæ”¾å›èµ„æºæ± ï¼Œå°† crash å†™å…¥ <code>pendingRepro</code> è¡¨ä¸­ç­‰å¾…ä¸‹ä¸€è½®å¾ªç¯è¿›è¡Œå¤„ç†ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">case</span> res := &lt;-runDone:<br>	log.Logf(<span class="hljs-number">1</span>, <span class="hljs-string">&quot;loop: instance %v finished, crash=%v&quot;</span>, res.idx, res.crash != <span class="hljs-literal">nil</span>)<br>	<span class="hljs-keyword">if</span> res.err != <span class="hljs-literal">nil</span> &amp;&amp; shutdown != <span class="hljs-literal">nil</span> &#123;<br>		log.Logf(<span class="hljs-number">0</span>, <span class="hljs-string">&quot;%v&quot;</span>, res.err)<br>	&#125;<br>	stopPending = <span class="hljs-literal">false</span><br>	instances.Put(res.idx)<br>	<span class="hljs-comment">// On shutdown qemu crashes with &quot;qemu: terminating on signal 2&quot;,</span><br>	<span class="hljs-comment">// which we detect as &quot;lost connection&quot;. Don&#x27;t save that as crash.</span><br>	<span class="hljs-keyword">if</span> shutdown != <span class="hljs-literal">nil</span> &amp;&amp; res.crash != <span class="hljs-literal">nil</span> &#123;<br>		needRepro := mgr.saveCrash(res.crash)<br>		<span class="hljs-keyword">if</span> needRepro &#123;<br>			log.Logf(<span class="hljs-number">1</span>, <span class="hljs-string">&quot;loop: add pending repro for &#x27;%v&#x27;&quot;</span>, res.crash.Title)<br>			pendingRepro[res.crash] = <span class="hljs-literal">true</span><br>		&#125;<br>	&#125;<br></code></pre></td></tr></table></figure>

<p><code>reproDone</code> ä¸­ä¸º crash çš„å¤ç°ç»“æœï¼Œè¿™é‡Œä¼šä¿å­˜å¤ç°ç»“æœå¹¶å°†å¯¹åº”çš„ crash ä» <code>reproducing</code> è¡¨ä¸­åˆ é™¤</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">case</span> res := &lt;-reproDone:<br>	atomic.AddUint32(&amp;mgr.numReproducing, ^<span class="hljs-type">uint32</span>(<span class="hljs-number">0</span>))<br>	crepro := <span class="hljs-literal">false</span><br>	title := <span class="hljs-string">&quot;&quot;</span><br>	<span class="hljs-keyword">if</span> res.repro != <span class="hljs-literal">nil</span> &#123;<br>		crepro = res.repro.CRepro<br>		title = res.repro.Report.Title<br>	&#125;<br>	log.Logf(<span class="hljs-number">1</span>, <span class="hljs-string">&quot;loop: repro on %+v finished &#x27;%v&#x27;, repro=%v crepro=%v desc=&#x27;%v&#x27;&quot;</span>,<br>		res.instances, res.report0.Title, res.repro != <span class="hljs-literal">nil</span>, crepro, title)<br>	<span class="hljs-keyword">if</span> res.err != <span class="hljs-literal">nil</span> &#123;<br>		log.Logf(<span class="hljs-number">0</span>, <span class="hljs-string">&quot;repro failed: %v&quot;</span>, res.err)<br>	&#125;<br>	<span class="hljs-built_in">delete</span>(reproducing, res.report0.Title)<br>	<span class="hljs-keyword">if</span> res.repro == <span class="hljs-literal">nil</span> &#123;<br>		<span class="hljs-keyword">if</span> !res.hub &#123;<br>			mgr.saveFailedRepro(res.report0, res.stats)<br>		&#125;<br>	&#125; <span class="hljs-keyword">else</span> &#123;<br>		mgr.saveRepro(res)<br>	&#125;<br></code></pre></td></tr></table></figure>

<p><code>shutdown</code> ä¸­æœ‰æ•°æ®åˆ™è¡¨ç¤ºæ”¶åˆ°äº†ç»ˆæ­¢ä¿¡å·ï¼Œæ­¤æ—¶ä¼šå°† <code>shutdown</code> ç½®ä¸º nilï¼Œç»ˆæ­¢å¾ªç¯ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">case</span> &lt;-shutdown:<br>	log.Logf(<span class="hljs-number">1</span>, <span class="hljs-string">&quot;loop: shutting down...&quot;</span>)<br>	shutdown = <span class="hljs-literal">nil</span><br></code></pre></td></tr></table></figure>

<p><code>hubReproQueue</code> ä¸Šä¹Ÿå¯èƒ½ä¼ æ¥ crashï¼Œæ­¤å¤„å°†å…¶é€å…¥ <code>pendingRepro</code> è¡¨ä¸­ç­‰å¾…åœ¨åç»­å¾ªç¯ä¸­å¤ç°ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">case</span> crash := &lt;-mgr.hubReproQueue:<br>	log.Logf(<span class="hljs-number">1</span>, <span class="hljs-string">&quot;loop: get repro from hub&quot;</span>)<br>	pendingRepro[crash] = <span class="hljs-literal">true</span><br></code></pre></td></tr></table></figure>

<p><code>needMoreRepros</code> æ˜¯ä¸€ä¸ªä¼ è¾“ channel çš„ channelï¼Œè¿™é‡Œä¼šå°†ä¸€ä¸ªæ¡ä»¶åˆ¤æ–­ç»“æœä¼ å…¥ä¼ æ¥çš„ channel ä¸­å¹¶é‡æ–°è·³å›ç­‰å¾…ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">case</span> reply := &lt;-mgr.needMoreRepros:<br>	reply &lt;- phase &gt;= phaseTriagedHub &amp;&amp;<br>		<span class="hljs-built_in">len</span>(reproQueue)+<span class="hljs-built_in">len</span>(pendingRepro)+<span class="hljs-built_in">len</span>(reproducing) == <span class="hljs-number">0</span><br>	<span class="hljs-keyword">goto</span> wait<br></code></pre></td></tr></table></figure>

<p>æœ€åæ˜¯ <code>reproRequest</code>ï¼Œè¯¥ channel æ„ä¸º<strong>ä¸»åŠ¨è¿›è¡Œå¤ç°çš„è¯·æ±‚</strong>ï¼Œè¿™é‡Œä¼šæ‹·è´ <code>reproducing</code> ä½å›¾åå°†å…¶ä¼ å…¥ä¼ æ¥çš„ channel ä¸­ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs go">		<span class="hljs-keyword">case</span> reply := &lt;-mgr.reproRequest:<br>			repros := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]<span class="hljs-type">bool</span>)<br>			<span class="hljs-keyword">for</span> title := <span class="hljs-keyword">range</span> reproducing &#123;<br>				repros[title] = <span class="hljs-literal">true</span><br>			&#125;<br>			reply &lt;- repros<br>			<span class="hljs-keyword">goto</span> wait<br>		&#125;<br>	&#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>è‡³æ­¤ï¼Œ<code>syz-manager</code> çš„åŸºæœ¬è¿è¡Œé€»è¾‘åˆ†æå®Œæ¯•</p>

                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
    <div class="post-meta mr-3 d-flex align-items-center">
      <i class="iconfont icon-category"></i>
      

<span class="category-chains">
  
  
    
      <span class="category-chain">
        
  <a href="/categories/FUZZ/" class="category-chain-item">FUZZ</a>
  
  

      </span>
    
  
</span>

    </div>
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/%E6%BC%8F%E6%B4%9E%E6%8C%96%E6%8E%98/">#æ¼æ´æŒ–æ˜</a>
      
        <a href="/tags/FUZZ/">#FUZZ</a>
      
        <a href="/tags/syzkaller/">#syzkaller</a>
      
    </div>
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>ã€FUZZ.0x02ã€‘syzkaller - IIï¼šsyz-manageræºç åˆ†æ</div>
      <div>http://blog.arttnba3.cn/2023/03/02/FUZZ-0X02-SYZKALLER-II_SOURCE_SYZMANAGER/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>ä½œè€…</div>
          <div>arttnba3</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>å‘å¸ƒäº</div>
          <div>2023å¹´3æœˆ2æ—¥</div>
        </div>
      
      
      <div class="license-meta-item">
        <div>è®¸å¯åè®®</div>
        <div>
          
            
            
              <a target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
              <span class="hint--top hint--rounded" aria-label="BY - ç½²å">
                <i class="iconfont icon-by"></i>
              </span>
              </a>
            
          
        </div>
      </div>
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2023/04/14/PAPER-0X01_VTW/" title="ã€PAPER.0x01ã€‘è®ºæ–‡ç¬”è®°ï¼šVirtual Wall: Filtering Rootkit Attacks To Protect Linux Kernel Functions ">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">ã€PAPER.0x01ã€‘è®ºæ–‡ç¬”è®°ï¼šVirtual Wall: Filtering Rootkit Attacks To Protect Linux Kernel Functions </span>
                        <span class="visible-mobile">ä¸Šä¸€ç¯‡</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2023/02/24/OS-0X04-LINUX-KERNEL-MEMORY-6.2-PART-III/" title="ã€OS.0x04ã€‘Linux Kernel å†…å­˜ç®¡ç†æµ…æ III - Slub Allocator">
                        <span class="hidden-mobile">ã€OS.0x04ã€‘Linux Kernel å†…å­˜ç®¡ç†æµ…æ III - Slub Allocator</span>
                        <span class="visible-mobile">ä¸‹ä¸€ç¯‡</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
  <article id="comments" lazyload>
    
  <div id="valine"></div>
  <script type="text/javascript">
    Fluid.utils.loadComments('#valine', function() {
      Fluid.utils.createScript('https://lib.baomitu.com/valine/1.4.17/Valine.min.js', function() {
        var options = Object.assign(
          {"appid":"ICj6cPRQWFTNiOttBHlzxnIv-gzGzoHsz","appkey":"tuvJh3xYxPFcW2JB6K26RKP2","path":"window.location.pathname","placeholder":"è¯´ç‚¹ä»€ä¹ˆå‘—ï¼ˆç¬‘ï¼‰","avatar":"retro","meta":["nick","mail","link"],"requiredFields":[],"pageSize":10,"lang":"zh-CN","highlight":false,"recordIP":false,"serverURLs":"","emojiCDN":null,"emojiMaps":null,"enableQQ":false,"appId":"ICj6cPRQWFTNiOttBHlzxnIv-gzGzoHsz","appKey":"tuvJh3xYxPFcW2JB6K26RKP2"},
          {
            el: "#valine",
            path: window.location.pathname
          }
        )
        new Valine(options);
        Fluid.utils.waitElementVisible('#valine .vcontent', () => {
          var imgSelector = '#valine .vcontent img:not(.vemoji)';
          Fluid.plugins.imageCaption(imgSelector);
          Fluid.plugins.fancyBox(imgSelector);
        })
      });
    });
  </script>
  <noscript>Please enable JavaScript to view the comments</noscript>


  </article>


          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;ç›®å½•</p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  


  
  









    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">æœç´¢</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">å…³é”®è¯</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  <!-- ç½‘ç«™è¿è¡Œæ—¶é—´çš„è®¾ç½® -->
  <span id="timeDate">è½½å…¥å¤©æ•°...</span>
  <span id="times">è½½å…¥æ—¶åˆ†ç§’...</span>
  <script>
      var now = new Date();
      function createtime() {
          var grt= new Date("04/20/2020 17:48:48");//æ­¤å¤„ä¿®æ”¹ä½ çš„å»ºç«™æ—¶é—´æˆ–è€…ç½‘ç«™ä¸Šçº¿æ—¶é—´
          now.setTime(now.getTime()+250);
          days = (now - grt ) / 1000 / 60 / 60 / 24; dnum = Math.floor(days);
          hours = (now - grt ) / 1000 / 60 / 60 - (24 * dnum); hnum = Math.floor(hours);
          if(String(hnum).length ==1 ){hnum = "0" + hnum;} minutes = (now - grt ) / 1000 /60 - (24 * 60 * dnum) - (60 * hnum);
          mnum = Math.floor(minutes); if(String(mnum).length ==1 ){mnum = "0" + mnum;}
          seconds = (now - grt ) / 1000 - (24 * 60 * 60 * dnum) - (60 * 60 * hnum) - (60 * mnum);
          snum = Math.round(seconds); if(String(snum).length ==1 ){snum = "0" + snum;}
          document.getElementById("timeDate").innerHTML = "arttnba3çš„å°å±‹å·²ç»å®‰å…¨å­˜åœ¨äº† "+dnum+" å¤© ";
          document.getElementById("times").innerHTML = hnum + " å°æ—¶ " + mnum + " åˆ† " + snum + " ç§’";
      }
  setInterval("createtime()",250);
  </script>
  
    <div class="footer-content">
       <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
    </div>
  
  
    <div class="statistics">
  
  

  
    
      <span id="busuanzi_container_site_pv" style="display: none">
        æ€»è®¿é—®é‡ 
        <span id="busuanzi_value_site_pv"></span>
         æ¬¡
      </span>
    
    
      <span id="busuanzi_container_site_uv" style="display: none">
        æ€»è®¿å®¢æ•° 
        <span id="busuanzi_value_site_uv"></span>
         äºº
      </span>
    
    
  
</div>

  
  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.0/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.18.2/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      headingSelector : CONFIG.toc.headingSelector || 'h1,h2,h3,h4,h5,h6',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      collapseDepth   : CONFIG.toc.collapseDepth || 0,
      scrollSmooth    : true,
      headingsOffset  : -boardTop
    });
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.10/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  
      <script>
        if (!window.MathJax) {
          window.MathJax = {
            tex    : {
              inlineMath: { '[+]': [['$', '$']] }
            },
            loader : {
              load: ['ui/lazy']
            },
            options: {
              renderActions: {
                insertedScript: [200, () => {
                  document.querySelectorAll('mjx-container').forEach(node => {
                    let target = node.parentNode;
                    if (target.nodeName.toLowerCase() === 'li') {
                      target.parentNode.classList.add('has-jax');
                    }
                  });
                }, '', false]
              }
            }
          };
        } else {
          MathJax.startup.document.state(0);
          MathJax.texReset();
          MathJax.typeset();
          MathJax.typesetPromise();
        }
      </script>
    

  <script  src="https://lib.baomitu.com/mathjax/3.2.1/es5/tex-mml-chtml.js" ></script>

  <script  src="/js/local-search.js" ></script>

  <script defer src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" ></script>





<!-- ä¸»é¢˜çš„å¯åŠ¨é¡¹ï¼Œå°†å®ƒä¿æŒåœ¨æœ€åº•éƒ¨ -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">åšå®¢åœ¨å…è®¸ JavaScript è¿è¡Œçš„ç¯å¢ƒä¸‹æµè§ˆæ•ˆæœæ›´ä½³</div>
  </noscript>
</body>
</html>
