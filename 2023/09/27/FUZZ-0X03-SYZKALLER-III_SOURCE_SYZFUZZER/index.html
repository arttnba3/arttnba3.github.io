

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/avatar.png">
  <link rel="icon" href="/img/avatar.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
    <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="arttnba3">
  <meta name="keywords" content="">
  
    <meta name="description" content="ï¼ˆæ‘˜ä¸‹çœ¼é•œï¼‰Furryï¼Ÿï¼ˆæˆ´ä¸Šçœ¼é•œï¼‰Fuzzerï¼">
<meta property="og:type" content="article">
<meta property="og:title" content="ã€FUZZ.0x03ã€‘syzkaller - IIIï¼šsyz-fuzzer æºç åˆ†æ">
<meta property="og:url" content="https://arttnba3.github.io/2023/09/27/FUZZ-0X03-SYZKALLER-III_SOURCE_SYZFUZZER/index.html">
<meta property="og:site_name" content="arttnba3&#39;s blog">
<meta property="og:description" content="ï¼ˆæ‘˜ä¸‹çœ¼é•œï¼‰Furryï¼Ÿï¼ˆæˆ´ä¸Šçœ¼é•œï¼‰Fuzzerï¼">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://s2.loli.net/2023/09/27/lbsTAikSnVxNcat.png">
<meta property="article:published_time" content="2023-09-26T15:26:14.000Z">
<meta property="article:modified_time" content="2023-12-30T09:06:06.000Z">
<meta property="article:author" content="arttnba3">
<meta property="article:tag" content="æ¼æ´æŒ–æ˜">
<meta property="article:tag" content="FUZZ">
<meta property="article:tag" content="syzkaller">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://s2.loli.net/2023/09/27/lbsTAikSnVxNcat.png">
  
  
    <meta name="referrer" content="no-referrer-when-downgrade">
  
  
  <title>ã€FUZZ.0x03ã€‘syzkaller - IIIï¼šsyz-fuzzer æºç åˆ†æ - arttnba3&#39;s blog</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- ä¸»é¢˜ä¾èµ–çš„å›¾æ ‡åº“ï¼Œä¸è¦è‡ªè¡Œä¿®æ”¹ -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  




  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"arttnba3.github.io","root":"/","version":"1.9.2","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":"Â§"},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":false,"follow_dnt":true,"baidu":null,"google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false}},"search_path":"/local-search.xml"};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  


  
<meta name="generator" content="Hexo 7.1.1"><link rel="alternate" href="/atom.xml" title="arttnba3's blog" type="application/atom+xml">
</head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 80vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>arttnba3&#39;s blog</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                é¦–é¡µ
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                å½’æ¡£
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                åˆ†ç±»
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                æ ‡ç­¾
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                å…³äº
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/links/">
                <i class="iconfont icon-link-fill"></i>
                å‹é“¾
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/atom.xml">
                <i class="iconfont icon-rss"></i>
                rss
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              &nbsp;<i class="iconfont icon-search"></i>&nbsp;
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">&nbsp;<i
                class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('https://i.loli.net/2021/11/11/LxNvdhpEX2sBjYc.png') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="ã€FUZZ.0x03ã€‘syzkaller - IIIï¼šsyz-fuzzer æºç åˆ†æ"></span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2023-09-27 01:26" pubdate>
          2023å¹´9æœˆ27æ—¥ å‡Œæ™¨
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          67k å­—
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          561 åˆ†é’Ÿ
        
      </span>
    

    
    
      
        <span id="busuanzi_container_page_pv" style="display: none">
          <i class="iconfont icon-eye" aria-hidden="true"></i>
          <span id="busuanzi_value_page_pv"></span> æ¬¡
        </span>
        
      
    
  </div>


        
      </div>

      
        <div class="scroll-down-bar">
          <i class="iconfont icon-arrowdown"></i>
        </div>
      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">ã€FUZZ.0x03ã€‘syzkaller - IIIï¼šsyz-fuzzer æºç åˆ†æ</h1>
            
              <p class="note note-info">
                
                  
                    æœ¬æ–‡æœ€åæ›´æ–°äºï¼š2023å¹´12æœˆ30æ—¥ æ™šä¸Š
                  
                
              </p>
            
            
              <div class="markdown-body">
                
                <p>ï¼ˆæ‘˜ä¸‹çœ¼é•œï¼‰Furryï¼Ÿï¼ˆæˆ´ä¸Šçœ¼é•œï¼‰Fuzzerï¼</p>
<span id="more"></span>

<h1 id="0x00-ä¸€åˆ‡å¼€å§‹ä¹‹å‰"><a href="#0x00-ä¸€åˆ‡å¼€å§‹ä¹‹å‰" class="headerlink" title="0x00. ä¸€åˆ‡å¼€å§‹ä¹‹å‰"></a>0x00. ä¸€åˆ‡å¼€å§‹ä¹‹å‰</h1><p>åœ¨<a target="_blank" rel="noopener" href="https://arttnba3.cn/2023/03/02/FUZZ-0X02-SYZKALLER-II_SOURCE_SYZMANAGER/">ä¸Šä¸€ç¯‡æ–‡ç« </a>å½“ä¸­æˆ‘ä»¬åˆ†æäº† syzkaller ä¸‰å¤§ç»„ä»¶å½“ä¸­çš„ syz-manager çš„æºç ï¼Œæœ¬ç¯‡æ–‡ç« æˆ‘ä»¬ç»§ç»­æ¥åˆ†æ syz-fuzzer çš„æºç </p>
<p>ä¸ syz-manager æ‰€ä¸åŒçš„æ˜¯ï¼Œsyz-fuzzer ä½äº Guest VM å½“ä¸­ï¼Œ<strong>æœ¬è´¨ä¸Šæ¶µç›–äº†ä¸€ä¸ªä¼ ç»Ÿ fuzzer çš„æ‰€æœ‰åŸºæœ¬åŠŸèƒ½</strong>ï¼šè¾“å…¥ç”Ÿæˆä¸å˜å¼‚ã€å¯åŠ¨æ–°è¿›ç¨‹ï¼ˆsyz-executorï¼‰æ‰§è¡Œè¾“å…¥ã€è·å–è¦†ç›–ç‡ä¿¡æ¯â€¦</p>
<p>åœ¨ syz-fuzzer è¿è¡Œè¿‡ç¨‹ä¸­å…¶ä¼šé€šè¿‡ RPC è°ƒç”¨ syz-manager ä¸­çš„éƒ¨åˆ†å‡½æ•°ï¼Œå› æ­¤æœ¬ç¯‡ä¹Ÿä¼šåˆ†æä¸Šç¯‡æ‰€æœªæ¶‰åŠåˆ°çš„ syz-manager ä¸­çš„ä¸€äº›å‡½æ•°ï¼šï¼‰</p>
<blockquote>
<p>è¿™ä¸€ç³»åˆ—æ–‡ç« ç¡®å®é¸½äº†æŒºä¹…äº†ï¼Œä½†æœ€è¿‘ç¡®å®æ˜¯æ¯”è¾ƒå¿™æ²¡å•¥æ—¶é—´å†™åšå®¢ï¼ˆè¿™ä¸€ç¯‡å…¶å®ä¹‹å‰å¤§è‡´çš„åˆç¨¿å°±å†™å¥½äº†ï¼Œä½†æ˜¯åé¢åˆé¸½æ‰äº†â€¦ï¼‰ï¼Œä¸çŸ¥é“ä¸‹ä¸€ç¯‡ä¼šæ˜¯ä»€ä¹ˆæ—¶å€™äº† XD</p>
</blockquote>
<h1 id="0x01-åŸºæœ¬ç»“æ„ä½“"><a href="#0x01-åŸºæœ¬ç»“æ„ä½“" class="headerlink" title="0x01. åŸºæœ¬ç»“æ„ä½“"></a>0x01. åŸºæœ¬ç»“æ„ä½“</h1><p>ç›¸æ¯”äºç›´æ¥å¼€å§‹ä¸€å¤´é›¾æ°´åœ°åˆ†ææºç ï¼Œç¬”è€…è®¤ä¸ºè¿˜æ˜¯æœ‰å¿…è¦åœ¨æ­¤ä¹‹å‰å…ˆåˆ—å‡ºä¸€äº›åŸºæœ¬çš„ç»“æ„ä½“ï¼Œä½ ä¹Ÿå¯ä»¥æŠŠè¿™ä¸€èŠ‚å½“æˆä¸€ä¸ªè¡¨æ¥æŸ¥ ï¼šï¼‰</p>
<h2 id="Fuzzing-è¿‡ç¨‹ç›¸å…³"><a href="#Fuzzing-è¿‡ç¨‹ç›¸å…³" class="headerlink" title="Fuzzing è¿‡ç¨‹ç›¸å…³"></a>Fuzzing è¿‡ç¨‹ç›¸å…³</h2><h3 id="1-Syscallï¼šå•ä¸ªç³»ç»Ÿè°ƒç”¨çš„åŸºæœ¬ä¿¡æ¯"><a href="#1-Syscallï¼šå•ä¸ªç³»ç»Ÿè°ƒç”¨çš„åŸºæœ¬ä¿¡æ¯" class="headerlink" title="1. Syscallï¼šå•ä¸ªç³»ç»Ÿè°ƒç”¨çš„åŸºæœ¬ä¿¡æ¯"></a>1. Syscallï¼šå•ä¸ªç³»ç»Ÿè°ƒç”¨çš„åŸºæœ¬ä¿¡æ¯</h3><p>syzkaller <strong>ä»¥ç³»ç»Ÿè°ƒç”¨ä¸ºåŸºæœ¬è¾“å…¥å•ä½</strong>ï¼Œå®šä¹‰äº <code>prog/types.go</code> ä¸­çš„ <code>Syscall</code> ç»“æ„ä½“è¢«ç”¨æ¥è¡¨ç¤ºå•ä¸ªç³»ç»Ÿè°ƒç”¨çš„åŸºæœ¬ä¿¡æ¯ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> Syscall <span class="hljs-keyword">struct</span> &#123;<br>	ID          <span class="hljs-type">int</span><br>	NR          <span class="hljs-type">uint64</span> <span class="hljs-comment">// kernel syscall number</span><br>	Name        <span class="hljs-type">string</span><br>	CallName    <span class="hljs-type">string</span><br>	MissingArgs <span class="hljs-type">int</span> <span class="hljs-comment">// number of trailing args that should be zero-filled</span><br>	Args        []Field<br>	Ret         Type<br>	Attrs       SyscallAttrs<br><br>	inputResources  []*ResourceDesc<br>	outputResources []*ResourceDesc<br>&#125;<br></code></pre></td></tr></table></figure>

<p>å½“æˆ‘ä»¬ç¼–å†™ syzlang æ–‡ä»¶æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥ä¸ºç³»ç»Ÿè°ƒç”¨<a target="_blank" rel="noopener" href="https://arttnba3.cn/2021/11/24/FUZZ-0X01-SYZKALLER-I/#call-attributes">æ·»åŠ ä¸€äº›å±æ€§</a>ï¼Œè¿™è¢«å°è£…äºå†…åµŒåœ¨ <code>Syscall</code> é‡Œçš„ <code>SyscallAttrs</code> ç»“æ„ä½“ä¸­ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// SyscallAttrs è¡¨ç¤º syzlang çš„è°ƒç”¨å±æ€§.</span><br><span class="hljs-comment">//</span><br><span class="hljs-comment">// è¯¥ç»“æ„ä¸ºç³»ç»Ÿæ‰€æœ‰å…¶ä»–éƒ¨åˆ†çš„ source of truth.</span><br><span class="hljs-comment">// pkg/compiler ä½¿ç”¨è¯¥ç»“æ„å¯¹æè¿°è¿›è¡Œè¯­æ³•åˆ†æ.</span><br><span class="hljs-comment">// syz-sysgen ä½¿ç”¨è¯¥ç»“æ„ä¸º executor ç”Ÿæˆä»£ç .</span><br><span class="hljs-comment">//</span><br><span class="hljs-comment">// ç›®å‰ä»…æ”¯æŒ `bool`s ä¸ `uint64`s.</span><br><span class="hljs-comment">//</span><br><span class="hljs-comment">// å¯¹äºç‹¬ç«‹å±æ€§çš„æè¿°ï¼Œå‚è§ docs/syscall_descriptions_syntax.md </span><br><span class="hljs-keyword">type</span> SyscallAttrs <span class="hljs-keyword">struct</span> &#123;<br>	Disabled      <span class="hljs-type">bool</span><br>	Timeout       <span class="hljs-type">uint64</span><br>	ProgTimeout   <span class="hljs-type">uint64</span><br>	IgnoreReturn  <span class="hljs-type">bool</span><br>	BreaksReturns <span class="hljs-type">bool</span><br>	NoGenerate    <span class="hljs-type">bool</span><br>	NoMinimize    <span class="hljs-type">bool</span><br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="2-ChoiceTableï¼šç³»ç»Ÿè°ƒç”¨ç”Ÿæˆä¼˜å…ˆçº§è¡¨"><a href="#2-ChoiceTableï¼šç³»ç»Ÿè°ƒç”¨ç”Ÿæˆä¼˜å…ˆçº§è¡¨" class="headerlink" title="2. ChoiceTableï¼šç³»ç»Ÿè°ƒç”¨ç”Ÿæˆä¼˜å…ˆçº§è¡¨"></a>2. ChoiceTableï¼šç³»ç»Ÿè°ƒç”¨ç”Ÿæˆä¼˜å…ˆçº§è¡¨</h3><p>å®šä¹‰äº <code>prog/prio.go</code> ä¸­çš„ <code>ChoiceTable</code> æ˜¯ syz-fuzzer ä¸­éå¸¸æ ¸å¿ƒçš„ä¸€ä¸ªç»“æ„ï¼Œå…¶ç”¨äºè¡¨ç¤º<strong>å¯¹äºç»™å®šçš„ç³»ç»Ÿè°ƒç”¨ xï¼Œåœ¨æ·»åŠ å…¥ç³»ç»Ÿè°ƒç”¨ y åï¼Œä»£ç è¦†ç›–ç‡ä¼šä¸Šå‡çš„å¯èƒ½æ€§</strong>ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// ChooseTableï¼ˆè¯‘æ³¨ï¼šåŸæ–‡å¦‚æ­¤ï¼‰å…è®¸å¯¹ç»™å®šçš„ä¸€ä¸ªç³»ç»Ÿè°ƒç”¨ï¼Œ</span><br><span class="hljs-comment">// å¯¹ä¸€ä¸ªç³»ç»Ÿè°ƒç”¨è¿›è¡Œä¸€æ¬¡æƒé‡é€‰æ‹©ï¼Œè¿™åŸºäºè°ƒç”¨åˆ°è°ƒç”¨çš„ä¼˜å…ˆçº§ä¸å¼€å¯&amp;å¯ç”Ÿæˆçš„ç³»ç»Ÿè°ƒç”¨é›†åˆ</span><br><span class="hljs-keyword">type</span> ChoiceTable <span class="hljs-keyword">struct</span> &#123;<br>	target          *Target	<span class="hljs-comment">/* ç›®æ ‡æ¶æ„ä¿¡æ¯ */</span><br>	runs            [][]<span class="hljs-type">int32</span> <span class="hljs-comment">/* ä¼˜å…ˆçº§è¡¨ */</span><br>	calls           []*Syscall <span class="hljs-comment">/* ç³»ç»Ÿè°ƒç”¨ä¿¡æ¯ */</span><br>	noGenerateCalls <span class="hljs-keyword">map</span>[<span class="hljs-type">int</span>]<span class="hljs-type">bool</span>  <span class="hljs-comment">/* ä¸ç”¨äºè¾“å…¥ç”Ÿæˆçš„ç³»ç»Ÿè°ƒç”¨å· */</span><br>&#125;<br></code></pre></td></tr></table></figure>

<p>ä¼˜å…ˆçº§æƒé‡å€¼å­˜æ”¾åœ¨äºŒç»´æ•°ç»„ <code>run</code> ä¸­ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯è¿™ä¸ªä¼˜å…ˆçº§ä¸º<strong>ç´¯åŠ å€¼</strong>ï¼Œä¾‹å¦‚æœ‰ç»™å®šçš„ä¸‰ä¸ªç³»ç»Ÿè°ƒç”¨ Aã€Bã€Cï¼Œæœ‰è¿™æ ·çš„ä¸€ä¸ªç”Ÿæˆä¼˜å…ˆçº§è¡¨ <code>prios</code>ï¼š</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">A</span> B C<br><span class="hljs-attribute">A</span> <span class="hljs-number">1</span> <span class="hljs-number">2</span> <span class="hljs-number">1</span><br><span class="hljs-attribute">B</span> <span class="hljs-number">2</span> <span class="hljs-number">1</span> <span class="hljs-number">2</span><br><span class="hljs-attribute">C</span> <span class="hljs-number">3</span> <span class="hljs-number">1</span> <span class="hljs-number">2</span><br></code></pre></td></tr></table></figure>

<p>é‚£ä¹ˆåœ¨ <code>run</code> è¡¨ä¸­åˆ™ä¼šå°†ä¸€åˆ—çš„ç»“æœé€ä¸ªåŠ èµ·æ¥ï¼Œä»è€Œæœ‰è¿™æ ·çš„ä¸€ä¸ªç»“æœï¼š</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">A</span> B C<br><span class="hljs-attribute">A</span> <span class="hljs-number">1</span> <span class="hljs-number">3</span> <span class="hljs-number">4</span><br><span class="hljs-attribute">B</span> <span class="hljs-number">2</span> <span class="hljs-number">3</span> <span class="hljs-number">5</span><br><span class="hljs-attribute">C</span> <span class="hljs-number">3</span> <span class="hljs-number">4</span> <span class="hljs-number">6</span><br></code></pre></td></tr></table></figure>

<p>ä¸ºä»€ä¹ˆè¦è¿™ä¹ˆåšç¬”è€…ä¹Ÿä¸çŸ¥é“ ï¼š(</p>
<h3 id="3-weightsï¼šæƒé‡"><a href="#3-weightsï¼šæƒé‡" class="headerlink" title="3. weightsï¼šæƒé‡"></a>3. weightsï¼šæƒé‡</h3><p>å®šä¹‰äº <code>prog/prio.go</code> ä¸­çš„ <code>weights</code> ç»“æ„ä½“ç”¨äºè¡¨ç¤ºã€ç›®æ ‡ç³»ç»Ÿè°ƒç”¨çš„æƒé‡ã€‘ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> weights <span class="hljs-keyword">struct</span> &#123;<br>	call  <span class="hljs-type">int</span> <span class="hljs-comment">/* ç³»ç»Ÿè°ƒç”¨å· */</span><br>	in    <span class="hljs-type">int32</span>  <span class="hljs-comment">/* ä»¥è¯¥ç³»ç»Ÿè°ƒç”¨ä½œä¸ºè¾“å…¥çš„æƒé‡å€¼ï¼Ÿ */</span><br>	inout <span class="hljs-type">int32</span>  <span class="hljs-comment">/* ä»¥è¯¥ç³»ç»Ÿè°ƒç”¨ä½œä¸ºè¾“å‡ºçš„æƒé‡å€¼ï¼Ÿ */</span><br>&#125;<br></code></pre></td></tr></table></figure>



<h3 id="4-Callï¼šç”¨ä½œè¾“å…¥çš„å•ä¸ªç³»ç»Ÿè°ƒç”¨"><a href="#4-Callï¼šç”¨ä½œè¾“å…¥çš„å•ä¸ªç³»ç»Ÿè°ƒç”¨" class="headerlink" title="4. Callï¼šç”¨ä½œè¾“å…¥çš„å•ä¸ªç³»ç»Ÿè°ƒç”¨"></a>4. Callï¼šç”¨ä½œè¾“å…¥çš„å•ä¸ªç³»ç»Ÿè°ƒç”¨</h3><p>syzkaller çš„ fuzzing ä»¥ syscall ä¸ºå•ä½ï¼Œ<code>Syscall</code> ç»“æ„ä½“ç”¨äºè¡¨ç¤ºå•ä¸ªç³»ç»Ÿè°ƒç”¨çš„åŸºæœ¬ä¿¡æ¯ï¼Œ<code>Call</code> ç»“æ„ä½“åˆ™è¡¨ç¤º<strong>å¸¦æœ‰å‚æ•°çš„ä¸€ä¸ªç³»ç»Ÿè°ƒç”¨</strong>ï¼Œæ˜¯ syzkaller ä¸­æ‰€è°“çš„æœ€å°è¾“å…¥å•ä½</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> Call <span class="hljs-keyword">struct</span> &#123;<br>	Meta    *Syscall<br>	Args    []Arg<br>	Ret     *ResultArg<br>	Props   CallProps<br>	Comment <span class="hljs-type">string</span><br>&#125;<br></code></pre></td></tr></table></figure>



<h3 id="5-ArgCtxï¼šå¸¦ä¸Šä¸‹æ–‡çš„å‚æ•°"><a href="#5-ArgCtxï¼šå¸¦ä¸Šä¸‹æ–‡çš„å‚æ•°" class="headerlink" title="5. ArgCtxï¼šå¸¦ä¸Šä¸‹æ–‡çš„å‚æ•°"></a>5. ArgCtxï¼šå¸¦ä¸Šä¸‹æ–‡çš„å‚æ•°</h3><p>ç³»ç»Ÿè°ƒç”¨çš„å‚æ•°ç”¨ <code>Arg</code> æ¥å£è¡¨ç¤ºï¼Œ <code>ArgCtx</code> ä¸ºå®ç°äº†è¯¥æ¥å£çš„å¸¦æœ‰ä¸Šä¸‹æ–‡çš„ä¸€ä¸ªå‚æ•°ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> ArgCtx <span class="hljs-keyword">struct</span> &#123;<br>	Parent *[]Arg      <span class="hljs-comment">// GroupArg.Inner (for structs) or Call.Args containing this arg.</span><br>	Fields []Field     <span class="hljs-comment">// Fields of the parent struct/syscall.</span><br>	Base   *PointerArg <span class="hljs-comment">// Pointer to the base of the heap object containing this arg.</span><br>	Offset <span class="hljs-type">uint64</span>      <span class="hljs-comment">// Offset of this arg from the base.</span><br>	Stop   <span class="hljs-type">bool</span>        <span class="hljs-comment">// If set by the callback, subargs of this arg are not visited.</span><br>&#125;<br></code></pre></td></tr></table></figure>





<h3 id="6-Progï¼šå•ä¸ªè¾“å…¥ç¨‹åº"><a href="#6-Progï¼šå•ä¸ªè¾“å…¥ç¨‹åº" class="headerlink" title="6. Progï¼šå•ä¸ªè¾“å…¥ç¨‹åº"></a>6. Progï¼šå•ä¸ªè¾“å…¥ç¨‹åº</h3><p>é€šå¸¸æƒ…å†µä¸‹æˆ‘ä»¬å¹¶ä¸ä»…ä»¥ä¸€ä¸ªç³»ç»Ÿè°ƒç”¨ä½œä¸ºè¾“å…¥ï¼Œè€Œæ˜¯ä»¥<strong>ä¸€ç»„ç³»ç»Ÿè°ƒç”¨åºåˆ—</strong>ä½œä¸ºè¾“å…¥å•ä½â€”â€”å³ä¸€ä¸ª<strong>ç¨‹åº</strong>ï¼Œè¿™ä¹Ÿæ˜¯ syzkaller ä¸­<strong>å®è´¨ä¸Šçš„æœ€å°è¾“å…¥å•ä½</strong>ï¼Œåœ¨ syz-fuzzer å½“ä¸­ä½¿ç”¨ <code>Prog</code> ç»“æ„ä½“æ¥è¡¨ç¤º<strong>å•ä¸ªè¾“å…¥</strong>ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> Prog <span class="hljs-keyword">struct</span> &#123;<br>	Target   *Target <span class="hljs-comment">/* ç›®æ ‡æ¶æ„ä¿¡æ¯ */</span><br>	Calls    []*Call <span class="hljs-comment">/* ç³»ç»Ÿè°ƒç”¨åºåˆ— */</span><br>	Comments []<span class="hljs-type">string</span>  <span class="hljs-comment">/* æ³¨é‡Šï¼Ÿ */</span><br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="6-Candidateï¼šåºåˆ—åŒ–çš„å•ä¸ªè¾“å…¥é¡¹"><a href="#6-Candidateï¼šåºåˆ—åŒ–çš„å•ä¸ªè¾“å…¥é¡¹" class="headerlink" title="6. Candidateï¼šåºåˆ—åŒ–çš„å•ä¸ªè¾“å…¥é¡¹"></a>6. Candidateï¼šåºåˆ—åŒ–çš„å•ä¸ªè¾“å…¥é¡¹</h3><p>æˆ‘ä»¬é€šå¸¸ä¼šæœ‰å¤šä¸ª syz-fuzzer è¿›ç¨‹ä¸ VMï¼Œè€Œæˆ‘ä»¬æ›´å¸Œæœ›<strong>åœ¨ fuzzer ä¹‹é—´å…±äº«é‚£äº›æœ‰ç”¨çš„è¾“å…¥</strong>ï¼Œè¿™é€šå¸¸é€šè¿‡ <code>syz-fuzzer</code> å‘ <code>syz-manager</code> å‘èµ· RPC <code>poll()</code> æ¥å®Œæˆâ€”â€”<code>candidate</code> ç”¨ä»¥è¡¨ç¤º<strong>åºåˆ—åŒ–åçš„è¾“å…¥</strong>ï¼Œä»è€Œæ–¹ä¾¿åœ¨ä¸åŒ è¿›ç¨‹é—´ä¼ é€’ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> Candidate <span class="hljs-keyword">struct</span> &#123;<br>	Prog      []<span class="hljs-type">byte</span>	<span class="hljs-comment">/* åºåˆ—åŒ–åçš„ç¨‹åº */</span><br>	Minimized <span class="hljs-type">bool</span>	<span class="hljs-comment">/* æ˜¯å¦æœ€å°åŒ–ï¼Ÿ */</span><br>	Smashed   <span class="hljs-type">bool</span>	<span class="hljs-comment">/* æ˜¯å¦è¦æ‰“ç¢é‡ç»„ï¼Ÿ */</span><br>&#125;<br></code></pre></td></tr></table></figure>



<h3 id="7-CallInfoï¼šå•ä¸ªç³»ç»Ÿè°ƒç”¨çš„è¿è¡Œç»“æœ"><a href="#7-CallInfoï¼šå•ä¸ªç³»ç»Ÿè°ƒç”¨çš„è¿è¡Œç»“æœ" class="headerlink" title="7. CallInfoï¼šå•ä¸ªç³»ç»Ÿè°ƒç”¨çš„è¿è¡Œç»“æœ"></a>7. CallInfoï¼šå•ä¸ªç³»ç»Ÿè°ƒç”¨çš„è¿è¡Œç»“æœ</h3><p>æ‰§è¡Œå®Œç¨‹åºä¹‹åæˆ‘ä»¬è‡ªç„¶æƒ³è¦çŸ¥é“ç¨‹åºçš„æ‰§è¡Œç»“æœï¼Œåœ¨ syz-fuzzer å½“ä¸­ä½¿ç”¨ <code>CallInfo</code> ç»“æ„ä½“è¡¨ç¤º<strong>å•ä¸ªç³»ç»Ÿè°ƒç”¨çš„æ‰§è¡Œç»“æœ</strong>ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> CallInfo <span class="hljs-keyword">struct</span> &#123;<br>	Flags  CallFlags<br>	Signal []<span class="hljs-type">uint32</span> <span class="hljs-comment">// åé¦ˆä¿¡å·, è‹¥è®¾ç½®äº† FlagSignal åˆ™å¡«å……</span><br>	Cover  []<span class="hljs-type">uint32</span> <span class="hljs-comment">// æ¯ä¸ªç³»ç»Ÿè°ƒç”¨çš„è¦†ç›–ç‡, è‹¥è®¾ç½®äº† FlagSignal ä¸” cover == true åˆ™å¡«å……,</span><br>	<span class="hljs-comment">// if dedup == false, åˆ™ cov å®é™…ä¸ŠåŒ…å«äº†ä¸€ä¸ª trace, å¦åˆ™é‡å¤é¡¹è¢«åˆ é™¤</span><br>	Comps prog.CompMap <span class="hljs-comment">// æ¯ä¸ªç³»ç»Ÿè°ƒç”¨çš„æ¯”è¾ƒæ“ä½œæ•°</span><br>	Errno <span class="hljs-type">int</span>          <span class="hljs-comment">// è°ƒç”¨çš„ errno (è‹¥è°ƒç”¨æˆåŠŸåˆ™ä¸º 0)</span><br>&#125;<br></code></pre></td></tr></table></figure>

<p>å…¶ä¸­ <code>CompMap</code> ä¸ºä¸€ä¸ªäºŒé‡æ˜ å°„ <code>uint64 â†’ ã€uint64 â†’ boolã€‘</code> ï¼Œæˆ‘ä»¬å°†åœ¨åæ–‡è§£é‡Šè¿™ä¸ªä¸œè¥¿ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// Example: for comparisons &#123;(op1, op2), (op1, op3), (op1, op4), (op2, op1)&#125;</span><br><span class="hljs-comment">// this map will store the following:</span><br><span class="hljs-comment">//</span><br><span class="hljs-comment">//	m = &#123;</span><br><span class="hljs-comment">//			op1: &#123;map[op2]: true, map[op3]: true, map[op4]: true&#125;,</span><br><span class="hljs-comment">//			op2: &#123;map[op1]: true&#125;</span><br><span class="hljs-comment">//	&#125;.</span><br><span class="hljs-keyword">type</span> CompMap <span class="hljs-keyword">map</span>[<span class="hljs-type">uint64</span>]<span class="hljs-keyword">map</span>[<span class="hljs-type">uint64</span>]<span class="hljs-type">bool</span><br></code></pre></td></tr></table></figure>



<h3 id="8-ProgInfoï¼šå•ä¸ªç¨‹åºçš„è¿è¡Œç»“æœ"><a href="#8-ProgInfoï¼šå•ä¸ªç¨‹åºçš„è¿è¡Œç»“æœ" class="headerlink" title="8. ProgInfoï¼šå•ä¸ªç¨‹åºçš„è¿è¡Œç»“æœ"></a>8. ProgInfoï¼šå•ä¸ªç¨‹åºçš„è¿è¡Œç»“æœ</h3><p>syzkaller ä¸­å•æ¬¡è¿è¡Œçš„æœ€å°ç²’åº¦å…¶å®æ˜¯ç”±ä¸€ç»„ç³»ç»Ÿè°ƒç”¨æ„æˆçš„ä¸€ä¸ªç¨‹åºï¼Œå› æ­¤ç¨‹åºçš„è¿è¡Œç»“æœå¾ˆè‡ªç„¶åœ°å°±æ˜¯ç”±ä¸€ç»„ <code>CallInfo</code> æ„æˆï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> ProgInfo <span class="hljs-keyword">struct</span> &#123;<br>	Calls []CallInfo<br>	Extra CallInfo <span class="hljs-comment">// stores Signal and Cover collected from background threads</span><br>&#125;<br></code></pre></td></tr></table></figure>



<h3 id="9-Envï¼šsyz-executor-çš„æ‰§è¡Œç¯å¢ƒä¿¡æ¯"><a href="#9-Envï¼šsyz-executor-çš„æ‰§è¡Œç¯å¢ƒä¿¡æ¯" class="headerlink" title="9. Envï¼šsyz-executor çš„æ‰§è¡Œç¯å¢ƒä¿¡æ¯"></a>9. Envï¼šsyz-executor çš„æ‰§è¡Œç¯å¢ƒä¿¡æ¯</h3><p> <code>Env</code> ç»“æ„ä½“ç”¨æ¥è®°å½• syz-executor çš„æ‰§è¡Œç¯å¢ƒä¿¡æ¯ï¼Œå¦‚è¾“å…¥ã€è¾“å‡ºã€æ‰§è¡Œçš„å‘½ä»¤è¡Œç­‰ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> Env <span class="hljs-keyword">struct</span> &#123;<br>	in  []<span class="hljs-type">byte</span><br>	out []<span class="hljs-type">byte</span><br><br>	cmd       *command<br>	inFile    *os.File<br>	outFile   *os.File<br>	bin       []<span class="hljs-type">string</span><br>	linkedBin <span class="hljs-type">string</span><br>	pid       <span class="hljs-type">int</span><br>	config    *Config<br><br>	StatExecs    <span class="hljs-type">uint64</span><br>	StatRestarts <span class="hljs-type">uint64</span><br>&#125;<br></code></pre></td></tr></table></figure>



<h3 id="10-WorkTriage-WorkCandidate-WorkSmash-ï¼šå®é™…çš„å•ä¸ªè¾“å…¥é¡¹"><a href="#10-WorkTriage-WorkCandidate-WorkSmash-ï¼šå®é™…çš„å•ä¸ªè¾“å…¥é¡¹" class="headerlink" title="10. WorkTriage&#x2F;WorkCandidate&#x2F;WorkSmash ï¼šå®é™…çš„å•ä¸ªè¾“å…¥é¡¹"></a>10. WorkTriage&#x2F;WorkCandidate&#x2F;WorkSmash ï¼šå®é™…çš„å•ä¸ªè¾“å…¥é¡¹</h3><p>åœ¨ fuzzing è¿‡ç¨‹å½“ä¸­ æˆ‘ä»¬å®é™…ä¸Šä¸ç›´æ¥ä»¥ raw çš„ <code>Prog</code> ä½œä¸ºè¾“å…¥ï¼Œæˆ‘ä»¬è¿˜æƒ³è¦åœ¨è¾“å…¥ä¸Šæ ‡è¯†æ›´å¤šé¢å¤–çš„ä¿¡æ¯â€”â€”å› æ­¤ä¾¿éœ€è¦åŠ ä¸Šä¸€å±‚ wrapperï¼Œä¸€å…±æœ‰å¦‚ä¸‹<strong>ä¸‰ç§ç±»å‹</strong>ï¼š</p>
<ul>
<li><code>WorkTriage</code>ï¼šå¯èƒ½æä¾›æ–°çš„è¦†ç›–ç‡çš„ç¨‹åº</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// WorkTriage ä¸ºæˆ‘ä»¬åœ¨åˆæ¬¡æ‰§è¡Œæ—¶æ‰€æ³¨æ„åˆ°çš„æ½œåœ¨æ–°è¦†ç›–çš„ç¨‹åº.</span><br><span class="hljs-comment">// ä½†æˆ‘ä»¬å¹¶ä¸èƒ½ç¡®å®šæ˜¯å¦è¿™æ˜¯çœŸå®çš„è¦†ç›–ç‡.</span><br><span class="hljs-comment">// åœ¨åˆ†ç±»ä¸­æˆ‘ä»¬æ˜ç™½äº†è¿™äº›ç¨‹åºæ˜¯å¦çœŸçš„ç»™å‡ºäº†æ–°çš„è¦†ç›–ç‡ï¼Œ</span><br><span class="hljs-comment">// è‹¥æ˜¯ï¼Œåˆ™å°†å…¶æœ€å°åŒ–å¹¶æ·»åŠ åˆ°è¯­æ–™åº“ä¸­.</span><br><span class="hljs-keyword">type</span> WorkTriage <span class="hljs-keyword">struct</span> &#123;<br>	p     *prog.Prog	<span class="hljs-comment">/* ç³»ç»Ÿè°ƒç”¨åºåˆ— */</span><br>	call  <span class="hljs-type">int</span>	<span class="hljs-comment">/* interesting çš„ç³»ç»Ÿè°ƒç”¨å·ï¼Ÿ */</span><br>	info  ipc.CallInfo	<span class="hljs-comment">/* è¿è¡Œç»“æœ */</span><br>	flags ProgTypes<br>&#125;<br></code></pre></td></tr></table></figure>

<ul>
<li><code>WorkCandidate</code>ï¼šç”± hubï¼ˆä¹Ÿå°±æ˜¯ syz-managerï¼‰ä¼ æ¥çš„ç¨‹åº</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// WorkCandidate ä¸ºæ¥è‡ª hub çš„ç¨‹åº.</span><br><span class="hljs-comment">// æˆ‘ä»¬æš‚ä¸çŸ¥é“å¥¹ä»¬å¯¹å½“å‰ fuzzer æ˜¯å¦æœ‰ç”¨.</span><br><span class="hljs-comment">// è¿›ç¨‹ä»¥å¯¹æœ¬åœ°ç”Ÿæˆ/å˜å¼‚ç¨‹åºç›¸åŒçš„æ–¹å¼å¤„ç†å¥¹ä»¬.</span><br><span class="hljs-keyword">type</span> WorkCandidate <span class="hljs-keyword">struct</span> &#123;<br>	p     *prog.Prog	<span class="hljs-comment">/* ç³»ç»Ÿè°ƒç”¨åºåˆ— */</span><br>	flags ProgTypes<br>&#125;<br></code></pre></td></tr></table></figure>

<ul>
<li><code>WorkSmash</code>ï¼šåˆšåˆšè¢«åŠ å…¥åˆ°è¯­æ–™åº“ä¸­çš„ç¨‹åº</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// WorkSmash ä¸ºåˆšåˆšæ·»åŠ åˆ°è¯­æ–™åº“ä¸­çš„ç¨‹åº.</span><br><span class="hljs-comment">// åœ¨ smashing è¿‡ç¨‹ä¸­è¿™äº›ç¨‹åºå°†æ”¶åˆ°ä¸€æ¬¡ç‰¹åˆ«çš„å…³æ³¨</span><br><span class="hljs-comment">// (emit faults, collect comparison hints, etc).</span><br><span class="hljs-keyword">type</span> WorkSmash <span class="hljs-keyword">struct</span> &#123;<br>	p    *prog.Prog	<span class="hljs-comment">/* ç³»ç»Ÿè°ƒç”¨åºåˆ— */</span><br>	call <span class="hljs-type">int</span>	<span class="hljs-comment">/* interesting çš„ç³»ç»Ÿè°ƒç”¨å·ï¼Ÿ */</span><br>&#125;<br></code></pre></td></tr></table></figure>



<h3 id="11-Coverï¼šè¦†ç›–ç‡ä¿¡æ¯"><a href="#11-Coverï¼šè¦†ç›–ç‡ä¿¡æ¯" class="headerlink" title="11. Coverï¼šè¦†ç›–ç‡ä¿¡æ¯"></a>11. Coverï¼šè¦†ç›–ç‡ä¿¡æ¯</h3><p>ä¸»æµçš„ fuzzer éƒ½æ˜¯åŸºäºè¦†ç›–ç‡æŒ‡å¯¼çš„ï¼Œsyzkaller ä¹Ÿä¸ä¾‹å¤–ï¼Œåœ¨ syz-fuzzer ä¸­ä½¿ç”¨ <code>Cover</code> ç»“æ„ä½“è¡¨ç¤ºè¦†ç›–ç‡ä¿¡æ¯ï¼š</p>
<blockquote>
<p> æ²¡æœ‰æ³¨é‡Šæ‰€ä»¥ç¬”è€…ä¹Ÿæ²¡å¤ªçœ‹æ˜ç™½æ˜¯æ€ä¹ˆä¸ªæ„æ€ï¼š( </p>
<p>ç›®å‰æ¨æµ‹ key æ˜¯ program counterï¼Œval ç›®å‰æ— å®é™…æ„ä¹‰åªæ˜¯ç”¨æ¥å ä½è¡¨ç¤ºè¦†ç›–åˆ°äº†è¯¥åœ°å€</p>
</blockquote>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> Cover <span class="hljs-keyword">map</span>[<span class="hljs-type">uint32</span>]<span class="hljs-keyword">struct</span>&#123;&#125;<br></code></pre></td></tr></table></figure>



<h2 id="è¾“å…¥ç”Ÿæˆå˜å¼‚ç›¸å…³"><a href="#è¾“å…¥ç”Ÿæˆå˜å¼‚ç›¸å…³" class="headerlink" title="è¾“å…¥ç”Ÿæˆå˜å¼‚ç›¸å…³"></a>è¾“å…¥ç”Ÿæˆå˜å¼‚ç›¸å…³</h2><h3 id="0-hint-æœºåˆ¶"><a href="#0-hint-æœºåˆ¶" class="headerlink" title="0. hint æœºåˆ¶"></a>0. hint æœºåˆ¶</h3><p>æˆ‘ä»¬é¦–å…ˆæ¥çœ‹ syz-executor ä¸­ä¸€ä¸ªé‡è¦çš„å˜å¼‚æœºåˆ¶â€”â€”<code>mutate with hint</code> ï¼ˆå¯ä»¥ç†è§£ä¸º hint è¾…åŠ©çš„å˜å¼‚ï¼‰ï¼Œåœ¨ <code>hint.go</code> å¼€å¤´æœ‰å¦‚ä¸‹æ³¨é‡Šï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// ä¸€ä¸ª hint å¤§ä½“è€Œè¨€ä¸ºä¸€ä¸ªç”±æŒ‡å‘ä¸€ä¸ªç¨‹åºä¸­ä¸€ä¸ªç³»ç»Ÿè°ƒç”¨çš„ä¸€ä¸ªå‚æ•°çš„æŒ‡é’ˆ</span><br><span class="hljs-comment">// ä¸ä¸€ä¸ªåº”å½“è¢«èµ‹ç»™è¯¥å‚æ•°çš„å€¼ï¼ˆæˆ‘ä»¬ç§°ä¹‹ä¸º replacerï¼‰ç»„æˆ.</span><br><span class="hljs-comment">//ï¼ˆè¯‘æ³¨ï¼šä»€ä¹ˆBé•¿éš¾å¥ï¼‰</span><br><br><span class="hljs-comment">// ä¸€ä¸ªç®€æ˜“ç‰ˆæœ¬çš„ hints workflow å½¢å¦‚:</span><br><span class="hljs-comment">//		1. Fuzzer å¯åŠ¨ä¸€ä¸ªç¨‹åº (ç§°ä¹‹ä¸º hint ç§å­) å¹¶ä¸ºç¨‹åºä¸­çš„æ¯ä¸ªç³»ç»Ÿè°ƒç”¨</span><br><span class="hljs-comment">// æ”¶é›†æ‰€æœ‰çš„æ¯”è¾ƒæ•°æ®.</span><br><span class="hljs-comment">//		2. æ¥ä¸‹æ¥å…¶å°è¯•å°†æ‰€è·å¾—çš„æ¯”è¾ƒæ“ä½œæ•°çš„å€¼äºè¾“å…¥å‚æ•°å€¼è¿›è¡ŒåŒ¹é….</span><br><span class="hljs-comment">//		3. å¯¹äºæ¯ä¸€ä¸ªè¿™æ ·çš„åŒ¹é…ï¼Œfuzzer é€šè¿‡å°†æŒ‡å‘çš„å‚æ•°ä½¿ç”¨ä¿å­˜çš„å€¼è¿›è¡Œæ›¿æ¢æ¥å˜å¼‚ç¨‹åº.</span><br><span class="hljs-comment">//		4. è‹¥è·å¾—äº†ä¸€ä¸ªåˆæ³•çš„ç¨‹åº, fuzzer å°†å…¶å¯åŠ¨å¹¶æ£€æŸ¥æ˜¯å¦è·å¾—äº†æ–°çš„è¦†ç›–ç‡.</span><br><span class="hljs-comment">// è¦äº†è§£æ›´å¤šå…³äºç‰¹å®šçªå˜çš„ä¿¡æ¯ï¼Œå‚è§ prog/hints_test.go.</span><br></code></pre></td></tr></table></figure>

<h3 id="1-CompMapï¼šç”¨ä½œæ¯”è¾ƒçš„å‚æ•°çš„æ”¶ç¼©-æ‰©å±•æ›¿æ¢å–å€¼è¡¨ã€æ ¸å¿ƒã€‘"><a href="#1-CompMapï¼šç”¨ä½œæ¯”è¾ƒçš„å‚æ•°çš„æ”¶ç¼©-æ‰©å±•æ›¿æ¢å–å€¼è¡¨ã€æ ¸å¿ƒã€‘" class="headerlink" title="1.CompMapï¼šç”¨ä½œæ¯”è¾ƒçš„å‚æ•°çš„æ”¶ç¼©&#x2F;æ‰©å±•æ›¿æ¢å–å€¼è¡¨ã€æ ¸å¿ƒã€‘"></a>1.CompMapï¼šç”¨ä½œæ¯”è¾ƒçš„å‚æ•°çš„æ”¶ç¼©&#x2F;æ‰©å±•æ›¿æ¢å–å€¼è¡¨ã€æ ¸å¿ƒã€‘</h3><p>CompMap ä¸ºä¸€ä¸ª <code>uint64 </code>åˆ° <code>[uint64 åˆ° bool çš„æ˜ å°„]</code> çš„æ˜ å°„ï¼Œç”¨æ¥åœ¨<strong>è¾“å…¥å˜å¼‚çš„æ—¶å€™è¿›è¡Œå‚æ•°å€¼çš„æ›¿æ¢</strong>ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// ğŸŒ°: å¯¹äºæ¯”è¾ƒå¯¹ &#123;(op1, op2), (op1, op3), (op1, op4), (op2, op1)&#125;</span><br><span class="hljs-comment">// è¯¥æ˜ å°„å°†å­˜å‚¨å¦‚ä¸‹:</span><br><span class="hljs-comment">//</span><br><span class="hljs-comment">//	m = &#123;</span><br><span class="hljs-comment">//			op1: &#123;map[op2]: true, map[op3]: true, map[op4]: true&#125;,</span><br><span class="hljs-comment">//			op2: &#123;map[op1]: true&#125;</span><br><span class="hljs-comment">//	&#125;.</span><br><span class="hljs-keyword">type</span> CompMap <span class="hljs-keyword">map</span>[<span class="hljs-type">uint64</span>]<span class="hljs-keyword">map</span>[<span class="hljs-type">uint64</span>]<span class="hljs-type">bool</span><br></code></pre></td></tr></table></figure>

<p>çœ‹ç€æ¯”è¾ƒæŠ½è±¡ï¼Œ<del>ç¬”è€…çœ‹äº†åŠå¤©ä¹Ÿä¸çŸ¥é“è¿™â„¢æ˜¯ä¸ªå•¥ç©æ„</del>ï¼Œä¸‹é¢æˆ‘ä»¬ç»“åˆ <code>prog/hints_test.go</code> ä¸­çš„ç¤ºä¾‹æ¥çœ‹ï¼šï¼‰</p>
<p><strong>æ¡ä»¶åˆ†æ”¯</strong>æ˜¯ç°ä»£ç¼–ç¨‹è¯­è¨€ä¸­çš„ä¸€ä¸ªåŸºæœ¬ç»“æ„ï¼Œä¾‹å¦‚æˆ‘ä»¬æœ‰å¦‚ä¸‹å‡½æ•°ï¼Œå…¶ä¼šæ ¹æ®ä¸åŒçš„å–å€¼è¿›å…¥ä¸åŒçš„åˆ†æ”¯ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// Models the following code:</span><br><span class="hljs-comment">// void f(u64 qw) &#123;</span><br><span class="hljs-comment">//		u8 b = (u8) qw</span><br><span class="hljs-comment">//		u16 w = (u16) qw</span><br><span class="hljs-comment">//		u32 dw = (u32) qw</span><br><span class="hljs-comment">//		if (b == 0xab) &#123;...&#125;</span><br><span class="hljs-comment">//		if (w == 0xcdcd) &#123;...&#125;</span><br><span class="hljs-comment">//		if (dw == 0xefefefef) &#123;...&#125;</span><br><span class="hljs-comment">//		if (qw == 0x0101010101010101) &#123;...&#125;</span><br><span class="hljs-comment">//  &#125;; f(0x1234567890abcdef);</span><br></code></pre></td></tr></table></figure>

<p>æˆ‘ä»¬ç»™è¯¥å‡½æ•°ä¼ å…¥çš„å‚æ•°ä¸º <code>0x1234567890abcdef</code> åœ¨è¯¥å‡½æ•°å½“ä¸­å‚æ•°ç”±äºå¼ºåˆ¶ç±»å‹è½¬æ¢è€Œå‘ç”Ÿäº†<strong>æˆªæ–­</strong>ï¼Œæˆ‘ä»¬ç§°ä¹‹ä¸º<strong>æ”¶ç¼©</strong>ï¼ˆshrinkï¼‰ï¼Œç”±äºå‚æ•°æˆªæ–­ä¹‹åä¸€ä¸ªæ¡ä»¶éƒ½åŒ¹é…ä¸ä¸Šï¼Œæ‰€ä»¥æˆ‘ä»¬ä¸€ä¸ªåˆ†æ”¯éƒ½è¿›ä¸å»ï¼š(</p>
<p>é‚£ä¹ˆå¦‚æœæˆ‘ä»¬æƒ³è¦èµ°è¿›ä¸åŒçš„åˆ†æ”¯è¯¥æ€ä¹ˆåŠå‘¢ï¼Ÿ <code>0x1234567890abcdef</code> æˆªæ–­æˆ <code>u8</code> åå˜æˆ <code>0xef</code>ï¼Œå¦‚æœæˆ‘ä»¬æƒ³è¦èµ°è¿›ç¬¬ä¸€ä¸ªæ¡ä»¶åˆ†æ”¯é‚£å°±è¦æ›¿æ¢æˆ <code>0xab</code>ï¼›ç±»ä¼¼åœ°ï¼Œ <code>0x1234567890abcdef</code> æˆªæ–­æˆ <code>u16</code> åå˜æˆ <code>0xcdef</code>ï¼Œå¦‚æœæˆ‘ä»¬æƒ³è¦èµ°è¿›ç¬¬äºŒä¸ªæ¡ä»¶åˆ†æ”¯é‚£å°±è¦æ›¿æ¢æˆ <code>0xcdcd</code> ï¼› <code>0x1234567890abcdef</code> æˆªæ–­æˆ <code>u32</code> åå˜æˆ <code>0xabcdef</code>ï¼Œå¦‚æœæˆ‘ä»¬æƒ³è¦èµ°è¿›ç¬¬ä¸‰ä¸ªæ¡ä»¶åˆ†æ”¯é‚£å°±è¦æ›¿æ¢æˆ <code>0xefefef</code> ï¼› è€Œå¦‚æœæˆ‘ä»¬æƒ³è¦èµ°è¿›æœ€åä¸€ä¸ªæ¡ä»¶åˆ†æ”¯ï¼Œåˆ™éœ€è¦å°†å‚æ•°æ•´ä¸ªæ›¿æ¢æˆ <code>0x0101010101010101</code> ï¼Œ<strong>ç”±æ­¤æˆ‘ä»¬å¾—åˆ°å¦‚ä¸‹ CompMap</strong>ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs go">CompMap&#123;<br>	<span class="hljs-number">0xef</span>:               compSet(<span class="hljs-number">0xab</span>, <span class="hljs-number">0xef</span>),<br>	<span class="hljs-number">0xcdef</span>:             compSet(<span class="hljs-number">0xcdcd</span>),<br>	<span class="hljs-number">0x90abcdef</span>:         compSet(<span class="hljs-number">0xefefefef</span>),<br>	<span class="hljs-number">0x1234567890abcdef</span>: compSet(<span class="hljs-number">0x0101010101010101</span>),<br>&#125;,<br></code></pre></td></tr></table></figure>

<p>æ ¹æ®è¯¥ <code>CompMap</code> ï¼Œæˆ‘ä»¬æœ€åå¾—åˆ°<strong>å¯ä»¥ç”¨æ¥æ›¿æ¢åŸå‚æ•°çš„æ–°å‚æ•°å€¼ä¸º</strong>ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs go">[]<span class="hljs-type">uint64</span>&#123;<br>	<span class="hljs-number">0x0101010101010101</span>,<br>	<span class="hljs-number">0x1234567890abcdab</span>,<br>	<span class="hljs-number">0x1234567890abcdcd</span>,<br>	<span class="hljs-number">0x12345678efefefef</span>,<br>&#125;,<br></code></pre></td></tr></table></figure>

<p>åœ¨ syzkaller çš„å®é™…è¿è¡Œè¿‡ç¨‹å½“ä¸­ï¼Œè¿™äº›æ¯”è¾ƒæ“ä½œæ•°<strong>å¯¹åº”çš„æ˜¯å†…æ ¸ä¸­çš„ä»£ç åˆ†æ”¯</strong>ï¼Œsyzkaller é€šè¿‡ <code>KCOV</code> è·å–è¿™äº›æ¯”è¾ƒæ“ä½œæ•°ï¼Œä»è€Œå¯¹ç¨‹åºè¾“å…¥å˜å¼‚<strong>ä»¥è·å–æ›´é«˜çš„ä»£ç è¦†ç›–ç‡</strong></p>
<h2 id="å…¨å±€ç®¡æ§ç›¸å…³"><a href="#å…¨å±€ç®¡æ§ç›¸å…³" class="headerlink" title="å…¨å±€ç®¡æ§ç›¸å…³"></a>å…¨å±€ç®¡æ§ç›¸å…³</h2><h3 id="1-Fuzzerï¼šåŸºæœ¬ä¿¡æ¯"><a href="#1-Fuzzerï¼šåŸºæœ¬ä¿¡æ¯" class="headerlink" title="1. Fuzzerï¼šåŸºæœ¬ä¿¡æ¯"></a>1. Fuzzerï¼šåŸºæœ¬ä¿¡æ¯</h3><p><code>Fuzzer</code> ç»“æ„ä½“ç”¨ä»¥å­˜å‚¨ä¸€ä¸ª syz-fuzzer çš„æ‰€æœ‰åŸºæœ¬ä¿¡æ¯ï¼Œå®šä¹‰äº <code>syz-fuzzer/fuzzer.go</code> ä¸­ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> Fuzzer <span class="hljs-keyword">struct</span> &#123;<br>	name        <span class="hljs-type">string</span><br>	outputType  OutputType<br>	config      *ipc.Config<br>	execOpts    *ipc.ExecOpts<br>	procs       []*Proc<br>	gate        *ipc.Gate<br>	workQueue   *WorkQueue<br>	needPoll    <span class="hljs-keyword">chan</span> <span class="hljs-keyword">struct</span>&#123;&#125;<br>	choiceTable *prog.ChoiceTable<br>	noMutate    <span class="hljs-keyword">map</span>[<span class="hljs-type">int</span>]<span class="hljs-type">bool</span><br>	<span class="hljs-comment">// stats åŸŸä¸å¹¸çš„æ— æ³•ä»…æ˜¯ä¸€ä¸ª uint64 æ•°ç»„, å› ä¸ºå…¶åœ¨ 32 ä½å¹³å°ä¸Š</span><br>	<span class="hljs-comment">// ä¼šé€ æˆ &quot;unaligned 64-bit atomic operation&quot; é”™è¯¯</span><br>	stats             []<span class="hljs-type">uint64</span><br>	manager           *rpctype.RPCClient<br>	target            *prog.Target<br>	triagedCandidates <span class="hljs-type">uint32</span><br>	timeouts          targets.Timeouts<br><br>	faultInjectionEnabled    <span class="hljs-type">bool</span><br>	comparisonTracingEnabled <span class="hljs-type">bool</span><br>	fetchRawCover            <span class="hljs-type">bool</span><br><br>	corpusMu     sync.RWMutex<br>	corpus       []*prog.Prog<br>	corpusHashes <span class="hljs-keyword">map</span>[hash.Sig]<span class="hljs-keyword">struct</span>&#123;&#125;<br>	corpusPrios  []<span class="hljs-type">int64</span><br>	sumPrios     <span class="hljs-type">int64</span><br><br>	signalMu     sync.RWMutex<br>	corpusSignal signal.Signal <span class="hljs-comment">// è¯­æ–™åº“ä¸­çš„è¾“å…¥çš„ä¿¡å·</span><br>	maxSignal    signal.Signal <span class="hljs-comment">// åŒ…æ‹¬ flakes åœ¨å†…çš„æ‰€è§‚å¯Ÿåˆ°çš„æœ€å¤§ä¿¡å·</span><br>	newSignal    signal.Signal <span class="hljs-comment">// è‡ªä¸Šæ¬¡ä¸ master åŒæ­¥ä»¥æ¥çš„ diff of maxSignal</span><br><br>	checkResult *rpctype.CheckArgs<br>	logMu       sync.Mutex<br>&#125;<br><br></code></pre></td></tr></table></figure>



<h3 id="2-Targetï¼šç›®æ ‡æ¶æ„ä¿¡æ¯"><a href="#2-Targetï¼šç›®æ ‡æ¶æ„ä¿¡æ¯" class="headerlink" title="2. Targetï¼šç›®æ ‡æ¶æ„ä¿¡æ¯"></a>2. Targetï¼šç›®æ ‡æ¶æ„ä¿¡æ¯</h3><p>å®šä¹‰äº <code>prog/target.go</code> ä¸­çš„ <code>Target</code> ç»“æ„ä½“ç”¨ä»¥è¡¨ç¤º fuzzing ç›®æ ‡æ¶æ„çš„åŸºæœ¬ä¿¡æ¯ï¼š</p>
<blockquote>
<p>æ‡’å¾—ç¿»è¯‘äº†ï¼Œå¤ªå¤šå­—äº†ï¼Œè‡ªå·±çœ‹ï¼šï¼‰</p>
</blockquote>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// Target describes target OS/arch pair.</span><br><span class="hljs-keyword">type</span> Target <span class="hljs-keyword">struct</span> &#123;<br>	OS                <span class="hljs-type">string</span><br>	Arch              <span class="hljs-type">string</span><br>	Revision          <span class="hljs-type">string</span> <span class="hljs-comment">// unique hash representing revision of the descriptions</span><br>	PtrSize           <span class="hljs-type">uint64</span><br>	PageSize          <span class="hljs-type">uint64</span><br>	NumPages          <span class="hljs-type">uint64</span><br>	DataOffset        <span class="hljs-type">uint64</span><br>	LittleEndian      <span class="hljs-type">bool</span><br>	ExecutorUsesShmem <span class="hljs-type">bool</span><br><br>	Syscalls  []*Syscall<br>	Resources []*ResourceDesc<br>	Consts    []ConstValue<br><br>	<span class="hljs-comment">// MakeDataMmap creates calls that mmaps target data memory range.</span><br>	MakeDataMmap <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> []*Call<br><br>	<span class="hljs-comment">// Neutralize neutralizes harmful calls by transforming them into non-harmful ones</span><br>	<span class="hljs-comment">// (e.g. an ioctl that turns off console output is turned into ioctl that turns on output).</span><br>	<span class="hljs-comment">// fixStructure determines whether it&#x27;s allowed to make structural changes (e.g. add or</span><br>	<span class="hljs-comment">// remove arguments). It is helpful e.g. when we do neutralization while iterating over the</span><br>	<span class="hljs-comment">// arguments.</span><br>	Neutralize <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(c *Call, fixStructure <span class="hljs-type">bool</span>)</span></span> <span class="hljs-type">error</span><br><br>	<span class="hljs-comment">// AnnotateCall annotates a syscall invocation in C reproducers.</span><br>	<span class="hljs-comment">// The returned string will be placed inside a comment except for the</span><br>	<span class="hljs-comment">// empty string which will omit the comment.</span><br>	AnnotateCall <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(c ExecCall)</span></span> <span class="hljs-type">string</span><br><br>	<span class="hljs-comment">// SpecialTypes allows target to do custom generation/mutation for some struct&#x27;s and union&#x27;s.</span><br>	<span class="hljs-comment">// Map key is struct/union name for which custom generation/mutation is required.</span><br>	<span class="hljs-comment">// Map value is custom generation/mutation function that will be called</span><br>	<span class="hljs-comment">// for the corresponding type. g is helper object that allows generate random numbers,</span><br>	<span class="hljs-comment">// allocate memory, etc. typ is the struct/union type. old is the old value of the struct/union</span><br>	<span class="hljs-comment">// for mutation, or nil for generation. The function returns a new value of the struct/union,</span><br>	<span class="hljs-comment">// and optionally any calls that need to be inserted before the arg reference.</span><br>	SpecialTypes <span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]<span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(g *Gen, typ Type, dir Dir, old Arg)</span></span> (Arg, []*Call)<br><br>	<span class="hljs-comment">// Resources that play auxiliary role, but widely used throughout all syscalls (e.g. pid/uid).</span><br>	AuxResources <span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]<span class="hljs-type">bool</span><br><br>	<span class="hljs-comment">// Additional special invalid pointer values besides NULL to use.</span><br>	SpecialPointers []<span class="hljs-type">uint64</span><br><br>	<span class="hljs-comment">// Special file name length that can provoke bugs (e.g. PATH_MAX).</span><br>	SpecialFileLenghts []<span class="hljs-type">int</span><br><br>	<span class="hljs-comment">// Filled by prog package:</span><br>	SyscallMap <span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]*Syscall<br>	ConstMap   <span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]<span class="hljs-type">uint64</span><br><br>	init        sync.Once<br>	initArch    <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(target *Target)</span></span><br>	types       []Type<br>	resourceMap <span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]*ResourceDesc<br>	<span class="hljs-comment">// Maps resource name to a list of calls that can create the resource.</span><br>	resourceCtors <span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>][]*Syscall<br>	any           anyTypes<br><br>	<span class="hljs-comment">// The default ChoiceTable is used only by tests and utilities, so we initialize it lazily.</span><br>	defaultOnce        sync.Once<br>	defaultChoiceTable *ChoiceTable<br>&#125;<br></code></pre></td></tr></table></figure>



<h3 id="3-Procï¼šsyz-executor-å®ä¾‹å¯¹è±¡"><a href="#3-Procï¼šsyz-executor-å®ä¾‹å¯¹è±¡" class="headerlink" title="3. Procï¼šsyz-executor å®ä¾‹å¯¹è±¡"></a>3. Procï¼šsyz-executor å®ä¾‹å¯¹è±¡</h3><p>åœ¨ syz-fuzzer å½“ä¸­ <code>Proc</code> ç»“æ„ä½“è¢«ç”¨ä»¥è¡¨ç¤º<strong>ä¸€ä¸ª syz-executor å®ä¾‹</strong></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// Proc è¡¨ç¤ºä¸€ä¸ªå•ç‹¬çš„ fuzzing ç¨‹åº (executor).</span><br><span class="hljs-keyword">type</span> Proc <span class="hljs-keyword">struct</span> &#123;<br>	fuzzer          *Fuzzer<br>	pid             <span class="hljs-type">int</span><br>	env             *ipc.Env<br>	rnd             *rand.Rand<br>	execOpts        *ipc.ExecOpts<br>	execOptsCollide *ipc.ExecOpts<br>	execOptsCover   *ipc.ExecOpts<br>	execOptsComps   *ipc.ExecOpts<br>&#125;<br></code></pre></td></tr></table></figure>

<p>å…¶ä¸­ <code>env</code> æˆå‘˜ç”¨ä»¥è¡¨ç¤ºå•ä¸ª syz-executor çš„è¿è¡Œç¯å¢ƒï¼Œå®šä¹‰äº <code>pkg/ipc/ipc.go</code> ä¸­ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> Env <span class="hljs-keyword">struct</span> &#123;<br>	in  []<span class="hljs-type">byte</span><br>	out []<span class="hljs-type">byte</span><br><br>	cmd       *command<br>	inFile    *os.File<br>	outFile   *os.File<br>	bin       []<span class="hljs-type">string</span><br>	linkedBin <span class="hljs-type">string</span><br>	pid       <span class="hljs-type">int</span><br>	config    *Config<br><br>	StatExecs    <span class="hljs-type">uint64</span><br>	StatRestarts <span class="hljs-type">uint64</span><br>&#125;<br></code></pre></td></tr></table></figure>

<p><code>Env-&gt;cmd</code> åˆ™ç”¨ä»¥è¡¨ç¤ºæ‰§è¡Œ syz-executor çš„å‘½ä»¤ä¿¡æ¯ï¼ŒåŒ…æ‹¬ pidã€é…ç½®ã€å‘½ä»¤è¡Œå‚æ•°ç­‰ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> command <span class="hljs-keyword">struct</span> &#123;<br>	pid      <span class="hljs-type">int</span><br>	config   *Config<br>	timeout  time.Duration<br>	cmd      *exec.Cmd<br>	dir      <span class="hljs-type">string</span><br>	readDone <span class="hljs-keyword">chan</span> []<span class="hljs-type">byte</span><br>	exited   <span class="hljs-keyword">chan</span> <span class="hljs-type">error</span><br>	inrp     *os.File<br>	outwp    *os.File<br>	outmem   []<span class="hljs-type">byte</span><br>&#125;<br></code></pre></td></tr></table></figure>

<p><code>command-&gt;cmd</code> ä¸ºæœ€ç»ˆç”¨æ¥æ‰§è¡Œ syz-executor çš„å‘½ä»¤è¡Œï¼Œæ¥è‡ªäº golang åŸç”Ÿçš„ exec åº“</p>
<h3 id="4-WorkQueueï¼šå¾…ä½¿ç”¨çš„å•-syz-fuzer-çš„å…¨å±€è¾“å…¥é˜Ÿåˆ—"><a href="#4-WorkQueueï¼šå¾…ä½¿ç”¨çš„å•-syz-fuzer-çš„å…¨å±€è¾“å…¥é˜Ÿåˆ—" class="headerlink" title="4. WorkQueueï¼šå¾…ä½¿ç”¨çš„å• syz-fuzer çš„å…¨å±€è¾“å…¥é˜Ÿåˆ—"></a>4. WorkQueueï¼šå¾…ä½¿ç”¨çš„å• syz-fuzer çš„å…¨å±€è¾“å…¥é˜Ÿåˆ—</h3><p>åœ¨ syz-fuzzer å½“ä¸­æ‰€æœ‰çš„è¾“å…¥éƒ½è¢«å­˜æ”¾åœ¨ <code>WorkQueue</code> é˜Ÿåˆ—å½“ä¸­ï¼Œä¸€ä¸ª syz-fuzzer å¯èƒ½ä¼šå¯åŠ¨å¤šä¸ª syz-executor è¿›ç¨‹ï¼Œä»–ä»¬å…±äº«åŒä¸€ä¸ª <code>WorkQueue</code>ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// WorkQueue å­˜æ”¾å…¨å±€çš„ non-fuzzing å·¥ä½œé¡¹ç›® (å‚è§ä¸‹é¢çš„ Work* ç»“æ„ä½“).</span><br><span class="hljs-comment">// WorkQueue ä¹Ÿåœ¨å·¥ä½œé¡¹ç›®é—´è¿›è¡Œä¼˜å…ˆæ’åºï¼Œä¾‹å¦‚æˆ‘ä»¬æƒ³è¦åœ¨æˆ‘ä»¬ç¢ç‰‡åŒ–ç¨‹åºå‰</span><br><span class="hljs-comment">// åˆ†ç±»å¹¶å‘ manager å‘é€æ–°çš„è¾“å…¥ä»¥åœ¨ VM å´©æºƒçš„æƒ…å†µä¸‹ä¸ä¼šæ°¸ä¹…å¤±å»æœ‰è¶£çš„ç¨‹åº.</span><br><span class="hljs-comment">//ï¼ˆè¯‘æ³¨ï¼šinteresting input åœ¨ fuzzing ä¸­æ˜¯ç»å…¸æ¦‚å¿µäº†ï¼Œè¿™é‡Œåº”è¯¥ä¸éœ€è¦ç¬”è€…æ³¨é‡Šäº†ï¼‰</span><br><span class="hljs-keyword">type</span> WorkQueue <span class="hljs-keyword">struct</span> &#123;<br>	mu              sync.RWMutex<br>	triageCandidate []*WorkTriage<br>	candidate       []*WorkCandidate<br>	triage          []*WorkTriage<br>	smash           []*WorkSmash<br><br>	procs          <span class="hljs-type">int</span><br>	needCandidates <span class="hljs-keyword">chan</span> <span class="hljs-keyword">struct</span>&#123;&#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ° <code>WorkQueue</code> ä¸º <code>WorkTriage/WorkCandidate/WorkSmash</code> éƒ½åˆ†åˆ«å»ºç«‹äº†ä¸€ä¸ªæ–°çš„é˜Ÿåˆ— </p>
<h2 id="fuzzer-executor-é€šä¿¡ç›¸å…³"><a href="#fuzzer-executor-é€šä¿¡ç›¸å…³" class="headerlink" title="fuzzer &amp; executor é€šä¿¡ç›¸å…³"></a>fuzzer &amp; executor é€šä¿¡ç›¸å…³</h2><h3 id="1-executeReqï¼šfuzzerâ†’executor-è¯·æ±‚å¤´"><a href="#1-executeReqï¼šfuzzerâ†’executor-è¯·æ±‚å¤´" class="headerlink" title="1. executeReqï¼šfuzzerâ†’executor è¯·æ±‚å¤´"></a>1. executeReqï¼šfuzzerâ†’executor è¯·æ±‚å¤´</h3><p>fuzzing çš„ä¸»ä½“è¿›ç¨‹ç”± syz-fuzzer å®Œæˆï¼Œsyz-executor ä»…éœ€è¦å®Œæˆå•ä¸ªè¾“å…¥ç¨‹åºçš„è¿è¡Œï¼Œå› æ­¤ syz-fuzzer éœ€è¦å¤šæ¬¡ä¸ syz-executor é—´é€šä¿¡ï¼šå‘é€å¾…è¿è¡Œçš„æ•°æ®å¹¶æ¥æ”¶è¿è¡Œç»“æœ</p>
<p>syz-fuzzer ä¸ syz-executor é—´é€šä¿¡é€šè¿‡ç®¡é“å®Œæˆï¼Œå› æ­¤æ¯æ¬¡é€šä¿¡å‰ syz-fuzzer éœ€è¦æ‰‹åŠ¨å‘Šè¯‰ syz-executor æœ¬æ¬¡å¾…æ¥æ”¶çš„æ•°æ®ç±»å‹ã€é•¿åº¦ç­‰ä¿¡æ¯ï¼Œè¿™äº›ä¿¡æ¯è¢«å°è£…åœ¨å›ºå®šå¤§å°çš„ <code>executeReq</code> ç»“æ„ä½“å½“ä¸­ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> executeReq <span class="hljs-keyword">struct</span> &#123;<br>	magic            <span class="hljs-type">uint64</span><br>	envFlags         <span class="hljs-type">uint64</span> <span class="hljs-comment">// env flags</span><br>	execFlags        <span class="hljs-type">uint64</span> <span class="hljs-comment">// exec flags</span><br>	pid              <span class="hljs-type">uint64</span><br>	syscallTimeoutMS <span class="hljs-type">uint64</span><br>	programTimeoutMS <span class="hljs-type">uint64</span><br>	slowdownScale    <span class="hljs-type">uint64</span><br>	progSize         <span class="hljs-type">uint64</span><br>	<span class="hljs-comment">// è¯¥ç»“æ„ä½“ä¹‹åè·Ÿç€ä¸€ä¸ª encodingexec æ ¼å¼çš„åºåˆ—åŒ–çš„æµ‹è¯•ç¨‹åº.</span><br>	<span class="hljs-comment">// Both when sent over a pipe or in shared memory.</span><br>&#125;<br></code></pre></td></tr></table></figure>

<p>æˆ‘ä»¬å¯ä»¥ç†è§£ä¸º <code>executeReq</code> ä¸ºå•æ¬¡è¯·æ±‚çš„è¯·æ±‚å¤´ï¼Œåé¢è·Ÿç€çš„åºåˆ—åŒ–è¾“å…¥ç¨‹åº <code>progData</code> ä¸ºå•æ¬¡è¯·æ±‚çš„è¯·æ±‚ä½“ï¼Œæ•… syz-fuzzer å‘ syz-executor å‘é€å•ä¸ªç¨‹åºæ‰§è¡Œè¯·æ±‚çš„ç¤ºä¾‹å¦‚ä¸‹ï¼š</p>
<p><img src="https://s2.loli.net/2023/04/24/I6od1evyCE3MZWH.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<h3 id="2-executeReply-callReplyï¼šexecutor-æ–¹å“åº”çš„å•ä¸ªç³»ç»Ÿè°ƒç”¨æ‰§è¡Œç»“æœ"><a href="#2-executeReply-callReplyï¼šexecutor-æ–¹å“åº”çš„å•ä¸ªç³»ç»Ÿè°ƒç”¨æ‰§è¡Œç»“æœ" class="headerlink" title="2. executeReply &amp; callReplyï¼šexecutor æ–¹å“åº”çš„å•ä¸ªç³»ç»Ÿè°ƒç”¨æ‰§è¡Œç»“æœ"></a>2. executeReply &amp; callReplyï¼šexecutor æ–¹å“åº”çš„å•ä¸ªç³»ç»Ÿè°ƒç”¨æ‰§è¡Œç»“æœ</h3><p>æœ‰æ”¶ä¾¿æœ‰å‘ï¼Œsyz-executor åœ¨å®Œæˆæ‰§è¡Œåä¼šé€šè¿‡å¦ä¸€ä¸ªç®¡é“å°†æ‰§è¡Œç»“æœå‘é€ç»™ syz-fuzzerï¼Œç”±äº syzkaller ä»¥å•ä¸ªç³»ç»Ÿè°ƒç”¨ä¸ºæ‰§è¡Œçš„æœ€å°ç²’åº¦ï¼Œå› æ­¤syz-executor æ¯æ¬¡è¿”å›ç»™ syz-fuzzer çš„ä¾¿æ˜¯<strong>å•ä¸ªç³»ç»Ÿè°ƒç”¨çš„æ‰§è¡Œç»“æœ</strong>ï¼Œä½¿ç”¨ä¸€ä¸ªå¤´éƒ¨ <code>executeReply</code> æ ‡è¯†ä¿¡æ¯ï¼Œä½¿ç”¨ <code>callReply</code> å­˜å‚¨å…·ä½“ç»“æœï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> executeReply <span class="hljs-keyword">struct</span> &#123;<br>	magic <span class="hljs-type">uint32</span><br>	<span class="hljs-comment">// If done is 0, then this is call completion message followed by callReply.</span><br>	<span class="hljs-comment">// If done is 1, then program execution is finished and status is set.</span><br>	done   <span class="hljs-type">uint32</span><br>	status <span class="hljs-type">uint32</span><br>&#125;<br><br><span class="hljs-keyword">type</span> callReply <span class="hljs-keyword">struct</span> &#123;<br>	magic      <span class="hljs-type">uint32</span><br>	index      <span class="hljs-type">uint32</span> <span class="hljs-comment">// call index in the program</span><br>	num        <span class="hljs-type">uint32</span> <span class="hljs-comment">// syscall number (for cross-checking)</span><br>	errno      <span class="hljs-type">uint32</span><br>	flags      <span class="hljs-type">uint32</span> <span class="hljs-comment">// see CallFlags</span><br>	signalSize <span class="hljs-type">uint32</span><br>	coverSize  <span class="hljs-type">uint32</span><br>	compsSize  <span class="hljs-type">uint32</span><br>	<span class="hljs-comment">// signal/cover/comps follow</span><br>&#125;<br></code></pre></td></tr></table></figure>

<p><code>executeReply</code> ä¸­çš„ done æ ‡å¿—ä½ç”¨ä»¥æ ‡è¯†ä¼ è¾“æ˜¯å¦ç»“æŸï¼Œå¯¹äºæ¥è‡ª syz-fuzzer çš„å•æ¬¡æ‰§è¡Œè¯·æ±‚ï¼Œsyz-executor çš„è¿”å›ç»“æœå¦‚ä¸‹ï¼ˆä»¥ä¸€ä¸ª <code>done != 0</code> çš„ <code>executeReply</code> ä½œä¸ºç»ˆæ­¢ï¼‰ï¼š</p>
<p><img src="https://s2.loli.net/2023/04/24/seE43rD2uaXCbwj.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<h1 id="0x02-main-ï¼šä¸-manager-å»ºç«‹-RPC-è¿æ¥ï¼Œè¿›è¡Œåˆå§‹åŒ–å·¥ä½œ"><a href="#0x02-main-ï¼šä¸-manager-å»ºç«‹-RPC-è¿æ¥ï¼Œè¿›è¡Œåˆå§‹åŒ–å·¥ä½œ" class="headerlink" title="0x02. main()ï¼šä¸ manager å»ºç«‹ RPC è¿æ¥ï¼Œè¿›è¡Œåˆå§‹åŒ–å·¥ä½œ"></a>0x02. main()ï¼šä¸ manager å»ºç«‹ RPC è¿æ¥ï¼Œè¿›è¡Œåˆå§‹åŒ–å·¥ä½œ</h1><p>æˆ‘ä»¬è¿˜æ˜¯æŒ‰ç…§æƒ¯ä¾‹ä»ç¨‹åºå…¥å£ç‚¹è¿›è¡Œåˆ†æï¼Œ<code>syz-fuzzer()</code> çš„ <code>main()</code> å‡½æ•°åšçš„å·¥ä½œæ¯”è¾ƒç®€å•ï¼Œä¸»è¦è¿˜æ˜¯ä¸€äº›åˆå§‹åŒ–å·¥ä½œä»¥åŠå¼•å¯¼åç»­å·¥ä½œæµç¨‹</p>
<h2 id="åˆå§‹åŒ–å‚æ•°è§£æä¸-RPC-è¿æ¥ï¼Œè·å–è¯­æ–™åº“ä¸è¾“å…¥"><a href="#åˆå§‹åŒ–å‚æ•°è§£æä¸-RPC-è¿æ¥ï¼Œè·å–è¯­æ–™åº“ä¸è¾“å…¥" class="headerlink" title="åˆå§‹åŒ–å‚æ•°è§£æä¸ RPC è¿æ¥ï¼Œè·å–è¯­æ–™åº“ä¸è¾“å…¥"></a>åˆå§‹åŒ–å‚æ•°è§£æä¸ RPC è¿æ¥ï¼Œè·å–è¯­æ–™åº“ä¸è¾“å…¥</h2><h3 id="Step-I-ä¸€äº›åˆå§‹åŒ–å·¥ä½œ"><a href="#Step-I-ä¸€äº›åˆå§‹åŒ–å·¥ä½œ" class="headerlink" title="Step.I - ä¸€äº›åˆå§‹åŒ–å·¥ä½œ"></a>Step.I - ä¸€äº›åˆå§‹åŒ–å·¥ä½œ</h3><p>ä¸€å¼€å§‹è¿˜æ˜¯æƒ¯ä¾‹çš„å„ç§åˆå§‹åŒ–å’Œé…ç½®å‚æ•°è§£æå·¥ä½œ</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// nolint: funlen</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>	debug.SetGCPercent(<span class="hljs-number">50</span>)<br><br>	<span class="hljs-keyword">var</span> (<br>		flagName     = flag.String(<span class="hljs-string">&quot;name&quot;</span>, <span class="hljs-string">&quot;test&quot;</span>, <span class="hljs-string">&quot;unique name for manager&quot;</span>)<br>		flagOS       = flag.String(<span class="hljs-string">&quot;os&quot;</span>, runtime.GOOS, <span class="hljs-string">&quot;target OS&quot;</span>)<br>		flagArch     = flag.String(<span class="hljs-string">&quot;arch&quot;</span>, runtime.GOARCH, <span class="hljs-string">&quot;target arch&quot;</span>)<br>		flagManager  = flag.String(<span class="hljs-string">&quot;manager&quot;</span>, <span class="hljs-string">&quot;&quot;</span>, <span class="hljs-string">&quot;manager rpc address&quot;</span>)<br>		flagProcs    = flag.Int(<span class="hljs-string">&quot;procs&quot;</span>, <span class="hljs-number">1</span>, <span class="hljs-string">&quot;number of parallel test processes&quot;</span>)<br>		flagOutput   = flag.String(<span class="hljs-string">&quot;output&quot;</span>, <span class="hljs-string">&quot;stdout&quot;</span>, <span class="hljs-string">&quot;write programs to none/stdout/dmesg/file&quot;</span>)<br>		flagTest     = flag.Bool(<span class="hljs-string">&quot;test&quot;</span>, <span class="hljs-literal">false</span>, <span class="hljs-string">&quot;enable image testing mode&quot;</span>)      <span class="hljs-comment">// used by syz-ci</span><br>		flagRunTest  = flag.Bool(<span class="hljs-string">&quot;runtest&quot;</span>, <span class="hljs-literal">false</span>, <span class="hljs-string">&quot;enable program testing mode&quot;</span>) <span class="hljs-comment">// used by pkg/runtest</span><br>		flagRawCover = flag.Bool(<span class="hljs-string">&quot;raw_cover&quot;</span>, <span class="hljs-literal">false</span>, <span class="hljs-string">&quot;fetch raw coverage&quot;</span>)<br>	)<br>	<span class="hljs-keyword">defer</span> tool.Init()()<br>	outputType := parseOutputType(*flagOutput)<br>	log.Logf(<span class="hljs-number">0</span>, <span class="hljs-string">&quot;fuzzer started&quot;</span>)<br><br>	target, err := prog.GetTarget(*flagOS, *flagArch)<br>	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>		log.Fatalf(<span class="hljs-string">&quot;%v&quot;</span>, err)<br>	&#125;<br><br>	config, execOpts, err := ipcconfig.Default(target)<br>	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>		log.Fatalf(<span class="hljs-string">&quot;failed to create default ipc config: %v&quot;</span>, err)<br>	&#125;<br>	<span class="hljs-keyword">if</span> *flagRawCover &#123;<br>		execOpts.Flags &amp;^= ipc.FlagDedupCover<br>	&#125;<br>	timeouts := config.Timeouts<br>	sandbox := ipc.FlagsToSandbox(config.Flags)<br></code></pre></td></tr></table></figure>

<p>æ¥ä¸‹æ¥ä¼šåˆ›å»ºä¸€ä¸ª <code>shutdown</code> channel å¹¶å¯åŠ¨ä¸€ä¸ªåç¨‹è¿›è¡Œç›‘æµ‹ï¼Œå½“è¯¥ channel æœ‰æ•°æ®æ—¶è¯´æ˜é‡åˆ°äº†ä¸€äº›æƒ…å†µï¼Œæ­¤æ—¶ syz-fuzzer éœ€è¦ä¸»åŠ¨é€€å‡º</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs go">shutdown := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> <span class="hljs-keyword">struct</span>&#123;&#125;)<br>osutil.HandleInterrupts(shutdown)<br><span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br>	<span class="hljs-comment">// Handles graceful preemption on GCE.</span><br>	&lt;-shutdown<br>	log.Logf(<span class="hljs-number">0</span>, <span class="hljs-string">&quot;SYZ-FUZZER: PREEMPTED&quot;</span>)<br>	os.Exit(<span class="hljs-number">1</span>)<br>&#125;()<br></code></pre></td></tr></table></figure>

<p><code>osutil.HandleInterrupts()</code> åˆ™æ˜¯ä¸€ä¸ªæ ¹æ®ä¸åŒçš„ç›®æ ‡ os è¿›è¡Œå®šåˆ¶çš„å‡½æ•°ï¼Œå¯¹äº unix ç³» os è€Œè¨€è¯¥å‡½æ•°å®šä¹‰äº <code>osutil_unix.go</code> ä¸­ï¼Œå…¶ä¼šç­‰å¾…æ”¶åˆ°ä¸‰ä¸ª SIGINT ä¿¡å·æ‰çœŸæ­£å…³é—­ç¨‹åºï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// HandleInterrupts åœ¨ç¬¬ä¸€ä¸ª SIGINT æ—¶å…³é—­ shutdown chan</span><br><span class="hljs-comment">// (å¸Œæœ›ç¨‹åºèƒ½ä¼˜é›…åœ° shutdown å¹¶ exit)</span><br><span class="hljs-comment">// å¹¶åœ¨ç¬¬ä¸‰ä¸ª SIGINT æ—¶ç»ˆæ­¢ç¨‹åº.</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">HandleInterrupts</span><span class="hljs-params">(shutdown <span class="hljs-keyword">chan</span> <span class="hljs-keyword">struct</span>&#123;&#125;)</span></span> &#123;<br>	<span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br>		c := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> os.Signal, <span class="hljs-number">3</span>)<br>		signal.Notify(c, syscall.SIGINT, syscall.SIGTERM)<br>		&lt;-c<br>		<span class="hljs-built_in">close</span>(shutdown)<br>		fmt.Fprint(os.Stderr, <span class="hljs-string">&quot;SIGINT: shutting down...\n&quot;</span>)<br>		&lt;-c<br>		fmt.Fprint(os.Stderr, <span class="hljs-string">&quot;SIGINT: shutting down harder...\n&quot;</span>)<br>		&lt;-c<br>		fmt.Fprint(os.Stderr, <span class="hljs-string">&quot;SIGINT: terminating\n&quot;</span>)<br>		os.Exit(<span class="hljs-type">int</span>(syscall.SIGINT))<br>	&#125;()<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="Step-II-ä¸-syz-manager-é—´å»ºç«‹-RPC-é€šä¿¡ï¼ŒåŠ è½½è¯­æ–™åº“"><a href="#Step-II-ä¸-syz-manager-é—´å»ºç«‹-RPC-é€šä¿¡ï¼ŒåŠ è½½è¯­æ–™åº“" class="headerlink" title="Step.II - ä¸ syz-manager é—´å»ºç«‹ RPC é€šä¿¡ï¼ŒåŠ è½½è¯­æ–™åº“"></a>Step.II - ä¸ syz-manager é—´å»ºç«‹ RPC é€šä¿¡ï¼ŒåŠ è½½è¯­æ–™åº“</h3><p>å›åˆ° <code>main()</code> ä¸­ï¼Œæ¥ä¸‹æ¥ä¼šæ”¶é›† Guest ä¿¡æ¯å¹¶å°è¯•ä¸ Hostï¼ˆsyz-managerï¼‰ é—´å»ºç«‹ RPC è¿æ¥ï¼Œè‹¥å¤±è´¥åˆ™ç›´æ¥é€€å‡ºï¼Œè¿™é‡Œæˆ‘ä»¬ä¼ ç»™ syz-manager çš„æ˜¯ <code>rpctype.ConnectArgs</code>ï¼Œæ”¶åˆ°çš„å“åº”ç»“æœä¸º <code>rpctype.ConnectRes</code> ï¼Œå…¶ä¸­åŒ…å«æœ‰å¾ˆå¤šä¿¡æ¯ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs go">checkArgs := &amp;checkArgs&#123;<br>	target:         target,<br>	sandbox:        sandbox,<br>	ipcConfig:      config,<br>	ipcExecOpts:    execOpts,<br>	gitRevision:    prog.GitRevision,<br>	targetRevision: target.Revision,<br>&#125;<br><span class="hljs-keyword">if</span> *flagTest &#123;<br>	testImage(*flagManager, checkArgs)<br>	<span class="hljs-keyword">return</span><br>&#125;<br><br>machineInfo, modules := collectMachineInfos(target)<br><br>log.Logf(<span class="hljs-number">0</span>, <span class="hljs-string">&quot;dialing manager at %v&quot;</span>, *flagManager)<br>manager, err := rpctype.NewRPCClient(*flagManager, timeouts.Scale)<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>	log.Fatalf(<span class="hljs-string">&quot;failed to create an RPC client: %v &quot;</span>, err)<br>&#125;<br><br>log.Logf(<span class="hljs-number">1</span>, <span class="hljs-string">&quot;connecting to manager...&quot;</span>)<br>a := &amp;rpctype.ConnectArgs&#123;<br>	Name:        *flagName,<br>	MachineInfo: machineInfo,<br>	Modules:     modules,<br>&#125;<br>r := &amp;rpctype.ConnectRes&#123;&#125;<br><span class="hljs-keyword">if</span> err := manager.Call(<span class="hljs-string">&quot;Manager.Connect&quot;</span>, a, r); err != <span class="hljs-literal">nil</span> &#123;<br>	log.Fatalf(<span class="hljs-string">&quot;failed to call Manager.Connect(): %v &quot;</span>, err)<br>&#125;<br></code></pre></td></tr></table></figure>

<p>syz-fuzzer ä¸­çš„ RPC éƒ½ä¼šè°ƒç”¨åˆ° <code>syz-manager/rpc.go</code> ä¸­çš„ <code>RPCServer</code> çš„æˆå‘˜å‡½æ•°ï¼Œæˆ‘ä»¬æœ€ç»ˆä¼šè°ƒç”¨åˆ° syz-manager ä¸Šçš„ <code>Connect()</code> å‡½æ•°è¿›è¡Œè¿æ¥ï¼Œå…¶æ ¸å¿ƒæ˜¯è°ƒç”¨ <code>RPCServer.RPCManagerView.fuzzerConnect()</code> æœ€å°åŒ–è¯­æ–™åº“å¹¶æ‹·è´ BugFrame ç­‰ä¿¡æ¯ï¼Œè¿™é‡Œå°±ä¸å±•å¼€åˆ†æäº†ï¼šï¼‰</p>
<p>æ¥ä¸‹æ¥è§£æè¦å¼€å¯çš„ç‰¹æ€§æ ‡å¿—ä½ï¼›éšåæ£€æŸ¥ä¸ syz-manager è¿›è¡Œ RPC è¿æ¥çš„å“åº”ç»“æœä¸­çš„ <code>CoverFilterBitmap</code> æ˜¯å¦ä¸ºç©ºï¼Œä¸ä¸ºç©ºåˆ™å†™å…¥åˆ° <code>&quot;syz-cover-bitmap&quot;</code> æ–‡ä»¶ä¸­ï¼Œè¯¥ä¿¡æ¯ä¸»è¦æ˜¯ç»™ syz-executor ç”¨çš„ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs go">featureFlags, err := csource.ParseFeaturesFlags(<span class="hljs-string">&quot;none&quot;</span>, <span class="hljs-string">&quot;none&quot;</span>, <span class="hljs-literal">true</span>)<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>	log.Fatal(err)<br>&#125;<br><span class="hljs-keyword">if</span> r.CoverFilterBitmap != <span class="hljs-literal">nil</span> &#123;<br>	<span class="hljs-keyword">if</span> err := osutil.WriteFile(<span class="hljs-string">&quot;syz-cover-bitmap&quot;</span>, r.CoverFilterBitmap); err != <span class="hljs-literal">nil</span> &#123;<br>		log.Fatalf(<span class="hljs-string">&quot;failed to write syz-cover-bitmap: %v&quot;</span>, err)<br>	&#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>ä¹‹åè‹¥ syz-manager è¿”å›ç»“æœä¸­çš„ <code>CheckResult</code> ä¸ºç©ºï¼Œåˆ™é‡æ–°ç”Ÿæˆé…ç½®ä¿¡æ¯åé€šè¿‡ RPC è°ƒç”¨ syz-manager çš„ <code>Manager.Check()</code> ï¼Œè‹¥æœ‰é”™è¯¯åˆ™ç›´æ¥é€€å‡ºï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">if</span> r.CheckResult == <span class="hljs-literal">nil</span> &#123;<br>	checkArgs.gitRevision = r.GitRevision<br>	checkArgs.targetRevision = r.TargetRevision<br>	checkArgs.enabledCalls = r.EnabledCalls<br>	checkArgs.allSandboxes = r.AllSandboxes<br>	checkArgs.featureFlags = featureFlags<br>	r.CheckResult, err = checkMachine(checkArgs)<br>	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>		<span class="hljs-keyword">if</span> r.CheckResult == <span class="hljs-literal">nil</span> &#123;<br>			r.CheckResult = <span class="hljs-built_in">new</span>(rpctype.CheckArgs)<br>		&#125;<br>		r.CheckResult.Error = err.Error()<br>	&#125;<br>	r.CheckResult.Name = *flagName<br>	<span class="hljs-keyword">if</span> err := manager.Call(<span class="hljs-string">&quot;Manager.Check&quot;</span>, r.CheckResult, <span class="hljs-literal">nil</span>); err != <span class="hljs-literal">nil</span> &#123;<br>		log.Fatalf(<span class="hljs-string">&quot;Manager.Check call failed: %v&quot;</span>, err)<br>	&#125;<br>	<span class="hljs-keyword">if</span> r.CheckResult.Error != <span class="hljs-string">&quot;&quot;</span> &#123;<br>		log.Fatalf(<span class="hljs-string">&quot;%v&quot;</span>, r.CheckResult.Error)<br>	&#125;<br>&#125; <br></code></pre></td></tr></table></figure>

<p>è¿™æ¬¡ RPC å®é™…ä¸Šä¼šè°ƒç”¨åˆ° syz-manager ä¸­çš„ <code>machineChecked()</code>ï¼Œè¯¥å‡½æ•°ä¼šè°ƒç”¨ <code>loadCorpus()</code> <strong>å®Œæˆè¯­æ–™åº“çš„åŠ è½½</strong>ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(mgr *Manager)</span></span> machineChecked(a *rpctype.CheckArgs, enabledSyscalls <span class="hljs-keyword">map</span>[*prog.Syscall]<span class="hljs-type">bool</span>) &#123;<br>	mgr.mu.Lock()<br>	<span class="hljs-keyword">defer</span> mgr.mu.Unlock()<br>	mgr.checkResult = a<br>	mgr.targetEnabledSyscalls = enabledSyscalls<br>	mgr.target.UpdateGlobs(a.GlobFiles)<br>	mgr.loadCorpus()<br>	mgr.firstConnect = time.Now()<br>&#125;<br></code></pre></td></tr></table></figure>

<p>å›åˆ° syz-fuzzerï¼Œè‹¥ <code>CheckResult</code> ä¸ä¸ºç©ºåˆ™è°ƒç”¨ <code>target.UpdateGlobs()</code> å°† manager è¿”å›æ•°æ®å­˜æ”¾åˆ° <code>GlobFiles</code> æ˜ å°„ä¸­ï¼Œå†è°ƒç”¨ <code>Setup()</code> æ ¹æ®æ‰€å¼€å¯çš„ç‰¹æ€§é…ç½® executor çš„å‚æ•°å¹¶è°ƒç”¨ <code>osutil.RunCmd()</code> åœ¨ 5min åå¯åŠ¨ executorï¼Œè¿™é‡Œå°±ä¸å±•å¼€äº†</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">else</span> &#123;<br>		target.UpdateGlobs(r.CheckResult.GlobFiles)<br>		<span class="hljs-keyword">if</span> err = host.Setup(target, r.CheckResult.Features, featureFlags, config.Executor); err != <span class="hljs-literal">nil</span> &#123;<br>			log.Fatal(err)<br>		&#125;<br>	&#125;<br></code></pre></td></tr></table></figure>

<h3 id="Step-III-åˆå§‹åŒ–-Fuzzer-ç»“æ„ä¿¡æ¯ï¼Œè·å–-input-ä¸-candidate"><a href="#Step-III-åˆå§‹åŒ–-Fuzzer-ç»“æ„ä¿¡æ¯ï¼Œè·å–-input-ä¸-candidate" class="headerlink" title="Step.III - åˆå§‹åŒ– Fuzzer ç»“æ„ä¿¡æ¯ï¼Œè·å– input ä¸ candidate"></a>Step.III - åˆå§‹åŒ– Fuzzer ç»“æ„ä¿¡æ¯ï¼Œè·å– input ä¸ candidate</h3><p>ä¹‹åæ—¥å¿—è¾“å‡ºå¼€å¯çš„ç³»ç»Ÿè°ƒç”¨æ•°é‡åŠç‰¹æ€§ä¿¡æ¯ï¼Œåˆ›å»º IPC é…ç½®ä¿¡æ¯ï¼Œè‹¥è®¾ç½®äº† <code>runtest</code> æ ‡å¿—ä½ï¼ˆé»˜è®¤ä¸º falseï¼‰åˆ™è°ƒç”¨ <code>runTest()</code> åç›´æ¥è¿”å›ï¼Œè¿™ä¸ªä¸»è¦æ˜¯æµ‹è¯•ç”¨çš„è¿™é‡Œå°±ä¸å±•å¼€äº†ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs go">log.Logf(<span class="hljs-number">0</span>, <span class="hljs-string">&quot;syscalls: %v&quot;</span>, <span class="hljs-built_in">len</span>(r.CheckResult.EnabledCalls[sandbox]))<br><span class="hljs-keyword">for</span> _, feat := <span class="hljs-keyword">range</span> r.CheckResult.Features.Supported() &#123;<br>	log.Logf(<span class="hljs-number">0</span>, <span class="hljs-string">&quot;%v: %v&quot;</span>, feat.Name, feat.Reason)<br>&#125;<br>createIPCConfig(r.CheckResult.Features, config)<br><br><span class="hljs-keyword">if</span> *flagRunTest &#123;<br>	runTest(target, manager, *flagName, config.Executor)<br>	<span class="hljs-keyword">return</span><br>&#125;<br><br></code></pre></td></tr></table></figure>

<p>ä¹‹ååˆ›å»º <code>needPoll</code> channel å¹¶å†™å…¥æ•°æ®ï¼Œä¸»è¦ç”¨æ¥æ ‡è¯†æ˜¯å¦éœ€è¦å‘ <code>syz-manager()</code> å‘èµ· pollï¼ˆå‘ syz-manager è·å–è¯­æ–™åº“ä¸ candidateï¼‰ï¼›æ¥ä¸‹æ¥åˆ›å»ºäº†ä¸€ä¸ªæ ‡è¯†å½“å‰ <code>syz-fuzzer</code> ä¿¡æ¯çš„ Fuzzer ç»“æ„ä½“ä»¥åŠä¸€ä¸ª <code>ipc.Gate</code> ç»“æ„ä½“ï¼ˆç”¨äºå°†å¹¶å‘çº§åˆ«å’Œçª—å£é™åˆ¶ä¸ºç»™å®šçš„å€¼ï¼‰ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs go"><br>needPoll := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> <span class="hljs-keyword">struct</span>&#123;&#125;, <span class="hljs-number">1</span>)<br>needPoll &lt;- <span class="hljs-keyword">struct</span>&#123;&#125;&#123;&#125;<br>fuzzer := &amp;Fuzzer&#123;<br>	name:                     *flagName,<br>	outputType:               outputType,<br>	config:                   config,<br>	execOpts:                 execOpts,<br>	workQueue:                newWorkQueue(*flagProcs, needPoll),<br>	needPoll:                 needPoll,<br>	manager:                  manager,<br>	target:                   target,<br>	timeouts:                 timeouts,<br>	faultInjectionEnabled:    r.CheckResult.Features[host.FeatureFault].Enabled,<br>	comparisonTracingEnabled: r.CheckResult.Features[host.FeatureComparisons].Enabled,<br>	corpusHashes:             <span class="hljs-built_in">make</span>(<span class="hljs-keyword">map</span>[hash.Sig]<span class="hljs-keyword">struct</span>&#123;&#125;),<br>	checkResult:              r.CheckResult,<br>	fetchRawCover:            *flagRawCover,<br>	noMutate:                 r.NoMutateCalls,<br>	stats:                    <span class="hljs-built_in">make</span>([]<span class="hljs-type">uint64</span>, StatCount),<br>&#125;<br>gateCallback := fuzzer.useBugFrames(r, *flagProcs)<br>fuzzer.gate = ipc.NewGate(<span class="hljs-number">2</span>**flagProcs, gateCallback)<br><br></code></pre></td></tr></table></figure>

<p>æ¥ä¸‹æ¥æ˜¯ä¸€ä¸ªå°å¾ªç¯ï¼Œè°ƒç”¨ <code>poll()</code> ä»¥<strong>å‘ syz-manager è·å–è¯­æ–™åº“ä¸ candidate åŠ å…¥åˆ°æœ¬åœ°å·¥ä½œé˜Ÿåˆ—ä¸­</strong>ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">for</span> needCandidates, more := <span class="hljs-literal">true</span>, <span class="hljs-literal">true</span>; more; needCandidates = <span class="hljs-literal">false</span> &#123;<br>	more = fuzzer.poll(needCandidates, <span class="hljs-literal">nil</span>)<br>	<span class="hljs-comment">// è¯¥å¾ªç¯åœ¨ qemu æ¨¡æ‹Ÿä¸­ä¸º &quot;no output&quot; , ä»¥å‘Šè¯‰ manager æˆ‘ä»¬è¿˜æ²¡æ­».</span><br>	log.Logf(<span class="hljs-number">0</span>, <span class="hljs-string">&quot;fetching corpus: %v, signal %v/%v (executing program)&quot;</span>,<br>		<span class="hljs-built_in">len</span>(fuzzer.corpus), <span class="hljs-built_in">len</span>(fuzzer.corpusSignal), <span class="hljs-built_in">len</span>(fuzzer.maxSignal))<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="poll-ï¼šé€šè¿‡-RPC-å‘-syz-manager-è·å–è¯­æ–™åº“ä¸-candidate-åŠ å…¥æœ¬åœ°å·¥ä½œé˜Ÿåˆ—ä¸­"><a href="#poll-ï¼šé€šè¿‡-RPC-å‘-syz-manager-è·å–è¯­æ–™åº“ä¸-candidate-åŠ å…¥æœ¬åœ°å·¥ä½œé˜Ÿåˆ—ä¸­" class="headerlink" title="poll()ï¼šé€šè¿‡ RPC å‘ syz-manager è·å–è¯­æ–™åº“ä¸ candidate åŠ å…¥æœ¬åœ°å·¥ä½œé˜Ÿåˆ—ä¸­"></a>poll()ï¼šé€šè¿‡ RPC å‘ syz-manager è·å–è¯­æ–™åº“ä¸ candidate åŠ å…¥æœ¬åœ°å·¥ä½œé˜Ÿåˆ—ä¸­</h4><p>è¯¥å‡½æ•°ä¸»è¦åšäº†ä¸¤ä»¶äº‹ï¼š</p>
<ul>
<li>é€šè¿‡ RPC å‘ syz-manager è·å–è¯­æ–™åº“ä¸ candidate</li>
<li>å°†è·å¾—çš„ candidate åŠ å…¥æœ¬åœ°å·¥ä½œé˜Ÿåˆ—ä¸­</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(fuzzer *Fuzzer)</span></span> poll(needCandidates <span class="hljs-type">bool</span>, stats <span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]<span class="hljs-type">uint64</span>) <span class="hljs-type">bool</span> &#123;<br>	a := &amp;rpctype.PollArgs&#123;<br>		Name:           fuzzer.name,<br>		NeedCandidates: needCandidates,<br>		MaxSignal:      fuzzer.grabNewSignal().Serialize(),<br>		Stats:          stats,<br>	&#125;<br>	r := &amp;rpctype.PollRes&#123;&#125;<br>    <span class="hljs-comment">/* RPC å‘ syz-manager è¯·æ±‚ä¿¡æ¯ */</span> <br>	<span class="hljs-keyword">if</span> err := fuzzer.manager.Call(<span class="hljs-string">&quot;Manager.Poll&quot;</span>, a, r); err != <span class="hljs-literal">nil</span> &#123;<br>		log.Fatalf(<span class="hljs-string">&quot;Manager.Poll call failed: %v&quot;</span>, err)<br>	&#125;<br>    <span class="hljs-comment">/* è§£æï¼šæœ€å¤§ä¿¡å·æ•°é‡ */</span><br>	maxSignal := r.MaxSignal.Deserialize()<br>	log.Logf(<span class="hljs-number">1</span>, <span class="hljs-string">&quot;poll: candidates=%v inputs=%v signal=%v&quot;</span>,<br>		<span class="hljs-built_in">len</span>(r.Candidates), <span class="hljs-built_in">len</span>(r.NewInputs), maxSignal.Len())<br>	fuzzer.addMaxSignal(maxSignal)<br>    <span class="hljs-comment">/* è§£æï¼šsyz-manager ç»™äºˆçš„ä»å…¶ä»– fuzzer è·å¾—çš„æ–°è¾“å…¥ */</span><br>	<span class="hljs-keyword">for</span> _, inp := <span class="hljs-keyword">range</span> r.NewInputs &#123;<br>		fuzzer.addInputFromAnotherFuzzer(inp)<br>	&#125;<br>    <span class="hljs-comment">/* è§£æï¼šcandidate */</span><br>	<span class="hljs-keyword">for</span> _, candidate := <span class="hljs-keyword">range</span> r.Candidates &#123;<br>		fuzzer.addCandidateInput(candidate)<br>	&#125;<br>	<span class="hljs-keyword">if</span> needCandidates &amp;&amp; <span class="hljs-built_in">len</span>(r.Candidates) == <span class="hljs-number">0</span> &amp;&amp; atomic.LoadUint32(&amp;fuzzer.triagedCandidates) == <span class="hljs-number">0</span> &#123;<br>		atomic.StoreUint32(&amp;fuzzer.triagedCandidates, <span class="hljs-number">1</span>)<br>	&#125;<br>	<span class="hljs-keyword">return</span> <span class="hljs-built_in">len</span>(r.NewInputs) != <span class="hljs-number">0</span> || <span class="hljs-built_in">len</span>(r.Candidates) != <span class="hljs-number">0</span> || maxSignal.Len() != <span class="hljs-number">0</span><br>&#125;<br></code></pre></td></tr></table></figure>

<p>è¯¥å‡½æ•°ä¼šé€šè¿‡ RPC è°ƒç”¨åˆ° syz-manager ä¸­ <code>syz-manager/rpc.go</code> ä¸‹çš„ <code>Poll()</code> å‡½æ•°ï¼š</p>
<ul>
<li>é¦–å…ˆä¼šè·å–åœ¨ syz-manager ä¸­è¯¥ syz-fuzzer çš„ä¿¡æ¯ï¼Œå¹¶æ£€æŸ¥æœ€å¤§ä¿¡å·é‡</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(serv *RPCServer)</span></span> Poll(a *rpctype.PollArgs, r *rpctype.PollRes) <span class="hljs-type">error</span> &#123;<br>	serv.stats.mergeNamed(a.Stats)<br><br>	serv.mu.Lock()<br>	<span class="hljs-keyword">defer</span> serv.mu.Unlock()<br><br>	f := serv.fuzzers[a.Name]<br>	<span class="hljs-keyword">if</span> f == <span class="hljs-literal">nil</span> &#123;<br>		<span class="hljs-comment">// è‹¥æˆ‘ä»¬è°ƒç”¨äº† shutdownInstance ã€ä½†å·²ç»æœ‰ä¸€ä¸ªæ¥è‡ªè¯¥å®ä¾‹çš„å¾…å¤„ç†è¯·æ±‚ï¼Œåˆ™è¿™æ˜¯æœ‰å¯èƒ½çš„</span><br>		log.Logf(<span class="hljs-number">1</span>, <span class="hljs-string">&quot;poll: fuzzer %v is not connected&quot;</span>, a.Name)<br>		<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span><br>	&#125;<br>	newMaxSignal := serv.maxSignal.Diff(a.MaxSignal.Deserialize())<br>	<span class="hljs-keyword">if</span> !newMaxSignal.Empty() &#123;<br>		serv.maxSignal.Merge(newMaxSignal)<br>		serv.stats.maxSignal.set(<span class="hljs-built_in">len</span>(serv.maxSignal))<br>		<span class="hljs-keyword">for</span> _, f1 := <span class="hljs-keyword">range</span> serv.fuzzers &#123;<br>			<span class="hljs-keyword">if</span> f1 == f || f1.rotated &#123;<br>				<span class="hljs-keyword">continue</span><br>			&#125;<br>			f1.newMaxSignal.Merge(newMaxSignal)<br>		&#125;<br>	&#125;<br></code></pre></td></tr></table></figure>

<ul>
<li>å¦‚æœè¯¥ syz-fuzzer å¯¹åº”çš„ VM å®ä¾‹æ­£åœ¨è½®è½¬è¿è¡Œï¼Œåˆ™ç›´æ¥è¿”å›</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">if</span> f.rotated &#123;<br>	<span class="hljs-comment">// è®©è½®è½¬ä¸­çš„ VMs ç‹¬ç«‹è¿è¡Œï¼Œä¸è¦å‘ä»–ä»¬å‘é€ä»»ä½•ä¸œè¥¿</span><br>	<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span><br>&#125;<br></code></pre></td></tr></table></figure>

<ul>
<li>æ¥ä¸‹æ¥å†™å…¥æ–°çš„æœ€å¤§ä¿¡å·ï¼Œä¹‹åæ£€æŸ¥ syz-fuzzer æ˜¯å¦å‘ syz-manager è¯·æ±‚äº†æ–°çš„ candidateï¼Œè‹¥æ˜¯åˆ™è°ƒç”¨ <code>candidateBatch()</code> è·å–ï¼Œè¯¥å‡½æ•°çš„ä½œç”¨ä¸»è¦æ˜¯ä» syz-manager ä¸Šçš„ candidate é˜Ÿåˆ—ä¸­è·å–ä¸€å®šæ•°é‡çš„ candidate</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs go">r.MaxSignal = f.newMaxSignal.Split(<span class="hljs-number">2000</span>).Serialize()<br><span class="hljs-keyword">if</span> a.NeedCandidates &#123;<br>	r.Candidates = serv.mgr.candidateBatch(serv.batchSize)<br>&#125;<br></code></pre></td></tr></table></figure>

<ul>
<li>è‹¥è·å–åˆ°çš„ candidate æ•°é‡ä¸º 0ï¼Œè¯´æ˜æ˜¯ç¬¬ä¸€æ¬¡ <code>poll()</code>ï¼Œè¿™æ—¶ä¾¿ä»åˆå§‹åŒ–æ—¶æ‰€è¯»å–çš„è¯­æ–™åº“ä¸­è·å–è¾“å…¥ä½œä¸º candidate è¿”è¿˜ç»™ syz-fuzzer</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs go">	<span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(r.Candidates) == <span class="hljs-number">0</span> &#123;<br>		batchSize := serv.batchSize<br>		<span class="hljs-comment">// å½“ fuzzer å¯åŠ¨æ—¶, å…¶ä¼šæŠ½å–æ‰€æœ‰çš„è¯­æ–™åº“.</span><br>		<span class="hljs-comment">// è‹¥æˆ‘ä»¬ä½¿ç”¨æœ€åçš„ batchSize è¿›è¡Œæ“ä½œ, è¿™å°†ä¼šéå¸¸æ…¢</span><br>		<span class="hljs-comment">// (å¯¹äº 50k çš„è¯­æ–™åº“ä¸æ…¢å†…æ ¸è€Œè¨€ï¼Œä¸€æ‰¹å¤§å°ä¸º 6 å¯èƒ½éœ€è¦10minä»¥ä¸Šçš„æ—¶é—´).</span><br>		<span class="hljs-comment">// æ‰€ä»¥åœ¨æœ€åˆå°±ä½¿ç”¨æ›´å¤§çš„æ‰¹é‡ (we use no stats as approximation of initial pump).</span><br>		<span class="hljs-keyword">const</span> initialBatch = <span class="hljs-number">50</span><br>		<span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(a.Stats) == <span class="hljs-number">0</span> &amp;&amp; batchSize &lt; initialBatch &#123;<br>			batchSize = initialBatch<br>		&#125;<br>		<span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; batchSize &amp;&amp; <span class="hljs-built_in">len</span>(f.inputs) &gt; <span class="hljs-number">0</span>; i++ &#123;<br>			last := <span class="hljs-built_in">len</span>(f.inputs) - <span class="hljs-number">1</span><br>			r.NewInputs = <span class="hljs-built_in">append</span>(r.NewInputs, f.inputs[last])<br>			f.inputs[last] = rpctype.Input&#123;&#125;<br>			f.inputs = f.inputs[:last]<br>		&#125;<br>		<span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(f.inputs) == <span class="hljs-number">0</span> &#123;<br>			f.inputs = <span class="hljs-literal">nil</span><br>		&#125;<br>	&#125;<br>	log.Logf(<span class="hljs-number">4</span>, <span class="hljs-string">&quot;poll from %v: candidates=%v inputs=%v maxsignal=%v&quot;</span>,<br>		a.Name, <span class="hljs-built_in">len</span>(r.Candidates), <span class="hljs-built_in">len</span>(r.NewInputs), <span class="hljs-built_in">len</span>(r.MaxSignal.Elems))<br>	<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span><br>&#125;<br></code></pre></td></tr></table></figure>



<h2 id="æ„å»ºã€ç³»ç»Ÿè°ƒç”¨ç”Ÿæˆä¼˜å…ˆçº§è¡¨ã€‘"><a href="#æ„å»ºã€ç³»ç»Ÿè°ƒç”¨ç”Ÿæˆä¼˜å…ˆçº§è¡¨ã€‘" class="headerlink" title="æ„å»ºã€ç³»ç»Ÿè°ƒç”¨ç”Ÿæˆä¼˜å…ˆçº§è¡¨ã€‘"></a>æ„å»ºã€ç³»ç»Ÿè°ƒç”¨ç”Ÿæˆä¼˜å…ˆçº§è¡¨ã€‘</h2><p>æ¥ä¸‹æ¥æ˜¯æ­£å¼è¿›è¡Œ fuzzing ä¹‹å‰æœ€æ ¸å¿ƒçš„ä¸€æ­¥â€”â€”æ„å»º<strong>ã€ç³»ç»Ÿè°ƒç”¨ç”Ÿæˆä¼˜å…ˆçº§è¡¨ã€‘</strong> <code>choiceTable</code> ï¼Œè¯¥è¡¨çš„ä½œç”¨æ˜¯ï¼š</p>
<ul>
<li><strong>è®¡ç®—å¯¹äºç»™å®šçš„ç³»ç»Ÿè°ƒç”¨ xï¼Œåœ¨æ·»åŠ å…¥ç³»ç»Ÿè°ƒç”¨ y åï¼Œä»£ç è¦†ç›–ç‡ä¼šä¸Šå‡çš„å¯èƒ½æ€§</strong></li>
</ul>
<p>ä»è€Œ<strong>åœ¨åç»­çš„ fuzzing è¿‡ç¨‹å½“ä¸­ä½¿ç”¨è¯¥è¡¨å¯¹è¾“å…¥è¿›è¡Œå˜å¼‚</strong></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs go">calls := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">map</span>[*prog.Syscall]<span class="hljs-type">bool</span>)<br><span class="hljs-keyword">for</span> _, id := <span class="hljs-keyword">range</span> r.CheckResult.EnabledCalls[sandbox] &#123;<br>	calls[target.Syscalls[id]] = <span class="hljs-literal">true</span><br>&#125;<br>fuzzer.choiceTable = target.BuildChoiceTable(fuzzer.corpus, calls)<br></code></pre></td></tr></table></figure>

<p><code>choiceTable</code> çš„è®¡ç®—é€šè¿‡ å®šä¹‰äº<code>prog/prio.go</code> ä¸­çš„ <code>BuildChoiceTable()</code> å®Œæˆï¼š</p>
<ul>
<li>é¦–å…ˆå»ºç«‹ä¸¤ä¸ªè¡¨ï¼š<ul>
<li>â‘  <code>Syscallâ†’bool</code> çš„è¡¨ <code>enable</code>ï¼Œè¡¨ç¤º<strong>å¯ç”¨çš„ç³»ç»Ÿè°ƒç”¨</strong>ï¼Œå¹¶å°†æ‰€æœ‰ç³»ç»Ÿè°ƒç”¨éƒ½åˆå§‹åŒ–ä¸º <code>true</code> </li>
<li>â‘¡ <code>intâ†’bool</code> çš„è¡¨ <code>noGenerateCalls</code> ï¼Œè¡¨ç¤º<strong>ä¸ç”¨äºç”Ÿæˆçš„ç³»ç»Ÿè°ƒç”¨</strong></li>
</ul>
</li>
<li>æ¥ä¸‹æ¥éå†ç³»ç»Ÿè°ƒç”¨å±æ€§ï¼ˆåœ¨ syzlang è§„åˆ™æ–‡ä»¶ä¸­ç¼–å†™ï¼‰ï¼Œè‹¥æŸä¸ªç³»ç»Ÿè°ƒç”¨ä¸å¼€å¯åˆ™å°†å…¶ä» <code>enable</code> è¡¨ä¸­å»é™¤ï¼Œè‹¥æŸä¸ªç³»ç»Ÿè°ƒç”¨ä¸ç”¨äºç”Ÿæˆåˆ™å°†å…¶ä» <code>enable</code> è¡¨ä¸­å»é™¤å¹¶æ·»åŠ åˆ° <code>noGenerateCalls</code> è¡¨</li>
<li>ä¹‹ååˆ›å»ºç¬¬ä¸‰ä¸ªè¡¨ <code>generateCalls</code>ï¼Œä¸º <code>enable</code> è¡¨çš„æ‹·è´ï¼Œè¡¨ç¤º<strong>ç”¨äºç”Ÿæˆçš„ç³»ç»Ÿè°ƒç”¨</strong>ï¼Œå¹¶æ ¹æ®ç³»ç»Ÿè°ƒç”¨å·è¿›è¡Œä»å°åˆ°å¤§çš„æ’åº</li>
</ul>
<blockquote>
<p>è¿™é‡Œçš„ã€ç”Ÿæˆã€‘æŒ‡çš„æ˜¯ç”Ÿæˆæ–°çš„è¾“å…¥ï¼Œå³æˆ‘ä»¬æ˜¯å¦åœ¨è¾“å…¥ç”Ÿæˆæ—¶æ·»åŠ è¯¥ç³»ç»Ÿè°ƒç”¨</p>
</blockquote>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(target *Target)</span></span> BuildChoiceTable(corpus []*Prog, enabled <span class="hljs-keyword">map</span>[*Syscall]<span class="hljs-type">bool</span>) *ChoiceTable &#123;<br>	<span class="hljs-keyword">if</span> enabled == <span class="hljs-literal">nil</span> &#123;<br>		enabled = <span class="hljs-built_in">make</span>(<span class="hljs-keyword">map</span>[*Syscall]<span class="hljs-type">bool</span>)<br>		<span class="hljs-keyword">for</span> _, c := <span class="hljs-keyword">range</span> target.Syscalls &#123;<br>			enabled[c] = <span class="hljs-literal">true</span><br>		&#125;<br>	&#125;<br>	noGenerateCalls := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">map</span>[<span class="hljs-type">int</span>]<span class="hljs-type">bool</span>)<br>	<span class="hljs-keyword">for</span> call := <span class="hljs-keyword">range</span> enabled &#123;<br>		<span class="hljs-keyword">if</span> call.Attrs.Disabled &#123;<br>			<span class="hljs-built_in">delete</span>(enabled, call)<br>		&#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> call.Attrs.NoGenerate &#123;<br>			noGenerateCalls[call.ID] = <span class="hljs-literal">true</span><br>			<span class="hljs-built_in">delete</span>(enabled, call)<br>		&#125;<br>	&#125;<br>    <span class="hljs-keyword">var</span> generatableCalls []*Syscall<br>	<span class="hljs-keyword">for</span> c := <span class="hljs-keyword">range</span> enabled &#123;<br>		generatableCalls = <span class="hljs-built_in">append</span>(generatableCalls, c)<br>	&#125;<br>	<span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(generatableCalls) == <span class="hljs-number">0</span> &#123;<br>		<span class="hljs-built_in">panic</span>(<span class="hljs-string">&quot;no syscalls enabled and generatable&quot;</span>)<br>	&#125;<br>	sort.Slice(generatableCalls, <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(i, j <span class="hljs-type">int</span>)</span></span> <span class="hljs-type">bool</span> &#123;<br>		<span class="hljs-keyword">return</span> generatableCalls[i].ID &lt; generatableCalls[j].ID<br>	&#125;)<br></code></pre></td></tr></table></figure>

<ul>
<li>æ¥ä¸‹æ¥åˆ¤æ–­è¯­æ–™åº“ä¸­æ˜¯å¦åŒ…å«æœ‰ç¦ç”¨çš„ç³»ç»Ÿè°ƒç”¨ï¼Œè‹¥æ˜¯åˆ™ç›´æ¥é€€å‡º</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">for</span> _, p := <span class="hljs-keyword">range</span> corpus &#123;<br>	<span class="hljs-keyword">for</span> _, call := <span class="hljs-keyword">range</span> p.Calls &#123;<br>		<span class="hljs-keyword">if</span> !enabled[call.Meta] &amp;&amp; !noGenerateCalls[call.Meta.ID] &#123;<br>			fmt.Printf(<span class="hljs-string">&quot;corpus contains disabled syscall %v\n&quot;</span>, call.Meta.Name)<br>			<span class="hljs-built_in">panic</span>(<span class="hljs-string">&quot;disabled syscall&quot;</span>)<br>		&#125;<br>	&#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<ul>
<li>æœ€åè°ƒç”¨ <code>target.CalculatePriorities(corpus)</code> <strong>åŸºäºè¯­æ–™åº“è¿›è¡Œç³»ç»Ÿè°ƒç”¨ç”Ÿæˆä¼˜å…ˆçº§è¡¨çš„è®¡ç®—</strong></li>
<li>å®Œæˆåç”Ÿæˆä¸€ä¸ªæ–°çš„è¡¨ <code>run</code> ä½œä¸ºç»“æœä¸ç”Ÿæˆ&amp;ä¸ç”Ÿæˆç³»ç»Ÿè°ƒç”¨è¡¨ä¸€èµ·è¿”å›ï¼Œå…¶ä¸­å­˜å‚¨çš„æ˜¯å¯¹äºå¯ç”¨çš„ç³»ç»Ÿè°ƒç”¨è€Œè¨€çš„<strong>åŠ æƒæƒé‡çš„ç´¯åŠ å’Œ</strong></li>
</ul>
<blockquote>
<p>ä¾‹å¦‚æœ‰ç»™å®šçš„ä¸‰ä¸ªç³»ç»Ÿè°ƒç”¨ Aã€Bã€Cï¼Œæœ‰è¿™æ ·çš„ä¸€ä¸ªç”Ÿæˆä¼˜å…ˆçº§è¡¨ <code>prios</code>ï¼š</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs apache">  <span class="hljs-attribute">A</span> B C<br><span class="hljs-attribute">A</span> <span class="hljs-number">1</span> <span class="hljs-number">2</span> <span class="hljs-number">1</span><br><span class="hljs-attribute">B</span> <span class="hljs-number">2</span> <span class="hljs-number">1</span> <span class="hljs-number">2</span><br><span class="hljs-attribute">C</span> <span class="hljs-number">3</span> <span class="hljs-number">1</span> <span class="hljs-number">2</span><br></code></pre></td></tr></table></figure>

<p>é‚£ä¹ˆåœ¨ <code>run</code> è¡¨ä¸­åˆ™ä¼šå°†ä¸€åˆ—çš„ç»“æœé€ä¸ªåŠ èµ·æ¥ï¼Œä»è€Œæœ‰è¿™æ ·çš„ä¸€ä¸ªç»“æœï¼š</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs apache">  <span class="hljs-attribute">A</span> B C<br><span class="hljs-attribute">A</span> <span class="hljs-number">1</span> <span class="hljs-number">3</span> <span class="hljs-number">4</span><br><span class="hljs-attribute">B</span> <span class="hljs-number">2</span> <span class="hljs-number">3</span> <span class="hljs-number">5</span><br><span class="hljs-attribute">C</span> <span class="hljs-number">3</span> <span class="hljs-number">4</span> <span class="hljs-number">6</span><br></code></pre></td></tr></table></figure>

<p>ä¸ºä»€ä¹ˆè¦è¿™ä¹ˆåšç¬”è€…ä¹Ÿä¸çŸ¥é“ï¼š(</p>
</blockquote>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs go">	prios := target.CalculatePriorities(corpus)<br>	run := <span class="hljs-built_in">make</span>([][]<span class="hljs-type">int32</span>, <span class="hljs-built_in">len</span>(target.Syscalls))<br>	<span class="hljs-comment">// ChoiceTable.runs[][] åŒ…å«å¯¹åŠ æƒä¼˜å…ˆçº§æ•°å­—çš„ç´¯åŠ æ€»å’Œ.</span><br>	<span class="hljs-comment">// è¿™åœ¨ç”Ÿæˆç¨‹åºæ—¶æœ‰åŠ©äºå¸¦æƒå¿«é€ŸäºŒå‰æœç´¢.</span><br>	<span class="hljs-comment">// è¿™ä»…ç”¨äºåœ¨ç›®æ ‡ä¸Šæ‰€å¯ç”¨çš„ç³»ç»Ÿè°ƒç”¨.</span><br>	<span class="hljs-keyword">for</span> i := <span class="hljs-keyword">range</span> run &#123;<br>		<span class="hljs-keyword">if</span> !enabled[target.Syscalls[i]] &#123;<br>			<span class="hljs-keyword">continue</span><br>		&#125;<br>		run[i] = <span class="hljs-built_in">make</span>([]<span class="hljs-type">int32</span>, <span class="hljs-built_in">len</span>(target.Syscalls))<br>		<span class="hljs-keyword">var</span> sum <span class="hljs-type">int32</span><br>		<span class="hljs-keyword">for</span> j := <span class="hljs-keyword">range</span> run[i] &#123;<br>			<span class="hljs-keyword">if</span> enabled[target.Syscalls[j]] &#123;<br>				sum += prios[i][j]<br>			&#125;<br>			run[i][j] = sum<br>		&#125;<br>	&#125;<br>	<span class="hljs-keyword">return</span> &amp;ChoiceTable&#123;target, run, generatableCalls, noGenerateCalls&#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="ã€æ ¸å¿ƒã€‘target-CalculatePriorities-corpus-ï¼šè®¡ç®—-call-to-call-çš„æƒé‡è¡¨"><a href="#ã€æ ¸å¿ƒã€‘target-CalculatePriorities-corpus-ï¼šè®¡ç®—-call-to-call-çš„æƒé‡è¡¨" class="headerlink" title="ã€æ ¸å¿ƒã€‘target.CalculatePriorities(corpus)ï¼šè®¡ç®— call-to-call çš„æƒé‡è¡¨"></a>ã€æ ¸å¿ƒã€‘target.CalculatePriorities(corpus)ï¼šè®¡ç®— call-to-call çš„æƒé‡è¡¨</h3><p>å®šä¹‰äº <code>prog/prio.go</code> ä¸­çš„ <code>CalculatePriorities(corpus)</code> ä¸ºç³»ç»Ÿè°ƒç”¨ç”Ÿæˆä¼˜å…ˆçº§è¡¨çš„æ ¸å¿ƒè®¡ç®—è¿‡ç¨‹ï¼Œä»£ç å…¶å®æ¯”è¾ƒç®€å•ï¼ˆä¸è¿‡æ³¨é‡Šå¾ˆé•¿ï¼‰ï¼Œä¸»è¦åˆ†ä¸º<strong>é™æ€ä¼˜å…ˆçº§</strong>ä¸<strong>åŠ¨æ€ä¼˜å…ˆçº§</strong>ä¸¤éƒ¨åˆ†è¿›è¡Œè®¡ç®—ï¼Œé»˜è®¤è¿›è¡Œé™æ€ä¼˜å…ˆçº§çš„è®¡ç®—ï¼Œè‹¥è¯­æ–™åº“ä¸ä¸ºç©ºåˆ™å†è®¡ç®—åŠ¨æ€ä¼˜å…ˆçº§ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// è®¡ç®— call-to-call çš„ä¼˜å…ˆçº§.</span><br><span class="hljs-comment">// å¯¹äºä¸€å¯¹ç»™å®šçš„è°ƒç”¨ X ä¸ Y, ä¼˜å…ˆçº§ä¾¿æ˜¯æˆ‘ä»¬å¯¹äº</span><br><span class="hljs-comment">// å°†ä¸€ä¸ªé¢å¤–çš„è°ƒç”¨ Y æ·»åŠ åˆ°ä¸€ä¸ªåŒ…å«æœ‰è°ƒç”¨ X çš„ç¨‹åºå½“ä¸­</span><br><span class="hljs-comment">// æ˜¯å¦æœ‰å¯èƒ½ç»™å‡ºæ–°çš„è¦†ç›–ç‡çš„çŒœæµ‹.</span><br><span class="hljs-comment">// å½“å‰çš„ç®—æ³•æœ‰ä¸¤ä¸ªéƒ¨åˆ†ï¼šé™æ€ä¸åŠ¨æ€.</span><br><span class="hljs-comment">// é™æ€éƒ¨åˆ†åŸºäºå¯¹å‚æ•°ç±»å‹çš„åˆ†æ. ä¸¾ä¸ªğŸŒ°,</span><br><span class="hljs-comment">// è‹¥è°ƒç”¨ X ä¸ Y éƒ½æ¥å— fd[sock], åˆ™ä»–ä»¬æ›´æœ‰å¯èƒ½ä¸€èµ·ç»™å‡ºæ–°çš„è¦†ç›–ç‡.</span><br><span class="hljs-comment">// åŠ¨æ€éƒ¨åˆ†åˆ™åŸºäºè¯­æ–™åº“ä¸­ä¸€å¯¹ç‰¹å®šçš„ç³»ç»Ÿè°ƒç”¨åœ¨ä¸€ä¸ªç¨‹åºä¸­å‡ºç°çš„é¢‘ç‡.</span><br><span class="hljs-comment">// ä¾‹å¦‚ï¼Œè‹¥ socket ä¸ connect é¢‘ç¹åœ°åœ¨ä¸€ä¸ªç¨‹åºä¸­ä¸€èµ·å‡ºç°ï¼Œ</span><br><span class="hljs-comment">// æˆ‘ä»¬ç»™è¿™å¯¹ç³»ç»Ÿè°ƒç”¨æ›´é«˜çš„ä¼˜å…ˆçº§.</span><br><span class="hljs-comment">// æ³¨æ„: å½“å‰çš„å®ç°éå¸¸ç®€é™‹, ä»»ä½•å¸¸é‡èƒŒåéƒ½æ²¡æœ‰ç†è®ºæ”¯æŒ.</span><br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(target *Target)</span></span> CalculatePriorities(corpus []*Prog) [][]<span class="hljs-type">int32</span> &#123;<br>	static := target.calcStaticPriorities()<br>	<span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(corpus) != <span class="hljs-number">0</span> &#123;<br>		dynamic := target.calcDynamicPrio(corpus)<br>		<span class="hljs-keyword">for</span> i, prios := <span class="hljs-keyword">range</span> dynamic &#123;<br>			dst := static[i]<br>			<span class="hljs-keyword">for</span> j, p := <span class="hljs-keyword">range</span> prios &#123;<br>				dst[j] = dst[j] * p / prioHigh<br>			&#125;<br>		&#125;<br>	&#125;<br>	<span class="hljs-keyword">return</span> static<br>&#125;<br></code></pre></td></tr></table></figure>

<p>å¯¹äºç»™å®šçš„ç³»ç»Ÿè°ƒç”¨ Xï¼Œæ·»åŠ ç³»ç»Ÿè°ƒç”¨ Y çš„ä¼˜å…ˆçº§ä¸ºï¼š<br>$$<br>æœ€ç»ˆä¼˜å…ˆçº§ &#x3D; é™æ€ä¼˜å…ˆçº§ * åŠ¨æ€ä¼˜å…ˆçº§ &#x2F; prioHigh<br>$$<br> å…¶ä¸­ <code>prioHigh</code> ä¸ºä¸€ä¸ªå¸¸é‡ <code>1000</code></p>
<h4 id="â‘ -calcStaticPriorities-ï¼šé™æ€ä¼˜å…ˆçº§è®¡ç®—"><a href="#â‘ -calcStaticPriorities-ï¼šé™æ€ä¼˜å…ˆçº§è®¡ç®—" class="headerlink" title="â‘  calcStaticPriorities()ï¼šé™æ€ä¼˜å…ˆçº§è®¡ç®—"></a>â‘  calcStaticPriorities()ï¼šé™æ€ä¼˜å…ˆçº§è®¡ç®—</h4><h5 id="Step-I-è®¡ç®—èµ„æºä½¿ç”¨æƒ…å†µ"><a href="#Step-I-è®¡ç®—èµ„æºä½¿ç”¨æƒ…å†µ" class="headerlink" title="Step.I - è®¡ç®—èµ„æºä½¿ç”¨æƒ…å†µ"></a>Step.I - è®¡ç®—èµ„æºä½¿ç”¨æƒ…å†µ</h5><blockquote>
<p>æ³¨ï¼šè¿™é‡Œçš„ã€èµ„æºã€‘æ›´ä¸¥è°¨åœ°è¯´åº”è¯¥æ˜¯ syzlang ä¸­çš„ <a target="_blank" rel="noopener" href="https://arttnba3.cn/2021/11/24/FUZZ-0X01-SYZKALLER-I/#VI-%E8%B5%84%E6%BA%90%EF%BC%88resources%EF%BC%89">resource</a></p>
</blockquote>
<p><code>calcStaticPriorities()</code> ç”¨ä»¥å®Œæˆé™æ€ä¼˜å…ˆçº§çš„è®¡ç®—ï¼Œè¯¥å‡½æ•°é¦–å…ˆä¼šè°ƒç”¨ <code>calcResourceUsage()</code> è·å–å½“å‰çš„ã€èµ„æºä½¿ç”¨æƒ…å†µã€‘ï¼š</p>
<ul>
<li>è¯¥å‡½æ•°çš„è¿”å›ç»“æœä¸ºä¸€ä¸ªäºŒé‡æ˜ å°„ <code>èµ„æºåï¼ˆstringï¼‰â†’ã€ç³»ç»Ÿè°ƒç”¨å·ï¼ˆintï¼‰â†’æƒé‡ï¼ˆweightsï¼‰ã€‘</code> </li>
<li>è¯¥å‡½æ•°çš„æ ¸å¿ƒé€»è¾‘ä¾¿æ˜¯è°ƒç”¨ <code>ForeachType()</code> è¿›è¡Œåˆ†æ</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(target *Target)</span></span> calcStaticPriorities() [][]<span class="hljs-type">int32</span> &#123;<br>	uses := target.calcResourceUsage()<br>	<span class="hljs-comment">//...</span><br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(target *Target)</span></span> calcResourceUsage() <span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]<span class="hljs-keyword">map</span>[<span class="hljs-type">int</span>]weights &#123;<br>	uses := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]<span class="hljs-keyword">map</span>[<span class="hljs-type">int</span>]weights)<br>	ForeachType(target.Syscalls, <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(t Type, ctx *TypeCtx)</span></span> &#123;<br>	<span class="hljs-comment">//...</span><br>	<span class="hljs-keyword">return</span> uses<br>&#125;<br></code></pre></td></tr></table></figure>

<p>æˆ‘ä»¬ç¨åå†æ¥åˆ†æä¼ å…¥çš„é—­åŒ…å‡½æ•°ï¼Œæˆ‘ä»¬é¦–å…ˆåˆ†æ <code>ForeachType()</code> ï¼Œå…¶ä¼šéå†ç³»ç»Ÿè°ƒç”¨è¡¨å¹¶è°ƒç”¨ <code>foreachTypeImpl()</code>ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">ForeachTypePost</span><span class="hljs-params">(syscalls []*Syscall, f <span class="hljs-keyword">func</span>(t Type, ctx *TypeCtx)</span></span>) &#123;<br>	<span class="hljs-keyword">for</span> _, meta := <span class="hljs-keyword">range</span> syscalls &#123;<br>		foreachTypeImpl(meta, <span class="hljs-literal">false</span>, f)<br>	&#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p> <code>foreachTypeImpl()</code>  ç”¨ä»¥å¤„ç†å•ä¸ªç³»ç»Ÿè°ƒç”¨ï¼Œå…¶é¦–å…ˆä¼šåˆ›å»ºä¸€ä¸ª <code>ç±»å‹â†’bool</code> çš„æ˜ å°„ <code>seen</code>ï¼Œæ¥ä¸‹æ¥ä¼šåˆ›å»ºä¸€ä¸ªé—­åŒ…å‡½æ•° <code>rec</code> ï¼Œè¯¥å‡½æ•°ä¼šæ ¹æ®ä¼ å…¥ç±»å‹çš„ä¸åŒè¿›è¡Œä¸åŒæ“ä½œï¼š</p>
<blockquote>
<p>æ³¨ï¼šè¿™é‡Œçš„ç±»å‹åº”å½“ä¸º syzlang ä¸­çš„ç±»å‹</p>
</blockquote>
<ul>
<li>è‹¥æ˜¯æŒ‡é’ˆç±»å‹ ï¼ˆ<code>PtrType</code> ï¼‰ï¼Œåˆ™é€’å½’è°ƒç”¨  <code>rec</code> </li>
<li>è‹¥æ˜¯æ•°ç»„ç±»å‹ï¼ˆ<code>ArrayType</code> ï¼‰ï¼Œåˆ™é€’å½’è°ƒç”¨ <code>rec</code></li>
<li>è‹¥æ˜¯ç»“æ„ä½“ç±»å‹ï¼ˆ<code>StructType</code>ï¼‰ä¸”ä¸åœ¨ <code>seen</code> ä¸­ï¼Œå°†å…¶æ·»åŠ åˆ° <code>seen</code> ä¸­ï¼Œå¹¶ä¸ºæ¯ä¸€ä¸ªç»“æ„ä½“æˆå‘˜è°ƒç”¨ <code>rec</code> </li>
<li>è‹¥æ˜¯è”åˆç±»å‹ï¼ˆ<code>UnionType</code>ï¼‰ä¸”ä¸åœ¨ <code>seen</code> ä¸­ï¼Œå°†å…¶æ·»åŠ åˆ° <code>seen</code> ä¸­ï¼Œå¹¶ä¸ºæ¯ä¸€ä¸ªè”åˆæˆå‘˜è°ƒç”¨ <code>rec</code> </li>
<li>å…¶ä»–åˆæ³•ç±»å‹åˆ™ç›´æ¥è·³è¿‡ï¼Œéæ³•ç±»å‹ï¼ˆsyzlang ç¼–è¯‘æœŸé”™è¯¯ï¼‰åˆ™ panic</li>
<li>æœ€åè°ƒç”¨ä¸Šå±‚ä¼ å…¥çš„é—­åŒ…å‡½æ•°ï¼ˆæˆ‘ä»¬åœ¨ <code>ForeachTypePost()</code> ä¸­ä¼ å…¥ <code>preorder = false</code>ï¼‰</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">foreachTypeImpl</span><span class="hljs-params">(meta *Syscall, preorder <span class="hljs-type">bool</span>, f <span class="hljs-keyword">func</span>(t Type, ctx *TypeCtx)</span></span>) &#123;<br>	<span class="hljs-comment">// æ³¨æ„: æˆ‘ä»¬ç‰¹æ„ä¸åœ¨ ForeachType ä¸­åˆ›å»º seen..</span><br>	<span class="hljs-comment">// å…¶èƒ½æ›´å¥½åœ°å¯¹é€’å½’è¿›è¡Œå‰ªæ (åœ¨ç³»ç»Ÿè°ƒç”¨é—´), ä½†å¤§é‡çš„ä½¿ç”¨è€…éœ€è¦</span><br>	<span class="hljs-comment">// å¯¹å•ä¸ªç³»ç»Ÿè°ƒç”¨è®¿é—®æ¯ä¸ªç»“æ„ä½“ (ä¾‹å¦‚ prio, used resources).</span><br>	seen := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">map</span>[Type]<span class="hljs-type">bool</span>)<br>	<span class="hljs-keyword">var</span> rec <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(*Type, Dir)</span></span><br>	rec = <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(ptr *Type, dir Dir)</span></span> &#123;<br>		ctx := &amp;TypeCtx&#123;Meta: meta, Dir: dir, Ptr: ptr&#125;<br>		<span class="hljs-keyword">if</span> preorder &#123;<br>			f(*ptr, ctx)<br>			<span class="hljs-keyword">if</span> ctx.Stop &#123;<br>				<span class="hljs-keyword">return</span><br>			&#125;<br>		&#125;<br>		<span class="hljs-keyword">switch</span> a := (*ptr).(<span class="hljs-keyword">type</span>) &#123;<br>		<span class="hljs-keyword">case</span> *PtrType:<br>			rec(&amp;a.Elem, a.ElemDir)<br>		<span class="hljs-keyword">case</span> *ArrayType:<br>			rec(&amp;a.Elem, dir)<br>		<span class="hljs-keyword">case</span> *StructType:<br>			<span class="hljs-keyword">if</span> seen[a] &#123;<br>				<span class="hljs-keyword">break</span> <span class="hljs-comment">// é€šè¿‡å¯¹structs/unionsçš„æŒ‡é’ˆæ¥å‰ªææ‰é€’å½’</span><br>			&#125;<br>			seen[a] = <span class="hljs-literal">true</span><br>			<span class="hljs-keyword">for</span> i, f := <span class="hljs-keyword">range</span> a.Fields &#123;<br>				rec(&amp;a.Fields[i].Type, f.Dir(dir))<br>			&#125;<br>		<span class="hljs-keyword">case</span> *UnionType:<br>			<span class="hljs-keyword">if</span> seen[a] &#123;<br>				<span class="hljs-keyword">break</span> <span class="hljs-comment">// é€šè¿‡å¯¹structs/unionsçš„æŒ‡é’ˆæ¥å‰ªææ‰é€’å½’</span><br>			&#125;<br>			seen[a] = <span class="hljs-literal">true</span><br>			<span class="hljs-keyword">for</span> i, f := <span class="hljs-keyword">range</span> a.Fields &#123;<br>				rec(&amp;a.Fields[i].Type, f.Dir(dir))<br>			&#125;<br>		<span class="hljs-keyword">case</span> *ResourceType, *BufferType, *VmaType, *LenType, *FlagsType,<br>			*ConstType, *IntType, *ProcType, *CsumType:<br>		<span class="hljs-keyword">case</span> Ref:<br>			<span class="hljs-comment">// ä»… pkg/compiler éœ€è¦.</span><br>		<span class="hljs-keyword">default</span>:<br>			<span class="hljs-built_in">panic</span>(<span class="hljs-string">&quot;unknown type&quot;</span>)<br>		&#125;<br>		<span class="hljs-keyword">if</span> !preorder &#123;<br>			f(*ptr, ctx)<br>			<span class="hljs-keyword">if</span> ctx.Stop &#123;<br>				<span class="hljs-built_in">panic</span>(<span class="hljs-string">&quot;Stop is set in post-order iteration&quot;</span>)<br>			&#125;<br>		&#125;<br>	&#125;<br></code></pre></td></tr></table></figure>

<p>è€Œ <code>foreachTypeImpl()</code> å®é™…ä¸Šä¾¿æ˜¯ä¸ºä¼ å…¥çš„ç³»ç»Ÿè°ƒç”¨çš„æ¯ä¸ªå‚æ•°éƒ½è°ƒç”¨ <code>rec()</code>ï¼Œè‹¥å­˜åœ¨è¿”å›å€¼ä¹Ÿä¸ºå…¶è°ƒç”¨ <code>rec</code>ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs go">	<span class="hljs-keyword">for</span> i := <span class="hljs-keyword">range</span> meta.Args &#123;<br>		rec(&amp;meta.Args[i].Type, DirIn)<br>	&#125;<br>	<span class="hljs-keyword">if</span> meta.Ret != <span class="hljs-literal">nil</span> &#123;<br>		rec(&amp;meta.Ret, DirOut)<br>	&#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>ç°åœ¨æˆ‘ä»¬å›åˆ° <code>calcResourceUsage()</code> çœ‹å…¶ä¼ ç»™ <code>ForeachType()</code> çš„é—­åŒ…å‡½æ•°ï¼Œä¹Ÿæ˜¯æ ¹æ®ç³»ç»Ÿè°ƒç”¨çš„å‚æ•°çš„ç±»å‹ä¸åŒè¿›è¡Œå¤„ç†ï¼š</p>
<blockquote>
<p>è¿™é‡Œçš„ <code>a</code> ä¸º Type æ¥å£ï¼Œ a.Desc ä¸º ResourceDescç±»å‹ï¼Œå³å¯¹ä¸€ä¸ªèµ„æºçš„æè¿°ï¼Œå…¶ Kind åŸŸä¸ºä¸€ä¸ª string æ•°ç»„ï¼ŒValues åŸŸä¸ºä¸€ä¸ª uint64 æ•°ç»„</p>
</blockquote>
<ul>
<li><p>è‹¥æ˜¯èµ„æºç±»å‹ ï¼ˆ<code>ResourceType</code> ï¼‰ï¼š</p>
<ul>
<li>è‹¥åœ¨ <code>AuxResources</code> è¡¨ï¼ˆè¾…åŠ©èµ„æºè¡¨ï¼Œå³æ‰®æ¼”ç€è¾…åŠ©è§’è‰²ä½†æ˜¯åœ¨æ‰€æœ‰ç³»ç»Ÿè°ƒç”¨ä¸­éƒ½ä¼šç”¨åˆ°çš„èµ„æºï¼ˆä¾‹å¦‚uid&#x2F;gidï¼‰ï¼‰é‡Œå·²æœ‰è®°å½•ï¼Œåˆ™è°ƒç”¨ <code>noteUsage()</code> æ›´æ–°æƒé‡å€¼ï¼Œè¿™é‡Œç»™çš„æƒé‡å€¼ä¸º 1</li>
<li>å¦åˆ™ï¼Œéå† <code>a.Desc.Kind</code> ï¼Œè°ƒç”¨ <code>noteUsage()</code> æ›´æ–°æƒé‡å€¼ï¼Œè¿™é‡Œç»™é™¤äº†æœ€åä¸€ä¸ª Kind ä»¥å¤–çš„æƒé‡å€¼ä¸º 2ï¼Œæœ€åä¸€ä¸ªä¸º 10</li>
</ul>
</li>
<li><p>è‹¥æ˜¯æŒ‡é’ˆç±»å‹ï¼ˆ<code>PttrType</code>ï¼‰ï¼Œåˆ™åˆ¤æ–­æŒ‡é’ˆæ‰€æŒ‡å¯¹è±¡ç±»å‹ï¼ˆç»“æ„ä½“&#x2F;è”åˆä½“&#x2F;æ•°ç»„ï¼‰å¹¶è°ƒç”¨ <code>noteUsage()</code> æ›´æ–°æƒé‡å€¼ï¼Œè¿™é‡Œç»™çš„æƒé‡å€¼éƒ½ä¸º 10</p>
</li>
<li><p>è‹¥æ˜¯ buffer ç±»å‹ï¼ˆ<code>BufferType</code>ï¼‰ï¼Œåˆ™æ ¹æ® <code>a.Kind</code> è¿›è¡Œä¸åŒå¤„ç†ï¼š</p>
<ul>
<li><code>BufferBlobRand, BufferBlobRange, BufferText, BufferCompressed</code> ï¼šæ— å¤„ç†</li>
<li><code>BufferString, BufferGlob</code> ï¼šè‹¥ <code>a.SubKind != &quot;&quot;</code>ï¼Œåˆ™è°ƒç”¨ <code>noteUsage()</code> æ›´æ–°æƒé‡å€¼ï¼Œè¿™é‡Œç»™çš„æƒé‡å€¼ä¸º 2</li>
<li><code>BufferFilename</code>ï¼šè°ƒç”¨ <code>noteUsage()</code> æ›´æ–°æƒé‡å€¼ï¼Œè¿™é‡Œç»™çš„æƒé‡å€¼ä¸º 10</li>
</ul>
</li>
<li><p>è‹¥ä¸º VMA ç±»å‹ ï¼ˆ<code>VmaType</code>ï¼‰ï¼Œåˆ™è°ƒç”¨ <code>noteUsage()</code> æ›´æ–°æƒé‡å€¼ï¼Œè¿™é‡Œç»™çš„æƒé‡å€¼ä¸º 5</p>
</li>
<li><p>å¯¹äºæ•´å‹åˆ™æ£€æŸ¥ <code>a.Kind</code> æ˜¯å¦ä¸º <code>IntPlain, IntRange</code>ï¼Œè‹¥ä¸æ˜¯åˆ™ç›´æ¥ panic</p>
</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(t Type, ctx *TypeCtx)</span></span> &#123;<br>		c := ctx.Meta<br>		<span class="hljs-keyword">switch</span> a := t.(<span class="hljs-keyword">type</span>) &#123;<br>		<span class="hljs-keyword">case</span> *ResourceType:<br>			<span class="hljs-keyword">if</span> target.AuxResources[a.Desc.Name] &#123;<br>				noteUsage(uses, c, <span class="hljs-number">1</span>, ctx.Dir, <span class="hljs-string">&quot;res%v&quot;</span>, a.Desc.Name)<br>			&#125; <span class="hljs-keyword">else</span> &#123;<br>				str := <span class="hljs-string">&quot;res&quot;</span><br>				<span class="hljs-keyword">for</span> i, k := <span class="hljs-keyword">range</span> a.Desc.Kind &#123;<br>					str += <span class="hljs-string">&quot;-&quot;</span> + k<br>					w := <span class="hljs-type">int32</span>(<span class="hljs-number">10</span>)<br>					<span class="hljs-keyword">if</span> i &lt; <span class="hljs-built_in">len</span>(a.Desc.Kind)<span class="hljs-number">-1</span> &#123;<br>						w = <span class="hljs-number">2</span><br>					&#125;<br>					noteUsage(uses, c, w, ctx.Dir, str)<br>				&#125;<br>			&#125;<br>		<span class="hljs-keyword">case</span> *PtrType:<br>			<span class="hljs-keyword">if</span> _, ok := a.Elem.(*StructType); ok &#123;<br>				noteUsage(uses, c, <span class="hljs-number">10</span>, ctx.Dir, <span class="hljs-string">&quot;ptrto-%v&quot;</span>, a.Elem.Name())<br>			&#125;<br>			<span class="hljs-keyword">if</span> _, ok := a.Elem.(*UnionType); ok &#123;<br>				noteUsage(uses, c, <span class="hljs-number">10</span>, ctx.Dir, <span class="hljs-string">&quot;ptrto-%v&quot;</span>, a.Elem.Name())<br>			&#125;<br>			<span class="hljs-keyword">if</span> arr, ok := a.Elem.(*ArrayType); ok &#123;<br>				noteUsage(uses, c, <span class="hljs-number">10</span>, ctx.Dir, <span class="hljs-string">&quot;ptrto-%v&quot;</span>, arr.Elem.Name())<br>			&#125;<br>		<span class="hljs-keyword">case</span> *BufferType:<br>			<span class="hljs-keyword">switch</span> a.Kind &#123;<br>			<span class="hljs-keyword">case</span> BufferBlobRand, BufferBlobRange, BufferText, BufferCompressed:<br>			<span class="hljs-keyword">case</span> BufferString, BufferGlob:<br>				<span class="hljs-keyword">if</span> a.SubKind != <span class="hljs-string">&quot;&quot;</span> &#123;<br>					noteUsage(uses, c, <span class="hljs-number">2</span>, ctx.Dir, fmt.Sprintf(<span class="hljs-string">&quot;str-%v&quot;</span>, a.SubKind))<br>				&#125;<br>			<span class="hljs-keyword">case</span> BufferFilename:<br>				noteUsage(uses, c, <span class="hljs-number">10</span>, DirIn, <span class="hljs-string">&quot;filename&quot;</span>)<br>			<span class="hljs-keyword">default</span>:<br>				<span class="hljs-built_in">panic</span>(<span class="hljs-string">&quot;unknown buffer kind&quot;</span>)<br>			&#125;<br>		<span class="hljs-keyword">case</span> *VmaType:<br>			noteUsage(uses, c, <span class="hljs-number">5</span>, ctx.Dir, <span class="hljs-string">&quot;vma&quot;</span>)<br>		<span class="hljs-keyword">case</span> *IntType:<br>			<span class="hljs-keyword">switch</span> a.Kind &#123;<br>			<span class="hljs-keyword">case</span> IntPlain, IntRange:<br>			<span class="hljs-keyword">default</span>:<br>				<span class="hljs-built_in">panic</span>(<span class="hljs-string">&quot;unknown int kind&quot;</span>)<br>			&#125;<br>		&#125;<br>	&#125;)<br></code></pre></td></tr></table></figure>

<p>è¿™é‡Œå¤§é‡ç”¨åˆ°äº† <code>noteUsage()</code> å‡½æ•°ï¼Œè¯¥å‡½æ•°å…¶å®å°±æ˜¯ç”¨æ¥<strong>æ›´æ–°ä¼ å…¥çš„è¡¨ä¸­ X åˆ° Y çš„æƒé‡å€¼</strong>ï¼ˆå–æœ€å¤§å€¼ï¼‰ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">noteUsage</span><span class="hljs-params">(uses <span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]<span class="hljs-keyword">map</span>[<span class="hljs-type">int</span>]weights, c *Syscall, weight <span class="hljs-type">int32</span>, dir Dir, str <span class="hljs-type">string</span>, args ...<span class="hljs-keyword">interface</span>&#123;&#125;)</span></span> &#123;<br>	id := fmt.Sprintf(str, args...)<br>	<span class="hljs-keyword">if</span> uses[id] == <span class="hljs-literal">nil</span> &#123;<br>		uses[id] = <span class="hljs-built_in">make</span>(<span class="hljs-keyword">map</span>[<span class="hljs-type">int</span>]weights)<br>	&#125;<br>	callWeight := uses[id][c.ID]<br>	callWeight.call = c.ID<br>	<span class="hljs-keyword">if</span> dir != DirOut &#123;<br>		<span class="hljs-keyword">if</span> weight &gt; uses[id][c.ID].in &#123;<br>			callWeight.in = weight<br>		&#125;<br>	&#125;<br>	<span class="hljs-keyword">if</span> weight &gt; uses[id][c.ID].inout &#123;<br>		callWeight.inout = weight<br>	&#125;<br>	uses[id][c.ID] = callWeight<br>&#125;<br></code></pre></td></tr></table></figure>

<h5 id="Step-II-å»ºç«‹-call-to-call-çš„æƒé‡è¡¨"><a href="#Step-II-å»ºç«‹-call-to-call-çš„æƒé‡è¡¨" class="headerlink" title="Step.II - å»ºç«‹ call-to-call çš„æƒé‡è¡¨"></a>Step.II - å»ºç«‹ call-to-call çš„æƒé‡è¡¨</h5><p>ç°åœ¨æˆ‘ä»¬å›åˆ° <code>calcStaticPriorities()</code> ä¸­ï¼Œåœ¨å®Œæˆäº†èµ„æºä½¿ç”¨è¡¨ <code>uses</code> çš„å»ºç«‹ä¹‹åï¼Œæ¥ä¸‹æ¥ä¼šå»ºç«‹ call-to-call çš„æƒé‡è¡¨ <code>prios</code>ï¼š</p>
<ul>
<li>éå†èµ„æºä½¿ç”¨è¡¨ä¸­çš„æ¯ä¸ªæƒé‡ï¼ŒåŸºäºå‚æ•°æ–¹å‘èµ‹äºˆé™æ€æƒé‡å€¼ï¼ˆä¾‹å¦‚ï¼Œå½“ c0 ä¸ºåˆ›å»ºäº†ä¸€ä¸ªèµ„æºçš„è°ƒç”¨ï¼Œè€Œ c1 ä¸ºä½¿ç”¨è¯¥èµ„æºçš„è°ƒç”¨ï¼Œåˆ™ä¸€ä¸ªæ›´é«˜çš„æƒé‡å°†è¢«èµ‹äºˆï¼‰</li>
<li>è°ƒç”¨ <code>normalizePrio()</code> å°†è¡¨ä¸­æƒé‡å€¼è¿›è¡Œæ ‡å‡†åŒ–</li>
<li>å¯¹äºè‡ªæˆ‘ç³»ç»Ÿè°ƒç”¨æƒé‡è¿›è¡Œå•ç‹¬èµ‹å€¼</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs go">	prios := <span class="hljs-built_in">make</span>([][]<span class="hljs-type">int32</span>, <span class="hljs-built_in">len</span>(target.Syscalls))<br>	<span class="hljs-keyword">for</span> i := <span class="hljs-keyword">range</span> prios &#123;<br>		prios[i] = <span class="hljs-built_in">make</span>([]<span class="hljs-type">int32</span>, <span class="hljs-built_in">len</span>(target.Syscalls))<br>	&#125;<br>	<span class="hljs-keyword">for</span> _, weights := <span class="hljs-keyword">range</span> uses &#123;<br>		<span class="hljs-keyword">for</span> _, w0 := <span class="hljs-keyword">range</span> weights &#123;<br>			<span class="hljs-keyword">for</span> _, w1 := <span class="hljs-keyword">range</span> weights &#123;<br>				<span class="hljs-keyword">if</span> w0.call == w1.call &#123;<br>					<span class="hljs-comment">// è‡ªèº«æƒé‡åœ¨ä¸‹æ–¹èµ‹å€¼.</span><br>					<span class="hljs-keyword">continue</span><br>				&#125;<br>				<span class="hljs-comment">// é™æ€æƒé‡å€¼åŸºäºå‚æ•°æ–¹å‘èµ‹å€¼.å½“ c0 ä¸ºåˆ›å»ºäº†ä¸€ä¸ªèµ„æºçš„è°ƒç”¨</span><br>				<span class="hljs-comment">// è€Œ c1 ä¸ºä½¿ç”¨è¯¥èµ„æºçš„è°ƒç”¨ï¼Œåˆ™ä¸€ä¸ªæ›´é«˜çš„æƒé‡å°†è¢«èµ‹äºˆ.</span><br>				prios[w0.call][w1.call] += w0.inout*w1.in*<span class="hljs-number">3</span>/<span class="hljs-number">2</span> + w0.inout*w1.inout<br>			&#125;<br>		&#125;<br>	&#125;<br>	normalizePrio(prios)<br>	<span class="hljs-comment">// è‡ªèº«æƒé‡å€¼(call wrt itself) çš„èµ‹å€¼åº”å½“é«˜äº›, ä½†ä¸è¦å¤ªé«˜.</span><br>	<span class="hljs-keyword">for</span> c0, pp := <span class="hljs-keyword">range</span> prios &#123;<br>		pp[c0] = prioHigh * <span class="hljs-number">9</span> / <span class="hljs-number">10</span><br>	&#125;<br>	<span class="hljs-keyword">return</span> prios<br>&#125;<br></code></pre></td></tr></table></figure>

<p>å®ŒæˆåŸºäºèµ„æºä½¿ç”¨çš„æƒé‡å€¼è®¡ç®—ä¹‹åé™æ€ä¼˜å…ˆçº§å°±ç®—è®¡ç®—å®Œæ¯•äº†ï¼šï¼‰</p>
<h4 id="â‘¡-calcDynamicPrio-ï¼šåŠ¨æ€ä¼˜å…ˆçº§è®¡ç®—"><a href="#â‘¡-calcDynamicPrio-ï¼šåŠ¨æ€ä¼˜å…ˆçº§è®¡ç®—" class="headerlink" title="â‘¡ calcDynamicPrio()ï¼šåŠ¨æ€ä¼˜å…ˆçº§è®¡ç®—"></a>â‘¡ calcDynamicPrio()ï¼šåŠ¨æ€ä¼˜å…ˆçº§è®¡ç®—</h4><p>åŠ¨æ€ä¼˜å…ˆçº§çš„è®¡ç®—åŸºäºç°æœ‰çš„è¯­æ–™åº“å®Œæˆï¼Œè¿™ä¸€éƒ¨åˆ†çš„ä»£ç æ¯”è¾ƒç®€å•ï¼Œä¸»è¦æ˜¯éå†è¯­æ–™åº“ï¼Œå¯¹äºåŒæ—¶å‡ºç°çš„ç³»ç»Ÿè°ƒç”¨å¯¹ Xã€Y çš„ä¼˜å…ˆçº§å€¼ <code>+1</code>ï¼Œå®Œæˆåè°ƒç”¨ <code>normalizePrio()</code> è¿›è¡Œæ ‡å‡†åŒ–ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(target *Target)</span></span> calcDynamicPrio(corpus []*Prog) [][]<span class="hljs-type">int32</span> &#123;<br>	prios := <span class="hljs-built_in">make</span>([][]<span class="hljs-type">int32</span>, <span class="hljs-built_in">len</span>(target.Syscalls))<br>	<span class="hljs-keyword">for</span> i := <span class="hljs-keyword">range</span> prios &#123;<br>		prios[i] = <span class="hljs-built_in">make</span>([]<span class="hljs-type">int32</span>, <span class="hljs-built_in">len</span>(target.Syscalls))<br>	&#125;<br>	<span class="hljs-keyword">for</span> _, p := <span class="hljs-keyword">range</span> corpus &#123;<br>		<span class="hljs-keyword">for</span> idx0, c0 := <span class="hljs-keyword">range</span> p.Calls &#123;<br>			<span class="hljs-keyword">for</span> _, c1 := <span class="hljs-keyword">range</span> p.Calls[idx0+<span class="hljs-number">1</span>:] &#123;<br>				prios[c0.Meta.ID][c1.Meta.ID]++<br>			&#125;<br>		&#125;<br>	&#125;<br>	normalizePrio(prios)<br>	<span class="hljs-keyword">return</span> prios<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="â‘¢-normalizePrio-ï¼šä¼˜å…ˆçº§å€¼æ ‡å‡†åŒ–"><a href="#â‘¢-normalizePrio-ï¼šä¼˜å…ˆçº§å€¼æ ‡å‡†åŒ–" class="headerlink" title="â‘¢ normalizePrio()ï¼šä¼˜å…ˆçº§å€¼æ ‡å‡†åŒ–"></a>â‘¢ normalizePrio()ï¼šä¼˜å…ˆçº§å€¼æ ‡å‡†åŒ–</h4><p>è¿™ä¸ªå‡½æ•°é€»è¾‘æ¯”è¾ƒç®€å•ï¼Œä¸»è¦å°±æ˜¯å°†æƒé‡å€¼æ ‡å‡†åŒ–åˆ° [prioLow..prioHigh] èŒƒå›´ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">const</span> (<br>	prioLow  = <span class="hljs-number">10</span><br>	prioHigh = <span class="hljs-number">1000</span><br>)<br><br><span class="hljs-comment">// normalizePrio å°†æƒé‡å€¼æ ‡å‡†åŒ–åˆ° [prioLow..prioHigh] èŒƒå›´.</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">normalizePrio</span><span class="hljs-params">(prios [][]<span class="hljs-type">int32</span>)</span></span> &#123;<br>	<span class="hljs-keyword">for</span> _, prio := <span class="hljs-keyword">range</span> prios &#123;<br>		max := <span class="hljs-type">int32</span>(<span class="hljs-number">1</span>)<br>		<span class="hljs-keyword">for</span> _, p := <span class="hljs-keyword">range</span> prio &#123;<br>			<span class="hljs-keyword">if</span> max &lt; p &#123;<br>				max = p<br>			&#125;<br>		&#125;<br>		<span class="hljs-keyword">for</span> i, p := <span class="hljs-keyword">range</span> prio &#123;<br>			prio[i] = prioLow + p*(prioHigh-prioLow)/max<br>		&#125;<br>	&#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<h2 id="ä¸ºæ¯ä¸ª-syz-executor-å¯åŠ¨ä¸€ä¸ªåç¨‹ï¼Œæ­£å¼å¼€å§‹-fuzz"><a href="#ä¸ºæ¯ä¸ª-syz-executor-å¯åŠ¨ä¸€ä¸ªåç¨‹ï¼Œæ­£å¼å¼€å§‹-fuzz" class="headerlink" title="ä¸ºæ¯ä¸ª syz-executor å¯åŠ¨ä¸€ä¸ªåç¨‹ï¼Œæ­£å¼å¼€å§‹ fuzz"></a>ä¸ºæ¯ä¸ª syz-executor å¯åŠ¨ä¸€ä¸ªåç¨‹ï¼Œæ­£å¼å¼€å§‹ fuzz</h2><p>å®Œæˆå‰é¢çš„æ‰€æœ‰å‡†å¤‡å·¥ä½œä¹‹åï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬ç»ˆäºå¯ä»¥æ­£å¼å¼€å§‹è¿›è¡Œ fuzzing äº†ï¼Œsyz-fuzzer ä¼šè°ƒç”¨ <code>newProc()</code> ä¸ºæ¯ä¸ªè¦å¯åŠ¨çš„ syz-executor åˆ›å»ºä¸€ä¸ª <code>Proc</code> å®ä¾‹å¯¹è±¡ï¼ˆéƒ½å­˜æ”¾åœ¨ <code>fuzzer.procs</code> åˆ—è¡¨ä¸­ï¼‰ï¼Œå¹¶<strong>ä¸ºæ¯ä¸ª syz-executor å¯åŠ¨ä¸€ä¸ªæ–°çš„åç¨‹è´Ÿè´£å…·ä½“çš„ fuzzing å·¥ä½œ</strong>ï¼ˆ<code>proc.Loop()</code>ï¼‰</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">if</span> r.CoverFilterBitmap != <span class="hljs-literal">nil</span> &#123;<br>	fuzzer.execOpts.Flags |= ipc.FlagEnableCoverageFilter<br>&#125;<br><br>log.Logf(<span class="hljs-number">0</span>, <span class="hljs-string">&quot;starting %v fuzzer processes&quot;</span>, *flagProcs)<br><span class="hljs-keyword">for</span> pid := <span class="hljs-number">0</span>; pid &lt; *flagProcs; pid++ &#123;<br>	proc, err := newProc(fuzzer, pid)<br>	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>		log.Fatalf(<span class="hljs-string">&quot;failed to create proc: %v&quot;</span>, err)<br>	&#125;<br>	fuzzer.procs = <span class="hljs-built_in">append</span>(fuzzer.procs, proc)<br>	<span class="hljs-keyword">go</span> proc.loop()<br>&#125;<br><br></code></pre></td></tr></table></figure>

<p>æœ€åä¸»çº¿ç¨‹è°ƒç”¨ <code>pollLoop()</code>ï¼Œå¾ªç¯ç­‰å¾…éœ€è¦ poll çš„æƒ…å†µ</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs go">	fuzzer.pollLoop()<br>&#125;<br></code></pre></td></tr></table></figure>

<h1 id="0x03-pollLooop-ï¼šå¾ªç¯ç­‰å¾…å¤„ç†-fuzzing-åç¨‹è¯·æ±‚ï¼Œä¸-syz-manager-é€šä¿¡"><a href="#0x03-pollLooop-ï¼šå¾ªç¯ç­‰å¾…å¤„ç†-fuzzing-åç¨‹è¯·æ±‚ï¼Œä¸-syz-manager-é€šä¿¡" class="headerlink" title="0x03. pollLooop()ï¼šå¾ªç¯ç­‰å¾…å¤„ç† fuzzing åç¨‹è¯·æ±‚ï¼Œä¸ syz-manager é€šä¿¡"></a>0x03. pollLooop()ï¼šå¾ªç¯ç­‰å¾…å¤„ç† fuzzing åç¨‹è¯·æ±‚ï¼Œä¸ syz-manager é€šä¿¡</h1><p>fuzzing çš„å·¥ä½œæ˜¯ç”±åç¨‹ <code>proc.loop()</code> å®Œæˆçš„ï¼Œåœ¨ç»§ç»­æ·±å…¥ fuzzing è¿‡ç¨‹ä¹‹å‰æˆ‘ä»¬å…ˆæ¥çœ‹çœ‹ä¸»çº¿ç¨‹æœ€åè¿˜ä¼šåšäº›ä»€ä¹ˆï¼šï¼‰</p>
<p>ä¸»çº¿ç¨‹åœ¨å¯åŠ¨è¿™äº›åç¨‹ä¹‹åæ‰€éœ€è¦åšçš„å·¥ä½œå…¶å®å°±æ˜¯å“åº”è¿™äº›åç¨‹çš„è¯·æ±‚ï¼Œå¹¶è´Ÿè´£ä¸ syz-manager é—´è¿›è¡Œ RPC é€šä¿¡ï¼Œé€šè¿‡ä¸€ä¸ªä¸ä¼šè¿”å›çš„ <code>pollLoop()</code> å‡½æ•°å®Œæˆï¼Œè¯¥å‡½æ•°æ ¸å¿ƒå…¶å®å°±æ˜¯ä¸€ä¸ª<strong>æ— é™å¾ªç¯</strong>ï¼š</p>
<ul>
<li>å¾ªç¯ç­‰å¾… <code>ticker</code> ï¼ˆæ¯ 3s å“åº”ä¸€æ¬¡çš„è®¡æ—¶å™¨ï¼‰æˆ– <code>fuzzer.needPoll</code> è¿™ä¸¤ä¸ª channel ä¹‹ä¸€æœ‰æ•°æ®ä¼ æ¥</li>
<li>å¦‚æœæ˜¯  <code>fuzzer.needPoll</code> ä¼ æ¥è¯·æ±‚æˆ–æ˜¯è·ç¦»ä¸Šæ¬¡ poll çš„æ—¶é—´å¤§äº 10sï¼š<ul>
<li>æ£€æŸ¥ workQueue æ˜¯å¦éœ€è¦æ–°çš„ candidateï¼ˆcandidate æ•°é‡å°‘äº executor æ•°é‡ï¼‰ï¼Œè‹¥ä¸æ˜¯ä¸”æœ¬æ¬¡è¯·æ±‚å¤„ç†ä¸º  <code>fuzzer.needPoll</code> ä¼ æ¥è¯·æ±‚ï¼Œåˆ™ç­‰åˆ°åˆ°è·ç¦»ä¸Šæ¬¡ poll çš„æ—¶é—´å¤§äº 10s</li>
<li>æ”¶é›† executor æ•°æ®ï¼Œè°ƒç”¨ <code>poll()</code> é€šè¿‡ RPC å‘ syz-manager è·å–æ–°çš„ candidate</li>
</ul>
</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs go">unc (fuzzer *Fuzzer) pollLoop() &#123;<br>	<span class="hljs-keyword">var</span> execTotal <span class="hljs-type">uint64</span><br>	<span class="hljs-keyword">var</span> lastPoll time.Time<br>	<span class="hljs-keyword">var</span> lastPrint time.Time<br>	ticker := time.NewTicker(<span class="hljs-number">3</span> * time.Second * fuzzer.timeouts.Scale).C<br>	<span class="hljs-keyword">for</span> &#123;<br>		poll := <span class="hljs-literal">false</span><br>		<span class="hljs-keyword">select</span> &#123;<br>		<span class="hljs-keyword">case</span> &lt;-ticker:	<span class="hljs-comment">/* 3s ä¸€æ¬¡çš„è®¡æ—¶å™¨ */</span><br>		<span class="hljs-keyword">case</span> &lt;-fuzzer.needPoll: <span class="hljs-comment">/* fuzzing åç¨‹çš„ poll è¯·æ±‚ */</span><br>			poll = <span class="hljs-literal">true</span><br>		&#125;<br>		<span class="hljs-keyword">if</span> fuzzer.outputType != OutputStdout &amp;&amp; time.Since(lastPrint) &gt; <span class="hljs-number">10</span>*time.Second*fuzzer.timeouts.Scale &#123;<br>			<span class="hljs-comment">// Keep-alive for manager.</span><br>			log.Logf(<span class="hljs-number">0</span>, <span class="hljs-string">&quot;alive, executed %v&quot;</span>, execTotal)<br>			lastPrint = time.Now()<br>		&#125;<br>		<span class="hljs-comment">/* å¯¹äºè®¡æ—¶å™¨è€Œè¨€è‡³å°‘ 10s æ‰ poll ä¸€æ¬¡ */</span><br>		<span class="hljs-keyword">if</span> poll || time.Since(lastPoll) &gt; <span class="hljs-number">10</span>*time.Second*fuzzer.timeouts.Scale &#123;<br>			<span class="hljs-comment">/* workqueue é‡Œ work item æ•°é‡å°‘äº executor æ•°é‡æ‰ poll */</span><br>			needCandidates := fuzzer.workQueue.wantCandidates()<br>			<span class="hljs-keyword">if</span> poll &amp;&amp; !needCandidates &#123;<br>				<span class="hljs-keyword">continue</span><br>			&#125;<br>			stats := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]<span class="hljs-type">uint64</span>)<br>			<span class="hljs-keyword">for</span> _, proc := <span class="hljs-keyword">range</span> fuzzer.procs &#123;<br>				stats[<span class="hljs-string">&quot;exec total&quot;</span>] += atomic.SwapUint64(&amp;proc.env.StatExecs, <span class="hljs-number">0</span>)<br>				stats[<span class="hljs-string">&quot;executor restarts&quot;</span>] += atomic.SwapUint64(&amp;proc.env.StatRestarts, <span class="hljs-number">0</span>)<br>			&#125;<br>			<span class="hljs-keyword">for</span> stat := Stat(<span class="hljs-number">0</span>); stat &lt; StatCount; stat++ &#123;<br>				v := atomic.SwapUint64(&amp;fuzzer.stats[stat], <span class="hljs-number">0</span>)<br>				stats[statNames[stat]] = v<br>				execTotal += v<br>			&#125;<br>			<span class="hljs-keyword">if</span> !fuzzer.poll(needCandidates, stats) &#123;<br>				lastPoll = time.Now()<br>			&#125;<br>		&#125;<br>	&#125;<br>&#125;<br></code></pre></td></tr></table></figure>



<h1 id="0x04-proc-loop-ï¼šçœŸæ­£è´Ÿè´£-fuzzing-çš„æ ¸å¿ƒåç¨‹"><a href="#0x04-proc-loop-ï¼šçœŸæ­£è´Ÿè´£-fuzzing-çš„æ ¸å¿ƒåç¨‹" class="headerlink" title="0x04. proc.loop()ï¼šçœŸæ­£è´Ÿè´£ fuzzing çš„æ ¸å¿ƒåç¨‹"></a>0x04. proc.loop()ï¼šçœŸæ­£è´Ÿè´£ fuzzing çš„æ ¸å¿ƒåç¨‹</h1><p>ä¸‹é¢æˆ‘ä»¬æ¥åˆ° syz-fuzzer çš„å¦ä¸€ä¸ªæ ¸å¿ƒâ€”â€”<strong>çœŸæ­£çš„ fuzzing è¿‡ç¨‹</strong>ï¼Œsyz-fuzzer ä¼šä¸ºæ¯ä¸ª syz-executor å¯åŠ¨ä¸€ä¸ªæ–°çš„åç¨‹è´Ÿè´£å…·ä½“çš„ fuzzing å·¥ä½œï¼ˆå¯¹äº executor æ¥è¯´ç›¸å½“äºç£å·¥å’Œä¸æ–­ç»™ä»»åŠ¡çš„ä¸Šå¸å±äºæ˜¯ï¼‰ï¼Œè¯¥åç¨‹å¯¹åº” <code>proc.loop()</code> å‡½æ•°ï¼Œè¯¥å‡½æ•°çš„æ ¸å¿ƒå…¶å®è¿˜æ˜¯ä¸€ä¸ª<strong>æ— é™å¾ªç¯</strong>ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(proc *Proc)</span></span> loop() &#123;<br>	generatePeriod := <span class="hljs-number">100</span><br>	<span class="hljs-keyword">if</span> proc.fuzzer.config.Flags&amp;ipc.FlagSignal == <span class="hljs-number">0</span> &#123;<br>		<span class="hljs-comment">// å¦‚æœæˆ‘ä»¬æ²¡æœ‰çœŸçš„è¦†ç›–ç‡ä¿¡å·, æ›´åŠ é¢‘ç¹åœ°ç”Ÿæˆç¨‹åº</span><br>		<span class="hljs-comment">// å› ä¸ºåé¦ˆä¿¡å·å¾ˆå¼±.</span><br>		generatePeriod = <span class="hljs-number">2</span><br>	&#125;<br>	<span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; ; i++ &#123;<br></code></pre></td></tr></table></figure>

<h2 id="ä»å…¨å±€-WorkQueue-ä¸­è·å–è¾“å…¥ï¼Œåˆ†ç±»å¤„ç†æ‰§è¡Œ"><a href="#ä»å…¨å±€-WorkQueue-ä¸­è·å–è¾“å…¥ï¼Œåˆ†ç±»å¤„ç†æ‰§è¡Œ" class="headerlink" title="ä»å…¨å±€ WorkQueue ä¸­è·å–è¾“å…¥ï¼Œåˆ†ç±»å¤„ç†æ‰§è¡Œ"></a>ä»å…¨å±€ WorkQueue ä¸­è·å–è¾“å…¥ï¼Œåˆ†ç±»å¤„ç†æ‰§è¡Œ</h2><p>å¤§å¾ªç¯çš„æ ¸å¿ƒé€»è¾‘ä¹‹ä¸€ä¸ºä¸æ–­åœ°ä»å…¨å±€ <code>WorkQueue</code> ä¸­è·å–æ–°çš„è¾“å…¥ï¼ŒæŒ‰ç…§å…¶ç±»å‹ä¸åŒè°ƒç”¨ä¸åŒçš„å¤„ç†å‡½æ•°ï¼Œå®Œæˆååˆç»§ç»­ä¸‹ä¸€è½®å¾ªç¯</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs go">item := proc.fuzzer.workQueue.dequeue()<br><span class="hljs-keyword">if</span> item != <span class="hljs-literal">nil</span> &#123;<br>	<span class="hljs-keyword">switch</span> item := item.(<span class="hljs-keyword">type</span>) &#123;<br>	<span class="hljs-keyword">case</span> *WorkTriage:<br>		proc.triageInput(item)<br>	<span class="hljs-keyword">case</span> *WorkCandidate:<br>		proc.execute(proc.execOpts, item.p, item.flags, StatCandidate)<br>	<span class="hljs-keyword">case</span> *WorkSmash:<br>		proc.smashInput(item)<br>	<span class="hljs-keyword">default</span>:<br>		log.Fatalf(<span class="hljs-string">&quot;unknown work type: %#v&quot;</span>, item)<br>	&#125;<br>	<span class="hljs-keyword">continue</span><br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="â‘ -proc-triageInput-ï¼šæ‰§è¡Œè¾“å…¥-å°è¯•æœ€å°åŒ–åå‘é€ç»™-manager-å¹¶æ·»åŠ åˆ°æœ¬åœ°è¯­æ–™åº“ï¼Œè‹¥æœª-smash-åˆ™æ·»åŠ åˆ°-smash-é˜Ÿåˆ—"><a href="#â‘ -proc-triageInput-ï¼šæ‰§è¡Œè¾“å…¥-å°è¯•æœ€å°åŒ–åå‘é€ç»™-manager-å¹¶æ·»åŠ åˆ°æœ¬åœ°è¯­æ–™åº“ï¼Œè‹¥æœª-smash-åˆ™æ·»åŠ åˆ°-smash-é˜Ÿåˆ—" class="headerlink" title="â‘  proc.triageInput()ï¼šæ‰§è¡Œè¾“å…¥&amp;å°è¯•æœ€å°åŒ–åå‘é€ç»™ manager å¹¶æ·»åŠ åˆ°æœ¬åœ°è¯­æ–™åº“ï¼Œè‹¥æœª smash åˆ™æ·»åŠ åˆ° smash é˜Ÿåˆ—"></a>â‘  proc.triageInput()ï¼šæ‰§è¡Œè¾“å…¥&amp;å°è¯•æœ€å°åŒ–åå‘é€ç»™ manager å¹¶æ·»åŠ åˆ°æœ¬åœ°è¯­æ–™åº“ï¼Œè‹¥æœª smash åˆ™æ·»åŠ åˆ° smash é˜Ÿåˆ—</h3><p>è¯¥å‡½æ•°ç”¨æ¥å¤„ç† WorkQueue ä¸­çš„ WorkTraigeï¼Œå³<strong>å¯èƒ½ä¼šæä¾›æ–°è¦†ç›–ç‡çš„ç¨‹åº</strong>ï¼š</p>
<ul>
<li>ä¸€å¼€å§‹å…ˆè°ƒç”¨ <code>signalPrio()</code> æ£€æŸ¥è¯¥è¾“å…¥ä¹‹å‰æ‰§è¡Œç»“æœçš„ <code>errno</code>ï¼Œä¸º <code>0</code> åˆ™ <code>prio |= 1 &lt;&lt; 1</code>ï¼ŒåŒæ—¶è¿˜ä¼šæ£€æŸ¥æ˜¯å¦ <code>item.p</code> çš„ <code>target</code> ä¸åŒ…å« <code>item.p.Calls[call]</code> å¯¹åº”çš„è°ƒç”¨ï¼Œè‹¥æ˜¯åˆ™ <code>prio |= 1 &lt;&lt; 0</code></li>
<li>åˆ¤æ–­æ˜¯å¦äº§ç”Ÿäº†è¯­æ–™åº“ä¸­æ²¡æœ‰çš„æ–°ä¿¡å·ï¼Œè‹¥æ— åˆ™ç›´æ¥è¿”å›</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(proc *Proc)</span></span> triageInput(item *WorkTriage) &#123;<br>	log.Logf(<span class="hljs-number">1</span>, <span class="hljs-string">&quot;#%v: triaging type=%x&quot;</span>, proc.pid, item.flags)<br><br>	prio := signalPrio(item.p, &amp;item.info, item.call)<br>	inputSignal := signal.FromRaw(item.info.Signal, prio)<br>	newSignal := proc.fuzzer.corpusSignalDiff(inputSignal)<br>	<span class="hljs-keyword">if</span> newSignal.Empty() &#123;<br>		<span class="hljs-keyword">return</span><br>	&#125;<br>	callName := <span class="hljs-string">&quot;.extra&quot;</span><br>	logCallName := <span class="hljs-string">&quot;extra&quot;</span><br>	<span class="hljs-keyword">if</span> item.call != <span class="hljs-number">-1</span> &#123;<br>		callName = item.p.Calls[item.call].Meta.Name<br>		logCallName = fmt.Sprintf(<span class="hljs-string">&quot;call #%v %v&quot;</span>, item.call, callName)<br>	&#125;<br>	log.Logf(<span class="hljs-number">3</span>, <span class="hljs-string">&quot;triaging input for %v (new signal=%v)&quot;</span>, logCallName, newSignal.Len())<br></code></pre></td></tr></table></figure>

<p>å®Œæˆå‰é¢çš„è¿™äº›åˆ¤æ–­å·¥ä½œä¹‹åï¼Œæ¥ä¸‹æ¥æ¥åˆ°ä¸€ä¸ªä¼šè¿è¡Œä¸‰æ¬¡çš„å°å¾ªç¯ï¼š</p>
<ul>
<li>è°ƒç”¨ <code>proc.executeRaw()</code> <strong>å°†è¯¥è¾“å…¥é‡æ–°æ‰§è¡Œä¸€æ¬¡</strong>ï¼Œè‹¥æ‰§è¡Œå¤±è´¥ï¼ˆè¿™é‡Œçš„ <code>reexecutionSuccess()</code> ä¸»è¦æ£€æŸ¥ä¿¡å·é•¿åº¦æ˜¯å¦ä¸ä¸º 0ï¼‰åˆ™é‡æ–°å¼€å§‹å¾ªç¯ï¼Œå¤±è´¥ 2æ¬¡ç›´æ¥è¿”å›</li>
<li>è·å–æ‰§è¡Œæ‰€å¾—ä¿¡å·ä¸è¦†ç›–ç‡ï¼Œå°†è¦†ç›–ç‡åˆå¹¶åˆ° <code>inputCover</code> ä¸­ï¼Œå¦‚æœ <code>rawCover</code> ä¸ºç©ºåˆ™è¿˜ä¼šå¾€é‡Œè¾¹æ”¾ä¸€ä»½</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">var</span> inputCover cover.Cover<br><span class="hljs-keyword">const</span> (<br>	signalRuns       = <span class="hljs-number">3</span><br>	minimizeAttempts = <span class="hljs-number">3</span><br>)<br><span class="hljs-comment">// è®¡ç®—è¾“å…¥è¦†ç›–ä¸ non-flaky ä¿¡å·ä»¥æœ€å°åŒ–.</span><br>notexecuted := <span class="hljs-number">0</span><br>rawCover := []<span class="hljs-type">uint32</span>&#123;&#125;<br><span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; signalRuns; i++ &#123;<br>	info := proc.executeRaw(proc.execOptsCover, item.p, StatTriage)<br>	<span class="hljs-keyword">if</span> !reexecutionSuccess(info, &amp;item.info, item.call) &#123;<br>		<span class="hljs-comment">// è°ƒç”¨æœªè¢«æ‰§è¡Œæˆ–å¤±è´¥äº†.</span><br>		notexecuted++<br>		<span class="hljs-keyword">if</span> notexecuted &gt; signalRuns/<span class="hljs-number">2</span>+<span class="hljs-number">1</span> &#123;<br>			<span class="hljs-keyword">return</span> <span class="hljs-comment">// å‘ç”Ÿå¾—å¤ªé¢‘ç¹ï¼Œæ”¾å¼ƒ</span><br>		&#125;<br>		<span class="hljs-keyword">continue</span><br>	&#125;<br>	thisSignal, thisCover := getSignalAndCover(item.p, info, item.call)<br>	<span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(rawCover) == <span class="hljs-number">0</span> &amp;&amp; proc.fuzzer.fetchRawCover &#123;<br>		rawCover = <span class="hljs-built_in">append</span>([]<span class="hljs-type">uint32</span>&#123;&#125;, thisCover...)<br>	&#125;<br>	newSignal = newSignal.Intersection(thisSignal)<br>	<span class="hljs-comment">// æ²¡æœ‰ !minimized æ£€æŸ¥çš„æƒ…å†µä¸‹ manager åœ¨æ¯æ¬¡é‡å¯åå¼€å§‹ä¸¢å¤±ç›¸å½“å¤§é‡çš„è¦†ç›–ç‡.</span><br>	<span class="hljs-comment">// Mechanics of this are not completely clear.</span><br>	<span class="hljs-keyword">if</span> newSignal.Empty() &amp;&amp; item.flags&amp;ProgMinimized == <span class="hljs-number">0</span> &#123;<br>		<span class="hljs-keyword">return</span><br>	&#125;<br>	inputCover.Merge(thisCover)<br>&#125;<br></code></pre></td></tr></table></figure>

<blockquote>
<p>è¿™é‡Œè¿™ä¸ª <code>Merge()</code> å…¶å®ç¬”è€…æ²¡å¤ªçœ‹æ˜ç™½ :ï¼ˆ</p>
<p>ç›®å‰ç¬”è€…æ¨æµ‹ <code>pc</code> æ˜¯ <code>program counter</code> ï¼Œè¿™æ ·æ¯”è¾ƒèƒ½è¯´å¾—é€šï¼Œä¸è¿‡è¿™æ ·ä¸ºä»€ä¹ˆä¸ç”¨ <code>map[uint32]bool</code> å‘¢ï¼Ÿ</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(cov *Cover)</span></span> Merge(raw []<span class="hljs-type">uint32</span>) &#123;<br>	c := *cov<br>	<span class="hljs-keyword">if</span> c == <span class="hljs-literal">nil</span> &#123;<br>		c = <span class="hljs-built_in">make</span>(Cover)<br>		*cov = c<br>	&#125;<br>	<span class="hljs-keyword">for</span> _, pc := <span class="hljs-keyword">range</span> raw &#123;<br>		c[pc] = <span class="hljs-keyword">struct</span>&#123;&#125;&#123;&#125;<br>	&#125;<br>&#125;<br></code></pre></td></tr></table></figure>


</blockquote>
<p>å¾ªç¯ç»“æŸåä¼šæ£€æŸ¥ item çš„æ ‡å¿—ä½ï¼Œå¦‚æœæœªè®¾ç½® <code>ProgMinimized</code> è¯´æ˜è¯¥è¾“å…¥è¿˜æœªè¿›è¡Œæœ€å°åŒ–ï¼Œ<strong>æ­¤æ—¶è°ƒç”¨</strong> <code>prog.Minimize()</code> <strong>å°†è¾“å…¥è¿›è¡Œæœ€å°åŒ–</strong></p>
<p>è¿™é‡Œä¼ å…¥çš„é—­åŒ…å‡½æ•°ä¸»è¦æ˜¯ä¸€ä¸ª <code>minimizeAttempts</code> ï¼ˆ3ï¼‰æ¬¡çš„å°å¾ªç¯ï¼Œå…¶ä¸­ä¼šè°ƒç”¨ <code>proc.execute()</code> æ‰§è¡Œæœ€å°åŒ–åçš„ç¨‹åºï¼Œæ‰§è¡Œå¤±è´¥åˆ™è¿”å›ï¼Œè‹¥ä¸‰æ¬¡å¾ªç¯æ‰§è¡Œä¸­æ— æ³•å†äº§ç”Ÿæ–°çš„ä¿¡å·ä¿¡å·åˆ™è¿”å› trueï¼Œå¦åˆ™è¿”å› false</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">if</span> item.flags&amp;ProgMinimized == <span class="hljs-number">0</span> &#123;<br>	item.p, item.call = prog.Minimize(item.p, item.call, <span class="hljs-literal">false</span>,<br>		<span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(p1 *prog.Prog, call1 <span class="hljs-type">int</span>)</span></span> <span class="hljs-type">bool</span> &#123;<br>			<span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; minimizeAttempts; i++ &#123;<br>				info := proc.execute(proc.execOpts, p1, ProgNormal, StatMinimize)<br>				<span class="hljs-keyword">if</span> !reexecutionSuccess(info, &amp;item.info, call1) &#123;<br>					<span class="hljs-comment">// The call was not executed or failed.</span><br>					<span class="hljs-keyword">continue</span><br>				&#125;<br>				thisSignal, _ := getSignalAndCover(p1, info, call1)<br>				<span class="hljs-keyword">if</span> newSignal.Intersection(thisSignal).Len() == newSignal.Len() &#123;<br>					<span class="hljs-keyword">return</span> <span class="hljs-literal">true</span><br>				&#125;<br>			&#125;<br>			<span class="hljs-keyword">return</span> <span class="hljs-literal">false</span><br>		&#125;)<br>&#125;<br></code></pre></td></tr></table></figure>

<p>æœ€åå°†è¿™ä¸ªè¾“å…¥åºåˆ—åŒ–å<strong>å‘é€ç»™ syz-manager å¹¶å°†å…¶æ·»åŠ åˆ°æœ¬åœ°è¯­æ–™åº“ä¸­</strong>ï¼Œå¦‚æœæœªè®¾ç½® <code>ProgSmashed</code> æ ‡å¿—ä½åˆ™å†å°†è¿™ä¸ªè¾“å…¥æ”¾åˆ° WorkSmash é˜Ÿåˆ—ä¸­</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs go">	data := item.p.Serialize()<br>	sig := hash.Hash(data)<br><br>	log.Logf(<span class="hljs-number">2</span>, <span class="hljs-string">&quot;added new input for %v to corpus:\n%s&quot;</span>, logCallName, data)<br>	proc.fuzzer.sendInputToManager(rpctype.Input&#123;<br>		Call:     callName,<br>		CallID:   item.call,<br>		Prog:     data,<br>		Signal:   inputSignal.Serialize(),<br>		Cover:    inputCover.Serialize(),<br>		RawCover: rawCover,<br>	&#125;)<br><br>	proc.fuzzer.addInputToCorpus(item.p, inputSignal, sig)<br><br>	<span class="hljs-keyword">if</span> item.flags&amp;ProgSmashed == <span class="hljs-number">0</span> &#123;<br>		proc.fuzzer.workQueue.enqueue(&amp;WorkSmash&#123;item.p, item.call&#125;)<br>	&#125;<br>&#125;<br></code></pre></td></tr></table></figure>



<h3 id="â‘¡-proc-execute-ï¼šæ‰§è¡Œè¾“å…¥ï¼Œå°†æœ‰æ„æ€çš„è¾“å…¥æ”¾åˆ°-traige-é˜Ÿåˆ—"><a href="#â‘¡-proc-execute-ï¼šæ‰§è¡Œè¾“å…¥ï¼Œå°†æœ‰æ„æ€çš„è¾“å…¥æ”¾åˆ°-traige-é˜Ÿåˆ—" class="headerlink" title="â‘¡ proc.execute()ï¼šæ‰§è¡Œè¾“å…¥ï¼Œå°†æœ‰æ„æ€çš„è¾“å…¥æ”¾åˆ° traige é˜Ÿåˆ—"></a>â‘¡ proc.execute()ï¼šæ‰§è¡Œè¾“å…¥ï¼Œå°†æœ‰æ„æ€çš„è¾“å…¥æ”¾åˆ° traige é˜Ÿåˆ—</h3><p>è¯¥å‡½æ•°çš„é€»è¾‘æ¯”è¾ƒç®€å•ï¼Œä¸»è¦ä¾¿æ˜¯è°ƒç”¨ <code>proc.executeRaw()</code> æ‰§è¡Œä¼ å…¥çš„è¾“å…¥ï¼Œå¹¶è°ƒç”¨ <code>checkNewSignal()</code> æ£€æŸ¥æ‰§è¡Œçš„ç»“æœï¼Œå°†å…¶ä¸­æœ‰æ„æ€çš„é‚£äº›æ”¾å…¥ traige é˜Ÿåˆ—ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(proc *Proc)</span></span> execute(execOpts *ipc.ExecOpts, p *prog.Prog, flags ProgTypes, stat Stat) *ipc.ProgInfo &#123;<br>	info := proc.executeRaw(execOpts, p, stat)<br>	<span class="hljs-keyword">if</span> info == <span class="hljs-literal">nil</span> &#123;<br>		<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span><br>	&#125;<br>	calls, extra := proc.fuzzer.checkNewSignal(p, info)<br>	<span class="hljs-keyword">for</span> _, callIndex := <span class="hljs-keyword">range</span> calls &#123;<br>		proc.enqueueCallTriage(p, flags, callIndex, info.Calls[callIndex])<br>	&#125;<br>	<span class="hljs-keyword">if</span> extra &#123;<br>		proc.enqueueCallTriage(p, flags, <span class="hljs-number">-1</span>, info.Extra)<br>	&#125;<br>	<span class="hljs-keyword">return</span> info<br>&#125;<br></code></pre></td></tr></table></figure>

<p><code>executeRaw()</code> å‡½æ•°çš„ä¸»è¦é€»è¾‘å…¶å®å°±æ˜¯å…ˆæ£€æŸ¥ç¦ç”¨çš„ç³»ç»Ÿè°ƒç”¨ç„¶åæ˜¯ä¸€ä¸ªä¼ªæ— é™å¾ªç¯è°ƒç”¨ <code>proc.env.Exec()</code> æ‰§è¡Œè¾“å…¥ï¼ˆå¥½å¤šå±‚å¥—å¨ƒï¼‰ï¼Œè‹¥æ‰§è¡Œå¤±è´¥åˆ™è¿›è¡Œé”™è¯¯è®°å½•å¹¶ä¼‘çœ  1s åé‡æ–°è¿›è¡Œï¼Œæ‰§è¡ŒæˆåŠŸåˆ™ç›´æ¥è¿”å›</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(proc *Proc)</span></span> executeRaw(opts *ipc.ExecOpts, p *prog.Prog, stat Stat) *ipc.ProgInfo &#123;<br>	proc.fuzzer.checkDisabledCalls(p)<br><br>	<span class="hljs-comment">// é™åˆ¶å¹¶å‘çª—å£ï¼Œæ¯éš”ä¸€æ®µæ—¶é—´è¿›è¡Œä¸€æ¬¡æ³„æ¼æ£€æŸ¥.</span><br>	ticket := proc.fuzzer.gate.Enter()<br>	<span class="hljs-keyword">defer</span> proc.fuzzer.gate.Leave(ticket)<br><br>	proc.logProgram(opts, p)<br>	<span class="hljs-keyword">for</span> try := <span class="hljs-number">0</span>; ; try++ &#123;<br>		atomic.AddUint64(&amp;proc.fuzzer.stats[stat], <span class="hljs-number">1</span>)<br>		output, info, hanged, err := proc.env.Exec(opts, p)<br>		<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>			<span class="hljs-keyword">if</span> err == prog.ErrExecBufferTooSmall &#123;<br>				<span class="hljs-comment">// è‹¥æˆ‘ä»¬ç³»ç»Ÿåœ°åœ¨åºåˆ—åŒ–ç¨‹åºä¸Šå¤±è´¥åˆ™éå¸¸ç³Ÿç³•,</span><br>				<span class="hljs-comment">// ä½†ç›®å‰ä¸ºæ­¢é™¤äº†ç»Ÿè®¡ä»¥å¤–æˆ‘ä»¬æ²¡æœ‰æ›´å¥½çš„å¤„ç†æ–¹å¼.</span><br>				<span class="hljs-comment">// è¯¥é”™è¯¯åœ¨ seeded seeded syz_mount_image è°ƒç”¨ä¸Šè§‚å¯Ÿåˆ°å¾ˆå¤š.</span><br>				atomic.AddUint64(&amp;proc.fuzzer.stats[StatBufferTooSmall], <span class="hljs-number">1</span>)<br>				<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span><br>			&#125;<br>			<span class="hljs-keyword">if</span> try &gt; <span class="hljs-number">10</span> &#123;<br>				log.Fatalf(<span class="hljs-string">&quot;executor %v failed %v times: %v&quot;</span>, proc.pid, try, err)<br>			&#125;<br>			log.Logf(<span class="hljs-number">4</span>, <span class="hljs-string">&quot;fuzzer detected executor failure=&#x27;%v&#x27;, retrying #%d&quot;</span>, err, try+<span class="hljs-number">1</span>)<br>			debug.FreeOSMemory()<br>			time.Sleep(time.Second)<br>			<span class="hljs-keyword">continue</span><br>		&#125;<br>		log.Logf(<span class="hljs-number">2</span>, <span class="hljs-string">&quot;result hanged=%v: %s&quot;</span>, hanged, output)<br>		<span class="hljs-keyword">return</span> info<br>	&#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="Env-Exec-ï¼šå¯åŠ¨-syz-executor-å¹¶å°†è¾“å…¥ç¨‹åºåºåˆ—åŒ–åäº¤ç»™å…¶æ‰§è¡Œ"><a href="#Env-Exec-ï¼šå¯åŠ¨-syz-executor-å¹¶å°†è¾“å…¥ç¨‹åºåºåˆ—åŒ–åäº¤ç»™å…¶æ‰§è¡Œ" class="headerlink" title="Env.Exec()ï¼šå¯åŠ¨ syz-executor å¹¶å°†è¾“å…¥ç¨‹åºåºåˆ—åŒ–åäº¤ç»™å…¶æ‰§è¡Œ"></a>Env.Exec()ï¼šå¯åŠ¨ syz-executor å¹¶å°†è¾“å…¥ç¨‹åºåºåˆ—åŒ–åäº¤ç»™å…¶æ‰§è¡Œ</h4><p><code>Env.Exec()</code> å‡½æ•°ç”¨æ¥å¯åŠ¨ syz-executor å¹¶å°†è¾“å…¥äº¤ç»™å…¶è¿›è¡Œæ‰§è¡Œï¼Œ<strong>syz-executor åœ¨è¢«å¯åŠ¨åä¼šä¸€ç›´ç­‰å¾… syz-fuzzer ä¼ æ¥çš„è¾“å…¥å¹¶æ‰§è¡Œ</strong>ï¼Œè€Œä¸æ˜¯æ¯ä¸ªè¾“å…¥éƒ½è¦é‡æ–°å¯åŠ¨ä¸€æ¬¡ executorï¼š</p>
<ul>
<li>é¦–å…ˆå°†è¾“å…¥åºåˆ—åŒ–åˆ° <code>env.in</code> ï¼ˆä½œä¸º syz-executor çš„è¾“å…¥ï¼Œsyz-executor ä¼šååºåˆ—åŒ–åå†å°†å…¶æ‰§è¡Œï¼‰ï¼Œå¹¶å°† <code>env.out</code> çš„å‰ 4 å­—èŠ‚ï¼ˆ<code>ncmd and nsig</code> ï¼‰ç½® 0ï¼›è¿™é‡Œæˆ‘ä»¬æ³¨æ„åˆ° syz-fuzzer ä¸ syz-executor é—´æœ‰ä¸¤ç§ä¼ é€’æ•°æ®çš„æ–¹å¼ï¼šç®¡é“&#x2F;å…±äº«å†…å­˜</li>
<li>æ¥ä¸‹æ¥æ£€æŸ¥ executor æ˜¯å¦å·²å¯åŠ¨ï¼Œè‹¥æœªå¯åŠ¨ï¼ˆ <code>env.cmd == nil</code> ï¼‰åˆ™è°ƒç”¨ <code>makeCommand()</code> <strong>å¯åŠ¨ syz-executor</strong></li>
<li>æ¥ä¸‹æ¥è°ƒç”¨ <code>cmd.exec()</code> <strong>çœŸæ­£å¼€å§‹è®© syz-executor æ‰§è¡Œç¨‹åº</strong>ï¼Œè‹¥å‡ºé”™åˆ™å…³é—­ syz-executorï¼ˆç­‰ <code>executeRaw()</code> çš„ä¸‹æ¬¡å¾ªç¯é‡æ–°å¯åŠ¨ï¼‰</li>
<li>æœ€åè§£æç¨‹åºè¾“å‡ºï¼Œè¿”å›ç»“æœ</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// Exec å¯åŠ¨ executor äºŒè¿›åˆ¶æ–‡ä»¶ä»¥æ‰§è¡Œç¨‹åº p å¹¶è¿”å›å…³äºæ‰§è¡Œçš„ä¿¡æ¯:</span><br><span class="hljs-comment">// output: ç¨‹åºè¾“å‡º</span><br><span class="hljs-comment">// info: per-call info</span><br><span class="hljs-comment">// hanged: ç¨‹åºæŒ‚èµ·ä¸”è¢«æ€æ­»</span><br><span class="hljs-comment">// err0: å¯åŠ¨ç¨‹åºå¤±è´¥æˆ–æ˜¯ executor è‡ªèº«æœ‰é—®é¢˜.</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(env *Env)</span></span> Exec(opts *ExecOpts, p *prog.Prog) (output []<span class="hljs-type">byte</span>, info *ProgInfo, hanged <span class="hljs-type">bool</span>, err0 <span class="hljs-type">error</span>) &#123;<br>	<span class="hljs-comment">// Copy-in serialized program.</span><br>	progSize, err := p.SerializeForExec(env.in)<br>	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>		err0 = err<br>		<span class="hljs-keyword">return</span><br>	&#125;<br>	<span class="hljs-keyword">var</span> progData []<span class="hljs-type">byte</span><br>	<span class="hljs-keyword">if</span> !env.config.UseShmem &#123;<br>		progData = env.in[:progSize]<br>	&#125;<br>	<span class="hljs-comment">// æ¸…é›¶å‰ä¸¤ä¸ªå­— (ncmd and nsig), ç”±æ­¤è‹¥ executor åœ¨å†™å…¥éåƒåœ¾æ•°æ®å‰å´©æºƒï¼Œ</span><br>	<span class="hljs-comment">// æˆ‘ä»¬åœ¨è¿™é‡Œä¾¿æ²¡æœ‰åƒåœ¾.</span><br>	<span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">4</span>; i++ &#123;<br>		env.out[i] = <span class="hljs-number">0</span><br>	&#125;<br><br>	atomic.AddUint64(&amp;env.StatExecs, <span class="hljs-number">1</span>)<br>	<span class="hljs-keyword">if</span> env.cmd == <span class="hljs-literal">nil</span> &#123; <span class="hljs-comment">/* syz-executor æœªå¯åŠ¨ */</span><br>		<span class="hljs-keyword">if</span> p.Target.OS != targets.TestOS &amp;&amp; targets.Get(p.Target.OS, p.Target.Arch).HostFuzzer &#123;<br>			<span class="hljs-comment">// executor å®é™…ä¸Šæ˜¯ ssh,</span><br>			<span class="hljs-comment">// å¤ªé¢‘ç¹åœ°å¯åŠ¨ä»–ä»¬ä¼šå¯¼è‡´å»¶è¿Ÿ.</span><br>			&lt;-rateLimit.C<br>		&#125;<br>		tmpDirPath := <span class="hljs-string">&quot;./&quot;</span><br>		atomic.AddUint64(&amp;env.StatRestarts, <span class="hljs-number">1</span>)<br>		env.cmd, err0 = makeCommand(env.pid, env.bin, env.config, env.inFile, env.outFile, env.out, tmpDirPath)<br>		<span class="hljs-keyword">if</span> err0 != <span class="hljs-literal">nil</span> &#123;<br>			<span class="hljs-keyword">return</span><br>		&#125;<br>	&#125;<br>	output, hanged, err0 = env.cmd.exec(opts, progData)<span class="hljs-comment">/* æ‰§è¡Œè¾“å…¥ */</span><br>	<span class="hljs-keyword">if</span> err0 != <span class="hljs-literal">nil</span> &#123; <span class="hljs-comment">/* å‡ºé”™ï¼Œå…³é—­ executor */</span><br>		env.cmd.<span class="hljs-built_in">close</span>()<br>		env.cmd = <span class="hljs-literal">nil</span><br>		<span class="hljs-keyword">return</span><br>	&#125;<br><br>	info, err0 = env.parseOutput(p, opts)<br>	<span class="hljs-keyword">if</span> info != <span class="hljs-literal">nil</span> &amp;&amp; env.config.Flags&amp;FlagSignal == <span class="hljs-number">0</span> &#123;<br>		addFallbackSignal(p, info)<br>	&#125;<br>	<span class="hljs-keyword">if</span> !env.config.UseForkServer &#123;<br>		env.cmd.<span class="hljs-built_in">close</span>()<br>		env.cmd = <span class="hljs-literal">nil</span><br>	&#125;<br>	<span class="hljs-keyword">return</span><br>&#125;<br></code></pre></td></tr></table></figure>



<h4 id="ã€æ ¸å¿ƒã€‘makeCommand-ï¼šå»ºç«‹é€šä¿¡ç®¡é“ï¼Œå¯åŠ¨-syz-executor"><a href="#ã€æ ¸å¿ƒã€‘makeCommand-ï¼šå»ºç«‹é€šä¿¡ç®¡é“ï¼Œå¯åŠ¨-syz-executor" class="headerlink" title="ã€æ ¸å¿ƒã€‘makeCommand()ï¼šå»ºç«‹é€šä¿¡ç®¡é“ï¼Œå¯åŠ¨ syz-executor"></a>ã€æ ¸å¿ƒã€‘makeCommand()ï¼šå»ºç«‹é€šä¿¡ç®¡é“ï¼Œå¯åŠ¨ syz-executor</h4><p><code>makeCommand()</code> å‡½æ•°æ˜¯çœŸæ­£å¯åŠ¨ syz-executor çš„å‡½æ•°ï¼Œå…¶é¦–å…ˆä¼šå…ˆåˆ›å»ºä¸€ä¸ªä¸´æ—¶æ–‡ä»¶å¤¹ <code>syzkaller-testdir</code> å¹¶æ›´æ”¹æƒé™ä¸º <code>0777</code>ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">makeCommand</span><span class="hljs-params">(pid <span class="hljs-type">int</span>, bin []<span class="hljs-type">string</span>, config *Config, inFile, outFile *os.File, outmem []<span class="hljs-type">byte</span>,</span></span><br><span class="hljs-params"><span class="hljs-function">	tmpDirPath <span class="hljs-type">string</span>)</span></span> (*command, <span class="hljs-type">error</span>) &#123;<br>	dir, err := os.MkdirTemp(tmpDirPath, <span class="hljs-string">&quot;syzkaller-testdir&quot;</span>)<br>	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>		<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, fmt.Errorf(<span class="hljs-string">&quot;failed to create temp dir: %v&quot;</span>, err)<br>	&#125;<br>	dir = osutil.Abs(dir)<br><br>	timeout := config.Timeouts.Program<br>	<span class="hljs-keyword">if</span> config.UseForkServer &#123;<br>		<span class="hljs-comment">// åœ¨å¯ç”¨äº† fork server æ—¶ï¼ŒExecutor æœ‰ä¸€ä¸ªå†…éƒ¨çš„ timeoutï¼Œå¯ä»¥é˜²æ­¢å¤§éƒ¨åˆ†çš„æŒ‚èµ·ï¼Œ</span><br>		<span class="hljs-comment">// å› æ­¤æˆ‘ä»¬ç”¨ä¸€ä¸ªéå¸¸å¤§çš„ timeout. Executor å¯ä»¥å› ä¸ºå‘½åç©ºé—´ä¸­çš„å…¨å±€é”ä¸å…¶ä»–ä¸œè¥¿è€Œå˜æ…¢ï¼Œ</span><br>		<span class="hljs-comment">// æ•…æˆ‘ä»¬æœ€å¥½ç­‰å¾…ï¼Œè€Œéä¸ŠæŠ¥è™šå‡çš„è¯¯å¯¼æ€§ crashes.</span><br>		timeout *= <span class="hljs-number">10</span><br>	&#125;<br><br>	c := &amp;command&#123;<br>		pid:     pid,<br>		config:  config,<br>		timeout: timeout,<br>		dir:     dir,<br>		outmem:  outmem,<br>	&#125;<br>	<span class="hljs-keyword">defer</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br>		<span class="hljs-keyword">if</span> c != <span class="hljs-literal">nil</span> &#123;<br>			c.<span class="hljs-built_in">close</span>()<br>		&#125;<br>	&#125;()<br><br>	<span class="hljs-keyword">if</span> err := os.Chmod(dir, <span class="hljs-number">0777</span>); err != <span class="hljs-literal">nil</span> &#123;<br>		<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, fmt.Errorf(<span class="hljs-string">&quot;failed to chmod temp dir: %v&quot;</span>, err)<br>	&#125;<br></code></pre></td></tr></table></figure>

<p>æ¥ä¸‹æ¥åˆ›å»ºä¸‰ä¸ªç”¨ä»¥ä¸ <code>syz-executor</code> é€šä¿¡çš„ç®¡é“ï¼Œåˆ†åˆ«ç”¨äºæ•è·è¾“å‡ºã€å‘ executor ä¼ é€’å‘½ä»¤ã€ä» executor æ¥æ”¶å‘½ä»¤ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// Output æ•è·ç®¡é“.</span><br>rp, wp, err := os.Pipe()<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>	<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, fmt.Errorf(<span class="hljs-string">&quot;failed to create pipe: %v&quot;</span>, err)<br>&#125;<br><span class="hljs-keyword">defer</span> wp.Close()<br><br><span class="hljs-comment">// executor-&gt;ipc å‘½ä»¤ç®¡é“.</span><br>inrp, inwp, err := os.Pipe()<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>	<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, fmt.Errorf(<span class="hljs-string">&quot;failed to create pipe: %v&quot;</span>, err)<br>&#125;<br><span class="hljs-keyword">defer</span> inwp.Close()<br>c.inrp = inrp<br><br><span class="hljs-comment">// ipc-&gt;executor å‘½ä»¤ç®¡é“.</span><br>outrp, outwp, err := os.Pipe()<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>	<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, fmt.Errorf(<span class="hljs-string">&quot;failed to create pipe: %v&quot;</span>, err)<br>&#125;<br><span class="hljs-keyword">defer</span> outrp.Close()<br>c.outwp = outwp<br><br>c.readDone = <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> []<span class="hljs-type">byte</span>, <span class="hljs-number">1</span>)<br></code></pre></td></tr></table></figure>

<p>æ¥ä¸‹æ¥ä¼šè°ƒç”¨ <code>osutil</code> ä¸­çš„ <code>Command()</code> åˆ›å»ºä¸€ä¸ª <code>exec.Cmd</code> å®ä¾‹ï¼ˆè¯¥å‡½æ•°ä¸º golag åŸç”Ÿçš„ <code>exec.Command()</code> çš„ wrapperï¼‰ï¼Œexecutor å®é™…ä¸Šè¦ç­‰åˆ°åé¢æ˜¾å¼è°ƒç”¨ <code>Start()</code> æˆ– <code>Run()</code> æ‰æ­£å¼å¼€å§‹è¿è¡Œï¼ˆå‚è§<a target="_blank" rel="noopener" href="https://books.studygolang.com/The-Golang-Standard-Library-by-Example/chapter10/10.1.html">åˆ›å»ºè¿›ç¨‹ Â· Goè¯­è¨€æ ‡å‡†åº“</a>ï¼‰ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs go">cmd := osutil.Command(bin[<span class="hljs-number">0</span>], bin[<span class="hljs-number">1</span>:]...)<br><span class="hljs-keyword">if</span> inFile != <span class="hljs-literal">nil</span> &amp;&amp; outFile != <span class="hljs-literal">nil</span> &#123;<br>	cmd.ExtraFiles = []*os.File&#123;inFile, outFile&#125;<br>&#125;<br>cmd.Dir = dir<br><span class="hljs-comment">// Tell ASAN to not mess with our NONFAILING.</span><br>cmd.Env = <span class="hljs-built_in">append</span>(<span class="hljs-built_in">append</span>([]<span class="hljs-type">string</span>&#123;&#125;, os.Environ()...), <span class="hljs-string">&quot;ASAN_OPTIONS=handle_segv=0 allow_user_segv_handler=1&quot;</span>)<br>cmd.Stdin = outrp<br>cmd.Stdout = inwp<br></code></pre></td></tr></table></figure>

<p>è‹¥æ˜¯æœªè®¾ç½® <code>FlagDebug</code> åˆ™è¿˜ä¼šå¯åŠ¨ä¸€ä¸ªæ–°çš„åç¨‹æŒç»­è¯»å– syz-executor è¾“å‡ºç®¡é“ä¸­çš„å†…å®¹ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">if</span> config.Flags&amp;FlagDebug != <span class="hljs-number">0</span> &#123;<br>	<span class="hljs-built_in">close</span>(c.readDone)<br>	cmd.Stderr = os.Stdout<br>&#125; <span class="hljs-keyword">else</span> &#123;<br>	cmd.Stderr = wp<br>	<span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(c *command)</span></span> &#123;<br>		<span class="hljs-comment">// è¯»å‡ºè¾“å‡ºä»¥é˜² executor æŒç»­åœ°æ‰“å°ä¸€äº›ä¸œè¥¿ã€‚</span><br>		<span class="hljs-keyword">const</span> bufSize = <span class="hljs-number">128</span> &lt;&lt; <span class="hljs-number">10</span><br>		output := <span class="hljs-built_in">make</span>([]<span class="hljs-type">byte</span>, bufSize)<br>		<span class="hljs-keyword">var</span> size <span class="hljs-type">uint64</span><br>		<span class="hljs-keyword">for</span> &#123;<br>			n, err := rp.Read(output[size:])<br>			<span class="hljs-keyword">if</span> n &gt; <span class="hljs-number">0</span> &#123;<br>				size += <span class="hljs-type">uint64</span>(n)<br>				<span class="hljs-keyword">if</span> size &gt;= bufSize*<span class="hljs-number">3</span>/<span class="hljs-number">4</span> &#123;<br>					<span class="hljs-built_in">copy</span>(output, output[size-bufSize/<span class="hljs-number">2</span>:size])<br>					size = bufSize / <span class="hljs-number">2</span><br>				&#125;<br>			&#125;<br>			<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>				rp.Close()<br>				c.readDone &lt;- output[:size]<br>				<span class="hljs-built_in">close</span>(c.readDone)<br>				<span class="hljs-keyword">return</span><br>			&#125;<br>		&#125;<br>	&#125;(c)<br>&#125;<br></code></pre></td></tr></table></figure>

<p>æœ€åè°ƒç”¨ <code>cmd.Start()</code> çœŸæ­£å¯åŠ¨ syz-executorï¼ˆè¯¥æ–¹æ³•ä¸ä¼šé˜»å¡çˆ¶è¿›ç¨‹ï¼‰ï¼Œå¹¶å¯åŠ¨ä¸€ä¸ªæ–°çš„åç¨‹ç­‰å¾… syz-executor çš„é€€å‡ºï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs go">	<span class="hljs-keyword">if</span> err := cmd.Start(); err != <span class="hljs-literal">nil</span> &#123;<br>		<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, fmt.Errorf(<span class="hljs-string">&quot;failed to start executor binary: %v&quot;</span>, err)<br>	&#125;<br>	c.exited = <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> <span class="hljs-type">error</span>, <span class="hljs-number">1</span>)<br>	c.cmd = cmd<br>	<span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(c *command)</span></span> &#123;<br>		err := c.cmd.Wait()<br>		c.exited &lt;- err<br>		<span class="hljs-built_in">close</span>(c.exited)<br>		<span class="hljs-comment">// è‹¥ cmd.Stderr å·²è¢«æ³„éœ²ç»™å¦ä¸€ä¸ªæ´»åŠ¨è¿›ç¨‹ï¼Œé˜²æ­¢ livelock.</span><br>		rp.SetDeadline(time.Now().Add(<span class="hljs-number">5</span> * time.Second))<br>	&#125;(c)<br>	wp.Close()<br>	<span class="hljs-comment">// æ³¨æ„: å°½ç®¡æˆ‘ä»¬åœ¨ä¸Šé¢ defer äº†ï¼Œæˆ‘ä»¬åœ¨è°ƒç”¨ğŸ¤å‰æ˜ç¡®åœ°å…³é—­ inwp.</span><br>	<span class="hljs-comment">// è‹¥æˆ‘ä»¬ä¸è¿™ä¹ˆåšä¸” executor åœ¨å†™å…¥ğŸ¤ç­”å¤å‰é€€å‡ºäº†,</span><br>	<span class="hljs-comment">// ç”±äºæˆ‘ä»¬æŒæœ‰å¦ä¸€ä¸ªæ‰“å¼€çš„ç®¡é“æœ«ç«¯ï¼Œä» inrp ä¸Šè¯»å–å°†æŒ‚èµ·.</span><br>	inwp.Close()<br><br>	<span class="hljs-keyword">if</span> c.config.UseForkServer &#123;<br>		<span class="hljs-keyword">if</span> err := c.handshake(); err != <span class="hljs-literal">nil</span> &#123;<br>			<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, err<br>		&#125;<br>	&#125;<br>	tmp := c<br>	c = <span class="hljs-literal">nil</span> <span class="hljs-comment">// disable defer above</span><br>	<span class="hljs-keyword">return</span> tmp, <span class="hljs-literal">nil</span><br>&#125;<br></code></pre></td></tr></table></figure>



<h4 id="ã€æ ¸å¿ƒã€‘cmd-exec-ï¼šå°†å•ä¸ªç¨‹åºè¾“å…¥ä¼ é€’ç»™-syz-executor-æ‰§è¡Œ"><a href="#ã€æ ¸å¿ƒã€‘cmd-exec-ï¼šå°†å•ä¸ªç¨‹åºè¾“å…¥ä¼ é€’ç»™-syz-executor-æ‰§è¡Œ" class="headerlink" title="ã€æ ¸å¿ƒã€‘cmd.exec()ï¼šå°†å•ä¸ªç¨‹åºè¾“å…¥ä¼ é€’ç»™ syz-executor æ‰§è¡Œ"></a>ã€æ ¸å¿ƒã€‘cmd.exec()ï¼šå°†å•ä¸ªç¨‹åºè¾“å…¥ä¼ é€’ç»™ syz-executor æ‰§è¡Œ</h4><p><code>command.exec()</code> å‡½æ•°ç”¨ä»¥å°†ä¸€ä¸ªåºåˆ—åŒ–åçš„è¾“å…¥ä¼ é€’ç»™ syz-executor è¿›ç¨‹æ‰§è¡Œï¼Œä¼ é€’çš„æ–¹å¼ä¸»è¦æ˜¯é€šè¿‡åœ¨ <code>makeCommand()</code> ä¸­å»ºç«‹çš„ <code>ipcâ†’executor</code> ç®¡é“å®Œæˆçš„ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(c *command)</span></span> exec(opts *ExecOpts, progData []<span class="hljs-type">byte</span>) (output []<span class="hljs-type">byte</span>, hanged <span class="hljs-type">bool</span>, err0 <span class="hljs-type">error</span>) &#123;<br>	req := &amp;executeReq&#123;<br>		magic:            inMagic,<br>		envFlags:         <span class="hljs-type">uint64</span>(c.config.Flags),<br>		execFlags:        <span class="hljs-type">uint64</span>(opts.Flags),<br>		pid:              <span class="hljs-type">uint64</span>(c.pid),<br>		syscallTimeoutMS: <span class="hljs-type">uint64</span>(c.config.Timeouts.Syscall / time.Millisecond),<br>		programTimeoutMS: <span class="hljs-type">uint64</span>(c.config.Timeouts.Program / time.Millisecond),<br>		slowdownScale:    <span class="hljs-type">uint64</span>(c.config.Timeouts.Scale),<br>		progSize:         <span class="hljs-type">uint64</span>(<span class="hljs-built_in">len</span>(progData)),<br>	&#125;<br>	reqData := (*[unsafe.Sizeof(*req)]<span class="hljs-type">byte</span>)(unsafe.Pointer(req))[:]<br>	<span class="hljs-keyword">if</span> _, err := c.outwp.Write(reqData); err != <span class="hljs-literal">nil</span> &#123;<br>		output = &lt;-c.readDone<br>		err0 = fmt.Errorf(<span class="hljs-string">&quot;executor %v: failed to write control pipe: %v&quot;</span>, c.pid, err)<br>		<span class="hljs-keyword">return</span><br>	&#125;<br>	<span class="hljs-keyword">if</span> progData != <span class="hljs-literal">nil</span> &#123;<br>		<span class="hljs-keyword">if</span> _, err := c.outwp.Write(progData); err != <span class="hljs-literal">nil</span> &#123;<br>			output = &lt;-c.readDone<br>			err0 = fmt.Errorf(<span class="hljs-string">&quot;executor %v: failed to write control pipe: %v&quot;</span>, c.pid, err)<br>			<span class="hljs-keyword">return</span><br>		&#125;<br>	&#125;<br>	<span class="hljs-comment">// åœ¨è¿™ä¸ªç‚¹ç¨‹åºå·²ç»å¼€å§‹è¿è¡Œäº†.</span><br></code></pre></td></tr></table></figure>

<p>å¯¹äºå•ä¸ªè¾“å…¥ç¨‹åºçš„ä¼ è¾“å®é™…ä¸Šä¼šå…ˆä¼ é€’ä¸€ä¸ª <code>executeReq</code> å¤´éƒ¨ï¼Œæ¥ä¸‹æ¥å†ä¼ é€’åºåˆ—åŒ–åçš„è¾“å…¥ç¨‹åºï¼š</p>
<p><img src="https://s2.loli.net/2023/04/24/I6od1evyCE3MZWH.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p>å½“æ•°æ®ä¼ é€’è¿‡å»ä¹‹å<strong>è¾“å…¥ç¨‹åºå°±å·²ç»å¼€å§‹æ‰§è¡Œäº†</strong>ï¼Œå› æ­¤è¯¥å‡½æ•°åé¢çš„éƒ¨åˆ†å°±éƒ½æ˜¯å¯¹ç»“æœçš„å¤„ç†ï¼›ï¼‰</p>
<p>å®Œæˆæ•°æ®å‘é€åä¼šå¯åŠ¨ä¸€ä¸ªåç¨‹å®šæ—¶ç­‰å¾… executor æ‰§è¡Œå®Œæ¯•ï¼Œè‹¥è¶…æ—¶åˆ™ä¼šå°† executor ç»™ kill æ‰ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs go">done := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> <span class="hljs-type">bool</span>)<br>hang := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> <span class="hljs-type">bool</span>)<br><span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br>	t := time.NewTimer(c.timeout)<br>	<span class="hljs-keyword">select</span> &#123;<br>	<span class="hljs-keyword">case</span> &lt;-t.C:<br>		c.cmd.Process.Kill()<br>		hang &lt;- <span class="hljs-literal">true</span><br>	<span class="hljs-keyword">case</span> &lt;-done:<br>		t.Stop()<br>		hang &lt;- <span class="hljs-literal">false</span><br>	&#125;<br>&#125;()<br></code></pre></td></tr></table></figure>

<p>éšåæ˜¯ä¸€ä¸ªæ— é™å¤§å¾ªç¯ï¼Œä» <code>executorâ†’ipc</code> ç®¡é“ä¸­è¯»å– syz-executor çš„æ‰§è¡Œç»“æœï¼ŒåŒæ ·æ˜¯ä¸€ä¸ª header <code>executeReply</code> å¸¦ä¸€ä»½æ•°æ® <code>callReply</code> ï¼Œå•æ¬¡è¯·æ±‚å¯èƒ½æœ‰å¤šä»½è¿”å›æ•°æ®å› æ­¤è¿™é‡Œæ˜¯ä¸€ä¸ªæ— é™å¾ªç¯ï¼Œé€šè¿‡ <code>executeReply</code> ä¸­çš„ <code>done</code> æ ‡å¿—ä½æ ‡è¯†ç»“æŸï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs go">exitStatus := <span class="hljs-number">-1</span><br>completedCalls := (*<span class="hljs-type">uint32</span>)(unsafe.Pointer(&amp;c.outmem[<span class="hljs-number">0</span>]))<br>outmem := c.outmem[<span class="hljs-number">4</span>:]<br><span class="hljs-keyword">for</span> &#123;<br>	reply := &amp;executeReply&#123;&#125;<br>	replyData := (*[unsafe.Sizeof(*reply)]<span class="hljs-type">byte</span>)(unsafe.Pointer(reply))[:]<br>	<span class="hljs-keyword">if</span> _, err := io.ReadFull(c.inrp, replyData); err != <span class="hljs-literal">nil</span> &#123;<br>		<span class="hljs-keyword">break</span><br>	&#125;<br>	<span class="hljs-keyword">if</span> reply.magic != outMagic &#123;<br>		fmt.Fprintf(os.Stderr, <span class="hljs-string">&quot;executor %v: got bad reply magic 0x%x\n&quot;</span>, c.pid, reply.magic)<br>		os.Exit(<span class="hljs-number">1</span>)<br>	&#125;<br>	<span class="hljs-keyword">if</span> reply.done != <span class="hljs-number">0</span> &#123;<br>		exitStatus = <span class="hljs-type">int</span>(reply.status)<br>		<span class="hljs-keyword">break</span><br>	&#125;<br>	callReply := &amp;callReply&#123;&#125;<br>	callReplyData := (*[unsafe.Sizeof(*callReply)]<span class="hljs-type">byte</span>)(unsafe.Pointer(callReply))[:]<br>	<span class="hljs-keyword">if</span> _, err := io.ReadFull(c.inrp, callReplyData); err != <span class="hljs-literal">nil</span> &#123;<br>		<span class="hljs-keyword">break</span><br>	&#125;<br>	<span class="hljs-keyword">if</span> callReply.signalSize != <span class="hljs-number">0</span> || callReply.coverSize != <span class="hljs-number">0</span> || callReply.compsSize != <span class="hljs-number">0</span> &#123;<br>		<span class="hljs-comment">// æš‚ä¸æ”¯æŒ.</span><br>		fmt.Fprintf(os.Stderr, <span class="hljs-string">&quot;executor %v: got call reply with coverage\n&quot;</span>, c.pid)<br>		os.Exit(<span class="hljs-number">1</span>)<br>	&#125;<br>	<span class="hljs-built_in">copy</span>(outmem, callReplyData)<br>	outmem = outmem[<span class="hljs-built_in">len</span>(callReplyData):]<br>	*completedCalls++<br>&#125;<br></code></pre></td></tr></table></figure>

<p>syz-fuzzer æ¥æ”¶ syz-executor è¿”å›æ•°æ®çš„ç¤ºä¾‹å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p>
<p><img src="https://s2.loli.net/2023/04/24/seE43rD2uaXCbwj.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p>æœ€åæ£€æŸ¥æœ¬æ¬¡æ‰§è¡Œç»“æœï¼Œå¦‚æœè¯´æ‰§è¡Œç»“æœä¸€åˆ‡é¡ºåˆ©åˆ™ç›´æ¥è¿”å›ï¼Œ<strong>å¦åˆ™ä¼šç»ˆæ­¢ syz-executor çš„ç»§ç»­è¿è¡Œ</strong>ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs go">	<span class="hljs-built_in">close</span>(done)<br>	<span class="hljs-keyword">if</span> exitStatus == <span class="hljs-number">0</span> &#123;<br>		<span class="hljs-comment">// Program was OK.</span><br>		&lt;-hang<br>		<span class="hljs-keyword">return</span><br>	&#125;<br>	c.cmd.Process.Kill()<br>	output = &lt;-c.readDone<br>	<span class="hljs-keyword">if</span> err := c.wait(); &lt;-hang &#123;<br>		hanged = <span class="hljs-literal">true</span><br>		<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>			output = <span class="hljs-built_in">append</span>(output, err.Error()...)<br>			output = <span class="hljs-built_in">append</span>(output, <span class="hljs-string">&#x27;\n&#x27;</span>)<br>		&#125;<br>		<span class="hljs-keyword">return</span><br>	&#125;<br>	<span class="hljs-keyword">if</span> exitStatus == <span class="hljs-number">-1</span> &#123;<br>		exitStatus = osutil.ProcessExitStatus(c.cmd.ProcessState)<br>	&#125;<br>	<span class="hljs-comment">// å¿½ç•¥å…¶ä»–çš„æ‰€æœ‰é”™è¯¯.</span><br>	<span class="hljs-comment">// åœ¨æ²¡æœ‰ fork server çš„æƒ…å†µä¸‹ executor å¯ä»¥åˆæ³•åœ°é€€å‡º (program contains exit_group),</span><br>	<span class="hljs-comment">// åœ¨å¸¦æœ‰ fork server çš„æƒ…å†µä¸‹è‹¥ top process æƒ³è¦ç‰¹æ®Šçš„å¤„ç†ï¼Œåˆ™å…¶å¯ä»¥å¸¦ç€ statusFail é€€å‡º.</span><br>	<span class="hljs-keyword">if</span> exitStatus == statusFail &#123;<br>		err0 = fmt.Errorf(<span class="hljs-string">&quot;executor %v: exit status %d\n%s&quot;</span>, c.pid, exitStatus, output)<br>	&#125;<br>	<span class="hljs-keyword">return</span><br>&#125;<br><br></code></pre></td></tr></table></figure>



<h3 id="â‘¢-proc-smashInput-ï¼šæ‰§è¡Œå¹¶å˜å¼‚åˆšåˆšè¢«åŠ å…¥åˆ°è¯­æ–™åº“ä¸­çš„ç¨‹åºã€æ ¸å¿ƒã€‘"><a href="#â‘¢-proc-smashInput-ï¼šæ‰§è¡Œå¹¶å˜å¼‚åˆšåˆšè¢«åŠ å…¥åˆ°è¯­æ–™åº“ä¸­çš„ç¨‹åºã€æ ¸å¿ƒã€‘" class="headerlink" title="â‘¢ proc.smashInput()ï¼šæ‰§è¡Œå¹¶å˜å¼‚åˆšåˆšè¢«åŠ å…¥åˆ°è¯­æ–™åº“ä¸­çš„ç¨‹åºã€æ ¸å¿ƒã€‘"></a>â‘¢ proc.smashInput()ï¼šæ‰§è¡Œå¹¶å˜å¼‚åˆšåˆšè¢«åŠ å…¥åˆ°è¯­æ–™åº“ä¸­çš„ç¨‹åºã€æ ¸å¿ƒã€‘</h3><p><code>proc.smashInput()</code> ç”¨ä»¥<strong>æ‰§è¡Œå¹¶å˜å¼‚åˆšåˆšè¢«åŠ å…¥åˆ°è¯­æ–™åº“ä¸­çš„ç¨‹åº</strong>ï¼ˆå³ <code>WorkSmash</code> ï¼‰ï¼š</p>
<ul>
<li>é¦–å…ˆæ£€æŸ¥ <code>faultInjectionEnabled</code> ï¼Œè‹¥è®¾ç½®äº†åˆ™è°ƒç”¨ <code>proc.failCall()</code> <ul>
<li>è¯¥å‡½æ•°ç”¨ä»¥å°†ä¸€ä¸ª fault æ³¨å…¥åˆ°ç¨‹åºä¸­ï¼Œå…¶ä¼šå¾ªç¯ä¸€ç™¾æ¬¡ï¼Œè®¾ç½® <code>newProg.Calls[call].Props.FailNth = nth</code> ï¼ˆ<code>newProg</code> ä¸ºè¾“å…¥ç¨‹åºçš„å…‹éš†ï¼‰åè°ƒç”¨ <code>proc.executeRaw()</code> è¿›è¡Œæ‰§è¡Œ</li>
</ul>
</li>
<li>æ¥ä¸‹æ¥æ£€æŸ¥ <code>comparisonTracingEnabled</code> ï¼Œè‹¥è®¾ç½®äº†åˆ™è°ƒç”¨ <code>proc.executeHintSeed()</code> <strong>ä½¿ç”¨ hint è¿›è¡Œå˜å¼‚</strong></li>
<li>éšåè·å– syz-fuzzer å½“å‰å¿«ç…§ï¼Œå¹¶å¾ªç¯ä¸€ç™¾æ¬¡ï¼š<strong>è°ƒç”¨</strong> <code>prog.Mutate()</code> <strong>å°†è¾“å…¥ç¨‹åºè¿›è¡Œå˜å¼‚åå†è°ƒç”¨</strong> <code>proc.executeAndCollide()</code> <strong>æ‰§è¡Œå˜å¼‚åçš„ç¨‹åº</strong></li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(proc *Proc)</span></span> smashInput(item *WorkSmash) &#123;<br>	<span class="hljs-keyword">if</span> proc.fuzzer.faultInjectionEnabled &amp;&amp; item.call != <span class="hljs-number">-1</span> &#123;<br>		proc.failCall(item.p, item.call)<br>	&#125;<br>	<span class="hljs-keyword">if</span> proc.fuzzer.comparisonTracingEnabled &amp;&amp; item.call != <span class="hljs-number">-1</span> &#123;<br>		proc.executeHintSeed(item.p, item.call)<br>	&#125;<br>	fuzzerSnapshot := proc.fuzzer.snapshot()<br>	<span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">100</span>; i++ &#123;<br>		p := item.p.Clone()<br>		p.Mutate(proc.rnd, prog.RecommendedCalls, proc.fuzzer.choiceTable, proc.fuzzer.noMutate, fuzzerSnapshot.corpus)<br>		log.Logf(<span class="hljs-number">1</span>, <span class="hljs-string">&quot;#%v: smash mutated&quot;</span>, proc.pid)<br>		proc.executeAndCollide(proc.execOpts, p, ProgNormal, StatSmash)<br>	&#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>å˜å¼‚å‡½æ•° <code>prog.Mutate()</code> æˆ‘ä»¬å°†åœ¨ä¸‹ä¸€èŠ‚ä¸­æ·±å…¥åˆ†æï¼Œæœ¬èŠ‚æˆ‘ä»¬å…ˆæ¥çœ‹å¦å¤–ä¸¤ä¸ªå‡½æ•°ï¼š</p>
<h4 id="proc-executeHintSeed-ï¼šä½¿ç”¨-hint-å˜å¼‚ç¨‹åºå¹¶æ‰§è¡Œ"><a href="#proc-executeHintSeed-ï¼šä½¿ç”¨-hint-å˜å¼‚ç¨‹åºå¹¶æ‰§è¡Œ" class="headerlink" title="proc.executeHintSeed()ï¼šä½¿ç”¨ hint å˜å¼‚ç¨‹åºå¹¶æ‰§è¡Œ"></a>proc.executeHintSeed()ï¼šä½¿ç”¨ hint å˜å¼‚ç¨‹åºå¹¶æ‰§è¡Œ</h4><p>è¯¥å‡½æ•°é¦–å…ˆä¼šå°†è¾“å…¥ç¨‹åºæ‰§è¡Œä¸€æ¬¡ï¼Œæ¥ä¸‹æ¥è°ƒç”¨ <code>prog.MutateWithHints</code> ä½¿ç”¨æ‰§è¡Œæ‰€å¾—çš„ CompMap <strong>å¯¹è¾“å…¥ç¨‹åºä¸­çš„ä¸€äº›å‚æ•°å€¼è¿›è¡Œæ›¿æ¢</strong>ï¼Œæœ€åå†å°†è¯¥è¾“å…¥ç¨‹åºæ‰§è¡Œä¸€æ¬¡ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(proc *Proc)</span></span> executeHintSeed(p *prog.Prog, call <span class="hljs-type">int</span>) &#123;<br>	log.Logf(<span class="hljs-number">1</span>, <span class="hljs-string">&quot;#%v: collecting comparisons&quot;</span>, proc.pid)<br>	<span class="hljs-comment">// é¦–å…ˆæ‰§è¡ŒåŸå§‹ç¨‹åºä»¥ä» KCOV è·å–æ¯”è¾ƒå€¼.</span><br>	info := proc.execute(proc.execOptsComps, p, ProgNormal, StatSeed)<br>	<span class="hljs-keyword">if</span> info == <span class="hljs-literal">nil</span> &#123;<br>		<span class="hljs-keyword">return</span><br>	&#125;<br><br>	<span class="hljs-comment">// æ¥ä¸‹æ¥ä¸ºæ¯ä¸ªç³»ç»Ÿè°ƒç”¨å‚æ•°äºä¸€ä¸ªæ¯”è¾ƒæ“ä½œæ•°çš„åŒ¹é…å¯¹å˜å¼‚åŸå§‹ç¨‹åº.</span><br>	<span class="hljs-comment">// æ‰§è¡Œæ¯ä¸€ä¸ªè¿™æ ·çš„å˜å¼‚ï¼Œä»¥æ£€æŸ¥æ˜¯å¦ç»™å‡ºäº†æ–°çš„è¦†ç›–ç‡.</span><br>	p.MutateWithHints(call, info.Calls[call].Comps, <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(p *prog.Prog)</span></span> &#123;<br>		log.Logf(<span class="hljs-number">1</span>, <span class="hljs-string">&quot;#%v: executing comparison hint&quot;</span>, proc.pid)<br>		proc.execute(proc.execOpts, p, ProgNormal, StatHint)<br>	&#125;)<br>&#125;<br></code></pre></td></tr></table></figure>

<p>åœ¨ <code>MutateWithHints()</code> å½“ä¸­è¾“å…¥è¿›ç¨‹ä¼šå…ˆè¢«å…‹éš†ä¸€ä»½ï¼Œæ¥ä¸‹æ¥ä½¿ç”¨ <code>ForeachArg</code> éå†æŒ‡å®šç³»ç»Ÿè°ƒç”¨ä¸­çš„æ¯ä¸ªå‚æ•°ï¼Œå¹¶ä¼ å…¥äº†ä¸€äº›é—­åŒ…å‡½æ•°å¥—å¨ƒï¼ˆå¥—ä¸­å¥—ä¸­å¥—å±äºæ˜¯ï¼‰ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// ä½¿ç”¨å­˜å‚¨åœ¨ compMapsä¸­çš„æ¯”è¾ƒæ“ä½œæ•°å˜å¼‚ç¨‹åº.</span><br><span class="hljs-comment">// å¯¹äºæ¯ä¸ªå˜ç§ï¼Œæ‰§è¡Œ exec å›è°ƒ.</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(p *Prog)</span></span> MutateWithHints(callIndex <span class="hljs-type">int</span>, comps CompMap, exec <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(p *Prog)</span></span>) &#123;<br>	p = p.Clone()<br>	c := p.Calls[callIndex]<br>	execValidate := <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br>		<span class="hljs-comment">// ä¸è¦å°è¯•ä¿®å¤ candidate ç¨‹åº.</span><br>		<span class="hljs-comment">// å‡è®¾åŸæ¥çš„è°ƒç”¨è¢« sanitized, æˆ‘ä»¬ä¼šå¾—åˆ°ä¸€ä¸ªåçš„è°ƒç”¨ä½œä¸º hint çš„æ›¿ä»£ç»“æœï¼Œå°†å…¶ä¸¢æ‰å°±è¡Œ.</span><br>		<span class="hljs-keyword">if</span> p.Target.sanitize(c, <span class="hljs-literal">false</span>) != <span class="hljs-literal">nil</span> &#123;<br>			<span class="hljs-keyword">return</span><br>		&#125;<br>		p.debugValidate()<br>		exec(p)<br>	&#125;<br>	ForeachArg(c, <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(arg Arg, _ *ArgCtx)</span></span> &#123;<br>		generateHints(comps, arg, execValidate)<br>	&#125;)<br>&#125;<br></code></pre></td></tr></table></figure>

<p>ç±»ä¼¼äºæˆ‘ä»¬ä¸Šæ–‡åˆ†æçš„ <code>ForeachType()</code>ï¼Œ<code>ForeachArg()</code> ä¼šä¸ºè¯¥è°ƒç”¨çš„è¿”å›å€¼ä¸æ¯ä¸€ä¸ªå‚æ•°éƒ½è°ƒç”¨ <code>foreachArgImpl()</code>ï¼Œè¯¥å‡½æ•°é¦–å…ˆä¼šè°ƒç”¨ä¸Šå±‚ä¼ å…¥çš„é—­åŒ… <code>generateHints()</code>ï¼Œæ¥ä¸‹æ¥ä¼šæ ¹æ®å‚æ•°ç±»å‹è¿›è¡Œä¸åŒæ“ä½œï¼š</p>
<ul>
<li><code>GroupArg</code> ï¼ˆé€»è¾‘ä¸Šçš„ä¸€ç»„å‚æ•°ï¼Œå³<strong>ç»“æ„ä½“</strong>ä¸<strong>æ•°ç»„</strong>ï¼‰ï¼šè·å–å¹¶éå†å…¶ä¸­çš„æ¯ä¸ªæˆå‘˜ï¼Œé€’å½’è°ƒç”¨ <code>foreachArgImpl()</code></li>
<li><code>PointerArg</code> ï¼ˆæŒ‡é’ˆç±»å‹ï¼‰ï¼šåˆ¤æ–­å…¶æŒ‡å‘ ï¼ˆpointeeï¼‰æ˜¯å¦ä¸º nilï¼Œè‹¥å¦ï¼Œé€’å½’è°ƒç”¨ <code>foreachArgImpl()</code></li>
<li><code>UnionArg</code>  ï¼ˆè”åˆä½“ç±»å‹ï¼‰ï¼šé€’å½’è°ƒç”¨ <code>foreachArgImpl()</code></li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">ForeachArg</span><span class="hljs-params">(c *Call, f <span class="hljs-keyword">func</span>(Arg, *ArgCtx)</span></span>) &#123;<br>	ctx := &amp;ArgCtx&#123;&#125;<br>	<span class="hljs-keyword">if</span> c.Ret != <span class="hljs-literal">nil</span> &#123;<br>		foreachArgImpl(c.Ret, ctx, f)<br>	&#125;<br>	ctx.Parent = &amp;c.Args<br>	ctx.Fields = c.Meta.Args<br>	<span class="hljs-keyword">for</span> _, arg := <span class="hljs-keyword">range</span> c.Args &#123;<br>		foreachArgImpl(arg, ctx, f)<br>	&#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">foreachArgImpl</span><span class="hljs-params">(arg Arg, ctx *ArgCtx, f <span class="hljs-keyword">func</span>(Arg, *ArgCtx)</span></span>) &#123;<br>	ctx0 := *ctx<br>	<span class="hljs-keyword">defer</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123; *ctx = ctx0 &#125;()<br>	f(arg, ctx)<br>	<span class="hljs-keyword">if</span> ctx.Stop &#123;<br>		<span class="hljs-keyword">return</span><br>	&#125;<br>	<span class="hljs-keyword">switch</span> a := arg.(<span class="hljs-keyword">type</span>) &#123;<br>	<span class="hljs-keyword">case</span> *GroupArg:<br>		overlayField := <span class="hljs-number">0</span><br>		<span class="hljs-keyword">if</span> typ, ok := a.Type().(*StructType); ok &#123;<br>			ctx.Parent = &amp;a.Inner<br>			ctx.Fields = typ.Fields<br>			overlayField = typ.OverlayField<br>		&#125;<br>		<span class="hljs-keyword">var</span> totalSize <span class="hljs-type">uint64</span><br>		<span class="hljs-keyword">for</span> i, arg1 := <span class="hljs-keyword">range</span> a.Inner &#123;<br>			<span class="hljs-keyword">if</span> i == overlayField &#123;<br>				ctx.Offset = ctx0.Offset<br>			&#125;<br>			foreachArgImpl(arg1, ctx, f)<br>			size := arg1.Size()<br>			ctx.Offset += size<br>			<span class="hljs-keyword">if</span> totalSize &lt; ctx.Offset &#123;<br>				totalSize = ctx.Offset - ctx0.Offset<br>			&#125;<br>		&#125;<br>		claimedSize := a.Size()<br>		varlen := a.Type().Varlen()<br>		<span class="hljs-keyword">if</span> varlen &amp;&amp; totalSize &gt; claimedSize || !varlen &amp;&amp; totalSize != claimedSize &#123;<br>			<span class="hljs-built_in">panic</span>(fmt.Sprintf(<span class="hljs-string">&quot;bad group arg size %v, should be &lt;= %v for %#v type %#v&quot;</span>,<br>				totalSize, claimedSize, a, a.Type().Name()))<br>		&#125;<br>	<span class="hljs-keyword">case</span> *PointerArg:<br>		<span class="hljs-keyword">if</span> a.Res != <span class="hljs-literal">nil</span> &#123;<br>			ctx.Base = a<br>			ctx.Offset = <span class="hljs-number">0</span><br>			foreachArgImpl(a.Res, ctx, f)<br>		&#125;<br>	<span class="hljs-keyword">case</span> *UnionArg:<br>		foreachArgImpl(a.Option, ctx, f)<br>	&#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>ç°åœ¨æˆ‘ä»¬æ¥çœ‹ <code>generateHints()</code> å‡½æ•°ï¼Œè¯¥å‡½æ•°é¦–å…ˆä¼šè°ƒç”¨ <code>Arg</code> æ¥å£çš„ <code>Type()</code> å‡½æ•°è·å–ç±»å‹å¹¶è¿›è¡Œåˆ¤æ–­ï¼Œå¯¹äºå¤§éƒ¨åˆ†ç±»å‹å¥½åƒéƒ½æ˜¯ç›´æ¥è¿”å›ï¼Œä»…æœ‰ä»¥ä¸‹é€šè¿‡ï¼š</p>
<ul>
<li><code>ConstType</code>ï¼šä¼šæ£€æŸ¥ <code>IsPad</code> æ ‡å¿—ä½ï¼Œè‹¥ä¸ä¸ºçœŸæ‰ä¼šç»§ç»­</li>
<li><code>BufferType</code> ä¸­çš„ <code>BufferString, BufferGlob</code>ï¼šä¼šæ£€æŸ¥å€¼çš„é•¿åº¦ï¼Œä¸º 0 æ‰ä¼šç»§ç»­</li>
<li>å…¶ä»–çš„ä¸åœ¨å¦‚ä¸‹ä»£ç ä¸­çš„ç±»å‹</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">generateHints</span><span class="hljs-params">(compMap CompMap, arg Arg, exec <span class="hljs-keyword">func</span>()</span></span>) &#123;<br>	typ := arg.Type()<br>	<span class="hljs-keyword">if</span> typ == <span class="hljs-literal">nil</span> || arg.Dir() == DirOut &#123;<br>		<span class="hljs-keyword">return</span><br>	&#125;<br>	<span class="hljs-keyword">switch</span> t := typ.(<span class="hljs-keyword">type</span>) &#123;<br>	<span class="hljs-keyword">case</span> *ProcType:<br>		<span class="hljs-comment">// éšæœºçš„ç¨‹åºä¸ä¼šé€šè¿‡éªŒè¯.</span><br>		<span class="hljs-comment">// æˆ‘ä»¬å¯ä»¥å°†å…¶å˜å¼‚ï¼Œä½†ä»…å½“ç»“æœå€¼åœ¨åˆæ³•èŒƒå›´å†….</span><br>		<span class="hljs-keyword">return</span><br>	<span class="hljs-keyword">case</span> *ConstType:<br>		<span class="hljs-keyword">if</span> IsPad(typ) &#123;<br>			<span class="hljs-keyword">return</span><br>		&#125;<br>	<span class="hljs-keyword">case</span> *CsumType:<br>		<span class="hljs-comment">// Csum å°†ä¸ä¼šé€šè¿‡éªŒè¯ï¼Œä¸”æ€»ä¼šè¢«è®¡ç®—.</span><br>		<span class="hljs-keyword">return</span><br>	<span class="hljs-keyword">case</span> *BufferType:<br>		<span class="hljs-keyword">switch</span> t.Kind &#123;<br>		<span class="hljs-keyword">case</span> BufferFilename:<br>			<span class="hljs-comment">// å…¶å¯ä»¥ç”Ÿæˆé€ƒé€¸è·¯å¾„ï¼Œä¸”é€šå¸¸ä¸ä¼šå¤ªæœ‰ç”¨.</span><br>			<span class="hljs-keyword">return</span><br>		<span class="hljs-keyword">case</span> BufferString, BufferGlob:<br>			<span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(t.Values) != <span class="hljs-number">0</span> &#123;<br>				<span class="hljs-comment">// è¿™äº›é€šå¸¸æ˜¯æ–‡ä»¶åæˆ–å®Œæ•´çš„æšä¸¾ã€‚</span><br>				<span class="hljs-comment">// è‹¥æˆ‘ä»¬æ‹¦æˆª strcmpï¼Œå°†å…¶å˜å¼‚å¯èƒ½æ˜¯æœ‰ç”¨çš„</span><br>				<span class="hljs-comment">// (å¹¶è¿‡æ»¤æ‰æ–‡ä»¶å).</span><br>				<span class="hljs-keyword">return</span><br>			&#125;<br>		&#125;<br>	&#125;<br></code></pre></td></tr></table></figure>

<p> æœ€åä¼šæ ¹æ®å‚æ•°å®é™…çš„å­˜å‚¨ç±»å‹è¿›è¡Œåˆ¤æ–­ï¼š</p>
<ul>
<li>å¯¹äºå¸¸é‡å‚æ•° <code>ConstArg</code> ç±»å‹ä¼šè°ƒç”¨ <code>checkConstArg()</code> å¤„ç†</li>
<li>å¯¹äºæ•°æ®å‚æ•° <code>DataArg</code> ç±»å‹ï¼Œé¦–å…ˆä¼šåˆ¤æ–­æ˜¯å¦ä¸º <code>BufferCompressed</code> ç±»å‹ï¼Œè‹¥æ˜¯åˆ™è°ƒç”¨ <code>checkCompressedArg()</code> ï¼Œå¦åˆ™è°ƒç”¨ <code>checkDataArg()</code> å¤„ç†</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs go">	<span class="hljs-keyword">switch</span> a := arg.(<span class="hljs-keyword">type</span>) &#123;<br>	<span class="hljs-keyword">case</span> *ConstArg:<br>		checkConstArg(a, compMap, exec)<br>	<span class="hljs-keyword">case</span> *DataArg:<br>		<span class="hljs-keyword">if</span> typ.(*BufferType).Kind == BufferCompressed &#123;<br>			checkCompressedArg(a, compMap, exec)<br>		&#125; <span class="hljs-keyword">else</span> &#123;<br>			checkDataArg(a, compMap, exec)<br>		&#125;<br>	&#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>è¿™ä¸‰ä¸ªå‡½æ•°éƒ½ä¼šè°ƒç”¨åˆ° <code>shrinkExpand()</code>ï¼Œæ‰€ä»¥æˆ‘ä»¬å…ˆæ¥çœ‹çœ‹è¿™ä¸ªå‡½æ•°çš„å®ç°ï¼Œè¯¥å‡½æ•°ç”¨ä»¥<strong>ä½¿ç”¨ç»™å®šçš„ CompMap å¯¹å‚æ•°è¿›è¡Œæ›¿æ¢ï¼Œè¿”å›ç»“æœä¸ºå¯ä»¥ç”¨æ¥è¿›è¡Œæ›¿æ¢çš„æ–°å‚æ•°å€¼</strong>ï¼Œå…¶å…·ä½“å®ç°æˆ‘ä»¬å°±ä¸æ·±å…¥äº†ï¼Œè¿™é‡Œæ¥çœ‹æ³¨é‡Šï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// Shrink and expand mutations åœ¨å½“ç³»ç»Ÿè°ƒç”¨å‚æ•°è¢«è½¬åŒ–ä¸ºæ›´ç‹­çª„ï¼ˆä¸æ›´å®½é˜”ï¼‰çš„æ•´å‹ç±»å‹æ—¶</span><br><span class="hljs-comment">// å¯¹è¿™äº›æƒ…å†µè¿›è¡Œå»ºæ¨¡.</span><br><span class="hljs-comment">//</span><br><span class="hljs-comment">// æ”¶ç¼©çš„åŠ¨æœº:</span><br><span class="hljs-comment">//</span><br><span class="hljs-comment">//	void f(u16 x) &#123;</span><br><span class="hljs-comment">//			u8 y = (u8)x;</span><br><span class="hljs-comment">//			if (y == 0xab) &#123;...&#125;</span><br><span class="hljs-comment">//	&#125;</span><br><span class="hljs-comment">//</span><br><span class="hljs-comment">// è‹¥æˆ‘ä»¬è°ƒç”¨ f(0x1234), æˆ‘ä»¬å°†çœ‹åˆ°åœ¨ 0x34 ä¸ 0xab é—´çš„æ¯”è¾ƒï¼Œ</span><br><span class="hljs-comment">// æˆ‘ä»¬å°†æ²¡æ³•å°†å‚æ•° 0x1234 ä¸ä»»ä½•æ¯”è¾ƒæ“ä½œæ•°åŒ¹é….</span><br><span class="hljs-comment">// ç”±æ­¤æˆ‘ä»¬å°† 0x1234 æ”¶ç¼©åˆ° 0x34 å¹¶å°è¯•åŒ¹é… 0x34.</span><br><span class="hljs-comment">// è‹¥å¯¹äºæ”¶ç¼©åçš„å€¼å­˜åœ¨ä¸€ä¸ªåŒ¹é…ï¼Œåˆ™æˆ‘ä»¬æ›¿æ¢è¾“å…¥ä¸­ç›¸åº”çš„å­—èŠ‚</span><br><span class="hljs-comment">//  (åœ¨ç»™å‡ºçš„ä¾‹å­ä¸­æˆ‘ä»¬å°†è·å¾— 0x12ab).</span><br><span class="hljs-comment">// æœ‰çš„æ—¶å€™å…¶ä»–çš„æ¯”è¾ƒæ“ä½œæ•°å°†æ¯”æ”¶ç¼©åçš„å€¼è¦å®½</span><br><span class="hljs-comment">// (åœ¨ä¸Šé¢çš„ä¾‹å­ä¸­è€ƒè™‘æ¯”è¾ƒ if (y == 0xdeadbeef) &#123;...&#125;).</span><br><span class="hljs-comment">// è¿™ç§æƒ…å†µä¸‹æˆ‘ä»¬å¿½ç•¥è¿™æ ·çš„æ¯”è¾ƒå› ä¸ºæˆ‘ä»¬æ— æ³•ç»™å‡ºåšç€ç±»ä¼¼äº‹æƒ…çš„åˆæ³•ä»£ç ğŸŒ°.</span><br><span class="hljs-comment">// ä¸ºäº†é¿å…è¿™æ ·çš„æ¯”è¾ƒï¼Œæˆ‘ä»¬æˆ‘ä»¬ä½¿ç”¨ leastSize() æ£€æŸ¥å…¶ size. </span><br><span class="hljs-comment">//</span><br><span class="hljs-comment">// æ‰©å±•çš„åŠ¨æœº:</span><br><span class="hljs-comment">//</span><br><span class="hljs-comment">//	void f(i8 x) &#123;</span><br><span class="hljs-comment">//			i16 y = (i16)x;</span><br><span class="hljs-comment">//			if (y == -2) &#123;...&#125;</span><br><span class="hljs-comment">//	&#125;</span><br><span class="hljs-comment">//</span><br><span class="hljs-comment">// å‡å¦‚æˆ‘ä»¬è°ƒç”¨ f(-1), æˆ‘ä»¬å°†çœ‹åˆ°åœ¨ 0xffff ä¸ 0xfffe é—´çš„æ¯”è¾ƒï¼Œ</span><br><span class="hljs-comment">// å¹¶æ— æ³•å°†è¾“å…¥ä¸ä»»ä½•æ“ä½œæ•°åŒ¹é…. ç”±æ­¤æˆ‘ä»¬å¯¹è¾“å…¥è¿›è¡Œç¬¦å·æ‰©å±•å¹¶æ£€æŸ¥æ‰©å±•.</span><br><span class="hljs-comment">// ä¸æ”¶ç¼©ä¸€æ ·ï¼Œæˆ‘ä»¬å¿½ç•¥äº†å¦ä¸€ä¸ªæ“ä½œæ•°æ›´å®½çš„æƒ…å†µ.</span><br><span class="hljs-comment">// éœ€è¦æ³¨æ„çš„æ˜¯ executor å°†æ‰€æœ‰çš„æ¯”è¾ƒæ“ä½œæ•°ç¬¦å·æ‰©å±•è‡³ int64.</span><br></code></pre></td></tr></table></figure>

<p>ä¸‹é¢æˆ‘ä»¬æ¥çœ‹è¿™ä¸‰ä¸ª <code>check*Arg()</code> ï¼Œæˆ‘ä»¬é¦–å…ˆçœ‹ç”¨æ¥å¤„ç†å¸¸é‡çš„ <code>checkConstArg()</code>ï¼Œä¸»è¦é€»è¾‘æ˜¯å—²ç”¨ <code>shrinkExpand()</code> å¹¶å¯¹å…¶ç»“æœï¼ˆ<code>CompMap</code> ç±»å‹ï¼‰è¿›è¡Œéå†ï¼Œå°† <code>arg.Val</code> ä¾æ¬¡æ›¿æ¢ä¸ºå…¶æä¾›çš„ replacer å€¼ï¼Œå¹¶è°ƒç”¨ä¸Šå±‚å›è°ƒå‡½æ•°ï¼ˆä¹Ÿå°±æ˜¯ <code>execValidate()</code> ï¼Œé‡Œé¢è¿˜ä¼šè°ƒç”¨ä¸Šå±‚ä¼ å…¥çš„é—­åŒ…å‡½æ•°ï¼Œæœ€åä¼šè°ƒç”¨ <code>proc.execute()</code> ï¼Œä¹Ÿå°±æ˜¯è¯´<strong>å¯¹äº shrinkExpand() æä¾›çš„æ¯ä¸ªæ›¿æ¢ç»“æœå…¶éƒ½ä¼šæ‰§è¡Œä¸€æ¬¡</strong>ï¼‰ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">checkConstArg</span><span class="hljs-params">(arg *ConstArg, compMap CompMap, exec <span class="hljs-keyword">func</span>()</span></span>) &#123;<br>	original := arg.Val<br>	<span class="hljs-comment">// Note: because shrinkExpand returns a map, order of programs is non-deterministic.</span><br>	<span class="hljs-comment">// This can affect test coverage reports.</span><br>	<span class="hljs-keyword">for</span> _, replacer := <span class="hljs-keyword">range</span> shrinkExpand(original, compMap, arg.Type().TypeBitSize(), <span class="hljs-literal">false</span>) &#123;<br>		arg.Val = replacer<br>		exec()<br>	&#125;<br>	arg.Val = original<br>&#125;<br></code></pre></td></tr></table></figure>

<p>æ¥ä¸‹æ¥çœ‹ <code>checkCompressedArg()</code> ï¼Œä¸»è¦å°±æ˜¯å°†æ•°æ®è§£å‹åé€ 4 å­—èŠ‚è¿›è¡Œéå†ï¼Œæ¯æ¬¡éå†æ—¶éƒ½ä¼šå†è°ƒç”¨ <code>shrinkExpand()</code> è·å–å¯æ›¿æ¢å€¼å¹¶å†å¯¹å…¶ç»“æœè¿›è¡Œéå†ï¼Œè°ƒç”¨ä¸Šå±‚ä¼ å…¥çš„é—­åŒ…å‡½æ•°æ‰§è¡Œæ›¿æ¢æ•°æ®åçš„ç¨‹åºï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">checkCompressedArg</span><span class="hljs-params">(arg *DataArg, compMap CompMap, exec <span class="hljs-keyword">func</span>()</span></span>) &#123;<br>	data0 := arg.Data()<br>	data, dtor := image.MustDecompress(data0)<br>	<span class="hljs-keyword">defer</span> dtor()<br>	<span class="hljs-comment">// Images are very large so the generic algorithm for data arguments</span><br>	<span class="hljs-comment">// can produce too many mutants. For images we consider only</span><br>	<span class="hljs-comment">// 4/8-byte aligned ints. This is enough to handle all magic</span><br>	<span class="hljs-comment">// numbers and checksums. We also ignore 0 and ^uint64(0) source bytes,</span><br>	<span class="hljs-comment">// because there are too many of these in lots of images.</span><br>	bytes := <span class="hljs-built_in">make</span>([]<span class="hljs-type">byte</span>, <span class="hljs-number">8</span>)<br>	<span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; <span class="hljs-built_in">len</span>(data); i += <span class="hljs-number">4</span> &#123;<br>		original := <span class="hljs-built_in">make</span>([]<span class="hljs-type">byte</span>, <span class="hljs-number">8</span>)<br>		<span class="hljs-built_in">copy</span>(original, data[i:])<br>		val := binary.LittleEndian.Uint64(original)<br>		<span class="hljs-keyword">for</span> _, replacer := <span class="hljs-keyword">range</span> shrinkExpand(val, compMap, <span class="hljs-number">64</span>, <span class="hljs-literal">true</span>) &#123;<br>			binary.LittleEndian.PutUint64(bytes, replacer)<br>			<span class="hljs-built_in">copy</span>(data[i:], bytes)<br>			arg.SetData(image.Compress(data))<br>			exec()<br>		&#125;<br>		<span class="hljs-built_in">copy</span>(data[i:], original)<br>	&#125;<br>	arg.SetData(data0)<br>&#125;<br></code></pre></td></tr></table></figure>

<p><code>checkDataArg()</code> é€»è¾‘åŸºæœ¬ä¸Šä¸ <code>checkCompressedArg()</code> ä¸€è‡´ï¼Œä¸è¿‡æ˜¯é€å­—èŠ‚éå†ä¸”æ²¡æœ‰è§£å‹è¿‡ç¨‹ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">checkDataArg</span><span class="hljs-params">(arg *DataArg, compMap CompMap, exec <span class="hljs-keyword">func</span>()</span></span>) &#123;<br>	bytes := <span class="hljs-built_in">make</span>([]<span class="hljs-type">byte</span>, <span class="hljs-number">8</span>)<br>	data := arg.Data()<br>	size := <span class="hljs-built_in">len</span>(data)<br>	<span class="hljs-keyword">if</span> size &gt; maxDataLength &#123;<br>		size = maxDataLength<br>	&#125;<br>	<span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; size; i++ &#123;<br>		original := <span class="hljs-built_in">make</span>([]<span class="hljs-type">byte</span>, <span class="hljs-number">8</span>)<br>		<span class="hljs-built_in">copy</span>(original, data[i:])<br>		val := binary.LittleEndian.Uint64(original)<br>		<span class="hljs-keyword">for</span> _, replacer := <span class="hljs-keyword">range</span> shrinkExpand(val, compMap, <span class="hljs-number">64</span>, <span class="hljs-literal">false</span>) &#123;<br>			binary.LittleEndian.PutUint64(bytes, replacer)<br>			<span class="hljs-built_in">copy</span>(data[i:], bytes)<br>			exec()<br>		&#125;<br>		<span class="hljs-built_in">copy</span>(data[i:], original)<br>	&#125;<br>&#125;<br></code></pre></td></tr></table></figure>



<h4 id="proc-executeAndCollide-ï¼šç®€æ˜“çš„å˜å¼‚æ‰§è¡Œï¼š"><a href="#proc-executeAndCollide-ï¼šç®€æ˜“çš„å˜å¼‚æ‰§è¡Œï¼š" class="headerlink" title="proc.executeAndCollide()ï¼šç®€æ˜“çš„å˜å¼‚æ‰§è¡Œï¼š"></a>proc.executeAndCollide()ï¼šç®€æ˜“çš„å˜å¼‚æ‰§è¡Œï¼š</h4><p>è¯¥å‡½æ•°çš„é€»è¾‘æ¯”è¾ƒç®€å•ï¼Œé¦–å…ˆä¼šå°†ç¨‹åºæ‰§è¡Œä¸€æ¬¡ï¼Œä¹‹åå¾ªç¯æ‰§è¡Œä¸¤æ¬¡ï¼Œä¸è¿‡ä¼šè°ƒç”¨ <code>proc.randomCollide()</code> å…ˆå°†åŸå§‹ç¨‹åºè¿›è¡Œå¤„ç†åå†æ‰§è¡Œï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(proc *Proc)</span></span> executeAndCollide(execOpts *ipc.ExecOpts, p *prog.Prog, flags ProgTypes, stat Stat) &#123;<br>	proc.execute(execOpts, p, flags, stat)<br><br>	<span class="hljs-keyword">if</span> proc.execOptsCollide.Flags&amp;ipc.FlagThreaded == <span class="hljs-number">0</span> &#123;<br>		<span class="hljs-comment">// We cannot collide syscalls without being in the threaded mode.</span><br>		<span class="hljs-keyword">return</span><br>	&#125;<br>	<span class="hljs-keyword">const</span> collideIterations = <span class="hljs-number">2</span><br>	<span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; collideIterations; i++ &#123;<br>		proc.executeRaw(proc.execOptsCollide, proc.randomCollide(p), StatCollide)<br>	&#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p><code>randomCollide()</code> æµç¨‹å¦‚ä¸‹ï¼š</p>
<ul>
<li>é¦–å…ˆä¼šæœ‰ 20% çš„å‡ ç‡è°ƒç”¨ <code>prog.DoubleExecCollide()</code> ï¼ˆæŠŠæºç¨‹åºæ‹·è´ä¸€ä»½é™„åŠ åˆ°å…¶è‡ªèº«çš„æœ«ï¼Œå¹¶ä½¿ç”¨ç¬¬ä¸€éƒ¨åˆ†çš„èµ„æºï¼‰ï¼Œè‹¥æœªå‡ºé”™åˆ™ç›´æ¥è¿”å›</li>
<li>æ¥ä¸‹æ¥æœ‰ 20% çš„å‡ ç‡è°ƒç”¨ <code>prog.DupCallCollide()</code> ï¼ˆå°†ç¨‹åºä¸­çš„éƒ¨åˆ†è°ƒç”¨è¿›è¡Œå¤åˆ¶å¹¶æ ‡è®°ä¸ºå¼‚æ­¥ï¼‰ï¼Œè‹¥æœªå‡ºé”™åˆ™ç›´æ¥è¿”å›</li>
<li>æœ€åä¼šè°ƒç”¨ <code>prog.AssignRandomAsync()</code> ï¼ˆç¡®ä¿ä½¿ç”¨ä¸€ä¸ªå¼‚æ­¥è°ƒç”¨ç”Ÿäº§çš„èµ„æºçš„è°ƒç”¨ä¸å…¶è‡³å°‘é—´éš”ä¸€ä¸ªéå¼‚æ­¥è°ƒç”¨ï¼‰å¹¶æœ‰ 50% çš„å‡ ç‡è°ƒç”¨ <code>prog.AssignRandomRerun()</code>ï¼š</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs go"><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(proc *Proc)</span></span> randomCollide(origP *prog.Prog) *prog.Prog &#123;<br>	<span class="hljs-keyword">if</span> proc.rnd.Intn(<span class="hljs-number">5</span>) == <span class="hljs-number">0</span> &#123;<br>		<span class="hljs-comment">// Old-style collide with a 20% probability.</span><br>		p, err := prog.DoubleExecCollide(origP, proc.rnd)<br>		<span class="hljs-keyword">if</span> err == <span class="hljs-literal">nil</span> &#123;<br>			<span class="hljs-keyword">return</span> p<br>		&#125;<br>	&#125;<br>	<span class="hljs-keyword">if</span> proc.rnd.Intn(<span class="hljs-number">4</span>) == <span class="hljs-number">0</span> &#123;<br>		<span class="hljs-comment">// Duplicate random calls with a 20% probability (25% * 80%).</span><br>		p, err := prog.DupCallCollide(origP, proc.rnd)<br>		<span class="hljs-keyword">if</span> err == <span class="hljs-literal">nil</span> &#123;<br>			<span class="hljs-keyword">return</span> p<br>		&#125;<br>	&#125;<br>	p := prog.AssignRandomAsync(origP, proc.rnd)<br>	<span class="hljs-keyword">if</span> proc.rnd.Intn(<span class="hljs-number">2</span>) != <span class="hljs-number">0</span> &#123;<br>		prog.AssignRandomRerun(p, proc.rnd)<br>	&#125;<br>	<span class="hljs-keyword">return</span> p<br>&#125;<br></code></pre></td></tr></table></figure>



<h2 id="ç”Ÿæˆæ–°è¾“å…¥-å˜å¼‚ç°æœ‰è¾“å…¥ï¼Œæ‰§è¡Œ"><a href="#ç”Ÿæˆæ–°è¾“å…¥-å˜å¼‚ç°æœ‰è¾“å…¥ï¼Œæ‰§è¡Œ" class="headerlink" title="ç”Ÿæˆæ–°è¾“å…¥&#x2F;å˜å¼‚ç°æœ‰è¾“å…¥ï¼Œæ‰§è¡Œ"></a>ç”Ÿæˆæ–°è¾“å…¥&#x2F;å˜å¼‚ç°æœ‰è¾“å…¥ï¼Œæ‰§è¡Œ</h2><p>ç»§ç»­å›åˆ° <code>loop()</code> çš„æ— é™å¾ªç¯ä¸­ï¼Œå¦‚æœè¯´å…¨å±€ <code>WorkQueue</code> ç©ºäº†ï¼Œè¯´æ˜è¿™ä¸ªæ—¶å€™æˆ‘ä»¬è¦è‡ªå·±æƒ³åŠæ³•å¼„æ–°çš„è¾“å…¥äº†ï¼Œé¦–å…ˆæˆ‘ä»¬è¦è·å– syz-fuzzer å½“å‰çš„å¿«ç…§ï¼ˆå…¶ä¸­åŒ…æ‹¬è¯­æ–™åº“ã€è¯­æ–™åº“æƒé‡å€¼ã€æ€»çš„æƒé‡å€¼ï¼‰ï¼Œä¹‹åè¿›è¡Œåˆ¤æ–­ï¼š</p>
<ul>
<li>è‹¥è¯­æ–™åº“ä¸ºç©ºï¼Œæˆ–æ˜¯å·²ç»è¿›è¡Œäº† <code>generatePeriod</code> æ¬¡å¾ªç¯ï¼Œæ­¤æ—¶è°ƒç”¨ <code>target.Generate()</code> ç”Ÿæˆæ–°çš„è¾“å…¥ç¨‹åº</li>
<li>å¦åˆ™ï¼Œé€‰æ‹©ä¸€ä»½ç°æœ‰çš„è¾“å…¥ï¼Œè°ƒç”¨ <code>prog.Mutate()</code> å°†è¯¥è¾“å…¥è¿›è¡Œå˜å¼‚ï¼Œç”Ÿæˆæ–°çš„è¾“å…¥</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs go">		ct := proc.fuzzer.choiceTable<br>		fuzzerSnapshot := proc.fuzzer.snapshot()<br>		<span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(fuzzerSnapshot.corpus) == <span class="hljs-number">0</span> || i%generatePeriod == <span class="hljs-number">0</span> &#123;<br>			<span class="hljs-comment">// Generate a new prog.</span><br>			p := proc.fuzzer.target.Generate(proc.rnd, prog.RecommendedCalls, ct)<br>			log.Logf(<span class="hljs-number">1</span>, <span class="hljs-string">&quot;#%v: generated&quot;</span>, proc.pid)<br>			proc.executeAndCollide(proc.execOpts, p, ProgNormal, StatGenerate)<br>		&#125; <span class="hljs-keyword">else</span> &#123;<br>			<span class="hljs-comment">// Mutate an existing prog.</span><br>			p := fuzzerSnapshot.chooseProgram(proc.rnd).Clone()<br>			p.Mutate(proc.rnd, prog.RecommendedCalls, ct, proc.fuzzer.noMutate, fuzzerSnapshot.corpus)<br>			log.Logf(<span class="hljs-number">1</span>, <span class="hljs-string">&quot;#%v: mutated&quot;</span>, proc.pid)<br>			proc.executeAndCollide(proc.execOpts, p, ProgNormal, StatFuzz)<br>		&#125;<br>	&#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="ã€æ ¸å¿ƒã€‘target-Generate-ï¼šç”Ÿæˆä¸€ä¸ªæ–°çš„è¾“å…¥ç¨‹åº"><a href="#ã€æ ¸å¿ƒã€‘target-Generate-ï¼šç”Ÿæˆä¸€ä¸ªæ–°çš„è¾“å…¥ç¨‹åº" class="headerlink" title="ã€æ ¸å¿ƒã€‘target.Generate()ï¼šç”Ÿæˆä¸€ä¸ªæ–°çš„è¾“å…¥ç¨‹åº"></a>ã€æ ¸å¿ƒã€‘target.Generate()ï¼šç”Ÿæˆä¸€ä¸ªæ–°çš„è¾“å…¥ç¨‹åº</h3><p>è¯¥å‡½æ•°æœ¬ä½“å…¶å®æ¯”è¾ƒç®€çŸ­ï¼Œä¸»è¦å°±æ˜¯éšæœºç”ŸæˆæŒ‡å®šæ•°é‡çš„ç³»ç»Ÿè°ƒç”¨å¹¶æ‰“åŒ…åˆ°ä¸€ä¸ªæ–°çš„ <code>Prog</code> ç»“æ„ä½“å½“ä¸­ï¼Œç”Ÿæˆçš„ä¾æ®ä¸»è¦æ˜¯æˆ‘ä»¬å‰é¢ç»™å‡ºçš„ <code>ChoiceTable</code> è¡¨ï¼Œæœ€åç§»é™¤ç¨‹åºæœ«å°¾å¤šä½™çš„ç³»ç»Ÿè°ƒç”¨ä¾¿ç›´æ¥è¿”å›äº†ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// Generate ç”Ÿæˆä¸€ä¸ªå¸¦æœ‰ ncalls ä¸ªè°ƒç”¨çš„éšæœºç¨‹åº.</span><br><span class="hljs-comment">// ct åŒ…å«ä¸€ç»„å…è®¸çš„ç³»ç»Ÿè°ƒç”¨, è‹¥ä¸º nil åˆ™å°†ä½¿ç”¨æ‰€æœ‰çš„ç³»ç»Ÿè°ƒç”¨.</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(target *Target)</span></span> Generate(rs rand.Source, ncalls <span class="hljs-type">int</span>, ct *ChoiceTable) *Prog &#123;<br>	p := &amp;Prog&#123;<br>		Target: target,<br>	&#125;<br>	r := newRand(target, rs)<br>	s := newState(target, ct, <span class="hljs-literal">nil</span>)<br>	<span class="hljs-keyword">for</span> <span class="hljs-built_in">len</span>(p.Calls) &lt; ncalls &#123;<br>		calls := r.generateCall(s, p, <span class="hljs-built_in">len</span>(p.Calls))<br>		<span class="hljs-keyword">for</span> _, c := <span class="hljs-keyword">range</span> calls &#123;<br>			s.analyze(c)<br>			p.Calls = <span class="hljs-built_in">append</span>(p.Calls, c)<br>		&#125;<br>	&#125;<br>	<span class="hljs-comment">// å¯¹äºç”Ÿæˆçš„æœ€åä¸€ä¸ªè°ƒç”¨è€Œè¨€ï¼Œæˆ‘ä»¬æœ‰å¯èƒ½åœ¨åˆ›é€ èµ„æºçš„åŒæ—¶å¢åŠ é¢å¤–çš„ç³»ç»Ÿè°ƒç”¨ï¼Œ</span><br>	<span class="hljs-comment">// ä»è€Œå¯¼è‡´è°ƒç”¨æ•°é‡è¶…è¿‡ ncallsã€‚ç§»é™¤éƒ¨åˆ†è°ƒç”¨ã€‚</span><br>    <span class="hljs-comment">/* è¯‘æ³¨ï¼šä¾‹å¦‚ read éœ€è¦ä¸€ä¸ª fdï¼Œé‚£å¯èƒ½å‰é¢ä¼šå†è¡¥ä¸€ä¸ª open */</span><br>	<span class="hljs-comment">// åœ¨æœ€åçš„è°ƒç”¨ä¸­çš„èµ„æºä¼šè¢«æ›¿æ¢ä¸ºé»˜è®¤å€¼,è¿™ä¾¿æ˜¯æˆ‘ä»¬æ‰€æƒ³è¦çš„ã€‚</span><br>	<span class="hljs-keyword">for</span> <span class="hljs-built_in">len</span>(p.Calls) &gt; ncalls &#123;<br>		p.RemoveCall(ncalls - <span class="hljs-number">1</span>)<br>	&#125;<br>	p.sanitizeFix()<br>	p.debugValidate()<br>	<span class="hljs-keyword">return</span> p<br>&#125;<br><br></code></pre></td></tr></table></figure>

<p>ç”Ÿæˆå•ä¸ªç³»ç»Ÿè°ƒç”¨çš„æ ¸å¿ƒå‡½æ•°æ˜¯ <code>generateCall()</code>ï¼š</p>
<ul>
<li>é¦–å…ˆä¼šæ£€æŸ¥ <code>insertPoint</code> æ˜¯å¦ä¸ä¸º 0ï¼ˆä¸º 0 åˆ™è¯´æ˜åˆšå¼€å§‹ç”Ÿæˆç¬¬ä¸€ä¸ªç³»ç»Ÿè°ƒç”¨ï¼‰ï¼Œè‹¥æ˜¯åˆ™éšæœºé€‰å–ç¨‹åºä¸­å·²æœ‰çš„ä¸€ä¸ªè°ƒç”¨ï¼Œè‹¥å…¶æœªè®¾ç½® <code>NoGenerate</code> å±æ€§åˆ™å°†å…¶ id ï¼ˆç³»ç»Ÿè°ƒç”¨å·ï¼‰ä½œä¸º <code>biasCall</code>ï¼Œå³<strong>ç”Ÿæˆçš„ç¬¬ä¸€ä¸ªç³»ç»Ÿè°ƒç”¨å®Œå…¨éšæœºï¼Œåç»­ç³»ç»Ÿè°ƒç”¨åˆ™æ ¹æ®ä¼˜å…ˆçº§è¡¨è¿›è¡Œç”Ÿæˆ</strong></li>
<li>æ¥ä¸‹æ¥è°ƒç”¨ ChoiceTable çš„ <code>choose</code> æ–¹æ³•ï¼Œå¯¹äºç¬¬ä¸€ä¸ªç³»ç»Ÿè°ƒç”¨è€Œè¨€å…¶ä¼šä» ChoiceTable ä¸­éšæœºé€‰å–ä¸€ä¸ªç³»ç»Ÿè°ƒç”¨ä½œä¸º <code>biasCall</code>ï¼Œæ¥ä¸‹æ¥ä»ä¼˜å…ˆçº§è¡¨ä¸­é€‰å– <code>biasCall</code> å¯¹åº”çš„ä¼˜å…ˆçº§æ•°æ®ï¼Œä»ä¸­éšæœºé€‰å–ä¸€ä¸ªèŒƒå›´ä¸­ä¼˜å…ˆçº§æœ€é«˜çš„ä¸€ä¸ªè¿”å›</li>
<li>æœ€åè°ƒç”¨ <code>generateParticularCall()</code> ç”Ÿæˆè¯¥ç³»ç»Ÿè°ƒç”¨æ‰€è¦ç”¨åˆ°çš„æ•°æ®ï¼Œè¿™é‡Œå°±ä¸å±•å¼€äº†</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(ct *ChoiceTable)</span></span> choose(r *rand.Rand, bias <span class="hljs-type">int</span>) <span class="hljs-type">int</span> &#123;<br>	<span class="hljs-keyword">if</span> bias &lt; <span class="hljs-number">0</span> &#123;	<span class="hljs-comment">/* ç¬¬ä¸€ä¸ªç³»ç»Ÿè°ƒç”¨ï¼Œéšæœºé€‰æ‹© */</span><br>		bias = ct.calls[r.Intn(<span class="hljs-built_in">len</span>(ct.calls))].ID<br>	&#125;<br>	<span class="hljs-keyword">if</span> !ct.Generatable(bias) &#123;<br>		fmt.Printf(<span class="hljs-string">&quot;bias to disabled or non-generatable syscall %v\n&quot;</span>, ct.target.Syscalls[bias].Name)<br>		<span class="hljs-built_in">panic</span>(<span class="hljs-string">&quot;disabled or non-generatable syscall&quot;</span>)<br>	&#125;<br>	run := ct.runs[bias]<br>	x := <span class="hljs-type">int32</span>(r.Intn(<span class="hljs-type">int</span>(run[<span class="hljs-built_in">len</span>(run)<span class="hljs-number">-1</span>])) + <span class="hljs-number">1</span>)	<span class="hljs-comment">/* é€‰æ‹©ä¼˜å…ˆçº§èŒƒå›´ */</span><br>	res := sort.Search(<span class="hljs-built_in">len</span>(run), <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(i <span class="hljs-type">int</span>)</span></span> <span class="hljs-type">bool</span> &#123;<br>		<span class="hljs-keyword">return</span> run[i] &gt;= x<br>	&#125;)<br>	<span class="hljs-keyword">if</span> !ct.Generatable(res) &#123;<br>		<span class="hljs-built_in">panic</span>(<span class="hljs-string">&quot;selected disabled or non-generatable syscall&quot;</span>)<br>	&#125;<br>	<span class="hljs-keyword">return</span> res<br>&#125;<br><br><span class="hljs-comment">// ...</span><br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(r *randGen)</span></span> generateCall(s *state, p *Prog, insertionPoint <span class="hljs-type">int</span>) []*Call &#123;<br>	biasCall := <span class="hljs-number">-1</span><br>	<span class="hljs-keyword">if</span> insertionPoint &gt; <span class="hljs-number">0</span> &#123;<br>		<span class="hljs-comment">// Choosing the base call is based on the insertion point of the new calls sequence.</span><br>		insertionCall := p.Calls[r.Intn(insertionPoint)].Meta<br>		<span class="hljs-keyword">if</span> !insertionCall.Attrs.NoGenerate &#123;<br>			<span class="hljs-comment">// We must be careful not to bias towards a non-generatable call.</span><br>			biasCall = insertionCall.ID<br>		&#125;<br>	&#125;<br>	idx := s.ct.choose(r.Rand, biasCall)<br>	meta := r.target.Syscalls[idx]<br>	<span class="hljs-keyword">return</span> r.generateParticularCall(s, meta)<br>&#125;<br></code></pre></td></tr></table></figure>



<h3 id="ã€æ ¸å¿ƒã€‘prog-Mutate-ï¼šå˜å¼‚ä¸€ä¸ªè¾“å…¥ç¨‹åº"><a href="#ã€æ ¸å¿ƒã€‘prog-Mutate-ï¼šå˜å¼‚ä¸€ä¸ªè¾“å…¥ç¨‹åº" class="headerlink" title="ã€æ ¸å¿ƒã€‘prog.Mutate()ï¼šå˜å¼‚ä¸€ä¸ªè¾“å…¥ç¨‹åº"></a>ã€æ ¸å¿ƒã€‘prog.Mutate()ï¼šå˜å¼‚ä¸€ä¸ªè¾“å…¥ç¨‹åº</h3><p>è¯¥å‡½æ•°çš„æ ¸å¿ƒå…¶å®æ˜¯ä¸€ä¸ª<strong>éšæœºå˜å¼‚</strong>çš„å¾ªç¯ï¼Œè¿™é‡Œçš„å˜é‡ <code>r</code> ä¸ºä¸€ä¸ªéšæœºæ•°ç”Ÿæˆå™¨ï¼š</p>
<ul>
<li>ç”Ÿæˆä¸€ä¸ª <code>[0, 5)</code> ä¹‹é—´çš„éšæœºæ•°ï¼Œè‹¥ä¸º 0 åˆ™æ‰§è¡Œ <code>mutator.squashAny()</code> </li>
<li>ä¸Šä¸€æ¡æœªå‘½ä¸­ï¼Œåˆ™ç”Ÿæˆä¸€ä¸ª  <code>[0, 100)</code> é—´éšæœºæ•°ï¼Œè‹¥ &gt;&#x3D; 1 åˆ™æ‰§è¡Œ <code>mutator.splice()</code></li>
<li>ä¸Šä¸€æ¡æœªå‘½ä¸­ï¼Œåˆ™ç”Ÿæˆä¸€ä¸ª <code> [0, 31)</code> é—´éšæœºæ•°ï¼Œè‹¥ &gt;&#x3D; 20 åˆ™æ‰§è¡Œ <code>mutator.insertCall()</code></li>
<li>ä¸Šä¸€æ¡æœªå‘½ä¸­ï¼Œåˆ™ç”Ÿæˆä¸€ä¸ª <code>[0, 11)</code> é—´éšæœºæ•°ï¼Œè‹¥ &gt;&#x3D; 10 åˆ™æ‰§è¡Œ <code>mutateArg()</code></li>
<li>çš†æœªå‘½ä¸­ï¼Œæ‰§è¡Œ <code>mutator.removeCall()</code></li>
</ul>
<p>ç»ˆæ­¢å¾ªç¯çš„æ¡ä»¶æ˜¯ <code>ä¸Šè¿°å˜å¼‚æ“ä½œä¹‹ä¸€æˆåŠŸæ‰§è¡Œ &amp; ç³»ç»Ÿè°ƒç”¨æ•°ä¸ä¸º 0</code> ï¼Œæ­¤å¤–è¿˜æœ‰ 2&#x2F;3 çš„æ¦‚ç‡é‡æ–°è¿›å…¥å¾ªç¯</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// Mutate program p.</span><br><span class="hljs-comment">//</span><br><span class="hljs-comment">// p:           è¦å˜å¼‚çš„ç¨‹åº.</span><br><span class="hljs-comment">// rs:          éšæœºæ•°èµ„æºæ± .</span><br><span class="hljs-comment">// ncalls:      å˜å¼‚åç¨‹åºä¸­å…è®¸çš„æœ€å¤§è°ƒç”¨æ•°é‡.</span><br><span class="hljs-comment">// ct:          ç³»ç»Ÿè°ƒç”¨çš„ ChoiceTable.</span><br><span class="hljs-comment">// noMutate:    ä¸€ç»„ä¸è¯¥è¢«å˜å¼‚çš„ç³»ç»Ÿè°ƒç”¨çš„ ID é›†åˆ.</span><br><span class="hljs-comment">// corpus:      åŒ…æ‹¬åŸå§‹ç¨‹åº p çš„æ•´ä¸ªè¯­æ–™åº“.</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(p *Prog)</span></span> Mutate(rs rand.Source, ncalls <span class="hljs-type">int</span>, ct *ChoiceTable, noMutate <span class="hljs-keyword">map</span>[<span class="hljs-type">int</span>]<span class="hljs-type">bool</span>, corpus []*Prog) &#123;<br>	r := newRand(p.Target, rs)<br>	<span class="hljs-keyword">if</span> ncalls &lt; <span class="hljs-built_in">len</span>(p.Calls) &#123;<br>		ncalls = <span class="hljs-built_in">len</span>(p.Calls)<br>	&#125;<br>	ctx := &amp;mutator&#123;<br>		p:        p,<br>		r:        r,<br>		ncalls:   ncalls,<br>		ct:       ct,<br>		noMutate: noMutate,<br>		corpus:   corpus,<br>	&#125;<br>	<span class="hljs-keyword">for</span> stop, ok := <span class="hljs-literal">false</span>, <span class="hljs-literal">false</span>; !stop; stop = ok &amp;&amp; <span class="hljs-built_in">len</span>(p.Calls) != <span class="hljs-number">0</span> &amp;&amp; r.oneOf(<span class="hljs-number">3</span>) &#123;<br>		<span class="hljs-keyword">switch</span> &#123;<br>		<span class="hljs-keyword">case</span> r.oneOf(<span class="hljs-number">5</span>):<br>			<span class="hljs-comment">// Not all calls have anything squashable,</span><br>			<span class="hljs-comment">// so this has lower priority in reality.</span><br>			ok = ctx.squashAny()<br>		<span class="hljs-keyword">case</span> r.nOutOf(<span class="hljs-number">1</span>, <span class="hljs-number">100</span>):<br>			ok = ctx.splice()<br>		<span class="hljs-keyword">case</span> r.nOutOf(<span class="hljs-number">20</span>, <span class="hljs-number">31</span>):<br>			ok = ctx.insertCall()<br>		<span class="hljs-keyword">case</span> r.nOutOf(<span class="hljs-number">10</span>, <span class="hljs-number">11</span>):<br>			ok = ctx.mutateArg()<br>		<span class="hljs-keyword">default</span>:<br>			ok = ctx.removeCall()<br>		&#125;<br>	&#125;<br>	p.sanitizeFix()<br>	p.debugValidate()<br>	<span class="hljs-keyword">if</span> got := <span class="hljs-built_in">len</span>(p.Calls); got &lt; <span class="hljs-number">1</span> || got &gt; ncalls &#123;<br>		<span class="hljs-built_in">panic</span>(fmt.Sprintf(<span class="hljs-string">&quot;bad number of calls after mutation: %v, want [1, %v]&quot;</span>, got, ncalls))<br>	&#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>æ¥ä¸‹æ¥æˆ‘ä»¬æ¥çœ‹è¿™äº”ä¸ªä¸åŒçš„å˜å¼‚æ–¹æ¡ˆ</p>
<h4 id="mutator-squashAny-ï¼šéšæœºå˜å¼‚ä¸€ä¸ªç³»ç»Ÿè°ƒç”¨çš„å‚æ•°"><a href="#mutator-squashAny-ï¼šéšæœºå˜å¼‚ä¸€ä¸ªç³»ç»Ÿè°ƒç”¨çš„å‚æ•°" class="headerlink" title="mutator.squashAny()ï¼šéšæœºå˜å¼‚ä¸€ä¸ªç³»ç»Ÿè°ƒç”¨çš„å‚æ•°"></a>mutator.squashAny()ï¼šéšæœºå˜å¼‚ä¸€ä¸ªç³»ç»Ÿè°ƒç”¨çš„å‚æ•°</h4><p>è¯¥å‡½æ•°ä¸€å¼€å§‹ä¼šè°ƒç”¨ <code>Prog.complexPtr()</code>ï¼Œå…¶ä¸­ä¸»è¦ä¼šè°ƒç”¨ <code>ForEachArg()</code> éå†ç”¨ä¾‹ç¨‹åºçš„å‚æ•°</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// é€‰æ‹©ä¸€ä¸ªéšæœºçš„å¤æ‚æŒ‡é’ˆå¹¶å°†å…¶å‚æ•°å˜ä¸º ANY.</span><br><span class="hljs-comment">// ä¹‹åï¼Œè‹¥ ANY ä¸­åŒ…å«æœ‰ blobï¼Œå˜å¼‚ä¸€ä¸ªéšæœºçš„ blob.</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(ctx *mutator)</span></span> squashAny() <span class="hljs-type">bool</span> &#123;<br>	p, r := ctx.p, ctx.r<br>	complexPtrs := p.complexPtrs()<br></code></pre></td></tr></table></figure>

<p>ä¼ å…¥ç»™ <code>ForEachArg()</code> çš„å›è°ƒå‡½æ•°ä¸»è¦è°ƒç”¨ <code>isComplexPtr()</code> åˆ¤æ–­æ¯ä¸ªè°ƒç”¨çš„å‚æ•°ä¸­æ˜¯å¦å­˜åœ¨å¤æ‚æŒ‡é’ˆï¼ˆå¤šçº§æŒ‡é’ˆï¼‰ï¼Œè‹¥æ˜¯ï¼Œåˆ™å°†è¯¥è°ƒç”¨æ·»åŠ åˆ°ä½œä¸ºè¿”å›å€¼çš„æ•°ç»„ä¸­ï¼Œ<strong>å³è¿™ä¸ªå‡½æ•°å…¶å®ä¸»è¦æ˜¯é’ˆå¯¹å¤šçº§æŒ‡é’ˆçš„å˜å¼‚</strong>ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(p *Prog)</span></span> complexPtrs() (res []complexPtr) &#123;<br>	<span class="hljs-keyword">for</span> _, c := <span class="hljs-keyword">range</span> p.Calls &#123;<br>		ForeachArg(c, <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(arg Arg, ctx *ArgCtx)</span></span> &#123;<br>			<span class="hljs-keyword">if</span> ptrArg, ok := arg.(*PointerArg); ok &amp;&amp; p.Target.isComplexPtr(ptrArg) &#123;<br>				res = <span class="hljs-built_in">append</span>(res, complexPtr&#123;ptrArg, c&#125;)<br>				ctx.Stop = <span class="hljs-literal">true</span><br>			&#125;<br>		&#125;)<br>	&#125;<br>	<span class="hljs-keyword">return</span><br>&#125;<br></code></pre></td></tr></table></figure>

<p>æ¥ä¸‹æ¥ä¼šä»è¿”å›åˆ—è¡¨ä¸­éšæœºé€‰æ‹©ä¸€ä¸ªæŒ‡é’ˆï¼Œè‹¥å…¶å¯¹åº”çš„è°ƒç”¨ä¸å…è®¸å˜å¼‚åˆ™ç›´æ¥è¿”å›ï¼Œè‹¥éæŒ‡é’ˆåˆ™è°ƒç”¨ <code>squashPtr()</code> </p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs go">ptr := complexPtrs[r.Intn(<span class="hljs-built_in">len</span>(complexPtrs))]<br><span class="hljs-keyword">if</span> ctx.noMutate[ptr.call.Meta.ID] &#123;<br>	<span class="hljs-keyword">return</span> <span class="hljs-literal">false</span><br>&#125;<br><span class="hljs-keyword">if</span> !p.Target.isAnyPtr(ptr.arg.Type()) &#123;<br>	p.Target.squashPtr(ptr.arg)<br>&#125;<br></code></pre></td></tr></table></figure>

<p>æ¥ä¸‹æ¥ä¼šè°ƒç”¨ <code>ForEachSubArg()</code>ï¼ˆæœ¬è´¨ä¸Šä¸º <code>ForEachArgImpl()</code> çš„å°è£…ï¼‰ï¼Œå¯¹ä¹‹å‰éšæœºé€‰å–çš„ç³»ç»Ÿè°ƒç”¨çš„å‚æ•°è¿›è¡Œéå†ï¼Œè¿™é‡Œä¼ å…¥çš„å›è°ƒå‡½æ•°ä¸»è¦æ˜¯æ£€æŸ¥ <code>arg.Dir()</code> æ˜¯å¦ä¸º <code>DirOut</code>ï¼Œè‹¥æ²¡æœ‰ä¸€ä¸ªå‚æ•°ç¬¦åˆåˆ™ç›´æ¥è¿”å› <code>false</code></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">var</span> blobs []*DataArg<br><span class="hljs-keyword">var</span> bases []*PointerArg<br>ForeachSubArg(ptr.arg, <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(arg Arg, ctx *ArgCtx)</span></span> &#123;<br>	<span class="hljs-keyword">if</span> data, ok := arg.(*DataArg); ok &amp;&amp; arg.Dir() != DirOut &#123;<br>		blobs = <span class="hljs-built_in">append</span>(blobs, data)<br>		bases = <span class="hljs-built_in">append</span>(bases, ctx.Base)<br>	&#125;<br>&#125;)<br><span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(blobs) == <span class="hljs-number">0</span> &#123;<br>	<span class="hljs-keyword">return</span> <span class="hljs-literal">false</span><br>&#125;<br></code></pre></td></tr></table></figure>

<p>æœ€åä¸€éƒ¨åˆ†ä¸»è¦æ˜¯è°ƒç”¨ <code>analyze()</code> è¿›è¡Œåˆ†æï¼Œä¹‹åè°ƒç”¨ <code>mutateData()</code> æ¥å¯¹å‚æ•°çš„æ•°æ®è¿›è¡Œå˜å¼‚ï¼Œä»¥åŠå¯¹æŒ‡é’ˆçš„æ›´æ–°</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs go">	<span class="hljs-comment">// æ³¨æ„: æˆ‘ä»¬éœ€è¦åœ¨å˜å¼‚ä¹‹å‰è°ƒç”¨ analyze.</span><br>	<span class="hljs-comment">// åœ¨å˜å¼‚åå…¶å¯ä»¥å¢é•¿åˆ°è¶…è¿‡æ•°æ®åŒºåŸŸçš„èŒƒå›´ï¼Œ</span><br>	<span class="hljs-comment">// åœ¨æ ‡è®°ç°æœ‰åˆ†é…æ—¶ analyze å°†ä¸º OOB è®¿é—®å´©æºƒ.</span><br>	s := analyze(ctx.ct, ctx.corpus, p, ptr.call)<br>	<span class="hljs-comment">// TODO(dvyukov): æˆ‘ä»¬å¯èƒ½æƒ³è¦ä¸º ANY å¼„ä¸€ä¸ªç‰¹åˆ«çš„å˜å¼‚.</span><br>	<span class="hljs-comment">// ä¾‹å¦‚ï¼Œåˆå¹¶ç›¸é‚»çš„ ANYBLOBs (æˆ‘ä»¬å¹¶ä¸åˆ›é€ ä»–ä»¬,</span><br>	<span class="hljs-comment">// ä½†ä»–ä»¬èƒ½åœ¨å°†æ¥å‡ºç°); æˆ–æ˜¯ç”¨ä¸€ä¸ª blob æ›¿ä»£ ANYRES</span><br>	<span class="hljs-comment">// (å¹¶ä½¿ç”¨ç›¸é‚»çš„ blobs å°†å…¶åˆå¹¶).</span><br>	idx := r.Intn(<span class="hljs-built_in">len</span>(blobs))<br>	arg := blobs[idx]<br>	base := bases[idx]<br>	baseSize := base.Res.Size()<br>	arg.data = mutateData(r, arg.Data(), <span class="hljs-number">0</span>, maxBlobLen)<br>	<span class="hljs-comment">// è‹¥ size å˜å¤§äº†åˆ™æ›´æ–°åŸºæŒ‡é’ˆ.</span><br>	<span class="hljs-keyword">if</span> baseSize &lt; base.Res.Size() &#123;<br>		newArg := r.allocAddr(s, base.Type(), base.Dir(), base.Res.Size(), base.Res)<br>		*base = *newArg<br>	&#125;<br>	<span class="hljs-keyword">return</span> <span class="hljs-literal">true</span><br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="mutator-splice-ï¼šéšæœºé€‰å–è¯­æ–™åº“ä¸­ä¸€ä¸ªç¨‹åºçš„ç³»ç»Ÿè°ƒç”¨æ’å…¥åˆ°ç¨‹åºéšæœºä½ç½®ä¸­"><a href="#mutator-splice-ï¼šéšæœºé€‰å–è¯­æ–™åº“ä¸­ä¸€ä¸ªç¨‹åºçš„ç³»ç»Ÿè°ƒç”¨æ’å…¥åˆ°ç¨‹åºéšæœºä½ç½®ä¸­" class="headerlink" title="mutator.splice()ï¼šéšæœºé€‰å–è¯­æ–™åº“ä¸­ä¸€ä¸ªç¨‹åºçš„ç³»ç»Ÿè°ƒç”¨æ’å…¥åˆ°ç¨‹åºéšæœºä½ç½®ä¸­"></a>mutator.splice()ï¼šéšæœºé€‰å–è¯­æ–™åº“ä¸­ä¸€ä¸ªç¨‹åºçš„ç³»ç»Ÿè°ƒç”¨æ’å…¥åˆ°ç¨‹åºéšæœºä½ç½®ä¸­</h4><p>è¯¥å‡½æ•°ä¸ºç¼–è¯‘è¿‡ç¨‹å½“ä¸­æ¦‚ç‡æœ€å¤§çš„ä¸»åˆ†æ”¯ï¼Œä¸è¿‡å…¶é€»è¾‘æ¯”è¾ƒç®€çŸ­ï¼š</p>
<ul>
<li>é¦–å…ˆä»è¯­æ–™åº“ä¸­éšæœºå¤åˆ¶ä¸€ä¸ªç¨‹åº</li>
<li>é€‰æ‹©ä¸€ä¸ªéšæœºä¸‹æ ‡ <code>idx</code> ï¼Œåœ¨å¾…å˜å¼‚ç¨‹åºè¯¥ä¸‹æ ‡å¤„æ’å…¥ <code>p0</code> çš„ç³»ç»Ÿè°ƒç”¨ç»„</li>
<li>ä»æœ«å°¾ç§»é™¤å¤šä½™çš„è°ƒç”¨</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// è¯‘æ³¨ï¼šæ³¨é‡Šå†™å¾—æ¯”è¾ƒæŠ½è±¡è¿™é‡Œå°±ä¸è´´äº†ï¼šï¼‰</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(ctx *mutator)</span></span> splice() <span class="hljs-type">bool</span> &#123;<br>	p, r := ctx.p, ctx.r<br>	<span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(ctx.corpus) == <span class="hljs-number">0</span> || <span class="hljs-built_in">len</span>(p.Calls) == <span class="hljs-number">0</span> || <span class="hljs-built_in">len</span>(p.Calls) &gt;= ctx.ncalls &#123;<br>		<span class="hljs-keyword">return</span> <span class="hljs-literal">false</span><br>	&#125;<br>	p0 := ctx.corpus[r.Intn(<span class="hljs-built_in">len</span>(ctx.corpus))]<br>	p0c := p0.Clone()<br>	idx := r.Intn(<span class="hljs-built_in">len</span>(p.Calls))<br>	p.Calls = <span class="hljs-built_in">append</span>(p.Calls[:idx], <span class="hljs-built_in">append</span>(p0c.Calls, p.Calls[idx:]...)...)<br>	<span class="hljs-keyword">for</span> i := <span class="hljs-built_in">len</span>(p.Calls) - <span class="hljs-number">1</span>; i &gt;= ctx.ncalls; i-- &#123;<br>		p.RemoveCall(i)<br>	&#125;<br>	<span class="hljs-keyword">return</span> <span class="hljs-literal">true</span><br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="mutator-insertCall-ï¼šéšæœºç”Ÿæˆä¸€ä¸ªç³»ç»Ÿè°ƒç”¨æ’å…¥åˆ°ç¨‹åºä¸­éšæœºä½ç½®"><a href="#mutator-insertCall-ï¼šéšæœºç”Ÿæˆä¸€ä¸ªç³»ç»Ÿè°ƒç”¨æ’å…¥åˆ°ç¨‹åºä¸­éšæœºä½ç½®" class="headerlink" title="mutator.insertCall()ï¼šéšæœºç”Ÿæˆä¸€ä¸ªç³»ç»Ÿè°ƒç”¨æ’å…¥åˆ°ç¨‹åºä¸­éšæœºä½ç½®"></a>mutator.insertCall()ï¼šéšæœºç”Ÿæˆä¸€ä¸ªç³»ç»Ÿè°ƒç”¨æ’å…¥åˆ°ç¨‹åºä¸­éšæœºä½ç½®</h4><p>è¯¥å‡½æ•°çš„é€»è¾‘ä¹Ÿæ¯”è¾ƒç®€çŸ­ï¼Œè‹¥ç¨‹åºä¸­è°ƒç”¨æ•°é‡å·²ç»è¾¾åˆ° <code>ncalls</code> çš„é™åˆ¶åˆ™ç›´æ¥è¿”å›ï¼Œå¦åˆ™ä¼šå…ˆè°ƒç”¨ <code>analyze()</code> è¿›è¡Œåˆ†æï¼Œéšåè°ƒç”¨ <code>generateCall()</code> ç”Ÿæˆä¸€ä¸ªç³»ç»Ÿè°ƒç”¨å¹¶æ’å…¥åˆ°ç¨‹åºä¸­çš„ä¸€ä¸ªéšæœºä½ç½®</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// åœ¨ä¸€ä¸ªéšæœºç‚¹ï¼ˆå€¾å‘äºç°æœ‰ç¨‹åºçš„æœ«å°¾ï¼‰æ’å…¥ä¸€ä¸ªéšæœºè°ƒç”¨</span><br><span class="hljs-comment">// è‹¥è¯¥ç¨‹åºè°ƒç”¨æ•°é‡æ—©å·²è¾¾åˆ° ncallsï¼ˆè¯‘æ³¨ï¼šé™åˆ¶æ•°é‡ï¼‰åˆ™ä¸ä¼šæ’å…¥ï¼‰</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(ctx *mutator)</span></span> insertCall() <span class="hljs-type">bool</span> &#123;<br>	p, r := ctx.p, ctx.r<br>	<span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(p.Calls) &gt;= ctx.ncalls &#123;<br>		<span class="hljs-keyword">return</span> <span class="hljs-literal">false</span><br>	&#125;<br>	idx := r.biasedRand(<span class="hljs-built_in">len</span>(p.Calls)+<span class="hljs-number">1</span>, <span class="hljs-number">5</span>)<br>	<span class="hljs-keyword">var</span> c *Call<br>	<span class="hljs-keyword">if</span> idx &lt; <span class="hljs-built_in">len</span>(p.Calls) &#123;<br>		c = p.Calls[idx]<br>	&#125;<br>	s := analyze(ctx.ct, ctx.corpus, p, c)<br>	calls := r.generateCall(s, p, idx)<br>	p.insertBefore(c, calls)<br>	<span class="hljs-keyword">for</span> <span class="hljs-built_in">len</span>(p.Calls) &gt; ctx.ncalls &#123;<br>		p.RemoveCall(idx)<br>	&#125;<br>	<span class="hljs-keyword">return</span> <span class="hljs-literal">true</span><br>&#125;<br><br></code></pre></td></tr></table></figure>

<h4 id="mutator-mutateArg-ï¼šéšæœºå˜å¼‚ç¨‹åºä¸­æŸä¸€ç³»ç»Ÿè°ƒç”¨çš„å‚æ•°"><a href="#mutator-mutateArg-ï¼šéšæœºå˜å¼‚ç¨‹åºä¸­æŸä¸€ç³»ç»Ÿè°ƒç”¨çš„å‚æ•°" class="headerlink" title="mutator.mutateArg()ï¼šéšæœºå˜å¼‚ç¨‹åºä¸­æŸä¸€ç³»ç»Ÿè°ƒç”¨çš„å‚æ•°"></a>mutator.mutateArg()ï¼šéšæœºå˜å¼‚ç¨‹åºä¸­æŸä¸€ç³»ç»Ÿè°ƒç”¨çš„å‚æ•°</h4><p>è¯¥å‡½æ•°çš„ä¸»è¦ä½œç”¨ä¾¿æ˜¯éšæœºå˜å¼‚ç¨‹åºä¸­æŸä¸€ç³»ç»Ÿè°ƒç”¨çš„å‚æ•°ï¼Œè¿™é‡Œå°±ä¸æ·±å…¥å±•å¼€åˆ†æäº†ï¼Œæ„Ÿå…´è¶£å¯ä»¥ç›´æ¥çœ‹æºç ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(ctx *mutator)</span></span> mutateArg() <span class="hljs-type">bool</span> &#123;<br>	p, r := ctx.p, ctx.r<br>	<span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(p.Calls) == <span class="hljs-number">0</span> &#123;<br>		<span class="hljs-keyword">return</span> <span class="hljs-literal">false</span><br>	&#125;<br><br>	idx := chooseCall(p, r)<br>	<span class="hljs-keyword">if</span> idx &lt; <span class="hljs-number">0</span> &#123;<br>		<span class="hljs-keyword">return</span> <span class="hljs-literal">false</span><br>	&#125;<br>	c := p.Calls[idx]<br>	<span class="hljs-keyword">if</span> ctx.noMutate[c.Meta.ID] &#123;<br>		<span class="hljs-keyword">return</span> <span class="hljs-literal">false</span><br>	&#125;<br>	updateSizes := <span class="hljs-literal">true</span><br>	<span class="hljs-keyword">for</span> stop, ok := <span class="hljs-literal">false</span>, <span class="hljs-literal">false</span>; !stop; stop = ok &amp;&amp; r.oneOf(<span class="hljs-number">3</span>) &#123;<br>		ok = <span class="hljs-literal">true</span><br>		ma := &amp;mutationArgs&#123;target: p.Target&#125;<br>		ForeachArg(c, ma.collectArg)<br>		<span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(ma.args) == <span class="hljs-number">0</span> &#123;<br>			<span class="hljs-keyword">return</span> <span class="hljs-literal">false</span><br>		&#125;<br>		s := analyze(ctx.ct, ctx.corpus, p, c)<br>		arg, argCtx := ma.chooseArg(r.Rand)<br>		calls, ok1 := p.Target.mutateArg(r, s, arg, argCtx, &amp;updateSizes)<br>		<span class="hljs-keyword">if</span> !ok1 &#123;<br>			ok = <span class="hljs-literal">false</span><br>			<span class="hljs-keyword">continue</span><br>		&#125;<br>		p.insertBefore(c, calls)<br>		idx += <span class="hljs-built_in">len</span>(calls)<br>		<span class="hljs-keyword">for</span> <span class="hljs-built_in">len</span>(p.Calls) &gt; ctx.ncalls &#123;<br>			idx--<br>			p.RemoveCall(idx)<br>		&#125;<br>		<span class="hljs-keyword">if</span> idx &lt; <span class="hljs-number">0</span> || idx &gt;= <span class="hljs-built_in">len</span>(p.Calls) || p.Calls[idx] != c &#123;<br>			<span class="hljs-built_in">panic</span>(fmt.Sprintf(<span class="hljs-string">&quot;wrong call index: idx=%v calls=%v p.Calls=%v ncalls=%v&quot;</span>,<br>				idx, <span class="hljs-built_in">len</span>(calls), <span class="hljs-built_in">len</span>(p.Calls), ctx.ncalls))<br>		&#125;<br>		<span class="hljs-keyword">if</span> updateSizes &#123;<br>			p.Target.assignSizesCall(c)<br>		&#125;<br>	&#125;<br>	<span class="hljs-keyword">return</span> <span class="hljs-literal">true</span><br>&#125;<br><br></code></pre></td></tr></table></figure>

<h4 id="mutator-removeCall-ï¼šéšæœºç§»é™¤ç¨‹åºä¸­çš„ä¸€ä¸ªç³»ç»Ÿè°ƒç”¨"><a href="#mutator-removeCall-ï¼šéšæœºç§»é™¤ç¨‹åºä¸­çš„ä¸€ä¸ªç³»ç»Ÿè°ƒç”¨" class="headerlink" title="mutator.removeCall()ï¼šéšæœºç§»é™¤ç¨‹åºä¸­çš„ä¸€ä¸ªç³»ç»Ÿè°ƒç”¨"></a>mutator.removeCall()ï¼šéšæœºç§»é™¤ç¨‹åºä¸­çš„ä¸€ä¸ªç³»ç»Ÿè°ƒç”¨</h4><p>è¯¥å‡½æ•°ä¹Ÿæ¯”è¾ƒç®€çŸ­ï¼Œä¸»è¦å°±æ˜¯éšæœºç§»é™¤ç¨‹åºä¸­çš„ä¸€ä¸ªç³»ç»Ÿè°ƒç”¨ï¼Œå¦‚æœç¨‹åºä¸­æ²¡æœ‰ç³»ç»Ÿè°ƒç”¨åˆ™ä¸ä¼šè¿›è¡Œç§»é™¤æ“ä½œï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(ctx *mutator)</span></span> removeCall() <span class="hljs-type">bool</span> &#123;<br>	p, r := ctx.p, ctx.r<br>	<span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(p.Calls) == <span class="hljs-number">0</span> &#123;<br>		<span class="hljs-keyword">return</span> <span class="hljs-literal">false</span><br>	&#125;<br>	idx := r.Intn(<span class="hljs-built_in">len</span>(p.Calls))<br>	p.RemoveCall(idx)<br>	<span class="hljs-keyword">return</span> <span class="hljs-literal">true</span><br>&#125;<br></code></pre></td></tr></table></figure>

<p>è‡³æ­¤ï¼Œsyz-fuzzer ä¸»ä½“æºç é€»è¾‘åˆ†æå®Œæ¯•</p>
<blockquote>
<p>ç®€å•æ€»ç»“çš„è¯ï¼Œç¬”è€…æ„Ÿè§‰å…¶å®ä¸»è¦éƒ½æ˜¯åå·¥ç¨‹æ€§çš„ä¸œè¥¿æ¯”è¾ƒå¤šğŸ¤”</p>
</blockquote>

                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
    <div class="post-meta mr-3 d-flex align-items-center">
      <i class="iconfont icon-category"></i>
      

<span class="category-chains">
  
  
    
      <span class="category-chain">
        
  <a href="/categories/FUZZ/" class="category-chain-item">FUZZ</a>
  
  

      </span>
    
  
</span>

    </div>
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/%E6%BC%8F%E6%B4%9E%E6%8C%96%E6%8E%98/">#æ¼æ´æŒ–æ˜</a>
      
        <a href="/tags/FUZZ/">#FUZZ</a>
      
        <a href="/tags/syzkaller/">#syzkaller</a>
      
    </div>
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>ã€FUZZ.0x03ã€‘syzkaller - IIIï¼šsyz-fuzzer æºç åˆ†æ</div>
      <div>https://arttnba3.github.io/2023/09/27/FUZZ-0X03-SYZKALLER-III_SOURCE_SYZFUZZER/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>ä½œè€…</div>
          <div>arttnba3</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>å‘å¸ƒäº</div>
          <div>2023å¹´9æœˆ27æ—¥</div>
        </div>
      
      
      <div class="license-meta-item">
        <div>è®¸å¯åè®®</div>
        <div>
          
            
            
              <a target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
              <span class="hint--top hint--rounded" aria-label="BY - ç½²å">
                <i class="iconfont icon-by"></i>
              </span>
              </a>
            
          
        </div>
      </div>
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2023/10/25/OPS-0X01-DOCKER_WAYLAND_GUI/" title="ã€OPS.0x01ã€‘ä¸º Docker è¿æ¥ Wayland å›¾å½¢ç¯å¢ƒ">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">ã€OPS.0x01ã€‘ä¸º Docker è¿æ¥ Wayland å›¾å½¢ç¯å¢ƒ</span>
                        <span class="visible-mobile">ä¸Šä¸€ç¯‡</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2023/09/25/DISTRO-0X00-INSTALL_ARCH_WINDOWS/" title="ã€DISTRO.0x00ã€‘ä»é›¶å¼€å§‹çš„ Arch Linux ç”Ÿæ´»">
                        <span class="hidden-mobile">ã€DISTRO.0x00ã€‘ä»é›¶å¼€å§‹çš„ Arch Linux ç”Ÿæ´»</span>
                        <span class="visible-mobile">ä¸‹ä¸€ç¯‡</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
  <article id="comments" lazyload>
    
  <div id="valine"></div>
  <script type="text/javascript">
    Fluid.utils.loadComments('#valine', function() {
      Fluid.utils.createScript('https://lib.baomitu.com/valine/1.4.17/Valine.min.js', function() {
        var options = Object.assign(
          {"appid":"ICj6cPRQWFTNiOttBHlzxnIv-gzGzoHsz","appkey":"tuvJh3xYxPFcW2JB6K26RKP2","path":"window.location.pathname","placeholder":"è¯´ç‚¹ä»€ä¹ˆå‘—ï¼ˆç¬‘ï¼‰","avatar":"retro","meta":["nick","mail","link"],"requiredFields":[],"pageSize":10,"lang":"zh-CN","highlight":false,"recordIP":false,"serverURLs":"","emojiCDN":null,"emojiMaps":null,"enableQQ":false,"appId":"ICj6cPRQWFTNiOttBHlzxnIv-gzGzoHsz","appKey":"tuvJh3xYxPFcW2JB6K26RKP2"},
          {
            el: "#valine",
            path: window.location.pathname
          }
        )
        new Valine(options);
        Fluid.utils.waitElementVisible('#valine .vcontent', () => {
          var imgSelector = '#valine .vcontent img:not(.vemoji)';
          Fluid.plugins.imageCaption(imgSelector);
          Fluid.plugins.fancyBox(imgSelector);
        })
      });
    });
  </script>
  <noscript>Please enable JavaScript to view the comments</noscript>


  </article>


          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;ç›®å½•</p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  


  
  









    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">æœç´¢</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">å…³é”®è¯</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  <!-- ç½‘ç«™è¿è¡Œæ—¶é—´çš„è®¾ç½® -->
  <span id="timeDate">è½½å…¥å¤©æ•°...</span>
  <span id="times">è½½å…¥æ—¶åˆ†ç§’...</span>
  <script>
      var now = new Date();
      function createtime() {
          var grt= new Date("04/20/2020 17:48:48");//æ­¤å¤„ä¿®æ”¹ä½ çš„å»ºç«™æ—¶é—´æˆ–è€…ç½‘ç«™ä¸Šçº¿æ—¶é—´
          now.setTime(now.getTime()+250);
          days = (now - grt ) / 1000 / 60 / 60 / 24; dnum = Math.floor(days);
          hours = (now - grt ) / 1000 / 60 / 60 - (24 * dnum); hnum = Math.floor(hours);
          if(String(hnum).length ==1 ){hnum = "0" + hnum;} minutes = (now - grt ) / 1000 /60 - (24 * 60 * dnum) - (60 * hnum);
          mnum = Math.floor(minutes); if(String(mnum).length ==1 ){mnum = "0" + mnum;}
          seconds = (now - grt ) / 1000 - (24 * 60 * 60 * dnum) - (60 * 60 * hnum) - (60 * mnum);
          snum = Math.round(seconds); if(String(snum).length ==1 ){snum = "0" + snum;}
          document.getElementById("timeDate").innerHTML = "arttnba3çš„å°å±‹å·²ç»å®‰å…¨å­˜åœ¨äº† "+dnum+" å¤© ";
          document.getElementById("times").innerHTML = hnum + " å°æ—¶ " + mnum + " åˆ† " + snum + " ç§’";
      }
  setInterval("createtime()",250);
  </script>
  
    <div class="footer-content">
       <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
    </div>
  
  
    <div class="statistics">
  
  

  
    
      <span id="busuanzi_container_site_pv" style="display: none">
        æ€»è®¿é—®é‡ 
        <span id="busuanzi_value_site_pv"></span>
         æ¬¡
      </span>
    
    
      <span id="busuanzi_container_site_uv" style="display: none">
        æ€»è®¿å®¢æ•° 
        <span id="busuanzi_value_site_uv"></span>
         äºº
      </span>
    
    
  
</div>

  
  
    <!-- å¤‡æ¡ˆä¿¡æ¯ ICP for China -->
    <div class="beian">
  <span>
    <a href="http://beian.miit.gov.cn/" target="_blank" rel="nofollow noopener">
      æ¡‚ICPå¤‡2022005068å·-1
    </a>
  </span>
  
</div>

  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.0/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.18.2/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      headingSelector : CONFIG.toc.headingSelector || 'h1,h2,h3,h4,h5,h6',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      collapseDepth   : CONFIG.toc.collapseDepth || 0,
      scrollSmooth    : true,
      headingsOffset  : -boardTop
    });
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.10/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  
      <script>
        if (!window.MathJax) {
          window.MathJax = {
            tex    : {
              inlineMath: { '[+]': [['$', '$']] }
            },
            loader : {
              load: ['ui/lazy']
            },
            options: {
              renderActions: {
                insertedScript: [200, () => {
                  document.querySelectorAll('mjx-container').forEach(node => {
                    let target = node.parentNode;
                    if (target.nodeName.toLowerCase() === 'li') {
                      target.parentNode.classList.add('has-jax');
                    }
                  });
                }, '', false]
              }
            }
          };
        } else {
          MathJax.startup.document.state(0);
          MathJax.texReset();
          MathJax.typeset();
          MathJax.typesetPromise();
        }
      </script>
    

  <script  src="https://lib.baomitu.com/mathjax/3.2.1/es5/tex-mml-chtml.js" ></script>

  <script  src="/js/local-search.js" ></script>

  <script defer src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" ></script>





<!-- ä¸»é¢˜çš„å¯åŠ¨é¡¹ï¼Œå°†å®ƒä¿æŒåœ¨æœ€åº•éƒ¨ -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">åšå®¢åœ¨å…è®¸ JavaScript è¿è¡Œçš„ç¯å¢ƒä¸‹æµè§ˆæ•ˆæœæ›´ä½³</div>
  </noscript>
</body>
</html>
