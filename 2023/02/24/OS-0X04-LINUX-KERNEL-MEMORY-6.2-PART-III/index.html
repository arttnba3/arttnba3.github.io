

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/avatar.png">
  <link rel="icon" href="/img/avatar.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
    <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="arttnba3">
  <meta name="keywords" content="">
  
    <meta name="description" content="åˆ«äººé—®ä½ å“ªé‡Œä¸‘æ€ä½ å†æŠŠä»–åæ‰‹æŒ‚åˆ°è‡ªå·±çš„å° slub é‡Œå¯»æ±‚è®¤åŒ">
<meta property="og:type" content="article">
<meta property="og:title" content="ã€OS.0x04ã€‘Linux Kernel å†…å­˜ç®¡ç†æµ…æ III - Slub Allocator">
<meta property="og:url" content="https://arttnba3.github.io/2023/02/24/OS-0X04-LINUX-KERNEL-MEMORY-6.2-PART-III/index.html">
<meta property="og:site_name" content="arttnba3&#39;s blog">
<meta property="og:description" content="åˆ«äººé—®ä½ å“ªé‡Œä¸‘æ€ä½ å†æŠŠä»–åæ‰‹æŒ‚åˆ°è‡ªå·±çš„å° slub é‡Œå¯»æ±‚è®¤åŒ">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://s2.loli.net/2023/02/21/D4idvgzLAaqIBQM.png">
<meta property="article:published_time" content="2023-02-23T15:24:42.000Z">
<meta property="article:modified_time" content="2023-04-23T17:58:23.750Z">
<meta property="article:author" content="arttnba3">
<meta property="article:tag" content="Linux">
<meta property="article:tag" content="Linux Kernel">
<meta property="article:tag" content="å­¦ä¹ æœ­è®°">
<meta property="article:tag" content="å†…å­˜ç®¡ç†">
<meta property="article:tag" content="slub allocator">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://s2.loli.net/2023/02/21/D4idvgzLAaqIBQM.png">
  
  
    <meta name="referrer" content="no-referrer-when-downgrade">
  
  
  <title>ã€OS.0x04ã€‘Linux Kernel å†…å­˜ç®¡ç†æµ…æ III - Slub Allocator - arttnba3&#39;s blog</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- ä¸»é¢˜ä¾èµ–çš„å›¾æ ‡åº“ï¼Œä¸è¦è‡ªè¡Œä¿®æ”¹ -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  




  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"arttnba3.github.io","root":"/","version":"1.9.2","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":"Â§"},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":false,"follow_dnt":true,"baidu":null,"google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false}},"search_path":"/local-search.xml"};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  


  
<meta name="generator" content="Hexo 6.2.0"><link rel="alternate" href="/atom.xml" title="arttnba3's blog" type="application/atom+xml">
</head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 80vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>arttnba3&#39;s blog</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                é¦–é¡µ
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                å½’æ¡£
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                åˆ†ç±»
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                æ ‡ç­¾
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                å…³äº
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/links/">
                <i class="iconfont icon-link-fill"></i>
                å‹é“¾
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/atom.xml">
                <i class="iconfont icon-rss"></i>
                rss
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              &nbsp;<i class="iconfont icon-search"></i>&nbsp;
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">&nbsp;<i
                class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('https://s2.loli.net/2023/02/22/wCchFdIZLOn3m7W.png') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="ã€OS.0x04ã€‘Linux Kernel å†…å­˜ç®¡ç†æµ…æ III - Slub Allocator"></span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2023-02-24 02:24" pubdate>
          2023å¹´2æœˆ24æ—¥ å‡Œæ™¨
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          42k å­—
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          350 åˆ†é’Ÿ
        
      </span>
    

    
    
      
        <span id="busuanzi_container_page_pv" style="display: none">
          <i class="iconfont icon-eye" aria-hidden="true"></i>
          <span id="busuanzi_value_page_pv"></span> æ¬¡
        </span>
        
      
    
  </div>


        
      </div>

      
        <div class="scroll-down-bar">
          <i class="iconfont icon-arrowdown"></i>
        </div>
      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">ã€OS.0x04ã€‘Linux Kernel å†…å­˜ç®¡ç†æµ…æ III - Slub Allocator</h1>
            
              <p class="note note-info">
                
                  
                    æœ¬æ–‡æœ€åæ›´æ–°äºï¼š2023å¹´4æœˆ24æ—¥ å‡Œæ™¨
                  
                
              </p>
            
            
              <div class="markdown-body">
                
                <p>åˆ«äººé—®ä½ å“ªé‡Œä¸‘æ€ä½ å†æŠŠä»–åæ‰‹æŒ‚åˆ°è‡ªå·±çš„å° slub é‡Œå¯»æ±‚è®¤åŒ</p>
<span id="more"></span>

<h1 id="0x00-ä¸€åˆ‡å¼€å§‹ä¹‹å‰"><a href="#0x00-ä¸€åˆ‡å¼€å§‹ä¹‹å‰" class="headerlink" title="0x00.ä¸€åˆ‡å¼€å§‹ä¹‹å‰"></a>0x00.ä¸€åˆ‡å¼€å§‹ä¹‹å‰</h1><blockquote>
<p>å› ä¸ºè¿™ç³»åˆ—æ–‡ç« ğŸ•ŠğŸ•ŠğŸ•Šå¤ªä¹…äº†ï¼Œå†…æ ¸çš„å†…å­˜ç®¡ç†ä¹Ÿå‘ç”Ÿäº†ä¸€å®šçš„å˜åŒ–ï¼Œæ‰€ä»¥æœ¬æ–‡ç›´æ¥ç”¨æœ€æ–°çš„ 6.2 ç‰ˆæœ¬çš„å†…æ ¸æºç ï¼šï¼‰</p>
</blockquote>
<p>åœ¨<a target="_blank" rel="noopener" href="https://arttnba3.cn/2022/06/30/OS-0X03-LINUX-KERNEL-MEMORY-5.11-PART-II/">ä¸Šä¸€ç¯‡æ–‡ç« </a> ä¸­ç¬”è€…ç®€è¦ä»‹ç»äº† buddy system çš„åŸºæœ¬æµç¨‹ï¼Œä½†å…¶ä¸ºä¸€ä¸ªã€Œé¡µã€è¿™ä¸€çº§çš„ allocatorï¼Œåœ¨æ—¥å¸¸ç”Ÿæ´»ä¸­ä½¿ç”¨ï¼ˆï¼Ÿï¼‰éš¾å…æœ‰äº›æµªè´¹ï¼Œå› ä¸ºå†…æ ¸ä¸­éœ€è¦åŠ¨æ€å†…å­˜åˆ†é…çš„åœºæ™¯è™½ç„¶å¾ˆå¤šï¼Œä½†æ˜¯æˆ‘ä»¬<strong>é€šå¸¸å¹¶ä¸éœ€è¦ä½¿ç”¨ä¸€æ•´é¡µèµ·æ­¥çš„å†…å­˜ï¼Œè€Œå¾€å¾€æ˜¯éœ€è¦åˆ†é…ä¸€äº›æ¯”è¾ƒå°çš„å¯¹è±¡</strong>â€”â€”å› æ­¤ slab allocator åº”è¿è€Œç”Ÿï¼Œå…¶ä»£æ›¿æˆ‘ä»¬å‘ buddy system è¯·æ±‚å†…å­˜é¡µï¼Œå¹¶åˆ†å‰²ä¸ºå¤šä¸ªå°çš„ objectï¼Œå½“æˆ‘ä»¬æ¯æ¬¡éœ€è¦æ—¶åªéœ€è¦å–ä¸€ä¸ª object å³å¯</p>
<blockquote>
<p>slab åˆè¢«ç§°ä¸ºå†…æ ¸çš„å †ï¼ˆheapï¼‰å†…å­˜ç®¡ç†ï¼Œå› ä¸ºå…¶ä¸ç”¨æˆ·æ€çš„å†…å­˜â€œå †â€ï¼ˆheapï¼‰ç±»ä¼¼ï¼Œéƒ½æ˜¯åŠ¨æ€åˆ†é…çš„å†…å­˜</p>
</blockquote>
<p>slab allocator ä¸€å…±æœ‰ä¸‰ç§ç‰ˆæœ¬ï¼š</p>
<ul>
<li>slabï¼ˆæœ€åˆçš„ç‰ˆæœ¬ï¼Œæœºåˆ¶æ¯”è¾ƒå¤æ‚ï¼Œæ•ˆç‡ä¸é«˜ï¼‰</li>
<li>slobï¼ˆç”¨äºåµŒå…¥å¼ç­‰åœºæ™¯çš„æä¸ºç®€åŒ–ç‰ˆæœ¬ï¼‰</li>
<li><strong>slub</strong>ï¼ˆä¼˜åŒ–åçš„ç‰ˆæœ¬ï¼Œ<strong>ç°åœ¨çš„é€šç”¨ç‰ˆæœ¬</strong>ï¼‰</li>
</ul>
<blockquote>
<p>è¿™ä¸‰ç§å†…å­˜åˆ†é…å™¨çš„é¡¶å±‚ API æ˜¯ä¸€è‡´çš„ï¼Œä½†å†…éƒ¨å®ç°æ˜¯ä¸ä¸€è‡´çš„ï¼ˆä¾‹å¦‚ slab å’Œ slub å„è‡ªæœ‰ä¸€ä¸ªå¯¹ <code>kmem_cache</code> çš„ä¸åŒå®šä¹‰ï¼‰</p>
</blockquote>
<p>æœ¬ç¯‡æ–‡ç« ä¸­æˆ‘ä»¬ä¸»è¦ä»‹ç»çš„æ˜¯ <strong>slub</strong> ï¼Œä¹Ÿæ˜¯ç°åœ¨å†…æ ¸ä¸­æœ€ä¸ºé€šç”¨çš„å°å¯¹è±¡åˆ†é…å™¨</p>
<h1 id="0x01-slub-allocator-çš„åŸºæœ¬ç»“æ„"><a href="#0x01-slub-allocator-çš„åŸºæœ¬ç»“æ„" class="headerlink" title="0x01. slub allocator çš„åŸºæœ¬ç»“æ„"></a>0x01. slub allocator çš„åŸºæœ¬ç»“æ„</h1><p>é¦–å…ˆæ¥ä¸€å¼  Overviewï¼š</p>
<p><img src="https://i.loli.net/2021/07/22/ivPnbsjHyI94m5z.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<h2 id="ä¸€ã€slabï¼šå•ä»½-object-æ± "><a href="#ä¸€ã€slabï¼šå•ä»½-object-æ± " class="headerlink" title="ä¸€ã€slabï¼šå•ä»½ object æ± "></a>ä¸€ã€slabï¼šå•ä»½ object æ± </h2><p>Linux kernel ä¸­ç”¨ä»¥ç»Ÿç­¹æ‰€æœ‰å†…å­˜çš„ä¾ç„¶æ˜¯ buddy systemï¼Œslub allocator ä¹Ÿä¸ä¾‹å¤–ï¼Œå…¶è´Ÿè´£å‘ buddy system è¯·æ±‚å†…å­˜ååˆ†å‰²ç»™å¤šä¸ªå° object åå†è¿”è¿˜ç»™ä¸Šå±‚è°ƒç”¨è€…ï¼Œ<strong>å•æ¬¡å‘ buddy system æ‰€è¯·æ±‚çš„ä¸€ä»½è¿ç»­å†…å­˜é¡µä¾¿ç§°ä¹‹ä¸ºä¸€å¼  slab</strong>ï¼Œåœ¨å†…æ ¸ä¸­å¯¹åº” <code>slab</code> ç»“æ„ä½“ï¼Œ<strong>æœ¬è´¨ä¸Šæ˜¯å¤ç”¨ page ç»“æ„ä½“</strong>ï¼š</p>
<blockquote>
<p>è¿™é‡Œæˆ‘ä»¬ä»…å…³æ³¨ slubï¼Œæ‰€ä»¥ç¬”è€…ä»…æˆªå– slub æ‰€éœ€å­—æ®µ</p>
<blockquote>
<p>è€ç‰ˆæœ¬ä¸­ slab æ˜¯ç›´æ¥å†…åµŒåœ¨ page ç»“æ„ä½“ä¸­çš„</p>
</blockquote>
</blockquote>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/* Reuses the bits in struct page */</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">slab</span> &#123;</span><br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> __page_flags;<br><br><span class="hljs-comment">//...</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">elif</span> defined(CONFIG_SLUB)</span><br><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">kmem_cache</span> *<span class="hljs-title">slab_cache</span>;</span><br>	<span class="hljs-class"><span class="hljs-keyword">union</span> &#123;</span><br>		<span class="hljs-class"><span class="hljs-keyword">struct</span> &#123;</span><br>			<span class="hljs-class"><span class="hljs-keyword">union</span> &#123;</span><br>				<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">list_head</span> <span class="hljs-title">slab_list</span>;</span><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONFIG_SLUB_CPU_PARTIAL</span><br>				<span class="hljs-class"><span class="hljs-keyword">struct</span> &#123;</span><br>					<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">slab</span> *<span class="hljs-title">next</span>;</span><br>					<span class="hljs-type">int</span> slabs;	<span class="hljs-comment">/* å‰©ä½™çš„ slabs æ•°é‡ */</span><br>				&#125;;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>			&#125;;<br>			<span class="hljs-comment">/* Double-word boundary */</span><br>			<span class="hljs-type">void</span> *freelist;		<span class="hljs-comment">/* ç¬¬ä¸€ä¸ªç©ºé—²å¯¹è±¡ */</span><br>			<span class="hljs-class"><span class="hljs-keyword">union</span> &#123;</span><br>				<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> counters;<br>				<span class="hljs-class"><span class="hljs-keyword">struct</span> &#123;</span><br>					<span class="hljs-type">unsigned</span> inuse:<span class="hljs-number">16</span>;<br>					<span class="hljs-type">unsigned</span> objects:<span class="hljs-number">15</span>;<br>					<span class="hljs-type">unsigned</span> frozen:<span class="hljs-number">1</span>;<br>				&#125;;<br>			&#125;;<br>		&#125;;<br>		<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">rcu_head</span> <span class="hljs-title">rcu_head</span>;</span><br>	&#125;;<br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> __unused;<br><br><span class="hljs-comment">//...</span><br><br>	<span class="hljs-type">atomic_t</span> __page_refcount;<br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONFIG_MEMCG</span><br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> memcg_data;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>&#125;;<br></code></pre></td></tr></table></figure>

<ul>
<li><code>slab_cache</code> ï¼šè¯¥ slab å¯¹åº”çš„å†…å­˜æ± </li>
<li><code>freelist</code> ï¼š<strong>Slab ä¸Šçš„ç©ºé—²å¯¹è±¡ç»„ç»‡ä¸ºä¸€ä¸ª NULL ç»“å°¾çš„å•å‘é“¾è¡¨</strong>ï¼Œè¯¥æŒ‡é’ˆæŒ‡å‘ç¬¬ä¸€ä¸ªç©ºé—²å¯¹è±¡ï¼Œè€—å°½æ—¶ä¸º NULL</li>
<li><code>slab_list</code> ï¼šæŒ‰ç”¨é€”è¿æ¥å¤šä¸ª slabs çš„åŒå‘é“¾è¡¨</li>
<li><code>inuse</code> ï¼šå·²è¢«ä½¿ç”¨çš„å¯¹è±¡æ•°é‡</li>
<li><code>objects</code>ï¼šè¯¥ slab ä¸Šçš„å¯¹è±¡æ€»æ•°</li>
<li><code>frozen</code>ï¼šæ˜¯å¦è¢«å†»ç»“ï¼Œå³<strong>å·²ç»å½’å±äºç‰¹å®šçš„ CPU</strong></li>
</ul>
<blockquote>
<p>è¿™é‡Œæˆ‘ä»¬éœ€è¦æ³¨æ„çš„æ˜¯ <strong>counters æˆå‘˜ç›´æ¥æ¶µç›–äº† inuse &amp; objects &amp; frozen</strong>ï¼Œåé¢ä¼šæœ‰å¤§é‡çš„ç›´æ¥é€šè¿‡ counters æˆå‘˜è¿›è¡Œèµ‹å€¼çš„æ“ä½œï¼Œ<strong>å®é™…ä¸Šå°±æ˜¯èµ‹å€¼äº† inuse &amp; objects &amp; frozen</strong></p>
</blockquote>
<p>æ­£å¦‚ä¸€ä¸ª page ç»“æ„ä½“ç›´æ¥å¯¹åº”ä¸€å¼ å†…å­˜é¡µï¼ˆæˆ–å¤åˆé¡µï¼‰ï¼Œå¤ç”¨äº† page ç»“æ„ä½“çš„ slab ä¹Ÿ<strong>ç›´æ¥å¯¹åº”ä¸€ä»½ slab å†…å­˜é¡µ</strong>ï¼Œå€ŸåŠ© <code>page_to_pfn()</code> ç­‰å‡½æ•°å¯ä»¥ç›´æ¥å®Œæˆ slab ç»“æ„ä½“åˆ°å¯¹åº”å†…å­˜é¡µè™šæ‹Ÿåœ°å€çš„è½¬æ¢ï¼Œåä¹‹äº¦ç„¶ï¼Œå³<strong>æˆ‘ä»¬å¯ä»¥ç›´æ¥é€šè¿‡ä¸€ä¸ªç©ºé—²å¯¹è±¡çš„è™šæ‹Ÿåœ°å€æ‰¾åˆ°å¯¹åº”çš„ slab ç»“æ„ä½“</strong></p>
<p><img src="https://s2.loli.net/2023/02/21/cBXCGF4Z18VLMzl.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<h2 id="äºŒã€kmem-cacheï¼šç‰¹å®šå¤§å°-amp-ç”¨é€”å¯¹è±¡ï¼ˆå †å—ï¼‰çš„å†…å­˜æ± "><a href="#äºŒã€kmem-cacheï¼šç‰¹å®šå¤§å°-amp-ç”¨é€”å¯¹è±¡ï¼ˆå †å—ï¼‰çš„å†…å­˜æ± " class="headerlink" title="äºŒã€kmem_cacheï¼šç‰¹å®šå¤§å°&amp;ç”¨é€”å¯¹è±¡ï¼ˆå †å—ï¼‰çš„å†…å­˜æ± "></a>äºŒã€kmem_cacheï¼šç‰¹å®šå¤§å°&amp;ç”¨é€”å¯¹è±¡ï¼ˆå †å—ï¼‰çš„å†…å­˜æ± </h2><p><code>kmem_cache</code> ä¸ºä¸€ä¸ªåŸºæœ¬çš„ allocator ç»„ä»¶ï¼Œå¯ä»¥ç†è§£ä¸º <strong>ç”¨äºåˆ†é…æŸä¸ªç‰¹å®šå¤§å°ï¼ˆæŸç§ç‰¹å®šç”¨é€”ï¼‰çš„å¯¹è±¡çš„å†…å­˜æ± </strong>ï¼Œæ‰€æœ‰çš„ kmem_cache æ„æˆä¸€ä¸ªåŒå‘é“¾è¡¨ï¼Œå¹¶å­˜åœ¨ä¸€ä¸ªå¯¹åº”çš„é€šç”¨ <code>kmem_cache</code> æ•°ç»„ <code>kmalloc_caches</code> </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">kmem_cache</span> *</span><br><span class="hljs-class"><span class="hljs-title">kmalloc_caches</span>[<span class="hljs-title">NR_KMALLOC_TYPES</span>][<span class="hljs-title">KMALLOC_SHIFT_HIGH</span> + 1] __<span class="hljs-title">ro_after_init</span> =</span><br>&#123; <span class="hljs-comment">/* initialization for https://bugs.llvm.org/show_bug.cgi?id=42570 */</span> &#125;;<br>EXPORT_SYMBOL(kmalloc_caches);<br></code></pre></td></tr></table></figure>

<blockquote>
<p>è€ç‰ˆæœ¬è¿˜æœ‰ä¸ª dma ä¸“ç”¨æ•°ç»„ <code>kmalloc_dma_caches</code> ï¼Œåœ¨ <a target="_blank" rel="noopener" href="https://patchwork.kernel.org/project/linux-mm/patch/20180718133620.6205-2-vbabka@suse.cz/">è¿™ä¸ª commit</a> ç»™åˆå¹¶èµ·æ¥äº†</p>
</blockquote>
<h3 id="I-åŸºæœ¬ç»“æ„"><a href="#I-åŸºæœ¬ç»“æ„" class="headerlink" title="I. åŸºæœ¬ç»“æ„"></a>I. åŸºæœ¬ç»“æ„</h3><p>è¯¥ç»“æ„ä½“å®šä¹‰äº <code>include/linux/slub_def.h</code> ä¸­ï¼Œå¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * Slab ç¼“å­˜ç®¡ç†.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">kmem_cache</span> &#123;</span><br><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> CONFIG_SLUB_TINY</span><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">kmem_cache_cpu</span> __<span class="hljs-title">percpu</span> *<span class="hljs-title">cpu_slab</span>;</span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>	<span class="hljs-comment">/* ç”¨äºå–å› partial slabs ç­‰. */</span><br>	<span class="hljs-type">slab_flags_t</span> flags;<br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> min_partial;<br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> size;	<span class="hljs-comment">/* ä¸€ä¸ªå¯¹è±¡åŒ…å«å…ƒæ•°æ®çš„å¤§å° */</span><br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> object_size;<span class="hljs-comment">/* ä¸€ä¸ªå¯¹è±¡ä¸åŒ…å«å…ƒæ•°æ®çš„å¤§å° */</span><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">reciprocal_value</span> <span class="hljs-title">reciprocal_size</span>;</span><br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> offset;	<span class="hljs-comment">/* ç©ºé—²æŒ‡é’ˆçš„åç§» */</span><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONFIG_SLUB_CPU_PARTIAL</span><br>	<span class="hljs-comment">/* è¦ä¿ç•™çš„ per cpu partial å¯¹è±¡æ•°é‡ */</span><br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> cpu_partial;<br>	<span class="hljs-comment">/* è¦ä¿ç•™çš„ per cpu partial slub æ•°é‡ */</span><br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> cpu_partial_slabs;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">kmem_cache_order_objects</span> <span class="hljs-title">oo</span>;</span><br><br>	<span class="hljs-comment">/* åˆ†é…ä¸é‡Šæ”¾ slabs */</span><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">kmem_cache_order_objects</span> <span class="hljs-title">min</span>;</span><br>	<span class="hljs-type">gfp_t</span> allocflags;	<span class="hljs-comment">/* ï¼ˆè¯‘æ³¨ï¼šå‘ buddy systemï¼‰åˆ†é…æ—¶æ‰€ç”¨çš„ gfp æ ‡å¿—ä½ */</span><br>	<span class="hljs-type">int</span> refcount;		<span class="hljs-comment">/* ç”¨äº slab ç¼“å­˜é”€æ¯çš„å¼•ç”¨è®¡æ•° */</span><br>	<span class="hljs-type">void</span> (*ctor)(<span class="hljs-type">void</span> *);<br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> inuse;		<span class="hljs-comment">/* å…ƒæ•°æ®çš„åç§» */</span><br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> align;		<span class="hljs-comment">/* å¯¹é½ */</span><br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> red_left_pad;	<span class="hljs-comment">/* Left redzone padding size */</span><br>	<span class="hljs-type">const</span> <span class="hljs-type">char</span> *name;	<span class="hljs-comment">/* Name (only for display!) */</span><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">list_head</span> <span class="hljs-title">list</span>;</span>	<span class="hljs-comment">/* slab ç¼“å­˜é“¾è¡¨ */</span><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONFIG_SYSFS</span><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">kobject</span> <span class="hljs-title">kobj</span>;</span>	<span class="hljs-comment">/* For sysfs */</span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONFIG_SLAB_FREELIST_HARDENED</span><br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> random;	<span class="hljs-comment">// ç”¨äºåŠ å¯† freelist æŒ‡é’ˆçš„éšæœºå€¼</span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONFIG_NUMA</span><br>	<span class="hljs-comment">/*</span><br><span class="hljs-comment">	 * é€šè¿‡ä»ä¸€ä¸ª remote node åˆ†é…ä»¥å»ç¢ç‰‡åŒ–.</span><br><span class="hljs-comment">	 */</span><br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> remote_node_defrag_ratio;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONFIG_SLAB_FREELIST_RANDOM</span><br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> *random_seq;	<span class="hljs-comment">// ç”¨äºåœ¨åˆå§‹åŒ–æ—¶éšæœºåŒ– freelist</span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONFIG_KASAN</span><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">kasan_cache</span> <span class="hljs-title">kasan_info</span>;</span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONFIG_HARDENED_USERCOPY</span><br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> useroffset;	<span class="hljs-comment">/* ç”¨æˆ·æ‹·è´åŒºåŸŸçš„åç§» */</span><br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> usersize;		<span class="hljs-comment">/* ç”¨æˆ·æ‹·è´åŒºåŸŸçš„å¤§å° */</span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">kmem_cache_node</span> *<span class="hljs-title">node</span>[<span class="hljs-title">MAX_NUMNODES</span>];</span><br>&#125;;<br></code></pre></td></tr></table></figure>

<ul>
<li><p><code>cpu_slab</code>ï¼š <em>percpu å˜é‡</em> ï¼ŒæŒ‡å‘ä¸€ä¸ª <code>kmem_cache_cpu</code> ç»“æ„ä½“ï¼Œå³<strong>å½“å‰ CPU ç‹¬å çš„å†…å­˜æ± </strong></p>
</li>
<li><p><code>flags</code>ï¼šæ ‡å¿—ä½</p>
</li>
<li><p><code>min_partial</code>ï¼šnode partial é“¾è¡¨ä¸Š slab çš„<strong>æœ€å¤§æ•°é‡</strong>ï¼ˆğŸ‘´ä¹Ÿä¸çŸ¥é“ä¸ºä»€ä¹ˆè¦å«minï¼Œä½†å®é™…åˆ¤å®šå‘æŒ¥çš„æ˜¯maxçš„ä½œç”¨ï¼‰</p>
</li>
<li><p><code>size</code>ï¼šä¸€ä¸ªå¯¹è±¡çš„å®é™…å¤§å°</p>
</li>
<li><p><code>object_size</code>ï¼šä¸€ä¸ªå¯¹è±¡æ‰€ç”¨æ•°æ®çš„å¤§å°</p>
<blockquote>
<p>ä¾‹å¦‚ <code>struct cred</code> å¤§å°ä¸º 176ï¼ˆobject_sizeï¼‰ï¼Œå®é™…åˆ†é…çš„å¯¹è±¡å¤§å°ä¸º 192 ï¼ˆsizeï¼‰</p>
</blockquote>
</li>
<li><p><code>offset</code>ï¼šslab ä¸Šç©ºé—²å¯¹è±¡é“¾è¡¨æŒ‡é’ˆåœ¨å¯¹è±¡ä¸Šçš„åç§»</p>
</li>
<li><p><code>oo</code> ï¼š <em>å…¶å®å°±æ˜¯ä¸€ä¸ª int</em> </p>
<ul>
<li>ä½ 16 ä½ï¼šä¸€å¼  slab ä¸Šçš„å¯¹è±¡æ•°é‡</li>
<li>é«˜ 16 ä½ï¼šä¸€å¼  slab çš„å¤§å°ï¼ˆ2<sup>n</sup> å¼ å†…å­˜é¡µï¼‰</li>
</ul>
</li>
<li><p><code>min</code>ï¼šä¸€å¼  slab ä¸Šæœ€å°‘çš„å¯¹è±¡æ•°é‡</p>
</li>
<li><p><code>allocflags</code>ï¼šå‘ buddy system è¯·æ±‚é¡µé¢æ—¶æ‰€ç”¨çš„ gfp flag</p>
</li>
<li><p><code>ctor</code>ï¼šå¯¹è±¡çš„æ„é€ å‡½æ•°ï¼Œåœ¨åˆ†é…å¯¹è±¡åä¼šè°ƒç”¨è¯¥å‡½æ•°è¿›è¡Œåˆå§‹åŒ–</p>
</li>
<li><p><code>inuse</code>ï¼šå®é™…ä¸Šå°±æ˜¯ <code>object_size</code></p>
</li>
<li><p><code>align</code>ï¼šå¯¹è±¡å¯¹é½çš„å®½åº¦</p>
</li>
<li><p>Randomed freelist ä¿æŠ¤ç›¸å…³ï¼š</p>
<ul>
<li><code>random_seq</code> ï¼šç”¨äºåœ¨ slab åˆå§‹åŒ–æ—¶éšæœºåŒ– freelist ä¸Šç©ºé—²å¯¹è±¡çš„è¿æ¥é¡ºåº</li>
</ul>
</li>
<li><p>Hardened Usercopy ä¿æŠ¤ç›¸å…³</p>
<ul>
<li><code>useroffset</code>ï¼šç”¨æˆ·ç©ºé—´èƒ½è¯»å†™åŒºåŸŸçš„èµ·å§‹åç§»</li>
<li><code>usersize</code>ï¼šç”¨æˆ·ç©ºé—´èƒ½è¯»å†™åŒºåŸŸçš„å¤§å°</li>
</ul>
</li>
<li><p><code>node</code>ï¼šä¸€ä¸ª <code>kmem_cache_node</code> æ•°ç»„ï¼Œå¯¹åº”å¤šä¸ª<strong>ä¸åŒ node çš„åå¤‡å†…å­˜æ± </strong></p>
</li>
</ul>
<p><img src="https://s2.loli.net/2023/02/21/D4idvgzLAaqIBQM.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<h3 id="II-ç±»å‹"><a href="#II-ç±»å‹" class="headerlink" title="II. ç±»å‹"></a>II. ç±»å‹</h3><p>åˆå§‹æ—¶ä¸€å…±æœ‰å¦‚ä¸‹å‡ ç§ç±»å‹çš„ <code>kmem_cache</code>ï¼Œåœ¨è¿›è¡Œå†…å­˜åˆ†é…æ—¶è‹¥æœªæŒ‡å®šå†…å­˜æ± åˆ™ä¼šæ ¹æ®å¯¹åº”çš„ flag ä»ä¸åŒçš„ <code>kmem_cache</code> ä¸­å–ï¼š</p>
<ul>
<li><code>KMALLOC_NORMAL</code> ï¼šé€šç”¨ç±»å‹å†…å­˜æ± ï¼Œå¯¹åº” <code>kmalloc-*</code>ï¼Œå¯¹åº”åˆ†é… flag ä¸º <code>GFP_KERNEL</code></li>
<li><code>KMALLOC_DMA</code>ï¼šç”¨äº DMA çš„å†…å­˜æ± ï¼Œå¯¹åº” <code>kmalloc-dma-*</code></li>
<li><code>KMALLOC_RECLAIM</code> å¯ä»¥è¢«å›æ”¶çš„å†…å­˜æ± ï¼Œå¯¹åº” <code>kmalloc-rcl-*</code></li>
<li><code>KMALLOC_CGROUP</code> ï¼šç”¨äºéœ€è¦è¿›è¡Œæ•°é‡ç»Ÿè®¡ï¼ˆ<code>accounted</code>ï¼Œä¸»è¦ç”¨äº CGROUP ç›¸å…³ï¼‰çš„å†…å­˜æ± ï¼Œå¯¹åº” <code>kmalloc-cg-*</code> ï¼Œå¯¹åº”åˆ†é… flag ä¸º <code>GFP_KERNEL_ACCOUNT</code></li>
</ul>
<p>è‹¥æ˜¯æœªå¼€å¯å¯¹åº”çš„ç¼–è¯‘é€‰é¡¹ï¼Œåˆ™é»˜è®¤åˆå¹¶å…¥ <code>KMALLOC_NORMAL</code> </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * Whenever changing this, take care of that kmalloc_type() and</span><br><span class="hljs-comment"> * create_kmalloc_caches() still work as intended.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * KMALLOC_NORMAL can contain only unaccounted objects whereas KMALLOC_CGROUP</span><br><span class="hljs-comment"> * is for accounted but unreclaimable and non-dma objects. All the other</span><br><span class="hljs-comment"> * kmem caches can have both accounted and unaccounted objects.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-class"><span class="hljs-keyword">enum</span> <span class="hljs-title">kmalloc_cache_type</span> &#123;</span><br>	KMALLOC_NORMAL = <span class="hljs-number">0</span>,<br><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> CONFIG_ZONE_DMA</span><br>	KMALLOC_DMA = KMALLOC_NORMAL,<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> CONFIG_MEMCG_KMEM</span><br>	KMALLOC_CGROUP = KMALLOC_NORMAL,<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONFIG_SLUB_TINY</span><br>	KMALLOC_RECLAIM = KMALLOC_NORMAL,<br><span class="hljs-meta">#<span class="hljs-keyword">else</span></span><br>	KMALLOC_RECLAIM,<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONFIG_ZONE_DMA</span><br>	KMALLOC_DMA,<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONFIG_MEMCG_KMEM</span><br>	KMALLOC_CGROUP,<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>	NR_KMALLOC_TYPES<br>&#125;;<br></code></pre></td></tr></table></figure>



<h3 id="III-slab-aliasï¼ˆmergeabilityï¼‰"><a href="#III-slab-aliasï¼ˆmergeabilityï¼‰" class="headerlink" title="III. slab aliasï¼ˆmergeabilityï¼‰"></a>III. slab aliasï¼ˆmergeabilityï¼‰</h3><p>slab alias æœºåˆ¶æ˜¯ä¸€ç§å¯¹åŒç­‰&#x2F;ç›¸è¿‘å¤§å° object çš„ <code>kmem_cache</code> è¿›è¡Œ<strong>å¤ç”¨</strong>çš„ä¸€ç§æœºåˆ¶ï¼š</p>
<ul>
<li>å½“ä¸€ä¸ª <code>kmem_cache</code> åœ¨åˆ›å»ºæ—¶ï¼Œè‹¥å·²ç»å­˜åœ¨èƒ½åˆ†é…ç›¸ç­‰&#x2F;è¿‘ä¼¼å¤§å°çš„ object çš„ <code>kmem_cache</code> ï¼Œåˆ™<strong>ä¸ä¼šåˆ›å»ºæ–°çš„ kmem_cacheï¼Œè€Œæ˜¯ä¸ºåŸæœ‰çš„ kmem_cache èµ·ä¸€ä¸ª aliasï¼Œä½œä¸ºâ€œæ–°çš„â€ kmem_cache è¿”å›</strong></li>
</ul>
<blockquote>
<p>ä¸¾ä¸ªğŸŒ°ï¼Œ<code>cred_jar</code> æ˜¯ä¸“é—¨ç”¨ä»¥åˆ†é… <code>cred</code> ç»“æ„ä½“çš„ <code>kmem_cache</code>ï¼Œåœ¨ Linux 4.4 ä¹‹å‰çš„ç‰ˆæœ¬ä¸­ï¼Œå…¶ä¸º <code>kmalloc-192</code> çš„ aliasï¼Œå³ cred ç»“æ„ä½“ä¸å…¶ä»–çš„ 192 å¤§å°çš„ object éƒ½ä¼šä»åŒä¸€ä¸ª <code>kmem_cache</code>â€”â€”<code>kmalloc-192</code> ä¸­åˆ†é…</p>
</blockquote>
<p>å¯¹äºåˆå§‹åŒ–æ—¶è®¾ç½®äº† <code>SLAB_ACCOUNT</code> è¿™ä¸€ flag çš„ <code>kmem_cache</code> è€Œè¨€ï¼Œåˆ™ä¼šæ–°å»ºä¸€ä¸ªæ–°çš„ <code>kmem_cache</code> è€Œéä¸ºåŸæœ‰çš„å»ºç«‹ aliasï¼ŒğŸŒ°å¦‚åœ¨æ–°ç‰ˆçš„å†…æ ¸å½“ä¸­ <code>cred_jar</code> ä¸ <code>kmalloc-192</code> ä¾¿æ˜¯ä¸¤ä¸ªç‹¬ç«‹çš„ <code>kmem_cache</code>ï¼Œ<strong>å½¼æ­¤ä¹‹é—´äº’ä¸å¹²æ‰°</strong></p>
<h2 id="ä¸‰ã€kmem-cache-cpuï¼šå„-CPU-ç‹¬å å†…å­˜æ± "><a href="#ä¸‰ã€kmem-cache-cpuï¼šå„-CPU-ç‹¬å å†…å­˜æ± " class="headerlink" title="ä¸‰ã€kmem_cache_cpuï¼šå„ CPU ç‹¬å å†…å­˜æ± "></a>ä¸‰ã€kmem_cache_cpuï¼šå„ CPU ç‹¬å å†…å­˜æ± </h2><p>å½“è¿›ç¨‹å‘ slab allocator è¯·æ±‚å†…å­˜åˆ†é…æ—¶ï¼Œé¦–å…ˆä¼šå°è¯•ä»å½“å‰ CPU çš„ç‹¬å å†…å­˜æ± è¿›è¡Œåˆ†é… â€”â€”<code>kmem_cache_cpu</code> ç»“æ„ä½“è¡¨ç¤º<strong>æ¯ä¸ª CPU ç‹¬å çš„å†…å­˜æ± </strong>ï¼Œå…¶åœ¨ <code>kmem_cache</code> ä¸­ä¸ºä¸€ä¸ª percpu å˜é‡ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * When changing the layout, make sure freelist and tid are still compatible</span><br><span class="hljs-comment"> * with this_cpu_cmpxchg_double() alignment requirements.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">kmem_cache_cpu</span> &#123;</span><br>	<span class="hljs-type">void</span> **freelist;	<span class="hljs-comment">/* æŒ‡å‘ä¸‹ä¸€ä¸ªå¯ç”¨å¯¹è±¡çš„æŒ‡é’ˆ */</span><br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> tid;	<span class="hljs-comment">/* Globally unique transaction id */</span><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">slab</span> *<span class="hljs-title">slab</span>;</span>	<span class="hljs-comment">/* ç”¨ä»¥å†…å­˜åˆ†é…çš„ slab */</span><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONFIG_SLUB_CPU_PARTIAL</span><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">slab</span> *<span class="hljs-title">partial</span>;</span>	<span class="hljs-comment">/* Partially allocated frozen slabs */</span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>	<span class="hljs-type">local_lock_t</span> lock;	<span class="hljs-comment">/* Protects the fields above */</span><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONFIG_SLUB_STATS</span><br>	<span class="hljs-type">unsigned</span> stat[NR_SLUB_STAT_ITEMS];<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>&#125;;<br></code></pre></td></tr></table></figure>

<ul>
<li><code>freelist</code>ï¼šæŒ‡å‘ä¸‹ä¸€ä¸ªç©ºé—²å¯¹è±¡çš„æŒ‡é’ˆ</li>
<li><code>slab</code>ï¼šå½“å‰ç”¨ä»¥è¿›è¡Œå†…å­˜åˆ†é…çš„ slab</li>
<li><code>partial</code>ï¼špercpu partial slab é“¾è¡¨ï¼Œé“¾è¡¨ä¸Šä¸ºä»æœ‰ä¸€å®šç©ºé—²å¯¹è±¡çš„ slab</li>
</ul>
<p>slab çš„ freelist ä»…å½“å…¶åœ¨ partial é“¾è¡¨ä¸Šæ—¶æœ‰ç”¨ï¼Œå½“ä¸€å¼  slab ä¸ºå½“å‰ CPU æ­£åœ¨ä½¿ç”¨çš„ slab æ—¶ï¼Œå…¶ freelist ä¸º NULLï¼Œç”± <code>kmem_cache_cpu.freelist</code> æŒ‡å‘ç¬¬ä¸€ä¸ªç©ºé—²å¯¹è±¡</p>
<p><img src="https://s2.loli.net/2023/02/21/xSLqghNZ23nCMiz.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<h2 id="å››ã€kmem-cache-nodeï¼šå„-node-åå¤‡å†…å­˜æ± "><a href="#å››ã€kmem-cache-nodeï¼šå„-node-åå¤‡å†…å­˜æ± " class="headerlink" title="å››ã€kmem_cache_nodeï¼šå„ node åå¤‡å†…å­˜æ± "></a>å››ã€kmem_cache_nodeï¼šå„ node åå¤‡å†…å­˜æ± </h2><p><strong>æ¯ä¸ª <a target="_blank" rel="noopener" href="https://arttnba3.cn/2021/11/28/OS-0X02-LINUX-KERNEL-MEMORY-5.11-PART-I/#0x03-struct-pglist-data%EF%BC%9A%E8%8A%82%E7%82%B9">node</a> å¯¹åº”çš„åå¤‡å†…å­˜æ± </strong>ï¼Œå½“ percpu çš„ç‹¬å å†…å­˜æ± è€—å°½åä¾¿ä¼šä»å¯¹åº” node çš„åå¤‡å†…å­˜æ± å°è¯•åˆ†é…</p>
<blockquote>
<p>ä¸è¿‡å¤§éƒ¨åˆ†è®¡ç®—æœºéƒ½ä»…æœ‰ä¸€ä¸ª nodeï¼Œæ‰€ä»¥é€šå¸¸æƒ…å†µä¸‹æ¯ä¸ª <code>kmem_cache</code> ä¹Ÿå°±åªæœ‰ä¸€ä¸ª <code>kmem_cache_node</code>  ğŸ˜„</p>
</blockquote>
<p>å› ä¸ºæœ¬æ–‡ä¸»è¦è®² slubï¼Œæ‰€ä»¥ä»…æˆªå– slub ç›¸å…³å­—æ®µï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> CONFIG_SLOB</span><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * The slab lists for all objects.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">kmem_cache_node</span> &#123;</span><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONFIG_SLAB</span><br>	<span class="hljs-comment">//...</span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONFIG_SLUB</span><br>	<span class="hljs-type">spinlock_t</span> list_lock;<br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> nr_partial;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">list_head</span> <span class="hljs-title">partial</span>;</span><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONFIG_SLUB_DEBUG</span><br>	<span class="hljs-type">atomic_long_t</span> nr_slabs;<br>	<span class="hljs-type">atomic_long_t</span> total_objects;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">list_head</span> <span class="hljs-title">full</span>;</span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br>&#125;;<br></code></pre></td></tr></table></figure>

<ul>
<li><code>list_lock</code>ï¼šä¿æŠ¤ partial å’Œ full é“¾è¡¨çš„é”</li>
<li><code>partial</code>ï¼špartial slab é“¾è¡¨ï¼Œè¿æ¥<strong>æœ‰ç€éƒ¨åˆ†ç©ºé—²å¯¹è±¡å‰©ä½™çš„ slab</strong></li>
<li><code>nr_partial</code>ï¼špartial slab çš„æ•°é‡</li>
<li><code>full</code>ï¼šfull slab é“¾è¡¨ï¼Œè¿æ¥<strong>ç©ºé—²å¯¹è±¡å®Œå…¨è€—å°½çš„ slab</strong>ï¼ˆæ³¨ï¼šè¯¥é“¾è¡¨åŸºæœ¬ä¸Šä¸å¸¸ç”¨ï¼‰</li>
<li><code>nr_slabs</code>ï¼šæ€»çš„ slab æ•°é‡</li>
<li><code>total_objects</code>ï¼šæ€»çš„å¯¹è±¡æ•°é‡</li>
</ul>
<p><img src="https://s2.loli.net/2023/02/21/ECDOVtxAyiwd1UZ.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<h1 id="0x02-å¯¹è±¡çš„åˆ†é…"><a href="#0x02-å¯¹è±¡çš„åˆ†é…" class="headerlink" title="0x02. å¯¹è±¡çš„åˆ†é…"></a>0x02. å¯¹è±¡çš„åˆ†é…</h1><h2 id="â€»-ä¸€ã€slab-alloc-node-ï¼šä»æŒ‡å®šçš„-kmem-cache-åˆ†é…-object"><a href="#â€»-ä¸€ã€slab-alloc-node-ï¼šä»æŒ‡å®šçš„-kmem-cache-åˆ†é…-object" class="headerlink" title="â€» ä¸€ã€slab_alloc_node()ï¼šä»æŒ‡å®šçš„ kmem_cache åˆ†é… object"></a>â€» ä¸€ã€slab_alloc_node()ï¼šä»æŒ‡å®šçš„ kmem_cache åˆ†é… object</h2><p>åœ¨ slab allocator ä¸­å­˜åœ¨ç€å¤šä¸ªä¸åŒçš„å†…å­˜åˆ†é…æ¥å£ï¼Œå…¶æœ€åéƒ½ä¼šè°ƒç”¨åˆ° <code>slab_alloc_node()</code> å®Œæˆå†…å­˜åˆ†é…çš„å·¥ä½œï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * å†…è”åŒ–çš„å¿«é€Ÿè·¯å¾„ä»¥è®©åˆ†é…å‡½æ•° (kmalloc, kmem_cache_alloc) ä¸­åŒ…å«å¿«é€Ÿè·¯å¾„.</span><br><span class="hljs-comment"> * å› æ­¤ï¼Œå¯¹äºå¿«é€Ÿè·¯å¾„å¯ä»¥æ»¡è¶³çš„è¯·æ±‚ï¼Œæ²¡æœ‰å‡½æ•°è°ƒç”¨çš„å¼€é”€.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * å¿«é€Ÿè·¯å¾„é¦–å…ˆæ£€æŸ¥æ— é”çš„ç©ºé—²é“¾è¡¨æ˜¯å¦å¯ä»¥è¢«ä½¿ç”¨.</span><br><span class="hljs-comment"> * è‹¥å¦ï¼Œè°ƒç”¨ __slab_alloc è¿›è¡Œç¼“æ…¢å¤„ç†.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * å¦åˆ™æˆ‘ä»¬å¯ä»¥ç®€å•åœ°ä»æ— é”ç©ºé—²é“¾è¡¨å–å‡ºä¸‹ä¸€ä¸ªå¯¹è±¡.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">static</span> __fastpath_inline <span class="hljs-type">void</span> *<span class="hljs-title function_">slab_alloc_node</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> kmem_cache *s, <span class="hljs-keyword">struct</span> list_lru *lru,</span><br><span class="hljs-params">		<span class="hljs-type">gfp_t</span> gfpflags, <span class="hljs-type">int</span> node, <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> addr, <span class="hljs-type">size_t</span> orig_size)</span><br>&#123;<br>	<span class="hljs-type">void</span> *object;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">obj_cgroup</span> *<span class="hljs-title">objcg</span> =</span> <span class="hljs-literal">NULL</span>;<br>	<span class="hljs-type">bool</span> init = <span class="hljs-literal">false</span>;<br></code></pre></td></tr></table></figure>

<p>è¯¥å‡½æ•°é¦–å…ˆä¼šè°ƒç”¨ <code>slab_pre_alloc_hook()</code> è¿›è¡Œåˆ†é…å‰çš„æ£€æŸ¥å·¥ä½œï¼Œä¸é€šè¿‡åˆ™è¿”å› NULLï¼Œè¿™ä¸€æ­¥ä¸»è¦æ˜¯æ£€æŸ¥åˆ†é…æ ‡å¿—ä½æ˜¯å¦åˆæ³•ç­‰ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs c">s = slab_pre_alloc_hook(s, lru, &amp;objcg, <span class="hljs-number">1</span>, gfpflags);<br><span class="hljs-keyword">if</span> (!s)<br>	<span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;<br></code></pre></td></tr></table></figure>

<p>æ¥ä¸‹æ¥è°ƒç”¨ <code>kfence_alloc()</code> è¿›è¡Œå†…å­˜é”™è¯¯æ£€æµ‹ï¼Œä¸é€šè¿‡åˆ™ç›´æ¥è·³è½¬åˆ° <code>out</code>ï¼Œè¿™é‡Œç”¨åˆ°äº† <em>Kfence (Kernel Electric Fence)</em>  å†…å­˜çº é”™æœºåˆ¶ï¼Œä¸»è¦æ˜¯æ£€æŸ¥å¯¹ <code>data page</code> çš„è®¿é—®æ˜¯å¦è¶Šç•Œï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs c">object = kfence_alloc(s, orig_size, gfpflags);<br><span class="hljs-keyword">if</span> (unlikely(object))<br>	<span class="hljs-keyword">goto</span> out;<br></code></pre></td></tr></table></figure>

<p><strong>æ¥ä¸‹æ¥è°ƒç”¨ <code>__slab_alloc_node()</code> è¿›è¡Œæ­£å¼çš„å†…å­˜åˆ†é…ï¼Œè¿™ä¸€æ­¥ä¾¿æ˜¯çœŸæ­£çš„æ ¸å¿ƒåˆ†é…å‡½æ•°</strong>ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c">object = __slab_alloc_node(s, gfpflags, node, addr, orig_size);<br></code></pre></td></tr></table></figure>

<p>æœ€åè°ƒç”¨ <code>maybe_wipe_obj_freeptr()</code> å°† object åŸæœ¬å­˜æ”¾ next free object æŒ‡é’ˆçš„ä½ç½®æ¸…é›¶ï¼Œä¹‹åè°ƒç”¨ <code>slab_want_init_on_alloc()</code> æ£€æŸ¥æ ‡å¿—ä½æ˜¯å¦æœ‰ <code>__GFP_ZERO</code>ï¼Œè‹¥æœ‰åˆ™è°ƒç”¨ <code>slab_post_alloc_hook()</code> å°† object ä¸Šæ•°æ®æ¸…é›¶</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs c">	maybe_wipe_obj_freeptr(s, object);<br>	init = slab_want_init_on_alloc(gfpflags, s);<br><br>out:<br>	<span class="hljs-comment">/*</span><br><span class="hljs-comment">	 * å½“ init == &#x27;true&#x27;, ç±»ä¼¼ kzalloc() æ—, </span><br><span class="hljs-comment">	 * ä»…æœ‰ @orig_size å­—èŠ‚ä¼šè¢«æ¸…é›¶ï¼Œè€Œé s-&gt;object_size</span><br><span class="hljs-comment">	 */</span><br>	slab_post_alloc_hook(s, objcg, gfpflags, <span class="hljs-number">1</span>, &amp;object, init, orig_size);<br><br>	<span class="hljs-keyword">return</span> object;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>æ¥ä¸‹æ¥æˆ‘ä»¬æ¥çœ‹çœŸæ­£çš„æ ¸å¿ƒåˆ†é…å‡½æ•° <code>__slab_alloc_node()</code></p>
<h3 id="I-slab-alloc-node-ï¼šä»-percpu-freelist-è¿›è¡Œåˆ†é…ï¼ˆfast-pathï¼‰"><a href="#I-slab-alloc-node-ï¼šä»-percpu-freelist-è¿›è¡Œåˆ†é…ï¼ˆfast-pathï¼‰" class="headerlink" title="I. __slab_alloc_node()ï¼šä» percpu freelist è¿›è¡Œåˆ†é…ï¼ˆfast pathï¼‰"></a>I. __slab_alloc_node()ï¼šä» percpu freelist è¿›è¡Œåˆ†é…ï¼ˆfast pathï¼‰</h3><p>è¯¥å‡½æ•°é¦–å…ˆä¼šå…ˆè·å– percpu çš„ <code>kmem_cache_cpu</code> ä¸Šçš„ freelist ä¸ slabï¼Œ<strong>è‹¥ slab æˆ– freelist ä¸ºç©º</strong> &#x2F; slab ä¸ node ä¸åŒ¹é…ï¼Œåˆ™è°ƒç”¨ <code>__slab_alloc()</code> åˆ†é…ä¸€å¼ æ–° slab å¹¶ä»å…¶ä¸­è·å–ä¸€ä¸ªç©ºé—²å¯¹è±¡ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> __always_inline <span class="hljs-type">void</span> *__slab_alloc_node(<span class="hljs-keyword">struct</span> kmem_cache *s,<br>		<span class="hljs-type">gfp_t</span> gfpflags, <span class="hljs-type">int</span> node, <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> addr, <span class="hljs-type">size_t</span> orig_size)<br>&#123;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">kmem_cache_cpu</span> *<span class="hljs-title">c</span>;</span><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">slab</span> *<span class="hljs-title">slab</span>;</span><br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> tid;<br>	<span class="hljs-type">void</span> *object;<br><br>redo:<br>	<span class="hljs-comment">/*</span><br><span class="hljs-comment">	 * å¿…é¡»é€šè¿‡è¯¥ cpu ptr è¯»å– kmem_cache cpu æ•°æ®. æŠ¢å æ˜¯å¼€å¯çš„.</span><br><span class="hljs-comment">	 * æˆ‘ä»¬å¯èƒ½ä¼šåœ¨ä»ä¸€ä¸ª cpu åŒºåŸŸè¯»å–æ—¶åœ¨ cpu é—´åˆ‡æ¢.</span><br><span class="hljs-comment">	 * åªè¦æˆ‘ä»¬åœ¨ cmpxchg æ—¶åœ¨åŸæœ¬çš„ cpu ä¸Šé‡æ–°ç»“æŸä¾¿ä¸è¦ç´§.</span><br><span class="hljs-comment">	 *</span><br><span class="hljs-comment">	 * æˆ‘ä»¬å¿…é¡»ä¿è¯ tid ä¸ kmem_cache_cpu è¢«åœ¨åŒä¸€ cpu ä¸Šå–å›.</span><br><span class="hljs-comment">	 * æˆ‘ä»¬é¦–å…ˆè¯»å– kmem_cache_cpu æŒ‡é’ˆå¹¶ç”¨å…¶è¯»å– tid.</span><br><span class="hljs-comment">	 * è‹¥æˆ‘ä»¬åœ¨ä¸¤æ¬¡è¯»å–é—´è¢«æŠ¢å å¹¶åˆ‡æ¢åˆ°å¦ä¸€ cpuï¼Œç”±äºè¿™ä¸¤è€…ä»ä¸åŒä¸€ cpu å…³è”ï¼Œ</span><br><span class="hljs-comment">	 * cmpxchg ç¨åå°†ä¼šéªŒè¯ cpu ï¼Œè¿™æ˜¯ OK çš„.</span><br><span class="hljs-comment">	 */</span><br>	c = raw_cpu_ptr(s-&gt;cpu_slab);<br>	tid = READ_ONCE(c-&gt;tid);<br><br>	<span class="hljs-comment">/*</span><br><span class="hljs-comment">	 * æ­¤å¤„ä½¿ç”¨çš„æ— ä¸­æ–­ï¼ˆirqlessï¼‰ å¯¹è±¡åˆ†é…/é‡Šæ”¾ç®—æ³•å†³å®šäºè·å– cpu_slab æ•°æ®çš„é¡ºåº.</span><br><span class="hljs-comment">	 * tid åº”å½“åœ¨åœ¨ c ä¸Šçš„ä»»ä½•äº‹ä¹‹å‰è¢«è·å–ä»¥ç¡®ä¿ä¸æ­¤å‰ tid å…³è”çš„å¯¹è±¡ä¸ slab</span><br><span class="hljs-comment">	 * ä¸ä¼šè¢«ä¸å½“å‰ tid ä¸€èµ·ä½¿ç”¨. è‹¥æˆ‘ä»¬å…ˆè·å– tidï¼Œå¯¹è±¡ä¸ slab å¯èƒ½ä¼šä¸ä¸‹ä¸€ä¸ª tid </span><br><span class="hljs-comment">	 * ç›¸å…³è”ï¼Œè€Œæˆ‘ä»¬çš„åˆ†é…/é‡Šæ”¾è¯·æ±‚ä¹Ÿå°†ä¼šå¤±è´¥.è¿™ç§æƒ…å†µä¸‹æˆ‘ä»¬ä¼šé‡è¯•æ‰€ä»¥æ²¡é—®é¢˜.</span><br><span class="hljs-comment">	 */</span><br>	barrier();<br><br>	<span class="hljs-comment">/*</span><br><span class="hljs-comment">	 * The transaction ids are globally unique per cpu and per operation on</span><br><span class="hljs-comment">	 * a per cpu queueï¼ˆè¿™å¥ç¿»æˆä¸­æ–‡å’‹éƒ½ä¸é¡ºï¼Œç›´æ¥çœ‹åŸæ–‡å§ğŸ˜„ï¼‰.</span><br><span class="hljs-comment">	 * ç”±æ­¤å¯ä»¥ç¡®ä¿ cmpxchg_double å‘ç”Ÿåœ¨æ­£ç¡®çš„å¤„ç†å™¨ä¸Šä¸”å…¶é—´åœ¨é“¾è¡¨ä¸Šæ²¡æœ‰ä»»ä½•æ“ä½œ.</span><br><span class="hljs-comment">	 */</span><br><br>	object = c-&gt;freelist;<br>	slab = c-&gt;slab;<br><br>	<span class="hljs-keyword">if</span> (!USE_LOCKLESS_FAST_PATH() ||<br>	    unlikely(!object || !slab || !node_match(slab, node))) &#123;<br>		object = __slab_alloc(s, gfpflags, node, addr, c, orig_size);<br></code></pre></td></tr></table></figure>

<p>è‹¥æœ‰ freelist &amp; slubï¼Œåˆ™<strong>è°ƒç”¨ <code>get_freepointer_safe()</code> è·å–å½“å‰ç©ºé—²å¯¹è±¡ä¸‹ä¸€ä¸ªç©ºé—²å¯¹è±¡</strong>ï¼›æ¥ä¸‹æ¥ <code>this_cpu_cmpxchg_double()</code> ä¼šæ£€æŸ¥æ˜¯å¦ <code>freelist == object</code>ã€<code>cpu_slab-&gt;tid == tid</code>ï¼Œè‹¥æ˜¯åˆ™<strong>å°† freelist è®¾ä¸º next_object å¹¶è·å–è®¾ç½®ä¸‹ä¸€ tid</strong>ï¼Œå¦åˆ™è¯´æ˜å‘ç”Ÿäº†æŠ¢å ï¼ˆæˆ‘ä»¬å·²ç»ä¸åœ¨åŸ cpu ä¸Šäº†ï¼‰ï¼Œè·³è½¬å› <code>redo</code> é‡æ–°åœ¨å½“å‰ cpu ä¸Šè¿›è¡Œåˆ†é…ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs c">&#125; <span class="hljs-keyword">else</span> &#123;<br>	<span class="hljs-type">void</span> *next_object = get_freepointer_safe(s, object);<br><br>	<span class="hljs-comment">/*</span><br><span class="hljs-comment">	 * ä»…å½“æ²¡æœ‰é¢å¤–æ“ä½œä¸”æˆ‘ä»¬åœ¨æ­£ç¡®çš„å¤„ç†å™¨ä¸Šæ—¶ cmpxchg å°†åŒ¹é….</span><br><span class="hljs-comment">	 *</span><br><span class="hljs-comment">	 * cmpxchg åŸå­åœ°è¿›è¡Œäº†å¦‚ä¸‹ï¼š (æ²¡æœ‰é”è¯­ä¹‰!)</span><br><span class="hljs-comment">	 * 1. é‡å®šä½ç¬¬ä¸€ä¸ªæŒ‡é’ˆåˆ°å½“å‰çš„ per cpu åŒºåŸŸ.</span><br><span class="hljs-comment">	 * 2. éªŒè¯ tid &amp; freelist æ²¡æœ‰è¢«æ”¹å˜</span><br><span class="hljs-comment">	 * 3. è‹¥æœªè¢«æ”¹å˜ï¼Œæ›¿æ¢ tid &amp; freelist</span><br><span class="hljs-comment">	 *</span><br><span class="hljs-comment">	 * è‡ªä»æ²¡æœ‰é”è¯­ä¹‰ï¼Œä¿æŠ¤ä»…éœ€è¦å¯¹æŠ—åœ¨è¯¥ cpu ä¸Šæ‰§è¡Œçš„ä»£ç *ä¸*ä»å…¶ä»–çš„ cpu ä¸Šè®¿é—®.</span><br><span class="hljs-comment">	 */</span><br>	<span class="hljs-keyword">if</span> (unlikely(!this_cpu_cmpxchg_double(<br>			s-&gt;cpu_slab-&gt;freelist, s-&gt;cpu_slab-&gt;tid,<br>			object, tid,<br>			next_object, next_tid(tid)))) &#123;<br><br>		note_cmpxchg_failure(<span class="hljs-string">&quot;slab_alloc&quot;</span>, s, tid);<br>		<span class="hljs-keyword">goto</span> redo;<br>	&#125;<br></code></pre></td></tr></table></figure>

<p>æœ€åå¯¹äºç›´æ¥ä» cpu_slab ä¸Šåˆ†é…çš„å¯¹è±¡ä¼šé€šè¿‡ <code>prefetch_freepointer()</code> è°ƒç”¨ prefetchw æŒ‡ä»¤æå‰å°†å·²åˆ†é…å¯¹è±¡çš„åœ°å€è½½å…¥ç¼“å­˜ä¸­ï¼Œä¹‹åå°±æ˜¯è¿”å›åˆ†é…æˆåŠŸçš„ç©ºé—²å¯¹è±¡</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs c">		prefetch_freepointer(s, next_object);<br>		stat(s, ALLOC_FASTPATH);<br>	&#125;<br><br>	<span class="hljs-keyword">return</span> object;<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="II-slab-alloc-ï¼šè·å–å¦ä¸€-slab-è¿›è¡Œåˆ†é…ï¼ˆslow-pathï¼‰"><a href="#II-slab-alloc-ï¼šè·å–å¦ä¸€-slab-è¿›è¡Œåˆ†é…ï¼ˆslow-pathï¼‰" class="headerlink" title="II. ___slab_alloc()ï¼šè·å–å¦ä¸€ slab è¿›è¡Œåˆ†é…ï¼ˆslow pathï¼‰"></a>II. ___slab_alloc()ï¼šè·å–å¦ä¸€ slab è¿›è¡Œåˆ†é…ï¼ˆslow pathï¼‰</h3><p><code>__slab_alloc()</code> å…¶å®æ˜¯åœ¨å¼€å¯äº†æŠ¢å çš„æƒ…å†µä¸‹ï¼ˆé»˜è®¤å¼€å¯ï¼‰å¯¹ <code>___slab_alloc()</code> çš„ä¸€ä¸ªç®€å•çš„ wrapperï¼Œä¸»è¦å°±æ˜¯é‡æ–°è¯»å– <code>kmem_cache_cpu</code> çš„æŒ‡é’ˆï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * å½“æŠ¢å æ²¡æœ‰å…³é—­æ—¶ ___slab_alloc() ç”¨äºä¸Šä¸‹æ–‡çš„ wrapper.</span><br><span class="hljs-comment"> * é€šè¿‡é‡æ–°è·å– percpu åŒºåŸŸçš„æŒ‡é’ˆæ¥è¡¥å¿å¯èƒ½çš„ cpu æ›´æ”¹.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> *__slab_alloc(<span class="hljs-keyword">struct</span> kmem_cache *s, <span class="hljs-type">gfp_t</span> gfpflags, <span class="hljs-type">int</span> node,<br>			  <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> addr, <span class="hljs-keyword">struct</span> kmem_cache_cpu *c, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> orig_size)<br>&#123;<br>	<span class="hljs-type">void</span> *p;<br><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONFIG_PREEMPT_COUNT</span><br>	<span class="hljs-comment">/*</span><br><span class="hljs-comment">	 * æˆ‘ä»¬å¯èƒ½å·²è¢«æŠ¢å ä¸”åœ¨å…³é—­æŠ¢å å‰è°ƒåº¦åˆ°äº†ä¸åŒçš„ cpu ä¸Š.</span><br><span class="hljs-comment">	 * éœ€è¦é‡æ–°è½½å…¥ cpu åŒºåŸŸæŒ‡é’ˆ.</span><br><span class="hljs-comment">	 */</span><br>	c = slub_get_cpu_ptr(s-&gt;cpu_slab);<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br>	p = ___slab_alloc(s, gfpflags, node, addr, c, orig_size);<br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONFIG_PREEMPT_COUNT</span><br>	slub_put_cpu_ptr(s-&gt;cpu_slab);<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>	<span class="hljs-keyword">return</span> p;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>æ¥ä¸‹æ¥æˆ‘ä»¬æ¥çœ‹ <code>___slab_alloc()</code>ï¼Œè¯¥å‡½æ•°ä¾¿æ˜¯æ…¢é€Ÿåˆ†é…è·¯å¾„çš„æ ¸å¿ƒå‡½æ•°ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * æ…¢é€Ÿè·¯å¾„. æ— é” freelist ä¸ºç©ºæˆ–æ˜¯æˆ‘ä»¬éœ€è¦è¿›è¡Œè°ƒè¯•ä»»åŠ¡.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * è‹¥æ–°çš„å¯¹è±¡å·²ç»è¢«é‡Šæ”¾åˆ°å¸¸è§„çš„ freelist ä¸Šï¼Œåˆ™è¿‡ç¨‹ä»æ˜¯å¾ˆå¿«çš„.</span><br><span class="hljs-comment"> * è¿™ç§æƒ…å†µä¸‹æˆ‘ä»¬ç®€å•åœ°è®©å¸¸è§„çš„ freelist å–ä»£æ— é” freelist</span><br><span class="hljs-comment"> * å¹¶ zap the regular freelist.ï¼ˆzapæƒ³ä¸å‡ºå’‹ç¿»è¯‘å¥½ğŸ˜„ï¼‰</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * è‹¥è¿™ä¸èµ·ä½œç”¨ï¼Œåˆ™æˆ‘ä»¬å›é€€åˆ° partial é“¾è¡¨. æˆ‘ä»¬å°† freelist ä¸Šçš„ç¬¬ä¸€ä¸ªå…ƒç´ </span><br><span class="hljs-comment"> * ä½œä¸ºè¦åˆ†é…çš„å¯¹è±¡å¹¶å°† freelist çš„å‰©ä½™éƒ¨åˆ†ç§»åŠ¨åˆ°æ— é” freelist.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * è‹¥æˆ‘ä»¬æ— æ³•ä» partial slab é“¾è¡¨ä¸Šè·å¾—ä¸€ä¸ªæ–°çš„ slabï¼Œæˆ‘ä»¬éœ€è¦åˆ†é…ä¸€ä¸ªæ–°çš„ slab.</span><br><span class="hljs-comment"> * å› ä¸ºè¿™åŒ…å«å¯¹é¡µåˆ†é…å™¨çš„è°ƒç”¨ä¸æ–° slab çš„è®¾ç½®ï¼Œè¿™æ˜¯æœ€æ…¢çš„è·¯å¾„.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * å½“æˆ‘ä»¬çŸ¥é“æŠ¢å è¢«ç¦ç”¨æ—¶æ‰€ç”¨çš„ __slab_alloc çš„ç‰ˆæœ¬ (ä¹Ÿæ˜¯é€ æˆå¤§é‡åˆ†é…çš„åŸå› ).</span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> *___slab_alloc(<span class="hljs-keyword">struct</span> kmem_cache *s, <span class="hljs-type">gfp_t</span> gfpflags, <span class="hljs-type">int</span> node,<br>			  <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> addr, <span class="hljs-keyword">struct</span> kmem_cache_cpu *c, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> orig_size)<br>&#123;<br>	<span class="hljs-type">void</span> *freelist;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">slab</span> *<span class="hljs-title">slab</span>;</span><br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> flags;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">partial_context</span> <span class="hljs-title">pc</span>;</span><br><br>	stat(s, ALLOC_SLOWPATH);<br></code></pre></td></tr></table></figure>

<p>æ¥ä¸‹æ¥ç¬”è€…æŒ‰ç…§ä»£ç æ ‡ç­¾é¡ºåºè¿›è¡Œåˆ†æ</p>
<h4 id="â‘ -reread-slabï¼šè¯»å–-percpu-slab"><a href="#â‘ -reread-slabï¼šè¯»å–-percpu-slab" class="headerlink" title="â‘  reread_slabï¼šè¯»å– percpu slab"></a>â‘  reread_slabï¼šè¯»å– percpu slab</h4><p>é¦–å…ˆè¯»å– percpu çš„ slabï¼Œè‹¥æ²¡æœ‰ slab åˆ™åˆ¤æ–­åˆ†é…èŠ‚ç‚¹ï¼Œå¹¶è·³è½¬åˆ° <code>new_slab</code> åˆ†é…æ–°çš„ slabï¼Œæ³¨æ„è¿™ä¸€å—ä»£ç å¯¹åº” <code>reread_slab</code> æ ‡ç­¾ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs c">reread_slab:<br><br>	slab = READ_ONCE(c-&gt;slab);<br>	<span class="hljs-keyword">if</span> (!slab) &#123;<br>		<span class="hljs-comment">/*</span><br><span class="hljs-comment">		 * è‹¥ node æœªä¸Šçº¿æˆ–æ²¡æœ‰ normal memoryï¼Œå¿½ç•¥ node çº¦æŸ</span><br><span class="hljs-comment">		 */</span><br>		<span class="hljs-keyword">if</span> (unlikely(node != NUMA_NO_NODE &amp;&amp;<br>			     !node_isset(node, slab_nodes)))<br>			node = NUMA_NO_NODE;<br>		<span class="hljs-keyword">goto</span> new_slab;<br>	&#125;<br></code></pre></td></tr></table></figure>

<h4 id="â‘¡-redoï¼šè·å–-percpu-slab-gt-freelist"><a href="#â‘¡-redoï¼šè·å–-percpu-slab-gt-freelist" class="headerlink" title="â‘¡ redoï¼šè·å– percpu slab-&gt;freelist"></a>â‘¡ redoï¼šè·å– percpu slab-&gt;freelist</h4><p>æ¥ä¸‹æ¥è¿™å—ä»£ç å¯¹åº” <code>redo</code> æ ‡ç­¾ï¼š</p>
<ul>
<li><p>è‹¥ percpu slab ä¸ä¸ºç©ºï¼Œåˆ¤æ–­ slab æ˜¯å¦å±äºæŒ‡å®šçš„èŠ‚ç‚¹ä¸”ä¸åˆ†é…æ ‡å¿—ä½åŒ¹é…ï¼Œè‹¥å¦ï¼Œåˆ™è·³è½¬åˆ° <code>deactivate_slab</code> æ ‡ç­¾</p>
</li>
<li><p>æ¥ä¸‹æ¥æ£€æŸ¥ slab æ˜¯å¦ä»ä¸ºåŸæ¥çš„ cpu slabï¼ˆå› ä¸ºæˆ‘ä»¬å¯èƒ½è¢«æŠ¢å ï¼‰ï¼Œè‹¥å¦ï¼Œåˆ™è·³è½¬å› <code>reread_slab</code></p>
</li>
<li><p>æ¥ä¸‹æ¥è·å– per-cpu çš„ freelistï¼Œè‹¥ä¸ä¸ºç©ºï¼Œåˆ™è·³è½¬åˆ° <code>load_freelist</code>ï¼Œå¦åˆ™<strong>è°ƒç”¨ <code>get_freelist()</code> è·å– slab çš„ freelist</strong></p>
</li>
<li><p>è‹¥ slab çš„ freelist ä»ä¸ºç©ºï¼Œå°† per-cpu freelist è®¾ä¸º NULLï¼Œè·å–ä¸‹ä¸€ä¸ª tidï¼Œå¹¶è·³è½¬åˆ° <code>new_slab</code> åˆ†é…æ–°çš„ slab</p>
</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><code class="hljs c">redo:<br><br>	<span class="hljs-keyword">if</span> (unlikely(!node_match(slab, node))) &#123;<br>		<span class="hljs-comment">/*</span><br><span class="hljs-comment">		 * ä¸ä¸Šé¢ç›¸åŒä½† node_match() ä¸º false åˆ™æ—©å·²è¯´æ˜ node != NUMA_NO_NODE</span><br><span class="hljs-comment">		 */</span><br>		<span class="hljs-keyword">if</span> (!node_isset(node, slab_nodes)) &#123;<br>			node = NUMA_NO_NODE;<br>		&#125; <span class="hljs-keyword">else</span> &#123;<br>			stat(s, ALLOC_NODE_MISMATCH);<br>			<span class="hljs-keyword">goto</span> deactivate_slab;<br>		&#125;<br>	&#125;<br><br>	<span class="hljs-comment">/*</span><br><span class="hljs-comment">	 * æˆ‘ä»¬ç†åº”æœç´¢ä¸€ä¸ª PFMEMALLOC çš„ slab é¡µé¢ï¼Œä½†ç°åœ¨ï¼Œ</span><br><span class="hljs-comment">	 * å½“é¡µé¢ç¦»å¼€ per-cpu åˆ†é…å™¨ï¼Œæˆ‘ä»¬æ­£åœ¨å¤±å» pfmemalloc ä¿¡æ¯</span><br><span class="hljs-comment">	 */</span><br>	<span class="hljs-keyword">if</span> (unlikely(!pfmemalloc_match(slab, gfpflags)))<br>		<span class="hljs-keyword">goto</span> deactivate_slab;<br><br>	<span class="hljs-comment">/* å¿…é¡»å†æ¬¡æ£€æŸ¥ c-&gt;slab ä»¥å…æˆ‘ä»¬è¢«æŠ¢å ä½¿å…¶å‘ç”Ÿäº†æ›´æ”¹ */</span><br>	local_lock_irqsave(&amp;s-&gt;cpu_slab-&gt;lock, flags);<br>	<span class="hljs-keyword">if</span> (unlikely(slab != c-&gt;slab)) &#123;<br>		local_unlock_irqrestore(&amp;s-&gt;cpu_slab-&gt;lock, flags);<br>		<span class="hljs-keyword">goto</span> reread_slab;<br>	&#125;<br>	freelist = c-&gt;freelist;<br>	<span class="hljs-keyword">if</span> (freelist)<br>		<span class="hljs-keyword">goto</span> load_freelist;<br><br>	freelist = get_freelist(s, slab);<br><br>	<span class="hljs-keyword">if</span> (!freelist) &#123;<br>		c-&gt;slab = <span class="hljs-literal">NULL</span>;<br>		c-&gt;tid = next_tid(c-&gt;tid);<br>		local_unlock_irqrestore(&amp;s-&gt;cpu_slab-&gt;lock, flags);<br>		stat(s, DEACTIVATE_BYPASS);<br>		<span class="hljs-keyword">goto</span> new_slab;<br>	&#125;<br><br>	stat(s, ALLOC_REFILL);<br></code></pre></td></tr></table></figure>

<p><code>get_freelist()</code> å‡½æ•°ä¸»è¦å°±æ˜¯è·å– <code>slab-&gt;freelist</code> åå°† <code>slab-&gt;freelist</code> è®¾ä¸º NULL å¹¶è¿”å›åŸæ¥çš„ freelist</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * æ£€æŸ¥ slab-&gt;freelist å¹¶å°† freelist ä¼ é€ç»™ percpu freelist</span><br><span class="hljs-comment"> * æˆ–æ˜¯å°† slab ç»™ deactivate.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * è‹¥è¿”å›å€¼é NULL åˆ™ slab ä»è¢«å†»ç»“.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * è‹¥è¯¥å‡½æ•°è¿”å› NULL åˆ™ slab è¢«è§£å†».</span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">static</span> <span class="hljs-keyword">inline</span> <span class="hljs-type">void</span> *<span class="hljs-title function_">get_freelist</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> kmem_cache *s, <span class="hljs-keyword">struct</span> slab *slab)</span><br>&#123;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">slab</span> <span class="hljs-title">new</span>;</span><br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> counters;<br>	<span class="hljs-type">void</span> *freelist;<br><br>	lockdep_assert_held(this_cpu_ptr(&amp;s-&gt;cpu_slab-&gt;lock));<br><br>	<span class="hljs-keyword">do</span> &#123;<br>		freelist = slab-&gt;freelist;<br>		counters = slab-&gt;counters;<br><br>		new.counters = counters;<br>		VM_BUG_ON(!new.frozen);<br><br>		new.inuse = slab-&gt;objects;<br>		new.frozen = freelist != <span class="hljs-literal">NULL</span>;<br><br>	&#125; <span class="hljs-keyword">while</span> (!__cmpxchg_double_slab(s, slab,<br>		freelist, counters,<br>		<span class="hljs-literal">NULL</span>, new.counters,<br>		<span class="hljs-string">&quot;get_freelist&quot;</span>));<br><br>	<span class="hljs-keyword">return</span> freelist;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<h4 id="â‘¢-load-freelistï¼šä»-freelist-åˆ†é…å¯¹è±¡"><a href="#â‘¢-load-freelistï¼šä»-freelist-åˆ†é…å¯¹è±¡" class="headerlink" title="â‘¢ load_freelistï¼šä» freelist åˆ†é…å¯¹è±¡"></a>â‘¢ load_freelistï¼šä» freelist åˆ†é…å¯¹è±¡</h4><p>ç»§ç»­è¿”å› <code>___slab_alloc()</code> ä¸­ï¼Œæ¥ä¸‹æ¥è¿™å—ä»£ç å¯¹åº” <code>load_freelist</code> æ ‡ç­¾ï¼Œä¸»è¦å°±æ˜¯è°ƒç”¨ <code>get_freepointer()</code> å°† percpu freelist æŒ‡å‘ç¬¬äºŒä¸ªç©ºé—²å¯¹è±¡ï¼Œå¹¶è·å–ä¸‹ä¸€ä¸ª tid åè¿”å›å‰é¢è·å–çš„ freelistï¼ˆä¹Ÿå°±æ˜¯ç¬¬ä¸€ä¸ªç©ºé—²å¯¹è±¡ï¼‰ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs c">load_freelist:<br><br>	lockdep_assert_held(this_cpu_ptr(&amp;s-&gt;cpu_slab-&gt;lock));<br><br>	<span class="hljs-comment">/*</span><br><span class="hljs-comment">	 * freelist æŒ‡å‘è¦è¢«ä½¿ç”¨çš„å¯¹è±¡é“¾è¡¨. slab æŒ‡å‘è·å¾—å¯¹è±¡çš„ slab.</span><br><span class="hljs-comment">	 * å› æ­¤ slab å¿…é¡»è¢«å†»ç»“ä»¥è®© percpu çš„åˆ†é…æ­£å¸¸å·¥ä½œ.</span><br><span class="hljs-comment">	 */</span><br>	VM_BUG_ON(!c-&gt;slab-&gt;frozen);<br>	c-&gt;freelist = get_freepointer(s, freelist);<br>	c-&gt;tid = next_tid(c-&gt;tid);<br>	local_unlock_irqrestore(&amp;s-&gt;cpu_slab-&gt;lock, flags);<br>	<span class="hljs-keyword">return</span> freelist;<br></code></pre></td></tr></table></figure>

<p>è¿™é‡Œæ³¨æ„åœ¨ <code>get_freepointer()</code> é‡Œå¥—äº†ä¸¤å±‚ï¼Œæœ€åä¼šè°ƒç”¨åˆ° <code>freelist_ptr()</code> è·å–åˆ°ç¬¬äºŒä¸ªç©ºé—²å¯¹è±¡çš„æŒ‡é’ˆï¼Œè¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯å½“å¼€å¯äº† Hardened freelist ä¿æŠ¤ååœ¨ next æŒ‡é’ˆçš„ä½ç½®å­˜æ”¾çš„æ˜¯ <strong>ç¬¬ä¸€ä¸ªç©ºé—²å¯¹è±¡åœ°å€ ^ ç¬¬äºŒä¸ªç©ºé—²å¯¹è±¡åœ°å€ ^ ä¸€ä¸ªéšæœºå€¼</strong>ï¼ˆ<code>kmem_cache-&gt;random</code>ï¼‰ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * è¿”å› freelist æŒ‡é’ˆ (ptr). åœ¨æœ‰åŠ å›ºçš„æƒ…å†µä¸‹å…¶é€šè¿‡ä¸€ä¸ª</span><br><span class="hljs-comment"> * å¯¹å­˜å‚¨æŒ‡é’ˆçš„åœ°å€ä¸ per-cache éšæœºå€¼çš„å¼‚æˆ–è¿›è¡Œæ··æ·†.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">static</span> <span class="hljs-keyword">inline</span> <span class="hljs-type">void</span> *<span class="hljs-title function_">freelist_ptr</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-keyword">struct</span> kmem_cache *s, <span class="hljs-type">void</span> *ptr,</span><br><span class="hljs-params">				 <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> ptr_addr)</span><br>&#123;<br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONFIG_SLAB_FREELIST_HARDENED</span><br>	<span class="hljs-comment">/*</span><br><span class="hljs-comment">	 * å½“å¼€å¯äº† CONFIG_KASAN_SW/HW_TAGS, ptr_addr å¯èƒ½è¢«æ‰“ä¸Šæ ‡ç­¾.</span><br><span class="hljs-comment">	 * é€šå¸¸è¿™ä¸ä¼šé€ æˆä»»ä½•é—®é¢˜ï¼Œå› ä¸º set_freepointer() ä¸ get_freepointer() </span><br><span class="hljs-comment">	 * è°ƒç”¨æ—¶éƒ½ä¼šæœ‰æ ‡ç­¾ç›¸åŒçš„æŒ‡é’ˆ.</span><br><span class="hljs-comment">	 * ä½†æ˜¯ CONFIG_SLUB_DEBUG çš„ä»£ç æœ‰äº›é—®é¢˜. ä¾‹å¦‚å½“ __free_slub() åœ¨</span><br><span class="hljs-comment">	 * ä¸€ä¸ª cache ä¸­è¿­ä»£å¯¹è±¡æ—¶,å…¶å°†æ²¡æœ‰æ ‡ç­¾çš„æŒ‡é’ˆä¼ ç»™ check_object(). </span><br><span class="hljs-comment">	 * check_object() ä¾æ¬¡å¸¦ç€ä¸€ä¸ªæ²¡æœ‰æ ‡ç­¾çš„æŒ‡é’ˆè°ƒç”¨ get_freepointer()ï¼Œ</span><br><span class="hljs-comment">	 * ä»è€Œé€ æˆ freepointer å­˜å‚¨é”™è¯¯.</span><br><span class="hljs-comment">	 */</span><br>	<span class="hljs-keyword">return</span> (<span class="hljs-type">void</span> *)((<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>)ptr ^ s-&gt;random ^<br>			swab((<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>)kasan_reset_tag((<span class="hljs-type">void</span> *)ptr_addr)));<br><span class="hljs-meta">#<span class="hljs-keyword">else</span></span><br>	<span class="hljs-keyword">return</span> ptr;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>&#125;<br></code></pre></td></tr></table></figure>

<p>ä»è¿™é‡Œæˆ‘ä»¬ä¹Ÿå¯ä»¥çœ‹å‡º <strong>slab-&gt;freelist æ˜¯æ²¡æœ‰åŠ å¯†çš„ï¼Œä½†é“¾è¡¨ä¸Šçš„åç»­æŒ‡é’ˆéƒ½æ˜¯åŠ å¯†äº†çš„</strong></p>
<h4 id="â‘£-deactivate-slabï¼šdeactivate-percpu-slab"><a href="#â‘£-deactivate-slabï¼šdeactivate-percpu-slab" class="headerlink" title="â‘£ deactivate_slabï¼šdeactivate percpu slab"></a>â‘£ deactivate_slabï¼šdeactivate percpu slab</h4><p>ç»§ç»­è¿”å› <code>___slab_alloc()</code> ä¸­ï¼Œæ¥ä¸‹æ¥è¿™å—ä»£ç å¯¹åº” <code>deactivate_slab</code> æ ‡ç­¾ï¼Œé¦–å…ˆè¿˜æ˜¯æƒ¯ä¾‹åœ°æ£€æŸ¥æ˜¯å¦è¢«æŠ¢å è°ƒåº¦åˆ°äº†åˆ«çš„ CPUï¼Œè‹¥æ˜¯åˆ™è·³è½¬å› <code>reread_slab</code>ï¼›ä¹‹åå°±æ˜¯ç®€å•åœ°å°† percpu çš„ slab å’Œ freelist è®¾ä¸º NULL å¹¶è·å–ä¸‹ä¸€ä¸ª tidï¼Œä¹‹åè°ƒç”¨ <code>deactivate_slab()</code> å°†è¿™å¼  slab ç»™ deactivate äº†ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs c">deactivate_slab:<br><br>	local_lock_irqsave(&amp;s-&gt;cpu_slab-&gt;lock, flags);<br>	<span class="hljs-keyword">if</span> (slab != c-&gt;slab) &#123;<br>		local_unlock_irqrestore(&amp;s-&gt;cpu_slab-&gt;lock, flags);<br>		<span class="hljs-keyword">goto</span> reread_slab;<br>	&#125;<br>	freelist = c-&gt;freelist;<br>	c-&gt;slab = <span class="hljs-literal">NULL</span>;<br>	c-&gt;freelist = <span class="hljs-literal">NULL</span>;<br>	c-&gt;tid = next_tid(c-&gt;tid);<br>	local_unlock_irqrestore(&amp;s-&gt;cpu_slab-&gt;lock, flags);<br>	deactivate_slab(s, slab, freelist);<br></code></pre></td></tr></table></figure>

<p><code>deactivate_slab()</code> çš„é€»è¾‘å¦‚ä¸‹ï¼š</p>
<ul>
<li>éå† freelist æ£€æŸ¥æ˜¯å¦è¢«ç ´åï¼Œæ”¾å¼ƒè¢«ç ´åçš„éƒ¨åˆ†</li>
<li>å°† <code>slab-&gt;freelist</code> è®¾ä¸ºåŸ <code>kmem_cache_cpu-&gt;freelist</code>ï¼Œè‹¥ slab ä¸ŠåŸæœ‰ freelist ä¸ä¸º NULL åˆ™å†æ¥åˆ°åé¢</li>
<li>è®¾ç½® slab çš„ countersï¼Œå…¶ä¸­<strong>å°† <code>frozen</code> è®¾ä¸º 0</strong></li>
<li>è‹¥ slab ä¸Šçš„å¯¹è±¡å…¨éƒ¨ç©ºé—²**ä¸” node çš„ partial slab æ•°é‡å¤§äº <code>kmem_cache-&gt;min_partial</code>**ï¼Œè°ƒç”¨ <code>discard_slab()</code> å°† slab é‡Šæ”¾</li>
<li>è‹¥ slab ä¸Šå­˜åœ¨ç©ºé—²å¯¹è±¡ï¼Œè°ƒç”¨ <code>add_partial()</code> å°†å…¶åŠ å…¥ node çš„ partial é“¾è¡¨</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * ç»“æŸç§»é™¤ cpu slab. åˆå¹¶ cpu&#x27;s freelist ä¸ slab&#x27;s freelist,</span><br><span class="hljs-comment"> * è§£å†» slabs å¹¶æ”¾åœ¨åˆé€‚çš„é“¾è¡¨ä¸Š.</span><br><span class="hljs-comment"> * å‡è®¾ slab å·²ç»è¢«è°ƒç”¨è€…å®‰å…¨åœ°ä» kmem_cache_cpu ä¸Šå–ä¸‹.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">deactivate_slab</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> kmem_cache *s, <span class="hljs-keyword">struct</span> slab *slab,</span><br><span class="hljs-params">			    <span class="hljs-type">void</span> *freelist)</span><br>&#123;<br>	<span class="hljs-class"><span class="hljs-keyword">enum</span> <span class="hljs-title">slab_modes</span> &#123;</span> M_NONE, M_PARTIAL, M_FREE, M_FULL_NOLIST &#125;;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">kmem_cache_node</span> *<span class="hljs-title">n</span> =</span> get_node(s, slab_nid(slab));<br>	<span class="hljs-type">int</span> free_delta = <span class="hljs-number">0</span>;<br>	<span class="hljs-class"><span class="hljs-keyword">enum</span> <span class="hljs-title">slab_modes</span> <span class="hljs-title">mode</span> =</span> M_NONE;<br>	<span class="hljs-type">void</span> *nextfree, *freelist_iter, *freelist_tail;<br>	<span class="hljs-type">int</span> tail = DEACTIVATE_TO_HEAD;<br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> flags = <span class="hljs-number">0</span>;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">slab</span> <span class="hljs-title">new</span>;</span><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">slab</span> <span class="hljs-title">old</span>;</span><br><br>	<span class="hljs-keyword">if</span> (slab-&gt;freelist) &#123;<br>		stat(s, DEACTIVATE_REMOTE_FREES);<br>		tail = DEACTIVATE_TO_TAIL;<br>	&#125;<br><br>	<span class="hljs-comment">/*</span><br><span class="hljs-comment">	 * é˜¶æ®µä¸€: ç»Ÿè®¡ cpu&#x27;s freelist ä¸Šçš„å¯¹è±¡æ•°é‡ï¼ˆfree_deltaï¼‰ </span><br><span class="hljs-comment">	 * å¹¶ä¿å­˜æœ€åä¸€ä¸ªå¯¹è±¡ï¼ˆfreelist_tailï¼‰ ç”¨äºåé¢çš„æ‹¼æ¥.</span><br><span class="hljs-comment">	 */</span><br>	freelist_tail = <span class="hljs-literal">NULL</span>;<br>	freelist_iter = freelist;<br>	<span class="hljs-keyword">while</span> (freelist_iter) &#123;<br>		nextfree = get_freepointer(s, freelist_iter);<br><br>		<span class="hljs-comment">/*</span><br><span class="hljs-comment">		 * è‹¥ &#x27;nextfree&#x27; æ— æ•ˆ, åœ¨ &#x27;freelist_iter&#x27; ä¸Šçš„å¯¹è±¡å¯èƒ½å·²è¢«ç ´å.</span><br><span class="hljs-comment">		 * æ•…é€šè¿‡ç•¥è¿‡ &#x27;freelist_iter&#x27; èµ·çš„æ‰€æœ‰å¯¹è±¡æ¥è¿›è¡Œéš”ç¦».</span><br><span class="hljs-comment">		 */</span><br>		<span class="hljs-keyword">if</span> (freelist_corrupted(s, slab, &amp;freelist_iter, nextfree))<br>			<span class="hljs-keyword">break</span>;<br><br>		freelist_tail = freelist_iter;<br>		free_delta++;<br><br>		freelist_iter = nextfree;<br>	&#125;<br><br>	<span class="hljs-comment">/*</span><br><span class="hljs-comment">	 * é˜¶æ®µäºŒ: è§£å†»slabå¹¶å°†per-cpu freelistæ‹¼æ¥åˆ°slab&#x27;s freelistå¤´éƒ¨.</span><br><span class="hljs-comment">	 *</span><br><span class="hljs-comment">	 * ç¡®ä¿é“¾è¡¨çš„å­˜åœ¨åæ˜ äº†åœ¨è§£å†»æœŸé—´å®é™…çš„å¯¹è±¡æ•°é‡æ—¶ï¼Œslab å·²è¢«è§£å†».</span><br><span class="hljs-comment">	 *</span><br><span class="hljs-comment">	 * æˆ‘ä»¬é¦–å…ˆåœ¨æŒæœ‰é”çš„æƒ…å†µä¸‹è¿›è¡Œcompxchgå¹¶å½“å…¶æˆåŠŸæ—¶å°† slab æ’å…¥é“¾è¡¨.</span><br><span class="hljs-comment">	 * è‹¥æœ‰ä¸åŒ¹é…çš„æƒ…å†µåˆ™ slab ä¸ºæœªå†»ç»“ä¸” slab ä¸Šçš„æ•°é‡å¯èƒ½å‘ç”Ÿäº†æ”¹å˜.</span><br><span class="hljs-comment">	 * é‡Šæ”¾é”å¹¶å†æ¬¡é‡è¯• cmpxchg.</span><br><span class="hljs-comment">	 */</span><br>redo:<br><br>	old.freelist = READ_ONCE(slab-&gt;freelist);<br>	old.counters = READ_ONCE(slab-&gt;counters);<br>	VM_BUG_ON(!old.frozen);<br><br>	<span class="hljs-comment">/* ç¡®å®š slab çš„ç›®æ ‡çŠ¶æ€ */</span><br>	new.counters = old.counters;<br>	<span class="hljs-keyword">if</span> (freelist_tail) &#123;<br>		new.inuse -= free_delta;<br>		set_freepointer(s, freelist_tail, old.freelist);<br>		new.freelist = freelist;<br>	&#125; <span class="hljs-keyword">else</span><br>		new.freelist = old.freelist;<br><br>	new.frozen = <span class="hljs-number">0</span>;<br><br>	<span class="hljs-keyword">if</span> (!new.inuse &amp;&amp; n-&gt;nr_partial &gt;= s-&gt;min_partial) &#123;<br>		mode = M_FREE;<br>	&#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (new.freelist) &#123;<br>		mode = M_PARTIAL;<br>		<span class="hljs-comment">/*</span><br><span class="hljs-comment">		 * æŒæœ‰è‡ªæ—‹é”æ¶ˆé™¤äº†acquire_slab()çœ‹åˆ°ä¸€ä¸ªslabä¸ºå†»ç»“çš„å¯èƒ½æ€§</span><br><span class="hljs-comment">		 */</span><br>		spin_lock_irqsave(&amp;n-&gt;list_lock, flags);<br>	&#125; <span class="hljs-keyword">else</span> &#123;<br>		mode = M_FULL_NOLIST;<br>	&#125;<br><br><br>	<span class="hljs-keyword">if</span> (!cmpxchg_double_slab(s, slab,<br>				old.freelist, old.counters,<br>				new.freelist, new.counters,<br>				<span class="hljs-string">&quot;unfreezing slab&quot;</span>)) &#123;<br>		<span class="hljs-keyword">if</span> (mode == M_PARTIAL)<br>			spin_unlock_irqrestore(&amp;n-&gt;list_lock, flags);<br>		<span class="hljs-keyword">goto</span> redo;<br>	&#125;<br><br><br>	<span class="hljs-keyword">if</span> (mode == M_PARTIAL) &#123;<br>		add_partial(n, slab, tail);<br>		spin_unlock_irqrestore(&amp;n-&gt;list_lock, flags);<br>		stat(s, tail);<br>	&#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (mode == M_FREE) &#123;<br>		stat(s, DEACTIVATE_EMPTY);<br>		discard_slab(s, slab);<br>		stat(s, FREE_SLAB);<br>	&#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (mode == M_FULL_NOLIST) &#123;<br>		stat(s, DEACTIVATE_FULL);<br>	&#125;<br>&#125;<br></code></pre></td></tr></table></figure>





<h4 id="â‘£-new-slabï¼šè·å–-percpu-partial-slab"><a href="#â‘£-new-slabï¼šè·å–-percpu-partial-slab" class="headerlink" title="â‘£ new_slabï¼šè·å– percpu partial slab"></a>â‘£ new_slabï¼šè·å– percpu partial slab</h4><p>æ¥ä¸‹æ¥æ˜¯ <code>new_slab</code> æ ‡ç­¾ï¼Œä¸»è¦å°±æ˜¯æ£€æŸ¥è‹¥æœ‰ percpu partial slab åˆ™ä» percpu partial é“¾è¡¨ä¸Šè·å–ä¸€ä¸ª slab å°†å…¶è®¾ä¸º percpu slab å å†è·³è½¬å› <code>redo</code> æ ‡ç­¾ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs c">new_slab:<br><br>	<span class="hljs-keyword">if</span> (slub_percpu_partial(c)) &#123;<span class="hljs-comment">//æœ‰ percpu partial slab</span><br>		local_lock_irqsave(&amp;s-&gt;cpu_slab-&gt;lock, flags);<br>		<span class="hljs-keyword">if</span> (unlikely(c-&gt;slab)) &#123;<span class="hljs-comment">//percpu slab ä¸ä¸ºç©ºï¼Œç›´æ¥è·³å› redo</span><br>			local_unlock_irqrestore(&amp;s-&gt;cpu_slab-&gt;lock, flags);<br>			<span class="hljs-keyword">goto</span> reread_slab;<br>		&#125;<br>		<span class="hljs-keyword">if</span> (unlikely(!slub_percpu_partial(c))) &#123;<span class="hljs-comment">//è¢«æŠ¢å ç„¶åpartialç©ºäº†</span><br>			local_unlock_irqrestore(&amp;s-&gt;cpu_slab-&gt;lock, flags);<br>			<span class="hljs-comment">/* æˆ‘ä»¬è¢«æŠ¢å äº†ä¸” partial é“¾è¡¨ç©ºäº† */</span><br>			<span class="hljs-keyword">goto</span> new_objects;<br>		&#125;<br><br>		<span class="hljs-comment">// è·å–ä¸€å¼  percpu patial slabï¼Œè·³å› redo</span><br>		slab = c-&gt;slab = slub_percpu_partial(c);<br>		slub_set_percpu_partial(c, slab);<br>		local_unlock_irqrestore(&amp;s-&gt;cpu_slab-&gt;lock, flags);<br>		stat(s, CPU_PARTIAL_ALLOC);<br>		<span class="hljs-keyword">goto</span> redo;<br>	&#125;<br></code></pre></td></tr></table></figure>

<h4 id="â‘¤-new-objectsï¼šè·å–-node-pertial-slab-æˆ–å‘-buddy-è¯·æ±‚æ–°-slab-è¿›è¡Œåˆ†é…"><a href="#â‘¤-new-objectsï¼šè·å–-node-pertial-slab-æˆ–å‘-buddy-è¯·æ±‚æ–°-slab-è¿›è¡Œåˆ†é…" class="headerlink" title="â‘¤ new_objectsï¼šè·å– node pertial slab æˆ–å‘ buddy è¯·æ±‚æ–° slab è¿›è¡Œåˆ†é…"></a>â‘¤ new_objectsï¼šè·å– node pertial slab æˆ–å‘ buddy è¯·æ±‚æ–° slab è¿›è¡Œåˆ†é…</h4><p>è‹¥ percpu partial é“¾è¡¨ä¹Ÿä¸ºç©ºï¼Œé‚£ä¹ˆä¾¿æ¥åˆ°æ¥ä¸‹æ¥çš„ <code>new_objects</code> æ ‡ç­¾åˆ†é…ä¸€ä¸ªæ–°çš„ slabï¼Œé¦–å…ˆä¼šè®¾ç½® <code>partial_context</code>ï¼Œè°ƒç”¨ <code>get_partial()</code> å°è¯•ä» <code>kmem_cache_node</code> çš„ partial é“¾è¡¨åˆ†é…ä¸€ä¸ª slabï¼Œè‹¥åˆ†é…æˆåŠŸåˆ™ç›´æ¥è·³è½¬åˆ° <code>check_new_slab</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs c">new_objects:<br><br>	pc.flags = gfpflags;<br>	pc.slab = &amp;slab;<br>	pc.orig_size = orig_size;<br>	freelist = get_partial(s, node, &amp;pc);<br>	<span class="hljs-keyword">if</span> (freelist)<br>		<span class="hljs-keyword">goto</span> check_new_slab;<br><br></code></pre></td></tr></table></figure>

<p><code>get_partial()</code> é¦–å…ˆä¼šè°ƒç”¨ <code>get_partial_node()</code> ä»å½“å‰ node çš„ <code>kmem_cache_node</code> çš„ partial é“¾è¡¨åˆ†é… slabï¼Œè‹¥æˆåŠŸäº†åˆ™ç›´æ¥è¿”å›ï¼Œå¦‚æœå¤±è´¥äº†ä½†æ˜¯æŒ‡å®šäº†åˆ†é…çš„ node ä¸º <code>NUMA_NO_NODE</code>ï¼Œåˆ™è°ƒç”¨ <code>get_any_partial()</code> ä»å…¶ä»–çš„ <code>kmem_cache_node</code> çš„ partial é“¾è¡¨å°è¯•åˆ†é…ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * è·å–ä¸€ä¸ª partial slab, åŠ é”å¹¶è¿”å›.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> *<span class="hljs-title function_">get_partial</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> kmem_cache *s, <span class="hljs-type">int</span> node, <span class="hljs-keyword">struct</span> partial_context *pc)</span><br>&#123;<br>	<span class="hljs-type">void</span> *object;<br>	<span class="hljs-type">int</span> searchnode = node;<br><br>	<span class="hljs-keyword">if</span> (node == NUMA_NO_NODE)<br>		searchnode = numa_mem_id();<br><br>	<span class="hljs-comment">// ä»å½“å‰ node çš„ partial é“¾è¡¨åˆ†é… slab</span><br>	object = get_partial_node(s, get_node(s, searchnode), pc);<br>	<span class="hljs-keyword">if</span> (object || node != NUMA_NO_NODE)<br>		<span class="hljs-keyword">return</span> object;<br><br>	<span class="hljs-comment">// ä»å…¶ä»– node çš„ partial é“¾è¡¨åˆ†é… slab</span><br>	<span class="hljs-keyword">return</span> get_any_partial(s, pc);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>è‹¥ <code>get_partial()</code> æ²¡æ³•è·å–åˆ° slabï¼Œåˆ™è°ƒç”¨ <code>new_slab()</code> å‘ buddy system è¯·æ±‚ä¸€ä»½æ–°çš„ slabï¼Œè‹¥å¤±è´¥äº†åˆ™ç›´æ¥è¿”å›ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs c">slub_put_cpu_ptr(s-&gt;cpu_slab);<br>slab = new_slab(s, gfpflags, node);<br>c = slub_get_cpu_ptr(s-&gt;cpu_slab);<br><br><span class="hljs-keyword">if</span> (unlikely(!slab)) &#123;<br>	slab_out_of_memory(s, gfpflags, node);<br>	<span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;<br>&#125;<br><br>stat(s, ALLOC_SLAB);<br></code></pre></td></tr></table></figure>

<p><code>new_slab()</code> æœ€åä¼šè°ƒç”¨åˆ° <code>allocate_slab()</code>ï¼š</p>
<ul>
<li>é¦–å…ˆæ£€æŸ¥é¡µé¢åˆ†é…æ ‡å¿—ä½ï¼Œä¹‹åè°ƒç”¨ <code>alloc_slab_page()</code> åœ¨æŒ‡å®š node ä¸Šè¿›è¡Œåˆ†é…<ul>
<li>è‹¥ <code>node == NUMA_NO_NODE</code>ï¼Œåˆ™è¯¥å‡½æ•°ä¼šè°ƒç”¨ <code>alloc_pages()</code>ï¼Œå¦åˆ™ä¼šè°ƒç”¨ <code>__alloc_pages_node()</code></li>
</ul>
</li>
<li>è‹¥å¤±è´¥äº†åˆ™å†æ¬¡è°ƒç”¨  <code>alloc_slab_page()</code>  å°è¯•è¿›è¡Œæœ€å°å†…å­˜åˆ†é…ï¼ˆ<code>kmem_cache-&gt;min</code>ï¼‰ï¼Œä»å¤±è´¥åˆ™ç›´æ¥è¿”å› NULL</li>
<li>åˆå§‹åŒ– slab å„æˆå‘˜ï¼Œå¹¶è°ƒç”¨ <code>shuffle_freelist()</code> ä¸ºç©ºé—²å¯¹è±¡æ„é€ éšæœºåŒ–é“¾è¡¨ï¼Œè‹¥æœªå¼€å¯éšæœºåŒ–åˆ™å°†ç©ºé—²å¯¹è±¡æŒ‰é¡ºåºè¿æ¥</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-keyword">struct</span> slab *<span class="hljs-title function_">allocate_slab</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> kmem_cache *s, <span class="hljs-type">gfp_t</span> flags, <span class="hljs-type">int</span> node)</span><br>&#123;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">slab</span> *<span class="hljs-title">slab</span>;</span><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">kmem_cache_order_objects</span> <span class="hljs-title">oo</span> =</span> s-&gt;oo;<br>	<span class="hljs-type">gfp_t</span> alloc_gfp;<br>	<span class="hljs-type">void</span> *start, *p, *next;<br>	<span class="hljs-type">int</span> idx;<br>	<span class="hljs-type">bool</span> shuffle;<br><br>	flags &amp;= gfp_allowed_mask;<br><br>	flags |= s-&gt;allocflags;<br><br>	<span class="hljs-comment">/*</span><br><span class="hljs-comment">	 * è®©æœ€åˆçš„ higher-order åˆ†é…åœ¨å†…å­˜å‹åŠ›ä¸‹å¤±è´¥</span><br><span class="hljs-comment">	 * ç”±æ­¤æˆ‘ä»¬è¿”å›åˆ°æœ€å° order çš„åˆ†é….</span><br><span class="hljs-comment">	 */</span><br>	alloc_gfp = (flags | __GFP_NOWARN | __GFP_NORETRY) &amp; ~__GFP_NOFAIL;<br>	<span class="hljs-keyword">if</span> ((alloc_gfp &amp; __GFP_DIRECT_RECLAIM) &amp;&amp; oo_order(oo) &gt; oo_order(s-&gt;min))<br>		alloc_gfp = (alloc_gfp | __GFP_NOMEMALLOC) &amp; ~__GFP_RECLAIM;<br><br>	slab = alloc_slab_page(alloc_gfp, node, oo);<br>	<span class="hljs-keyword">if</span> (unlikely(!slab)) &#123;<span class="hljs-comment">//åˆ†é…å¤±è´¥ï¼Œå°è¯•æœ€å°å†…å­˜åˆ†é…</span><br>		oo = s-&gt;min;<br>		alloc_gfp = flags;<br>		<span class="hljs-comment">/*</span><br><span class="hljs-comment">		 * åˆ†é…å¯èƒ½å› ä¸ºç¢ç‰‡åŒ–è€Œå¤±è´¥.</span><br><span class="hljs-comment">		 * å¯èƒ½çš„è¯å°è¯•ä¸€ä¸ª lower order çš„åˆ†é…</span><br><span class="hljs-comment">		 */</span><br>		slab = alloc_slab_page(alloc_gfp, node, oo);<br>		<span class="hljs-keyword">if</span> (unlikely(!slab))<br>			<span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;<br>		stat(s, ORDER_FALLBACK);<br>	&#125;<br><br>	slab-&gt;objects = oo_objects(oo);<br>	slab-&gt;inuse = <span class="hljs-number">0</span>;<br>	slab-&gt;frozen = <span class="hljs-number">0</span>;<br><br>	account_slab(slab, oo_order(oo), s, flags);<br><br>	slab-&gt;slab_cache = s;<br><br>	kasan_poison_slab(slab);<br><br>	start = slab_address(slab);<br><br>	setup_slab_debug(s, slab, start);<br><br>	<span class="hljs-comment">//å¼€å¯äº†éšæœºåŒ–ä¼šåœ¨è¯¥å‡½æ•°å†…éšæœºè¿æ¥</span><br>	shuffle = shuffle_freelist(s, slab);<br><br>	<span class="hljs-comment">//æœªå¼€å¯éšæœºåŒ–ï¼ŒæŒ‰é¡ºåºè¿æ¥</span><br>	<span class="hljs-keyword">if</span> (!shuffle) &#123;<br>		start = fixup_red_left(s, start);<br>		start = setup_object(s, start);<br>		slab-&gt;freelist = start;<br>		<span class="hljs-keyword">for</span> (idx = <span class="hljs-number">0</span>, p = start; idx &lt; slab-&gt;objects - <span class="hljs-number">1</span>; idx++) &#123;<br>			next = p + s-&gt;size;<br>			next = setup_object(s, next);<br>			set_freepointer(s, p, next);<br>			p = next;<br>		&#125;<br>		set_freepointer(s, p, <span class="hljs-literal">NULL</span>);<br>	&#125;<br><br>	<span class="hljs-keyword">return</span> slab;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>è¿™é‡Œç”¨äº†ä¸€ä¸ªå‡½æ•° <code>set_freepointer()</code>ï¼Œä¸»è¦å°±æ˜¯ç”¨ <code>freelist_ptr()</code> å‘ <code>object + s-&gt;offset</code> çš„ä½ç½®å†™å…¥ç”¨ <code>freelist_ptr()</code> åŠ å¯†åçš„ <code>fp</code> æŒ‡é’ˆï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-keyword">inline</span> <span class="hljs-type">void</span> <span class="hljs-title function_">set_freepointer</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> kmem_cache *s, <span class="hljs-type">void</span> *object, <span class="hljs-type">void</span> *fp)</span><br>&#123;<br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> freeptr_addr = (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>)object + s-&gt;offset;<br><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONFIG_SLAB_FREELIST_HARDENED</span><br>	BUG_ON(object == fp); <span class="hljs-comment">/* naive detection of double free or corruption */</span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br>	freeptr_addr = (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>)kasan_reset_tag((<span class="hljs-type">void</span> *)freeptr_addr);<br>	*(<span class="hljs-type">void</span> **)freeptr_addr = freelist_ptr(s, fp, freeptr_addr);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>è¿”å› <code>___slab_alloc()</code>ï¼Œå¦‚æœ<strong>è¯¥ kmem_cache è®¾ç½®äº† <code>SLAB_DEBUG_FLAGS</code> æ ‡å¿—ä½</strong>ï¼Œåˆ™æ¥ä¸‹æ¥ä¼šè°ƒç”¨ <code>alloc_single_from_new_slab()</code> <strong>ä»æ–°è·å–åˆ°çš„ slab ä¸Šåˆ†é…ä¸€ä¸ªå¯¹è±¡åå°† slab é‡æ–°æŒ‚å› partial&#x2F;full é“¾è¡¨</strong>ï¼Œè‹¥åˆ†é…å¤±è´¥åˆ™è·³è½¬å› <code>new_objects</code>ï¼ŒæˆåŠŸåˆ™ç›´æ¥è¿”å›</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">if</span> (kmem_cache_debug(s)) &#123;<br>	freelist = alloc_single_from_new_slab(s, slab, orig_size);<br><br>	<span class="hljs-keyword">if</span> (unlikely(!freelist))<br>		<span class="hljs-keyword">goto</span> new_objects;<br><br>	<span class="hljs-keyword">if</span> (s-&gt;flags &amp; SLAB_STORE_USER)<br>		set_track(s, freelist, TRACK_ALLOC, addr);<br><br>	<span class="hljs-keyword">return</span> freelist;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>å¦‚æœæ²¡æœ‰è®¾ç½® <code>SLAB_DEBUG_FLAGS</code> æ ‡å¿—ä½ï¼Œåˆ™æ¥ä¸‹æ¥è·å– slab çš„ freelistï¼Œå¹¶è°ƒç”¨ <code>inc_slabs_node()</code> å¢åŠ  node ä¸Šçš„è®¡æ•°</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * No other reference to the slab yet so we can</span><br><span class="hljs-comment"> * muck around with it freely without cmpxchg</span><br><span class="hljs-comment"> */</span><br>freelist = slab-&gt;freelist;<br>slab-&gt;freelist = <span class="hljs-literal">NULL</span>;<br>slab-&gt;inuse = slab-&gt;objects;<br>slab-&gt;frozen = <span class="hljs-number">1</span>;<br><br>inc_slabs_node(s, slab_nid(slab), slab-&gt;objects);<br></code></pre></td></tr></table></figure>

<h4 id="â‘¥-check-new-slabï¼šæ£€æŸ¥-slab"><a href="#â‘¥-check-new-slabï¼šæ£€æŸ¥-slab" class="headerlink" title="â‘¥ check_new_slabï¼šæ£€æŸ¥ slab"></a>â‘¥ check_new_slabï¼šæ£€æŸ¥ slab</h4><p>æ¥ä¸‹æ¥å¯¹æ–°è·å–çš„ slab è¿›è¡Œæ£€æŸ¥ï¼Œè‹¥è¯¥ kmem_cache è®¾ç½®äº† <code>SLAB_DEBUG_FLAGS</code> æ ‡å¿—ä½ï¼Œæ£€æŸ¥æ˜¯å¦è®¾ç½®äº† <code>SLAB_STORE_USER</code> æ ‡å¿—ä½ï¼Œä¹‹åç›´æ¥è¿”å› freelist</p>
<p>æ¥ä¸‹æ¥è°ƒç”¨ <code>pfmemalloc_match()</code> æ£€æŸ¥ slab ä¸åˆ†é…æ ‡å¿—ä½æ˜¯å¦ä¸åŒ¹é…ï¼Œè‹¥æ˜¯åˆ™è°ƒç”¨ <code>deactivate_slab()</code> ä½¿å…¶ä¸å†æ´»åŠ¨å¹¶è¿”å› freelist</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs c">check_new_slab:<br><br>	<span class="hljs-keyword">if</span> (kmem_cache_debug(s)) &#123;<br>		<span class="hljs-comment">/*</span><br><span class="hljs-comment">		 * For debug caches here we had to go through</span><br><span class="hljs-comment">		 * alloc_single_from_partial() so just store the tracking info</span><br><span class="hljs-comment">		 * and return the object</span><br><span class="hljs-comment">		 */</span><br>		<span class="hljs-keyword">if</span> (s-&gt;flags &amp; SLAB_STORE_USER)<br>			set_track(s, freelist, TRACK_ALLOC, addr);<br><br>		<span class="hljs-keyword">return</span> freelist;<br>	&#125;<br><br>	<span class="hljs-keyword">if</span> (unlikely(!pfmemalloc_match(slab, gfpflags))) &#123;<br>		<span class="hljs-comment">/*</span><br><span class="hljs-comment">		 * For !pfmemalloc_match() case we don&#x27;t load freelist so that</span><br><span class="hljs-comment">		 * we don&#x27;t make further mismatched allocations easier.</span><br><span class="hljs-comment">		 */</span><br>		deactivate_slab(s, slab, get_freepointer(s, freelist));<br>		<span class="hljs-keyword">return</span> freelist;<br>	&#125;<br><br></code></pre></td></tr></table></figure>

<h4 id="â‘¦-retry-load-slabï¼š"><a href="#â‘¦-retry-load-slabï¼š" class="headerlink" title="â‘¦ retry_load_slabï¼š"></a>â‘¦ retry_load_slabï¼š</h4><p>æœ€åå°±æ˜¯å°è¯•åŠ è½½æ–°è·å¾—çš„ slabï¼Œå¦‚æœ percpu slab ä¸ä¸º NULL åˆ™ä½¿å…¶ä¸å†æ´»åŠ¨ï¼Œå¹¶è®¾ç½® percpu slab &amp; freelist ä¸º NULLï¼Œå¹¶è·å–ä¸‹ä¸€ä¸ª tid</p>
<p>æœ€åå°±æ˜¯å°† percpu slab è®¾ä¸ºæ–°è·å–çš„ slab å¹¶è·³è½¬å› <code>load_freelist</code> åˆ†é…å¯¹è±¡å¹¶è¿”å›</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs c">retry_load_slab:<br><br>	local_lock_irqsave(&amp;s-&gt;cpu_slab-&gt;lock, flags);<br>	<span class="hljs-keyword">if</span> (unlikely(c-&gt;slab)) &#123;<br>		<span class="hljs-type">void</span> *flush_freelist = c-&gt;freelist;<br>		<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">slab</span> *<span class="hljs-title">flush_slab</span> =</span> c-&gt;slab;<br><br>		c-&gt;slab = <span class="hljs-literal">NULL</span>;<br>		c-&gt;freelist = <span class="hljs-literal">NULL</span>;<br>		c-&gt;tid = next_tid(c-&gt;tid);<br><br>		local_unlock_irqrestore(&amp;s-&gt;cpu_slab-&gt;lock, flags);<br><br>		deactivate_slab(s, flush_slab, flush_freelist);<br><br>		stat(s, CPUSLAB_FLUSH);<br><br>		<span class="hljs-keyword">goto</span> retry_load_slab;<br>	&#125;<br>	c-&gt;slab = slab;<br><br>	<span class="hljs-keyword">goto</span> load_freelist;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>è‡³æ­¤ï¼Œ slub åˆ†é…ç®—æ³•çš„æ ¸å¿ƒé€»è¾‘åˆ†æç»“æŸ</p>
<h2 id="äºŒã€kmallocï¼š-NUMA-NO-NODE-çš„é€šç”¨ä¸Šå±‚åˆ†é…æ¥å£"><a href="#äºŒã€kmallocï¼š-NUMA-NO-NODE-çš„é€šç”¨ä¸Šå±‚åˆ†é…æ¥å£" class="headerlink" title="äºŒã€kmallocï¼š NUMA_NO_NODE çš„é€šç”¨ä¸Šå±‚åˆ†é…æ¥å£"></a>äºŒã€kmallocï¼š NUMA_NO_NODE çš„é€šç”¨ä¸Šå±‚åˆ†é…æ¥å£</h2><p>æˆ‘ä»¬æ—¥å¸¸ç”Ÿæ´»ä¸­ï¼ˆï¼Ÿï¼‰æœ€å¸¸ç”¨çš„å…¶å®è¿˜æ˜¯ <code>kmalloc()</code>ï¼Œå…¶ä¼šæ ¹æ®åˆ†é…çš„å¤§å°ä¸æ ‡å¿—ä½å¸®æˆ‘ä»¬å®Œæˆ <code>kmem_cache</code> çš„é€‰å–å¹¶è¿›è¡Œå¯¹è±¡åˆ†é…</p>
<p>å‡½æ•°æ•´ä½“é€»è¾‘æ¯”è¾ƒç®€å•ï¼š</p>
<ul>
<li>è‹¥åˆ†é…çš„å¤§å°åœ¨ç¼–è¯‘æœŸå·²çŸ¥ï¼ˆ<code>__builtin_constant_p()</code>ï¼‰åˆ™åˆ¤æ–­å¤§å°ï¼š<ul>
<li>è‹¥å¤§å°å¤§äº <code>KMALLOC_MAX_CACHE_SIZE</code> åˆ™ä½¿ç”¨ <code>kmalloc_large()</code> è¿›è¡Œåˆ†é…</li>
<li>é€šè¿‡ <code>kmalloc_index()</code> ä¸ <code>kmalloc_type()</code> è·å– <code>kmalloc_caches</code> ä¸­å¯¹åº”çš„æ•°ç»„ä¸‹æ ‡å¹¶è°ƒç”¨ <code>kmalloc_trace</code> è¿›è¡Œå¯¹è±¡åˆ†é…</li>
</ul>
</li>
<li>è‹¥å¤§å°æ˜¯åŠ¨æ€ä¼ å…¥çš„ï¼Œè°ƒç”¨ <code>__kmalloc()</code> è¿›è¡Œåˆ†é…</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * kmalloc - åˆ†é…å†…æ ¸å†…å­˜</span><br><span class="hljs-comment"> * @size: éœ€è¦çš„å†…å­˜å­—èŠ‚æ•°.</span><br><span class="hljs-comment"> * @flags: æè¿°åˆ†é…ä¸Šä¸‹æ–‡</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * kmalloc æ˜¯å†…æ ¸ä¸­åˆ†é…å°äºé¡µé¢å¤§å°çš„å†…å­˜å¯¹è±¡çš„é€šç”¨æ–¹æ³•.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * è¢«åˆ†é…çš„å¯¹è±¡åœ°å€è‡³å°‘è¦å¯¹é½åˆ° ARCH_KMALLOC_MINALIGN å­—èŠ‚.</span><br><span class="hljs-comment"> * å¯¹äº 2^n å­—èŠ‚çš„ @size , å¯¹é½ä¹Ÿéœ€è¦ä¿è¯è‡³å°‘åˆ°è¯¥å¤§å°.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * @flags argument å¯èƒ½æ˜¯ include/linux/gfp.h ä¸­å®šä¹‰çš„GFP æ ‡å¿—ä½ï¼Œæè¿°äº</span><br><span class="hljs-comment"> * :ref:`Documentation/core-api/mm-api.rst &lt;mm-api-gfp-flags&gt;`</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * æ¨èçš„å¯¹ @flags ä½¿ç”¨æè¿°äº</span><br><span class="hljs-comment"> * :ref:`Documentation/core-api/memory-allocation.rst &lt;memory_allocation&gt;`</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * ä»¥ä¸‹ä¸ºæœ€å¸¸ç”¨çš„ GFP æ ‡å¿—ä½ç®€è¦æ¦‚è¿°</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * %GFP_KERNEL</span><br><span class="hljs-comment"> *	åˆ†é…æ™®é€šå†…æ ¸å†…å­˜. å¯èƒ½ç¡çœ .</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * %GFP_NOWAIT</span><br><span class="hljs-comment"> *	åˆ†é…å°†ä¸ä¼šç¡çœ .</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * %GFP_ATOMIC</span><br><span class="hljs-comment"> *	åˆ†é…å°†ä¸ä¼šç¡çœ .  å¯èƒ½ä½¿ç”¨ emergency pools.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * ä¹Ÿå¯ä»¥é€šè¿‡å¼‚æˆ–ä»¥ä¸‹çš„ä¸€ä¸ªæˆ–å¤šä¸ªé¢å¤–@flagsæ¥è®¾ç½®ä¸åŒçš„æ ‡å¿—ä½:</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * %__GFP_ZERO</span><br><span class="hljs-comment"> *	åœ¨è¿”å›å‰æ¸…é›¶åˆ†é…çš„å†…å­˜. ä¹Ÿå¯å‚è§ kzalloc().</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * %__GFP_HIGH</span><br><span class="hljs-comment"> *	è¿™ä¸ªåˆ†é…æœ‰ç€é«˜ä¼˜å…ˆçº§ä¸”å¯èƒ½ä½¿ç”¨ emergency pools.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * %__GFP_NOFAIL</span><br><span class="hljs-comment"> *	è¡¨ç¤ºæ­¤æ¬¡åˆ†é…ä¸å…è®¸å¤±è´¥</span><br><span class="hljs-comment"> *	(åœ¨ä½¿ç”¨å‰å†æ¬¡æ€è€ƒ).</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * %__GFP_NORETRY</span><br><span class="hljs-comment"> *	è‹¥å†…å­˜ä¸ä¼šé©¬ä¸Šå¯ç”¨,ç«‹å³æ”¾å¼ƒ.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * %__GFP_NOWARN</span><br><span class="hljs-comment"> *	è‹¥åˆ†é…å¤±è´¥ï¼Œä¸è¦æäº¤è­¦å‘Š.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * %__GFP_RETRY_MAYFAIL</span><br><span class="hljs-comment"> *	åŠªåŠ›å°è¯•ä½¿åˆ†é…æˆåŠŸï¼Œä½†æœ€ç»ˆå¤±è´¥.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> CONFIG_SLOB</span><br><span class="hljs-type">static</span> __always_inline __alloc_size(<span class="hljs-number">1</span>) <span class="hljs-type">void</span> *<span class="hljs-title function_">kmalloc</span><span class="hljs-params">(<span class="hljs-type">size_t</span> size, <span class="hljs-type">gfp_t</span> flags)</span><br>&#123;<br>	<span class="hljs-keyword">if</span> (__builtin_constant_p(size) &amp;&amp; size) &#123;<br>		<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> index;<br><br>		<span class="hljs-keyword">if</span> (size &gt; KMALLOC_MAX_CACHE_SIZE)<br>			<span class="hljs-keyword">return</span> kmalloc_large(size, flags);<br><br>		index = kmalloc_index(size);<br>		<span class="hljs-keyword">return</span> kmalloc_trace(<br>				kmalloc_caches[kmalloc_type(flags)][index],<br>				flags, size);<br>	&#125;<br>	<span class="hljs-keyword">return</span> __kmalloc(size, flags);<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="I-kmalloc-large-ï¼šç›´æ¥å‘-buddy-system-è¯·æ±‚å†…å­˜"><a href="#I-kmalloc-large-ï¼šç›´æ¥å‘-buddy-system-è¯·æ±‚å†…å­˜" class="headerlink" title="I. kmalloc_large()ï¼šç›´æ¥å‘ buddy system è¯·æ±‚å†…å­˜"></a>I. kmalloc_large()ï¼šç›´æ¥å‘ buddy system è¯·æ±‚å†…å­˜</h3><p>å¯¹äºè¯·æ±‚å¤§å°å¤§äº <code>KMALLOC_MAX_CACHE_SIZE</code> çš„å†…å­˜åˆ†é…è¯·æ±‚è€Œè¨€ï¼Œ <code>kmalloc()</code> ä¼šç›´æ¥è°ƒç”¨ <code>kmalloc_large()</code> å®Œæˆå†…å­˜åˆ†é…ï¼Œæœ€åå®é™…ä¸Šä¼šåœ¨ <code>__kmalloc_large_node()</code> è°ƒç”¨ <code>alloc_pages()</code> å‘ buddy system è¯·æ±‚å†…å­˜ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * ä¸ºäº†é¿å…ä¸å¿…è¦çš„å¼€é”€,æˆ‘ä»¬å°†å¤§çš„åˆ†é…è¯·æ±‚ç›´æ¥ä¼ é€’ç»™é¡µé¢åˆ†é…å™¨.</span><br><span class="hljs-comment"> * æˆ‘ä»¬ä½¿ç”¨ __GFP_COMP, å› ä¸ºæˆ‘ä»¬éœ€è¦çŸ¥é“åˆ†é…çš„ order ä»¥åœ¨ kfree ä¸­æ°å½“åœ°é‡Šæ”¾.</span><br><span class="hljs-comment"> */</span><br><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> *__kmalloc_large_node(<span class="hljs-type">size_t</span> size, <span class="hljs-type">gfp_t</span> flags, <span class="hljs-type">int</span> node)<br>&#123;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">page</span> *<span class="hljs-title">page</span>;</span><br>	<span class="hljs-type">void</span> *ptr = <span class="hljs-literal">NULL</span>;<br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> order = get_order(size);<br><br>	<span class="hljs-keyword">if</span> (unlikely(flags &amp; GFP_SLAB_BUG_MASK))<br>		flags = kmalloc_fix_flags(flags);<br><br>	flags |= __GFP_COMP;<br>	page = alloc_pages_node(node, flags, order);<br>	<span class="hljs-keyword">if</span> (page) &#123;<br>		ptr = page_address(page);<br>		mod_lruvec_page_state(page, NR_SLAB_UNRECLAIMABLE_B,<br>				      PAGE_SIZE &lt;&lt; order);<br>	&#125;<br><br>	ptr = kasan_kmalloc_large(ptr, size, flags);<br>	<span class="hljs-comment">/* As ptr might get tagged, call kmemleak hook after KASAN. */</span><br>	kmemleak_alloc(ptr, size, <span class="hljs-number">1</span>, flags);<br>	kmsan_kmalloc_large(ptr, size, flags);<br><br>	<span class="hljs-keyword">return</span> ptr;<br>&#125;<br><br><span class="hljs-type">void</span> *<span class="hljs-title function_">kmalloc_large</span><span class="hljs-params">(<span class="hljs-type">size_t</span> size, <span class="hljs-type">gfp_t</span> flags)</span><br>&#123;<br>	<span class="hljs-type">void</span> *ret = __kmalloc_large_node(size, flags, NUMA_NO_NODE);<br><br>	trace_kmalloc(_RET_IP_, ret, size, PAGE_SIZE &lt;&lt; get_order(size),<br>		      flags, NUMA_NO_NODE);<br>	<span class="hljs-keyword">return</span> ret;<br>&#125;<br>EXPORT_SYMBOL(kmalloc_large);<br></code></pre></td></tr></table></figure>



<h3 id="II-kmalloc-index-ï¼šè·å–sizeå¯¹åº”ä¸‹æ ‡"><a href="#II-kmalloc-index-ï¼šè·å–sizeå¯¹åº”ä¸‹æ ‡" class="headerlink" title="II. __kmalloc_index()ï¼šè·å–sizeå¯¹åº”ä¸‹æ ‡"></a>II. __kmalloc_index()ï¼šè·å–sizeå¯¹åº”ä¸‹æ ‡</h3><p><code>kmalloc_index()</code> å…¶å®å°±æ˜¯ <code>__kmalloc_indexï¼ˆï¼‰</code>ï¼Œæ ¹æ®è¯·æ±‚çš„å¤§å°è¿”å›å¯¹åº”çš„ä¸‹æ ‡ï¼Œæ•´ä½“é€»è¾‘éå¸¸ç®€å•ç²—æš´ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * ç®—å‡ºä¸€ä¸ªç‰¹å®šå¤§å°çš„åˆ†é…å±äºå“ªä¸ª kmalloc slab .</span><br><span class="hljs-comment"> * 0 = zero alloc</span><br><span class="hljs-comment"> * 1 =  65 .. 96 bytes</span><br><span class="hljs-comment"> * 2 = 129 .. 192 bytes</span><br><span class="hljs-comment"> * n = 2^(n-1)+1 .. 2^n</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * æ³¨æ„: __kmalloc_index() åœ¨ç¼–è¯‘æœŸä¼˜åŒ–, æ²¡æœ‰è¿è¡Œæ—¶ä¼˜åŒ–;</span><br><span class="hljs-comment"> * å…¸å‹çš„ç”¨æ³•ä¸ºé€šè¿‡ kmalloc_index() ä»¥åœ¨ç¼–è¯‘æœŸä¼˜åŒ–.</span><br><span class="hljs-comment"> * å¤§å°éå¸¸é‡çš„è°ƒç”¨è€…ä»…åº”å½“ä¸º__kmalloc_index()çš„è¿è¡Œæ—¶å¼€é”€å¯ä»¥è¢«æ¥å—çš„æµ‹è¯•æ¨¡å—.</span><br><span class="hljs-comment"> * åŒæ ·å‚è§ kmalloc_slab().</span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">static</span> __always_inline <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> __kmalloc_index(<span class="hljs-type">size_t</span> size,<br>						    <span class="hljs-type">bool</span> size_is_constant)<br>&#123;<br>	<span class="hljs-keyword">if</span> (!size)<br>		<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br><br>	<span class="hljs-keyword">if</span> (size &lt;= KMALLOC_MIN_SIZE)<br>		<span class="hljs-keyword">return</span> KMALLOC_SHIFT_LOW;<br><br>	<span class="hljs-keyword">if</span> (KMALLOC_MIN_SIZE &lt;= <span class="hljs-number">32</span> &amp;&amp; size &gt; <span class="hljs-number">64</span> &amp;&amp; size &lt;= <span class="hljs-number">96</span>)<br>		<span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;<br>	<span class="hljs-keyword">if</span> (KMALLOC_MIN_SIZE &lt;= <span class="hljs-number">64</span> &amp;&amp; size &gt; <span class="hljs-number">128</span> &amp;&amp; size &lt;= <span class="hljs-number">192</span>)<br>		<span class="hljs-keyword">return</span> <span class="hljs-number">2</span>;<br>	<span class="hljs-keyword">if</span> (size &lt;=          <span class="hljs-number">8</span>) <span class="hljs-keyword">return</span> <span class="hljs-number">3</span>;<br>	<span class="hljs-keyword">if</span> (size &lt;=         <span class="hljs-number">16</span>) <span class="hljs-keyword">return</span> <span class="hljs-number">4</span>;<br>	<span class="hljs-keyword">if</span> (size &lt;=         <span class="hljs-number">32</span>) <span class="hljs-keyword">return</span> <span class="hljs-number">5</span>;<br>	<span class="hljs-keyword">if</span> (size &lt;=         <span class="hljs-number">64</span>) <span class="hljs-keyword">return</span> <span class="hljs-number">6</span>;<br>	<span class="hljs-keyword">if</span> (size &lt;=        <span class="hljs-number">128</span>) <span class="hljs-keyword">return</span> <span class="hljs-number">7</span>;<br>	<span class="hljs-keyword">if</span> (size &lt;=        <span class="hljs-number">256</span>) <span class="hljs-keyword">return</span> <span class="hljs-number">8</span>;<br>	<span class="hljs-keyword">if</span> (size &lt;=        <span class="hljs-number">512</span>) <span class="hljs-keyword">return</span> <span class="hljs-number">9</span>;<br>	<span class="hljs-keyword">if</span> (size &lt;=       <span class="hljs-number">1024</span>) <span class="hljs-keyword">return</span> <span class="hljs-number">10</span>;<br>	<span class="hljs-keyword">if</span> (size &lt;=   <span class="hljs-number">2</span> * <span class="hljs-number">1024</span>) <span class="hljs-keyword">return</span> <span class="hljs-number">11</span>;<br>	<span class="hljs-keyword">if</span> (size &lt;=   <span class="hljs-number">4</span> * <span class="hljs-number">1024</span>) <span class="hljs-keyword">return</span> <span class="hljs-number">12</span>;<br>	<span class="hljs-keyword">if</span> (size &lt;=   <span class="hljs-number">8</span> * <span class="hljs-number">1024</span>) <span class="hljs-keyword">return</span> <span class="hljs-number">13</span>;<br>	<span class="hljs-keyword">if</span> (size &lt;=  <span class="hljs-number">16</span> * <span class="hljs-number">1024</span>) <span class="hljs-keyword">return</span> <span class="hljs-number">14</span>;<br>	<span class="hljs-keyword">if</span> (size &lt;=  <span class="hljs-number">32</span> * <span class="hljs-number">1024</span>) <span class="hljs-keyword">return</span> <span class="hljs-number">15</span>;<br>	<span class="hljs-keyword">if</span> (size &lt;=  <span class="hljs-number">64</span> * <span class="hljs-number">1024</span>) <span class="hljs-keyword">return</span> <span class="hljs-number">16</span>;<br>	<span class="hljs-keyword">if</span> (size &lt;= <span class="hljs-number">128</span> * <span class="hljs-number">1024</span>) <span class="hljs-keyword">return</span> <span class="hljs-number">17</span>;<br>	<span class="hljs-keyword">if</span> (size &lt;= <span class="hljs-number">256</span> * <span class="hljs-number">1024</span>) <span class="hljs-keyword">return</span> <span class="hljs-number">18</span>;<br>	<span class="hljs-keyword">if</span> (size &lt;= <span class="hljs-number">512</span> * <span class="hljs-number">1024</span>) <span class="hljs-keyword">return</span> <span class="hljs-number">19</span>;<br>	<span class="hljs-keyword">if</span> (size &lt;= <span class="hljs-number">1024</span> * <span class="hljs-number">1024</span>) <span class="hljs-keyword">return</span> <span class="hljs-number">20</span>;<br>	<span class="hljs-keyword">if</span> (size &lt;=  <span class="hljs-number">2</span> * <span class="hljs-number">1024</span> * <span class="hljs-number">1024</span>) <span class="hljs-keyword">return</span> <span class="hljs-number">21</span>;<br><br>	<span class="hljs-keyword">if</span> (!IS_ENABLED(CONFIG_PROFILE_ALL_BRANCHES) &amp;&amp; size_is_constant)<br>		BUILD_BUG_ON_MSG(<span class="hljs-number">1</span>, <span class="hljs-string">&quot;unexpected size in kmalloc_index()&quot;</span>);<br>	<span class="hljs-keyword">else</span><br>		BUG();<br><br>	<span class="hljs-comment">/* Will never be reached. Needed because the compiler may complain */</span><br>	<span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="III-kmalloc-types-ï¼šè·å–æ ‡å¿—ä½å¯¹åº”ç±»å‹"><a href="#III-kmalloc-types-ï¼šè·å–æ ‡å¿—ä½å¯¹åº”ç±»å‹" class="headerlink" title="III. kmalloc_types()ï¼šè·å–æ ‡å¿—ä½å¯¹åº”ç±»å‹"></a>III. kmalloc_types()ï¼šè·å–æ ‡å¿—ä½å¯¹åº”ç±»å‹</h3><p><code>kmalloc_type()</code> å…¶å®ä¸»è¦å°±æ˜¯æ ¹æ®æ ‡å¿—ä½è¿”å›ç±»å‹ï¼Œé™¤äº†æŒ‡å®šäº† <code>__GFP_DMA/__GFP_RECLAIMABLE/__GFP_ACCOUNT</code> ä»¥å¤–å°±éƒ½æ˜¯ <code>KMALLOC_NORMAL</code>ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> __always_inline <span class="hljs-keyword">enum</span> kmalloc_cache_type <span class="hljs-title function_">kmalloc_type</span><span class="hljs-params">(<span class="hljs-type">gfp_t</span> flags)</span><br>&#123;<br>	<span class="hljs-comment">/*</span><br><span class="hljs-comment">	 * æœ€å¸¸è§„çš„æƒ…å†µä¸º KMALLOC_NORMAL, æ‰€ä»¥ç”¨ä¸€ä¸ªå•ç‹¬çš„åˆ†æ”¯æµ‹è¯•æ‰€æœ‰ç›¸å…³çš„æ ‡å¿—ä½.</span><br><span class="hljs-comment">	 */</span><br>	<span class="hljs-keyword">if</span> (likely((flags &amp; KMALLOC_NOT_NORMAL_BITS) == <span class="hljs-number">0</span>))<br>		<span class="hljs-keyword">return</span> KMALLOC_NORMAL;<br><br>	<span class="hljs-comment">/*</span><br><span class="hljs-comment">	 * è‡³å°‘éœ€è¦è®¾ç½®ä¸€ç§æ ‡å¿—ä½. ä¼˜å…ˆé¡ºåºä¸º:</span><br><span class="hljs-comment">	 *  1) __GFP_DMA</span><br><span class="hljs-comment">	 *  2) __GFP_RECLAIMABLE</span><br><span class="hljs-comment">	 *  3) __GFP_ACCOUNT</span><br><span class="hljs-comment">	 */</span><br>	<span class="hljs-keyword">if</span> (IS_ENABLED(CONFIG_ZONE_DMA) &amp;&amp; (flags &amp; __GFP_DMA))<br>		<span class="hljs-keyword">return</span> KMALLOC_DMA;<br>	<span class="hljs-keyword">if</span> (!IS_ENABLED(CONFIG_MEMCG_KMEM) || (flags &amp; __GFP_RECLAIMABLE))<br>		<span class="hljs-keyword">return</span> KMALLOC_RECLAIM;<br>	<span class="hljs-keyword">else</span><br>		<span class="hljs-keyword">return</span> KMALLOC_CGROUP;<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="IV-kmalloc-trace-ï¼šå¸¸è§„å¤§å°çš„-NUMA-NO-NODE-å¯¹è±¡åˆ†é…"><a href="#IV-kmalloc-trace-ï¼šå¸¸è§„å¤§å°çš„-NUMA-NO-NODE-å¯¹è±¡åˆ†é…" class="headerlink" title="IV. kmalloc_trace()ï¼šå¸¸è§„å¤§å°çš„ NUMA_NO_NODE å¯¹è±¡åˆ†é…"></a>IV. kmalloc_trace()ï¼šå¸¸è§„å¤§å°çš„ NUMA_NO_NODE å¯¹è±¡åˆ†é…</h3><p><code>kmalloc_trace()</code> ä¸»è¦æ˜¯å¯¹ <code>__kmem_cache_alloc_node()</code> çš„ wrapperï¼ŒåŠ ä¸Š tracepoint å’Œ kasan çš„ç›¸å…³è®¾ç½®ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯è¿™é‡Œä¼šæŒ‡å®š node ä¸º <code>NUMA_NO_NODE</code>ï¼š</p>
<blockquote>
<p>ä¸çŸ¥é“ä»€ä¹ˆæ˜¯ kernel trace point çš„å¯ä»¥å‚è§ <a target="_blank" rel="noopener" href="https://docs.kernel.org/trace/tracepoints.html">è¿™é‡Œ</a></p>
</blockquote>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span> *<span class="hljs-title function_">kmalloc_trace</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> kmem_cache *s, <span class="hljs-type">gfp_t</span> gfpflags, <span class="hljs-type">size_t</span> size)</span><br>&#123;<br>	<span class="hljs-type">void</span> *ret = __kmem_cache_alloc_node(s, gfpflags, NUMA_NO_NODE,<br>					    size, _RET_IP_);<br><br>	trace_kmalloc(_RET_IP_, ret, size, s-&gt;size, gfpflags, NUMA_NO_NODE);<br><br>	ret = kasan_kmalloc(s, ret, size, gfpflags);<br>	<span class="hljs-keyword">return</span> ret;<br>&#125;<br>EXPORT_SYMBOL(kmalloc_trace);<br></code></pre></td></tr></table></figure>

<p><code>__kmem_cache_alloc_node()</code> å…¶å®å°±æ˜¯ <code>slab_alloc_node()</code> çš„ wrapperï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span> *__kmem_cache_alloc_node(<span class="hljs-keyword">struct</span> kmem_cache *s, <span class="hljs-type">gfp_t</span> gfpflags,<br>			      <span class="hljs-type">int</span> node, <span class="hljs-type">size_t</span> orig_size,<br>			      <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> caller)<br>&#123;<br>	<span class="hljs-keyword">return</span> slab_alloc_node(s, <span class="hljs-literal">NULL</span>, gfpflags, node,<br>			       caller, orig_size);<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="V-kmalloc-ï¼šå¸¸è§„å¤§å°çš„-NUMA-NO-NODE-å¯¹è±¡åˆ†é…"><a href="#V-kmalloc-ï¼šå¸¸è§„å¤§å°çš„-NUMA-NO-NODE-å¯¹è±¡åˆ†é…" class="headerlink" title="V. __kmalloc()ï¼šå¸¸è§„å¤§å°çš„ NUMA_NO_NODE å¯¹è±¡åˆ†é…"></a>V. __kmalloc()ï¼šå¸¸è§„å¤§å°çš„ NUMA_NO_NODE å¯¹è±¡åˆ†é…</h3><p><code>__kmalloc()</code> å…¶å®å°±æ˜¯æŒ‡å®š node ä¸º <code> NUMA_NO_NODE</code> çš„ <code>__do_kmalloc_node()</code> ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span> *__kmalloc(<span class="hljs-type">size_t</span> size, <span class="hljs-type">gfp_t</span> flags)<br>&#123;<br>	<span class="hljs-keyword">return</span> __do_kmalloc_node(size, flags, NUMA_NO_NODE, _RET_IP_);<br>&#125;<br>EXPORT_SYMBOL(__kmalloc);<br></code></pre></td></tr></table></figure>

<h3 id="VI-do-kmalloc-node-ï¼šåˆ¤æ–­æ‰€éœ€-kmem-cache-å¹¶è¿›è¡Œå¯¹è±¡åˆ†é…"><a href="#VI-do-kmalloc-node-ï¼šåˆ¤æ–­æ‰€éœ€-kmem-cache-å¹¶è¿›è¡Œå¯¹è±¡åˆ†é…" class="headerlink" title="VI. __do_kmalloc_node()ï¼šåˆ¤æ–­æ‰€éœ€ kmem_cache å¹¶è¿›è¡Œå¯¹è±¡åˆ†é…"></a>VI. __do_kmalloc_node()ï¼šåˆ¤æ–­æ‰€éœ€ kmem_cache å¹¶è¿›è¡Œå¯¹è±¡åˆ†é…</h3><p>è¯¥å‡½æ•°çš„ä¸»è¦é€»è¾‘ä¸ºï¼š</p>
<ul>
<li>è‹¥ <code>size &gt; KMALLOC_MAX_CACHE_SIZE</code> ï¼Œåˆ™è°ƒç”¨ <code>__kmalloc_large_node()</code> è¿›è¡Œåˆ†é…ï¼Œå¹¶è¿›è¡Œ tracepoint ä¸ kasan ç›¸å…³è®¾ç½®</li>
<li>å¯¹äºå¸¸è§„ sizeï¼š<ul>
<li>é¦–å…ˆè°ƒç”¨ <code>kmalloc_slab()</code> è·å–å¯¹åº”çš„ <code>kmem_cache</code></li>
<li>æ¥ä¸‹æ¥è°ƒç”¨ <code>__kmem_cache_alloc_node()</code> è¿›è¡Œå†…å­˜åˆ†é…</li>
<li>æœ€åè¿›è¡Œ tracepoint ä¸ kasan ç›¸å…³è®¾ç½®</li>
</ul>
</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> __always_inline<br><span class="hljs-type">void</span> *__do_kmalloc_node(<span class="hljs-type">size_t</span> size, <span class="hljs-type">gfp_t</span> flags, <span class="hljs-type">int</span> node, <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> caller)<br>&#123;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">kmem_cache</span> *<span class="hljs-title">s</span>;</span><br>	<span class="hljs-type">void</span> *ret;<br><br>	<span class="hljs-keyword">if</span> (unlikely(size &gt; KMALLOC_MAX_CACHE_SIZE)) &#123;<br>		ret = __kmalloc_large_node(size, flags, node);<br>		trace_kmalloc(caller, ret, size,<br>			      PAGE_SIZE &lt;&lt; get_order(size), flags, node);<br>		<span class="hljs-keyword">return</span> ret;<br>	&#125;<br><br>	s = kmalloc_slab(size, flags);<br><br>	<span class="hljs-keyword">if</span> (unlikely(ZERO_OR_NULL_PTR(s)))<br>		<span class="hljs-keyword">return</span> s;<br><br>	ret = __kmem_cache_alloc_node(s, flags, node, size, caller);<br>	ret = kasan_kmalloc(s, ret, size, flags);<br>	trace_kmalloc(caller, ret, size, s-&gt;size, flags, node);<br>	<span class="hljs-keyword">return</span> ret;<br>&#125;<br></code></pre></td></tr></table></figure>

<p><code>kmalloc_slab()</code> ä¸­å¯»æ‰¾ <code>kmem_cache</code> çš„è¿‡ç¨‹å’Œ kmalloc ç±»ä¼¼ï¼Œä¸è¿‡å¯»æ‰¾ä¸‹æ ‡ç”¨çš„æ˜¯ <code>size_index[size_index_elem(size)]</code> å’Œ <code>fls()</code> ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * å¯»æ‰¾æ»¡è¶³ç»™å®šå¤§å°çš„åˆ†é…çš„ kmem_cache ç»“æ„ä½“</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">struct</span> kmem_cache *<span class="hljs-title function_">kmalloc_slab</span><span class="hljs-params">(<span class="hljs-type">size_t</span> size, <span class="hljs-type">gfp_t</span> flags)</span><br>&#123;<br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> index;<br><br>	<span class="hljs-keyword">if</span> (size &lt;= <span class="hljs-number">192</span>) &#123;<br>		<span class="hljs-keyword">if</span> (!size)<br>			<span class="hljs-keyword">return</span> ZERO_SIZE_PTR;<br><br>		index = size_index[size_index_elem(size)];<br>	&#125; <span class="hljs-keyword">else</span> &#123;<br>		<span class="hljs-keyword">if</span> (WARN_ON_ONCE(size &gt; KMALLOC_MAX_CACHE_SIZE))<br>			<span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;<br>		index = fls(size - <span class="hljs-number">1</span>);<br>	&#125;<br><br>	<span class="hljs-keyword">return</span> kmalloc_caches[kmalloc_type(flags)][index];<br>&#125;<br></code></pre></td></tr></table></figure>

<p><code>size_index</code> å’Œ <code>size_index_elem()</code> çš„å®šä¹‰éƒ½éå¸¸ç®€å•ç²—æš´ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * Conversion table for small slabs sizes / 8 to the index in the</span><br><span class="hljs-comment"> * kmalloc array. This is necessary for slabs &lt; 192 since we have non power</span><br><span class="hljs-comment"> * of two cache sizes there. The size of larger slabs can be determined using</span><br><span class="hljs-comment"> * fls.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">static</span> u8 size_index[<span class="hljs-number">24</span>] __ro_after_init = &#123;<br>	<span class="hljs-number">3</span>,	<span class="hljs-comment">/* 8 */</span><br>	<span class="hljs-number">4</span>,	<span class="hljs-comment">/* 16 */</span><br>	<span class="hljs-number">5</span>,	<span class="hljs-comment">/* 24 */</span><br>	<span class="hljs-number">5</span>,	<span class="hljs-comment">/* 32 */</span><br>	<span class="hljs-number">6</span>,	<span class="hljs-comment">/* 40 */</span><br>	<span class="hljs-number">6</span>,	<span class="hljs-comment">/* 48 */</span><br>	<span class="hljs-number">6</span>,	<span class="hljs-comment">/* 56 */</span><br>	<span class="hljs-number">6</span>,	<span class="hljs-comment">/* 64 */</span><br>	<span class="hljs-number">1</span>,	<span class="hljs-comment">/* 72 */</span><br>	<span class="hljs-number">1</span>,	<span class="hljs-comment">/* 80 */</span><br>	<span class="hljs-number">1</span>,	<span class="hljs-comment">/* 88 */</span><br>	<span class="hljs-number">1</span>,	<span class="hljs-comment">/* 96 */</span><br>	<span class="hljs-number">7</span>,	<span class="hljs-comment">/* 104 */</span><br>	<span class="hljs-number">7</span>,	<span class="hljs-comment">/* 112 */</span><br>	<span class="hljs-number">7</span>,	<span class="hljs-comment">/* 120 */</span><br>	<span class="hljs-number">7</span>,	<span class="hljs-comment">/* 128 */</span><br>	<span class="hljs-number">2</span>,	<span class="hljs-comment">/* 136 */</span><br>	<span class="hljs-number">2</span>,	<span class="hljs-comment">/* 144 */</span><br>	<span class="hljs-number">2</span>,	<span class="hljs-comment">/* 152 */</span><br>	<span class="hljs-number">2</span>,	<span class="hljs-comment">/* 160 */</span><br>	<span class="hljs-number">2</span>,	<span class="hljs-comment">/* 168 */</span><br>	<span class="hljs-number">2</span>,	<span class="hljs-comment">/* 176 */</span><br>	<span class="hljs-number">2</span>,	<span class="hljs-comment">/* 184 */</span><br>	<span class="hljs-number">2</span>	<span class="hljs-comment">/* 192 */</span><br>&#125;;<br><br><span class="hljs-type">static</span> <span class="hljs-keyword">inline</span> <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> <span class="hljs-title function_">size_index_elem</span><span class="hljs-params">(<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> bytes)</span><br>&#123;<br>	<span class="hljs-keyword">return</span> (bytes - <span class="hljs-number">1</span>) / <span class="hljs-number">8</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<h2 id="ä¸‰ã€ä¸Šå±‚è°ƒç”¨æ¥å£å…³ç³»å›¾"><a href="#ä¸‰ã€ä¸Šå±‚è°ƒç”¨æ¥å£å…³ç³»å›¾" class="headerlink" title="ä¸‰ã€ä¸Šå±‚è°ƒç”¨æ¥å£å…³ç³»å›¾"></a>ä¸‰ã€ä¸Šå±‚è°ƒç”¨æ¥å£å…³ç³»å›¾</h2><p>å› ä¸ºå¾ˆå¤šæ¯”å¦‚è¯´ <code>__kmem_cache_alloc_lru()</code> ä¸€ç±»çš„å‡½æ•°å…¶å®æœ€åéƒ½æ˜¯å¯¹ <code>slab_alloc_node()</code> çš„å¥—å¨ƒï¼Œè¿™é‡Œç¬”è€…ç›´æ¥ç»™å‡ºä¸€ä¸ªç®€æ˜“çš„è°ƒç”¨å…³ç³»å›¾ï¼š</p>
<blockquote>
<p>åªæˆªå–äº†ç¬”è€…è®¤ä¸ºæ¯”è¾ƒä¸»è¦çš„é‚£äº›ï¼Œ<del>å› ä¸ºä½œå›¾ä½œåˆ°åé¢å®åœ¨èšŒåŸ ä½äº†</del></p>
</blockquote>
<p><img src="https://s2.loli.net/2023/02/22/wCchFdIZLOn3m7W.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<h1 id="0x03-å¯¹è±¡çš„é‡Šæ”¾"><a href="#0x03-å¯¹è±¡çš„é‡Šæ”¾" class="headerlink" title="0x03. å¯¹è±¡çš„é‡Šæ”¾"></a>0x03. å¯¹è±¡çš„é‡Šæ”¾</h1><h2 id="â€»-ä¸€ã€do-slab-free-ï¼šå‘æŒ‡å®šçš„-kmem-cache-é‡Šæ”¾å¯¹è±¡ï¼ˆé“¾ï¼‰"><a href="#â€»-ä¸€ã€do-slab-free-ï¼šå‘æŒ‡å®šçš„-kmem-cache-é‡Šæ”¾å¯¹è±¡ï¼ˆé“¾ï¼‰" class="headerlink" title="â€» ä¸€ã€do_slab_free()ï¼šå‘æŒ‡å®šçš„ kmem_cache é‡Šæ”¾å¯¹è±¡ï¼ˆé“¾ï¼‰"></a>â€» ä¸€ã€do_slab_free()ï¼šå‘æŒ‡å®šçš„ kmem_cache é‡Šæ”¾å¯¹è±¡ï¼ˆé“¾ï¼‰</h2><p>åœ¨ slab allocator ä¸­å­˜åœ¨ç€å¤šä¸ªä¸åŒçš„å†…å­˜é‡Šæ”¾æ¥å£ï¼Œå…¶æœ€åéƒ½ä¼šè°ƒç”¨åˆ° <code>do_slab_free()</code> å®Œæˆå†…å­˜é‡Šæ”¾çš„å·¥ä½œï¼Œéœ€è¦æ³¨æ„çš„æ˜¯è¯¥å‡½æ•°  <em><strong>å…è®¸é‡Šæ”¾å·²ç»è¿æ¥æˆä¸€æ¡ freelist ä¸”å·²ç»åŠ å¯†å¥½çš„å¤šä¸ªå¯¹è±¡</strong></em>  ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * å¼ºåˆ¶å†…è”å¿«é€Ÿè·¯å¾„ä»¥åˆ›é€ æ— éœ€é¢å¤–çš„å‡½æ•°è°ƒç”¨ä¾¿èƒ½å®Œæˆå¿«é€Ÿè·¯å¾„é‡Šæ”¾çš„kfree&amp;kmem_cache_free.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * å¿«é€Ÿè·¯å¾„ä»…åœ¨æˆ‘ä»¬è¦é‡Šæ”¾ä¼šå½“å‰ cpu slab æ—¶ç”Ÿæ•ˆ.</span><br><span class="hljs-comment"> * è¿™é€šå¸¸æ˜¯åœ¨æˆ‘ä»¬åˆšåˆšåˆ†é…äº†è¯¥å¯¹è±¡çš„æƒ…å†µ.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * è‹¥å¿«é€Ÿè·¯å¾„ä¸å¯ç”¨åˆ™é€€å› __slab_free ä»¥å¤„ç†æ‰€æœ‰ç§ç±»çš„ç‰¹æ®Šå¤„ç†.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * é€šè¿‡æŒ‡å®š head &amp; tail æŒ‡é’ˆ åŠ ä¸Šå¯¹è±¡æ•°é‡ï¼ˆcntï¼‰ï¼Œå¯ä»¥å¤§é‡é‡Šæ”¾åŒ…å«å¤šä¸ªå¯¹è±¡çš„freelist.</span><br><span class="hljs-comment"> * Bulk free indicated by tail pointer being set.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">static</span> __always_inline <span class="hljs-type">void</span> <span class="hljs-title function_">do_slab_free</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> kmem_cache *s,</span><br><span class="hljs-params">				<span class="hljs-keyword">struct</span> slab *slab, <span class="hljs-type">void</span> *head, <span class="hljs-type">void</span> *tail,</span><br><span class="hljs-params">				<span class="hljs-type">int</span> cnt, <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> addr)</span><br>&#123;<br>	<span class="hljs-type">void</span> *tail_obj = tail ? : head;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">kmem_cache_cpu</span> *<span class="hljs-title">c</span>;</span><br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> tid;<br>	<span class="hljs-type">void</span> **freelist;<br></code></pre></td></tr></table></figure>

<p>ä¸åˆ†é…ç±»ä¼¼ï¼Œé‡Šæ”¾åŒæ ·åˆ†ä¸ºå¿«é€Ÿè·¯å¾„ä¸æ…¢é€Ÿè·¯å¾„</p>
<h3 id="I-ç›´æ¥é‡Šæ”¾å›-percpu-slabï¼ˆfast-pathï¼‰"><a href="#I-ç›´æ¥é‡Šæ”¾å›-percpu-slabï¼ˆfast-pathï¼‰" class="headerlink" title="I. ç›´æ¥é‡Šæ”¾å› percpu slabï¼ˆfast pathï¼‰"></a>I. ç›´æ¥é‡Šæ”¾å› percpu slabï¼ˆfast pathï¼‰</h3><p>å¿«é€Ÿè·¯å¾„æ¯”è¾ƒç®€å•ï¼Œä¸»è¦å°±æ˜¯<strong>å¯¹æ¯”å¾…é‡Šæ”¾å¯¹è±¡æ‰€å± slab æ˜¯å¦ä¸º percpu slabï¼Œè‹¥æ˜¯åˆ™ç›´æ¥æŒ‚å›å»å³å¯ï¼Œéµå¾ª LIFO æœºåˆ¶</strong>ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><code class="hljs c">redo:<br>	<span class="hljs-comment">/*</span><br><span class="hljs-comment">	 * ç¡®å®šå½“å‰çš„ per cpu slab. </span><br><span class="hljs-comment">	 * cpu å¯èƒ½åœ¨ä¹‹åæ”¹å˜.ä½†ç”±äºæ•°æ®å·²ç»é€šè¿‡è¯¥æŒ‡é’ˆè·å¾—ï¼Œè¿™å¹¶æ²¡é—®é¢˜.</span><br><span class="hljs-comment">	 * è‹¥æˆ‘ä»¬åœ¨ cmpxchg æœŸé—´åœ¨åŒä¸€ cpu ä¸Šï¼Œé‡Šæ”¾å°†ä¼šæˆåŠŸ.</span><br><span class="hljs-comment">	 */</span><br>	c = raw_cpu_ptr(s-&gt;cpu_slab);<br>	tid = READ_ONCE(c-&gt;tid);<br><br>	<span class="hljs-comment">/* ä¸ slab_alloc_node() ä¸­åœ¨ barrier() ä¸Šçš„æ³¨é‡Šä¸€æ · */</span><br>	barrier();<br><br>	<span class="hljs-comment">// ä¸å±äº percpu slabï¼Œè°ƒç”¨ __slab_free() è¿›è¡Œé‡Šæ”¾</span><br>	<span class="hljs-keyword">if</span> (unlikely(slab != c-&gt;slab)) &#123;<br>		__slab_free(s, slab, head, tail_obj, cnt, addr);<br>		<span class="hljs-keyword">return</span>;<br>	&#125;<br><br>	<span class="hljs-keyword">if</span> (USE_LOCKLESS_FAST_PATH()) &#123;<br>		freelist = READ_ONCE(c-&gt;freelist);<br><br>		<span class="hljs-comment">// ç›´æ¥å°† percpu freelist æ¥åˆ° tail_obj åé¢</span><br>		set_freepointer(s, tail_obj, freelist);<br><br>		<span class="hljs-keyword">if</span> (unlikely(!this_cpu_cmpxchg_double(<br>				s-&gt;cpu_slab-&gt;freelist, s-&gt;cpu_slab-&gt;tid,<br>				freelist, tid,<br>				head, next_tid(tid)))) &#123;<br><br>			note_cmpxchg_failure(<span class="hljs-string">&quot;slab_free&quot;</span>, s, tid);<br>			<span class="hljs-keyword">goto</span> redo;<br>		&#125;<br>	&#125; <span class="hljs-keyword">else</span> &#123;<br>		<span class="hljs-comment">/* Update the free list under the local lock */</span><br>		local_lock(&amp;s-&gt;cpu_slab-&gt;lock);<br>		c = this_cpu_ptr(s-&gt;cpu_slab);<br>		<span class="hljs-keyword">if</span> (unlikely(slab != c-&gt;slab)) &#123;<br>			local_unlock(&amp;s-&gt;cpu_slab-&gt;lock);<br>			<span class="hljs-keyword">goto</span> redo;<br>		&#125;<br>		tid = c-&gt;tid;<br>		freelist = c-&gt;freelist;<br><br>		<span class="hljs-comment">// ç›´æ¥å°† percpu freelist æ¥åˆ° tail_obj åé¢</span><br>		set_freepointer(s, tail_obj, freelist);<br>		c-&gt;freelist = head;<br>		c-&gt;tid = next_tid(tid);<br><br>		local_unlock(&amp;s-&gt;cpu_slab-&gt;lock);<br>	&#125;<br>	stat(s, FREE_FASTPATH);<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="II-slab-free-ï¼šé‡Šæ”¾å›å¯¹åº”çš„-slabï¼ˆslow-pathï¼‰"><a href="#II-slab-free-ï¼šé‡Šæ”¾å›å¯¹åº”çš„-slabï¼ˆslow-pathï¼‰" class="headerlink" title="II. __slab_free()ï¼šé‡Šæ”¾å›å¯¹åº”çš„ slabï¼ˆslow pathï¼‰"></a>II. __slab_free()ï¼šé‡Šæ”¾å›å¯¹åº”çš„ slabï¼ˆslow pathï¼‰</h3><p>å¦‚æœå¾…é‡Šæ”¾å¯¹è±¡ä¸å±äº percpu clabï¼Œåˆ™è°ƒç”¨ <code>__slab_free()</code> è¿›è¡Œé‡Šæ”¾ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * å¤„ç†æ…¢é€Ÿè·¯å¾„. è¿™å¯èƒ½ä¼šè¢«é¢‘ç¹è°ƒç”¨å› ä¸ºåœ¨å¤§éƒ¨åˆ†æƒ…å†µä¸‹å¯¹è±¡æ¯”cpu slabç”Ÿå‘½å‘¨æœŸæ›´é•¿</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * æ‰€ä»¥æˆ‘ä»¬ä»å°è¯•å‡å°‘ç¼“å­˜è¡Œçš„ä½¿ç”¨ç‡. æ‹¿å– slab lock å¹¶é‡Šæ”¾å¯¹è±¡å³å¯.</span><br><span class="hljs-comment"> * è‹¥ä¸éœ€è¦é¢å¤–çš„ partial slab handling æˆ‘ä»¬ä¾¿å¯ç«‹å³è¿”å›.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> __slab_free(<span class="hljs-keyword">struct</span> kmem_cache *s, <span class="hljs-keyword">struct</span> slab *slab,<br>			<span class="hljs-type">void</span> *head, <span class="hljs-type">void</span> *tail, <span class="hljs-type">int</span> cnt,<br>			<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> addr)<br><br>&#123;<br>	<span class="hljs-type">void</span> *prior;<br>	<span class="hljs-type">int</span> was_frozen;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">slab</span> <span class="hljs-title">new</span>;</span><br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> counters;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">kmem_cache_node</span> *<span class="hljs-title">n</span> =</span> <span class="hljs-literal">NULL</span>;<br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> flags;<br><br>	stat(s, FREE_SLOWPATH);<br></code></pre></td></tr></table></figure>

<p>é¦–å…ˆè¿˜æ˜¯ kfence å’Œ debug ç›¸å…³ï¼Œå¦‚æœè¯¥ <code>kmem_cache</code> è®¾ç½®äº† <code>SLAB_DEBUG_FLAGS</code> æ ‡å¿—ä½åˆ™ç›´æ¥è°ƒç”¨ <code>free_to_partial_list()</code> åè¿”å›å³å¯ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">if</span> (kfence_free(head))<br>	<span class="hljs-keyword">return</span>;<br><br><span class="hljs-keyword">if</span> (IS_ENABLED(CONFIG_SLUB_TINY) || kmem_cache_debug(s)) &#123;<br>	free_to_partial_list(s, slab, head, tail, cnt, addr);<br>	<span class="hljs-keyword">return</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>ä¹‹åæ˜¯ä¸€ä¸ª <code>do while</code> å¾ªç¯ï¼Œé¦–å…ˆä¼šå°† <strong><code>å¾…é‡Šæ”¾ freelist æ‰€å± slab çš„ freelist</code></strong> è¿æ¥åˆ° <strong><code>å¾…é‡Šæ”¾ freelist çš„ tail object</code></strong> åè¾¹ï¼Œè¿™é‡Œçš„ <code>new</code> æ˜¯ä¸€ä¸ªæ ˆä¸Šçš„ä¸´æ—¶ slab ç»“æ„ä½“ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">do</span> &#123;<br>	<span class="hljs-keyword">if</span> (unlikely(n)) &#123;<br>		spin_unlock_irqrestore(&amp;n-&gt;list_lock, flags);<br>		n = <span class="hljs-literal">NULL</span>;<br>	&#125;<br>	prior = slab-&gt;freelist;<br>	counters = slab-&gt;counters;<br>	set_freepointer(s, tail, prior);<br>	new.counters = counters;<br>	was_frozen = new.frozen;<br>	new.inuse -= cnt;<br></code></pre></td></tr></table></figure>

<p>æ¥ä¸‹æ¥æ£€æŸ¥æ˜¯å¦  <strong><code>(æ‰€æœ‰çš„å¯¹è±¡éƒ½*å°†*ä¸ºç©ºé—²å¯¹è±¡ || åŸ slab ä¸Šæ— ç©ºé—²å¯¹è±¡) &amp;&amp; slab æœªè¢«å†»ç»“</code></strong> ï¼Œè‹¥æ»¡è¶³è¯¥æ¡ä»¶åˆ™ï¼š</p>
<ul>
<li>æ£€æŸ¥æ˜¯å¦æœ‰ percpu partial slab ä¸”åŸ slab ä¸Šæ— ç©ºé—²å¯¹è±¡ï¼ˆå³ slab-&gt;freelistï¼ˆä¹Ÿå°±æ˜¯ä»£ç ä¸­çš„ <code>prior</code>ï¼‰ä¸º NULLï¼‰ï¼š<ul>
<li>è‹¥æ˜¯ï¼Œåˆ™è®¾ç½® slab å°†è¢«å†»ç»“ï¼ˆ<code>new.frozen=1</code>ï¼‰</li>
<li>è‹¥å¦ï¼Œåˆ™è·å– slab æ‰€å¯¹åº”çš„ <code>kmem_cache_node</code></li>
</ul>
</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">if</span> ((!new.inuse || !prior) &amp;&amp; !was_frozen) &#123;<br><br>	<span class="hljs-keyword">if</span> (kmem_cache_has_cpu_partial(s) &amp;&amp; !prior) &#123;<br><br>		<span class="hljs-comment">/*</span><br><span class="hljs-comment">		 * Slab ä¹‹å‰ä¸åœ¨é“¾è¡¨ä¸Šä¸”å°†ä¼šéƒ¨åˆ†ä¸ºç©º</span><br><span class="hljs-comment">		 * æˆ‘ä»¬å¯ä»¥æ¨è¿Ÿé“¾è¡¨ç§»åŠ¨ï¼Œè€Œæ˜¯åä¹‹å°†å…¶å†»ç»“.</span><br><span class="hljs-comment">		 */</span><br>		new.frozen = <span class="hljs-number">1</span>;<br><br>	&#125; <span class="hljs-keyword">else</span> &#123; <span class="hljs-comment">/* éœ€è¦ä»ä¸€ä¸ªé“¾è¡¨ä¸Šå–ä¸‹ */</span><br><br>		n = get_node(s, slab_nid(slab));<br>		<span class="hljs-comment">/*</span><br><span class="hljs-comment">		 * æ¨æµ‹æ€§åœ°è·å– list_lock.</span><br><span class="hljs-comment">		 * è‹¥ cmpxchg æœªæˆåŠŸï¼Œåˆ™æˆ‘ä»¬å¯èƒ½</span><br><span class="hljs-comment">		 * åœ¨ä¸è¿›è¡Œä»»ä½•å¤„ç†çš„æƒ…å†µä¸‹æ”¾å¼ƒ list_lock.</span><br><span class="hljs-comment">		 *</span><br><span class="hljs-comment">		 * å¦åˆ™ list_lock å°†ä¸å…¶ä»–å¤„ç†å™¨åŒæ­¥æ›´æ–° slabs é“¾è¡¨</span><br><span class="hljs-comment">		 */</span><br>		spin_lock_irqsave(&amp;n-&gt;list_lock, flags);<br><br>	&#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>å¾ªç¯çš„ç»ˆæ­¢æ¡ä»¶ç”¨äº†ä¸€ä¸ª <code>cmpxchg_double_slab()</code> å‡½æ•°ï¼Œ<del>å¥—å¨ƒå¥—å¾—ğŸ‘´å¤´æ˜çœ¼èŠ±</del>ï¼Œä¸»è¦é€»è¾‘ä¸ºï¼š</p>
<ul>
<li><strong>å¯¹æ¯” slab-&gt;freelist &#x3D;&#x3D; prior &amp;&amp; slab-&gt;counters &#x3D;&#x3D; countersï¼Œè‹¥æ˜¯ï¼Œåˆ™å°† slab-&gt;freelist è®¾ä¸º head ä¸”å°† slab-&gt;counters è®¾ä¸º new.counters</strong>ï¼Œè¯¥æ“ä½œæˆåŠŸåˆ™è¿”å› trueï¼Œæ¡ä»¶ä¸ç¬¦åˆ™è¿”å› false</li>
</ul>
<p>æˆåŠŸäº†å¾ªç¯å°†ä¼šç›´æ¥è·³å‡ºï¼šï¼‰</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c">&#125; <span class="hljs-keyword">while</span> (!cmpxchg_double_slab(s, slab,<br>	prior, counters,<br>	head, new.counters,<br>	<span class="hljs-string">&quot;__slab_free&quot;</span>));<br></code></pre></td></tr></table></figure>

<p>æ¥ä¸‹æ¥æ£€æŸ¥<strong>è¯¥ slab æ˜¯å¦éœ€è¦ä»ä¸€ä¸ª <code>kmem_cache_node</code> çš„é“¾è¡¨ä¸Šå–ä¸‹ï¼Œè‹¥å¦ï¼Œ</strong>åˆ™ï¼š</p>
<ul>
<li>è‹¥ slab å·²ç»è¢«å†»ç»“ï¼Œstat() ä¸€ä¸‹ï¼ˆåŸºæœ¬ä¸Šç­‰äºå•¥éƒ½ä¸åšï¼‰</li>
<li>è‹¥ slab éœ€è¦è¢«å†»ç»“ ï¼ˆ<code>new.frozen</code> ä¸º trueï¼‰ï¼Œè°ƒç”¨ <code>put_cpu_partial()</code> ç›´æ¥å°† slab æ”¾åˆ° percpu partial é“¾è¡¨</li>
<li>é‡Šæ”¾å·¥ä½œå®Œæˆï¼Œè¿”å›</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">if</span> (likely(!n)) &#123;<br><br>	<span class="hljs-keyword">if</span> (likely(was_frozen)) &#123;<br>		<span class="hljs-comment">/*</span><br><span class="hljs-comment">		 * é“¾è¡¨é”æœªè¢«å ç”¨ï¼Œå› æ­¤ä¸éœ€è¦æ´»è·ƒä»»ä½•é“¾è¡¨.</span><br><span class="hljs-comment">		 */</span><br>		stat(s, FREE_FROZEN);<br>	&#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (new.frozen) &#123;<br>		<span class="hljs-comment">/*</span><br><span class="hljs-comment">		 * If we just froze the slab then put it onto the</span><br><span class="hljs-comment">		 * per cpu partial list.</span><br><span class="hljs-comment">		 */</span><br>		put_cpu_partial(s, slab, <span class="hljs-number">1</span>);<br>		stat(s, CPU_PARTIAL_FREE);<br>	&#125;<br><br>	<span class="hljs-keyword">return</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>å¦‚æœ slab ä¸Šæ‰€æœ‰å¯¹è±¡éƒ½è¢«é‡Šæ”¾ï¼Œä¸” node ä¸Šçš„ partial slab æ•°é‡å·²ç»è¶…è¿‡ <code>kmem_cache-&gt;min_partial</code> ï¼Œ<strong>è¿™æ„å‘³ç€è¿™æ˜¯ä¸€å¼ å®Œå…¨ç©ºé—²çš„ slab</strong>ï¼Œæ¥ä¸‹æ¥è·³è½¬åˆ° <code>slab_empty</code> æ ‡ç­¾ï¼Œè¯¥æ ‡ç­¾å¯¹åº”ä»£ç å—ä¸»è¦æ˜¯ï¼š</p>
<ul>
<li>è‹¥ slab ä¸ŠåŸæ¥æœ‰ç©ºé—²å¯¹è±¡ï¼ˆä½äº node partial é“¾è¡¨ï¼‰ï¼Œåˆ™ä» partial é“¾è¡¨ç§»é™¤</li>
<li>è‹¥ slab ä¸ŠåŸæ¥æ— ç©ºé—²å¯¹è±¡ï¼ˆä½äº node full é“¾è¡¨ï¼‰ï¼Œåˆ™ä» full é“¾è¡¨ç§»é™¤</li>
<li><strong>æœ€åè°ƒç”¨ <code>discard_slab()</code> é‡Šæ”¾è¿™ä¸€å¼  slab</strong></li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs c">	<span class="hljs-keyword">if</span> (unlikely(!new.inuse &amp;&amp; n-&gt;nr_partial &gt;= s-&gt;min_partial))<br>		<span class="hljs-keyword">goto</span> slab_empty;<br><br>	<span class="hljs-comment">//...</span><br><br>slab_empty:<br>	<span class="hljs-keyword">if</span> (prior) &#123;<br>		<span class="hljs-comment">/*</span><br><span class="hljs-comment">		 * Slab on the partial list.</span><br><span class="hljs-comment">		 */</span><br>		remove_partial(n, slab);<br>		stat(s, FREE_REMOVE_PARTIAL);<br>	&#125; <span class="hljs-keyword">else</span> &#123;<br>		<span class="hljs-comment">/* Slab must be on the full list */</span><br>		remove_full(s, n, slab);<br>	&#125;<br><br>	spin_unlock_irqrestore(&amp;n-&gt;list_lock, flags);<br>	stat(s, FREE_SLAB);<br>	discard_slab(s, slab);<br>&#125;<br><br></code></pre></td></tr></table></figure>

<p>è‹¥ä¸æ»¡è¶³ä¸Šé¢çš„æ¡ä»¶ï¼Œåˆ™æ£€æŸ¥æ˜¯å¦æ²¡æœ‰ percpu partial slab ä¸” slab ä¸ŠåŸ freelist ä¸º NULLï¼ˆå³ä½äº node full é“¾è¡¨ï¼‰ï¼Œè‹¥æ˜¯åˆ™ä» full é“¾è¡¨ç§»é™¤å¹¶æ·»åŠ åˆ° node partial é“¾è¡¨</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * Objects left in the slab. If it was not on the partial list before</span><br><span class="hljs-comment"> * then add it.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">if</span> (!kmem_cache_has_cpu_partial(s) &amp;&amp; unlikely(!prior)) &#123;<br>	remove_full(s, n, slab);<br>	add_partial(n, slab, DEACTIVATE_TO_TAIL);<br>	stat(s, FREE_ADD_PARTIAL);<br>&#125;<br>spin_unlock_irqrestore(&amp;n-&gt;list_lock, flags);<br><span class="hljs-keyword">return</span>;<br></code></pre></td></tr></table></figure>

<p>è‡³æ­¤ï¼Œ slub ç®—æ³•çš„é‡Šæ”¾é€»è¾‘åˆ†æå®Œæ¯•</p>
<h2 id="äºŒã€kfreeï¼šé€šç”¨çš„ä¸Šå±‚é‡Šæ”¾æ¥å£"><a href="#äºŒã€kfreeï¼šé€šç”¨çš„ä¸Šå±‚é‡Šæ”¾æ¥å£" class="headerlink" title="äºŒã€kfreeï¼šé€šç”¨çš„ä¸Šå±‚é‡Šæ”¾æ¥å£"></a>äºŒã€kfreeï¼šé€šç”¨çš„ä¸Šå±‚é‡Šæ”¾æ¥å£</h2><p>æ­£å¦‚åŒ <code>kmalloc()</code> æ˜¯æœ€ä¸ºé€šç”¨çš„å†…æ ¸å¯¹è±¡åˆ†é…å‡½æ•°ï¼Œä¸ä¹‹ç›¸å¯¹åº”çš„é‡Šæ”¾å‡½æ•°ä¾¿æ˜¯ <code>kfree()</code> äº†ï¼Œè¿™ä¸ªå‡½æ•°å…¶å®ä¸»è¦å°±æ˜¯ <code>__kmem_cache_free()</code> çš„ wrapperï¼Œå¯¹äºè¾ƒå¤§çš„å¯¹è±¡åˆ™ä¼šç”¨ <code>free_large_kmalloc()</code> è¿›è¡Œé‡Šæ”¾ï¼Œå¦‚æœ object ä¸º NULL åˆ™ç›´æ¥è¿”å›ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * kfree - é‡Šæ”¾ä¹‹å‰åˆ†é…çš„å¯¹è±¡</span><br><span class="hljs-comment"> * @object: kmalloc è¿”å›çš„æŒ‡é’ˆ.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * è‹¥ @object ä¸º NULL, åˆ™ä¸ä¼šè¿›è¡Œä»»ä½•æ“ä½œ.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * ä¸è¦é‡Šæ”¾ä¸ç”± kmalloc() åˆ†é…çš„å†…å­˜ï¼Œå¦åˆ™ä¼šå‡ºé—®é¢˜.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">void</span> <span class="hljs-title function_">kfree</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">void</span> *object)</span><br>&#123;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">folio</span> *<span class="hljs-title">folio</span>;</span><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">slab</span> *<span class="hljs-title">slab</span>;</span><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">kmem_cache</span> *<span class="hljs-title">s</span>;</span><br><br>	trace_kfree(_RET_IP_, object);<br><br>	<span class="hljs-keyword">if</span> (unlikely(ZERO_OR_NULL_PTR(object)))<br>		<span class="hljs-keyword">return</span>;<br><br>	folio = virt_to_folio(object);<br>	<span class="hljs-keyword">if</span> (unlikely(!folio_test_slab(folio))) &#123;<br>		free_large_kmalloc(folio, (<span class="hljs-type">void</span> *)object);<br>		<span class="hljs-keyword">return</span>;<br>	&#125;<br><br>	slab = folio_slab(folio);<br>	s = slab-&gt;slab_cache;<br>	__kmem_cache_free(s, (<span class="hljs-type">void</span> *)object, _RET_IP_);<br>&#125;<br>EXPORT_SYMBOL(kfree);<br></code></pre></td></tr></table></figure>

<h3 id="I-folio-ç»“æ„ï¼šä¸€æ®µç‰©ç†ã€è™šæ‹Ÿã€é€»è¾‘ä¸Šéƒ½è¿ç»­çš„å†…å­˜"><a href="#I-folio-ç»“æ„ï¼šä¸€æ®µç‰©ç†ã€è™šæ‹Ÿã€é€»è¾‘ä¸Šéƒ½è¿ç»­çš„å†…å­˜" class="headerlink" title="I. folio ç»“æ„ï¼šä¸€æ®µç‰©ç†ã€è™šæ‹Ÿã€é€»è¾‘ä¸Šéƒ½è¿ç»­çš„å†…å­˜"></a>I. folio ç»“æ„ï¼šä¸€æ®µç‰©ç†ã€è™šæ‹Ÿã€é€»è¾‘ä¸Šéƒ½è¿ç»­çš„å†…å­˜</h3><p>æ³¨æ„åˆ°è¿™é‡Œç”¨äº†ä¸€ä¸ªåä¸º <code>folio</code> çš„ç»“æ„ä½“ï¼Œå…¶è¡¨ç¤ºäº†<strong>ä¸€å—ç‰©ç†ã€è™šæ‹Ÿã€é€»è¾‘ä¸Šéƒ½è¿ç»­çš„å†…å­˜</strong>ï¼Œ  <em>å…¶å®æœ¬è´¨ä¸Šè¿˜æ˜¯å¤ç”¨äº† page ç»“æ„ä½“ï¼Œåªä¸è¿‡è¿™ä¸€æ¬¡æ˜¯å°† page è½¬ä¸º folio</em>  ï¼Œå®šä¹‰æ¯”è¾ƒé•¿è¿™é‡Œå°±ä¸è´´ä»£ç äº†</p>
<p><code>virt_to_folio()</code> é¦–å…ˆä¼šç”¨ <code>virt_to_page()</code> æ‰¾åˆ°å¾…é‡Šæ”¾å¯¹è±¡è™šæ‹Ÿåœ°å€å¯¹åº”çš„ <code>page</code> ç»“æ„ä½“ï¼Œä¹‹åç”¨ <code>page_folio()</code> å°†å…¶è½¬æ¢ä¸º folio ç»“æ„ä½“â€”â€”å…¶å®å°±æ˜¯å¯¹äºå¤åˆé¡µè€Œè¨€ä¼šæ‰¾åˆ°ç¬¬ä¸€å¼ é¡µé¢ï¼Œç”±æ­¤å¦‚æœæ˜¯å¤åˆé¡µçš„è¯é‚£è¯´æ˜æ˜¯å¤§ slab æ‰€ä»¥ä¼šè°ƒç”¨ <code>free_large_kmalloc()</code>ï¼Œä¸æ˜¯å¤åˆé¡µè¯´æ˜æ˜¯å° slab æ‰€ä»¥ä¼šè°ƒç”¨ <code>__kmem_cache_free()</code>ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-keyword">inline</span> <span class="hljs-keyword">struct</span> folio *<span class="hljs-title function_">virt_to_folio</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">void</span> *x)</span><br>&#123;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">page</span> *<span class="hljs-title">page</span> =</span> virt_to_page(x);<br><br>	<span class="hljs-keyword">return</span> page_folio(page);<br>&#125;<br><br><span class="hljs-comment">//...</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> page_folio(p)		(_Generic((p),				\</span><br><span class="hljs-meta">	const struct page *:	(const struct folio *)_compound_head(p), \</span><br><span class="hljs-meta">	struct page *:		(struct folio *)_compound_head(p)))</span><br></code></pre></td></tr></table></figure>

<p>ç„¶å <code>folio_test_slab()</code> å…¶å®æ˜¯ <code>include/linux/page-flags.h</code> é‡Œçš„æ‹¼æ¥å®ï¼Œè¿™é‡Œå°±ä¸æ·±å…¥å±•å¼€äº†ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> __always_inline <span class="hljs-type">bool</span> folio_test_#<span class="hljs-meta">#lname(struct folio *folio)	\</span><br><span class="hljs-meta">&#123; return test_bit(PG_##lname, folio_flags(folio, FOLIO_##policy)); &#125;	\</span><br></code></pre></td></tr></table></figure>

<h3 id="II-free-large-kmalloc-ï¼šç›´æ¥å°†é¡µé¢é‡Šæ”¾å›-buddy-system"><a href="#II-free-large-kmalloc-ï¼šç›´æ¥å°†é¡µé¢é‡Šæ”¾å›-buddy-system" class="headerlink" title="II. free_large_kmalloc()ï¼šç›´æ¥å°†é¡µé¢é‡Šæ”¾å› buddy system"></a>II. free_large_kmalloc()ï¼šç›´æ¥å°†é¡µé¢é‡Šæ”¾å› buddy system</h3><p>æ­£å¦‚å¯¹äºå¤§å¯¹è±¡çš„åˆ†é… <code>kmalloc_large()</code> ä¼šç›´æ¥ä» buddy system è¯·æ±‚å†…å­˜ä¸€èˆ¬ï¼Œç›¸å¯¹åº”çš„ <code>free_large_kmalloc()</code> ä¹Ÿä¼šç›´æ¥å°†é¡µé¢é‡Šæ”¾å› buddy systemï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span> <span class="hljs-title function_">free_large_kmalloc</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> folio *folio, <span class="hljs-type">void</span> *object)</span><br>&#123;<br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> order = folio_order(folio);<br><br>	<span class="hljs-keyword">if</span> (WARN_ON_ONCE(order == <span class="hljs-number">0</span>))<br>		pr_warn_once(<span class="hljs-string">&quot;object pointer: 0x%p\n&quot;</span>, object);<br><br>	kmemleak_free(object);<br>	kasan_kfree_large(object);<br>	kmsan_kfree_large(object);<br><br>	mod_lruvec_page_state(folio_page(folio, <span class="hljs-number">0</span>), NR_SLAB_UNRECLAIMABLE_B,<br>			      -(PAGE_SIZE &lt;&lt; order));<br>	__free_pages(folio_page(folio, <span class="hljs-number">0</span>), order);<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="III-kmem-cache-free-ï¼šå¸¸è§„çš„é‡Šæ”¾å‡½æ•°"><a href="#III-kmem-cache-free-ï¼šå¸¸è§„çš„é‡Šæ”¾å‡½æ•°" class="headerlink" title="III. __kmem_cache_free()ï¼šå¸¸è§„çš„é‡Šæ”¾å‡½æ•°"></a>III. __kmem_cache_free()ï¼šå¸¸è§„çš„é‡Šæ”¾å‡½æ•°</h3><p><code>__kmem_cache_free()</code> ä¸»è¦å°±æ˜¯å¯¹ <code>slab_free()</code> çš„ wrapperï¼Œä¸è¿‡ä¼šæŒ‡å®š tail ä¸º NULLï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span> __kmem_cache_free(<span class="hljs-keyword">struct</span> kmem_cache *s, <span class="hljs-type">void</span> *x, <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> caller)<br>&#123;<br>	slab_free(s, virt_to_slab(x), x, <span class="hljs-literal">NULL</span>, &amp;x, <span class="hljs-number">1</span>, caller);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>è€Œ <code>slab_free()</code> åˆ™ä¼šæœ€ç»ˆè°ƒç”¨åˆ° <code>do_slab_free()</code>ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> __fastpath_inline <span class="hljs-type">void</span> <span class="hljs-title function_">slab_free</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> kmem_cache *s, <span class="hljs-keyword">struct</span> slab *slab,</span><br><span class="hljs-params">				      <span class="hljs-type">void</span> *head, <span class="hljs-type">void</span> *tail, <span class="hljs-type">void</span> **p, <span class="hljs-type">int</span> cnt,</span><br><span class="hljs-params">				      <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> addr)</span><br>&#123;<br>	memcg_slab_free_hook(s, slab, p, cnt);<br>	<span class="hljs-comment">/*</span><br><span class="hljs-comment">	 * With KASAN enabled slab_free_freelist_hook modifies the freelist</span><br><span class="hljs-comment">	 * to remove objects, whose reuse must be delayed.</span><br><span class="hljs-comment">	 */</span><br>	<span class="hljs-keyword">if</span> (slab_free_freelist_hook(s, &amp;head, &amp;tail, &amp;cnt))<br>		do_slab_free(s, slab, head, tail, cnt, addr);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>è¿™é‡Œç”¨åˆ°äº†ä¸€ä¸ªå‡½æ•° <code>slab_free_freelist_hook()</code>ï¼Œä¸»è¦çš„ä½œç”¨æ˜¯éå†å¾…é‡Šæ”¾çš„ freelistï¼š</p>
<ul>
<li>å¦‚æœè®¾ç½®äº† free hookï¼ˆ <code>slab_free_hook() == true</code> ï¼‰ï¼Œåˆ™ä»…å‡å°‘è®¡æ•°ä»¥æ¨è¿Ÿé‡Šæ”¾</li>
<li>å¦åˆ™é‡æ–°å»ºç«‹ä¸€é freelist åè¿”å›</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><code class="hljs c"><br><span class="hljs-type">static</span> <span class="hljs-keyword">inline</span> <span class="hljs-type">bool</span> <span class="hljs-title function_">slab_free_freelist_hook</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> kmem_cache *s,</span><br><span class="hljs-params">					   <span class="hljs-type">void</span> **head, <span class="hljs-type">void</span> **tail,</span><br><span class="hljs-params">					   <span class="hljs-type">int</span> *cnt)</span><br>&#123;<br><br>	<span class="hljs-type">void</span> *object;<br>	<span class="hljs-type">void</span> *next = *head;<br>	<span class="hljs-type">void</span> *old_tail = *tail ? *tail : *head;<br><br>	<span class="hljs-keyword">if</span> (is_kfence_address(next)) &#123;<br>		slab_free_hook(s, next, <span class="hljs-literal">false</span>);<br>		<span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>	&#125;<br><br>	<span class="hljs-comment">/* Head and tail of the reconstructed freelist */</span><br>	*head = <span class="hljs-literal">NULL</span>;<br>	*tail = <span class="hljs-literal">NULL</span>;<br><br>	<span class="hljs-keyword">do</span> &#123;<br>		object = next;<br>		next = get_freepointer(s, object);<br><br>		<span class="hljs-comment">/* If object&#x27;s reuse doesn&#x27;t have to be delayed */</span><br>		<span class="hljs-keyword">if</span> (!slab_free_hook(s, object, slab_want_init_on_free(s))) &#123;<br>			<span class="hljs-comment">/* Move object to the new freelist */</span><br>			set_freepointer(s, object, *head);<br>			*head = object;<br>			<span class="hljs-keyword">if</span> (!*tail)<br>				*tail = object;<br>		&#125; <span class="hljs-keyword">else</span> &#123;<br>			<span class="hljs-comment">/*</span><br><span class="hljs-comment">			 * Adjust the reconstructed freelist depth</span><br><span class="hljs-comment">			 * accordingly if object&#x27;s reuse is delayed.</span><br><span class="hljs-comment">			 */</span><br>			--(*cnt);<br>		&#125;<br>	&#125; <span class="hljs-keyword">while</span> (object != old_tail);<br><br>	<span class="hljs-keyword">if</span> (*head == *tail)<br>		*tail = <span class="hljs-literal">NULL</span>;<br><br>	<span class="hljs-keyword">return</span> *head != <span class="hljs-literal">NULL</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<h2 id="ä¸‰ã€ä¸Šå±‚è°ƒç”¨æ¥å£å…³ç³»å›¾-1"><a href="#ä¸‰ã€ä¸Šå±‚è°ƒç”¨æ¥å£å…³ç³»å›¾-1" class="headerlink" title="ä¸‰ã€ä¸Šå±‚è°ƒç”¨æ¥å£å…³ç³»å›¾"></a>ä¸‰ã€ä¸Šå±‚è°ƒç”¨æ¥å£å…³ç³»å›¾</h2><p>æ¶‰åŠåˆ°å†…å­˜é‡Šæ”¾çš„å‡½æ•°ç›¸è¾ƒäºå†…å­˜åˆ†é…å…¶å®å°‘å¾ˆå¤šï¼Œå¸¸ç”¨çš„ä¸»è¦å°±æ˜¯ <code>kfree()</code>ã€<code>kfree_sensitive()</code>ã€<code>kmem_cache_free()</code> è¿™ä¸‰å¤§å‡½æ•°ï¼š</p>
<p><img src="https://s2.loli.net/2023/02/24/Itbqo2eO15yn7ZW.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>

                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
    <div class="post-meta mr-3 d-flex align-items-center">
      <i class="iconfont icon-category"></i>
      

<span class="category-chains">
  
  
    
      <span class="category-chain">
        
  <a href="/categories/OS/" class="category-chain-item">OS</a>
  
  

      </span>
    
  
</span>

    </div>
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/Linux/">#Linux</a>
      
        <a href="/tags/Linux-Kernel/">#Linux Kernel</a>
      
        <a href="/tags/%E5%AD%A6%E4%B9%A0%E6%9C%AD%E8%AE%B0/">#å­¦ä¹ æœ­è®°</a>
      
        <a href="/tags/%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86/">#å†…å­˜ç®¡ç†</a>
      
        <a href="/tags/slub-allocator/">#slub allocator</a>
      
    </div>
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>ã€OS.0x04ã€‘Linux Kernel å†…å­˜ç®¡ç†æµ…æ III - Slub Allocator</div>
      <div>https://arttnba3.github.io/2023/02/24/OS-0X04-LINUX-KERNEL-MEMORY-6.2-PART-III/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>ä½œè€…</div>
          <div>arttnba3</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>å‘å¸ƒäº</div>
          <div>2023å¹´2æœˆ24æ—¥</div>
        </div>
      
      
      <div class="license-meta-item">
        <div>è®¸å¯åè®®</div>
        <div>
          
            
            
              <a target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
              <span class="hint--top hint--rounded" aria-label="BY - ç½²å">
                <i class="iconfont icon-by"></i>
              </span>
              </a>
            
          
        </div>
      </div>
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2023/03/02/FUZZ-0X02-SYZKALLER-II_SOURCE_SYZMANAGER/" title="ã€FUZZ.0x02ã€‘syzkaller - IIï¼šsyz-manageræºç åˆ†æ">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">ã€FUZZ.0x02ã€‘syzkaller - IIï¼šsyz-manageræºç åˆ†æ</span>
                        <span class="visible-mobile">ä¸Šä¸€ç¯‡</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2023/01/29/PAPER-0X01-HUNTING_THE_HAUNTER-EFFICIENT_RELATIONAL_SYMBOLIC_EXECUTION_FOR_SPECTRE_WITH_HAUNTED_RELSE/" title="ã€PAPER.0x01ã€‘è®ºæ–‡ç¬”è®°ï¼šHunting the Haunter â€” Efficient Relational Symbolic Execution for Spectre with Haunted RelSE ">
                        <span class="hidden-mobile">ã€PAPER.0x01ã€‘è®ºæ–‡ç¬”è®°ï¼šHunting the Haunter â€” Efficient Relational Symbolic Execution for Spectre with Haunted RelSE </span>
                        <span class="visible-mobile">ä¸‹ä¸€ç¯‡</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
  <article id="comments" lazyload>
    
  <div id="valine"></div>
  <script type="text/javascript">
    Fluid.utils.loadComments('#valine', function() {
      Fluid.utils.createScript('https://lib.baomitu.com/valine/1.4.17/Valine.min.js', function() {
        var options = Object.assign(
          {"appid":"ICj6cPRQWFTNiOttBHlzxnIv-gzGzoHsz","appkey":"tuvJh3xYxPFcW2JB6K26RKP2","path":"window.location.pathname","placeholder":"è¯´ç‚¹ä»€ä¹ˆå‘—ï¼ˆç¬‘ï¼‰","avatar":"retro","meta":["nick","mail","link"],"requiredFields":[],"pageSize":10,"lang":"zh-CN","highlight":false,"recordIP":false,"serverURLs":"","emojiCDN":null,"emojiMaps":null,"enableQQ":false,"appId":"ICj6cPRQWFTNiOttBHlzxnIv-gzGzoHsz","appKey":"tuvJh3xYxPFcW2JB6K26RKP2"},
          {
            el: "#valine",
            path: window.location.pathname
          }
        )
        new Valine(options);
        Fluid.utils.waitElementVisible('#valine .vcontent', () => {
          var imgSelector = '#valine .vcontent img:not(.vemoji)';
          Fluid.plugins.imageCaption(imgSelector);
          Fluid.plugins.fancyBox(imgSelector);
        })
      });
    });
  </script>
  <noscript>Please enable JavaScript to view the comments</noscript>


  </article>


          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;ç›®å½•</p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  


  
  









    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">æœç´¢</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">å…³é”®è¯</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  <!-- ç½‘ç«™è¿è¡Œæ—¶é—´çš„è®¾ç½® -->
  <span id="timeDate">è½½å…¥å¤©æ•°...</span>
  <span id="times">è½½å…¥æ—¶åˆ†ç§’...</span>
  <script>
      var now = new Date();
      function createtime() {
          var grt= new Date("04/20/2020 17:48:48");//æ­¤å¤„ä¿®æ”¹ä½ çš„å»ºç«™æ—¶é—´æˆ–è€…ç½‘ç«™ä¸Šçº¿æ—¶é—´
          now.setTime(now.getTime()+250);
          days = (now - grt ) / 1000 / 60 / 60 / 24; dnum = Math.floor(days);
          hours = (now - grt ) / 1000 / 60 / 60 - (24 * dnum); hnum = Math.floor(hours);
          if(String(hnum).length ==1 ){hnum = "0" + hnum;} minutes = (now - grt ) / 1000 /60 - (24 * 60 * dnum) - (60 * hnum);
          mnum = Math.floor(minutes); if(String(mnum).length ==1 ){mnum = "0" + mnum;}
          seconds = (now - grt ) / 1000 - (24 * 60 * 60 * dnum) - (60 * 60 * hnum) - (60 * mnum);
          snum = Math.round(seconds); if(String(snum).length ==1 ){snum = "0" + snum;}
          document.getElementById("timeDate").innerHTML = "arttnba3çš„å°å±‹å·²ç»å®‰å…¨å­˜åœ¨äº† "+dnum+" å¤© ";
          document.getElementById("times").innerHTML = hnum + " å°æ—¶ " + mnum + " åˆ† " + snum + " ç§’";
      }
  setInterval("createtime()",250);
  </script>
  
    <div class="footer-content">
       <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
    </div>
  
  
    <div class="statistics">
  
  

  
    
      <span id="busuanzi_container_site_pv" style="display: none">
        æ€»è®¿é—®é‡ 
        <span id="busuanzi_value_site_pv"></span>
         æ¬¡
      </span>
    
    
      <span id="busuanzi_container_site_uv" style="display: none">
        æ€»è®¿å®¢æ•° 
        <span id="busuanzi_value_site_uv"></span>
         äºº
      </span>
    
    
  
</div>

  
  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.0/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.18.2/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      headingSelector : CONFIG.toc.headingSelector || 'h1,h2,h3,h4,h5,h6',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      collapseDepth   : CONFIG.toc.collapseDepth || 0,
      scrollSmooth    : true,
      headingsOffset  : -boardTop
    });
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.10/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  
      <script>
        if (!window.MathJax) {
          window.MathJax = {
            tex    : {
              inlineMath: { '[+]': [['$', '$']] }
            },
            loader : {
              load: ['ui/lazy']
            },
            options: {
              renderActions: {
                insertedScript: [200, () => {
                  document.querySelectorAll('mjx-container').forEach(node => {
                    let target = node.parentNode;
                    if (target.nodeName.toLowerCase() === 'li') {
                      target.parentNode.classList.add('has-jax');
                    }
                  });
                }, '', false]
              }
            }
          };
        } else {
          MathJax.startup.document.state(0);
          MathJax.texReset();
          MathJax.typeset();
          MathJax.typesetPromise();
        }
      </script>
    

  <script  src="https://lib.baomitu.com/mathjax/3.2.1/es5/tex-mml-chtml.js" ></script>

  <script  src="/js/local-search.js" ></script>

  <script defer src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" ></script>





<!-- ä¸»é¢˜çš„å¯åŠ¨é¡¹ï¼Œå°†å®ƒä¿æŒåœ¨æœ€åº•éƒ¨ -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">åšå®¢åœ¨å…è®¸ JavaScript è¿è¡Œçš„ç¯å¢ƒä¸‹æµè§ˆæ•ˆæœæ›´ä½³</div>
  </noscript>
</body>
</html>
