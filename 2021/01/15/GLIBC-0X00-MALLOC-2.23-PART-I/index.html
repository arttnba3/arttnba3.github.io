

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/avatar.png">
  <link rel="icon" href="/img/avatar.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
    <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="arttnba3">
  <meta name="keywords" content="">
  
    <meta name="description" content="è®©æˆ‘ä»¬å…ˆä»æœ€ç®€å•çš„chunkè®²èµ·â€¦">
<meta property="og:type" content="article">
<meta property="og:title" content="ã€GLIBC.0x00ã€‘glibc2.23 mallocæºç åˆ†æ - Iï¼šå †å†…å­˜çš„åŸºæœ¬ç»„ç»‡å½¢å¼">
<meta property="og:url" content="https://arttnba3.github.io/2021/01/15/GLIBC-0X00-MALLOC-2.23-PART-I/index.html">
<meta property="og:site_name" content="arttnba3&#39;s blog">
<meta property="og:description" content="è®©æˆ‘ä»¬å…ˆä»æœ€ç®€å•çš„chunkè®²èµ·â€¦">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://i.loli.net/2020/12/18/MAmvtL1zrpo9sFV.png">
<meta property="article:published_time" content="2021-01-15T08:17:03.000Z">
<meta property="article:modified_time" content="2023-10-27T00:41:20.000Z">
<meta property="article:author" content="arttnba3">
<meta property="article:tag" content="å †">
<meta property="article:tag" content="ptmalloc">
<meta property="article:tag" content="glibc">
<meta property="article:tag" content="å†…å­˜ç®¡ç†">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://i.loli.net/2020/12/18/MAmvtL1zrpo9sFV.png">
  
  
    <meta name="referrer" content="no-referrer-when-downgrade">
  
  
  <title>ã€GLIBC.0x00ã€‘glibc2.23 mallocæºç åˆ†æ - Iï¼šå †å†…å­˜çš„åŸºæœ¬ç»„ç»‡å½¢å¼ - arttnba3&#39;s blog</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- ä¸»é¢˜ä¾èµ–çš„å›¾æ ‡åº“ï¼Œä¸è¦è‡ªè¡Œä¿®æ”¹ -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  




  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"arttnba3.github.io","root":"/","version":"1.9.2","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":"Â§"},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":false,"follow_dnt":true,"baidu":null,"google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false}},"search_path":"/local-search.xml"};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  


  
<meta name="generator" content="Hexo 7.1.1"><link rel="alternate" href="/atom.xml" title="arttnba3's blog" type="application/atom+xml">
</head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 80vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>arttnba3&#39;s blog</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                é¦–é¡µ
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                å½’æ¡£
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                åˆ†ç±»
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                æ ‡ç­¾
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                å…³äº
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/links/">
                <i class="iconfont icon-link-fill"></i>
                å‹é“¾
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/atom.xml">
                <i class="iconfont icon-rss"></i>
                rss
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              &nbsp;<i class="iconfont icon-search"></i>&nbsp;
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">&nbsp;<i
                class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('https://i.loli.net/2020/12/23/PNIcnpb1YJovmai.png') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="ã€GLIBC.0x00ã€‘glibc2.23 mallocæºç åˆ†æ - Iï¼šå †å†…å­˜çš„åŸºæœ¬ç»„ç»‡å½¢å¼"></span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2021-01-15 19:17" pubdate>
          2021å¹´1æœˆ15æ—¥ æ™šä¸Š
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          58k å­—
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          486 åˆ†é’Ÿ
        
      </span>
    

    
    
      
        <span id="busuanzi_container_page_pv" style="display: none">
          <i class="iconfont icon-eye" aria-hidden="true"></i>
          <span id="busuanzi_value_page_pv"></span> æ¬¡
        </span>
        
      
    
  </div>


        
      </div>

      
        <div class="scroll-down-bar">
          <i class="iconfont icon-arrowdown"></i>
        </div>
      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">ã€GLIBC.0x00ã€‘glibc2.23 mallocæºç åˆ†æ - Iï¼šå †å†…å­˜çš„åŸºæœ¬ç»„ç»‡å½¢å¼</h1>
            
              <p class="note note-info">
                
                  
                    æœ¬æ–‡æœ€åæ›´æ–°äºï¼š2023å¹´10æœˆ27æ—¥ ä¸­åˆ
                  
                
              </p>
            
            
              <div class="markdown-body">
                
                <p>è®©æˆ‘ä»¬å…ˆä»æœ€ç®€å•çš„chunkè®²èµ·â€¦</p>
<span id="more"></span>

<h1 id="0x00-å †å†…å­˜çš„ç»„ç»‡å½¢å¼"><a href="#0x00-å †å†…å­˜çš„ç»„ç»‡å½¢å¼" class="headerlink" title="0x00.å †å†…å­˜çš„ç»„ç»‡å½¢å¼"></a>0x00.å †å†…å­˜çš„ç»„ç»‡å½¢å¼</h1><h2 id="ä¸€ã€malloc-chunk"><a href="#ä¸€ã€malloc-chunk" class="headerlink" title="ä¸€ã€malloc_chunk"></a>ä¸€ã€malloc_chunk</h2><p>æ€æ¥æƒ³å»è¿˜æ˜¯å…ˆä»æœ€ç®€å•çš„å †å—çš„åŸºæœ¬ç»„ç»‡å½¢å¼â€”â€”malloc_chunkç»“æ„ä½“å¼€å§‹è®²èµ·ï¼ŒåŒæ—¶ä¹Ÿäº‹å…ˆè®²å®Œä¸€äº›é€šç”¨å®å®šä¹‰ï¼Œ<del>çœå¾—åé¢å†ä¸æ–­çš„é€’å½’å¥—å¨ƒå›æ¥çœ‹chunkç›¸å…³çš„å„ç§å®šä¹‰</del>ï¼ˆ<del>â†å› ä¸ºè¿™ä¸ªäººçœŸçš„é‡åˆ°äº†è¿™æ ·çš„æƒ…å†µ</del>ï¼‰</p>
<p>é€šå¸¸æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å°†å‘ç³»ç»Ÿæ‰€ç”³è¯·å¾—åˆ°çš„å†…å­˜å—ç§°ä¹‹ä¸ºchunkï¼Œåœ¨ptmallocçš„å†…éƒ¨ä½¿ç”¨malloc_chunkç»“æ„ä½“æ¥è¡¨ç¤ºï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">malloc_chunk</span> &#123;</span><br><br>  INTERNAL_SIZE_T      prev_size;  <span class="hljs-comment">/* Size of previous chunk (if free).  */</span><br>  INTERNAL_SIZE_T      size;       <span class="hljs-comment">/* Size in bytes, including overhead. */</span><br><br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">malloc_chunk</span>* <span class="hljs-title">fd</span>;</span>         <span class="hljs-comment">/* double links -- used only if free. */</span><br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">malloc_chunk</span>* <span class="hljs-title">bk</span>;</span><br><br>  <span class="hljs-comment">/* Only used for large blocks: pointer to next larger size.  */</span><br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">malloc_chunk</span>* <span class="hljs-title">fd_nextsize</span>;</span> <span class="hljs-comment">/* double links -- used only if free. */</span><br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">malloc_chunk</span>* <span class="hljs-title">bk_nextsize</span>;</span><br>&#125;;<br></code></pre></td></tr></table></figure>

<p>é¦–å…ˆæˆ‘ä»¬å…ˆçœ‹ä¸€äº›ç›¸å…³çš„å®å®šä¹‰ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> INTERNAL_SIZE_T</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> INTERNAL_SIZE_T size_t</span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br><span class="hljs-comment">/* The corresponding word size */</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> SIZE_SZ                (sizeof(INTERNAL_SIZE_T))</span><br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment">  MALLOC_ALIGNMENT is the minimum alignment for malloc&#x27;ed chunks.</span><br><span class="hljs-comment">  It must be a power of two at least 2 * SIZE_SZ, even on machines</span><br><span class="hljs-comment">  for which smaller alignments would suffice. It may be defined as</span><br><span class="hljs-comment">  larger than this though. Note however that code and data structures</span><br><span class="hljs-comment">  are optimized for the case of 8-byte alignment.</span><br><span class="hljs-comment">*/</span><br><br><br><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> MALLOC_ALIGNMENT</span><br><span class="hljs-meta"># <span class="hljs-keyword">if</span> !SHLIB_COMPAT (libc, GLIBC_2_0, GLIBC_2_16)</span><br><span class="hljs-comment">/* This is the correct definition when there is no past ABI to constrain it.</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">   Among configurations with a past ABI constraint, it differs from</span><br><span class="hljs-comment">   2*SIZE_SZ only on powerpc32.  For the time being, changing this is</span><br><span class="hljs-comment">   causing more compatibility problems due to malloc_get_state and</span><br><span class="hljs-comment">   malloc_set_state than will returning blocks not adequately aligned for</span><br><span class="hljs-comment">   long double objects under -mlong-double-128.  */</span><br><br><span class="hljs-meta">#  <span class="hljs-keyword">define</span> MALLOC_ALIGNMENT       (2 *SIZE_SZ &lt; __alignof__ (long double)      \</span><br><span class="hljs-meta">                                  ? __alignof__ (long double) : 2 *SIZE_SZ)</span><br><span class="hljs-meta"># <span class="hljs-keyword">else</span></span><br><span class="hljs-meta">#  <span class="hljs-keyword">define</span> MALLOC_ALIGNMENT       (2 *SIZE_SZ)</span><br><span class="hljs-meta"># <span class="hljs-keyword">endif</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br><span class="hljs-comment">/* The corresponding bit mask value */</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MALLOC_ALIGN_MASK      (MALLOC_ALIGNMENT - 1)</span><br></code></pre></td></tr></table></figure>

<p>å¤§è‡´å¦‚ä¸‹ï¼š</p>
<ul>
<li><strong>INTERNAL_SIZE_T</strong>å®å±•å¼€å<strong>å…¶å®å°±æ˜¯size_tï¼Œ32ä½ä¸‹ä¸º4å­—èŠ‚ï¼Œ64ä½ä¸‹ä¸º8å­—èŠ‚</strong>ï¼Œ<strong>SIZE_SZä¸ºå…¶åˆ«å</strong></li>
<li><strong>MALLOC_ALIGNMENT</strong>åˆ™å®šä¹‰äº†chunkåœ¨å†…å­˜ä¸­å¯¹é½çš„å­—èŠ‚æ•°ï¼Œä¸€èˆ¬æ¥è¯´ç®—å‡ºæ¥éƒ½æ˜¯<strong>å¯¹2*SIZE_SZå¯¹é½</strong>ï¼Œå³<strong>32ä½ä¸‹8å­—èŠ‚å¯¹é½ï¼Œ64ä½ä¸‹16å­—èŠ‚å¯¹é½</strong></li>
<li><strong>MALLOC_ALIGEN_MASK</strong>çš„å€¼åˆ™æ˜¯MALLOC_ALIGENMENT - 1ï¼Œç¬”è€…çŒœæµ‹å…¶è¡¨ç¤ºçš„æ˜¯<strong>æ ‡å¿—ä½å…¨æ»¡çš„æ ‡å¿—ä½å€¼</strong>ï¼ˆ<strong>æ©ç </strong>ï¼‰<strong>ï¼Œç”¨ä»¥è¿›è¡Œåç»­çš„æ ‡å¿—ä½æ¸…é™¤è¿ç®—ç­‰æ“ä½œ</strong></li>
</ul>
<blockquote>
<h3 id="The-alignof-operator"><a href="#The-alignof-operator" class="headerlink" title="The __alignof__ operator"></a><a target="_blank" rel="noopener" href="https://www.ibm.com/support/knowledgecenter/ssw_ibm_i_71/rzarg/sc09785202.htm?view=kc#ToC_180">The __alignof__ operator</a></h3><p>The __alignof__ operator is a language extension to C99 and Standard C++ that returns the number of bytes used in the alignment of its operand. The operand can be an expression or a parenthesized type identifier. If the operand is an expression representing an lvalue, the number returned by <strong>alignof</strong> represents the alignment that the lvalue is known to have. The type of the expression is determined at compile time, but the expression itself is not evaluated. If the operand is a type, the number represents the alignment usually required for the type on the target platform.</p>
<p>(from IBM Knowledge Center)</p>
<p>å¤§æ„æ˜¯è¯´__alignof__è¿ç®—ç¬¦æ˜¯å¯¹C99åŠæ ‡å‡†C++çš„æ‹“å±•ï¼Œç”¨ä»¥è¿”å›è¿ç®—å¯¹è±¡æ‰€å ç”¨ç©ºé—´çš„å­—èŠ‚æ•°</p>
</blockquote>
<p>ç»“æ„ä½“ä¸­ä¸€å…±æœ‰å…­ä¸ªå˜é‡ï¼Œå¤§è‡´å¦‚ä¸‹ï¼š</p>
<ul>
<li><strong>prev_size</strong>:ç”¨ä»¥ä¿å­˜å‰ä¸€ä¸ªå†…å­˜ç‰©ç†åœ°å€ç›¸é‚»çš„chunkçš„sizeï¼Œ<strong>ä»…åœ¨è¯¥chunkä¸ºfreeçŠ¶æ€æ—¶ä¼šè¢«ä½¿ç”¨åˆ°</strong></li>
<li><strong>size</strong>ï¼šé¡¾åæ€ä¹‰ï¼Œç”¨ä»¥ä¿å­˜è¿™ä¸ªchunkçš„<strong>æ€»çš„å¤§å°ï¼Œå³åŒæ—¶åŒ…å«chunkå¤´</strong>ï¼ˆ<strong>prev_size + size</strong>ï¼‰<strong>å’Œchunkå‰©ä½™éƒ¨åˆ†çš„å¤§å°</strong></li>
<li><strong>fd</strong>&amp;&amp;<strong>bk</strong>ï¼š<strong>ä»…åœ¨åœ¨chunkè¢«freeåä½¿ç”¨</strong>ï¼Œç”¨ä»¥è¿æ¥å…¶ä»–çš„chunkï¼Œ<strong>ä¹Ÿå°±æ˜¯è¯´å½“chunkå¤„äºè¢«ä½¿ç”¨çš„çŠ¶æ€æ—¶è¯¥å­—æ®µæ— æ•ˆï¼Œè¢«ç”¨ä»¥å­˜å‚¨ç”¨æˆ·çš„æ•°æ®</strong></li>
<li><strong>fd_nextsize</strong>&amp;&amp;<strong>bk_nextsize</strong>ï¼šä»…åœ¨åœ¨chunkè¢«freeåä½¿ç”¨ï¼Œç”¨ä»¥è¿æ¥å…¶ä»–çš„chunk</li>
</ul>
<p>åé¢æˆ‘ä»¬è¿˜ä¼šå†è¯¦ç»†è®²è§£è¿™å‡ ä¸ªå˜é‡çš„ç›¸å…³å†…å®¹ï¼Œè¿™é‡Œä»…ä½œä¸€ç®€è§ˆ</p>
<p>ç”±äºæœ€åçš„ä¸¤ä¸ªå˜é‡ä»…ç”¨äºè¾ƒå¤§çš„freeçš„chunkï¼Œæ•…æˆ‘ä»¬å…ˆæš‚ä¸”å¿½ç•¥</p>
<p>é‚£ä¹ˆæˆ‘ä»¬ä¾¿å¯ä»¥çŸ¥é“ï¼š<strong>ä¸€ä¸ªchunkåœ¨å†…å­˜ä¸­å¤§æ¦‚æ˜¯é•¿è¿™ä¸ªæ ·å­çš„</strong>ï¼š</p>
<p><img src="https://i.loli.net/2020/12/18/qLi36sem4wYZMEo.png" srcset="/img/loading.gif" lazyload alt="44FB88C98453823956FB22B5B8C8C113.png"></p>
<p>å½“ç„¶ï¼Œæˆ‘ä¸ªäººæ›´å–œæ¬¢ç”¨å¦‚ä¸‹çš„ç»“æ„æ¥è¡¨ç¤ºï¼Œ<del>é—®å°±æ˜¯ğŸ‘´å–œæ¬¢å’ŒMALLOC_ALIGNMENTå¯¹é½çš„æ„Ÿè§‰</del></p>
<p><img src="https://i.loli.net/2020/12/18/MAmvtL1zrpo9sFV.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<h2 id="äºŒã€chunkç›¸å…³å®"><a href="#äºŒã€chunkç›¸å…³å®" class="headerlink" title="äºŒã€chunkç›¸å…³å®"></a>äºŒã€chunkç›¸å…³å®</h2><p>malloc.cä¸­è¿˜å®šä¹‰äº†ä¸€äº›å’Œmalloc_chunkç›¸å…³çš„å®ï¼Œå¦‚ä¸‹ï¼š</p>
<h3 id="1-chunk-sizeç›¸å…³å®"><a href="#1-chunk-sizeç›¸å…³å®" class="headerlink" title="1.chunk sizeç›¸å…³å®"></a>1.chunk sizeç›¸å…³å®</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/*</span><br><span class="hljs-comment">  ---------- Size and alignment checks and conversions ----------</span><br><span class="hljs-comment">*/</span><br><br><span class="hljs-comment">/* conversion from malloc headers to user pointers, and back */</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> chunk2mem(p)   ((void*)((char*)(p) + 2*SIZE_SZ))</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> mem2chunk(mem) ((mchunkptr)((char*)(mem) - 2*SIZE_SZ))</span><br><br><span class="hljs-comment">/* The smallest possible chunk */</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MIN_CHUNK_SIZE        (offsetof(struct malloc_chunk, fd_nextsize))</span><br><br><span class="hljs-comment">/* The smallest size we can malloc is an aligned minimal chunk */</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MINSIZE  \</span><br><span class="hljs-meta">  (unsigned long)(((MIN_CHUNK_SIZE+MALLOC_ALIGN_MASK) &amp; ~MALLOC_ALIGN_MASK))</span><br><br><span class="hljs-comment">/* Check if m has acceptable alignment */</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> aligned_OK(m)  (((unsigned long)(m) &amp; MALLOC_ALIGN_MASK) == 0)</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> misaligned_chunk(p) \</span><br><span class="hljs-meta">  ((uintptr_t)(MALLOC_ALIGNMENT == 2 * SIZE_SZ ? (p) : chunk2mem (p)) \</span><br><span class="hljs-meta">   &amp; MALLOC_ALIGN_MASK)</span><br></code></pre></td></tr></table></figure>

<p>å¤§è‡´å¦‚ä¸‹ï¼š</p>
<ul>
<li><strong>chunk2mem</strong>ï¼šå°†æŒ‡å‘chunkçš„æŒ‡é’ˆè½¬ä¸ºæŒ‡å‘memoryçš„æŒ‡é’ˆï¼Œ<strong>å³æŒ‡é’ˆç”±æŒ‡å‘chunk header</strong>ï¼ˆåˆšå¥½æ˜¯prev_sizeçš„ä½ç½®ï¼‰<strong>ç§»åŠ¨åˆ°æŒ‡å‘fd</strong></li>
<li><strong>mem2chunk</strong>ï¼šå°†æŒ‡å‘memoryçš„æŒ‡é’ˆè½¬æ¢ä¸ºæŒ‡å‘chunkçš„æŒ‡é’ˆï¼Œ<strong>å³æŒ‡é’ˆç”±æŒ‡å‘fdç§»åŠ¨åˆ°æŒ‡å‘chunk header</strong>ï¼Œä¸chunk2memäº’ä¸ºé€†æ“ä½œ</li>
<li><strong>MIN_CHUNK_SIZE</strong>ï¼šæ‰€å¯åˆ†é…çš„æœ€å°çš„chunkçš„sizeï¼Œä¸º<strong>ç”±prev_sizeåˆ°fd_nextsizeçš„åç§»é‡ï¼Œ32ä½ä¸‹æ˜¯0x10ï¼Œ64ä½ä¸‹æ˜¯0x20ï¼Œå³ä¸€ä¸ªæœ€å°çš„chunkåº”å½“åŒ…å«æœ‰chunk headerå’Œfdã€bk</strong></li>
<li><strong>MINSIZE</strong>ï¼šæ‰€èƒ½åˆ†é…çš„æœ€å°chunkçš„sizeï¼›æˆ‘ä»¬æ‰€èƒ½åˆ†é…çš„æœ€å°çš„sizeçš„chunkåº”å½“ä¸º<strong>ä¸€ä¸ªå†…å­˜å¯¹å…¶çš„æœ€å°çš„chunk</strong>ï¼Œè¿™é‡Œ<strong>ç®—å‡ºæ¥å…¶å®å°±æ˜¯MIN_CHUNK_SIZE</strong>ï¼ŒMIN_CHUNK_SIZEåŠ ä¸ŠMALLOC_ALIGN_MASKä»¥åå†å’Œåšäº†å–åæ“ä½œçš„MALLOC_ALIGN_MASKåšä¸è¿ç®—çŒœæµ‹å®é™…ä¸Šæ˜¯ä¸ºäº†æ¶ˆé™¤æ‰æ ‡å¿—ä½</li>
<li><strong>aligned_OK</strong>ï¼šè¯¥å®ç”¨ä»¥æ£€æŸ¥<strong>æ˜¯å¦ä¸MALLOC_ALIGNMENTå¯¹é½</strong>ï¼Œå› ä¸º<strong>è‹¥æ˜¯ä¸MALLOC_ALIGNMENTä¸å¯¹å…¶çš„è¯ï¼Œå…¶ä¸MALLOC_ALIGN_MASKè¿›è¡Œä¸è¿ç®—çš„ç»“æœå¿…ç„¶ä¸ä¸º0</strong>ï¼ˆè¿™é‡Œåº”è¯¥å°±ä¸éœ€è¦æˆ‘å†è¯´æ˜ä¸ºä»€ä¹ˆäº†â€¦ï¼‰</li>
<li><strong>misaligned_chunk</strong>ï¼šè¯¥å®ç”¨ä»¥æ£€æµ‹<strong>ä¸€ä¸ªchunkæ˜¯å¦ä¸ºæœªå¯¹é½çš„chunk</strong>ï¼Œè‹¥æ˜¯åˆ™<strong>è¿”å›æœªå¯¹é½çš„å­—èŠ‚æ•°</strong></li>
</ul>
<p>ç®€å•çš„å›¾ç¤ºå¦‚ä¸‹ï¼š</p>
<p><img src="https://i.loli.net/2020/12/19/ZSDand7AebOoqB3.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<blockquote>
<h4 id="å®ï¼šoffsetof"><a href="#å®ï¼šoffsetof" class="headerlink" title="å®ï¼šoffsetof"></a>å®ï¼šoffsetof</h4><p>ä¹Ÿæ˜¯ä¸€ä¸ªåœ¨å¾ˆå¤šæ–‡ä»¶ä¸­éƒ½æœ‰ç€å®šä¹‰çš„ä¸€ä¸ªå®ï¼Œå¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/* Some compilers, like SunOS4 cc, don&#x27;t have offsetof in &lt;stddef.h&gt;.  */</span><br><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> offsetof</span><br><span class="hljs-meta"># <span class="hljs-keyword">define</span> offsetof(type,ident) ((size_t)&amp;(((type*)0)-&gt;ident))</span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br></code></pre></td></tr></table></figure>

<p>è¯¥å®çš„ä½œç”¨æ˜¯æ±‚å‡ºæŸä¸ªç±»å‹ä¸­æŸä¸ªæˆå‘˜çš„åç§»ï¼Œå¤§è‡´è¿‡ç¨‹å¦‚ä¸‹ï¼š</p>
<ul>
<li>å°†0è½¬æ¢ä¸ºæŒ‡å‘æŸä¸ªç±»å‹çš„æŒ‡é’ˆ</li>
<li>å–åœ°å€ç¬¦å–å‡º0-&gt;identçš„åœ°å€</li>
<li>è½¬æ¢æˆsize_tç±»å‹</li>
</ul>
<p>ç”±äºæ˜¯ä»¥0ä½œä¸ºåœ°å€åŸºåº•æ¥å–åœ°å€çš„ï¼Œå› æ­¤ä¾¿å¯ä»¥å¾ˆæ–¹ä¾¿åœ°è®¡ç®—å‡ºæŸä¸ªæˆå‘˜çš„åç§»</p>
</blockquote>
<h3 id="2-memory-requestç›¸å…³å®"><a href="#2-memory-requestç›¸å…³å®" class="headerlink" title="2.memory requestç›¸å…³å®"></a>2.memory requestç›¸å…³å®</h3><p>æ¥ä¸‹æ¥è¿™äº›å®ç”¨ä»¥å¯¹è¯·æ±‚çš„å †å—å¤§å°è¿›è¡Œæ£€æŸ¥ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/*</span><br><span class="hljs-comment">   Check if a request is so large that it would wrap around zero when</span><br><span class="hljs-comment">   padded and aligned. To simplify some other code, the bound is made</span><br><span class="hljs-comment">   low enough so that adding MINSIZE will also not wrap around zero.</span><br><span class="hljs-comment"> */</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> REQUEST_OUT_OF_RANGE(req)                                 \</span><br><span class="hljs-meta">  ((unsigned long) (req) &gt;=						      \</span><br><span class="hljs-meta">   (unsigned long) (INTERNAL_SIZE_T) (-2 * MINSIZE))</span><br><br><span class="hljs-comment">/* pad request bytes into a usable size -- internal version */</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> request2size(req)                                         \</span><br><span class="hljs-meta">  (((req) + SIZE_SZ + MALLOC_ALIGN_MASK &lt; MINSIZE)  ?             \</span><br><span class="hljs-meta">   MINSIZE :                                                      \</span><br><span class="hljs-meta">   ((req) + SIZE_SZ + MALLOC_ALIGN_MASK) &amp; ~MALLOC_ALIGN_MASK)</span><br><br><span class="hljs-comment">/*  Same, except also perform argument check */</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> checked_request2size(req, sz)                             \</span><br><span class="hljs-meta">  <span class="hljs-keyword">if</span> (REQUEST_OUT_OF_RANGE (req)) &#123;					      \</span><br><span class="hljs-meta">      __set_errno (ENOMEM);						      \</span><br><span class="hljs-meta">      return 0;								      \</span><br><span class="hljs-meta">    &#125;									      \</span><br><span class="hljs-meta">  (sz) = request2size (req);</span><br></code></pre></td></tr></table></figure>

<p>å¤§è‡´å¦‚ä¸‹ï¼š</p>
<ul>
<li><strong>REQUEST_OUT_OF_RANGE</strong>ï¼šå®å¦‚å…¶åï¼Œç”¨ä»¥<strong>æ£€æŸ¥ç”¨æˆ·è¯·æ±‚çš„å†…å­˜å¤§å°æ˜¯å¦å¤§äºè§„å®šçš„æœ€å¤§å†…å­˜å¤§å°</strong>ï¼Œè¿™ä¸ªå€¼è¢«å®šä¹‰ä¸º4å­—èŠ‚æ•´å‹èƒ½è¡¨ç¤ºçš„æœ€å¤§å€¼å†å‡å»ä¸¤ä¸ªæœ€å°chunkçš„sizeæ‰€æ±‚å¾—çš„å€¼ï¼Œä¸ºçš„æ˜¯é¿å…å½“æœ‰äººçœŸçš„å°è¯•å»åˆ†é…äº†è¿™æ ·çš„ä¸€ä¸ªå¤§chunkæ—¶mallocå†…éƒ¨å°†è¿™ä¸ªå€¼åŠ ä¸ŠMINSIZEåä¼šå‘ç”Ÿæ•´å‹ä¸Šæº¢è€Œå˜æˆ0é™„è¿‘çš„ä¸€ä¸ªè¾ƒå°çš„å€¼</li>
<li><strong>request2size</strong>ï¼šä½œç”¨æ˜¯<strong>å°†ç”¨æˆ·è¯·æ±‚çš„å†…å­˜å¤§å°è½¬æ¢ä¸ºå†…å­˜å¯¹é½çš„å¤§å°ï¼Œè¿™ä¸ªè½¬æ¢åçš„å¤§å°ä¾¿æ˜¯å®é™…åˆ†é…ç»™ç”¨æˆ·çš„chunkçš„size</strong>ï¼›è‹¥æ˜¯è¯·æ±‚çš„å†…å­˜å¤§å°<strong>å°äºMINSIZEå¾—åˆ°çš„sizeç›´æ¥ä¸ºMINSIZE</strong>ï¼Œ<strong>å¦åˆ™åˆ™ä¼šå¾—åˆ°ä¸€ä¸ªä¸MALLOC_ALIGNMENTå¯¹é½çš„chunk size</strong></li>
<li><strong>checked_request2size</strong>ï¼šå¯ä»¥ç†è§£ä¸º<strong>request2sizeå®å°è£…ä¸Šäº†sizeæ£€æŸ¥çš„å®</strong>ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯è‹¥æ˜¯REQUEST_OUT_OF_RANGEåˆ™è¯¥å®åˆ™ä¼šåœ¨è®¾ç½®errnoæ ‡å¿—ä½ä¸ºENOMEMåç›´æ¥return 0ï¼Œç»ˆæ­¢å…¶è°ƒç”¨å‡½æ•°çš„æ‰§è¡Œ</li>
</ul>
<blockquote>
<h4 id="å…³äºchunké—´çš„å†…å­˜å¤ç”¨åŠrequest2sizeè®¡ç®—ç›¸å…³äº‹é¡¹"><a href="#å…³äºchunké—´çš„å†…å­˜å¤ç”¨åŠrequest2sizeè®¡ç®—ç›¸å…³äº‹é¡¹" class="headerlink" title="å…³äºchunké—´çš„å†…å­˜å¤ç”¨åŠrequest2sizeè®¡ç®—ç›¸å…³äº‹é¡¹"></a>å…³äºchunké—´çš„å†…å­˜å¤ç”¨åŠrequest2sizeè®¡ç®—ç›¸å…³äº‹é¡¹</h4><p><del>ä¼—æ‰€å‘¨çŸ¥Â·</del>ï¼Œptmallocåœ¨ç»„ç»‡å„chunkæ—¶å…è®¸ä¸€ä¸ªchunkå¤ç”¨å…¶ç‰©ç†ç›¸é‚»çš„ä¸‹ä¸€ä¸ªchunkçš„prev_sizeå­—æ®µä½œä¸ºè‡ªå·±çš„å‚¨å­˜ç©ºé—´ï¼Œè¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆå½“<strong>ä¸€ä¸ªchunkçš„ç‰©ç†ç›¸é‚»çš„å‰ä¸€ä¸ªchunkå¤„åœ¨è¢«åˆ†é…çŠ¶æ€æ—¶è¯¥chunkçš„prev_sizeå­—æ®µæ— æ•ˆ</strong>çš„åŸå› ï¼Œå¤§è‡´å›¾ç¤ºå¦‚ä¸‹ï¼š</p>
<p><img src="https://i.loli.net/2020/12/19/HZfcpy4wkJGg9V3.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p>å› æ­¤ï¼ŒåŸºäºè¿™æ ·çš„ä¸€ç§ç©ºé—´å¤ç”¨çš„æ€æƒ³ï¼Œrequest2sizeå®è®¡ç®—å‡ºæ¥çš„sizeä¾¿å¦‚å›¾å³ä¾§æ‰€ç¤ºäº†</p>
</blockquote>
<h3 id="3-chunkæ ‡å¿—ä½ç›¸å…³å®"><a href="#3-chunkæ ‡å¿—ä½ç›¸å…³å®" class="headerlink" title="3.chunkæ ‡å¿—ä½ç›¸å…³å®"></a>3.chunkæ ‡å¿—ä½ç›¸å…³å®</h3><h4 id="â‘ æ ‡å¿—ä½å®šä¹‰åŠç›¸å…³å®"><a href="#â‘ æ ‡å¿—ä½å®šä¹‰åŠç›¸å…³å®" class="headerlink" title="â‘ æ ‡å¿—ä½å®šä¹‰åŠç›¸å…³å®"></a>â‘ æ ‡å¿—ä½å®šä¹‰åŠç›¸å…³å®</h4><p>æˆ‘ä»¬çŸ¥é“å¯¹äºä¸€ä¸ªmalloc_chunkè€Œè¨€å…¶sizeå­—æ®µåº”å½“ä¸MALLOC_ALIGNMENTå¯¹é½ï¼Œè€Œåœ¨è¿™æ ·çš„æƒ…å†µä¸‹ä¸€ä¸ªchunkçš„sizeå­—æ®µçš„ä½3&#x2F;4ï¼ˆ32&#x2F;64ä½ç³»ç»Ÿï¼‰ä½å°†ä¼šæ°¸è¿œä¸º0ï¼Œæ— æ³•å¾—åˆ°å……åˆ†çš„åˆ©ç”¨ï¼Œå› æ­¤<del>å‡ºäºèƒ½å‹æ¦¨ä¸€ç‚¹ç©ºé—´æ˜¯ä¸€ç‚¹ç©ºé—´çš„æ€æƒ³</del>ä¸€ä¸ªchunkçš„sizeå­—æ®µçš„ä½ä¸‰ä½ç”¨ä»¥ä¿å­˜ç›¸å…³çš„ä¸‰ä¸ªçŠ¶æ€ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/*</span><br><span class="hljs-comment">   --------------- Physical chunk operations ---------------</span><br><span class="hljs-comment"> */</span><br><br><br><span class="hljs-comment">/* size field is or&#x27;ed with PREV_INUSE when previous adjacent chunk in use */</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PREV_INUSE 0x1</span><br><br><span class="hljs-comment">/* extract inuse bit of previous chunk */</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> prev_inuse(p)       ((p)-&gt;size &amp; PREV_INUSE)</span><br><br><br><span class="hljs-comment">/* size field is or&#x27;ed with IS_MMAPPED if the chunk was obtained with mmap() */</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> IS_MMAPPED 0x2</span><br><br><span class="hljs-comment">/* check for mmap()&#x27;ed chunk */</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> chunk_is_mmapped(p) ((p)-&gt;size &amp; IS_MMAPPED)</span><br><br><br><span class="hljs-comment">/* size field is or&#x27;ed with NON_MAIN_ARENA if the chunk was obtained</span><br><span class="hljs-comment">   from a non-main arena.  This is only set immediately before handing</span><br><span class="hljs-comment">   the chunk to the user, if necessary.  */</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> NON_MAIN_ARENA 0x4</span><br><br><span class="hljs-comment">/* check for chunk from non-main arena */</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> chunk_non_main_arena(p) ((p)-&gt;size &amp; NON_MAIN_ARENA)</span><br></code></pre></td></tr></table></figure>

<p>ä»ä½ä½åˆ°é«˜ä½ä¾æ¬¡å¦‚ä¸‹ï¼š</p>
<ul>
<li><strong>PREV_IN_USE</strong>ï¼šè¯¥chunk<strong>å†…å­˜ç‰©ç†ç›¸é‚»çš„ä¸Šä¸€ä¸ªchunk</strong>æ˜¯å¦<strong>å¤„äºè¢«åˆ†é…çŠ¶æ€</strong></li>
<li><strong>IS_MAPPED</strong>ï¼šè¯¥chunkæ˜¯å¦æ˜¯<strong>ç”±mmap</strong>()<strong>è¿›è¡Œå†…å­˜åˆ†é…å¾—åˆ°çš„</strong></li>
<li><strong>NON_MAIN_ARENA</strong>ï¼šè¯¥chunkæ˜¯å¦æ˜¯ä¸€ä¸ª<strong>ä¸å±äºmain_arenaçš„chunk</strong></li>
</ul>
<p>å› è€Œæœ‰ä¸‰ä¸ªç”¨ä»¥æ£€æµ‹æ ‡å¿—ä½çš„å®ï¼š<code>prev_inuse()</code>ã€<code>chunk_is_mapped</code>ã€<code>chunk_non_main_arena()</code>ï¼Œè¿™é‡Œä¾¿ä¸å†è¿‡å¤šèµ˜å™äº†</p>
<h4 id="â‘¡æ ‡å¿—ä½æ“ä½œç›¸å…³å®åŠå…¶ä»–å®"><a href="#â‘¡æ ‡å¿—ä½æ“ä½œç›¸å…³å®åŠå…¶ä»–å®" class="headerlink" title="â‘¡æ ‡å¿—ä½æ“ä½œç›¸å…³å®åŠå…¶ä»–å®"></a>â‘¡æ ‡å¿—ä½æ“ä½œç›¸å…³å®åŠå…¶ä»–å®</h4><p>malloc.cä¸­è¿™äº›å®çš„ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/*</span><br><span class="hljs-comment">   Bits to mask off when extracting size</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">   Note: IS_MMAPPED is intentionally not masked off from size field in</span><br><span class="hljs-comment">   macros for which mmapped chunks should never be seen. This should</span><br><span class="hljs-comment">   cause helpful core dumps to occur if it is tried by accident by</span><br><span class="hljs-comment">   people extending or adapting this malloc.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> SIZE_BITS (PREV_INUSE | IS_MMAPPED | NON_MAIN_ARENA)</span><br><br><span class="hljs-comment">/* Get size, ignoring use bits */</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> chunksize(p)         ((p)-&gt;size &amp; ~(SIZE_BITS))</span><br><br><br><span class="hljs-comment">/* Ptr to next physical malloc_chunk. */</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> next_chunk(p) ((mchunkptr) (((char *) (p)) + ((p)-&gt;size &amp; ~SIZE_BITS)))</span><br><br><span class="hljs-comment">/* Ptr to previous physical malloc_chunk */</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> prev_chunk(p) ((mchunkptr) (((char *) (p)) - ((p)-&gt;prev_size)))</span><br><br><span class="hljs-comment">/* Treat space at ptr + offset as a chunk */</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> chunk_at_offset(p, s)  ((mchunkptr) (((char *) (p)) + (s)))</span><br><br><span class="hljs-comment">/* extract p&#x27;s inuse bit */</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> inuse(p)							      \</span><br><span class="hljs-meta">  ((((mchunkptr) (((char *) (p)) + ((p)-&gt;size &amp; ~SIZE_BITS)))-&gt;size) &amp; PREV_INUSE)</span><br><br><span class="hljs-comment">/* set/clear chunk as being inuse without otherwise disturbing */</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> set_inuse(p)							      \</span><br><span class="hljs-meta">  ((mchunkptr) (((char *) (p)) + ((p)-&gt;size &amp; ~SIZE_BITS)))-&gt;size |= PREV_INUSE</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> clear_inuse(p)							      \</span><br><span class="hljs-meta">  ((mchunkptr) (((char *) (p)) + ((p)-&gt;size &amp; ~SIZE_BITS)))-&gt;size &amp;= ~(PREV_INUSE)</span><br><br><br><span class="hljs-comment">/* check/set/clear inuse bits in known places */</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> inuse_bit_at_offset(p, s)					      \</span><br><span class="hljs-meta">  (((mchunkptr) (((char *) (p)) + (s)))-&gt;size &amp; PREV_INUSE)</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> set_inuse_bit_at_offset(p, s)					      \</span><br><span class="hljs-meta">  (((mchunkptr) (((char *) (p)) + (s)))-&gt;size |= PREV_INUSE)</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> clear_inuse_bit_at_offset(p, s)					      \</span><br><span class="hljs-meta">  (((mchunkptr) (((char *) (p)) + (s)))-&gt;size &amp;= ~(PREV_INUSE))</span><br><br><br><span class="hljs-comment">/* Set size at head, without disturbing its use bit */</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> set_head_size(p, s)  ((p)-&gt;size = (((p)-&gt;size &amp; SIZE_BITS) | (s)))</span><br><br><span class="hljs-comment">/* Set size/use field */</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> set_head(p, s)       ((p)-&gt;size = (s))</span><br><br><span class="hljs-comment">/* Set size at footer (only when chunk is not in use) */</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> set_foot(p, s)       (((mchunkptr) ((char *) (p) + (s)))-&gt;prev_size = (s))</span><br><br></code></pre></td></tr></table></figure>

<p>å¤§è‡´å¦‚ä¸‹ï¼š</p>
<ul>
<li><strong>SIZE_BITS</strong>ï¼šè¯¥å®ç”¨ä»¥è¡¨ç¤º<strong>ä¸‰ä¸ªæ ‡å¿—ä½å…¨ä¸º1</strong></li>
<li><strong>chunksize</strong> ()ï¼šè¯¥å®ç”¨ä»¥<strong>æ¸…é™¤sizeå­—æ®µçš„æ ‡å¿—ä½ï¼Œå¾—åˆ°åŸå§‹çš„chunk size</strong></li>
<li><strong>next_chunk</strong> ()ï¼šè¯¥å®ç”¨ä»¥<strong>è·å¾—æŒ‡å‘è¯¥chunkçš„ç‰©ç†ç›¸é‚»çš„ä¸‹ä¸€ä¸ªchunkçš„æŒ‡é’ˆ</strong></li>
<li><strong>prev_chunk</strong> ()ï¼šè¯¥å®ç”¨ä»¥<strong>è·å¾—æŒ‡å‘è¯¥chunkçš„ç‰©ç†ç›¸é‚»çš„ä¸Šä¸€ä¸ªchunkçš„æŒ‡é’ˆ</strong>ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯<strong>prev_sizeå­—æ®µå¿…é¡»æœ‰æ•ˆï¼Œå³ä¸Šä¸€ä¸ªchunkå¿…é¡»ä¸ºfreeçŠ¶æ€</strong></li>
<li><strong>chunk_at_offset</strong> ()ï¼šè¯¥å®ç”¨ä»¥<strong>å°†ptr + offsetä½ç½®ä½œä¸ºä¸€ä¸ªchunkæ¥å¯¹å¾…ï¼Œè·å¾—ä¸€ä¸ªæŒ‡å‘ptr + offsetä½ç½®çš„chunkæŒ‡é’ˆ</strong>ï¼ˆå¤§æ„æ˜¯å‡è®¾ptr + offsetä¸Šæœ‰ä¸€ä¸ªchunkï¼Œç„¶åæˆ‘ä»¬ç”¨è¿™ä¸ªå®å¾—åˆ°æŒ‡å‘è¿™ä¸ªchunkçš„chunkæŒ‡é’ˆï¼Œåé¢è®²åˆ°top_chunkæ—¶ä¼šç”¨åˆ°ï¼‰</li>
<li><strong>inuse()ã€set_inuse()ã€clear_inuse</strong> ()ï¼š<strong>æ£€æµ‹ã€è®¾ç½®ã€æ¸…é™¤chunkçš„PREV_INUSEæ ‡å¿—ä½</strong></li>
<li><strong>inuse_bit_at_offset()ã€set_inuse_bit_at_offset()ã€clear_inuse_bit_at_offset</strong> ()ï¼šå°†ptr + offsetä½ç½®è§†ä¸ºä¸€ä¸ªchunkå¹¶<strong>æ£€æµ‹ã€è®¾ç½®ã€æ¸…é™¤è¯¥chunkçš„PREV_INUSEæ ‡å¿—ä½</strong></li>
<li><strong>set_head_size</strong> ()ï¼šè¯¥å®ç”¨ä»¥<strong>åœ¨ä¸æ”¹å˜æ ‡å¿—ä½çš„æƒ…å†µä¸‹æ”¹å˜ä¸€ä¸ªchunkçš„sizeå­—æ®µ</strong></li>
<li><strong>set_size</strong> ()ï¼šè¯¥å®ç”¨ä»¥<strong>æ”¹å˜ä¸€ä¸ªchunkçš„sizeå­—æ®µ</strong>ï¼Œæ˜¯å‰è€…çš„ç®€åŒ–ç‰ˆæœ¬</li>
<li><strong>set_foot</strong> ()ï¼šè¯¥å®ç”¨ä»¥<strong>åœ¨å°†ptr + sè§†ä¸ºä¸€ä¸ªchunkçš„åœ°å€çš„æƒ…å†µä¸‹å°†è¿™ä¸ªchunkçš„prev_sizeå­—æ®µç½®ä¸ºs</strong></li>
</ul>
<h2 id="ä¸‰ã€Binsï¼šå­˜æ”¾é—²ç½®chunkçš„æ•°ç»„"><a href="#ä¸‰ã€Binsï¼šå­˜æ”¾é—²ç½®chunkçš„æ•°ç»„" class="headerlink" title="ä¸‰ã€Binsï¼šå­˜æ”¾é—²ç½®chunkçš„æ•°ç»„"></a>ä¸‰ã€Binsï¼šå­˜æ”¾é—²ç½®chunkçš„æ•°ç»„</h2><p>å¯¹äºé—²ç½®çš„chunkï¼Œptmallocä¼šæ ¹æ®sizeçš„ä¸åŒå°†ä¹‹å­˜æ”¾åˆ°ä¸åŒçš„binsä¸­è¿›è¡Œç»Ÿä¸€çš„è°ƒåº¦ï¼Œè€Œä¸ä¼šé©¬ä¸Šè¿”è¿˜ç»™ç³»ç»Ÿï¼Œè¿™æ ·ä¸€æ¥åœ¨ç”¨æˆ·å†æ¬¡è¿›è¡Œè¯·æ±‚æ—¶ï¼Œptmallocä¾¿å¯ä»binsä¸­æŒ‘é€‰å‡ºåˆé€‚çš„chunkç»™äºˆç”¨æˆ·ï¼Œè¿™æ ·ä¸€æ¥ä¾¿èƒ½å¤§å¹…åº¦åœ°å‡å°‘ç³»ç»Ÿè°ƒç”¨çš„æ¬¡æ•°åŠå…¶å¸¦æ¥çš„å·¨å¤§å¼€é”€</p>
<p>malloc.cä¸­å¯¹äºbinsçš„è¯´æ˜å¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/*</span><br><span class="hljs-comment">   Bins</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">    An array of bin headers for free chunks. Each bin is doubly</span><br><span class="hljs-comment">    linked.  The bins are approximately proportionally (log) spaced.</span><br><span class="hljs-comment">    There are a lot of these bins (128). This may look excessive, but</span><br><span class="hljs-comment">    works very well in practice.  Most bins hold sizes that are</span><br><span class="hljs-comment">    unusual as malloc request sizes, but are more usual for fragments</span><br><span class="hljs-comment">    and consolidated sets of chunks, which is what these bins hold, so</span><br><span class="hljs-comment">    they can be found quickly.  All procedures maintain the invariant</span><br><span class="hljs-comment">    that no consolidated chunk physically borders another one, so each</span><br><span class="hljs-comment">    chunk in a list is known to be preceeded and followed by either</span><br><span class="hljs-comment">    inuse chunks or the ends of memory.</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">    Chunks in bins are kept in size order, with ties going to the</span><br><span class="hljs-comment">    approximately least recently used chunk. Ordering isn&#x27;t needed</span><br><span class="hljs-comment">    for the small bins, which all contain the same-sized chunks, but</span><br><span class="hljs-comment">    facilitates best-fit allocation for larger chunks. These lists</span><br><span class="hljs-comment">    are just sequential. Keeping them in order almost never requires</span><br><span class="hljs-comment">    enough traversal to warrant using fancier ordered data</span><br><span class="hljs-comment">    structures.</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">    Chunks of the same size are linked with the most</span><br><span class="hljs-comment">    recently freed at the front, and allocations are taken from the</span><br><span class="hljs-comment">    back.  This results in LRU (FIFO) allocation order, which tends</span><br><span class="hljs-comment">    to give each chunk an equal opportunity to be consolidated with</span><br><span class="hljs-comment">    adjacent freed chunks, resulting in larger free chunks and less</span><br><span class="hljs-comment">    fragmentation.</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">    To simplify use in double-linked lists, each bin header acts</span><br><span class="hljs-comment">    as a malloc_chunk. This avoids special-casing for headers.</span><br><span class="hljs-comment">    But to conserve space and improve locality, we allocate</span><br><span class="hljs-comment">    only the fd/bk pointers of bins, and then use repositioning tricks</span><br><span class="hljs-comment">    to treat these as the fields of a malloc_chunk*.</span><br><span class="hljs-comment"> */</span><br><br><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">malloc_chunk</span> *<span class="hljs-title">mbinptr</span>;</span><br></code></pre></td></tr></table></figure>

<p>å¤§æ„æ˜¯è¯´binsæ˜¯ä¸€ä¸ªç”¨ä»¥å­˜æ”¾é—²ç½®çš„chunkçš„æ•°ç»„ï¼ŒchunkæŒ‰ç…§sizeæ¥å­˜æ”¾åœ¨ä¸åŒçš„ä¸‹æ ‡çš„binä¸­ï¼Œ<strong>æ¯ä¸ªbinä¸­çš„chunkéƒ½æ˜¯ä½¿ç”¨åŒå‘é“¾è¡¨è¿›è¡Œé“¾æ¥çš„</strong></p>
<p>ä¸€å…±æœ‰ç€128ä¸ªbinï¼Œå…¶ä¸­å¯¹äºsmall size chunkè€Œè¨€å…¶å­˜æ”¾äºå­˜æ”¾ç€ç›¸åŒsizeçš„chunkä¸­ï¼Œå› æ­¤å…¶æ¯ä¸ªbinå†…ä¹Ÿå°±ä¸éœ€è¦æ’åºï¼Œä½†è¿™ä¹Ÿæœ‰åŠ©äºæ›´å¤§çš„chunkè¾¾åˆ°æœ€ä½³çš„åˆ†é…æœºåˆ¶</p>
<p><strong>è¢«freeçš„chunkä¼šæ”¾ç½®äºåŒå‘é“¾è¡¨çš„å¤´éƒ¨ï¼Œè€Œåœ¨åˆ†é…chunkæ—¶åˆ™æ˜¯ä»é“¾è¡¨çš„å°¾éƒ¨å–chunk</strong>ï¼Œå³<strong>binä¸­çš„chunké“¾è¡¨é‡‡å–FIFOæœºåˆ¶</strong></p>
<p>ä¸ºäº†ç®€åŒ–åŒå‘é“¾è¡¨çš„ä½¿ç”¨ï¼Œæ¯ä¸€ä¸ªbin headeréƒ½è¢«å¦‚åŒmalloc_chunkä¸€èˆ¬ä½¿ç”¨ï¼ŒåŒæ—¶ä¸ºäº†èŠ‚çœç©ºé—´ï¼Œ<strong>åœ¨chunkä¸­ä»…ä¼šä½¿ç”¨FD&#x2F;BKå­—æ®µ</strong></p>
<p>åŒæ—¶è¿˜typedefäº†ä¸€ä¸ªmbinptrç±»å‹ï¼Œä¸ºæŒ‡å‘malloc_chunkç»“æ„ä½“çš„æŒ‡é’ˆ</p>
<p>åœ¨ptmallocä¸­<strong>binsæ•°ç»„ä¸­çš„binä¸€å…±å¯ä»¥åˆ’åˆ†ä¸ºä¸‰ç±»ï¼šunsorted binã€small binã€large bin</strong>ï¼Œå°†ä¼šåœ¨åé¢è¿›è¡Œè¯´æ˜</p>
<h3 id="1-binsé€šç”¨å®"><a href="#1-binsé€šç”¨å®" class="headerlink" title="1.binsé€šç”¨å®"></a>1.binsé€šç”¨å®</h3><p>malloc.cä¸­å®šä¹‰äº†ä¸€äº›å’Œbinsç›¸å…³çš„å®ï¼Œå¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/* addressing -- note that bin_at(0) does not exist */</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> bin_at(m, i) \</span><br><span class="hljs-meta">  (mbinptr) (((char *) &amp;((m)-&gt;bins[((i) - 1) * 2]))			      \</span><br><span class="hljs-meta">             - offsetof (struct malloc_chunk, fd))</span><br><br><span class="hljs-comment">/* analog of ++bin */</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> next_bin(b)  ((mbinptr) ((char *) (b) + (sizeof (mchunkptr) &lt;&lt; 1)))</span><br><br><span class="hljs-comment">/* Reminders about list directionality within bins */</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> first(b)     ((b)-&gt;fd)</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> last(b)      ((b)-&gt;bk)</span><br>...<br><span class="hljs-meta">#<span class="hljs-keyword">define</span> bin_index(sz) \</span><br><span class="hljs-meta">  ((in_smallbin_range (sz)) ? smallbin_index (sz) : largebin_index (sz))</span><br></code></pre></td></tr></table></figure>

<ul>
<li><strong>bin_at</strong>ï¼šå–å‡ºä½äºä¸‹æ ‡ i çš„bin chunkï¼Œéœ€è¦æ³¨æ„çš„æ˜¯åœ¨è¿™é‡Œè·å¾—çš„æŒ‡é’ˆä¸ºåŸå§‹å­˜åœ¨binä¸­çš„æŒ‡é’ˆå†å‡å»äº†chunk headerçš„å¤§å°æ‰€å¾—åˆ°çš„å€¼ï¼Œè¿™æ˜¯ç”±äºåœ¨binsæ•°ç»„ä¸­å­˜æ”¾çš„ä¸ºfd&#x2F;bkï¼Œéœ€è¦å‡å»chunk headerçš„å¤§å°æ‰èƒ½è·å¾—ä¸€ä¸ªæŒ‡å‘chunkçš„æŒ‡é’ˆè€Œä¸æ˜¯æŒ‡å‘memçš„æŒ‡é’ˆï¼›ä»è¿™é‡Œæˆ‘ä»¬ä¹Ÿå¯ä»¥çœ‹å‡ºä¸€ä¸ªbinå æ®binsæ•°ç»„ä¸¤æ ¼çš„ç©ºé—´</li>
<li><strong>next_bin</strong>ï¼šè·å–ä¸‹ä¸€ä¸ªbin</li>
<li><strong>first &amp;&amp; last</strong>ï¼šè·å¾—bin chunkçš„fd&#x2F;bk</li>
</ul>
<p>ç®€å•çš„ç®€æä¸€ä¸‹å…³äºbin_atå®çš„è¿™æ ·ä¸€ä¸ªçœ‹èµ·æ¥è¿·æƒ‘çš„æ“ä½œï¼š<strong>Binsæ•°ç»„ä¸­çš„æ¯ä¸€ä¸ªbinéƒ½è¢«è§†ä½œfree chunkæ„å»ºçš„åŒå‘å¾ªç¯é“¾è¡¨ä¸­çš„ä¸€ä¸ªç‰¹æ®Šçš„chunkï¼Œè€Œæ¯ä¸ªbinä¼šåœ¨æ•°ç»„ä¸­å­˜æ”¾FD &amp;&amp; BKï¼ŒåŒæ—¶å°†ç‰©ç†ç›¸é‚»çš„ä¸Šä¸€ä¸ªbinç©ºé—´å¤ç”¨ä½œä¸ºè‡ªå·±çš„chunk header</strong></p>
<p>å…³äºbin chunkçš„å†…å­˜å¤ç”¨æ€æƒ³å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p>
<p><img src="https://i.loli.net/2020/12/22/6fZzuqnyxjcFAKl.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p>åŒæ—¶æœ‰ä¸€ä¸ªå®ç”¨ä»¥æ ¹æ®chunkçš„sizeè·å–ç›¸å¯¹åº”çš„binä¸‹æ ‡ï¼Œç¬”è€…åœ¨åé¢ä¼šå±•å¼€è®²è¿™ä¸ªå®é‡Œé¢çš„ä¸œè¥¿</p>
<h3 id="2-binsç›¸å…³å®šä¹‰å®"><a href="#2-binsç›¸å…³å®šä¹‰å®" class="headerlink" title="2.binsç›¸å…³å®šä¹‰å®"></a>2.binsç›¸å…³å®šä¹‰å®</h3><p>å¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/*</span><br><span class="hljs-comment">   Indexing</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">    Bins for sizes &lt; 512 bytes contain chunks of all the same size, spaced</span><br><span class="hljs-comment">    8 bytes apart. Larger bins are approximately logarithmically spaced:</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">    64 bins of size       8</span><br><span class="hljs-comment">    32 bins of size      64</span><br><span class="hljs-comment">    16 bins of size     512</span><br><span class="hljs-comment">     8 bins of size    4096</span><br><span class="hljs-comment">     4 bins of size   32768</span><br><span class="hljs-comment">     2 bins of size  262144</span><br><span class="hljs-comment">     1 bin  of size what&#x27;s left</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">    There is actually a little bit of slop in the numbers in bin_index</span><br><span class="hljs-comment">    for the sake of speed. This makes no difference elsewhere.</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">    The bins top out around 1MB because we expect to service large</span><br><span class="hljs-comment">    requests via mmap.</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">    Bin 0 does not exist.  Bin 1 is the unordered list; if that would be</span><br><span class="hljs-comment">    a valid chunk size the small bins are bumped up one.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> NBINS             128</span><br></code></pre></td></tr></table></figure>

<p>å¯¹äºè£…è½½ç€sizeå°äº512ï¼ˆ0x200ï¼‰çš„chunkçš„binè€Œè¨€ï¼Œæ¯ä¸ªbinä¸­éƒ½å­˜æ”¾ç€ç›¸åŒå¤§å°çš„chunkï¼Œè€Œå­˜æ”¾æ›´å¤§sizeçš„chunkçš„binï¼ˆlarge binï¼‰ä¸­æ¯ä¸ªbinä¸­chunkçš„å¤§å°å¹¶ä¸ä¸€è‡´ï¼Œè€Œæ˜¯å¤„äºä¸€å®šèŒƒå›´å†…ï¼Œè¢«åˆ†ä¸º7ç»„ï¼Œï¼ˆ32ä½ä¸‹ï¼‰æ¯ç»„binä¸­chunk sizeé—´å…¬å·®å¦‚ä¸Šè¡¨æ‰€ç¤ºï¼ˆ64ä½ç›´æ¥ * 2å³å¯ï¼‰</p>
<p>åŒæ—¶ï¼Œ<strong>bin 0ä¸å­˜åœ¨ï¼Œbin 1åˆ™æ˜¯ä¸€ä¸ªæ— åºçš„é“¾è¡¨</strong>ï¼ˆunsorted binï¼‰</p>
<p>å®å®šä¹‰äº†<code>NBIINS</code>ä¸º<code>128</code>ï¼Œä¹Ÿå°±æ˜¯è¯´ç†åº”æœ‰ç€128ä¸ªbinå­˜æ”¾ä¸åŒç±»å‹çš„chunkï¼Œä½†æ˜¯bin 0 ä¸å­˜åœ¨ï¼Œå› æ­¤<strong>å®é™…ä¸Šåªæœ‰127ä¸ªbin</strong>ï¼Œåœ¨åç»­arenaçš„å®šä¹‰ä¸­æˆ‘ä»¬ä¹Ÿèƒ½çœ‹å‡ºè¿™ä¸€ç‚¹</p>
<h4 id="â‘ unsorted-binç›¸å…³å®"><a href="#â‘ unsorted-binç›¸å…³å®" class="headerlink" title="â‘ unsorted binç›¸å…³å®"></a>â‘ unsorted binç›¸å…³å®</h4><p>å¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/*</span><br><span class="hljs-comment">   Unsorted chunks</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">    All remainders from chunk splits, as well as all returned chunks,</span><br><span class="hljs-comment">    are first placed in the &quot;unsorted&quot; bin. They are then placed</span><br><span class="hljs-comment">    in regular bins after malloc gives them ONE chance to be used before</span><br><span class="hljs-comment">    binning. So, basically, the unsorted_chunks list acts as a queue,</span><br><span class="hljs-comment">    with chunks being placed on it in free (and malloc_consolidate),</span><br><span class="hljs-comment">    and taken off (to be either used or placed in bins) in malloc.</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">    The NON_MAIN_ARENA flag is never set for unsorted chunks, so it</span><br><span class="hljs-comment">    does not have to be taken into account in size comparisons.</span><br><span class="hljs-comment"> */</span><br><br><span class="hljs-comment">/* The otherwise unindexable 1-bin is used to hold unsorted chunks. */</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> unsorted_chunks(M)          (bin_at (M, 1))</span><br></code></pre></td></tr></table></figure>

<p>å¯¹äºåœ¨chunkåˆ†å‰²è¿‡ç¨‹ä¸­æ‰€å‰©ä½™çš„chunkã€ä»¥åŠæ‰€æœ‰å›å½’é—²ç½®çš„chunkéƒ½ä¼š<strong>é¦–å…ˆè¢«å­˜æ”¾åœ¨unsorted binå½“ä¸­</strong>ï¼›å½“è°ƒç”¨mallocæ—¶å…¶ä¸­çš„chunkä¼šæœ‰æœºä¼šè¢«æ”¾å›åˆ°å¸¸è§„çš„binsä¸­ï¼›å› æ­¤é€šå¸¸æƒ…å†µä¸‹unsort binå°±åƒä¸€ä¸ªé˜Ÿåˆ—ä¸€æ ·ï¼Œåœ¨free&#x2F;malloc_consolidateä¸­chunkä¼šè¢«æ”¾ç½®å…¶ä¸­ï¼Œè€Œåœ¨mallocæ—¶å…¶ä¸­çš„chunkåˆä¼šè¢«é‡æ–°æ‹¿èµ°ï¼›<strong>unsorted binä¸­çš„chunkæ°¸è¿œä¸ä¼šè®¾ç½®NON_MAIN_ARENAæ ‡å¿—ä½</strong></p>
<p>åŒæ—¶æˆ‘ä»¬ä¹Ÿå¯ä»¥å¾—çŸ¥å¯¹äºå­˜æ”¾åœ¨unsorted binä¸­çš„chunkçš„sizeå¹¶æ²¡æœ‰åšé™åˆ¶</p>
<p>å®šä¹‰äº†å®<strong>unsorted_chunks()<strong>ç”¨ä»¥è·å¾—unsorted binï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°</strong>unsorted binåœ¨binsæ•°ç»„ä¸­å ç”¨äº†ä¸‹æ ‡0ä¸ä¸‹æ ‡1ï¼Œä¹Ÿå°±æ˜¯è¯´å…¶ä¸ºbinsä¸­çš„ç¬¬ä¸€ä¸ªbin</strong></p>
<h4 id="â‘¡small-binsç›¸å…³å®"><a href="#â‘¡small-binsç›¸å…³å®" class="headerlink" title="â‘¡small binsç›¸å…³å®"></a>â‘¡small binsç›¸å…³å®</h4><p>bin 0ä¸å­˜åœ¨ï¼Œ è€Œbin 1 æ˜¯unsorted binï¼Œ æ•…small binsåº”å½“ä»bin 2 å¼€å§‹å­˜æ”¾</p>
<p>ç›¸å…³å®å¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> NSMALLBINS         64</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> SMALLBIN_WIDTH    MALLOC_ALIGNMENT</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> SMALLBIN_CORRECTION (MALLOC_ALIGNMENT &gt; 2 * SIZE_SZ)</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MIN_LARGE_SIZE    ((NSMALLBINS - SMALLBIN_CORRECTION) * SMALLBIN_WIDTH)</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> in_smallbin_range(sz)  \</span><br><span class="hljs-meta">  ((unsigned long) (sz) &lt; (unsigned long) MIN_LARGE_SIZE)</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> smallbin_index(sz) \</span><br><span class="hljs-meta">  ((SMALLBIN_WIDTH == 16 ? (((unsigned) (sz)) &gt;&gt; 4) : (((unsigned) (sz)) &gt;&gt; 3))\</span><br><span class="hljs-meta">   + SMALLBIN_CORRECTION)</span><br></code></pre></td></tr></table></figure>

<ul>
<li><strong>NSMALLBINS</strong>ï¼šsmall binsä½äºbinsä¸‹æ ‡çš„ç»ˆæ­¢ï¼Œå³<strong>ä»bin1å¼€å§‹åˆ°bin63ä¸€å…±62ä¸ªbinæ˜¯å±äºsmall binsçš„</strong>ï¼Œè¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯<strong>ä¸è¦ç›´æ¥ç†è§£ä¸ºsmall binsçš„æ•°é‡</strong>ï¼Œåé¢ä¼šè¯´æ˜ä¸ºä»€ä¹ˆæ˜¯62ä¸ª</li>
<li><strong>SMALLBIN_WIDTH</strong>ï¼š<strong>æ¯ä¸ª small bin ä¹‹é—´æ‰€å‚¨å­˜çš„chunkçš„sizeå·®å€¼</strong></li>
<li><strong>SMALLBIN_CORRECTION</strong>ï¼šæŸ¥é˜…äº†ä¸€ä¸‹<del>æŒ‡è°·æ­Œ</del>ï¼Œæœ‰ä¸€ç§è¯´æ³•æ˜¯è¿™ä¸ªå®æ˜¯ç”¨ä»¥æ£€æŸ¥binæ˜¯å¦è¢«ç ´åçš„ï¼Œè‹¥è¢«ç ´ååˆ™é’ˆå¯¹åç»­çš„ä¸‹æ ‡ç›¸å…³æ“ä½œè¿›è¡Œä¿®æ­£<del>è¿™ä¸ªå®ä¸€èˆ¬æ¥è¯´éƒ½ä¸º0æ‰€ä»¥æˆ‘ä¹Ÿä¸æ‡‚æœ‰ä»€ä¹ˆç”¨ï¼Œå¤§æ¦‚å¯ä»¥ç›´æ¥å¿½è§†æ‰ï¼Œå—¯x</del></li>
<li><strong>MIN_LARGE_SIZE</strong>ï¼š<strong>æœ€å°çš„large binèŒƒå›´å†…çš„chunkçš„size</strong>ï¼Œåªæœ‰å°äºè¿™ä¸ªsizeçš„chunkæ‰å±äºsmall binçš„èŒƒå›´å†…ï¼Œ<strong>32ä½ä¸‹ä¸º512ï¼Œ64ä½ä¸‹ä¸º1024</strong></li>
<li><strong>in_smallbin_range</strong> ()ï¼šç”¨ä»¥<strong>æ£€æŸ¥ä¸€ä¸ªchunkçš„sizeæ˜¯å¦å±äºsmall binèŒƒå›´å†…</strong></li>
<li><strong>smallbin_index</strong> ()ï¼šç”¨ä»¥<strong>è·å¾—ä¸€ä¸ªsmall bin chunkå¤„åœ¨binä¸­çš„index</strong>ï¼Œç”±äºbin 1æ˜¯unsorted binæ‰€ä»¥ç›´æ¥è¿›è¡Œç§»ä½æ“ä½œå³å¯è·å¾—index</li>
</ul>
<p>é€šè¿‡MIN_LARGE_SIZEæˆ‘ä»¬å¯ä»¥çŸ¥é“<strong>æœ€å¤§çš„small binçš„sizeåœ¨32ä½ä¸‹ä¸º504ï¼Œ 64ä½ä¸‹ä¸º1008</strong>ï¼ˆå‡å»äº†ä¸€ä¸ªMALLOC_ALIGNMENTï¼‰ï¼Œ<strong>ç”±æ­¤æˆ‘ä»¬ä¾¿å¯ä»¥å¾—å‡ºsmall binsçš„æ•°é‡ä¸º62</strong></p>
<h4 id="â‘¢large-binsç›¸å…³å®"><a href="#â‘¢large-binsç›¸å…³å®" class="headerlink" title="â‘¢large binsç›¸å…³å®"></a>â‘¢large binsç›¸å…³å®</h4><p>å¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> largebin_index_32(sz)                                                \</span><br><span class="hljs-meta">  (((((unsigned long) (sz)) &gt;&gt; 6) <span class="hljs-string">&lt;= 38) ?  56 + (((unsigned long) (sz)) &gt;</span>&gt; 6) :\</span><br><span class="hljs-meta">   ((((unsigned long) (sz)) &gt;&gt; 9) <span class="hljs-string">&lt;= 20) ?  91 + (((unsigned long) (sz)) &gt;</span>&gt; 9) :\</span><br><span class="hljs-meta">   ((((unsigned long) (sz)) &gt;&gt; 12) <span class="hljs-string">&lt;= 10) ? 110 + (((unsigned long) (sz)) &gt;</span>&gt; 12) :\</span><br><span class="hljs-meta">   ((((unsigned long) (sz)) &gt;&gt; 15) <span class="hljs-string">&lt;= 4) ? 119 + (((unsigned long) (sz)) &gt;</span>&gt; 15) :\</span><br><span class="hljs-meta">   ((((unsigned long) (sz)) &gt;&gt; 18) <span class="hljs-string">&lt;= 2) ? 124 + (((unsigned long) (sz)) &gt;</span>&gt; 18) :\</span><br><span class="hljs-meta">   126)</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> largebin_index_32_big(sz)                                            \</span><br><span class="hljs-meta">  (((((unsigned long) (sz)) &gt;&gt; 6) <span class="hljs-string">&lt;= 45) ?  49 + (((unsigned long) (sz)) &gt;</span>&gt; 6) :\</span><br><span class="hljs-meta">   ((((unsigned long) (sz)) &gt;&gt; 9) <span class="hljs-string">&lt;= 20) ?  91 + (((unsigned long) (sz)) &gt;</span>&gt; 9) :\</span><br><span class="hljs-meta">   ((((unsigned long) (sz)) &gt;&gt; 12) <span class="hljs-string">&lt;= 10) ? 110 + (((unsigned long) (sz)) &gt;</span>&gt; 12) :\</span><br><span class="hljs-meta">   ((((unsigned long) (sz)) &gt;&gt; 15) <span class="hljs-string">&lt;= 4) ? 119 + (((unsigned long) (sz)) &gt;</span>&gt; 15) :\</span><br><span class="hljs-meta">   ((((unsigned long) (sz)) &gt;&gt; 18) <span class="hljs-string">&lt;= 2) ? 124 + (((unsigned long) (sz)) &gt;</span>&gt; 18) :\</span><br><span class="hljs-meta">   126)</span><br><br><span class="hljs-comment">// XXX It remains to be seen whether it is good to keep the widths of</span><br><span class="hljs-comment">// XXX the buckets the same or whether it should be scaled by a factor</span><br><span class="hljs-comment">// XXX of two as well.</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> largebin_index_64(sz)                                                \</span><br><span class="hljs-meta">  (((((unsigned long) (sz)) &gt;&gt; 6) <span class="hljs-string">&lt;= 48) ?  48 + (((unsigned long) (sz)) &gt;</span>&gt; 6) :\</span><br><span class="hljs-meta">   ((((unsigned long) (sz)) &gt;&gt; 9) <span class="hljs-string">&lt;= 20) ?  91 + (((unsigned long) (sz)) &gt;</span>&gt; 9) :\</span><br><span class="hljs-meta">   ((((unsigned long) (sz)) &gt;&gt; 12) <span class="hljs-string">&lt;= 10) ? 110 + (((unsigned long) (sz)) &gt;</span>&gt; 12) :\</span><br><span class="hljs-meta">   ((((unsigned long) (sz)) &gt;&gt; 15) <span class="hljs-string">&lt;= 4) ? 119 + (((unsigned long) (sz)) &gt;</span>&gt; 15) :\</span><br><span class="hljs-meta">   ((((unsigned long) (sz)) &gt;&gt; 18) <span class="hljs-string">&lt;= 2) ? 124 + (((unsigned long) (sz)) &gt;</span>&gt; 18) :\</span><br><span class="hljs-meta">   126)</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> largebin_index(sz) \</span><br><span class="hljs-meta">  (SIZE_SZ == 8 ? largebin_index_64 (sz)                                     \</span><br><span class="hljs-meta">   : MALLOC_ALIGNMENT == 16 ? largebin_index_32_big (sz)                     \</span><br><span class="hljs-meta">   : largebin_index_32 (sz))</span><br></code></pre></td></tr></table></figure>

<ul>
<li><strong>largebin_index_32() &amp;&amp; largebin_index_64</strong> ()ï¼šä¸€èˆ¬æƒ…å†µä¸‹ç”¨ä»¥<strong>è·å–large bin chunkä½äºbinä¸­çš„index</strong></li>
<li><strong>largebin_index_32_big</strong> ()ï¼šè‹¥æ˜¯åœ¨32ä½ä¸‹MALLOC_ALIGNMENTä¸º16æ—¶æ‰ä¼šå¯ç”¨çš„ç‰¹æ®Šå®ç”¨ä»¥è·å–indexï¼Œè¿™æ˜¯å› ä¸ºå¸¸è§„æƒ…å†µä¸‹32ä½ä¸‹MALLOC_ALIGNMENTä¸º8ï¼Œè‹¥æ˜¯æ‰©å¤§åˆ°16çš„è¯è‡ªç„¶è®¡ç®—large binçš„indexçš„ç­–ç•¥ä¹Ÿè¦æ”¹å˜</li>
<li><strong>largebin_index</strong> ()ï¼šå¯¹å‰é¢ä¸‰ä¸ªå®çš„å°è£…ï¼Œç”¨ä»¥<strong>è·å–large bin chunkä½äºbinä¸­çš„index</strong></li>
</ul>
<p>å¯ä»¥çœ‹å¾—å‡ºæ¥ï¼Œç›¸è¾ƒäºsmall binè€Œè¨€ï¼Œç”±äºlarge biné‡‡ç”¨äº†æ›´ä¸ºç‰¹æ®Šçš„ç­–ç•¥ï¼Œæ•…å…¶è·å–indexçš„è¿‡ç¨‹ä¹Ÿæ›´ä¸ºå¤æ‚ï¼Œå…·ä½“å¯ä»¥å‚è§è¿™ä¸€èŠ‚å¼€å¤´å…ˆå‰çš„å…³äºlarge bin sizeçš„è¯´æ˜</p>
<p>é€šè¿‡è¿™äº›å®å®šä¹‰æˆ‘ä»¬ä¹Ÿå¯ä»¥ç®—å‡º<strong>ä¸€å…±æœ‰63ä¸ªlarge bin</strong></p>
<h3 id="3-unlinkï¼šä»binsä¸­å–å‡ºchunk"><a href="#3-unlinkï¼šä»binsä¸­å–å‡ºchunk" class="headerlink" title="3.unlinkï¼šä»binsä¸­å–å‡ºchunk"></a>3.unlinkï¼šä»binsä¸­å–å‡ºchunk</h3><p>ç”±äºä»å„ç§binsä¸­å–å‡ºä¸€ä¸ªchunkçš„æ“ä½œååˆ†é¢‘ç¹ï¼Œè‹¥æ˜¯ä½¿ç”¨å‡½æ•°å®ç°åˆ™ä¼šé€ æˆè¾ƒå¤§çš„å¼€é”€ï¼Œæ•…unlinkæ“ä½œè¢«å•ç‹¬å®ç°ä¸ºä¸€ä¸ªå®ï¼Œå¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/* Take a chunk off a bin list */</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> unlink(AV, P, BK, FD) &#123;                                            \</span><br><span class="hljs-meta">    FD = P-&gt;fd;								      \</span><br><span class="hljs-meta">    BK = P-&gt;bk;								      \</span><br><span class="hljs-meta">    <span class="hljs-keyword">if</span> (__builtin_expect (FD-&gt;bk != P || BK-&gt;fd != P, 0))		      \</span><br><span class="hljs-meta">      malloc_printerr (check_action, <span class="hljs-string">&quot;corrupted double-linked list&quot;</span>, P, AV);  \</span><br><span class="hljs-meta">    <span class="hljs-keyword">else</span> &#123;								      \</span><br><span class="hljs-meta">        FD-&gt;bk = BK;							      \</span><br><span class="hljs-meta">        BK-&gt;fd = FD;							      \</span><br><span class="hljs-meta">        <span class="hljs-keyword">if</span> (!in_smallbin_range (P-&gt;size)				      \</span><br><span class="hljs-meta">            &amp;&amp; __builtin_expect (P-&gt;fd_nextsize != NULL, 0)) &#123;		      \</span><br><span class="hljs-meta">	    <span class="hljs-keyword">if</span> (__builtin_expect (P-&gt;fd_nextsize-&gt;bk_nextsize != P, 0)	      \</span><br><span class="hljs-meta">		|| __builtin_expect (P-&gt;bk_nextsize-&gt;fd_nextsize != P, 0))    \</span><br><span class="hljs-meta">	      malloc_printerr (check_action,				      \</span><br><span class="hljs-meta">			       <span class="hljs-string">&quot;corrupted double-linked list (not small)&quot;</span>,    \</span><br><span class="hljs-meta">			       P, AV);					      \</span><br><span class="hljs-meta">            <span class="hljs-keyword">if</span> (FD-&gt;fd_nextsize == NULL) &#123;				      \</span><br><span class="hljs-meta">                <span class="hljs-keyword">if</span> (P-&gt;fd_nextsize == P)				      \</span><br><span class="hljs-meta">                  FD-&gt;fd_nextsize = FD-&gt;bk_nextsize = FD;		      \</span><br><span class="hljs-meta">                <span class="hljs-keyword">else</span> &#123;							      \</span><br><span class="hljs-meta">                    FD-&gt;fd_nextsize = P-&gt;fd_nextsize;			      \</span><br><span class="hljs-meta">                    FD-&gt;bk_nextsize = P-&gt;bk_nextsize;			      \</span><br><span class="hljs-meta">                    P-&gt;fd_nextsize-&gt;bk_nextsize = FD;			      \</span><br><span class="hljs-meta">                    P-&gt;bk_nextsize-&gt;fd_nextsize = FD;			      \</span><br><span class="hljs-meta">                  &#125;							      \</span><br><span class="hljs-meta">              &#125; <span class="hljs-keyword">else</span> &#123;							      \</span><br><span class="hljs-meta">                P-&gt;fd_nextsize-&gt;bk_nextsize = P-&gt;bk_nextsize;		      \</span><br><span class="hljs-meta">                P-&gt;bk_nextsize-&gt;fd_nextsize = P-&gt;fd_nextsize;		      \</span><br><span class="hljs-meta">              &#125;								      \</span><br><span class="hljs-meta">          &#125;								      \</span><br><span class="hljs-meta">      &#125;									      \</span><br><span class="hljs-meta">&#125;</span><br></code></pre></td></tr></table></figure>

<p>å¤§è‡´çš„ä¸€ä¸ªæµç¨‹å¦‚ä¸‹ï¼š</p>
<ul>
<li>Pä¸ºè¦è¢«unlinkçš„chunkï¼ŒFDã€BKåˆ™æ˜¯chunkï¼šP-&gt;fdä¸P-&gt;bk</li>
<li>æ£€æŸ¥FD-&gt;bkä¸BK-&gt;fdæ˜¯å¦éƒ½æŒ‡å‘Pï¼Œè‹¥å¦ï¼Œåˆ™è¾“å‡ºé”™è¯¯ä¿¡æ¯</li>
<li>å°†FD-&gt;bkæŒ‡å‘BKï¼Œå°†BK-&gt;fdæŒ‡å‘FDï¼Œ<strong>è¿™ä¸ªæ—¶å€™è¿™ä¸ªchunkä¾¿å·²ç»ä¸åœ¨è¯¥binçš„åŒå‘å¾ªç¯é“¾è¡¨ä¸­äº†</strong></li>
<li><strong>è‹¥æ˜¯chunk sizeä½äºsmall binçš„èŒƒå›´å†…ï¼Œåˆ™unlinkç»“æŸï¼Œå¦åˆ™æ ‡å¿—ç€æ­¤æ—¶chunkçš„fd_nextsizeä¸bk_nextsizeå­—æ®µæ˜¯å¯ç”¨çš„ï¼Œéœ€è¦æ¥ç€å°†ä¹‹ä»nextsizeé“¾è¡¨ä¸­unlink</strong>ï¼ˆlarge binç‰¹æœ‰ï¼‰</li>
<li>æ£€æŸ¥P-&gt;fd_nextsize-&gt;bk_sizeä¸P-&gt;bk_nextsize-&gt;fd_nextsizeæ˜¯å¦æŒ‡å‘Pï¼Œå’Œå‰é¢çš„è¿‡ç¨‹ç±»ä¼¼è¿™é‡Œä¾¿ä¸å†èµ˜å™</li>
<li><strong>è‹¥FD-&gt;fd_nextsizeä¸ä¸ºNULLï¼Œåˆ™å°†Pä»å…¶æ‰€å¤„nextsizeé“¾è¡¨ä¸­unlink</strong></li>
<li><strong>è‹¥FD-&gt;fd_nextsizeä¸ºNULLæ—¶</strong>ï¼Œè‹¥P-&gt;fd_nextsizeæŒ‡å‘è‡ªèº«ï¼Œåˆ™å°†FD-&gt;fd_nextsizeä¸FD-&gt;bk_nextsizeéƒ½æŒ‡å‘FDï¼ˆä»£è¡¨è¯¥chunkä¸å±äºä»»ä½•ä¸€ä¸ªnextsizeé“¾è¡¨ï¼Ÿï¼‰ï¼Œ<strong>å¦åˆ™ä½¿ç”¨FDæ›¿æ¢æ‰Pæ‰€åœ¨çš„nextsizeé“¾è¡¨ä¸­çš„ä½ç½®</strong></li>
</ul>
<p>å¤§è‡´è¿‡ç¨‹å¦‚ä¸‹å›¾æ‰€ç¤º</p>
<p><img src="https://i.loli.net/2020/12/23/AVsn1tB9hydocYe.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p><img src="https://i.loli.net/2020/12/23/MfhiGYa97XLRtHK.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p><img src="https://i.loli.net/2020/12/23/gkAXzI2M8UviO9C.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p><img src="https://i.loli.net/2020/12/23/TR23CkfSEOLYtgh.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p><img src="https://i.loli.net/2020/12/23/FGMlVisw69xtThJ.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p><img src="https://i.loli.net/2020/12/23/PNIcnpb1YJovmai.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<blockquote>
<p>unlinkæ“ä½œåº”è¯¥æ˜¯æˆ‘åœ¨0x00ä¸­ç”»å›¾æœ€å¤šçš„ä¸€éƒ¨åˆ†äº†â€¦</p>
</blockquote>
<blockquote>
<h5 id="builtin-expect-expr-var-ï¼šåˆ†æ”¯é¢„æµ‹ä¼˜åŒ–"><a href="#builtin-expect-expr-var-ï¼šåˆ†æ”¯é¢„æµ‹ä¼˜åŒ–" class="headerlink" title="__builtin_expect(expr, var)ï¼šåˆ†æ”¯é¢„æµ‹ä¼˜åŒ–"></a>__builtin_expect(expr, var)ï¼šåˆ†æ”¯é¢„æµ‹ä¼˜åŒ–</h5><p>gccçš„åˆ†æ”¯é¢„æµ‹ä¼˜åŒ–ä»£ç ï¼Œå¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/* Tell the compiler when a conditional or integer expression is</span><br><span class="hljs-comment">almost always true or almost always false.  */</span><br><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> HAVE_BUILTIN_EXPECT</span><br><span class="hljs-meta"># <span class="hljs-keyword">define</span> __builtin_expect(expr, val) (expr)</span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br></code></pre></td></tr></table></figure>

<p>è¯¥ä»£ç ç”¨äº<strong>ç¼–è¯‘å™¨</strong>åˆ†æ”¯é¢„æµ‹ä¼˜åŒ–ï¼Œ<strong>å½“exprçš„å€¼åœ¨å¤§éƒ¨åˆ†æƒ…å†µä¸‹éƒ½ä¸ºvaræ—¶ï¼Œä¾¿å¯ä»¥ä½¿ç”¨è¯¥å®ï¼Œç¼–è¯‘å™¨ä¼šé’ˆå¯¹è¯¥åˆ†æ”¯é¢„æµ‹è¿›è¡Œç›¸åº”çš„ä¼˜åŒ–</strong></p>
</blockquote>
<blockquote>
<h5 id="malloc-printerr"><a href="#malloc-printerr" class="headerlink" title="malloc_printerr()"></a>malloc_printerr()</h5><p>å®šä¹‰äºmalloc.cä¸­çš„ä¸€ä¸ªå‡½æ•°ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">void</span><br><span class="hljs-title function_">malloc_printerr</span> <span class="hljs-params">(<span class="hljs-type">int</span> action, <span class="hljs-type">const</span> <span class="hljs-type">char</span> *str, <span class="hljs-type">void</span> *ptr, mstate ar_ptr)</span><br>&#123;<br><span class="hljs-comment">/* Avoid using this arena in future.  We do not attempt to synchronize this</span><br><span class="hljs-comment">with anything else because we minimally want to ensure that __libc_message</span><br><span class="hljs-comment">gets its resources safely without stumbling on the current corruption.  */</span><br><span class="hljs-keyword">if</span> (ar_ptr)<br>set_arena_corrupt (ar_ptr);<br><br><span class="hljs-keyword">if</span> ((action &amp; <span class="hljs-number">5</span>) == <span class="hljs-number">5</span>)<br>__libc_message (action &amp; <span class="hljs-number">2</span>, <span class="hljs-string">&quot;%s\n&quot;</span>, str);<br><span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (action &amp; <span class="hljs-number">1</span>)<br>&#123;<br><span class="hljs-type">char</span> buf[<span class="hljs-number">2</span> * <span class="hljs-keyword">sizeof</span> (<span class="hljs-type">uintptr_t</span>) + <span class="hljs-number">1</span>];<br><br>buf[<span class="hljs-keyword">sizeof</span> (buf) - <span class="hljs-number">1</span>] = <span class="hljs-string">&#x27;\0&#x27;</span>;<br><span class="hljs-type">char</span> *cp = _itoa_word ((<span class="hljs-type">uintptr_t</span>) ptr, &amp;buf[<span class="hljs-keyword">sizeof</span> (buf) - <span class="hljs-number">1</span>], <span class="hljs-number">16</span>, <span class="hljs-number">0</span>);<br><span class="hljs-keyword">while</span> (cp &gt; buf)<br>  *--cp = <span class="hljs-string">&#x27;0&#x27;</span>;<br><br>__libc_message (action &amp; <span class="hljs-number">2</span>, <span class="hljs-string">&quot;*** Error in `%s&#x27;: %s: 0x%s ***\n&quot;</span>,<br>                __libc_argv[<span class="hljs-number">0</span>] ? : <span class="hljs-string">&quot;&lt;unknown&gt;&quot;</span>, str, cp);<br>&#125;<br><span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (action &amp; <span class="hljs-number">2</span>)<br><span class="hljs-built_in">abort</span> ();<br>&#125;<br></code></pre></td></tr></table></figure>

<p>é¦–å…ˆæ£€æŸ¥arenaæŒ‡é’ˆæ˜¯å¦ä¸ºç©ºï¼Œè‹¥å¦åˆ™è®¾ç½®arenaè¢«ç ´åçš„æ ‡å¿—ä½</p>
<p>éšåæ ¹æ®actionçš„ä¸åŒçš„å€¼åšå‡ºä¸åŒçš„å†³ç­–ï¼š</p>
<ul>
<li>5ï¼šç›´æ¥è¾“å‡ºé”™è¯¯ä¿¡æ¯</li>
<li>1ï¼šå£°æ˜äº†ä¸€ä¸ªbufæ•°ç»„ç”¨ä»¥å­˜å‚¨åœ°å€ä¿¡æ¯ï¼Œéšåè¾“å‡ºé”™è¯¯ä¿¡æ¯</li>
<li>2ï¼šç›´æ¥è°ƒç”¨abort()å‡½æ•°ç»ˆæ­¢ç¨‹åº</li>
</ul>
<p>__libc_message()å‡½æ•°ç”¨äºè¾“å‡ºé”™è¯¯ä¿¡æ¯ï¼Œè¯¥å‡½æ•°å®šä¹‰äºsysdeps&#x2F;posix&#x2F;libc_fatal.cä¸­ï¼Œç”±äºä¸æ˜¯æœ¬ç¯‡æ–‡ç« çš„é‡ç‚¹æ•…ä¸ä½œè¯¦ç»†è¯´æ˜</p>
<p>abort()å‡½æ•°å®šä¹‰äºstdlib&#x2F;abort.cä¸­ï¼Œç”¨ä»¥ç»ˆæ­¢ç¨‹åºå¹¶æŠŠcoreç»™dumpä¸‹æ¥ï¼Œè¿™é‡Œä¹Ÿä¸å†æ·±å…¥è¯´æ˜</p>
</blockquote>
<h3 id="4-binmapï¼šç”¨æ¥æ ‡è¯†binçŠ¶æ€ï¼ˆæ˜¯å¦ä¸ºç©ºï¼‰çš„æ•°ç»„"><a href="#4-binmapï¼šç”¨æ¥æ ‡è¯†binçŠ¶æ€ï¼ˆæ˜¯å¦ä¸ºç©ºï¼‰çš„æ•°ç»„" class="headerlink" title="4.binmapï¼šç”¨æ¥æ ‡è¯†binçŠ¶æ€ï¼ˆæ˜¯å¦ä¸ºç©ºï¼‰çš„æ•°ç»„"></a>4.binmapï¼šç”¨æ¥æ ‡è¯†binçŠ¶æ€ï¼ˆæ˜¯å¦ä¸ºç©ºï¼‰çš„æ•°ç»„</h3><p>æˆ‘ä»¬å…ˆæ¥çœ‹malloc.cä¸­å¯¹äºbinmapçš„è¯´æ˜å¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/*</span><br><span class="hljs-comment">   Binmap</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">    To help compensate for the large number of bins, a one-level index</span><br><span class="hljs-comment">    structure is used for bin-by-bin searching.  `binmap&#x27; is a</span><br><span class="hljs-comment">    bitvector recording whether bins are definitely empty so they can</span><br><span class="hljs-comment">    be skipped over during during traversals.  The bits are NOT always</span><br><span class="hljs-comment">    cleared as soon as bins are empty, but instead only</span><br><span class="hljs-comment">    when they are noticed to be empty during traversal in malloc.</span><br><span class="hljs-comment"> */</span><br><br><span class="hljs-comment">/* Conservatively use 32 bits per map word, even if on 64bit system */</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> BINMAPSHIFT      5</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> BITSPERMAP       (1U &lt;&lt; BINMAPSHIFT)</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> BINMAPSIZE       (NBINS / BITSPERMAP)</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> idx2block(i)     ((i) &gt;&gt; BINMAPSHIFT)</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> idx2bit(i)       ((1U &lt;&lt; ((i) &amp; ((1U &lt;&lt; BINMAPSHIFT) - 1))))</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> mark_bin(m, i)    ((m)-&gt;binmap[idx2block (i)] |= idx2bit (i))</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> unmark_bin(m, i)  ((m)-&gt;binmap[idx2block (i)] &amp;= ~(idx2bit (i)))</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> get_binmap(m, i)  ((m)-&gt;binmap[idx2block (i)] &amp; idx2bit (i))</span><br></code></pre></td></tr></table></figure>

<p>å¤§æ„æ˜¯è¯´ç”±äºbinsçš„æ•°é‡è¿‡å¤šï¼Œæ•…ptmallocåœ¨binçš„éå†æŸ¥æ‰¾ä¸­ä½¿ç”¨ä¸€ç§ç§°ä¹‹ä¸ºbinmapçš„ä¸€çº§ç´¢å¼•ç»“æ„ã€‚binmapä½¿ç”¨<strong>ã€Œä½å‘é‡ã€</strong>æ¥æ ‡è®°binsæ•°ç»„ä¸­çš„æ¯ä¸€ä¸ªbinï¼Œä»¥ä¾¿äºèƒ½å¤Ÿå¿«é€Ÿéå†binsã€‚</p>
<p><strong>åœ¨ä¸€ä¸ªbinè¢«ç½®ç©ºæ—¶å…¶binmapå†…å¯¹åº”çš„æ ‡å¿—ä½å¹¶ä¸ä¼šè¢«ç«‹å³æ¸…ç©ºï¼Œåªä¼šåœ¨ä¸‹æ¬¡é‡æ–°éå†æ—¶é‡æ–°ç½®ä½</strong></p>
<p>binmapçš„è®¾è®¡æ€æƒ³æ˜¯<strong>å……åˆ†åˆ©ç”¨æ¯ä¸€ä½æ¥è¿›è¡ŒbinçŠ¶æ€çš„æ ‡è®°</strong></p>
<p>é¦–å…ˆå®šä¹‰äº†ä¸‰ä¸ªå®ï¼š</p>
<ul>
<li><strong>BINMAPSHIFT</strong>ï¼šbinmapä¸­ä¸€ä¸ªmapçš„è®¡æ•°é‡çš„ç§»ä½æ•°</li>
<li><strong>BITSPERMAP</strong>ï¼šbinmapä¸­æ¯ä¸ªmapæ‰€å‚¨å­˜çš„bitæ•°ï¼ŒåŒæ—¶ä¹Ÿæ˜¯ä¸€ä¸ªmapæ‰€å¯¹åº”çš„binsæ•°ï¼Œ<strong>ä¸º32</strong></li>
<li><strong>BINMAPSIZE</strong>ï¼šbinmapçš„å¤§å°ï¼Œåœ¨è¿™é‡Œå¯ä»¥çœ‹å‡ºæ¥binmapä¸­mapçš„æ•°é‡æ˜¯æ ¹æ®binsçš„æ•°é‡æ¥è®¡ç®—çš„ï¼Œ<strong>ä¸º4</strong></li>
</ul>
<p>binmapåœ¨ptmallocä¸­æ˜¯unsigned intç±»å‹ï¼Œ32ä½&amp;&amp;64ä½ä¸‹éƒ½æ˜¯4å­—èŠ‚ï¼Œç”±æ­¤æˆ‘ä»¬ä¾¿å¯ä»¥å¾—å‡ºbinmapçš„å¤§è‡´ç»“æ„åº”å½“å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p>
<p><img src="https://i.loli.net/2020/12/27/PO3noG2fuUMitXz.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p>ç”±æ­¤è¿˜å®šä¹‰äº†å¦‚ä¸‹å®ï¼š</p>
<ul>
<li><p><strong>idx2block</strong> ()ï¼šç”±binå¯¹åº”binsæ•°ç»„çš„indexè·å–å…¶å¯¹åº”çš„binmapä¸­çš„mapçš„indexï¼ˆ0~3ï¼‰</p>
</li>
<li><p><strong>idx2bit</strong> ()ï¼šç”±binå¯¹åº”binsæ•°ç»„çš„indexè·å–å…¶å¯¹åº”çš„binmapä¸­çš„mapçš„bitï¼ˆè¯¥å€¼åº”ä¸º2^nï¼Œnä¸º[0, 31]ä¸­ä»»ä¸€æ•´æ•°ï¼‰</p>
</li>
<li><p><strong>mark_bin</strong> ()ï¼šåœ¨binmapä¸­æ ‡è®°è¯¥binä¸ºéç©ºï¼ˆè®¾è¯¥bitä¸º1ï¼‰</p>
</li>
<li><p><strong>unmark_bin</strong> ()ï¼šåœ¨binmapä¸­æ ‡è®°è¯¥binä¸ºç©ºï¼ˆè®¾è¯¥bitä¸º0ï¼‰</p>
</li>
<li><p><strong>get_binmap</strong> ()ï¼šè·å¾—ä¸€ä¸ªbinåœ¨binmapä¸­çš„æ ‡è®°ä½çš„<strong>åŸå§‹å€¼</strong></p>
<p>ä¸è¿‡æˆ‘ä»¬è¿˜éœ€è¦æ³¨æ„çš„ä¸€ç‚¹ä¾¿æ˜¯ï¼š<strong>fastbinä¸ä½¿ç”¨binmapæ ‡å¿—ä½</strong>ï¼Œfastbinæ˜¯ä¸“é—¨ç”¨ä»¥å­˜å‚¨å°chunkçš„ç‹¬ç«‹äºbinsæ•°ç»„ä¹‹å¤–çš„binsæ•°ç»„ï¼Œè®¾è®¡çš„ç›®çš„æ˜¯æé«˜chunkçš„ä½¿ç”¨æ•ˆç‡ï¼Œä¸‹é¢æˆ‘ä»¬å°±æ¥è®²è®²fastbin</p>
</li>
</ul>
<h2 id="å››ã€Fastbinsï¼šå¿«é€Ÿå­˜å–chunkçš„æ•°ç»„"><a href="#å››ã€Fastbinsï¼šå¿«é€Ÿå­˜å–chunkçš„æ•°ç»„" class="headerlink" title="å››ã€Fastbinsï¼šå¿«é€Ÿå­˜å–chunkçš„æ•°ç»„"></a>å››ã€Fastbinsï¼šå¿«é€Ÿå­˜å–chunkçš„æ•°ç»„</h2><p>è™½ç„¶æˆ‘ä»¬åœ¨å‰é¢è®²åˆ°åœ¨ptmallocä¸­ä½¿ç”¨Binsæ•°ç»„å‚¨å­˜é—²ç½®çš„chunkï¼Œä½†æ˜¯ç”±äºå¤§éƒ¨åˆ†ç¨‹åºéƒ½ä¼šé¢‘ç¹åœ°ç”³è¯·ä»¥åŠé‡Šæ”¾ä¸€äº›è¾ƒå°çš„chunkï¼Œè‹¥æ˜¯æˆ‘ä»¬å°†å¤§éƒ¨åˆ†çš„æ—¶é—´éƒ½èŠ±åœ¨åˆå¹¶chunkã€åˆ†å‰²chunkã€ç¹å¤çš„å®‰å…¨æ£€æŸ¥ä¸Šï¼Œåˆ™ä¼šä¼šå¤§å¤§åœ°é™ä½å †çš„åˆ©ç”¨æ•ˆç‡ï¼Œæ•…ptmalloc<strong>ç‹¬ç«‹äºBinsä¹‹å¤–å•ç‹¬è®¾è®¡äº†ä¸€ä¸ªFastbinç”¨ä»¥å‚¨å­˜ä¸€äº›sizeè¾ƒå°çš„é—²ç½®chunk</strong>ï¼Œè¯´æ˜å¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/*</span><br><span class="hljs-comment">   Fastbins</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">    An array of lists holding recently freed small chunks.  Fastbins</span><br><span class="hljs-comment">    are not doubly linked.  It is faster to single-link them, and</span><br><span class="hljs-comment">    since chunks are never removed from the middles of these lists,</span><br><span class="hljs-comment">    double linking is not necessary. Also, unlike regular bins, they</span><br><span class="hljs-comment">    are not even processed in FIFO order (they use faster LIFO) since</span><br><span class="hljs-comment">    ordering doesn&#x27;t much matter in the transient contexts in which</span><br><span class="hljs-comment">    fastbins are normally used.</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">    Chunks in fastbins keep their inuse bit set, so they cannot</span><br><span class="hljs-comment">    be consolidated with other free chunks. malloc_consolidate</span><br><span class="hljs-comment">    releases all chunks in fastbins and consolidates them with</span><br><span class="hljs-comment">    other free chunks.</span><br><span class="hljs-comment"> */</span><br><br><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">malloc_chunk</span> *<span class="hljs-title">mfastbinptr</span>;</span><br></code></pre></td></tr></table></figure>



<ul>
<li><p>Fastbinsæ˜¯ä¸€ä¸ªç”¨ä»¥ä¿å­˜æœ€è¿‘é‡Šæ”¾çš„è¾ƒå°çš„chunkçš„æ•°ç»„ï¼Œä¸ºäº†æé«˜é€Ÿåº¦å…¶<strong>ä½¿ç”¨å•å‘é“¾è¡¨è¿›è¡Œé“¾æ¥</strong></p>
</li>
<li><p><strong>Fastbiné‡‡å–FILO&#x2F;LIFOçš„ç­–ç•¥ï¼Œå³æ¯æ¬¡éƒ½å–ç”¨fastbiné“¾è¡¨å¤´éƒ¨çš„chunkï¼Œæ¯æ¬¡é‡Šæ”¾chunkæ—¶éƒ½æ’å…¥è‡³é“¾è¡¨å¤´éƒ¨æˆä¸ºæ–°çš„å¤´ç»“ç‚¹</strong>ï¼Œå› è€Œå¤§å¹…æé«˜äº†å­˜å–chunkçš„é€Ÿåº¦</p>
</li>
<li><p><strong>Fastbinä¸­çš„chunkæ°¸è¿œä¿æŒåœ¨in_useçš„çŠ¶æ€ï¼Œè¿™ä¹Ÿä¿è¯äº†å¥¹ä»¬ä¸ä¼šè¢«ä¸å…¶ä»–çš„free chunkåˆå¹¶</strong></p>
</li>
<li><p><strong>malloc_consolidate()å‡½æ•°å°†ä¼šæ¸…ç©ºfastbinä¸­æ‰€æœ‰çš„chunkï¼Œåœ¨è¿›è¡Œç›¸åº”çš„åˆå¹¶åé€å…¥æ™®é€šçš„small binsä¸­</strong></p>
</li>
</ul>
<h3 id="fastbinç›¸å…³å®"><a href="#fastbinç›¸å…³å®" class="headerlink" title="fastbinç›¸å…³å®"></a>fastbinç›¸å…³å®</h3><p>malloc.cä¸­åŒæ ·å®šä¹‰äº†ä¸€äº›ä¸fastbinç›¸å…³çš„å®ï¼Œå¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> fastbin(ar_ptr, idx) ((ar_ptr)-&gt;fastbinsY[idx])</span><br><br><span class="hljs-comment">/* offset 2 to use otherwise unindexable first 2 bins */</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> fastbin_index(sz) \</span><br><span class="hljs-meta">  ((((unsigned int) (sz)) &gt;&gt; (SIZE_SZ == 8 ? 4 : 3)) - 2)</span><br><span class="hljs-comment">/* The maximum fastbin request size we support */</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MAX_FAST_SIZE     (80 * SIZE_SZ / 4)</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> NFASTBINS  (fastbin_index (request2size (MAX_FAST_SIZE)) + 1)</span><br></code></pre></td></tr></table></figure>

<ul>
<li><p><strong>fastbin</strong> ()ï¼šä»ä¸€ä¸ªarenaä¸­è·å–å…¶fastbinæ•°ç»„ç›¸åº”ä¸‹æ ‡çš„bin</p>
</li>
<li><p><strong>fastbin_index</strong> ()ï¼šæ ¹æ®chunkçš„sizeè·å–å…¶åº”å½“å¤„äºçš„fast binçš„indexï¼Œåœ¨è¿™é‡Œæˆ‘ä»¬å¯ä»¥å‘ç°ä¸€ç‚¹æ˜¯<strong>fastbinè®¡ç®—indexæ—¶æ˜¯é€šè¿‡ç§»ä½æ“ä½œè¿›è¡Œçš„ï¼Œå³æ ‡å¿—ä½çš„ä¸åŒå¯¹äºfastbin indexçš„è®¡ç®—å¹¶æ²¡æœ‰å½±å“ï¼Œè¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆæˆ‘ä»¬åœ¨fastbin attackæ—¶èƒ½å¤Ÿåˆ©ç”¨malloc_hook - 0x23ä½ç½®ä¸Šçš„0x7fè¿™ä¸ªå€¼åˆ†é…åˆ°ä¸€ä¸ªfake chunkçš„åŸå› </strong>ï¼ˆåç»­ä¼šåœ¨mallocä¸­è¯´æ˜fastbinç›¸å…³çš„å®‰å…¨æ£€æŸ¥ï¼‰</p>
</li>
<li><p><strong>MAX_FAST_SIZE</strong>ï¼š<strong>ã€å®šä¹‰ä¸Šçš„ã€‘æœ€å¤§çš„fastbin chunkçš„sizeï¼Œè¶…è¿‡è¿™ä¸ªsizeçš„chunkéƒ½å°†ä¼šè¢«é€å…¥unsorted binä¸­ï¼›32ä½ç³»ç»Ÿä¸‹ä¸º0x50ï¼Œ64ä½ç³»ç»Ÿä¸‹ä¸º0xA0</strong></p>
</li>
<li><p><strong>NFASTBINS</strong>ï¼šFastbinsä¸­binçš„æ•°é‡ï¼Œç®€å•è®¡ç®—ä¸€ä¸‹ä¾¿å¯çŸ¥<strong>32ä½ä¸‹NFASTBINSä¸º11ï¼Œ64ä½ä¸‹NFASTBINSä¸º10</strong></p>
</li>
</ul>
<h3 id="fastbin-sizeè¯¦è§£"><a href="#fastbin-sizeè¯¦è§£" class="headerlink" title="fastbin sizeè¯¦è§£"></a>fastbin sizeè¯¦è§£</h3><p>éœ€è¦æ³¨æ„çš„æ˜¯è™½ç„¶è¯´å®šä¹‰äº†ä¸€ä¸ªMAX_FAST_SIZEå®è¯´æ˜fastbinæœ€å¤§æ”¯æŒçš„sizeï¼Œä½†å…¶å®<strong>fastbinæ•°ç»„ä¸­çš„bin 7ã€8ã€9éƒ½æ˜¯ç”¨ä¸ä¸Šçš„ï¼Œè¿™æ˜¯å› ä¸ºfastbin chunkçœŸæ­£çš„sizeèŒƒå›´æ˜¯ç”±å¦‚ä¸‹å®è¿›è¡Œå®šä¹‰çš„</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> set_max_fast(s) \</span><br><span class="hljs-meta">  global_max_fast = (((s) == 0)						      \</span><br><span class="hljs-meta">                     ? SMALLBIN_WIDTH : ((s + SIZE_SZ) &amp; ~MALLOC_ALIGN_MASK))</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> get_max_fast() global_max_fast</span><br>...<br><span class="hljs-comment">/* Maximum size of memory handled in fastbins.  */</span><br><span class="hljs-type">static</span> INTERNAL_SIZE_T global_max_fast;<br></code></pre></td></tr></table></figure>

<ul>
<li><strong>global_max_fast</strong>ï¼š<strong>fastbin chunk sizeæœ€å¤§å€¼</strong></li>
<li><strong>set_max_fast</strong> ()ï¼šè®¾ç½®global_max_fastï¼Œ<strong>è‹¥ä¸º0åˆ™åˆå§‹åŒ–ä¸ºSMALLBIN_WIDTH</strong></li>
<li><strong>get_max_fast</strong> ()ï¼šè·å–global_max_fast</li>
</ul>
<p>è€Œ<strong>åœ¨malloc_init_state()å‡½æ•°ä¸­åˆå§‹åŒ–fastbin chunkçš„max sizeä¸ºDEFAULT_MXFASTï¼Œè€Œä¸æ˜¯MAX_FAST_SIZE</strong>ï¼Œåœ¨åé¢çš„éƒ¨åˆ†æˆ‘ä»¬ä¼šè¯¦ç»†è§£æè¿™ä¸ªå‡½æ•°</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">void</span><br><span class="hljs-title function_">malloc_init_state</span> <span class="hljs-params">(mstate av)</span><br>&#123;<br>...<br>  <span class="hljs-keyword">if</span> (av == &amp;main_arena)<br>    set_max_fast (DEFAULT_MXFAST);<br>....<br></code></pre></td></tr></table></figure>

<p>DEFAULT_MXFASTå®šä¹‰å¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> DEFAULT_MXFAST</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> DEFAULT_MXFAST     (64 * SIZE_SZ / 4)</span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br></code></pre></td></tr></table></figure>

<p>ä¹Ÿå°±æ˜¯è¯´<strong>32ä½ä¸‹æœ€å¤§çš„fastbin chunk sizeä¸º0x40ï¼Œ 64ä½ä¸‹æœ€å¤§çš„fastbin chunk sizeä¸º0x80ï¼Œè¶…è¿‡è¿™ä¸ªèŒƒå›´çš„chunkåœ¨freeä¹‹ååˆ™ä¼šè¢«é€å…¥unsorted binä¸­</strong></p>
<h2 id="äº”ã€malloc-parï¼šå †ç®¡ç†å™¨å‚æ•°"><a href="#äº”ã€malloc-parï¼šå †ç®¡ç†å™¨å‚æ•°" class="headerlink" title="äº”ã€malloc_parï¼šå †ç®¡ç†å™¨å‚æ•°"></a>äº”ã€malloc_parï¼šå †ç®¡ç†å™¨å‚æ•°</h2><p>åœ¨ptmallocä¸­ä½¿ç”¨malloc_parç»“æ„ä½“æ¥è®°å½•å †ç®¡ç†å™¨çš„ç›¸å…³å‚æ•°ï¼Œè¯¥ç»“æ„ä½“å®šä¹‰äºmalloc.cä¸­ï¼Œå¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">malloc_par</span></span><br><span class="hljs-class">&#123;</span><br>  <span class="hljs-comment">/* Tunable parameters */</span><br>  <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> trim_threshold;<br>  INTERNAL_SIZE_T top_pad;<br>  INTERNAL_SIZE_T mmap_threshold;<br>  INTERNAL_SIZE_T arena_test;<br>  INTERNAL_SIZE_T arena_max;<br><br>  <span class="hljs-comment">/* Memory map support */</span><br>  <span class="hljs-type">int</span> n_mmaps;<br>  <span class="hljs-type">int</span> n_mmaps_max;<br>  <span class="hljs-type">int</span> max_n_mmaps;<br>  <span class="hljs-comment">/* the mmap_threshold is dynamic, until the user sets</span><br><span class="hljs-comment">     it manually, at which point we need to disable any</span><br><span class="hljs-comment">     dynamic behavior. */</span><br>  <span class="hljs-type">int</span> no_dyn_threshold;<br><br>  <span class="hljs-comment">/* Statistics */</span><br>  INTERNAL_SIZE_T mmapped_mem;<br>  <span class="hljs-comment">/*INTERNAL_SIZE_T  sbrked_mem;*/</span><br>  <span class="hljs-comment">/*INTERNAL_SIZE_T  max_sbrked_mem;*/</span><br>  INTERNAL_SIZE_T max_mmapped_mem;<br>  INTERNAL_SIZE_T max_total_mem;  <span class="hljs-comment">/* only kept for NO_THREADS */</span><br><br>  <span class="hljs-comment">/* First address handed out by MORECORE/sbrk.  */</span><br>  <span class="hljs-type">char</span> *sbrk_base;<br>&#125;;<br></code></pre></td></tr></table></figure>

<p>ä¸»è¦æ˜¯å®šä¹‰äº†å’Œmmapå’Œarenaç›¸å…³çš„ä¸€äº›å‚æ•°ï¼ˆå¦‚æ•°é‡ä¸Šé™ç­‰ï¼‰ï¼Œä»¥åŠsbrkçš„åŸºå€</p>
<h3 id="mp-ï¼šè®°å½•ptmallocç›¸å…³å‚æ•°çš„malloc-parç»“æ„ä½“"><a href="#mp-ï¼šè®°å½•ptmallocç›¸å…³å‚æ•°çš„malloc-parç»“æ„ä½“" class="headerlink" title="mp_ï¼šè®°å½•ptmallocç›¸å…³å‚æ•°çš„malloc_parç»“æ„ä½“"></a>mp_ï¼šè®°å½•ptmallocç›¸å…³å‚æ•°çš„malloc_parç»“æ„ä½“</h3><p>è¯¥é™æ€ç»“æ„ä½“ç”¨ä»¥è®°å½•ptmallocç›¸å…³å‚æ•°ï¼ŒåŒæ ·å®šä¹‰äºmalloc.cä¸­ï¼Œå¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">malloc_par</span> <span class="hljs-title">mp_</span> =</span><br>&#123;<br>  .top_pad = DEFAULT_TOP_PAD,<br>  .n_mmaps_max = DEFAULT_MMAP_MAX,<br>  .mmap_threshold = DEFAULT_MMAP_THRESHOLD,<br>  .trim_threshold = DEFAULT_TRIM_THRESHOLD,<br><span class="hljs-meta">#<span class="hljs-keyword">define</span> NARENAS_FROM_NCORES(n) ((n) * (sizeof (long) == 4 ? 2 : 8))</span><br>  .arena_test = NARENAS_FROM_NCORES (<span class="hljs-number">1</span>)<br>&#125;;<br></code></pre></td></tr></table></figure>

<p>å®å†å±•å¼€çš„ä»£ç å°±ä¸è´´äº†ï¼Œå¤§æ¦‚åšäº†ä»¥ä¸‹å‡ ä»¶äº‹ï¼š</p>
<ul>
<li>è®¾ç½®äº†<code>top_pad</code>ä¸º 0</li>
<li>è®¾ç½®äº†<code>n_maps_max</code>ä¸º 65535</li>
<li>è®¾ç½®äº†<code>mmap_threshold</code>ä¸º 128 * 1024</li>
<li>è®¾ç½®äº†<code>trim_threshold</code>ä¸º 128 * 1024</li>
<li>è®¾ç½®äº†<code>arena_test</code>åœ¨gccä¸­32ä¸‹ä¸º2ï¼Œ64ä½ä¸‹ä¸º8ï¼ˆä¸åŒçš„ç¼–è¯‘å™¨ä¸­longçš„é•¿åº¦å¯èƒ½ä¸åŒï¼Œè¿™é‡Œä»…ä»¥gccä¸ºä¾‹ï¼‰</li>
</ul>
<h2 id="å…­ã€heap-infoï¼šHeap-Header-for-heap-allocated-by-mmap"><a href="#å…­ã€heap-infoï¼šHeap-Header-for-heap-allocated-by-mmap" class="headerlink" title="å…­ã€heap_infoï¼šHeap Header(for heap allocated by mmap)"></a>å…­ã€heap_infoï¼šHeap Header(for heap allocated by mmap)</h2><p>è¯¥ç»“æ„ä½“ç±»å‹å®šä¹‰äºarena.cä¸­ï¼Œå¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/* A heap is a single contiguous memory region holding (coalesceable)</span><br><span class="hljs-comment">   malloc_chunks.  It is allocated with mmap() and always starts at an</span><br><span class="hljs-comment">   address aligned to HEAP_MAX_SIZE.  */</span><br><br><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">heap_info</span></span><br><span class="hljs-class">&#123;</span><br>  mstate ar_ptr; <span class="hljs-comment">/* Arena for this heap. */</span><br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">heap_info</span> *<span class="hljs-title">prev</span>;</span> <span class="hljs-comment">/* Previous heap. */</span><br>  <span class="hljs-type">size_t</span> size;   <span class="hljs-comment">/* Current size in bytes. */</span><br>  <span class="hljs-type">size_t</span> mprotect_size; <span class="hljs-comment">/* Size in bytes that has been mprotected</span><br><span class="hljs-comment">                           PROT_READ|PROT_WRITE.  */</span><br>  <span class="hljs-comment">/* Make sure the following data is properly aligned, particularly</span><br><span class="hljs-comment">     that sizeof (heap_info) + 2 * SIZE_SZ is a multiple of</span><br><span class="hljs-comment">     MALLOC_ALIGNMENT. */</span><br>  <span class="hljs-type">char</span> pad[<span class="hljs-number">-6</span> * SIZE_SZ &amp; MALLOC_ALIGN_MASK];<br>&#125; heap_info;<br></code></pre></td></tr></table></figure>

<p><strong>heap_infoä½äºä¸€ä¸ªheapå—çš„å¼€å¤´ï¼Œ</strong>ç”¨ä»¥è®°å½•<strong>é€šè¿‡mmapç³»ç»Ÿè°ƒç”¨ä»Memory Mapping Segmentå¤„ç”³è¯·åˆ°çš„å†…å­˜å—çš„ä¿¡æ¯</strong></p>
<p><strong>heap_infoä¹‹é—´é“¾æ¥æˆä¸€ä¸ªå•å‘é“¾è¡¨</strong></p>
<p>å…¶ä¸­æœ‰ä¸€ä¸ªmstateç±»å‹ï¼Œå®šä¹‰äºinclude&#x2F;malloc.hä¸­ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> _MALLOC_H</span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;malloc/malloc.h&gt;</span></span><br><br><br><span class="hljs-comment">/* In the GNU libc we rename the global variable</span><br><span class="hljs-comment">   `__malloc_initialized&#x27; to `__libc_malloc_initialized&#x27;.  */</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> __malloc_initialized __libc_malloc_initialized</span><br><span class="hljs-comment">/* Nonzero if the malloc is already initialized.  */</span><br><span class="hljs-keyword">extern</span> <span class="hljs-type">int</span> __malloc_initialized attribute_hidden;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">malloc_state</span>;</span><br><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">malloc_state</span> *<span class="hljs-title">mstate</span>;</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br></code></pre></td></tr></table></figure>

<p>ä¹Ÿå°±æ˜¯è¯´mstateå…¶å®æ˜¯<strong>æŒ‡å‘malloc_stateç»“æ„ä½“çš„æŒ‡é’ˆ</strong>çš„typedefåˆ«åï¼Œå³<strong>æŒ‡å‘arenaçš„æŒ‡é’ˆ</strong></p>
<p>ç»“åˆæ³¨é‡Šæˆ‘ä»¬å¯ä»¥å¾—å‡ºheap_infoç»“æ„ä½“çš„æˆå‘˜å¦‚ä¸‹ï¼š</p>
<ul>
<li><strong>ar_ptr</strong>ï¼šæŒ‡å‘ç®¡ç†è¯¥å †å—çš„arena</li>
<li><strong>prev</strong>ï¼šè¯¥heap_infoæ‰€é“¾æ¥çš„ä¸Šä¸€ä¸ªheap_info</li>
<li><strong>size</strong>ï¼šè®°å½•è¯¥å †å—çš„å¤§å°</li>
<li><strong>mprotect_size</strong>ï¼šè®°å½•è¯¥å †å—ä¸­è¢«ä¿æŠ¤ï¼ˆmprotectedï¼‰çš„å¤§å°</li>
<li><strong>pad</strong>ï¼šå³paddingï¼Œç”¨ä»¥<strong>åœ¨SIZE_SZä¸æ­£å¸¸çš„æƒ…å†µä¸‹è¿›è¡Œå¡«å……ä»¥è®©å†…å­˜å¯¹é½</strong>ï¼Œ<strong>æ­£å¸¸æƒ…å†µä¸‹padæ‰€å ç”¨ç©ºé—´åº”ä¸º0å­—èŠ‚</strong></li>
</ul>
<p>é‚£ä¹ˆæˆ‘ä»¬å¯ä»¥å¾—å‡ºä½¿ç”¨mmapç³»ç»Ÿè°ƒç”¨åˆ†é…çš„ä¸€ä¸ªheapçš„ç»“æ„åº”å½“å¦‚ä¸‹ï¼š</p>
<p><img src="https://i.loli.net/2021/01/14/vgjIJmEwQu6crLB.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p>æ›´å¤šçš„ä¼šåœ¨åç»­è®²åˆ°ç›¸å…³å‡½æ•°æ—¶è¯´åˆ°</p>
<h3 id="heap-infoç›¸å…³å®"><a href="#heap-infoç›¸å…³å®" class="headerlink" title="heap_infoç›¸å…³å®"></a>heap_infoç›¸å…³å®</h3><p>arena.cä¸­è¿˜å®šä¹‰äº†ä¸€äº›ç›¸å…³çš„å®ï¼Œå¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> HEAP_MIN_SIZE (32 * 1024)</span><br><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> HEAP_MAX_SIZE</span><br><span class="hljs-meta"># <span class="hljs-keyword">ifdef</span> DEFAULT_MMAP_THRESHOLD_MAX</span><br><span class="hljs-meta">#  <span class="hljs-keyword">define</span> HEAP_MAX_SIZE (2 * DEFAULT_MMAP_THRESHOLD_MAX)</span><br><span class="hljs-meta"># <span class="hljs-keyword">else</span></span><br><span class="hljs-meta">#  <span class="hljs-keyword">define</span> HEAP_MAX_SIZE (1024 * 1024) <span class="hljs-comment">/* must be a power of two */</span></span><br><span class="hljs-meta"># <span class="hljs-keyword">endif</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br><span class="hljs-comment">/* HEAP_MIN_SIZE and HEAP_MAX_SIZE limit the size of mmap()ed heaps</span><br><span class="hljs-comment">   that are dynamically created for multi-threaded programs.  The</span><br><span class="hljs-comment">   maximum size must be a power of two, for fast determination of</span><br><span class="hljs-comment">   which heap belongs to a chunk.  It should be much larger than the</span><br><span class="hljs-comment">   mmap threshold, so that requests with a size just below that</span><br><span class="hljs-comment">   threshold can be fulfilled without creating too many heaps.  */</span><br><br></code></pre></td></tr></table></figure>

<ul>
<li><p><strong>HEAP_MIN_SIZE</strong>ï¼šç”¨mmapæ‰€åˆ†é…çš„å †å—çš„æœ€å°å¤§å°ï¼Œåº”å½“ä¸º<code>32 * 1024</code></p>
</li>
<li><p><strong>HEAP_MAX_SIZE</strong>ï¼šç”¨mmapæ‰€åˆ†é…çš„å †å—çš„æœ€å¤§å¤§å°ï¼Œè¿™ä¸ªå€¼ç”±<code>DEFAULE_MMAP_THRESHOLD_MAX</code>å®å†³å®šï¼Œè¯¥å®å®šä¹‰äºmalloc.cä¸­ï¼Œå¦‚ä¸‹ï¼š</p>
</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> DEFAULT_MMAP_THRESHOLD_MAX</span><br>  <span class="hljs-comment">/* For 32-bit platforms we cannot increase the maximum mmap</span><br><span class="hljs-comment">     threshold much because it is also the minimum value for the</span><br><span class="hljs-comment">     maximum heap size and its alignment.  Going above 512k (i.e., 1M</span><br><span class="hljs-comment">     for new heaps) wastes too much address space.  */</span><br><span class="hljs-meta"># <span class="hljs-keyword">if</span> __WORDSIZE == 32</span><br><span class="hljs-meta">#  <span class="hljs-keyword">define</span> DEFAULT_MMAP_THRESHOLD_MAX (512 * 1024)</span><br><span class="hljs-meta"># <span class="hljs-keyword">else</span></span><br><span class="hljs-meta">#  <span class="hljs-keyword">define</span> DEFAULT_MMAP_THRESHOLD_MAX (4 * 1024 * 1024 * sizeof(long))</span><br><span class="hljs-meta"># <span class="hljs-keyword">endif</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br></code></pre></td></tr></table></figure>

<p>__WORDSIZEå®æ‰€è·å–çš„æ˜¯å­—é•¿çš„ä½æ•°ï¼Œå®šä¹‰äºsysdeps&#x2F;x86&#x2F;bits&#x2F;wordsize.hä¸‹ï¼Œè¿™é‡Œä¾¿ä¸å†èµ˜å™</p>
<p>é‚£ä¹ˆæˆ‘ä»¬ä¾¿å¯ä»¥å¾—çŸ¥åœ¨32ä½ä¸‹mmapæ‰€åˆ†é…çš„å †å—çš„æœ€å¤§å¤§å°åº”å½“ä¸º<code>2 * 512 * 1024</code>ï¼Œ64ä½ä¸‹åº”å½“ä¸º<code>2 * 4 * 1024 * 1024 * (sizeof(long)) </code></p>
<p>ç”±äºä½¿ç”¨mmapåˆ†é…çš„å †å—çš„å¤§å°æ˜¯å¯¹äºHEAP_MAX_SIZEå¯¹é½çš„ï¼Œæ•…é€šè¿‡æ­¤ç‰¹ç‚¹å¯ä»¥é€šè¿‡æŒ‡å‘å †å—ä¸ŠæŸä½ç½®çš„æŒ‡é’ˆç›´æ¥è·å–åˆ°ä¸€ä¸ªæŒ‡å‘è¯¥å †å—çš„æŒ‡é’ˆï¼Œå› æ­¤ä¹Ÿå®šä¹‰äº†ç›¸å…³å®ï¼Œå¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/* find the heap and corresponding arena for a given ptr */</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> heap_for_ptr(ptr) \</span><br><span class="hljs-meta">  ((heap_info *) ((unsigned long) (ptr) &amp; ~(HEAP_MAX_SIZE - 1)))</span><br></code></pre></td></tr></table></figure>

<p>è¯¥å®ç”¨ä»¥é€šè¿‡ä¸€ä¸ªæŒ‡å‘æŸå †å—ä¸ŠæŸä½ç½®çš„æŒ‡é’ˆè·å–åˆ°æŒ‡å‘è¯¥å †å—çš„æŒ‡é’ˆ</p>
<h2 id="ä¸ƒã€arenaï¼šçº¿ç¨‹å†…å­˜æ± "><a href="#ä¸ƒã€arenaï¼šçº¿ç¨‹å†…å­˜æ± " class="headerlink" title="ä¸ƒã€arenaï¼šçº¿ç¨‹å†…å­˜æ± "></a>ä¸ƒã€arenaï¼šçº¿ç¨‹å†…å­˜æ± </h2><p>ä»æœ€å°çš„chunkå¼€å§‹è‡ªåº•å‘ä¸Šåˆ†æç°åœ¨ç»ˆäºåˆ°äº†åˆ†æarenaçš„æºç çš„æ—¶å€™ï¼Œarenaè¿™ä¸ªè¯ç›´è¯‘æ˜¯â€œç«æŠ€åœºâ€çš„æ„æ€ï¼Œ<del>wsmè¦èµ·è¿™ç§å¥‡æ€ªçš„åå­—æˆ‘ä¹Ÿä¸çŸ¥é“ï¼Œå¯èƒ½æ˜¯å› ä¸ºå¬èµ·æ¥æ¯”è¾ƒå¸…æ°”å§</del>ï¼ŒæŒ‰ç…§ç¬”è€…çš„ç†è§£ï¼Œarenaåœ¨ptmallocä¸­ç”¨ä»¥è¡¨ç¤º<strong>ã€Œå•ä¸ªçº¿ç¨‹ç‹¬ç«‹ç»´æŠ¤çš„å†…å­˜æ± ã€</strong>ï¼Œè¿™æ˜¯ç”±äºå¤§éƒ¨åˆ†æƒ…å†µä¸‹å¯¹äºæ¯ä¸ªçº¿ç¨‹è€Œè¨€å…¶éƒ½ä¼šå•ç‹¬æœ‰ç€ä¸€ä¸ªarenaå®ä¾‹ç”¨ä»¥ç®¡ç†å±äºè¯¥çº¿ç¨‹çš„å †å†…å­˜åŒºåŸŸï¼ŒåŒ…æ‹¬Binsã€Fastbinç­‰å…¶å®éƒ½æ˜¯è¢«æ”¾ç½®åœ¨arenaçš„ç»“æ„ä½“ä¸­ç»Ÿä¸€è¿›è¡Œç®¡ç†çš„</p>
<p>åœ¨malloc.cä¸­å¯¹äºptmallocçš„å†…éƒ¨æ•°æ®ç»“æ„è¯´æ˜å¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/*</span><br><span class="hljs-comment">   -------------------- Internal data structures --------------------</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">   All internal state is held in an instance of malloc_state defined</span><br><span class="hljs-comment">   below. There are no other static variables, except in two optional</span><br><span class="hljs-comment">   cases:</span><br><span class="hljs-comment"> * If USE_MALLOC_LOCK is defined, the mALLOC_MUTEx declared above.</span><br><span class="hljs-comment"> * If mmap doesn&#x27;t support MAP_ANONYMOUS, a dummy file descriptor</span><br><span class="hljs-comment">     for mmap.</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">   Beware of lots of tricks that minimize the total bookkeeping space</span><br><span class="hljs-comment">   requirements. The result is a little over 1K bytes (for 4byte</span><br><span class="hljs-comment">   pointers and size_t.)</span><br><span class="hljs-comment"> */</span><br></code></pre></td></tr></table></figure>

<p>ptmallocå†…éƒ¨çš„å†…å­˜æ± ç»“æ„æ˜¯ç”±malloc_stateç»“æ„ä½“è¿›è¡Œå®šä¹‰çš„ï¼Œå³arenaæœ¬èº«ä¾¿ä¸ºmalloc_stateçš„ä¸€ä¸ªå®ä¾‹å¯¹è±¡</p>
<h3 id="1-malloc-stateç»“æ„ä½“"><a href="#1-malloc-stateç»“æ„ä½“" class="headerlink" title="1.malloc_stateç»“æ„ä½“"></a>1.malloc_stateç»“æ„ä½“</h3><p>malloc_stateç»“æ„ä½“å®šä¹‰äºmalloc&#x2F;malloc.cä¸­ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">malloc_state</span></span><br><span class="hljs-class">&#123;</span><br>  <span class="hljs-comment">/* Serialize access.  */</span><br>  <span class="hljs-type">mutex_t</span> mutex;<br><br>  <span class="hljs-comment">/* Flags (formerly in max_fast).  */</span><br>  <span class="hljs-type">int</span> flags;<br><br>  <span class="hljs-comment">/* Fastbins */</span><br>  mfastbinptr fastbinsY[NFASTBINS];<br><br>  <span class="hljs-comment">/* Base of the topmost chunk -- not otherwise kept in a bin */</span><br>  mchunkptr top;<br><br>  <span class="hljs-comment">/* The remainder from the most recent split of a small request */</span><br>  mchunkptr last_remainder;<br><br>  <span class="hljs-comment">/* Normal bins packed as described above */</span><br>  mchunkptr bins[NBINS * <span class="hljs-number">2</span> - <span class="hljs-number">2</span>];<br><br>  <span class="hljs-comment">/* Bitmap of bins */</span><br>  <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> binmap[BINMAPSIZE];<br><br>  <span class="hljs-comment">/* Linked list */</span><br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">malloc_state</span> *<span class="hljs-title">next</span>;</span><br><br>  <span class="hljs-comment">/* Linked list for free arenas.  Access to this field is serialized</span><br><span class="hljs-comment">     by free_list_lock in arena.c.  */</span><br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">malloc_state</span> *<span class="hljs-title">next_free</span>;</span><br><br>  <span class="hljs-comment">/* Number of threads attached to this arena.  0 if the arena is on</span><br><span class="hljs-comment">     the free list.  Access to this field is serialized by</span><br><span class="hljs-comment">     free_list_lock in arena.c.  */</span><br>  INTERNAL_SIZE_T attached_threads;<br><br>  <span class="hljs-comment">/* Memory allocated from the system in this arena.  */</span><br>  INTERNAL_SIZE_T system_mem;<br>  INTERNAL_SIZE_T max_system_mem;<br>&#125;;<br></code></pre></td></tr></table></figure>

<h4 id="â‘ mutexï¼šäº’æ–¥é”"><a href="#â‘ mutexï¼šäº’æ–¥é”" class="headerlink" title="â‘ mutexï¼šäº’æ–¥é”"></a>â‘ mutexï¼šäº’æ–¥é”</h4><p>ä»å®šä¹‰ä¸­æˆ‘ä»¬ä¸éš¾è¯»å‡º<strong>mutexå˜é‡å³ä¸ºå¤šçº¿ç¨‹äº’æ–¥é”</strong>ï¼Œç”¨ä»¥ä¿è¯çº¿ç¨‹å®‰å…¨</p>
<blockquote>
<p> ptmallocä¸­æœ‰ç€å¯¹å¤šçº¿ç¨‹çš„æ”¯æŒ</p>
</blockquote>
<h4 id="â‘¡flagsï¼šæ ‡å¿—ä½"><a href="#â‘¡flagsï¼šæ ‡å¿—ä½" class="headerlink" title="â‘¡flagsï¼šæ ‡å¿—ä½"></a>â‘¡flagsï¼šæ ‡å¿—ä½</h4><p>æ¥ä¸‹æ¥æ˜¯ä¸€ä¸ªæ•´å½¢å˜é‡flagsï¼Œå³æ ‡å¿—ä½ï¼Œç”¨ä»¥è¡¨ç¤ºarenaçš„ä¸€äº›çŠ¶æ€ï¼Œå¦‚ï¼šæ˜¯å¦æœ‰fastbinã€å†…å­˜æ˜¯å¦è¿ç»­ç­‰</p>
<blockquote>
<h5 id="flagsæ ‡å¿—ä½ç›¸å…³"><a href="#flagsæ ‡å¿—ä½ç›¸å…³" class="headerlink" title="flagsæ ‡å¿—ä½ç›¸å…³"></a>flagsæ ‡å¿—ä½ç›¸å…³</h5><p>ä¸ºäº†èŠ‚çœç©ºé—´ï¼Œglibcå……åˆ†åœ°ä½¿ç”¨äº†ç”¨æ¯ä¸€ä½(bit)æ¥è¡¨ç¤ºä¸åŒçŠ¶æ€çš„æ€æƒ³ï¼Œä¸chunkçš„sizeçš„æ ‡å¿—ä½å¼‚æ›²åŒå·¥</p>
<p>ç›¸å…³ä»£ç å¦‚ä¸‹</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/*</span><br><span class="hljs-comment">FASTCHUNKS_BIT held in max_fast indicates that there are probably</span><br><span class="hljs-comment">some fastbin chunks. It is set true on entering a chunk into any</span><br><span class="hljs-comment">fastbin, and cleared only in malloc_consolidate.</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">The truth value is inverted so that have_fastchunks will be true</span><br><span class="hljs-comment">upon startup (since statics are zero-filled), simplifying</span><br><span class="hljs-comment">initialization checks.</span><br><span class="hljs-comment">*/</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> FASTCHUNKS_BIT        (1U)</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> have_fastchunks(M)     (((M)-&gt;flags &amp; FASTCHUNKS_BIT) == 0)</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> clear_fastchunks(M)    catomic_or (&amp;(M)-&gt;flags, FASTCHUNKS_BIT)</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> set_fastchunks(M)      catomic_and (&amp;(M)-&gt;flags, ~FASTCHUNKS_BIT)</span><br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment">NONCONTIGUOUS_BIT indicates that MORECORE does not return contiguous</span><br><span class="hljs-comment">regions.  Otherwise, contiguity is exploited in merging together,</span><br><span class="hljs-comment">when possible, results from consecutive MORECORE calls.</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">The initial value comes from MORECORE_CONTIGUOUS, but is</span><br><span class="hljs-comment">changed dynamically if mmap is ever used as an sbrk substitute.</span><br><span class="hljs-comment">*/</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> NONCONTIGUOUS_BIT     (2U)</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> contiguous(M)          (((M)-&gt;flags &amp; NONCONTIGUOUS_BIT) == 0)</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> noncontiguous(M)       (((M)-&gt;flags &amp; NONCONTIGUOUS_BIT) != 0)</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> set_noncontiguous(M)   ((M)-&gt;flags |= NONCONTIGUOUS_BIT)</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> set_contiguous(M)      ((M)-&gt;flags &amp;= ~NONCONTIGUOUS_BIT)</span><br><br><span class="hljs-comment">/* ARENA_CORRUPTION_BIT is set if a memory corruption was detected on the</span><br><span class="hljs-comment">arena.  Such an arena is no longer used to allocate chunks.  Chunks</span><br><span class="hljs-comment">allocated in that arena before detecting corruption are not freed.  */</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> ARENA_CORRUPTION_BIT (4U)</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> arena_is_corrupt(A)	(((A)-&gt;flags &amp; ARENA_CORRUPTION_BIT))</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> set_arena_corrupt(A)	((A)-&gt;flags |= ARENA_CORRUPTION_BIT)</span><br></code></pre></td></tr></table></figure>

<p>ä»…ä½¿ç”¨äº†flagsçš„ä½ä¸‰ä½ä½œä¸ºæ ‡å¿—ä½ï¼Œä»ä½ä½åˆ°é«˜ä½çš„å«ä¹‰å¦‚ä¸‹ï¼š</p>
<ul>
<li>æ˜¯å¦<strong>ä¸å­˜åœ¨fastbin chunk</strong></li>
<li>æ˜¯å¦<strong>ä¸å­˜åœ¨</strong>è¿ç»­å†…å­˜ï¼ˆå—ï¼‰</li>
<li>arenaæ˜¯å¦<strong>è¢«ç ´å</strong></li>
</ul>
<p>å¹¶å®šä¹‰äº†ç›¸å…³çš„<strong>è·å–&amp;æ”¹å˜æ ‡å¿—ä½</strong>çš„å®</p>
</blockquote>
<h4 id="â‘¢fastbinYï¼šå­˜æ”¾fastbin-chunkçš„æ•°ç»„"><a href="#â‘¢fastbinYï¼šå­˜æ”¾fastbin-chunkçš„æ•°ç»„" class="headerlink" title="â‘¢fastbinYï¼šå­˜æ”¾fastbin chunkçš„æ•°ç»„"></a>â‘¢fastbinYï¼šå­˜æ”¾fastbin chunkçš„æ•°ç»„</h4><p>é¦–å…ˆæ˜¯fastbinä¸­æ‰€ç”¨çš„mchunkptrç±»å‹ï¼Œå®šä¹‰å¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/* Forward declarations.  */</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">malloc_chunk</span>;</span><br><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">malloc_chunk</span>* <span class="hljs-title">mchunkptr</span>;</span><br></code></pre></td></tr></table></figure>

<p>å³mchunkpträ¸º<strong>æŒ‡å‘malloc_chunk</strong>ç»“æ„ä½“çš„æŒ‡é’ˆ<del>å¥—å¨ƒeveryday</del>ï¼Œä¹Ÿå°±æ˜¯è¯´fastbinYæ˜¯ä¸€ä¸ªæŒ‡é’ˆæ•°ç»„ï¼Œç”¨ä»¥å­˜æ”¾æŒ‡å‘malloc_chunkç±»å‹çš„æŒ‡é’ˆ</p>
<p>æ— è®ºæ˜¯ä»æ³¨é‡Šè¿˜æ˜¯ä»åå­—ä¸­æˆ‘ä»¬éƒ½å¯ä»¥çŸ¥é“<strong>è¿™ä¸ªæ•°ç»„ä¾¿æ˜¯fastbin</strong></p>
<h4 id="â‘£topï¼šæŒ‡å‘Top-Chunkçš„æŒ‡é’ˆ"><a href="#â‘£topï¼šæŒ‡å‘Top-Chunkçš„æŒ‡é’ˆ" class="headerlink" title="â‘£topï¼šæŒ‡å‘Top Chunkçš„æŒ‡é’ˆ"></a>â‘£topï¼šæŒ‡å‘Top Chunkçš„æŒ‡é’ˆ</h4><p>Top Chunkæ˜¯æ‰€æœ‰chunkä¸­è¾ƒä¸ºç‰¹æ®Šçš„ä¸€ä¸ªchunkï¼Œç”±äºç³»ç»Ÿè°ƒç”¨çš„å¼€é”€è¾ƒå¤§ï¼Œæ•…ä¸€èˆ¬æƒ…å†µä¸‹mallocéƒ½ä¸ä¼šé¢‘ç¹åœ°ç›´æ¥è°ƒç”¨brkç³»ç»Ÿè°ƒç”¨å¼€è¾Ÿå †å†…å­˜ç©ºé—´ï¼Œè€Œæ˜¯ä¼šåœ¨ä¸€å¼€å§‹æ—¶å…ˆå‘ç³»ç»Ÿç”³è¯·ä¸€ä¸ªè¾ƒå¤§çš„Top Chunkï¼Œåç»­éœ€è¦å–ç”¨å†…å­˜æ—¶ä¾¿ä»Top chunkä¸­åˆ‡å‰²ï¼Œç›´åˆ°Top chunkä¸è¶³ä»¥åˆ†é…æ‰€éœ€å¤§å°çš„chunkæ—¶æ‰ä¼šè¿›è¡Œç³»ç»Ÿè°ƒç”¨</p>
<p>å…³äºTop Chunkçš„ç›¸å…³äº‹å®œä¼šåœ¨åç»­åˆ†æå†…å­˜åˆ†é…æœºåˆ¶æ—¶è¯¦ç»†è¯´æ˜</p>
<h4 id="â‘¤last-remainderï¼šchunkåˆ‡å‰²ä¸­çš„å‰©ä½™éƒ¨åˆ†"><a href="#â‘¤last-remainderï¼šchunkåˆ‡å‰²ä¸­çš„å‰©ä½™éƒ¨åˆ†" class="headerlink" title="â‘¤last_remainderï¼šchunkåˆ‡å‰²ä¸­çš„å‰©ä½™éƒ¨åˆ†"></a>â‘¤last_remainderï¼šchunkåˆ‡å‰²ä¸­çš„å‰©ä½™éƒ¨åˆ†</h4><p>mallocåœ¨åˆ†é…chunkæ—¶è‹¥æ˜¯æ²¡æ‰¾åˆ°sizeåˆé€‚çš„chunkè€Œæ˜¯æ‰¾åˆ°äº†ä¸€ä¸ªsizeæ›´å¤§çš„chunkï¼Œåˆ™ä¼š<strong>ä»å¤§chunkä¸­åˆ‡å‰²æ‰ä¸€å—è¿”å›ç»™ç”¨æˆ·ï¼Œå‰©ä¸‹çš„é‚£ä¸€å—ä¾¿æ˜¯last_remainderï¼Œå…¶éšåä¼šè¢«æ”¾å…¥unsorted binä¸­</strong>ï¼Œç›¸å…³äº‹å®œä¹Ÿä¼šåœ¨åç»­åˆ†æå†…å­˜åˆ†é…æœºåˆ¶æ—¶è¯¦ç»†è¯´æ˜</p>
<h4 id="â‘¥binsï¼šå­˜æ”¾é—²ç½®chunkçš„æ•°ç»„"><a href="#â‘¥binsï¼šå­˜æ”¾é—²ç½®chunkçš„æ•°ç»„" class="headerlink" title="â‘¥binsï¼šå­˜æ”¾é—²ç½®chunkçš„æ•°ç»„"></a>â‘¥binsï¼šå­˜æ”¾é—²ç½®chunkçš„æ•°ç»„</h4><p>è¿™ä¸ªbinsä¾¿æ˜¯æˆ‘ä»¬å…ˆå‰æ‰€è¯´çš„ç”¨ä»¥å­˜æ”¾é—²ç½®chunkçš„æŒ‡é’ˆæ•°ç»„ï¼Œåœ¨è¿™é‡Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°å…¶ä¸€å…±æœ‰NBINS x 2 - 2ä¸ªå…ƒç´ ï¼Œå³<strong>ä¸€å…±æœ‰NBINS - 1ä¸ªbinï¼Œä¹Ÿå°±æ˜¯127ä¸ªbinï¼Œè€Œbin0ä¸å­˜åœ¨ï¼Œæ•…åº”å½“æœ‰126ä¸ªbinï¼Œå…¶ä¸­åŒ…å«1ä¸ªunsorted binï¼Œ 62ä¸ªsmall binï¼Œ 63ä¸ªlarge bin</strong></p>
<h4 id="â‘¦binmapï¼šç”¨ä»¥è¡¨ç¤ºbinmapçš„æ•°ç»„"><a href="#â‘¦binmapï¼šç”¨ä»¥è¡¨ç¤ºbinmapçš„æ•°ç»„" class="headerlink" title="â‘¦binmapï¼šç”¨ä»¥è¡¨ç¤ºbinmapçš„æ•°ç»„"></a>â‘¦binmapï¼šç”¨ä»¥è¡¨ç¤ºbinmapçš„æ•°ç»„</h4><p>binmapç”¨ä»¥æ ‡è®°ä¸€ä¸ªbinä¸­æ˜¯å¦æœ‰chunkä»¥æ–¹ä¾¿æ£€ç´¢ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯chunkè¢«å–å‡ºåè‹¥ä¸€ä¸ªbinç©ºäº†å¹¶ä¸ä¼šç«‹å³è¢«ç½®0ï¼Œè€Œä¼šåœ¨ä¸‹ä¸€æ¬¡éå†åˆ°æ—¶é‡æ–°ç½®ä½</p>
<p><strong>â€»fastbinä¸ä½¿ç”¨binmapæ ‡å¿—ä½â€»</strong></p>
<h4 id="â‘§nextï¼šæŒ‡å‘ä¸‹ä¸€ä¸ªarenaçš„æŒ‡é’ˆ"><a href="#â‘§nextï¼šæŒ‡å‘ä¸‹ä¸€ä¸ªarenaçš„æŒ‡é’ˆ" class="headerlink" title="â‘§nextï¼šæŒ‡å‘ä¸‹ä¸€ä¸ªarenaçš„æŒ‡é’ˆ"></a>â‘§nextï¼šæŒ‡å‘ä¸‹ä¸€ä¸ªarenaçš„æŒ‡é’ˆ</h4><p>ä¸€ä¸ªè¿›ç¨‹å†…æ‰€æœ‰çš„arenaä¸²æˆäº†ä¸€æ¡å¾ªç¯å•å‘é“¾è¡¨ï¼Œmalloc_stateä¸­çš„nextæŒ‡é’ˆä¾¿æ˜¯ç”¨ä»¥æŒ‡å‘ä¸‹ä¸€ä¸ªarenaï¼Œæ–¹ä¾¿åç»­çš„éå†arenaçš„æ“ä½œï¼ˆå› ä¸ºä¸æ˜¯æ‰€æœ‰çš„çº¿ç¨‹éƒ½æœ‰è‡ªå·±ç‹¬ç«‹çš„arenaï¼‰</p>
<h4 id="â‘¨next-freeï¼šæŒ‡å‘ä¸‹ä¸€ä¸ªç©ºé—²çš„arenaçš„æŒ‡é’ˆ"><a href="#â‘¨next-freeï¼šæŒ‡å‘ä¸‹ä¸€ä¸ªç©ºé—²çš„arenaçš„æŒ‡é’ˆ" class="headerlink" title="â‘¨next_freeï¼šæŒ‡å‘ä¸‹ä¸€ä¸ªç©ºé—²çš„arenaçš„æŒ‡é’ˆ"></a>â‘¨next_freeï¼šæŒ‡å‘ä¸‹ä¸€ä¸ªç©ºé—²çš„arenaçš„æŒ‡é’ˆ</h4><p>ä¸nextæŒ‡é’ˆç±»ä¼¼ï¼Œåªä¸è¿‡æŒ‡å‘çš„æ˜¯ç©ºé—²çš„arenaï¼ˆå³æ²¡æœ‰è¢«ä»»ä¸€çº¿ç¨‹æ‰€å ç”¨ï¼‰ï¼Œè¿™é‡Œä¾¿ä¸å†èµ˜å™</p>
<h4 id="â‘©attached-threadsï¼šä¸è¯¥arenaç›¸å…³è”çš„çº¿ç¨‹æ•°"><a href="#â‘©attached-threadsï¼šä¸è¯¥arenaç›¸å…³è”çš„çº¿ç¨‹æ•°" class="headerlink" title="â‘©attached_threadsï¼šä¸è¯¥arenaç›¸å…³è”çš„çº¿ç¨‹æ•°"></a>â‘©attached_threadsï¼šä¸è¯¥arenaç›¸å…³è”çš„çº¿ç¨‹æ•°</h4><p>è¯¥å˜é‡ç”¨ä»¥è¡¨ç¤ºæœ‰å¤šå°‘ä¸ªçº¿ç¨‹ä¸è¯¥arenaç›¸å…³è”ï¼Œè¿™æ˜¯å› ä¸ºaernaçš„æ•°é‡æ˜¯æœ‰é™çš„ï¼Œå¹¶éæ¯ä¸€ä¸ªçº¿ç¨‹éƒ½æœ‰æœºä¼šåˆ†é…åˆ°ä¸€ä¸ªarenaï¼Œåœ¨çº¿ç¨‹æ•°é‡è¾ƒå¤§çš„æƒ…å†µä¸‹ä¼šå­˜åœ¨ç€å¤šä¸ªçº¿ç¨‹å…±ç”¨ä¸€ä¸ªarenaçš„æƒ…å†µ</p>
<h4 id="â‘ªsystem-memï¼šè®°å½•å½“å‰arenaåœ¨å †åŒºä¸­æ‰€åˆ†é…åˆ°çš„å†…å­˜çš„æ€»å¤§å°"><a href="#â‘ªsystem-memï¼šè®°å½•å½“å‰arenaåœ¨å †åŒºä¸­æ‰€åˆ†é…åˆ°çš„å†…å­˜çš„æ€»å¤§å°" class="headerlink" title="â‘ªsystem_memï¼šè®°å½•å½“å‰arenaåœ¨å †åŒºä¸­æ‰€åˆ†é…åˆ°çš„å†…å­˜çš„æ€»å¤§å°"></a>â‘ªsystem_memï¼šè®°å½•å½“å‰arenaåœ¨å †åŒºä¸­æ‰€åˆ†é…åˆ°çš„å†…å­˜çš„æ€»å¤§å°</h4><p>è¯¥å˜é‡ç”¨ä»¥è®°å½•è®°å½•å½“å‰arenaåœ¨å †åŒºä¸­æ‰€åˆ†é…åˆ°çš„å†…å­˜çš„æ€»å¤§å°ï¼Œ<del>ä¼¼ä¹åªåœ¨è¿›è¡Œäº†ç³»ç»Ÿè°ƒç”¨brkè°ƒæ•´å †åŒºå¤§å°æ—¶ä¼šåˆ·ä¸€æ³¢å­˜åœ¨æ„Ÿ</del></p>
<blockquote>
<p>æŒ‰ç¬”è€…è‡ªå·±æµ‹è¯•64ä½ä¸‹è¿™ä¸ªå€¼ä¼¼ä¹æ˜¯0x21000çš„æ•´æ•°å€ï¼Œåé¢ç»§ç»­åˆ†ææºç çš„æ—¶å€™åº”è¯¥ä¼šçŸ¥é“ä¸ºä»€ä¹ˆ</p>
</blockquote>
<h4 id="â‘«-max-system-memï¼šè®°å½•å½“å‰arenaåœ¨å †åŒºä¸­æ‰€åˆ†é…åˆ°çš„å†…å­˜çš„æ€»å¤§å°çš„æœ€å¤§å€¼"><a href="#â‘«-max-system-memï¼šè®°å½•å½“å‰arenaåœ¨å †åŒºä¸­æ‰€åˆ†é…åˆ°çš„å†…å­˜çš„æ€»å¤§å°çš„æœ€å¤§å€¼" class="headerlink" title="â‘« max_system_memï¼šè®°å½•å½“å‰arenaåœ¨å †åŒºä¸­æ‰€åˆ†é…åˆ°çš„å†…å­˜çš„æ€»å¤§å°çš„æœ€å¤§å€¼"></a>â‘« max_system_memï¼šè®°å½•å½“å‰arenaåœ¨å †åŒºä¸­æ‰€åˆ†é…åˆ°çš„å†…å­˜çš„æ€»å¤§å°çš„æœ€å¤§å€¼</h4><p>å½“æ“ä½œç³»ç»Ÿäºˆè¿›ç¨‹ä»¥å†…å­˜æ—¶ï¼Œsystem_memä¼šéšä¹‹å¢å¤§ï¼Œå½“å†…å­˜è¢«è¿”è¿˜ç»™æ“ä½œç³»ç»Ÿæ—¶ï¼Œsysyetm_memä¼šéšä¹‹å‡å°ï¼Œ<strong>max_system_memå˜é‡ä¾¿æ˜¯ç”¨æ¥è®°å½•åœ¨è¿™ä¸ªè¿‡ç¨‹å½“ä¸­system_memçš„å³°å€¼</strong></p>
<h3 id="2-arenaç›¸å…³å˜é‡"><a href="#2-arenaç›¸å…³å˜é‡" class="headerlink" title="2.arenaç›¸å…³å˜é‡"></a>2.arenaç›¸å…³å˜é‡</h3><p>åœ¨malloc&#x2F;arena.cä¸­å®šä¹‰äº†arenaç›¸å…³çš„ä¸€äº›å˜é‡ï¼Œå¦‚ä¸‹ï¼š</p>
<h4 id="â‘ thread-arenaï¼šæ¯ä¸ªçº¿ç¨‹æ‰€å¯¹åº”çš„arena"><a href="#â‘ thread-arenaï¼šæ¯ä¸ªçº¿ç¨‹æ‰€å¯¹åº”çš„arena" class="headerlink" title="â‘ thread_arenaï¼šæ¯ä¸ªçº¿ç¨‹æ‰€å¯¹åº”çš„arena"></a>â‘ thread_arenaï¼šæ¯ä¸ªçº¿ç¨‹æ‰€å¯¹åº”çš„arena</h4><p>é¦–å…ˆæˆ‘ä»¬å…ˆçœ‹thread_arenaï¼Œè¿™æ˜¯ä¸€ä¸ªå®šä¹‰äºarena.cä¸­çš„å˜é‡ï¼Œå¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/* Thread specific data.  */</span><br><br><span class="hljs-type">static</span> __thread mstate thread_arena attribute_tls_model_ie;<br></code></pre></td></tr></table></figure>

<p>ä¸éš¾çœ‹å‡ºthread_arenaæ˜¯ä¸€ä¸ªé™æ€çš„æ¯ä¸ªçº¿ç¨‹éƒ½ä¼šæœ‰ä¸€ä»½çš„å…¨å±€å˜é‡ï¼Œç±»å‹ä¸ºmstateï¼Œç”±æ­¤æˆ‘ä»¬å¯ä»¥çŸ¥é“çš„æ˜¯ï¼Œ<strong>åœ¨å…è®¸çš„æƒ…å†µä¸‹ï¼Œptmallocä¼šä¸ºæ¯ä¸ªçº¿ç¨‹å•ç‹¬åˆ†é…ä¸€ä¸ªarenaï¼Œè€Œæ¯ä¸ªçº¿ç¨‹éƒ½ä¼šæœ‰ä¸€ä¸ªthread_arenaæŒ‡é’ˆæŒ‡å‘è‡ªå·±æ‰€ç”¨çš„arena</strong></p>
<blockquote>
<h4 id="threadï¼šçº¿ç¨‹å˜é‡"><a href="#threadï¼šçº¿ç¨‹å˜é‡" class="headerlink" title="__threadï¼šçº¿ç¨‹å˜é‡"></a>__threadï¼šçº¿ç¨‹å˜é‡</h4><p>GCCå…³é”®å­—ä¹‹ä¸€ï¼Œä¹Ÿæ˜¯GCCå†…ç½®çš„çº¿ç¨‹å±€éƒ¨å­˜å‚¨è®¾æ–½ï¼Œå…¶å­˜å‚¨æ•ˆç‡è¿‘ä¼¼äºå…¨å±€å˜é‡</p>
<p>å¯¹äºä¸€ä¸ªè¢«__threadå…³é”®å­—ä¿®é¥°çš„ä¸€ä¸ªå˜é‡è€Œè¨€ï¼Œ<strong>æ¯ä¸ªçº¿ç¨‹éƒ½ä¼šç‹¬ç«‹æœ‰ä¸€ä¸ªè¯¥å˜é‡çš„å®ä¾‹ï¼Œçº¿ç¨‹ä¹‹é—´è¯¥å˜é‡å®ä¾‹çš„å€¼äº’ä¸å¹²æ‰°</strong></p>
<p>åªèƒ½ç”¨ä»¥ä¿®é¥°PODç±»å‹å˜é‡ã€å…¨å±€å˜é‡ã€é™æ€å˜é‡</p>
</blockquote>
<blockquote>
<h4 id="attribute-tls-model-ie"><a href="#attribute-tls-model-ie" class="headerlink" title="attribute_tls_model_ie"></a>attribute_tls_model_ie</h4><p>è¯¥å®å®šä¹‰äºinclude&#x2F;libc-symbols.hä¸‹</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> attribute_tls_model_ie __attribute__ ((tls_model (<span class="hljs-string">&quot;initial-exec&quot;</span>)))</span><br></code></pre></td></tr></table></figure>

<p>æ˜¯ä¸€ä¸ªattributeï¼Œè®¾ç½®äº†å…¶tls modeä¸ºâ€initial-execâ€ï¼›è¯¥modeå¯ç”¨äºä¼˜åŒ–å®šä¹‰äºåŠ¨æ€åŠ è½½åº“ä¸­çš„çº¿ç¨‹å±€éƒ¨å˜é‡ï¼Œä½†éœ€è¦å¯¹äºè¯¥å˜é‡çš„æ‰€æœ‰å¼•ç”¨æ“ä½œéƒ½ä½äºå®šä¹‰è¯¥å˜é‡çš„æ¨¡å—ä¸­</p>
<p>è¯¦è§<a target="_blank" rel="noopener" href="https://www.ibm.com/support/knowledgecenter/en/SSXVZZ_16.1.0/com.ibm.xlcpp161.lelinux.doc/compiler_ref/opt_tls.html">IBM knowledgeCenter - ftls-model</a></p>
<blockquote>
<h5 id="Thread-Local-Storageï¼šçº¿ç¨‹æœ¬åœ°å­˜å‚¨ï¼ˆTLSï¼‰"><a href="#Thread-Local-Storageï¼šçº¿ç¨‹æœ¬åœ°å­˜å‚¨ï¼ˆTLSï¼‰" class="headerlink" title="Thread-Local Storageï¼šçº¿ç¨‹æœ¬åœ°å­˜å‚¨ï¼ˆTLSï¼‰"></a>Thread-Local Storageï¼šçº¿ç¨‹æœ¬åœ°å­˜å‚¨ï¼ˆTLSï¼‰</h5><p>å¯¹äºä¸€ä¸ªè¿›ç¨‹ä¸­çš„æ‰€æœ‰çº¿ç¨‹è€Œè¨€ï¼Œä»–ä»¬å…±äº«ç€åŒä¸€ä¸ªå†…å­˜ç©ºé—´ï¼Œå› è€Œè‹¥å­˜åœ¨ä¸€å…¨å±€&#x2F;é™æ€å˜é‡ï¼Œåˆ™æ‰€æœ‰çº¿ç¨‹éƒ½ä¼šå…±äº«ä¸€ä»½å˜é‡å®ä¾‹ï¼Œå½“ä¸€ä¸ªçº¿ç¨‹å¯¹å…¶è¿›è¡Œä¿®æ”¹æ—¶ï¼Œåˆ™ä¼šåŒæ—¶å½±å“åˆ°å…¶ä»–çš„çº¿ç¨‹ï¼Œè€Œç»“æœå¹¶ä¸ä¸€å®šæ˜¯æˆ‘ä»¬æƒ³è¦çš„</p>
<p>å› è€Œå°±æœ‰äº†TLSçš„æ¦‚å¿µâ€”â€”çº¿ç¨‹æœ¬åœ°å­˜å‚¨ï¼š<strong>å„ä¸ªçº¿ç¨‹ç‹¬ç«‹æ‹¥æœ‰ä¸€ä¸ªå˜é‡å®ä¾‹ï¼Œç›¸äº’ä¹‹é—´å¹¶ä¸å½±å“</strong></p>
</blockquote>
</blockquote>
<blockquote>
<h4 id="attribute"><a href="#attribute" class="headerlink" title="__attribute__"></a>__attribute__</h4><p>GNU Cç‰¹æ€§ï¼Œç®€å•æ¥è¯´å°±æ˜¯æ ¹æ®å‡½æ•°çš„ä¸åŒçš„åŠŸèƒ½æ‰€å†³å®šçš„è¿”å›å€¼è€Œç”¨æ¥ä¼˜åŒ–æ‰€ç”Ÿæˆçš„ä»£ç çš„ï¼Œæ¯”å¦‚è¯´å†…å­˜åˆ†é…å‡½æ•°é€šå¸¸ä¼šè¿”å›ä¸€ä¸ªæŒ‡å‘å†…å­˜å—çš„æŒ‡é’ˆï¼Œé‚£ä¹ˆå°±å¯ä»¥ä½¿ç”¨__attribute__((malloc))è¿›è¡Œä¼˜åŒ–</p>
<p>è¯¦è§<a target="_blank" rel="noopener" href="https://gcc.gnu.org/onlinedocs/gcc-10.2.0/gcc/Common-Function-Attributes.html#Common-Function-Attributes">æ‰‹å†Œ</a></p>
</blockquote>
<h4 id="â‘¡narenasï¼šarenaæ•°é‡"><a href="#â‘¡narenasï¼šarenaæ•°é‡" class="headerlink" title="â‘¡narenasï¼šarenaæ•°é‡"></a>â‘¡narenasï¼šarenaæ•°é‡</h4><p>è¯¥å˜é‡ç”¨ä»¥è®°å½•arenaçš„æ•°é‡ï¼Œå®šä¹‰äºarena.cä¸­ï¼Œå¦‚ä¸‹</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">size_t</span> narenas = <span class="hljs-number">1</span>;<br></code></pre></td></tr></table></figure>

<p>è¯¥é™æ€å˜é‡è¢«åˆå§‹åŒ–ä¸º1ï¼Œå³é»˜è®¤ä¸€å¼€å§‹ä¾¿æœ‰ä¸€ä¸ªarenaï¼ˆmain_arenaï¼‰</p>
<h4 id="â‘¢main-arenaï¼šåˆå§‹ä¸»çº¿ç¨‹arena"><a href="#â‘¢main-arenaï¼šåˆå§‹ä¸»çº¿ç¨‹arena" class="headerlink" title="â‘¢main_arenaï¼šåˆå§‹ä¸»çº¿ç¨‹arena"></a>â‘¢main_arenaï¼šåˆå§‹ä¸»çº¿ç¨‹arena</h4><p>main_arenaä¸ºä¸€ä¸ªå®šä¹‰äºmalloc.cä¸­çš„é™æ€çš„malloc_stateç»“æ„ä½“ï¼Œå¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/* There are several instances of this struct (&quot;arenas&quot;) in this</span><br><span class="hljs-comment">   malloc.  If you are adapting this malloc in a way that does NOT use</span><br><span class="hljs-comment">   a static or mmapped malloc_state, you MUST explicitly zero-fill it</span><br><span class="hljs-comment">   before using. This malloc relies on the property that malloc_state</span><br><span class="hljs-comment">   is initialized to all zeroes (as is true of C statics).  */</span><br><br><span class="hljs-type">static</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">malloc_state</span> <span class="hljs-title">main_arena</span> =</span><br>&#123;<br>  .mutex = _LIBC_LOCK_INITIALIZER,<br>  .next = &amp;main_arena,<br>  .attached_threads = <span class="hljs-number">1</span><br>&#125;;<br></code></pre></td></tr></table></figure>

<p>ç”±äºå…¶ä¸ºlibcä¸­çš„é™æ€å˜é‡ï¼Œ<strong>è¯¥arenaä¼šè¢«éšç€libcæ–‡ä»¶ä¸€åŒåŠ è½½åˆ°Memory Mapping Segment</strong></p>
<h4 id="â‘£free-listï¼šç©ºé—²arenaé“¾è¡¨ï¼ˆå¤´ç»“ç‚¹ï¼‰"><a href="#â‘£free-listï¼šç©ºé—²arenaé“¾è¡¨ï¼ˆå¤´ç»“ç‚¹ï¼‰" class="headerlink" title="â‘£free_listï¼šç©ºé—²arenaé“¾è¡¨ï¼ˆå¤´ç»“ç‚¹ï¼‰"></a>â‘£free_listï¼šç©ºé—²arenaé“¾è¡¨ï¼ˆå¤´ç»“ç‚¹ï¼‰</h4><p>free_liståŒæ ·æ˜¯ä¸€ä¸ªmstateå˜é‡ï¼Œç”¨ä»¥ä¿å­˜ç©ºé—²arenaé“¾è¡¨çš„å¤´èŠ‚ç‚¹æŒ‡é’ˆï¼Œå®šä¹‰äºarena.cä¸­ï¼Œç›¸å…³ä»£ç å¦‚ä¸‹</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/* Arena free list.  free_list_lock synchronizes access to the</span><br><span class="hljs-comment">   free_list variable below, and the next_free and attached_threads</span><br><span class="hljs-comment">   members of struct malloc_state objects.  No other locks must be</span><br><span class="hljs-comment">   acquired after free_list_lock has been acquired.  */</span><br><br><span class="hljs-type">static</span> <span class="hljs-type">mutex_t</span> free_list_lock = _LIBC_LOCK_INITIALIZER;<br><span class="hljs-type">static</span> mstate free_list;<br></code></pre></td></tr></table></figure>

<p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ä¸ºäº†åº”å¯¹å¤šçº¿ç¨‹æ“ä½œï¼Œfree_liståŒæ ·æœ‰ç€ä¸€ä¸ªå¯¹åº”çš„äº’æ–¥é”</p>
<h4 id="â‘¤-arena-memï¼šéä¸»çº¿ç¨‹çš„arenaæ‰€å ç”¨çš„å†…å­˜ç©ºé—´æ€»å¤§å°"><a href="#â‘¤-arena-memï¼šéä¸»çº¿ç¨‹çš„arenaæ‰€å ç”¨çš„å†…å­˜ç©ºé—´æ€»å¤§å°" class="headerlink" title="â‘¤ arena_memï¼šéä¸»çº¿ç¨‹çš„arenaæ‰€å ç”¨çš„å†…å­˜ç©ºé—´æ€»å¤§å°"></a>â‘¤ arena_memï¼šéä¸»çº¿ç¨‹çš„arenaæ‰€å ç”¨çš„å†…å­˜ç©ºé—´æ€»å¤§å°</h4><p>å®šä¹‰äºarena.cä¸­ï¼Œå¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/* Mapped memory in non-main arenas (reliable only for NO_THREADS). */</span><br><span class="hljs-type">static</span> <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> arena_mem;<br></code></pre></td></tr></table></figure>

<p>è¯¥å˜é‡ç”¨ä»¥è®°å½•émain_arenaæ‰€åˆ†é…åˆ°çš„ç©ºé—´çš„<strong>æ€»å¤§å°</strong></p>
<h3 id="3-arenaç›¸å…³å‡½æ•°ä¸å®"><a href="#3-arenaç›¸å…³å‡½æ•°ä¸å®" class="headerlink" title="3.arenaç›¸å…³å‡½æ•°ä¸å®"></a>3.arenaç›¸å…³å‡½æ•°ä¸å®</h3><h4 id="â‘ malloc-init-state-ï¼šåˆå§‹åŒ–arenaå†…æˆå‘˜"><a href="#â‘ malloc-init-state-ï¼šåˆå§‹åŒ–arenaå†…æˆå‘˜" class="headerlink" title="â‘ malloc_init_state()ï¼šåˆå§‹åŒ–arenaå†…æˆå‘˜"></a>â‘ malloc_init_state()ï¼šåˆå§‹åŒ–arenaå†…æˆå‘˜</h4><p>è¯¥å‡½æ•°ä½äºmalloc.cä¸­ï¼Œå¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/*</span><br><span class="hljs-comment">   Initialize a malloc_state struct.</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">   This is called only from within malloc_consolidate, which needs</span><br><span class="hljs-comment">   be called in the same contexts anyway.  It is never called directly</span><br><span class="hljs-comment">   outside of malloc_consolidate because some optimizing compilers try</span><br><span class="hljs-comment">   to inline it at all call points, which turns out not to be an</span><br><span class="hljs-comment">   optimization at all. (Inlining it in malloc_consolidate is fine though.)</span><br><span class="hljs-comment"> */</span><br><br><span class="hljs-type">static</span> <span class="hljs-type">void</span><br><span class="hljs-title function_">malloc_init_state</span> <span class="hljs-params">(mstate av)</span><br>&#123;<br>  <span class="hljs-type">int</span> i;<br>  mbinptr bin;<br><br>  <span class="hljs-comment">/* Establish circular links for normal bins */</span><br>  <span class="hljs-keyword">for</span> (i = <span class="hljs-number">1</span>; i &lt; NBINS; ++i)<br>    &#123;<br>      bin = bin_at (av, i);<br>      bin-&gt;fd = bin-&gt;bk = bin;<br>    &#125;<br><br><span class="hljs-meta">#<span class="hljs-keyword">if</span> MORECORE_CONTIGUOUS</span><br>  <span class="hljs-keyword">if</span> (av != &amp;main_arena)<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>  set_noncontiguous (av);<br>  <span class="hljs-keyword">if</span> (av == &amp;main_arena)<br>    set_max_fast (DEFAULT_MXFAST);<br>  av-&gt;flags |= FASTCHUNKS_BIT;<br><br>  av-&gt;top = initial_top (av);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>å¤§æ¦‚åšäº†ä»¥ä¸‹å‡ ä»¶äº‹ï¼š</p>
<ul>
<li><strong>å°†arenaä¸­æ‰€æœ‰bin</strong>ï¼ˆfastbiné™¤å¤–ï¼‰<strong>çš„fdä¸bkéƒ½æŒ‡å‘binè‡ªèº«</strong></li>
<li>ï¼ˆä½¿ç”¨sbrkè¿›è¡Œå¢é•¿çš„å †åŒºåŸŸåœ¨å†…å­˜ä¸­ä¸ºè¿ç»­åŒºåŸŸçš„æƒ…å†µä¸‹è‹¥è¯¥arenaémain_arenaåˆ™ï¼‰<strong>è®¾ç½®è¯¥arenaçš„æ ‡å¿—ä½ä¸­çš„noncontiguous</strong>ï¼Œç¬”è€…æ¨æµ‹è¿™æ˜¯ç”±äºéä¸»çº¿ç¨‹arenaçš„å†…å­˜åŒºåŸŸä½äºç”±mmapæ˜ å°„çš„MMSæ®µï¼Œä¸€èˆ¬æ¥è¯´å¹¶éè¿ç»­å†…å­˜ï¼Œæ•…è®¾ç½®è¯¥æ ‡å¿—ä½ï¼Œè€Œæ‰€ç®¡ç†çš„å†…å­˜ä½äºheapåŒºçš„main_arenaåˆ™å¯ä»¥é€šè¿‡ç³»ç»Ÿè°ƒç”¨sbrkåœ¨heapåŒºè¿›è¡Œå¢é•¿ï¼Œæ•…ä¸è®¾ç½®è¯¥æ ‡å¿—ä½ï¼ˆMORECORE_CONTIGUOUSè¢«è®¾ä¸º1ï¼Œå³æ„ä¸ºsbrkç³»ç»Ÿè°ƒç”¨çš„å †åŒºå†…å­˜å¢é•¿è¿ç»­ï¼ˆMORECOREä¸ºsbrkçš„å°è£…ï¼‰ï¼‰</li>
<li>è‹¥è¯¥arenaä¸ºmain_arenaåˆ™è®¾ç½®set_max_fastä¸ºé»˜è®¤å€¼ï¼Œè¯¥å€¼32ä½ä¸‹ä¸º0x40ï¼Œ64ä½ä¸‹ä¸º0x80</li>
<li>è®¾ç½®æ ‡å¿—ä½FASTCHUNKS_BITï¼Œ<strong>å³ä¸€ä¸ªarenaåœ¨é»˜è®¤æƒ…å†µä¸‹å¹¶ä¸æ‹¥æœ‰fastbin chunk</strong></li>
<li>å°†è¯¥arevaçš„top chunkæŒ‡é’ˆæŒ‡å‘unsorted binï¼Œ<strong>ç”¨ä»¥è¡¨ç¤ºåˆå§‹æ—¶top chunkå¤§å°ä¸º0</strong></li>
</ul>
<h4 id="â‘¡-int-new-arena-ï¼šåˆ›å»ºä¸€ä¸ªæ–°çš„arena"><a href="#â‘¡-int-new-arena-ï¼šåˆ›å»ºä¸€ä¸ªæ–°çš„arena" class="headerlink" title="â‘¡_int_new_arena()ï¼šåˆ›å»ºä¸€ä¸ªæ–°çš„arena"></a>â‘¡_int_new_arena()ï¼šåˆ›å»ºä¸€ä¸ªæ–°çš„arena</h4><p>è¯¥å‡½æ•°å®šä¹‰äºarena.cä¸­ï¼Œå¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> mstate<br>_int_new_arena (<span class="hljs-type">size_t</span> size)<br>&#123;<br>  mstate a;<br>  heap_info *h;<br>  <span class="hljs-type">char</span> *ptr;<br>  <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> misalign;<br><br>  h = new_heap (size + (<span class="hljs-keyword">sizeof</span> (*h) + <span class="hljs-keyword">sizeof</span> (*a) + MALLOC_ALIGNMENT),<br>                mp_.top_pad);<br>  <span class="hljs-keyword">if</span> (!h)<br>    &#123;<br>      <span class="hljs-comment">/* Maybe size is too large to fit in a single heap.  So, just try</span><br><span class="hljs-comment">         to create a minimally-sized arena and let _int_malloc() attempt</span><br><span class="hljs-comment">         to deal with the large request via mmap_chunk().  */</span><br>      h = new_heap (<span class="hljs-keyword">sizeof</span> (*h) + <span class="hljs-keyword">sizeof</span> (*a) + MALLOC_ALIGNMENT, mp_.top_pad);<br>      <span class="hljs-keyword">if</span> (!h)<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>    &#125;<br>  a = h-&gt;ar_ptr = (mstate) (h + <span class="hljs-number">1</span>);<br>  malloc_init_state (a);<br>  a-&gt;attached_threads = <span class="hljs-number">1</span>;<br>  <span class="hljs-comment">/*a-&gt;next = NULL;*/</span><br>  a-&gt;system_mem = a-&gt;max_system_mem = h-&gt;size;<br>  arena_mem += h-&gt;size;<br><br>  <span class="hljs-comment">/* Set up the top chunk, with proper alignment. */</span><br>  ptr = (<span class="hljs-type">char</span> *) (a + <span class="hljs-number">1</span>);<br>  misalign = (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) chunk2mem (ptr) &amp; MALLOC_ALIGN_MASK;<br>  <span class="hljs-keyword">if</span> (misalign &gt; <span class="hljs-number">0</span>)<br>    ptr += MALLOC_ALIGNMENT - misalign;<br>  top (a) = (mchunkptr) ptr;<br>  set_head (top (a), (((<span class="hljs-type">char</span> *) h + h-&gt;size) - ptr) | PREV_INUSE);<br><br>  LIBC_PROBE (memory_arena_new, <span class="hljs-number">2</span>, a, size);<br>  mstate replaced_arena = thread_arena;<br>  thread_arena = a;<br>  mutex_init (&amp;a-&gt;mutex);<br><br>  (<span class="hljs-type">void</span>) mutex_lock (&amp;list_lock);<br><br>  <span class="hljs-comment">/* Add the new arena to the global list.  */</span><br>  a-&gt;next = main_arena.next;<br>  <span class="hljs-comment">/* <span class="hljs-doctag">FIXME:</span> The barrier is an attempt to synchronize with read access</span><br><span class="hljs-comment">     in reused_arena, which does not acquire list_lock while</span><br><span class="hljs-comment">     traversing the list.  */</span><br>  atomic_write_barrier ();<br>  main_arena.next = a;<br><br>  (<span class="hljs-type">void</span>) mutex_unlock (&amp;list_lock);<br><br>  (<span class="hljs-type">void</span>) mutex_lock (&amp;free_list_lock);<br>  detach_arena (replaced_arena);<br>  (<span class="hljs-type">void</span>) mutex_unlock (&amp;free_list_lock);<br><br>  <span class="hljs-comment">/* Lock this arena.  NB: Another thread may have been attached to</span><br><span class="hljs-comment">     this arena because the arena is now accessible from the</span><br><span class="hljs-comment">     main_arena.next list and could have been picked by reused_arena.</span><br><span class="hljs-comment">     This can only happen for the last arena created (before the arena</span><br><span class="hljs-comment">     limit is reached).  At this point, some arena has to be attached</span><br><span class="hljs-comment">     to two threads.  We could acquire the arena lock before list_lock</span><br><span class="hljs-comment">     to make it less likely that reused_arena picks this new arena,</span><br><span class="hljs-comment">     but this could result in a deadlock with ptmalloc_lock_all.  */</span><br><br>  (<span class="hljs-type">void</span>) mutex_lock (&amp;a-&gt;mutex);<br><br>  <span class="hljs-keyword">return</span> a;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>è¯¥å‡½æ•°é¦–å…ˆä¼šå°è¯•ä»Memory Mapping SegmentåŒºåŸŸåˆ†é…ä¸€ä¸ªå¤§å°ä¸º<code>size + heap_info + malloc_state + MALLOC_ALIGNMENT + __mp.top_pad</code>çš„å†…å­˜å—ï¼Œè‹¥å¤±è´¥åˆ™<strong>é‡æ–°å°è¯•åˆ†é…ä¸€ä¸ªå¤§å°ä»…ä¸º<code>heap_info + malloc_state + MALLOC_ALIGNMENT + __mp.top_pad</code>çš„å†…å­˜å—</strong>ï¼Œè‹¥ä»å¤±è´¥åˆ™è¿”å›NULLï¼Œéœ€è¦æ³¨æ„çš„æ˜¯åœ¨new_heap()å‡½æ•°ä¸­<strong>è¯¥å€¼ä¼šè¢«è‡ªåŠ¨è½¬æ¢ä¸ºä¸€ä¸ªå¯¹åˆ†é¡µå¤§å°å¯¹é½çš„size</strong>ï¼Œ<strong>è‹¥è¯¥å€¼å°äºHEAP_MIN_SIZE</strong>ï¼ˆ32*1024ï¼‰<strong>åˆ™ä¼šè¢«è‡ªåŠ¨è½¬æ¢ä¸ºHEAP_MIN_SIZE</strong>ï¼Œè¯¦ç»†ä¼šåœ¨åç»­new_heap()å‡½æ•°è§£æä¸­è¯´æ˜</p>
<p>æ¥ä¸‹æ¥è¯¥å‡½æ•°ä¼šå°†è·å¾—çš„å†…å­˜å—ä»<strong>heap headerå¾€åçš„ä¸€å—å¤§å°ä¸ºmalloc_stateçš„åŒºåŸŸå½“ä½œæ˜¯ä¸€ä¸ªæ–°çš„arenaæ¥ç»§ç»­æ“ä½œ</strong></p>
<p>ä¹Ÿå°±æ˜¯è¯´æ­¤æ—¶è¯¥å†…å­˜å—çš„å¸ƒå±€åº”å½“å¦‚ä¸‹ï¼š</p>
<p><img src="https://i.loli.net/2021/01/14/bevLqTFRpxkjCcW.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p>éšåä¼šè°ƒç”¨<code>malloc_init_state()</code>å‡½æ•°åˆå§‹åŒ–è¯¥arenaï¼Œå¹¶è®¾ç½®å…¶å…³è”çº¿ç¨‹æ•°ä¸º1ï¼Œè®¾ç½®åˆ†é…åˆ°çš„å†…å­˜å¤§å°ä¸ºheap headerä¸­çš„sizeï¼Œå¹¶ä½¿arena_memåŠ ä¸Šè¯¥size</p>
<p>æœ€åï¼Œ<strong>å‰©ä½™çš„å†…å­˜ä¼šè¢«è§†ä½œè¯¥arenaçš„top chunkï¼Œå¹¶è®¾ç½®PREV_INUSEæ ‡å¿—ä½</strong></p>
<p>æ­¤æ—¶è¿™ä¸€å—å†…å­˜çš„å¸ƒå±€å¦‚ä¸‹ï¼š</p>
<p><img src="https://i.loli.net/2021/01/14/GM8qCiErXgFDYsy.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p>éœ€è¦æ³¨æ„çš„æ˜¯è‹¥æ˜¯å†…å­˜åœ°å€æœªå¯¹MALLOC_ALIGNMENTå¯¹é½åˆ™ä¼šé€‚å½“è°ƒæ•´top chunkçš„ä½ç½®</p>
<p><img src="https://i.loli.net/2021/01/14/sjQrLvNORFXhDbC.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p>æ¥ä¸‹æ¥ä¼š<strong>å°†è¯¥çº¿ç¨‹çš„arenaè®¾ä¸ºè¯¥arenaï¼Œå¹¶å°†è¯¥arenaæ’å…¥åˆ°arenaé“¾è¡¨ä¸­çš„main_arenaä¹‹å</strong></p>
<p>æœ€åè§£é”çº¿ç¨‹åŸarenaï¼Œé”ä¸Šæ–°çš„arenaï¼Œå¹¶å°†æ–°çš„arenaè¿”å›</p>
<blockquote>
<h5 id="LIBC-PROBEï¼šã€ŒLIBCæ¢é’ˆã€"><a href="#LIBC-PROBEï¼šã€ŒLIBCæ¢é’ˆã€" class="headerlink" title="LIBC_PROBEï¼šã€ŒLIBCæ¢é’ˆã€"></a>LIBC_PROBEï¼šã€ŒLIBCæ¢é’ˆã€</h5><p>LIBC_PROBEä¸ºç³»ç»Ÿæ¢é’ˆçš„ä¸Šå±‚å°è£…ï¼Œè¯¥å®å®šä¹‰äºinclude&#x2F;stap-probe.hä¸­ï¼Œå¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> USE_STAP_PROBE</span><br><br><span class="hljs-meta"># <span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/sdt.h&gt;</span></span><br><br><span class="hljs-comment">/* Our code uses one macro LIBC_PROBE (name, n, arg1, ..., argn).</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">Without USE_STAP_PROBE, that does nothing but evaluates all</span><br><span class="hljs-comment">its arguments (to prevent bit rot, unlike e.g. assert).</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">Systemtap&#x27;s header defines the macros STAP_PROBE (provider, name) and</span><br><span class="hljs-comment">STAP_PROBEn (provider, name, arg1, ..., argn).  For &quot;provider&quot; we paste</span><br><span class="hljs-comment">in MODULE_NAME (libc, libpthread, etc.) automagically.</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">The format of the arg parameters is discussed here:</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">https://sourceware.org/systemtap/wiki/UserSpaceProbeImplementation</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">The precise details of how register names are specified is</span><br><span class="hljs-comment">architecture specific and can be found in the gdb and SystemTap</span><br><span class="hljs-comment">source code.  */</span><br><br><span class="hljs-meta"># <span class="hljs-keyword">define</span> LIBC_PROBE(name, n, ...)	\</span><br><span class="hljs-meta">LIBC_PROBE_1 (MODULE_NAME, name, n, ## __VA_ARGS__)</span><br><br><span class="hljs-meta"># <span class="hljs-keyword">define</span> LIBC_PROBE_1(lib, name, n, ...) \</span><br><span class="hljs-meta">STAP_PROBE##n (lib, name, ## __VA_ARGS__)</span><br><br><span class="hljs-meta"># <span class="hljs-keyword">define</span> STAP_PROBE0		STAP_PROBE</span><br><br><span class="hljs-meta"># <span class="hljs-keyword">define</span> LIBC_PROBE_ASM(name, template) \</span><br><span class="hljs-meta">STAP_PROBE_ASM (MODULE_NAME, name, template)</span><br><br><span class="hljs-meta"># <span class="hljs-keyword">define</span> LIBC_PROBE_ASM_OPERANDS STAP_PROBE_ASM_OPERANDS</span><br>...<span class="hljs-comment">//ä¸ä½¿ç”¨PROBEçš„å®å°±ä¸è´´å‡ºæ¥äº†ï¼Œå…¶é€»è¾‘ä»…ä¸ºå®šä¹‰è¯¥å®ä¸ºç©º</span><br></code></pre></td></tr></table></figure>

<p>ä¾æ—§æ˜¯å¥—å¨ƒå®ï¼ŒSTAP_PROBE##nå®å®šä¹‰åœ¨sys&#x2F;sdt.hä¸‹ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯<strong>è¿™ä¸ªæ–‡ä»¶ä¼¼ä¹ä¸å±äºglibc</strong></p>
<p><del>è°·æ­Œäº†ä¸€ä¸‹ï¼Œ</del>åœ¨ç»ˆç«¯ä½¿ç”¨å¦‚ä¸‹æŒ‡ä»¤å®‰è£…systemtap-sdt-dev</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">sudo apt install systemtap-sdt-dev<br></code></pre></td></tr></table></figure>

<p>ç„¶åå°±èƒ½è·å¾—sdt.häº†</p>
<p>åœ¨sdt.hä¸­å®šä¹‰äº†13ä¸ªSTAP_PROBEå®ï¼Œå¦‚ä¸‹ï¼š<del>ä»¤äººçœ‹ç€å¤´å¤§çš„å†™æ³•</del></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> STAP_PROBE(provider, name) \</span><br><span class="hljs-meta">_SDT_PROBE(provider, name, 0, ())</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> STAP_PROBE1(provider, name, arg1) \</span><br><span class="hljs-meta">_SDT_PROBE(provider, name, 1, (arg1))</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> STAP_PROBE2(provider, name, arg1, arg2) \</span><br><span class="hljs-meta">_SDT_PROBE(provider, name, 2, (arg1, arg2))</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> STAP_PROBE3(provider, name, arg1, arg2, arg3) \</span><br><span class="hljs-meta">_SDT_PROBE(provider, name, 3, (arg1, arg2, arg3))</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> STAP_PROBE4(provider, name, arg1, arg2, arg3, arg4) \</span><br><span class="hljs-meta">_SDT_PROBE(provider, name, 4, (arg1, arg2, arg3, arg4))</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> STAP_PROBE5(provider, name, arg1, arg2, arg3, arg4, arg5) \</span><br><span class="hljs-meta">_SDT_PROBE(provider, name, 5, (arg1, arg2, arg3, arg4, arg5))</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> STAP_PROBE6(provider, name, arg1, arg2, arg3, arg4, arg5, arg6)	\</span><br><span class="hljs-meta">_SDT_PROBE(provider, name, 6, (arg1, arg2, arg3, arg4, arg5, arg6))</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> STAP_PROBE7(provider, name, arg1, arg2, arg3, arg4, arg5, arg6, arg7) \</span><br><span class="hljs-meta">_SDT_PROBE(provider, name, 7, (arg1, arg2, arg3, arg4, arg5, arg6, arg7))</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> STAP_PROBE8(provider,name,arg1,arg2,arg3,arg4,arg5,arg6,arg7,arg8) \</span><br><span class="hljs-meta">_SDT_PROBE(provider, name, 8, (arg1,arg2,arg3,arg4,arg5,arg6,arg7,arg8))</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> STAP_PROBE9(provider,name,arg1,arg2,arg3,arg4,arg5,arg6,arg7,arg8,arg9)\</span><br><span class="hljs-meta">_SDT_PROBE(provider, name, 9, (arg1,arg2,arg3,arg4,arg5,arg6,arg7,arg8,arg9))</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> STAP_PROBE10(provider,name,arg1,arg2,arg3,arg4,arg5,arg6,arg7,arg8,arg9,arg10) \</span><br><span class="hljs-meta">_SDT_PROBE(provider, name, 10, \</span><br><span class="hljs-meta">	     (arg1,arg2,arg3,arg4,arg5,arg6,arg7,arg8,arg9,arg10))</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> STAP_PROBE11(provider,name,arg1,arg2,arg3,arg4,arg5,arg6,arg7,arg8,arg9,arg10,arg11) \</span><br><span class="hljs-meta">_SDT_PROBE(provider, name, 11, \</span><br><span class="hljs-meta">	     (arg1,arg2,arg3,arg4,arg5,arg6,arg7,arg8,arg9,arg10,arg11))</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> STAP_PROBE12(provider,name,arg1,arg2,arg3,arg4,arg5,arg6,arg7,arg8,arg9,arg10,arg11,arg12) \</span><br><span class="hljs-meta">_SDT_PROBE(provider, name, 12, \</span><br><span class="hljs-meta">	     (arg1,arg2,arg3,arg4,arg5,arg6,arg7,arg8,arg9,arg10,arg11,arg12))</span><br></code></pre></td></tr></table></figure>

<p>ä¾ç„¶æ˜¯å¥—å¨ƒå®šä¹‰ï¼Œè·Ÿè¿›</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> __ASSEMBLER__</span><br><span class="hljs-meta"># <span class="hljs-keyword">define</span> _SDT_PROBE(provider, name, n, arglist)	\</span><br><span class="hljs-meta">_SDT_ASM_BODY(provider, name, _SDT_ASM_STRING_1, (_SDT_DEPAREN_##n arglist)) \</span><br><span class="hljs-meta">_SDT_ASM_BASE</span><br><span class="hljs-meta"># <span class="hljs-keyword">define</span> _SDT_ASM_1(x)			x;</span><br><span class="hljs-meta"># <span class="hljs-keyword">define</span> _SDT_ASM_2(a, b)		a,b;</span><br><span class="hljs-meta"># <span class="hljs-keyword">define</span> _SDT_ASM_3(a, b, c)		a,b,c;</span><br><span class="hljs-meta"># <span class="hljs-keyword">define</span> _SDT_ASM_5(a, b, c, d, e)	a,b,c,d,e;</span><br>...<br><span class="hljs-meta">#<span class="hljs-keyword">else</span></span><br>...<span class="hljs-comment">//å‰é¢åœ¨stap-probe.hä¸­è‹¥æ˜¯æ²¡æœ‰def __ASSEMBLER__ çš„è¯STAP_PROBEå°±æ˜¯ç©ºäº†ï¼Œæ‰€ä»¥åé¢çš„å°±ä¸è´´äº†</span><br></code></pre></td></tr></table></figure>

<p>ä¾æ—§å¥—å¨ƒï¼Œå†åº¦è·Ÿè¿›</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> _SDT_ASM_BODY(provider, name, pack_args, args)			      \</span><br><span class="hljs-meta">_SDT_ASM_1(990:	_SDT_NOP)					      \</span><br><span class="hljs-meta">_SDT_ASM_3(		.pushsection .note.stapsdt,_SDT_ASM_AUTOGROUP,<span class="hljs-string">&quot;note&quot;</span>) \</span><br><span class="hljs-meta">_SDT_ASM_1(		.balign 4)					      \</span><br><span class="hljs-meta">_SDT_ASM_3(		.4byte 992f-991f, 994f-993f, _SDT_NOTE_TYPE)	      \</span><br><span class="hljs-meta">_SDT_ASM_1(991:	.asciz _SDT_NOTE_NAME)				      \</span><br><span class="hljs-meta">_SDT_ASM_1(992:	.balign 4)					      \</span><br><span class="hljs-meta">_SDT_ASM_1(993:	_SDT_ASM_ADDR 990b)				      \</span><br><span class="hljs-meta">_SDT_ASM_1(		_SDT_ASM_ADDR _.stapsdt.base)			      \</span><br><span class="hljs-meta">_SDT_SEMAPHORE(provider,name)						      \</span><br><span class="hljs-meta">_SDT_ASM_STRING(provider)						      \</span><br><span class="hljs-meta">_SDT_ASM_STRING(name)							      \</span><br><span class="hljs-meta">pack_args args							      \</span><br><span class="hljs-meta">_SDT_ASM_1(994:	.balign 4)					      \</span><br><span class="hljs-meta">_SDT_ASM_1(		.popsection)</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> _SDT_ASM_BASE							      \</span><br><span class="hljs-meta">_SDT_ASM_1(.<span class="hljs-keyword">ifndef</span> _.stapsdt.base)					      \</span><br><span class="hljs-meta">_SDT_ASM_5(		.pushsection .stapsdt.base,<span class="hljs-string">&quot;aG&quot;</span>,<span class="hljs-string">&quot;progbits&quot;</span>,	      \</span><br><span class="hljs-meta">							.stapsdt.base,comdat) \</span><br><span class="hljs-meta">_SDT_ASM_1(		.weak _.stapsdt.base)				      \</span><br><span class="hljs-meta">_SDT_ASM_1(		.hidden _.stapsdt.base)				      \</span><br><span class="hljs-meta">_SDT_ASM_1(	_.stapsdt.base: .space 1)				      \</span><br><span class="hljs-meta">_SDT_ASM_2(		.size _.stapsdt.base, 1)			      \</span><br><span class="hljs-meta">_SDT_ASM_1(		.popsection)					      \</span><br><span class="hljs-meta">_SDT_ASM_1(.<span class="hljs-keyword">endif</span>)</span><br></code></pre></td></tr></table></figure>

<p><del>è¿™ä½ ğŸ¦„çš„åˆå¥—å›å»äº†å•Š</del></p>
<p>è¿™â†‘é‡Œâ†“ä¾¿æ˜¯ç³»ç»Ÿæ¢é’ˆçš„å®ç°åŸç†äº†ï¼Œç”±äºä¸æ˜¯æœ¬ç¯‡é‡ç‚¹æ•…å…·ä½“ä»£ç å°±å…ˆä¸åˆ†æäº†ï¼ˆ<del>å…¶å®æ˜¯ä¸ä¼š</del></p>
</blockquote>
<blockquote>
<h5 id="System-Tapï¼šã€Œå†…æ ¸æ¢æµ‹å·¥å…·ã€"><a href="#System-Tapï¼šã€Œå†…æ ¸æ¢æµ‹å·¥å…·ã€" class="headerlink" title="System Tapï¼šã€Œå†…æ ¸æ¢æµ‹å·¥å…·ã€"></a>System Tapï¼šã€Œå†…æ ¸æ¢æµ‹å·¥å…·ã€</h5><blockquote>
<p>In computing, SystemTap (stap) is a scripting language and tool for dynamically instrumenting running production Linux kernel-based operating systems. System administrators can use SystemTap to extract, filter and summarize data in order to enable diagnosis of complex performance or functional problems.</p>
<p>SystemTap consists of free and open-source software and includes contributions from Red Hat, IBM, Intel, Hitachi, Oracle, the University of Wisconsin-Madison and other community members</p>
<p><a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/SystemTap">WikiPedia: System Tap</a></p>
</blockquote>
<p>å¤§æ„æ˜¯è¯´SystemTapæ˜¯ä¸€ä¸ªç”¨ä»¥<strong>å¯¹åŸºäºLinuxå†…æ ¸çš„æ“ä½œç³»ç»Ÿè¿›è¡ŒåŠ¨æ€æ’æ¡©</strong>çš„è„šæœ¬è¯­è¨€å·¥å…·ï¼Œç³»ç»Ÿç®¡ç†å‘˜å¯ä»¥ç”¨å®ƒæ¥æå–ã€è¿‡æ»¤ã€æ±‡æ€»æ•°æ®ä»¥è¿›è¡Œå¤æ‚æ€§èƒ½æˆ–åŠŸèƒ½é—®é¢˜çš„è¯Šæ–­</p>
<blockquote>
<p>In order to aid in debugging and monitoring internal behavior, the GNU C Library exposes nearly-zero-overhead SystemTap probes marked with the libc provider.</p>
<p><a target="_blank" rel="noopener" href="http://ld2015.scusa.lsu.edu/gnu_c_libs/Internal-Probes.html#Internal-Probes">The GNU C Library : Internal Probe</a></p>
</blockquote>
<p>ä¸ºäº†<strong>å¸®åŠ©è°ƒè¯•å’Œç›‘è§†å†…éƒ¨è¡Œä¸º</strong>ï¼ŒGNU Cåº“å…¬å¼€äº†ç”¨libcæä¾›ç¨‹åºæ ‡è®°çš„<strong>å¼€é”€å‡ ä¹ä¸ºé›¶çš„</strong>ç³»ç»Ÿæ¢é’ˆã€‚ </p>
<p>åœ¨get_free_list()å‡½æ•°ä¸­ç”¨åˆ°çš„æ¢é’ˆä¸ºmemory_arena_reuse_free_listï¼Œè¯´æ˜å¦‚ä¸‹ï¼š</p>
<blockquote>
<p>Probe: <strong>memory_arena_reuse_free_list</strong> <em>(void *$arg1)</em></p>
<p>This probe is triggered when <code>malloc</code> has chosen an arena that is in the free list for use by a thread, within the <code>get_free_list</code> function. The argument $arg1 holds a pointer to the selected arena.</p>
<p><a target="_blank" rel="noopener" href="http://ld2015.scusa.lsu.edu/gnu_c_libs/Memory-Allocation-Probes.html#Memory-Allocation-Probes">The GNU C Library: Memory Allocation Probes</a></p>
</blockquote>
<p>æ€»ä¹‹ï¼Œè°ƒè¯•linuxå†…æ ¸çš„æ—¶å€™ä¾¿å¯ä»¥åœ¨è¿™äº›åœ°æ–¹ä½¿ç”¨ç›¸åº”çš„ç³»ç»Ÿæ¢é’ˆ</p>
</blockquote>
<h4 id="â‘¢get-free-list-ï¼šå°è¯•ä»free-listä¸­è·å–ä¸€ä¸ªç©ºé—²arena"><a href="#â‘¢get-free-list-ï¼šå°è¯•ä»free-listä¸­è·å–ä¸€ä¸ªç©ºé—²arena" class="headerlink" title="â‘¢get_free_list()ï¼šå°è¯•ä»free_listä¸­è·å–ä¸€ä¸ªç©ºé—²arena"></a>â‘¢get_free_list()ï¼šå°è¯•ä»free_listä¸­è·å–ä¸€ä¸ªç©ºé—²arena</h4><p>è¯¥å‡½æ•°åŒæ ·å®šä¹‰äºarena.cä¸­ï¼Œç”¨ä»¥ä»free_listä¸­è·å–ä¸€ä¸ªç©ºé—²çš„arenaï¼Œå¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/* Remove an arena from free_list.  The arena may be in use because it</span><br><span class="hljs-comment">   was attached concurrently to a thread by reused_arena below.  */</span><br><span class="hljs-type">static</span> mstate<br><span class="hljs-title function_">get_free_list</span> <span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>  mstate replaced_arena = thread_arena;<br>  mstate result = free_list;<br>  <span class="hljs-keyword">if</span> (result != <span class="hljs-literal">NULL</span>)<br>    &#123;<br>      (<span class="hljs-type">void</span>) mutex_lock (&amp;free_list_lock);<br>      result = free_list;<br>      <span class="hljs-keyword">if</span> (result != <span class="hljs-literal">NULL</span>)<br>	&#123;<br>	  free_list = result-&gt;next_free;<br><br>	  <span class="hljs-comment">/* The arena will be attached to this thread.  */</span><br>	  ++result-&gt;attached_threads;<br><br>	  detach_arena (replaced_arena);<br>	&#125;<br>      (<span class="hljs-type">void</span>) mutex_unlock (&amp;free_list_lock);<br><br>      <span class="hljs-keyword">if</span> (result != <span class="hljs-literal">NULL</span>)<br>        &#123;<br>          LIBC_PROBE (memory_arena_reuse_free_list, <span class="hljs-number">1</span>, result);<br>          (<span class="hljs-type">void</span>) mutex_lock (&amp;result-&gt;mutex);<br>	  thread_arena = result;<br>        &#125;<br>    &#125;<br><br>  <span class="hljs-keyword">return</span> result;<br>&#125;<br></code></pre></td></tr></table></figure>



<p>get_free_list()å‡½æ•°é¦–å…ˆä¼šæ£€æŸ¥free_listæ˜¯å¦ä¸ºç©ºï¼Œ<strong>è‹¥ä¸ºç©ºåˆ™ç›´æ¥è¿”å›NULL</strong>ï¼Œä¸ä¸ºç©ºçš„æƒ…å†µä¸‹åˆ™ä¼šè¿›è¡Œå¦‚ä¸‹æ“ä½œï¼š</p>
<ul>
<li><strong>é¦–å…ˆå°è¯•é”ä¸Šfree_list_lockåå†æ¬¡æ£€æŸ¥free_listæ˜¯å¦ä¸ºç©ºï¼Œè‹¥è¿˜æ˜¯ä¸ä¸ºç©ºæ‰ä¼šå–å‡ºå¤´ç»“ç‚¹ï¼Œå¹¶è°ƒç”¨detach_arena()å‡½æ•°å°†å½“å‰çº¿ç¨‹åŸå…ˆä½¿ç”¨çš„arenaçš„å…³è”çº¿ç¨‹æ•°å‡ä¸€</strong>ï¼Œè¿™é‡Œçš„äºŒæ¬¡æ£€æŸ¥æ˜¯ä¸ºäº†é˜²æ­¢å¤šçº¿ç¨‹é—´çš„å†²çªï¼ˆä¸¾ä¸ªä¾‹å­ï¼Œå¯èƒ½æœ‰ä¸ªçº¿ç¨‹åœ¨å…¶ä¹‹å‰å…ˆå–å‡ºäº†free_listä¸­çš„ç©ºé—²arenaï¼Œè€Œå½“å‰çº¿ç¨‹å¿…é¡»è¦ç­‰å¾…å…¶è§£é”äº’æ–¥é”free_list_lockåæ‰èƒ½ç»§ç»­æ¥ä¸‹æ¥çš„æ“ä½œï¼Œè‹¥æ˜¯ä»ä½¿ç”¨å‰é¢æ‰€è·å–çš„arenaé‚£å°±ä¹±å¥—äº†ï¼‰ï¼›</li>
<li>è°ƒç”¨mutex_unlock()å‡½æ•°<strong>è§£é”free_listäº’æ–¥é”ï¼Œéšåå†æ¬¡æ£€æŸ¥æ­¤å‰è·å¾—çš„arenaæ˜¯å¦ä¸ºNULL</strong></li>
<li>è‹¥è·å¾—çš„<strong>arenaä¸ä¸ºNULLåˆ™é”ä¸Šå…¶äº’æ–¥é”ï¼Œå°†å½“å‰çº¿ç¨‹çš„thread_arenaè®¾ä¸ºè¯¥arena</strong></li>
<li>å°†æœ€ç»ˆçš„resultè¿”å›ç»™ä¸Šå±‚å‡½æ•°</li>
</ul>
<h4 id="â‘£arena-get-ï¼šè·å¾—ä¸€ä¸ªarena"><a href="#â‘£arena-get-ï¼šè·å¾—ä¸€ä¸ªarena" class="headerlink" title="â‘£arena_get()ï¼šè·å¾—ä¸€ä¸ªarena"></a>â‘£arena_get()ï¼šè·å¾—ä¸€ä¸ªarena</h4><p>ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/* arena_get() acquires an arena and locks the corresponding mutex.</span><br><span class="hljs-comment">   First, try the one last locked successfully by this thread.  (This</span><br><span class="hljs-comment">   is the common case and handled with a macro for speed.)  Then, loop</span><br><span class="hljs-comment">   once over the circularly linked list of arenas.  If no arena is</span><br><span class="hljs-comment">   readily available, create a new one.  In this latter case, `size&#x27;</span><br><span class="hljs-comment">   is just a hint as to how much memory will be required immediately</span><br><span class="hljs-comment">   in the new arena. */</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> arena_get(ptr, size) do &#123; \</span><br><span class="hljs-meta">      ptr = thread_arena;						      \</span><br><span class="hljs-meta">      arena_lock (ptr, size);						      \</span><br><span class="hljs-meta">  &#125; while (0)</span><br><br></code></pre></td></tr></table></figure>

<p>arena_get()å®å°†ä¼šè·å–ä¸€ä¸ªç©ºé—´å……è¶³çš„arenaå¹¶é”ä¸Šå¯¹åº”çš„äº’æ–¥é”ï¼š</p>
<ul>
<li><strong>å°†thread_arenaç»™åˆ°ptrï¼Œå¹¶è°ƒç”¨arena_lock()å®è¿›è¡Œæ£€æŸ¥æ— è¯¯åå°è¯•é”ä¸Šäº’æ–¥é”</strong></li>
<li><strong>è‹¥æ£€æŸ¥å‘ç°thread_arenaä¸ºNULL</strong>ï¼ˆ<strong>è¯¥çº¿ç¨‹ç¬¬ä¸€æ¬¡è°ƒç”¨malloc</strong>ï¼‰<strong>æˆ–è¯¥arenaè¢«ç ´åï¼Œåˆ™ä¼šå°è¯•éå†arenaé“¾è¡¨å¯»æ‰¾å¯ç”¨çš„arena</strong></li>
<li><strong>è‹¥æ— æ³•æ‰¾å¯»åˆ°å¯ç”¨çš„arenaåˆ™ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„arena</strong></li>
</ul>
<p>æ¥ä¸‹æ¥æˆ‘ä»¬æ¥çœ‹å…¶å†…éƒ¨å®ç°çš„æ ¸å¿ƒå®arena_lock()ä¸æ ¸å¿ƒå‡½æ•°arena_get2()</p>
<blockquote>
<h5 id="do-â€¦-while-0-ï¼šçº¦å®šä¿—æˆä¹¦å†™å½¢å¼"><a href="#do-â€¦-while-0-ï¼šçº¦å®šä¿—æˆä¹¦å†™å½¢å¼" class="headerlink" title="do{â€¦}while(0)ï¼šçº¦å®šä¿—æˆä¹¦å†™å½¢å¼"></a>do{â€¦}while(0)ï¼šçº¦å®šä¿—æˆä¹¦å†™å½¢å¼</h5><p>æˆ–è®¸ä¸å°‘äººåœ¨ç¬¬ä¸€çœ¼çœ‹åˆ°è¿™ä¸ªå†™æ³•æ—¶éƒ½ä¼šè§‰å¾—è¿™ä¹ˆå†™æ˜¯åœ¨è„±è£¤å­æ”¾å±ï¼ˆxï¼‰ï¼ˆåŒ…æ‹¬ç¬”è€…ï¼‰ï¼Œä½†å…¶å®è¿™ç§å†™æ³•æœ‰å…¶å­˜åœ¨çš„æ„ä¹‰æ‰€åœ¨</p>
<p>è®¾æƒ³å‡å¦‚æˆ‘ä»¬å®šä¹‰äº†è¿™æ ·ä¸€ä¸ªå®ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> DO_SOMETHING_USELESS() foo1();foo2();</span><br></code></pre></td></tr></table></figure>

<p>è€Œå‡è®¾åœ¨è¿™æ ·ä¸€æ®µä»£ç ä¸­æˆ‘ä»¬ä½¿ç”¨äº†è¿™ä¸ªå®ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">if</span> (somthing)<br>	DO_SOMETHING_USELESS();<br><span class="hljs-keyword">else</span><br>	<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;fxck you!\n&quot;</span>);<br></code></pre></td></tr></table></figure>

<p>é‚£ä¹ˆä¼šè¢«å±•å¼€æˆå¦‚ä¸‹å½¢å¼ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">if</span> (somthing)<br>	foo1();foo2();;<br><span class="hljs-keyword">else</span><br>	<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;fxck you!\n&quot;</span>);<br></code></pre></td></tr></table></figure>

<p>æ¯«æ— ç–‘é—®ä¸‹æ–¹çš„elseä¾¿æ— æ³•åŒ¹é…åˆ°ä¸Šæ–¹çš„if</p>
<p>å¯èƒ½æœ‰äººæƒ³é—®äº†ï¼Œè‹¥æ˜¯åŠ ä¸ªæ‹¬å·å‘¢ï¼Ÿ</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> DO_SOMETHING_USELESS() &#123; foo1();foo2(); &#125;</span><br></code></pre></td></tr></table></figure>

<p>åˆ™å±•å¼€åæ˜¯å¦‚ä¸‹å½¢å¼ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">if</span> (somthing)<br>	&#123; foo1();foo2(); &#125;;<br><span class="hljs-keyword">else</span><br>	<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;fxck you!\n&quot;</span>);<br></code></pre></td></tr></table></figure>

<p>ç”±äºå¤šäº†ä¸€ä¸ªåˆ†å·ï¼Œä¸‹æ–¹çš„elseè¿˜æ˜¯æ— æ³•åŒ¹é…åˆ°ä¸Šæ–¹çš„if</p>
<p>å› æ­¤è€ƒè™‘ä½¿ç”¨do{â€¦}while(0)çš„å†™æ³•ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> DO_SOMETHING_USELESS() do&#123; foo1();foo2(); &#125;while(0)</span><br></code></pre></td></tr></table></figure>

<p>åˆ™å±•å¼€åæ˜¯å¦‚ä¸‹å½¢å¼ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">if</span> (somthing)<br>	<span class="hljs-keyword">do</span>&#123; foo1();foo2(); &#125;<span class="hljs-keyword">while</span>(<span class="hljs-number">0</span>);<br><span class="hljs-keyword">else</span><br>	<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;fxck you!\n&quot;</span>);<br></code></pre></td></tr></table></figure>

<p>ä¸‹æ–¹çš„elseä¾¿èƒ½æˆåŠŸåŒ¹é…åˆ°ä¸Šæ–¹çš„if</p>
<p>å¯èƒ½æœ‰äººè¦æ äº†ï¼šwsmä¸ç›´æ¥åŠ æ‹¬å·ã€ç„¶ååœ¨è°ƒç”¨è¯¥å®æ—¶ä¸å†™åˆ†å·ï¼Ÿè¿™æ˜¯å› ä¸ºå¯¹äºæ™®é€šçš„Cè¯­è¨€è¯­å¥è€Œè¨€å…¶æœ«å°¾è¯­æ³•è¦æ±‚æ˜¯è¦åŠ åˆ†å·çš„ï¼Œå› æ­¤å¤æ—©æ—¶æœŸå®çš„å†™æ³•ä¹Ÿä¾¿<strong>çº¦å®šä¿—æˆ</strong>è¦åœ¨è¯­å¥æœ«å°¾å†™ä¸Šåˆ†å·ï¼Œå› è€Œä¾¿å‡ºç°äº†do{}while(0)çš„å†™æ³•ï¼Œä»¥ä¾¿ç»Ÿä¸€å®ä¸ä¸€èˆ¬è¯­å¥çš„ä¹¦å†™æ ¼å¼</p>
</blockquote>
<h4 id="â‘¤arena-lock-ï¼šå°†arenaä¸Šé”"><a href="#â‘¤arena-lock-ï¼šå°†arenaä¸Šé”" class="headerlink" title="â‘¤arena_lock()ï¼šå°†arenaä¸Šé”"></a>â‘¤arena_lock()ï¼šå°†arenaä¸Šé”</h4><p>ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> arena_lock(ptr, size) do &#123;					      \</span><br><span class="hljs-meta">      <span class="hljs-keyword">if</span> (ptr &amp;&amp; !arena_is_corrupt (ptr))				      \</span><br><span class="hljs-meta">        (void) mutex_lock (&amp;ptr-&gt;mutex);				      \</span><br><span class="hljs-meta">      <span class="hljs-keyword">else</span>								      \</span><br><span class="hljs-meta">        ptr = arena_get2 ((size), NULL);				      \</span><br><span class="hljs-meta">  &#125; while (0)</span><br></code></pre></td></tr></table></figure>

<p>é¦–å…ˆæ£€æŸ¥ptræ˜¯å¦ä¸ºç©ºï¼Œå¹¶è°ƒç”¨arena_is_corruptå®æ£€æŸ¥arenaæ˜¯å¦è¢«ç ´å</p>
<ul>
<li>è‹¥æ˜¯æ£€æŸ¥é€šè¿‡ï¼Œåˆ™è°ƒç”¨mutex_lock()å‡½æ•°å°†arenaä¸­çš„äº’æ–¥é”ä¸Šé”ï¼ˆå¤šçº¿ç¨‹ç›¸å…³å‡½æ•°ä¾¿ä¸åœ¨è¿™é‡Œèµ˜å™äº†ï¼‰</li>
<li>è‹¥æ˜¯æ£€æŸ¥ä¸é€šè¿‡ï¼Œåˆ™è°ƒç”¨arena_get2()å‡½æ•°è·å¾—ä¸€ä¸ªæ–°çš„arena</li>
</ul>
<h4 id="â‘¥arena-get2-ï¼šéå†free-listï¼Œè‹¥æ— åˆé€‚åˆ™å°è¯•è·å–ä¸€ä¸ªæ–°çš„arenaæˆ–ä½¿ç”¨å·²æœ‰arena"><a href="#â‘¥arena-get2-ï¼šéå†free-listï¼Œè‹¥æ— åˆé€‚åˆ™å°è¯•è·å–ä¸€ä¸ªæ–°çš„arenaæˆ–ä½¿ç”¨å·²æœ‰arena" class="headerlink" title="â‘¥arena_get2()ï¼šéå†free_listï¼Œè‹¥æ— åˆé€‚åˆ™å°è¯•è·å–ä¸€ä¸ªæ–°çš„arenaæˆ–ä½¿ç”¨å·²æœ‰arena"></a>â‘¥arena_get2()ï¼šéå†free_listï¼Œè‹¥æ— åˆé€‚åˆ™å°è¯•è·å–ä¸€ä¸ªæ–°çš„arenaæˆ–ä½¿ç”¨å·²æœ‰arena</h4><p>arena_get2()å‡½æ•°åŒæ ·å®šä¹‰äºarena.cä¸­ï¼Œå¦‚ä¸‹</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> mstate<br>internal_function<br><span class="hljs-title function_">arena_get2</span> <span class="hljs-params">(<span class="hljs-type">size_t</span> size, mstate avoid_arena)</span><br>&#123;<br>  mstate a;<br><br>  <span class="hljs-type">static</span> <span class="hljs-type">size_t</span> narenas_limit;<br><br>  a = get_free_list ();<br>  <span class="hljs-keyword">if</span> (a == <span class="hljs-literal">NULL</span>)<br>    &#123;<br>      <span class="hljs-comment">/* Nothing immediately available, so generate a new arena.  */</span><br>      <span class="hljs-keyword">if</span> (narenas_limit == <span class="hljs-number">0</span>)<br>        &#123;<br>          <span class="hljs-keyword">if</span> (mp_.arena_max != <span class="hljs-number">0</span>)<br>            narenas_limit = mp_.arena_max;<br>          <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (narenas &gt; mp_.arena_test)<br>            &#123;<br>              <span class="hljs-type">int</span> n = __get_nprocs ();<br><br>              <span class="hljs-keyword">if</span> (n &gt;= <span class="hljs-number">1</span>)<br>                narenas_limit = NARENAS_FROM_NCORES (n);<br>              <span class="hljs-keyword">else</span><br>                <span class="hljs-comment">/* We have no information about the system.  Assume two</span><br><span class="hljs-comment">                   cores.  */</span><br>                narenas_limit = NARENAS_FROM_NCORES (<span class="hljs-number">2</span>);<br>            &#125;<br>        &#125;<br>    repeat:;<br>      <span class="hljs-type">size_t</span> n = narenas;<br>      <span class="hljs-comment">/* NB: the following depends on the fact that (size_t)0 - 1 is a</span><br><span class="hljs-comment">         very large number and that the underflow is OK.  If arena_max</span><br><span class="hljs-comment">         is set the value of arena_test is irrelevant.  If arena_test</span><br><span class="hljs-comment">         is set but narenas is not yet larger or equal to arena_test</span><br><span class="hljs-comment">         narenas_limit is 0.  There is no possibility for narenas to</span><br><span class="hljs-comment">         be too big for the test to always fail since there is not</span><br><span class="hljs-comment">         enough address space to create that many arenas.  */</span><br>      <span class="hljs-keyword">if</span> (__glibc_unlikely (n &lt;= narenas_limit - <span class="hljs-number">1</span>))<br>        &#123;<br>          <span class="hljs-keyword">if</span> (catomic_compare_and_exchange_bool_acq (&amp;narenas, n + <span class="hljs-number">1</span>, n))<br>            <span class="hljs-keyword">goto</span> repeat;<br>          a = _int_new_arena (size);<br>	  <span class="hljs-keyword">if</span> (__glibc_unlikely (a == <span class="hljs-literal">NULL</span>))<br>            catomic_decrement (&amp;narenas);<br>        &#125;<br>      <span class="hljs-keyword">else</span><br>        a = reused_arena (avoid_arena);<br>    &#125;<br>  <span class="hljs-keyword">return</span> a;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>é¦–å…ˆä¼šè°ƒç”¨get_free_list()å‡½æ•°å°è¯•ä»free_listä¸­è·å–ä¸€ä¸ªarenaï¼Œ<strong>è‹¥æˆåŠŸåˆ™ç›´æ¥è¿”å›</strong></p>
<p>è‹¥æ— æ³•ä»free_listä¸­è·å–è·å–åˆ°arenaï¼ˆfree_lIstä¸ºç©ºï¼‰ï¼Œé¦–å…ˆä¼šæ£€æŸ¥<code>narenas_limit</code>å˜é‡æ˜¯å¦ä¸º0ï¼Œ<strong>è¯¥å˜é‡ç”¨ä»¥è®°å½•ä¸€ä¸ªè¿›ç¨‹ä¸­çš„arenaæ•°é‡é™åˆ¶</strong>ï¼Œç”±äºè¯¥å˜é‡ä¸ºé™æ€å˜é‡ï¼Œæ•…åˆå§‹å€¼é»˜è®¤åº”å½“ä¸º0</p>
<p>åˆå§‹å€¼ä¸º0çš„æƒ…å†µä¸‹ä¾¿ä¼šå…ˆæ£€æŸ¥ptmallocå‚æ•°ä¸­çš„arena_maxæ˜¯å¦ä¸º0ï¼Œç”±äºmp_ä¹Ÿæ˜¯ä¸€ä¸ªé™æ€å˜é‡ï¼Œæ•…arena_maxåˆå§‹å€¼ä¹Ÿåº”å½“ä¸º0</p>
<p>è‹¥arena_maxä¸ä¸º0ï¼ˆæ²¡æœ‰è®¾å®šarena_maxï¼‰ï¼Œåˆ™ç›´æ¥å°†å…¶å€¼èµ‹äºˆnarenas_limit</p>
<p>å¦åˆ™ï¼Œå°†narenasä¸ptmallocå‚æ•°ä¸­çš„arena_testè¿›è¡Œæ¯”è¾ƒï¼Œ<strong>è‹¥æ˜¯arenaæ•°é‡å·²ç»è¶…å‡ºäº†testå€¼</strong>ï¼Œåˆ™<strong>é‡æ–°åˆå§‹åŒ–arenaæ•°é‡ä¸Šé™</strong>ï¼šè°ƒç”¨<code>__get_nprocs()</code>å‡½æ•°<strong>è·å–CPUçš„æ ¸å¿ƒæ•°ä»¥è®¾å®šarenaçš„æ•°é‡ä¸Šé™ï¼Œ32ä½ä¸‹ä¸ºæ ¸å¿ƒæ•°ä¹˜2ï¼Œ64ä½ä¸‹ä¸ºæ ¸å¿ƒæ•°ä¹˜8ï¼Œè‹¥æ˜¯æ— æ³•è·å–åˆ°æ ¸å¿ƒæ•°ï¼Œåˆ™ç›´æ¥æŒ‰ç…§æ ¸å¿ƒæ•°ä¸º2è¿›è¡Œè®¡ç®—</strong>ï¼Œå½“çº¿ç¨‹æ•°å¤§äºæ ¸å¿ƒæ•°çš„2å€æ—¶ï¼Œä¾¿å¿…ç„¶æœ‰çº¿ç¨‹å¤„äºç­‰å¾…çŠ¶æ€ï¼Œå› æ­¤åœ¨è¿™é‡Œä¾¿æ ¹æ®æ ¸å¿ƒæ•°è®¡ç®—arenaä¸Šé™æ•°ï¼ˆè‡³äº64ä½ä¸‹ä¸ºä»€ä¹ˆæ˜¯ä¹˜8ï¼Œç¬”è€…ä¹Ÿæš‚ä¸”è’™åœ¨å¤é‡Œ<del>æŒ‡åœ¨è’™å¤å¾…ä¼š</del>ï¼‰</p>
<p>éšå<strong>æ£€æŸ¥arenaæ•°é‡æ˜¯å¦è¾¾åˆ°ä¸Šé™</strong>ï¼ˆnarenas &#x3D;&#x3D; narena_limitï¼‰ï¼Œ<strong>è‹¥å¦</strong>ï¼Œåˆ™æ¥ä¸‹æ¥ä¼šè°ƒç”¨å®<code>catomic_compare_and_exchange_bool_acq</code><strong>å°†narenasçš„å€¼åŠ 1</strong>ï¼Œéšåè°ƒç”¨<code>_int_new_arena()</code>å‡½æ•°<strong>åˆ›å»ºä¸€ä¸ªæ–°çš„arena</strong>ï¼Œè‹¥æˆåŠŸåˆ™è¿”å›ï¼Œ<strong>å¦åˆ™é‡æ–°å°†narenasçš„å€¼å‡1</strong></p>
<p>è‹¥<strong>arenaæ•°é‡å·²ç»è¾¾åˆ°ä¸Šé™</strong>ï¼Œåˆ™ä¼šè°ƒç”¨<code>reused_arena()</code>å‡½æ•°å°è¯•ä»ç°æœ‰arenaä¸­å¯»æ‰¾å¯ç”¨çš„arenaä¸Šé”åè¿”å›ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯è¯¥å‡½æ•°éå†arenaæ—¶ä¼šè¿‡æ»¤æ‰ä¼ å…¥çš„avoid_arena</p>
<blockquote>
<h5 id="glibc-likely-expr-glibc-unlikely-expr-ï¼šåˆ†æ”¯é¢„æµ‹ä¼˜åŒ–ï¼ˆå°è£…å®ï¼‰"><a href="#glibc-likely-expr-glibc-unlikely-expr-ï¼šåˆ†æ”¯é¢„æµ‹ä¼˜åŒ–ï¼ˆå°è£…å®ï¼‰" class="headerlink" title="__glibc_likely(expr) &amp;&amp; __glibc_unlikely(expr)ï¼šåˆ†æ”¯é¢„æµ‹ä¼˜åŒ–ï¼ˆå°è£…å®ï¼‰"></a>__glibc_likely(expr) &amp;&amp; __glibc_unlikely(expr)ï¼šåˆ†æ”¯é¢„æµ‹ä¼˜åŒ–ï¼ˆå°è£…å®ï¼‰</h5><p>å¯¹__builtin_expectå®çš„å°è£…ï¼Œå®šä¹‰äºmisc&#x2F;sys&#x2F;cdefs.hä¸­ï¼Œå¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">if</span> __GNUC__ &gt;= 3</span><br><span class="hljs-meta"># <span class="hljs-keyword">define</span> __glibc_unlikely(cond)	__builtin_expect ((cond), 0)</span><br><span class="hljs-meta"># <span class="hljs-keyword">define</span> __glibc_likely(cond)	__builtin_expect ((cond), 1)</span><br><span class="hljs-meta">#<span class="hljs-keyword">else</span></span><br><span class="hljs-meta"># <span class="hljs-keyword">define</span> __glibc_unlikely(cond)	(cond)</span><br><span class="hljs-meta"># <span class="hljs-keyword">define</span> __glibc_likely(cond)	(cond)</span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br></code></pre></td></tr></table></figure>

<p>åªæœ‰å®__GNUC__çš„å€¼å¤§äº3æ—¶æ‰ä¼šå¯ç”¨è¯¥å®ï¼Œå…¶æ ¸å¿ƒæ˜¯å®__bulltin_expect(expr, var)</p>
</blockquote>
<blockquote>
<h5 id="internal-function"><a href="#internal-function" class="headerlink" title="internal_function"></a>internal_function</h5><p>å®šä¹‰äºmalloc.cä¸­ï¼Œå¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/* On some platforms we can compile internal, not exported functions better.</span><br><span class="hljs-comment">Let the environment provide a macro and define it to be empty if it</span><br><span class="hljs-comment">is not available.  */</span><br><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> internal_function</span><br><span class="hljs-meta"># <span class="hljs-keyword">define</span> internal_function</span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br></code></pre></td></tr></table></figure>

<p>å¤§æ„æ˜¯è¯´è¿™æ˜¯ä¸ºäº†ä¸€äº›ç‰¹æ®Šç”¨é€”è€Œé¢„ç•™çš„ä¸€ä¸ªå®ï¼Œè¯¥å®é»˜è®¤å®šä¹‰ä¸ºç©º</p>
</blockquote>
<blockquote>
<h5 id="catomic-compare-and-exchange-bool-acq"><a href="#catomic-compare-and-exchange-bool-acq" class="headerlink" title="catomic_compare_and_exchange_bool_acq"></a>catomic_compare_and_exchange_bool_acq</h5><p>è¯¥å®å®šä¹‰äºinclude&#x2F;atomic.hä¸­ï¼Œå¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> catomic_compare_and_exchange_bool_acq</span><br><span class="hljs-meta"># <span class="hljs-keyword">ifdef</span> __arch_c_compare_and_exchange_bool_32_acq</span><br><span class="hljs-meta">#  <span class="hljs-keyword">define</span> catomic_compare_and_exchange_bool_acq(mem, newval, oldval) \</span><br><span class="hljs-meta">__atomic_bool_bysize (__arch_c_compare_and_exchange_bool,acq,		      \</span><br><span class="hljs-meta">		        mem, newval, oldval)</span><br><span class="hljs-meta"># <span class="hljs-keyword">else</span></span><br><span class="hljs-meta">#  <span class="hljs-keyword">define</span> catomic_compare_and_exchange_bool_acq(mem, newval, oldval) \</span><br><span class="hljs-meta">(&#123; <span class="hljs-comment">/* Cannot use __oldval here, because macros later in this file might     \</span></span><br><span class="hljs-comment"><span class="hljs-meta">	call this macro with __oldval argument.	 */</span>			      \</span><br><span class="hljs-meta">__typeof (oldval) __atg4_old = (oldval);				      \</span><br><span class="hljs-meta">catomic_compare_and_exchange_val_acq (mem, newval, __atg4_old)	      \</span><br><span class="hljs-meta">!= __atg4_old;							      \</span><br><span class="hljs-meta">&#125;)</span><br><span class="hljs-meta"># <span class="hljs-keyword">endif</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br></code></pre></td></tr></table></figure>

<p>åœ¨glibcæºç ä¸­ç¬”è€…å¹¶æ²¡æœ‰æ‰¾åˆ°å…³äº<code>__arch_c_compare_and_exchange_bool_32_acq</code>å®çš„å®šä¹‰ï¼Œæ•…é»˜è®¤åº”å½“æ˜¯ä½¿ç”¨elseè¿™ä¸€å—çš„å†…å®¹</p>
<p>é¦–å…ˆä¼šå°†oldvalçš„å€¼æ‹·è´ä¸€ä»½ï¼Œéšåå†è°ƒç”¨å®<code>catomic_compare_and_exchange_val_acq</code>ï¼ˆ<del>å¥—å¨ƒæ¥å¥—å¨ƒå»</del></p>
<p>è¯¥å®åŒæ ·ä½äºinclude&#x2F;atomic.hä¸­ï¼Œå¦‚ä¸‹</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> catomic_compare_and_exchange_val_acq</span><br><span class="hljs-meta"># <span class="hljs-keyword">ifdef</span> __arch_c_compare_and_exchange_val_32_acq</span><br><span class="hljs-meta">#  <span class="hljs-keyword">define</span> catomic_compare_and_exchange_val_acq(mem, newval, oldval) \</span><br><span class="hljs-meta">__atomic_val_bysize (__arch_c_compare_and_exchange_val,acq,		      \</span><br><span class="hljs-meta">		       mem, newval, oldval)</span><br><span class="hljs-meta"># <span class="hljs-keyword">else</span></span><br><span class="hljs-meta">#  <span class="hljs-keyword">define</span> catomic_compare_and_exchange_val_acq(mem, newval, oldval) \</span><br><span class="hljs-meta">atomic_compare_and_exchange_val_acq (mem, newval, oldval)</span><br><span class="hljs-meta"># <span class="hljs-keyword">endif</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br></code></pre></td></tr></table></figure>

<p><del>åˆå¥—äº†ä¸€å±‚å¨ƒ</del></p>
<p>ç»§ç»­è·Ÿè¿›</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/* Atomically store NEWVAL in *MEM if *MEM is equal to OLDVAL.</span><br><span class="hljs-comment">Return the old *MEM value.  */</span><br><span class="hljs-meta">#<span class="hljs-keyword">if</span> !defined atomic_compare_and_exchange_val_acq \</span><br><span class="hljs-meta"> &amp;&amp; defined __arch_compare_and_exchange_val_32_acq</span><br><span class="hljs-meta"># <span class="hljs-keyword">define</span> atomic_compare_and_exchange_val_acq(mem, newval, oldval) \</span><br><span class="hljs-meta">__atomic_val_bysize (__arch_compare_and_exchange_val,acq,		      \</span><br><span class="hljs-meta">		       mem, newval, oldval)</span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br></code></pre></td></tr></table></figure>

<p>å®<code>__arch_compare_and_exchange_val_32_acq</code>å·²ç»åœ¨sysdeps&#x2F;ï¼ˆå¤šä¸ªæ–‡ä»¶å¤¹ä¸­çš†æœ‰ï¼‰&#x2F;atomic-machine.hä¸­å®šä¹‰äº†ï¼Œæˆ‘ä»¬ç›´æ¥è·Ÿè¿›<code>__atomic_val_bysize</code>çš„å®šä¹‰å³å¯</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/* Wrapper macros to call pre_NN_post (mem, ...) where NN is the</span><br><span class="hljs-comment">bit width of *MEM.  The calling macro puts parens around MEM</span><br><span class="hljs-comment">and following args.  */</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> __atomic_val_bysize(pre, post, mem, ...)			      \</span><br><span class="hljs-meta">(&#123;									      \</span><br><span class="hljs-meta"> __typeof (*mem) __atg1_result;					      \</span><br><span class="hljs-meta"> <span class="hljs-keyword">if</span> (sizeof (*mem) == 1)						      \</span><br><span class="hljs-meta">   __atg1_result = pre##_8_##post (mem, __VA_ARGS__);		      \</span><br><span class="hljs-meta"> <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (sizeof (*mem) == 2)					      \</span><br><span class="hljs-meta">   __atg1_result = pre##_16_##post (mem, __VA_ARGS__);		      \</span><br><span class="hljs-meta"> <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (sizeof (*mem) == 4)					      \</span><br><span class="hljs-meta">   __atg1_result = pre##_32_##post (mem, __VA_ARGS__);		      \</span><br><span class="hljs-meta"> <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (sizeof (*mem) == 8)					      \</span><br><span class="hljs-meta">   __atg1_result = pre##_64_##post (mem, __VA_ARGS__);		      \</span><br><span class="hljs-meta"> <span class="hljs-keyword">else</span>								      \</span><br><span class="hljs-meta">   abort ();								      \</span><br><span class="hljs-meta"> __atg1_result;							      \</span><br><span class="hljs-meta">&#125;)</span><br></code></pre></td></tr></table></figure>

<p>åœ¨è¿™é‡Œåˆ™åˆä¼šæ ¹æ®<code>*mem</code>çš„å¤§å°è°ƒç”¨ç›¸åº”çš„å®ï¼Œå®šä¹‰äºsysdeps&#x2F;ia64&#x2F;atomic-machine.hä¸­ï¼Œå¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> __arch_compare_and_exchange_val_8_acq(mem, newval, oldval) \</span><br><span class="hljs-meta">(abort (), (__typeof (*mem)) 0)</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> __arch_compare_and_exchange_val_16_acq(mem, newval, oldval) \</span><br><span class="hljs-meta">(abort (), (__typeof (*mem)) 0)</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> __arch_compare_and_exchange_val_32_acq(mem, newval, oldval) \</span><br><span class="hljs-meta">__sync_val_compare_and_swap ((mem), (int) (long) (oldval), \</span><br><span class="hljs-meta">			       (int) (long) (newval))</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> __arch_compare_and_exchange_val_64_acq(mem, newval, oldval) \</span><br><span class="hljs-meta">__sync_val_compare_and_swap ((mem), (long) (oldval), (long) (newval))</span><br></code></pre></td></tr></table></figure>

<p>å¯¹äº1å­—èŠ‚ä¸2å­—èŠ‚é•¿çš„æŒ‡é’ˆï¼Œè¿›ç¨‹ä¼šç›´æ¥è°ƒç”¨abort()ç»ˆæ­¢ï¼ˆç¬”è€…ä¹Ÿä¸æ˜ç™½wsmè¿™ä¹ˆè®¾è®¡ï¼‰ï¼Œè€Œå¯¹äº4å­—èŠ‚é•¿ä¸8å­—èŠ‚é•¿çš„æŒ‡é’ˆï¼Œåˆ™ä¼šè°ƒç”¨<strong>GCCå†…ç½®çš„åŸå­æ“ä½œ</strong><code>__sync_val_compare_and_swap</code></p>
<p>æŸ¥çœ‹<a target="_blank" rel="noopener" href="https://gcc.gnu.org/onlinedocs/gcc-4.1.1/gcc/Atomic-Builtins.html">GCCæ‰‹å†Œ</a>ä¸­è¯´æ˜å¦‚ä¸‹ï¼š</p>
<blockquote>
<figure class="highlight autohotkey"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs autohotkey">bool __sync_bool_compare_and_swap (`type` *ptr, `type` oldval `type` newval, ...)<br></code></pre></td></tr></table></figure>

<p>type<code> __sync_val_compare_and_swap (</code>type<code>*ptr,</code>type<code>oldval</code>type<code> newval, ...)</code></p>
<p>ptrisoldval  ptr</p>
<p>The â€œboolâ€ version returns true if the comparison is successful and newval was written. The â€œvalâ€ version returns the contents of <code>*</code>ptr before the operation. </p>
</blockquote>
<p>é‚£ä¹ˆä¸€åˆ‡å°±çœŸç›¸å¤§ç™½äº†</p>
<p><del>å¥—å¨ƒ</del><code>catomic_compare_and_exchange_bool_acq</code>å®éœ€è¦ä¼ å…¥ä¸‰ä¸ªå‚æ•°ï¼š<code>mem</code>ã€<code>newval</code>ã€<code>oldval</code>ï¼Œå…¶ä¸­memåº”å½“è¦ä¸ºä¸€ä¸ªæŒ‡é’ˆç±»å‹ï¼Œéšåæ¯”è¾ƒ<code>oldval</code>ä¸<code>*mem</code>çš„å€¼æ˜¯å¦ç›¸ç­‰ï¼Œè‹¥æ˜¯åˆ™å°†<code>*mem</code>èµ‹å€¼ä¸º<code>newval</code>å¹¶è¿”å›0ï¼Œè‹¥å¦åˆ™è¿”å›éé›¶å€¼</p>
</blockquote>
<blockquote>
<h5 id="catomic-decrement"><a href="#catomic-decrement" class="headerlink" title="catomic_decrement"></a>catomic_decrement</h5><p>å®šä¹‰äºinclude&#x2F;atomic.hä¸­ï¼Œå¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> catomic_decrement</span><br><span class="hljs-meta"># <span class="hljs-keyword">define</span> catomic_decrement(mem) catomic_add ((mem), -1)</span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br></code></pre></td></tr></table></figure>

<p>å¥—å¨ƒï¼Œè·Ÿè¿›</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> catomic_add</span><br><span class="hljs-meta"># <span class="hljs-keyword">define</span> catomic_add(mem, value) \</span><br><span class="hljs-meta">(void) catomic_exchange_and_add ((mem), (value))</span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br></code></pre></td></tr></table></figure>

<p>è¿˜æ˜¯å¥—å¨ƒï¼Œå†è·Ÿè¿›</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> catomic_exchange_and_add</span><br><span class="hljs-meta"># <span class="hljs-keyword">define</span> catomic_exchange_and_add(mem, value) \</span><br><span class="hljs-meta">(&#123; __typeof (*(mem)) __atg7_oldv;					      \</span><br><span class="hljs-meta">  __typeof (mem) __atg7_memp = (mem);				      \</span><br><span class="hljs-meta">  __typeof (*(mem)) __atg7_value = (value);				      \</span><br><span class="hljs-meta">									      \</span><br><span class="hljs-meta">  do									      \</span><br><span class="hljs-meta">    __atg7_oldv = *__atg7_memp;					      \</span><br><span class="hljs-meta">  while (__builtin_expect						      \</span><br><span class="hljs-meta">	    (catomic_compare_and_exchange_bool_acq (__atg7_memp,	      \</span><br><span class="hljs-meta">						    __atg7_oldv		      \</span><br><span class="hljs-meta">						    + __atg7_value,	      \</span><br><span class="hljs-meta">						    __atg7_oldv), 0));	      \</span><br><span class="hljs-meta">									      \</span><br><span class="hljs-meta">  __atg7_oldv; &#125;)</span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br></code></pre></td></tr></table></figure>

<p>æœ€ç»ˆæˆ‘ä»¬å¯ä»¥çŸ¥é“è¯¥å®çš„ç”¨å¤„æ˜¯å°†ä¸€ä¸ªå˜é‡çš„å€¼å‡ä¸€ï¼ŒåŒæ ·ç”±äºè€ƒè™‘åˆ°å¤šçº¿ç¨‹æ“ä½œçš„æƒ…å†µï¼Œåœ¨è¿™é‡Œä½¿ç”¨çš„æ˜¯åŸå­æ“ä½œ</p>
</blockquote>
<h4 id="â‘¦reused-arena-ï¼šå¯»æ‰¾å¯ç”¨arenaä¸Šé”åè¿”å›"><a href="#â‘¦reused-arena-ï¼šå¯»æ‰¾å¯ç”¨arenaä¸Šé”åè¿”å›" class="headerlink" title="â‘¦reused_arena()ï¼šå¯»æ‰¾å¯ç”¨arenaä¸Šé”åè¿”å›"></a>â‘¦reused_arena()ï¼šå¯»æ‰¾å¯ç”¨arenaä¸Šé”åè¿”å›</h4><p>åŒæ ·å®šä¹‰äºarena.hä¸­ï¼Œå¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/* Lock and return an arena that can be reused for memory allocation.</span><br><span class="hljs-comment">   Avoid AVOID_ARENA as we have already failed to allocate memory in</span><br><span class="hljs-comment">   it and it is currently locked.  */</span><br><span class="hljs-type">static</span> mstate<br><span class="hljs-title function_">reused_arena</span> <span class="hljs-params">(mstate avoid_arena)</span><br>&#123;<br>  mstate result;<br>  <span class="hljs-comment">/* <span class="hljs-doctag">FIXME:</span> Access to next_to_use suffers from data races.  */</span><br>  <span class="hljs-type">static</span> mstate next_to_use;<br>  <span class="hljs-keyword">if</span> (next_to_use == <span class="hljs-literal">NULL</span>)<br>    next_to_use = &amp;main_arena;<br><br>  <span class="hljs-comment">/* Iterate over all arenas (including those linked from</span><br><span class="hljs-comment">     free_list).  */</span><br>  result = next_to_use;<br>  <span class="hljs-keyword">do</span><br>    &#123;<br>      <span class="hljs-keyword">if</span> (!arena_is_corrupt (result) &amp;&amp; !mutex_trylock (&amp;result-&gt;mutex))<br>        <span class="hljs-keyword">goto</span> out;<br><br>      <span class="hljs-comment">/* <span class="hljs-doctag">FIXME:</span> This is a data race, see _int_new_arena.  */</span><br>      result = result-&gt;next;<br>    &#125;<br>  <span class="hljs-keyword">while</span> (result != next_to_use);<br><br>  <span class="hljs-comment">/* Avoid AVOID_ARENA as we have already failed to allocate memory</span><br><span class="hljs-comment">     in that arena and it is currently locked.   */</span><br>  <span class="hljs-keyword">if</span> (result == avoid_arena)<br>    result = result-&gt;next;<br><br>  <span class="hljs-comment">/* Make sure that the arena we get is not corrupted.  */</span><br>  mstate begin = result;<br>  <span class="hljs-keyword">while</span> (arena_is_corrupt (result) || result == avoid_arena)<br>    &#123;<br>      result = result-&gt;next;<br>      <span class="hljs-keyword">if</span> (result == begin)<br>	<span class="hljs-keyword">break</span>;<br>    &#125;<br><br>  <span class="hljs-comment">/* We could not find any arena that was either not corrupted or not the one</span><br><span class="hljs-comment">     we wanted to avoid.  */</span><br>  <span class="hljs-keyword">if</span> (result == begin || result == avoid_arena)<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;<br><br>  <span class="hljs-comment">/* No arena available without contention.  Wait for the next in line.  */</span><br>  LIBC_PROBE (memory_arena_reuse_wait, <span class="hljs-number">3</span>, &amp;result-&gt;mutex, result, avoid_arena);<br>  (<span class="hljs-type">void</span>) mutex_lock (&amp;result-&gt;mutex);<br><br>out:<br>  <span class="hljs-comment">/* Attach the arena to the current thread.  Note that we may have</span><br><span class="hljs-comment">     selected an arena which was on free_list.  */</span><br>  &#123;<br>    <span class="hljs-comment">/* Update the arena thread attachment counters.   */</span><br>    mstate replaced_arena = thread_arena;<br>    (<span class="hljs-type">void</span>) mutex_lock (&amp;free_list_lock);<br>    detach_arena (replaced_arena);<br>    ++result-&gt;attached_threads;<br>    (<span class="hljs-type">void</span>) mutex_unlock (&amp;free_list_lock);<br>  &#125;<br><br>  LIBC_PROBE (memory_arena_reuse, <span class="hljs-number">2</span>, result, avoid_arena);<br>  thread_arena = result;<br>  next_to_use = result-&gt;next;<br><br>  <span class="hljs-keyword">return</span> result;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>æ“ä½œæ­¥éª¤å¦‚ä¸‹ï¼š</p>
<ul>
<li><p>é¦–å…ˆæ£€æŸ¥next_to_useï¼Œè‹¥ä¸ºNULLåˆ™è®¾ä¸ºmain_arena</p>
</li>
<li><p>æ¥ä¸‹æ¥ä»next_to_useå¼€å§‹éå†arenaé“¾è¡¨ï¼Œè‹¥æ‰¾åˆ°ä¸€ä¸ª<strong>æœªè¢«ç ´åä¸”èƒ½æˆåŠŸä¸Šé”çš„arena</strong>ï¼ˆå³è¯¥æœªè¢«ç ´åçš„arenaæœªè¢«ä¸Šé”ï¼‰åˆ™è·³è½¬åˆ°ä¸‹ä¸€æ­¥ï¼Œå¦åˆ™ä¼šäºŒæ¬¡éå†arenaé“¾è¡¨ï¼Œå¯»æ‰¾<strong>æœªè¢«ç ´åçš„ä¸”éavoid_arena</strong>çš„arenaå¹¶ä¸Šé”ï¼Œè‹¥ä»æ—§å¤±è´¥åˆ™è¿”å›NULL</p>
</li>
<li><p>æ¥ä¸‹æ¥å°†<strong>åŸarenaå…³è”çº¿ç¨‹æ•°å‡ä¸€ï¼Œæ–°arenaå…³è”çº¿ç¨‹æ•°åŠ ä¸€</strong>ï¼Œå¹¶å°†next_to_useè®¾ä¸ºè¯¥arenaçš„nextæŒ‡é’ˆæŒ‡å‘çš„arenaï¼Œä¸ºäº†é˜²æ­¢å¤šçº¿ç¨‹å†²çªï¼Œè¿™ä¸€æ­¥æ“ä½œä¼šå…ˆé”ä¸Šfree_listï¼Œæ“ä½œç»“æŸåå†è¡Œè§£é”</p>
</li>
<li><p>æœ€å<strong>å°†è¯¥çº¿ç¨‹arenaè®¾ä¸ºè·å–åˆ°çš„arenaå¹¶è¿”å›</strong></p>
</li>
</ul>
<h4 id="â‘§detach-arena-ï¼šå°†arenaå…³è”çº¿ç¨‹æ•°å‡ä¸€"><a href="#â‘§detach-arena-ï¼šå°†arenaå…³è”çº¿ç¨‹æ•°å‡ä¸€" class="headerlink" title="â‘§detach_arena()ï¼šå°†arenaå…³è”çº¿ç¨‹æ•°å‡ä¸€"></a>â‘§detach_arena()ï¼šå°†arenaå…³è”çº¿ç¨‹æ•°å‡ä¸€</h4><p>åŒæ ·å®šä¹‰äºarena.cä¸­ï¼Œå¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/* If REPLACED_ARENA is not NULL, detach it from this thread.  Must be</span><br><span class="hljs-comment">   called while free_list_lock is held.  */</span><br><span class="hljs-type">static</span> <span class="hljs-type">void</span><br><span class="hljs-title function_">detach_arena</span> <span class="hljs-params">(mstate replaced_arena)</span><br>&#123;<br>  <span class="hljs-keyword">if</span> (replaced_arena != <span class="hljs-literal">NULL</span>)<br>    &#123;<br>      assert (replaced_arena-&gt;attached_threads &gt; <span class="hljs-number">0</span>);<br>      <span class="hljs-comment">/* The current implementation only detaches from main_arena in</span><br><span class="hljs-comment">	 case of allocation failure.  This means that it is likely not</span><br><span class="hljs-comment">	 beneficial to put the arena on free_list even if the</span><br><span class="hljs-comment">	 reference count reaches zero.  */</span><br>      --replaced_arena-&gt;attached_threads;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>è¯¥å‡½æ•°é¦–å…ˆä¼šæ£€æŸ¥å…¶å‚æ•°replace_arenaæ˜¯å¦ä¸ä¸ºNULLï¼Œåªæœ‰ä¸ä¸ºNULLæ—¶æ‰ä¼šè¿›ä¸€æ­¥æ“ä½œ</p>
<p>éšå<strong>ä½¿ç”¨assertæ£€æŸ¥replace_arenaçš„attached_threadsæˆå‘˜æ˜¯å¦å¤§äº0</strong></p>
<p>åªæœ‰åœ¨ä¸€åˆ‡æ­£å¸¸çš„æƒ…å†µä¸‹ï¼Œæ‰ä¼šå°†è¯¥arenaçš„å…³è”çº¿ç¨‹æ•°å‡ä¸€</p>
<h4 id="â‘¨arena-for-chunk-ï¼šè·å–ä¸€ä¸ªå †å—å¯¹åº”çš„arena"><a href="#â‘¨arena-for-chunk-ï¼šè·å–ä¸€ä¸ªå †å—å¯¹åº”çš„arena" class="headerlink" title="â‘¨arena_for_chunk()ï¼šè·å–ä¸€ä¸ªå †å—å¯¹åº”çš„arena"></a>â‘¨arena_for_chunk()ï¼šè·å–ä¸€ä¸ªå †å—å¯¹åº”çš„arena</h4><p>è¯¥å®å®šä¹‰äºarena.cä¸­ï¼Œå¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> arena_for_chunk(ptr) \</span><br><span class="hljs-meta">  (chunk_non_main_arena (ptr) ? heap_for_ptr (ptr)-&gt;ar_ptr : &amp;main_arena)</span><br></code></pre></td></tr></table></figure>

<p>é¦–å…ˆä¼šæ£€æŸ¥è¯¥chunkçš„<code>NON_MAIN_ARENA</code>æ ‡å¿—ä½ï¼Œè‹¥ä¸ºfalseåˆ™ç›´æ¥è¿”å›main_arenaï¼Œå¦åˆ™ä¼šå…ˆè·å–è¯¥chunkæ‰€å±çš„heapåå†é€šè¿‡heap headerï¼ˆheap_infoï¼‰è·å–åˆ°å…¶æ‰€å±çš„arena</p>

                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
    <div class="post-meta mr-3 d-flex align-items-center">
      <i class="iconfont icon-category"></i>
      

<span class="category-chains">
  
  
    
      <span class="category-chain">
        
  <a href="/categories/GLIBC/" class="category-chain-item">GLIBC</a>
  
  

      </span>
    
  
</span>

    </div>
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/%E5%A0%86/">#å †</a>
      
        <a href="/tags/ptmalloc/">#ptmalloc</a>
      
        <a href="/tags/glibc/">#glibc</a>
      
        <a href="/tags/%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86/">#å†…å­˜ç®¡ç†</a>
      
    </div>
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>ã€GLIBC.0x00ã€‘glibc2.23 mallocæºç åˆ†æ - Iï¼šå †å†…å­˜çš„åŸºæœ¬ç»„ç»‡å½¢å¼</div>
      <div>https://arttnba3.github.io/2021/01/15/GLIBC-0X00-MALLOC-2.23-PART-I/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>ä½œè€…</div>
          <div>arttnba3</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>å‘å¸ƒäº</div>
          <div>2021å¹´1æœˆ15æ—¥</div>
        </div>
      
      
      <div class="license-meta-item">
        <div>è®¸å¯åè®®</div>
        <div>
          
            
            
              <a target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
              <span class="hint--top hint--rounded" aria-label="BY - ç½²å">
                <i class="iconfont icon-by"></i>
              </span>
              </a>
            
          
        </div>
      </div>
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2021/01/15/GLIBC-0X01-MALLOC-2.23-PART-II/" title="ã€GLIBC.0x01ã€‘glibc2.23 mallocæºç åˆ†æ - IIï¼šmalloc">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">ã€GLIBC.0x01ã€‘glibc2.23 mallocæºç åˆ†æ - IIï¼šmalloc</span>
                        <span class="visible-mobile">ä¸Šä¸€ç¯‡</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2020/11/23/CTF-0X01-ByteCTF2020-pwn/" title="ã€CTF.0x01ã€‘ByteCTF2020-Pwn WP">
                        <span class="hidden-mobile">ã€CTF.0x01ã€‘ByteCTF2020-Pwn WP</span>
                        <span class="visible-mobile">ä¸‹ä¸€ç¯‡</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
  <article id="comments" lazyload>
    
  <div id="valine"></div>
  <script type="text/javascript">
    Fluid.utils.loadComments('#valine', function() {
      Fluid.utils.createScript('https://lib.baomitu.com/valine/1.4.17/Valine.min.js', function() {
        var options = Object.assign(
          {"appid":"ICj6cPRQWFTNiOttBHlzxnIv-gzGzoHsz","appkey":"tuvJh3xYxPFcW2JB6K26RKP2","path":"window.location.pathname","placeholder":"è¯´ç‚¹ä»€ä¹ˆå‘—ï¼ˆç¬‘ï¼‰","avatar":"retro","meta":["nick","mail","link"],"requiredFields":[],"pageSize":10,"lang":"zh-CN","highlight":false,"recordIP":false,"serverURLs":"","emojiCDN":null,"emojiMaps":null,"enableQQ":false,"appId":"ICj6cPRQWFTNiOttBHlzxnIv-gzGzoHsz","appKey":"tuvJh3xYxPFcW2JB6K26RKP2"},
          {
            el: "#valine",
            path: window.location.pathname
          }
        )
        new Valine(options);
        Fluid.utils.waitElementVisible('#valine .vcontent', () => {
          var imgSelector = '#valine .vcontent img:not(.vemoji)';
          Fluid.plugins.imageCaption(imgSelector);
          Fluid.plugins.fancyBox(imgSelector);
        })
      });
    });
  </script>
  <noscript>Please enable JavaScript to view the comments</noscript>


  </article>


          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;ç›®å½•</p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  


  
  









    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">æœç´¢</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">å…³é”®è¯</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  <!-- ç½‘ç«™è¿è¡Œæ—¶é—´çš„è®¾ç½® -->
  <span id="timeDate">è½½å…¥å¤©æ•°...</span>
  <span id="times">è½½å…¥æ—¶åˆ†ç§’...</span>
  <script>
      var now = new Date();
      function createtime() {
          var grt= new Date("04/20/2020 17:48:48");//æ­¤å¤„ä¿®æ”¹ä½ çš„å»ºç«™æ—¶é—´æˆ–è€…ç½‘ç«™ä¸Šçº¿æ—¶é—´
          now.setTime(now.getTime()+250);
          days = (now - grt ) / 1000 / 60 / 60 / 24; dnum = Math.floor(days);
          hours = (now - grt ) / 1000 / 60 / 60 - (24 * dnum); hnum = Math.floor(hours);
          if(String(hnum).length ==1 ){hnum = "0" + hnum;} minutes = (now - grt ) / 1000 /60 - (24 * 60 * dnum) - (60 * hnum);
          mnum = Math.floor(minutes); if(String(mnum).length ==1 ){mnum = "0" + mnum;}
          seconds = (now - grt ) / 1000 - (24 * 60 * 60 * dnum) - (60 * 60 * hnum) - (60 * mnum);
          snum = Math.round(seconds); if(String(snum).length ==1 ){snum = "0" + snum;}
          document.getElementById("timeDate").innerHTML = "arttnba3çš„å°å±‹å·²ç»å®‰å…¨å­˜åœ¨äº† "+dnum+" å¤© ";
          document.getElementById("times").innerHTML = hnum + " å°æ—¶ " + mnum + " åˆ† " + snum + " ç§’";
      }
  setInterval("createtime()",250);
  </script>
  
    <div class="footer-content">
       <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
    </div>
  
  
    <div class="statistics">
  
  

  
    
      <span id="busuanzi_container_site_pv" style="display: none">
        æ€»è®¿é—®é‡ 
        <span id="busuanzi_value_site_pv"></span>
         æ¬¡
      </span>
    
    
      <span id="busuanzi_container_site_uv" style="display: none">
        æ€»è®¿å®¢æ•° 
        <span id="busuanzi_value_site_uv"></span>
         äºº
      </span>
    
    
  
</div>

  
  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.0/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.18.2/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      headingSelector : CONFIG.toc.headingSelector || 'h1,h2,h3,h4,h5,h6',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      collapseDepth   : CONFIG.toc.collapseDepth || 0,
      scrollSmooth    : true,
      headingsOffset  : -boardTop
    });
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.10/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  
      <script>
        if (!window.MathJax) {
          window.MathJax = {
            tex    : {
              inlineMath: { '[+]': [['$', '$']] }
            },
            loader : {
              load: ['ui/lazy']
            },
            options: {
              renderActions: {
                insertedScript: [200, () => {
                  document.querySelectorAll('mjx-container').forEach(node => {
                    let target = node.parentNode;
                    if (target.nodeName.toLowerCase() === 'li') {
                      target.parentNode.classList.add('has-jax');
                    }
                  });
                }, '', false]
              }
            }
          };
        } else {
          MathJax.startup.document.state(0);
          MathJax.texReset();
          MathJax.typeset();
          MathJax.typesetPromise();
        }
      </script>
    

  <script  src="https://lib.baomitu.com/mathjax/3.2.1/es5/tex-mml-chtml.js" ></script>

  <script  src="/js/local-search.js" ></script>

  <script defer src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" ></script>





<!-- ä¸»é¢˜çš„å¯åŠ¨é¡¹ï¼Œå°†å®ƒä¿æŒåœ¨æœ€åº•éƒ¨ -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">åšå®¢åœ¨å…è®¸ JavaScript è¿è¡Œçš„ç¯å¢ƒä¸‹æµè§ˆæ•ˆæœæ›´ä½³</div>
  </noscript>
</body>
</html>
