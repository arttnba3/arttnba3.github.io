

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/avatar.png">
  <link rel="icon" href="/img/avatar.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
    <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="arttnba3">
  <meta name="keywords" content="">
  
    <meta name="description" content="ç®€ç®€å•å•æ³„éœ²ä¸ªå†…å­˜">
<meta property="og:type" content="article">
<meta property="og:title" content="ã€GLIBC.0x01ã€‘glibc2.23 mallocæºç åˆ†æ - IIï¼šmalloc">
<meta property="og:url" content="http://example.com/2021/01/15/GLIBC-0X01-MALLOC-2.23-PART-II/index.html">
<meta property="og:site_name" content="arttnba3&#39;s blog">
<meta property="og:description" content="ç®€ç®€å•å•æ³„éœ²ä¸ªå†…å­˜">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://i.loli.net/2021/01/18/rYo8HAqZWKDveLN.png">
<meta property="article:published_time" content="2021-01-15T09:17:03.000Z">
<meta property="article:modified_time" content="2023-10-27T00:41:20.000Z">
<meta property="article:author" content="arttnba3">
<meta property="article:tag" content="å†…å­˜ç®¡ç†">
<meta property="article:tag" content="å †">
<meta property="article:tag" content="ptmalloc">
<meta property="article:tag" content="glibc">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://i.loli.net/2021/01/18/rYo8HAqZWKDveLN.png">
  
  
    <meta name="referrer" content="no-referrer-when-downgrade">
  
  
  <title>ã€GLIBC.0x01ã€‘glibc2.23 mallocæºç åˆ†æ - IIï¼šmalloc - arttnba3&#39;s blog</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- ä¸»é¢˜ä¾èµ–çš„å›¾æ ‡åº“ï¼Œä¸è¦è‡ªè¡Œä¿®æ”¹ -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  




  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"example.com","root":"/","version":"1.9.2","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":"Â§"},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":false,"follow_dnt":true,"baidu":null,"google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false}},"search_path":"/local-search.xml"};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  


  
<meta name="generator" content="Hexo 7.1.1"><link rel="alternate" href="/atom.xml" title="arttnba3's blog" type="application/atom+xml">
</head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 80vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>arttnba3&#39;s blog</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                é¦–é¡µ
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                å½’æ¡£
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                åˆ†ç±»
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                æ ‡ç­¾
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                å…³äº
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/links/">
                <i class="iconfont icon-link-fill"></i>
                å‹é“¾
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" target="_blank" rel="noopener" href="https://github.com/arttnba3">
                <i class="iconfont icon-github-fill"></i>
                GitHub
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/atom.xml">
                <i class="iconfont icon-rss"></i>
                rss
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              &nbsp;<i class="iconfont icon-search"></i>&nbsp;
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">&nbsp;<i
                class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('https://i.loli.net/2021/01/18/tqdoXQujvxWlIDN.png') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="ã€GLIBC.0x01ã€‘glibc2.23 mallocæºç åˆ†æ - IIï¼šmalloc"></span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2021-01-15 20:17" pubdate>
          2021å¹´1æœˆ15æ—¥ æ™šä¸Š
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          59k å­—
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          492 åˆ†é’Ÿ
        
      </span>
    

    
    
      
        <span id="busuanzi_container_page_pv" style="display: none">
          <i class="iconfont icon-eye" aria-hidden="true"></i>
          <span id="busuanzi_value_page_pv"></span> æ¬¡
        </span>
        
      
    
  </div>


        
      </div>

      
        <div class="scroll-down-bar">
          <i class="iconfont icon-arrowdown"></i>
        </div>
      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">ã€GLIBC.0x01ã€‘glibc2.23 mallocæºç åˆ†æ - IIï¼šmalloc</h1>
            
              <p class="note note-info">
                
                  
                    æœ¬æ–‡æœ€åæ›´æ–°äºï¼š2023å¹´10æœˆ27æ—¥ ä¸­åˆ
                  
                
              </p>
            
            
              <div class="markdown-body">
                
                <p>ç®€ç®€å•å•æ³„éœ²ä¸ªå†…å­˜</p>
<span id="more"></span>

<h1 id="0x00-malloc"><a href="#0x00-malloc" class="headerlink" title="0x00.malloc"></a>0x00.malloc</h1><p>æˆ‘ä»¬åœ¨ç¼–å†™Cè¯­è¨€ç¨‹åºéœ€è¦åŠ¨æ€åˆ†é…ä¸€å—åˆé€‚å¤§å°çš„å†…å­˜æ—¶ï¼Œæˆ‘ä»¬é€šå¸¸éƒ½è¦ç”¨åˆ°mallocå‡½æ•°ï¼ˆåŒ…æ‹¬C++çš„newè¿ç®—ç¬¦çš„ä¸€ç§å®ç°æ–¹å¼ä¾¿æ˜¯å°è£…äº†mallocï¼‰</p>
<p>glibcæºç ä¸­å¯¹äºmallocå‡½æ•°çš„å®šä¹‰å¦‚ä¸‹ï¼š</p>
<p>é¦–å…ˆæˆ‘ä»¬åœ¨<strong>malloc&#x2F;malloc.h</strong>æ–‡ä»¶ä¸­å¯ä»¥çœ‹åˆ°å¯¹mallocå‡½æ•°çš„å¤–éƒ¨å¼•ç”¨å£°æ˜:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/* Allocate SIZE bytes of memory.  */</span><br><span class="hljs-keyword">extern</span> <span class="hljs-type">void</span> *<span class="hljs-title function_">malloc</span> <span class="hljs-params">(<span class="hljs-type">size_t</span> __size)</span> __THROW __attribute_malloc__ __wur;<br></code></pre></td></tr></table></figure>

<p>åœ¨è¿™é‡Œæˆ‘ä»¬ä¼šçœ‹åˆ°ä¸‰ä¸ªå¥‡æ€ªçš„ç¬¦å·ï¼š<code>__THROW</code>ã€<code>__attribute_malloc__</code>ã€<code>__wur</code>ï¼Œ<del>ä¼¼ä¹å¸¸è§„çš„Cè¯­è¨€æ•™ç§‘ä¹¦ä¸Šå¹¶æ²¡æœ‰ä»‹ç»è¿‡è¿™æ ·å¥‡æ€ªçš„ä¸œè¥¿</del></p>
<h2 id="THROWï¼šC-ä¸‹ä¸æŠ›å‡ºå¼‚å¸¸"><a href="#THROWï¼šC-ä¸‹ä¸æŠ›å‡ºå¼‚å¸¸" class="headerlink" title="__THROWï¼šC++ä¸‹ä¸æŠ›å‡ºå¼‚å¸¸"></a>__THROWï¼šC++ä¸‹ä¸æŠ›å‡ºå¼‚å¸¸</h2><p>æ˜¯ä¸€ä¸ªå®å®šä¹‰ï¼Œå®šä¹‰äºmisc&#x2F;sys&#x2F;cddefs.hä¸‹ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/* GCC can always grok prototypes.  For C++ programs we add throw()</span><br><span class="hljs-comment">   to help it optimize the function calls.  But this works only with</span><br><span class="hljs-comment">   gcc 2.8.x and egcs.  For gcc 3.2 and up we even mark C functions</span><br><span class="hljs-comment">   as non-throwing using a function attribute since programs can use</span><br><span class="hljs-comment">   the -fexceptions options for C code as well.  */</span><br><span class="hljs-meta"># <span class="hljs-keyword">if</span> !defined __cplusplus &amp;&amp; __GNUC_PREREQ (3, 3)</span><br><span class="hljs-meta">#  <span class="hljs-keyword">define</span> __THROW	__attribute__ ((__nothrow__ __LEAF))</span><br><span class="hljs-meta">#  <span class="hljs-keyword">define</span> __THROWNL	__attribute__ ((__nothrow__))</span><br><span class="hljs-meta">#  <span class="hljs-keyword">define</span> __NTH(fct)	__attribute__ ((__nothrow__ __LEAF)) fct</span><br><span class="hljs-meta"># <span class="hljs-keyword">else</span></span><br><span class="hljs-meta">#  <span class="hljs-keyword">if</span> defined __cplusplus &amp;&amp; __GNUC_PREREQ (2,8)</span><br><span class="hljs-meta">#   <span class="hljs-keyword">define</span> __THROW	throw ()</span><br><span class="hljs-meta">#   <span class="hljs-keyword">define</span> __THROWNL	throw ()</span><br><span class="hljs-meta">#   <span class="hljs-keyword">define</span> __NTH(fct)	__LEAF_ATTR fct throw ()</span><br><span class="hljs-meta">#  <span class="hljs-keyword">else</span></span><br><span class="hljs-meta">#   <span class="hljs-keyword">define</span> __THROW</span><br><span class="hljs-meta">#   <span class="hljs-keyword">define</span> __THROWNL</span><br><span class="hljs-meta">#   <span class="hljs-keyword">define</span> __NTH(fct)	fct</span><br><span class="hljs-meta">#  <span class="hljs-keyword">endif</span></span><br><span class="hljs-meta"># <span class="hljs-keyword">endif</span></span><br></code></pre></td></tr></table></figure>

<p><strong>è‹¥æ˜¯åœ¨C++ç¯å¢ƒ</strong>ï¼Œè¡¨æ˜è¯¥å‡½æ•°ä¸ä¼šæ‰”å‡ºå¼‚å¸¸ï¼Œä»¥é¿å…ç¼–è¯‘å™¨ç”Ÿæˆå¯¹å¼‚å¸¸çš„å¤„ç†ä»£ç ï¼Œä»è€Œä¼˜åŒ–ä»£ç ç”Ÿæˆç»“æœ.</p>
<p><strong>åœ¨Cç¯å¢ƒä¸‹æ²¡æœ‰ä»»ä½•æ•ˆæœ</strong></p>
<h2 id="attribute-malloc-ï¼šä¼˜åŒ–mallocç±»å‹å‡½æ•°"><a href="#attribute-malloc-ï¼šä¼˜åŒ–mallocç±»å‹å‡½æ•°" class="headerlink" title="__attribute_malloc__ï¼šä¼˜åŒ–mallocç±»å‹å‡½æ•°"></a>__attribute_malloc__ï¼šä¼˜åŒ–mallocç±»å‹å‡½æ•°</h2><p>è¿™ä¸ªç¬¦å·åŒæ ·å®šä¹‰äºmisc&#x2F;sys&#x2F;cdefs.hä¸‹</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/* At some point during the gcc 2.96 development the `malloc&#x27; attribute</span><br><span class="hljs-comment">   for functions was introduced.  We don&#x27;t want to use it unconditionally</span><br><span class="hljs-comment">   (although this would be possible) since it generates warnings.  */</span><br><span class="hljs-meta">#<span class="hljs-keyword">if</span> __GNUC_PREREQ (2,96)</span><br><span class="hljs-meta"># <span class="hljs-keyword">define</span> __attribute_malloc__ __attribute__ ((__malloc__))</span><br><span class="hljs-meta">#<span class="hljs-keyword">else</span></span><br><span class="hljs-meta"># <span class="hljs-keyword">define</span> __attribute_malloc__ <span class="hljs-comment">/* Ignore */</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br></code></pre></td></tr></table></figure>

<p>å¯¹äºgcc2.96åŠä»¥ä¸Šçš„ç‰ˆæœ¬ï¼Œè¯¥æ®µä»£ç å°†ä¼šä½¿ç”¨ç¼–è¯‘å™¨çš„__attribute__æŒ‡ä»¤</p>
<p>æŸ¥é˜…gccæ‰‹å†Œä¸­è¯´æ˜å¦‚ä¸‹ï¼š</p>
<blockquote>
<figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ebnf"><span class="hljs-attribute">malloc</span><br></code></pre></td></tr></table></figure>

<p>Using this attribute can improve optimization. Compiler predicts that a function with the attribute returns non-null in most cases. Functions like <code>malloc</code> and <code>calloc</code> have this property because they return a pointer to uninitialized or zeroed-out storage. However, functions like <code>realloc</code> do not have this property, as they can return a pointer to storage containing pointers.</p>
</blockquote>
<p>å¤§æ„æ˜¯mallocä½œä¸ºä¸€ç§attributeå¯ä»¥ç”¨æ¥ä¼˜åŒ–ç±»ä¼¼mallocã€callocç­‰å†…å­˜åˆ†é…å‡½æ•°çš„ä»£ç ï¼Œ<del>æˆ‘è‡ªå·±æ˜¯å£°æ˜ç”¨æ¥ä¼˜åŒ–åƒæˆ‘è‡ªå·±è¿™æ ·çš„å‡½æ•°çš„</del>ï¼ŒåŒæ—¶ä¹Ÿé˜æ˜äº†<strong>reallocå‡½æ•°å¹¶ä¸ä½¿ç”¨è¿™æ ·ä¸€ä¸ªattributeç‰¹æ€§ï¼Œå› ä¸ºreallocå‡½æ•°å¯èƒ½ä¼šè¿”å›æŒ‡å‘åŒ…å«æœ‰å…¶ä»–æŒ‡é’ˆçš„å†…å­˜å—çš„æŒ‡é’ˆ</strong></p>
<p>å¯¹äºgcc2.96ä»¥ä¸‹çš„ç‰ˆæœ¬ï¼Œå®å®šä¹‰__attribute_malloc__<strong>æ˜¯æ— æ•ˆçš„</strong></p>
<blockquote>
<h4 id="GNUC-PREREQ"><a href="#GNUC-PREREQ" class="headerlink" title="__GNUC_PREREQ()"></a>__GNUC_PREREQ()</h4><p>å®šä¹‰äºsys&#x2F;features.hä¸‹</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/* Convenience macros to test the versions of glibc and gcc.</span><br><span class="hljs-comment">Use them like this:</span><br><span class="hljs-comment">#if __GNUC_PREREQ (2,8)</span><br><span class="hljs-comment">... code requiring gcc 2.8 or later ...</span><br><span class="hljs-comment">#endif</span><br><span class="hljs-comment">Note - they won&#x27;t work for gcc1 or glibc1, since the _MINOR macros</span><br><span class="hljs-comment">were not defined then.  */</span><br><span class="hljs-meta">#<span class="hljs-keyword">if</span> defined __GNUC__ &amp;&amp; defined __GNUC_MINOR__</span><br><span class="hljs-meta"># <span class="hljs-keyword">define</span> __GNUC_PREREQ(maj, min) \</span><br><span class="hljs-meta">	((__GNUC__ <span class="hljs-string">&lt;&lt; 16) + __GNUC_MINOR__ &gt;</span>= ((maj) &lt;&lt; 16) + (min))</span><br><span class="hljs-meta">#<span class="hljs-keyword">else</span></span><br><span class="hljs-meta"># <span class="hljs-keyword">define</span> __GNUC_PREREQ(maj, min) 0</span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br></code></pre></td></tr></table></figure>

<p>å¤§æ„æ˜¯æ£€æµ‹gccçš„ç‰ˆæœ¬ï¼Œè¿™é‡Œå°±ä¸å…·ä½“å±•å¼€è¯´æ˜äº†</p>
<p><del>gcc pre-requirement</del></p>
</blockquote>
<h2 id="wurï¼šè‹¥å‡½æ•°è¿”å›å€¼æœªè¢«å¼•ç”¨åˆ™æŠ›å‡ºè­¦å‘Š"><a href="#wurï¼šè‹¥å‡½æ•°è¿”å›å€¼æœªè¢«å¼•ç”¨åˆ™æŠ›å‡ºè­¦å‘Š" class="headerlink" title="__wurï¼šè‹¥å‡½æ•°è¿”å›å€¼æœªè¢«å¼•ç”¨åˆ™æŠ›å‡ºè­¦å‘Š"></a>__wurï¼šè‹¥å‡½æ•°è¿”å›å€¼æœªè¢«å¼•ç”¨åˆ™æŠ›å‡ºè­¦å‘Š</h2><p>ä¾ç„¶æ˜¯ä½äºmisc&#x2F;sys&#x2F;cdefs.hä¸‹çš„ä¸€ä¸ªå®å®šä¹‰ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/* If fortification mode, we warn about unused results of certain</span><br><span class="hljs-comment">   function calls which can lead to problems.  */</span><br><span class="hljs-meta">#<span class="hljs-keyword">if</span> __GNUC_PREREQ (3,4)</span><br><span class="hljs-meta"># <span class="hljs-keyword">define</span> __attribute_warn_unused_result__ \</span><br><span class="hljs-meta">   __attribute__ ((__warn_unused_result__))</span><br><span class="hljs-meta"># <span class="hljs-keyword">if</span> __USE_FORTIFY_LEVEL &gt; 0</span><br><span class="hljs-meta">#  <span class="hljs-keyword">define</span> __wur __attribute_warn_unused_result__</span><br><span class="hljs-meta"># <span class="hljs-keyword">endif</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">else</span></span><br><span class="hljs-meta"># <span class="hljs-keyword">define</span> __attribute_warn_unused_result__ <span class="hljs-comment">/* empty */</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> __wur</span><br><span class="hljs-meta"># <span class="hljs-keyword">define</span> __wur <span class="hljs-comment">/* Ignore */</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br></code></pre></td></tr></table></figure>

<p>è‹¥æ˜¯gccç‰ˆæœ¬ä¸º3.4åŠä»¥ä¸Šï¼Œåˆ™é¦–å…ˆä¼šå°†<code>__attribute_warn_unused_result__</code>å®šä¹‰ä¸º<code>__attribute__ ((__warn_unused_result__))</code></p>
<p>è¯¥attributeåœ¨gccæ‰‹å†Œä¸­çš„è¯´æ˜å¦‚ä¸‹ï¼š</p>
<blockquote>
<figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ebnf"><span class="hljs-attribute">warn_unused_result</span><br></code></pre></td></tr></table></figure>

<p>The <code>warn_unused_result</code> attribute causes a warning to be emitted if a caller of the function with this attribute does not use its return value. This is useful for functions where not checking the result is either a security problem or always a bug, such as <code>realloc</code>.</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-keyword">int</span> <span class="hljs-function"><span class="hljs-keyword">fn</span> (<span class="hljs-params"></span>) <span class="hljs-title">__attribute__</span> (<span class="hljs-params">(<span class="hljs-params">warn_unused_result</span>)</span>)</span>;<br><span class="hljs-keyword">int</span> <span class="hljs-title function_ invoke__">foo</span> ()<br>&#123;<br><span class="hljs-keyword">if</span> (<span class="hljs-function"><span class="hljs-keyword">fn</span> (<span class="hljs-params"></span>) &lt; 0) <span class="hljs-title">return</span> -1</span>;<br><span class="hljs-function"><span class="hljs-keyword">fn</span> (<span class="hljs-params"></span>)</span>;<br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>results in warning on line 5.</p>
</blockquote>
<p>å¤§æ„æ˜¯<strong>è‹¥æ˜¯è¯¥å‡½æ•°çš„è¿”å›å€¼æœªè¢«ç¨‹åºä½¿ç”¨ï¼Œåˆ™ç¼–è¯‘å™¨ä¼šå‘å‡ºè­¦å‘Š</strong><del>ï¼Œç„¶è€Œåˆæœ‰è°ä¼šå»æ³¨æ„warningså‘¢x</del></p>
<p>è€Œ<strong>å½“__USE_FORTIFY_LEVEL &gt; 0æ—¶</strong>ï¼Œ<code>__wur</code>ä¼šè¢«å¯ç”¨ï¼ŒåŠŸèƒ½åŒä¸Šæ‰€è¿°ï¼šæ£€æŸ¥å‡½æ•°è¿”å›å€¼æ˜¯å¦è¢«ä½¿ç”¨ï¼Œè‹¥å¦åˆ™å‘å‡ºè­¦å‘Š</p>
<p>è‹¥æ˜¯gccç‰ˆæœ¬ä¸º3.4ä»¥ä¸‹ï¼Œ<strong>åˆ™è¯¥å®å®šä¹‰æ— æ•ˆ</strong></p>
<blockquote>
<h4 id="USE-FORTIFY-LEVEL"><a href="#USE-FORTIFY-LEVEL" class="headerlink" title="__USE_FORTIFY_LEVEL"></a>__USE_FORTIFY_LEVEL</h4><p>å®šä¹‰äºfeatures.hä¸­ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">if</span> defined _FORTIFY_SOURCE &amp;&amp; _FORTIFY_SOURCE &gt; 0</span><br><span class="hljs-meta"># <span class="hljs-keyword">if</span> !defined __OPTIMIZE__ || __OPTIMIZE__ &lt;= 0</span><br><span class="hljs-meta">#  <span class="hljs-keyword">warning</span> _FORTIFY_SOURCE requires compiling with optimization (-O)</span><br><span class="hljs-meta"># <span class="hljs-keyword">elif</span> !__GNUC_PREREQ (4, 1)</span><br><span class="hljs-meta">#  <span class="hljs-keyword">warning</span> _FORTIFY_SOURCE requires GCC 4.1 or later</span><br><span class="hljs-meta"># <span class="hljs-keyword">elif</span> _FORTIFY_SOURCE &gt; 1</span><br><span class="hljs-meta">#  <span class="hljs-keyword">define</span> __USE_FORTIFY_LEVEL 2</span><br><span class="hljs-meta"># <span class="hljs-keyword">else</span></span><br><span class="hljs-meta">#  <span class="hljs-keyword">define</span> __USE_FORTIFY_LEVEL 1</span><br><span class="hljs-meta"># <span class="hljs-keyword">endif</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> __USE_FORTIFY_LEVEL</span><br><span class="hljs-meta"># <span class="hljs-keyword">define</span> __USE_FORTIFY_LEVEL 0</span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br></code></pre></td></tr></table></figure>

<p>å½“_FORTIFY_SOURCEæœªè¢«å®šä¹‰æ—¶åˆ™ä¼šç½®0ï¼Œå¦åˆ™ä¼šå¯¹_FORTIFY_SOURCEçš„å€¼è¿›è¡Œåˆ¤æ–­ï¼Œè‹¥å¤§äº1åˆ™ä¸º2ï¼Œå¦åˆ™ä¸º1ï¼Œ<strong>æ— è®ºå¦‚ä½•åªè¦å®šä¹‰äº†_FORTIFY_SOURCEä¸”å¤§äº0ï¼Œåˆ™__wuréƒ½ä¼šè¢«å¯ç”¨</strong></p>
</blockquote>
<blockquote>
<h4 id="FORTIFY-SOURCE"><a href="#FORTIFY-SOURCE" class="headerlink" title="_FORTIFY_SOURCE"></a>_FORTIFY_SOURCE</h4><p>å¤§æ¦‚æ˜¯å’ŒGCCç¼–è¯‘é€‰é¡¹ç›¸å…³çš„ï¼Œå¯ä»¥ä½¿ç”¨<code>-D_FORTIFY_SOURCE</code>è¿›è¡ŒæŒ‡å®šï¼Œå¦‚<code>-D_FORTIFY_SOURCE=1</code></p>
<p>Ubuntu18ä¸‹é»˜è®¤<code>-D_FORTIFY_SOURCE=2</code></p>
</blockquote>
<h2 id="strong-aliasï¼šé‡å‘½åmallocä¸º-libc-malloc"><a href="#strong-aliasï¼šé‡å‘½åmallocä¸º-libc-malloc" class="headerlink" title="strong_aliasï¼šé‡å‘½åmallocä¸º__libc_malloc"></a>strong_aliasï¼šé‡å‘½åmallocä¸º__libc_malloc</h2><p>åœ¨ä¸Šé¢æˆ‘ä»¬å·²ç»ç®€è¦åœ°è§£æäº†åœ¨malloc.hä¸­å¯¹äºmallocå‡½æ•°çš„ä¸‰ä¸ªæ ‡è®°ï¼Œå¤§è‡´æ˜¯<strong>é’ˆå¯¹C++é»˜è®¤ä¸æŠ›å‡ºå¼‚å¸¸ä»¥ä¼˜åŒ–ä»£ç ï¼Œæ ¹æ®è¿”å›å€¼çš†ä¸ºmallocç±»å‹è¿›è¡Œä»£ç ç¼–è¯‘ä¼˜åŒ–ï¼Œè¿”å›å€¼æœªè¢«ä½¿ç”¨æ—¶æŠ›å‡ºè­¦å‘Š</strong></p>
<p>ä½†æ˜¯åœ¨malloc.cä¸­æˆ‘ä»¬æ— æ³•æ‰¾åˆ°å¯¹äºmallocå‡½æ•°çš„ç›´æ¥å®šä¹‰ï¼Œ<del>éš¾é“è¯´å®é™…ä¸Šå¹¶æ²¡æœ‰è¿™ä¸ªå‡½æ•°ğŸ¦„ï¼Œäº‹å®ä¸Šè¿˜çœŸçš„æ²¡æœ‰è¿™ä¸ªå‡½æ•°x</del></p>
<p>ä¸è¿‡æˆ‘ä»¬å¯ä»¥åœ¨malloc.hä¸­å‘ç°å­˜åœ¨å¦‚ä¸‹ä»£ç ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c">strong_alias (__libc_malloc, __malloc) strong_alias (__libc_malloc, <span class="hljs-built_in">malloc</span>)<br></code></pre></td></tr></table></figure>

<p>å‘ç°ä¸€ä¸ªæ–°çš„ç¬¦å·ï¼š<strong>strong_alias</strong></p>
<p>è¯¥å®å®šä¹‰äºlibc-symbols.hä¸‹ï¼š</p>
<figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs scss"><span class="hljs-comment">/* GCC understands weak symbols and aliases; use its interface where</span><br><span class="hljs-comment">   possible, instead of embedded assembly language.  */</span><br><br><span class="hljs-comment">/* Define ALIASNAME as a strong alias for NAME.  */</span><br># define <span class="hljs-built_in">strong_alias</span>(name, aliasname) <span class="hljs-built_in">_strong_alias</span>(name, aliasname)<br># define <span class="hljs-built_in">_strong_alias</span>(name, aliasname) \<br>  extern __typeof (name) aliasname __attribute__ ((alias (#name)));<br></code></pre></td></tr></table></figure>

<p>_strong_aliaså®æ˜¯strong_aliasçš„å®å±•å¼€ï¼Œè€Œ_strong_aliaså®å±•å¼€ååˆ™æ˜¯<code>extern __typeof (name) aliasname __attribute__ ((alias (#name)));</code><del>æ—   é™  å¥—  å¨ƒ</del></p>
<p><del>é…åˆç€glibcçš„æ³¨é‡Šï¼Œ</del>ä¸éš¾ç†è§£ï¼Œåœ¨è¿™é‡Œ<strong>å°†mallocå£°æ˜ä¸º__libc_mallocçš„åˆ«åï¼Œå³__libc_mallocæ‰æ˜¯æˆ‘ä»¬åœ¨è°ƒç”¨mallocæ—¶æ‰€çœŸæ­£è°ƒç”¨çš„å‡½æ•°</strong></p>
<p>è¿™ä¸‹å°±çœŸç›¸å¤§ç™½äº†</p>
<blockquote>
<h4 id="typeof"><a href="#typeof" class="headerlink" title="__typeof"></a>__typeof</h4><p>æ‹“å±•Cå…³é”®å­—ï¼Œç”¨äºè·å–æŸä¸ªä¸œè¥¿çš„ç±»å‹</p>
<p>ç”¨ä¾‹å¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-type">int</span> <span class="hljs-title function_">foo</span><span class="hljs-params">(<span class="hljs-type">int</span> n)</span>&#123;<span class="hljs-keyword">return</span> n;&#125;<br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br> __typeof(foo()) var;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>è¿™ç§æƒ…å†µä¸‹ä¾¿å¯ä»¥è·å–åˆ°foo()å‡½æ•°çš„è¿”å›å€¼ä¸ºintç±»å‹ï¼Œå¹¶ä»¥æ­¤å£°æ˜ä¸€ä¸ªintç±»å‹çš„å˜é‡var</p>
<p>éœ€è¦æ³¨æ„çš„æ˜¯__typeof(char)å’Œ__typeof(â€˜aâ€™)æ‰€è·å¾—çš„ç»“æœæ˜¯ä¸ä¸€æ ·çš„ï¼Œåè€…ä¼šå°†ä¹‹æå‡ä¸ºintç±»å‹</p>
</blockquote>
<p>äºæ˜¯æˆ‘ä»¬æœ€ç»ˆè½¬åˆ°__libc_mallocçš„å£°æ˜ï¼Œåœ¨å‰é¢å‘ç°äº†ä¸€å¤§æ®µå¯¹äºmallocçš„æ³¨é‡Š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/*</span><br><span class="hljs-comment">  malloc(size_t n)</span><br><span class="hljs-comment">  Returns a pointer to a newly allocated chunk of at least n bytes, or null</span><br><span class="hljs-comment">  if no space is available. Additionally, on failure, errno is</span><br><span class="hljs-comment">  set to ENOMEM on ANSI C systems.</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">  If n is zero, malloc returns a minumum-sized chunk. (The minimum</span><br><span class="hljs-comment">  size is 16 bytes on most 32bit systems, and 24 or 32 bytes on 64bit</span><br><span class="hljs-comment">  systems.)  On most systems, size_t is an unsigned type, so calls</span><br><span class="hljs-comment">  with negative arguments are interpreted as requests for huge amounts</span><br><span class="hljs-comment">  of space, which will often fail. The maximum supported value of n</span><br><span class="hljs-comment">  differs across systems, but is in all cases less than the maximum</span><br><span class="hljs-comment">  representable value of a size_t.</span><br><span class="hljs-comment">*/</span><br><span class="hljs-type">void</span>*  __libc_malloc(<span class="hljs-type">size_t</span>);<br>libc_hidden_proto (__libc_malloc)<br></code></pre></td></tr></table></figure>

<p>æ•…æˆ‘ä»¬æœ€ç»ˆå¯ä»¥å¾—çŸ¥ï¼šå½“æˆ‘ä»¬è°ƒç”¨mallocå‡½æ•°æ—¶ï¼Œå…¶çœŸæ­£è°ƒç”¨çš„å‡½æ•°åº”å½“æ˜¯æ˜¯<strong>__libc_malloc</strong></p>
<p>äºæ˜¯æ¥ä¸‹æ¥æˆ‘ä»¬æ¥çœ‹çœ‹<strong>__libc_mallocå‡½æ•°çš„æºç </strong></p>
<h1 id="0x01-libc-malloc"><a href="#0x01-libc-malloc" class="headerlink" title="0x01.__libc_malloc"></a>0x01.__libc_malloc</h1><p>è¯¥æ®µä»£ç åŒæ ·ä½äºmalloc&#x2F;malloc.cä¸­ï¼Œæˆ‘ä»¬é¦–å…ˆå…ˆé˜…è¯»è¿™æ®µå…³äºmallocçš„æ³¨é‡Š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/*</span><br><span class="hljs-comment">  malloc(size_t n)</span><br><span class="hljs-comment">  Returns a pointer to a newly allocated chunk of at least n bytes, or null</span><br><span class="hljs-comment">  if no space is available. Additionally, on failure, errno is</span><br><span class="hljs-comment">  set to ENOMEM on ANSI C systems.</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">  If n is zero, malloc returns a minumum-sized chunk. (The minimum</span><br><span class="hljs-comment">  size is 16 bytes on most 32bit systems, and 24 or 32 bytes on 64bit</span><br><span class="hljs-comment">  systems.)  On most systems, size_t is an unsigned type, so calls</span><br><span class="hljs-comment">  with negative arguments are interpreted as requests for huge amounts</span><br><span class="hljs-comment">  of space, which will often fail. The maximum supported value of n</span><br><span class="hljs-comment">  differs across systems, but is in all cases less than the maximum</span><br><span class="hljs-comment">  representable value of a size_t.</span><br><span class="hljs-comment">*/</span><br><span class="hljs-type">void</span>*  __libc_malloc(<span class="hljs-type">size_t</span>);<br>libc_hidden_proto (__libc_malloc)<br></code></pre></td></tr></table></figure>

<blockquote>
<p>ï¼ˆarttnba3è¯‘ï¼‰</p>
<p>malloc(size_t n)</p>
<p>å°†ä¼šè¿”å›ä¸€ä¸ªæŒ‡å‘åˆ†é…ç»™çš„è‡³å°‘n byteså¤§å°çš„chunkçš„æŒ‡é’ˆï¼Œè‹¥ç©ºé—´ä¸è¶³åˆ™ä¼šè¿”å›NULLã€‚æ­¤å¤–ï¼Œåœ¨ANSI Cæ ‡å‡†çš„ç³»ç»Ÿä¸Šï¼Œerrnoä¼šè¢«è®¾ä¸º<strong>ENOMEM</strong></p>
<p>å½“nä¸º0æ—¶ï¼Œmallocå°†ä¼šè¿”å›ä¸€ä¸ªæœ€å°sizeçš„chunkï¼ˆ32ä½ç³»ç»Ÿä¸‹ä¸º16bytesï¼Œ64ä½ç³»ç»Ÿä¸‹åˆ™ä¸º24æˆ–32bytesï¼‰ã€‚åœ¨å¤§éƒ¨åˆ†ç³»ç»Ÿä¸Šï¼Œsize_tä¸ºæ— ç¬¦å·ç±»å‹ï¼Œå› æ­¤è´Ÿæ•°å¤§å°çš„è¯·æ±‚å°†ä¼šè¢«è§£é‡Šä¸ºä¸€ä¸ªå¯¹äºæå·¨å¤§å†…å­˜ç©ºé—´çš„è¯·æ±‚ï¼Œè€Œè¿™é€šå¸¸éƒ½ä¼šå¤±è´¥ã€‚å¯¹äºæ”¯æŒçš„æœ€å¤§çš„å†…å­˜è¯·æ±‚é€šå¸¸åœ¨ä¸åŒçš„æ“ä½œç³»ç»Ÿä¸Šä¸ä¸€è‡´ï¼Œä½†éƒ½ä¼šæ¯”size_tç±»å‹æ‰€èƒ½è¡¨è¾¾çš„æœ€å¤§å€¼è¦å°</p>
</blockquote>
<blockquote>
<h4 id="errno"><a href="#errno" class="headerlink" title="errno"></a>errno</h4><p>å®šä¹‰äºerrno.hä¸­çš„ä¸€ä¸ªå‚¨å­˜é”™è¯¯ä»£ç çš„å˜é‡ï¼Œå…·ä½“é”™è¯¯ä»£ç è¯¦è§sysdeps&#x2F;mach&#x2F;hurd&#x2F;bits&#x2F;errno.h</p>
<p>å…¶ä¸­ENOMEMçš„å€¼ä¸º12</p>
<p>ï¼ˆç¬”è€…çŒœæµ‹ENOMEMåº”è¯¥ä¸ºerror: no memoryçš„æ„æ€ï¼‰</p>
</blockquote>
<p>ä¹Ÿå°±æ˜¯è¯´malloc(0)å¹¶ä¸ä¼šè¿”å›å†…å­˜å¤§å°ä¸º0çš„å†…å­˜ç©ºé—´ï¼Œè€Œæ˜¯è¿”å›ä¸€ä¸ªæœ€å°sizeçš„chunk</p>
<p>åŒæ—¶æˆ‘ä»¬è¿˜èƒ½å‘ç°ï¼šåœ¨__libc_mallocçš„å‡½æ•°å£°æ˜ä¸‹è¿˜æœ‰ä¸€è¡Œå¥‡æ€ªçš„ä»£ç â€”â€”libc_hidden_proto</p>
<h2 id="libc-hidden-protoï¼šå‡½æ•°ç¬¦å·éšè—"><a href="#libc-hidden-protoï¼šå‡½æ•°ç¬¦å·éšè—" class="headerlink" title="libc_hidden_protoï¼šå‡½æ•°ç¬¦å·éšè—"></a>libc_hidden_protoï¼šå‡½æ•°ç¬¦å·éšè—</h2><p>è¯¥ç¬¦å·è¢«å®šä¹‰åœ¨include&#x2F;libc-symbols.hä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">if</span> IS_IN (libc)</span><br><span class="hljs-meta"># <span class="hljs-keyword">define</span> libc_hidden_proto(name, attrs...) hidden_proto (name, ##attrs)</span><br>...<span class="hljs-comment">//ä¸­é—´çš„ä»£ç å¤ªå¤šäº†ï¼Œè¿™é‡Œæˆ‘å°±ä¸copyäº†</span><br><span class="hljs-meta">#<span class="hljs-keyword">else</span></span><br><span class="hljs-meta"># <span class="hljs-keyword">define</span> libc_hidden_proto(name, attrs...)</span><br>...<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br></code></pre></td></tr></table></figure>

<p>åœ¨libcä¸­è¯¥å®å±•å¼€ä¸ºhidden_protoå®ï¼Œè¯¥å®åŒæ ·å®šä¹‰äºinclude&#x2F;libc-symbols.hä¸­ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">if</span> defined SHARED &amp;&amp; !defined NO_HIDDEN</span><br><span class="hljs-meta"># <span class="hljs-keyword">ifndef</span> __ASSEMBLER__</span><br><span class="hljs-meta">#  <span class="hljs-keyword">define</span> __hidden_proto_hiddenattr(attrs...) \</span><br><span class="hljs-meta">  __attribute__ ((visibility (<span class="hljs-string">&quot;hidden&quot;</span>), ##attrs))</span><br><span class="hljs-meta">#  <span class="hljs-keyword">define</span> hidden_proto(name, attrs...) \</span><br><span class="hljs-meta">  __hidden_proto (name, , __GI_##name, ##attrs)</span><br><span class="hljs-meta">#  <span class="hljs-keyword">define</span> hidden_tls_proto(name, attrs...) \</span><br><span class="hljs-meta">  __hidden_proto (name, __thread, __GI_##name, ##attrs)</span><br><span class="hljs-meta">#  <span class="hljs-keyword">define</span> __hidden_proto(name, thread, internal, attrs...)	     \</span><br><span class="hljs-meta">  extern thread __typeof (name) name __asm__ (__hidden_asmname (#internal)) \</span><br><span class="hljs-meta">  __hidden_proto_hiddenattr (attrs);</span><br>...<br><span class="hljs-meta">#<span class="hljs-keyword">else</span></span><br><span class="hljs-meta"># <span class="hljs-keyword">ifndef</span> __ASSEMBLER__</span><br><span class="hljs-meta">#  <span class="hljs-keyword">define</span> hidden_proto(name, attrs...)</span><br>...<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br></code></pre></td></tr></table></figure>

<p>çœ‹å¾—å‡ºæ¥åœ¨å¤šé‡å¥—å¨ƒä¹‹åè¿™å…¶å®æ˜¯ä¸€ä¸ªattributeï¼Œé‡Œè¾¹å¥—çš„æ˜¯visibility (â€œhiddenâ€)ï¼ŒæŸ¥çœ‹gccæ‰‹å†Œæˆ‘ä»¬å¯ä»¥å‘ç°å…¶è¯´æ˜å¦‚ä¸‹ï¼š</p>
<blockquote>
<figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ebnf"><span class="hljs-attribute">hidden</span><br></code></pre></td></tr></table></figure>

<p>Hidden visibility indicates that the entity declared has a new form of linkage, which we call â€œhidden linkageâ€. Two declarations of an object with hidden linkage refer to the same object if they are in the same shared object.</p>
</blockquote>
<p>å¤§æ„æ˜¯è¯´è¿™ä¸ªattributeå£°æ˜è¯¥å‡½æ•°çš„visibilityä¸ºhiddenï¼Œå…¶æœ‰ç€ä¸€ç§æ–°çš„é“¾æ¥å½¢å¼ï¼Œç§°ä¹‹ä¸ºâ€œéšå¼é“¾æ¥â€ï¼ˆhidden linkageï¼‰ï¼Œå³<strong>å¯¹äºé“¾æ¥è¯¥åº“çš„ç¨‹åºè€Œè¨€ï¼Œè¯¥å‡½æ•°æ˜¯éšè—çš„</strong></p>
<p>åœ¨<strong>élibcä¸­è¯¥å®æ— æ•ˆ</strong></p>
<blockquote>
<h4 id="attribute-visibility-â€œhiddenâ€"><a href="#attribute-visibility-â€œhiddenâ€" class="headerlink" title="attribute: visibility(â€œhiddenâ€)"></a>attribute: visibility(â€œhiddenâ€)</h4><p>é€šä¿—æ¥è®²ï¼Œhiddenæ˜¯ç”¨äºæŠ‘åˆ¶ä¸€ä¸ªç¬¦å·çš„è¡¨è¾¾çš„</p>
<p>è®¾æƒ³å¦‚ä¸‹æƒ…å†µï¼šç¨‹åºaéœ€è¦åŒæ—¶é“¾æ¥libc-arttnba1.soå’Œlibc-arttnba2.soä¸¤ä¸ªåº“ï¼Œè€Œä¸¤ä¸ªåº“ä¸­è‹¥æ˜¯å­˜åœ¨åŒåçš„å‡½æ•°ï¼Œé‚£ä¹ˆåº“çš„åŠ è½½å…ˆåé¡ºåºçš„ä¸åŒå°†ä¼šå¯¼è‡´ç¨‹åºæ‰€è°ƒç”¨çš„å‡½æ•°ä¸åŒï¼Œ<strong>æ¯«æ— ç–‘é—®è¿™å°†é€ æˆæ··ä¹±è°ƒç”¨</strong></p>
<p>åœ¨ä½¿ç”¨attributeçš„visibility(â€œhiddenâ€)çš„æƒ…å†µä¸‹ï¼Œ<strong>è¯¥å‡½æ•°å°†ä¼šæŠ‘åˆ¶è‡ªèº«ç¬¦å·çš„è¡¨è¾¾</strong>ï¼š</p>
<p>åŒæ ·è®¾æƒ³å‰é¢çš„æƒ…å†µï¼Œè‹¥æ˜¯å­˜åœ¨ä¸€ä¸ªåŒåå‡½æ•°foo()ï¼Œè€Œlibc-arttnba2.soä¸­çš„foo()å‡½æ•°ä½¿ç”¨attributeè®¾å®šäº†visibilityä¸ºhiddençš„æƒ…å†µä¸‹ï¼Œæ— è®ºè¿™ä¸¤ä¸ªåŠ¨æ€é“¾æ¥åº“çš„åŠ è½½å…ˆåé¡ºåºå¦‚ä½•ï¼Œéƒ½åªä¼šè°ƒç”¨libc-arttnba1.soä¸­çš„foo()å‡½æ•°</p>
</blockquote>
<p>æ¥ä¸‹æ¥æˆ‘ä»¬çœ‹è¯¥å‡½æ•°çš„å®šä¹‰éƒ¨åˆ†</p>
<h2 id="libc-mallocå‡½æ•°å®šä¹‰ï¼š"><a href="#libc-mallocå‡½æ•°å®šä¹‰ï¼š" class="headerlink" title="__libc_mallocå‡½æ•°å®šä¹‰ï¼š"></a>__libc_mallocå‡½æ•°å®šä¹‰ï¼š</h2><p>è‹¥æ˜¯ç¬¬ä¸€æ¬¡é˜…è¯»libcæºç ï¼Œæ¯«æ— ç–‘é—®æˆ‘ä»¬ä¼šååˆ†æƒŠå¥‡åœ°å‘ç°è¯¥å‡½æ•°çš„ä»£ç è¶…ä¹æƒ³è±¡çš„çŸ­ï¼Œå¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span> *<br>__libc_malloc (<span class="hljs-type">size_t</span> bytes)<br>&#123;<br>  mstate ar_ptr;<br>  <span class="hljs-type">void</span> *victim;<br><br>  <span class="hljs-type">void</span> *(*hook) (<span class="hljs-type">size_t</span>, <span class="hljs-type">const</span> <span class="hljs-type">void</span> *)<br>    = atomic_forced_read (__malloc_hook);<br>  <span class="hljs-keyword">if</span> (__builtin_expect (hook != <span class="hljs-literal">NULL</span>, <span class="hljs-number">0</span>))<br>    <span class="hljs-keyword">return</span> (*hook)(bytes, RETURN_ADDRESS (<span class="hljs-number">0</span>));<br><br>  arena_get (ar_ptr, bytes);<br><br>  victim = _int_malloc (ar_ptr, bytes);<br>  <span class="hljs-comment">/* Retry with another arena only if we were able to find a usable arena</span><br><span class="hljs-comment">     before.  */</span><br>  <span class="hljs-keyword">if</span> (!victim &amp;&amp; ar_ptr != <span class="hljs-literal">NULL</span>)<br>    &#123;<br>      LIBC_PROBE (memory_malloc_retry, <span class="hljs-number">1</span>, bytes);<br>      ar_ptr = arena_get_retry (ar_ptr, bytes);<br>      victim = _int_malloc (ar_ptr, bytes);<br>    &#125;<br><br>  <span class="hljs-keyword">if</span> (ar_ptr != <span class="hljs-literal">NULL</span>)<br>    (<span class="hljs-type">void</span>) mutex_unlock (&amp;ar_ptr-&gt;mutex);<br><br>  assert (!victim || chunk_is_mmapped (mem2chunk (victim)) ||<br>          ar_ptr == arena_for_chunk (mem2chunk (victim)));<br>  <span class="hljs-keyword">return</span> victim;<br>&#125;<br>libc_hidden_def (__libc_malloc)<br></code></pre></td></tr></table></figure>

<p>é¦–å…ˆå¼€å¤´å®šä¹‰ä¸‰ä¸ªå˜é‡ï¼šmstateç±»å‹çš„ar_ptrï¼Œvoidç±»å‹æŒ‡é’ˆvictimï¼Œè¿”å›å€¼ä¸ºvoidç±»å‹æŒ‡é’ˆçš„å‡½æ•°æŒ‡é’ˆhook</p>
<blockquote>
<p>ä¸éš¾æƒ³åˆ°ï¼Œar_ptrå³ä¸ºarena pointerï¼›victimåº”å½“ä¸ºæŒ‡å‘åˆ†é…çš„chunkçš„æŒ‡é’ˆï¼›è€Œè¿™ä¸ªhookåº”å½“å°±æ˜¯æˆ‘ä»¬æ¯”èµ›ä¸­å¸¸æ‰“çš„__malloc_hook</p>
</blockquote>
<h3 id="1-æ£€æŸ¥é’©å­-malloc-hookæ˜¯å¦ä¸ºNULLï¼Œè‹¥å¦ï¼Œåˆ™è°ƒç”¨é’©å­"><a href="#1-æ£€æŸ¥é’©å­-malloc-hookæ˜¯å¦ä¸ºNULLï¼Œè‹¥å¦ï¼Œåˆ™è°ƒç”¨é’©å­" class="headerlink" title="1.æ£€æŸ¥é’©å­__malloc_hookæ˜¯å¦ä¸ºNULLï¼Œè‹¥å¦ï¼Œåˆ™è°ƒç”¨é’©å­"></a>1.æ£€æŸ¥é’©å­__malloc_hookæ˜¯å¦ä¸ºNULLï¼Œè‹¥å¦ï¼Œåˆ™è°ƒç”¨é’©å­</h3><p>åœ¨å‡½æ•°ä¸€å¼€å§‹çš„æ—¶å€™ä¼šå…ˆè°ƒç”¨<code>atomic_forced_read()</code>ç»™hookå˜é‡èµ‹å€¼ï¼Œä¼ å…¥è¿™ä¸ªå‡½æ•°çš„å‚æ•°ä¸º<strong>__malloc_hook</strong></p>
<p>æˆ‘ä»¬å…ˆçœ‹<code>atomic_forced_read()</code>ï¼Œæ˜¯ä¸€ä¸ªå®šä¹‰äºinclude&#x2F;atomic.hä¸­çš„å®ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> atomic_forced_read</span><br><span class="hljs-meta"># <span class="hljs-keyword">define</span> atomic_forced_read(x) \</span><br><span class="hljs-meta">  (&#123; __typeof (x) __x; __asm (<span class="hljs-string">&quot;&quot;</span> : <span class="hljs-string">&quot;=r&quot;</span> (__x) : <span class="hljs-string">&quot;0&quot;</span> (x)); __x; &#125;)</span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br></code></pre></td></tr></table></figure>

<p><del>ç›´æ¥ç¿»è¯‘å‡½æ•°åæ˜¯ç”¨åŸå­èƒ½æ¥è¯»å–</del></p>
<p>å¤§æ¦‚æ˜¯<strong>é€šè¿‡ä½¿ç”¨åŸå­æ“ä½œ</strong>å°†xè¯»å…¥åˆ°ä¸€ä¸ªå¯„å­˜å™¨ä¸­å†è¿”å›ï¼ŒåŸå­æ“ä½œç®€å•æ¥è¯´å°±æ˜¯ä¸ä¼šè¢«çº¿ç¨‹çš„è°ƒåº¦æ‰“æ–­çš„æ“ä½œï¼Œç”¨å¤„æ˜¯é˜²æ­¢ç”±äºå¤šçº¿ç¨‹å†²çªå¯¼è‡´çš„è¯¥å€¼è¢«é‡è½½</p>
<p>æ¥ä¸‹æ¥æˆ‘ä»¬æ¥çœ‹<strong>__malloc_hook</strong>çš„å£°æ˜ï¼Œå¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span> *<span class="hljs-title function_">weak_variable</span> <span class="hljs-params">(*__malloc_hook)</span><br>  <span class="hljs-params">(<span class="hljs-type">size_t</span> __size, <span class="hljs-type">const</span> <span class="hljs-type">void</span> *)</span> = malloc_hook_ini;<br></code></pre></td></tr></table></figure>

<p>å¯è§<strong>__malloc_hookåº”ä¸ºä¸€å‡½æ•°æŒ‡é’ˆï¼Œåˆå§‹æ—¶æŒ‡å‘malloc_hook_iniå‡½æ•°</strong></p>
<blockquote>
<h4 id="weak-variable"><a href="#weak-variable" class="headerlink" title="weak_variable"></a>weak_variable</h4><p>å®šä¹‰äºmalloc.cä¸­ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> weak_variable</span><br><span class="hljs-comment">/* In GNU libc we want the hook variables to be weak definitions to</span><br><span class="hljs-comment">avoid a problem with Emacs.  */</span><br><span class="hljs-meta"># <span class="hljs-keyword">define</span> weak_variable weak_function</span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br></code></pre></td></tr></table></figure>

<p>è¿˜æ˜¯å¥—å¨ƒå®šä¹‰ï¼Œè·Ÿè¿›ï¼Œåœ¨include&#x2F;libc-symbols.hä¸­å¯è§å…¶å®šä¹‰</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/* This comes between the return type and function name in</span><br><span class="hljs-comment">a function definition to make that definition weak.  */</span><br><span class="hljs-meta"># <span class="hljs-keyword">define</span> weak_function __attribute__ ((weak))</span><br><span class="hljs-meta"># <span class="hljs-keyword">define</span> weak_const_function __attribute__ ((weak, __const__))</span><br></code></pre></td></tr></table></figure>

<p>ä¹Ÿå°±æ˜¯è¯´è¿™è¿˜æ˜¯ä¸€ä¸ªgccçš„attributeï¼ŒæŸ¥é˜…æ‰‹å†Œä¸­è¯´æ˜å¦‚ä¸‹ï¼š</p>
<blockquote>
<figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ebnf"><span class="hljs-attribute">weak</span><br></code></pre></td></tr></table></figure>

<p>The <code>weak</code> attribute causes a declaration of an external symbol to be emitted as a weak symbol rather than a global. This is primarily useful in defining library functions that can be overridden in user code, though it can also be used with non-function declarations. The overriding symbol must have the same type as the weak symbol. In addition, if it designates a variable it must also have the same size and alignment as the weak symbol. Weak symbols are supported for ELF targets, and also for a.out targets when using the GNU assembler and linker.</p>
</blockquote>
<p>å¯çŸ¥è¿™ä¸ªattributeå¤§æ„æ˜¯å¯¹äºè¯¥ç¬¦å·è€Œè¨€é“¾æ¥å™¨ä¼šå»ä¼˜å…ˆå¯»æ‰¾å…¨å±€ç¬¦å·ï¼Œæ— æ³•æ‰¾å¯»åˆ°ç¬¦åˆæ¡ä»¶çš„å…¨å±€ç¬¦å·åæ‰ä¼šä½¿ç”¨å¼±ç¬¦å·ï¼Œä»¥é¿å…é‡å®šä¹‰é”™è¯¯ï¼›å³å½“ä¸€ä¸ªç¬¦å·å¯èƒ½æˆ–éœ€è¦è¢«ç”¨æˆ·è¦†ç›–æ—¶ï¼Œå¯å°†ä¹‹å£°æ˜ä¸ºä¸€ä¸ªå¼±ç¬¦å·</p>
</blockquote>
<p>å½“<strong>hooké’©å­ä¸ä¸ºNULLæ—¶ä¼šæ‰§è¡Œå…¶æŒ‡å‘çš„å‡½æ•°å¹¶è¿”å›</strong>ï¼Œ__libc_mallocå‡½æ•°ä¾¿äºæ­¤æš‚æ—¶ç»“æŸå…¶æ—…ç¨‹äº†</p>
<p>è€Œ__malloc_hookçš„åˆå§‹å€¼ä¾¿ä¸ä¸ºNULLï¼Œæ•…<strong>åœ¨ç¬¬ä¸€æ¬¡è°ƒç”¨mallocå‡½æ•°æ—¶ä¸€å®šä¼šè½¬åˆ°æ‰§è¡Œmalloc_hook_iniå‡½æ•°</strong></p>
<h4 id="â‘ malloc-hook-iniï¼šé‡ç½®-malloc-hookä¸ºNULLï¼Œè°ƒç”¨ptmallocåˆå§‹åŒ–å‡½æ•°ï¼Œé‡æ–°è°ƒç”¨-libc-mallocåˆ†é…å†…å­˜å—"><a href="#â‘ malloc-hook-iniï¼šé‡ç½®-malloc-hookä¸ºNULLï¼Œè°ƒç”¨ptmallocåˆå§‹åŒ–å‡½æ•°ï¼Œé‡æ–°è°ƒç”¨-libc-mallocåˆ†é…å†…å­˜å—" class="headerlink" title="â‘ malloc_hook__iniï¼šé‡ç½®__malloc_hookä¸ºNULLï¼Œè°ƒç”¨ptmallocåˆå§‹åŒ–å‡½æ•°ï¼Œé‡æ–°è°ƒç”¨__libc_mallocåˆ†é…å†…å­˜å—"></a>â‘ malloc_hook__iniï¼šé‡ç½®__malloc_hookä¸ºNULLï¼Œè°ƒç”¨ptmallocåˆå§‹åŒ–å‡½æ•°ï¼Œé‡æ–°è°ƒç”¨__libc_mallocåˆ†é…å†…å­˜å—</h4><p>ç”±äºmalloc_hook_iniå‡½æ•°åœ¨ç¬¬ä¸€æ¬¡è°ƒç”¨mallocæ—¶ä¸€å®šä¼šè¢«è°ƒç”¨ä¸€æ¬¡ï¼Œæ•…æˆ‘ä»¬å…ˆæ¥çœ‹çœ‹è¿™ä¸ªå‡½æ•°</p>
<p>malloc_hook_iniå‡½æ•°çš„å£°æ˜åœ¨malloc.cä¸­ï¼Œå¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">void</span> *<span class="hljs-title function_">malloc_hook_ini</span> <span class="hljs-params">(<span class="hljs-type">size_t</span> sz,</span><br><span class="hljs-params">                              <span class="hljs-type">const</span> <span class="hljs-type">void</span> *caller)</span> __THROW;<br></code></pre></td></tr></table></figure>

<p>è¯¥å‡½æ•°å®šä¹‰äºmalloc&#x2F;hook.cä¸­ï¼Œå¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">void</span> *<br><span class="hljs-title function_">malloc_hook_ini</span> <span class="hljs-params">(<span class="hljs-type">size_t</span> sz, <span class="hljs-type">const</span> <span class="hljs-type">void</span> *caller)</span><br>&#123;<br>  __malloc_hook = <span class="hljs-literal">NULL</span>;<br>  ptmalloc_init ();<br>  <span class="hljs-keyword">return</span> __libc_malloc (sz);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>è¯¥å‡½æ•°åšäº†ä¸‰ä»¶å°äº‹ï¼š</p>
<ul>
<li><strong>å°†__malloc_hookèµ‹å€¼ä¸ºNULL</strong>ï¼Œè¿™æ ·ä¸€æ¥åœ¨ç¬¬äºŒæ¬¡åŠä»¥åè°ƒç”¨mallocæ—¶éƒ½ä¸ä¼šè¿›å…¥malloc_hook_iniå‡½æ•°ï¼Œè€Œæ˜¯æ¥ç€__libc_mallocçš„å‡½æ•°è¿›ç¨‹å¾€ä¸‹èµ°</li>
<li><strong>è°ƒç”¨ptmalloc_init()å‡½æ•°</strong></li>
<li><strong>é‡æ–°è°ƒç”¨__libc_malloc()å‡½æ•°åˆ†é…åˆé€‚çš„å†…å­˜å—è¿”å›ç»™ç”¨æˆ·</strong></li>
</ul>
<p>äºæ˜¯æˆ‘ä»¬æ¥ä¸‹æ¥æ¥çœ‹çœ‹ptmalloc_init()å‡½æ•°</p>
<h4 id="â‘¡ptmalloc-init-ï¼šåˆå§‹åŒ–ptmallocå †ç®¡ç†å™¨"><a href="#â‘¡ptmalloc-init-ï¼šåˆå§‹åŒ–ptmallocå †ç®¡ç†å™¨" class="headerlink" title="â‘¡ptmalloc_init()ï¼šåˆå§‹åŒ–ptmallocå †ç®¡ç†å™¨"></a>â‘¡ptmalloc_init()ï¼šåˆå§‹åŒ–ptmallocå †ç®¡ç†å™¨</h4><p>è¯¥å‡½æ•°å®šä¹‰äºmalloc&#x2F;arena.cä¸­ï¼Œå¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">void</span><br><span class="hljs-title function_">ptmalloc_init</span> <span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>  <span class="hljs-keyword">if</span> (__malloc_initialized &gt;= <span class="hljs-number">0</span>)<br>    <span class="hljs-keyword">return</span>;<br><br>  __malloc_initialized = <span class="hljs-number">0</span>;<br><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> SHARED</span><br>  <span class="hljs-comment">/* In case this libc copy is in a non-default namespace, never use brk.</span><br><span class="hljs-comment">     Likewise if dlopened from statically linked program.  */</span><br>  Dl_info di;<br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">link_map</span> *<span class="hljs-title">l</span>;</span><br><br>  <span class="hljs-keyword">if</span> (_dl_open_hook != <span class="hljs-literal">NULL</span><br>      || (_dl_addr (ptmalloc_init, &amp;di, &amp;l, <span class="hljs-literal">NULL</span>) != <span class="hljs-number">0</span><br>          &amp;&amp; l-&gt;l_ns != LM_ID_BASE))<br>    __morecore = __failing_morecore;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br>  thread_arena = &amp;main_arena;<br>  thread_atfork (ptmalloc_lock_all, ptmalloc_unlock_all, ptmalloc_unlock_all2);<br>  <span class="hljs-type">const</span> <span class="hljs-type">char</span> *s = <span class="hljs-literal">NULL</span>;<br>  <span class="hljs-keyword">if</span> (__glibc_likely (_environ != <span class="hljs-literal">NULL</span>))<br>    &#123;<br>      <span class="hljs-type">char</span> **runp = _environ;<br>      <span class="hljs-type">char</span> *envline;<br><br>      <span class="hljs-keyword">while</span> (__builtin_expect ((envline = next_env_entry (&amp;runp)) != <span class="hljs-literal">NULL</span>,<br>                               <span class="hljs-number">0</span>))<br>        &#123;<br>          <span class="hljs-type">size_t</span> len = <span class="hljs-built_in">strcspn</span> (envline, <span class="hljs-string">&quot;=&quot;</span>);<br><br>          <span class="hljs-keyword">if</span> (envline[len] != <span class="hljs-string">&#x27;=&#x27;</span>)<br>            <span class="hljs-comment">/* This is a &quot;MALLOC_&quot; variable at the end of the string</span><br><span class="hljs-comment">               without a &#x27;=&#x27; character.  Ignore it since otherwise we</span><br><span class="hljs-comment">               will access invalid memory below.  */</span><br>            <span class="hljs-keyword">continue</span>;<br><br>          <span class="hljs-keyword">switch</span> (len)<br>            &#123;<br>            <span class="hljs-keyword">case</span> <span class="hljs-number">6</span>:<br>              <span class="hljs-keyword">if</span> (<span class="hljs-built_in">memcmp</span> (envline, <span class="hljs-string">&quot;CHECK_&quot;</span>, <span class="hljs-number">6</span>) == <span class="hljs-number">0</span>)<br>                s = &amp;envline[<span class="hljs-number">7</span>];<br>              <span class="hljs-keyword">break</span>;<br>            <span class="hljs-keyword">case</span> <span class="hljs-number">8</span>:<br>              <span class="hljs-keyword">if</span> (!__builtin_expect (__libc_enable_secure, <span class="hljs-number">0</span>))<br>                &#123;<br>                  <span class="hljs-keyword">if</span> (<span class="hljs-built_in">memcmp</span> (envline, <span class="hljs-string">&quot;TOP_PAD_&quot;</span>, <span class="hljs-number">8</span>) == <span class="hljs-number">0</span>)<br>                    __libc_mallopt (M_TOP_PAD, atoi (&amp;envline[<span class="hljs-number">9</span>]));<br>                  <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-built_in">memcmp</span> (envline, <span class="hljs-string">&quot;PERTURB_&quot;</span>, <span class="hljs-number">8</span>) == <span class="hljs-number">0</span>)<br>                    __libc_mallopt (M_PERTURB, atoi (&amp;envline[<span class="hljs-number">9</span>]));<br>                &#125;<br>              <span class="hljs-keyword">break</span>;<br>            <span class="hljs-keyword">case</span> <span class="hljs-number">9</span>:<br>              <span class="hljs-keyword">if</span> (!__builtin_expect (__libc_enable_secure, <span class="hljs-number">0</span>))<br>                &#123;<br>                  <span class="hljs-keyword">if</span> (<span class="hljs-built_in">memcmp</span> (envline, <span class="hljs-string">&quot;MMAP_MAX_&quot;</span>, <span class="hljs-number">9</span>) == <span class="hljs-number">0</span>)<br>                    __libc_mallopt (M_MMAP_MAX, atoi (&amp;envline[<span class="hljs-number">10</span>]));<br>                  <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-built_in">memcmp</span> (envline, <span class="hljs-string">&quot;ARENA_MAX&quot;</span>, <span class="hljs-number">9</span>) == <span class="hljs-number">0</span>)<br>                    __libc_mallopt (M_ARENA_MAX, atoi (&amp;envline[<span class="hljs-number">10</span>]));<br>                &#125;<br>              <span class="hljs-keyword">break</span>;<br>            <span class="hljs-keyword">case</span> <span class="hljs-number">10</span>:<br>              <span class="hljs-keyword">if</span> (!__builtin_expect (__libc_enable_secure, <span class="hljs-number">0</span>))<br>                &#123;<br>                  <span class="hljs-keyword">if</span> (<span class="hljs-built_in">memcmp</span> (envline, <span class="hljs-string">&quot;ARENA_TEST&quot;</span>, <span class="hljs-number">10</span>) == <span class="hljs-number">0</span>)<br>                    __libc_mallopt (M_ARENA_TEST, atoi (&amp;envline[<span class="hljs-number">11</span>]));<br>                &#125;<br>              <span class="hljs-keyword">break</span>;<br>            <span class="hljs-keyword">case</span> <span class="hljs-number">15</span>:<br>              <span class="hljs-keyword">if</span> (!__builtin_expect (__libc_enable_secure, <span class="hljs-number">0</span>))<br>                &#123;<br>                  <span class="hljs-keyword">if</span> (<span class="hljs-built_in">memcmp</span> (envline, <span class="hljs-string">&quot;TRIM_THRESHOLD_&quot;</span>, <span class="hljs-number">15</span>) == <span class="hljs-number">0</span>)<br>                    __libc_mallopt (M_TRIM_THRESHOLD, atoi (&amp;envline[<span class="hljs-number">16</span>]));<br>                  <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-built_in">memcmp</span> (envline, <span class="hljs-string">&quot;MMAP_THRESHOLD_&quot;</span>, <span class="hljs-number">15</span>) == <span class="hljs-number">0</span>)<br>                    __libc_mallopt (M_MMAP_THRESHOLD, atoi (&amp;envline[<span class="hljs-number">16</span>]));<br>                &#125;<br>              <span class="hljs-keyword">break</span>;<br>            <span class="hljs-keyword">default</span>:<br>              <span class="hljs-keyword">break</span>;<br>            &#125;<br>        &#125;<br>    &#125;<br>  <span class="hljs-keyword">if</span> (s &amp;&amp; s[<span class="hljs-number">0</span>])<br>    &#123;<br>      __libc_mallopt (M_CHECK_ACTION, (<span class="hljs-type">int</span>) (s[<span class="hljs-number">0</span>] - <span class="hljs-string">&#x27;0&#x27;</span>));<br>      <span class="hljs-keyword">if</span> (check_action != <span class="hljs-number">0</span>)<br>        __malloc_check_init ();<br>    &#125;<br>  <span class="hljs-type">void</span> (*hook) (<span class="hljs-type">void</span>) = atomic_forced_read (__malloc_initialize_hook);<br>  <span class="hljs-keyword">if</span> (hook != <span class="hljs-literal">NULL</span>)<br>    (*hook)();<br>  __malloc_initialized = <span class="hljs-number">1</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<h5 id="1ï¼‰ä¿®æ”¹ptmallocåˆå§‹åŒ–æ ‡å¿—ä½"><a href="#1ï¼‰ä¿®æ”¹ptmallocåˆå§‹åŒ–æ ‡å¿—ä½" class="headerlink" title="1ï¼‰ä¿®æ”¹ptmallocåˆå§‹åŒ–æ ‡å¿—ä½"></a>1ï¼‰ä¿®æ”¹ptmallocåˆå§‹åŒ–æ ‡å¿—ä½</h5><p>å¼€å¤´å…ˆæ£€æµ‹<code>__maloc_initialized</code>æ˜¯å¦å¤§äºç­‰äº0ï¼Œè‹¥å¦æ‰ä¼šç»§ç»­æ‰§è¡Œæ¥ä¸‹æ¥çš„ä¸€åˆ‡ï¼Œè€Œç¬¬ä¸€æ­¥ä¾¿æ˜¯å°†ä¹‹ç½®0ï¼Œæ•…ä¸éš¾å¾—å‡ºè¿™æ˜¯ä¸€ä¸ª<strong>ç”¨æ¥æ£€æµ‹ptmallocæ˜¯å¦å·²ç»åˆå§‹åŒ–</strong>çš„æ ‡å¿—ä½ï¼›</p>
<p>è¯¥å˜é‡åŒæ ·å®šä¹‰äºarena.cä¸­ï¼Œå¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/* Already initialized? */</span><br><span class="hljs-type">int</span> __malloc_initialized = <span class="hljs-number">-1</span>;<br></code></pre></td></tr></table></figure>

<p>å…¶åˆå§‹å€¼è¢«è®¾ç½®ä¸º<code>-1</code>ï¼Œä¿è¯äº†è¿™ä¸ªå‡½æ•°ä¸€å®šä¼šè¢«æ‰§è¡Œä¸€æ¬¡</p>
<h5 id="2ï¼‰æ£€æŸ¥SHAREDå®"><a href="#2ï¼‰æ£€æŸ¥SHAREDå®" class="headerlink" title="2ï¼‰æ£€æŸ¥SHAREDå®"></a>2ï¼‰æ£€æŸ¥SHAREDå®</h5><p>æ¥ä¸‹æ¥ä¼šæ£€æŸ¥<code>SHARED</code>å®æ˜¯å¦æœ‰è¢«å®šä¹‰è¿‡ï¼Œæ³¨é‡Šè¯´æ˜ï¼š<strong>å‡ä½¿è¯¥libcå‰¯æœ¬åœ¨éé»˜è®¤çš„å‘½åç©ºé—´ä¸­ï¼Œåˆ™ä¸è¦ä½¿ç”¨brkç³»ç»Ÿè°ƒç”¨ï¼›åŒæ ·çš„ï¼Œè‹¥æ˜¯åœ¨ä½¿ç”¨dlopen</strong>()<strong>æ‰“å¼€ä¸€ä¸ªé™æ€é“¾æ¥çš„ç¨‹åºçš„æƒ…å†µä¸‹äº¦æ˜¯å¦‚æ­¤</strong></p>
<p><del>è¿™ä¸ªå®çš„å®šä¹‰ä½ç½®æš‚ä¸”æ‰¾ä¸åˆ°ï¼Œè¿™é‡Œå°±å…ˆä¸ç®¡äº†</del></p>
<h5 id="3ï¼‰è·å–main-arenaï¼Œæ·»åŠ atfork-memå…¥fork-handleré“¾è¡¨"><a href="#3ï¼‰è·å–main-arenaï¼Œæ·»åŠ atfork-memå…¥fork-handleré“¾è¡¨" class="headerlink" title="3ï¼‰è·å–main_arenaï¼Œæ·»åŠ atfork_memå…¥fork_handleré“¾è¡¨"></a>3ï¼‰è·å–main_arenaï¼Œæ·»åŠ atfork_memå…¥fork_handleré“¾è¡¨</h5><p>æ¥ä¸‹æ¥ä¼šå…ˆè®¾ç½®è¯¥çº¿ç¨‹arenaä¸ºmain_arenaï¼Œå³åœ¨ptmallocæœªåˆå§‹åŒ–æ—¶é»˜è®¤ä¼šä½¿ç”¨main_arenaï¼Œè€Œä¸æ˜¯æ–°å»ºarena</p>
<p>éšåæ˜¯ä½¿ç”¨äº†<code>thread_atfork()</code>å®ï¼Œè¯¥å®å®šä¹‰äºsysdeps&#x2F;nptl&#x2F;malloc-machine.hä¸­ï¼Œå¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> ATFORK_MEM static struct fork_handler atfork_mem</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> SHARED</span><br><span class="hljs-meta"># <span class="hljs-keyword">define</span> thread_atfork(prepare, parent, child) \</span><br><span class="hljs-meta">  atfork_mem.prepare_handler = prepare;					      \</span><br><span class="hljs-meta">  atfork_mem.parent_handler = parent;					      \</span><br><span class="hljs-meta">  atfork_mem.child_handler = child;					      \</span><br><span class="hljs-meta">  atfork_mem.dso_handle = __dso_handle;					      \</span><br><span class="hljs-meta">  atfork_mem.refcntr = 1;						      \</span><br><span class="hljs-meta">  __linkin_atfork (&amp;atfork_mem)</span><br><span class="hljs-meta">#<span class="hljs-keyword">else</span></span><br><span class="hljs-meta"># <span class="hljs-keyword">define</span> thread_atfork(prepare, parent, child) \</span><br><span class="hljs-meta">  atfork_mem.prepare_handler = prepare;					      \</span><br><span class="hljs-meta">  atfork_mem.parent_handler = parent;					      \</span><br><span class="hljs-meta">  atfork_mem.child_handler = child;					      \</span><br><span class="hljs-meta">  atfork_mem.dso_handle = &amp;__dso_handle == NULL ? NULL : __dso_handle;	      \</span><br><span class="hljs-meta">  atfork_mem.refcntr = 1;						      \</span><br><span class="hljs-meta">  __linkin_atfork (&amp;atfork_mem)</span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br></code></pre></td></tr></table></figure>

<p>è¿™é‡Œçš„atfork_memå˜é‡çš„ç±»å‹ä¸ºfork_handlerç»“æ„ä½“ï¼Œè¯¥ç»“æ„ä½“å®šä¹‰ä¸sysdeps&#x2F;nptl&#x2F;fork.hä¸­ï¼Œå¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">fork_handler</span></span><br><span class="hljs-class">&#123;</span><br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">fork_handler</span> *<span class="hljs-title">next</span>;</span><br>  <span class="hljs-type">void</span> (*prepare_handler) (<span class="hljs-type">void</span>);<br>  <span class="hljs-type">void</span> (*parent_handler) (<span class="hljs-type">void</span>);<br>  <span class="hljs-type">void</span> (*child_handler) (<span class="hljs-type">void</span>);<br>  <span class="hljs-type">void</span> *dso_handle;<br>  <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> refcntr;<br>  <span class="hljs-type">int</span> need_signal;<br>&#125;;<br></code></pre></td></tr></table></figure>

<p>ä¸éš¾çœ‹å‡ºfork_handlerä¹‹é—´åŒæ ·é“¾æ¥æˆä¸€ä¸ªå•å‘é“¾è¡¨</p>
<p>é‚£ä¹ˆæˆ‘ä»¬å¯ä»¥å¾—å‡ºthread_atfork()å®è®¾ç½®äº†ä¸‰ä¸ªå‡½æ•°æŒ‡é’ˆï¼Œå¹¶æœ€ç»ˆåˆè°ƒç”¨äº†å‡½æ•°__linkin_atfork()ï¼Œè¯¥å‡½æ•°å®šä¹‰äºnptl&#x2F;register-atfork.cä¸­ï¼Œå¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span><br>attribute_hidden<br>__linkin_atfork (<span class="hljs-keyword">struct</span> fork_handler *newp)<br>&#123;<br>  <span class="hljs-keyword">do</span><br>    newp-&gt;next = __fork_handlers;<br>  <span class="hljs-keyword">while</span> (catomic_compare_and_exchange_bool_acq (&amp;__fork_handlers,<br>						newp, newp-&gt;next) != <span class="hljs-number">0</span>);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>å¾—å‡º__linkin_atfork()çš„ä½œç”¨åº”å½“ä¸ºå°†atfork_memæ·»åŠ å…¥fork_handleré“¾è¡¨ä¸­</p>
<p><strong>è¿™ä¸€ç³»åˆ—ä¸‹æ¥çš„æ“ä½œçš„ä½œç”¨æ˜¯ï¼šåœ¨æ¥ä¸‹æ¥ç¨‹åºforkå‡ºå­çº¿ç¨‹æ—¶ä¼šè°ƒç”¨atfork_memä¸­çš„ä¸‰ä¸ªå‡½æ•°æŒ‡é’ˆæ‰€æŒ‡å‘çš„å‡½æ•°</strong></p>
<h5 id="4ï¼‰ç¯å¢ƒå˜é‡-environç›¸å…³æ“ä½œ"><a href="#4ï¼‰ç¯å¢ƒå˜é‡-environç›¸å…³æ“ä½œ" class="headerlink" title="4ï¼‰ç¯å¢ƒå˜é‡__environç›¸å…³æ“ä½œ"></a>4ï¼‰ç¯å¢ƒå˜é‡__environç›¸å…³æ“ä½œ</h5><p>æ¥ä¸‹æ¥ä¼šæ£€æŸ¥_environå˜é‡æ˜¯å¦ä¸ºNULLï¼Œè¯¥å˜é‡ä¸º__environå˜é‡çš„å¼±åˆ«åï¼Œå®šä¹‰äºposix&#x2F;environ.cä¸­ï¼Œå¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/* This must be initialized; we cannot have a weak alias into bss.  */</span><br><span class="hljs-type">char</span> **__environ = <span class="hljs-literal">NULL</span>;<br>weak_alias (__environ, environ)<br><br><span class="hljs-comment">/* The SVR4 ABI says `_environ&#x27; will be the name to use</span><br><span class="hljs-comment">   in case the user overrides the weak alias `environ&#x27;.  */</span><br>weak_alias (__environ, _environ)<br></code></pre></td></tr></table></figure>

<p>weak_aliaså’Œstrong_aliasæ˜¯ç±»ä¼¼çš„ï¼Œåªä¸è¿‡å®šä¹‰çš„æ˜¯å¼±åˆ«åï¼Œè¿™é‡Œä¾¿ä¸å†èµ˜å™</p>
<p>__environå˜é‡ä¸€èˆ¬éƒ½ä¸ä¸ºNULLï¼Œå› æ­¤åœ¨è¿™é‡Œä½¿ç”¨äº†åˆ†æ”¯é¢„æµ‹ä¼˜åŒ–å°è£…å®__glibc_likely()ï¼ˆè¯¦ç»†å®šä¹‰å‰æ–‡å·²æœ‰è¯´æ˜ï¼‰</p>
<p>æ¥ä¸‹æ¥ä¼šè°ƒç”¨<code>next_env_entry()</code>å‡½æ•°ï¼ŒåŒæ ·å®šä¹‰äºarena.cä¸­ï¼Œå¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">char</span> *<br>internal_function<br><span class="hljs-title function_">next_env_entry</span> <span class="hljs-params">(<span class="hljs-type">char</span> ***position)</span><br>&#123;<br>  <span class="hljs-type">char</span> **current = *position;<br>  <span class="hljs-type">char</span> *result = <span class="hljs-literal">NULL</span>;<br><br>  <span class="hljs-keyword">while</span> (*current != <span class="hljs-literal">NULL</span>)<br>    &#123;<br>      <span class="hljs-keyword">if</span> (__builtin_expect ((*current)[<span class="hljs-number">0</span>] == <span class="hljs-string">&#x27;M&#x27;</span>, <span class="hljs-number">0</span>)<br>          &amp;&amp; (*current)[<span class="hljs-number">1</span>] == <span class="hljs-string">&#x27;A&#x27;</span><br>          &amp;&amp; (*current)[<span class="hljs-number">2</span>] == <span class="hljs-string">&#x27;L&#x27;</span><br>          &amp;&amp; (*current)[<span class="hljs-number">3</span>] == <span class="hljs-string">&#x27;L&#x27;</span><br>          &amp;&amp; (*current)[<span class="hljs-number">4</span>] == <span class="hljs-string">&#x27;O&#x27;</span><br>          &amp;&amp; (*current)[<span class="hljs-number">5</span>] == <span class="hljs-string">&#x27;C&#x27;</span><br>          &amp;&amp; (*current)[<span class="hljs-number">6</span>] == <span class="hljs-string">&#x27;_&#x27;</span>)<br>        &#123;<br>          result = &amp;(*current)[<span class="hljs-number">7</span>];<br><br>          <span class="hljs-comment">/* Save current position for next visit.  */</span><br>          *position = ++current;<br><br>          <span class="hljs-keyword">break</span>;<br>        &#125;<br><br>      ++current;<br>    &#125;<br><br>  <span class="hljs-keyword">return</span> result;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>å¤§æ¦‚ä½œç”¨æ˜¯åœ¨<code>__environ</code>ä¸­æ‰¾åˆ°<strong>å¼€å¤´ä¸ºâ€MALLOC_â€œçš„å­—ç¬¦ä¸²</strong>çš„åœ°å€ï¼Œè‹¥æ‰¾ä¸åˆ°åˆ™è¿”å›NULL</p>
<p>é€šå¸¸æƒ…å†µä¸‹<code>__environ</code>ä¸­ä¸å­˜åœ¨è¿™æ ·çš„å­—ç¬¦ä¸²ï¼Œå› è€Œåœ¨è¿™é‡Œç”¨äº†builtin_expectå®</p>
<p>è‹¥è¯¥å­—ç¬¦ä¸²å­˜åœ¨ï¼Œåˆ™ä¼šè°ƒç”¨<code>strcspn()</code>å‡½æ•°æŸ¥æ‰¾å­—ç¬¦<code>&#39;=&#39;</code>ï¼Œè‹¥ä¸å­˜åœ¨åˆ™åˆä¼šé‡æ–°å›å»è°ƒç”¨<code>next_env_entry()</code>å‡½æ•°</p>
<blockquote>
<p>ç¬”è€…è®¤ä¸ºè¿™é‡Œæœ‰å¯èƒ½é€ æˆæ­»å¾ªç¯</p>
</blockquote>
<p>å‡½æ•°ä¸­è®¾å®šçš„éœ€è¦å¤„ç†çš„å­—ç¬¦ä¸²å¦‚ä¸‹ï¼š</p>
<ul>
<li><strong>MALLOC_CHECK_</strong></li>
<li><strong>MALLOC_TOP_PAD_</strong></li>
<li><strong>MALLOC_PERTURB_</strong></li>
<li><strong>MALLOC_MMAP_MAX_</strong></li>
<li><strong>MALLOC_ARENA_MAX</strong></li>
<li><strong>MALLOC_ARENA_TEST</strong></li>
<li><strong>MALLOC_TRIM_THRESHOLD_</strong></li>
<li><strong>MALLOC_MMAP_THRESHOLD_</strong></li>
</ul>
<p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œé’ˆå¯¹<code>MALLOC_CHECK_</code>ï¼Œptmalloc_init()å‡½æ•°ä¼šå•ç‹¬è¿›è¡Œå¤„ç†ï¼Œè€Œå‰©ä¸‹çš„åˆ™ä¼šè°ƒç”¨<code>__libc_mallopt()</code>å‡½æ•°è¿›è¡Œå¤„ç†</p>
<p>è¯¥å‡½æ•°å®šä¹‰äºmalloc.cä¸­ï¼Œå¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span><br>__libc_mallopt (<span class="hljs-type">int</span> param_number, <span class="hljs-type">int</span> value)<br>&#123;<br>  mstate av = &amp;main_arena;<br>  <span class="hljs-type">int</span> res = <span class="hljs-number">1</span>;<br><br>  <span class="hljs-keyword">if</span> (__malloc_initialized &lt; <span class="hljs-number">0</span>)<br>    ptmalloc_init ();<br>  (<span class="hljs-type">void</span>) mutex_lock (&amp;av-&gt;mutex);<br>  <span class="hljs-comment">/* Ensure initialization/consolidation */</span><br>  malloc_consolidate (av);<br><br>  LIBC_PROBE (memory_mallopt, <span class="hljs-number">2</span>, param_number, value);<br><br>  <span class="hljs-keyword">switch</span> (param_number)<br>    &#123;<br>    <span class="hljs-keyword">case</span> M_MXFAST:<br>      <span class="hljs-keyword">if</span> (value &gt;= <span class="hljs-number">0</span> &amp;&amp; value &lt;= MAX_FAST_SIZE)<br>        &#123;<br>          LIBC_PROBE (memory_mallopt_mxfast, <span class="hljs-number">2</span>, value, get_max_fast ());<br>          set_max_fast (value);<br>        &#125;<br>      <span class="hljs-keyword">else</span><br>        res = <span class="hljs-number">0</span>;<br>      <span class="hljs-keyword">break</span>;<br><br>    <span class="hljs-keyword">case</span> M_TRIM_THRESHOLD:<br>      LIBC_PROBE (memory_mallopt_trim_threshold, <span class="hljs-number">3</span>, value,<br>                  mp_.trim_threshold, mp_.no_dyn_threshold);<br>      mp_.trim_threshold = value;<br>      mp_.no_dyn_threshold = <span class="hljs-number">1</span>;<br>      <span class="hljs-keyword">break</span>;<br><br>    <span class="hljs-keyword">case</span> M_TOP_PAD:<br>      LIBC_PROBE (memory_mallopt_top_pad, <span class="hljs-number">3</span>, value,<br>                  mp_.top_pad, mp_.no_dyn_threshold);<br>      mp_.top_pad = value;<br>      mp_.no_dyn_threshold = <span class="hljs-number">1</span>;<br>      <span class="hljs-keyword">break</span>;<br><br>    <span class="hljs-keyword">case</span> M_MMAP_THRESHOLD:<br>      <span class="hljs-comment">/* Forbid setting the threshold too high. */</span><br>      <span class="hljs-keyword">if</span> ((<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) value &gt; HEAP_MAX_SIZE / <span class="hljs-number">2</span>)<br>        res = <span class="hljs-number">0</span>;<br>      <span class="hljs-keyword">else</span><br>        &#123;<br>          LIBC_PROBE (memory_mallopt_mmap_threshold, <span class="hljs-number">3</span>, value,<br>                      mp_.mmap_threshold, mp_.no_dyn_threshold);<br>          mp_.mmap_threshold = value;<br>          mp_.no_dyn_threshold = <span class="hljs-number">1</span>;<br>        &#125;<br>      <span class="hljs-keyword">break</span>;<br><br>    <span class="hljs-keyword">case</span> M_MMAP_MAX:<br>      LIBC_PROBE (memory_mallopt_mmap_max, <span class="hljs-number">3</span>, value,<br>                  mp_.n_mmaps_max, mp_.no_dyn_threshold);<br>      mp_.n_mmaps_max = value;<br>      mp_.no_dyn_threshold = <span class="hljs-number">1</span>;<br>      <span class="hljs-keyword">break</span>;<br><br>    <span class="hljs-keyword">case</span> M_CHECK_ACTION:<br>      LIBC_PROBE (memory_mallopt_check_action, <span class="hljs-number">2</span>, value, check_action);<br>      check_action = value;<br>      <span class="hljs-keyword">break</span>;<br><br>    <span class="hljs-keyword">case</span> M_PERTURB:<br>      LIBC_PROBE (memory_mallopt_perturb, <span class="hljs-number">2</span>, value, perturb_byte);<br>      perturb_byte = value;<br>      <span class="hljs-keyword">break</span>;<br><br>    <span class="hljs-keyword">case</span> M_ARENA_TEST:<br>      <span class="hljs-keyword">if</span> (value &gt; <span class="hljs-number">0</span>)<br>        &#123;<br>          LIBC_PROBE (memory_mallopt_arena_test, <span class="hljs-number">2</span>, value, mp_.arena_test);<br>          mp_.arena_test = value;<br>        &#125;<br>      <span class="hljs-keyword">break</span>;<br><br>    <span class="hljs-keyword">case</span> M_ARENA_MAX:<br>      <span class="hljs-keyword">if</span> (value &gt; <span class="hljs-number">0</span>)<br>        &#123;<br>          LIBC_PROBE (memory_mallopt_arena_max, <span class="hljs-number">2</span>, value, mp_.arena_max);<br>          mp_.arena_max = value;<br>        &#125;<br>      <span class="hljs-keyword">break</span>;<br>    &#125;<br>  (<span class="hljs-type">void</span>) mutex_unlock (&amp;av-&gt;mutex);<br>  <span class="hljs-keyword">return</span> res;<br>&#125;<br>libc_hidden_def (__libc_mallopt)<br></code></pre></td></tr></table></figure>

<p>é¦–å…ˆä¼šæ£€æŸ¥<code>malloc_initialized</code>çš„å€¼ï¼Œè‹¥æ˜¯å°äº0åˆ™ä¼šè°ƒç”¨<code>ptmalloc_init()</code>å‡½æ•°ï¼Œ<del>è¿™æ˜¯åˆå¥—å¨ƒå›å»äº†ï¼Œä¸è¿‡è¿™é‡Œåœ¨å‰é¢å¼€å¤´å·²ç»å°†å…¶ç½®0äº†ï¼Œæ‰€ä»¥è¿™ç§æƒ…å†µä¸ä¼šå‘ç”Ÿ</del></p>
<p>æ¥ä¸‹æ¥é¦–å…ˆä¼šé”ä¸Šmain_arenaçš„äº’æ–¥é”ï¼Œéšåè°ƒç”¨<code>malloc_consolidate()</code>å‡½æ•°æ¸…ç©ºfastbinä¸­çš„chunkï¼Œè¿™ä¸ªå‡½æ•°æˆ‘ä»¬ä¼šåœ¨åé¢è¯¦ç»†åˆ†æ</p>
<p>æ¥ä¸‹æ¥å°±æ˜¯é’ˆå¯¹ä¸åŒçš„æƒ…å†µå¯¹ä¸åŒçš„å˜é‡è®¾ç½®ä¸åŒçš„ï¼ˆåˆå§‹ï¼Ÿï¼‰å€¼ï¼Œå®Œæˆåè§£é”main_arenaå¹¶è¿”å›</p>
<p>è€Œå¯¹äºå­—ç¬¦ä¸²<code>&quot;MALLOC_CHECK_&quot;</code>ï¼Œåˆ™ä¼šå…ˆè°ƒç”¨<code>__libc_mallopt()</code>å‡½æ•°ï¼Œä¹‹åï¼Œæ£€æŸ¥å˜é‡<code>check_action</code>çš„å€¼ï¼Œè‹¥ä¸ä¸º0åˆ™ä¼šè°ƒç”¨<code>__malloc_check_init()</code>å‡½æ•°</p>
<blockquote>
<p>ç¬”è€…è®¤ä¸ºè¿™ä¸€æ­¥å…¶å®å¯ä»¥åˆå¹¶åˆ°å‰é¢çš„switchä¸­ï¼Œè€Œä¸éœ€è¦å•å¼€ä¸€ä¸ªif</p>
</blockquote>
<p>check_actionå®šä¹‰äºmalloc.cä¸­ï¼Œå¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> DEFAULT_CHECK_ACTION</span><br><span class="hljs-meta"># <span class="hljs-keyword">define</span> DEFAULT_CHECK_ACTION 3</span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br><span class="hljs-type">static</span> <span class="hljs-type">int</span> check_action = DEFAULT_CHECK_ACTION;<br></code></pre></td></tr></table></figure>

<p>å³è¯¥é™æ€å˜é‡çš„å€¼é»˜è®¤ä¸º3ï¼Œå³é»˜è®¤æƒ…å†µä¸‹å¯¹äºå­—ç¬¦ä¸²<code>&quot;MALLOC_CHECK&quot;</code>ï¼Œéƒ½ä¼šè°ƒç”¨<code>__malloc_check_init()</code>å‡½æ•°</p>
<p>è¯¥å‡½æ•°å®šä¹‰äºmalloc&#x2F;hook.cä¸­ï¼Œå¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">int</span> disallow_malloc_check;<br><span class="hljs-comment">/* Activate a standard set of debugging hooks. */</span><br><span class="hljs-type">void</span><br>__malloc_check_init (<span class="hljs-type">void</span>)<br>&#123;<br>  <span class="hljs-keyword">if</span> (disallow_malloc_check)<br>    &#123;<br>      disallow_malloc_check = <span class="hljs-number">0</span>;<br>      <span class="hljs-keyword">return</span>;<br>    &#125;<br>  using_malloc_checking = <span class="hljs-number">1</span>;<br>  __malloc_hook = malloc_check;<br>  __free_hook = free_check;<br>  __realloc_hook = realloc_check;<br>  __memalign_hook = memalign_check;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>è‹¥æ˜¯å˜é‡<code>disallow_malloc_check</code>ä¸ä¸º0åˆ™ä¼šèµ‹å€¼ä¸º0åç›´æ¥è¿”å›ï¼Œå¦åˆ™ä¼šå°†<code>using_malloc_check</code>èµ‹å€¼ä¸º1åå°†å››ä¸ªhooké’©å­åˆ†åˆ«è®¾ä¸ºå¯¹åº”çš„checkå‡½æ•°</p>
<h5 id="5ï¼‰æ£€æŸ¥é’©å­-malloc-initialized-hook"><a href="#5ï¼‰æ£€æŸ¥é’©å­-malloc-initialized-hook" class="headerlink" title="5ï¼‰æ£€æŸ¥é’©å­__malloc_initialized_hook"></a>5ï¼‰æ£€æŸ¥é’©å­__malloc_initialized_hook</h5><p>æœ€åä¾¿æ˜¯æ£€æŸ¥é’©å­<code>__malloc_initialize_hook</code>æ˜¯å¦ä¸ºNULLï¼Œè‹¥å¦ï¼Œåˆ™ä¼šè°ƒç”¨å…¶æ‰€æŒ‡å‘çš„å‡½æ•°</p>
<p>è¯¥hookå®šä¹‰äºmalloc.cä¸­ï¼Œå¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span> <span class="hljs-title function_">weak_variable</span> <span class="hljs-params">(*__malloc_initialize_hook)</span> <span class="hljs-params">(<span class="hljs-type">void</span>)</span> = <span class="hljs-literal">NULL</span>;<br></code></pre></td></tr></table></figure>

<p>å³åˆå§‹æƒ…å†µä¸‹è¯¥é’©å­åº”å½“ä¸ºNULL</p>
<p>æœ€åå°†<code>__malloc_initialized</code>çš„å€¼è®¾ä¸º1åï¼Œè¿™ä¸ªå‡½æ•°å°±ç»“æŸäº†</p>
<h3 id="2-è·å–ä¸€ä¸ªarena"><a href="#2-è·å–ä¸€ä¸ªarena" class="headerlink" title="2.è·å–ä¸€ä¸ªarena"></a>2.è·å–ä¸€ä¸ªarena</h3><p>æ¥ä¸‹æ¥ä¼šé€šè¿‡å®<code>arena_get()</code>å°è¯•è·å–ä¸€ä¸ªarenaï¼Œè¿™ä¸ªå®çš„å…·ä½“å®ç°åœ¨å‰é¢å·²ç»è¯¦ç»†å™è¿°è¿‡äº†ï¼Œè¿™é‡Œå°±ä¸å†èµ˜å™äº†</p>
<p>ç”±äºåœ¨ptmalloc_init()å‡½æ•°ä¸­å·²ç»å°†thread_arenaè®¾ä¸ºmain_arenaäº†ï¼Œæ‰€ä»¥ç¬¬ä¸€æ¬¡è°ƒç”¨mallocæ—¶ä¾¿ä¼š<strong>ç›´æ¥é”ä¸Šmain_arenaåä½¿ç”¨</strong></p>
<p>å¯¹äºå…¶ä»–åç»­è¿›è¡Œè°ƒç”¨çš„çº¿ç¨‹åˆ™ä¼š<strong>å…ˆæ£€æŸ¥free_listæ˜¯å¦æœ‰å¯ç”¨ç©ºé—²arenaï¼Œè‹¥æ²¡æœ‰å¯ç”¨ç©ºé—²arenaåˆ™å°è¯•åœ¨Memory Mapping Segmentæ–°å»ºä¸€ä¸ªarenaï¼Œè‹¥å¤±è´¥åˆ™åªèƒ½ä¸å…¶ä»–çº¿ç¨‹å…±äº«arena</strong></p>
<h3 id="â­3-è°ƒç”¨-int-malloc-å‡½æ•°åˆ†é…å†…å­˜"><a href="#â­3-è°ƒç”¨-int-malloc-å‡½æ•°åˆ†é…å†…å­˜" class="headerlink" title="â­3.è°ƒç”¨_int_malloc()å‡½æ•°åˆ†é…å†…å­˜"></a>â­3.è°ƒç”¨_int_malloc()å‡½æ•°åˆ†é…å†…å­˜</h3><p>æ¥ä¸‹æ¥__libc_malloc()å‡½æ•°ä¼šè°ƒç”¨<code>_int_malloc()</code>å‡½æ•°<strong>çœŸæ­£å¼€å§‹è¿›è¡Œå†…å­˜åˆ†é…</strong>ï¼Œä¹Ÿå°±æ˜¯è¯´å†…å­˜åˆ†é…çš„<strong>æ ¸å¿ƒå‡½æ•°å…¶å®æ˜¯</strong><code>_int_malloc()</code>å‡½æ•°ï¼Œ__libc_malloc()å‡½æ•°å…¶å®æœ¬èº«è¿˜æ˜¯å¯¹è¯¥å‡½æ•°çš„ä¸€å±‚å°è£…ï¼Œå¹¶é™„åŠ ä¸Šä¸€äº›å †ç®¡ç†å™¨ç›¸å…³çš„æ“ä½œï¼Œè¯¥å‡½æ•°æˆ‘ä»¬ä¼šåœ¨åé¢è¯¦ç»†è¿›è¡Œè§£æ</p>
<h3 id="4-æ£€æµ‹ç»“æœï¼Œè‹¥ä¸ºNULLåˆ™é‡æ–°è·å¾—arenaå¹¶é‡æ–°è°ƒç”¨-int-malloc-åˆ†é…å†…å­˜"><a href="#4-æ£€æµ‹ç»“æœï¼Œè‹¥ä¸ºNULLåˆ™é‡æ–°è·å¾—arenaå¹¶é‡æ–°è°ƒç”¨-int-malloc-åˆ†é…å†…å­˜" class="headerlink" title="4.æ£€æµ‹ç»“æœï¼Œè‹¥ä¸ºNULLåˆ™é‡æ–°è·å¾—arenaå¹¶é‡æ–°è°ƒç”¨_int_malloc()åˆ†é…å†…å­˜"></a>4.æ£€æµ‹ç»“æœï¼Œè‹¥ä¸ºNULLåˆ™é‡æ–°è·å¾—arenaå¹¶é‡æ–°è°ƒç”¨_int_malloc()åˆ†é…å†…å­˜</h3><p>è‹¥æ˜¯<code>_int_malloc()</code>å‡½æ•°æœªèƒ½å¤ŸæˆåŠŸè·å–åˆ°ä¸€ä¸ªé€‚åˆçš„å †å—ï¼Œåˆ™ä¼šå‘ä¸Šå±‚å‡½æ•°è¿”å›NULLï¼Œå› æ­¤åœ¨è¿™é‡Œä¼šå¯¹å…¶è¿”å›çš„ç»“æœè¿›è¡Œæ£€æµ‹</p>
<p>ç”±äºptmallocè€ƒè™‘åˆ°å¯èƒ½æ˜¯arenaä¸è¶³ä»¥æä¾›æ‰€éœ€ç©ºé—´çš„åŸå› ï¼Œæ•…åœ¨è¿™é‡Œé¦–å…ˆä¼šè°ƒç”¨<code>arena_gert_retry()</code>å‡½æ•°ï¼Œé‡æ–°å°è¯•è·å¾—ä¸€ä¸ªæ–°çš„arena</p>
<h4 id="â‘ arena-get-retry-ï¼šé‡æ–°è·å¾—ä¸€ä¸ªarena"><a href="#â‘ arena-get-retry-ï¼šé‡æ–°è·å¾—ä¸€ä¸ªarena" class="headerlink" title="â‘ arena_get_retry()ï¼šé‡æ–°è·å¾—ä¸€ä¸ªarena"></a>â‘ arena_get_retry()ï¼šé‡æ–°è·å¾—ä¸€ä¸ªarena</h4><p>è¯¥å‡½æ•°å®šä¹‰äºarena.cä¸­ï¼Œå¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/* If we don&#x27;t have the main arena, then maybe the failure is due to running</span><br><span class="hljs-comment">   out of mmapped areas, so we can try allocating on the main arena.</span><br><span class="hljs-comment">   Otherwise, it is likely that sbrk() has failed and there is still a chance</span><br><span class="hljs-comment">   to mmap(), so try one of the other arenas.  */</span><br><span class="hljs-type">static</span> mstate<br><span class="hljs-title function_">arena_get_retry</span> <span class="hljs-params">(mstate ar_ptr, <span class="hljs-type">size_t</span> bytes)</span><br>&#123;<br>  LIBC_PROBE (memory_arena_retry, <span class="hljs-number">2</span>, bytes, ar_ptr);<br>  <span class="hljs-keyword">if</span> (ar_ptr != &amp;main_arena)<br>    &#123;<br>      (<span class="hljs-type">void</span>) mutex_unlock (&amp;ar_ptr-&gt;mutex);<br>      <span class="hljs-comment">/* Don&#x27;t touch the main arena if it is corrupt.  */</span><br>      <span class="hljs-keyword">if</span> (arena_is_corrupt (&amp;main_arena))<br>	<span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;<br><br>      ar_ptr = &amp;main_arena;<br>      (<span class="hljs-type">void</span>) mutex_lock (&amp;ar_ptr-&gt;mutex);<br>    &#125;<br>  <span class="hljs-keyword">else</span><br>    &#123;<br>      (<span class="hljs-type">void</span>) mutex_unlock (&amp;ar_ptr-&gt;mutex);<br>      ar_ptr = arena_get2 (bytes, ar_ptr);<br>    &#125;<br><br>  <span class="hljs-keyword">return</span> ar_ptr;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>æ³¨é‡Šä¸­è¯´æ˜æœ‰ä¸¤ç§å¯èƒ½çš„æƒ…å†µï¼š</p>
<ul>
<li>è‹¥æ˜¯æˆ‘ä»¬ä½¿ç”¨çš„ä¸æ˜¯main_arenaï¼Œåˆ™è¯´æ˜mmapedåŒºåŸŸï¼ˆMemory Mapping Segmentï¼‰å·²ç»è€—å°½äº†ï¼Œå› æ­¤æˆ‘ä»¬å°è¯•å›åˆ°main_arenaä¸Šè¿›è¡Œå†…å­˜åˆ†é…ï¼ˆby (s)brkï¼‰</li>
<li>è‹¥æ˜¯æˆ‘ä»¬ä½¿ç”¨çš„å°±æ˜¯main_arenaï¼Œåˆ™è¯´æ˜(s)brkç³»ç»Ÿè°ƒç”¨å¤±è´¥ï¼ˆå †åŒºå¯ç”¨ç©ºé—´è€—å°½ï¼‰ï¼Œä½†æˆ‘ä»¬ä»ç„¶æœ‰å¯èƒ½åœ¨mmapedåŒºåŸŸæœ‰å¯ç”¨çš„ç©ºé—´ï¼Œæ­¤æ—¶ptmallocé€‰æ‹©å°è¯•å…¶ä»–çš„arena</li>
</ul>
<p>å› æ­¤å…¶æµç¨‹åˆ†æ”¯å¦‚ä¸‹ï¼š</p>
<h5 id="1ï¼‰åŸarenaä¸ä¸ºmain-arenaï¼Œåˆ™è§£é”åè·å–main-arena"><a href="#1ï¼‰åŸarenaä¸ä¸ºmain-arenaï¼Œåˆ™è§£é”åè·å–main-arena" class="headerlink" title="1ï¼‰åŸarenaä¸ä¸ºmain_arenaï¼Œåˆ™è§£é”åè·å–main_arena"></a>1ï¼‰åŸarenaä¸ä¸ºmain_arenaï¼Œåˆ™è§£é”åè·å–main_arena</h5><p>é¦–å…ˆä¼šå°†åŸå…ˆä½¿ç”¨çš„arenaè§£é”ï¼Œéšåæ£€æŸ¥main_arenaæ˜¯å¦è¢«ç ´åï¼Œ<strong>è‹¥main_arenaå·²è¢«ç ´ååˆ™ç›´æ¥è¿”å›NULLï¼Œå¦åˆ™é”ä¸Šmain_arena</strong></p>
<h5 id="2ï¼‰åŸarenaä¸ºmain-arenaï¼Œè§£é”åè°ƒç”¨arena-get2-è·å–å…¶ä»–arena"><a href="#2ï¼‰åŸarenaä¸ºmain-arenaï¼Œè§£é”åè°ƒç”¨arena-get2-è·å–å…¶ä»–arena" class="headerlink" title="2ï¼‰åŸarenaä¸ºmain_arenaï¼Œè§£é”åè°ƒç”¨arena_get2()è·å–å…¶ä»–arena"></a>2ï¼‰åŸarenaä¸ºmain_arenaï¼Œè§£é”åè°ƒç”¨arena_get2()è·å–å…¶ä»–arena</h5><p>è‹¥åŸarenaå°±æ˜¯main_arenaï¼Œåˆ™æ­¤æ—¶ä¼šå°è¯•è°ƒç”¨arena_get2()å‡½æ•°è·å–ä¸€ä¸ªarenaï¼Œåœ¨è¿™é‡Œmain_arenaè¢«ä½œä¸ºavoid_arenaå‚æ•°ä¼ å…¥å› è€Œä¸ä¼šåˆé‡æ–°è·å–åˆ°main_arena</p>
<p>æœ€åå°†è·å–åˆ°çš„arenaï¼ˆ<strong>å¯èƒ½ä¸ºNULL</strong>ï¼‰è¿”å›ï¼Œè¯¥å‡½æ•°çš„æµç¨‹ä¾¿ç»“æŸäº†</p>
<h4 id="â‘¡é‡æ–°è°ƒç”¨-int-malloc-åˆ†é…å†…å­˜"><a href="#â‘¡é‡æ–°è°ƒç”¨-int-malloc-åˆ†é…å†…å­˜" class="headerlink" title="â‘¡é‡æ–°è°ƒç”¨_int_malloc()åˆ†é…å†…å­˜"></a>â‘¡é‡æ–°è°ƒç”¨_int_malloc()åˆ†é…å†…å­˜</h4><p>å”¯ä¸€éœ€è¦æ³¨æ„çš„ä¸€ç‚¹æˆ–è®¸å°±æ˜¯<code>_int_malloc()</code>å‡½æ•°è¿”å›çš„å†…å­˜æ˜¯memè€Œä¸æ˜¯chunkï¼Œå› æ­¤å¯ä»¥ç›´æ¥è¿”å›ç»™ç”¨æˆ·è¿›è¡Œä½¿ç”¨</p>
<h3 id="5-æ£€æµ‹æ— è¯¯åè¿”å›å†…å­˜å—"><a href="#5-æ£€æµ‹æ— è¯¯åè¿”å›å†…å­˜å—" class="headerlink" title="5.æ£€æµ‹æ— è¯¯åè¿”å›å†…å­˜å—"></a>5.æ£€æµ‹æ— è¯¯åè¿”å›å†…å­˜å—</h3><p>å¤§æ¦‚æ˜¯ä¼šæ£€æµ‹å¦‚ä¸‹ä¸‰ä¸ªç‚¹ï¼š</p>
<ul>
<li>æ‰€è·å¾—çš„å †å—<strong>æ˜¯å¦ä¸ºNULL</strong></li>
<li>è¯¥å †å—<strong>æ˜¯å¦æ˜¯é€šè¿‡mmapè·å¾—çš„</strong></li>
<li>ï¼ˆè‹¥è¯¥å †å—æ˜¯é€šè¿‡mmapè·å¾—çš„ï¼‰è¯¥å †å—<strong>æ‰€å±çš„arenaæ˜¯å¦ä¸ºæˆ‘ä»¬æ­¤å‰æ‰€ä½¿ç”¨çš„arena</strong></li>
</ul>
<p>åœ¨æœ€åä¸€æ­¥ä½¿ç”¨äº†<code>arena_for_chunk()</code>å®ï¼Œè¯¥å®å·²ç»åœ¨å‰é¢è§£æè¿‡äº†ï¼Œè¿™é‡Œä¾¿ä¸å†èµ˜å™ï¼Œç®€å•æ¥è¯´å°±æ˜¯<strong>è·å–ä¸€ä¸ªchunkæ‰€å±çš„arena</strong></p>
<p>è‹¥æ˜¯ä¸‰ä¸ªéƒ½æ²¡é€šè¿‡åˆ™è¯´æ˜å†…å­˜åˆ†é…è¿‡ç¨‹ä¸­å¯èƒ½å‡ºäº†é—®é¢˜ï¼Œåˆ™ä¼šç›´æ¥è§¦å‘assertï¼Œéšåabort()ç»ˆæ­¢è¿›ç¨‹ï¼Œcore dump</p>
<p>ä»»ä¸€æ£€æµ‹é€šè¿‡ï¼Œåˆ™å°†è·å–åˆ°çš„å †å—è¿”å›ç»™ä¸Šå±‚è°ƒç”¨çš„ç”¨æˆ·ï¼Œæ•´ä¸ªmallocçš„è¿›ç¨‹å°±ç»“æŸäº†</p>
<h2 id="libc-hidden-defï¼šå‡½æ•°å®šä¹‰éšè—"><a href="#libc-hidden-defï¼šå‡½æ•°å®šä¹‰éšè—" class="headerlink" title="libc_hidden_defï¼šå‡½æ•°å®šä¹‰éšè—"></a>libc_hidden_defï¼šå‡½æ•°å®šä¹‰éšè—</h2><p>ä¸libc_hidden_protoä¸€æ ·å®šä¹‰äºlibc-symbols.hä¸‹ï¼Œå¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">if</span> IS_IN (libc)</span><br><span class="hljs-meta"># <span class="hljs-keyword">define</span> libc_hidden_proto(name, attrs...) hidden_proto (name, ##attrs)</span><br><span class="hljs-meta"># <span class="hljs-keyword">define</span> libc_hidden_tls_proto(name, attrs...) hidden_tls_proto (name, ##attrs)</span><br><span class="hljs-meta"># <span class="hljs-keyword">define</span> libc_hidden_def(name) hidden_def (name)</span><br>...<br><span class="hljs-meta">#<span class="hljs-keyword">else</span></span><br><span class="hljs-meta"># <span class="hljs-keyword">define</span> libc_hidden_proto(name, attrs...)</span><br><span class="hljs-meta"># <span class="hljs-keyword">define</span> libc_hidden_tls_proto(name, attrs...)</span><br><span class="hljs-meta"># <span class="hljs-keyword">define</span> libc_hidden_def(name)</span><br>...<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br></code></pre></td></tr></table></figure>

<p>åŒæ ·æ˜¯å¥—å¨ƒå®šä¹‰ï¼Œè½¬åˆ°hidden_defï¼Œå¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">if</span> defined SHARED &amp;&amp; !defined NO_HIDDEN</span><br><span class="hljs-meta"># <span class="hljs-keyword">ifndef</span> __ASSEMBLER__</span><br>...<br><span class="hljs-meta">#  <span class="hljs-keyword">define</span> hidden_def(name)		__hidden_ver1(__GI_##name, name, name);</span><br>...<br><br><span class="hljs-meta"># <span class="hljs-keyword">else</span></span><br><span class="hljs-comment">/* For assembly, we need to do the opposite of what we do in C:</span><br><span class="hljs-comment">   in assembly gcc __REDIRECT stuff is not in place, so functions</span><br><span class="hljs-comment">   are defined by its normal name and we need to create the</span><br><span class="hljs-comment">   __GI_* alias to it, in C __REDIRECT causes the function definition</span><br><span class="hljs-comment">   to use __GI_* name and we need to add alias to the real name.</span><br><span class="hljs-comment">   There is no reason to use hidden_weak over hidden_def in assembly,</span><br><span class="hljs-comment">   but we provide it for consistency with the C usage.</span><br><span class="hljs-comment">   hidden_proto doesn&#x27;t make sense for assembly but the equivalent</span><br><span class="hljs-comment">   is to call via the HIDDEN_JUMPTARGET macro instead of JUMPTARGET.  */</span><br><span class="hljs-meta">#  <span class="hljs-keyword">define</span> hidden_def(name)	strong_alias (name, __GI_##name)</span><br>...<br><span class="hljs-meta">#<span class="hljs-keyword">else</span></span><br><span class="hljs-meta"># <span class="hljs-keyword">ifndef</span> __ASSEMBLER__</span><br><span class="hljs-meta">#  <span class="hljs-keyword">define</span> hidden_proto(name, attrs...)</span><br><span class="hljs-meta">#  <span class="hljs-keyword">define</span> hidden_tls_proto(name, attrs...)</span><br><span class="hljs-meta"># <span class="hljs-keyword">else</span></span><br><span class="hljs-meta">#  <span class="hljs-keyword">define</span> HIDDEN_JUMPTARGET(name) JUMPTARGET(name)</span><br><span class="hljs-meta"># <span class="hljs-keyword">endif</span> <span class="hljs-comment">/* Not  __ASSEMBLER__ */</span></span><br><span class="hljs-meta"># <span class="hljs-keyword">define</span> hidden_weak(name)</span><br><span class="hljs-meta"># <span class="hljs-keyword">define</span> hidden_def(name)</span><br>...<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br></code></pre></td></tr></table></figure>

<p>ä¸éš¾æƒ³åˆ°libc_hidden_def()å’Œæ­¤å‰çš„libc_hidden_protoæ˜¯ç›¸ç±»ä¼¼çš„ï¼Œåªä¸è¿‡è¯¥å®éšè—çš„æ˜¯å‡½æ•°å®šä¹‰ï¼Œè¿™é‡Œä¾¿ä¸å†å±•å¼€è¯´æ˜</p>
<h1 id="0x02-malloc-consolidate"><a href="#0x02-malloc-consolidate" class="headerlink" title="0x02.malloc_consolidate"></a>0x02.malloc_consolidate</h1><p>ç”±äºè¿™ä¸ªå‡½æ•°æ˜¯ptmallocä¸­ååˆ†é‡è¦çš„ä¸€ä¸ªå‡½æ•°ï¼ŒåŒæ—¶ä¹Ÿæ˜¯å„ç§pwné¢˜ä¸­ç»å¸¸ç”¨åˆ°çš„ä¸€ä¸ªå‡½æ•°ï¼Œæ•…æˆ‘ä»¬å…ˆæ¥è§£æå…¶ä»£ç </p>
<p>è¯¥å‡½æ•°å®šä¹‰äºmalloc.cä¸­ï¼Œç”¨ä»¥<strong>æ¸…ç©ºfastbinsä¸­chunkã€åˆå¹¶ç›¸é‚»ç©ºé—²chunk</strong>ï¼Œå¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/*</span><br><span class="hljs-comment">  ------------------------- malloc_consolidate -------------------------</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">  malloc_consolidate is a specialized version of free() that tears</span><br><span class="hljs-comment">  down chunks held in fastbins.  Free itself cannot be used for this</span><br><span class="hljs-comment">  purpose since, among other things, it might place chunks back onto</span><br><span class="hljs-comment">  fastbins.  So, instead, we need to use a minor variant of the same</span><br><span class="hljs-comment">  code.</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">  Also, because this routine needs to be called the first time through</span><br><span class="hljs-comment">  malloc anyway, it turns out to be the perfect place to trigger</span><br><span class="hljs-comment">  initialization code.</span><br><span class="hljs-comment">*/</span><br><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">malloc_consolidate</span><span class="hljs-params">(mstate av)</span><br>&#123;<br>  mfastbinptr*    fb;                 <span class="hljs-comment">/* current fastbin being consolidated */</span><br>  mfastbinptr*    maxfb;              <span class="hljs-comment">/* last fastbin (for loop control) */</span><br>  mchunkptr       p;                  <span class="hljs-comment">/* current chunk being consolidated */</span><br>  mchunkptr       nextp;              <span class="hljs-comment">/* next chunk to consolidate */</span><br>  mchunkptr       unsorted_bin;       <span class="hljs-comment">/* bin header */</span><br>  mchunkptr       first_unsorted;     <span class="hljs-comment">/* chunk to link to */</span><br><br>  <span class="hljs-comment">/* These have same use as in free() */</span><br>  mchunkptr       nextchunk;<br>  INTERNAL_SIZE_T size;<br>  INTERNAL_SIZE_T nextsize;<br>  INTERNAL_SIZE_T prevsize;<br>  <span class="hljs-type">int</span>             nextinuse;<br>  mchunkptr       bck;<br>  mchunkptr       fwd;<br><br>  <span class="hljs-comment">/*</span><br><span class="hljs-comment">    If max_fast is 0, we know that av hasn&#x27;t</span><br><span class="hljs-comment">    yet been initialized, in which case do so below</span><br><span class="hljs-comment">  */</span><br><br>  <span class="hljs-keyword">if</span> (get_max_fast () != <span class="hljs-number">0</span>) &#123;<br>    clear_fastchunks(av);<br><br>    unsorted_bin = unsorted_chunks(av);<br><br>    <span class="hljs-comment">/*</span><br><span class="hljs-comment">      Remove each chunk from fast bin and consolidate it, placing it</span><br><span class="hljs-comment">      then in unsorted bin. Among other reasons for doing this,</span><br><span class="hljs-comment">      placing in unsorted bin avoids needing to calculate actual bins</span><br><span class="hljs-comment">      until malloc is sure that chunks aren&#x27;t immediately going to be</span><br><span class="hljs-comment">      reused anyway.</span><br><span class="hljs-comment">    */</span><br><br>    maxfb = &amp;fastbin (av, NFASTBINS - <span class="hljs-number">1</span>);<br>    fb = &amp;fastbin (av, <span class="hljs-number">0</span>);<br>    <span class="hljs-keyword">do</span> &#123;<br>      p = atomic_exchange_acq (fb, <span class="hljs-number">0</span>);<br>      <span class="hljs-keyword">if</span> (p != <span class="hljs-number">0</span>) &#123;<br>	<span class="hljs-keyword">do</span> &#123;<br>	  check_inuse_chunk(av, p);<br>	  nextp = p-&gt;fd;<br><br>	  <span class="hljs-comment">/* Slightly streamlined version of consolidation code in free() */</span><br>	  size = p-&gt;size &amp; ~(PREV_INUSE|NON_MAIN_ARENA);<br>	  nextchunk = chunk_at_offset(p, size);<br>	  nextsize = chunksize(nextchunk);<br><br>	  <span class="hljs-keyword">if</span> (!prev_inuse(p)) &#123;<br>	    prevsize = p-&gt;prev_size;<br>	    size += prevsize;<br>	    p = chunk_at_offset(p, -((<span class="hljs-type">long</span>) prevsize));<br>	    unlink(av, p, bck, fwd);<br>	  &#125;<br><br>	  <span class="hljs-keyword">if</span> (nextchunk != av-&gt;top) &#123;<br>	    nextinuse = inuse_bit_at_offset(nextchunk, nextsize);<br><br>	    <span class="hljs-keyword">if</span> (!nextinuse) &#123;<br>	      size += nextsize;<br>	      unlink(av, nextchunk, bck, fwd);<br>	    &#125; <span class="hljs-keyword">else</span><br>	      clear_inuse_bit_at_offset(nextchunk, <span class="hljs-number">0</span>);<br><br>	    first_unsorted = unsorted_bin-&gt;fd;<br>	    unsorted_bin-&gt;fd = p;<br>	    first_unsorted-&gt;bk = p;<br><br>	    <span class="hljs-keyword">if</span> (!in_smallbin_range (size)) &#123;<br>	      p-&gt;fd_nextsize = <span class="hljs-literal">NULL</span>;<br>	      p-&gt;bk_nextsize = <span class="hljs-literal">NULL</span>;<br>	    &#125;<br><br>	    set_head(p, size | PREV_INUSE);<br>	    p-&gt;bk = unsorted_bin;<br>	    p-&gt;fd = first_unsorted;<br>	    set_foot(p, size);<br>	  &#125;<br><br>	  <span class="hljs-keyword">else</span> &#123;<br>	    size += nextsize;<br>	    set_head(p, size | PREV_INUSE);<br>	    av-&gt;top = p;<br>	  &#125;<br><br>	&#125; <span class="hljs-keyword">while</span> ( (p = nextp) != <span class="hljs-number">0</span>);<br><br>      &#125;<br>    &#125; <span class="hljs-keyword">while</span> (fb++ != maxfb);<br>  &#125;<br>  <span class="hljs-keyword">else</span> &#123;<br>    malloc_init_state(av);<br>    check_malloc_state(av);<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>é¦–å…ˆä¼šå…ˆæ£€æŸ¥<strong>global_max_fast</strong>ï¼š</p>
<ul>
<li><strong>è‹¥ä¸ä¸º0åˆ™ä¼šè®¾ç½®è¯¥arenaçš„FASTCHUNKS_BITæ ‡å¿—ä½ï¼Œæ„å‘³ç€æ¥ä¸‹æ¥è¯¥å‡½æ•°ä¼šæ¸…ç©ºè¯¥arenaçš„fastbinä¸­çš„chunks</strong></li>
<li><strong>è‹¥ä¸º0åˆ™æ„å‘³ç€è¯¥çº¿ç¨‹çš„arenaæœªè¿›è¡Œåˆå§‹åŒ–</strong>ï¼Œæ­¤æ—¶ä¾¿ä¼š<strong>è°ƒç”¨malloc_init_state</strong>()<strong>å‡½æ•°åˆå§‹åŒ–è¯¥arenaï¼Œ</strong>éšåä½¿ç”¨check_malloc_state()å®è¿›è¡Œæ£€æŸ¥å<strong>è¯¥å‡½æ•°ä¾¿ç»“æŸäº†</strong>ï¼Œåœ¨éDEBUGæ¨¡å¼ä¸‹ï¼ˆæœªå®šä¹‰å®MALLOC_DEBUGï¼‰è¯¥å®ä¸ºç©º</li>
</ul>
<p>æ¥åœ¨å·²ç»åˆå§‹åŒ–çš„æƒ…å†µä¸‹æ¥ä¸‹æ¥ä¼š<strong>åˆ†åˆ«è·å–æŒ‡å‘arenaä¸­fastbinsYæ•°ç»„é¦–å°¾å…ƒç´ çš„æŒ‡é’ˆï¼Œç”¨ä»¥å¯¹fastbinsYæ•°ç»„è¿›è¡Œéå†ï¼Œ</strong>è¿™ä¸ªéå†ç”±ä¸¤å±‚å¾ªç¯åµŒå¥—è€Œæˆï¼š</p>
<h2 id="å¤–å±‚å¾ªç¯ï¼šéå†fastbinsYæ•°ç»„å…ƒç´ "><a href="#å¤–å±‚å¾ªç¯ï¼šéå†fastbinsYæ•°ç»„å…ƒç´ " class="headerlink" title="å¤–å±‚å¾ªç¯ï¼šéå†fastbinsYæ•°ç»„å…ƒç´ "></a>å¤–å±‚å¾ªç¯ï¼šéå†fastbinsYæ•°ç»„å…ƒç´ </h2><p>æˆ‘ä»¬å•ç‹¬å°†è¿™ä¸ªå¾ªç¯åµŒå¥—æ‹¿å‡ºæ¥çœ‹ä¸ºå¦‚ä¸‹å½¢å¼ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">do</span> &#123;<br>	p = atomic_exchange_acq (fb, <span class="hljs-number">0</span>);<br>	<span class="hljs-keyword">if</span> (p != <span class="hljs-number">0</span>) <br>    &#123;<br>		<span class="hljs-keyword">do</span> &#123;<br>	  		<span class="hljs-comment">// inner loop there</span><br>		&#125; <span class="hljs-keyword">while</span> ( (p = nextp) != <span class="hljs-number">0</span>);<br>    &#125;<br>&#125; <span class="hljs-keyword">while</span> (fb++ != maxfb);<br></code></pre></td></tr></table></figure>

<p>æˆ‘ä»¬ä¸éš¾çœ‹å‡ºå¤–å±‚å¾ªç¯çš„ä½œç”¨ä¾¿æ˜¯<strong>é€ä¸ªå–å‡ºfastbinsYæ•°ç»„ä¸­å…ƒç´ ï¼Œéšåäº¤ç”±å†…å±‚å¾ªç¯è¿›è¡Œä¸‹ä¸€æ­¥çš„å¤„ç†</strong></p>
<p>åœ¨è¿™é‡Œä½¿ç”¨äº†ä¸€ä¸ªå®<code>atomic_exchange_acq()</code>ï¼Œç”¨é€”æ˜¯<strong>é€šè¿‡åŸå­è¯»æ“ä½œè®¾ç½®æ–°å€¼ï¼Œè¿”å›æ—§å€¼</strong>ï¼Œå‰é¢å·²è§£æè¿‡ç±»ä¼¼å®ï¼Œè¿™é‡Œä¾¿ä¸å†èµ˜å™</p>
<p>è™½ç„¶å‰æ–‡æˆ‘ä»¬æœ‰è®²åˆ°fastbinsYæ•°ç»„çš„ä¸‹æ ‡åŒ…æ‹¬7åŠå¾€åéƒ½æ˜¯ç”¨ä¸åˆ°çš„ï¼Œä½†æ˜¯åœ¨è¿™é‡Œä»ä¼šå°è¯•å¯¹é½è¿›è¡Œéå†</p>
<h3 id="å†…å±‚å¾ªç¯ï¼šéå†fastbin-é“¾è¡¨ã€åˆå¹¶ç©ºé—²chunk"><a href="#å†…å±‚å¾ªç¯ï¼šéå†fastbin-é“¾è¡¨ã€åˆå¹¶ç©ºé—²chunk" class="headerlink" title="å†…å±‚å¾ªç¯ï¼šéå†fastbin é“¾è¡¨ã€åˆå¹¶ç©ºé—²chunk"></a>å†…å±‚å¾ªç¯ï¼šéå†fastbin é“¾è¡¨ã€åˆå¹¶ç©ºé—²chunk</h3><p>åœ¨å†…å±‚å¾ªç¯ä¸­ä¼šä»æˆ‘ä»¬ä»å¤–å±‚å¾ªç¯ä¸­æ‰€å–å¾—çš„fastbinsé“¾è¡¨çš„å¤´ç»“ç‚¹å¼€å§‹è¿›è¡Œéå†ï¼Œå¹¶è¿›è¡Œç©ºé—²chunkçš„åˆå¹¶ä»¥å‡å°‘å†…å­˜ç¢ç‰‡</p>
<p>è‹¥<strong>è·å–åˆ°çš„å¤´ç»“ç‚¹ä¸ºNULLåˆ™ä¼šç›´æ¥è·³è¿‡è¯¥å±‚å¾ªç¯</strong>ï¼Œå¦åˆ™è¿›å…¥ä¸‹é¢çš„æ­¥éª¤</p>
<p>åœ¨è¿™é‡Œæœ‰ä¸€ä¸ªå®<code>check_inuse_chunk()</code>ï¼Œè¯¥å®åœ¨éDEBUGæ¨¡å¼ä¸‹ï¼ˆå®MALLOC_DEBUG undefinedï¼‰ä¹Ÿä¸ºç©º</p>
<p>é¦–å…ˆä¼šè·å–è¯¥èŠ‚ç‚¹chunkçš„sizeï¼Œåœ¨è¿™é‡Œ<strong>è·å–åˆ°çš„sizeæ¸…é™¤äº†PREV_INUSEæ ‡å¿—ä½ä¸NON_MAIN_ARENAæ ‡å¿—ä½</strong>ï¼Œè¿™æ˜¯ä¸ºäº†åœ¨åé¢çš„åˆå¹¶è¿‡ç¨‹ä¸­èƒ½å¤Ÿå‡†ç¡®åœ°è·å–åˆ°é«˜åœ°å€ç›¸é‚»chunkçš„ä½ç½®</p>
<blockquote>
<p>è¯´èµ·æ¥ç½‘ä¸Šå¾ˆå¤šå…³äºmalloc_consolidate()çš„åšå®¢éƒ½æœ‰è®²åˆ°æ‰€è°“ã€Œå‰å‘åˆå¹¶ã€å’Œã€Œåå‘åˆå¹¶ã€ï¼Œä½†æ˜¯å“ªè¾¹æ˜¯å‰å“ªè¾¹æ˜¯åç¬”è€…æš‚ä¸”è’™åœ¨å¤é‡Œï¼ˆæ³¨é‡Šé‡Œç¬”è€…ä¹Ÿæ²¡çœ‹åˆ°forward&#x2F;backwardâ€¦</p>
<p>é‚£ä¹ˆä¸‹æ–‡æˆ‘ä»¬æŒ‰ç…§å¯¹å…¶ç§°å‘¼çš„æƒ¯ä¾‹åšå‡ºå¦‚ä¸‹çº¦å®šï¼šå°†<strong>å‘é«˜åœ°å€çš„åˆå¹¶ç§°ä¸ºã€Œå‰å‘åˆå¹¶ã€ï¼Œå‘ä½åœ°å€çš„åˆå¹¶ç§°ä¸ºã€Œåå‘åˆå¹¶ã€</strong></p>
</blockquote>
<h4 id="â‘ åå‘åˆå¹¶ï¼šä½¿ç”¨unlinkå–å‡ºç›¸é‚»ä½åœ°å€chunkï¼ˆè‹¥å·²freeï¼‰"><a href="#â‘ åå‘åˆå¹¶ï¼šä½¿ç”¨unlinkå–å‡ºç›¸é‚»ä½åœ°å€chunkï¼ˆè‹¥å·²freeï¼‰" class="headerlink" title="â‘ åå‘åˆå¹¶ï¼šä½¿ç”¨unlinkå–å‡ºç›¸é‚»ä½åœ°å€chunkï¼ˆè‹¥å·²freeï¼‰"></a>â‘ åå‘åˆå¹¶ï¼šä½¿ç”¨unlinkå–å‡ºç›¸é‚»ä½åœ°å€chunkï¼ˆè‹¥å·²freeï¼‰</h4><p>é¦–å…ˆä¼š<strong>æ£€æŸ¥è¯¥chunkçš„PREV_IN_USEæ ‡å¿—ä½ï¼Œè‹¥ä¸ä¸º1åˆ™è¯´æ˜ä½åœ°å€ç›¸é‚»chunkå¿…ä¸ºå­˜æ”¾åœ¨binsæ•°ç»„ä¸­çš„free chunk</strong>ï¼Œè¿™æ˜¯å› ä¸º<strong>å½“ä¸€ä¸ªchunkè¢«ä½¿ç”¨ä¸­&#x2F;è¢«æ”¾å…¥fastbinä¸­ï¼Œå…¶ç›¸é‚»é«˜åœ°å€çš„chunkçš„PREV_INUSEæ ‡å¿—ä½éƒ½ä¸ä¼šè¢«æ¸…é™¤ï¼Œåªæœ‰æ”¾å…¥binsä¸­æ‰ä¼šæ¸…é™¤è¯¥æ ‡å¿—ä½</strong>ï¼Œç›¸å…³æœºåˆ¶æˆ‘ä»¬ä¼šåœ¨åæ–‡çš„_int_free()å‡½æ•°ä¸­è¯¦ç»†è¿›è¡Œåˆ†æ</p>
<p>è¿™ç§æƒ…å†µä¸‹ä¼š<strong>åœ¨å‰é¢çš„sizeå˜é‡ä¸­åŠ ä¸ŠåŸchunkçš„prevsizeåŸŸçš„å€¼ï¼Œå°†chunkæŒ‡é’ˆç§»åŠ¨è‡³æŒ‡å‘è¯¥ç©ºé—²chunkï¼Œå¦‚ä¸‹å›¾æ‰€ç¤º</strong></p>
<p><img src="https://i.loli.net/2021/01/23/GqBQHD12NtAESkT.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p><strong>æœ€åä½¿ç”¨unlinkå®ä»binsä¸­å–å‡ºè¯¥chunk</strong>ï¼Œåå‘åˆå¹¶çš„è¿‡ç¨‹å°±å®Œæˆäº†</p>
<p><img src="https://i.loli.net/2021/01/23/pKVSclCIunvofOm.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p>éœ€è¦æ³¨æ„çš„æ˜¯åœ¨è¿™é‡Œæ˜¯<strong>ä½¿ç”¨åŸchunkçš„prevsizeåŸŸè®¡ç®—è¯¥ç©ºé—²chunkçš„å¤§å°ï¼Œè€Œå¹¶éç›´æ¥ä½¿ç”¨ä½åœ°å€ç©ºé—²chunkçš„sizeåŸŸ</strong></p>
<h4 id="â‘¡å‰å‘åˆå¹¶ï¼šè‹¥ä¸ºtop-chunkåˆ™åˆå¹¶å…¥top-chunkä¸­ï¼Œå¦åˆ™ä¼šå°è¯•åˆå¹¶åæ’å…¥unsorted-binä¸­"><a href="#â‘¡å‰å‘åˆå¹¶ï¼šè‹¥ä¸ºtop-chunkåˆ™åˆå¹¶å…¥top-chunkä¸­ï¼Œå¦åˆ™ä¼šå°è¯•åˆå¹¶åæ’å…¥unsorted-binä¸­" class="headerlink" title="â‘¡å‰å‘åˆå¹¶ï¼šè‹¥ä¸ºtop chunkåˆ™åˆå¹¶å…¥top chunkä¸­ï¼Œå¦åˆ™ä¼šå°è¯•åˆå¹¶åæ’å…¥unsorted_binä¸­"></a>â‘¡å‰å‘åˆå¹¶ï¼šè‹¥ä¸ºtop chunkåˆ™åˆå¹¶å…¥top chunkä¸­ï¼Œå¦åˆ™ä¼šå°è¯•åˆå¹¶åæ’å…¥unsorted_binä¸­</h4><h5 id="1ï¼‰nextchunkä¸ºtop-chunk"><a href="#1ï¼‰nextchunkä¸ºtop-chunk" class="headerlink" title="1ï¼‰nextchunkä¸ºtop chunk"></a>1ï¼‰nextchunkä¸ºtop chunk</h5><p>é¦–å…ˆä¼šæ£€æŸ¥nextchunkæ˜¯å¦ä¸ºtop chunkï¼Œè‹¥æ˜¯åˆ™æµç¨‹ä¼šç®€ä¾¿å¾—å¤šï¼š<strong>å°†è¯¥chunkçš„sizeåŠ ä¸Šnextchunkçš„sizeï¼Œè®¾ç½®PREV_INUSEæ ‡å¿—ä½ï¼Œå°†arenaçš„top chunkè®¾ç½®ä¸ºè¯¥chunkåä¾¿è¿›å…¥ä¸‹ä¸€æ­¥</strong></p>
<p><img src="https://i.loli.net/2021/01/23/QF5vhAYbGeqf4C9.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<h5 id="5ï¼‰nextchunkä¸ä¸ºtop-chunk"><a href="#5ï¼‰nextchunkä¸ä¸ºtop-chunk" class="headerlink" title="5ï¼‰nextchunkä¸ä¸ºtop chunk"></a>5ï¼‰nextchunkä¸ä¸ºtop chunk</h5><p>è‹¥nextchunkä¸ä¸ºtop chunkï¼Œåˆ™<strong>é¦–å…ˆä¼šæ£€æŸ¥nextchunkçš„ç‰©ç†ç›¸é‚»é«˜åœ°å€chunkçš„PREV_INUSEæ ‡å¿—ä½</strong></p>
<ul>
<li><strong>è‹¥ä¸ä¸º0åˆ™ä¼šæ¸…é™¤nextchunkçš„PREV_INSUEä½</strong></li>
</ul>
<p><img src="https://i.loli.net/2021/01/23/YVaFRKonG4WBuXM.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<ul>
<li><strong>è‹¥ä¸º0åˆ™ä½¿ç”¨unlinkå°†nextchunkä»binsä¸­å–å‡º</strong></li>
</ul>
<p><img src="https://i.loli.net/2021/01/23/LEBAKhTbSMlCcVr.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p>æ¥ä¸‹æ¥ä¼š<strong>å°†è¯¥chunkæ”¾å…¥unsorted binä¸­ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯åœ¨è¿™é‡Œä½¿ç”¨çš„æ˜¯å¤´æ’æ³•ä½¿å…¶æˆä¸ºunsorted binçš„å¤´ç»“ç‚¹</strong></p>
<p><img src="https://i.loli.net/2021/01/23/BNJIPrGL9eTvX8U.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p>æ¥ä¸‹æ¥ä¼šæ£€æŸ¥chunkæœ€ç»ˆçš„å¤§å°ï¼Œ<strong>è‹¥æ˜¯sizeä¸å¤„äºsmallbinsèŒƒå›´å†…åˆ™ä¼šè®¾ç½®å…¶fd_nextsizeä¸bk_nextsizeä¸ºNULL</strong></p>
<p>æœ€åï¼Œ<strong>è®¾ç½®è¯¥chunkçš„PREV_INUSEä½ä¸º1</strong>ï¼Œè®¾ç½®<strong>å½“å‰æƒ…å†µä¸‹çš„ç‰©ç†ç›¸é‚»chunkçš„prevsizeåŸŸä¸ºè¯¥chunkçš„size</strong></p>
<p><img src="https://i.loli.net/2021/01/23/5b7qYPjO1AmXkyF.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<h4 id="â‘¢æ£€æŸ¥é“¾è¡¨ä¸­çš„ä¸‹ä¸€ä¸ªchunkï¼Œä¸ä¸ºNULLåˆ™ç»§ç»­æ–°ä¸€è½®å¾ªç¯"><a href="#â‘¢æ£€æŸ¥é“¾è¡¨ä¸­çš„ä¸‹ä¸€ä¸ªchunkï¼Œä¸ä¸ºNULLåˆ™ç»§ç»­æ–°ä¸€è½®å¾ªç¯" class="headerlink" title="â‘¢æ£€æŸ¥é“¾è¡¨ä¸­çš„ä¸‹ä¸€ä¸ªchunkï¼Œä¸ä¸ºNULLåˆ™ç»§ç»­æ–°ä¸€è½®å¾ªç¯"></a>â‘¢æ£€æŸ¥é“¾è¡¨ä¸­çš„ä¸‹ä¸€ä¸ªchunkï¼Œä¸ä¸ºNULLåˆ™ç»§ç»­æ–°ä¸€è½®å¾ªç¯</h4><p>è™½ç„¶chunkæŒ‡é’ˆå¯èƒ½åœ¨åˆå¹¶ä¸­è¢«ä¿®æ”¹ï¼Œä½†æ˜¯æˆ‘ä»¬åœ¨å‰é¢å·²ç»ä¿å­˜äº†å…¶fdï¼Œè‹¥ä¸ä¸ºNULLåˆ™è¿›è¡Œä¸‹ä¸€è½®å¾ªç¯ï¼Œæ•…å¯ä»¥ç»§ç»­éå†é“¾è¡¨çš„è¿›ç¨‹</p>
<h1 id="0x03-int-malloc"><a href="#0x03-int-malloc" class="headerlink" title="0x03._int_malloc"></a>0x03._int_malloc</h1><p>è¯¥å‡½æ•°ä¸º<strong>ptmallocå†…å­˜åˆ†é…æœºåˆ¶çš„æ ¸å¿ƒå‡½æ•°</strong>ï¼Œå®šä¹‰äºmalloc.cä¸­ï¼Œå¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/*</span><br><span class="hljs-comment">   ------------------------------ malloc ------------------------------</span><br><span class="hljs-comment"> */</span><br><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> *<br>_int_malloc (mstate av, <span class="hljs-type">size_t</span> bytes)<br>&#123;<br>  INTERNAL_SIZE_T nb;               <span class="hljs-comment">/* normalized request size */</span><br>  <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> idx;                 <span class="hljs-comment">/* associated bin index */</span><br>  mbinptr bin;                      <span class="hljs-comment">/* associated bin */</span><br><br>  mchunkptr victim;                 <span class="hljs-comment">/* inspected/selected chunk */</span><br>  INTERNAL_SIZE_T size;             <span class="hljs-comment">/* its size */</span><br>  <span class="hljs-type">int</span> victim_index;                 <span class="hljs-comment">/* its bin index */</span><br><br>  mchunkptr remainder;              <span class="hljs-comment">/* remainder from a split */</span><br>  <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> remainder_size;     <span class="hljs-comment">/* its size */</span><br><br>  <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> block;               <span class="hljs-comment">/* bit map traverser */</span><br>  <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> bit;                 <span class="hljs-comment">/* bit map traverser */</span><br>  <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> <span class="hljs-built_in">map</span>;                 <span class="hljs-comment">/* current word of binmap */</span><br><br>  mchunkptr fwd;                    <span class="hljs-comment">/* misc temp for linking */</span><br>  mchunkptr bck;                    <span class="hljs-comment">/* misc temp for linking */</span><br><br>  <span class="hljs-type">const</span> <span class="hljs-type">char</span> *errstr = <span class="hljs-literal">NULL</span>;<br><br>  <span class="hljs-comment">/*</span><br><span class="hljs-comment">     Convert request size to internal form by adding SIZE_SZ bytes</span><br><span class="hljs-comment">     overhead plus possibly more to obtain necessary alignment and/or</span><br><span class="hljs-comment">     to obtain a size of at least MINSIZE, the smallest allocatable</span><br><span class="hljs-comment">     size. Also, checked_request2size traps (returning 0) request sizes</span><br><span class="hljs-comment">     that are so large that they wrap around zero when padded and</span><br><span class="hljs-comment">     aligned.</span><br><span class="hljs-comment">   */</span><br><br>  checked_request2size (bytes, nb);<br><br>  <span class="hljs-comment">/* There are no usable arenas.  Fall back to sysmalloc to get a chunk from</span><br><span class="hljs-comment">     mmap.  */</span><br>  <span class="hljs-keyword">if</span> (__glibc_unlikely (av == <span class="hljs-literal">NULL</span>))<br>    &#123;<br>      <span class="hljs-type">void</span> *p = sysmalloc (nb, av);<br>      <span class="hljs-keyword">if</span> (p != <span class="hljs-literal">NULL</span>)<br>	alloc_perturb (p, bytes);<br>      <span class="hljs-keyword">return</span> p;<br>    &#125;<br><br>  <span class="hljs-comment">/*</span><br><span class="hljs-comment">     If the size qualifies as a fastbin, first check corresponding bin.</span><br><span class="hljs-comment">     This code is safe to execute even if av is not yet initialized, so we</span><br><span class="hljs-comment">     can try it without checking, which saves some time on this fast path.</span><br><span class="hljs-comment">   */</span><br><br>  <span class="hljs-keyword">if</span> ((<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) (nb) &lt;= (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) (get_max_fast ()))<br>    &#123;<br>      idx = fastbin_index (nb);<br>      mfastbinptr *fb = &amp;fastbin (av, idx);<br>      mchunkptr pp = *fb;<br>      <span class="hljs-keyword">do</span><br>        &#123;<br>          victim = pp;<br>          <span class="hljs-keyword">if</span> (victim == <span class="hljs-literal">NULL</span>)<br>            <span class="hljs-keyword">break</span>;<br>        &#125;<br>      <span class="hljs-keyword">while</span> ((pp = catomic_compare_and_exchange_val_acq (fb, victim-&gt;fd, victim))<br>             != victim);<br>      <span class="hljs-keyword">if</span> (victim != <span class="hljs-number">0</span>)<br>        &#123;<br>          <span class="hljs-keyword">if</span> (__builtin_expect (fastbin_index (chunksize (victim)) != idx, <span class="hljs-number">0</span>))<br>            &#123;<br>              errstr = <span class="hljs-string">&quot;malloc(): memory corruption (fast)&quot;</span>;<br>            errout:<br>              malloc_printerr (check_action, errstr, chunk2mem (victim), av);<br>              <span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;<br>            &#125;<br>          check_remalloced_chunk (av, victim, nb);<br>          <span class="hljs-type">void</span> *p = chunk2mem (victim);<br>          alloc_perturb (p, bytes);<br>          <span class="hljs-keyword">return</span> p;<br>        &#125;<br>    &#125;<br><br>  <span class="hljs-comment">/*</span><br><span class="hljs-comment">     If a small request, check regular bin.  Since these &quot;smallbins&quot;</span><br><span class="hljs-comment">     hold one size each, no searching within bins is necessary.</span><br><span class="hljs-comment">     (For a large request, we need to wait until unsorted chunks are</span><br><span class="hljs-comment">     processed to find best fit. But for small ones, fits are exact</span><br><span class="hljs-comment">     anyway, so we can check now, which is faster.)</span><br><span class="hljs-comment">   */</span><br><br>  <span class="hljs-keyword">if</span> (in_smallbin_range (nb))<br>    &#123;<br>      idx = smallbin_index (nb);<br>      bin = bin_at (av, idx);<br><br>      <span class="hljs-keyword">if</span> ((victim = last (bin)) != bin)<br>        &#123;<br>          <span class="hljs-keyword">if</span> (victim == <span class="hljs-number">0</span>) <span class="hljs-comment">/* initialization check */</span><br>            malloc_consolidate (av);<br>          <span class="hljs-keyword">else</span><br>            &#123;<br>              bck = victim-&gt;bk;<br>	<span class="hljs-keyword">if</span> (__glibc_unlikely (bck-&gt;fd != victim))<br>                &#123;<br>                  errstr = <span class="hljs-string">&quot;malloc(): smallbin double linked list corrupted&quot;</span>;<br>                  <span class="hljs-keyword">goto</span> errout;<br>                &#125;<br>              set_inuse_bit_at_offset (victim, nb);<br>              bin-&gt;bk = bck;<br>              bck-&gt;fd = bin;<br><br>              <span class="hljs-keyword">if</span> (av != &amp;main_arena)<br>                victim-&gt;size |= NON_MAIN_ARENA;<br>              check_malloced_chunk (av, victim, nb);<br>              <span class="hljs-type">void</span> *p = chunk2mem (victim);<br>              alloc_perturb (p, bytes);<br>              <span class="hljs-keyword">return</span> p;<br>            &#125;<br>        &#125;<br>    &#125;<br><br>  <span class="hljs-comment">/*</span><br><span class="hljs-comment">     If this is a large request, consolidate fastbins before continuing.</span><br><span class="hljs-comment">     While it might look excessive to kill all fastbins before</span><br><span class="hljs-comment">     even seeing if there is space available, this avoids</span><br><span class="hljs-comment">     fragmentation problems normally associated with fastbins.</span><br><span class="hljs-comment">     Also, in practice, programs tend to have runs of either small or</span><br><span class="hljs-comment">     large requests, but less often mixtures, so consolidation is not</span><br><span class="hljs-comment">     invoked all that often in most programs. And the programs that</span><br><span class="hljs-comment">     it is called frequently in otherwise tend to fragment.</span><br><span class="hljs-comment">   */</span><br><br>  <span class="hljs-keyword">else</span><br>    &#123;<br>      idx = largebin_index (nb);<br>      <span class="hljs-keyword">if</span> (have_fastchunks (av))<br>        malloc_consolidate (av);<br>    &#125;<br><br>  <span class="hljs-comment">/*</span><br><span class="hljs-comment">     Process recently freed or remaindered chunks, taking one only if</span><br><span class="hljs-comment">     it is exact fit, or, if this a small request, the chunk is remainder from</span><br><span class="hljs-comment">     the most recent non-exact fit.  Place other traversed chunks in</span><br><span class="hljs-comment">     bins.  Note that this step is the only place in any routine where</span><br><span class="hljs-comment">     chunks are placed in bins.</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">     The outer loop here is needed because we might not realize until</span><br><span class="hljs-comment">     near the end of malloc that we should have consolidated, so must</span><br><span class="hljs-comment">     do so and retry. This happens at most once, and only when we would</span><br><span class="hljs-comment">     otherwise need to expand memory to service a &quot;small&quot; request.</span><br><span class="hljs-comment">   */</span><br><br>  <span class="hljs-keyword">for</span> (;; )<br>    &#123;<br>      <span class="hljs-type">int</span> iters = <span class="hljs-number">0</span>;<br>      <span class="hljs-keyword">while</span> ((victim = unsorted_chunks (av)-&gt;bk) != unsorted_chunks (av))<br>        &#123;<br>          bck = victim-&gt;bk;<br>          <span class="hljs-keyword">if</span> (__builtin_expect (victim-&gt;size &lt;= <span class="hljs-number">2</span> * SIZE_SZ, <span class="hljs-number">0</span>)<br>              || __builtin_expect (victim-&gt;size &gt; av-&gt;system_mem, <span class="hljs-number">0</span>))<br>            malloc_printerr (check_action, <span class="hljs-string">&quot;malloc(): memory corruption&quot;</span>,<br>                             chunk2mem (victim), av);<br>          size = chunksize (victim);<br><br>          <span class="hljs-comment">/*</span><br><span class="hljs-comment">             If a small request, try to use last remainder if it is the</span><br><span class="hljs-comment">             only chunk in unsorted bin.  This helps promote locality for</span><br><span class="hljs-comment">             runs of consecutive small requests. This is the only</span><br><span class="hljs-comment">             exception to best-fit, and applies only when there is</span><br><span class="hljs-comment">             no exact fit for a small chunk.</span><br><span class="hljs-comment">           */</span><br><br>          <span class="hljs-keyword">if</span> (in_smallbin_range (nb) &amp;&amp;<br>              bck == unsorted_chunks (av) &amp;&amp;<br>              victim == av-&gt;last_remainder &amp;&amp;<br>              (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) (size) &gt; (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) (nb + MINSIZE))<br>            &#123;<br>              <span class="hljs-comment">/* split and reattach remainder */</span><br>              remainder_size = size - nb;<br>              remainder = chunk_at_offset (victim, nb);<br>              unsorted_chunks (av)-&gt;bk = unsorted_chunks (av)-&gt;fd = remainder;<br>              av-&gt;last_remainder = remainder;<br>              remainder-&gt;bk = remainder-&gt;fd = unsorted_chunks (av);<br>              <span class="hljs-keyword">if</span> (!in_smallbin_range (remainder_size))<br>                &#123;<br>                  remainder-&gt;fd_nextsize = <span class="hljs-literal">NULL</span>;<br>                  remainder-&gt;bk_nextsize = <span class="hljs-literal">NULL</span>;<br>                &#125;<br><br>              set_head (victim, nb | PREV_INUSE |<br>                        (av != &amp;main_arena ? NON_MAIN_ARENA : <span class="hljs-number">0</span>));<br>              set_head (remainder, remainder_size | PREV_INUSE);<br>              set_foot (remainder, remainder_size);<br><br>              check_malloced_chunk (av, victim, nb);<br>              <span class="hljs-type">void</span> *p = chunk2mem (victim);<br>              alloc_perturb (p, bytes);<br>              <span class="hljs-keyword">return</span> p;<br>            &#125;<br><br>          <span class="hljs-comment">/* remove from unsorted list */</span><br>          unsorted_chunks (av)-&gt;bk = bck;<br>          bck-&gt;fd = unsorted_chunks (av);<br><br>          <span class="hljs-comment">/* Take now instead of binning if exact fit */</span><br><br>          <span class="hljs-keyword">if</span> (size == nb)<br>            &#123;<br>              set_inuse_bit_at_offset (victim, size);<br>              <span class="hljs-keyword">if</span> (av != &amp;main_arena)<br>                victim-&gt;size |= NON_MAIN_ARENA;<br>              check_malloced_chunk (av, victim, nb);<br>              <span class="hljs-type">void</span> *p = chunk2mem (victim);<br>              alloc_perturb (p, bytes);<br>              <span class="hljs-keyword">return</span> p;<br>            &#125;<br><br>          <span class="hljs-comment">/* place chunk in bin */</span><br><br>          <span class="hljs-keyword">if</span> (in_smallbin_range (size))<br>            &#123;<br>              victim_index = smallbin_index (size);<br>              bck = bin_at (av, victim_index);<br>              fwd = bck-&gt;fd;<br>            &#125;<br>          <span class="hljs-keyword">else</span><br>            &#123;<br>              victim_index = largebin_index (size);<br>              bck = bin_at (av, victim_index);<br>              fwd = bck-&gt;fd;<br><br>              <span class="hljs-comment">/* maintain large bins in sorted order */</span><br>              <span class="hljs-keyword">if</span> (fwd != bck)<br>                &#123;<br>                  <span class="hljs-comment">/* Or with inuse bit to speed comparisons */</span><br>                  size |= PREV_INUSE;<br>                  <span class="hljs-comment">/* if smaller than smallest, bypass loop below */</span><br>                  assert ((bck-&gt;bk-&gt;size &amp; NON_MAIN_ARENA) == <span class="hljs-number">0</span>);<br>                  <span class="hljs-keyword">if</span> ((<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) (size) &lt; (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) (bck-&gt;bk-&gt;size))<br>                    &#123;<br>                      fwd = bck;<br>                      bck = bck-&gt;bk;<br><br>                      victim-&gt;fd_nextsize = fwd-&gt;fd;<br>                      victim-&gt;bk_nextsize = fwd-&gt;fd-&gt;bk_nextsize;<br>                      fwd-&gt;fd-&gt;bk_nextsize = victim-&gt;bk_nextsize-&gt;fd_nextsize = victim;<br>                    &#125;<br>                  <span class="hljs-keyword">else</span><br>                    &#123;<br>                      assert ((fwd-&gt;size &amp; NON_MAIN_ARENA) == <span class="hljs-number">0</span>);<br>                      <span class="hljs-keyword">while</span> ((<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) size &lt; fwd-&gt;size)<br>                        &#123;<br>                          fwd = fwd-&gt;fd_nextsize;<br>                          assert ((fwd-&gt;size &amp; NON_MAIN_ARENA) == <span class="hljs-number">0</span>);<br>                        &#125;<br><br>                      <span class="hljs-keyword">if</span> ((<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) size == (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) fwd-&gt;size)<br>                        <span class="hljs-comment">/* Always insert in the second position.  */</span><br>                        fwd = fwd-&gt;fd;<br>                      <span class="hljs-keyword">else</span><br>                        &#123;<br>                          victim-&gt;fd_nextsize = fwd;<br>                          victim-&gt;bk_nextsize = fwd-&gt;bk_nextsize;<br>                          fwd-&gt;bk_nextsize = victim;<br>                          victim-&gt;bk_nextsize-&gt;fd_nextsize = victim;<br>                        &#125;<br>                      bck = fwd-&gt;bk;<br>                    &#125;<br>                &#125;<br>              <span class="hljs-keyword">else</span><br>                victim-&gt;fd_nextsize = victim-&gt;bk_nextsize = victim;<br>            &#125;<br><br>          mark_bin (av, victim_index);<br>          victim-&gt;bk = bck;<br>          victim-&gt;fd = fwd;<br>          fwd-&gt;bk = victim;<br>          bck-&gt;fd = victim;<br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MAX_ITERS       10000</span><br>          <span class="hljs-keyword">if</span> (++iters &gt;= MAX_ITERS)<br>            <span class="hljs-keyword">break</span>;<br>        &#125;<br><br>      <span class="hljs-comment">/*</span><br><span class="hljs-comment">         If a large request, scan through the chunks of current bin in</span><br><span class="hljs-comment">         sorted order to find smallest that fits.  Use the skip list for this.</span><br><span class="hljs-comment">       */</span><br><br>      <span class="hljs-keyword">if</span> (!in_smallbin_range (nb))<br>        &#123;<br>          bin = bin_at (av, idx);<br><br>          <span class="hljs-comment">/* skip scan if empty or largest chunk is too small */</span><br>          <span class="hljs-keyword">if</span> ((victim = first (bin)) != bin &amp;&amp;<br>              (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) (victim-&gt;size) &gt;= (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) (nb))<br>            &#123;<br>              victim = victim-&gt;bk_nextsize;<br>              <span class="hljs-keyword">while</span> (((<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) (size = chunksize (victim)) &lt;<br>                      (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) (nb)))<br>                victim = victim-&gt;bk_nextsize;<br><br>              <span class="hljs-comment">/* Avoid removing the first entry for a size so that the skip</span><br><span class="hljs-comment">                 list does not have to be rerouted.  */</span><br>              <span class="hljs-keyword">if</span> (victim != last (bin) &amp;&amp; victim-&gt;size == victim-&gt;fd-&gt;size)<br>                victim = victim-&gt;fd;<br><br>              remainder_size = size - nb;<br>              unlink (av, victim, bck, fwd);<br><br>              <span class="hljs-comment">/* Exhaust */</span><br>              <span class="hljs-keyword">if</span> (remainder_size &lt; MINSIZE)<br>                &#123;<br>                  set_inuse_bit_at_offset (victim, size);<br>                  <span class="hljs-keyword">if</span> (av != &amp;main_arena)<br>                    victim-&gt;size |= NON_MAIN_ARENA;<br>                &#125;<br>              <span class="hljs-comment">/* Split */</span><br>              <span class="hljs-keyword">else</span><br>                &#123;<br>                  remainder = chunk_at_offset (victim, nb);<br>                  <span class="hljs-comment">/* We cannot assume the unsorted list is empty and therefore</span><br><span class="hljs-comment">                     have to perform a complete insert here.  */</span><br>                  bck = unsorted_chunks (av);<br>                  fwd = bck-&gt;fd;<br>	  <span class="hljs-keyword">if</span> (__glibc_unlikely (fwd-&gt;bk != bck))<br>                    &#123;<br>                      errstr = <span class="hljs-string">&quot;malloc(): corrupted unsorted chunks&quot;</span>;<br>                      <span class="hljs-keyword">goto</span> errout;<br>                    &#125;<br>                  remainder-&gt;bk = bck;<br>                  remainder-&gt;fd = fwd;<br>                  bck-&gt;fd = remainder;<br>                  fwd-&gt;bk = remainder;<br>                  <span class="hljs-keyword">if</span> (!in_smallbin_range (remainder_size))<br>                    &#123;<br>                      remainder-&gt;fd_nextsize = <span class="hljs-literal">NULL</span>;<br>                      remainder-&gt;bk_nextsize = <span class="hljs-literal">NULL</span>;<br>                    &#125;<br>                  set_head (victim, nb | PREV_INUSE |<br>                            (av != &amp;main_arena ? NON_MAIN_ARENA : <span class="hljs-number">0</span>));<br>                  set_head (remainder, remainder_size | PREV_INUSE);<br>                  set_foot (remainder, remainder_size);<br>                &#125;<br>              check_malloced_chunk (av, victim, nb);<br>              <span class="hljs-type">void</span> *p = chunk2mem (victim);<br>              alloc_perturb (p, bytes);<br>              <span class="hljs-keyword">return</span> p;<br>            &#125;<br>        &#125;<br><br>      <span class="hljs-comment">/*</span><br><span class="hljs-comment">         Search for a chunk by scanning bins, starting with next largest</span><br><span class="hljs-comment">         bin. This search is strictly by best-fit; i.e., the smallest</span><br><span class="hljs-comment">         (with ties going to approximately the least recently used) chunk</span><br><span class="hljs-comment">         that fits is selected.</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">         The bitmap avoids needing to check that most blocks are nonempty.</span><br><span class="hljs-comment">         The particular case of skipping all bins during warm-up phases</span><br><span class="hljs-comment">         when no chunks have been returned yet is faster than it might look.</span><br><span class="hljs-comment">       */</span><br><br>      ++idx;<br>      bin = bin_at (av, idx);<br>      block = idx2block (idx);<br>      <span class="hljs-built_in">map</span> = av-&gt;binmap[block];<br>      bit = idx2bit (idx);<br><br>      <span class="hljs-keyword">for</span> (;; )<br>        &#123;<br>          <span class="hljs-comment">/* Skip rest of block if there are no more set bits in this block.  */</span><br>          <span class="hljs-keyword">if</span> (bit &gt; <span class="hljs-built_in">map</span> || bit == <span class="hljs-number">0</span>)<br>            &#123;<br>              <span class="hljs-keyword">do</span><br>                &#123;<br>                  <span class="hljs-keyword">if</span> (++block &gt;= BINMAPSIZE) <span class="hljs-comment">/* out of bins */</span><br>                    <span class="hljs-keyword">goto</span> use_top;<br>                &#125;<br>              <span class="hljs-keyword">while</span> ((<span class="hljs-built_in">map</span> = av-&gt;binmap[block]) == <span class="hljs-number">0</span>);<br><br>              bin = bin_at (av, (block &lt;&lt; BINMAPSHIFT));<br>              bit = <span class="hljs-number">1</span>;<br>            &#125;<br><br>          <span class="hljs-comment">/* Advance to bin with set bit. There must be one. */</span><br>          <span class="hljs-keyword">while</span> ((bit &amp; <span class="hljs-built_in">map</span>) == <span class="hljs-number">0</span>)<br>            &#123;<br>              bin = next_bin (bin);<br>              bit &lt;&lt;= <span class="hljs-number">1</span>;<br>              assert (bit != <span class="hljs-number">0</span>);<br>            &#125;<br><br>          <span class="hljs-comment">/* Inspect the bin. It is likely to be non-empty */</span><br>          victim = last (bin);<br><br>          <span class="hljs-comment">/*  If a false alarm (empty bin), clear the bit. */</span><br>          <span class="hljs-keyword">if</span> (victim == bin)<br>            &#123;<br>              av-&gt;binmap[block] = <span class="hljs-built_in">map</span> &amp;= ~bit; <span class="hljs-comment">/* Write through */</span><br>              bin = next_bin (bin);<br>              bit &lt;&lt;= <span class="hljs-number">1</span>;<br>            &#125;<br><br>          <span class="hljs-keyword">else</span><br>            &#123;<br>              size = chunksize (victim);<br><br>              <span class="hljs-comment">/*  We know the first chunk in this bin is big enough to use. */</span><br>              assert ((<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) (size) &gt;= (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) (nb));<br><br>              remainder_size = size - nb;<br><br>              <span class="hljs-comment">/* unlink */</span><br>              unlink (av, victim, bck, fwd);<br><br>              <span class="hljs-comment">/* Exhaust */</span><br>              <span class="hljs-keyword">if</span> (remainder_size &lt; MINSIZE)<br>                &#123;<br>                  set_inuse_bit_at_offset (victim, size);<br>                  <span class="hljs-keyword">if</span> (av != &amp;main_arena)<br>                    victim-&gt;size |= NON_MAIN_ARENA;<br>                &#125;<br><br>              <span class="hljs-comment">/* Split */</span><br>              <span class="hljs-keyword">else</span><br>                &#123;<br>                  remainder = chunk_at_offset (victim, nb);<br><br>                  <span class="hljs-comment">/* We cannot assume the unsorted list is empty and therefore</span><br><span class="hljs-comment">                     have to perform a complete insert here.  */</span><br>                  bck = unsorted_chunks (av);<br>                  fwd = bck-&gt;fd;<br>	  <span class="hljs-keyword">if</span> (__glibc_unlikely (fwd-&gt;bk != bck))<br>                    &#123;<br>                      errstr = <span class="hljs-string">&quot;malloc(): corrupted unsorted chunks 2&quot;</span>;<br>                      <span class="hljs-keyword">goto</span> errout;<br>                    &#125;<br>                  remainder-&gt;bk = bck;<br>                  remainder-&gt;fd = fwd;<br>                  bck-&gt;fd = remainder;<br>                  fwd-&gt;bk = remainder;<br><br>                  <span class="hljs-comment">/* advertise as last remainder */</span><br>                  <span class="hljs-keyword">if</span> (in_smallbin_range (nb))<br>                    av-&gt;last_remainder = remainder;<br>                  <span class="hljs-keyword">if</span> (!in_smallbin_range (remainder_size))<br>                    &#123;<br>                      remainder-&gt;fd_nextsize = <span class="hljs-literal">NULL</span>;<br>                      remainder-&gt;bk_nextsize = <span class="hljs-literal">NULL</span>;<br>                    &#125;<br>                  set_head (victim, nb | PREV_INUSE |<br>                            (av != &amp;main_arena ? NON_MAIN_ARENA : <span class="hljs-number">0</span>));<br>                  set_head (remainder, remainder_size | PREV_INUSE);<br>                  set_foot (remainder, remainder_size);<br>                &#125;<br>              check_malloced_chunk (av, victim, nb);<br>              <span class="hljs-type">void</span> *p = chunk2mem (victim);<br>              alloc_perturb (p, bytes);<br>              <span class="hljs-keyword">return</span> p;<br>            &#125;<br>        &#125;<br><br>    use_top:<br>      <span class="hljs-comment">/*</span><br><span class="hljs-comment">         If large enough, split off the chunk bordering the end of memory</span><br><span class="hljs-comment">         (held in av-&gt;top). Note that this is in accord with the best-fit</span><br><span class="hljs-comment">         search rule.  In effect, av-&gt;top is treated as larger (and thus</span><br><span class="hljs-comment">         less well fitting) than any other available chunk since it can</span><br><span class="hljs-comment">         be extended to be as large as necessary (up to system</span><br><span class="hljs-comment">         limitations).</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">         We require that av-&gt;top always exists (i.e., has size &gt;=</span><br><span class="hljs-comment">         MINSIZE) after initialization, so if it would otherwise be</span><br><span class="hljs-comment">         exhausted by current request, it is replenished. (The main</span><br><span class="hljs-comment">         reason for ensuring it exists is that we may need MINSIZE space</span><br><span class="hljs-comment">         to put in fenceposts in sysmalloc.)</span><br><span class="hljs-comment">       */</span><br><br>      victim = av-&gt;top;<br>      size = chunksize (victim);<br><br>      <span class="hljs-keyword">if</span> ((<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) (size) &gt;= (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) (nb + MINSIZE))<br>        &#123;<br>          remainder_size = size - nb;<br>          remainder = chunk_at_offset (victim, nb);<br>          av-&gt;top = remainder;<br>          set_head (victim, nb | PREV_INUSE |<br>                    (av != &amp;main_arena ? NON_MAIN_ARENA : <span class="hljs-number">0</span>));<br>          set_head (remainder, remainder_size | PREV_INUSE);<br><br>          check_malloced_chunk (av, victim, nb);<br>          <span class="hljs-type">void</span> *p = chunk2mem (victim);<br>          alloc_perturb (p, bytes);<br>          <span class="hljs-keyword">return</span> p;<br>        &#125;<br><br>      <span class="hljs-comment">/* When we are using atomic ops to free fast chunks we can get</span><br><span class="hljs-comment">         here for all block sizes.  */</span><br>      <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (have_fastchunks (av))<br>        &#123;<br>          malloc_consolidate (av);<br>          <span class="hljs-comment">/* restore original bin index */</span><br>          <span class="hljs-keyword">if</span> (in_smallbin_range (nb))<br>            idx = smallbin_index (nb);<br>          <span class="hljs-keyword">else</span><br>            idx = largebin_index (nb);<br>        &#125;<br><br>      <span class="hljs-comment">/*</span><br><span class="hljs-comment">         Otherwise, relay to handle system-dependent cases</span><br><span class="hljs-comment">       */</span><br>      <span class="hljs-keyword">else</span><br>        &#123;<br>          <span class="hljs-type">void</span> *p = sysmalloc (nb, av);<br>          <span class="hljs-keyword">if</span> (p != <span class="hljs-literal">NULL</span>)<br>            alloc_perturb (p, bytes);<br>          <span class="hljs-keyword">return</span> p;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>åœ¨å‡½æ•°ä¸€å¼€å§‹ä¼šåˆ›å»ºä¸€äº›åç»­åˆ†é…æœºåˆ¶æ‰€éœ€ä½¿ç”¨çš„å˜é‡ï¼Œå…·ä½“ç”¨é€”è§æ³¨é‡Šï¼Œè¿™é‡Œä¾¿ä¸å†èµ˜å™</p>
<h2 id="ä¸€ã€å°†è¯·æ±‚å¤§å°è½¬æ¢ä¸ºæ ‡å‡†å¤§å°"><a href="#ä¸€ã€å°†è¯·æ±‚å¤§å°è½¬æ¢ä¸ºæ ‡å‡†å¤§å°" class="headerlink" title="ä¸€ã€å°†è¯·æ±‚å¤§å°è½¬æ¢ä¸ºæ ‡å‡†å¤§å°"></a>ä¸€ã€å°†è¯·æ±‚å¤§å°è½¬æ¢ä¸ºæ ‡å‡†å¤§å°</h2><p>åœ¨_int_malloc()å‡½æ•°ä¸€å¼€å§‹æ—¶ä¼šå°†ç”¨æˆ·æ‰€è¯·æ±‚çš„å¤§å°è½¬æ¢ä¸ºå¯¹åº”çš„ä¸<code>MALLOC_ALIGNMENT</code>å¯¹é½çš„å¤§å°ï¼Œåœ¨è¿™é‡Œä½¿ç”¨äº†ä¸€ä¸ªå®<code>checked_request2size()</code>ï¼Œå…¶ä¼šä½¿ç”¨<code>request2size()</code>å®è¿›è¡Œè®¡ç®—ï¼Œchunk sizeçš„è®¡ç®—è§„åˆ™å¤§è‡´å¦‚ä¸‹å›¾æ‰€ç¤ºï¼ˆè¯¥å®ä¼šå°†è¯·æ±‚çš„sizeå…ˆåŠ ä¸Šchunk headerçš„å¤§å°ï¼‰ï¼š</p>
<p><img src="https://i.loli.net/2020/12/19/HZfcpy4wkJGg9V3.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<blockquote>
<p>è¯¦è§0x00.äºŒ.1</p>
</blockquote>
<h2 id="äºŒã€æ£€æŸ¥arenaæ˜¯å¦å¯ç”¨"><a href="#äºŒã€æ£€æŸ¥arenaæ˜¯å¦å¯ç”¨" class="headerlink" title="äºŒã€æ£€æŸ¥arenaæ˜¯å¦å¯ç”¨"></a>äºŒã€æ£€æŸ¥arenaæ˜¯å¦å¯ç”¨</h2><p>ä¸Šæ–‡æˆ‘ä»¬è®²åˆ°ï¼Œ<strong>è·å–å¯ç”¨arena</strong>è¿™ä¸€æ­¥éª¤æ˜¯åœ¨<code>__libc_malloc()</code>å‡½æ•°ä¸­å®Œæˆçš„ï¼Œ<code>_int_malloc()</code>å‡½æ•°æ‰€éœ€è¦åšçš„ä»…ä»…æ˜¯ä½¿ç”¨ä¸Šå±‚è°ƒç”¨å‡½æ•°ä¼ å…¥çš„arenaï¼Œ<strong>ä½†æ˜¯åœ¨__libc_malloc</strong>()<strong>å‡½æ•°ä¸­æˆ‘ä»¬æœ‰å¯èƒ½æ— æ³•å¾—åˆ°ä¸€ä¸ªå¯ç”¨çš„arena</strong>ï¼ˆè¯¦è§0x02.2 &amp; 0x02.4ï¼‰</p>
<p>å› è€Œåœ¨è¿™é‡Œä¼šé¦–å…ˆæ£€æŸ¥ä¼ å…¥çš„arenaï¼Œ<strong>è‹¥ä¸ºNULLåˆ™è¯´æ˜ç°æœ‰arenaå·²ç»æ— æ³•æ»¡è¶³ç”¨æˆ·å†…å­˜è¯·æ±‚ï¼Œæ­¤æ—¶ä¼šç›´æ¥è°ƒç”¨sysmalloc</strong>()<strong>å‡½æ•°é€šè¿‡mmapç³»ç»Ÿè°ƒç”¨åˆ†é…å†…å­˜ï¼Œå¹¶å°†æ‰€å¾—çš„ç»“æœç›´æ¥è¿”å›ä¸Šå±‚è°ƒç”¨</strong></p>
<p>è‹¥sysmallocè¿”å›ç»“æœä¸ä¸ºNULLï¼Œåˆ™ä¼šè°ƒç”¨<code>alloc_perturb()</code>å‡½æ•°å¯¹æˆ‘ä»¬æ‰€è·å¾—çš„å†…å­˜å—è¿›è¡Œé¢„å¤„ç†ï¼Œè¯¥å‡½æ•°å®šä¹‰äºmalloc.cä¸­ï¼Œå¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/* ------------------ Testing support ----------------------------------*/</span><br><br><span class="hljs-type">static</span> <span class="hljs-type">int</span> perturb_byte;<br><br><span class="hljs-type">static</span> <span class="hljs-type">void</span><br><span class="hljs-title function_">alloc_perturb</span> <span class="hljs-params">(<span class="hljs-type">char</span> *p, <span class="hljs-type">size_t</span> n)</span><br>&#123;<br>  <span class="hljs-keyword">if</span> (__glibc_unlikely (perturb_byte))<br>    <span class="hljs-built_in">memset</span> (p, perturb_byte ^ <span class="hljs-number">0xff</span>, n);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>è‹¥æ˜¯é™æ€å…¨å±€å˜é‡<code>perturb_byte</code>ä¸º0ï¼Œåˆ™ä¼šå°†è¯¥å†…å­˜å—ä¸­ç”¨æˆ·è¯·æ±‚å¤§å°çš„éƒ¨åˆ†å…¨éƒ¨è®¾ä¸º<code>0xff</code></p>
<blockquote>
<p>è¿™é‡Œç”¨äº†ä¸€ä¸ªä¸çŸ¥æ‰€è°“çš„å¼‚æˆ–æ“ä½œï¼Œç¬”è€…æš‚ä¸”è’™åœ¨å¤é‡Œâ€¦</p>
</blockquote>
<h2 id="ä¸‰ã€fastbinèŒƒå›´sizeè¯·æ±‚ç›¸å…³æ“ä½œ"><a href="#ä¸‰ã€fastbinèŒƒå›´sizeè¯·æ±‚ç›¸å…³æ“ä½œ" class="headerlink" title="ä¸‰ã€fastbinèŒƒå›´sizeè¯·æ±‚ç›¸å…³æ“ä½œ"></a>ä¸‰ã€fastbinèŒƒå›´sizeè¯·æ±‚ç›¸å…³æ“ä½œ</h2><p>è‹¥æ‰€éœ€chunkçš„sizeåœ¨fastbinçš„èŒƒå›´å†…ï¼ˆ32ä½&lt;&#x3D;0x40ï¼Œ64ä½&lt;&#x3D;0x80ï¼Œè¯¦è§0x00.å››ï¼‰ï¼Œåˆ™ä¼šè¿›è¡Œå¦‚ä¸‹æ“ä½œï¼š</p>
<h3 id="1-å°è¯•ä»fastbinå¯¹åº”ä¸‹æ ‡å–å‡ºchunk"><a href="#1-å°è¯•ä»fastbinå¯¹åº”ä¸‹æ ‡å–å‡ºchunk" class="headerlink" title="1.å°è¯•ä»fastbinå¯¹åº”ä¸‹æ ‡å–å‡ºchunk"></a>1.å°è¯•ä»fastbinå¯¹åº”ä¸‹æ ‡å–å‡ºchunk</h3><h3 id="2-ï¼ˆè‹¥æˆåŠŸè·å¾—chunkï¼‰è¿›è¡Œchunk-sizeå®‰å…¨æ£€æŸ¥"><a href="#2-ï¼ˆè‹¥æˆåŠŸè·å¾—chunkï¼‰è¿›è¡Œchunk-sizeå®‰å…¨æ£€æŸ¥" class="headerlink" title="2.ï¼ˆè‹¥æˆåŠŸè·å¾—chunkï¼‰è¿›è¡Œchunk sizeå®‰å…¨æ£€æŸ¥"></a>2.ï¼ˆè‹¥æˆåŠŸè·å¾—chunkï¼‰è¿›è¡Œchunk sizeå®‰å…¨æ£€æŸ¥</h3><h1 id="0x04-sysmallocï¼š"><a href="#0x04-sysmallocï¼š" class="headerlink" title="0x04.sysmallocï¼š"></a>0x04.sysmallocï¼š</h1><p>å®šä¹‰äºmalloc.cä¸­ï¼Œç”¨ä»¥<strong>çœŸæ­£è°ƒç”¨ç³»ç»Ÿè°ƒç”¨çš„æ¥å£è¿›è¡Œå†…å­˜åˆ†é…</strong>ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/* ----------- Routines dealing with system allocation -------------- */</span><br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment">   sysmalloc handles malloc cases requiring more memory from the system.</span><br><span class="hljs-comment">   On entry, it is assumed that av-&gt;top does not have enough</span><br><span class="hljs-comment">   space to service request for nb bytes, thus requiring that av-&gt;top</span><br><span class="hljs-comment">   be extended or replaced.</span><br><span class="hljs-comment"> */</span><br><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> *<br><span class="hljs-title function_">sysmalloc</span> <span class="hljs-params">(INTERNAL_SIZE_T nb, mstate av)</span><br>&#123;<br>  mchunkptr old_top;              <span class="hljs-comment">/* incoming value of av-&gt;top */</span><br>  INTERNAL_SIZE_T old_size;       <span class="hljs-comment">/* its size */</span><br>  <span class="hljs-type">char</span> *old_end;                  <span class="hljs-comment">/* its end address */</span><br><br>  <span class="hljs-type">long</span> size;                      <span class="hljs-comment">/* arg to first MORECORE or mmap call */</span><br>  <span class="hljs-type">char</span> *brk;                      <span class="hljs-comment">/* return value from MORECORE */</span><br><br>  <span class="hljs-type">long</span> correction;                <span class="hljs-comment">/* arg to 2nd MORECORE call */</span><br>  <span class="hljs-type">char</span> *snd_brk;                  <span class="hljs-comment">/* 2nd return val */</span><br><br>  INTERNAL_SIZE_T front_misalign; <span class="hljs-comment">/* unusable bytes at front of new space */</span><br>  INTERNAL_SIZE_T end_misalign;   <span class="hljs-comment">/* partial page left at end of new space */</span><br>  <span class="hljs-type">char</span> *aligned_brk;              <span class="hljs-comment">/* aligned offset into brk */</span><br><br>  mchunkptr p;                    <span class="hljs-comment">/* the allocated/returned chunk */</span><br>  mchunkptr remainder;            <span class="hljs-comment">/* remainder from allocation */</span><br>  <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> remainder_size;   <span class="hljs-comment">/* its size */</span><br><br><br>  <span class="hljs-type">size_t</span> pagesize = GLRO (dl_pagesize);<br>  <span class="hljs-type">bool</span> tried_mmap = <span class="hljs-literal">false</span>;<br><br><br>  <span class="hljs-comment">/*</span><br><span class="hljs-comment">     If have mmap, and the request size meets the mmap threshold, and</span><br><span class="hljs-comment">     the system supports mmap, and there are few enough currently</span><br><span class="hljs-comment">     allocated mmapped regions, try to directly map this request</span><br><span class="hljs-comment">     rather than expanding top.</span><br><span class="hljs-comment">   */</span><br><br>  <span class="hljs-keyword">if</span> (av == <span class="hljs-literal">NULL</span><br>      || ((<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) (nb) &gt;= (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) (mp_.mmap_threshold)<br>	  &amp;&amp; (mp_.n_mmaps &lt; mp_.n_mmaps_max)))<br>    &#123;<br>      <span class="hljs-type">char</span> *mm;           <span class="hljs-comment">/* return value from mmap call*/</span><br><br>    try_mmap:<br>      <span class="hljs-comment">/*</span><br><span class="hljs-comment">         Round up size to nearest page.  For mmapped chunks, the overhead</span><br><span class="hljs-comment">         is one SIZE_SZ unit larger than for normal chunks, because there</span><br><span class="hljs-comment">         is no following chunk whose prev_size field could be used.</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">         See the front_misalign handling below, for glibc there is no</span><br><span class="hljs-comment">         need for further alignments unless we have have high alignment.</span><br><span class="hljs-comment">       */</span><br>      <span class="hljs-keyword">if</span> (MALLOC_ALIGNMENT == <span class="hljs-number">2</span> * SIZE_SZ)<br>        size = ALIGN_UP (nb + SIZE_SZ, pagesize);<br>      <span class="hljs-keyword">else</span><br>        size = ALIGN_UP (nb + SIZE_SZ + MALLOC_ALIGN_MASK, pagesize);<br>      tried_mmap = <span class="hljs-literal">true</span>;<br><br>      <span class="hljs-comment">/* Don&#x27;t try if size wraps around 0 */</span><br>      <span class="hljs-keyword">if</span> ((<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) (size) &gt; (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) (nb))<br>        &#123;<br>          mm = (<span class="hljs-type">char</span> *) (MMAP (<span class="hljs-number">0</span>, size, PROT_READ | PROT_WRITE, <span class="hljs-number">0</span>));<br><br>          <span class="hljs-keyword">if</span> (mm != MAP_FAILED)<br>            &#123;<br>              <span class="hljs-comment">/*</span><br><span class="hljs-comment">                 The offset to the start of the mmapped region is stored</span><br><span class="hljs-comment">                 in the prev_size field of the chunk. This allows us to adjust</span><br><span class="hljs-comment">                 returned start address to meet alignment requirements here</span><br><span class="hljs-comment">                 and in memalign(), and still be able to compute proper</span><br><span class="hljs-comment">                 address argument for later munmap in free() and realloc().</span><br><span class="hljs-comment">               */</span><br><br>              <span class="hljs-keyword">if</span> (MALLOC_ALIGNMENT == <span class="hljs-number">2</span> * SIZE_SZ)<br>                &#123;<br>                  <span class="hljs-comment">/* For glibc, chunk2mem increases the address by 2*SIZE_SZ and</span><br><span class="hljs-comment">                     MALLOC_ALIGN_MASK is 2*SIZE_SZ-1.  Each mmap&#x27;ed area is page</span><br><span class="hljs-comment">                     aligned and therefore definitely MALLOC_ALIGN_MASK-aligned.  */</span><br>                  assert (((INTERNAL_SIZE_T) chunk2mem (mm) &amp; MALLOC_ALIGN_MASK) == <span class="hljs-number">0</span>);<br>                  front_misalign = <span class="hljs-number">0</span>;<br>                &#125;<br>              <span class="hljs-keyword">else</span><br>                front_misalign = (INTERNAL_SIZE_T) chunk2mem (mm) &amp; MALLOC_ALIGN_MASK;<br>              <span class="hljs-keyword">if</span> (front_misalign &gt; <span class="hljs-number">0</span>)<br>                &#123;<br>                  correction = MALLOC_ALIGNMENT - front_misalign;<br>                  p = (mchunkptr) (mm + correction);<br>                  p-&gt;prev_size = correction;<br>                  set_head (p, (size - correction) | IS_MMAPPED);<br>                &#125;<br>              <span class="hljs-keyword">else</span><br>                &#123;<br>                  p = (mchunkptr) mm;<br>                  set_head (p, size | IS_MMAPPED);<br>                &#125;<br><br>              <span class="hljs-comment">/* update statistics */</span><br><br>              <span class="hljs-type">int</span> new = atomic_exchange_and_add (&amp;mp_.n_mmaps, <span class="hljs-number">1</span>) + <span class="hljs-number">1</span>;<br>              <span class="hljs-type">atomic_max</span> (&amp;mp_.max_n_mmaps, new);<br><br>              <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> sum;<br>              sum = atomic_exchange_and_add (&amp;mp_.mmapped_mem, size) + size;<br>              <span class="hljs-type">atomic_max</span> (&amp;mp_.max_mmapped_mem, sum);<br><br>              check_chunk (av, p);<br><br>              <span class="hljs-keyword">return</span> chunk2mem (p);<br>            &#125;<br>        &#125;<br>    &#125;<br><br>  <span class="hljs-comment">/* There are no usable arenas and mmap also failed.  */</span><br>  <span class="hljs-keyword">if</span> (av == <span class="hljs-literal">NULL</span>)<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br><br>  <span class="hljs-comment">/* Record incoming configuration of top */</span><br><br>  old_top = av-&gt;top;<br>  old_size = chunksize (old_top);<br>  old_end = (<span class="hljs-type">char</span> *) (chunk_at_offset (old_top, old_size));<br><br>  brk = snd_brk = (<span class="hljs-type">char</span> *) (MORECORE_FAILURE);<br><br>  <span class="hljs-comment">/*</span><br><span class="hljs-comment">     If not the first time through, we require old_size to be</span><br><span class="hljs-comment">     at least MINSIZE and to have prev_inuse set.</span><br><span class="hljs-comment">   */</span><br><br>  assert ((old_top == initial_top (av) &amp;&amp; old_size == <span class="hljs-number">0</span>) ||<br>          ((<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) (old_size) &gt;= MINSIZE &amp;&amp;<br>           prev_inuse (old_top) &amp;&amp;<br>           ((<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) old_end &amp; (pagesize - <span class="hljs-number">1</span>)) == <span class="hljs-number">0</span>));<br><br>  <span class="hljs-comment">/* Precondition: not enough current space to satisfy nb request */</span><br>  assert ((<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) (old_size) &lt; (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) (nb + MINSIZE));<br><br><br>  <span class="hljs-keyword">if</span> (av != &amp;main_arena)<br>    &#123;<br>      heap_info *old_heap, *heap;<br>      <span class="hljs-type">size_t</span> old_heap_size;<br><br>      <span class="hljs-comment">/* First try to extend the current heap. */</span><br>      old_heap = heap_for_ptr (old_top);<br>      old_heap_size = old_heap-&gt;size;<br>      <span class="hljs-keyword">if</span> ((<span class="hljs-type">long</span>) (MINSIZE + nb - old_size) &gt; <span class="hljs-number">0</span><br>          &amp;&amp; grow_heap (old_heap, MINSIZE + nb - old_size) == <span class="hljs-number">0</span>)<br>        &#123;<br>          av-&gt;system_mem += old_heap-&gt;size - old_heap_size;<br>          arena_mem += old_heap-&gt;size - old_heap_size;<br>          set_head (old_top, (((<span class="hljs-type">char</span> *) old_heap + old_heap-&gt;size) - (<span class="hljs-type">char</span> *) old_top)<br>                    | PREV_INUSE);<br>        &#125;<br>      <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> ((heap = new_heap (nb + (MINSIZE + <span class="hljs-keyword">sizeof</span> (*heap)), mp_.top_pad)))<br>        &#123;<br>          <span class="hljs-comment">/* Use a newly allocated heap.  */</span><br>          heap-&gt;ar_ptr = av;<br>          heap-&gt;prev = old_heap;<br>          av-&gt;system_mem += heap-&gt;size;<br>          arena_mem += heap-&gt;size;<br>          <span class="hljs-comment">/* Set up the new top.  */</span><br>          top (av) = chunk_at_offset (heap, <span class="hljs-keyword">sizeof</span> (*heap));<br>          set_head (top (av), (heap-&gt;size - <span class="hljs-keyword">sizeof</span> (*heap)) | PREV_INUSE);<br><br>          <span class="hljs-comment">/* Setup fencepost and free the old top chunk with a multiple of</span><br><span class="hljs-comment">             MALLOC_ALIGNMENT in size. */</span><br>          <span class="hljs-comment">/* The fencepost takes at least MINSIZE bytes, because it might</span><br><span class="hljs-comment">             become the top chunk again later.  Note that a footer is set</span><br><span class="hljs-comment">             up, too, although the chunk is marked in use. */</span><br>          old_size = (old_size - MINSIZE) &amp; ~MALLOC_ALIGN_MASK;<br>          set_head (chunk_at_offset (old_top, old_size + <span class="hljs-number">2</span> * SIZE_SZ), <span class="hljs-number">0</span> | PREV_INUSE);<br>          <span class="hljs-keyword">if</span> (old_size &gt;= MINSIZE)<br>            &#123;<br>              set_head (chunk_at_offset (old_top, old_size), (<span class="hljs-number">2</span> * SIZE_SZ) | PREV_INUSE);<br>              set_foot (chunk_at_offset (old_top, old_size), (<span class="hljs-number">2</span> * SIZE_SZ));<br>              set_head (old_top, old_size | PREV_INUSE | NON_MAIN_ARENA);<br>              _int_free (av, old_top, <span class="hljs-number">1</span>);<br>            &#125;<br>          <span class="hljs-keyword">else</span><br>            &#123;<br>              set_head (old_top, (old_size + <span class="hljs-number">2</span> * SIZE_SZ) | PREV_INUSE);<br>              set_foot (old_top, (old_size + <span class="hljs-number">2</span> * SIZE_SZ));<br>            &#125;<br>        &#125;<br>      <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (!tried_mmap)<br>        <span class="hljs-comment">/* We can at least try to use to mmap memory.  */</span><br>        <span class="hljs-keyword">goto</span> try_mmap;<br>    &#125;<br>  <span class="hljs-keyword">else</span>     <span class="hljs-comment">/* av == main_arena */</span><br><br><br>    &#123; <span class="hljs-comment">/* Request enough space for nb + pad + overhead */</span><br>      size = nb + mp_.top_pad + MINSIZE;<br><br>      <span class="hljs-comment">/*</span><br><span class="hljs-comment">         If contiguous, we can subtract out existing space that we hope to</span><br><span class="hljs-comment">         combine with new space. We add it back later only if</span><br><span class="hljs-comment">         we don&#x27;t actually get contiguous space.</span><br><span class="hljs-comment">       */</span><br><br>      <span class="hljs-keyword">if</span> (contiguous (av))<br>        size -= old_size;<br><br>      <span class="hljs-comment">/*</span><br><span class="hljs-comment">         Round to a multiple of page size.</span><br><span class="hljs-comment">         If MORECORE is not contiguous, this ensures that we only call it</span><br><span class="hljs-comment">         with whole-page arguments.  And if MORECORE is contiguous and</span><br><span class="hljs-comment">         this is not first time through, this preserves page-alignment of</span><br><span class="hljs-comment">         previous calls. Otherwise, we correct to page-align below.</span><br><span class="hljs-comment">       */</span><br><br>      size = ALIGN_UP (size, pagesize);<br><br>      <span class="hljs-comment">/*</span><br><span class="hljs-comment">         Don&#x27;t try to call MORECORE if argument is so big as to appear</span><br><span class="hljs-comment">         negative. Note that since mmap takes size_t arg, it may succeed</span><br><span class="hljs-comment">         below even if we cannot call MORECORE.</span><br><span class="hljs-comment">       */</span><br><br>      <span class="hljs-keyword">if</span> (size &gt; <span class="hljs-number">0</span>)<br>        &#123;<br>          brk = (<span class="hljs-type">char</span> *) (MORECORE (size));<br>          LIBC_PROBE (memory_sbrk_more, <span class="hljs-number">2</span>, brk, size);<br>        &#125;<br><br>      <span class="hljs-keyword">if</span> (brk != (<span class="hljs-type">char</span> *) (MORECORE_FAILURE))<br>        &#123;<br>          <span class="hljs-comment">/* Call the `morecore&#x27; hook if necessary.  */</span><br>          <span class="hljs-type">void</span> (*hook) (<span class="hljs-type">void</span>) = atomic_forced_read (__after_morecore_hook);<br>          <span class="hljs-keyword">if</span> (__builtin_expect (hook != <span class="hljs-literal">NULL</span>, <span class="hljs-number">0</span>))<br>            (*hook)();<br>        &#125;<br>      <span class="hljs-keyword">else</span><br>        &#123;<br>          <span class="hljs-comment">/*</span><br><span class="hljs-comment">             If have mmap, try using it as a backup when MORECORE fails or</span><br><span class="hljs-comment">             cannot be used. This is worth doing on systems that have &quot;holes&quot; in</span><br><span class="hljs-comment">             address space, so sbrk cannot extend to give contiguous space, but</span><br><span class="hljs-comment">             space is available elsewhere.  Note that we ignore mmap max count</span><br><span class="hljs-comment">             and threshold limits, since the space will not be used as a</span><br><span class="hljs-comment">             segregated mmap region.</span><br><span class="hljs-comment">           */</span><br><br>          <span class="hljs-comment">/* Cannot merge with old top, so add its size back in */</span><br>          <span class="hljs-keyword">if</span> (contiguous (av))<br>            size = ALIGN_UP (size + old_size, pagesize);<br><br>          <span class="hljs-comment">/* If we are relying on mmap as backup, then use larger units */</span><br>          <span class="hljs-keyword">if</span> ((<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) (size) &lt; (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) (MMAP_AS_MORECORE_SIZE))<br>            size = MMAP_AS_MORECORE_SIZE;<br><br>          <span class="hljs-comment">/* Don&#x27;t try if size wraps around 0 */</span><br>          <span class="hljs-keyword">if</span> ((<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) (size) &gt; (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) (nb))<br>            &#123;<br>              <span class="hljs-type">char</span> *mbrk = (<span class="hljs-type">char</span> *) (MMAP (<span class="hljs-number">0</span>, size, PROT_READ | PROT_WRITE, <span class="hljs-number">0</span>));<br><br>              <span class="hljs-keyword">if</span> (mbrk != MAP_FAILED)<br>                &#123;<br>                  <span class="hljs-comment">/* We do not need, and cannot use, another sbrk call to find end */</span><br>                  brk = mbrk;<br>                  snd_brk = brk + size;<br><br>                  <span class="hljs-comment">/*</span><br><span class="hljs-comment">                     Record that we no longer have a contiguous sbrk region.</span><br><span class="hljs-comment">                     After the first time mmap is used as backup, we do not</span><br><span class="hljs-comment">                     ever rely on contiguous space since this could incorrectly</span><br><span class="hljs-comment">                     bridge regions.</span><br><span class="hljs-comment">                   */</span><br>                  set_noncontiguous (av);<br>                &#125;<br>            &#125;<br>        &#125;<br><br>      <span class="hljs-keyword">if</span> (brk != (<span class="hljs-type">char</span> *) (MORECORE_FAILURE))<br>        &#123;<br>          <span class="hljs-keyword">if</span> (mp_.sbrk_base == <span class="hljs-number">0</span>)<br>            mp_.sbrk_base = brk;<br>          av-&gt;system_mem += size;<br><br>          <span class="hljs-comment">/*</span><br><span class="hljs-comment">             If MORECORE extends previous space, we can likewise extend top size.</span><br><span class="hljs-comment">           */</span><br><br>          <span class="hljs-keyword">if</span> (brk == old_end &amp;&amp; snd_brk == (<span class="hljs-type">char</span> *) (MORECORE_FAILURE))<br>            set_head (old_top, (size + old_size) | PREV_INUSE);<br><br>          <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (contiguous (av) &amp;&amp; old_size &amp;&amp; brk &lt; old_end)<br>            &#123;<br>              <span class="hljs-comment">/* Oops!  Someone else killed our space..  Can&#x27;t touch anything.  */</span><br>              malloc_printerr (<span class="hljs-number">3</span>, <span class="hljs-string">&quot;break adjusted to free malloc space&quot;</span>, brk,<br>			       av);<br>            &#125;<br><br>          <span class="hljs-comment">/*</span><br><span class="hljs-comment">             Otherwise, make adjustments:</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">           * If the first time through or noncontiguous, we need to call sbrk</span><br><span class="hljs-comment">              just to find out where the end of memory lies.</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">           * We need to ensure that all returned chunks from malloc will meet</span><br><span class="hljs-comment">              MALLOC_ALIGNMENT</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">           * If there was an intervening foreign sbrk, we need to adjust sbrk</span><br><span class="hljs-comment">              request size to account for fact that we will not be able to</span><br><span class="hljs-comment">              combine new space with existing space in old_top.</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">           * Almost all systems internally allocate whole pages at a time, in</span><br><span class="hljs-comment">              which case we might as well use the whole last page of request.</span><br><span class="hljs-comment">              So we allocate enough more memory to hit a page boundary now,</span><br><span class="hljs-comment">              which in turn causes future contiguous calls to page-align.</span><br><span class="hljs-comment">           */</span><br><br>          <span class="hljs-keyword">else</span><br>            &#123;<br>              front_misalign = <span class="hljs-number">0</span>;<br>              end_misalign = <span class="hljs-number">0</span>;<br>              correction = <span class="hljs-number">0</span>;<br>              aligned_brk = brk;<br><br>              <span class="hljs-comment">/* handle contiguous cases */</span><br>              <span class="hljs-keyword">if</span> (contiguous (av))<br>                &#123;<br>                  <span class="hljs-comment">/* Count foreign sbrk as system_mem.  */</span><br>                  <span class="hljs-keyword">if</span> (old_size)<br>                    av-&gt;system_mem += brk - old_end;<br><br>                  <span class="hljs-comment">/* Guarantee alignment of first new chunk made from this space */</span><br><br>                  front_misalign = (INTERNAL_SIZE_T) chunk2mem (brk) &amp; MALLOC_ALIGN_MASK;<br>                  <span class="hljs-keyword">if</span> (front_misalign &gt; <span class="hljs-number">0</span>)<br>                    &#123;<br>                      <span class="hljs-comment">/*</span><br><span class="hljs-comment">                         Skip over some bytes to arrive at an aligned position.</span><br><span class="hljs-comment">                         We don&#x27;t need to specially mark these wasted front bytes.</span><br><span class="hljs-comment">                         They will never be accessed anyway because</span><br><span class="hljs-comment">                         prev_inuse of av-&gt;top (and any chunk created from its start)</span><br><span class="hljs-comment">                         is always true after initialization.</span><br><span class="hljs-comment">                       */</span><br><br>                      correction = MALLOC_ALIGNMENT - front_misalign;<br>                      aligned_brk += correction;<br>                    &#125;<br><br>                  <span class="hljs-comment">/*</span><br><span class="hljs-comment">                     If this isn&#x27;t adjacent to existing space, then we will not</span><br><span class="hljs-comment">                     be able to merge with old_top space, so must add to 2nd request.</span><br><span class="hljs-comment">                   */</span><br><br>                  correction += old_size;<br><br>                  <span class="hljs-comment">/* Extend the end address to hit a page boundary */</span><br>                  end_misalign = (INTERNAL_SIZE_T) (brk + size + correction);<br>                  correction += (ALIGN_UP (end_misalign, pagesize)) - end_misalign;<br><br>                  assert (correction &gt;= <span class="hljs-number">0</span>);<br>                  snd_brk = (<span class="hljs-type">char</span> *) (MORECORE (correction));<br><br>                  <span class="hljs-comment">/*</span><br><span class="hljs-comment">                     If can&#x27;t allocate correction, try to at least find out current</span><br><span class="hljs-comment">                     brk.  It might be enough to proceed without failing.</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">                     Note that if second sbrk did NOT fail, we assume that space</span><br><span class="hljs-comment">                     is contiguous with first sbrk. This is a safe assumption unless</span><br><span class="hljs-comment">                     program is multithreaded but doesn&#x27;t use locks and a foreign sbrk</span><br><span class="hljs-comment">                     occurred between our first and second calls.</span><br><span class="hljs-comment">                   */</span><br><br>                  <span class="hljs-keyword">if</span> (snd_brk == (<span class="hljs-type">char</span> *) (MORECORE_FAILURE))<br>                    &#123;<br>                      correction = <span class="hljs-number">0</span>;<br>                      snd_brk = (<span class="hljs-type">char</span> *) (MORECORE (<span class="hljs-number">0</span>));<br>                    &#125;<br>                  <span class="hljs-keyword">else</span><br>                    &#123;<br>                      <span class="hljs-comment">/* Call the `morecore&#x27; hook if necessary.  */</span><br>                      <span class="hljs-type">void</span> (*hook) (<span class="hljs-type">void</span>) = atomic_forced_read (__after_morecore_hook);<br>                      <span class="hljs-keyword">if</span> (__builtin_expect (hook != <span class="hljs-literal">NULL</span>, <span class="hljs-number">0</span>))<br>                        (*hook)();<br>                    &#125;<br>                &#125;<br><br>              <span class="hljs-comment">/* handle non-contiguous cases */</span><br>              <span class="hljs-keyword">else</span><br>                &#123;<br>                  <span class="hljs-keyword">if</span> (MALLOC_ALIGNMENT == <span class="hljs-number">2</span> * SIZE_SZ)<br>                    <span class="hljs-comment">/* MORECORE/mmap must correctly align */</span><br>                    assert (((<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) chunk2mem (brk) &amp; MALLOC_ALIGN_MASK) == <span class="hljs-number">0</span>);<br>                  <span class="hljs-keyword">else</span><br>                    &#123;<br>                      front_misalign = (INTERNAL_SIZE_T) chunk2mem (brk) &amp; MALLOC_ALIGN_MASK;<br>                      <span class="hljs-keyword">if</span> (front_misalign &gt; <span class="hljs-number">0</span>)<br>                        &#123;<br>                          <span class="hljs-comment">/*</span><br><span class="hljs-comment">                             Skip over some bytes to arrive at an aligned position.</span><br><span class="hljs-comment">                             We don&#x27;t need to specially mark these wasted front bytes.</span><br><span class="hljs-comment">                             They will never be accessed anyway because</span><br><span class="hljs-comment">                             prev_inuse of av-&gt;top (and any chunk created from its start)</span><br><span class="hljs-comment">                             is always true after initialization.</span><br><span class="hljs-comment">                           */</span><br><br>                          aligned_brk += MALLOC_ALIGNMENT - front_misalign;<br>                        &#125;<br>                    &#125;<br><br>                  <span class="hljs-comment">/* Find out current end of memory */</span><br>                  <span class="hljs-keyword">if</span> (snd_brk == (<span class="hljs-type">char</span> *) (MORECORE_FAILURE))<br>                    &#123;<br>                      snd_brk = (<span class="hljs-type">char</span> *) (MORECORE (<span class="hljs-number">0</span>));<br>                    &#125;<br>                &#125;<br><br>              <span class="hljs-comment">/* Adjust top based on results of second sbrk */</span><br>              <span class="hljs-keyword">if</span> (snd_brk != (<span class="hljs-type">char</span> *) (MORECORE_FAILURE))<br>                &#123;<br>                  av-&gt;top = (mchunkptr) aligned_brk;<br>                  set_head (av-&gt;top, (snd_brk - aligned_brk + correction) | PREV_INUSE);<br>                  av-&gt;system_mem += correction;<br><br>                  <span class="hljs-comment">/*</span><br><span class="hljs-comment">                     If not the first time through, we either have a</span><br><span class="hljs-comment">                     gap due to foreign sbrk or a non-contiguous region.  Insert a</span><br><span class="hljs-comment">                     double fencepost at old_top to prevent consolidation with space</span><br><span class="hljs-comment">                     we don&#x27;t own. These fenceposts are artificial chunks that are</span><br><span class="hljs-comment">                     marked as inuse and are in any case too small to use.  We need</span><br><span class="hljs-comment">                     two to make sizes and alignments work out.</span><br><span class="hljs-comment">                   */</span><br><br>                  <span class="hljs-keyword">if</span> (old_size != <span class="hljs-number">0</span>)<br>                    &#123;<br>                      <span class="hljs-comment">/*</span><br><span class="hljs-comment">                         Shrink old_top to insert fenceposts, keeping size a</span><br><span class="hljs-comment">                         multiple of MALLOC_ALIGNMENT. We know there is at least</span><br><span class="hljs-comment">                         enough space in old_top to do this.</span><br><span class="hljs-comment">                       */</span><br>                      old_size = (old_size - <span class="hljs-number">4</span> * SIZE_SZ) &amp; ~MALLOC_ALIGN_MASK;<br>                      set_head (old_top, old_size | PREV_INUSE);<br><br>                      <span class="hljs-comment">/*</span><br><span class="hljs-comment">                         Note that the following assignments completely overwrite</span><br><span class="hljs-comment">                         old_top when old_size was previously MINSIZE.  This is</span><br><span class="hljs-comment">                         intentional. We need the fencepost, even if old_top otherwise gets</span><br><span class="hljs-comment">                         lost.</span><br><span class="hljs-comment">                       */</span><br>                      chunk_at_offset (old_top, old_size)-&gt;size =<br>                        (<span class="hljs-number">2</span> * SIZE_SZ) | PREV_INUSE;<br><br>                      chunk_at_offset (old_top, old_size + <span class="hljs-number">2</span> * SIZE_SZ)-&gt;size =<br>                        (<span class="hljs-number">2</span> * SIZE_SZ) | PREV_INUSE;<br><br>                      <span class="hljs-comment">/* If possible, release the rest. */</span><br>                      <span class="hljs-keyword">if</span> (old_size &gt;= MINSIZE)<br>                        &#123;<br>                          _int_free (av, old_top, <span class="hljs-number">1</span>);<br>                        &#125;<br>                    &#125;<br>                &#125;<br>            &#125;<br>        &#125;<br>    &#125; <span class="hljs-comment">/* if (av !=  &amp;main_arena) */</span><br><br>  <span class="hljs-keyword">if</span> ((<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) av-&gt;system_mem &gt; (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) (av-&gt;max_system_mem))<br>    av-&gt;max_system_mem = av-&gt;system_mem;<br>  check_malloc_state (av);<br><br>  <span class="hljs-comment">/* finally, do the allocation */</span><br>  p = av-&gt;top;<br>  size = chunksize (p);<br><br>  <span class="hljs-comment">/* check that one of the above allocation paths succeeded */</span><br>  <span class="hljs-keyword">if</span> ((<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) (size) &gt;= (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) (nb + MINSIZE))<br>    &#123;<br>      remainder_size = size - nb;<br>      remainder = chunk_at_offset (p, nb);<br>      av-&gt;top = remainder;<br>      set_head (p, nb | PREV_INUSE | (av != &amp;main_arena ? NON_MAIN_ARENA : <span class="hljs-number">0</span>));<br>      set_head (remainder, remainder_size | PREV_INUSE);<br>      check_malloced_chunk (av, p, nb);<br>      <span class="hljs-keyword">return</span> chunk2mem (p);<br>    &#125;<br><br>  <span class="hljs-comment">/* catch all failure paths */</span><br>  __set_errno (ENOMEM);<br>  <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure>



<h1 id="0x05-new-heapï¼š"><a href="#0x05-new-heapï¼š" class="headerlink" title="0x05.new_heapï¼š"></a>0x05.new_heapï¼š</h1><p>å®šä¹‰äºarena.cä¸­ï¼Œ<strong>ç”¨ä»¥é€šè¿‡mmapç³»ç»Ÿè°ƒç”¨åˆ†é…å†…å­˜</strong>ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/* Create a new heap.  size is automatically rounded up to a multiple</span><br><span class="hljs-comment">   of the page size. */</span><br><br><span class="hljs-type">static</span> heap_info *<br>internal_function<br><span class="hljs-title function_">new_heap</span> <span class="hljs-params">(<span class="hljs-type">size_t</span> size, <span class="hljs-type">size_t</span> top_pad)</span><br>&#123;<br>  <span class="hljs-type">size_t</span> pagesize = GLRO (dl_pagesize);<br>  <span class="hljs-type">char</span> *p1, *p2;<br>  <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> ul;<br>  heap_info *h;<br><br>  <span class="hljs-keyword">if</span> (size + top_pad &lt; HEAP_MIN_SIZE)<br>    size = HEAP_MIN_SIZE;<br>  <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (size + top_pad &lt;= HEAP_MAX_SIZE)<br>    size += top_pad;<br>  <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (size &gt; HEAP_MAX_SIZE)<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>  <span class="hljs-keyword">else</span><br>    size = HEAP_MAX_SIZE;<br>  size = ALIGN_UP (size, pagesize);<br><br>  <span class="hljs-comment">/* A memory region aligned to a multiple of HEAP_MAX_SIZE is needed.</span><br><span class="hljs-comment">     No swap space needs to be reserved for the following large</span><br><span class="hljs-comment">     mapping (on Linux, this is the case for all non-writable mappings</span><br><span class="hljs-comment">     anyway). */</span><br>  p2 = MAP_FAILED;<br>  <span class="hljs-keyword">if</span> (aligned_heap_area)<br>    &#123;<br>      p2 = (<span class="hljs-type">char</span> *) MMAP (aligned_heap_area, HEAP_MAX_SIZE, PROT_NONE,<br>                          MAP_NORESERVE);<br>      aligned_heap_area = <span class="hljs-literal">NULL</span>;<br>      <span class="hljs-keyword">if</span> (p2 != MAP_FAILED &amp;&amp; ((<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) p2 &amp; (HEAP_MAX_SIZE - <span class="hljs-number">1</span>)))<br>        &#123;<br>          __munmap (p2, HEAP_MAX_SIZE);<br>          p2 = MAP_FAILED;<br>        &#125;<br>    &#125;<br>  <span class="hljs-keyword">if</span> (p2 == MAP_FAILED)<br>    &#123;<br>      p1 = (<span class="hljs-type">char</span> *) MMAP (<span class="hljs-number">0</span>, HEAP_MAX_SIZE &lt;&lt; <span class="hljs-number">1</span>, PROT_NONE, MAP_NORESERVE);<br>      <span class="hljs-keyword">if</span> (p1 != MAP_FAILED)<br>        &#123;<br>          p2 = (<span class="hljs-type">char</span> *) (((<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) p1 + (HEAP_MAX_SIZE - <span class="hljs-number">1</span>))<br>                         &amp; ~(HEAP_MAX_SIZE - <span class="hljs-number">1</span>));<br>          ul = p2 - p1;<br>          <span class="hljs-keyword">if</span> (ul)<br>            __munmap (p1, ul);<br>          <span class="hljs-keyword">else</span><br>            aligned_heap_area = p2 + HEAP_MAX_SIZE;<br>          __munmap (p2 + HEAP_MAX_SIZE, HEAP_MAX_SIZE - ul);<br>        &#125;<br>      <span class="hljs-keyword">else</span><br>        &#123;<br>          <span class="hljs-comment">/* Try to take the chance that an allocation of only HEAP_MAX_SIZE</span><br><span class="hljs-comment">             is already aligned. */</span><br>          p2 = (<span class="hljs-type">char</span> *) MMAP (<span class="hljs-number">0</span>, HEAP_MAX_SIZE, PROT_NONE, MAP_NORESERVE);<br>          <span class="hljs-keyword">if</span> (p2 == MAP_FAILED)<br>            <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br><br>          <span class="hljs-keyword">if</span> ((<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) p2 &amp; (HEAP_MAX_SIZE - <span class="hljs-number">1</span>))<br>            &#123;<br>              __munmap (p2, HEAP_MAX_SIZE);<br>              <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>            &#125;<br>        &#125;<br>    &#125;<br>  <span class="hljs-keyword">if</span> (__mprotect (p2, size, PROT_READ | PROT_WRITE) != <span class="hljs-number">0</span>)<br>    &#123;<br>      __munmap (p2, HEAP_MAX_SIZE);<br>      <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>    &#125;<br>  h = (heap_info *) p2;<br>  h-&gt;size = size;<br>  h-&gt;mprotect_size = size;<br>  LIBC_PROBE (memory_heap_new, <span class="hljs-number">2</span>, h, h-&gt;size);<br>  <span class="hljs-keyword">return</span> h;<br>&#125;<br></code></pre></td></tr></table></figure>


                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
    <div class="post-meta mr-3 d-flex align-items-center">
      <i class="iconfont icon-category"></i>
      

<span class="category-chains">
  
  
    
      <span class="category-chain">
        
  <a href="/categories/GLIBC/" class="category-chain-item">GLIBC</a>
  
  

      </span>
    
  
</span>

    </div>
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86/">#å†…å­˜ç®¡ç†</a>
      
        <a href="/tags/%E5%A0%86/">#å †</a>
      
        <a href="/tags/ptmalloc/">#ptmalloc</a>
      
        <a href="/tags/glibc/">#glibc</a>
      
    </div>
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>ã€GLIBC.0x01ã€‘glibc2.23 mallocæºç åˆ†æ - IIï¼šmalloc</div>
      <div>http://example.com/2021/01/15/GLIBC-0X01-MALLOC-2.23-PART-II/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>ä½œè€…</div>
          <div>arttnba3</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>å‘å¸ƒäº</div>
          <div>2021å¹´1æœˆ15æ—¥</div>
        </div>
      
      
      <div class="license-meta-item">
        <div>è®¸å¯åè®®</div>
        <div>
          
            
            
              <a target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
              <span class="hint--top hint--rounded" aria-label="BY - ç½²å">
                <i class="iconfont icon-by"></i>
              </span>
              </a>
            
          
        </div>
      </div>
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2021/01/20/CTF-0X02-STARCTF2021-PWN/" title="ã€CTF.0X02ã€‘*CTF2021-Pwn WP">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">ã€CTF.0X02ã€‘*CTF2021-Pwn WP</span>
                        <span class="visible-mobile">ä¸Šä¸€ç¯‡</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2021/01/15/GLIBC-0X00-MALLOC-2.23-PART-I/" title="ã€GLIBC.0x00ã€‘glibc2.23 mallocæºç åˆ†æ - Iï¼šå †å†…å­˜çš„åŸºæœ¬ç»„ç»‡å½¢å¼">
                        <span class="hidden-mobile">ã€GLIBC.0x00ã€‘glibc2.23 mallocæºç åˆ†æ - Iï¼šå †å†…å­˜çš„åŸºæœ¬ç»„ç»‡å½¢å¼</span>
                        <span class="visible-mobile">ä¸‹ä¸€ç¯‡</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
  <article id="comments" lazyload>
    
  <div id="valine"></div>
  <script type="text/javascript">
    Fluid.utils.loadComments('#valine', function() {
      Fluid.utils.createScript('https://lib.baomitu.com/valine/1.4.17/Valine.min.js', function() {
        var options = Object.assign(
          {"appid":"ICj6cPRQWFTNiOttBHlzxnIv-gzGzoHsz","appkey":"tuvJh3xYxPFcW2JB6K26RKP2","path":"window.location.pathname","placeholder":"è¯´ç‚¹ä»€ä¹ˆå‘—ï¼ˆç¬‘ï¼‰","avatar":"retro","meta":["nick","mail","link"],"requiredFields":[],"pageSize":10,"lang":"zh-CN","highlight":false,"recordIP":false,"serverURLs":"","emojiCDN":null,"emojiMaps":null,"enableQQ":false,"appId":"ICj6cPRQWFTNiOttBHlzxnIv-gzGzoHsz","appKey":"tuvJh3xYxPFcW2JB6K26RKP2"},
          {
            el: "#valine",
            path: window.location.pathname
          }
        )
        new Valine(options);
        Fluid.utils.waitElementVisible('#valine .vcontent', () => {
          var imgSelector = '#valine .vcontent img:not(.vemoji)';
          Fluid.plugins.imageCaption(imgSelector);
          Fluid.plugins.fancyBox(imgSelector);
        })
      });
    });
  </script>
  <noscript>Please enable JavaScript to view the comments</noscript>


  </article>


          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;ç›®å½•</p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  


  
  









    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">æœç´¢</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">å…³é”®è¯</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  <!-- ç½‘ç«™è¿è¡Œæ—¶é—´çš„è®¾ç½® -->
  <span id="timeDate">è½½å…¥å¤©æ•°...</span>
  <span id="times">è½½å…¥æ—¶åˆ†ç§’...</span>
  <script>
      var now = new Date();
      function createtime() {
          var grt= new Date("04/20/2020 17:48:48");//æ­¤å¤„ä¿®æ”¹ä½ çš„å»ºç«™æ—¶é—´æˆ–è€…ç½‘ç«™ä¸Šçº¿æ—¶é—´
          now.setTime(now.getTime()+250);
          days = (now - grt ) / 1000 / 60 / 60 / 24; dnum = Math.floor(days);
          hours = (now - grt ) / 1000 / 60 / 60 - (24 * dnum); hnum = Math.floor(hours);
          if(String(hnum).length ==1 ){hnum = "0" + hnum;} minutes = (now - grt ) / 1000 /60 - (24 * 60 * dnum) - (60 * hnum);
          mnum = Math.floor(minutes); if(String(mnum).length ==1 ){mnum = "0" + mnum;}
          seconds = (now - grt ) / 1000 - (24 * 60 * 60 * dnum) - (60 * 60 * hnum) - (60 * mnum);
          snum = Math.round(seconds); if(String(snum).length ==1 ){snum = "0" + snum;}
          document.getElementById("timeDate").innerHTML = "arttnba3çš„å°å±‹å·²ç»å®‰å…¨å­˜åœ¨äº† "+dnum+" å¤© ";
          document.getElementById("times").innerHTML = hnum + " å°æ—¶ " + mnum + " åˆ† " + snum + " ç§’";
      }
  setInterval("createtime()",250);
  </script>
  
    <div class="footer-content">
       <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
    </div>
  
  
    <div class="statistics">
  
  

  
    
      <span id="busuanzi_container_site_pv" style="display: none">
        æ€»è®¿é—®é‡ 
        <span id="busuanzi_value_site_pv"></span>
         æ¬¡
      </span>
    
    
      <span id="busuanzi_container_site_uv" style="display: none">
        æ€»è®¿å®¢æ•° 
        <span id="busuanzi_value_site_uv"></span>
         äºº
      </span>
    
    
  
</div>

  
  
    <!-- å¤‡æ¡ˆä¿¡æ¯ ICP for China -->
    <div class="beian">
  <span>
    <a href="http://beian.miit.gov.cn/" target="_blank" rel="nofollow noopener">
      æ¡‚ICPå¤‡2022005068å·-1
    </a>
  </span>
  
</div>

  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.0/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.18.2/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      headingSelector : CONFIG.toc.headingSelector || 'h1,h2,h3,h4,h5,h6',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      collapseDepth   : CONFIG.toc.collapseDepth || 0,
      scrollSmooth    : true,
      headingsOffset  : -boardTop
    });
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.10/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  
      <script>
        if (!window.MathJax) {
          window.MathJax = {
            tex    : {
              inlineMath: { '[+]': [['$', '$']] }
            },
            loader : {
              load: ['ui/lazy']
            },
            options: {
              renderActions: {
                insertedScript: [200, () => {
                  document.querySelectorAll('mjx-container').forEach(node => {
                    let target = node.parentNode;
                    if (target.nodeName.toLowerCase() === 'li') {
                      target.parentNode.classList.add('has-jax');
                    }
                  });
                }, '', false]
              }
            }
          };
        } else {
          MathJax.startup.document.state(0);
          MathJax.texReset();
          MathJax.typeset();
          MathJax.typesetPromise();
        }
      </script>
    

  <script  src="https://lib.baomitu.com/mathjax/3.2.1/es5/tex-mml-chtml.js" ></script>

  <script  src="/js/local-search.js" ></script>

  <script defer src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" ></script>





<!-- ä¸»é¢˜çš„å¯åŠ¨é¡¹ï¼Œå°†å®ƒä¿æŒåœ¨æœ€åº•éƒ¨ -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">åšå®¢åœ¨å…è®¸ JavaScript è¿è¡Œçš„ç¯å¢ƒä¸‹æµè§ˆæ•ˆæœæ›´ä½³</div>
  </noscript>
</body>
</html>
