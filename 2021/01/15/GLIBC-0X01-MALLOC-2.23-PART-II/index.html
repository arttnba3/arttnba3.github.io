<!DOCTYPE html>
<html lang="zh-CN" color-mode="light">

  <head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="keywords" content="" />
  <meta name="author" content="arttnba3" />
  <meta name="description" content="ã‚ãŒã„ãŸå¤¢ã‚’æ¨ã¦ã¦æºã‚Œã‚‹ä»Šæ—¥ã¯çœ ã£ã¦èª¤é­”åŒ–ã›" />
  
  
  <title>
    
      ã€GLIBC.0x01ã€‘glibc2.23 mallocæºç åˆ†æ - IIï¼šmalloc 
      
      
      |
    
     arttnba3&#39;s blog
  </title>

  
    <link rel="apple-touch-icon" href="/img/favicon.png">
    <link rel="icon" href="/img/favicon.png">
  

  <!-- Raleway-Font -->
  <link href="https://fonts.googleapis.com/css?family=Raleway&display=swap" rel="stylesheet">

  <!-- hexo site css -->
  
<link rel="stylesheet" href="/css/color-scheme.css">
<link rel="stylesheet" href="/css/base.css">
<link rel="stylesheet" href="//at.alicdn.com/t/font_1886449_67xjft27j1l.css">
<link rel="stylesheet" href="/css/github-markdown.css">
<link rel="stylesheet" href="/css/highlight.css">
<link rel="stylesheet" href="/css/comments.css">

  <!-- ä»£ç å—é£æ ¼ -->
  

  <!-- jquery3.3.1 -->
  
    <script defer type="text/javascript" src="/plugins/jquery.min.js"></script>
  

  <!-- fancybox -->
  
    <link href="/plugins/jquery.fancybox.min.css" rel="stylesheet">
    <script defer type="text/javascript" src="/plugins/jquery.fancybox.min.js"></script>
  
  
<script src="/js/fancybox.js"></script>


  

  <script>
    var html = document.documentElement
    const colorMode = localStorage.getItem('color-mode')
    if (colorMode) {
      document.documentElement.setAttribute('color-mode', colorMode)
    }
  </script>
<meta name="generator" content="Hexo 6.2.0"><link rel="alternate" href="/atom.xml" title="arttnba3's blog" type="application/atom+xml">
</head>


  <body>
    <div id="app">
      <div class="header">
  <div class="avatar">
    <a target="_blank" rel="noopener" href="https://arttnba3.cn">
      <!-- å¤´åƒå–æ¶ˆæ‡’åŠ è½½ï¼Œæ·»åŠ no-lazy -->
      
        <img src="/img/avatar.png" alt="">
      
    </a>
    <div class="nickname"><a target="_blank" rel="noopener" href="https://arttnba3.cn">arttnba3's blog</a></div>
  </div>
  <div class="navbar">
    <ul>
      
        <li class="nav-item" data-path="/">
          <a href="/">Home</a>
        </li>
      
        <li class="nav-item" data-path="/archives/">
          <a href="/archives/">Archives</a>
        </li>
      
        <li class="nav-item" data-path="/categories/">
          <a href="/categories/">Categories</a>
        </li>
      
        <li class="nav-item" data-path="/tags/">
          <a href="/tags/">Tags</a>
        </li>
      
        <li class="nav-item" data-path="/friends/">
          <a href="/friends/">Friends</a>
        </li>
      
        <li class="nav-item" data-path="/about/">
          <a href="/about/">About</a>
        </li>
      
    </ul>
  </div>
</div>


<script src="/js/activeNav.js"></script>



      <div class="flex-container">
        <!-- æ–‡ç« è¯¦æƒ…é¡µï¼Œå±•ç¤ºæ–‡ç« å…·ä½“å†…å®¹ï¼Œurlå½¢å¼ï¼šhttps://yoursite/æ–‡ç« æ ‡é¢˜/ -->
<!-- åŒæ—¶ä¸ºã€Œæ ‡ç­¾tagã€ï¼Œã€Œæœ‹å‹friendã€ï¼Œã€Œåˆ†ç±»categoriesã€ï¼Œã€Œå…³äºaboutã€é¡µé¢çš„æ‰¿è½½é¡µé¢ï¼Œå…·ä½“å±•ç¤ºå–å†³äºpage.type -->


  <!-- LaTex Display -->

  
    <script async type="text/javascript" src="/plugins/mathjax/tex-chtml.js"></script>
  
  <script>
    MathJax = {
      tex: {
        inlineMath: [['$', '$'], ['\\(', '\\)']]
      }
    }
  </script>





  <!-- clipboard -->

  
    <script async type="text/javascript" src="/plugins/clipboard.min.js"></script>
  
  
<script src="/js/codeCopy.js"></script>







  

  

  

  
  <!-- æ–‡ç« å†…å®¹é¡µ urlå½¢å¼ï¼šhttps://yoursite/æ–‡ç« æ ‡é¢˜/ -->
  <div class="container post-details" id="post-details">
    <div class="post-content">
      <div class="post-title">ã€GLIBC.0x01ã€‘glibc2.23 mallocæºç åˆ†æ - IIï¼šmalloc</div>
      <div class="post-attach">
        <span class="post-pubtime">
          <i class="iconfont icon-updatetime" title="æ›´æ–°æ—¶é—´"></i>
          2021-01-15 20:17:03
        </span>
        
              <span class="post-categories">
                <i class="iconfont icon-bookmark" title="åˆ†ç±»"></i>
                
                <span class="span--category">
                  <a href="/categories/GLIBC/" title="GLIBC">
                    <b>#</b> GLIBC
                  </a>
                </span>
                
              </span>
          
              <span class="post-tags">
                <i class="iconfont icon-tags" title="æ ‡ç­¾"></i>
                
                <span class="span--tag">
                  <a href="/tags/%E5%AD%A6%E4%B9%A0%E6%9C%AD%E8%AE%B0/" title="å­¦ä¹ æœ­è®°">
                    <b>#</b> å­¦ä¹ æœ­è®°
                  </a>
                </span>
                
                <span class="span--tag">
                  <a href="/tags/ptmalloc/" title="ptmalloc">
                    <b>#</b> ptmalloc
                  </a>
                </span>
                
                <span class="span--tag">
                  <a href="/tags/glibc/" title="glibc">
                    <b>#</b> glibc
                  </a>
                </span>
                
                <span class="span--tag">
                  <a href="/tags/%E5%A0%86-%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86/" title="å † - å†…å­˜ç®¡ç†">
                    <b>#</b> å † - å†…å­˜ç®¡ç†
                  </a>
                </span>
                
              </span>
          
      </div>
      <div class="markdown-body">
        <p>ç®€ç®€å•å•æ³„éœ²ä¸ªå†…å­˜</p>
<span id="more"></span>

<h1 id="0x00-malloc"><a href="#0x00-malloc" class="headerlink" title="0x00.malloc"></a>0x00.malloc</h1><p>æˆ‘ä»¬åœ¨ç¼–å†™Cè¯­è¨€ç¨‹åºéœ€è¦åŠ¨æ€åˆ†é…ä¸€å—åˆé€‚å¤§å°çš„å†…å­˜æ—¶ï¼Œæˆ‘ä»¬é€šå¸¸éƒ½è¦ç”¨åˆ°mallocå‡½æ•°ï¼ˆåŒ…æ‹¬C++çš„newè¿ç®—ç¬¦çš„ä¸€ç§å®ç°æ–¹å¼ä¾¿æ˜¯å°è£…äº†mallocï¼‰</p>
<p>glibcæºç ä¸­å¯¹äºmallocå‡½æ•°çš„å®šä¹‰å¦‚ä¸‹ï¼š</p>
<p>é¦–å…ˆæˆ‘ä»¬åœ¨<strong>malloc&#x2F;malloc.h</strong>æ–‡ä»¶ä¸­å¯ä»¥çœ‹åˆ°å¯¹mallocå‡½æ•°çš„å¤–éƒ¨å¼•ç”¨å£°æ˜:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Allocate SIZE bytes of memory.  */</span></span><br><span class="line"><span class="keyword">extern</span> <span class="type">void</span> *<span class="title function_">malloc</span> <span class="params">(<span class="type">size_t</span> __size)</span> __THROW __attribute_malloc__ __wur;</span><br></pre></td></tr></table></figure>

<p>åœ¨è¿™é‡Œæˆ‘ä»¬ä¼šçœ‹åˆ°ä¸‰ä¸ªå¥‡æ€ªçš„ç¬¦å·ï¼š<code>__THROW</code>ã€<code>__attribute_malloc__</code>ã€<code>__wur</code>ï¼Œ<del>ä¼¼ä¹å¸¸è§„çš„Cè¯­è¨€æ•™ç§‘ä¹¦ä¸Šå¹¶æ²¡æœ‰ä»‹ç»è¿‡è¿™æ ·å¥‡æ€ªçš„ä¸œè¥¿</del></p>
<h2 id="THROWï¼šC-ä¸‹ä¸æŠ›å‡ºå¼‚å¸¸"><a href="#THROWï¼šC-ä¸‹ä¸æŠ›å‡ºå¼‚å¸¸" class="headerlink" title="__THROWï¼šC++ä¸‹ä¸æŠ›å‡ºå¼‚å¸¸"></a>__THROWï¼šC++ä¸‹ä¸æŠ›å‡ºå¼‚å¸¸</h2><p>æ˜¯ä¸€ä¸ªå®å®šä¹‰ï¼Œå®šä¹‰äºmisc&#x2F;sys&#x2F;cddefs.hä¸‹ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* GCC can always grok prototypes.  For C++ programs we add throw()</span></span><br><span class="line"><span class="comment">   to help it optimize the function calls.  But this works only with</span></span><br><span class="line"><span class="comment">   gcc 2.8.x and egcs.  For gcc 3.2 and up we even mark C functions</span></span><br><span class="line"><span class="comment">   as non-throwing using a function attribute since programs can use</span></span><br><span class="line"><span class="comment">   the -fexceptions options for C code as well.  */</span></span><br><span class="line"><span class="meta"># <span class="keyword">if</span> !defined __cplusplus &amp;&amp; __GNUC_PREREQ (3, 3)</span></span><br><span class="line"><span class="meta">#  <span class="keyword">define</span> __THROW	__attribute__ ((__nothrow__ __LEAF))</span></span><br><span class="line"><span class="meta">#  <span class="keyword">define</span> __THROWNL	__attribute__ ((__nothrow__))</span></span><br><span class="line"><span class="meta">#  <span class="keyword">define</span> __NTH(fct)	__attribute__ ((__nothrow__ __LEAF)) fct</span></span><br><span class="line"><span class="meta"># <span class="keyword">else</span></span></span><br><span class="line"><span class="meta">#  <span class="keyword">if</span> defined __cplusplus &amp;&amp; __GNUC_PREREQ (2,8)</span></span><br><span class="line"><span class="meta">#   <span class="keyword">define</span> __THROW	throw ()</span></span><br><span class="line"><span class="meta">#   <span class="keyword">define</span> __THROWNL	throw ()</span></span><br><span class="line"><span class="meta">#   <span class="keyword">define</span> __NTH(fct)	__LEAF_ATTR fct throw ()</span></span><br><span class="line"><span class="meta">#  <span class="keyword">else</span></span></span><br><span class="line"><span class="meta">#   <span class="keyword">define</span> __THROW</span></span><br><span class="line"><span class="meta">#   <span class="keyword">define</span> __THROWNL</span></span><br><span class="line"><span class="meta">#   <span class="keyword">define</span> __NTH(fct)	fct</span></span><br><span class="line"><span class="meta">#  <span class="keyword">endif</span></span></span><br><span class="line"><span class="meta"># <span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure>

<p><strong>è‹¥æ˜¯åœ¨C++ç¯å¢ƒ</strong>ï¼Œè¡¨æ˜è¯¥å‡½æ•°ä¸ä¼šæ‰”å‡ºå¼‚å¸¸ï¼Œä»¥é¿å…ç¼–è¯‘å™¨ç”Ÿæˆå¯¹å¼‚å¸¸çš„å¤„ç†ä»£ç ï¼Œä»è€Œä¼˜åŒ–ä»£ç ç”Ÿæˆç»“æœ.</p>
<p><strong>åœ¨Cç¯å¢ƒä¸‹æ²¡æœ‰ä»»ä½•æ•ˆæœ</strong></p>
<h2 id="attribute-malloc-ï¼šä¼˜åŒ–mallocç±»å‹å‡½æ•°"><a href="#attribute-malloc-ï¼šä¼˜åŒ–mallocç±»å‹å‡½æ•°" class="headerlink" title="__attribute_malloc__ï¼šä¼˜åŒ–mallocç±»å‹å‡½æ•°"></a>__attribute_malloc__ï¼šä¼˜åŒ–mallocç±»å‹å‡½æ•°</h2><p>è¿™ä¸ªç¬¦å·åŒæ ·å®šä¹‰äºmisc&#x2F;sys&#x2F;cdefs.hä¸‹</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* At some point during the gcc 2.96 development the `malloc&#x27; attribute</span></span><br><span class="line"><span class="comment">   for functions was introduced.  We don&#x27;t want to use it unconditionally</span></span><br><span class="line"><span class="comment">   (although this would be possible) since it generates warnings.  */</span></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> __GNUC_PREREQ (2,96)</span></span><br><span class="line"><span class="meta"># <span class="keyword">define</span> __attribute_malloc__ __attribute__ ((__malloc__))</span></span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line"><span class="meta"># <span class="keyword">define</span> __attribute_malloc__ <span class="comment">/* Ignore */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure>

<p>å¯¹äºgcc2.96åŠä»¥ä¸Šçš„ç‰ˆæœ¬ï¼Œè¯¥æ®µä»£ç å°†ä¼šä½¿ç”¨ç¼–è¯‘å™¨çš„__attribute__æŒ‡ä»¤</p>
<p>æŸ¥é˜…gccæ‰‹å†Œä¸­è¯´æ˜å¦‚ä¸‹ï¼š</p>
<blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">malloc</span><br></pre></td></tr></table></figure>

<p>Using this attribute can improve optimization. Compiler predicts that a function with the attribute returns non-null in most cases. Functions like <code>malloc</code> and <code>calloc</code> have this property because they return a pointer to uninitialized or zeroed-out storage. However, functions like <code>realloc</code> do not have this property, as they can return a pointer to storage containing pointers.</p>
</blockquote>
<p>å¤§æ„æ˜¯mallocä½œä¸ºä¸€ç§attributeå¯ä»¥ç”¨æ¥ä¼˜åŒ–ç±»ä¼¼mallocã€callocç­‰å†…å­˜åˆ†é…å‡½æ•°çš„ä»£ç ï¼Œ<del>æˆ‘è‡ªå·±æ˜¯å£°æ˜ç”¨æ¥ä¼˜åŒ–åƒæˆ‘è‡ªå·±è¿™æ ·çš„å‡½æ•°çš„</del>ï¼ŒåŒæ—¶ä¹Ÿé˜æ˜äº†<strong>reallocå‡½æ•°å¹¶ä¸ä½¿ç”¨è¿™æ ·ä¸€ä¸ªattributeç‰¹æ€§ï¼Œå› ä¸ºreallocå‡½æ•°å¯èƒ½ä¼šè¿”å›æŒ‡å‘åŒ…å«æœ‰å…¶ä»–æŒ‡é’ˆçš„å†…å­˜å—çš„æŒ‡é’ˆ</strong></p>
<p>å¯¹äºgcc2.96ä»¥ä¸‹çš„ç‰ˆæœ¬ï¼Œå®å®šä¹‰__attribute_malloc__<strong>æ˜¯æ— æ•ˆçš„</strong></p>
<blockquote>
<h4 id="GNUC-PREREQ"><a href="#GNUC-PREREQ" class="headerlink" title="__GNUC_PREREQ()"></a>__GNUC_PREREQ()</h4><p>å®šä¹‰äºsys&#x2F;features.hä¸‹</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Convenience macros to test the versions of glibc and gcc.</span></span><br><span class="line"><span class="comment">Use them like this:</span></span><br><span class="line"><span class="comment">#if __GNUC_PREREQ (2,8)</span></span><br><span class="line"><span class="comment">... code requiring gcc 2.8 or later ...</span></span><br><span class="line"><span class="comment">#endif</span></span><br><span class="line"><span class="comment">Note - they won&#x27;t work for gcc1 or glibc1, since the _MINOR macros</span></span><br><span class="line"><span class="comment">were not defined then.  */</span></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> defined __GNUC__ &amp;&amp; defined __GNUC_MINOR__</span></span><br><span class="line"><span class="meta"># <span class="keyword">define</span> __GNUC_PREREQ(maj, min) \</span></span><br><span class="line"><span class="meta">	((__GNUC__ <span class="string">&lt;&lt; 16) + __GNUC_MINOR__ &gt;</span>= ((maj) &lt;&lt; 16) + (min))</span></span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line"><span class="meta"># <span class="keyword">define</span> __GNUC_PREREQ(maj, min) 0</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure>

<p>å¤§æ„æ˜¯æ£€æµ‹gccçš„ç‰ˆæœ¬ï¼Œè¿™é‡Œå°±ä¸å…·ä½“å±•å¼€è¯´æ˜äº†</p>
<p><del>gcc pre-requirement</del></p>
</blockquote>
<h2 id="wurï¼šè‹¥å‡½æ•°è¿”å›å€¼æœªè¢«å¼•ç”¨åˆ™æŠ›å‡ºè­¦å‘Š"><a href="#wurï¼šè‹¥å‡½æ•°è¿”å›å€¼æœªè¢«å¼•ç”¨åˆ™æŠ›å‡ºè­¦å‘Š" class="headerlink" title="__wurï¼šè‹¥å‡½æ•°è¿”å›å€¼æœªè¢«å¼•ç”¨åˆ™æŠ›å‡ºè­¦å‘Š"></a>__wurï¼šè‹¥å‡½æ•°è¿”å›å€¼æœªè¢«å¼•ç”¨åˆ™æŠ›å‡ºè­¦å‘Š</h2><p>ä¾ç„¶æ˜¯ä½äºmisc&#x2F;sys&#x2F;cdefs.hä¸‹çš„ä¸€ä¸ªå®å®šä¹‰ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* If fortification mode, we warn about unused results of certain</span></span><br><span class="line"><span class="comment">   function calls which can lead to problems.  */</span></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> __GNUC_PREREQ (3,4)</span></span><br><span class="line"><span class="meta"># <span class="keyword">define</span> __attribute_warn_unused_result__ \</span></span><br><span class="line"><span class="meta">   __attribute__ ((__warn_unused_result__))</span></span><br><span class="line"><span class="meta"># <span class="keyword">if</span> __USE_FORTIFY_LEVEL &gt; 0</span></span><br><span class="line"><span class="meta">#  <span class="keyword">define</span> __wur __attribute_warn_unused_result__</span></span><br><span class="line"><span class="meta"># <span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line"><span class="meta"># <span class="keyword">define</span> __attribute_warn_unused_result__ <span class="comment">/* empty */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> __wur</span></span><br><span class="line"><span class="meta"># <span class="keyword">define</span> __wur <span class="comment">/* Ignore */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure>

<p>è‹¥æ˜¯gccç‰ˆæœ¬ä¸º3.4åŠä»¥ä¸Šï¼Œåˆ™é¦–å…ˆä¼šå°†<code>__attribute_warn_unused_result__</code>å®šä¹‰ä¸º<code>__attribute__ ((__warn_unused_result__))</code></p>
<p>è¯¥attributeåœ¨gccæ‰‹å†Œä¸­çš„è¯´æ˜å¦‚ä¸‹ï¼š</p>
<blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">warn_unused_result</span><br></pre></td></tr></table></figure>

<p>The <code>warn_unused_result</code> attribute causes a warning to be emitted if a caller of the function with this attribute does not use its return value. This is useful for functions where not checking the result is either a security problem or always a bug, such as <code>realloc</code>.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">int fn () __attribute__ ((warn_unused_result));</span><br><span class="line">int foo ()</span><br><span class="line">&#123;</span><br><span class="line">if (fn () &lt; 0) return -1;</span><br><span class="line">fn ();</span><br><span class="line">return 0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>results in warning on line 5.</p>
</blockquote>
<p>å¤§æ„æ˜¯<strong>è‹¥æ˜¯è¯¥å‡½æ•°çš„è¿”å›å€¼æœªè¢«ç¨‹åºä½¿ç”¨ï¼Œåˆ™ç¼–è¯‘å™¨ä¼šå‘å‡ºè­¦å‘Š</strong><del>ï¼Œç„¶è€Œåˆæœ‰è°ä¼šå»æ³¨æ„warningså‘¢x</del></p>
<p>è€Œ<strong>å½“__USE_FORTIFY_LEVEL &gt; 0æ—¶</strong>ï¼Œ<code>__wur</code>ä¼šè¢«å¯ç”¨ï¼ŒåŠŸèƒ½åŒä¸Šæ‰€è¿°ï¼šæ£€æŸ¥å‡½æ•°è¿”å›å€¼æ˜¯å¦è¢«ä½¿ç”¨ï¼Œè‹¥å¦åˆ™å‘å‡ºè­¦å‘Š</p>
<p>è‹¥æ˜¯gccç‰ˆæœ¬ä¸º3.4ä»¥ä¸‹ï¼Œ<strong>åˆ™è¯¥å®å®šä¹‰æ— æ•ˆ</strong></p>
<blockquote>
<h4 id="USE-FORTIFY-LEVEL"><a href="#USE-FORTIFY-LEVEL" class="headerlink" title="__USE_FORTIFY_LEVEL"></a>__USE_FORTIFY_LEVEL</h4><p>å®šä¹‰äºfeatures.hä¸­ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">if</span> defined _FORTIFY_SOURCE &amp;&amp; _FORTIFY_SOURCE &gt; 0</span></span><br><span class="line"><span class="meta"># <span class="keyword">if</span> !defined __OPTIMIZE__ || __OPTIMIZE__ &lt;= 0</span></span><br><span class="line"><span class="meta">#  <span class="keyword">warning</span> _FORTIFY_SOURCE requires compiling with optimization (-O)</span></span><br><span class="line"><span class="meta"># <span class="keyword">elif</span> !__GNUC_PREREQ (4, 1)</span></span><br><span class="line"><span class="meta">#  <span class="keyword">warning</span> _FORTIFY_SOURCE requires GCC 4.1 or later</span></span><br><span class="line"><span class="meta"># <span class="keyword">elif</span> _FORTIFY_SOURCE &gt; 1</span></span><br><span class="line"><span class="meta">#  <span class="keyword">define</span> __USE_FORTIFY_LEVEL 2</span></span><br><span class="line"><span class="meta"># <span class="keyword">else</span></span></span><br><span class="line"><span class="meta">#  <span class="keyword">define</span> __USE_FORTIFY_LEVEL 1</span></span><br><span class="line"><span class="meta"># <span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> __USE_FORTIFY_LEVEL</span></span><br><span class="line"><span class="meta"># <span class="keyword">define</span> __USE_FORTIFY_LEVEL 0</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure>

<p>å½“_FORTIFY_SOURCEæœªè¢«å®šä¹‰æ—¶åˆ™ä¼šç½®0ï¼Œå¦åˆ™ä¼šå¯¹_FORTIFY_SOURCEçš„å€¼è¿›è¡Œåˆ¤æ–­ï¼Œè‹¥å¤§äº1åˆ™ä¸º2ï¼Œå¦åˆ™ä¸º1ï¼Œ<strong>æ— è®ºå¦‚ä½•åªè¦å®šä¹‰äº†_FORTIFY_SOURCEä¸”å¤§äº0ï¼Œåˆ™__wuréƒ½ä¼šè¢«å¯ç”¨</strong></p>
</blockquote>
<blockquote>
<h4 id="FORTIFY-SOURCE"><a href="#FORTIFY-SOURCE" class="headerlink" title="_FORTIFY_SOURCE"></a>_FORTIFY_SOURCE</h4><p>å¤§æ¦‚æ˜¯å’ŒGCCç¼–è¯‘é€‰é¡¹ç›¸å…³çš„ï¼Œå¯ä»¥ä½¿ç”¨<code>-D_FORTIFY_SOURCE</code>è¿›è¡ŒæŒ‡å®šï¼Œå¦‚<code>-D_FORTIFY_SOURCE=1</code></p>
<p>Ubuntu18ä¸‹é»˜è®¤<code>-D_FORTIFY_SOURCE=2</code></p>
</blockquote>
<h2 id="strong-aliasï¼šé‡å‘½åmallocä¸º-libc-malloc"><a href="#strong-aliasï¼šé‡å‘½åmallocä¸º-libc-malloc" class="headerlink" title="strong_aliasï¼šé‡å‘½åmallocä¸º__libc_malloc"></a>strong_aliasï¼šé‡å‘½åmallocä¸º__libc_malloc</h2><p>åœ¨ä¸Šé¢æˆ‘ä»¬å·²ç»ç®€è¦åœ°è§£æäº†åœ¨malloc.hä¸­å¯¹äºmallocå‡½æ•°çš„ä¸‰ä¸ªæ ‡è®°ï¼Œå¤§è‡´æ˜¯<strong>é’ˆå¯¹C++é»˜è®¤ä¸æŠ›å‡ºå¼‚å¸¸ä»¥ä¼˜åŒ–ä»£ç ï¼Œæ ¹æ®è¿”å›å€¼çš†ä¸ºmallocç±»å‹è¿›è¡Œä»£ç ç¼–è¯‘ä¼˜åŒ–ï¼Œè¿”å›å€¼æœªè¢«ä½¿ç”¨æ—¶æŠ›å‡ºè­¦å‘Š</strong></p>
<p>ä½†æ˜¯åœ¨malloc.cä¸­æˆ‘ä»¬æ— æ³•æ‰¾åˆ°å¯¹äºmallocå‡½æ•°çš„ç›´æ¥å®šä¹‰ï¼Œ<del>éš¾é“è¯´å®é™…ä¸Šå¹¶æ²¡æœ‰è¿™ä¸ªå‡½æ•°ğŸ¦„ï¼Œäº‹å®ä¸Šè¿˜çœŸçš„æ²¡æœ‰è¿™ä¸ªå‡½æ•°x</del></p>
<p>ä¸è¿‡æˆ‘ä»¬å¯ä»¥åœ¨malloc.hä¸­å‘ç°å­˜åœ¨å¦‚ä¸‹ä»£ç ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">strong_alias (__libc_malloc, __malloc) strong_alias (__libc_malloc, <span class="built_in">malloc</span>)</span><br></pre></td></tr></table></figure>

<p>å‘ç°ä¸€ä¸ªæ–°çš„ç¬¦å·ï¼š<strong>strong_alias</strong></p>
<p>è¯¥å®å®šä¹‰äºlibc-symbols.hä¸‹ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">/* GCC understands weak symbols and aliases; use its interface where</span><br><span class="line">   possible, instead of embedded assembly language.  */</span><br><span class="line"></span><br><span class="line">/* Define ALIASNAME as a strong alias for NAME.  */</span><br><span class="line"># define strong_alias(name, aliasname) _strong_alias(name, aliasname)</span><br><span class="line"># define _strong_alias(name, aliasname) \</span><br><span class="line">  extern __typeof (name) aliasname __attribute__ ((alias (#name)));</span><br></pre></td></tr></table></figure>

<p>_strong_aliaså®æ˜¯strong_aliasçš„å®å±•å¼€ï¼Œè€Œ_strong_aliaså®å±•å¼€ååˆ™æ˜¯<code>extern __typeof (name) aliasname __attribute__ ((alias (#name)));</code><del>æ—   é™  å¥—  å¨ƒ</del></p>
<p><del>é…åˆç€glibcçš„æ³¨é‡Šï¼Œ</del>ä¸éš¾ç†è§£ï¼Œåœ¨è¿™é‡Œ<strong>å°†mallocå£°æ˜ä¸º__libc_mallocçš„åˆ«åï¼Œå³__libc_mallocæ‰æ˜¯æˆ‘ä»¬åœ¨è°ƒç”¨mallocæ—¶æ‰€çœŸæ­£è°ƒç”¨çš„å‡½æ•°</strong></p>
<p>è¿™ä¸‹å°±çœŸç›¸å¤§ç™½äº†</p>
<blockquote>
<h4 id="typeof"><a href="#typeof" class="headerlink" title="__typeof"></a>__typeof</h4><p>æ‹“å±•Cå…³é”®å­—ï¼Œç”¨äºè·å–æŸä¸ªä¸œè¥¿çš„ç±»å‹</p>
<p>ç”¨ä¾‹å¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">foo</span><span class="params">(<span class="type">int</span> n)</span>&#123;<span class="keyword">return</span> n;&#125;</span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line"> __typeof(foo()) var;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™ç§æƒ…å†µä¸‹ä¾¿å¯ä»¥è·å–åˆ°foo()å‡½æ•°çš„è¿”å›å€¼ä¸ºintç±»å‹ï¼Œå¹¶ä»¥æ­¤å£°æ˜ä¸€ä¸ªintç±»å‹çš„å˜é‡var</p>
<p>éœ€è¦æ³¨æ„çš„æ˜¯__typeof(char)å’Œ__typeof(â€˜aâ€™)æ‰€è·å¾—çš„ç»“æœæ˜¯ä¸ä¸€æ ·çš„ï¼Œåè€…ä¼šå°†ä¹‹æå‡ä¸ºintç±»å‹</p>
</blockquote>
<p>äºæ˜¯æˆ‘ä»¬æœ€ç»ˆè½¬åˆ°__libc_mallocçš„å£°æ˜ï¼Œåœ¨å‰é¢å‘ç°äº†ä¸€å¤§æ®µå¯¹äºmallocçš„æ³¨é‡Š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">  malloc(size_t n)</span></span><br><span class="line"><span class="comment">  Returns a pointer to a newly allocated chunk of at least n bytes, or null</span></span><br><span class="line"><span class="comment">  if no space is available. Additionally, on failure, errno is</span></span><br><span class="line"><span class="comment">  set to ENOMEM on ANSI C systems.</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">  If n is zero, malloc returns a minumum-sized chunk. (The minimum</span></span><br><span class="line"><span class="comment">  size is 16 bytes on most 32bit systems, and 24 or 32 bytes on 64bit</span></span><br><span class="line"><span class="comment">  systems.)  On most systems, size_t is an unsigned type, so calls</span></span><br><span class="line"><span class="comment">  with negative arguments are interpreted as requests for huge amounts</span></span><br><span class="line"><span class="comment">  of space, which will often fail. The maximum supported value of n</span></span><br><span class="line"><span class="comment">  differs across systems, but is in all cases less than the maximum</span></span><br><span class="line"><span class="comment">  representable value of a size_t.</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="type">void</span>*  __libc_malloc(<span class="type">size_t</span>);</span><br><span class="line">libc_hidden_proto (__libc_malloc)</span><br></pre></td></tr></table></figure>

<p>æ•…æˆ‘ä»¬æœ€ç»ˆå¯ä»¥å¾—çŸ¥ï¼šå½“æˆ‘ä»¬è°ƒç”¨mallocå‡½æ•°æ—¶ï¼Œå…¶çœŸæ­£è°ƒç”¨çš„å‡½æ•°åº”å½“æ˜¯æ˜¯<strong>__libc_malloc</strong></p>
<p>äºæ˜¯æ¥ä¸‹æ¥æˆ‘ä»¬æ¥çœ‹çœ‹<strong>__libc_mallocå‡½æ•°çš„æºç </strong></p>
<h1 id="0x01-libc-malloc"><a href="#0x01-libc-malloc" class="headerlink" title="0x01.__libc_malloc"></a>0x01.__libc_malloc</h1><p>è¯¥æ®µä»£ç åŒæ ·ä½äºmalloc&#x2F;malloc.cä¸­ï¼Œæˆ‘ä»¬é¦–å…ˆå…ˆé˜…è¯»è¿™æ®µå…³äºmallocçš„æ³¨é‡Š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">  malloc(size_t n)</span></span><br><span class="line"><span class="comment">  Returns a pointer to a newly allocated chunk of at least n bytes, or null</span></span><br><span class="line"><span class="comment">  if no space is available. Additionally, on failure, errno is</span></span><br><span class="line"><span class="comment">  set to ENOMEM on ANSI C systems.</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">  If n is zero, malloc returns a minumum-sized chunk. (The minimum</span></span><br><span class="line"><span class="comment">  size is 16 bytes on most 32bit systems, and 24 or 32 bytes on 64bit</span></span><br><span class="line"><span class="comment">  systems.)  On most systems, size_t is an unsigned type, so calls</span></span><br><span class="line"><span class="comment">  with negative arguments are interpreted as requests for huge amounts</span></span><br><span class="line"><span class="comment">  of space, which will often fail. The maximum supported value of n</span></span><br><span class="line"><span class="comment">  differs across systems, but is in all cases less than the maximum</span></span><br><span class="line"><span class="comment">  representable value of a size_t.</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="type">void</span>*  __libc_malloc(<span class="type">size_t</span>);</span><br><span class="line">libc_hidden_proto (__libc_malloc)</span><br></pre></td></tr></table></figure>

<blockquote>
<p>ï¼ˆarttnba3è¯‘ï¼‰</p>
<p>malloc(size_t n)</p>
<p>å°†ä¼šè¿”å›ä¸€ä¸ªæŒ‡å‘åˆ†é…ç»™çš„è‡³å°‘n byteså¤§å°çš„chunkçš„æŒ‡é’ˆï¼Œè‹¥ç©ºé—´ä¸è¶³åˆ™ä¼šè¿”å›NULLã€‚æ­¤å¤–ï¼Œåœ¨ANSI Cæ ‡å‡†çš„ç³»ç»Ÿä¸Šï¼Œerrnoä¼šè¢«è®¾ä¸º<strong>ENOMEM</strong></p>
<p>å½“nä¸º0æ—¶ï¼Œmallocå°†ä¼šè¿”å›ä¸€ä¸ªæœ€å°sizeçš„chunkï¼ˆ32ä½ç³»ç»Ÿä¸‹ä¸º16bytesï¼Œ64ä½ç³»ç»Ÿä¸‹åˆ™ä¸º24æˆ–32bytesï¼‰ã€‚åœ¨å¤§éƒ¨åˆ†ç³»ç»Ÿä¸Šï¼Œsize_tä¸ºæ— ç¬¦å·ç±»å‹ï¼Œå› æ­¤è´Ÿæ•°å¤§å°çš„è¯·æ±‚å°†ä¼šè¢«è§£é‡Šä¸ºä¸€ä¸ªå¯¹äºæå·¨å¤§å†…å­˜ç©ºé—´çš„è¯·æ±‚ï¼Œè€Œè¿™é€šå¸¸éƒ½ä¼šå¤±è´¥ã€‚å¯¹äºæ”¯æŒçš„æœ€å¤§çš„å†…å­˜è¯·æ±‚é€šå¸¸åœ¨ä¸åŒçš„æ“ä½œç³»ç»Ÿä¸Šä¸ä¸€è‡´ï¼Œä½†éƒ½ä¼šæ¯”size_tç±»å‹æ‰€èƒ½è¡¨è¾¾çš„æœ€å¤§å€¼è¦å°</p>
</blockquote>
<blockquote>
<h4 id="errno"><a href="#errno" class="headerlink" title="errno"></a>errno</h4><p>å®šä¹‰äºerrno.hä¸­çš„ä¸€ä¸ªå‚¨å­˜é”™è¯¯ä»£ç çš„å˜é‡ï¼Œå…·ä½“é”™è¯¯ä»£ç è¯¦è§sysdeps&#x2F;mach&#x2F;hurd&#x2F;bits&#x2F;errno.h</p>
<p>å…¶ä¸­ENOMEMçš„å€¼ä¸º12</p>
<p>ï¼ˆç¬”è€…çŒœæµ‹ENOMEMåº”è¯¥ä¸ºerror: no memoryçš„æ„æ€ï¼‰</p>
</blockquote>
<p>ä¹Ÿå°±æ˜¯è¯´malloc(0)å¹¶ä¸ä¼šè¿”å›å†…å­˜å¤§å°ä¸º0çš„å†…å­˜ç©ºé—´ï¼Œè€Œæ˜¯è¿”å›ä¸€ä¸ªæœ€å°sizeçš„chunk</p>
<p>åŒæ—¶æˆ‘ä»¬è¿˜èƒ½å‘ç°ï¼šåœ¨__libc_mallocçš„å‡½æ•°å£°æ˜ä¸‹è¿˜æœ‰ä¸€è¡Œå¥‡æ€ªçš„ä»£ç â€”â€”libc_hidden_proto</p>
<h2 id="libc-hidden-protoï¼šå‡½æ•°ç¬¦å·éšè—"><a href="#libc-hidden-protoï¼šå‡½æ•°ç¬¦å·éšè—" class="headerlink" title="libc_hidden_protoï¼šå‡½æ•°ç¬¦å·éšè—"></a>libc_hidden_protoï¼šå‡½æ•°ç¬¦å·éšè—</h2><p>è¯¥ç¬¦å·è¢«å®šä¹‰åœ¨include&#x2F;libc-symbols.hä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">if</span> IS_IN (libc)</span></span><br><span class="line"><span class="meta"># <span class="keyword">define</span> libc_hidden_proto(name, attrs...) hidden_proto (name, ##attrs)</span></span><br><span class="line">...<span class="comment">//ä¸­é—´çš„ä»£ç å¤ªå¤šäº†ï¼Œè¿™é‡Œæˆ‘å°±ä¸copyäº†</span></span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line"><span class="meta"># <span class="keyword">define</span> libc_hidden_proto(name, attrs...)</span></span><br><span class="line">...</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure>

<p>åœ¨libcä¸­è¯¥å®å±•å¼€ä¸ºhidden_protoå®ï¼Œè¯¥å®åŒæ ·å®šä¹‰äºinclude&#x2F;libc-symbols.hä¸­ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">if</span> defined SHARED &amp;&amp; !defined NO_HIDDEN</span></span><br><span class="line"><span class="meta"># <span class="keyword">ifndef</span> __ASSEMBLER__</span></span><br><span class="line"><span class="meta">#  <span class="keyword">define</span> __hidden_proto_hiddenattr(attrs...) \</span></span><br><span class="line"><span class="meta">  __attribute__ ((visibility (<span class="string">&quot;hidden&quot;</span>), ##attrs))</span></span><br><span class="line"><span class="meta">#  <span class="keyword">define</span> hidden_proto(name, attrs...) \</span></span><br><span class="line"><span class="meta">  __hidden_proto (name, , __GI_##name, ##attrs)</span></span><br><span class="line"><span class="meta">#  <span class="keyword">define</span> hidden_tls_proto(name, attrs...) \</span></span><br><span class="line"><span class="meta">  __hidden_proto (name, __thread, __GI_##name, ##attrs)</span></span><br><span class="line"><span class="meta">#  <span class="keyword">define</span> __hidden_proto(name, thread, internal, attrs...)	     \</span></span><br><span class="line"><span class="meta">  extern thread __typeof (name) name __asm__ (__hidden_asmname (#internal)) \</span></span><br><span class="line"><span class="meta">  __hidden_proto_hiddenattr (attrs);</span></span><br><span class="line">...</span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line"><span class="meta"># <span class="keyword">ifndef</span> __ASSEMBLER__</span></span><br><span class="line"><span class="meta">#  <span class="keyword">define</span> hidden_proto(name, attrs...)</span></span><br><span class="line">...</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure>

<p>çœ‹å¾—å‡ºæ¥åœ¨å¤šé‡å¥—å¨ƒä¹‹åè¿™å…¶å®æ˜¯ä¸€ä¸ªattributeï¼Œé‡Œè¾¹å¥—çš„æ˜¯visibility (â€œhiddenâ€)ï¼ŒæŸ¥çœ‹gccæ‰‹å†Œæˆ‘ä»¬å¯ä»¥å‘ç°å…¶è¯´æ˜å¦‚ä¸‹ï¼š</p>
<blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hidden</span><br></pre></td></tr></table></figure>

<p>Hidden visibility indicates that the entity declared has a new form of linkage, which we call â€œhidden linkageâ€. Two declarations of an object with hidden linkage refer to the same object if they are in the same shared object.</p>
</blockquote>
<p>å¤§æ„æ˜¯è¯´è¿™ä¸ªattributeå£°æ˜è¯¥å‡½æ•°çš„visibilityä¸ºhiddenï¼Œå…¶æœ‰ç€ä¸€ç§æ–°çš„é“¾æ¥å½¢å¼ï¼Œç§°ä¹‹ä¸ºâ€œéšå¼é“¾æ¥â€ï¼ˆhidden linkageï¼‰ï¼Œå³<strong>å¯¹äºé“¾æ¥è¯¥åº“çš„ç¨‹åºè€Œè¨€ï¼Œè¯¥å‡½æ•°æ˜¯éšè—çš„</strong></p>
<p>åœ¨<strong>élibcä¸­è¯¥å®æ— æ•ˆ</strong></p>
<blockquote>
<h4 id="attribute-visibility-â€œhiddenâ€"><a href="#attribute-visibility-â€œhiddenâ€" class="headerlink" title="attribute: visibility(â€œhiddenâ€)"></a>attribute: visibility(â€œhiddenâ€)</h4><p>é€šä¿—æ¥è®²ï¼Œhiddenæ˜¯ç”¨äºæŠ‘åˆ¶ä¸€ä¸ªç¬¦å·çš„è¡¨è¾¾çš„</p>
<p>è®¾æƒ³å¦‚ä¸‹æƒ…å†µï¼šç¨‹åºaéœ€è¦åŒæ—¶é“¾æ¥libc-arttnba1.soå’Œlibc-arttnba2.soä¸¤ä¸ªåº“ï¼Œè€Œä¸¤ä¸ªåº“ä¸­è‹¥æ˜¯å­˜åœ¨åŒåçš„å‡½æ•°ï¼Œé‚£ä¹ˆåº“çš„åŠ è½½å…ˆåé¡ºåºçš„ä¸åŒå°†ä¼šå¯¼è‡´ç¨‹åºæ‰€è°ƒç”¨çš„å‡½æ•°ä¸åŒï¼Œ<strong>æ¯«æ— ç–‘é—®è¿™å°†é€ æˆæ··ä¹±è°ƒç”¨</strong></p>
<p>åœ¨ä½¿ç”¨attributeçš„visibility(â€œhiddenâ€)çš„æƒ…å†µä¸‹ï¼Œ<strong>è¯¥å‡½æ•°å°†ä¼šæŠ‘åˆ¶è‡ªèº«ç¬¦å·çš„è¡¨è¾¾</strong>ï¼š</p>
<p>åŒæ ·è®¾æƒ³å‰é¢çš„æƒ…å†µï¼Œè‹¥æ˜¯å­˜åœ¨ä¸€ä¸ªåŒåå‡½æ•°foo()ï¼Œè€Œlibc-arttnba2.soä¸­çš„foo()å‡½æ•°ä½¿ç”¨attributeè®¾å®šäº†visibilityä¸ºhiddençš„æƒ…å†µä¸‹ï¼Œæ— è®ºè¿™ä¸¤ä¸ªåŠ¨æ€é“¾æ¥åº“çš„åŠ è½½å…ˆåé¡ºåºå¦‚ä½•ï¼Œéƒ½åªä¼šè°ƒç”¨libc-arttnba1.soä¸­çš„foo()å‡½æ•°</p>
</blockquote>
<p>æ¥ä¸‹æ¥æˆ‘ä»¬çœ‹è¯¥å‡½æ•°çš„å®šä¹‰éƒ¨åˆ†</p>
<h2 id="libc-mallocå‡½æ•°å®šä¹‰ï¼š"><a href="#libc-mallocå‡½æ•°å®šä¹‰ï¼š" class="headerlink" title="__libc_mallocå‡½æ•°å®šä¹‰ï¼š"></a>__libc_mallocå‡½æ•°å®šä¹‰ï¼š</h2><p>è‹¥æ˜¯ç¬¬ä¸€æ¬¡é˜…è¯»libcæºç ï¼Œæ¯«æ— ç–‘é—®æˆ‘ä»¬ä¼šååˆ†æƒŠå¥‡åœ°å‘ç°è¯¥å‡½æ•°çš„ä»£ç è¶…ä¹æƒ³è±¡çš„çŸ­ï¼Œå¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> *</span><br><span class="line">__libc_malloc (<span class="type">size_t</span> bytes)</span><br><span class="line">&#123;</span><br><span class="line">  mstate ar_ptr;</span><br><span class="line">  <span class="type">void</span> *victim;</span><br><span class="line"></span><br><span class="line">  <span class="type">void</span> *(*hook) (<span class="type">size_t</span>, <span class="type">const</span> <span class="type">void</span> *)</span><br><span class="line">    = atomic_forced_read (__malloc_hook);</span><br><span class="line">  <span class="keyword">if</span> (__builtin_expect (hook != <span class="literal">NULL</span>, <span class="number">0</span>))</span><br><span class="line">    <span class="keyword">return</span> (*hook)(bytes, RETURN_ADDRESS (<span class="number">0</span>));</span><br><span class="line"></span><br><span class="line">  arena_get (ar_ptr, bytes);</span><br><span class="line"></span><br><span class="line">  victim = _int_malloc (ar_ptr, bytes);</span><br><span class="line">  <span class="comment">/* Retry with another arena only if we were able to find a usable arena</span></span><br><span class="line"><span class="comment">     before.  */</span></span><br><span class="line">  <span class="keyword">if</span> (!victim &amp;&amp; ar_ptr != <span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">      LIBC_PROBE (memory_malloc_retry, <span class="number">1</span>, bytes);</span><br><span class="line">      ar_ptr = arena_get_retry (ar_ptr, bytes);</span><br><span class="line">      victim = _int_malloc (ar_ptr, bytes);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (ar_ptr != <span class="literal">NULL</span>)</span><br><span class="line">    (<span class="type">void</span>) mutex_unlock (&amp;ar_ptr-&gt;mutex);</span><br><span class="line"></span><br><span class="line">  assert (!victim || chunk_is_mmapped (mem2chunk (victim)) ||</span><br><span class="line">          ar_ptr == arena_for_chunk (mem2chunk (victim)));</span><br><span class="line">  <span class="keyword">return</span> victim;</span><br><span class="line">&#125;</span><br><span class="line">libc_hidden_def (__libc_malloc)</span><br></pre></td></tr></table></figure>

<p>é¦–å…ˆå¼€å¤´å®šä¹‰ä¸‰ä¸ªå˜é‡ï¼šmstateç±»å‹çš„ar_ptrï¼Œvoidç±»å‹æŒ‡é’ˆvictimï¼Œè¿”å›å€¼ä¸ºvoidç±»å‹æŒ‡é’ˆçš„å‡½æ•°æŒ‡é’ˆhook</p>
<blockquote>
<p>ä¸éš¾æƒ³åˆ°ï¼Œar_ptrå³ä¸ºarena pointerï¼›victimåº”å½“ä¸ºæŒ‡å‘åˆ†é…çš„chunkçš„æŒ‡é’ˆï¼›è€Œè¿™ä¸ªhookåº”å½“å°±æ˜¯æˆ‘ä»¬æ¯”èµ›ä¸­å¸¸æ‰“çš„__malloc_hook</p>
</blockquote>
<h3 id="1-æ£€æŸ¥é’©å­-malloc-hookæ˜¯å¦ä¸ºNULLï¼Œè‹¥å¦ï¼Œåˆ™è°ƒç”¨é’©å­"><a href="#1-æ£€æŸ¥é’©å­-malloc-hookæ˜¯å¦ä¸ºNULLï¼Œè‹¥å¦ï¼Œåˆ™è°ƒç”¨é’©å­" class="headerlink" title="1.æ£€æŸ¥é’©å­__malloc_hookæ˜¯å¦ä¸ºNULLï¼Œè‹¥å¦ï¼Œåˆ™è°ƒç”¨é’©å­"></a>1.æ£€æŸ¥é’©å­__malloc_hookæ˜¯å¦ä¸ºNULLï¼Œè‹¥å¦ï¼Œåˆ™è°ƒç”¨é’©å­</h3><p>åœ¨å‡½æ•°ä¸€å¼€å§‹çš„æ—¶å€™ä¼šå…ˆè°ƒç”¨<code>atomic_forced_read()</code>ç»™hookå˜é‡èµ‹å€¼ï¼Œä¼ å…¥è¿™ä¸ªå‡½æ•°çš„å‚æ•°ä¸º<strong>__malloc_hook</strong></p>
<p>æˆ‘ä»¬å…ˆçœ‹<code>atomic_forced_read()</code>ï¼Œæ˜¯ä¸€ä¸ªå®šä¹‰äºinclude&#x2F;atomic.hä¸­çš„å®ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifndef</span> atomic_forced_read</span></span><br><span class="line"><span class="meta"># <span class="keyword">define</span> atomic_forced_read(x) \</span></span><br><span class="line"><span class="meta">  (&#123; __typeof (x) __x; __asm (<span class="string">&quot;&quot;</span> : <span class="string">&quot;=r&quot;</span> (__x) : <span class="string">&quot;0&quot;</span> (x)); __x; &#125;)</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure>

<p><del>ç›´æ¥ç¿»è¯‘å‡½æ•°åæ˜¯ç”¨åŸå­èƒ½æ¥è¯»å–</del></p>
<p>å¤§æ¦‚æ˜¯<strong>é€šè¿‡ä½¿ç”¨åŸå­æ“ä½œ</strong>å°†xè¯»å…¥åˆ°ä¸€ä¸ªå¯„å­˜å™¨ä¸­å†è¿”å›ï¼ŒåŸå­æ“ä½œç®€å•æ¥è¯´å°±æ˜¯ä¸ä¼šè¢«çº¿ç¨‹çš„è°ƒåº¦æ‰“æ–­çš„æ“ä½œï¼Œç”¨å¤„æ˜¯é˜²æ­¢ç”±äºå¤šçº¿ç¨‹å†²çªå¯¼è‡´çš„è¯¥å€¼è¢«é‡è½½</p>
<p>æ¥ä¸‹æ¥æˆ‘ä»¬æ¥çœ‹<strong>__malloc_hook</strong>çš„å£°æ˜ï¼Œå¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> *<span class="title function_">weak_variable</span> <span class="params">(*__malloc_hook)</span></span><br><span class="line">  <span class="params">(<span class="type">size_t</span> __size, <span class="type">const</span> <span class="type">void</span> *)</span> = malloc_hook_ini;</span><br></pre></td></tr></table></figure>

<p>å¯è§<strong>__malloc_hookåº”ä¸ºä¸€å‡½æ•°æŒ‡é’ˆï¼Œåˆå§‹æ—¶æŒ‡å‘malloc_hook_iniå‡½æ•°</strong></p>
<blockquote>
<h4 id="weak-variable"><a href="#weak-variable" class="headerlink" title="weak_variable"></a>weak_variable</h4><p>å®šä¹‰äºmalloc.cä¸­ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifndef</span> weak_variable</span></span><br><span class="line"><span class="comment">/* In GNU libc we want the hook variables to be weak definitions to</span></span><br><span class="line"><span class="comment">avoid a problem with Emacs.  */</span></span><br><span class="line"><span class="meta"># <span class="keyword">define</span> weak_variable weak_function</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure>

<p>è¿˜æ˜¯å¥—å¨ƒå®šä¹‰ï¼Œè·Ÿè¿›ï¼Œåœ¨include&#x2F;libc-symbols.hä¸­å¯è§å…¶å®šä¹‰</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* This comes between the return type and function name in</span></span><br><span class="line"><span class="comment">a function definition to make that definition weak.  */</span></span><br><span class="line"><span class="meta"># <span class="keyword">define</span> weak_function __attribute__ ((weak))</span></span><br><span class="line"><span class="meta"># <span class="keyword">define</span> weak_const_function __attribute__ ((weak, __const__))</span></span><br></pre></td></tr></table></figure>

<p>ä¹Ÿå°±æ˜¯è¯´è¿™è¿˜æ˜¯ä¸€ä¸ªgccçš„attributeï¼ŒæŸ¥é˜…æ‰‹å†Œä¸­è¯´æ˜å¦‚ä¸‹ï¼š</p>
<blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">weak</span><br></pre></td></tr></table></figure>

<p>The <code>weak</code> attribute causes a declaration of an external symbol to be emitted as a weak symbol rather than a global. This is primarily useful in defining library functions that can be overridden in user code, though it can also be used with non-function declarations. The overriding symbol must have the same type as the weak symbol. In addition, if it designates a variable it must also have the same size and alignment as the weak symbol. Weak symbols are supported for ELF targets, and also for a.out targets when using the GNU assembler and linker.</p>
</blockquote>
<p>å¯çŸ¥è¿™ä¸ªattributeå¤§æ„æ˜¯å¯¹äºè¯¥ç¬¦å·è€Œè¨€é“¾æ¥å™¨ä¼šå»ä¼˜å…ˆå¯»æ‰¾å…¨å±€ç¬¦å·ï¼Œæ— æ³•æ‰¾å¯»åˆ°ç¬¦åˆæ¡ä»¶çš„å…¨å±€ç¬¦å·åæ‰ä¼šä½¿ç”¨å¼±ç¬¦å·ï¼Œä»¥é¿å…é‡å®šä¹‰é”™è¯¯ï¼›å³å½“ä¸€ä¸ªç¬¦å·å¯èƒ½æˆ–éœ€è¦è¢«ç”¨æˆ·è¦†ç›–æ—¶ï¼Œå¯å°†ä¹‹å£°æ˜ä¸ºä¸€ä¸ªå¼±ç¬¦å·</p>
</blockquote>
<p>å½“<strong>hooké’©å­ä¸ä¸ºNULLæ—¶ä¼šæ‰§è¡Œå…¶æŒ‡å‘çš„å‡½æ•°å¹¶è¿”å›</strong>ï¼Œ__libc_mallocå‡½æ•°ä¾¿äºæ­¤æš‚æ—¶ç»“æŸå…¶æ—…ç¨‹äº†</p>
<p>è€Œ__malloc_hookçš„åˆå§‹å€¼ä¾¿ä¸ä¸ºNULLï¼Œæ•…<strong>åœ¨ç¬¬ä¸€æ¬¡è°ƒç”¨mallocå‡½æ•°æ—¶ä¸€å®šä¼šè½¬åˆ°æ‰§è¡Œmalloc_hook_iniå‡½æ•°</strong></p>
<h4 id="â‘ malloc-hook-iniï¼šé‡ç½®-malloc-hookä¸ºNULLï¼Œè°ƒç”¨ptmallocåˆå§‹åŒ–å‡½æ•°ï¼Œé‡æ–°è°ƒç”¨-libc-mallocåˆ†é…å†…å­˜å—"><a href="#â‘ malloc-hook-iniï¼šé‡ç½®-malloc-hookä¸ºNULLï¼Œè°ƒç”¨ptmallocåˆå§‹åŒ–å‡½æ•°ï¼Œé‡æ–°è°ƒç”¨-libc-mallocåˆ†é…å†…å­˜å—" class="headerlink" title="â‘ malloc_hook__iniï¼šé‡ç½®__malloc_hookä¸ºNULLï¼Œè°ƒç”¨ptmallocåˆå§‹åŒ–å‡½æ•°ï¼Œé‡æ–°è°ƒç”¨__libc_mallocåˆ†é…å†…å­˜å—"></a>â‘ malloc_hook__iniï¼šé‡ç½®__malloc_hookä¸ºNULLï¼Œè°ƒç”¨ptmallocåˆå§‹åŒ–å‡½æ•°ï¼Œé‡æ–°è°ƒç”¨__libc_mallocåˆ†é…å†…å­˜å—</h4><p>ç”±äºmalloc_hook_iniå‡½æ•°åœ¨ç¬¬ä¸€æ¬¡è°ƒç”¨mallocæ—¶ä¸€å®šä¼šè¢«è°ƒç”¨ä¸€æ¬¡ï¼Œæ•…æˆ‘ä»¬å…ˆæ¥çœ‹çœ‹è¿™ä¸ªå‡½æ•°</p>
<p>malloc_hook_iniå‡½æ•°çš„å£°æ˜åœ¨malloc.cä¸­ï¼Œå¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">void</span> *<span class="title function_">malloc_hook_ini</span> <span class="params">(<span class="type">size_t</span> sz,</span></span><br><span class="line"><span class="params">                              <span class="type">const</span> <span class="type">void</span> *caller)</span> __THROW;</span><br></pre></td></tr></table></figure>

<p>è¯¥å‡½æ•°å®šä¹‰äºmalloc&#x2F;hook.cä¸­ï¼Œå¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">void</span> *</span><br><span class="line"><span class="title function_">malloc_hook_ini</span> <span class="params">(<span class="type">size_t</span> sz, <span class="type">const</span> <span class="type">void</span> *caller)</span></span><br><span class="line">&#123;</span><br><span class="line">  __malloc_hook = <span class="literal">NULL</span>;</span><br><span class="line">  ptmalloc_init ();</span><br><span class="line">  <span class="keyword">return</span> __libc_malloc (sz);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¯¥å‡½æ•°åšäº†ä¸‰ä»¶å°äº‹ï¼š</p>
<ul>
<li><strong>å°†__malloc_hookèµ‹å€¼ä¸ºNULL</strong>ï¼Œè¿™æ ·ä¸€æ¥åœ¨ç¬¬äºŒæ¬¡åŠä»¥åè°ƒç”¨mallocæ—¶éƒ½ä¸ä¼šè¿›å…¥malloc_hook_iniå‡½æ•°ï¼Œè€Œæ˜¯æ¥ç€__libc_mallocçš„å‡½æ•°è¿›ç¨‹å¾€ä¸‹èµ°</li>
<li><strong>è°ƒç”¨ptmalloc_init()å‡½æ•°</strong></li>
<li><strong>é‡æ–°è°ƒç”¨__libc_malloc()å‡½æ•°åˆ†é…åˆé€‚çš„å†…å­˜å—è¿”å›ç»™ç”¨æˆ·</strong></li>
</ul>
<p>äºæ˜¯æˆ‘ä»¬æ¥ä¸‹æ¥æ¥çœ‹çœ‹ptmalloc_init()å‡½æ•°</p>
<h4 id="â‘¡ptmalloc-init-ï¼šåˆå§‹åŒ–ptmallocå †ç®¡ç†å™¨"><a href="#â‘¡ptmalloc-init-ï¼šåˆå§‹åŒ–ptmallocå †ç®¡ç†å™¨" class="headerlink" title="â‘¡ptmalloc_init()ï¼šåˆå§‹åŒ–ptmallocå †ç®¡ç†å™¨"></a>â‘¡ptmalloc_init()ï¼šåˆå§‹åŒ–ptmallocå †ç®¡ç†å™¨</h4><p>è¯¥å‡½æ•°å®šä¹‰äºmalloc&#x2F;arena.cä¸­ï¼Œå¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">void</span></span><br><span class="line"><span class="title function_">ptmalloc_init</span> <span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">if</span> (__malloc_initialized &gt;= <span class="number">0</span>)</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">  __malloc_initialized = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> SHARED</span></span><br><span class="line">  <span class="comment">/* In case this libc copy is in a non-default namespace, never use brk.</span></span><br><span class="line"><span class="comment">     Likewise if dlopened from statically linked program.  */</span></span><br><span class="line">  Dl_info di;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">link_map</span> *<span class="title">l</span>;</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (_dl_open_hook != <span class="literal">NULL</span></span><br><span class="line">      || (_dl_addr (ptmalloc_init, &amp;di, &amp;l, <span class="literal">NULL</span>) != <span class="number">0</span></span><br><span class="line">          &amp;&amp; l-&gt;l_ns != LM_ID_BASE))</span><br><span class="line">    __morecore = __failing_morecore;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">  thread_arena = &amp;main_arena;</span><br><span class="line">  thread_atfork (ptmalloc_lock_all, ptmalloc_unlock_all, ptmalloc_unlock_all2);</span><br><span class="line">  <span class="type">const</span> <span class="type">char</span> *s = <span class="literal">NULL</span>;</span><br><span class="line">  <span class="keyword">if</span> (__glibc_likely (_environ != <span class="literal">NULL</span>))</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="type">char</span> **runp = _environ;</span><br><span class="line">      <span class="type">char</span> *envline;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">while</span> (__builtin_expect ((envline = next_env_entry (&amp;runp)) != <span class="literal">NULL</span>,</span><br><span class="line">                               <span class="number">0</span>))</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="type">size_t</span> len = <span class="built_in">strcspn</span> (envline, <span class="string">&quot;=&quot;</span>);</span><br><span class="line"></span><br><span class="line">          <span class="keyword">if</span> (envline[len] != <span class="string">&#x27;=&#x27;</span>)</span><br><span class="line">            <span class="comment">/* This is a &quot;MALLOC_&quot; variable at the end of the string</span></span><br><span class="line"><span class="comment">               without a &#x27;=&#x27; character.  Ignore it since otherwise we</span></span><br><span class="line"><span class="comment">               will access invalid memory below.  */</span></span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">          <span class="keyword">switch</span> (len)</span><br><span class="line">            &#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">6</span>:</span><br><span class="line">              <span class="keyword">if</span> (<span class="built_in">memcmp</span> (envline, <span class="string">&quot;CHECK_&quot;</span>, <span class="number">6</span>) == <span class="number">0</span>)</span><br><span class="line">                s = &amp;envline[<span class="number">7</span>];</span><br><span class="line">              <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">8</span>:</span><br><span class="line">              <span class="keyword">if</span> (!__builtin_expect (__libc_enable_secure, <span class="number">0</span>))</span><br><span class="line">                &#123;</span><br><span class="line">                  <span class="keyword">if</span> (<span class="built_in">memcmp</span> (envline, <span class="string">&quot;TOP_PAD_&quot;</span>, <span class="number">8</span>) == <span class="number">0</span>)</span><br><span class="line">                    __libc_mallopt (M_TOP_PAD, atoi (&amp;envline[<span class="number">9</span>]));</span><br><span class="line">                  <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">memcmp</span> (envline, <span class="string">&quot;PERTURB_&quot;</span>, <span class="number">8</span>) == <span class="number">0</span>)</span><br><span class="line">                    __libc_mallopt (M_PERTURB, atoi (&amp;envline[<span class="number">9</span>]));</span><br><span class="line">                &#125;</span><br><span class="line">              <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">9</span>:</span><br><span class="line">              <span class="keyword">if</span> (!__builtin_expect (__libc_enable_secure, <span class="number">0</span>))</span><br><span class="line">                &#123;</span><br><span class="line">                  <span class="keyword">if</span> (<span class="built_in">memcmp</span> (envline, <span class="string">&quot;MMAP_MAX_&quot;</span>, <span class="number">9</span>) == <span class="number">0</span>)</span><br><span class="line">                    __libc_mallopt (M_MMAP_MAX, atoi (&amp;envline[<span class="number">10</span>]));</span><br><span class="line">                  <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">memcmp</span> (envline, <span class="string">&quot;ARENA_MAX&quot;</span>, <span class="number">9</span>) == <span class="number">0</span>)</span><br><span class="line">                    __libc_mallopt (M_ARENA_MAX, atoi (&amp;envline[<span class="number">10</span>]));</span><br><span class="line">                &#125;</span><br><span class="line">              <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">10</span>:</span><br><span class="line">              <span class="keyword">if</span> (!__builtin_expect (__libc_enable_secure, <span class="number">0</span>))</span><br><span class="line">                &#123;</span><br><span class="line">                  <span class="keyword">if</span> (<span class="built_in">memcmp</span> (envline, <span class="string">&quot;ARENA_TEST&quot;</span>, <span class="number">10</span>) == <span class="number">0</span>)</span><br><span class="line">                    __libc_mallopt (M_ARENA_TEST, atoi (&amp;envline[<span class="number">11</span>]));</span><br><span class="line">                &#125;</span><br><span class="line">              <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">15</span>:</span><br><span class="line">              <span class="keyword">if</span> (!__builtin_expect (__libc_enable_secure, <span class="number">0</span>))</span><br><span class="line">                &#123;</span><br><span class="line">                  <span class="keyword">if</span> (<span class="built_in">memcmp</span> (envline, <span class="string">&quot;TRIM_THRESHOLD_&quot;</span>, <span class="number">15</span>) == <span class="number">0</span>)</span><br><span class="line">                    __libc_mallopt (M_TRIM_THRESHOLD, atoi (&amp;envline[<span class="number">16</span>]));</span><br><span class="line">                  <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">memcmp</span> (envline, <span class="string">&quot;MMAP_THRESHOLD_&quot;</span>, <span class="number">15</span>) == <span class="number">0</span>)</span><br><span class="line">                    __libc_mallopt (M_MMAP_THRESHOLD, atoi (&amp;envline[<span class="number">16</span>]));</span><br><span class="line">                &#125;</span><br><span class="line">              <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">              <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  <span class="keyword">if</span> (s &amp;&amp; s[<span class="number">0</span>])</span><br><span class="line">    &#123;</span><br><span class="line">      __libc_mallopt (M_CHECK_ACTION, (<span class="type">int</span>) (s[<span class="number">0</span>] - <span class="string">&#x27;0&#x27;</span>));</span><br><span class="line">      <span class="keyword">if</span> (check_action != <span class="number">0</span>)</span><br><span class="line">        __malloc_check_init ();</span><br><span class="line">    &#125;</span><br><span class="line">  <span class="type">void</span> (*hook) (<span class="type">void</span>) = atomic_forced_read (__malloc_initialize_hook);</span><br><span class="line">  <span class="keyword">if</span> (hook != <span class="literal">NULL</span>)</span><br><span class="line">    (*hook)();</span><br><span class="line">  __malloc_initialized = <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="1ï¼‰ä¿®æ”¹ptmallocåˆå§‹åŒ–æ ‡å¿—ä½"><a href="#1ï¼‰ä¿®æ”¹ptmallocåˆå§‹åŒ–æ ‡å¿—ä½" class="headerlink" title="1ï¼‰ä¿®æ”¹ptmallocåˆå§‹åŒ–æ ‡å¿—ä½"></a>1ï¼‰ä¿®æ”¹ptmallocåˆå§‹åŒ–æ ‡å¿—ä½</h5><p>å¼€å¤´å…ˆæ£€æµ‹<code>__maloc_initialized</code>æ˜¯å¦å¤§äºç­‰äº0ï¼Œè‹¥å¦æ‰ä¼šç»§ç»­æ‰§è¡Œæ¥ä¸‹æ¥çš„ä¸€åˆ‡ï¼Œè€Œç¬¬ä¸€æ­¥ä¾¿æ˜¯å°†ä¹‹ç½®0ï¼Œæ•…ä¸éš¾å¾—å‡ºè¿™æ˜¯ä¸€ä¸ª<strong>ç”¨æ¥æ£€æµ‹ptmallocæ˜¯å¦å·²ç»åˆå§‹åŒ–</strong>çš„æ ‡å¿—ä½ï¼›</p>
<p>è¯¥å˜é‡åŒæ ·å®šä¹‰äºarena.cä¸­ï¼Œå¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Already initialized? */</span></span><br><span class="line"><span class="type">int</span> __malloc_initialized = <span class="number">-1</span>;</span><br></pre></td></tr></table></figure>

<p>å…¶åˆå§‹å€¼è¢«è®¾ç½®ä¸º<code>-1</code>ï¼Œä¿è¯äº†è¿™ä¸ªå‡½æ•°ä¸€å®šä¼šè¢«æ‰§è¡Œä¸€æ¬¡</p>
<h5 id="2ï¼‰æ£€æŸ¥SHAREDå®"><a href="#2ï¼‰æ£€æŸ¥SHAREDå®" class="headerlink" title="2ï¼‰æ£€æŸ¥SHAREDå®"></a>2ï¼‰æ£€æŸ¥SHAREDå®</h5><p>æ¥ä¸‹æ¥ä¼šæ£€æŸ¥<code>SHARED</code>å®æ˜¯å¦æœ‰è¢«å®šä¹‰è¿‡ï¼Œæ³¨é‡Šè¯´æ˜ï¼š<strong>å‡ä½¿è¯¥libcå‰¯æœ¬åœ¨éé»˜è®¤çš„å‘½åç©ºé—´ä¸­ï¼Œåˆ™ä¸è¦ä½¿ç”¨brkç³»ç»Ÿè°ƒç”¨ï¼›åŒæ ·çš„ï¼Œè‹¥æ˜¯åœ¨ä½¿ç”¨dlopen</strong>()<strong>æ‰“å¼€ä¸€ä¸ªé™æ€é“¾æ¥çš„ç¨‹åºçš„æƒ…å†µä¸‹äº¦æ˜¯å¦‚æ­¤</strong></p>
<p><del>è¿™ä¸ªå®çš„å®šä¹‰ä½ç½®æš‚ä¸”æ‰¾ä¸åˆ°ï¼Œè¿™é‡Œå°±å…ˆä¸ç®¡äº†</del></p>
<h5 id="3ï¼‰è·å–main-arenaï¼Œæ·»åŠ atfork-memå…¥fork-handleré“¾è¡¨"><a href="#3ï¼‰è·å–main-arenaï¼Œæ·»åŠ atfork-memå…¥fork-handleré“¾è¡¨" class="headerlink" title="3ï¼‰è·å–main_arenaï¼Œæ·»åŠ atfork_memå…¥fork_handleré“¾è¡¨"></a>3ï¼‰è·å–main_arenaï¼Œæ·»åŠ atfork_memå…¥fork_handleré“¾è¡¨</h5><p>æ¥ä¸‹æ¥ä¼šå…ˆè®¾ç½®è¯¥çº¿ç¨‹arenaä¸ºmain_arenaï¼Œå³åœ¨ptmallocæœªåˆå§‹åŒ–æ—¶é»˜è®¤ä¼šä½¿ç”¨main_arenaï¼Œè€Œä¸æ˜¯æ–°å»ºarena</p>
<p>éšåæ˜¯ä½¿ç”¨äº†<code>thread_atfork()</code>å®ï¼Œè¯¥å®å®šä¹‰äºsysdeps&#x2F;nptl&#x2F;malloc-machine.hä¸­ï¼Œå¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> ATFORK_MEM static struct fork_handler atfork_mem</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> SHARED</span></span><br><span class="line"><span class="meta"># <span class="keyword">define</span> thread_atfork(prepare, parent, child) \</span></span><br><span class="line"><span class="meta">  atfork_mem.prepare_handler = prepare;					      \</span></span><br><span class="line"><span class="meta">  atfork_mem.parent_handler = parent;					      \</span></span><br><span class="line"><span class="meta">  atfork_mem.child_handler = child;					      \</span></span><br><span class="line"><span class="meta">  atfork_mem.dso_handle = __dso_handle;					      \</span></span><br><span class="line"><span class="meta">  atfork_mem.refcntr = 1;						      \</span></span><br><span class="line"><span class="meta">  __linkin_atfork (&amp;atfork_mem)</span></span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line"><span class="meta"># <span class="keyword">define</span> thread_atfork(prepare, parent, child) \</span></span><br><span class="line"><span class="meta">  atfork_mem.prepare_handler = prepare;					      \</span></span><br><span class="line"><span class="meta">  atfork_mem.parent_handler = parent;					      \</span></span><br><span class="line"><span class="meta">  atfork_mem.child_handler = child;					      \</span></span><br><span class="line"><span class="meta">  atfork_mem.dso_handle = &amp;__dso_handle == NULL ? NULL : __dso_handle;	      \</span></span><br><span class="line"><span class="meta">  atfork_mem.refcntr = 1;						      \</span></span><br><span class="line"><span class="meta">  __linkin_atfork (&amp;atfork_mem)</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œçš„atfork_memå˜é‡çš„ç±»å‹ä¸ºfork_handlerç»“æ„ä½“ï¼Œè¯¥ç»“æ„ä½“å®šä¹‰ä¸sysdeps&#x2F;nptl&#x2F;fork.hä¸­ï¼Œå¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">fork_handler</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">fork_handler</span> *<span class="title">next</span>;</span></span><br><span class="line">  <span class="type">void</span> (*prepare_handler) (<span class="type">void</span>);</span><br><span class="line">  <span class="type">void</span> (*parent_handler) (<span class="type">void</span>);</span><br><span class="line">  <span class="type">void</span> (*child_handler) (<span class="type">void</span>);</span><br><span class="line">  <span class="type">void</span> *dso_handle;</span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> refcntr;</span><br><span class="line">  <span class="type">int</span> need_signal;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>ä¸éš¾çœ‹å‡ºfork_handlerä¹‹é—´åŒæ ·é“¾æ¥æˆä¸€ä¸ªå•å‘é“¾è¡¨</p>
<p>é‚£ä¹ˆæˆ‘ä»¬å¯ä»¥å¾—å‡ºthread_atfork()å®è®¾ç½®äº†ä¸‰ä¸ªå‡½æ•°æŒ‡é’ˆï¼Œå¹¶æœ€ç»ˆåˆè°ƒç”¨äº†å‡½æ•°__linkin_atfork()ï¼Œè¯¥å‡½æ•°å®šä¹‰äºnptl&#x2F;register-atfork.cä¸­ï¼Œå¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span></span><br><span class="line">attribute_hidden</span><br><span class="line">__linkin_atfork (<span class="keyword">struct</span> fork_handler *newp)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">do</span></span><br><span class="line">    newp-&gt;next = __fork_handlers;</span><br><span class="line">  <span class="keyword">while</span> (catomic_compare_and_exchange_bool_acq (&amp;__fork_handlers,</span><br><span class="line">						newp, newp-&gt;next) != <span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¾—å‡º__linkin_atfork()çš„ä½œç”¨åº”å½“ä¸ºå°†atfork_memæ·»åŠ å…¥fork_handleré“¾è¡¨ä¸­</p>
<p><strong>è¿™ä¸€ç³»åˆ—ä¸‹æ¥çš„æ“ä½œçš„ä½œç”¨æ˜¯ï¼šåœ¨æ¥ä¸‹æ¥ç¨‹åºforkå‡ºå­çº¿ç¨‹æ—¶ä¼šè°ƒç”¨atfork_memä¸­çš„ä¸‰ä¸ªå‡½æ•°æŒ‡é’ˆæ‰€æŒ‡å‘çš„å‡½æ•°</strong></p>
<h5 id="4ï¼‰ç¯å¢ƒå˜é‡-environç›¸å…³æ“ä½œ"><a href="#4ï¼‰ç¯å¢ƒå˜é‡-environç›¸å…³æ“ä½œ" class="headerlink" title="4ï¼‰ç¯å¢ƒå˜é‡__environç›¸å…³æ“ä½œ"></a>4ï¼‰ç¯å¢ƒå˜é‡__environç›¸å…³æ“ä½œ</h5><p>æ¥ä¸‹æ¥ä¼šæ£€æŸ¥_environå˜é‡æ˜¯å¦ä¸ºNULLï¼Œè¯¥å˜é‡ä¸º__environå˜é‡çš„å¼±åˆ«åï¼Œå®šä¹‰äºposix&#x2F;environ.cä¸­ï¼Œå¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* This must be initialized; we cannot have a weak alias into bss.  */</span></span><br><span class="line"><span class="type">char</span> **__environ = <span class="literal">NULL</span>;</span><br><span class="line">weak_alias (__environ, environ)</span><br><span class="line"></span><br><span class="line"><span class="comment">/* The SVR4 ABI says `_environ&#x27; will be the name to use</span></span><br><span class="line"><span class="comment">   in case the user overrides the weak alias `environ&#x27;.  */</span></span><br><span class="line">weak_alias (__environ, _environ)</span><br></pre></td></tr></table></figure>

<p>weak_aliaså’Œstrong_aliasæ˜¯ç±»ä¼¼çš„ï¼Œåªä¸è¿‡å®šä¹‰çš„æ˜¯å¼±åˆ«åï¼Œè¿™é‡Œä¾¿ä¸å†èµ˜å™</p>
<p>__environå˜é‡ä¸€èˆ¬éƒ½ä¸ä¸ºNULLï¼Œå› æ­¤åœ¨è¿™é‡Œä½¿ç”¨äº†åˆ†æ”¯é¢„æµ‹ä¼˜åŒ–å°è£…å®__glibc_likely()ï¼ˆè¯¦ç»†å®šä¹‰å‰æ–‡å·²æœ‰è¯´æ˜ï¼‰</p>
<p>æ¥ä¸‹æ¥ä¼šè°ƒç”¨<code>next_env_entry()</code>å‡½æ•°ï¼ŒåŒæ ·å®šä¹‰äºarena.cä¸­ï¼Œå¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">char</span> *</span><br><span class="line">internal_function</span><br><span class="line"><span class="title function_">next_env_entry</span> <span class="params">(<span class="type">char</span> ***position)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">char</span> **current = *position;</span><br><span class="line">  <span class="type">char</span> *result = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">while</span> (*current != <span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> (__builtin_expect ((*current)[<span class="number">0</span>] == <span class="string">&#x27;M&#x27;</span>, <span class="number">0</span>)</span><br><span class="line">          &amp;&amp; (*current)[<span class="number">1</span>] == <span class="string">&#x27;A&#x27;</span></span><br><span class="line">          &amp;&amp; (*current)[<span class="number">2</span>] == <span class="string">&#x27;L&#x27;</span></span><br><span class="line">          &amp;&amp; (*current)[<span class="number">3</span>] == <span class="string">&#x27;L&#x27;</span></span><br><span class="line">          &amp;&amp; (*current)[<span class="number">4</span>] == <span class="string">&#x27;O&#x27;</span></span><br><span class="line">          &amp;&amp; (*current)[<span class="number">5</span>] == <span class="string">&#x27;C&#x27;</span></span><br><span class="line">          &amp;&amp; (*current)[<span class="number">6</span>] == <span class="string">&#x27;_&#x27;</span>)</span><br><span class="line">        &#123;</span><br><span class="line">          result = &amp;(*current)[<span class="number">7</span>];</span><br><span class="line"></span><br><span class="line">          <span class="comment">/* Save current position for next visit.  */</span></span><br><span class="line">          *position = ++current;</span><br><span class="line"></span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">      ++current;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¤§æ¦‚ä½œç”¨æ˜¯åœ¨<code>__environ</code>ä¸­æ‰¾åˆ°<strong>å¼€å¤´ä¸ºâ€MALLOC_â€œçš„å­—ç¬¦ä¸²</strong>çš„åœ°å€ï¼Œè‹¥æ‰¾ä¸åˆ°åˆ™è¿”å›NULL</p>
<p>é€šå¸¸æƒ…å†µä¸‹<code>__environ</code>ä¸­ä¸å­˜åœ¨è¿™æ ·çš„å­—ç¬¦ä¸²ï¼Œå› è€Œåœ¨è¿™é‡Œç”¨äº†builtin_expectå®</p>
<p>è‹¥è¯¥å­—ç¬¦ä¸²å­˜åœ¨ï¼Œåˆ™ä¼šè°ƒç”¨<code>strcspn()</code>å‡½æ•°æŸ¥æ‰¾å­—ç¬¦<code>&#39;=&#39;</code>ï¼Œè‹¥ä¸å­˜åœ¨åˆ™åˆä¼šé‡æ–°å›å»è°ƒç”¨<code>next_env_entry()</code>å‡½æ•°</p>
<blockquote>
<p>ç¬”è€…è®¤ä¸ºè¿™é‡Œæœ‰å¯èƒ½é€ æˆæ­»å¾ªç¯</p>
</blockquote>
<p>å‡½æ•°ä¸­è®¾å®šçš„éœ€è¦å¤„ç†çš„å­—ç¬¦ä¸²å¦‚ä¸‹ï¼š</p>
<ul>
<li><strong>MALLOC_CHECK_</strong></li>
<li><strong>MALLOC_TOP_PAD_</strong></li>
<li><strong>MALLOC_PERTURB_</strong></li>
<li><strong>MALLOC_MMAP_MAX_</strong></li>
<li><strong>MALLOC_ARENA_MAX</strong></li>
<li><strong>MALLOC_ARENA_TEST</strong></li>
<li><strong>MALLOC_TRIM_THRESHOLD_</strong></li>
<li><strong>MALLOC_MMAP_THRESHOLD_</strong></li>
</ul>
<p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œé’ˆå¯¹<code>MALLOC_CHECK_</code>ï¼Œptmalloc_init()å‡½æ•°ä¼šå•ç‹¬è¿›è¡Œå¤„ç†ï¼Œè€Œå‰©ä¸‹çš„åˆ™ä¼šè°ƒç”¨<code>__libc_mallopt()</code>å‡½æ•°è¿›è¡Œå¤„ç†</p>
<p>è¯¥å‡½æ•°å®šä¹‰äºmalloc.cä¸­ï¼Œå¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span></span><br><span class="line">__libc_mallopt (<span class="type">int</span> param_number, <span class="type">int</span> value)</span><br><span class="line">&#123;</span><br><span class="line">  mstate av = &amp;main_arena;</span><br><span class="line">  <span class="type">int</span> res = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (__malloc_initialized &lt; <span class="number">0</span>)</span><br><span class="line">    ptmalloc_init ();</span><br><span class="line">  (<span class="type">void</span>) mutex_lock (&amp;av-&gt;mutex);</span><br><span class="line">  <span class="comment">/* Ensure initialization/consolidation */</span></span><br><span class="line">  malloc_consolidate (av);</span><br><span class="line"></span><br><span class="line">  LIBC_PROBE (memory_mallopt, <span class="number">2</span>, param_number, value);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">switch</span> (param_number)</span><br><span class="line">    &#123;</span><br><span class="line">    <span class="keyword">case</span> M_MXFAST:</span><br><span class="line">      <span class="keyword">if</span> (value &gt;= <span class="number">0</span> &amp;&amp; value &lt;= MAX_FAST_SIZE)</span><br><span class="line">        &#123;</span><br><span class="line">          LIBC_PROBE (memory_mallopt_mxfast, <span class="number">2</span>, value, get_max_fast ());</span><br><span class="line">          set_max_fast (value);</span><br><span class="line">        &#125;</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">        res = <span class="number">0</span>;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">case</span> M_TRIM_THRESHOLD:</span><br><span class="line">      LIBC_PROBE (memory_mallopt_trim_threshold, <span class="number">3</span>, value,</span><br><span class="line">                  mp_.trim_threshold, mp_.no_dyn_threshold);</span><br><span class="line">      mp_.trim_threshold = value;</span><br><span class="line">      mp_.no_dyn_threshold = <span class="number">1</span>;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">case</span> M_TOP_PAD:</span><br><span class="line">      LIBC_PROBE (memory_mallopt_top_pad, <span class="number">3</span>, value,</span><br><span class="line">                  mp_.top_pad, mp_.no_dyn_threshold);</span><br><span class="line">      mp_.top_pad = value;</span><br><span class="line">      mp_.no_dyn_threshold = <span class="number">1</span>;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">case</span> M_MMAP_THRESHOLD:</span><br><span class="line">      <span class="comment">/* Forbid setting the threshold too high. */</span></span><br><span class="line">      <span class="keyword">if</span> ((<span class="type">unsigned</span> <span class="type">long</span>) value &gt; HEAP_MAX_SIZE / <span class="number">2</span>)</span><br><span class="line">        res = <span class="number">0</span>;</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">          LIBC_PROBE (memory_mallopt_mmap_threshold, <span class="number">3</span>, value,</span><br><span class="line">                      mp_.mmap_threshold, mp_.no_dyn_threshold);</span><br><span class="line">          mp_.mmap_threshold = value;</span><br><span class="line">          mp_.no_dyn_threshold = <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">case</span> M_MMAP_MAX:</span><br><span class="line">      LIBC_PROBE (memory_mallopt_mmap_max, <span class="number">3</span>, value,</span><br><span class="line">                  mp_.n_mmaps_max, mp_.no_dyn_threshold);</span><br><span class="line">      mp_.n_mmaps_max = value;</span><br><span class="line">      mp_.no_dyn_threshold = <span class="number">1</span>;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">case</span> M_CHECK_ACTION:</span><br><span class="line">      LIBC_PROBE (memory_mallopt_check_action, <span class="number">2</span>, value, check_action);</span><br><span class="line">      check_action = value;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">case</span> M_PERTURB:</span><br><span class="line">      LIBC_PROBE (memory_mallopt_perturb, <span class="number">2</span>, value, perturb_byte);</span><br><span class="line">      perturb_byte = value;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">case</span> M_ARENA_TEST:</span><br><span class="line">      <span class="keyword">if</span> (value &gt; <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">          LIBC_PROBE (memory_mallopt_arena_test, <span class="number">2</span>, value, mp_.arena_test);</span><br><span class="line">          mp_.arena_test = value;</span><br><span class="line">        &#125;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">case</span> M_ARENA_MAX:</span><br><span class="line">      <span class="keyword">if</span> (value &gt; <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">          LIBC_PROBE (memory_mallopt_arena_max, <span class="number">2</span>, value, mp_.arena_max);</span><br><span class="line">          mp_.arena_max = value;</span><br><span class="line">        &#125;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  (<span class="type">void</span>) mutex_unlock (&amp;av-&gt;mutex);</span><br><span class="line">  <span class="keyword">return</span> res;</span><br><span class="line">&#125;</span><br><span class="line">libc_hidden_def (__libc_mallopt)</span><br></pre></td></tr></table></figure>

<p>é¦–å…ˆä¼šæ£€æŸ¥<code>malloc_initialized</code>çš„å€¼ï¼Œè‹¥æ˜¯å°äº0åˆ™ä¼šè°ƒç”¨<code>ptmalloc_init()</code>å‡½æ•°ï¼Œ<del>è¿™æ˜¯åˆå¥—å¨ƒå›å»äº†ï¼Œä¸è¿‡è¿™é‡Œåœ¨å‰é¢å¼€å¤´å·²ç»å°†å…¶ç½®0äº†ï¼Œæ‰€ä»¥è¿™ç§æƒ…å†µä¸ä¼šå‘ç”Ÿ</del></p>
<p>æ¥ä¸‹æ¥é¦–å…ˆä¼šé”ä¸Šmain_arenaçš„äº’æ–¥é”ï¼Œéšåè°ƒç”¨<code>malloc_consolidate()</code>å‡½æ•°æ¸…ç©ºfastbinä¸­çš„chunkï¼Œè¿™ä¸ªå‡½æ•°æˆ‘ä»¬ä¼šåœ¨åé¢è¯¦ç»†åˆ†æ</p>
<p>æ¥ä¸‹æ¥å°±æ˜¯é’ˆå¯¹ä¸åŒçš„æƒ…å†µå¯¹ä¸åŒçš„å˜é‡è®¾ç½®ä¸åŒçš„ï¼ˆåˆå§‹ï¼Ÿï¼‰å€¼ï¼Œå®Œæˆåè§£é”main_arenaå¹¶è¿”å›</p>
<p>è€Œå¯¹äºå­—ç¬¦ä¸²<code>&quot;MALLOC_CHECK_&quot;</code>ï¼Œåˆ™ä¼šå…ˆè°ƒç”¨<code>__libc_mallopt()</code>å‡½æ•°ï¼Œä¹‹åï¼Œæ£€æŸ¥å˜é‡<code>check_action</code>çš„å€¼ï¼Œè‹¥ä¸ä¸º0åˆ™ä¼šè°ƒç”¨<code>__malloc_check_init()</code>å‡½æ•°</p>
<blockquote>
<p>ç¬”è€…è®¤ä¸ºè¿™ä¸€æ­¥å…¶å®å¯ä»¥åˆå¹¶åˆ°å‰é¢çš„switchä¸­ï¼Œè€Œä¸éœ€è¦å•å¼€ä¸€ä¸ªif</p>
</blockquote>
<p>check_actionå®šä¹‰äºmalloc.cä¸­ï¼Œå¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifndef</span> DEFAULT_CHECK_ACTION</span></span><br><span class="line"><span class="meta"># <span class="keyword">define</span> DEFAULT_CHECK_ACTION 3</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> check_action = DEFAULT_CHECK_ACTION;</span><br></pre></td></tr></table></figure>

<p>å³è¯¥é™æ€å˜é‡çš„å€¼é»˜è®¤ä¸º3ï¼Œå³é»˜è®¤æƒ…å†µä¸‹å¯¹äºå­—ç¬¦ä¸²<code>&quot;MALLOC_CHECK&quot;</code>ï¼Œéƒ½ä¼šè°ƒç”¨<code>__malloc_check_init()</code>å‡½æ•°</p>
<p>è¯¥å‡½æ•°å®šä¹‰äºmalloc&#x2F;hook.cä¸­ï¼Œå¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">int</span> disallow_malloc_check;</span><br><span class="line"><span class="comment">/* Activate a standard set of debugging hooks. */</span></span><br><span class="line"><span class="type">void</span></span><br><span class="line">__malloc_check_init (<span class="type">void</span>)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">if</span> (disallow_malloc_check)</span><br><span class="line">    &#123;</span><br><span class="line">      disallow_malloc_check = <span class="number">0</span>;</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  using_malloc_checking = <span class="number">1</span>;</span><br><span class="line">  __malloc_hook = malloc_check;</span><br><span class="line">  __free_hook = free_check;</span><br><span class="line">  __realloc_hook = realloc_check;</span><br><span class="line">  __memalign_hook = memalign_check;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è‹¥æ˜¯å˜é‡<code>disallow_malloc_check</code>ä¸ä¸º0åˆ™ä¼šèµ‹å€¼ä¸º0åç›´æ¥è¿”å›ï¼Œå¦åˆ™ä¼šå°†<code>using_malloc_check</code>èµ‹å€¼ä¸º1åå°†å››ä¸ªhooké’©å­åˆ†åˆ«è®¾ä¸ºå¯¹åº”çš„checkå‡½æ•°</p>
<h5 id="5ï¼‰æ£€æŸ¥é’©å­-malloc-initialized-hook"><a href="#5ï¼‰æ£€æŸ¥é’©å­-malloc-initialized-hook" class="headerlink" title="5ï¼‰æ£€æŸ¥é’©å­__malloc_initialized_hook"></a>5ï¼‰æ£€æŸ¥é’©å­__malloc_initialized_hook</h5><p>æœ€åä¾¿æ˜¯æ£€æŸ¥é’©å­<code>__malloc_initialize_hook</code>æ˜¯å¦ä¸ºNULLï¼Œè‹¥å¦ï¼Œåˆ™ä¼šè°ƒç”¨å…¶æ‰€æŒ‡å‘çš„å‡½æ•°</p>
<p>è¯¥hookå®šä¹‰äºmalloc.cä¸­ï¼Œå¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">weak_variable</span> <span class="params">(*__malloc_initialize_hook)</span> <span class="params">(<span class="type">void</span>)</span> = <span class="literal">NULL</span>;</span><br></pre></td></tr></table></figure>

<p>å³åˆå§‹æƒ…å†µä¸‹è¯¥é’©å­åº”å½“ä¸ºNULL</p>
<p>æœ€åå°†<code>__malloc_initialized</code>çš„å€¼è®¾ä¸º1åï¼Œè¿™ä¸ªå‡½æ•°å°±ç»“æŸäº†</p>
<h3 id="2-è·å–ä¸€ä¸ªarena"><a href="#2-è·å–ä¸€ä¸ªarena" class="headerlink" title="2.è·å–ä¸€ä¸ªarena"></a>2.è·å–ä¸€ä¸ªarena</h3><p>æ¥ä¸‹æ¥ä¼šé€šè¿‡å®<code>arena_get()</code>å°è¯•è·å–ä¸€ä¸ªarenaï¼Œè¿™ä¸ªå®çš„å…·ä½“å®ç°åœ¨å‰é¢å·²ç»è¯¦ç»†å™è¿°è¿‡äº†ï¼Œè¿™é‡Œå°±ä¸å†èµ˜å™äº†</p>
<p>ç”±äºåœ¨ptmalloc_init()å‡½æ•°ä¸­å·²ç»å°†thread_arenaè®¾ä¸ºmain_arenaäº†ï¼Œæ‰€ä»¥ç¬¬ä¸€æ¬¡è°ƒç”¨mallocæ—¶ä¾¿ä¼š<strong>ç›´æ¥é”ä¸Šmain_arenaåä½¿ç”¨</strong></p>
<p>å¯¹äºå…¶ä»–åç»­è¿›è¡Œè°ƒç”¨çš„çº¿ç¨‹åˆ™ä¼š<strong>å…ˆæ£€æŸ¥free_listæ˜¯å¦æœ‰å¯ç”¨ç©ºé—²arenaï¼Œè‹¥æ²¡æœ‰å¯ç”¨ç©ºé—²arenaåˆ™å°è¯•åœ¨Memory Mapping Segmentæ–°å»ºä¸€ä¸ªarenaï¼Œè‹¥å¤±è´¥åˆ™åªèƒ½ä¸å…¶ä»–çº¿ç¨‹å…±äº«arena</strong></p>
<h3 id="â­3-è°ƒç”¨-int-malloc-å‡½æ•°åˆ†é…å†…å­˜"><a href="#â­3-è°ƒç”¨-int-malloc-å‡½æ•°åˆ†é…å†…å­˜" class="headerlink" title="â­3.è°ƒç”¨_int_malloc()å‡½æ•°åˆ†é…å†…å­˜"></a>â­3.è°ƒç”¨_int_malloc()å‡½æ•°åˆ†é…å†…å­˜</h3><p>æ¥ä¸‹æ¥__libc_malloc()å‡½æ•°ä¼šè°ƒç”¨<code>_int_malloc()</code>å‡½æ•°<strong>çœŸæ­£å¼€å§‹è¿›è¡Œå†…å­˜åˆ†é…</strong>ï¼Œä¹Ÿå°±æ˜¯è¯´å†…å­˜åˆ†é…çš„<strong>æ ¸å¿ƒå‡½æ•°å…¶å®æ˜¯</strong><code>_int_malloc()</code>å‡½æ•°ï¼Œ__libc_malloc()å‡½æ•°å…¶å®æœ¬èº«è¿˜æ˜¯å¯¹è¯¥å‡½æ•°çš„ä¸€å±‚å°è£…ï¼Œå¹¶é™„åŠ ä¸Šä¸€äº›å †ç®¡ç†å™¨ç›¸å…³çš„æ“ä½œï¼Œè¯¥å‡½æ•°æˆ‘ä»¬ä¼šåœ¨åé¢è¯¦ç»†è¿›è¡Œè§£æ</p>
<h3 id="4-æ£€æµ‹ç»“æœï¼Œè‹¥ä¸ºNULLåˆ™é‡æ–°è·å¾—arenaå¹¶é‡æ–°è°ƒç”¨-int-malloc-åˆ†é…å†…å­˜"><a href="#4-æ£€æµ‹ç»“æœï¼Œè‹¥ä¸ºNULLåˆ™é‡æ–°è·å¾—arenaå¹¶é‡æ–°è°ƒç”¨-int-malloc-åˆ†é…å†…å­˜" class="headerlink" title="4.æ£€æµ‹ç»“æœï¼Œè‹¥ä¸ºNULLåˆ™é‡æ–°è·å¾—arenaå¹¶é‡æ–°è°ƒç”¨_int_malloc()åˆ†é…å†…å­˜"></a>4.æ£€æµ‹ç»“æœï¼Œè‹¥ä¸ºNULLåˆ™é‡æ–°è·å¾—arenaå¹¶é‡æ–°è°ƒç”¨_int_malloc()åˆ†é…å†…å­˜</h3><p>è‹¥æ˜¯<code>_int_malloc()</code>å‡½æ•°æœªèƒ½å¤ŸæˆåŠŸè·å–åˆ°ä¸€ä¸ªé€‚åˆçš„å †å—ï¼Œåˆ™ä¼šå‘ä¸Šå±‚å‡½æ•°è¿”å›NULLï¼Œå› æ­¤åœ¨è¿™é‡Œä¼šå¯¹å…¶è¿”å›çš„ç»“æœè¿›è¡Œæ£€æµ‹</p>
<p>ç”±äºptmallocè€ƒè™‘åˆ°å¯èƒ½æ˜¯arenaä¸è¶³ä»¥æä¾›æ‰€éœ€ç©ºé—´çš„åŸå› ï¼Œæ•…åœ¨è¿™é‡Œé¦–å…ˆä¼šè°ƒç”¨<code>arena_gert_retry()</code>å‡½æ•°ï¼Œé‡æ–°å°è¯•è·å¾—ä¸€ä¸ªæ–°çš„arena</p>
<h4 id="â‘ arena-get-retry-ï¼šé‡æ–°è·å¾—ä¸€ä¸ªarena"><a href="#â‘ arena-get-retry-ï¼šé‡æ–°è·å¾—ä¸€ä¸ªarena" class="headerlink" title="â‘ arena_get_retry()ï¼šé‡æ–°è·å¾—ä¸€ä¸ªarena"></a>â‘ arena_get_retry()ï¼šé‡æ–°è·å¾—ä¸€ä¸ªarena</h4><p>è¯¥å‡½æ•°å®šä¹‰äºarena.cä¸­ï¼Œå¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* If we don&#x27;t have the main arena, then maybe the failure is due to running</span></span><br><span class="line"><span class="comment">   out of mmapped areas, so we can try allocating on the main arena.</span></span><br><span class="line"><span class="comment">   Otherwise, it is likely that sbrk() has failed and there is still a chance</span></span><br><span class="line"><span class="comment">   to mmap(), so try one of the other arenas.  */</span></span><br><span class="line"><span class="type">static</span> mstate</span><br><span class="line"><span class="title function_">arena_get_retry</span> <span class="params">(mstate ar_ptr, <span class="type">size_t</span> bytes)</span></span><br><span class="line">&#123;</span><br><span class="line">  LIBC_PROBE (memory_arena_retry, <span class="number">2</span>, bytes, ar_ptr);</span><br><span class="line">  <span class="keyword">if</span> (ar_ptr != &amp;main_arena)</span><br><span class="line">    &#123;</span><br><span class="line">      (<span class="type">void</span>) mutex_unlock (&amp;ar_ptr-&gt;mutex);</span><br><span class="line">      <span class="comment">/* Don&#x27;t touch the main arena if it is corrupt.  */</span></span><br><span class="line">      <span class="keyword">if</span> (arena_is_corrupt (&amp;main_arena))</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">      ar_ptr = &amp;main_arena;</span><br><span class="line">      (<span class="type">void</span>) mutex_lock (&amp;ar_ptr-&gt;mutex);</span><br><span class="line">    &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      (<span class="type">void</span>) mutex_unlock (&amp;ar_ptr-&gt;mutex);</span><br><span class="line">      ar_ptr = arena_get2 (bytes, ar_ptr);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> ar_ptr;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ³¨é‡Šä¸­è¯´æ˜æœ‰ä¸¤ç§å¯èƒ½çš„æƒ…å†µï¼š</p>
<ul>
<li>è‹¥æ˜¯æˆ‘ä»¬ä½¿ç”¨çš„ä¸æ˜¯main_arenaï¼Œåˆ™è¯´æ˜mmapedåŒºåŸŸï¼ˆMemory Mapping Segmentï¼‰å·²ç»è€—å°½äº†ï¼Œå› æ­¤æˆ‘ä»¬å°è¯•å›åˆ°main_arenaä¸Šè¿›è¡Œå†…å­˜åˆ†é…ï¼ˆby (s)brkï¼‰</li>
<li>è‹¥æ˜¯æˆ‘ä»¬ä½¿ç”¨çš„å°±æ˜¯main_arenaï¼Œåˆ™è¯´æ˜(s)brkç³»ç»Ÿè°ƒç”¨å¤±è´¥ï¼ˆå †åŒºå¯ç”¨ç©ºé—´è€—å°½ï¼‰ï¼Œä½†æˆ‘ä»¬ä»ç„¶æœ‰å¯èƒ½åœ¨mmapedåŒºåŸŸæœ‰å¯ç”¨çš„ç©ºé—´ï¼Œæ­¤æ—¶ptmallocé€‰æ‹©å°è¯•å…¶ä»–çš„arena</li>
</ul>
<p>å› æ­¤å…¶æµç¨‹åˆ†æ”¯å¦‚ä¸‹ï¼š</p>
<h5 id="1ï¼‰åŸarenaä¸ä¸ºmain-arenaï¼Œåˆ™è§£é”åè·å–main-arena"><a href="#1ï¼‰åŸarenaä¸ä¸ºmain-arenaï¼Œåˆ™è§£é”åè·å–main-arena" class="headerlink" title="1ï¼‰åŸarenaä¸ä¸ºmain_arenaï¼Œåˆ™è§£é”åè·å–main_arena"></a>1ï¼‰åŸarenaä¸ä¸ºmain_arenaï¼Œåˆ™è§£é”åè·å–main_arena</h5><p>é¦–å…ˆä¼šå°†åŸå…ˆä½¿ç”¨çš„arenaè§£é”ï¼Œéšåæ£€æŸ¥main_arenaæ˜¯å¦è¢«ç ´åï¼Œ<strong>è‹¥main_arenaå·²è¢«ç ´ååˆ™ç›´æ¥è¿”å›NULLï¼Œå¦åˆ™é”ä¸Šmain_arena</strong></p>
<h5 id="2ï¼‰åŸarenaä¸ºmain-arenaï¼Œè§£é”åè°ƒç”¨arena-get2-è·å–å…¶ä»–arena"><a href="#2ï¼‰åŸarenaä¸ºmain-arenaï¼Œè§£é”åè°ƒç”¨arena-get2-è·å–å…¶ä»–arena" class="headerlink" title="2ï¼‰åŸarenaä¸ºmain_arenaï¼Œè§£é”åè°ƒç”¨arena_get2()è·å–å…¶ä»–arena"></a>2ï¼‰åŸarenaä¸ºmain_arenaï¼Œè§£é”åè°ƒç”¨arena_get2()è·å–å…¶ä»–arena</h5><p>è‹¥åŸarenaå°±æ˜¯main_arenaï¼Œåˆ™æ­¤æ—¶ä¼šå°è¯•è°ƒç”¨arena_get2()å‡½æ•°è·å–ä¸€ä¸ªarenaï¼Œåœ¨è¿™é‡Œmain_arenaè¢«ä½œä¸ºavoid_arenaå‚æ•°ä¼ å…¥å› è€Œä¸ä¼šåˆé‡æ–°è·å–åˆ°main_arena</p>
<p>æœ€åå°†è·å–åˆ°çš„arenaï¼ˆ<strong>å¯èƒ½ä¸ºNULL</strong>ï¼‰è¿”å›ï¼Œè¯¥å‡½æ•°çš„æµç¨‹ä¾¿ç»“æŸäº†</p>
<h4 id="â‘¡é‡æ–°è°ƒç”¨-int-malloc-åˆ†é…å†…å­˜"><a href="#â‘¡é‡æ–°è°ƒç”¨-int-malloc-åˆ†é…å†…å­˜" class="headerlink" title="â‘¡é‡æ–°è°ƒç”¨_int_malloc()åˆ†é…å†…å­˜"></a>â‘¡é‡æ–°è°ƒç”¨_int_malloc()åˆ†é…å†…å­˜</h4><p>å”¯ä¸€éœ€è¦æ³¨æ„çš„ä¸€ç‚¹æˆ–è®¸å°±æ˜¯<code>_int_malloc()</code>å‡½æ•°è¿”å›çš„å†…å­˜æ˜¯memè€Œä¸æ˜¯chunkï¼Œå› æ­¤å¯ä»¥ç›´æ¥è¿”å›ç»™ç”¨æˆ·è¿›è¡Œä½¿ç”¨</p>
<h3 id="5-æ£€æµ‹æ— è¯¯åè¿”å›å†…å­˜å—"><a href="#5-æ£€æµ‹æ— è¯¯åè¿”å›å†…å­˜å—" class="headerlink" title="5.æ£€æµ‹æ— è¯¯åè¿”å›å†…å­˜å—"></a>5.æ£€æµ‹æ— è¯¯åè¿”å›å†…å­˜å—</h3><p>å¤§æ¦‚æ˜¯ä¼šæ£€æµ‹å¦‚ä¸‹ä¸‰ä¸ªç‚¹ï¼š</p>
<ul>
<li>æ‰€è·å¾—çš„å †å—<strong>æ˜¯å¦ä¸ºNULL</strong></li>
<li>è¯¥å †å—<strong>æ˜¯å¦æ˜¯é€šè¿‡mmapè·å¾—çš„</strong></li>
<li>ï¼ˆè‹¥è¯¥å †å—æ˜¯é€šè¿‡mmapè·å¾—çš„ï¼‰è¯¥å †å—<strong>æ‰€å±çš„arenaæ˜¯å¦ä¸ºæˆ‘ä»¬æ­¤å‰æ‰€ä½¿ç”¨çš„arena</strong></li>
</ul>
<p>åœ¨æœ€åä¸€æ­¥ä½¿ç”¨äº†<code>arena_for_chunk()</code>å®ï¼Œè¯¥å®å·²ç»åœ¨å‰é¢è§£æè¿‡äº†ï¼Œè¿™é‡Œä¾¿ä¸å†èµ˜å™ï¼Œç®€å•æ¥è¯´å°±æ˜¯<strong>è·å–ä¸€ä¸ªchunkæ‰€å±çš„arena</strong></p>
<p>è‹¥æ˜¯ä¸‰ä¸ªéƒ½æ²¡é€šè¿‡åˆ™è¯´æ˜å†…å­˜åˆ†é…è¿‡ç¨‹ä¸­å¯èƒ½å‡ºäº†é—®é¢˜ï¼Œåˆ™ä¼šç›´æ¥è§¦å‘assertï¼Œéšåabort()ç»ˆæ­¢è¿›ç¨‹ï¼Œcore dump</p>
<p>ä»»ä¸€æ£€æµ‹é€šè¿‡ï¼Œåˆ™å°†è·å–åˆ°çš„å †å—è¿”å›ç»™ä¸Šå±‚è°ƒç”¨çš„ç”¨æˆ·ï¼Œæ•´ä¸ªmallocçš„è¿›ç¨‹å°±ç»“æŸäº†</p>
<h2 id="libc-hidden-defï¼šå‡½æ•°å®šä¹‰éšè—"><a href="#libc-hidden-defï¼šå‡½æ•°å®šä¹‰éšè—" class="headerlink" title="libc_hidden_defï¼šå‡½æ•°å®šä¹‰éšè—"></a>libc_hidden_defï¼šå‡½æ•°å®šä¹‰éšè—</h2><p>ä¸libc_hidden_protoä¸€æ ·å®šä¹‰äºlibc-symbols.hä¸‹ï¼Œå¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">if</span> IS_IN (libc)</span></span><br><span class="line"><span class="meta"># <span class="keyword">define</span> libc_hidden_proto(name, attrs...) hidden_proto (name, ##attrs)</span></span><br><span class="line"><span class="meta"># <span class="keyword">define</span> libc_hidden_tls_proto(name, attrs...) hidden_tls_proto (name, ##attrs)</span></span><br><span class="line"><span class="meta"># <span class="keyword">define</span> libc_hidden_def(name) hidden_def (name)</span></span><br><span class="line">...</span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line"><span class="meta"># <span class="keyword">define</span> libc_hidden_proto(name, attrs...)</span></span><br><span class="line"><span class="meta"># <span class="keyword">define</span> libc_hidden_tls_proto(name, attrs...)</span></span><br><span class="line"><span class="meta"># <span class="keyword">define</span> libc_hidden_def(name)</span></span><br><span class="line">...</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure>

<p>åŒæ ·æ˜¯å¥—å¨ƒå®šä¹‰ï¼Œè½¬åˆ°hidden_defï¼Œå¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">if</span> defined SHARED &amp;&amp; !defined NO_HIDDEN</span></span><br><span class="line"><span class="meta"># <span class="keyword">ifndef</span> __ASSEMBLER__</span></span><br><span class="line">...</span><br><span class="line"><span class="meta">#  <span class="keyword">define</span> hidden_def(name)		__hidden_ver1(__GI_##name, name, name);</span></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="meta"># <span class="keyword">else</span></span></span><br><span class="line"><span class="comment">/* For assembly, we need to do the opposite of what we do in C:</span></span><br><span class="line"><span class="comment">   in assembly gcc __REDIRECT stuff is not in place, so functions</span></span><br><span class="line"><span class="comment">   are defined by its normal name and we need to create the</span></span><br><span class="line"><span class="comment">   __GI_* alias to it, in C __REDIRECT causes the function definition</span></span><br><span class="line"><span class="comment">   to use __GI_* name and we need to add alias to the real name.</span></span><br><span class="line"><span class="comment">   There is no reason to use hidden_weak over hidden_def in assembly,</span></span><br><span class="line"><span class="comment">   but we provide it for consistency with the C usage.</span></span><br><span class="line"><span class="comment">   hidden_proto doesn&#x27;t make sense for assembly but the equivalent</span></span><br><span class="line"><span class="comment">   is to call via the HIDDEN_JUMPTARGET macro instead of JUMPTARGET.  */</span></span><br><span class="line"><span class="meta">#  <span class="keyword">define</span> hidden_def(name)	strong_alias (name, __GI_##name)</span></span><br><span class="line">...</span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line"><span class="meta"># <span class="keyword">ifndef</span> __ASSEMBLER__</span></span><br><span class="line"><span class="meta">#  <span class="keyword">define</span> hidden_proto(name, attrs...)</span></span><br><span class="line"><span class="meta">#  <span class="keyword">define</span> hidden_tls_proto(name, attrs...)</span></span><br><span class="line"><span class="meta"># <span class="keyword">else</span></span></span><br><span class="line"><span class="meta">#  <span class="keyword">define</span> HIDDEN_JUMPTARGET(name) JUMPTARGET(name)</span></span><br><span class="line"><span class="meta"># <span class="keyword">endif</span> <span class="comment">/* Not  __ASSEMBLER__ */</span></span></span><br><span class="line"><span class="meta"># <span class="keyword">define</span> hidden_weak(name)</span></span><br><span class="line"><span class="meta"># <span class="keyword">define</span> hidden_def(name)</span></span><br><span class="line">...</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure>

<p>ä¸éš¾æƒ³åˆ°libc_hidden_def()å’Œæ­¤å‰çš„libc_hidden_protoæ˜¯ç›¸ç±»ä¼¼çš„ï¼Œåªä¸è¿‡è¯¥å®éšè—çš„æ˜¯å‡½æ•°å®šä¹‰ï¼Œè¿™é‡Œä¾¿ä¸å†å±•å¼€è¯´æ˜</p>
<h1 id="0x02-malloc-consolidate"><a href="#0x02-malloc-consolidate" class="headerlink" title="0x02.malloc_consolidate"></a>0x02.malloc_consolidate</h1><p>ç”±äºè¿™ä¸ªå‡½æ•°æ˜¯ptmallocä¸­ååˆ†é‡è¦çš„ä¸€ä¸ªå‡½æ•°ï¼ŒåŒæ—¶ä¹Ÿæ˜¯å„ç§pwné¢˜ä¸­ç»å¸¸ç”¨åˆ°çš„ä¸€ä¸ªå‡½æ•°ï¼Œæ•…æˆ‘ä»¬å…ˆæ¥è§£æå…¶ä»£ç </p>
<p>è¯¥å‡½æ•°å®šä¹‰äºmalloc.cä¸­ï¼Œç”¨ä»¥<strong>æ¸…ç©ºfastbinsä¸­chunkã€åˆå¹¶ç›¸é‚»ç©ºé—²chunk</strong>ï¼Œå¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">  ------------------------- malloc_consolidate -------------------------</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">  malloc_consolidate is a specialized version of free() that tears</span></span><br><span class="line"><span class="comment">  down chunks held in fastbins.  Free itself cannot be used for this</span></span><br><span class="line"><span class="comment">  purpose since, among other things, it might place chunks back onto</span></span><br><span class="line"><span class="comment">  fastbins.  So, instead, we need to use a minor variant of the same</span></span><br><span class="line"><span class="comment">  code.</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">  Also, because this routine needs to be called the first time through</span></span><br><span class="line"><span class="comment">  malloc anyway, it turns out to be the perfect place to trigger</span></span><br><span class="line"><span class="comment">  initialization code.</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">malloc_consolidate</span><span class="params">(mstate av)</span></span><br><span class="line">&#123;</span><br><span class="line">  mfastbinptr*    fb;                 <span class="comment">/* current fastbin being consolidated */</span></span><br><span class="line">  mfastbinptr*    maxfb;              <span class="comment">/* last fastbin (for loop control) */</span></span><br><span class="line">  mchunkptr       p;                  <span class="comment">/* current chunk being consolidated */</span></span><br><span class="line">  mchunkptr       nextp;              <span class="comment">/* next chunk to consolidate */</span></span><br><span class="line">  mchunkptr       unsorted_bin;       <span class="comment">/* bin header */</span></span><br><span class="line">  mchunkptr       first_unsorted;     <span class="comment">/* chunk to link to */</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/* These have same use as in free() */</span></span><br><span class="line">  mchunkptr       nextchunk;</span><br><span class="line">  INTERNAL_SIZE_T size;</span><br><span class="line">  INTERNAL_SIZE_T nextsize;</span><br><span class="line">  INTERNAL_SIZE_T prevsize;</span><br><span class="line">  <span class="type">int</span>             nextinuse;</span><br><span class="line">  mchunkptr       bck;</span><br><span class="line">  mchunkptr       fwd;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">    If max_fast is 0, we know that av hasn&#x27;t</span></span><br><span class="line"><span class="comment">    yet been initialized, in which case do so below</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (get_max_fast () != <span class="number">0</span>) &#123;</span><br><span class="line">    clear_fastchunks(av);</span><br><span class="line"></span><br><span class="line">    unsorted_bin = unsorted_chunks(av);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">      Remove each chunk from fast bin and consolidate it, placing it</span></span><br><span class="line"><span class="comment">      then in unsorted bin. Among other reasons for doing this,</span></span><br><span class="line"><span class="comment">      placing in unsorted bin avoids needing to calculate actual bins</span></span><br><span class="line"><span class="comment">      until malloc is sure that chunks aren&#x27;t immediately going to be</span></span><br><span class="line"><span class="comment">      reused anyway.</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line"></span><br><span class="line">    maxfb = &amp;fastbin (av, NFASTBINS - <span class="number">1</span>);</span><br><span class="line">    fb = &amp;fastbin (av, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">      p = atomic_exchange_acq (fb, <span class="number">0</span>);</span><br><span class="line">      <span class="keyword">if</span> (p != <span class="number">0</span>) &#123;</span><br><span class="line">	<span class="keyword">do</span> &#123;</span><br><span class="line">	  check_inuse_chunk(av, p);</span><br><span class="line">	  nextp = p-&gt;fd;</span><br><span class="line"></span><br><span class="line">	  <span class="comment">/* Slightly streamlined version of consolidation code in free() */</span></span><br><span class="line">	  size = p-&gt;size &amp; ~(PREV_INUSE|NON_MAIN_ARENA);</span><br><span class="line">	  nextchunk = chunk_at_offset(p, size);</span><br><span class="line">	  nextsize = chunksize(nextchunk);</span><br><span class="line"></span><br><span class="line">	  <span class="keyword">if</span> (!prev_inuse(p)) &#123;</span><br><span class="line">	    prevsize = p-&gt;prev_size;</span><br><span class="line">	    size += prevsize;</span><br><span class="line">	    p = chunk_at_offset(p, -((<span class="type">long</span>) prevsize));</span><br><span class="line">	    unlink(av, p, bck, fwd);</span><br><span class="line">	  &#125;</span><br><span class="line"></span><br><span class="line">	  <span class="keyword">if</span> (nextchunk != av-&gt;top) &#123;</span><br><span class="line">	    nextinuse = inuse_bit_at_offset(nextchunk, nextsize);</span><br><span class="line"></span><br><span class="line">	    <span class="keyword">if</span> (!nextinuse) &#123;</span><br><span class="line">	      size += nextsize;</span><br><span class="line">	      unlink(av, nextchunk, bck, fwd);</span><br><span class="line">	    &#125; <span class="keyword">else</span></span><br><span class="line">	      clear_inuse_bit_at_offset(nextchunk, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">	    first_unsorted = unsorted_bin-&gt;fd;</span><br><span class="line">	    unsorted_bin-&gt;fd = p;</span><br><span class="line">	    first_unsorted-&gt;bk = p;</span><br><span class="line"></span><br><span class="line">	    <span class="keyword">if</span> (!in_smallbin_range (size)) &#123;</span><br><span class="line">	      p-&gt;fd_nextsize = <span class="literal">NULL</span>;</span><br><span class="line">	      p-&gt;bk_nextsize = <span class="literal">NULL</span>;</span><br><span class="line">	    &#125;</span><br><span class="line"></span><br><span class="line">	    set_head(p, size | PREV_INUSE);</span><br><span class="line">	    p-&gt;bk = unsorted_bin;</span><br><span class="line">	    p-&gt;fd = first_unsorted;</span><br><span class="line">	    set_foot(p, size);</span><br><span class="line">	  &#125;</span><br><span class="line"></span><br><span class="line">	  <span class="keyword">else</span> &#123;</span><br><span class="line">	    size += nextsize;</span><br><span class="line">	    set_head(p, size | PREV_INUSE);</span><br><span class="line">	    av-&gt;top = p;</span><br><span class="line">	  &#125;</span><br><span class="line"></span><br><span class="line">	&#125; <span class="keyword">while</span> ( (p = nextp) != <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">while</span> (fb++ != maxfb);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> &#123;</span><br><span class="line">    malloc_init_state(av);</span><br><span class="line">    check_malloc_state(av);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>é¦–å…ˆä¼šå…ˆæ£€æŸ¥<strong>global_max_fast</strong>ï¼š</p>
<ul>
<li><strong>è‹¥ä¸ä¸º0åˆ™ä¼šè®¾ç½®è¯¥arenaçš„FASTCHUNKS_BITæ ‡å¿—ä½ï¼Œæ„å‘³ç€æ¥ä¸‹æ¥è¯¥å‡½æ•°ä¼šæ¸…ç©ºè¯¥arenaçš„fastbinä¸­çš„chunks</strong></li>
<li><strong>è‹¥ä¸º0åˆ™æ„å‘³ç€è¯¥çº¿ç¨‹çš„arenaæœªè¿›è¡Œåˆå§‹åŒ–</strong>ï¼Œæ­¤æ—¶ä¾¿ä¼š<strong>è°ƒç”¨malloc_init_state</strong>()<strong>å‡½æ•°åˆå§‹åŒ–è¯¥arenaï¼Œ</strong>éšåä½¿ç”¨check_malloc_state()å®è¿›è¡Œæ£€æŸ¥å<strong>è¯¥å‡½æ•°ä¾¿ç»“æŸäº†</strong>ï¼Œåœ¨éDEBUGæ¨¡å¼ä¸‹ï¼ˆæœªå®šä¹‰å®MALLOC_DEBUGï¼‰è¯¥å®ä¸ºç©º</li>
</ul>
<p>æ¥åœ¨å·²ç»åˆå§‹åŒ–çš„æƒ…å†µä¸‹æ¥ä¸‹æ¥ä¼š<strong>åˆ†åˆ«è·å–æŒ‡å‘arenaä¸­fastbinsYæ•°ç»„é¦–å°¾å…ƒç´ çš„æŒ‡é’ˆï¼Œç”¨ä»¥å¯¹fastbinsYæ•°ç»„è¿›è¡Œéå†ï¼Œ</strong>è¿™ä¸ªéå†ç”±ä¸¤å±‚å¾ªç¯åµŒå¥—è€Œæˆï¼š</p>
<h2 id="å¤–å±‚å¾ªç¯ï¼šéå†fastbinsYæ•°ç»„å…ƒç´ "><a href="#å¤–å±‚å¾ªç¯ï¼šéå†fastbinsYæ•°ç»„å…ƒç´ " class="headerlink" title="å¤–å±‚å¾ªç¯ï¼šéå†fastbinsYæ•°ç»„å…ƒç´ "></a>å¤–å±‚å¾ªç¯ï¼šéå†fastbinsYæ•°ç»„å…ƒç´ </h2><p>æˆ‘ä»¬å•ç‹¬å°†è¿™ä¸ªå¾ªç¯åµŒå¥—æ‹¿å‡ºæ¥çœ‹ä¸ºå¦‚ä¸‹å½¢å¼ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">do</span> &#123;</span><br><span class="line">	p = atomic_exchange_acq (fb, <span class="number">0</span>);</span><br><span class="line">	<span class="keyword">if</span> (p != <span class="number">0</span>) </span><br><span class="line">    &#123;</span><br><span class="line">		<span class="keyword">do</span> &#123;</span><br><span class="line">	  		<span class="comment">// inner loop there</span></span><br><span class="line">		&#125; <span class="keyword">while</span> ( (p = nextp) != <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125; <span class="keyword">while</span> (fb++ != maxfb);</span><br></pre></td></tr></table></figure>

<p>æˆ‘ä»¬ä¸éš¾çœ‹å‡ºå¤–å±‚å¾ªç¯çš„ä½œç”¨ä¾¿æ˜¯<strong>é€ä¸ªå–å‡ºfastbinsYæ•°ç»„ä¸­å…ƒç´ ï¼Œéšåäº¤ç”±å†…å±‚å¾ªç¯è¿›è¡Œä¸‹ä¸€æ­¥çš„å¤„ç†</strong></p>
<p>åœ¨è¿™é‡Œä½¿ç”¨äº†ä¸€ä¸ªå®<code>atomic_exchange_acq()</code>ï¼Œç”¨é€”æ˜¯<strong>é€šè¿‡åŸå­è¯»æ“ä½œè®¾ç½®æ–°å€¼ï¼Œè¿”å›æ—§å€¼</strong>ï¼Œå‰é¢å·²è§£æè¿‡ç±»ä¼¼å®ï¼Œè¿™é‡Œä¾¿ä¸å†èµ˜å™</p>
<p>è™½ç„¶å‰æ–‡æˆ‘ä»¬æœ‰è®²åˆ°fastbinsYæ•°ç»„çš„ä¸‹æ ‡åŒ…æ‹¬7åŠå¾€åéƒ½æ˜¯ç”¨ä¸åˆ°çš„ï¼Œä½†æ˜¯åœ¨è¿™é‡Œä»ä¼šå°è¯•å¯¹é½è¿›è¡Œéå†</p>
<h3 id="å†…å±‚å¾ªç¯ï¼šéå†fastbin-é“¾è¡¨ã€åˆå¹¶ç©ºé—²chunk"><a href="#å†…å±‚å¾ªç¯ï¼šéå†fastbin-é“¾è¡¨ã€åˆå¹¶ç©ºé—²chunk" class="headerlink" title="å†…å±‚å¾ªç¯ï¼šéå†fastbin é“¾è¡¨ã€åˆå¹¶ç©ºé—²chunk"></a>å†…å±‚å¾ªç¯ï¼šéå†fastbin é“¾è¡¨ã€åˆå¹¶ç©ºé—²chunk</h3><p>åœ¨å†…å±‚å¾ªç¯ä¸­ä¼šä»æˆ‘ä»¬ä»å¤–å±‚å¾ªç¯ä¸­æ‰€å–å¾—çš„fastbinsé“¾è¡¨çš„å¤´ç»“ç‚¹å¼€å§‹è¿›è¡Œéå†ï¼Œå¹¶è¿›è¡Œç©ºé—²chunkçš„åˆå¹¶ä»¥å‡å°‘å†…å­˜ç¢ç‰‡</p>
<p>è‹¥<strong>è·å–åˆ°çš„å¤´ç»“ç‚¹ä¸ºNULLåˆ™ä¼šç›´æ¥è·³è¿‡è¯¥å±‚å¾ªç¯</strong>ï¼Œå¦åˆ™è¿›å…¥ä¸‹é¢çš„æ­¥éª¤</p>
<p>åœ¨è¿™é‡Œæœ‰ä¸€ä¸ªå®<code>check_inuse_chunk()</code>ï¼Œè¯¥å®åœ¨éDEBUGæ¨¡å¼ä¸‹ï¼ˆå®MALLOC_DEBUG undefinedï¼‰ä¹Ÿä¸ºç©º</p>
<p>é¦–å…ˆä¼šè·å–è¯¥èŠ‚ç‚¹chunkçš„sizeï¼Œåœ¨è¿™é‡Œ<strong>è·å–åˆ°çš„sizeæ¸…é™¤äº†PREV_INUSEæ ‡å¿—ä½ä¸NON_MAIN_ARENAæ ‡å¿—ä½</strong>ï¼Œè¿™æ˜¯ä¸ºäº†åœ¨åé¢çš„åˆå¹¶è¿‡ç¨‹ä¸­èƒ½å¤Ÿå‡†ç¡®åœ°è·å–åˆ°é«˜åœ°å€ç›¸é‚»chunkçš„ä½ç½®</p>
<blockquote>
<p>è¯´èµ·æ¥ç½‘ä¸Šå¾ˆå¤šå…³äºmalloc_consolidate()çš„åšå®¢éƒ½æœ‰è®²åˆ°æ‰€è°“ã€Œå‰å‘åˆå¹¶ã€å’Œã€Œåå‘åˆå¹¶ã€ï¼Œä½†æ˜¯å“ªè¾¹æ˜¯å‰å“ªè¾¹æ˜¯åç¬”è€…æš‚ä¸”è’™åœ¨å¤é‡Œï¼ˆæ³¨é‡Šé‡Œç¬”è€…ä¹Ÿæ²¡çœ‹åˆ°forward&#x2F;backwardâ€¦</p>
<p>é‚£ä¹ˆä¸‹æ–‡æˆ‘ä»¬æŒ‰ç…§å¯¹å…¶ç§°å‘¼çš„æƒ¯ä¾‹åšå‡ºå¦‚ä¸‹çº¦å®šï¼šå°†<strong>å‘é«˜åœ°å€çš„åˆå¹¶ç§°ä¸ºã€Œå‰å‘åˆå¹¶ã€ï¼Œå‘ä½åœ°å€çš„åˆå¹¶ç§°ä¸ºã€Œåå‘åˆå¹¶ã€</strong></p>
</blockquote>
<h4 id="â‘ åå‘åˆå¹¶ï¼šä½¿ç”¨unlinkå–å‡ºç›¸é‚»ä½åœ°å€chunkï¼ˆè‹¥å·²freeï¼‰"><a href="#â‘ åå‘åˆå¹¶ï¼šä½¿ç”¨unlinkå–å‡ºç›¸é‚»ä½åœ°å€chunkï¼ˆè‹¥å·²freeï¼‰" class="headerlink" title="â‘ åå‘åˆå¹¶ï¼šä½¿ç”¨unlinkå–å‡ºç›¸é‚»ä½åœ°å€chunkï¼ˆè‹¥å·²freeï¼‰"></a>â‘ åå‘åˆå¹¶ï¼šä½¿ç”¨unlinkå–å‡ºç›¸é‚»ä½åœ°å€chunkï¼ˆè‹¥å·²freeï¼‰</h4><p>é¦–å…ˆä¼š<strong>æ£€æŸ¥è¯¥chunkçš„PREV_IN_USEæ ‡å¿—ä½ï¼Œè‹¥ä¸ä¸º1åˆ™è¯´æ˜ä½åœ°å€ç›¸é‚»chunkå¿…ä¸ºå­˜æ”¾åœ¨binsæ•°ç»„ä¸­çš„free chunk</strong>ï¼Œè¿™æ˜¯å› ä¸º<strong>å½“ä¸€ä¸ªchunkè¢«ä½¿ç”¨ä¸­&#x2F;è¢«æ”¾å…¥fastbinä¸­ï¼Œå…¶ç›¸é‚»é«˜åœ°å€çš„chunkçš„PREV_INUSEæ ‡å¿—ä½éƒ½ä¸ä¼šè¢«æ¸…é™¤ï¼Œåªæœ‰æ”¾å…¥binsä¸­æ‰ä¼šæ¸…é™¤è¯¥æ ‡å¿—ä½</strong>ï¼Œç›¸å…³æœºåˆ¶æˆ‘ä»¬ä¼šåœ¨åæ–‡çš„_int_free()å‡½æ•°ä¸­è¯¦ç»†è¿›è¡Œåˆ†æ</p>
<p>è¿™ç§æƒ…å†µä¸‹ä¼š<strong>åœ¨å‰é¢çš„sizeå˜é‡ä¸­åŠ ä¸ŠåŸchunkçš„prevsizeåŸŸçš„å€¼ï¼Œå°†chunkæŒ‡é’ˆç§»åŠ¨è‡³æŒ‡å‘è¯¥ç©ºé—²chunkï¼Œå¦‚ä¸‹å›¾æ‰€ç¤º</strong></p>
<p><img src="https://i.loli.net/2021/01/23/GqBQHD12NtAESkT.png" alt="image.png"></p>
<p><strong>æœ€åä½¿ç”¨unlinkå®ä»binsä¸­å–å‡ºè¯¥chunk</strong>ï¼Œåå‘åˆå¹¶çš„è¿‡ç¨‹å°±å®Œæˆäº†</p>
<p><img src="https://i.loli.net/2021/01/23/pKVSclCIunvofOm.png" alt="image.png"></p>
<p>éœ€è¦æ³¨æ„çš„æ˜¯åœ¨è¿™é‡Œæ˜¯<strong>ä½¿ç”¨åŸchunkçš„prevsizeåŸŸè®¡ç®—è¯¥ç©ºé—²chunkçš„å¤§å°ï¼Œè€Œå¹¶éç›´æ¥ä½¿ç”¨ä½åœ°å€ç©ºé—²chunkçš„sizeåŸŸ</strong></p>
<h4 id="â‘¡å‰å‘åˆå¹¶ï¼šè‹¥ä¸ºtop-chunkåˆ™åˆå¹¶å…¥top-chunkä¸­ï¼Œå¦åˆ™ä¼šå°è¯•åˆå¹¶åæ’å…¥unsorted-binä¸­"><a href="#â‘¡å‰å‘åˆå¹¶ï¼šè‹¥ä¸ºtop-chunkåˆ™åˆå¹¶å…¥top-chunkä¸­ï¼Œå¦åˆ™ä¼šå°è¯•åˆå¹¶åæ’å…¥unsorted-binä¸­" class="headerlink" title="â‘¡å‰å‘åˆå¹¶ï¼šè‹¥ä¸ºtop chunkåˆ™åˆå¹¶å…¥top chunkä¸­ï¼Œå¦åˆ™ä¼šå°è¯•åˆå¹¶åæ’å…¥unsorted_binä¸­"></a>â‘¡å‰å‘åˆå¹¶ï¼šè‹¥ä¸ºtop chunkåˆ™åˆå¹¶å…¥top chunkä¸­ï¼Œå¦åˆ™ä¼šå°è¯•åˆå¹¶åæ’å…¥unsorted_binä¸­</h4><h5 id="1ï¼‰nextchunkä¸ºtop-chunk"><a href="#1ï¼‰nextchunkä¸ºtop-chunk" class="headerlink" title="1ï¼‰nextchunkä¸ºtop chunk"></a>1ï¼‰nextchunkä¸ºtop chunk</h5><p>é¦–å…ˆä¼šæ£€æŸ¥nextchunkæ˜¯å¦ä¸ºtop chunkï¼Œè‹¥æ˜¯åˆ™æµç¨‹ä¼šç®€ä¾¿å¾—å¤šï¼š<strong>å°†è¯¥chunkçš„sizeåŠ ä¸Šnextchunkçš„sizeï¼Œè®¾ç½®PREV_INUSEæ ‡å¿—ä½ï¼Œå°†arenaçš„top chunkè®¾ç½®ä¸ºè¯¥chunkåä¾¿è¿›å…¥ä¸‹ä¸€æ­¥</strong></p>
<p><img src="https://i.loli.net/2021/01/23/QF5vhAYbGeqf4C9.png" alt="image.png"></p>
<h5 id="5ï¼‰nextchunkä¸ä¸ºtop-chunk"><a href="#5ï¼‰nextchunkä¸ä¸ºtop-chunk" class="headerlink" title="5ï¼‰nextchunkä¸ä¸ºtop chunk"></a>5ï¼‰nextchunkä¸ä¸ºtop chunk</h5><p>è‹¥nextchunkä¸ä¸ºtop chunkï¼Œåˆ™<strong>é¦–å…ˆä¼šæ£€æŸ¥nextchunkçš„ç‰©ç†ç›¸é‚»é«˜åœ°å€chunkçš„PREV_INUSEæ ‡å¿—ä½</strong></p>
<ul>
<li><strong>è‹¥ä¸ä¸º0åˆ™ä¼šæ¸…é™¤nextchunkçš„PREV_INSUEä½</strong></li>
</ul>
<p><img src="https://i.loli.net/2021/01/23/YVaFRKonG4WBuXM.png" alt="image.png"></p>
<ul>
<li><strong>è‹¥ä¸º0åˆ™ä½¿ç”¨unlinkå°†nextchunkä»binsä¸­å–å‡º</strong></li>
</ul>
<p><img src="https://i.loli.net/2021/01/23/LEBAKhTbSMlCcVr.png" alt="image.png"></p>
<p>æ¥ä¸‹æ¥ä¼š<strong>å°†è¯¥chunkæ”¾å…¥unsorted binä¸­ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯åœ¨è¿™é‡Œä½¿ç”¨çš„æ˜¯å¤´æ’æ³•ä½¿å…¶æˆä¸ºunsorted binçš„å¤´ç»“ç‚¹</strong></p>
<p><img src="https://i.loli.net/2021/01/23/BNJIPrGL9eTvX8U.png" alt="image.png"></p>
<p>æ¥ä¸‹æ¥ä¼šæ£€æŸ¥chunkæœ€ç»ˆçš„å¤§å°ï¼Œ<strong>è‹¥æ˜¯sizeä¸å¤„äºsmallbinsèŒƒå›´å†…åˆ™ä¼šè®¾ç½®å…¶fd_nextsizeä¸bk_nextsizeä¸ºNULL</strong></p>
<p>æœ€åï¼Œ<strong>è®¾ç½®è¯¥chunkçš„PREV_INUSEä½ä¸º1</strong>ï¼Œè®¾ç½®<strong>å½“å‰æƒ…å†µä¸‹çš„ç‰©ç†ç›¸é‚»chunkçš„prevsizeåŸŸä¸ºè¯¥chunkçš„size</strong></p>
<p><img src="https://i.loli.net/2021/01/23/5b7qYPjO1AmXkyF.png" alt="image.png"></p>
<h4 id="â‘¢æ£€æŸ¥é“¾è¡¨ä¸­çš„ä¸‹ä¸€ä¸ªchunkï¼Œä¸ä¸ºNULLåˆ™ç»§ç»­æ–°ä¸€è½®å¾ªç¯"><a href="#â‘¢æ£€æŸ¥é“¾è¡¨ä¸­çš„ä¸‹ä¸€ä¸ªchunkï¼Œä¸ä¸ºNULLåˆ™ç»§ç»­æ–°ä¸€è½®å¾ªç¯" class="headerlink" title="â‘¢æ£€æŸ¥é“¾è¡¨ä¸­çš„ä¸‹ä¸€ä¸ªchunkï¼Œä¸ä¸ºNULLåˆ™ç»§ç»­æ–°ä¸€è½®å¾ªç¯"></a>â‘¢æ£€æŸ¥é“¾è¡¨ä¸­çš„ä¸‹ä¸€ä¸ªchunkï¼Œä¸ä¸ºNULLåˆ™ç»§ç»­æ–°ä¸€è½®å¾ªç¯</h4><p>è™½ç„¶chunkæŒ‡é’ˆå¯èƒ½åœ¨åˆå¹¶ä¸­è¢«ä¿®æ”¹ï¼Œä½†æ˜¯æˆ‘ä»¬åœ¨å‰é¢å·²ç»ä¿å­˜äº†å…¶fdï¼Œè‹¥ä¸ä¸ºNULLåˆ™è¿›è¡Œä¸‹ä¸€è½®å¾ªç¯ï¼Œæ•…å¯ä»¥ç»§ç»­éå†é“¾è¡¨çš„è¿›ç¨‹</p>
<h1 id="0x03-int-malloc"><a href="#0x03-int-malloc" class="headerlink" title="0x03._int_malloc"></a>0x03._int_malloc</h1><p>è¯¥å‡½æ•°ä¸º<strong>ptmallocå†…å­˜åˆ†é…æœºåˆ¶çš„æ ¸å¿ƒå‡½æ•°</strong>ï¼Œå®šä¹‰äºmalloc.cä¸­ï¼Œå¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">   ------------------------------ malloc ------------------------------</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> *</span><br><span class="line">_int_malloc (mstate av, <span class="type">size_t</span> bytes)</span><br><span class="line">&#123;</span><br><span class="line">  INTERNAL_SIZE_T nb;               <span class="comment">/* normalized request size */</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> idx;                 <span class="comment">/* associated bin index */</span></span><br><span class="line">  mbinptr bin;                      <span class="comment">/* associated bin */</span></span><br><span class="line"></span><br><span class="line">  mchunkptr victim;                 <span class="comment">/* inspected/selected chunk */</span></span><br><span class="line">  INTERNAL_SIZE_T size;             <span class="comment">/* its size */</span></span><br><span class="line">  <span class="type">int</span> victim_index;                 <span class="comment">/* its bin index */</span></span><br><span class="line"></span><br><span class="line">  mchunkptr remainder;              <span class="comment">/* remainder from a split */</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">long</span> remainder_size;     <span class="comment">/* its size */</span></span><br><span class="line"></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> block;               <span class="comment">/* bit map traverser */</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> bit;                 <span class="comment">/* bit map traverser */</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> <span class="built_in">map</span>;                 <span class="comment">/* current word of binmap */</span></span><br><span class="line"></span><br><span class="line">  mchunkptr fwd;                    <span class="comment">/* misc temp for linking */</span></span><br><span class="line">  mchunkptr bck;                    <span class="comment">/* misc temp for linking */</span></span><br><span class="line"></span><br><span class="line">  <span class="type">const</span> <span class="type">char</span> *errstr = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">     Convert request size to internal form by adding SIZE_SZ bytes</span></span><br><span class="line"><span class="comment">     overhead plus possibly more to obtain necessary alignment and/or</span></span><br><span class="line"><span class="comment">     to obtain a size of at least MINSIZE, the smallest allocatable</span></span><br><span class="line"><span class="comment">     size. Also, checked_request2size traps (returning 0) request sizes</span></span><br><span class="line"><span class="comment">     that are so large that they wrap around zero when padded and</span></span><br><span class="line"><span class="comment">     aligned.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line"></span><br><span class="line">  checked_request2size (bytes, nb);</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* There are no usable arenas.  Fall back to sysmalloc to get a chunk from</span></span><br><span class="line"><span class="comment">     mmap.  */</span></span><br><span class="line">  <span class="keyword">if</span> (__glibc_unlikely (av == <span class="literal">NULL</span>))</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="type">void</span> *p = sysmalloc (nb, av);</span><br><span class="line">      <span class="keyword">if</span> (p != <span class="literal">NULL</span>)</span><br><span class="line">	alloc_perturb (p, bytes);</span><br><span class="line">      <span class="keyword">return</span> p;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">     If the size qualifies as a fastbin, first check corresponding bin.</span></span><br><span class="line"><span class="comment">     This code is safe to execute even if av is not yet initialized, so we</span></span><br><span class="line"><span class="comment">     can try it without checking, which saves some time on this fast path.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ((<span class="type">unsigned</span> <span class="type">long</span>) (nb) &lt;= (<span class="type">unsigned</span> <span class="type">long</span>) (get_max_fast ()))</span><br><span class="line">    &#123;</span><br><span class="line">      idx = fastbin_index (nb);</span><br><span class="line">      mfastbinptr *fb = &amp;fastbin (av, idx);</span><br><span class="line">      mchunkptr pp = *fb;</span><br><span class="line">      <span class="keyword">do</span></span><br><span class="line">        &#123;</span><br><span class="line">          victim = pp;</span><br><span class="line">          <span class="keyword">if</span> (victim == <span class="literal">NULL</span>)</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">      <span class="keyword">while</span> ((pp = catomic_compare_and_exchange_val_acq (fb, victim-&gt;fd, victim))</span><br><span class="line">             != victim);</span><br><span class="line">      <span class="keyword">if</span> (victim != <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="keyword">if</span> (__builtin_expect (fastbin_index (chunksize (victim)) != idx, <span class="number">0</span>))</span><br><span class="line">            &#123;</span><br><span class="line">              errstr = <span class="string">&quot;malloc(): memory corruption (fast)&quot;</span>;</span><br><span class="line">            errout:</span><br><span class="line">              malloc_printerr (check_action, errstr, chunk2mem (victim), av);</span><br><span class="line">              <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">            &#125;</span><br><span class="line">          check_remalloced_chunk (av, victim, nb);</span><br><span class="line">          <span class="type">void</span> *p = chunk2mem (victim);</span><br><span class="line">          alloc_perturb (p, bytes);</span><br><span class="line">          <span class="keyword">return</span> p;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">     If a small request, check regular bin.  Since these &quot;smallbins&quot;</span></span><br><span class="line"><span class="comment">     hold one size each, no searching within bins is necessary.</span></span><br><span class="line"><span class="comment">     (For a large request, we need to wait until unsorted chunks are</span></span><br><span class="line"><span class="comment">     processed to find best fit. But for small ones, fits are exact</span></span><br><span class="line"><span class="comment">     anyway, so we can check now, which is faster.)</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (in_smallbin_range (nb))</span><br><span class="line">    &#123;</span><br><span class="line">      idx = smallbin_index (nb);</span><br><span class="line">      bin = bin_at (av, idx);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> ((victim = last (bin)) != bin)</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="keyword">if</span> (victim == <span class="number">0</span>) <span class="comment">/* initialization check */</span></span><br><span class="line">            malloc_consolidate (av);</span><br><span class="line">          <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">              bck = victim-&gt;bk;</span><br><span class="line">	<span class="keyword">if</span> (__glibc_unlikely (bck-&gt;fd != victim))</span><br><span class="line">                &#123;</span><br><span class="line">                  errstr = <span class="string">&quot;malloc(): smallbin double linked list corrupted&quot;</span>;</span><br><span class="line">                  <span class="keyword">goto</span> errout;</span><br><span class="line">                &#125;</span><br><span class="line">              set_inuse_bit_at_offset (victim, nb);</span><br><span class="line">              bin-&gt;bk = bck;</span><br><span class="line">              bck-&gt;fd = bin;</span><br><span class="line"></span><br><span class="line">              <span class="keyword">if</span> (av != &amp;main_arena)</span><br><span class="line">                victim-&gt;size |= NON_MAIN_ARENA;</span><br><span class="line">              check_malloced_chunk (av, victim, nb);</span><br><span class="line">              <span class="type">void</span> *p = chunk2mem (victim);</span><br><span class="line">              alloc_perturb (p, bytes);</span><br><span class="line">              <span class="keyword">return</span> p;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">     If this is a large request, consolidate fastbins before continuing.</span></span><br><span class="line"><span class="comment">     While it might look excessive to kill all fastbins before</span></span><br><span class="line"><span class="comment">     even seeing if there is space available, this avoids</span></span><br><span class="line"><span class="comment">     fragmentation problems normally associated with fastbins.</span></span><br><span class="line"><span class="comment">     Also, in practice, programs tend to have runs of either small or</span></span><br><span class="line"><span class="comment">     large requests, but less often mixtures, so consolidation is not</span></span><br><span class="line"><span class="comment">     invoked all that often in most programs. And the programs that</span></span><br><span class="line"><span class="comment">     it is called frequently in otherwise tend to fragment.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      idx = largebin_index (nb);</span><br><span class="line">      <span class="keyword">if</span> (have_fastchunks (av))</span><br><span class="line">        malloc_consolidate (av);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">     Process recently freed or remaindered chunks, taking one only if</span></span><br><span class="line"><span class="comment">     it is exact fit, or, if this a small request, the chunk is remainder from</span></span><br><span class="line"><span class="comment">     the most recent non-exact fit.  Place other traversed chunks in</span></span><br><span class="line"><span class="comment">     bins.  Note that this step is the only place in any routine where</span></span><br><span class="line"><span class="comment">     chunks are placed in bins.</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">     The outer loop here is needed because we might not realize until</span></span><br><span class="line"><span class="comment">     near the end of malloc that we should have consolidated, so must</span></span><br><span class="line"><span class="comment">     do so and retry. This happens at most once, and only when we would</span></span><br><span class="line"><span class="comment">     otherwise need to expand memory to service a &quot;small&quot; request.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (;; )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="type">int</span> iters = <span class="number">0</span>;</span><br><span class="line">      <span class="keyword">while</span> ((victim = unsorted_chunks (av)-&gt;bk) != unsorted_chunks (av))</span><br><span class="line">        &#123;</span><br><span class="line">          bck = victim-&gt;bk;</span><br><span class="line">          <span class="keyword">if</span> (__builtin_expect (victim-&gt;size &lt;= <span class="number">2</span> * SIZE_SZ, <span class="number">0</span>)</span><br><span class="line">              || __builtin_expect (victim-&gt;size &gt; av-&gt;system_mem, <span class="number">0</span>))</span><br><span class="line">            malloc_printerr (check_action, <span class="string">&quot;malloc(): memory corruption&quot;</span>,</span><br><span class="line">                             chunk2mem (victim), av);</span><br><span class="line">          size = chunksize (victim);</span><br><span class="line"></span><br><span class="line">          <span class="comment">/*</span></span><br><span class="line"><span class="comment">             If a small request, try to use last remainder if it is the</span></span><br><span class="line"><span class="comment">             only chunk in unsorted bin.  This helps promote locality for</span></span><br><span class="line"><span class="comment">             runs of consecutive small requests. This is the only</span></span><br><span class="line"><span class="comment">             exception to best-fit, and applies only when there is</span></span><br><span class="line"><span class="comment">             no exact fit for a small chunk.</span></span><br><span class="line"><span class="comment">           */</span></span><br><span class="line"></span><br><span class="line">          <span class="keyword">if</span> (in_smallbin_range (nb) &amp;&amp;</span><br><span class="line">              bck == unsorted_chunks (av) &amp;&amp;</span><br><span class="line">              victim == av-&gt;last_remainder &amp;&amp;</span><br><span class="line">              (<span class="type">unsigned</span> <span class="type">long</span>) (size) &gt; (<span class="type">unsigned</span> <span class="type">long</span>) (nb + MINSIZE))</span><br><span class="line">            &#123;</span><br><span class="line">              <span class="comment">/* split and reattach remainder */</span></span><br><span class="line">              remainder_size = size - nb;</span><br><span class="line">              remainder = chunk_at_offset (victim, nb);</span><br><span class="line">              unsorted_chunks (av)-&gt;bk = unsorted_chunks (av)-&gt;fd = remainder;</span><br><span class="line">              av-&gt;last_remainder = remainder;</span><br><span class="line">              remainder-&gt;bk = remainder-&gt;fd = unsorted_chunks (av);</span><br><span class="line">              <span class="keyword">if</span> (!in_smallbin_range (remainder_size))</span><br><span class="line">                &#123;</span><br><span class="line">                  remainder-&gt;fd_nextsize = <span class="literal">NULL</span>;</span><br><span class="line">                  remainder-&gt;bk_nextsize = <span class="literal">NULL</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">              set_head (victim, nb | PREV_INUSE |</span><br><span class="line">                        (av != &amp;main_arena ? NON_MAIN_ARENA : <span class="number">0</span>));</span><br><span class="line">              set_head (remainder, remainder_size | PREV_INUSE);</span><br><span class="line">              set_foot (remainder, remainder_size);</span><br><span class="line"></span><br><span class="line">              check_malloced_chunk (av, victim, nb);</span><br><span class="line">              <span class="type">void</span> *p = chunk2mem (victim);</span><br><span class="line">              alloc_perturb (p, bytes);</span><br><span class="line">              <span class="keyword">return</span> p;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">          <span class="comment">/* remove from unsorted list */</span></span><br><span class="line">          unsorted_chunks (av)-&gt;bk = bck;</span><br><span class="line">          bck-&gt;fd = unsorted_chunks (av);</span><br><span class="line"></span><br><span class="line">          <span class="comment">/* Take now instead of binning if exact fit */</span></span><br><span class="line"></span><br><span class="line">          <span class="keyword">if</span> (size == nb)</span><br><span class="line">            &#123;</span><br><span class="line">              set_inuse_bit_at_offset (victim, size);</span><br><span class="line">              <span class="keyword">if</span> (av != &amp;main_arena)</span><br><span class="line">                victim-&gt;size |= NON_MAIN_ARENA;</span><br><span class="line">              check_malloced_chunk (av, victim, nb);</span><br><span class="line">              <span class="type">void</span> *p = chunk2mem (victim);</span><br><span class="line">              alloc_perturb (p, bytes);</span><br><span class="line">              <span class="keyword">return</span> p;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">          <span class="comment">/* place chunk in bin */</span></span><br><span class="line"></span><br><span class="line">          <span class="keyword">if</span> (in_smallbin_range (size))</span><br><span class="line">            &#123;</span><br><span class="line">              victim_index = smallbin_index (size);</span><br><span class="line">              bck = bin_at (av, victim_index);</span><br><span class="line">              fwd = bck-&gt;fd;</span><br><span class="line">            &#125;</span><br><span class="line">          <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">              victim_index = largebin_index (size);</span><br><span class="line">              bck = bin_at (av, victim_index);</span><br><span class="line">              fwd = bck-&gt;fd;</span><br><span class="line"></span><br><span class="line">              <span class="comment">/* maintain large bins in sorted order */</span></span><br><span class="line">              <span class="keyword">if</span> (fwd != bck)</span><br><span class="line">                &#123;</span><br><span class="line">                  <span class="comment">/* Or with inuse bit to speed comparisons */</span></span><br><span class="line">                  size |= PREV_INUSE;</span><br><span class="line">                  <span class="comment">/* if smaller than smallest, bypass loop below */</span></span><br><span class="line">                  assert ((bck-&gt;bk-&gt;size &amp; NON_MAIN_ARENA) == <span class="number">0</span>);</span><br><span class="line">                  <span class="keyword">if</span> ((<span class="type">unsigned</span> <span class="type">long</span>) (size) &lt; (<span class="type">unsigned</span> <span class="type">long</span>) (bck-&gt;bk-&gt;size))</span><br><span class="line">                    &#123;</span><br><span class="line">                      fwd = bck;</span><br><span class="line">                      bck = bck-&gt;bk;</span><br><span class="line"></span><br><span class="line">                      victim-&gt;fd_nextsize = fwd-&gt;fd;</span><br><span class="line">                      victim-&gt;bk_nextsize = fwd-&gt;fd-&gt;bk_nextsize;</span><br><span class="line">                      fwd-&gt;fd-&gt;bk_nextsize = victim-&gt;bk_nextsize-&gt;fd_nextsize = victim;</span><br><span class="line">                    &#125;</span><br><span class="line">                  <span class="keyword">else</span></span><br><span class="line">                    &#123;</span><br><span class="line">                      assert ((fwd-&gt;size &amp; NON_MAIN_ARENA) == <span class="number">0</span>);</span><br><span class="line">                      <span class="keyword">while</span> ((<span class="type">unsigned</span> <span class="type">long</span>) size &lt; fwd-&gt;size)</span><br><span class="line">                        &#123;</span><br><span class="line">                          fwd = fwd-&gt;fd_nextsize;</span><br><span class="line">                          assert ((fwd-&gt;size &amp; NON_MAIN_ARENA) == <span class="number">0</span>);</span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                      <span class="keyword">if</span> ((<span class="type">unsigned</span> <span class="type">long</span>) size == (<span class="type">unsigned</span> <span class="type">long</span>) fwd-&gt;size)</span><br><span class="line">                        <span class="comment">/* Always insert in the second position.  */</span></span><br><span class="line">                        fwd = fwd-&gt;fd;</span><br><span class="line">                      <span class="keyword">else</span></span><br><span class="line">                        &#123;</span><br><span class="line">                          victim-&gt;fd_nextsize = fwd;</span><br><span class="line">                          victim-&gt;bk_nextsize = fwd-&gt;bk_nextsize;</span><br><span class="line">                          fwd-&gt;bk_nextsize = victim;</span><br><span class="line">                          victim-&gt;bk_nextsize-&gt;fd_nextsize = victim;</span><br><span class="line">                        &#125;</span><br><span class="line">                      bck = fwd-&gt;bk;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">              <span class="keyword">else</span></span><br><span class="line">                victim-&gt;fd_nextsize = victim-&gt;bk_nextsize = victim;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">          mark_bin (av, victim_index);</span><br><span class="line">          victim-&gt;bk = bck;</span><br><span class="line">          victim-&gt;fd = fwd;</span><br><span class="line">          fwd-&gt;bk = victim;</span><br><span class="line">          bck-&gt;fd = victim;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MAX_ITERS       10000</span></span><br><span class="line">          <span class="keyword">if</span> (++iters &gt;= MAX_ITERS)</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">/*</span></span><br><span class="line"><span class="comment">         If a large request, scan through the chunks of current bin in</span></span><br><span class="line"><span class="comment">         sorted order to find smallest that fits.  Use the skip list for this.</span></span><br><span class="line"><span class="comment">       */</span></span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (!in_smallbin_range (nb))</span><br><span class="line">        &#123;</span><br><span class="line">          bin = bin_at (av, idx);</span><br><span class="line"></span><br><span class="line">          <span class="comment">/* skip scan if empty or largest chunk is too small */</span></span><br><span class="line">          <span class="keyword">if</span> ((victim = first (bin)) != bin &amp;&amp;</span><br><span class="line">              (<span class="type">unsigned</span> <span class="type">long</span>) (victim-&gt;size) &gt;= (<span class="type">unsigned</span> <span class="type">long</span>) (nb))</span><br><span class="line">            &#123;</span><br><span class="line">              victim = victim-&gt;bk_nextsize;</span><br><span class="line">              <span class="keyword">while</span> (((<span class="type">unsigned</span> <span class="type">long</span>) (size = chunksize (victim)) &lt;</span><br><span class="line">                      (<span class="type">unsigned</span> <span class="type">long</span>) (nb)))</span><br><span class="line">                victim = victim-&gt;bk_nextsize;</span><br><span class="line"></span><br><span class="line">              <span class="comment">/* Avoid removing the first entry for a size so that the skip</span></span><br><span class="line"><span class="comment">                 list does not have to be rerouted.  */</span></span><br><span class="line">              <span class="keyword">if</span> (victim != last (bin) &amp;&amp; victim-&gt;size == victim-&gt;fd-&gt;size)</span><br><span class="line">                victim = victim-&gt;fd;</span><br><span class="line"></span><br><span class="line">              remainder_size = size - nb;</span><br><span class="line">              unlink (av, victim, bck, fwd);</span><br><span class="line"></span><br><span class="line">              <span class="comment">/* Exhaust */</span></span><br><span class="line">              <span class="keyword">if</span> (remainder_size &lt; MINSIZE)</span><br><span class="line">                &#123;</span><br><span class="line">                  set_inuse_bit_at_offset (victim, size);</span><br><span class="line">                  <span class="keyword">if</span> (av != &amp;main_arena)</span><br><span class="line">                    victim-&gt;size |= NON_MAIN_ARENA;</span><br><span class="line">                &#125;</span><br><span class="line">              <span class="comment">/* Split */</span></span><br><span class="line">              <span class="keyword">else</span></span><br><span class="line">                &#123;</span><br><span class="line">                  remainder = chunk_at_offset (victim, nb);</span><br><span class="line">                  <span class="comment">/* We cannot assume the unsorted list is empty and therefore</span></span><br><span class="line"><span class="comment">                     have to perform a complete insert here.  */</span></span><br><span class="line">                  bck = unsorted_chunks (av);</span><br><span class="line">                  fwd = bck-&gt;fd;</span><br><span class="line">	  <span class="keyword">if</span> (__glibc_unlikely (fwd-&gt;bk != bck))</span><br><span class="line">                    &#123;</span><br><span class="line">                      errstr = <span class="string">&quot;malloc(): corrupted unsorted chunks&quot;</span>;</span><br><span class="line">                      <span class="keyword">goto</span> errout;</span><br><span class="line">                    &#125;</span><br><span class="line">                  remainder-&gt;bk = bck;</span><br><span class="line">                  remainder-&gt;fd = fwd;</span><br><span class="line">                  bck-&gt;fd = remainder;</span><br><span class="line">                  fwd-&gt;bk = remainder;</span><br><span class="line">                  <span class="keyword">if</span> (!in_smallbin_range (remainder_size))</span><br><span class="line">                    &#123;</span><br><span class="line">                      remainder-&gt;fd_nextsize = <span class="literal">NULL</span>;</span><br><span class="line">                      remainder-&gt;bk_nextsize = <span class="literal">NULL</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                  set_head (victim, nb | PREV_INUSE |</span><br><span class="line">                            (av != &amp;main_arena ? NON_MAIN_ARENA : <span class="number">0</span>));</span><br><span class="line">                  set_head (remainder, remainder_size | PREV_INUSE);</span><br><span class="line">                  set_foot (remainder, remainder_size);</span><br><span class="line">                &#125;</span><br><span class="line">              check_malloced_chunk (av, victim, nb);</span><br><span class="line">              <span class="type">void</span> *p = chunk2mem (victim);</span><br><span class="line">              alloc_perturb (p, bytes);</span><br><span class="line">              <span class="keyword">return</span> p;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">/*</span></span><br><span class="line"><span class="comment">         Search for a chunk by scanning bins, starting with next largest</span></span><br><span class="line"><span class="comment">         bin. This search is strictly by best-fit; i.e., the smallest</span></span><br><span class="line"><span class="comment">         (with ties going to approximately the least recently used) chunk</span></span><br><span class="line"><span class="comment">         that fits is selected.</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">         The bitmap avoids needing to check that most blocks are nonempty.</span></span><br><span class="line"><span class="comment">         The particular case of skipping all bins during warm-up phases</span></span><br><span class="line"><span class="comment">         when no chunks have been returned yet is faster than it might look.</span></span><br><span class="line"><span class="comment">       */</span></span><br><span class="line"></span><br><span class="line">      ++idx;</span><br><span class="line">      bin = bin_at (av, idx);</span><br><span class="line">      block = idx2block (idx);</span><br><span class="line">      <span class="built_in">map</span> = av-&gt;binmap[block];</span><br><span class="line">      bit = idx2bit (idx);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">for</span> (;; )</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="comment">/* Skip rest of block if there are no more set bits in this block.  */</span></span><br><span class="line">          <span class="keyword">if</span> (bit &gt; <span class="built_in">map</span> || bit == <span class="number">0</span>)</span><br><span class="line">            &#123;</span><br><span class="line">              <span class="keyword">do</span></span><br><span class="line">                &#123;</span><br><span class="line">                  <span class="keyword">if</span> (++block &gt;= BINMAPSIZE) <span class="comment">/* out of bins */</span></span><br><span class="line">                    <span class="keyword">goto</span> use_top;</span><br><span class="line">                &#125;</span><br><span class="line">              <span class="keyword">while</span> ((<span class="built_in">map</span> = av-&gt;binmap[block]) == <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">              bin = bin_at (av, (block &lt;&lt; BINMAPSHIFT));</span><br><span class="line">              bit = <span class="number">1</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">          <span class="comment">/* Advance to bin with set bit. There must be one. */</span></span><br><span class="line">          <span class="keyword">while</span> ((bit &amp; <span class="built_in">map</span>) == <span class="number">0</span>)</span><br><span class="line">            &#123;</span><br><span class="line">              bin = next_bin (bin);</span><br><span class="line">              bit &lt;&lt;= <span class="number">1</span>;</span><br><span class="line">              assert (bit != <span class="number">0</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">          <span class="comment">/* Inspect the bin. It is likely to be non-empty */</span></span><br><span class="line">          victim = last (bin);</span><br><span class="line"></span><br><span class="line">          <span class="comment">/*  If a false alarm (empty bin), clear the bit. */</span></span><br><span class="line">          <span class="keyword">if</span> (victim == bin)</span><br><span class="line">            &#123;</span><br><span class="line">              av-&gt;binmap[block] = <span class="built_in">map</span> &amp;= ~bit; <span class="comment">/* Write through */</span></span><br><span class="line">              bin = next_bin (bin);</span><br><span class="line">              bit &lt;&lt;= <span class="number">1</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">          <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">              size = chunksize (victim);</span><br><span class="line"></span><br><span class="line">              <span class="comment">/*  We know the first chunk in this bin is big enough to use. */</span></span><br><span class="line">              assert ((<span class="type">unsigned</span> <span class="type">long</span>) (size) &gt;= (<span class="type">unsigned</span> <span class="type">long</span>) (nb));</span><br><span class="line"></span><br><span class="line">              remainder_size = size - nb;</span><br><span class="line"></span><br><span class="line">              <span class="comment">/* unlink */</span></span><br><span class="line">              unlink (av, victim, bck, fwd);</span><br><span class="line"></span><br><span class="line">              <span class="comment">/* Exhaust */</span></span><br><span class="line">              <span class="keyword">if</span> (remainder_size &lt; MINSIZE)</span><br><span class="line">                &#123;</span><br><span class="line">                  set_inuse_bit_at_offset (victim, size);</span><br><span class="line">                  <span class="keyword">if</span> (av != &amp;main_arena)</span><br><span class="line">                    victim-&gt;size |= NON_MAIN_ARENA;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">              <span class="comment">/* Split */</span></span><br><span class="line">              <span class="keyword">else</span></span><br><span class="line">                &#123;</span><br><span class="line">                  remainder = chunk_at_offset (victim, nb);</span><br><span class="line"></span><br><span class="line">                  <span class="comment">/* We cannot assume the unsorted list is empty and therefore</span></span><br><span class="line"><span class="comment">                     have to perform a complete insert here.  */</span></span><br><span class="line">                  bck = unsorted_chunks (av);</span><br><span class="line">                  fwd = bck-&gt;fd;</span><br><span class="line">	  <span class="keyword">if</span> (__glibc_unlikely (fwd-&gt;bk != bck))</span><br><span class="line">                    &#123;</span><br><span class="line">                      errstr = <span class="string">&quot;malloc(): corrupted unsorted chunks 2&quot;</span>;</span><br><span class="line">                      <span class="keyword">goto</span> errout;</span><br><span class="line">                    &#125;</span><br><span class="line">                  remainder-&gt;bk = bck;</span><br><span class="line">                  remainder-&gt;fd = fwd;</span><br><span class="line">                  bck-&gt;fd = remainder;</span><br><span class="line">                  fwd-&gt;bk = remainder;</span><br><span class="line"></span><br><span class="line">                  <span class="comment">/* advertise as last remainder */</span></span><br><span class="line">                  <span class="keyword">if</span> (in_smallbin_range (nb))</span><br><span class="line">                    av-&gt;last_remainder = remainder;</span><br><span class="line">                  <span class="keyword">if</span> (!in_smallbin_range (remainder_size))</span><br><span class="line">                    &#123;</span><br><span class="line">                      remainder-&gt;fd_nextsize = <span class="literal">NULL</span>;</span><br><span class="line">                      remainder-&gt;bk_nextsize = <span class="literal">NULL</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                  set_head (victim, nb | PREV_INUSE |</span><br><span class="line">                            (av != &amp;main_arena ? NON_MAIN_ARENA : <span class="number">0</span>));</span><br><span class="line">                  set_head (remainder, remainder_size | PREV_INUSE);</span><br><span class="line">                  set_foot (remainder, remainder_size);</span><br><span class="line">                &#125;</span><br><span class="line">              check_malloced_chunk (av, victim, nb);</span><br><span class="line">              <span class="type">void</span> *p = chunk2mem (victim);</span><br><span class="line">              alloc_perturb (p, bytes);</span><br><span class="line">              <span class="keyword">return</span> p;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    use_top:</span><br><span class="line">      <span class="comment">/*</span></span><br><span class="line"><span class="comment">         If large enough, split off the chunk bordering the end of memory</span></span><br><span class="line"><span class="comment">         (held in av-&gt;top). Note that this is in accord with the best-fit</span></span><br><span class="line"><span class="comment">         search rule.  In effect, av-&gt;top is treated as larger (and thus</span></span><br><span class="line"><span class="comment">         less well fitting) than any other available chunk since it can</span></span><br><span class="line"><span class="comment">         be extended to be as large as necessary (up to system</span></span><br><span class="line"><span class="comment">         limitations).</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">         We require that av-&gt;top always exists (i.e., has size &gt;=</span></span><br><span class="line"><span class="comment">         MINSIZE) after initialization, so if it would otherwise be</span></span><br><span class="line"><span class="comment">         exhausted by current request, it is replenished. (The main</span></span><br><span class="line"><span class="comment">         reason for ensuring it exists is that we may need MINSIZE space</span></span><br><span class="line"><span class="comment">         to put in fenceposts in sysmalloc.)</span></span><br><span class="line"><span class="comment">       */</span></span><br><span class="line"></span><br><span class="line">      victim = av-&gt;top;</span><br><span class="line">      size = chunksize (victim);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> ((<span class="type">unsigned</span> <span class="type">long</span>) (size) &gt;= (<span class="type">unsigned</span> <span class="type">long</span>) (nb + MINSIZE))</span><br><span class="line">        &#123;</span><br><span class="line">          remainder_size = size - nb;</span><br><span class="line">          remainder = chunk_at_offset (victim, nb);</span><br><span class="line">          av-&gt;top = remainder;</span><br><span class="line">          set_head (victim, nb | PREV_INUSE |</span><br><span class="line">                    (av != &amp;main_arena ? NON_MAIN_ARENA : <span class="number">0</span>));</span><br><span class="line">          set_head (remainder, remainder_size | PREV_INUSE);</span><br><span class="line"></span><br><span class="line">          check_malloced_chunk (av, victim, nb);</span><br><span class="line">          <span class="type">void</span> *p = chunk2mem (victim);</span><br><span class="line">          alloc_perturb (p, bytes);</span><br><span class="line">          <span class="keyword">return</span> p;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">/* When we are using atomic ops to free fast chunks we can get</span></span><br><span class="line"><span class="comment">         here for all block sizes.  */</span></span><br><span class="line">      <span class="keyword">else</span> <span class="keyword">if</span> (have_fastchunks (av))</span><br><span class="line">        &#123;</span><br><span class="line">          malloc_consolidate (av);</span><br><span class="line">          <span class="comment">/* restore original bin index */</span></span><br><span class="line">          <span class="keyword">if</span> (in_smallbin_range (nb))</span><br><span class="line">            idx = smallbin_index (nb);</span><br><span class="line">          <span class="keyword">else</span></span><br><span class="line">            idx = largebin_index (nb);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">/*</span></span><br><span class="line"><span class="comment">         Otherwise, relay to handle system-dependent cases</span></span><br><span class="line"><span class="comment">       */</span></span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">          <span class="type">void</span> *p = sysmalloc (nb, av);</span><br><span class="line">          <span class="keyword">if</span> (p != <span class="literal">NULL</span>)</span><br><span class="line">            alloc_perturb (p, bytes);</span><br><span class="line">          <span class="keyword">return</span> p;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>åœ¨å‡½æ•°ä¸€å¼€å§‹ä¼šåˆ›å»ºä¸€äº›åç»­åˆ†é…æœºåˆ¶æ‰€éœ€ä½¿ç”¨çš„å˜é‡ï¼Œå…·ä½“ç”¨é€”è§æ³¨é‡Šï¼Œè¿™é‡Œä¾¿ä¸å†èµ˜å™</p>
<h2 id="ä¸€ã€å°†è¯·æ±‚å¤§å°è½¬æ¢ä¸ºæ ‡å‡†å¤§å°"><a href="#ä¸€ã€å°†è¯·æ±‚å¤§å°è½¬æ¢ä¸ºæ ‡å‡†å¤§å°" class="headerlink" title="ä¸€ã€å°†è¯·æ±‚å¤§å°è½¬æ¢ä¸ºæ ‡å‡†å¤§å°"></a>ä¸€ã€å°†è¯·æ±‚å¤§å°è½¬æ¢ä¸ºæ ‡å‡†å¤§å°</h2><p>åœ¨_int_malloc()å‡½æ•°ä¸€å¼€å§‹æ—¶ä¼šå°†ç”¨æˆ·æ‰€è¯·æ±‚çš„å¤§å°è½¬æ¢ä¸ºå¯¹åº”çš„ä¸<code>MALLOC_ALIGNMENT</code>å¯¹é½çš„å¤§å°ï¼Œåœ¨è¿™é‡Œä½¿ç”¨äº†ä¸€ä¸ªå®<code>checked_request2size()</code>ï¼Œå…¶ä¼šä½¿ç”¨<code>request2size()</code>å®è¿›è¡Œè®¡ç®—ï¼Œchunk sizeçš„è®¡ç®—è§„åˆ™å¤§è‡´å¦‚ä¸‹å›¾æ‰€ç¤ºï¼ˆè¯¥å®ä¼šå°†è¯·æ±‚çš„sizeå…ˆåŠ ä¸Šchunk headerçš„å¤§å°ï¼‰ï¼š</p>
<p><img src="https://i.loli.net/2020/12/19/HZfcpy4wkJGg9V3.png" alt="image.png"></p>
<blockquote>
<p>è¯¦è§0x00.äºŒ.1</p>
</blockquote>
<h2 id="äºŒã€æ£€æŸ¥arenaæ˜¯å¦å¯ç”¨"><a href="#äºŒã€æ£€æŸ¥arenaæ˜¯å¦å¯ç”¨" class="headerlink" title="äºŒã€æ£€æŸ¥arenaæ˜¯å¦å¯ç”¨"></a>äºŒã€æ£€æŸ¥arenaæ˜¯å¦å¯ç”¨</h2><p>ä¸Šæ–‡æˆ‘ä»¬è®²åˆ°ï¼Œ<strong>è·å–å¯ç”¨arena</strong>è¿™ä¸€æ­¥éª¤æ˜¯åœ¨<code>__libc_malloc()</code>å‡½æ•°ä¸­å®Œæˆçš„ï¼Œ<code>_int_malloc()</code>å‡½æ•°æ‰€éœ€è¦åšçš„ä»…ä»…æ˜¯ä½¿ç”¨ä¸Šå±‚è°ƒç”¨å‡½æ•°ä¼ å…¥çš„arenaï¼Œ<strong>ä½†æ˜¯åœ¨__libc_malloc</strong>()<strong>å‡½æ•°ä¸­æˆ‘ä»¬æœ‰å¯èƒ½æ— æ³•å¾—åˆ°ä¸€ä¸ªå¯ç”¨çš„arena</strong>ï¼ˆè¯¦è§0x02.2 &amp; 0x02.4ï¼‰</p>
<p>å› è€Œåœ¨è¿™é‡Œä¼šé¦–å…ˆæ£€æŸ¥ä¼ å…¥çš„arenaï¼Œ<strong>è‹¥ä¸ºNULLåˆ™è¯´æ˜ç°æœ‰arenaå·²ç»æ— æ³•æ»¡è¶³ç”¨æˆ·å†…å­˜è¯·æ±‚ï¼Œæ­¤æ—¶ä¼šç›´æ¥è°ƒç”¨sysmalloc</strong>()<strong>å‡½æ•°é€šè¿‡mmapç³»ç»Ÿè°ƒç”¨åˆ†é…å†…å­˜ï¼Œå¹¶å°†æ‰€å¾—çš„ç»“æœç›´æ¥è¿”å›ä¸Šå±‚è°ƒç”¨</strong></p>
<p>è‹¥sysmallocè¿”å›ç»“æœä¸ä¸ºNULLï¼Œåˆ™ä¼šè°ƒç”¨<code>alloc_perturb()</code>å‡½æ•°å¯¹æˆ‘ä»¬æ‰€è·å¾—çš„å†…å­˜å—è¿›è¡Œé¢„å¤„ç†ï¼Œè¯¥å‡½æ•°å®šä¹‰äºmalloc.cä¸­ï¼Œå¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* ------------------ Testing support ----------------------------------*/</span></span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> perturb_byte;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">void</span></span><br><span class="line"><span class="title function_">alloc_perturb</span> <span class="params">(<span class="type">char</span> *p, <span class="type">size_t</span> n)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">if</span> (__glibc_unlikely (perturb_byte))</span><br><span class="line">    <span class="built_in">memset</span> (p, perturb_byte ^ <span class="number">0xff</span>, n);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è‹¥æ˜¯é™æ€å…¨å±€å˜é‡<code>perturb_byte</code>ä¸º0ï¼Œåˆ™ä¼šå°†è¯¥å†…å­˜å—ä¸­ç”¨æˆ·è¯·æ±‚å¤§å°çš„éƒ¨åˆ†å…¨éƒ¨è®¾ä¸º<code>0xff</code></p>
<blockquote>
<p>è¿™é‡Œç”¨äº†ä¸€ä¸ªä¸çŸ¥æ‰€è°“çš„å¼‚æˆ–æ“ä½œï¼Œç¬”è€…æš‚ä¸”è’™åœ¨å¤é‡Œâ€¦</p>
</blockquote>
<h2 id="ä¸‰ã€fastbinèŒƒå›´sizeè¯·æ±‚ç›¸å…³æ“ä½œ"><a href="#ä¸‰ã€fastbinèŒƒå›´sizeè¯·æ±‚ç›¸å…³æ“ä½œ" class="headerlink" title="ä¸‰ã€fastbinèŒƒå›´sizeè¯·æ±‚ç›¸å…³æ“ä½œ"></a>ä¸‰ã€fastbinèŒƒå›´sizeè¯·æ±‚ç›¸å…³æ“ä½œ</h2><p>è‹¥æ‰€éœ€chunkçš„sizeåœ¨fastbinçš„èŒƒå›´å†…ï¼ˆ32ä½&lt;&#x3D;0x40ï¼Œ64ä½&lt;&#x3D;0x80ï¼Œè¯¦è§0x00.å››ï¼‰ï¼Œåˆ™ä¼šè¿›è¡Œå¦‚ä¸‹æ“ä½œï¼š</p>
<h3 id="1-å°è¯•ä»fastbinå¯¹åº”ä¸‹æ ‡å–å‡ºchunk"><a href="#1-å°è¯•ä»fastbinå¯¹åº”ä¸‹æ ‡å–å‡ºchunk" class="headerlink" title="1.å°è¯•ä»fastbinå¯¹åº”ä¸‹æ ‡å–å‡ºchunk"></a>1.å°è¯•ä»fastbinå¯¹åº”ä¸‹æ ‡å–å‡ºchunk</h3><h3 id="2-ï¼ˆè‹¥æˆåŠŸè·å¾—chunkï¼‰è¿›è¡Œchunk-sizeå®‰å…¨æ£€æŸ¥"><a href="#2-ï¼ˆè‹¥æˆåŠŸè·å¾—chunkï¼‰è¿›è¡Œchunk-sizeå®‰å…¨æ£€æŸ¥" class="headerlink" title="2.ï¼ˆè‹¥æˆåŠŸè·å¾—chunkï¼‰è¿›è¡Œchunk sizeå®‰å…¨æ£€æŸ¥"></a>2.ï¼ˆè‹¥æˆåŠŸè·å¾—chunkï¼‰è¿›è¡Œchunk sizeå®‰å…¨æ£€æŸ¥</h3><h1 id="0x04-sysmallocï¼š"><a href="#0x04-sysmallocï¼š" class="headerlink" title="0x04.sysmallocï¼š"></a>0x04.sysmallocï¼š</h1><p>å®šä¹‰äºmalloc.cä¸­ï¼Œç”¨ä»¥<strong>çœŸæ­£è°ƒç”¨ç³»ç»Ÿè°ƒç”¨çš„æ¥å£è¿›è¡Œå†…å­˜åˆ†é…</strong>ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* ----------- Routines dealing with system allocation -------------- */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">   sysmalloc handles malloc cases requiring more memory from the system.</span></span><br><span class="line"><span class="comment">   On entry, it is assumed that av-&gt;top does not have enough</span></span><br><span class="line"><span class="comment">   space to service request for nb bytes, thus requiring that av-&gt;top</span></span><br><span class="line"><span class="comment">   be extended or replaced.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> *</span><br><span class="line"><span class="title function_">sysmalloc</span> <span class="params">(INTERNAL_SIZE_T nb, mstate av)</span></span><br><span class="line">&#123;</span><br><span class="line">  mchunkptr old_top;              <span class="comment">/* incoming value of av-&gt;top */</span></span><br><span class="line">  INTERNAL_SIZE_T old_size;       <span class="comment">/* its size */</span></span><br><span class="line">  <span class="type">char</span> *old_end;                  <span class="comment">/* its end address */</span></span><br><span class="line"></span><br><span class="line">  <span class="type">long</span> size;                      <span class="comment">/* arg to first MORECORE or mmap call */</span></span><br><span class="line">  <span class="type">char</span> *brk;                      <span class="comment">/* return value from MORECORE */</span></span><br><span class="line"></span><br><span class="line">  <span class="type">long</span> correction;                <span class="comment">/* arg to 2nd MORECORE call */</span></span><br><span class="line">  <span class="type">char</span> *snd_brk;                  <span class="comment">/* 2nd return val */</span></span><br><span class="line"></span><br><span class="line">  INTERNAL_SIZE_T front_misalign; <span class="comment">/* unusable bytes at front of new space */</span></span><br><span class="line">  INTERNAL_SIZE_T end_misalign;   <span class="comment">/* partial page left at end of new space */</span></span><br><span class="line">  <span class="type">char</span> *aligned_brk;              <span class="comment">/* aligned offset into brk */</span></span><br><span class="line"></span><br><span class="line">  mchunkptr p;                    <span class="comment">/* the allocated/returned chunk */</span></span><br><span class="line">  mchunkptr remainder;            <span class="comment">/* remainder from allocation */</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">long</span> remainder_size;   <span class="comment">/* its size */</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="type">size_t</span> pagesize = GLRO (dl_pagesize);</span><br><span class="line">  <span class="type">bool</span> tried_mmap = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">     If have mmap, and the request size meets the mmap threshold, and</span></span><br><span class="line"><span class="comment">     the system supports mmap, and there are few enough currently</span></span><br><span class="line"><span class="comment">     allocated mmapped regions, try to directly map this request</span></span><br><span class="line"><span class="comment">     rather than expanding top.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (av == <span class="literal">NULL</span></span><br><span class="line">      || ((<span class="type">unsigned</span> <span class="type">long</span>) (nb) &gt;= (<span class="type">unsigned</span> <span class="type">long</span>) (mp_.mmap_threshold)</span><br><span class="line">	  &amp;&amp; (mp_.n_mmaps &lt; mp_.n_mmaps_max)))</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="type">char</span> *mm;           <span class="comment">/* return value from mmap call*/</span></span><br><span class="line"></span><br><span class="line">    try_mmap:</span><br><span class="line">      <span class="comment">/*</span></span><br><span class="line"><span class="comment">         Round up size to nearest page.  For mmapped chunks, the overhead</span></span><br><span class="line"><span class="comment">         is one SIZE_SZ unit larger than for normal chunks, because there</span></span><br><span class="line"><span class="comment">         is no following chunk whose prev_size field could be used.</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">         See the front_misalign handling below, for glibc there is no</span></span><br><span class="line"><span class="comment">         need for further alignments unless we have have high alignment.</span></span><br><span class="line"><span class="comment">       */</span></span><br><span class="line">      <span class="keyword">if</span> (MALLOC_ALIGNMENT == <span class="number">2</span> * SIZE_SZ)</span><br><span class="line">        size = ALIGN_UP (nb + SIZE_SZ, pagesize);</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">        size = ALIGN_UP (nb + SIZE_SZ + MALLOC_ALIGN_MASK, pagesize);</span><br><span class="line">      tried_mmap = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">      <span class="comment">/* Don&#x27;t try if size wraps around 0 */</span></span><br><span class="line">      <span class="keyword">if</span> ((<span class="type">unsigned</span> <span class="type">long</span>) (size) &gt; (<span class="type">unsigned</span> <span class="type">long</span>) (nb))</span><br><span class="line">        &#123;</span><br><span class="line">          mm = (<span class="type">char</span> *) (MMAP (<span class="number">0</span>, size, PROT_READ | PROT_WRITE, <span class="number">0</span>));</span><br><span class="line"></span><br><span class="line">          <span class="keyword">if</span> (mm != MAP_FAILED)</span><br><span class="line">            &#123;</span><br><span class="line">              <span class="comment">/*</span></span><br><span class="line"><span class="comment">                 The offset to the start of the mmapped region is stored</span></span><br><span class="line"><span class="comment">                 in the prev_size field of the chunk. This allows us to adjust</span></span><br><span class="line"><span class="comment">                 returned start address to meet alignment requirements here</span></span><br><span class="line"><span class="comment">                 and in memalign(), and still be able to compute proper</span></span><br><span class="line"><span class="comment">                 address argument for later munmap in free() and realloc().</span></span><br><span class="line"><span class="comment">               */</span></span><br><span class="line"></span><br><span class="line">              <span class="keyword">if</span> (MALLOC_ALIGNMENT == <span class="number">2</span> * SIZE_SZ)</span><br><span class="line">                &#123;</span><br><span class="line">                  <span class="comment">/* For glibc, chunk2mem increases the address by 2*SIZE_SZ and</span></span><br><span class="line"><span class="comment">                     MALLOC_ALIGN_MASK is 2*SIZE_SZ-1.  Each mmap&#x27;ed area is page</span></span><br><span class="line"><span class="comment">                     aligned and therefore definitely MALLOC_ALIGN_MASK-aligned.  */</span></span><br><span class="line">                  assert (((INTERNAL_SIZE_T) chunk2mem (mm) &amp; MALLOC_ALIGN_MASK) == <span class="number">0</span>);</span><br><span class="line">                  front_misalign = <span class="number">0</span>;</span><br><span class="line">                &#125;</span><br><span class="line">              <span class="keyword">else</span></span><br><span class="line">                front_misalign = (INTERNAL_SIZE_T) chunk2mem (mm) &amp; MALLOC_ALIGN_MASK;</span><br><span class="line">              <span class="keyword">if</span> (front_misalign &gt; <span class="number">0</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                  correction = MALLOC_ALIGNMENT - front_misalign;</span><br><span class="line">                  p = (mchunkptr) (mm + correction);</span><br><span class="line">                  p-&gt;prev_size = correction;</span><br><span class="line">                  set_head (p, (size - correction) | IS_MMAPPED);</span><br><span class="line">                &#125;</span><br><span class="line">              <span class="keyword">else</span></span><br><span class="line">                &#123;</span><br><span class="line">                  p = (mchunkptr) mm;</span><br><span class="line">                  set_head (p, size | IS_MMAPPED);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">              <span class="comment">/* update statistics */</span></span><br><span class="line"></span><br><span class="line">              <span class="type">int</span> new = atomic_exchange_and_add (&amp;mp_.n_mmaps, <span class="number">1</span>) + <span class="number">1</span>;</span><br><span class="line">              <span class="type">atomic_max</span> (&amp;mp_.max_n_mmaps, new);</span><br><span class="line"></span><br><span class="line">              <span class="type">unsigned</span> <span class="type">long</span> sum;</span><br><span class="line">              sum = atomic_exchange_and_add (&amp;mp_.mmapped_mem, size) + size;</span><br><span class="line">              <span class="type">atomic_max</span> (&amp;mp_.max_mmapped_mem, sum);</span><br><span class="line"></span><br><span class="line">              check_chunk (av, p);</span><br><span class="line"></span><br><span class="line">              <span class="keyword">return</span> chunk2mem (p);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* There are no usable arenas and mmap also failed.  */</span></span><br><span class="line">  <span class="keyword">if</span> (av == <span class="literal">NULL</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Record incoming configuration of top */</span></span><br><span class="line"></span><br><span class="line">  old_top = av-&gt;top;</span><br><span class="line">  old_size = chunksize (old_top);</span><br><span class="line">  old_end = (<span class="type">char</span> *) (chunk_at_offset (old_top, old_size));</span><br><span class="line"></span><br><span class="line">  brk = snd_brk = (<span class="type">char</span> *) (MORECORE_FAILURE);</span><br><span class="line"></span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">     If not the first time through, we require old_size to be</span></span><br><span class="line"><span class="comment">     at least MINSIZE and to have prev_inuse set.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line"></span><br><span class="line">  assert ((old_top == initial_top (av) &amp;&amp; old_size == <span class="number">0</span>) ||</span><br><span class="line">          ((<span class="type">unsigned</span> <span class="type">long</span>) (old_size) &gt;= MINSIZE &amp;&amp;</span><br><span class="line">           prev_inuse (old_top) &amp;&amp;</span><br><span class="line">           ((<span class="type">unsigned</span> <span class="type">long</span>) old_end &amp; (pagesize - <span class="number">1</span>)) == <span class="number">0</span>));</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Precondition: not enough current space to satisfy nb request */</span></span><br><span class="line">  assert ((<span class="type">unsigned</span> <span class="type">long</span>) (old_size) &lt; (<span class="type">unsigned</span> <span class="type">long</span>) (nb + MINSIZE));</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (av != &amp;main_arena)</span><br><span class="line">    &#123;</span><br><span class="line">      heap_info *old_heap, *heap;</span><br><span class="line">      <span class="type">size_t</span> old_heap_size;</span><br><span class="line"></span><br><span class="line">      <span class="comment">/* First try to extend the current heap. */</span></span><br><span class="line">      old_heap = heap_for_ptr (old_top);</span><br><span class="line">      old_heap_size = old_heap-&gt;size;</span><br><span class="line">      <span class="keyword">if</span> ((<span class="type">long</span>) (MINSIZE + nb - old_size) &gt; <span class="number">0</span></span><br><span class="line">          &amp;&amp; grow_heap (old_heap, MINSIZE + nb - old_size) == <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">          av-&gt;system_mem += old_heap-&gt;size - old_heap_size;</span><br><span class="line">          arena_mem += old_heap-&gt;size - old_heap_size;</span><br><span class="line">          set_head (old_top, (((<span class="type">char</span> *) old_heap + old_heap-&gt;size) - (<span class="type">char</span> *) old_top)</span><br><span class="line">                    | PREV_INUSE);</span><br><span class="line">        &#125;</span><br><span class="line">      <span class="keyword">else</span> <span class="keyword">if</span> ((heap = new_heap (nb + (MINSIZE + <span class="keyword">sizeof</span> (*heap)), mp_.top_pad)))</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="comment">/* Use a newly allocated heap.  */</span></span><br><span class="line">          heap-&gt;ar_ptr = av;</span><br><span class="line">          heap-&gt;prev = old_heap;</span><br><span class="line">          av-&gt;system_mem += heap-&gt;size;</span><br><span class="line">          arena_mem += heap-&gt;size;</span><br><span class="line">          <span class="comment">/* Set up the new top.  */</span></span><br><span class="line">          top (av) = chunk_at_offset (heap, <span class="keyword">sizeof</span> (*heap));</span><br><span class="line">          set_head (top (av), (heap-&gt;size - <span class="keyword">sizeof</span> (*heap)) | PREV_INUSE);</span><br><span class="line"></span><br><span class="line">          <span class="comment">/* Setup fencepost and free the old top chunk with a multiple of</span></span><br><span class="line"><span class="comment">             MALLOC_ALIGNMENT in size. */</span></span><br><span class="line">          <span class="comment">/* The fencepost takes at least MINSIZE bytes, because it might</span></span><br><span class="line"><span class="comment">             become the top chunk again later.  Note that a footer is set</span></span><br><span class="line"><span class="comment">             up, too, although the chunk is marked in use. */</span></span><br><span class="line">          old_size = (old_size - MINSIZE) &amp; ~MALLOC_ALIGN_MASK;</span><br><span class="line">          set_head (chunk_at_offset (old_top, old_size + <span class="number">2</span> * SIZE_SZ), <span class="number">0</span> | PREV_INUSE);</span><br><span class="line">          <span class="keyword">if</span> (old_size &gt;= MINSIZE)</span><br><span class="line">            &#123;</span><br><span class="line">              set_head (chunk_at_offset (old_top, old_size), (<span class="number">2</span> * SIZE_SZ) | PREV_INUSE);</span><br><span class="line">              set_foot (chunk_at_offset (old_top, old_size), (<span class="number">2</span> * SIZE_SZ));</span><br><span class="line">              set_head (old_top, old_size | PREV_INUSE | NON_MAIN_ARENA);</span><br><span class="line">              _int_free (av, old_top, <span class="number">1</span>);</span><br><span class="line">            &#125;</span><br><span class="line">          <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">              set_head (old_top, (old_size + <span class="number">2</span> * SIZE_SZ) | PREV_INUSE);</span><br><span class="line">              set_foot (old_top, (old_size + <span class="number">2</span> * SIZE_SZ));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      <span class="keyword">else</span> <span class="keyword">if</span> (!tried_mmap)</span><br><span class="line">        <span class="comment">/* We can at least try to use to mmap memory.  */</span></span><br><span class="line">        <span class="keyword">goto</span> try_mmap;</span><br><span class="line">    &#125;</span><br><span class="line">  <span class="keyword">else</span>     <span class="comment">/* av == main_arena */</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#123; <span class="comment">/* Request enough space for nb + pad + overhead */</span></span><br><span class="line">      size = nb + mp_.top_pad + MINSIZE;</span><br><span class="line"></span><br><span class="line">      <span class="comment">/*</span></span><br><span class="line"><span class="comment">         If contiguous, we can subtract out existing space that we hope to</span></span><br><span class="line"><span class="comment">         combine with new space. We add it back later only if</span></span><br><span class="line"><span class="comment">         we don&#x27;t actually get contiguous space.</span></span><br><span class="line"><span class="comment">       */</span></span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (contiguous (av))</span><br><span class="line">        size -= old_size;</span><br><span class="line"></span><br><span class="line">      <span class="comment">/*</span></span><br><span class="line"><span class="comment">         Round to a multiple of page size.</span></span><br><span class="line"><span class="comment">         If MORECORE is not contiguous, this ensures that we only call it</span></span><br><span class="line"><span class="comment">         with whole-page arguments.  And if MORECORE is contiguous and</span></span><br><span class="line"><span class="comment">         this is not first time through, this preserves page-alignment of</span></span><br><span class="line"><span class="comment">         previous calls. Otherwise, we correct to page-align below.</span></span><br><span class="line"><span class="comment">       */</span></span><br><span class="line"></span><br><span class="line">      size = ALIGN_UP (size, pagesize);</span><br><span class="line"></span><br><span class="line">      <span class="comment">/*</span></span><br><span class="line"><span class="comment">         Don&#x27;t try to call MORECORE if argument is so big as to appear</span></span><br><span class="line"><span class="comment">         negative. Note that since mmap takes size_t arg, it may succeed</span></span><br><span class="line"><span class="comment">         below even if we cannot call MORECORE.</span></span><br><span class="line"><span class="comment">       */</span></span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (size &gt; <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">          brk = (<span class="type">char</span> *) (MORECORE (size));</span><br><span class="line">          LIBC_PROBE (memory_sbrk_more, <span class="number">2</span>, brk, size);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (brk != (<span class="type">char</span> *) (MORECORE_FAILURE))</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="comment">/* Call the `morecore&#x27; hook if necessary.  */</span></span><br><span class="line">          <span class="type">void</span> (*hook) (<span class="type">void</span>) = atomic_forced_read (__after_morecore_hook);</span><br><span class="line">          <span class="keyword">if</span> (__builtin_expect (hook != <span class="literal">NULL</span>, <span class="number">0</span>))</span><br><span class="line">            (*hook)();</span><br><span class="line">        &#125;</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">          <span class="comment">/*</span></span><br><span class="line"><span class="comment">             If have mmap, try using it as a backup when MORECORE fails or</span></span><br><span class="line"><span class="comment">             cannot be used. This is worth doing on systems that have &quot;holes&quot; in</span></span><br><span class="line"><span class="comment">             address space, so sbrk cannot extend to give contiguous space, but</span></span><br><span class="line"><span class="comment">             space is available elsewhere.  Note that we ignore mmap max count</span></span><br><span class="line"><span class="comment">             and threshold limits, since the space will not be used as a</span></span><br><span class="line"><span class="comment">             segregated mmap region.</span></span><br><span class="line"><span class="comment">           */</span></span><br><span class="line"></span><br><span class="line">          <span class="comment">/* Cannot merge with old top, so add its size back in */</span></span><br><span class="line">          <span class="keyword">if</span> (contiguous (av))</span><br><span class="line">            size = ALIGN_UP (size + old_size, pagesize);</span><br><span class="line"></span><br><span class="line">          <span class="comment">/* If we are relying on mmap as backup, then use larger units */</span></span><br><span class="line">          <span class="keyword">if</span> ((<span class="type">unsigned</span> <span class="type">long</span>) (size) &lt; (<span class="type">unsigned</span> <span class="type">long</span>) (MMAP_AS_MORECORE_SIZE))</span><br><span class="line">            size = MMAP_AS_MORECORE_SIZE;</span><br><span class="line"></span><br><span class="line">          <span class="comment">/* Don&#x27;t try if size wraps around 0 */</span></span><br><span class="line">          <span class="keyword">if</span> ((<span class="type">unsigned</span> <span class="type">long</span>) (size) &gt; (<span class="type">unsigned</span> <span class="type">long</span>) (nb))</span><br><span class="line">            &#123;</span><br><span class="line">              <span class="type">char</span> *mbrk = (<span class="type">char</span> *) (MMAP (<span class="number">0</span>, size, PROT_READ | PROT_WRITE, <span class="number">0</span>));</span><br><span class="line"></span><br><span class="line">              <span class="keyword">if</span> (mbrk != MAP_FAILED)</span><br><span class="line">                &#123;</span><br><span class="line">                  <span class="comment">/* We do not need, and cannot use, another sbrk call to find end */</span></span><br><span class="line">                  brk = mbrk;</span><br><span class="line">                  snd_brk = brk + size;</span><br><span class="line"></span><br><span class="line">                  <span class="comment">/*</span></span><br><span class="line"><span class="comment">                     Record that we no longer have a contiguous sbrk region.</span></span><br><span class="line"><span class="comment">                     After the first time mmap is used as backup, we do not</span></span><br><span class="line"><span class="comment">                     ever rely on contiguous space since this could incorrectly</span></span><br><span class="line"><span class="comment">                     bridge regions.</span></span><br><span class="line"><span class="comment">                   */</span></span><br><span class="line">                  set_noncontiguous (av);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (brk != (<span class="type">char</span> *) (MORECORE_FAILURE))</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="keyword">if</span> (mp_.sbrk_base == <span class="number">0</span>)</span><br><span class="line">            mp_.sbrk_base = brk;</span><br><span class="line">          av-&gt;system_mem += size;</span><br><span class="line"></span><br><span class="line">          <span class="comment">/*</span></span><br><span class="line"><span class="comment">             If MORECORE extends previous space, we can likewise extend top size.</span></span><br><span class="line"><span class="comment">           */</span></span><br><span class="line"></span><br><span class="line">          <span class="keyword">if</span> (brk == old_end &amp;&amp; snd_brk == (<span class="type">char</span> *) (MORECORE_FAILURE))</span><br><span class="line">            set_head (old_top, (size + old_size) | PREV_INUSE);</span><br><span class="line"></span><br><span class="line">          <span class="keyword">else</span> <span class="keyword">if</span> (contiguous (av) &amp;&amp; old_size &amp;&amp; brk &lt; old_end)</span><br><span class="line">            &#123;</span><br><span class="line">              <span class="comment">/* Oops!  Someone else killed our space..  Can&#x27;t touch anything.  */</span></span><br><span class="line">              malloc_printerr (<span class="number">3</span>, <span class="string">&quot;break adjusted to free malloc space&quot;</span>, brk,</span><br><span class="line">			       av);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">          <span class="comment">/*</span></span><br><span class="line"><span class="comment">             Otherwise, make adjustments:</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">           * If the first time through or noncontiguous, we need to call sbrk</span></span><br><span class="line"><span class="comment">              just to find out where the end of memory lies.</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">           * We need to ensure that all returned chunks from malloc will meet</span></span><br><span class="line"><span class="comment">              MALLOC_ALIGNMENT</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">           * If there was an intervening foreign sbrk, we need to adjust sbrk</span></span><br><span class="line"><span class="comment">              request size to account for fact that we will not be able to</span></span><br><span class="line"><span class="comment">              combine new space with existing space in old_top.</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">           * Almost all systems internally allocate whole pages at a time, in</span></span><br><span class="line"><span class="comment">              which case we might as well use the whole last page of request.</span></span><br><span class="line"><span class="comment">              So we allocate enough more memory to hit a page boundary now,</span></span><br><span class="line"><span class="comment">              which in turn causes future contiguous calls to page-align.</span></span><br><span class="line"><span class="comment">           */</span></span><br><span class="line"></span><br><span class="line">          <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">              front_misalign = <span class="number">0</span>;</span><br><span class="line">              end_misalign = <span class="number">0</span>;</span><br><span class="line">              correction = <span class="number">0</span>;</span><br><span class="line">              aligned_brk = brk;</span><br><span class="line"></span><br><span class="line">              <span class="comment">/* handle contiguous cases */</span></span><br><span class="line">              <span class="keyword">if</span> (contiguous (av))</span><br><span class="line">                &#123;</span><br><span class="line">                  <span class="comment">/* Count foreign sbrk as system_mem.  */</span></span><br><span class="line">                  <span class="keyword">if</span> (old_size)</span><br><span class="line">                    av-&gt;system_mem += brk - old_end;</span><br><span class="line"></span><br><span class="line">                  <span class="comment">/* Guarantee alignment of first new chunk made from this space */</span></span><br><span class="line"></span><br><span class="line">                  front_misalign = (INTERNAL_SIZE_T) chunk2mem (brk) &amp; MALLOC_ALIGN_MASK;</span><br><span class="line">                  <span class="keyword">if</span> (front_misalign &gt; <span class="number">0</span>)</span><br><span class="line">                    &#123;</span><br><span class="line">                      <span class="comment">/*</span></span><br><span class="line"><span class="comment">                         Skip over some bytes to arrive at an aligned position.</span></span><br><span class="line"><span class="comment">                         We don&#x27;t need to specially mark these wasted front bytes.</span></span><br><span class="line"><span class="comment">                         They will never be accessed anyway because</span></span><br><span class="line"><span class="comment">                         prev_inuse of av-&gt;top (and any chunk created from its start)</span></span><br><span class="line"><span class="comment">                         is always true after initialization.</span></span><br><span class="line"><span class="comment">                       */</span></span><br><span class="line"></span><br><span class="line">                      correction = MALLOC_ALIGNMENT - front_misalign;</span><br><span class="line">                      aligned_brk += correction;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                  <span class="comment">/*</span></span><br><span class="line"><span class="comment">                     If this isn&#x27;t adjacent to existing space, then we will not</span></span><br><span class="line"><span class="comment">                     be able to merge with old_top space, so must add to 2nd request.</span></span><br><span class="line"><span class="comment">                   */</span></span><br><span class="line"></span><br><span class="line">                  correction += old_size;</span><br><span class="line"></span><br><span class="line">                  <span class="comment">/* Extend the end address to hit a page boundary */</span></span><br><span class="line">                  end_misalign = (INTERNAL_SIZE_T) (brk + size + correction);</span><br><span class="line">                  correction += (ALIGN_UP (end_misalign, pagesize)) - end_misalign;</span><br><span class="line"></span><br><span class="line">                  assert (correction &gt;= <span class="number">0</span>);</span><br><span class="line">                  snd_brk = (<span class="type">char</span> *) (MORECORE (correction));</span><br><span class="line"></span><br><span class="line">                  <span class="comment">/*</span></span><br><span class="line"><span class="comment">                     If can&#x27;t allocate correction, try to at least find out current</span></span><br><span class="line"><span class="comment">                     brk.  It might be enough to proceed without failing.</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">                     Note that if second sbrk did NOT fail, we assume that space</span></span><br><span class="line"><span class="comment">                     is contiguous with first sbrk. This is a safe assumption unless</span></span><br><span class="line"><span class="comment">                     program is multithreaded but doesn&#x27;t use locks and a foreign sbrk</span></span><br><span class="line"><span class="comment">                     occurred between our first and second calls.</span></span><br><span class="line"><span class="comment">                   */</span></span><br><span class="line"></span><br><span class="line">                  <span class="keyword">if</span> (snd_brk == (<span class="type">char</span> *) (MORECORE_FAILURE))</span><br><span class="line">                    &#123;</span><br><span class="line">                      correction = <span class="number">0</span>;</span><br><span class="line">                      snd_brk = (<span class="type">char</span> *) (MORECORE (<span class="number">0</span>));</span><br><span class="line">                    &#125;</span><br><span class="line">                  <span class="keyword">else</span></span><br><span class="line">                    &#123;</span><br><span class="line">                      <span class="comment">/* Call the `morecore&#x27; hook if necessary.  */</span></span><br><span class="line">                      <span class="type">void</span> (*hook) (<span class="type">void</span>) = atomic_forced_read (__after_morecore_hook);</span><br><span class="line">                      <span class="keyword">if</span> (__builtin_expect (hook != <span class="literal">NULL</span>, <span class="number">0</span>))</span><br><span class="line">                        (*hook)();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">              <span class="comment">/* handle non-contiguous cases */</span></span><br><span class="line">              <span class="keyword">else</span></span><br><span class="line">                &#123;</span><br><span class="line">                  <span class="keyword">if</span> (MALLOC_ALIGNMENT == <span class="number">2</span> * SIZE_SZ)</span><br><span class="line">                    <span class="comment">/* MORECORE/mmap must correctly align */</span></span><br><span class="line">                    assert (((<span class="type">unsigned</span> <span class="type">long</span>) chunk2mem (brk) &amp; MALLOC_ALIGN_MASK) == <span class="number">0</span>);</span><br><span class="line">                  <span class="keyword">else</span></span><br><span class="line">                    &#123;</span><br><span class="line">                      front_misalign = (INTERNAL_SIZE_T) chunk2mem (brk) &amp; MALLOC_ALIGN_MASK;</span><br><span class="line">                      <span class="keyword">if</span> (front_misalign &gt; <span class="number">0</span>)</span><br><span class="line">                        &#123;</span><br><span class="line">                          <span class="comment">/*</span></span><br><span class="line"><span class="comment">                             Skip over some bytes to arrive at an aligned position.</span></span><br><span class="line"><span class="comment">                             We don&#x27;t need to specially mark these wasted front bytes.</span></span><br><span class="line"><span class="comment">                             They will never be accessed anyway because</span></span><br><span class="line"><span class="comment">                             prev_inuse of av-&gt;top (and any chunk created from its start)</span></span><br><span class="line"><span class="comment">                             is always true after initialization.</span></span><br><span class="line"><span class="comment">                           */</span></span><br><span class="line"></span><br><span class="line">                          aligned_brk += MALLOC_ALIGNMENT - front_misalign;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                  <span class="comment">/* Find out current end of memory */</span></span><br><span class="line">                  <span class="keyword">if</span> (snd_brk == (<span class="type">char</span> *) (MORECORE_FAILURE))</span><br><span class="line">                    &#123;</span><br><span class="line">                      snd_brk = (<span class="type">char</span> *) (MORECORE (<span class="number">0</span>));</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">              <span class="comment">/* Adjust top based on results of second sbrk */</span></span><br><span class="line">              <span class="keyword">if</span> (snd_brk != (<span class="type">char</span> *) (MORECORE_FAILURE))</span><br><span class="line">                &#123;</span><br><span class="line">                  av-&gt;top = (mchunkptr) aligned_brk;</span><br><span class="line">                  set_head (av-&gt;top, (snd_brk - aligned_brk + correction) | PREV_INUSE);</span><br><span class="line">                  av-&gt;system_mem += correction;</span><br><span class="line"></span><br><span class="line">                  <span class="comment">/*</span></span><br><span class="line"><span class="comment">                     If not the first time through, we either have a</span></span><br><span class="line"><span class="comment">                     gap due to foreign sbrk or a non-contiguous region.  Insert a</span></span><br><span class="line"><span class="comment">                     double fencepost at old_top to prevent consolidation with space</span></span><br><span class="line"><span class="comment">                     we don&#x27;t own. These fenceposts are artificial chunks that are</span></span><br><span class="line"><span class="comment">                     marked as inuse and are in any case too small to use.  We need</span></span><br><span class="line"><span class="comment">                     two to make sizes and alignments work out.</span></span><br><span class="line"><span class="comment">                   */</span></span><br><span class="line"></span><br><span class="line">                  <span class="keyword">if</span> (old_size != <span class="number">0</span>)</span><br><span class="line">                    &#123;</span><br><span class="line">                      <span class="comment">/*</span></span><br><span class="line"><span class="comment">                         Shrink old_top to insert fenceposts, keeping size a</span></span><br><span class="line"><span class="comment">                         multiple of MALLOC_ALIGNMENT. We know there is at least</span></span><br><span class="line"><span class="comment">                         enough space in old_top to do this.</span></span><br><span class="line"><span class="comment">                       */</span></span><br><span class="line">                      old_size = (old_size - <span class="number">4</span> * SIZE_SZ) &amp; ~MALLOC_ALIGN_MASK;</span><br><span class="line">                      set_head (old_top, old_size | PREV_INUSE);</span><br><span class="line"></span><br><span class="line">                      <span class="comment">/*</span></span><br><span class="line"><span class="comment">                         Note that the following assignments completely overwrite</span></span><br><span class="line"><span class="comment">                         old_top when old_size was previously MINSIZE.  This is</span></span><br><span class="line"><span class="comment">                         intentional. We need the fencepost, even if old_top otherwise gets</span></span><br><span class="line"><span class="comment">                         lost.</span></span><br><span class="line"><span class="comment">                       */</span></span><br><span class="line">                      chunk_at_offset (old_top, old_size)-&gt;size =</span><br><span class="line">                        (<span class="number">2</span> * SIZE_SZ) | PREV_INUSE;</span><br><span class="line"></span><br><span class="line">                      chunk_at_offset (old_top, old_size + <span class="number">2</span> * SIZE_SZ)-&gt;size =</span><br><span class="line">                        (<span class="number">2</span> * SIZE_SZ) | PREV_INUSE;</span><br><span class="line"></span><br><span class="line">                      <span class="comment">/* If possible, release the rest. */</span></span><br><span class="line">                      <span class="keyword">if</span> (old_size &gt;= MINSIZE)</span><br><span class="line">                        &#123;</span><br><span class="line">                          _int_free (av, old_top, <span class="number">1</span>);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="comment">/* if (av !=  &amp;main_arena) */</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ((<span class="type">unsigned</span> <span class="type">long</span>) av-&gt;system_mem &gt; (<span class="type">unsigned</span> <span class="type">long</span>) (av-&gt;max_system_mem))</span><br><span class="line">    av-&gt;max_system_mem = av-&gt;system_mem;</span><br><span class="line">  check_malloc_state (av);</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* finally, do the allocation */</span></span><br><span class="line">  p = av-&gt;top;</span><br><span class="line">  size = chunksize (p);</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* check that one of the above allocation paths succeeded */</span></span><br><span class="line">  <span class="keyword">if</span> ((<span class="type">unsigned</span> <span class="type">long</span>) (size) &gt;= (<span class="type">unsigned</span> <span class="type">long</span>) (nb + MINSIZE))</span><br><span class="line">    &#123;</span><br><span class="line">      remainder_size = size - nb;</span><br><span class="line">      remainder = chunk_at_offset (p, nb);</span><br><span class="line">      av-&gt;top = remainder;</span><br><span class="line">      set_head (p, nb | PREV_INUSE | (av != &amp;main_arena ? NON_MAIN_ARENA : <span class="number">0</span>));</span><br><span class="line">      set_head (remainder, remainder_size | PREV_INUSE);</span><br><span class="line">      check_malloced_chunk (av, p, nb);</span><br><span class="line">      <span class="keyword">return</span> chunk2mem (p);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* catch all failure paths */</span></span><br><span class="line">  __set_errno (ENOMEM);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h1 id="0x05-new-heapï¼š"><a href="#0x05-new-heapï¼š" class="headerlink" title="0x05.new_heapï¼š"></a>0x05.new_heapï¼š</h1><p>å®šä¹‰äºarena.cä¸­ï¼Œ<strong>ç”¨ä»¥é€šè¿‡mmapç³»ç»Ÿè°ƒç”¨åˆ†é…å†…å­˜</strong>ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Create a new heap.  size is automatically rounded up to a multiple</span></span><br><span class="line"><span class="comment">   of the page size. */</span></span><br><span class="line"></span><br><span class="line"><span class="type">static</span> heap_info *</span><br><span class="line">internal_function</span><br><span class="line"><span class="title function_">new_heap</span> <span class="params">(<span class="type">size_t</span> size, <span class="type">size_t</span> top_pad)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">size_t</span> pagesize = GLRO (dl_pagesize);</span><br><span class="line">  <span class="type">char</span> *p1, *p2;</span><br><span class="line">  <span class="type">unsigned</span> <span class="type">long</span> ul;</span><br><span class="line">  heap_info *h;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (size + top_pad &lt; HEAP_MIN_SIZE)</span><br><span class="line">    size = HEAP_MIN_SIZE;</span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> (size + top_pad &lt;= HEAP_MAX_SIZE)</span><br><span class="line">    size += top_pad;</span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> (size &gt; HEAP_MAX_SIZE)</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    size = HEAP_MAX_SIZE;</span><br><span class="line">  size = ALIGN_UP (size, pagesize);</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* A memory region aligned to a multiple of HEAP_MAX_SIZE is needed.</span></span><br><span class="line"><span class="comment">     No swap space needs to be reserved for the following large</span></span><br><span class="line"><span class="comment">     mapping (on Linux, this is the case for all non-writable mappings</span></span><br><span class="line"><span class="comment">     anyway). */</span></span><br><span class="line">  p2 = MAP_FAILED;</span><br><span class="line">  <span class="keyword">if</span> (aligned_heap_area)</span><br><span class="line">    &#123;</span><br><span class="line">      p2 = (<span class="type">char</span> *) MMAP (aligned_heap_area, HEAP_MAX_SIZE, PROT_NONE,</span><br><span class="line">                          MAP_NORESERVE);</span><br><span class="line">      aligned_heap_area = <span class="literal">NULL</span>;</span><br><span class="line">      <span class="keyword">if</span> (p2 != MAP_FAILED &amp;&amp; ((<span class="type">unsigned</span> <span class="type">long</span>) p2 &amp; (HEAP_MAX_SIZE - <span class="number">1</span>)))</span><br><span class="line">        &#123;</span><br><span class="line">          __munmap (p2, HEAP_MAX_SIZE);</span><br><span class="line">          p2 = MAP_FAILED;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  <span class="keyword">if</span> (p2 == MAP_FAILED)</span><br><span class="line">    &#123;</span><br><span class="line">      p1 = (<span class="type">char</span> *) MMAP (<span class="number">0</span>, HEAP_MAX_SIZE &lt;&lt; <span class="number">1</span>, PROT_NONE, MAP_NORESERVE);</span><br><span class="line">      <span class="keyword">if</span> (p1 != MAP_FAILED)</span><br><span class="line">        &#123;</span><br><span class="line">          p2 = (<span class="type">char</span> *) (((<span class="type">unsigned</span> <span class="type">long</span>) p1 + (HEAP_MAX_SIZE - <span class="number">1</span>))</span><br><span class="line">                         &amp; ~(HEAP_MAX_SIZE - <span class="number">1</span>));</span><br><span class="line">          ul = p2 - p1;</span><br><span class="line">          <span class="keyword">if</span> (ul)</span><br><span class="line">            __munmap (p1, ul);</span><br><span class="line">          <span class="keyword">else</span></span><br><span class="line">            aligned_heap_area = p2 + HEAP_MAX_SIZE;</span><br><span class="line">          __munmap (p2 + HEAP_MAX_SIZE, HEAP_MAX_SIZE - ul);</span><br><span class="line">        &#125;</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">          <span class="comment">/* Try to take the chance that an allocation of only HEAP_MAX_SIZE</span></span><br><span class="line"><span class="comment">             is already aligned. */</span></span><br><span class="line">          p2 = (<span class="type">char</span> *) MMAP (<span class="number">0</span>, HEAP_MAX_SIZE, PROT_NONE, MAP_NORESERVE);</span><br><span class="line">          <span class="keyword">if</span> (p2 == MAP_FAILED)</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">          <span class="keyword">if</span> ((<span class="type">unsigned</span> <span class="type">long</span>) p2 &amp; (HEAP_MAX_SIZE - <span class="number">1</span>))</span><br><span class="line">            &#123;</span><br><span class="line">              __munmap (p2, HEAP_MAX_SIZE);</span><br><span class="line">              <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  <span class="keyword">if</span> (__mprotect (p2, size, PROT_READ | PROT_WRITE) != <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">      __munmap (p2, HEAP_MAX_SIZE);</span><br><span class="line">      <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  h = (heap_info *) p2;</span><br><span class="line">  h-&gt;size = size;</span><br><span class="line">  h-&gt;mprotect_size = size;</span><br><span class="line">  LIBC_PROBE (memory_heap_new, <span class="number">2</span>, h, h-&gt;size);</span><br><span class="line">  <span class="keyword">return</span> h;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


      </div>
      
        <div class="prev-or-next">
          <div class="post-foot-next">
            
              <a href="/2021/01/15/GLIBC-0X00-MALLOC-2.23-PART-I/" target="_self">
                <i class="iconfont icon-chevronleft"></i>
                <span>ä¸Šä¸€é¡µ</span>
              </a>
            
          </div>
          <div class="post-attach">
            <span class="post-pubtime">
              <i class="iconfont icon-updatetime" title="æ›´æ–°æ—¶é—´"></i>
              2021-01-15 20:17:03
            </span>
            
                  <span class="post-categories">
                    <i class="iconfont icon-bookmark" title="åˆ†ç±»"></i>
                    
                    <span class="span--category">
                      <a href="/categories/GLIBC/" title="GLIBC">
                        <b>#</b> GLIBC
                      </a>
                    </span>
                    
                  </span>
              
                  <span class="post-tags">
                    <i class="iconfont icon-tags" title="æ ‡ç­¾"></i>
                    
                    <span class="span--tag">
                      <a href="/tags/%E5%AD%A6%E4%B9%A0%E6%9C%AD%E8%AE%B0/" title="å­¦ä¹ æœ­è®°">
                        <b>#</b> å­¦ä¹ æœ­è®°
                      </a>
                    </span>
                    
                    <span class="span--tag">
                      <a href="/tags/ptmalloc/" title="ptmalloc">
                        <b>#</b> ptmalloc
                      </a>
                    </span>
                    
                    <span class="span--tag">
                      <a href="/tags/glibc/" title="glibc">
                        <b>#</b> glibc
                      </a>
                    </span>
                    
                    <span class="span--tag">
                      <a href="/tags/%E5%A0%86-%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86/" title="å † - å†…å­˜ç®¡ç†">
                        <b>#</b> å † - å†…å­˜ç®¡ç†
                      </a>
                    </span>
                    
                  </span>
              
          </div>
          <div class="post-foot-prev">
            
              <a href="/2021/01/20/CTF-0X02-STARCTF2021-PWN/" target="_self">
                <span>ä¸‹ä¸€é¡µ</span>
                <i class="iconfont icon-chevronright"></i>
              </a>
            
          </div>
        </div>
      
    </div>
    
  <div id="btn-catalog" class="btn-catalog">
    <i class="iconfont icon-catalog"></i>
  </div>
  <div class="post-catalog hidden" id="catalog">
    <div class="title">ç›®å½•</div>
    <div class="catalog-content">
      
        <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#0x00-malloc"><span class="toc-text">0x00.malloc</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#THROW%EF%BC%9AC-%E4%B8%8B%E4%B8%8D%E6%8A%9B%E5%87%BA%E5%BC%82%E5%B8%B8"><span class="toc-text">__THROWï¼šC++ä¸‹ä¸æŠ›å‡ºå¼‚å¸¸</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#attribute-malloc-%EF%BC%9A%E4%BC%98%E5%8C%96malloc%E7%B1%BB%E5%9E%8B%E5%87%BD%E6%95%B0"><span class="toc-text">__attribute_malloc__ï¼šä¼˜åŒ–mallocç±»å‹å‡½æ•°</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#GNUC-PREREQ"><span class="toc-text">__GNUC_PREREQ()</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#wur%EF%BC%9A%E8%8B%A5%E5%87%BD%E6%95%B0%E8%BF%94%E5%9B%9E%E5%80%BC%E6%9C%AA%E8%A2%AB%E5%BC%95%E7%94%A8%E5%88%99%E6%8A%9B%E5%87%BA%E8%AD%A6%E5%91%8A"><span class="toc-text">__wurï¼šè‹¥å‡½æ•°è¿”å›å€¼æœªè¢«å¼•ç”¨åˆ™æŠ›å‡ºè­¦å‘Š</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#USE-FORTIFY-LEVEL"><span class="toc-text">__USE_FORTIFY_LEVEL</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#FORTIFY-SOURCE"><span class="toc-text">_FORTIFY_SOURCE</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#strong-alias%EF%BC%9A%E9%87%8D%E5%91%BD%E5%90%8Dmalloc%E4%B8%BA-libc-malloc"><span class="toc-text">strong_aliasï¼šé‡å‘½åmallocä¸º__libc_malloc</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#typeof"><span class="toc-text">__typeof</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x01-libc-malloc"><span class="toc-text">0x01.__libc_malloc</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#errno"><span class="toc-text">errno</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#libc-hidden-proto%EF%BC%9A%E5%87%BD%E6%95%B0%E7%AC%A6%E5%8F%B7%E9%9A%90%E8%97%8F"><span class="toc-text">libc_hidden_protoï¼šå‡½æ•°ç¬¦å·éšè—</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#attribute-visibility-%E2%80%9Chidden%E2%80%9D"><span class="toc-text">attribute: visibility(â€œhiddenâ€)</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#libc-malloc%E5%87%BD%E6%95%B0%E5%AE%9A%E4%B9%89%EF%BC%9A"><span class="toc-text">__libc_mallocå‡½æ•°å®šä¹‰ï¼š</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E6%A3%80%E6%9F%A5%E9%92%A9%E5%AD%90-malloc-hook%E6%98%AF%E5%90%A6%E4%B8%BANULL%EF%BC%8C%E8%8B%A5%E5%90%A6%EF%BC%8C%E5%88%99%E8%B0%83%E7%94%A8%E9%92%A9%E5%AD%90"><span class="toc-text">1.æ£€æŸ¥é’©å­__malloc_hookæ˜¯å¦ä¸ºNULLï¼Œè‹¥å¦ï¼Œåˆ™è°ƒç”¨é’©å­</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#weak-variable"><span class="toc-text">weak_variable</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E2%91%A0malloc-hook-ini%EF%BC%9A%E9%87%8D%E7%BD%AE-malloc-hook%E4%B8%BANULL%EF%BC%8C%E8%B0%83%E7%94%A8ptmalloc%E5%88%9D%E5%A7%8B%E5%8C%96%E5%87%BD%E6%95%B0%EF%BC%8C%E9%87%8D%E6%96%B0%E8%B0%83%E7%94%A8-libc-malloc%E5%88%86%E9%85%8D%E5%86%85%E5%AD%98%E5%9D%97"><span class="toc-text">â‘ malloc_hook__iniï¼šé‡ç½®__malloc_hookä¸ºNULLï¼Œè°ƒç”¨ptmallocåˆå§‹åŒ–å‡½æ•°ï¼Œé‡æ–°è°ƒç”¨__libc_mallocåˆ†é…å†…å­˜å—</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E2%91%A1ptmalloc-init-%EF%BC%9A%E5%88%9D%E5%A7%8B%E5%8C%96ptmalloc%E5%A0%86%E7%AE%A1%E7%90%86%E5%99%A8"><span class="toc-text">â‘¡ptmalloc_init()ï¼šåˆå§‹åŒ–ptmallocå †ç®¡ç†å™¨</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#1%EF%BC%89%E4%BF%AE%E6%94%B9ptmalloc%E5%88%9D%E5%A7%8B%E5%8C%96%E6%A0%87%E5%BF%97%E4%BD%8D"><span class="toc-text">1ï¼‰ä¿®æ”¹ptmallocåˆå§‹åŒ–æ ‡å¿—ä½</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2%EF%BC%89%E6%A3%80%E6%9F%A5SHARED%E5%AE%8F"><span class="toc-text">2ï¼‰æ£€æŸ¥SHAREDå®</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3%EF%BC%89%E8%8E%B7%E5%8F%96main-arena%EF%BC%8C%E6%B7%BB%E5%8A%A0atfork-mem%E5%85%A5fork-handler%E9%93%BE%E8%A1%A8"><span class="toc-text">3ï¼‰è·å–main_arenaï¼Œæ·»åŠ atfork_memå…¥fork_handleré“¾è¡¨</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#4%EF%BC%89%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F-environ%E7%9B%B8%E5%85%B3%E6%93%8D%E4%BD%9C"><span class="toc-text">4ï¼‰ç¯å¢ƒå˜é‡__environç›¸å…³æ“ä½œ</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#5%EF%BC%89%E6%A3%80%E6%9F%A5%E9%92%A9%E5%AD%90-malloc-initialized-hook"><span class="toc-text">5ï¼‰æ£€æŸ¥é’©å­__malloc_initialized_hook</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E8%8E%B7%E5%8F%96%E4%B8%80%E4%B8%AAarena"><span class="toc-text">2.è·å–ä¸€ä¸ªarena</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E2%AD%903-%E8%B0%83%E7%94%A8-int-malloc-%E5%87%BD%E6%95%B0%E5%88%86%E9%85%8D%E5%86%85%E5%AD%98"><span class="toc-text">â­3.è°ƒç”¨_int_malloc()å‡½æ•°åˆ†é…å†…å­˜</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-%E6%A3%80%E6%B5%8B%E7%BB%93%E6%9E%9C%EF%BC%8C%E8%8B%A5%E4%B8%BANULL%E5%88%99%E9%87%8D%E6%96%B0%E8%8E%B7%E5%BE%97arena%E5%B9%B6%E9%87%8D%E6%96%B0%E8%B0%83%E7%94%A8-int-malloc-%E5%88%86%E9%85%8D%E5%86%85%E5%AD%98"><span class="toc-text">4.æ£€æµ‹ç»“æœï¼Œè‹¥ä¸ºNULLåˆ™é‡æ–°è·å¾—arenaå¹¶é‡æ–°è°ƒç”¨_int_malloc()åˆ†é…å†…å­˜</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E2%91%A0arena-get-retry-%EF%BC%9A%E9%87%8D%E6%96%B0%E8%8E%B7%E5%BE%97%E4%B8%80%E4%B8%AAarena"><span class="toc-text">â‘ arena_get_retry()ï¼šé‡æ–°è·å¾—ä¸€ä¸ªarena</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#1%EF%BC%89%E5%8E%9Farena%E4%B8%8D%E4%B8%BAmain-arena%EF%BC%8C%E5%88%99%E8%A7%A3%E9%94%81%E5%90%8E%E8%8E%B7%E5%8F%96main-arena"><span class="toc-text">1ï¼‰åŸarenaä¸ä¸ºmain_arenaï¼Œåˆ™è§£é”åè·å–main_arena</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2%EF%BC%89%E5%8E%9Farena%E4%B8%BAmain-arena%EF%BC%8C%E8%A7%A3%E9%94%81%E5%90%8E%E8%B0%83%E7%94%A8arena-get2-%E8%8E%B7%E5%8F%96%E5%85%B6%E4%BB%96arena"><span class="toc-text">2ï¼‰åŸarenaä¸ºmain_arenaï¼Œè§£é”åè°ƒç”¨arena_get2()è·å–å…¶ä»–arena</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E2%91%A1%E9%87%8D%E6%96%B0%E8%B0%83%E7%94%A8-int-malloc-%E5%88%86%E9%85%8D%E5%86%85%E5%AD%98"><span class="toc-text">â‘¡é‡æ–°è°ƒç”¨_int_malloc()åˆ†é…å†…å­˜</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-%E6%A3%80%E6%B5%8B%E6%97%A0%E8%AF%AF%E5%90%8E%E8%BF%94%E5%9B%9E%E5%86%85%E5%AD%98%E5%9D%97"><span class="toc-text">5.æ£€æµ‹æ— è¯¯åè¿”å›å†…å­˜å—</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#libc-hidden-def%EF%BC%9A%E5%87%BD%E6%95%B0%E5%AE%9A%E4%B9%89%E9%9A%90%E8%97%8F"><span class="toc-text">libc_hidden_defï¼šå‡½æ•°å®šä¹‰éšè—</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x02-malloc-consolidate"><span class="toc-text">0x02.malloc_consolidate</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%A4%96%E5%B1%82%E5%BE%AA%E7%8E%AF%EF%BC%9A%E9%81%8D%E5%8E%86fastbinsY%E6%95%B0%E7%BB%84%E5%85%83%E7%B4%A0"><span class="toc-text">å¤–å±‚å¾ªç¯ï¼šéå†fastbinsYæ•°ç»„å…ƒç´ </span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%86%85%E5%B1%82%E5%BE%AA%E7%8E%AF%EF%BC%9A%E9%81%8D%E5%8E%86fastbin-%E9%93%BE%E8%A1%A8%E3%80%81%E5%90%88%E5%B9%B6%E7%A9%BA%E9%97%B2chunk"><span class="toc-text">å†…å±‚å¾ªç¯ï¼šéå†fastbin é“¾è¡¨ã€åˆå¹¶ç©ºé—²chunk</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E2%91%A0%E5%90%8E%E5%90%91%E5%90%88%E5%B9%B6%EF%BC%9A%E4%BD%BF%E7%94%A8unlink%E5%8F%96%E5%87%BA%E7%9B%B8%E9%82%BB%E4%BD%8E%E5%9C%B0%E5%9D%80chunk%EF%BC%88%E8%8B%A5%E5%B7%B2free%EF%BC%89"><span class="toc-text">â‘ åå‘åˆå¹¶ï¼šä½¿ç”¨unlinkå–å‡ºç›¸é‚»ä½åœ°å€chunkï¼ˆè‹¥å·²freeï¼‰</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E2%91%A1%E5%89%8D%E5%90%91%E5%90%88%E5%B9%B6%EF%BC%9A%E8%8B%A5%E4%B8%BAtop-chunk%E5%88%99%E5%90%88%E5%B9%B6%E5%85%A5top-chunk%E4%B8%AD%EF%BC%8C%E5%90%A6%E5%88%99%E4%BC%9A%E5%B0%9D%E8%AF%95%E5%90%88%E5%B9%B6%E5%90%8E%E6%8F%92%E5%85%A5unsorted-bin%E4%B8%AD"><span class="toc-text">â‘¡å‰å‘åˆå¹¶ï¼šè‹¥ä¸ºtop chunkåˆ™åˆå¹¶å…¥top chunkä¸­ï¼Œå¦åˆ™ä¼šå°è¯•åˆå¹¶åæ’å…¥unsorted_binä¸­</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#1%EF%BC%89nextchunk%E4%B8%BAtop-chunk"><span class="toc-text">1ï¼‰nextchunkä¸ºtop chunk</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#5%EF%BC%89nextchunk%E4%B8%8D%E4%B8%BAtop-chunk"><span class="toc-text">5ï¼‰nextchunkä¸ä¸ºtop chunk</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E2%91%A2%E6%A3%80%E6%9F%A5%E9%93%BE%E8%A1%A8%E4%B8%AD%E7%9A%84%E4%B8%8B%E4%B8%80%E4%B8%AAchunk%EF%BC%8C%E4%B8%8D%E4%B8%BANULL%E5%88%99%E7%BB%A7%E7%BB%AD%E6%96%B0%E4%B8%80%E8%BD%AE%E5%BE%AA%E7%8E%AF"><span class="toc-text">â‘¢æ£€æŸ¥é“¾è¡¨ä¸­çš„ä¸‹ä¸€ä¸ªchunkï¼Œä¸ä¸ºNULLåˆ™ç»§ç»­æ–°ä¸€è½®å¾ªç¯</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x03-int-malloc"><span class="toc-text">0x03._int_malloc</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%80%E3%80%81%E5%B0%86%E8%AF%B7%E6%B1%82%E5%A4%A7%E5%B0%8F%E8%BD%AC%E6%8D%A2%E4%B8%BA%E6%A0%87%E5%87%86%E5%A4%A7%E5%B0%8F"><span class="toc-text">ä¸€ã€å°†è¯·æ±‚å¤§å°è½¬æ¢ä¸ºæ ‡å‡†å¤§å°</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%8C%E3%80%81%E6%A3%80%E6%9F%A5arena%E6%98%AF%E5%90%A6%E5%8F%AF%E7%94%A8"><span class="toc-text">äºŒã€æ£€æŸ¥arenaæ˜¯å¦å¯ç”¨</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%89%E3%80%81fastbin%E8%8C%83%E5%9B%B4size%E8%AF%B7%E6%B1%82%E7%9B%B8%E5%85%B3%E6%93%8D%E4%BD%9C"><span class="toc-text">ä¸‰ã€fastbinèŒƒå›´sizeè¯·æ±‚ç›¸å…³æ“ä½œ</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E5%B0%9D%E8%AF%95%E4%BB%8Efastbin%E5%AF%B9%E5%BA%94%E4%B8%8B%E6%A0%87%E5%8F%96%E5%87%BAchunk"><span class="toc-text">1.å°è¯•ä»fastbinå¯¹åº”ä¸‹æ ‡å–å‡ºchunk</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%EF%BC%88%E8%8B%A5%E6%88%90%E5%8A%9F%E8%8E%B7%E5%BE%97chunk%EF%BC%89%E8%BF%9B%E8%A1%8Cchunk-size%E5%AE%89%E5%85%A8%E6%A3%80%E6%9F%A5"><span class="toc-text">2.ï¼ˆè‹¥æˆåŠŸè·å¾—chunkï¼‰è¿›è¡Œchunk sizeå®‰å…¨æ£€æŸ¥</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x04-sysmalloc%EF%BC%9A"><span class="toc-text">0x04.sysmallocï¼š</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x05-new-heap%EF%BC%9A"><span class="toc-text">0x05.new_heapï¼š</span></a></li></ol>
      
    </div>
  </div>

  
<script src="/js/catalog.js"></script>




    
      <div class="comments-container">
        




  
    <script async type="text/javascript" src="/plugins/valine.min.js" onload="loadValineSuc(this)"></script>
  

  <div id="vcomments"></div>

  <script>
    function loadValineSuc() {
      new Valine({
        el: '#vcomments',
        appId: 'ICj6cPRQWFTNiOttBHlzxnIv-gzGzoHsz',
        appKey: 'tuvJh3xYxPFcW2JB6K26RKP2',
        placeholder: 'è¯´ç‚¹ä»€ä¹ˆå‘—...',
        avatar: 'retro',
        lang: 'zh-CN'
      })
    }
  </script>

    <style>
      .comments-container .v .vempty {
        display: none!important;
      }
    </style>




      </div>
    
  </div>


        
<div class="footer">
  <div class="social">
    <ul>
      
        <li>
          <a title="github" target="_blank" rel="noopener" href="https://github.com/arttnba3">
            <i class="iconfont icon-github"></i>
          </a>
        </li>
      
        <li>
          <a title="email" href="mailto:arttnba@gmail.com">
            <i class="iconfont icon-envelope"></i>
          </a>
        </li>
      
        <li>
          <a title="twitter" target="_blank" rel="noopener" href="https://twitter.com/arttnba3">
            <i class="iconfont icon-twitter"></i>
          </a>
        </li>
      
        <li>
          <a title="rss" href="/atom.xml">
            <i class="iconfont icon-rss"></i>
          </a>
        </li>
      
    </ul>
  </div>
  
    
    <div class="footer-more">
      
        <a target="_blank" rel="noopener" href="https://github.com/arttnba3">Copyright Â© 2022 arttnba3</a>
        
    </div>
  
    
    <div class="footer-more">
      
        <a target="_blank" rel="noopener" href="https://github.com/zchengsite/hexo-theme-oranges">Theme by Oranges | Powered by Hexo</a>
        
    </div>
  
</div>

      </div>

      <div class="tools-bar">
        <div class="back-to-top tools-bar-item hidden">
  <a href="javascript: void(0)">
    <i class="iconfont icon-chevronup"></i>
  </a>
</div>


<script src="/js/backtotop.js"></script>



        
  <div class="search-icon tools-bar-item" id="search-icon">
    <a href="javascript: void(0)">
      <i class="iconfont icon-search"></i>
    </a>
  </div>

  <div class="search-overlay hidden">
    <div class="search-content" tabindex="0">
      <div class="search-title">
        <span class="search-icon-input">
          <a href="javascript: void(0)">
            <i class="iconfont icon-search"></i>
          </a>
        </span>
        
          <input type="text" class="search-input" id="search-input" placeholder="æœç´¢...">
        
        <span class="search-close-icon" id="search-close-icon">
          <a href="javascript: void(0)">
            <i class="iconfont icon-close"></i>
          </a>
        </span>
      </div>
      <div class="search-result" id="search-result"></div>
    </div>
  </div>

  <script type="text/javascript">
    var inputArea = document.querySelector("#search-input")
    var searchOverlayArea = document.querySelector(".search-overlay")

    inputArea.onclick = function() {
      getSearchFile()
      this.onclick = null
    }

    inputArea.onkeydown = function() {
      if(event.keyCode == 13)
        return false
    }

    function openOrHideSearchContent() {
      let isHidden = searchOverlayArea.classList.contains('hidden')
      if (isHidden) {
        searchOverlayArea.classList.remove('hidden')
        document.body.classList.add('hidden')
        // inputArea.focus()
      } else {
        searchOverlayArea.classList.add('hidden')
        document.body.classList.remove('hidden')
      }
    }

    function blurSearchContent(e) {
      if (e.target === searchOverlayArea) {
        openOrHideSearchContent()
      }
    }

    document.querySelector("#search-icon").addEventListener("click", openOrHideSearchContent, false)
    document.querySelector("#search-close-icon").addEventListener("click", openOrHideSearchContent, false)
    searchOverlayArea.addEventListener("click", blurSearchContent, false)

    var searchFunc = function (path, search_id, content_id) {
      'use strict';
      var $input = document.getElementById(search_id);
      var $resultContent = document.getElementById(content_id);
      $resultContent.innerHTML = "<ul><span class='local-search-empty'>é¦–æ¬¡æœç´¢ï¼Œæ­£åœ¨è½½å…¥ç´¢å¼•æ–‡ä»¶ï¼Œè¯·ç¨åâ€¦â€¦<span></ul>";
      $.ajax({
        // 0x01. load xml file
        url: path,
        dataType: "xml",
        success: function (xmlResponse) {
          // 0x02. parse xml file
          var datas = $("entry", xmlResponse).map(function () {
            return {
              title: $("title", this).text(),
              content: $("content", this).text(),
              url: $("url", this).text()
            };
          }).get();
          $resultContent.innerHTML = "";

          $input.addEventListener('input', function () {
            // 0x03. parse query to keywords list
            var str = '<ul class=\"search-result-list\">';
            var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
            $resultContent.innerHTML = "";
            if (this.value.trim().length <= 0) {
              return;
            }
            // 0x04. perform local searching
            datas.forEach(function (data) {
              var isMatch = true;
              var content_index = [];
              if (!data.title || data.title.trim() === '') {
                data.title = "Untitled";
              }
              var orig_data_title = data.title.trim();
              var data_title = orig_data_title.toLowerCase();
              var orig_data_content = data.content.trim().replace(/<[^>]+>/g, "");
              var data_content = orig_data_content.toLowerCase();
              var data_url = data.url;
              var index_title = -1;
              var index_content = -1;
              var first_occur = -1;
              // only match artiles with not empty contents
              if (data_content !== '') {
                keywords.forEach(function (keyword, i) {
                  index_title = data_title.indexOf(keyword);
                  index_content = data_content.indexOf(keyword);

                  if (index_title < 0 && index_content < 0) {
                    isMatch = false;
                  } else {
                    if (index_content < 0) {
                      index_content = 0;
                    }
                    if (i == 0) {
                      first_occur = index_content;
                    }
                    // content_index.push({index_content:index_content, keyword_len:keyword_len});
                  }
                });
              } else {
                isMatch = false;
              }
              // 0x05. show search results
              if (isMatch) {
                str += "<li><a href='" + data_url + "' class='search-result-title'>" + orig_data_title + "</a>";
                var content = orig_data_content;
                if (first_occur >= 0) {
                  // cut out 100 characters
                  var start = first_occur - 20;
                  var end = first_occur + 80;

                  if (start < 0) {
                    start = 0;
                  }

                  if (start == 0) {
                    end = 100;
                  }

                  if (end > content.length) {
                    end = content.length;
                  }

                  var match_content = content.substr(start, end);

                  // highlight all keywords
                  keywords.forEach(function (keyword) {
                    var regS = new RegExp(keyword, "gi");
                    match_content = match_content.replace(regS, "<span class=\"search-keyword\">" + keyword + "</span>");
                  });

                  str += "<p class=\"search-result-abstract\">" + match_content + "...</p>"
                }
                str += "</li>";
              }
            });
            str += "</ul>";
            if (str.indexOf('<li>') === -1) {
              return $resultContent.innerHTML = "<ul><span class='local-search-empty'>æ²¡æœ‰æ‰¾åˆ°å†…å®¹ï¼Œè¯·å°è¯•æ›´æ¢æ£€ç´¢è¯ã€‚<span></ul>";
            }
            $resultContent.innerHTML = str;
          });
        },
        error: function(xhr, status, error) {
          $resultContent.innerHTML = ""
          if (xhr.status === 404) {
            $resultContent.innerHTML = "<ul><span class='local-search-empty'>æœªæ‰¾åˆ°search.xmlæ–‡ä»¶ï¼Œå…·ä½“è¯·å‚è€ƒï¼š<a href='https://github.com/zchengsite/hexo-theme-oranges#configuration' target='_black'>configuration</a><span></ul>";
          } else {
            $resultContent.innerHTML = "<ul><span class='local-search-empty'>è¯·æ±‚å¤±è´¥ï¼Œå°è¯•é‡æ–°åˆ·æ–°é¡µé¢æˆ–ç¨åé‡è¯•ã€‚<span></ul>";
          }
        }
      });
      $(document).on('click', '#search-close-icon', function() {
        $('#search-input').val('');
        $('#search-result').html('');
      });
    }

    var getSearchFile = function() {
        var path = "/search.xml";
        searchFunc(path, 'search-input', 'search-result');
    }
  </script>




        
  <div class="tools-bar-item theme-icon" id="switch-color-scheme">
    <a href="javascript: void(0)">
      <i id="theme-icon" class="iconfont icon-moon"></i>
    </a>
  </div>

  
<script src="/js/colorscheme.js"></script>





        
  
    <div class="share-icon tools-bar-item">
      <a href="javascript: void(0)" id="share-icon">
        <i class="iconfont iconshare"></i>
      </a>
      <div class="share-content hidden">
        
          <a class="share-item" href="https://twitter.com/intent/tweet?text=' + %E3%80%90GLIBC.0x01%E3%80%91glibc2.23%20malloc%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%20-%20II%EF%BC%9Amalloc + '&url=' + http%3A%2F%2Fblog.arttnba3.cn%2F2021%2F01%2F15%2FGLIBC-0X01-MALLOC-2.23-PART-II%2F + '" target="_blank" title="Twitter">
            <i class="iconfont icon-twitter"></i>
          </a>
        
        
          <a class="share-item" href="https://www.facebook.com/sharer.php?u=http://blog.arttnba3.cn/2021/01/15/GLIBC-0X01-MALLOC-2.23-PART-II/" target="_blank" title="Facebook">
            <i class="iconfont icon-facebooksquare"></i>
          </a>
        
      </div>
    </div>
  
  
<script src="/js/shares.js"></script>



      </div>
    </div>
  </body>
</html>
